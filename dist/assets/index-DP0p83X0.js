const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/Home-LuCsJ0Kz.js","assets/ui-DwoKAdU7.js","assets/vendor-D3F3s8fL.js","assets/stats-X3jz_E9o.js","assets/OnlinePlay.clean-CN7HYk28.js","assets/GameCalibrationStatus-DQyKziTB.js","assets/OfflinePlay-DjuWU6he.js","assets/Scoreboard-_rvnj03B.js","assets/StatsPanel-DoVTHWBw.js","assets/Friends-BfZdnlzG.js","assets/Tournaments-JwbXz_UM.js","assets/AdminAccess-9iGjTPz_.js","assets/OpsDashboard-CXAm-VQ7.js"])))=>i.map(i=>d[i]);
import{r as Br,a as Do,g as Io}from"./vendor-D3F3s8fL.js";import{r as o,R as dt,M as Rn,S as Qs,L as xc,a as bc,U as Va,T as Cs,C as Fa,P as gc,Z as Wi,X as Vr,b as Ua,c as Hr,d as Ws,E as kr,V as vc,e as yc,f as wc,G as jc,g as Er,h as Nc,i as Sc,j as Cc,k as kc,l as Ec,m as Tc,A as Dc,n as Ic,B as zi,o as Mc,H as Rc}from"./ui-DwoKAdU7.js";(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))a(r);new MutationObserver(r=>{for(const i of r)if(i.type==="childList")for(const l of i.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&a(l)}).observe(document,{childList:!0,subtree:!0});function s(r){const i={};return r.integrity&&(i.integrity=r.integrity),r.referrerPolicy&&(i.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?i.credentials="include":r.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function a(r){if(r.ep)return;r.ep=!0;const i=s(r);fetch(r.href,i)}})();var ir={exports:{}},zs={};/**
 * @license React
 * react-jsx-runtime.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var qi;function Ac(){if(qi)return zs;qi=1;var t=Br(),n=Symbol.for("react.element"),s=Symbol.for("react.fragment"),a=Object.prototype.hasOwnProperty,r=t.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,i={key:!0,ref:!0,__self:!0,__source:!0};function l(u,f,c){var m,p={},h=null,N=null;c!==void 0&&(h=""+c),f.key!==void 0&&(h=""+f.key),f.ref!==void 0&&(N=f.ref);for(m in f)a.call(f,m)&&!i.hasOwnProperty(m)&&(p[m]=f[m]);if(u&&u.defaultProps)for(m in f=u.defaultProps,f)p[m]===void 0&&(p[m]=f[m]);return{$$typeof:n,type:u,key:h,ref:N,props:p,_owner:r.current}}return zs.Fragment=s,zs.jsx=l,zs.jsxs=l,zs}var Gi;function Pc(){return Gi||(Gi=1,ir.exports=Ac()),ir.exports}var e=Pc(),Ta={},Yi;function Lc(){if(Yi)return Ta;Yi=1;var t=Do();return Ta.createRoot=t.createRoot,Ta.hydrateRoot=t.hydrateRoot,Ta}var Oc=Lc();const Fc=Io(Oc),Uc="modulepreload",_c=function(t){return"/"+t},Ji={},rn=function(n,s,a){let r=Promise.resolve();if(s&&s.length>0){let f=function(c){return Promise.all(c.map(m=>Promise.resolve(m).then(p=>({status:"fulfilled",value:p}),p=>({status:"rejected",reason:p}))))};document.getElementsByTagName("link");const l=document.querySelector("meta[property=csp-nonce]"),u=l?.nonce||l?.getAttribute("nonce");r=f(s.map(c=>{if(c=_c(c),c in Ji)return;Ji[c]=!0;const m=c.endsWith(".css"),p=m?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${c}"]${p}`))return;const h=document.createElement("link");if(h.rel=m?"stylesheet":Uc,m||(h.as="script"),h.crossOrigin="",h.href=c,u&&h.setAttribute("nonce",u),document.head.appendChild(h),m)return new Promise((N,w)=>{h.addEventListener("load",N),h.addEventListener("error",()=>w(new Error(`Unable to preload CSS for ${c}`)))})}))}function i(l){const u=new Event("vite:preloadError",{cancelable:!0});if(u.payload=l,window.dispatchEvent(u),!u.defaultPrevented)throw l}return r.then(l=>{for(const u of l||[])u.status==="rejected"&&i(u.reason);return n().catch(i)})};function $c(t,n){if(t==null)return{};var s={};for(var a in t)if({}.hasOwnProperty.call(t,a)){if(n.indexOf(a)!==-1)continue;s[a]=t[a]}return s}function ea(){return ea=Object.assign?Object.assign.bind():function(t){for(var n=1;n<arguments.length;n++){var s=arguments[n];for(var a in s)({}).hasOwnProperty.call(s,a)&&(t[a]=s[a])}return t},ea.apply(null,arguments)}var Tr="data-focus-lock",Mo="data-focus-lock-disabled",Bc="data-no-focus-lock",Vc="data-autofocus-inside",Hc="data-no-autofocus";function or(t,n){return typeof t=="function"?t(n):t&&(t.current=n),t}function Wc(t,n){var s=o.useState(function(){return{value:t,callback:n,facade:{get current(){return s.value},set current(a){var r=s.value;r!==a&&(s.value=a,s.callback(a,r))}}}})[0];return s.callback=n,s.facade}var zc=typeof window<"u"?o.useLayoutEffect:o.useEffect,Xi=new WeakMap;function qc(t,n){var s=Wc(null,function(a){return t.forEach(function(r){return or(r,a)})});return zc(function(){var a=Xi.get(s);if(a){var r=new Set(a),i=new Set(t),l=s.current;r.forEach(function(u){i.has(u)||or(u,null)}),i.forEach(function(u){r.has(u)||or(u,l)})}Xi.set(s,t)},[t]),s}var lr={width:"1px",height:"0px",padding:0,overflow:"hidden",position:"fixed",top:"1px",left:"1px"},Dr=function(){return Dr=Object.assign||function(n){for(var s,a=1,r=arguments.length;a<r;a++){s=arguments[a];for(var i in s)Object.prototype.hasOwnProperty.call(s,i)&&(n[i]=s[i])}return n},Dr.apply(this,arguments)};function Ro(t){return t}function Ao(t,n){n===void 0&&(n=Ro);var s=[],a=!1,r={read:function(){if(a)throw new Error("Sidecar: could not `read` from an `assigned` medium. `read` could be used only with `useMedium`.");return s.length?s[s.length-1]:t},useMedium:function(i){var l=n(i,a);return s.push(l),function(){s=s.filter(function(u){return u!==l})}},assignSyncMedium:function(i){for(a=!0;s.length;){var l=s;s=[],l.forEach(i)}s={push:function(u){return i(u)},filter:function(){return s}}},assignMedium:function(i){a=!0;var l=[];if(s.length){var u=s;s=[],u.forEach(i),l=s}var f=function(){var m=l;l=[],m.forEach(i)},c=function(){return Promise.resolve().then(f)};c(),s={push:function(m){l.push(m),c()},filter:function(m){return l=l.filter(m),s}}}};return r}function Wr(t,n){return n===void 0&&(n=Ro),Ao(t,n)}function Gc(t){t===void 0&&(t={});var n=Ao(null);return n.options=Dr({async:!0,ssr:!1},t),n}var Po=Wr({},function(t){var n=t.target,s=t.currentTarget;return{target:n,currentTarget:s}}),Lo=Wr(),Yc=Wr(),Jc=Gc({async:!0,ssr:typeof document<"u"}),Xc=o.createContext(void 0),Kc=[],zr=o.forwardRef(function(n,s){var a,r=o.useState(),i=r[0],l=r[1],u=o.useRef(),f=o.useRef(!1),c=o.useRef(null),m=o.useState({}),p=m[1],h=n.children,N=n.disabled,w=N===void 0?!1:N,b=n.noFocusGuards,g=b===void 0?!1:b,y=n.persistentFocus,M=y===void 0?!1:y,L=n.crossFrame,S=L===void 0?!0:L,I=n.autoFocus,k=I===void 0?!0:I;n.allowTextSelection;var T=n.group,E=n.className,V=n.whiteList,H=n.hasPositiveIndices,$=n.shards,ce=$===void 0?Kc:$,me=n.as,xe=me===void 0?"div":me,we=n.lockProps,ye=we===void 0?{}:we,De=n.sideCar,Ue=n.returnFocus,ge=Ue===void 0?!1:Ue,He=n.focusOptions,U=n.onActivation,P=n.onDeactivation,ee=o.useState({}),X=ee[0],re=o.useCallback(function(Ee){var te=Ee.captureFocusRestore;if(!c.current){var Te,C=(Te=document)==null?void 0:Te.activeElement;c.current=C,C!==document.body&&(c.current=te(C))}u.current&&U&&U(u.current),f.current=!0,p()},[U]),se=o.useCallback(function(){f.current=!1,P&&P(u.current),p()},[P]),je=o.useCallback(function(Ee){var te=c.current;if(te){var Te=(typeof te=="function"?te():te)||document.body,C=typeof ge=="function"?ge(Te):ge;if(C){var B=typeof C=="object"?C:void 0;c.current=null,Ee?Promise.resolve().then(function(){return Te.focus(B)}):Te.focus(B)}}},[ge]),le=o.useCallback(function(Ee){f.current&&Po.useMedium(Ee)},[]),Ne=Lo.useMedium,Ie=o.useCallback(function(Ee){u.current!==Ee&&(u.current=Ee,l(Ee))},[]),Se=ea((a={},a[Mo]=w&&"disabled",a[Tr]=T,a),ye),Me=g!==!0,G=Me&&g!=="tail",Ce=qc([s,Ie]),he=o.useMemo(function(){return{observed:u,shards:ce,enabled:!w,active:f.current}},[w,f.current,ce,i]);return dt.createElement(o.Fragment,null,Me&&[dt.createElement("div",{key:"guard-first","data-focus-guard":!0,tabIndex:w?-1:0,style:lr}),H?dt.createElement("div",{key:"guard-nearest","data-focus-guard":!0,tabIndex:w?-1:1,style:lr}):null],!w&&dt.createElement(De,{id:X,sideCar:Jc,observed:i,disabled:w,persistentFocus:M,crossFrame:S,autoFocus:k,whiteList:V,shards:ce,onActivation:re,onDeactivation:se,returnFocus:je,focusOptions:He,noFocusGuards:g}),dt.createElement(xe,ea({ref:Ce},Se,{className:E,onBlur:Ne,onFocus:le}),dt.createElement(Xc.Provider,{value:he},h)),G&&dt.createElement("div",{"data-focus-guard":!0,tabIndex:w?-1:0,style:lr}))});zr.propTypes={};function Ir(t,n){return Ir=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(s,a){return s.__proto__=a,s},Ir(t,n)}function Qc(t,n){t.prototype=Object.create(n.prototype),t.prototype.constructor=t,Ir(t,n)}function ta(t){"@babel/helpers - typeof";return ta=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(n){return typeof n}:function(n){return n&&typeof Symbol=="function"&&n.constructor===Symbol&&n!==Symbol.prototype?"symbol":typeof n},ta(t)}function Zc(t,n){if(ta(t)!="object"||!t)return t;var s=t[Symbol.toPrimitive];if(s!==void 0){var a=s.call(t,n);if(ta(a)!="object")return a;throw new TypeError("@@toPrimitive must return a primitive value.")}return(n==="string"?String:Number)(t)}function ed(t){var n=Zc(t,"string");return ta(n)=="symbol"?n:n+""}function td(t,n,s){return(n=ed(n))in t?Object.defineProperty(t,n,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[n]=s,t}function nd(t,n){function s(a){return a.displayName||a.name||"Component"}return function(r){var i=[],l;function u(){l=t(i.map(function(c){return c.props})),n(l)}var f=(function(c){Qc(m,c);function m(){return c.apply(this,arguments)||this}m.peek=function(){return l};var p=m.prototype;return p.componentDidMount=function(){i.push(this),u()},p.componentDidUpdate=function(){u()},p.componentWillUnmount=function(){var N=i.indexOf(this);i.splice(N,1),u()},p.render=function(){return dt.createElement(r,this.props)},m})(o.PureComponent);return td(f,"displayName","SideEffect("+s(r)+")"),f}}var An=function(t){for(var n=Array(t.length),s=0;s<t.length;++s)n[s]=t[s];return n},us=function(t){return Array.isArray(t)?t:[t]},Oo=function(t){return Array.isArray(t)?t[0]:t},sd=function(t){if(t.nodeType!==Node.ELEMENT_NODE)return!1;var n=window.getComputedStyle(t,null);return!n||!n.getPropertyValue?!1:n.getPropertyValue("display")==="none"||n.getPropertyValue("visibility")==="hidden"},Fo=function(t){return t.parentNode&&t.parentNode.nodeType===Node.DOCUMENT_FRAGMENT_NODE?t.parentNode.host:t.parentNode},Uo=function(t){return t===document||t&&t.nodeType===Node.DOCUMENT_NODE},ad=function(t){return t.hasAttribute("inert")},rd=function(t,n){return!t||Uo(t)||!sd(t)&&!ad(t)&&n(Fo(t))},_o=function(t,n){var s=t.get(n);if(s!==void 0)return s;var a=rd(n,_o.bind(void 0,t));return t.set(n,a),a},id=function(t,n){return t&&!Uo(t)?cd(t)?n(Fo(t)):!1:!0},$o=function(t,n){var s=t.get(n);if(s!==void 0)return s;var a=id(n,$o.bind(void 0,t));return t.set(n,a),a},Bo=function(t){return t.dataset},od=function(t){return t.tagName==="BUTTON"},Vo=function(t){return t.tagName==="INPUT"},Ho=function(t){return Vo(t)&&t.type==="radio"},ld=function(t){return!((Vo(t)||od(t))&&(t.type==="hidden"||t.disabled))},cd=function(t){var n=t.getAttribute(Hc);return![!0,"true",""].includes(n)},qr=function(t){var n;return!!(t&&(!((n=Bo(t))===null||n===void 0)&&n.focusGuard))},Mr=function(t){return!qr(t)},dd=function(t){return!!t},ud=function(t,n){var s=Math.max(0,t.tabIndex),a=Math.max(0,n.tabIndex),r=s-a,i=t.index-n.index;if(r){if(!s)return 1;if(!a)return-1}return r||i},md=function(t){return t.tabIndex<0&&!t.hasAttribute("tabindex")?0:t.tabIndex},Gr=function(t,n,s){return An(t).map(function(a,r){var i=md(a);return{node:a,index:r,tabIndex:s&&i===-1?(a.dataset||{}).focusGuard?0:-1:i}}).filter(function(a){return!n||a.tabIndex>=0}).sort(ud)},hd=["button:enabled","select:enabled","textarea:enabled","input:enabled","a[href]","area[href]","summary","iframe","object","embed","audio[controls]","video[controls]","[tabindex]","[contenteditable]","[autofocus]"],Yr=hd.join(","),fd="".concat(Yr,", [data-focus-guard]"),Wo=function(t,n){return An((t.shadowRoot||t).children).reduce(function(s,a){return s.concat(a.matches(n?fd:Yr)?[a]:[],Wo(a))},[])},pd=function(t,n){var s;return t instanceof HTMLIFrameElement&&(!((s=t.contentDocument)===null||s===void 0)&&s.body)?Ds([t.contentDocument.body],n):[t]},Ds=function(t,n){return t.reduce(function(s,a){var r,i=Wo(a,n),l=(r=[]).concat.apply(r,i.map(function(u){return pd(u,n)}));return s.concat(l,a.parentNode?An(a.parentNode.querySelectorAll(Yr)).filter(function(u){return u===a}):[])},[])},xd=function(t){var n=t.querySelectorAll("[".concat(Vc,"]"));return An(n).map(function(s){return Ds([s])}).reduce(function(s,a){return s.concat(a)},[])},Jr=function(t,n){return An(t).filter(function(s){return _o(n,s)}).filter(function(s){return ld(s)})},Ki=function(t,n){return n===void 0&&(n=new Map),An(t).filter(function(s){return $o(n,s)})},Xr=function(t,n,s){return Gr(Jr(Ds(t,s),n),!0,s)},na=function(t,n){return Gr(Jr(Ds(t),n),!1)},bd=function(t,n){return Jr(xd(t),n)},ds=function(t,n){return t.shadowRoot?ds(t.shadowRoot,n):Object.getPrototypeOf(t).contains!==void 0&&Object.getPrototypeOf(t).contains.call(t,n)?!0:An(t.children).some(function(s){var a;if(s instanceof HTMLIFrameElement){var r=(a=s.contentDocument)===null||a===void 0?void 0:a.body;return r?ds(r,n):!1}return ds(s,n)})},gd=function(t){for(var n=new Set,s=t.length,a=0;a<s;a+=1)for(var r=a+1;r<s;r+=1){var i=t[a].compareDocumentPosition(t[r]);(i&Node.DOCUMENT_POSITION_CONTAINED_BY)>0&&n.add(r),(i&Node.DOCUMENT_POSITION_CONTAINS)>0&&n.add(a)}return t.filter(function(l,u){return!n.has(u)})},zo=function(t){return t.parentNode?zo(t.parentNode):t},Kr=function(t){var n=us(t);return n.filter(Boolean).reduce(function(s,a){var r=a.getAttribute(Tr);return s.push.apply(s,r?gd(An(zo(a).querySelectorAll("[".concat(Tr,'="').concat(r,'"]:not([').concat(Mo,'="disabled"])')))):[a]),s},[])},vd=function(t){try{return t()}catch{return}},sa=function(t){if(t===void 0&&(t=document),!(!t||!t.activeElement)){var n=t.activeElement;return n.shadowRoot?sa(n.shadowRoot):n instanceof HTMLIFrameElement&&vd(function(){return n.contentWindow.document})?sa(n.contentWindow.document):n}},yd=function(t,n){return t===n},wd=function(t,n){return!!An(t.querySelectorAll("iframe")).some(function(s){return yd(s,n)})},qo=function(t,n){return n===void 0&&(n=sa(Oo(t).ownerDocument)),!n||n.dataset&&n.dataset.focusGuard?!1:Kr(t).some(function(s){return ds(s,n)||wd(s,n)})},jd=function(t){t===void 0&&(t=document);var n=sa(t);return n?An(t.querySelectorAll("[".concat(Bc,"]"))).some(function(s){return ds(s,n)}):!1},Nd=function(t,n){return n.filter(Ho).filter(function(s){return s.name===t.name}).filter(function(s){return s.checked})[0]||t},Qr=function(t,n){return Ho(t)&&t.name?Nd(t,n):t},Sd=function(t){var n=new Set;return t.forEach(function(s){return n.add(Qr(s,t))}),t.filter(function(s){return n.has(s)})},Qi=function(t){return t[0]&&t.length>1?Qr(t[0],t):t[0]},Zi=function(t,n){return t.indexOf(Qr(n,t))},Rr="NEW_FOCUS",Cd=function(t,n,s,a,r){var i=t.length,l=t[0],u=t[i-1],f=qr(a);if(!(a&&t.indexOf(a)>=0)){var c=a!==void 0?s.indexOf(a):-1,m=r?s.indexOf(r):c,p=r?t.indexOf(r):-1;if(c===-1)return p!==-1?p:Rr;if(p===-1)return Rr;var h=c-m,N=s.indexOf(l),w=s.indexOf(u),b=Sd(s),g=a!==void 0?b.indexOf(a):-1,y=r?b.indexOf(r):g,M=b.filter(function(E){return E.tabIndex>=0}),L=a!==void 0?M.indexOf(a):-1,S=r?M.indexOf(r):L,I=L>=0&&S>=0?S-L:y-g;if(!h&&p>=0||n.length===0)return p;var k=Zi(t,n[0]),T=Zi(t,n[n.length-1]);if(c<=N&&f&&Math.abs(h)>1)return T;if(c>=w&&f&&Math.abs(h)>1)return k;if(h&&Math.abs(I)>1)return p;if(c<=N)return T;if(c>w)return k;if(h)return Math.abs(h)>1?p:(i+p+h)%i}},kd=function(t){return function(n){var s,a=(s=Bo(n))===null||s===void 0?void 0:s.autofocus;return n.autofocus||a!==void 0&&a!=="false"||t.indexOf(n)>=0}},eo=function(t,n,s){var a=t.map(function(i){var l=i.node;return l}),r=Ki(a.filter(kd(s)));return r&&r.length?Qi(r):Qi(Ki(n))},Ar=function(t,n){return n===void 0&&(n=[]),n.push(t),t.parentNode&&Ar(t.parentNode.host||t.parentNode,n),n},cr=function(t,n){for(var s=Ar(t),a=Ar(n),r=0;r<s.length;r+=1){var i=s[r];if(a.indexOf(i)>=0)return i}return!1},Go=function(t,n,s){var a=us(t),r=us(n),i=a[0],l=!1;return r.filter(Boolean).forEach(function(u){l=cr(l||u,u)||l,s.filter(Boolean).forEach(function(f){var c=cr(i,f);c&&(!l||ds(c,l)?l=c:l=cr(c,l))})}),l},to=function(t,n){return t.reduce(function(s,a){return s.concat(bd(a,n))},[])},Ed=function(t,n){var s=new Map;return n.forEach(function(a){return s.set(a.node,a)}),t.map(function(a){return s.get(a)}).filter(dd)},Td=function(t,n){var s=sa(us(t).length>0?document:Oo(t).ownerDocument),a=Kr(t).filter(Mr),r=Go(s||t,t,a),i=new Map,l=na(a,i),u=l.filter(function(w){var b=w.node;return Mr(b)});if(u[0]){var f=na([r],i).map(function(w){var b=w.node;return b}),c=Ed(f,u),m=c.map(function(w){var b=w.node;return b}),p=c.filter(function(w){var b=w.tabIndex;return b>=0}).map(function(w){var b=w.node;return b}),h=Cd(m,p,f,s,n);if(h===Rr){var N=eo(l,p,to(a,i))||eo(l,m,to(a,i));if(N)return{node:N};console.warn("focus-lock: cannot find any node to move focus into");return}return h===void 0?h:c[h]}},Dd=function(t){var n=Kr(t).filter(Mr),s=Go(t,t,n),a=Gr(Ds([s],!0),!0,!0),r=Ds(n,!1);return a.map(function(i){var l=i.node,u=i.index;return{node:l,index:u,lockItem:r.indexOf(l)>=0,guard:qr(l)}})},Zr=function(t,n){t&&("focus"in t&&t.focus(n),"contentWindow"in t&&t.contentWindow&&t.contentWindow.focus())},dr=0,ur=!1,Yo=function(t,n,s){s===void 0&&(s={});var a=Td(t,n);if(!ur&&a){if(dr>2){console.error("FocusLock: focus-fighting detected. Only one focus management system could be active. See https://github.com/theKashey/focus-lock/#focus-fighting"),ur=!0,setTimeout(function(){ur=!1},1);return}dr++,Zr(a.node,s.focusOptions),dr--}};function qs(t){if(!t)return null;if(typeof WeakRef>"u")return function(){return t||null};var n=t?new WeakRef(t):null;return function(){return n?.deref()||null}}var Id=function(t){if(!t)return null;for(var n=[],s=t;s&&s!==document.body;)n.push({current:qs(s),parent:qs(s.parentElement),left:qs(s.previousElementSibling),right:qs(s.nextElementSibling)}),s=s.parentElement;return{element:qs(t),stack:n,ownerDocument:t.ownerDocument}},Md=function(t){var n,s,a,r,i;if(t)for(var l=t.stack,u=t.ownerDocument,f=new Map,c=0,m=l;c<m.length;c++){var p=m[c],h=(n=p.parent)===null||n===void 0?void 0:n.call(p);if(h&&u.contains(h)){for(var N=(s=p.left)===null||s===void 0?void 0:s.call(p),w=p.current(),b=h.contains(w)?w:void 0,g=(a=p.right)===null||a===void 0?void 0:a.call(p),y=Xr([h],f),M=(i=(r=b??N?.nextElementSibling)!==null&&r!==void 0?r:g)!==null&&i!==void 0?i:N;M;){for(var L=0,S=y;L<S.length;L++){var I=S[L];if(M?.contains(I.node))return I.node}M=M.nextElementSibling}if(y.length)return y[0].node}}},Jo=function(t){var n=Id(t);return function(){return Md(n)}},Rd=function(t,n,s){if(!t||!n)return console.error("no element or scope given"),{};var a=us(n);if(a.every(function(l){return!ds(l,t)}))return console.error("Active element is not contained in the scope"),{};var r=s?Xr(a,new Map):na(a,new Map),i=r.findIndex(function(l){var u=l.node;return u===t});if(i!==-1)return{prev:r[i-1],next:r[i+1],first:r[0],last:r[r.length-1]}},Ad=function(t,n){var s=n?Xr(us(t),new Map):na(us(t),new Map);return{first:s[0],last:s[s.length-1]}},Pd=function(t){return Object.assign({scope:document.body,cycle:!0,onlyTabbable:!0},t)},Xo=function(t,n,s){n===void 0&&(n={});var a=Pd(n),r=Rd(t,a.scope,a.onlyTabbable);if(r){var i=s(r,a.cycle);i&&Zr(i.node,a.focusOptions)}},Ld=function(t,n){n===void 0&&(n={}),Xo(t,n,function(s,a){var r=s.next,i=s.first;return r||a&&i})},Od=function(t,n){n===void 0&&(n={}),Xo(t,n,function(s,a){var r=s.prev,i=s.last;return r||a&&i})},Ko=function(t,n,s){var a,r=Ad(t,(a=n.onlyTabbable)!==null&&a!==void 0?a:!0),i=r[s];i&&Zr(i.node,n.focusOptions)},Fd=function(t,n){n===void 0&&(n={}),Ko(t,n,"first")},Ud=function(t,n){n===void 0&&(n={}),Ko(t,n,"last")};function ei(t){setTimeout(t,1)}var _d=function(n){return n&&"current"in n?n.current:n},Qo=function(){return document&&document.activeElement===document.body},$d=function(){return Qo()||jd()},ks=null,tn=null,no=function(){return null},Es=null,aa=!1,ti=!1,Bd=function(){return!0},Vd=function(n){return(ks.whiteList||Bd)(n)},Hd=function(n,s){Es={observerNode:n,portaledElement:s}},Wd=function(n){return Es&&Es.portaledElement===n};function so(t,n,s,a){var r=null,i=t;do{var l=a[i];if(l.guard)l.node.dataset.focusAutoGuard&&(r=l);else if(l.lockItem){if(i!==t)return;r=null}else break}while((i+=s)!==n);r&&(r.node.tabIndex=0)}var zd=function(n){return n?!!aa:aa==="meanwhile"},qd=function t(n,s,a){return s&&(s.host===n&&(!s.activeElement||a.contains(s.activeElement))||s.parentNode&&t(n,s.parentNode,a))},Gd=function(n,s){return s.some(function(a){return qd(n,a,a)})},Zo=function(n){return na(n,new Map)},Yd=function(n){return!Zo([n.parentNode]).some(function(s){return s.node===n})},Ha=function(){var n=!1;if(ks){var s=ks,a=s.observed,r=s.persistentFocus,i=s.autoFocus,l=s.shards,u=s.crossFrame,f=s.focusOptions,c=s.noFocusGuards,m=a||Es&&Es.portaledElement;if(Qo()&&tn&&tn!==document.body&&(!document.body.contains(tn)||Yd(tn))){var p=no();p&&p.focus()}var h=document&&document.activeElement;if(m){var N=[m].concat(l.map(_d).filter(Boolean)),w=function(){if(!zd(u)||!c||!tn||ti)return!1;var L=Zo(N),S=L.findIndex(function(I){var k=I.node;return k===tn});return S===0||S===L.length-1};if((!h||Vd(h))&&(r||w()||!$d()||!tn&&i)&&(m&&!(qo(N)||h&&Gd(h,N)||Wd(h))&&(document&&!tn&&h&&!i?(h.blur&&h.blur(),document.body.focus()):(n=Yo(N,tn,{focusOptions:f}),Es={})),tn=document&&document.activeElement,tn!==document.body&&(no=Jo(tn)),aa=!1),document&&h!==document.activeElement&&document.querySelector("[data-focus-auto-guard]")){var b=document&&document.activeElement,g=Dd(N),y=g.map(function(M){var L=M.node;return L}).indexOf(b);y>-1&&(g.filter(function(M){var L=M.guard,S=M.node;return L&&S.dataset.focusAutoGuard}).forEach(function(M){var L=M.node;return L.removeAttribute("tabIndex")}),so(y,g.length,1,g),so(y,-1,-1,g))}}}return n},el=function(n){Ha()&&n&&(n.stopPropagation(),n.preventDefault())},ni=function(){return ei(Ha)},Jd=function(n){var s=n.target,a=n.currentTarget;a.contains(s)||Hd(a,s)},Xd=function(){return null},tl=function(){ti=!0},nl=function(){ti=!1,aa="just",ei(function(){aa="meanwhile"})},Kd=function(){document.addEventListener("focusin",el),document.addEventListener("focusout",ni),window.addEventListener("focus",tl),window.addEventListener("blur",nl)},Qd=function(){document.removeEventListener("focusin",el),document.removeEventListener("focusout",ni),window.removeEventListener("focus",tl),window.removeEventListener("blur",nl)};function Zd(t){return t.filter(function(n){var s=n.disabled;return!s})}var sl={moveFocusInside:Yo,focusInside:qo,focusNextElement:Ld,focusPrevElement:Od,focusFirstElement:Fd,focusLastElement:Ud,captureFocusRestore:Jo};function eu(t){var n=t.slice(-1)[0];n&&!ks&&Kd();var s=ks,a=s&&n&&n.id===s.id;ks=n,s&&!a&&(s.onDeactivation(),t.filter(function(r){var i=r.id;return i===s.id}).length||s.returnFocus(!n)),n?(tn=null,(!a||s.observed!==n.observed)&&n.onActivation(sl),Ha(),ei(Ha)):(Qd(),tn=null)}Po.assignSyncMedium(Jd);Lo.assignMedium(ni);Yc.assignMedium(function(t){return t(sl)});const tu=nd(Zd,eu)(Xd);var Bn=o.forwardRef(function(n,s){return dt.createElement(zr,ea({sideCar:tu,ref:s},n))}),al=zr.propTypes||{};al.sideCar;$c(al,["sideCar"]);Bn.propTypes={};var Pr=Do();const nu=t=>`ndn_online_quota_${t}`;function mr(t=new Date){const n=new Date(Date.UTC(t.getFullYear(),t.getMonth(),t.getDate())),s=n.getUTCDay()||7;n.setUTCDate(n.getUTCDate()+4-s);const a=new Date(Date.UTC(n.getUTCFullYear(),0,1)),r=Math.ceil(((n.getTime()-a.getTime())/864e5+1)/7),i=String(r).padStart(2,"0");return`${n.getUTCFullYear()}-${i}`}function su(t){try{const n=localStorage.getItem(nu(t));if(!n)return{week:mr(),used:0};const s=JSON.parse(n),a=mr();return!s.week||s.week!==a?{week:a,used:0}:{week:String(s.week),used:Number(s.used)||0}}catch{return{week:mr(),used:0}}}function au(t,n=3){const s=su(t);return Math.max(0,n-(s.used||0))}const rl={BASE_URL:"/",DEV:!1,MODE:"production",PROD:!0,SSR:!1,VITE_API_URL:"http://localhost:8787",VITE_WS_URL:"ws://localhost:8787"},il="ndn:isAdmin:v1";function ol(){try{const t=localStorage.getItem(il);return t?JSON.parse(t):{}}catch{return{}}}function ru(t,n){try{const s=ol();s[(t||"").toLowerCase()]={v:n,ts:Date.now()},localStorage.setItem(il,JSON.stringify(s))}catch{}}async function iu(t){const n=String(t||"").toLowerCase();if(!n)return!1;try{const r=String(rl?.VITE_OWNER_EMAIL||"").toLowerCase();if(r&&n===r)return!0}catch{}if(n==="daviesfamily108@gmail.com")return!0;try{const r=localStorage.getItem("ndn:forceAdmin");if(r==="1"||r==="true")return!0}catch{}const a=ol()[n];if(a&&Date.now()-a.ts<300*1e3)return!!a.v;try{const l=!!(await(await fetch(`/api/admins/check?email=${encodeURIComponent(n)}`)).json().catch(()=>({})))?.isAdmin;return ru(n,l),l}catch{return!!a?.v}}function ll(t){const n=String(t||"").toLowerCase(),[s,a]=o.useState(!1);return o.useEffect(()=>{let r=!0;if(!n){a(!1);return}try{const i=String(rl?.VITE_OWNER_EMAIL||"").toLowerCase(),l=(()=>{try{const u=localStorage.getItem("ndn:forceAdmin");return u==="1"||u==="true"}catch{return!1}})();if(i&&n===i){a(!0);return}if(l){a(!0);return}}catch{}if(n==="daviesfamily108@gmail.com"){a(!0);return}return iu(n).then(i=>{r&&a(!!i)}),()=>{r=!1}},[n]),s}const ou={},lu=5,cu={GBP:1,EUR:1.16,USD:1.26,AUD:1.92,NZD:2.08,CAD:1.73};function Ff(t,n=lu){const s=(t||"GBP").toUpperCase(),a=cu[s]??1,r=n*a;try{return new Intl.NumberFormat(void 0,{style:"currency",currency:s}).format(r)}catch{return`${s} ${r.toFixed(2)}`}}function Uf(){try{const t=new Intl.NumberFormat().resolvedOptions(),n=String(t.locale).toLowerCase();return n.includes("-gb")?"GBP":n.includes("-ie")||n.includes("-de")||n.includes("-fr")||n.includes("-es")||n.includes("-it")||n.includes("-nl")?"EUR":n.includes("-us")?"USD":n.includes("-au")?"AUD":n.includes("-nz")?"NZD":n.includes("-ca")?"CAD":"GBP"}catch{return"GBP"}}const du=ou?.VITE_DISCORD_INVITE_URL||"https://discord.gg/nCfT4hJz",uu={};let gn=null;const mu=uu?.VITE_REMOTE_API_FALLBACK||"",hr=(mu.trim()||"https://ninedartnation-1.onrender.com").replace(/\/$/,""),hu=new Set(["localhost","127.0.0.1"]);function cl(){if(gn)return gn;const t="http://localhost:8787".trim();if(t){const n=t.replace(/\/$/,"");return typeof window<"u"&&/https?:\/\/(localhost|127\.0\.0\.1)(:\\d+)?/i.test(n)&&!hu.has(window.location.hostname)?(gn=hr,gn):(gn=n,gn)}if(typeof window<"u"){const{protocol:n,host:s,hostname:a}=window.location,r=`${n}//${s}`;return a.endsWith("onrender.com")||a==="localhost"||a==="127.0.0.1"?gn=r.replace(/\/$/,""):gn=hr,gn}return gn=hr,gn}function fu(t){if(/^https?:\/\//i.test(t))return t;const n=cl(),s=t.startsWith("/")?t:`/${t}`;return`${n}${s}`}function _a(t){return fu(t)}function dl(){return cl()}function ss(t,n){const s=_a(t);try{if(window.__ndnApiDisabled)return Promise.resolve({ok:!1,status:503,json:async()=>({})})}catch{}return fetch(s,n).catch(a=>{try{window.__ndnApiDisabled=!0}catch{}return{ok:!1,status:503,json:async()=>({})}}).then(a=>{try{const r=new URL(String(s)).hostname;a&&a.status===404&&r!==window.location.hostname&&(window.__ndnApiDisabled=!0)}catch{}return a})}function pu(){if(typeof window>"u"||typeof window.fetch!="function")return;const t=window;if(t.__ndnApiPatched)return;const n=window.fetch.bind(window);window.fetch=(s,a)=>{try{if(typeof s=="string")return s.startsWith("/")?n(_a(s),a):n(s,a);if(s instanceof Request){const r=s.url.startsWith("/")?_a(s.url):s.url;if(r===s.url)return n(s,a);const i=new Request(r,s);return n(i,a)}if(s instanceof URL){const r=s.href.startsWith("/")?_a(s.href):s.href;return n(r,a)}}catch(r){console.warn("[API] Interceptor failed, falling back to original fetch",r)}return n(s,a)},t.__ndnApiPatched=!0}function xu(t){const n=[{key:"score",label:"Home ðŸ ",icon:bc},{key:"online",label:"Online Play ðŸŒ",icon:Va},{key:"offline",label:"Offline ðŸ†",icon:Cs},{key:"tournaments",label:"Tournaments ðŸŸï¸",icon:Cs},{key:"friends",label:"Friends ðŸ‘¥",icon:Va},{key:"stats",label:"Stats ðŸ“Š",icon:Cs},{key:"calibrate",label:"Calibrate ðŸ“",icon:Fa},{key:"settings",label:"Settings âš™ï¸",icon:Qs}];function s(a){if(!a)return!1;const r=a.subscription;if(!r)return!!a.fullAccess;if(r.fullAccess){if(r.expiresAt){const i=typeof r.expiresAt=="string"?Date.parse(r.expiresAt):Number(r.expiresAt);if(!isNaN(i))return i>Date.now()}return r.status?r.status==="active":!0}return!1}return s(t)||n.push({key:"fullaccess",label:"PREMIUM Â£â‚¬$ âœ¨",icon:gc}),n}function bu(t){let n=t;if(!t?.subscription&&t?.email)try{const s=localStorage?.getItem;if(typeof s=="function"){const a=s.call(localStorage,`ndn:subscription:${t.email}`);if(a){const r=JSON.parse(a);n={...t,subscription:r,fullAccess:r.fullAccess||t.fullAccess}}}}catch{}return n}function ul(t,n){const s=[...xu(t)];if(n&&!s.some(a=>a.key==="admin")){const a={key:"admin",label:"Admin ðŸ›¡ï¸",icon:Qs},r=s.findIndex(i=>i.key==="settings");r>=0?s.splice(r,0,a):s.push(a)}return s}function ml({active:t,onChange:n,user:s,className:a}){const r=dt.useRef(null),i=dt.useRef(!1),l=dt.useRef(0),u=dt.useRef(0),f=H=>{i.current=!0,r.current&&(l.current=H.pageY-r.current.offsetTop,u.current=r.current.scrollTop,r.current.style.cursor="grabbing")},c=()=>{i.current=!1,r.current&&(r.current.style.cursor="grab")},m=()=>{i.current=!1,r.current&&(r.current.style.cursor="grab")},p=H=>{if(!i.current||!r.current)return;H.preventDefault();const ce=(H.pageY-r.current.offsetTop-l.current)*2;r.current.scrollTop=u.current-ce},h=bu(s),N=ll(s?.email),w=ul(h,N),[b,g]=o.useState(!1),[y,M]=o.useState(!1),L=s?.username&&!s?.fullAccess?au(s.username):1/0,[S,I]=o.useState({friendRequests:0,messages:0,tournaments:0});o.useEffect(()=>{if(!s?.email)return;let H=!0;const $={count:0};let ce=null;const me=async()=>{try{if(!H||window.__ndnApiDisabled||ce&&Date.now()<ce)return;const[ye,De]=await Promise.all([ss(`/api/friends/requests?email=${encodeURIComponent(s.email)}`),ss(`/api/friends/messages?email=${encodeURIComponent(s.email)}`)]),Ue=ye&&ye.ok?await ye.json():{requests:[]},He=(De&&De.ok?await De.json():{messages:[]}).messages?.filter(U=>!U.read).length||0;I({friendRequests:Ue.requests?.length||0,messages:He,tournaments:0}),$.count=0,ce=null}catch(we){console.error("Failed to fetch notifications:",we),$.count+=1,$.count>=3&&(ce=Date.now()+300*1e3,console.warn("Sidebar notifications polling paused for 5m due to repeated failures"))}};me();const xe=setInterval(me,3e4);return()=>{H=!1,clearInterval(xe)}},[s?.email]),o.useEffect(()=>{if(!b)return;const H=$=>{($.key==="Escape"||$.key==="Enter")&&g(!1)};return document.addEventListener("keydown",H),()=>document.removeEventListener("keydown",H)},[b]);const k=w.filter(H=>["score","online","offline","tournaments"].includes(H.key)),T=w.filter(H=>["friends"].includes(H.key)),E=w.filter(H=>["stats","calibrate","settings","admin","fullaccess"].includes(H.key)),V=H=>{const{key:$,label:ce,icon:me}=H,xe=t===$;let we=0;return $==="friends"&&(we=S.friendRequests),$==="score"&&(we=S.messages+S.tournaments),e.jsxs("button",{className:`tab whitespace-nowrap flex items-center justify-between gap-3 ${xe?"tab--active":"tab--inactive"} ${$==="fullaccess"?"tab--premium":""}`,onClick:()=>n($),title:ce,children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(me,{className:`w-5 h-5 ${xe?"text-white":"text-slate-400"}`}),e.jsx("span",{className:`font-semibold text-[1rem] ${xe?"text-white":"text-slate-300"}`,children:ce})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[$==="online"&&!s?.fullAccess&&L<=0&&e.jsx(xc,{className:"w-3 h-3 text-rose-500"}),we>0&&e.jsx("span",{className:"notification-badge animate-pulse",children:we>9?"9+":we})]})]},$)};return e.jsxs("aside",{ref:r,onMouseDown:f,onMouseLeave:c,onMouseUp:m,onMouseMove:p,className:`${s?.fullAccess?"premium-sidebar":""} sidebar glass ${a?"":"w-72"} p-5 rounded-2xl ${a??"hidden sm:flex"} flex-col gap-8 overflow-y-auto overflow-x-hidden ${a?"":"fixed top-4 bottom-4 left-4"}`,children:[e.jsx("div",{className:"px-2 mb-2",children:e.jsxs("h1",{className:"text-2xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-purple-400 tracking-tight",children:["NINE DART",e.jsx("br",{}),"NATION"]})}),e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx("h3",{className:"text-xs font-bold text-slate-500 uppercase tracking-wider px-3 mb-2",children:"Play"}),k.map(V)]}),e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx("h3",{className:"text-xs font-bold text-slate-500 uppercase tracking-wider px-3 mb-2",children:"Social"}),T.map(V)]}),e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx("h3",{className:"text-xs font-bold text-slate-500 uppercase tracking-wider px-3 mb-2",children:"System"}),E.map(H=>{const $=V(H);return H.key==="settings"?e.jsxs(dt.Fragment,{children:[$,e.jsxs("button",{className:"tab tab--compact whitespace-nowrap flex items-center justify-start gap-3 bg-[#5865F2]/10 hover:bg-[#5865F2]/20 text-[#5865F2] transition-colors ml-4 border-l-2 border-[#5865F2]/30",onClick:()=>g(!0),title:"BullseyeDartsLeague",children:[e.jsx(Rn,{className:"w-4 h-4"}),e.jsx("span",{className:"truncate text-sm font-semibold",children:"Bullseye League"})]}),e.jsxs("button",{className:"tab tab--compact whitespace-nowrap flex items-center justify-start gap-3 bg-[#5865F2]/10 hover:bg-[#5865F2]/20 text-[#5865F2] transition-colors ml-4 border-l-2 border-[#5865F2]/30",onClick:()=>M(!0),title:"NineDartNation",children:[e.jsx(Rn,{className:"w-4 h-4"}),e.jsx("span",{className:"truncate text-sm font-semibold",children:"NDN Community"})]})]},H.key):$})]}),b&&Pr.createPortal(e.jsxs("div",{className:"fixed inset-0 z-[1000]",children:[e.jsx("button",{className:"absolute inset-0 bg-black/50",onClick:()=>g(!1),onTouchStart:()=>g(!1),"aria-label":"Close Discord dialog"}),e.jsx("div",{className:"absolute inset-0 flex items-center justify-center p-4",children:e.jsx(Bn,{returnFocus:!0,children:e.jsxs("div",{role:"dialog","aria-modal":"true",className:"card max-w-md w-full relative text-left p-6 rounded-xl",children:[e.jsx("button",{className:"absolute -top-3 -right-3 btn px-3 py-1","aria-label":"Close",onClick:()=>g(!1),children:"âœ•"}),e.jsxs("h3",{className:"text-xl font-bold mb-2 flex items-center gap-2 text-[#8ea1e1]",children:[e.jsx(Rn,{className:"w-6 h-6"})," BullseyeDartsLeague ðŸŽ¯"]}),e.jsx("div",{className:"mb-4 text-lg font-semibold",children:"Join this fantastic Online Darts League with divisions and other cool stuff included"}),e.jsx("a",{href:du,target:"_blank",rel:"noopener noreferrer nofollow",className:"btn bg-[#5865F2] text-white w-full font-bold text-lg",children:"Join Discord ðŸ’¬"})]})})})]}),document.body),y&&Pr.createPortal(e.jsxs("div",{className:"fixed inset-0 z-[1000]",children:[e.jsx("button",{className:"absolute inset-0 bg-black/50",onClick:()=>M(!1),onTouchStart:()=>M(!1),"aria-label":"Close NineDartNation dialog"}),e.jsx("div",{className:"absolute inset-0 flex items-center justify-center p-4",children:e.jsx(Bn,{returnFocus:!0,children:e.jsxs("div",{role:"dialog","aria-modal":"true",className:"card max-w-md w-full relative text-left p-6 rounded-xl",children:[e.jsx("button",{className:"absolute -top-3 -right-3 btn px-3 py-1","aria-label":"Close",onClick:()=>M(!1),children:"âœ•"}),e.jsxs("h3",{className:"text-xl font-bold mb-2 flex items-center gap-2 text-[#8ea1e1]",children:[e.jsx(Rn,{className:"w-6 h-6"})," NineDartNation ðŸŽ¯"]}),e.jsx("div",{className:"mb-4 text-lg font-semibold",children:"Join the NineDartNation ðŸŽ¯ Discord community"}),e.jsx("a",{href:"https://discord.gg/Q33J5FTVve",target:"_blank",rel:"noopener noreferrer nofollow",className:"btn bg-[#5865F2] text-white w-full font-bold text-lg",children:"Join Discord ðŸ’¬"})]})})})]}),document.body)]})}function Mn({children:t,className:n,style:s}){const a=o.useRef(null),[r,i]=o.useState(0);return o.useEffect(()=>{let l=0,u=0;const f=()=>{const p=document.getElementById("ndn-header");if(!p){u!==0&&(u=0,i(0));return}const h=document.getElementById("ndn-main-scroll"),N=h?h.scrollTop:window.scrollY||0,w=p.getBoundingClientRect().height,b=N>0?w:0;Math.abs(b-u)>1&&(u=b,i(b))};f();const c=()=>{l&&cancelAnimationFrame(l),l=requestAnimationFrame(f)},m=document.getElementById("ndn-main-scroll");return m?.addEventListener("scroll",c,{passive:!0}),window.addEventListener("scroll",c,{passive:!0}),window.addEventListener("resize",c,{passive:!0}),()=>{m?.removeEventListener("scroll",c),window.removeEventListener("scroll",c),window.removeEventListener("resize",c),l&&cancelAnimationFrame(l)}},[]),e.jsxs("div",{ref:a,className:n,style:{...s,position:"relative",willChange:"transform",transform:"translateZ(0)"},children:[r>0&&e.jsx("div",{style:{position:"absolute",left:0,right:0,top:0,height:r,pointerEvents:"none",zIndex:20,background:"linear-gradient(to bottom, rgba(17,24,39,1), rgba(17,24,39,0))",willChange:"height",transform:"translateZ(0)"}}),t]})}const gu={dash:"â€”",bullet:"â€¢",middot:"Â·",ellipsis:"â€¦",ok:"âœ“",no:"âœ—",warn:"!",info:"i",lock:"LOCK",refresh:"â†»",camera:"CAM",target:"â—Ž",spinner:"â€¦"};function Xs(t){return gu[t]}const vu={},ao=t=>{let n;const s=new Set,a=(m,p)=>{const h=typeof m=="function"?m(n):m;if(!Object.is(h,n)){const N=n;n=p??(typeof h!="object"||h===null)?h:Object.assign({},n,h),s.forEach(w=>w(n,N))}},r=()=>n,f={setState:a,getState:r,getInitialState:()=>c,subscribe:m=>(s.add(m),()=>s.delete(m)),destroy:()=>{(vu?"production":void 0)!=="production"&&console.warn("[DEPRECATED] The `destroy` method will be unsupported in a future version. Instead use unsubscribe function returned by subscribe. Everything will be garbage-collected if store is garbage-collected."),s.clear()}},c=n=t(a,r,f);return f},yu=t=>t?ao(t):ao;var fr={exports:{}},pr={},xr={exports:{}},br={};/**
 * @license React
 * use-sync-external-store-shim.production.js
 *
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var ro;function wu(){if(ro)return br;ro=1;var t=Br();function n(p,h){return p===h&&(p!==0||1/p===1/h)||p!==p&&h!==h}var s=typeof Object.is=="function"?Object.is:n,a=t.useState,r=t.useEffect,i=t.useLayoutEffect,l=t.useDebugValue;function u(p,h){var N=h(),w=a({inst:{value:N,getSnapshot:h}}),b=w[0].inst,g=w[1];return i(function(){b.value=N,b.getSnapshot=h,f(b)&&g({inst:b})},[p,N,h]),r(function(){return f(b)&&g({inst:b}),p(function(){f(b)&&g({inst:b})})},[p]),l(N),N}function f(p){var h=p.getSnapshot;p=p.value;try{var N=h();return!s(p,N)}catch{return!0}}function c(p,h){return h()}var m=typeof window>"u"||typeof window.document>"u"||typeof window.document.createElement>"u"?c:u;return br.useSyncExternalStore=t.useSyncExternalStore!==void 0?t.useSyncExternalStore:m,br}var io;function ju(){return io||(io=1,xr.exports=wu()),xr.exports}/**
 * @license React
 * use-sync-external-store-shim/with-selector.production.js
 *
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var oo;function Nu(){if(oo)return pr;oo=1;var t=Br(),n=ju();function s(c,m){return c===m&&(c!==0||1/c===1/m)||c!==c&&m!==m}var a=typeof Object.is=="function"?Object.is:s,r=n.useSyncExternalStore,i=t.useRef,l=t.useEffect,u=t.useMemo,f=t.useDebugValue;return pr.useSyncExternalStoreWithSelector=function(c,m,p,h,N){var w=i(null);if(w.current===null){var b={hasValue:!1,value:null};w.current=b}else b=w.current;w=u(function(){function y(k){if(!M){if(M=!0,L=k,k=h(k),N!==void 0&&b.hasValue){var T=b.value;if(N(T,k))return S=T}return S=k}if(T=S,a(L,k))return T;var E=h(k);return N!==void 0&&N(T,E)?(L=k,T):(L=k,S=E)}var M=!1,L,S,I=p===void 0?null:p;return[function(){return y(m())},I===null?void 0:function(){return y(I())}]},[m,p,h,N]);var g=r(c,w[0],w[1]);return l(function(){b.hasValue=!0,b.value=g},[g]),f(g),g},pr}var lo;function Su(){return lo||(lo=1,fr.exports=Nu()),fr.exports}var Cu=Su();const ku=Io(Cu),hl={},{useDebugValue:Eu}=dt,{useSyncExternalStoreWithSelector:Tu}=ku;let co=!1;const Du=t=>t;function Iu(t,n=Du,s){(hl?"production":void 0)!=="production"&&s&&!co&&(console.warn("[DEPRECATED] Use `createWithEqualityFn` instead of `create` or use `useStoreWithEqualityFn` instead of `useStore`. They can be imported from 'zustand/traditional'. https://github.com/pmndrs/zustand/discussions/1937"),co=!0);const a=Tu(t.subscribe,t.getState,t.getServerState||t.getInitialState,n,s);return Eu(a),a}const uo=t=>{(hl?"production":void 0)!=="production"&&typeof t!="function"&&console.warn("[DEPRECATED] Passing a vanilla store will be unsupported in a future version. Instead use `import { useStore } from 'zustand'`.");const n=typeof t=="function"?yu(t):t,s=(a,r)=>Iu(n,a,r);return Object.assign(s,n),s},Vn=t=>t?uo(t):uo;function Le(...t){}const fl="ndn_user_settings";function Lr(){try{const t=localStorage.getItem(fl);if(!t)return{favoriteDouble:"D16",callerEnabled:!0,callerVoice:"",callerVolume:1,speakCheckoutOnly:!1,avgMode:"all-time",autoStartOffline:!1,rememberLastOffline:!0,lastOffline:{mode:"X01",x01Start:501,firstTo:1,aiLevel:"None"},reducedMotion:!1,compactHeader:!1,allowSpectate:!0,cameraScale:1,cameraAspect:"wide",cameraFitMode:"fit",cameraRecordDarts:!1,cameraShowLabels:!1,cameraLowLatency:!1,cameraProcessingFps:15,calibrationGuide:!0,preferredCameraId:void 0,preferredCameraLabel:void 0,preserveCalibrationOverlay:!0,preserveCalibrationOnCameraChange:!0,cameraEnabled:!0,hideCameraOverlay:!1,offlineLayout:"modern",hideInGameSidebar:!0,autoscoreProvider:"built-in",autoscoreWsUrl:"",autoCommitMode:"wait-for-clear",confirmUncertainDarts:!0,autoScoreConfidenceThreshold:.85,autoscoreDetectorMinArea:30,autoscoreDetectorThresh:15,autoscoreDetectorRequireStableN:2,harshLightingMode:!1,enhanceBigTrebles:!1,allowAutocommitInOnline:!1,textSize:"medium",boxSize:"medium",matchType:"singles",teamAName:"Team A",teamBName:"Team B",dartTimerEnabled:!1,dartTimerSeconds:10,x01DoubleIn:!1};const n=JSON.parse(t);return{favoriteDouble:n.favoriteDouble||"D16",callerEnabled:typeof n.callerEnabled=="boolean"?n.callerEnabled:!0,callerVoice:n.callerVoice||"",callerVolume:typeof n.callerVolume=="number"?Math.max(0,Math.min(1,n.callerVolume)):1,speakCheckoutOnly:!!n.speakCheckoutOnly,avgMode:n.avgMode==="24h"?"24h":"all-time",autoStartOffline:!!n.autoStartOffline,rememberLastOffline:typeof n.rememberLastOffline=="boolean"?n.rememberLastOffline:!0,lastOffline:n.lastOffline&&typeof n.lastOffline=="object"?{mode:n.lastOffline.mode||"X01",x01Start:Number(n.lastOffline.x01Start)||501,firstTo:Number(n.lastOffline.firstTo)||1,aiLevel:n.lastOffline.aiLevel||"None"}:{mode:"X01",x01Start:501,firstTo:1,aiLevel:"None"},reducedMotion:!!n.reducedMotion,compactHeader:!!n.compactHeader,allowSpectate:typeof n.allowSpectate=="boolean"?n.allowSpectate:!0,cameraScale:typeof n.cameraScale=="number"&&isFinite(n.cameraScale)?Math.max(.5,Math.min(1.25,n.cameraScale)):1,cameraAspect:n.cameraAspect==="square"?"square":"wide",cameraFitMode:n.cameraFitMode==="fit"||n.cameraFitMode==="fill"?n.cameraFitMode:"fit",calibrationUseRansac:typeof n.calibrationUseRansac=="boolean"?n.calibrationUseRansac:!0,autoscoreProvider:n.autoscoreProvider==="external-ws"?"external-ws":n.autoscoreProvider==="manual"?"manual":n.autoscoreProvider==="built-in-v2"?"built-in-v2":"built-in",autoscoreWsUrl:typeof n.autoscoreWsUrl=="string"?n.autoscoreWsUrl:"",autoCommitMode:n.autoCommitMode==="immediate"?"immediate":"wait-for-clear",confirmUncertainDarts:typeof n.confirmUncertainDarts=="boolean"?n.confirmUncertainDarts:!0,autoScoreConfidenceThreshold:typeof n.autoScoreConfidenceThreshold=="number"&&isFinite(n.autoScoreConfidenceThreshold)?Math.max(.5,Math.min(.99,n.autoScoreConfidenceThreshold)):.85,autoscoreDetectorMinArea:typeof n.autoscoreDetectorMinArea=="number"&&isFinite(n.autoscoreDetectorMinArea)?Math.max(5,Math.min(500,Math.round(n.autoscoreDetectorMinArea))):30,autoscoreDetectorThresh:typeof n.autoscoreDetectorThresh=="number"&&isFinite(n.autoscoreDetectorThresh)?Math.max(5,Math.min(60,Math.round(n.autoscoreDetectorThresh))):15,autoscoreDetectorRequireStableN:typeof n.autoscoreDetectorRequireStableN=="number"&&isFinite(n.autoscoreDetectorRequireStableN)?Math.max(1,Math.min(10,Math.round(n.autoscoreDetectorRequireStableN))):2,harshLightingMode:typeof n.harshLightingMode=="boolean"?n.harshLightingMode:!1,enhanceBigTrebles:typeof n.enhanceBigTrebles=="boolean"?n.enhanceBigTrebles:!1,allowAutocommitInOnline:!!n.allowAutocommitInOnline,calibrationGuide:typeof n.calibrationGuide=="boolean"?n.calibrationGuide:!0,preferredCameraId:typeof n.preferredCameraId=="string"?n.preferredCameraId:void 0,preserveCalibrationOverlay:typeof n.preserveCalibrationOverlay=="boolean"?n.preserveCalibrationOverlay:!0,preserveCalibrationOnCameraChange:typeof n.preserveCalibrationOnCameraChange=="boolean"?n.preserveCalibrationOnCameraChange:!0,preferredCameraLabel:typeof n.preferredCameraLabel=="string"?n.preferredCameraLabel:void 0,preferredCameraLocked:typeof n.preferredCameraLocked=="boolean"?n.preferredCameraLocked:!1,cameraEnabled:typeof n.cameraEnabled=="boolean"?n.cameraEnabled:!0,hideCameraOverlay:typeof n.cameraRecordDarts=="boolean"?n.cameraRecordDarts:!0,offlineLayout:n.offlineLayout==="classic"?"classic":"modern",hideInGameSidebar:typeof n.hideInGameSidebar=="boolean"?n.hideInGameSidebar:!0,textSize:n.textSize==="small"||n.textSize==="large"?n.textSize:"medium",boxSize:n.boxSize==="small"||n.boxSize==="large"?n.boxSize:"medium",matchType:n.matchType==="doubles"?"doubles":"singles",teamAName:typeof n.teamAName=="string"?n.teamAName:"Team A",teamBName:typeof n.teamBName=="string"?n.teamBName:"Team B",dartTimerEnabled:typeof n.dartTimerEnabled=="boolean"?n.dartTimerEnabled:!1,dartTimerSeconds:typeof n.dartTimerSeconds=="number"&&isFinite(n.dartTimerSeconds)?Math.max(3,Math.min(60,n.dartTimerSeconds)):10,x01DoubleIn:typeof n.x01DoubleIn=="boolean"?n.x01DoubleIn:!1,cameraRecordDarts:typeof n.cameraRecordDarts=="boolean"?n.cameraRecordDarts:!1,cameraShowLabels:typeof n.cameraShowLabels=="boolean"?n.cameraShowLabels:!1}}catch{return{favoriteDouble:"D16",callerEnabled:!0,callerVoice:"",callerVolume:1,speakCheckoutOnly:!1,avgMode:"all-time",autoStartOffline:!1,rememberLastOffline:!0,lastOffline:{mode:"X01",x01Start:501,firstTo:1,aiLevel:"None"},reducedMotion:!1,compactHeader:!1,allowSpectate:!0,cameraScale:1,cameraAspect:"wide",cameraFitMode:"fit",calibrationGuide:!0,calibrationUseRansac:!0,preferredCameraId:void 0,preferredCameraLabel:void 0,preferredCameraLocked:!1,preserveCalibrationOverlay:!0,preserveCalibrationOnCameraChange:!0,cameraEnabled:!0,hideCameraOverlay:!1,offlineLayout:"modern",hideInGameSidebar:!0,autoscoreProvider:"built-in",autoscoreWsUrl:"",autoCommitMode:"wait-for-clear",confirmUncertainDarts:!0,autoScoreConfidenceThreshold:.85,harshLightingMode:!1,enhanceBigTrebles:!1,textSize:"medium",boxSize:"medium",matchType:"singles",teamAName:"Team A",teamBName:"Team B",dartTimerEnabled:!1,dartTimerSeconds:10,x01DoubleIn:!1}}}function Pe(t){try{const n=Lr();localStorage.setItem(fl,JSON.stringify({...n,...t}))}catch{}}const pe=Vn((t,n)=>({...Lr(),setFavoriteDouble:s=>{Pe({favoriteDouble:s}),t({favoriteDouble:s})},setCallerEnabled:s=>{Pe({callerEnabled:s}),t({callerEnabled:s})},setCallerVoice:s=>{Pe({callerVoice:s}),t({callerVoice:s})},setAvgMode:s=>{Pe({avgMode:s}),t({avgMode:s})},setCallerVolume:s=>{const a=Math.max(0,Math.min(1,s));Pe({callerVolume:a}),t({callerVolume:a})},setSpeakCheckoutOnly:s=>{Pe({speakCheckoutOnly:s}),t({speakCheckoutOnly:s})},setAutoStartOffline:s=>{Pe({autoStartOffline:s}),t({autoStartOffline:s})},setRememberLastOffline:s=>{Pe({rememberLastOffline:s}),t({rememberLastOffline:s})},setLastOffline:s=>{const r={...Lr().lastOffline,...s};Pe({lastOffline:r}),t({lastOffline:r})},setReducedMotion:s=>{Pe({reducedMotion:s}),t({reducedMotion:s})},setCompactHeader:s=>{Pe({compactHeader:s}),t({compactHeader:s})},setAllowSpectate:s=>{Pe({allowSpectate:s}),t({allowSpectate:s})},ignorePreferredCameraSync:!1,setIgnorePreferredCameraSync:s=>{Pe({}),t({ignorePreferredCameraSync:s})},setCameraScale:s=>{const a=Math.max(.5,Math.min(2,s));Pe({cameraScale:a}),t({cameraScale:a})},setCameraAspect:s=>{const a=s==="square"?"square":"wide";Pe({cameraAspect:a}),t({cameraAspect:a})},setCameraFitMode:s=>{const a=s==="fit"?"fit":"fill";Pe({cameraFitMode:a}),t({cameraFitMode:a})},setAutoscoreProvider:s=>{Pe({autoscoreProvider:s}),t({autoscoreProvider:s})},setAutoscoreWsUrl:s=>{Pe({autoscoreWsUrl:s}),t({autoscoreWsUrl:s})},setAutoCommitMode:s=>{const a=s==="immediate"?"immediate":"wait-for-clear";Pe({autoCommitMode:a}),t({autoCommitMode:a})},setConfirmUncertainDarts:s=>{const a=!!s;Pe({confirmUncertainDarts:a}),t({confirmUncertainDarts:a})},setAutoScoreConfidenceThreshold:s=>{const a=typeof s=="number"&&isFinite(s)?Math.max(.5,Math.min(.99,s)):.85;Pe({autoScoreConfidenceThreshold:a}),t({autoScoreConfidenceThreshold:a})},setAutoscoreDetectorMinArea:s=>{const a=typeof s=="number"&&isFinite(s)?Math.max(5,Math.min(500,Math.round(s))):30;Pe({autoscoreDetectorMinArea:a}),t({autoscoreDetectorMinArea:a})},setAutoscoreDetectorThresh:s=>{const a=typeof s=="number"&&isFinite(s)?Math.max(5,Math.min(60,Math.round(s))):15;Pe({autoscoreDetectorThresh:a}),t({autoscoreDetectorThresh:a})},setAutoscoreDetectorRequireStableN:s=>{const a=typeof s=="number"&&isFinite(s)?Math.max(1,Math.min(10,Math.round(s))):2;Pe({autoscoreDetectorRequireStableN:a}),t({autoscoreDetectorRequireStableN:a})},setHarshLightingMode:s=>{const a=!!s;Pe({harshLightingMode:a}),t({harshLightingMode:a})},setEnhanceBigTrebles:s=>{const a=!!s;Pe({enhanceBigTrebles:a}),t({enhanceBigTrebles:a})},setAllowAutocommitInOnline:s=>{Pe({allowAutocommitInOnline:s}),t({allowAutocommitInOnline:s})},setCalibrationGuide:s=>{Pe({calibrationGuide:s}),t({calibrationGuide:s})},setCalibrationUseRansac:s=>{Pe({calibrationUseRansac:s}),t({calibrationUseRansac:s})},setPreserveCalibrationOverlay:s=>{Pe({preserveCalibrationOverlay:s}),t({preserveCalibrationOverlay:s})},setPreserveCalibrationOnCameraChange:s=>{Pe({preserveCalibrationOnCameraChange:s}),t({preserveCalibrationOnCameraChange:!!s})},setPreferredCamera:(s,a,r=!1)=>{try{if(n().preferredCameraLocked&&!r){console.log("[USERSETTINGS] Camera selection locked and force=false, ignoring update");return}}catch{}try{const i=n();if(i.preferredCameraId===s&&i.preferredCameraLabel===a)return}catch{}Pe({preferredCameraId:s,preferredCameraLabel:a}),t({preferredCameraId:s,preferredCameraLabel:a})},setPreferredCameraLocked:s=>{try{if(n().ignorePreferredCameraSync&&s===!0){console.debug("[USERSETTINGS] Ignoring auto-lock due to ignorePreferredCameraSync");return}}catch{}Pe({preferredCameraLocked:s}),t({preferredCameraLocked:s})},setCameraEnabled:s=>{Pe({cameraEnabled:s}),t({cameraEnabled:s})},setHideCameraOverlay:s=>{Pe({hideCameraOverlay:s}),t({hideCameraOverlay:s})},setCameraShowLabels:s=>{Pe({cameraShowLabels:s}),t({cameraShowLabels:!!s})},setCameraRecordDarts:s=>{const a=!!s;Pe({cameraRecordDarts:a}),t({cameraRecordDarts:a})},setCameraLowLatency:s=>{const a=!!s;Pe({cameraLowLatency:a}),t({cameraLowLatency:a})},setCameraProcessingFps:s=>{const a=Math.max(5,Math.min(30,Math.round(s)));Pe({cameraProcessingFps:a}),t({cameraProcessingFps:a})},setOfflineLayout:s=>{Pe({offlineLayout:s}),t({offlineLayout:s})},setHideInGameSidebar:s=>{Pe({hideInGameSidebar:s}),t({hideInGameSidebar:s})},setTextSize:s=>{Pe({textSize:s}),t({textSize:s})},setBoxSize:s=>{Pe({boxSize:s}),t({boxSize:s})},setMatchType:s=>{const a=s==="doubles"?"doubles":"singles";Pe({matchType:a}),t({matchType:a})},setTeamAName:s=>{const a=s?.trim()||"Team A";Pe({teamAName:a}),t({teamAName:a})},setTeamBName:s=>{const a=s?.trim()||"Team B";Pe({teamBName:a}),t({teamBName:a})},setDartTimerEnabled:s=>{Pe({dartTimerEnabled:s}),t({dartTimerEnabled:s})},setDartTimerSeconds:s=>{const a=Math.max(3,Math.min(60,Math.round(s)));Pe({dartTimerSeconds:a}),t({dartTimerSeconds:a})},setX01DoubleIn:s=>{Pe({x01DoubleIn:s}),t({x01DoubleIn:s})}})),dn=Vn()((t,n)=>({H:null,createdAt:null,errorPx:null,confidence:null,imageSize:null,overlaySize:null,anchors:null,theta:null,rotationOffsetRad:0,sectorOffset:0,cameraId:null,locked:!1,_hydrated:!0,setCalibration:s=>t(a=>{try{if(pe.getState().preserveCalibrationOnCameraChange&&a.locked&&s.cameraId&&s.cameraId!==a.cameraId)return console.info("[CALIBRATION] preserveCalibrationOnCameraChange enabled and camera change detected; ignoring auto-update"),a}catch{}return{...a,...s}}),reset:()=>t({H:null,createdAt:null,errorPx:null,confidence:null,imageSize:null,overlaySize:null,anchors:null,theta:null,rotationOffsetRad:0,sectorOffset:0,cameraId:null,locked:!1})})),gt={bullInner:6.35,bullOuter:15.9,trebleInner:99,trebleOuter:107,doubleInner:162,doubleOuter:170},Wa=[20,1,18,4,13,6,10,15,2,17,3,19,7,16,8,11,14,9,12,5];function pl(t,n){const s=new Array(9).fill(0);for(let a=0;a<3;a++)for(let r=0;r<3;r++)for(let i=0;i<3;i++)s[a*3+r]+=t[a*3+i]*n[i*3+r];return s}function as(t,n){const s=n.x,a=n.y,r=t[6]*s+t[7]*a+t[8],i=(t[0]*s+t[1]*a+t[2])/r,l=(t[3]*s+t[4]*a+t[5])/r;return{x:i,y:l}}function Mu(t,n,s){return[n*t[0],n*t[1],n*t[2],s*t[3],s*t[4],s*t[5],t[6],t[7],t[8]]}function Ru(t,n){const s=Math.cos(n),a=Math.sin(n),r=[s,-a,0,a,s,0,0,0,1];return pl(t,r)}function Au(t,n,s){return pl([1,0,n,0,1,s,0,0,1],t)}function Pu(t){const n=t,s=n[0],a=n[1],r=n[2],i=n[3],l=n[4],u=n[5],f=n[6],c=n[7],m=n[8],p=l*m-u*c,h=r*c-a*m,N=a*u-r*l,w=u*f-i*m,b=s*m-r*f,g=r*i-s*u,y=i*c-l*f,M=a*f-s*c,L=s*l-a*i,S=s*p+a*w+r*y;if(Math.abs(S)<1e-12)throw new Error("Singular homography");return[p/S,h/S,N/S,w/S,b/S,g/S,y/S,M/S,L/S]}function Is(t,n){if(t.length<4||n.length<4)throw new Error("Need at least 4 correspondences");if(t.length!==n.length)throw new Error("Correspondences must have equal length");const s=[],a=[];for(let l=0;l<t.length;l++){const{x:u,y:f}=t[l],{x:c,y:m}=n[l];s.push([u,f,1,0,0,0,-c*u,-c*f]),a.push(c),s.push([0,0,0,u,f,1,-m*u,-m*f]),a.push(m)}const r=Lu(s,a);return[r[0],r[1],r[2],r[3],r[4],r[5],r[6],r[7],1]}function Lu(t,n){const s=t.length,a=t[0].length,r=Array.from({length:a},()=>new Array(a).fill(0)),i=new Array(a).fill(0);for(let l=0;l<s;l++)for(let u=0;u<a;u++){i[u]+=t[l][u]*n[l];for(let f=0;f<a;f++)r[u][f]+=t[l][u]*t[l][f]}return Ou(r,i)}function Ou(t,n){const s=n.length,a=t.map((i,l)=>i.concat([n[l]]));for(let i=0;i<s;i++){let l=i;for(let u=i+1;u<s;u++)Math.abs(a[u][i])>Math.abs(a[l][i])&&(l=u);if(Math.abs(a[l][i])<1e-12)throw new Error("Singular matrix");if(l!==i){const u=a[i];a[i]=a[l],a[l]=u}for(let u=i+1;u<s;u++){const f=a[u][i]/a[i][i];for(let c=i;c<=s;c++)a[u][c]-=f*a[i][c]}}const r=new Array(s).fill(0);for(let i=s-1;i>=0;i--){let l=a[i][s];for(let u=i+1;u<s;u++)l-=a[i][u]*r[u];r[i]=l/a[i][i]}return r}function xl(t="center"){const n=(gt.doubleInner+gt.doubleOuter)/2,a=[20,6,3,11].map(r=>{const l=Wa.indexOf(r)/Wa.length*Math.PI*2-Math.PI/2,u=n*Math.cos(l),f=n*Math.sin(l);return{x:Math.abs(u)<1e-9?0:u,y:Math.abs(f)<1e-9?0:f}});return a.push({x:0,y:0}),a}function Fu(t,n,s=256){const a=[];for(let r=0;r<s;r++){const i=r/s*Math.PI*2,l=as(t,{x:n*Math.cos(i),y:n*Math.sin(i)});a.push(l)}return a}function ns(t,n,s){let a=0;for(let r=0;r<n.length;r++){const i=as(t,n[r]),l=i.x-s[r].x,u=i.y-s[r].y;a+=l*l+u*u}return Math.sqrt(a/n.length)}function bl(t,n,s={}){const a=t.length;if(a<4||n.length<4)throw new Error("Need at least 4 correspondences");const r=s.thresholdPx??8,i=s.maxIter??500,l=s.minInliers??4,u=s.rng??Math.random;let f=null,c=new Array(a).fill(!1),m=0,p=1/0;for(let b=0;b<i;b++){const g=new Set;for(;g.size<4;)g.add(Math.floor(u()*a));const y=Array.from(g),M=[],L=[];for(const $ of y)M.push(t[$]),L.push(n[$]);let S;try{S=Is(M,L)}catch{continue}const I=new Array(a).fill(!1);let k=0;for(let $=0;$<a;$++){const ce=as(S,t[$]),me=ce.x-n[$].x,xe=ce.y-n[$].y;Math.hypot(me,xe)<=r&&(I[$]=!0,k++)}if(k<l)continue;const T=[],E=[];for(let $=0;$<a;$++)I[$]&&(T.push(t[$]),E.push(n[$]));let V;try{V=Is(T,E)}catch{continue}const H=ns(V,T,E);(k>m||k===m&&H<p)&&(m=k,p=H,f=V,c=I.slice())}if(!f||m<l)return{H:null,inliers:new Array(a).fill(!1),errorPx:null};const h=[],N=[];for(let b=0;b<a;b++)c[b]&&(h.push(t[b]),N.push(n[b]));const w=h.length>0?ns(f,h,N):null;return{H:f,inliers:c,errorPx:w}}function Ms(t,n){try{const s=Pu(t),a=as(s,n);return!isFinite(a.x)||!isFinite(a.y)?null:a}catch{return null}}function Uu(t){const n=Math.hypot(t.x,t.y);let a=Math.atan2(t.y,t.x)*180/Math.PI;a=(a+360+90)%360;const r=Math.floor((a+9)%360/18),i=Wa[r],{bullInner:l,bullOuter:u,trebleInner:f,trebleOuter:c,doubleInner:m,doubleOuter:p}=gt,h=.75;return n>p+h?{base:0,ring:"MISS",sector:null,mult:0}:n>=m-h?{base:i*2,ring:"DOUBLE",sector:i,mult:2}:n>c+h?{base:i,ring:"SINGLE",sector:i,mult:1}:n>=f-h?{base:i*3,ring:"TRIPLE",sector:i,mult:3}:n>u+h?{base:i,ring:"SINGLE",sector:i,mult:1}:n>l+.5?{base:25,ring:"BULL",sector:25,mult:1}:{base:50,ring:"INNER_BULL",sector:25,mult:2}}function _u(t,n,s=0,a=0){const r=Math.hypot(t.x,t.y);let l=(Math.atan2(t.y,t.x)+(Number.isFinite(n)?n:0)+(Number.isFinite(a)?a:0))*180/Math.PI;l=(l+360+90)%360;const f=((Math.floor((l+9)%360/18)+(Number.isFinite(s)?s:0))%20+20)%20,c=Wa[f],{bullInner:m,bullOuter:p,trebleInner:h,trebleOuter:N,doubleInner:w,doubleOuter:b}=gt,g=.75;return r>b+g?{base:0,ring:"MISS",sector:null,mult:0}:r>=w-g?{base:c*2,ring:"DOUBLE",sector:c,mult:2}:r>N+g?{base:c,ring:"SINGLE",sector:c,mult:1}:r>=h-g?{base:c*3,ring:"TRIPLE",sector:c,mult:3}:r>p+g?{base:c,ring:"SINGLE",sector:c,mult:1}:r>m+.5?{base:25,ring:"BULL",sector:25,mult:1}:{base:50,ring:"INNER_BULL",sector:25,mult:2}}function za(t,n,s){return Math.max(n,Math.min(s,t))}function $u(t,n,s){const{width:a,data:r}=t,i=[[-1,0,1],[-2,0,2],[-1,0,1]],l=[[-1,-2,-1],[0,0,0],[1,2,1]];let u=0,f=0;for(let c=-1;c<=1;c++)for(let m=-1;m<=1;m++){const p=za(n+m,0,a-1),N=(za(s+c,0,t.height-1)*a+p)*4,w=r[N],b=r[N+1],g=r[N+2],y=.299*w+.587*b+.114*g;u+=y*i[c+1][m+1],f+=y*l[c+1][m+1]}return Math.hypot(u,f)}function Or(t,n,s=6){const r=t.getContext("2d").getImageData(0,0,t.width,t.height),i=za(Math.round(n.x),1,t.width-2),l=za(Math.round(n.y),1,t.height-2);let u={x:i,y:l,mag:-1};for(let f=l-s;f<=l+s;f++)for(let c=i-s;c<=i+s;c++){if(c<=0||f<=0||c>=t.width-1||f>=t.height-1)continue;const m=$u(r,c,f);m>u.mag&&(u={x:c,y:f,mag:m})}return{x:u.x,y:u.y}}function mo(t,n){const a=n.slice(0,4).map(c=>as(t,c)),r=a.reduce((c,m)=>c+m.x,0)/a.length,i=a.reduce((c,m)=>c+m.y,0)/a.length,l=[-Math.PI/2,0,Math.PI/2,Math.PI],u=a.map(c=>Math.atan2(c.y-i,c.x-r));let f=l[0]-u[0];for(;f>Math.PI;)f-=2*Math.PI;for(;f<-Math.PI;)f+=2*Math.PI;return f}function Ns(t){return t===null?0:-(t*180)/Math.PI}async function Bu(t){const{H:n,errorPx:s,confidence:a,imageSize:r,overlaySize:i,pointMappings:l,captureCanvas:u,extra:f}=t;let c=null;try{u&&typeof u.toDataURL=="function"&&(c=u.toDataURL("image/png"))}catch{c=null}return{createdAt:Date.now(),H:n||null,errorPx:typeof s=="number"?s:null,confidence:typeof a=="number"?a:null,imageSize:r||null,overlaySize:i||null,pointMappings:l||[],extra:f||null,screenshotDataUrl:c}}function Vu(t,n){const s=`ndn-diagnostic-${new Date(t.createdAt).toISOString()}.json`,a=new Blob([JSON.stringify(t,null,2)],{type:"application/json"}),r=URL.createObjectURL(a),i=document.createElement("a");i.href=r,i.download=s,document.body.appendChild(i),i.click(),i.remove(),setTimeout(()=>URL.revokeObjectURL(r),1e3)}function ra(t){if(t==null||Number.isNaN(t)||t<0)return null;let n;t<=.25?n=99.5+(.25-t)*2:t<=1?n=98+(1-t)*2:t<=2?n=95+(2-t)*3:t<=5?n=90+(5-t)*1.66:n=Math.max(0,90-(t-5)*5);const s=Math.max(0,Math.min(100,n));return Number(s.toFixed(1))}const si={X01:{tolerancePx:10,requiredTargets:["SINGLE","DOUBLE","TREBLE","BULL","OUTER_BULL"],criticalZones:["D20","D1","BULLSEYE","T20","SINGLE_20"],minConfidence:80},"Double Practice":{tolerancePx:12,requiredTargets:["DOUBLE","BULL"],criticalZones:["D20","D1","D6","D17"],minConfidence:75},"Treble Practice":{tolerancePx:8,requiredTargets:["TREBLE"],criticalZones:["T20","T1","T5"],minConfidence:85},"Checkout 170":{tolerancePx:9,requiredTargets:["DOUBLE"],criticalZones:["D25","D20","D8"],minConfidence:82},"Checkout 121":{tolerancePx:9,requiredTargets:["DOUBLE"],criticalZones:["D20","D5","D1"],minConfidence:82},Cricket:{tolerancePx:15,requiredTargets:["20","19","18","17","16","15","BULL"],criticalZones:["20","15","BULL"],minConfidence:70},"American Cricket":{tolerancePx:15,requiredTargets:["20","19","18","17","16","15","BULL"],criticalZones:["20","15","BULL"],minConfidence:70},"Around the Clock":{tolerancePx:12,requiredTargets:["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20"],criticalZones:["1","20","6","15"],minConfidence:78},Shanghai:{tolerancePx:13,requiredTargets:["1","2","3","4","5","6","7","SINGLE","DOUBLE","TREBLE"],criticalZones:["1","7","S1","D1","T1"],minConfidence:75},"High Score":{tolerancePx:14,requiredTargets:["TREBLE","DOUBLE","BULL"],criticalZones:["T20","BULL","D20"],minConfidence:72},"Low Score":{tolerancePx:11,requiredTargets:["SINGLE"],criticalZones:["1","2","3"],minConfidence:76},"Count-Up":{tolerancePx:13,requiredTargets:["SINGLE","DOUBLE","TREBLE"],criticalZones:["20","DOUBLE","TREBLE"],minConfidence:74},"Halve It":{tolerancePx:12,requiredTargets:["TREBLE","SINGLE"],criticalZones:["T20","T5","SINGLE"],minConfidence:73},"High-Low":{tolerancePx:13,requiredTargets:["SINGLE","DOUBLE","BULL"],criticalZones:["HIGH (>10)","LOW (<5)","BULL"],minConfidence:72},Killer:{tolerancePx:12,requiredTargets:["ALL_NUMBERS"],criticalZones:["RANDOM_TARGETS"],minConfidence:74},Baseball:{tolerancePx:14,requiredTargets:["1-9","SINGLE","DOUBLE","TREBLE"],criticalZones:["1","9","TRIPLE"],minConfidence:71},Golf:{tolerancePx:14,requiredTargets:["1-18","TREBLE"],criticalZones:["T1","T18"],minConfidence:71},"Tic Tac Toe":{tolerancePx:16,requiredTargets:["1-9","SINGLE"],criticalZones:["CENTER","CORNERS"],minConfidence:68},"Bob's 27":{tolerancePx:13,requiredTargets:["SINGLE","DOUBLE"],criticalZones:["1-20","BULL"],minConfidence:73},Scam:{tolerancePx:14,requiredTargets:["ALL_NUMBERS","OUTER_BULL"],criticalZones:["TARGET_NUMBER","OUTER_BULL"],minConfidence:70},Fives:{tolerancePx:14,requiredTargets:["ALL_NUMBERS","OUTER_BULL"],criticalZones:["5","10","15","20"],minConfidence:70},Sevens:{tolerancePx:14,requiredTargets:["ALL_NUMBERS","OUTER_BULL"],criticalZones:["7","14"],minConfidence:70}};function ai(t,n){if(n==null||Number.isNaN(n)||n<0)return 0;const a=si[t]?.tolerancePx??12;if(n<=.25)return 99.5+(.25-n)*2;if(n<=1)return 98+(1-n)*2;if(n<=2)return 95+(2-n)*3;if(n<=5)return 90+(5-n)*1.66;if(n<=a){const r=a-5;return r<=0?85:85+(a-n)/r*5}else{const r=a*3;return n>=r?0:85*(1-(n-a)/(r-a))}}function _f(t,n){if(n==null||Number.isNaN(n)||n<0)return!1;const s=si[t];return s?ai(t,n)>=s.minConfidence:!0}function Hu(t,n){if(n==null||Number.isNaN(n)||n<0)return{quality:"none",text:"Not calibrated"};const s=ai(t,n);return s>=99.5?{quality:"perfect",text:`Perfect (${s.toFixed(1)}%)`}:s>=90?{quality:"excellent",text:`Excellent (${Math.round(s)}%)`}:s>=75?{quality:"good",text:`Good (${Math.round(s)}%)`}:s>=50?{quality:"fair",text:`Fair (${Math.round(s)}%)`}:{quality:"poor",text:`Poor (${Math.round(s)}%)`}}function ri(t){const{H:n,imageSize:s,locked:a,errorPx:r,maxErrorPx:i=12}=t;if(!n)return"none";const l=!!(s&&typeof s.w=="number"&&typeof s.h=="number"&&s.w>0&&s.h>0),u=typeof r=="number"&&!Number.isNaN(r)?r:null;return l&&(a||u!=null&&u<=i)?"verified":"unknown"}function $f(t){const n=si[t];return!n||n.criticalZones.length===0?null:`Recalibrate focusing on: ${n.criticalZones.join(", ")}`}const Wu=t=>!!t&&Number.isFinite(t.x)&&Number.isFinite(t.y),zu=t=>Array.isArray(t)&&t.length===9&&t.every(Number.isFinite);function qu(t,n){const s=t.getContext("2d",{willReadFrequently:!0});if(!s)return null;const a=t.width,r=t.height,i=160,l=i/a,u=Math.floor(r*l),c=new OffscreenCanvas(i,u).getContext("2d",{willReadFrequently:!0});if(!c)return null;c.drawImage(t,0,0,i,u);const p=c.getImageData(0,0,i,u).data,h=new Float32Array(i*u),N=8;for(let P=1;P<u-1;P++)for(let ee=1;ee<i-1;ee++){const X=(P*i+ee)*4,re=X-4,se=X+4,je=X-i*4,le=X+i*4,Ne=p[re]*.299+p[re+1]*.587+p[re+2]*.114,Ie=p[se]*.299+p[se+1]*.587+p[se+2]*.114,Se=p[je]*.299+p[je+1]*.587+p[je+2]*.114,Me=p[le]*.299+p[le+1]*.587+p[le+2]*.114,G=Ie-Ne,Ce=Me-Se,he=Math.sqrt(G*G+Ce*Ce);if(he>N){const Ee=G/he,te=Ce/he,Te=i*.03,C=i*.6;for(let B=Te;B<C;B+=1){const A=Math.round(ee+Ee*B),W=Math.round(P+te*B);A>=0&&A<i&&W>=0&&W<u&&h[W*i+A]++;const ae=Math.round(ee-Ee*B),K=Math.round(P-te*B);ae>=0&&ae<i&&K>=0&&K<u&&h[K*i+ae]++}}}const w=new Float32Array(i*u),b=2;for(let P=b;P<u-b;P++)for(let ee=b;ee<i-b;ee++){let X=0;for(let re=-b;re<=b;re++)for(let se=-b;se<=b;se++)X+=h[(P+re)*i+(ee+se)];w[P*i+ee]=X}let g=0,y=i/2,M=u/2;const L=5;for(let P=L;P<u-L;P++)for(let ee=L;ee<i-L;ee++){const X=w[P*i+ee];X>g&&(g=X,y=ee,M=P)}let S=y/l,I=M/l;console.log(`[findDartboardRings] Voting Peak: (${Math.round(S)}, ${Math.round(I)}) Votes=${g}`);const k=400,T=k/a,E=Math.floor(r*T),H=new OffscreenCanvas(k,E).getContext("2d");if(!H)return null;H.drawImage(t,0,0,k,E);const $=H.getImageData(0,0,k,E).data,ce=new Float32Array(k*E),me=new Float32Array(k*E);for(let P=1;P<E-1;P++)for(let ee=1;ee<k-1;ee++){const X=(P*k+ee)*4;$[X]*.299+$[X+1]*.587+$[X+2]*.114;const re=X-4,se=X+4,je=X-k*4,le=X+k*4,Ne=$[re]*.299+$[re+1]*.587+$[re+2]*.114,Ie=$[se]*.299+$[se+1]*.587+$[se+2]*.114,Se=$[je]*.299+$[je+1]*.587+$[je+2]*.114,Me=$[le]*.299+$[le+1]*.587+$[le+2]*.114,G=Ie-Ne,Ce=Me-Se;ce[P*k+ee]=G,me[P*k+ee]=Ce}const xe=s.getImageData(0,0,a,r).data,we=(P,ee)=>{const X=Math.max(0,Math.min(a-1,Math.round(P))),se=(Math.max(0,Math.min(r-1,Math.round(ee)))*a+X)*4;return .299*xe[se]+.587*xe[se+1]+.114*xe[se+2]},ye=60,De={};for(let P=0;P<ye;P++){const ee=P/ye*Math.PI*2,X=Math.cos(ee),re=Math.sin(ee),se=[];for(let le=30;le<Math.min(a,r)/2;le+=1){const Ne=S+(le-2)*X,Ie=I+(le-2)*re,Se=S+(le+2)*X,Me=I+(le+2)*re,G=we(Ne,Ie),Ce=we(Se,Me),he=Math.abs(Ce-G);he>2&&le>20&&se.push({r:le,grad:he})}const je=[];for(let le=0;le<se.length;le++){const Ne=le>0?se[le-1].grad:0,Ie=se[le].grad,Se=le<se.length-1?se[le+1].grad:0;Ie>Ne&&Ie>Se&&Ie>2&&je.push(se[le].r)}je.length>0&&je.forEach(le=>{const Ne=Object.keys(De).map(Se=>({key:parseInt(Se),median:De[parseInt(Se)][Math.floor(De[parseInt(Se)].length/2)]})).filter(Se=>Math.abs(Se.median-le)<15).sort((Se,Me)=>Math.abs(Se.median-le)-Math.abs(Me.median-le))[0],Ie=Ne?Ne.key:Math.max(-1,...Object.keys(De).map(Se=>parseInt(Se)))+1;De[Ie]||(De[Ie]=[]),De[Ie].push(le)})}const Ue=Object.keys(De).map(P=>{const ee=De[parseInt(P)].sort((re,se)=>re-se),X=ee[Math.floor(ee.length/2)];return{tier:parseInt(P),radius:X,samples:ee.length}}).sort((P,ee)=>P.radius-ee.radius);console.log("[findDartboardRings] Detected ring tiers:",Ue);const ge=[...Ue];if(ge.length>=2){const P=ge[ge.length-1].radius,ee=ge[ge.length-2].radius,X=P/ee;(X>1.15&&ge.length>=5||X>1.3)&&(console.log(`[findDartboardRings] Ignoring outermost ring (likely light ring/surround): ${P.toFixed(1)}px (ratio ${X.toFixed(2)} to ${ee.toFixed(1)}px)`),ge.pop())}const He=ge.length>0?ge[ge.length-1].radius:Math.min(a,r)*.3;let U=50+ge.length*6;return ge.length>=7?U=98:ge.length===6?U=96:ge.length===5&&(U=94),{cx:S,cy:I,r:He,confidence:U,ringCount:ge.length,ringStrength:ge.length>0?ge[ge.length-1].radius:0,detectedRings:ge.map(P=>P.radius)}}function Gu(t,n,s,a){const r=t.getContext("2d");if(!r)return null;const i=t.width,l=t.height,u=720,f=a,c=new Array(u).fill(0),m=Math.max(2,Math.round(f-8)),p=Math.round(f+8),h=r.getImageData(0,0,i,l).data,N=(k,T)=>{const E=Math.round(k),V=Math.round(T);if(E<0||E>=i||V<0||V>=l)return 127;const H=(V*i+E)*4;return h[H]*.299+h[H+1]*.587+h[H+2]*.114};for(let k=0;k<u;k++){const T=k/u*Math.PI*2;let E=0,V=N(n+m*Math.cos(T),s+m*Math.sin(T));for(let H=m+1;H<=p;H++){const $=N(n+H*Math.cos(T),s+H*Math.sin(T)),ce=Math.abs($-V);ce>E&&(E=ce),V=$}c[k]=E}const w=[];for(let k=0;k<u;k++){const T=c[(k-1+u)%u],E=c[k],V=c[(k+1)%u];E>T&&E>V&&E>10&&w.push(k)}if(w.length<16){const k=c.map((T,E)=>{let V=0,H=0;for(let $=-2;$<=2;$++)V+=c[(E+$+u)%u],H++;return V/H});for(let T=0;T<u;T++){const E=k[(T-1+u)%u],V=k[T],H=k[(T+1)%u];V>E&&V>H&&V>8&&w.push(T)}}if(w.length===0)return 0;const b=w.map(k=>k/u*Math.PI*2);b.sort((k,T)=>k-T);const g=[];for(let k=0;k<b.length;k++){const T=b[k],V=(b[(k+1)%b.length]-T+Math.PI*2)%(Math.PI*2);g.push((T+V/2)%(Math.PI*2))}const y=20,M=new Array(y).fill(0).map((k,T)=>-Math.PI/2+T*(Math.PI*2/y));let L=0,S=1/0;for(let k=0;k<g.length;k++){let T=0;for(let E=0;E<Math.min(y,g.length);E++){const V=g[(E+k)%g.length],H=M[E],$=Math.abs((V-H+Math.PI)%(Math.PI*2)-Math.PI);T+=$*$}T<S&&(S=T,L=(g[k]-M[0]+Math.PI*2)%(Math.PI*2))}return(L+Math.PI)%(Math.PI*2)-Math.PI}function Yu(t,n){const s=t.getContext("2d");if(!s)return n;const a=t.width,r=t.height,l=s.getImageData(0,0,a,r).data,u=(y,M)=>{const L=Math.max(0,Math.min(a-1,Math.round(y))),I=(Math.max(0,Math.min(r-1,Math.round(M)))*a+L)*4;return .299*l[I]+.587*l[I+1]+.114*l[I+2]},f=(y,M)=>{const L=u(y+1,M)-u(y-1,M),S=u(y,M+1)-u(y,M-1);return{gx:L,gy:S}},c=as(n,{x:0,y:0}),m=y=>{const M=[gt.trebleOuter,gt.doubleOuter];let L=0;for(const S of M){const I=Fu(y,S,180);for(let k=0;k<I.length;k++){const T=I[k],E=f(T.x,T.y),V=T.x-c.x,H=T.y-c.y,$=Math.hypot(V,H)||1,ce=V/$,me=H/$;L+=Math.abs(E.gx*ce+E.gy*me)}}return L/180/2};let p=n,h=m(n);const N=y=>y*Math.PI/180,w=[-4,-2,-1,-.5,0,.5,1,2,4],b=[-3,-2,-1,0,1,2,3],g=[.98,.99,1,1.01,1.02];for(const y of w){const M=Ru(n,N(y));for(const L of b)for(const S of b){const I=Au(M,L,S);for(const k of g){const T=Mu(I,k,k),E=m(T);E>h&&(h=E,p=T)}}}return p}function ho(t,n){try{const s=t.width,a=t.height,r=s/2,i=a/2;let l=t;n?.colorAssist;const u=qu(l,n?.centerHint);if(!u)return{success:!1,cx:r,cy:i,bullInner:0,bullOuter:0,trebleInner:0,trebleOuter:0,doubleInner:0,doubleOuter:0,confidence:0,homography:null,errorPx:null,calibrationPoints:[],message:"No dartboard detected. Ensure board is clearly visible with good contrast between rings and background."};const f=(()=>{const I=u.detectedRings||[];if(I.length>=6)return{cx:u.cx,cy:u.cy,bullInner:I[0],bullOuter:I[1],trebleInner:I[2],trebleOuter:I[3],doubleInner:I[4],doubleOuter:I[5]};{const k=u.r/gt.doubleOuter;return{cx:u.cx,cy:u.cy,bullInner:gt.bullInner*k,bullOuter:gt.bullOuter*k,trebleInner:gt.trebleInner*k,trebleOuter:gt.trebleOuter*k,doubleInner:gt.doubleInner*k,doubleOuter:u.r}}})(),c=Gu(t,f.cx,f.cy,f.doubleOuter)||0,m=xl("outer"),p=m.map(I=>{if(I.x===0&&I.y===0)return{x:f.cx,y:f.cy};const k=Math.cos(c),T=Math.sin(c),E=f.doubleOuter/gt.doubleOuter,V=I.x*E,H=I.y*E;return{x:f.cx+(V*k-H*T),y:f.cy+(V*T+H*k)}});let h=null,N=null,w=u.confidence,b=1;try{let I=!0;try{I=!!pe.getState?.()?.calibrationUseRansac}catch{}if(I){const E=bl(m,p,{thresholdPx:8,maxIter:300});E.H?(h=E.H,N=E.errorPx,b=E.inliers.filter(Boolean).length/p.length,w=Math.max(w,Math.round(w*.6+b*40))):(h=Is(m,p),N=ns(h,m,p))}else h=Is(m,p),N=ns(h,m,p);h&&(h=Yu(t,h),N=ns(h,m,p));const T=ra(typeof N=="number"?N:null);typeof T=="number"?w=T:w=Math.max(b*100,u.confidence)}catch{w=Math.max(65,u.confidence)}const g=p.every(Wu),y=zu(h),M=!!y&&g&&w>50,L=u.ringCount??0,S={success:M,cx:f.cx,cy:f.cy,bullInner:f.bullInner,bullOuter:f.bullOuter,trebleInner:f.trebleInner,trebleOuter:f.trebleOuter,doubleInner:f.doubleInner,doubleOuter:f.doubleOuter,confidence:Math.round(w),homography:y?h:null,errorPx:y?N:null,calibrationPoints:g?p:[],theta:typeof c=="number"?c:void 0,message:!g||!y?`âŒ Detection produced unstable calibration data. Adjust camera framing or calibrate manually. (rings: ${L}, r:${Math.round(u.r)})`:w>85?`âœ… Excellent detection (rings: ${L}, r:${Math.round(u.r)})`:`âœ… Board detected - may need angle adjustment (rings: ${L}, r:${Math.round(u.r)})`};return console.log("[detectBoard] Final result:",{success:S.success,confidence:S.confidence,homographyValid:y,pointsValid:g,cx:Math.round(S.cx),cy:Math.round(S.cy),doubleOuter:Math.round(S.doubleOuter),rings:L,errorPx:S.errorPx?S.errorPx.toFixed(2):null,calibrationPoints:p.map(I=>({x:Math.round(I.x),y:Math.round(I.y)}))},S.message),S}catch(s){return{success:!1,cx:t.width/2,cy:t.height/2,bullInner:0,bullOuter:0,trebleInner:0,trebleOuter:0,doubleInner:0,doubleOuter:0,confidence:0,homography:null,errorPx:null,calibrationPoints:[],message:s instanceof Error?s.message:"Board detection failed"}}}const Ju={};function gl(t,n){let s;try{s=t()}catch{return}return{getItem:r=>{var i;const l=f=>f===null?null:JSON.parse(f,void 0),u=(i=s.getItem(r))!=null?i:null;return u instanceof Promise?u.then(l):l(u)},setItem:(r,i)=>s.setItem(r,JSON.stringify(i,void 0)),removeItem:r=>s.removeItem(r)}}const ia=t=>n=>{try{const s=t(n);return s instanceof Promise?s:{then(a){return ia(a)(s)},catch(a){return this}}}catch(s){return{then(a){return this},catch(a){return ia(a)(s)}}}},Xu=(t,n)=>(s,a,r)=>{let i={getStorage:()=>localStorage,serialize:JSON.stringify,deserialize:JSON.parse,partialize:g=>g,version:0,merge:(g,y)=>({...y,...g}),...n},l=!1;const u=new Set,f=new Set;let c;try{c=i.getStorage()}catch{}if(!c)return t((...g)=>{console.warn(`[zustand persist middleware] Unable to update item '${i.name}', the given storage is currently unavailable.`),s(...g)},a,r);const m=ia(i.serialize),p=()=>{const g=i.partialize({...a()});let y;const M=m({state:g,version:i.version}).then(L=>c.setItem(i.name,L)).catch(L=>{y=L});if(y)throw y;return M},h=r.setState;r.setState=(g,y)=>{h(g,y),p()};const N=t((...g)=>{s(...g),p()},a,r);let w;const b=()=>{var g;if(!c)return;l=!1,u.forEach(M=>M(a()));const y=((g=i.onRehydrateStorage)==null?void 0:g.call(i,a()))||void 0;return ia(c.getItem.bind(c))(i.name).then(M=>{if(M)return i.deserialize(M)}).then(M=>{if(M)if(typeof M.version=="number"&&M.version!==i.version){if(i.migrate)return i.migrate(M.state,M.version);console.error("State loaded from storage couldn't be migrated since no migrate function was provided")}else return M.state}).then(M=>{var L;return w=i.merge(M,(L=a())!=null?L:N),s(w,!0),p()}).then(()=>{y?.(w,void 0),l=!0,f.forEach(M=>M(w))}).catch(M=>{y?.(void 0,M)})};return r.persist={setOptions:g=>{i={...i,...g},g.getStorage&&(c=g.getStorage())},clearStorage:()=>{c?.removeItem(i.name)},getOptions:()=>i,rehydrate:()=>b(),hasHydrated:()=>l,onHydrate:g=>(u.add(g),()=>{u.delete(g)}),onFinishHydration:g=>(f.add(g),()=>{f.delete(g)})},b(),w||N},Ku=(t,n)=>(s,a,r)=>{let i={storage:gl(()=>localStorage),partialize:b=>b,version:0,merge:(b,g)=>({...g,...b}),...n},l=!1;const u=new Set,f=new Set;let c=i.storage;if(!c)return t((...b)=>{console.warn(`[zustand persist middleware] Unable to update item '${i.name}', the given storage is currently unavailable.`),s(...b)},a,r);const m=()=>{const b=i.partialize({...a()});return c.setItem(i.name,{state:b,version:i.version})},p=r.setState;r.setState=(b,g)=>{p(b,g),m()};const h=t((...b)=>{s(...b),m()},a,r);r.getInitialState=()=>h;let N;const w=()=>{var b,g;if(!c)return;l=!1,u.forEach(M=>{var L;return M((L=a())!=null?L:h)});const y=((g=i.onRehydrateStorage)==null?void 0:g.call(i,(b=a())!=null?b:h))||void 0;return ia(c.getItem.bind(c))(i.name).then(M=>{if(M)if(typeof M.version=="number"&&M.version!==i.version){if(i.migrate)return[!0,i.migrate(M.state,M.version)];console.error("State loaded from storage couldn't be migrated since no migrate function was provided")}else return[!1,M.state];return[!1,void 0]}).then(M=>{var L;const[S,I]=M;if(N=i.merge(I,(L=a())!=null?L:h),s(N,!0),S)return m()}).then(()=>{y?.(N,void 0),N=a(),l=!0,f.forEach(M=>M(N))}).catch(M=>{y?.(void 0,M)})};return r.persist={setOptions:b=>{i={...i,...b},b.storage&&(c=b.storage)},clearStorage:()=>{c?.removeItem(i.name)},getOptions:()=>i,rehydrate:()=>w(),hasHydrated:()=>l,onHydrate:b=>(u.add(b),()=>{u.delete(b)}),onFinishHydration:b=>(f.add(b),()=>{f.delete(b)})},i.skipHydration||w(),N||h},Qu=(t,n)=>"getStorage"in n||"serialize"in n||"deserialize"in n?((Ju?"production":void 0)!=="production"&&console.warn("[DEPRECATED] `getStorage`, `serialize` and `deserialize` options are deprecated. Use `storage` option instead."),Xu(t,n)):Ku(t,n),Zu=Qu;let Zn=null,Da=null,gr=null,vr=null,Gs=0,Ss=null,es=null;const em=200,vn=Vn()(Zu(t=>({isStreaming:!1,mode:"local",pairingCode:null,expiresAt:null,isPaired:!1,mobileUrl:null,showOverlay:!0,setStreaming:n=>{t({isStreaming:n})},setMode:n=>{t({mode:n})},setPairingCode:n=>t({pairingCode:n}),setExpiresAt:n=>t({expiresAt:n}),setPaired:n=>t({isPaired:n}),setMobileUrl:n=>t({mobileUrl:n}),setShowOverlay:n=>t({showOverlay:!!n}),setMediaStream:n=>{!n&&Gs>0||(Da=n)},getMediaStream:()=>{if(Da)return Da;try{const s=Zn?.srcObject||null;if(s)return s}catch{}return null},setPcRef:n=>{gr=n},getPcRef:()=>gr,setWsRef:n=>{vr=n},getWsRef:()=>vr,getVideoElementRef:()=>Zn,setVideoElementRef:n=>{try{if(n===null){es&&(clearTimeout(es),es=null,Ss=null),Le("[cameraSession] ðŸ›‘ setVideoElementRef called - clearing ref"),Zn=null;return}if(!Zn){Le("[cameraSession] âœ“ setVideoElementRef called - storing HTMLVideoElement",{tagName:n.tagName,hasStream:!!n.srcObject}),Zn=n;return}if(Zn===n)return;es&&(clearTimeout(es),es=null),Ss=n,es=window.setTimeout(()=>{try{Le("[cameraSession] (deferred) setVideoElementRef applying pending ref",{tagName:Ss?.tagName,hasStream:!!Ss?.srcObject}),Zn=Ss}catch(s){Le("[cameraSession] Failed to apply pending video ref:",s)}finally{Ss=null,es=null}},em)}catch{}},acquireKeepAlive:n=>{Gs+=1},releaseKeepAlive:n=>{Gs=Math.max(0,Gs-1)},clearSession:()=>{Gs===0&&(Zn=null,Da=null),gr=null,vr=null,t({isStreaming:!1,pairingCode:null,expiresAt:null,isPaired:!1,mobileUrl:null})}}),{name:"ndn-camera-session",storage:gl(()=>localStorage),partialize:t=>({isStreaming:t.isStreaming,mode:t.mode,pairingCode:t.pairingCode,expiresAt:t.expiresAt,isPaired:t.isPaired,mobileUrl:t.mobileUrl,showOverlay:t.showOverlay})})),tm={501:{minConfidence:75,label:"501",color:"text-cyan-400"},Cricket:{minConfidence:70,label:"Cricket",color:"text-green-400"},X01:{minConfidence:80,label:"X01 (Strict)",color:"text-red-400"},"Around the World":{minConfidence:60,label:"Around the World",color:"text-yellow-400"},Shanghai:{minConfidence:65,label:"Shanghai",color:"text-purple-400"}},yr=["ðŸ“ D20 (Center of double ring)","ðŸ“ D6 (Center of double ring)","ðŸ“ D3 (Center of double ring)","ðŸ“ D11 (Center of double ring)","ðŸ“ Bull (Center)"],Ia=["#c62828","#00796b","#ff8f00","#2e7d32","#512da8"];function Zs(){try{const t=localStorage.getItem("ndn-calibration-history");return t?JSON.parse(t):[]}catch{return[]}}function fo(t,n,s,a,r){try{const i=Zs(),l={id:Date.now().toString(),date:new Date().toLocaleString(),errorPx:typeof n=="number"?n:null,H:t,...s?{imageSize:s}:{},...a?{overlaySize:a}:{},...typeof r=="number"?{confidence:r}:{}};i.unshift(l),i.splice(10),localStorage.setItem("ndn-calibration-history",JSON.stringify(i))}catch(i){console.error("Failed to save calibration history:",i)}}function nm(t){try{const s=Zs().filter(a=>a.id!==t);localStorage.setItem("ndn-calibration-history",JSON.stringify(s))}catch(n){console.error("Failed to delete calibration from history:",n)}}async function po(){try{return navigator&&navigator.mediaDevices&&typeof navigator.mediaDevices.enumerateDevices=="function"?(await navigator.mediaDevices.enumerateDevices()).filter(s=>s.kind==="videoinput").map(s=>{let a=s.label||`Camera ${s.deviceId.substring(0,5)}`;return s.label.includes("OBS")?a=`ðŸ“º ${s.label} (Virtual)`:s.label.includes("Virtual")||s.label.includes("Evostream")?a=`ðŸ“¹ ${s.label} (Virtual)`:s.label.includes("USB")?a=`ðŸ“½ï¸ ${s.label} (USB)`:s.label.toLowerCase().includes("front")||s.label.toLowerCase().includes("front camera")?a=`ðŸ“± ${s.label} (Front)`:(s.label.toLowerCase().includes("back")||s.label.toLowerCase().includes("rear"))&&(a=`ðŸ“± ${s.label} (Back)`),{deviceId:s.deviceId,label:a,kind:s.kind}}):[]}catch(t){return console.error("Failed to enumerate devices:",t),[]}}function Ma(t,n,s,a){let r=!0,i=0,l,u=0;if(a)try{const m=Ms(a,n);if(!m)console.warn("[evaluateClickQuality] Failed to transform point to board space"),r=!1;else{l=m;const p=Math.hypot(m.x-s.x,m.y-s.y);u=p;const h=Math.hypot(m.x,m.y);if(i=h,t<4){const N=gt.doubleInner-5,w=gt.doubleOuter+5,b=h>=N&&h<=w,g=p<30;r=b&&g,Le(`[evaluateClickQuality] Point ${t} (D${[20,6,3,11][t]}): boardCoords=${JSON.stringify({x:m.x.toFixed(1),y:m.y.toFixed(1)})} radius=${h.toFixed(1)}mm (need ${N}-${w}) dist_to_target=${p.toFixed(1)}mm valid=${r}`)}else{const N=gt.bullOuter+2;r=h<=N,Le(`[evaluateClickQuality] Bull: boardCoords=${JSON.stringify({x:m.x.toFixed(1),y:m.y.toFixed(1)})} radius=${h.toFixed(1)}mm (need â‰¤${N}) valid=${r}`)}}}catch(m){console.warn("[evaluateClickQuality] Failed to apply homography for validation:",m),r=!1}else u=0,r=!0;let f,c;return u<10?(f="Excellent",c="â€¢"):u<25?(f="Good",c="âœ“"):u<50?(f="Fair",c="âš "):(f="Poor",c="âœ—"),{distance:u,boardDistance:i,boardCoords:l,quality:f,icon:c,isValid:r}}function xo(t){if(!t.length)return{allValid:!1,avgBoardMiss:null,maxBoardMiss:null,samples:0};let n=!0,s=0,a=0,r=0;for(const i of t)if(i.isValid||(n=!1),typeof i.distance=="number"&&!Number.isNaN(i.distance)){const l=Math.abs(i.distance);s+=l,a=Math.max(a,l),r+=1}return{allValid:n,avgBoardMiss:r>0?s/r:null,maxBoardMiss:r>0?a:null,samples:r}}function vl(t){return t>=99.5?{level:"Perfect",color:"text-indigo-400"}:t>=90?{level:"Excellent",color:"text-emerald-400"}:t>=75?{level:"Good",color:"text-cyan-400"}:t>=50?{level:"Fair",color:"text-yellow-400"}:{level:"Low",color:"text-red-400"}}function wr(t,n){const s=n??{allValid:!0,avgBoardMiss:null,maxBoardMiss:null};if(!s.allValid)return{percentage:0,level:"Low",color:"text-red-400"};const a=ra(t);let r=typeof a=="number"?a:0;if(s.maxBoardMiss!=null){const u=Math.min(Math.max(0,s.maxBoardMiss),40),f=s.avgBoardMiss??s.maxBoardMiss,c=f!=null?Math.min(Math.max(0,f),40):null,m=4*Math.max(0,1-u/40),p=c!=null?4*Math.max(0,1-c/40):0,h=Math.min(4,Math.max(m,p));r=r+h}r=Math.min(100,Number(r.toFixed(1)));const{level:i,color:l}=vl(r);return{percentage:Number(r.toFixed(1)),level:i,color:l}}function sm(){const{H:t,setCalibration:n,reset:s,locked:a,imageSize:r,overlaySize:i,confidence:l}=dn(),u=vn(),f=o.useRef(null),c=o.useRef(null),m=o.useRef(null),[p,h]=o.useState([]),[N,w]=o.useState(!1),[b,g]=o.useState(null),[y,M]=o.useState(null),[L,S]=o.useState(!0),[I,k]=o.useState([]),[T,E]=o.useState(null),[V,H]=o.useState(Zs()),[$,ce]=o.useState(!1),[me,xe]=o.useState(!1),[we,ye]=o.useState([]),[De,Ue]=o.useState(null),[ge,He]=o.useState(!1),[U,P]=o.useState(null),[ee,X]=o.useState(0),[re,se]=o.useState(!1),[je,le]=o.useState(1),[Ne,Ie]=o.useState(null),[Se,Me]=o.useState(!1),[G,Ce]=o.useState(!1),[he,Ee]=o.useState(()=>typeof window<"u"&&localStorage.getItem("ndn:cal:mode")||"local"),[te,Te]=o.useState(!1),C=o.useRef(new Array(5).fill(null)),B=o.useRef({cropX:0,cropY:0,cropW:1,cropH:1,canvasWidth:1,canvasHeight:1}),A=o.useRef(new Array(5).fill(null)),W=o.useRef(null),ae=o.useRef(!1),K=o.useRef(null),_e=o.useRef(null),Ae=o.useRef(null),ut=o.useRef(!1);o.useEffect(()=>{A.current=new Array(5).fill(null)},[]),o.useEffect(()=>()=>{},[]);const _=o.useMemo(()=>{const D=xl("outer").slice(0,4);return D.push({x:0,y:0}),D},[]),Y=D=>{const O=D.radius/gt.doubleOuter,F=_.map(oe=>({x:D.cx+oe.x*O,y:D.cy+oe.y*O}));C.current=F};o.useEffect(()=>{(async()=>{try{const O=await po();if(ye(O),O.length===0){E("No cameras found. Please connect a camera or virtual camera."),xe(!1);return}const F=localStorage.getItem("ndn-selected-camera"),oe=F&&O.some(Ye=>Ye.deviceId===F)?F:O[0].deviceId;Ue(oe),await kt(oe)}catch(O){console.error("Failed to initialize camera:",O),E("Camera initialization failed. Check permissions.")}})();try{typeof navigator<"u"&&navigator.mediaDevices&&typeof navigator.mediaDevices.addEventListener=="function"&&navigator.mediaDevices.addEventListener("devicechange",async()=>{const O=await po();ye(O)})}catch{}return()=>{y?.getTracks().forEach(O=>{O.stop()});try{u.setStreaming(!1),u.setMediaStream(null)}catch{}try{typeof navigator<"u"&&navigator.mediaDevices&&typeof navigator.mediaDevices.removeEventListener=="function"&&navigator.mediaDevices.removeEventListener("devicechange",()=>{})}catch{}}},[]);const Q=D=>{Ee(D);try{localStorage.setItem("ndn:cal:mode",D)}catch{}},de=pe(),tt=pe(D=>D.calibrationUseRansac),ft=()=>Te(D=>!D),yt=()=>{try{de.setIgnorePreferredCameraSync(!0),de.setPreferredCameraLocked(!de.preferredCameraLocked),setTimeout(()=>{try{de.setIgnorePreferredCameraSync(!1)}catch{}},1500)}catch{}};o.useEffect(()=>{if(!c.current)return;const D=c.current,O=()=>{Le("Video metadata loaded - dimensions:",{width:D.videoWidth,height:D.videoHeight}),f.current&&(f.current.width=D.videoWidth||640,f.current.height=D.videoHeight||480,Le("Canvas updated to:",{width:f.current.width,height:f.current.height}))},F=()=>{},oe=()=>{},Ye=Ge=>{console.error("Video error event:",Ge)};return D.addEventListener("loadedmetadata",O),D.addEventListener("play",F),D.addEventListener("playing",oe),D.addEventListener("error",Ye),()=>{D.removeEventListener("loadedmetadata",O),D.removeEventListener("play",F),D.removeEventListener("playing",oe),D.removeEventListener("error",Ye)}},[]);const kt=async D=>{try{Le("Starting camera with ID:",D),y?.getTracks().forEach(xt=>{xt.stop()}),E(null);const O={deviceId:D?{exact:D}:void 0},F={facingMode:"environment"},oe={width:{ideal:3840},height:{ideal:2160},frameRate:{ideal:30}},Ye={width:{ideal:1280},height:{ideal:720},frameRate:{ideal:30}},Ge={width:{ideal:2560},height:{ideal:1440},frameRate:{ideal:30}},qe={width:{ideal:1920},height:{ideal:1080},frameRate:{ideal:30}},wt=pe.getState?.()?.cameraLowLatency??!1,Et=xt=>{const Oe=String(xt?.name||xt?.code||"");return Oe==="OverconstrainedError"||Oe==="NotFoundError"||Oe==="NotReadableError"||Oe==="NotSupportedError"},St=async(xt,Oe,j)=>(Le("Requesting camera stream:",xt,{...Oe,...j}),navigator.mediaDevices.getUserMedia({video:{...Oe,...j},audio:!1})),Tt=await(async()=>{const xt=wt?[{label:"720p",hints:Ye},{label:"1080p",hints:qe},{label:"1440p",hints:Ge}]:[{label:"4k",hints:oe},{label:"1440p",hints:Ge},{label:"1080p",hints:qe},{label:"720p",hints:Ye}];if(D)for(const Oe of xt)try{return await St(`${Oe.label} (device)`,O,Oe.hints)}catch(j){if(console.warn(`[Calibrator] ${Oe.label} (device) failed:`,j),!Et(j))throw j}for(const Oe of xt)try{return await St(`${Oe.label} (fallback)`,F,Oe.hints)}catch(j){if(console.warn(`[Calibrator] ${Oe.label} (fallback) failed:`,j),!Et(j))throw j}return console.warn("[Calibrator] Falling back to video: true"),navigator.mediaDevices.getUserMedia({video:!0,audio:!1})})();Le("Got media stream:",{tracks:Tt.getTracks().length}),M(Tt);try{u.setMediaStream(Tt),u.setMode("local"),c.current&&u.setVideoElementRef(c.current),u.setStreaming(!0)}catch(xt){console.warn("Failed to sync with camera session:",xt)}c.current&&(c.current.srcObject=Tt,Le("Set video srcObject, attempting to play"),setTimeout(()=>{c.current&&c.current.play().catch(xt=>{console.error("Video playback failed:",xt)})},100)),xe(!0),Le("Camera ready!");try{localStorage.setItem("ndn-selected-camera",D)}catch{}}catch(O){const F=O.message||"Camera access denied. Check permissions.";console.error("Camera access error:",O),E(F),xe(!1)}},lt=async D=>{Ue(D),Nt(),await kt(D),He(!1)},Je=D=>{if(!D.isPrimary||D.pointerType==="mouse"&&D.button!==0)return;const O=nn(D);O&&(Ae.current=D.pointerType,Xt(O.canvasX,O.canvasY,D.pointerType)&&(Be(),W.current&&(W.current.pointerId=D.pointerId),f.current?.setPointerCapture?.(D.pointerId),f.current&&!a&&(f.current.style.cursor="grabbing"),pt(O.canvasX,O.canvasY,!0),D.preventDefault()))},Hn=D=>{const O=W.current;if(!O||O.pointerId!==D.pointerId)return;const F=nn(D);F&&(ae.current=!0,pt(F.canvasX,F.canvasY),D.preventDefault())},yn=D=>{const O=W.current;!O||O.pointerId!==D.pointerId||(ze(D.pointerId),D.preventDefault())},Wn=D=>{const O=W.current;!O||O.pointerId!==D.pointerId||ze(D.pointerId)},wn=D=>{const O=W.current;!O||O.pointerId!==D.pointerId||ze(D.pointerId)},zn=D=>{if(W.current||ae.current){ae.current=!1;return}if(!f.current||p.length>=5||a)return;Be();const O=f.current,F=O.getBoundingClientRect(),oe=D.clientX-F.left,Ye=D.clientY-F.top,Ge=O.width/F.width,qe=O.height/F.height,wt=oe*Ge,Et=Ye*qe,St=c.current,mt=St?.videoWidth||O.width,Tt=St?.videoHeight||O.height,xt=mt/je,Oe=Tt/je,j=(mt-xt)/2,Z=(Tt-Oe)/2,be=j+wt/O.width*xt,st=Z+Et/O.height*Oe,ht=Or(O,{x:be,y:st},10),ot=[...p,ht];if(h(ot),k([...I,p]),ot.length===5)try{const on=pe.getState?.()?.calibrationUseRansac;let Dt,Vt;if(on){const ln=bl(_,ot,{thresholdPx:8,maxIter:200});ln.H?(Dt=ln.H,Vt=ln.errorPx??ns(ln.H,_,ot)):(Dt=Is(_,ot),Vt=ns(Dt,_,ot))}else Dt=Is(_,ot),Vt=ns(Dt,_,ot);const pn=ot.map((ln,hs)=>Ma(hs,ln,_[hs],Dt)),Rs=xo(pn),ca=wr(Vt,Rs);g(Vt),n({H:Dt,locked:!1,errorPx:Vt,confidence:ca.percentage,imageSize:{w:O.width,h:O.height},overlaySize:{w:c.current?.clientWidth||c.current?.videoWidth||O.width,h:c.current?.clientHeight||c.current?.videoHeight||O.height}}),Le("[Calibrator] Homography computed:",{H:Dt,errorPx:Vt,pointMappings:ot.map((ln,hs)=>({index:hs,imageSpace:ln,boardSpace:Ms(Dt,ln)}))})}catch(on){console.error("Homography computation failed:",on),g(null)}},qn=()=>{if(I.length>0){const D=I[I.length-1];h(D),k(I.slice(0,-1)),g(null)}},mn=()=>{s(),h([]),k([]),g(null),P(null),X(0),se(!1),Bt(),Nt()},Pn=()=>{const D=c.current,O=f.current;return{w:D?.clientWidth||D?.videoWidth||O?.width||0,h:D?.clientHeight||D?.videoHeight||O?.height||0}},Ln=()=>{if(b!==null&&t){const D=mo(t,_);P(D),n({locked:!0,cameraId:De,theta:D,sectorOffset:ee,imageSize:{w:f.current?.width||0,h:f.current?.height||0},overlaySize:Pn()});const O={w:f.current?.width||0,h:f.current?.height||0},F=Pn();fo(t,b,O,F,We?.percentage??null),H(Zs()),se(!0)}},qt=()=>{s(),h([]),k([]),g(null),P(null),X(0),se(!1),Bt(),Nt()},x=()=>{t&&(n({locked:!0,theta:U,sectorOffset:ee,imageSize:{w:f.current?.width||0,h:f.current?.height||0},overlaySize:Pn()}),se(!1))},z=async()=>{if(!(!f.current||!c.current))try{Ce(!0);const D=f.current,O=D.getContext("2d");if(!O){Ie({success:!1,cx:0,cy:0,bullInner:0,bullOuter:0,trebleInner:0,trebleOuter:0,doubleInner:0,doubleOuter:0,confidence:0,homography:null,errorPx:null,calibrationPoints:[],message:"Failed to capture frame"});return}O.drawImage(c.current,0,0,D.width,D.height);const F=ho(D),oe=F;Ie(oe);const Ye=ra(typeof oe.errorPx=="number"?oe.errorPx:null);if(oe.success&&oe.homography){h([]),k([]),g(oe.errorPx);const Ge=oe.theta?oe.theta:mo(oe.homography,_);n({H:oe.homography,locked:!0,errorPx:oe.errorPx,confidence:typeof Ye=="number"?Ye:null,cameraId:De,theta:Ge,sectorOffset:0,imageSize:{w:D.width,h:D.height},overlaySize:{w:c.current?.videoWidth||D.width,h:c.current?.videoHeight||D.height}});try{fo(oe.homography,typeof oe.errorPx=="number"?oe.errorPx:null,{w:D.width,h:D.height},{w:c.current?.videoWidth||D.width,h:c.current?.videoHeight||D.height},typeof Ye=="number"?Ye:null)}catch(qe){console.warn("Failed to write calibration to history:",qe)}P(Ge),X(0),se(!0),Le("[Auto-Calibrate] Success:",{confidence:oe.confidence,errorPx:oe.errorPx,theta:Ge})}Me(!0)}catch(D){console.error("[Auto-Calibrate] Error:",D),Ie({success:!1,cx:0,cy:0,bullInner:0,bullOuter:0,trebleInner:0,trebleOuter:0,doubleInner:0,doubleOuter:0,confidence:0,homography:null,errorPx:null,calibrationPoints:[],message:`Error: ${D instanceof Error?D.message:String(D)}`}),Me(!0)}finally{Ce(!1)}},ie=D=>{n({H:D.H,locked:!0,errorPx:D.errorPx,confidence:typeof D.confidence=="number"?D.confidence:null,...D.imageSize?{imageSize:D.imageSize}:{},...D.overlaySize?{overlaySize:D.overlaySize}:{}}),h([]),k([]),g(D.errorPx),ce(!1),Bt()},$e=p.length,Fe=p.length===5,it=o.useMemo(()=>{if(p.length!==5||!t)return null;const D=p.map((O,F)=>Ma(F,O,_[F],t));return xo(D)},[p,_,t]),We=o.useMemo(()=>{if(b!==null&&it)return wr(b,it);if(typeof l=="number"){const D=Number(l.toFixed(1));return{percentage:D,...vl(D)}}return b!==null?wr(b,null):null},[b,it,l]),hn=o.useMemo(()=>!Ne||typeof Ne.errorPx!="number"?null:ra(Ne.errorPx),[Ne]),Rt=(D,O)=>{const{cropX:F,cropY:oe,cropW:Ye,cropH:Ge,canvasWidth:qe,canvasHeight:wt}=B.current;if(!qe||!wt||!Ye||!Ge)return{x:D,y:O};const Et=(D-F)/Ye,St=(O-oe)/Ge;return{x:Et*qe,y:St*wt}},jn=(D,O)=>{const{cropX:F,cropY:oe,cropW:Ye,cropH:Ge,canvasWidth:qe,canvasHeight:wt}=B.current;if(!qe||!wt)return{x:D,y:O};const Et=F+D/qe*Ye,St=oe+O/wt*Ge;return{x:Et,y:St}},nn=D=>{const O=f.current;if(!O)return null;const F=O.getBoundingClientRect();let oe,Ye;if("touches"in D){if(D.touches.length===0)return null;oe=D.touches[0].clientX,Ye=D.touches[0].clientY}else oe=D.clientX,Ye=D.clientY;const Ge=(oe-F.left)*O.width/F.width,qe=(Ye-F.top)*O.height/F.height;return{canvasX:Ge,canvasY:qe}},Bt=()=>{C.current=new Array(5).fill(null),A.current=new Array(5).fill(null)},Be=()=>{ut.current||(ut.current=!0)},Nt=()=>{ut.current=!1},nt=D=>{const O=f.current;if(!O)return 32;const F=Math.min(O.width,O.height)/600,oe=Math.max(28,Math.min(70,32*(F||1)));return D==="touch"?oe*1.35:D==="pen"?oe*1.15:oe},Xt=(D,O,F)=>{if(a)return!1;const oe=A.current,Ye=nt(F??Ae.current);for(let Ge=p.length;Ge<oe.length;Ge++){const qe=oe[Ge];if(!qe)continue;if(Math.hypot(qe.x-D,qe.y-O)<=Ye)return W.current={targetIndex:Ge,offsetX:D-qe.x,offsetY:O-qe.y},ae.current=!1,!0}return!1},At=(D,O)=>{const F=W.current;if(!F)return;const oe=D-F.offsetX,Ye=O-F.offsetY,Ge=f.current,qe=Ge?.width??oe,wt=Ge?.height??Ye,Et=Math.max(0,Math.min(qe,oe)),St=Math.max(0,Math.min(wt,Ye)),mt=jn(Et,St);C.current[F.targetIndex]=mt,A.current[F.targetIndex]={x:Et,y:St}},Ve=()=>{if(!_e.current)return;const{x:D,y:O}=_e.current;_e.current=null,At(D,O)},pt=(D,O,F=!1)=>{if(_e.current={x:D,y:O},F){K.current!==null&&(cancelAnimationFrame(K.current),K.current=null),Ve();return}K.current===null&&(K.current=requestAnimationFrame(()=>{K.current=null,Ve()}))},ze=D=>{Ve(),K.current!==null&&(cancelAnimationFrame(K.current),K.current=null),_e.current=null;const O=D??W.current?.pointerId;typeof O=="number"&&f.current?.hasPointerCapture?.(O)&&f.current.releasePointerCapture(O),W.current=null,f.current&&!a&&(f.current.style.cursor="crosshair"),Ae.current=null};o.useEffect(()=>()=>{K.current!==null&&(cancelAnimationFrame(K.current),K.current=null)},[]);const Gn=o.useRef(null),Nn=o.useRef(null),fn=o.useRef(null),rs=o.useCallback(D=>{try{const O=D.current;if(!O)return;const F=O.getContext("2d");if(!F)return;const oe=c.current;let Ye=O.width,Ge=O.height,qe=O.width/je,wt=O.height/je,Et=(Ye-qe)/2,St=(Ge-wt)/2;const mt=Oe=>{F.fillStyle="#374151",F.fillRect(0,0,O.width,O.height),Oe&&(F.fillStyle="rgba(255, 255, 255, 0.2)",F.font="14px sans-serif",F.textAlign="center",F.fillText(Oe,O.width/2,O.height/2))};if(oe){const Oe=oe.srcObject instanceof MediaStream,j=oe.readyState;if(Oe&&j>=2){try{Ye=oe.videoWidth||O.width,Ge=oe.videoHeight||O.height,qe=Ye/je,wt=Ge/je,Et=(Ye-qe)/2,St=(Ge-wt)/2,F.drawImage(oe,Et,St,qe,wt,0,0,O.width,O.height)}catch(Xe){console.error("Failed to draw video frame:",Xe),mt()}const Z=performance.now();if((typeof document>"u"||document.visibilityState!=="hidden")&&!ut.current&&!W.current&&p.length<5&&oe.videoWidth>0&&oe.videoHeight>0&&(!Gn.current||Z-Gn.current.timestamp>600)){Nn.current||(Nn.current=document.createElement("canvas"));const Xe=Nn.current;if(Xe){Xe.width=oe.videoWidth,Xe.height=oe.videoHeight;const ht=Xe.getContext("2d");if(ht){ht.drawImage(oe,0,0,Xe.width,Xe.height);try{const ot=ho(Xe);if(ot?.success&&ot.doubleOuter>0){const on={cx:ot.cx,cy:ot.cy,radius:ot.doubleOuter,timestamp:Z};Gn.current=on,ut.current||(Be(),Y(on))}}catch(ot){console.warn("Board detection failed",ot)}}}}}else mt(j<2?"Loading video...":void 0)}else mt("Camera feed unavailable");B.current={cropX:Et,cropY:St,cropW:qe,cropH:wt,canvasWidth:O.width,canvasHeight:O.height};const Tt=Gn.current,xt=W.current?.targetIndex??null;for(let Oe=0;Oe<5;Oe++)if(Oe>=p.length){const j=_[Oe];let Z,be;const st=C.current[Oe];if(st){const ht=Rt(st.x,st.y);Z=ht.x,be=ht.y}else if(Tt){const ht=Tt.radius/gt.doubleOuter,ot=Tt.cx+j.x*ht,on=Tt.cy+j.y*ht,Dt=Rt(ot,on);Z=Dt.x,be=Dt.y}else{const ht=Math.min(O.width,O.height)/390;Z=O.width/2+j.x*ht,be=O.height/2+j.y*ht}A.current[Oe]={x:Z,y:be};const Xe=xt===Oe;Xe&&(F.strokeStyle="rgba(255,255,255,0.8)",F.lineWidth=7,F.globalAlpha=.2,F.beginPath(),F.arc(Z,be,30,0,Math.PI*2),F.stroke()),F.strokeStyle=Ia[Oe],F.lineWidth=Xe?4:3,F.globalAlpha=Xe?1:.8,F.beginPath(),F.arc(Z,be,22,0,Math.PI*2),F.stroke(),F.fillStyle="#ffffff",F.beginPath(),F.arc(Z,be,7,0,Math.PI*2),F.fill(),F.fillStyle=Ia[Oe],F.beginPath(),F.arc(Z,be,5,0,Math.PI*2),typeof F.fill=="function"&&F.fill(),F.globalAlpha=1,F.fillStyle=Ia[Oe],F.font="bold 12px sans-serif",F.textAlign="center",F.fillText(yr[Oe].split(" ")[0],Z,be-35)}if(p.forEach((Oe,j)=>{A.current[j]=null;const Z=Rt(Oe.x,Oe.y),be=Z.x,st=Z.y,Xe=Ma(j,Oe,_[j],t||void 0),ht=Xe.isValid?"#22c55e":"#ef4444";F.strokeStyle=ht,F.lineWidth=2,F.globalAlpha=.8,F.beginPath(),F.arc(be,st,15,0,Math.PI*2),F.stroke(),F.fillStyle=ht,F.globalAlpha=.6,F.beginPath(),F.arc(be,st,12,0,Math.PI*2),typeof F.fill=="function"&&F.fill(),F.fillStyle="#fff",F.font="bold 14px sans-serif",F.textAlign="center",F.textBaseline="middle",F.globalAlpha=1,F.fillText(Xe.isValid?"âœ“":"âœ—",be,st),F.fillText(Xe.isValid?Xs("ok"):Xs("no"),be,st),Xe.isValid&&(F.strokeStyle="#22c55e",F.lineWidth=1.5,F.globalAlpha=.3,F.setLineDash([3,3]),F.beginPath(),F.arc(be,st,22,0,Math.PI*2),F.stroke(),F.setLineDash([]))}),Fe&&b!==null&&We){const Z=O.width/2-70,be=15;let st;We.percentage>=75?st="#22c55e":st="#ef4444",F.globalAlpha=.9,F.fillStyle=st,F.beginPath(),typeof F.roundRect=="function"?F.roundRect(Z,be,140,36,8):F.rect(Z,be,140,36),typeof F.fill=="function"&&F.fill(),F.globalAlpha=1,F.fillStyle="#fff",F.font="bold 14px sans-serif",F.textAlign="center",F.textBaseline="middle";const Xe=We.percentage>=75?`${Xs("ok")} PASS ${We.percentage}%`:`${Xs("no")} FAIL ${We.percentage}%`;F.fillText(Xe,O.width/2,be+36/2)}}catch{return}},[p,_,We,b,Fe,je,t]);return o.useEffect(()=>{const D=()=>{rs(f),fn.current=requestAnimationFrame(D)};return fn.current=requestAnimationFrame(D),()=>{fn.current!==null&&(cancelAnimationFrame(fn.current),fn.current=null)}},[rs]),e.jsxs("div",{ref:m,className:"w-full min-h-screen bg-gradient-to-br from-slate-950 via-blue-950/30 to-slate-950 text-white overflow-x-hidden",children:[e.jsx("div",{className:"sticky top-0 z-50 bg-gradient-to-r from-slate-900/95 to-slate-800/95 backdrop-blur-xl border-b border-blue-500/20",children:e.jsx("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 sm:py-8",children:e.jsx("div",{children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"text-4xl",children:"âš™ï¸"}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-black tracking-tight",children:"Dartboard Calibration âš™ï¸"}),e.jsx("p",{className:"text-white/40 text-sm font-medium",children:"Map your camera view to the physical board"})]})]})})})}),e.jsxs("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8",children:[T&&e.jsx("div",{className:"mb-6 bg-gradient-to-r from-red-500/10 to-red-600/5 border border-red-500/30 backdrop-blur-md p-4 sm:p-6 rounded-2xl animate-pulse",children:e.jsxs("div",{className:"flex gap-3",children:[e.jsx("div",{className:"text-2xl flex-shrink-0",children:"âš ï¸"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"font-semibold text-red-300 mb-1",children:"Camera Access Required"}),e.jsx("p",{className:"text-sm text-red-200/80 mb-2",children:T}),e.jsx("p",{className:"text-xs text-red-200/60",children:"Grant camera permissions in your browser settings to proceed."})]})]})}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8",children:[e.jsxs("div",{className:"lg:col-span-2",children:[e.jsxs("div",{className:"mb-4 flex items-center gap-3 bg-slate-800/80 backdrop-blur-md px-4 py-3 rounded-xl border border-slate-700/50 shadow-lg",children:[e.jsxs("span",{className:"text-sm text-slate-400 font-bold whitespace-nowrap flex items-center gap-2",children:["ðŸ” ",e.jsx("span",{className:"hidden sm:inline",children:"ZOOM"})]}),e.jsx("input",{type:"range",min:"1",max:"3",step:"0.1",value:je,onChange:D=>le(parseFloat(D.target.value)),className:"flex-1 h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-cyan-500"}),e.jsxs("span",{className:"text-sm font-mono font-bold text-cyan-400 min-w-[3.5rem] text-right bg-slate-900/50 px-2 py-1 rounded border border-slate-700/50",children:[je.toFixed(1),"x"]})]}),e.jsxs("div",{className:"bg-gradient-to-b from-slate-800/60 to-slate-900/60 backdrop-blur-sm border border-slate-700/50 rounded-2xl overflow-hidden shadow-2xl",children:[e.jsxs("div",{className:"relative bg-black/20 aspect-video sm:aspect-auto",style:{minHeight:"300px"},children:[e.jsx("canvas",{ref:f,width:800,height:600,onClick:zn,onPointerDown:Je,onPointerMove:Hn,onPointerUp:yn,onPointerLeave:Wn,onPointerCancel:wn,className:"w-full h-full object-cover cursor-crosshair touch-none",style:{cursor:a?"not-allowed":"crosshair",touchAction:"none"}}),e.jsxs("div",{className:"absolute top-4 right-4 flex items-center gap-2 bg-black/50 backdrop-blur-md px-3 py-2 rounded-full border border-blue-400/30 text-sm font-semibold",children:[e.jsx("span",{className:`w-2.5 h-2.5 rounded-full animate-pulse ${me?"bg-emerald-400":"bg-yellow-400"}`}),e.jsx("span",{className:"text-slate-200",children:me?"Live ðŸ”´":"Ready âœ…"})]}),a&&e.jsx("div",{className:"absolute inset-0 bg-black/30 backdrop-blur-sm flex items-center justify-center rounded-xl",children:e.jsxs("div",{className:"bg-emerald-600/90 backdrop-blur-md px-6 py-3 rounded-xl font-bold text-white flex items-center gap-2 shadow-2xl",children:[e.jsx("span",{children:"ðŸ”’"})," LOCKED"]})})]}),e.jsxs("div",{className:"px-4 sm:px-6 py-4 bg-slate-900/40 border-t border-slate-700/50",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("span",{className:"text-xs font-semibold text-slate-400 uppercase tracking-wider",children:"Progress"}),e.jsxs("span",{className:"text-sm font-bold text-cyan-400",children:[$e," / 5"]})]}),e.jsx("div",{className:"h-2.5 bg-slate-700/50 rounded-full overflow-hidden border border-slate-600/30",children:e.jsx("div",{className:"h-full bg-gradient-to-r from-cyan-400 via-blue-400 to-blue-500 rounded-full shadow-lg shadow-cyan-400/40 transition-all duration-500",style:{width:`${$e/5*100}%`}})})]})]}),!Fe&&!a&&$e<5&&e.jsx("div",{className:"mt-6 bg-gradient-to-br from-blue-600/20 to-cyan-600/10 border border-blue-400/40 backdrop-blur-md p-5 rounded-2xl animate-in fade-in slide-in-from-bottom",children:e.jsxs("div",{className:"flex gap-3",children:[e.jsx("div",{className:"text-2xl flex-shrink-0",children:"ðŸ‘†"}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("h3",{className:"text-sm font-semibold text-blue-200 mb-1",children:["Step ",$e+1," of 5"]}),e.jsx("p",{className:"text-sm text-blue-100/90 mb-2",children:yr[$e]}),e.jsxs("p",{className:"text-xs text-blue-200/70",children:["Click the"," ",e.jsx("span",{className:"font-semibold",children:"center of the double ring"})," ","for best accuracy"]})]})]})})]}),e.jsxs("div",{className:"space-y-5",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{"data-testid":"mode-local",className:`btn btn--ghost ${he==="local"?"bg-blue-600/20":""}`,onClick:()=>Q("local"),children:"Local ðŸ’»"}),e.jsx("button",{"data-testid":"mode-phone",className:`btn btn--ghost ${he==="phone"?"bg-blue-600/20":""}`,onClick:()=>Q("phone"),children:"Phone ðŸ“±"}),e.jsx("button",{"data-testid":"mode-wifi",className:`btn btn--ghost ${he==="wifi"?"bg-blue-600/20":""}`,onClick:()=>Q("wifi"),children:"WiFi ðŸ“¶"})]}),e.jsx("div",{"data-testid":"device-picker-root","data-open":te?"true":"false",className:"mt-3 rounded-lg border border-indigo-500/30 bg-indigo-500/5 p-3",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{"data-testid":"device-picker-toggle",className:"btn btn--ghost",onClick:ft,onPointerDown:D=>D.stopPropagation(),children:"Device"}),e.jsx("button",{"data-testid":"cam-lock-toggle",className:"btn btn--ghost",onClick:yt,children:de.preferredCameraLocked?"Unlock":"Lock"})]})}),p.length>0&&e.jsxs("div",{className:"bg-gradient-to-br from-slate-800/60 to-slate-900/60 backdrop-blur-sm border border-slate-700/50 rounded-2xl p-5 shadow-xl",children:[e.jsx("h3",{className:"text-xs font-bold text-slate-400 uppercase tracking-widest mb-4",children:"Calibration Confidence"}),We?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("div",{className:"text-3xl sm:text-4xl font-black text-white drop-shadow-lg",children:[We.percentage.toFixed(1),"%"]}),e.jsx("span",{className:`inline-block px-3 py-1 rounded-full text-xs font-semibold ${We.percentage>=90?"bg-emerald-500/25 text-emerald-300":We.percentage>=75?"bg-blue-500/25 text-blue-300":We.percentage>=50?"bg-yellow-500/25 text-yellow-300":"bg-red-500/25 text-red-300"}`,children:We.level})]}),e.jsx("div",{className:"h-2 bg-slate-700/50 rounded-full overflow-hidden border border-slate-600/30",children:e.jsx("div",{className:`h-full rounded-full transition-all duration-500 ${We.percentage>=90?"bg-gradient-to-r from-emerald-400 to-emerald-500 shadow-lg shadow-emerald-400/40":We.percentage>=75?"bg-gradient-to-r from-cyan-400 to-blue-400 shadow-lg shadow-cyan-400/40":We.percentage>=50?"bg-gradient-to-r from-yellow-400 to-amber-400 shadow-lg shadow-yellow-400/40":"bg-gradient-to-r from-red-400 to-pink-400 shadow-lg shadow-red-400/40"}`,style:{width:`${We.percentage}%`}})}),e.jsxs("p",{className:"text-[11px] text-slate-400 mt-3 space-y-1",children:[e.jsx("span",{className:"block",children:"Set each circle on the double (or bull) to jump straight to near-perfect confidence."}),e.jsx("span",{className:"block",children:"Angle forgiveness means even a tilted camera no longer drags the score down."})]})]}):e.jsx("div",{className:"text-center text-slate-400 text-sm py-4",children:"Start calibrating to see confidence"})]}),e.jsxs("div",{className:"bg-gradient-to-br from-slate-800/60 to-slate-900/60 backdrop-blur-sm border border-slate-700/50 rounded-2xl p-5 shadow-xl",children:[e.jsx("h3",{className:"text-xs font-bold text-slate-400 uppercase tracking-widest mb-4",children:"Points"}),e.jsx("div",{className:"space-y-2",children:yr.map((D,O)=>{const F=O<p.length,oe=F?Ma(O,p[O],_[O],t||void 0):null;return e.jsx("div",{className:`p-3 rounded-lg border-2 transition-all ${F?oe?.isValid?"bg-emerald-500/15 border-emerald-400/40 ring-1 ring-emerald-400/20":"bg-red-500/15 border-red-400/40 ring-1 ring-red-400/20":O===$e?"bg-blue-500/15 border-blue-400/50 ring-1 ring-blue-400/30":"bg-slate-700/20 border-slate-600/30 opacity-50"}`,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:`w-2.5 h-2.5 rounded-full flex-shrink-0 ${F?"shadow-md shadow-current":""}`,style:{backgroundColor:oe?.isValid?Ia[O]:"#ef4444"}}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:`text-xs font-semibold truncate ${oe?.isValid?"text-slate-300":"text-red-300"}`,children:D.split(" (")[0]}),oe&&e.jsxs("p",{className:`text-xs mt-0.5 ${oe.isValid?"text-slate-400":"text-red-400 font-semibold"}`,children:[oe.icon," ",oe.distance.toFixed(1),"px"," ",!oe.isValid&&"âŒ Not on double"]})]}),e.jsx("span",{className:"text-xs font-bold flex-shrink-0",children:F?oe?.isValid?"âœ…":"âŒ":String(O+1).padStart(1)})]})},O)})})]}),Fe&&We&&e.jsxs("div",{className:"bg-gradient-to-br from-emerald-900/30 to-cyan-900/20 backdrop-blur-sm border border-emerald-400/30 rounded-2xl p-5 shadow-xl",children:[e.jsx("h3",{className:"text-xs font-bold text-emerald-300 uppercase tracking-widest mb-3",children:"âœ… Compatible"}),e.jsx("div",{className:"space-y-1.5 max-h-48 overflow-y-auto",children:Object.entries(tm).map(([D,O])=>{const F=We.percentage>=O.minConfidence;return e.jsxs("div",{className:`px-3 py-2 rounded-lg text-xs font-medium transition-all ${F?"bg-emerald-500/20 text-emerald-200":"bg-slate-700/30 text-slate-400 opacity-60"}`,children:[e.jsx("span",{className:"mr-2",children:F?"âœ…":"â€”"}),O.label]},D)})})]})]})]}),e.jsxs("div",{className:"flex flex-wrap gap-3 justify-center sm:justify-start mb-8",children:[p.length>0&&!Fe&&!a&&e.jsx("button",{onClick:qn,className:"px-5 py-2.5 bg-slate-700/50 hover:bg-slate-700 border border-slate-600/50 hover:border-slate-500 rounded-lg font-semibold text-sm transition-all",children:"â†©ï¸ Undo"}),p.length>0&&!a&&e.jsx("button",{onClick:mn,className:"px-5 py-2.5 bg-slate-700/50 hover:bg-slate-700 border border-slate-600/50 hover:border-slate-500 rounded-lg font-semibold text-sm transition-all",children:"ðŸ”„ Reset"}),!a&&!Fe&&me&&e.jsx("button",{onClick:z,disabled:G,className:`px-6 py-2.5 rounded-lg font-bold text-sm transition-all flex items-center gap-2 shadow-lg ${G?"bg-slate-700 cursor-not-allowed":"bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-500 hover:to-purple-500 shadow-indigo-500/20"}`,children:G?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"}),"Detecting..."]}):e.jsx(e.Fragment,{children:"ðŸ“¸ Snap & Auto-Calibrate"})}),Fe&&!a&&e.jsx("button",{onClick:Ln,className:"px-6 py-2.5 bg-gradient-to-r from-emerald-600 to-emerald-700 hover:from-emerald-700 hover:to-emerald-800 rounded-lg font-bold text-sm shadow-lg shadow-emerald-500/30 transition-all",children:"ðŸ”’ Lock Calibration"}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("label",{className:"flex items-center gap-2 text-xs opacity-90",children:[e.jsx("input",{type:"checkbox",className:"form-checkbox",checked:N,onChange:D=>w(D.target.checked)}),e.jsx("span",{children:"Diagnostic Mode"})]}),e.jsx("button",{onClick:async()=>{try{const D=await Bu({H:t||null,errorPx:typeof b=="number"?b:null,confidence:typeof We?.percentage=="number"?We.percentage:null,imageSize:r||null,overlaySize:i||null,pointMappings:p.map((O,F)=>({index:F,imageSpace:O,boardSpace:t?Ms(t,O):null})),captureCanvas:f.current||null,extra:{calibrationUseRansac:tt}});Vu(D)}catch(D){console.warn("[Calibrator] Failed to export diagnostic bundle",D)}},className:"px-4 py-2 text-xs rounded-lg bg-white/5 hover:bg-white/10 border border-white/10",disabled:!N,title:N?"Export diagnostic bundle (JSON)":"Enable Diagnostic Mode to export",children:"ðŸ§¶ Export Diagnostic"}),e.jsxs("label",{className:"flex items-center gap-2 text-xs ml-2",children:[e.jsx("input",{type:"checkbox",className:"form-checkbox",checked:!!tt,onChange:D=>de.setCalibrationUseRansac?.(D.target.checked),title:"Use RANSAC-based homography for auto-detection"}),e.jsx("span",{className:"text-xs",children:"Use RANSAC (auto-detect)"})]})]}),a&&e.jsx("button",{onClick:qt,className:"px-6 py-2.5 bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 rounded-lg font-bold text-sm shadow-lg shadow-blue-500/30 transition-all",children:"ðŸ”“ Recalibrate"})]}),re&&!a&&U!==null&&e.jsxs("div",{className:"bg-gradient-to-br from-purple-900/40 to-blue-900/40 backdrop-blur-sm border border-purple-400/30 rounded-2xl p-6 shadow-xl mb-6",children:[e.jsx("h3",{className:"text-lg font-bold text-purple-300 mb-1",children:"ðŸ“ Camera Angle Adjustment"}),e.jsx("p",{className:"text-sm text-purple-200/70 mb-5",children:"Your camera is at an angle. Fine-tune these settings for perfect accuracy from any position."}),e.jsxs("div",{className:"mb-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("label",{className:"text-sm font-semibold text-purple-300",children:"Board Rotation"}),e.jsxs("span",{className:"text-sm font-bold text-cyan-400",children:[Ns(U).toFixed(1),"Â°"]})]}),e.jsx("input",{type:"range",min:"-180",max:"180",step:"1",value:-Ns(U),onChange:D=>P(-(parseFloat(D.target.value)*Math.PI/180)),className:"w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-purple-500"}),e.jsx("p",{className:"text-xs text-slate-400 mt-1",children:Math.abs(Ns(U))<1?"âœ… Camera is front-facing":`Camera is rotated ${Math.abs(Ns(U)).toFixed(1)}Â° ${Ns(U)>0?"clockwise":"counter-clockwise"}`})]}),e.jsxs("div",{className:"mb-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("label",{className:"text-sm font-semibold text-purple-300",children:"Sector Fine-Tune"}),e.jsxs("span",{className:"text-sm font-bold text-cyan-400",children:[ee>0?"+":"",ee]})]}),e.jsx("input",{type:"range",min:"-5",max:"5",step:"1",value:ee,onChange:D=>X(parseInt(D.target.value)),className:"w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-purple-500"}),e.jsx("p",{className:"text-xs text-slate-400 mt-1",children:"Adjust by sector if darts still score wrong sectors (0 = automatic detection)"})]}),e.jsxs("div",{className:"bg-slate-800/50 border border-slate-700/50 rounded-lg p-4 mb-4",children:[e.jsxs("p",{className:"text-sm text-slate-300 mb-3",children:[e.jsx("strong",{children:"Next step:"})," Throw one dart to test"]}),e.jsxs("div",{className:"text-xs text-slate-400 space-y-1",children:[e.jsx("p",{children:"â€¢ Check if it scores at the correct location"}),e.jsx("p",{children:"â€¢ If still wrong, adjust the sliders above"}),e.jsx("p",{children:"â€¢ Repeat until perfect accuracy"})]})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{onClick:x,className:"flex-1 px-4 py-2.5 bg-gradient-to-r from-emerald-600 to-emerald-700 hover:from-emerald-700 hover:to-emerald-800 rounded-lg font-bold text-sm shadow-lg shadow-emerald-500/30 transition-all",children:"âœ… Save & Test"}),e.jsx("button",{onClick:()=>{se(!1),P(null),X(0)},className:"px-4 py-2.5 bg-slate-700/50 hover:bg-slate-700 border border-slate-600/50 hover:border-slate-500 rounded-lg font-semibold text-sm transition-all",children:"Skip"})]})]}),Se&&Ne&&e.jsxs("div",{className:"bg-gradient-to-br from-purple-900/40 to-blue-900/40 backdrop-blur-sm border border-purple-400/30 rounded-2xl p-6 shadow-xl mb-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-lg font-bold",children:"ðŸ” Auto-Detection Results"}),e.jsx("button",{onClick:()=>Me(!1),className:"text-slate-400 hover:text-slate-200 text-xl",children:"âœ•"})]}),e.jsx("p",{className:`text-sm mb-4 font-semibold ${Ne.success?"text-emerald-300":"text-red-300"}`,children:Ne.message||(Ne.success?"âœ… Board detected successfully!":"âŒ Detection failed")}),Ne.success&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4 mb-6",children:[e.jsxs("div",{className:"bg-slate-800/50 border border-slate-700/50 rounded-lg p-3",children:[e.jsx("p",{className:"text-xs text-slate-400 mb-1",children:"System Confidence (game scale)"}),e.jsx("p",{className:"text-2xl font-bold text-cyan-400",children:typeof hn=="number"?`${hn.toFixed(1)}%`:"â€”"}),e.jsxs("p",{className:"text-[11px] text-slate-500 mt-1",children:["Detector score: ",Ne.confidence.toFixed(0),"%"]})]}),e.jsxs("div",{className:"bg-slate-800/50 border border-slate-700/50 rounded-lg p-3",children:[e.jsx("p",{className:"text-xs text-slate-400 mb-1",children:"Detection Error"}),e.jsx("p",{className:"text-2xl font-bold text-emerald-400",children:typeof Ne.errorPx=="number"&&!Number.isNaN(Ne.errorPx)?`${Ne.errorPx.toFixed(2)}px`:"N/A"})]})]}),e.jsxs("div",{className:"bg-slate-800/50 border border-slate-700/50 rounded-lg p-4 mb-4",children:[e.jsx("p",{className:"text-sm text-slate-300 mb-2",children:e.jsx("strong",{children:"Detected Features:"})}),e.jsxs("div",{className:"text-xs text-slate-400 space-y-1",children:[e.jsx("p",{children:"âœ… Board center located"}),e.jsx("p",{children:"âœ… Ring boundaries identified"}),e.jsx("p",{children:"âœ… Board orientation detected"}),Ne.theta!==void 0&&e.jsxs("p",{children:["âœ… Camera angle:"," ",Ns(Ne.theta).toFixed(1),"Â°"]})]})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{onClick:()=>{Me(!1),n({locked:!0})},className:"flex-1 px-4 py-2.5 bg-gradient-to-r from-emerald-600 to-emerald-700 hover:from-emerald-700 hover:to-emerald-800 rounded-lg font-bold text-sm shadow-lg shadow-emerald-500/30 transition-all",children:"âœ… Accept & Lock"}),e.jsx("button",{onClick:()=>Me(!1),className:"px-4 py-2.5 bg-blue-600 hover:bg-blue-700 rounded-lg font-semibold text-sm transition-all",children:"Retry"})]})]}),!Ne.success&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"bg-slate-800/50 border border-slate-700/50 rounded-lg p-4 mb-4",children:[e.jsx("p",{className:"text-sm text-slate-300 mb-2",children:e.jsx("strong",{children:"Detection Tips:"})}),e.jsxs("div",{className:"text-xs text-slate-400 space-y-1",children:[e.jsx("p",{children:"â€¢ Ensure dartboard is fully visible in camera frame"}),e.jsx("p",{children:"â€¢ Make sure board is well-lit"}),e.jsx("p",{children:"â€¢ Try different camera angles (45Â°-90Â° works best)"}),e.jsx("p",{children:"â€¢ Clean camera lens if blurry"})]})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{onClick:()=>Me(!1),className:"flex-1 px-4 py-2.5 bg-blue-600 hover:bg-blue-700 rounded-lg font-bold text-sm shadow-lg shadow-blue-500/30 transition-all",children:"Retry"}),e.jsx("button",{onClick:()=>{Me(!1),mn()},className:"px-4 py-2.5 bg-slate-700 hover:bg-slate-600 rounded-lg font-semibold text-sm transition-all",children:"Manual Mode"})]})]})]}),e.jsxs("div",{className:"space-y-5",children:[V.length>0&&e.jsxs("div",{className:"bg-gradient-to-br from-slate-800/60 to-slate-900/60 backdrop-blur-sm border border-slate-700/50 rounded-2xl p-5",children:[e.jsxs("button",{onClick:()=>ce(!$),className:"w-full flex items-center justify-between font-semibold text-blue-300 hover:text-blue-200 transition-colors mb-3",children:[e.jsxs("span",{children:["ðŸ“‹ Calibration History (",V.length,")"]}),e.jsx("span",{className:"text-lg",children:$?"â–¼":"â–¶"})]}),$&&e.jsx("div",{className:"space-y-2 max-h-64 overflow-y-auto",children:V.map(D=>e.jsxs("div",{className:"w-full text-left p-3 bg-slate-700/40 hover:bg-slate-700/60 rounded-lg transition-all border border-slate-600/30 hover:border-slate-500/30 flex items-center justify-between group",children:[e.jsx("button",{onClick:()=>{ie(D),ce(!1)},className:"flex-1 text-left",children:e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold text-slate-200 text-sm",children:D.date}),e.jsxs("p",{className:"text-xs text-slate-400 mt-1",children:["Error:"," ",typeof D.errorPx=="number"?`${D.errorPx.toFixed(2)}px`:"Unknown",typeof D.confidence=="number"&&e.jsxs("span",{className:"ml-2",children:["Â· Confidence: ",D.confidence.toFixed(1),"%"]})]})]})}),e.jsx("button",{onClick:O=>{O.stopPropagation(),nm(D.id),H(Zs())},className:"ml-2 p-1.5 text-red-400 hover:text-red-300 hover:bg-red-500/20 rounded transition-all opacity-0 group-hover:opacity-100 flex-shrink-0",title:"Delete this calibration",children:e.jsx("span",{className:"text-lg font-bold",children:"âœ•"})})]},D.id))})]}),we.length>1&&e.jsxs("div",{className:"bg-gradient-to-br from-slate-800/60 to-slate-900/60 backdrop-blur-sm border border-slate-700/50 rounded-2xl p-5",children:[e.jsxs("button",{onClick:()=>He(!ge),className:"w-full flex items-center justify-between font-semibold text-purple-300 hover:text-purple-200 transition-colors mb-3",children:[e.jsxs("span",{children:["ðŸ“¹ Cameras (",we.length,")"]}),e.jsx("span",{className:"text-lg",children:ge?"â–¼":"â–¶"})]}),ge&&e.jsx("div",{className:"space-y-2",children:we.map(D=>e.jsx("button",{onClick:()=>{lt(D.deviceId),He(!1)},className:`w-full text-left p-3 rounded-lg transition-all border ${De===D.deviceId?"bg-cyan-600/30 border-cyan-400/40 text-cyan-200 font-semibold":"bg-slate-700/40 hover:bg-slate-700/60 border-slate-600/30 hover:border-slate-500/30 text-slate-200"}`,children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm",children:D.label}),De===D.deviceId&&e.jsx("span",{children:"âœ…"})]})},D.deviceId))})]})]}),a&&e.jsxs("div",{className:"mt-8 bg-gradient-to-r from-emerald-600/20 to-cyan-600/20 border border-emerald-400/30 backdrop-blur-sm p-4 rounded-2xl text-center",children:[e.jsx("p",{className:"font-semibold text-emerald-300 mb-1",children:"âœ… Calibration Active"}),e.jsxs("p",{className:"text-sm text-emerald-200/70",children:["Your setup is locked and ready for accurate scoring Â· Error:"," ",b?.toFixed(2),"px"]})]})]}),e.jsx("video",{ref:c,autoPlay:!0,playsInline:!0,muted:!0,style:{display:"none"},width:640,height:480})]})}const Ts=Vn(t=>({recent:[],totals:{visits:0,darts:0,points:0,finishes:0,busts:0,byMode:{}},calibration:{hasHomography:!1,imageSize:null,lastUpdated:void 0},recordVisit:(n,s,a,r)=>t(i=>{const u={ts:Date.now(),mode:n,darts:s,visitTotal:a,preOpenDarts:r?.preOpenDarts,preRemaining:r?.preRemaining,postRemaining:r?.postRemaining,bust:r?.bust,finish:r?.finish,threeDartAvg:r?.threeDartAvg},f=[...i.recent,u].slice(-50),c={...i.totals};c.visits+=1,c.darts+=s,c.points+=a,u.finish&&(c.finishes+=1),u.bust&&(c.busts+=1);const m=c.byMode[n]||{visits:0,darts:0,points:0};m.visits+=1,m.darts+=s,m.points+=a,c.byMode[n]=m;try{const p=u.finish?"FINISH":u.bust?"BUST":"VISIT",h={mode:n,darts:s,visitTotal:a,preOpenDarts:u.preOpenDarts??0,preRemaining:u.preRemaining,postRemaining:u.postRemaining,threeDartAvg:u.threeDartAvg};console.info(`[Audit:${p}]`,h)}catch{}try{localStorage.setItem("ndn_audit_recent",JSON.stringify(f))}catch{}return{...i,recent:f,totals:c}}),setCalibrationStatus:n=>t(s=>{const a={hasHomography:n.hasHomography??s.calibration.hasHomography,imageSize:n.imageSize===void 0?s.calibration.imageSize:n.imageSize,lastUpdated:Date.now()};try{console.info("[Audit:Calibration]",a)}catch{}return{...s,calibration:a}}),reset:()=>t({recent:[],totals:{visits:0,darts:0,points:0,finishes:0,busts:0,byMode:{}},calibration:{hasHomography:!1,imageSize:null,lastUpdated:void 0}})}));try{typeof window<"u"&&(window.__NDN_AUDIT__={get:()=>Ts.getState(),subscribe:Ts.subscribe,reset:()=>Ts.getState().reset()})}catch{}try{if(typeof window<"u"){const t=localStorage.getItem("ndn_audit_recent");if(t){const n=JSON.parse(t);Array.isArray(n)&&n.length&&Ts.setState(s=>({...s,recent:n.slice(-50)}))}}}catch{}const $a="ndn:match-sync",yl="ndn-match-sync";function un(t){try{const n=typeof window<"u"&&window.BroadcastChannel?window.BroadcastChannel:null;let s=!1;if(n&&typeof n=="function"&&(s=!0),s){const a=n;try{const r=new a(yl);try{r.postMessage(t)}finally{try{r.close()}catch{}}return}catch{}}}catch{try{localStorage.setItem(`${$a}:lastmsg`,JSON.stringify({msg:t,ts:Date.now()}));try{const n=new StorageEvent("storage",{key:`${$a}:lastmsg`,newValue:localStorage.getItem(`${$a}:lastmsg`)});window.dispatchEvent(n)}catch{try{window.dispatchEvent(new Event("storage"))}catch{}}try{window.dispatchEvent(new CustomEvent("ndn:match-sync",{detail:{msg:t}}))}catch{}}catch{}}}function am(t){let n=null;try{const s=typeof window<"u"&&window.BroadcastChannel?window.BroadcastChannel:null;let a=!1;if(s&&typeof s=="function"&&(a=!0),a)try{const r=s;n=new r(yl)}catch{throw new Error("no-bc")}else throw new Error("no-bc");n&&(n.onmessage=r=>{try{t(r.data)}catch{}})}catch{const s=()=>{try{const r=localStorage.getItem(`${$a}:lastmsg`);if(!r)return;const i=JSON.parse(r);t(i.msg)}catch{}},a=r=>{try{if(!r?.detail)return;t(r.detail.msg)}catch{}};return window.addEventListener("storage",s),window.addEventListener("ndn:match-sync",a),()=>{window.removeEventListener("storage",s),window.removeEventListener("ndn:match-sync",a)}}return()=>{try{n&&n.close()}catch{}}}const wl=t=>`ndn_stats_${t}`,jl=t=>`ndn_stats_ts_${t}`,Nl=t=>`ndn_stats_daily_${t}`;function ms(t){try{const n=localStorage.getItem(wl(t));if(!n)return{darts:0,scored:0};const s=JSON.parse(n);return{darts:Number(s.darts)||0,scored:Number(s.scored)||0,fnDarts:Number(s.fnDarts)||0,fnScored:Number(s.fnScored)||0,best3:typeof s.best3=="number"?s.best3:0,worst3:typeof s.worst3=="number"?s.worst3:0,bestLegDarts:typeof s.bestLegDarts=="number"?s.bestLegDarts:0,bestCheckout:typeof s.bestCheckout=="number"?s.bestCheckout:0,worstLegDarts:typeof s.worstLegDarts=="number"?s.worstLegDarts:0,bestFNAvg:typeof s.bestFNAvg=="number"?s.bestFNAvg:0,worstFNAvg:typeof s.worstFNAvg=="number"?s.worstFNAvg:0,num180s:typeof s.num180s=="number"?s.num180s:0}}catch{return{darts:0,scored:0}}}function rm(t,n){try{localStorage.setItem(wl(t),JSON.stringify(n)),window.dispatchEvent(new CustomEvent("ndn:stats-updated",{detail:{name:t,totals:n}}));try{un({type:"statsUpdated",name:t,totals:n})}catch{}}catch{}}function Sl(t){const{darts:n,scored:s}=ms(t);return n?s/n*3:0}function im(t){const{fnDarts:n=0,fnScored:s=0}=ms(t);return n?s/n*3:0}function om(t){const{bestLegDarts:n=0}=ms(t);return n||0}function lm(t){const{bestCheckout:n=0}=ms(t);return n||0}function cm(t){const{num180s:n=0}=ms(t);return Number(n||0)}const Cl="ndn_game_mode_stats";function kl(t){let n={};try{const s=localStorage.getItem(Cl);s&&(n=JSON.parse(s))}catch{}if(Array.isArray(t))for(const s of t)n[s]||(n[s]={played:0,won:0});return n}function dm(t){try{localStorage.setItem(Cl,JSON.stringify(t)),window.dispatchEvent(new CustomEvent("ndn:stats-updated",{detail:{gameModes:!0}}))}catch{}}function Bf(t,n){const s=kl(),a=s[t]||{played:0,won:0};a.played+=1,n&&(a.won+=1),s[t]=a,dm(s)}function oa(t){try{const n=localStorage.getItem(jl(t));if(!n)return[];const s=JSON.parse(n);return Array.isArray(s)?s.map(a=>({t:Number(a.t)||0,darts:Number(a.darts)||0,scored:Number(a.scored)||0,fnDarts:Number(a.fnDarts)||0,fnScored:Number(a.fnScored)||0})).filter(a=>a.t>0):[]}catch{return[]}}function um(t,n){try{localStorage.setItem(jl(t),JSON.stringify(n)),window.dispatchEvent(new CustomEvent("ndn:stats-updated",{detail:{name:t}}))}catch{}}function Vf(t){return oa(t)}function mm(t,n){const s=Date.now();return t.filter(a=>s-a.t<=n)}function Ys(t,n,s,a=Date.now(),r,i){if(n<=0)return;const l=oa(t),u=mm([...l,{t:a,darts:n,scored:s,fnDarts:r,fnScored:i}],1e3*60*60*24*30);um(t,u)}function El(t,n=1e3*60*60*24){const s=oa(t);if(!s.length)return 0;const a=Date.now();let r=0,i=0;for(const l of s)a-l.t<=n&&(r+=l.darts,i+=l.scored);return r<=0?0:i/r*3}function hm(t,n=1e3*60*60*24*30){const s=oa(t);if(!s.length)return 0;const a=Date.now();let r=0,i=0;for(const l of s)a-l.t<=n&&(r+=l.fnDarts||0,i+=l.fnScored||0);return r<=0?0:i/r*3}function fm(t){try{const n=localStorage.getItem(Nl(t));if(!n)return null;const s=JSON.parse(n);return{avg:Number(s.avg)||0,ts:Number(s.ts)||0}}catch{return null}}function pm(t,n){try{localStorage.setItem(Nl(t),JSON.stringify(n)),window.dispatchEvent(new CustomEvent("ndn:stats-updated",{detail:{name:t}}))}catch{}}function Hf(t){const n=fm(t),s=Date.now(),a=1e3*60*60*24;if(n&&s-n.ts<a)return n.avg;const r=El(t,a);return pm(t,{avg:r,ts:s}),r}function Wf(t){const s=oa(t);if(!s.length)return 0;const a=Date.now(),r=s.filter(c=>a-c.t<=2592e6),i=r.filter(c=>typeof c.fnDarts=="number"),l=i.length?i:r;let u=0,f=0;for(const c of l)u+=c.darts,f+=c.scored;return u<=0?0:f/u*3}function zf(t){return hm(t,2592e6)}function xm(t,n){let s=null;try{const a=localStorage.getItem("ndn:currentUser");a?s=a:typeof window?.ndnCurrentUser=="string"&&(s=window.ndnCurrentUser)}catch{}for(const a of t){const r={...a};if(s){const y=(r.name||"").trim();(!y||y.toLowerCase()==="you")&&(r.name=s)}let i=0,l=0,u=0,f=0,c=0,m=0,p=0,h=0,N=0,w=0,b=0,g=0;for(const y of r.legs){if(!y.finished)continue;i+=y.dartsThrown,l+=Math.max(0,y.totalScoreStart-y.totalScoreRemaining);const{d:M,s:L}=bm(y);u+=M,f+=L;const S=Math.max(0,y.dartsThrown),I=Math.max(0,y.totalScoreStart-y.totalScoreRemaining),k=S>0?I/S*3:0,T=M>0?L/M*3:0;if(k>0&&(c=Math.max(c,k),m=m===0?k:Math.min(m,k)),T>0&&(w=Math.max(w,T),b=b===0?T:Math.min(b,T)),y.totalScoreRemaining===0){(p===0||S<p)&&(p=S),(N===0||S>N)&&(N=S);const V=typeof y.checkoutScore=="number"?y.checkoutScore:0;V>h&&(h=V)}try{for(const V of y.visits||[])Number(V.score||0)===180&&(g+=1)}catch{}}if(i>0){const y=ms(r.name),M={darts:y.darts+i,scored:y.scored+l,fnDarts:(y.fnDarts||0)+u,fnScored:(y.fnScored||0)+f,best3:Math.max(y.best3||0,c||0),worst3:(()=>{const L=y.worst3||0;return L===0?m||0:m===0?L:Math.min(L,m)})(),bestLegDarts:(()=>{const L=y.bestLegDarts||0;return L===0?p||0:p===0?L:Math.min(L,p)})(),bestCheckout:Math.max(y.bestCheckout||0,h||0),worstLegDarts:(()=>{const L=y.worstLegDarts||0;return L===0?N||0:N===0?L:Math.max(L,N)})(),bestFNAvg:Math.max(y.bestFNAvg||0,w||0),worstFNAvg:(()=>{const L=y.worstFNAvg||0;return L===0?b||0:b===0?L:Math.min(L,b)})(),num180s:(y.num180s||0)+(g||0)};rm(r.name,M)}}}function bm(t){let n=Math.min(9,t.dartsThrown);if(n<=0)return{d:0,s:0};let s=0;for(const r of t.visits){if(n<=0)break;const i=Math.min(n,r.darts);i===r.darts?s+=r.score:s+=Math.round(r.score/r.darts*i),n-=i}return{d:Math.min(9,t.dartsThrown),s}}function Tl(t){const n=(t.visits||[]).reduce((r,i)=>r+(i.preOpenDarts||0),0),s=Math.max(0,t.dartsThrown-n);return s===0?0:(t.totalScoreStart-t.totalScoreRemaining)/s*3}function gm(t){const n=Tl(t),s=t.finished;return{avg:n,isCompleted:s,darts:t.dartsThrown,checkout:t.checkoutScore??0}}function vm(t){if(t.legs.length===0)return;const n=[];let s,a=t.bestCheckout??0;for(const r of t.legs){if(!r.finished)continue;const i=gm(r);n.push(i.avg),(!s||i.darts<s.darts||i.darts===s.darts&&(r.endTime??0)<s.timestamp)&&(s={darts:i.darts,timestamp:r.endTime??Date.now()}),i.checkout>a&&(a=i.checkout)}n.length&&(t.bestThreeDartAvg=Math.max(...n),t.worstThreeDartAvg=Math.min(...n)),s&&(t.bestNineDart=s),t.bestCheckout=a}const Wt=Vn(t=>({roomId:"",players:[],currentPlayerIdx:0,startingScore:501,inProgress:!1,newMatch:(n,s,a="")=>t(()=>{const r=n.map((i,l)=>({id:`${l}`,name:i,legsWon:0,legs:[]}));return console.debug("[useMatch] newMatch",n,s,a),{players:r,currentPlayerIdx:0,startingScore:s,inProgress:!0,roomId:a,bestLegThisMatch:void 0}}),addVisit:(n,s,a)=>t(r=>{if(console.debug("[useMatch] addVisit",{score:n,darts:s,inProgress:r.inProgress,currentPlayerIdx:r.currentPlayerIdx,players:r.players.length}),!r.inProgress)return r;const i=r.currentPlayerIdx,l=r.players[i],u=l.legs[l.legs.length-1];let f,c;!u||u.finished?(f={visits:[],totalScoreStart:r.startingScore,totalScoreRemaining:r.startingScore,dartsThrown:0,finished:!1,checkoutScore:null,startTime:Date.now()},c=[...l.legs,f]):(f={...u,visits:[...u.visits]},c=[...l.legs.slice(0,-1),f]);const m=f.totalScoreRemaining,p=Number(a?.visitTotal??n),h=Math.max(0,m-p);f.visits.push({darts:s,score:n,preOpenDarts:a?.preOpenDarts,doubleWindowDarts:a?.doubleWindowDarts,finishedByDouble:a?.finishedByDouble,visitTotal:p,entries:Array.isArray(a?.entries)?a.entries.map(b=>({label:String(b.label??""),value:Number(b.value??0),ring:String(b.ring??"")})):void 0}),f.dartsThrown+=s,f.totalScoreRemaining=h;const N={...l,legs:c};try{const b=n===0&&s>0&&h===m,g=h===0,y={},M=(f.visits||[]).reduce((S,I)=>S+(I.preOpenDarts||0),0),L=Math.max(0,f.dartsThrown-M);if(L>0&&(L%3===0||g)){const S=Tl(f);Math.abs((N.currentThreeDartAvg??0)-S)>1e-4&&(N.currentThreeDartAvg=S),y.threeDartAvg=S}Ts.getState().recordVisit("x01-match",s,p,{preOpenDarts:a?.preOpenDarts??0,preRemaining:m,postRemaining:h,...y,bust:b,finish:g})}catch{}try{un({type:"visit",score:p,darts:s,playerIdx:r.currentPlayerIdx,ts:Date.now()})}catch{}const w=r.players.map((b,g)=>g===i?N:b);return{...r,players:w}}),undoVisit:()=>t(n=>{const s=n.currentPlayerIdx,a=n.players[s],r=a.legs[a.legs.length-1];if(!r||r.finished||r.visits.length===0)return n;const i=r.visits.slice(0,-1),l=r.visits[r.visits.length-1],u=Number(l.visitTotal??l.score),f={...r,visits:i,dartsThrown:r.dartsThrown-l.darts,totalScoreRemaining:r.totalScoreRemaining+u},c=[...a.legs.slice(0,-1),f],m={...a,legs:c},p=n.players.map((h,N)=>N===s?m:h);return{...n,players:p}}),endLeg:n=>t(s=>{const a=s.currentPlayerIdx,r=s.players[a],i=r.legs[r.legs.length-1];if(!i||i.finished)return s;const l=Date.now(),u={...i,finished:!0,checkoutScore:n,endTime:l},f=[...r.legs.slice(0,-1),u];let c=r.legsWon,m=s.bestLegThisMatch;u.totalScoreRemaining===0&&(c+=1,(!m||u.dartsThrown<m.darts)&&(m={playerId:r.id,darts:u.dartsThrown,timestamp:l}));const p={...r,legs:f,legsWon:c},h=s.players.map((N,w)=>w===a?p:N);try{un({type:"endLeg",checkoutScore:n,playerIdx:s.currentPlayerIdx,ts:Date.now()})}catch{}return{...s,players:h,bestLegThisMatch:m}}),nextPlayer:()=>t(n=>{const s=(n.currentPlayerIdx+1)%n.players.length;try{un({type:"nextPlayer",currentPlayerIdx:s,ts:Date.now()})}catch{}return{...n,currentPlayerIdx:s}}),endGame:()=>t(n=>{if(!n.inProgress)return n;const s=n.players.map(a=>{const r={...a};return vm(r),r});try{xm(s,{recordSeries:!1})}catch{}try{un({type:"endGame",ts:Date.now()})}catch{}return{...n,players:s,inProgress:!1}}),importState:n=>t(()=>({...n})),setPlayerCurrentAverage:(n,s)=>t(a=>{const r=a.players[n];if(!r)return a;if(Math.abs((r.currentThreeDartAvg??0)-s)>1e-4){const i={...r,currentThreeDartAvg:s},l=a.players.map((u,f)=>f===n?i:u);return{...a,players:l}}return a})}));function jr(t,n,s,a){const r=Ms(t,n);return r?typeof s=="number"?_u(r,s,a??0):Uu(r):{base:0,ring:"MISS",sector:null,mult:0}}class ym{width=0;height=0;bg=null;lastAcceptTs=0;cooldownMs=600;roiRadius=0;roiCx=0;roiCy=0;initialized=!1;thresh=18;minArea=60;maxArea=6e3;angMaxDeg=70;prevTip=null;prevArea=0;stableCount=0;requireStableN=2;constructor(n){n?.thresh!==void 0&&(this.thresh=n.thresh),n?.minArea!==void 0&&(this.minArea=n.minArea),n?.maxArea!==void 0&&(this.maxArea=n.maxArea),n?.requireStableN!==void 0&&(this.requireStableN=n.requireStableN),n?.angMaxDeg!==void 0&&(this.angMaxDeg=n.angMaxDeg)}setROI(n,s,a){this.roiCx=n,this.roiCy=s,this.roiRadius=Math.max(0,a|0)}reset(n,s){this.width=n,this.height=s,this.bg=new Float32Array(n*s),this.initialized=!1}updateBackground(n,s=.05){const{width:a,height:r,data:i}=n;(!this.bg||a!==this.width||r!==this.height)&&this.reset(a,r);const l=this.bg,u=a*r;for(let f=0,c=0;f<u;f++,c+=4){const m=i[c],p=i[c+1],h=i[c+2],N=.299*m+.587*p+.114*h;this.initialized?l[f]=(1-s)*l[f]+s*N:l[f]=N}this.initialized=!0}inRoi(n,s){if(this.roiRadius<=0)return!0;const a=n-this.roiCx,r=s-this.roiCy;return a*a+r*r<=this.roiRadius*this.roiRadius}detect(n){const a=Date.now()-this.lastAcceptTs<this.cooldownMs,{width:r,height:i,data:l}=n;(!this.bg||r!==this.width||i!==this.height)&&this.reset(r,i);const u=this.bg;if(!this.initialized)return this.updateBackground(n,1),console.log("[DETECTOR] Background not initialized yet"),null;const f=r*i,c=new Uint8Array(f),m=new Float32Array(f);let p=0,h=0,N=0;const w=new Uint8Array(f);for(let A=0,W=0;A<f;A++,W+=4){const ae=l[W],K=l[W+1],_e=l[W+2],Ae=Math.max(ae,K,_e),ut=Math.min(ae,K,_e),_=.299*ae+.587*K+.114*_e,Y=Math.abs(_-u[A]);m[A]=Y;const Q=Math.floor(A/r),de=A-Q*r,tt=Ae===0?0:(Ae-ut)/Ae,ft=Ae>=250&&tt<=.12;ft&&(w[A]=1),this.inRoi(de,Q)&&!ft&&(p+=Y,h+=Y*Y,N++)}const b=N?p/N:0,g=N?Math.max(0,h/N-b*b):0,y=Math.sqrt(g),M=Math.max(this.thresh,b+1.2*y);for(let A=0;A<f;A++){if(w[A]){c[A]=0;continue}if(m[A]>M){const W=Math.floor(A/r),ae=A-W*r;c[A]=this.inRoi(ae,W)?1:0}}this._dilate(c,r,i),this._erode(c,r,i);const L=new Uint8Array(f);let S=0,I=null;for(let A=0;A<f;A++){if(c[A]===0||L[A])continue;const W=[];let ae=0,K=0;const _e=[A];for(L[A]=1;K<_e.length;){const Ae=_e[K++];W.push(Ae),ae++;const ut=Ae/r|0,_=[Ae-1,Ae+1,Ae-r,Ae+r];for(const Y of _)Y<0||Y>=f||L[Y]||(Y===Ae-1||Y===Ae+1)&&(Y/r|0)!==ut||c[Y]&&(L[Y]=1,_e.push(Y))}ae>S&&(S=ae,I=W)}if(!I||S<this.minArea||S>this.maxArea)return a||this.updateBackground(n,.02),Math.random()<.02&&console.log("[DETECTOR] No valid blob:",{bestArea:S,minArea:this.minArea,maxArea:this.maxArea,hasBlob:!!I}),null;let k=r,T=i,E=0,V=0,H=0,$=0;for(const A of I){const W=A/r|0,ae=A-W*r;H+=ae,$+=W,ae<k&&(k=ae),ae>E&&(E=ae),W<T&&(T=W),W>V&&(V=W)}H/=S,$/=S;let ce=0,me=0,xe=0;for(const A of I){const W=A/r|0,K=A-W*r-H,_e=W-$;ce+=K*K,me+=_e*_e,xe+=K*_e}ce/=S,me/=S,xe/=S;const we=ce+me,ye=ce*me-xe*xe,De=Math.sqrt(Math.max(0,we*we/4-ye)),Ue=we/2+De;let ge=xe,He=Ue-ce;Math.hypot(ge,He)<1e-6&&(ge=Ue-me,He=xe);const U=Math.hypot(ge,He)||1;ge/=U,He/=U;const P=H-this.roiCx,ee=$-this.roiCy,X=Math.hypot(P,ee),re=Math.max(8,this.roiRadius*.05);if(X>=re){const A=P/X,W=ee/X,ae=Math.max(-1,Math.min(1,Math.abs(ge*A+He*W))),K=Math.acos(ae)*180/Math.PI;if(K>this.angMaxDeg)return a||this.updateBackground(n,.02),console.log("[DETECTOR] Rejected - angle too large:",{angDeg:K,maxAllowed:this.angMaxDeg}),null}let se=-1/0,je=H,le=$;for(const A of I){const W=A/r|0,ae=A-W*r,K=(ae-H)*ge+(W-$)*He;K>se&&(se=K,je=ae,le=W)}const Ne=je-this.roiCx,Ie=le-this.roiCy,Se=Ne*Ne+Ie*Ie,Me=Math.max(1,E-k+1),G=Math.max(1,V-T+1),Ce=Me*G,he=S/Ce,Ee=Math.sqrt(Se)/Math.max(1,this.roiRadius);let te=.5;he<.45&&(te+=.2),he<.25&&(te+=.15),Ee<1.1&&(te+=.1);const Te=we-Ue;return(Ue>0?1-Te/Ue:0)>.3&&(te+=.1),te=Math.max(0,Math.min(1,te)),this._isStable({x:je+.5,y:le+.5},S)?a?(console.log("[DETECTOR] In cooldown period"),null):(console.log("[DETECTOR] âœ… DART FOUND!",{tipX:je,tipY:le,area:S,confidence:te}),{tip:{x:je+.5,y:le+.5},axis:{x1:H-ge*20,y1:$-He*20,x2:H+ge*20,y2:$+He*20},area:S,bbox:{x:k,y:T,w:Me,h:G},confidence:te}):(console.log("[DETECTOR] Waiting for stability:",{stableCount:this.stableCount,needFrames:this.requireStableN}),null)}accept(n,s){if(this.lastAcceptTs=Date.now(),this.prevTip=null,this.prevArea=0,this.stableCount=0,!this.bg)return;const{width:a}=n,r=this.bg,{x:i,y:l,w:u,h:f}=s.bbox,c=.5;for(let m=l;m<l+f;m++)for(let p=i;p<i+u;p++){const h=m*a+p,N=h*4,w=n.data[N],b=n.data[N+1],g=n.data[N+2],y=.299*w+.587*b+.114*g;r[h]=(1-c)*r[h]+c*y}}_isStable(n,s){const a=(r,i)=>Math.hypot(r.x-i.x,r.y-i.y)<=6;if(!this.prevTip)return this.prevTip={...n},this.prevArea=s,this.stableCount=1,!1;if(a(this.prevTip,n)&&Math.abs(s-this.prevArea)/Math.max(1,s)<.3)this.prevTip={...n},this.prevArea=s,this.stableCount++;else return this.prevTip={...n},this.prevArea=s,this.stableCount=1,!1;return this.stableCount>=this.requireStableN}_dilate(n,s,a){const r=new Uint8Array(n.length);for(let i=0;i<a;i++)for(let l=0;l<s;l++){let u=0;for(let f=-1;f<=1;f++){for(let c=-1;c<=1;c++){const m=i+f,p=l+c;if(!(m<0||m>=a||p<0||p>=s)&&n[m*s+p]){u=1;break}}if(u)break}r[i*s+l]=u}n.set(r)}_erode(n,s,a){const r=new Uint8Array(n.length);for(let i=0;i<a;i++)for(let l=0;l<s;l++){let u=1;for(let f=-1;f<=1;f++){for(let c=-1;c<=1;c++){const m=i+f,p=l+c;if(!(m<0||m>=a||p<0||p>=s)&&!n[m*s+p]){u=0;break}}if(!u)break}r[i*s+l]=u}n.set(r)}}function wm(t){try{if(!t||typeof t!="object")return null;const n=t.confidence,s=typeof n=="number"&&Number.isFinite(n)?n>1?Math.max(0,Math.min(1,n/100)):Math.max(0,Math.min(1,n)):void 0;if((t.type==="dart"||t.kind==="dart"||t.event==="dart")&&typeof t.value=="number"){const a=bo(t.ring),r=go(t.value,a);return r?{...r,confidence:s}:null}if(typeof t.value=="number"&&t.ring){const a=bo(t.ring),r=go(t.value,a);return r?{...r,confidence:s}:null}if(typeof t.score=="string"){const a=t.score.trim().toUpperCase();if(a==="50"||a==="DBULL"||a==="INNER_BULL")return{value:50,ring:"INNER_BULL",sector:null,mult:0,confidence:s};if(a==="25"||a==="BULL"||a==="OBULL")return{value:25,ring:"BULL",sector:null,mult:0,confidence:s};const r=a.match(/^(S|D|T)(\d{1,2})$/);if(r){const i=r[1]==="S"?1:r[1]==="D"?2:3,l=parseInt(r[2],10);if(l>=1&&l<=20)return{value:l*i,ring:i===1?"SINGLE":i===2?"DOUBLE":"TRIPLE",sector:l,mult:i,confidence:s}}}if(typeof t.sector=="number"&&typeof t.mult=="number"){const a=Math.max(1,Math.min(20,Math.floor(t.sector))),r=t.mult===1?1:t.mult===2?2:3;return{value:a*r,ring:r===1?"SINGLE":r===2?"DOUBLE":"TRIPLE",sector:a,mult:r,confidence:s}}if(t.bull){const a=String(t.bull).toLowerCase()==="inner"||t.bull===!0;return{value:a?50:25,ring:a?"INNER_BULL":"BULL",sector:null,mult:0,confidence:s}}}catch{}return null}function bo(t){const n=String(t||"").toUpperCase();return n.startsWith("TR")?"TRIPLE":n.startsWith("DO")?"DOUBLE":n.startsWith("SI")?"SINGLE":n==="INNER_BULL"||n==="DBULL"||n==="50"||n==="IBULL"?"INNER_BULL":n==="BULL"||n==="25"||n==="OBULL"||n==="OUTER_BULL"?"BULL":n==="MISS"||n==="0"?"MISS":"SINGLE"}function go(t,n){const s=Math.max(0,Math.min(60,Math.round(Number(t)||0)));return n==="INNER_BULL"?{value:50,ring:n}:n==="BULL"?{value:25,ring:n}:{value:s,ring:n}}function jm(t,n){let s=null,a=!0,r=null,i=0;const l=400,u=[],f=new Set;function c(p,h){const N=typeof p?.id=="string"||typeof p?.id=="number"?String(p.id):null;if(N){if(f.has(N))return;if(f.add(N),u.push(N),u.length>200){const g=u.shift();g&&f.delete(g)}}const w=`${h.value}|${h.ring}|${h.sector??""}|${h.mult??""}`,b=Date.now();w===r&&b-i<l||(r=w,i=b,n(h))}function m(){if(a)try{s=new WebSocket(t),s.onmessage=p=>{try{const h=JSON.parse(p.data),N=wm(h);N&&c(h,N)}catch{}},s.onclose=()=>{s=null,setTimeout(m,1500)},s.onerror=()=>{}}catch{setTimeout(m,2e3)}}return m(),{close:()=>{a=!1;try{s?.close()}catch{}}}}function vo({storageKey:t,children:n,className:s,defaultWidth:a=640,defaultHeight:r=360,minWidth:i=320,minHeight:l=200,maxWidth:u=1600,maxHeight:f=1200,autoFill:c=!1}){const[m,p]=o.useState(()=>{try{const S=localStorage.getItem(t);if(S)return JSON.parse(S)}catch{}return c?{width:a}:{width:a,height:r}}),h=o.useRef(null),N=o.useRef(null);o.useEffect(()=>{function S(){try{localStorage.removeItem(t)}catch{}p({width:a,height:r})}return window.addEventListener("ndn:layout-reset",S),window.addEventListener("ndn:camera-reset",S),()=>{window.removeEventListener("ndn:layout-reset",S),window.removeEventListener("ndn:camera-reset",S)}},[t,a,r]),o.useEffect(()=>{try{localStorage.setItem(t,JSON.stringify(m))}catch{}},[m,t]);function w(S,I,k){return Math.max(I,Math.min(k,S))}function b(S,I){S.preventDefault();const k=N.current;if(!k)return;const T=k.getBoundingClientRect();h.current={x:S.clientX,y:S.clientY,w:T.width,h:T.height,dir:I},window.addEventListener("mousemove",g),window.addEventListener("mouseup",y)}function g(S){const I=h.current;if(!I)return;const k=S.clientX-I.x,T=S.clientY-I.y;let E=I.w,V=I.h;I.dir.includes("e")&&(E=w(I.w+k,i,u)),!c&&I.dir.includes("s")&&(V=w(I.h+T,l,f)),I.dir.includes("w")&&(E=w(I.w-k,i,u)),!c&&I.dir.includes("n")&&(V=w(I.h-T,l,f)),p({width:Math.round(E),height:Math.round(V)})}function y(){window.removeEventListener("mousemove",g),window.removeEventListener("mouseup",y),h.current=null}function M(S,I){const T=S.key;if(!["ArrowLeft","ArrowRight","ArrowUp","ArrowDown","Enter"," "].includes(T))return;S.preventDefault();const E=T==="ArrowLeft"||T==="ArrowUp"?-20:20;p(V=>{const H=V.width||a,$=V.height||r;let ce=H,me=$;return I.includes("e")&&(ce=w(H+E,i,u)),I.includes("w")&&(ce=w(H-E,i,u)),!c&&I.includes("s")&&(me=w($+E,l,f)),!c&&I.includes("n")&&(me=w($-E,l,f)),{width:Math.round(ce),height:Math.round(me)}})}const L={width:c?"100%":m.width?`${m.width}px`:void 0,height:c?"100%":m.height?`${m.height}px`:void 0,maxWidth:"100%",maxHeight:c?"100%":"80vh",position:"relative",...c?{display:"flex",flexDirection:"column",flex:"1 1 auto"}:{}};return e.jsxs("div",{ref:N,className:`${s||""}`,style:L,children:[n,e.jsx("div",{className:"resizer resizer-nw",onMouseDown:S=>b(S,"nw"),role:"button",tabIndex:0,"aria-label":"Resize north-west",onKeyDown:S=>M(S,"nw")}),e.jsx("div",{className:"resizer resizer-ne",onMouseDown:S=>b(S,"ne"),role:"button",tabIndex:0,"aria-label":"Resize north-east",onKeyDown:S=>M(S,"ne")}),e.jsx("div",{className:"resizer resizer-sw",onMouseDown:S=>b(S,"sw"),role:"button",tabIndex:0,"aria-label":"Resize south-west",onKeyDown:S=>M(S,"sw")}),e.jsx("div",{className:"resizer resizer-se",onMouseDown:S=>b(S,"se"),role:"button",tabIndex:0,"aria-label":"Resize south-east",onKeyDown:S=>M(S,"se")})]})}function Dl({storageKey:t,children:n,className:s,defaultWidth:a=520,defaultHeight:r,minWidth:i=360,minHeight:l=200,maxWidth:u=1100,maxHeight:f=900,fullScreen:c=!1,initialFitHeight:m=!1,onClose:p}){const[h,N]=o.useState(()=>{if(!c){try{const T=localStorage.getItem(t);if(T)return JSON.parse(T)}catch{}return{width:a,height:r}}return{}}),w=o.useRef(null);o.useEffect(()=>{if(c)return;function T(){try{localStorage.removeItem(t)}catch{}if(m&&S.current?.parentElement){const E=S.current.parentElement,V=window.getComputedStyle(E),H=parseFloat(V.paddingTop||"0")||0,$=parseFloat(V.paddingBottom||"0")||0,ce=Math.max(0,E.clientHeight-H-$),me=Math.max(l,Math.min(f,Math.round(ce)));N({width:a,height:me});return}N({width:a,height:r})}return window.addEventListener("ndn:layout-reset",T),()=>window.removeEventListener("ndn:layout-reset",T)},[t,a,r,c]),o.useEffect(()=>{if(!c)try{localStorage.setItem(t,JSON.stringify(h))}catch{}},[h,t,c]),o.useEffect(()=>{if(c||!m)return;const T=S.current?.parentElement;if(!T)return;const E=window.getComputedStyle(T),V=parseFloat(E.paddingTop||"0")||0,H=parseFloat(E.paddingBottom||"0")||0,$=Math.max(0,T.clientHeight-V-H),ce=Math.max(l,Math.min(f,Math.round($)));try{const me=localStorage.getItem(t);if(me){const we=JSON.parse(me)?.height||0;(!we||we<ce)&&N(ye=>({...ye,height:ce}));return}}catch{}N(me=>({...me,height:ce}))},[m,c,t,l,f]);function b(T,E,V){return Math.max(E,Math.min(V,T))}function g(T,E){T.preventDefault();const V=S.current;if(!V)return;const H=V.getBoundingClientRect();w.current={x:T.clientX,y:T.clientY,w:H.width,h:H.height,dir:E},window.addEventListener("mousemove",M),window.addEventListener("mouseup",L)}function y(T,E){const H=T.key;if(!["ArrowLeft","ArrowRight","ArrowUp","ArrowDown","Enter"," "].includes(H))return;T.preventDefault();const $=H==="ArrowLeft"||H==="ArrowUp"?-20:20;N(ce=>{const me=ce.width||a,xe=ce.height||r||l;let we=me,ye=xe;return E.includes("e")&&(we=b(me+$,i,u)),E.includes("w")&&(we=b(me-$,i,u)),E.includes("s")&&(ye=b(xe+$,l,f)),E.includes("n")&&(ye=b(xe-$,l,f)),{width:Math.round(we),height:Math.round(ye)}})}function M(T){const E=w.current;if(!E)return;const V=T.clientX-E.x,H=T.clientY-E.y,$=E.dir;let ce=E.w,me=E.h,xe=1/0;const we=S.current?.parentElement;if(we){const De=window.getComputedStyle(we),Ue=parseFloat(De.paddingTop||"0")||0,ge=parseFloat(De.paddingBottom||"0")||0;xe=Math.max(0,we.clientHeight-Ue-ge)}const ye=Math.min(f,isFinite(xe)?xe:f);$.includes("e")&&(ce=b(E.w+V,i,u)),$.includes("s")&&(me=b(E.h+H,l,ye)),$.includes("w")&&(ce=b(E.w-V,i,u)),$.includes("n")&&(me=b(E.h-H,l,ye)),N({width:Math.round(ce),height:Math.round(me)})}function L(){window.removeEventListener("mousemove",M),window.removeEventListener("mouseup",L),w.current=null}const S=o.useRef(null);o.useEffect(()=>{if(!p)return;function T(E){E.key==="Escape"&&(E.stopPropagation(),p())}return window.addEventListener("keydown",T,!0),()=>window.removeEventListener("keydown",T,!0)},[p]);const I=c?{width:"100%",height:"100%",maxWidth:"100%",maxHeight:"100%"}:{width:h.width?`${h.width}px`:void 0,height:h.height?`${h.height}px`:void 0,maxWidth:`${u}px`,maxHeight:"100%"},k=c?"card relative ndn-modal-full":"card relative";return e.jsxs("div",{ref:S,className:`${k} ${s||""}`,style:I,children:[e.jsx(Bn,{returnFocus:!0,className:"flex-1 flex flex-col min-h-0 w-full",children:n}),!c&&e.jsx("div",{className:"resizer resizer-nw",onMouseDown:T=>g(T,"nw"),role:"button",tabIndex:0,"aria-label":"Resize north-west",onKeyDown:T=>y(T,"nw")}),!c&&e.jsx("div",{className:"resizer resizer-ne",onMouseDown:T=>g(T,"ne"),role:"button",tabIndex:0,"aria-label":"Resize north-east",onKeyDown:T=>y(T,"ne")}),!c&&e.jsx("div",{className:"resizer resizer-sw",onMouseDown:T=>g(T,"sw"),role:"button",tabIndex:0,"aria-label":"Resize south-west",onKeyDown:T=>y(T,"sw")}),!c&&e.jsx("div",{className:"resizer resizer-se",onMouseDown:T=>g(T,"se"),role:"button",tabIndex:0,"aria-label":"Resize south-east",onKeyDown:T=>y(T,"se")}),!c&&e.jsx("div",{className:"resizer-edge resizer-s",onMouseDown:T=>g(T,"s"),role:"button",tabIndex:0,"aria-label":"Resize south",onKeyDown:T=>y(T,"s")})]})}const Nm=Vn((t,n)=>({samples:[],addSample:s=>t(a=>({samples:[...a.samples,s]})),clear:()=>t({samples:[]}),export:()=>n().samples.slice()})),Jt=Vn(t=>({darts:0,total:0,entries:[],setVisit:(n,s,a)=>t({entries:n,darts:s,total:a}),reset:()=>t({darts:0,total:0,entries:[]})})),zt=Vn(t=>({paused:!1,pauseEndsAt:null,pauseStartedAt:null,setPaused:(n,s=null)=>t({paused:n,pauseEndsAt:s??null,pauseStartedAt:n?Date.now():null})}));function Sm({onClose:t,onQuit:n,onPause:s}){return dt.useEffect(()=>{const a=r=>{r.key==="Escape"&&t()};return window.addEventListener("keydown",a),()=>window.removeEventListener("keydown",a)},[t]),e.jsxs("div",{className:"fixed inset-0 z-[1200]",role:"presentation",children:[e.jsx("button",{className:"absolute inset-0 bg-black/50",onClick:t,"aria-label":"Close overlay"}),e.jsx("div",{className:"absolute inset-0 flex items-center justify-center p-4",children:e.jsx(Bn,{returnFocus:!0,children:e.jsxs("div",{className:"card max-w-md w-full p-4 rounded-xl text-left",role:"dialog","aria-modal":"true","aria-labelledby":"pause-quit-heading",children:[e.jsxs("div",{className:"flex justify-between items-center mb-3",children:[e.jsx("h3",{id:"pause-quit-heading",className:"text-lg font-bold",children:"Quit or Pause ðŸŽ¯"}),e.jsx("button",{className:"btn px-3 py-1",onClick:t,"aria-label":"Close dialog",children:"âœ•"})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("p",{className:"mb-2",children:"You can either quit the match, or pause it for up to 5 minutes ðŸŽ¯."}),e.jsx("p",{className:"text-sm text-slate-400",children:"If paused, the match will automatically resume when the timer expires or when a player resumes early ðŸŽ¯."})]}),e.jsxs("div",{className:"flex gap-2 flex-wrap mb-3",children:[e.jsx("button",{className:"btn bg-rose-600 hover:bg-rose-700 px-3 py-1",onClick:()=>n(),children:"Quit match ðŸŽ¯"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"opacity-80",children:"Pause:"}),[1,2,3,4,5].map(a=>e.jsxs("button",{className:"btn btn--ghost px-3 py-1 text-sm",onClick:()=>s(a),children:[a,"m ðŸŽ¯"]},a))]})]}),e.jsx("div",{className:"text-right",children:e.jsx("button",{className:"btn btn--ghost px-3 py-1",onClick:t,children:"Cancel ðŸŽ¯"})})]})})})]})}function Cm(t){const n=Math.max(0,Math.floor(t/1e3)),s=Math.floor(n/60).toString().padStart(2,"0"),a=(n%60).toString().padStart(2,"0");return`${s}:${a}`}function Il({compact:t=!1}){const n=zt(m=>m.pauseEndsAt),s=zt(m=>m.pauseStartedAt),a=zt(m=>m.paused),[r,i]=o.useState(Date.now());if(o.useEffect(()=>{if(!a||!n)return;const m=setInterval(()=>i(Date.now()),500);return()=>clearInterval(m)},[a,n]),!a||!n)return null;const l=Math.max(0,n-r),f=Math.max(1,n-(s??r)),c=Math.max(0,Math.min(1,1-l/f));return e.jsxs("div",{className:"mr-2",role:"status","aria-live":"polite","aria-atomic":"true","aria-label":`Match paused, ${Math.ceil(l/1e3)} seconds remaining`,children:[e.jsxs("div",{className:`px-2 py-1 rounded-full bg-amber-600 text-black text-xs font-semibold ${t?"":"mr-2"}`,children:["Paused ",Cm(l)," ðŸŽ¯"]}),!t&&e.jsx("div",{className:"w-40 h-2 bg-white/10 rounded overflow-hidden mt-1","aria-hidden":!0,children:e.jsx("div",{className:"h-2 bg-amber-400",style:{width:`${Math.round(c*100)}%`}})})]})}const Ml="ndn:match-sync";function km(){try{const t=Wt.getState(),n=zt.getState(),s={roomId:t.roomId,players:t.players,currentPlayerIdx:t.currentPlayerIdx,startingScore:t.startingScore,inProgress:t.inProgress,bestLegThisMatch:t.bestLegThisMatch,game:t.game??null,mode:t.mode??null,value:t.value??null};let a={};try{if(typeof localStorage<"u"){const i=localStorage.getItem("ndn:selectedMode");a.selectedMode=i||null}}catch{a={selectedMode:null}}const r={paused:n.paused,pauseEndsAt:n.pauseEndsAt??null,pauseStartedAt:n.pauseStartedAt??null};return{match:s,control:r,ui:a,ts:Date.now()}}catch{return null}}function Nr(){try{const t=km();if(!t)return;localStorage.setItem(Ml,JSON.stringify(t));try{un({type:"snapshot",state:t})}catch{}}catch{}}function yo(){try{const t=localStorage.getItem(Ml);if(!t)return null;const n=JSON.parse(t);return{match:n.match,control:n.control}}catch{return null}}let Ba=null,ts=null;function Em(t,n=500){try{Rl(),ts=t,Ba=window.setInterval(()=>{try{if(!ts||!ts.videoWidth||!ts.videoHeight)return;const s=320,a=Math.round(ts.videoHeight/ts.videoWidth*s)||180,r=document.createElement("canvas");r.width=s,r.height=a;const i=r.getContext("2d");if(!i)return;i.drawImage(ts,0,0,s,a);try{const l=r.toDataURL("image/jpeg",.45);un({type:"cameraFrame",frame:l,ts:Date.now()})}catch{}}catch{}},n)}catch{}}function Rl(){try{Ba&&(clearInterval(Ba),Ba=null),ts=null}catch{}}const Tm=["D1","D2","D3","D4","D5","D6","D7","D8","D9","D10","D11","D12","D13","D14","D15","D16","D17","D18","D19","D20","DB"];function Dm(t){return t==="DB"?50:Number(t.slice(1))*2}function Im(t){return Tm.includes(t)?Dm(t):32}function qf(t,n="D16"){if(t>170||t<=1)return[];const s={170:["T20 T20 DB"],167:["T20 T19 DB"],164:["T20 T18 DB"],161:["T20 T17 DB"],160:["T20 T20 D20"],158:["T20 T20 D19"],157:["T20 T19 D20"],156:["T20 T20 D18"],155:["T20 T19 D19"],154:["T20 T18 D20"],153:["T20 T19 D18"],152:["T20 T20 D16"],151:["T20 T17 D20"],150:["T20 T18 D18"],149:["T20 T19 D16"],148:["T20 T16 D20"],147:["T20 T17 D18"],146:["T20 T18 D16"],145:["T20 T15 D20"],144:["T20 T20 D12"],141:["T20 T19 D12"],140:["T20 T20 D10"],137:["T20 T19 D10"],136:["T20 T20 D8"],132:["BULL T14 D20","T20 T12 D8"],130:["T20 T20 D5","T20 T18 D8"],129:["T19 T16 D12"],128:["T18 T14 D16"],127:["T20 T17 D8"],126:["T19 T19 D6"],121:["T20 11 D20","T20 T15 D8"],120:["T20 20 D20","T20 S20 D20"],110:["T20 10 D20"],100:["T20 D20"],99:["T19 10 D16","T19 S10 D16"],97:["T19 D20"],96:["T20 D18"],95:["T19 D19"],94:["T18 D20"],92:["T20 D16"],90:["T18 D18","T20 D15"],86:["T18 D16"],84:["T20 D12","T16 D18"],82:["BULL D16","T14 D20"],81:["T19 D12"],80:["T20 D10","D20 D20"],78:["T18 D12"],76:["T20 D8","T16 D14"],74:["T14 D16","T18 D10"],72:["T16 D12","T20 D6"],70:["T18 D8","S20 BULL"],68:["T20 D4","T16 D10"],66:["T10 D18","T14 D12"],64:["T16 D8","D16 D16"],62:["T10 D16","T12 D13"],60:["20 D20","S20 D20"],58:["18 D20","S18 D20"],56:["16 D20","S16 D20"],54:["14 D20","S14 D20"],52:["20 D16","S20 D16"],50:["BULL","10 D20"],48:["16 D16","S16 D16"],46:["14 D16"],44:["12 D16"],42:["10 D16"],40:["D20"],38:["D19"],36:["D18"],34:["D17"],32:["D16"],30:["D15"],28:["D14"],26:["D13"],24:["D12"],22:["D11"],20:["D10"],18:["D9"],16:["D8"],14:["D7"],12:["D6"],10:["D5"],8:["D4"],6:["D3"],4:["D2"],2:["D1"]};if(s[t])return s[t];const a=Im(n),r=[];for(const i of[60,57,54,51,48])if(t-i===a){r.push(`T${i/3} ${n}`);break}if(!r.length){for(const i of[20,19,18,17,16,15])if(t-i===a){r.push(`${i} ${n}`);break}}return r}function Mm(t,n,s,a,r){try{const i=window.speechSynthesis;if(!i)return;const l=new SpeechSynthesisUtterance,u=s<=170&&s>0,f=n===180;if(!(!r?.checkoutOnly||u||f))return;if(f){const m=[`${t}... One hundred and eighty!`,`One hundred and EIGHTY! ${t}!`,`${t} with a maximum! One eighty!`];l.text=m[Math.floor(Math.random()*m.length)],l.rate=.95,l.pitch=1.1}else if(s===0){const m=[`Game shot! And the match, ${t}!`,`${t} takes it! Game shot!`,`And that's the checkout! ${t} wins!`];l.text=m[Math.floor(Math.random()*m.length)],l.rate=.9,l.pitch=1.05}else if(u)s<=40?l.text=`${t}... requires ${s}.`:s<=100?l.text=`${t}, you require ${s}.`:l.text=`${t} leaves ${s}.`,l.rate=.92,l.pitch=1;else if(n===0){const m=[`${t}... no score.`,`No score there for ${t}.`,`${t}, unfortunately, no score.`];l.text=m[Math.floor(Math.random()*m.length)],l.rate=.95,l.pitch=.95}else if(n>=140){const m=[`${t}! ${n}!`,`Lovely darts! ${t} with ${n}!`,`${n}! Great scoring from ${t}!`];l.text=m[Math.floor(Math.random()*m.length)],l.rate=.95,l.pitch=1.05}else n>=100?(l.text=`${t}, ${n}.`,l.rate=.95,l.pitch=1):(l.text=`${t}... ${n}.`,l.rate=.95,l.pitch=.98);if(a){const m=i.getVoices().find(p=>p.name===a);m&&(l.voice=m)}typeof r?.volume=="number"?l.volume=Math.max(0,Math.min(1,r.volume)):l.volume=1;try{i.cancel()}catch{}i.speak(l)}catch{}}const Rm={bullOuterRadiusMm:15.9};function Am(t){const n=t.bullOuterRadiusBoardUnits;return!Number.isFinite(n)||n<=0?0:Rm.bullOuterRadiusMm/n}function Pm(t){const{pBoard:n,bullCenter:s={x:0,y:0},mmPerBoardUnit:a,bullInnerRadiusBoardUnits:r,bullOuterRadiusBoardUnits:i}=t,l=(n?.x??0)-(s?.x??0),u=(n?.y??0)-(s?.y??0),f=Math.sqrt(l*l+u*u),c=Math.max(0,f*(Number.isFinite(a)?a:0)),m=f<=r+1e-9,p=f<=i+1e-9;return{distanceMm:c,inInnerBull:m,inOuterBull:p}}const Lm={},Om=4,Fm=250,Js=400,Um=800,_m=1500,Ra=10,Aa=.85,wo=4,$m=3,Bm=900,Vm=6500,Hm=!0,Wm=!1,zm=String(Lm?.VITE_CAMERA_VERBOSE_LOGS??"").trim().toLowerCase()==="1",ls=(...t)=>{zm&&console.log(...t)};function qm(t,n){const s=Math.max(0,Math.min(255,n?.knee)),a=Math.max(0,Math.min(1,n?.strength)),r=t.data;for(let i=0;i<r.length;i+=4){const l=r[i],u=r[i+1],f=r[i+2],c=l*77+u*150+f*29>>8;if(c<=s)continue;const m=c-s,p=m/Math.max(1,255-s),h=c-a*m*p,N=c>0?h/c:1;r[i]=Math.max(0,Math.min(255,Math.round(l*N))),r[i+1]=Math.max(0,Math.min(255,Math.round(u*N))),r[i+2]=Math.max(0,Math.min(255,Math.round(f*N)))}}function jo(t){const{videoW:n,videoH:s,calibW:a,calibH:r,fitMode:i}=t,l=n/a,u=s/r,f=n/s,c=a/r;let m=0,p=0;if(i==="fill"){if(f>c){const h=r*f;m=Math.max(0,(h-a)/2)}else if(f<c){const h=a/f;p=Math.max(0,(h-r)/2)}}else m=0,p=0;return{toCalibration:h=>{const N={x:h.x/l,y:h.y/u};return{x:N.x+m,y:N.y+p}}}}const ii=o.forwardRef(function({onVisitCommitted:n,showToolbar:s=!0,onAutoDart:a,immediateAutoCommit:r=!1,hideInlinePanels:i=!1,scoringMode:l="x01",onGenericDart:u,onGenericReplace:f,x01DoubleInOverride:c,onAddVisit:m,onEndLeg:p,cameraAutoCommit:h="camera",forceAutoStart:N=!1},w){const b=o.useRef(null),g=pe(d=>d.preferredCameraId),y=pe(d=>d.preferredCameraLabel),M=pe(d=>d.autoscoreProvider),L=pe(d=>d.autoscoreWsUrl),S=pe(d=>d.cameraAspect),I=pe(d=>d.cameraFitMode),k=pe(d=>d.cameraScale),T=pe(d=>d.cameraLowLatency)??!1,E=pe(d=>d.cameraProcessingFps)??15,V=pe(d=>d.autoCommitMode)??"wait-for-clear",H=pe(d=>d.confirmUncertainDarts)??!0,$=pe(d=>d.autoScoreConfidenceThreshold)??Aa,ce=pe(d=>d.autoscoreDetectorMinArea)??30,me=pe(d=>d.autoscoreDetectorThresh)??15,xe=pe(d=>d.autoscoreDetectorRequireStableN)??2,we=pe(d=>d.harshLightingMode)??!1,ye=pe(d=>d.enhanceBigTrebles)??!1,De=pe(d=>d.cameraEnabled),Ue=pe(d=>d.preferredCameraLocked),ge=pe(d=>d.hideCameraOverlay);pe(d=>typeof d.cameraRecordDarts=="boolean"?d.cameraRecordDarts:!0);const He=pe(d=>typeof d.cameraShowLabels=="boolean"?d.cameraShowLabels:!1),U=pe(d=>d.callerEnabled),P=pe(d=>d.speakCheckoutOnly),ee=pe(d=>d.callerVoice),X=pe(d=>d.callerVolume),re=pe.getState().setPreferredCamera,se=pe.getState().setCameraEnabled,je=pe.getState().setHideCameraOverlay,le=pe.getState().setCameraScale,Ne=pe.getState().setCameraAspect,Ie=pe.getState().setCameraFitMode;pe(d=>d.preserveCalibrationOverlay);const Se=M==="manual",[Me,G]=o.useState([]),Ce=o.useRef(null),he=o.useRef(null),[Ee,te]=o.useState(!1),[Te,C]=o.useState(!1),[B,A]=o.useState(!1),[W,ae]=o.useState(null),K=vn(),_e=o.useCallback(d=>{b.current=d;try{K.setVideoElementRef?.(d)}catch{}},[K]),Ae=y==="Phone Camera",ut=K.getMediaStream?.()||null,_=K.isStreaming,Y=Ae&&K.mode==="phone"&&_&&!!ut,Q=Ee||_||!1,[de,tt]=o.useState(!1),[ft,yt]=o.useState(()=>typeof document>"u"?!0:!document.hidden);o.useEffect(()=>{if(typeof document>"u")return;const d=()=>yt(!document.hidden);return document.addEventListener("visibilitychange",d),()=>document.removeEventListener("visibilitychange",d)},[]),o.useEffect(()=>{const d=b.current,v=K.getMediaStream?.()||null;if(!(!d||!v))try{d.srcObject||(d.srcObject=v),typeof d.play=="function"&&Promise.resolve(d.play()).catch(()=>{})}catch{}},[K.isStreaming,K.mode,g]),o.useEffect(()=>{if(!De||Ae&&Y)return;const d=!!K.getMediaStream?.();if(!d&&!Ee&&!de)try{xn()}catch{}if(K.isStreaming&&!d&&!de){try{K.setStreaming(!1)}catch{}try{xn()}catch{}}},[De,Ae,Y,Ee,de,g]),o.useEffect(()=>{const d=b.current;if(!d)return;const v=()=>{try{const ne=d.play();ne&&typeof ne.catch=="function"&&ne.catch(()=>{})}catch{}},R=()=>{try{d.videoWidth&&d.videoHeight&&C(!0)}catch{}},J=()=>{try{d.videoWidth&&d.videoHeight&&C(!0)}catch{}};return d.addEventListener("loadedmetadata",v),d.addEventListener("playing",R),d.addEventListener("resize",J),()=>{d.removeEventListener("loadedmetadata",v),d.removeEventListener("playing",R),d.removeEventListener("resize",J)}},[]);const kt=o.useCallback(d=>{const v=b.current,R=K.getMediaStream?.()||null,J=R?R.getVideoTracks():[],ne=R?R.getAudioTracks():[];return{ts:Date.now(),hasVideoEl:!!v,video:{hasSrcObject:!!v?.srcObject,readyState:typeof v?.readyState=="number"?v.readyState:null,paused:typeof v?.paused=="boolean"?v.paused:null,ended:typeof v?.ended=="boolean"?v.ended:null,videoWidth:v?.videoWidth||0,videoHeight:v?.videoHeight||0},stream:{exists:!!R,videoTracks:J.length,audioTracks:ne.length,videoTrackStates:J.map(q=>({enabled:q.enabled,muted:q.muted,readyState:q.readyState}))},session:{mode:K.mode,isStreaming:K.isStreaming},preferredCamera:{id:g,label:y,locked:Ue},error:d?.error??null}},[K,g,y,Ue]);o.useEffect(()=>{if(!B)return;let d=!0;const v=()=>{if(d)try{ae(kt())}catch{}};v();const R=window.setInterval(v,500);return()=>{d=!1,window.clearInterval(R)}},[B,kt]),o.useEffect(()=>{if(N){try{se(!0)}catch{}if(!Ee&&!de)try{xn()}catch{}}},[N,Ee,de,se]),o.useEffect(()=>{try{se(!0)}catch{}if(!Ee&&!de)try{xn()}catch{}},[Ee,de,se]);const{H:lt,imageSize:Je,overlaySize:Hn,theta:yn,sectorOffset:Wn,reset:wn,_hydrated:zn,locked:qn,errorPx:mn}=dn(),Pn=12,Ln=90,qt=typeof mn=="number"?mn:null,x=ra(qt),z=!!lt&&!!Je&&(qn||qt!=null&&qt<=Pn&&x!=null&&x>=Ln);o.useEffect(()=>{Ue&&!ge&&je(!0)},[Ue,ge,je]);const[ie,$e]=o.useState(""),[Fe,it]=o.useState(""),[We,hn]=o.useState(0),[Rt,jn]=o.useState("MISS"),nn=o.useRef(null),Bt=o.useRef({pending:!1,lastSeenTs:0,lastBullDistanceMm:null,lastTipVideoPx:null}),[Be,Nt]=o.useState(0),nt=o.useRef(0),[Xt,At]=o.useState(0),[Ve,pt]=o.useState([]),ze=Wt(d=>d),[Gn,Nn]=o.useState(!1),[fn,rs]=o.useState(!1),D=!!(ze&&ze.roomId),O=D&&Ve.some(d=>d.meta&&d.meta.source==="camera"&&!d.meta.calibrationValid),[F,oe]=o.useState(0),[Ye,Ge]=o.useState(0),[qe,wt]=o.useState(!1),Et=o.useRef(null),St=o.useRef(null),mt=!r&&V!=="immediate",[Tt,xt]=o.useState(0),[Oe,j]=o.useState([]),Z=o.useRef(null),be=o.useRef([]),st=o.useRef(0),Xe=o.useRef(0),ht=o.useRef(!1),ot=o.useRef(null),on=o.useRef(0),Dt=o.useRef({lastTip:null,stableFrames:0}),Vt=o.useRef(0),pn=o.useRef(null),[Rs,ca]=o.useState([]),[ln,hs]=o.useState(!1),[Sn,$l]=o.useState(null),[fs,Bl]=o.useState(null),[If,As]=o.useState("idle"),[Mf,da]=o.useState(null),[Ps,ci]=o.useState(!1),Ut=o.useRef({lastTs:0}),[,Vl]=o.useState(0),di=o.useCallback(d=>{try{Ut.current={...Ut.current,...d,lastTs:Date.now()},Ps&&Vl(v=>(v+1)%1e5);try{window.ndnAutoscoreDiagnostics=Ut.current}catch{}}catch{}},[Ps]);o.useEffect(()=>{const d=v=>{try{if(String(v.key||"").toLowerCase()!=="d"||!(v.shiftKey&&(v.ctrlKey||v.metaKey)))return;v.preventDefault(),ci(J=>!J)}catch{}};return window.addEventListener("keydown",d),()=>window.removeEventListener("keydown",d)},[]);const[Cn,is]=o.useState(null),ui=o.useCallback(d=>{try{if(!H)return!1;if(Cn)return!0;const v=Number(d.confidence);if(!isFinite(v))return!1;const R=Math.max(.5,Math.min(.99,Number($)||Aa));return v>=R?!1:(is({label:d.label,value:d.value,ring:d.ring,confidence:v,meta:d.meta}),!0)}catch{return!1}},[H,Cn,$,is]),qa=o.useRef(!1);o.useEffect(()=>{qa.current=!1},[l]);const ua=o.useCallback(()=>{St.current&&(clearTimeout(St.current),St.current=null)},[]),mi=o.useCallback(d=>typeof d!="number"||Number.isNaN(d)?1:Math.min(1.25,Math.max(.5,Math.round(d*100)/100)),[]),hi=o.useCallback(d=>{if(!le)return;const v=mi((k??1)+d);le(v)},[k,mi,le]),Hl=o.useCallback(()=>{Ie&&Ie("fill"),Ne&&Ne("wide")},[Ie,Ne]),Wl=o.useCallback(()=>{Ie&&Ie("fit"),Ne&&Ne("wide")},[Ie,Ne]);o.useImperativeHandle(w,()=>({runDetectionTick:()=>{try{pn.current&&pn.current()}catch{}},__test_addDart:void 0,__test_commitVisit:void 0,runSelfTest:async()=>{try{return await zl()}catch{return!1}},__test_forceSetPendingVisit:void 0}));const ps=o.useCallback(d=>{try{const R=Ga();R&&(d.frame=R)}catch{}const v=[...be.current.slice(-8),d];be.current=v,ca(v);try{$l(d)}catch{}try{window.ndnCameraDiagnostics=v}catch{}},[]),ma=o.useCallback(()=>{try{const d=window.AudioContext||window.webkitAudioContext;if(!d)return;const v=new d,R=v.createOscillator(),J=v.createGain();R.type="sine",R.frequency.value=1e3,J.gain.value=.0015,R.connect(J),J.connect(v.destination),R.start(),setTimeout(()=>{try{R.stop(),v.close?.()}catch{}},120)}catch{}},[]),zl=o.useCallback(async()=>{try{As("running"),da(null),be.current=[],ca([]);const d=6;for(let J=0;J<d;J++){try{pn.current&&pn.current()}catch{}await new Promise(ne=>setTimeout(ne,180))}const v=be.current.slice();v.some(J=>J.accepted||J.ready&&J.confidence>=($??Aa))?(As("pass"),da("Detection OK")):(As("fail"),da(v.length?`No accepted detections (best confidence ${(v[v.length-1].confidence||0).toFixed(2)})`:"No detections"))}catch{As("fail"),da("Self-test error")}finally{setTimeout(()=>As("idle"),3e3)}},[$]),Ga=o.useCallback(()=>{try{const d=b.current;if(!d||!d.videoWidth||!d.videoHeight)return null;const v=640,R=Math.round(d.videoHeight/d.videoWidth*v)||360,J=document.createElement("canvas");J.width=v,J.height=R;const ne=J.getContext("2d");return ne?(ne.drawImage(d,0,0,v,R),J.toDataURL("image/jpeg",.5)):null}catch{return null}},[]),On=o.useCallback(d=>{const v=Et.current;if(v){Et.current=null,ua(),wt(!1);try{const R=v.meta?.entries,J=R?.[R.length-1]?.meta?.bullDistanceMm;nr(J)}catch{}try{sr(v.score)}catch{}if(n)try{n(v.score,v.darts,v.finished,v.meta);try{un({type:"visit",score:v.score,darts:v.darts,finished:v.finished,meta:v.meta,playerIdx:ze.currentPlayerIdx,ts:Date.now()});try{Nr()}catch{}try{const R=Ga();Bl({ts:Date.now(),score:v.score,darts:v.darts,frame:R})}catch{}}catch{}}catch{}}},[n,ua]),Yn=o.useCallback(d=>{if(n){if(!mt){try{const v=d.meta?.entries,R=v?.[v.length-1]?.meta?.bullDistanceMm;nr(R)}catch{}try{sr(d.score)}catch{}try{n(d.score,d.darts,d.finished,d.meta)}catch{}return}Et.current=d,wt(!0),ua(),St.current=window.setTimeout(()=>On("timeout"),Vm)}},[n,mt,ua,On,nr,sr]),ha=o.useCallback(d=>{Nt(0),nt.current=0,At(0),pt([]),oe(0),Ge(0),Pt(!1);try{window.dispatchEvent(new CustomEvent("ndn:clear-visit-request",{detail:{source:"camera-view",reason:d,ts:Date.now()}}))}catch{}},[]);o.useEffect(()=>{if(!mt)return;const d=()=>On("event");return window.addEventListener("ndn:darts-cleared",d),()=>window.removeEventListener("ndn:darts-cleared",d)},[mt,On]),o.useEffect(()=>{mt||On("timeout")},[mt,On]),o.useEffect(()=>()=>On("teardown"),[On]);const ql=o.useCallback(()=>{ha("indicator"),xt(d=>d+1)},[ha]),Gl=o.useCallback(()=>{Be===0&&Xt===0||(ha("toolbar"),xt(d=>d+1))},[ha,Be,Xt]),Yl=o.useCallback(()=>{if(!Se)try{window.dispatchEvent(new CustomEvent("ndn:open-camera-manager",{detail:{source:"camera-view",ts:Date.now()}}))}catch(d){console.warn("[CameraView] Failed to request camera manager:",d)}},[Se]),Jl=pe(d=>d.x01DoubleIn),xs=typeof c=="boolean"?!!c:!!Jl,[Xl,fi]=o.useState({}),fa=ze.players[ze.currentPlayerIdx]?.id,bs=!!(fa&&Xl[fa]),pi=d=>{fa&&fi(v=>({...v,[fa]:d}))},Ya=ze?.inProgress,xi=Jt(d=>d.setVisit),bi=Jt(d=>d.reset);o.useEffect(()=>{try{xi(Ve,Be,Xt);try{const d={type:"pendingVisit",entries:Ve,darts:Be,total:Xt,playerIdx:ze.currentPlayerIdx,ts:Date.now()};try{const v=b.current;if(v&&v.videoWidth&&v.videoHeight){const J=Math.round(v.videoHeight/v.videoWidth*320)||180,ne=document.createElement("canvas");ne.width=320,ne.height=J;const q=ne.getContext("2d");if(q){q.drawImage(v,0,0,320,J);try{d.frame=ne.toDataURL("image/jpeg",.45)}catch{}}}}catch{}un(d)}catch{}}catch{}},[Ve,Be,Xt,xi]),o.useEffect(()=>()=>{try{bi()}catch{}},[bi]);const Kl=Wt(d=>d.addVisit),Ql=Wt(d=>d.endLeg),Ls=o.useCallback(d=>{try{return Array.isArray(d)?d.slice(0,3).map(v=>({label:String(v?.label??""),value:Number(v?.value??0),ring:String(v?.ring??"")})):void 0}catch{return}},[]),Jn=(d,v,R)=>{try{Le("CameraView: callAddVisit",d,v,R),m?m(d,v,R):Kl(d,v,R);try{un({type:"visit",score:d,darts:v,playerIdx:ze.currentPlayerIdx,ts:Date.now()});try{Nr()}catch{}}catch{}}catch{}},gi=d=>{try{p?p(d):Ql(typeof d=="number"?d:0)}catch{}},Ja=Nm(d=>d.addSample),[pa,Zl]=o.useState(""),[xa,ec]=o.useState(""),[kn,It]=o.useState(0),[tc,cn]=o.useState(!1),[Xn,Pt]=o.useState(!1),[Rf,vi]=o.useState(!1),[yi,Fn]=o.useState("auto"),[Xa,Un]=o.useState(!1),[nc,ba]=o.useState(!1),[sc,wi]=o.useState(!1),ji=o.useRef(null),Os=pe(d=>d.dartTimerEnabled),Ka=pe(d=>d.dartTimerSeconds)||10,[gs,Qa]=o.useState(null),En=o.useRef(null),vs=zt(d=>d.paused),_n=o.useRef(null),Kn=o.useRef(null),Ni=o.useRef(0),Si=o.useRef(null),Ci=o.useRef(0),ga=o.useRef(null),va=o.useRef(0),Za=o.useRef(!1),ys=o.useRef(null),[ki,Ei]=o.useState(0),Fs=o.useCallback(()=>{try{window.dispatchEvent(new CustomEvent("ndn:phone-camera-reconnect",{detail:{source:"camera-view",ts:Date.now()}}))}catch(d){console.warn("[CameraView] Phone camera reconnect dispatch failed:",d)}},[]);o.useEffect(()=>{const d=()=>{Se||ba(!0)};return window.addEventListener("ndn:open-autoscore",d),()=>window.removeEventListener("ndn:open-autoscore",d)},[Se]),o.useEffect(()=>()=>{try{ys.current&&clearTimeout(ys.current)}catch{}},[]),o.useEffect(()=>{const d=()=>wi(!0);return window.addEventListener("ndn:open-scoring",d),()=>window.removeEventListener("ndn:open-scoring",d)},[]),o.useEffect(()=>{const d=()=>{xt(v=>v+1),Nt(0),nt.current=0,At(0),pt([]),oe(0),Ge(0),Pt(!1)};return window.addEventListener("ndn:darts-cleared",d),()=>window.removeEventListener("ndn:darts-cleared",d)},[]),o.useEffect(()=>{j(d=>{if(Ve.length>d.length){const v=Ve.length-d.length;return[...d,...Array(v).fill(Tt)]}return Ve.length<d.length?d.slice(0,Ve.length):d})},[Ve,Tt]),o.useEffect(()=>{if(ot.current&&(clearTimeout(ot.current),ot.current=null),Se){ht.current=!1,Xe.current=0,Z.current=null;return}return Q?(Xe.current=performance.now(),Z.current=null,ht.current=!1,Vt.current=0,ot.current=window.setTimeout(()=>{ht.current=!0,ot.current=null},_m)):(Xe.current=0,Z.current=null,ht.current=!1,Vt.current=0),()=>{ot.current&&(clearTimeout(ot.current),ot.current=null),ht.current=!1,Vt.current=0,pn.current=null}},[Q,Se]),o.useEffect(()=>{let d=!0;async function v(){try{if(!navigator?.mediaDevices?.enumerateDevices)return;const R=await navigator.mediaDevices.enumerateDevices();if(!d)return;G(R.filter(J=>J.kind==="videoinput"))}catch(R){console.warn("[CAMERA] enumerateDevices failed:",R)}}v();try{navigator.mediaDevices.addEventListener("devicechange",v)}catch{try{navigator.mediaDevices.ondevicechange=v}catch{}}return()=>{d=!1;try{navigator.mediaDevices.removeEventListener("devicechange",v)}catch{}}},[]),o.useEffect(()=>{const d=()=>{Fn("manual"),Un(!0)},v=()=>{Fn("auto"),Un(!1)};return window.addEventListener("ndn:open-manual",d),window.addEventListener("ndn:close-manual",v),()=>{window.removeEventListener("ndn:open-manual",d),window.removeEventListener("ndn:close-manual",v)}},[]),o.useEffect(()=>{Se&&(Fn("manual"),ba(!1))},[Se]),o.useEffect(()=>{try{const d=ze.players[ze.currentPlayerIdx],v=d?.legs?.[d.legs.length-1];if(!d)return;(!v||v.dartsThrown===0)&&fi(R=>({...R,[d.id]:!1}))}catch{}},[ze.currentPlayerIdx,ze.players?.[ze.currentPlayerIdx]?.legs?.length]),o.useEffect(()=>{const d=!!Os&&Ya&&!vs&&Be<3;if(En.current&&(clearInterval(En.current),En.current=null),!d){Qa(null);return}return Qa(Ka),En.current=window.setInterval(()=>{Qa(v=>{const R=(v??Ka)-1;if(R<=0){try{const J=nt.current||0,ne=Math.max(0,3-J);for(let q=0;q<ne;q++)sn(0,"MISS 0","MISS")}catch{}return En.current&&(clearInterval(En.current),En.current=null),0}return R})},1e3),()=>{En.current&&(clearInterval(En.current),En.current=null)}},[Os,Ka,Be,ze.currentPlayerIdx,ze?.inProgress,vs]),o.useEffect(()=>{if(!Xa)return;const d=setInterval(()=>{try{const v=b.current,R=ji.current;if(!v||!R)return;const J=v.videoWidth||0,ne=v.videoHeight||0;if(!J||!ne)return;const q=R.clientWidth||640,ve=R.clientHeight||360,ke=Math.max(1,Math.round((window.devicePixelRatio||1)*100)/100),fe=Math.floor(q*ke),et=Math.floor(ve*ke);R.width!==fe&&(R.width=fe),R.height!==et&&(R.height=et);const ue=R.getContext("2d");if(!ue)return;ue.imageSmoothingEnabled=!0;try{ue.setTransform(ke,0,0,ke,0,0)}catch{}const at=Math.min(q/J,ve/ne),$t=Math.round(J*at),Ke=Math.round(ne*at),Ze=Math.floor((q-$t)/2),Kt=Math.floor((ve-Ke)/2);ue.fillStyle="#000",ue.fillRect(0,0,q,ve),ue.drawImage(v,Ze,Kt,$t,Ke)}catch(v){console.warn("Manual preview update error:",v)}},120);return()=>clearInterval(d)},[Xa]),o.useEffect(()=>()=>{},[]);const Ti=Ae&&!Y;async function xn(){const d=K.getMediaStream?.()||(b.current?.srcObject??null),v=(()=>{try{const J=d;if(!J)return!1;const ne=J.getVideoTracks;return typeof ne!="function"?!1:!!ne.call(J)?.length}catch{return!1}})();if(de||Ee&&v)return;if(Ae&&Y&&(d?.getVideoTracks?.()||[]).some(q=>q.readyState==="live")){tt(!1);return}tt(!0);try{os(null)}catch{}const R=async J=>{if(!J||J.kind!=="video"||!(we||typeof window<"u"&&window.localStorage?.getItem("ndn.glareClamp")==="1"))return;const q=J.getCapabilities?.()||{},ve=fe=>fe in q,ke={...ve("exposureMode")?{exposureMode:"continuous"}:{},...ve("whiteBalanceMode")?{whiteBalanceMode:"continuous"}:{},...ve("focusMode")?{focusMode:"continuous"}:{},...ve("sharpness")?{sharpness:q.sharpness?.max}:{},...ve("contrast")?{contrast:q.contrast?.max}:{},...ve("backlightCompensation")?{backlightCompensation:!1}:{}};if(Object.keys(ke).length)try{await J.applyConstraints(ke),Le("[CAMERA] Applied anti-glare track constraints:",ke)}catch(fe){console.warn("[CAMERA] Anti-glare track constraints not supported:",fe)}};try{const J={width:{ideal:3840},height:{ideal:2160},frameRate:{ideal:30}},ne={width:{ideal:2560},height:{ideal:1440},frameRate:{ideal:30}},q={width:{ideal:1920},height:{ideal:1080},frameRate:{ideal:30}},ve={width:{ideal:1280},height:{ideal:720},frameRate:{ideal:30}},ke=g?{deviceId:{exact:g}}:{facingMode:"environment"},fe=async(ue,at)=>{const $t={video:{...ke,...ue},audio:!1};return Le(`[CAMERA] Using constraints (${at}):`,$t),navigator.mediaDevices.getUserMedia($t)};let et;try{if(T)try{et=await fe(ve,"720p")}catch(ue){console.warn("[CAMERA] 720p request failed, falling back:",ue);try{et=await fe(q,"1080p")}catch(at){console.warn("[CAMERA] 1080p failed, trying 1440p:",at),et=await fe(ne,"1440p")}}else try{et=await fe(J,"4k")}catch(ue){console.warn("[CAMERA] 4K request failed, trying 1440p:",ue);try{et=await fe(ne,"1440p")}catch(at){console.warn("[CAMERA] 1440p request failed, trying 1080p:",at),et=await fe(q,"1080p")}}Le("[CAMERA] Got stream:",!!et)}catch(ue){console.warn("[CAMERA] First attempt failed:",ue);const at=ue&&(ue.name||ue.code)||"";if(g&&(at==="OverconstrainedError"||at==="NotFoundError"))Le("[CAMERA] Trying fallback without deviceId"),et=await navigator.mediaDevices.getUserMedia({video:{...ne},audio:!1});else if(!g&&(at==="OverconstrainedError"||at==="NotFoundError"||at==="NotSupportedError"))Le("[CAMERA] Trying fallback for facingMode not supported"),et=await navigator.mediaDevices.getUserMedia({video:{...ne},audio:!1});else throw ue}if(b.current){Le("[CAMERA] Setting stream to video element"),b.current.srcObject=et;try{const ue=et?.getVideoTracks?.()?.[0];await R(ue)}catch{}try{await b.current.play()}catch{}Le("[CAMERA] Stream tracks:",et.getTracks().length,"video tracks:",et.getVideoTracks().length),b.current.addEventListener("loadeddata",()=>Le("[CAMERA] Video loadeddata")),b.current.addEventListener("loadedmetadata",()=>{Le("[CAMERA] Video loadedmetadata - dimensions available"),b.current?.videoWidth&&b.current?.videoHeight&&C(!0)}),b.current.addEventListener("canplay",()=>{Le("[CAMERA] Video canplay"),b.current?.videoWidth&&b.current?.videoHeight&&C(!0)}),b.current.addEventListener("play",()=>Le("[CAMERA] Video started playing")),b.current.addEventListener("error",ue=>console.error("[CAMERA] Video error:",ue)),Promise.resolve(b.current.play()).then(()=>Le("[CAMERA] Play called successfully")).catch(ue=>{console.error("[CAMERA] Video play failed:",ue),setTimeout(()=>{Promise.resolve(b.current?.play()).catch(at=>{console.error("[CAMERA] Retry play failed:",at)})},100)});try{K.setVideoElementRef?.(b.current),K.setMediaStream?.(et),K.setMode?.("local"),K.setStreaming?.(!0)}catch(ue){console.warn("[CAMERA] Failed to sync camera session with local stream:",ue)}if(Ae)try{K.setMediaStream?.(et),K.setVideoElementRef?.(b.current)}catch{}}else console.error("[CAMERA] Video element not found");te(!0);try{os(null)}catch{}try{const ue=await navigator.mediaDevices.enumerateDevices();G(ue.filter(at=>at.kind==="videoinput")),Le("[CAMERA] Found cameras:",ue.filter(at=>at.kind==="videoinput").length)}catch(ue){console.warn("[CAMERA] Failed to enumerate devices:",ue)}}catch(J){console.error("[CAMERA] Camera start failed:",J);const ne=J?.name||J?.code||"";os(ne==="NotAllowedError"||ne==="SecurityError"?"permission-denied":ne==="NotFoundError"||ne==="OverconstrainedError"?"not-found":ne==="NotSupportedError"?"not-supported":"unknown")}finally{tt(!1)}}function ya(){try{const d=K.getMediaStream?.()||null;d&&d.getTracks().forEach(v=>v.stop())}catch{}if(b.current)try{b.current.srcObject=null}catch{}try{K.setMediaStream?.(null),K.setStreaming?.(!1),K.setVideoElementRef?.(null)}catch{}te(!1),tt(!1)}o.useEffect(()=>{const d=b.current;if(!d)return;const v=K.getMediaStream?.()||null,J=(K.getVideoElementRef?.()||null)?.srcObject||null,ne=v||J;if(ne){d.srcObject!==ne&&(d.srcObject=ne),d.muted=!0,d.playsInline=!0;try{Promise.resolve(d.play()).catch(()=>{})}catch{}Ee||te(!0)}},[K.mode,K.isStreaming,Ee,K]);const[wa,os]=o.useState(null);o.useEffect(()=>{if(B)try{ae(kt({error:wa}))}catch{}},[B,wa,kt]);async function Di(){try{if(!navigator?.mediaDevices?.enumerateDevices){os("not-supported");return}const d=await navigator.mediaDevices.enumerateDevices();G(d.filter(v=>v.kind==="videoinput"))}catch(d){console.warn("[CAMERA] enumerateDevices failed:",d)}}function Ii(){const[d,v]=o.useState(!1),[R,J]=o.useState(""),ne=async q=>{if(de)return;const ve=Me.find(ke=>ke.deviceId===q)?.label;re(q||void 0,ve||"",!0),ya(),await new Promise(ke=>setTimeout(ke,150));try{await xn()}catch{}};return e.jsxs("div",{className:"camera-selector absolute top-2 right-2 z-20 flex items-center gap-2 bg-black/40 rounded px-2 py-1 text-xs",children:[e.jsx("span",{children:"Cam:"}),e.jsxs("select",{onPointerDown:q=>{q.stopPropagation()},onMouseDown:q=>{q.stopPropagation()},onTouchStart:q=>{q.stopPropagation?.()},className:"bg-black/20 rounded px-1 py-0.5",value:g||"",onChange:async q=>{if(de)return;const ve=q.target.value||void 0,ke=Me.find(fe=>fe.deviceId===ve)?.label;re(ve,ke||"",!0),ya(),await new Promise(fe=>setTimeout(fe,150));try{await xn()}catch(fe){console.warn("Failed to start camera after device switch:",fe),setTimeout(async()=>{try{await xn()}catch(et){console.error("Camera switch failed after retry:",et),alert("Failed to switch camera. Please try again or refresh the page.")}},500)}},children:[e.jsx("option",{value:"",children:"Auto"}),e.jsx("option",{value:"manual",children:"~ Enter device ID ..."}),Me.map(q=>e.jsx("option",{value:q.deviceId,children:q.label||(q.deviceId?`Camera (${q.deviceId.slice(0,6)})`:"Camera")},q.deviceId))]}),g==="manual"&&e.jsxs("div",{className:"flex items-center gap-2 ml-2",children:[e.jsx("input",{className:"input input--small",placeholder:"Device ID",value:R,onChange:q=>J(q.target.value)}),e.jsx("button",{className:"btn btn--ghost btn-sm",onClick:()=>ne(R||void 0),children:"Apply"})]}),Me.length===0&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-xs text-yellow-300",children:"No cameras found"}),e.jsx("button",{className:"btn btn--ghost btn-sm ml-2",onClick:Di,title:"Refresh camera list",children:"Refresh"})]}),wa==="permission-denied"&&e.jsx("div",{className:"ml-2 text-xs text-rose-300",children:"Camera permission denied. Allow camera access in your browser site settings, then click Rescan."}),e.jsx("button",{className:"btn btn--ghost btn-sm ml-2",onClick:async()=>{try{await Di()}catch(q){console.warn("Rescan failed:",q)}},title:"Rescan connected cameras",children:"Rescan"}),e.jsx("button",{className:"btn btn--ghost btn-sm ml-2",onClick:()=>{A(q=>!q);try{B||ae(kt({error:wa}))}catch{}},title:"Show video diagnostics",children:B?"Hide diag":"Diag"}),e.jsx("div",{className:"flex items-center gap-2 ml-2",children:e.jsx("button",{className:"btn btn--ghost btn-sm",onClick:()=>{v(q=>!q),d||(async()=>{try{const q=await navigator.mediaDevices.enumerateDevices();G(q.filter(ve=>ve.kind==="videoinput"))}catch{}})()},children:d?"Hide devices":"Show devices"})}),d&&e.jsxs("div",{className:"mt-2 space-y-1 ml-1 text-xs",children:[e.jsx("div",{className:"opacity-60 text-xxs mb-1",children:"If you don't see your virtual camera (e.g., OBS), ensure the virtual camera is enabled and your browser has camera permission. Click Rescan after enabling."}),Me.map(q=>{const ve=String(q.label||"").toLowerCase().includes("obs")||String(q.label||"").toLowerCase().includes("virtual");return e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"truncate",children:[q.label||"Unnamed device"," ",ve&&e.jsx("span",{className:"text-xs opacity-60 ml-1",children:"(OBS)"})]}),e.jsx("div",{className:"opacity-60 ml-1",children:q.deviceId}),e.jsx("button",{className:"btn btn--ghost btn-xs ml-2",onClick:()=>ne(q.deviceId),children:"Select"})]},q.deviceId)})]}),B&&e.jsxs("div",{className:"mt-2 ml-1 text-xs rounded-lg border border-white/10 bg-black/30 p-2",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("div",{className:"font-semibold",children:"Video diagnostics"}),e.jsx("div",{className:"opacity-60 text-xxs",children:W?.ts?new Date(W.ts).toLocaleTimeString():""})]}),e.jsxs("div",{className:"mt-1 grid grid-cols-2 gap-x-3 gap-y-1",children:[e.jsx("div",{className:"opacity-70",children:"preferred"}),e.jsxs("div",{className:"break-all",children:[y||"(none)"," ",g?`(${g})`:""]}),e.jsx("div",{className:"opacity-70",children:"session"}),e.jsxs("div",{children:["mode=",String(W?.session?.mode??"?")," stream=",String(W?.session?.isStreaming??"?")]}),e.jsx("div",{className:"opacity-70",children:"video el"}),e.jsxs("div",{children:["srcObject=",String(W?.video?.hasSrcObject??!1)," rs=",String(W?.video?.readyState??"?")," paused=",String(W?.video?.paused??"?")]}),e.jsx("div",{className:"opacity-70",children:"dimensions"}),e.jsxs("div",{children:[W?.video?.videoWidth??0,"Ã—",W?.video?.videoHeight??0]}),e.jsx("div",{className:"opacity-70",children:"tracks"}),e.jsxs("div",{children:["v=",W?.stream?.videoTracks??0," a=",W?.stream?.audioTracks??0]})]}),W?.stream?.videoTrackStates?.length?e.jsxs("div",{className:"mt-2",children:[e.jsx("div",{className:"opacity-70",children:"video track state"}),e.jsx("div",{className:"mt-1 space-y-1",children:W.stream.videoTrackStates.map((q,ve)=>e.jsxs("div",{className:"text-xxs opacity-90",children:["#",ve," ready=",q.readyState," enabled=",String(q.enabled),typeof q.muted=="boolean"?` muted=${String(q.muted)}`:""]},ve))})]}):null,W?.error?e.jsxs("div",{className:"mt-2 text-xxs text-rose-200",children:["cameraAccessError=",String(W.error)]}):null,e.jsx("div",{className:"mt-2 text-xxs opacity-60",children:"If dims stay 0Ã—0 but tracks>0, the video element isn't receiving frames (often a virtual cam / autoplay / stream ownership issue). If tracks=0, getUserMedia succeeded but no video track is being delivered."})]})]})}o.useEffect(()=>{},[lt,Je,Q,Se,Ae,Ue,ge,ft]),o.useEffect(()=>{if(ls("[DETECTION] Effect running",{manualOnly:Se,autoscoreProvider:M,videoReady:Te,hasH:!!lt,hasImageSize:!!Je,hasVideoRef:!!b.current,videoWidth:b.current?.videoWidth,videoHeight:b.current?.videoHeight}),!ft)return;if(Se){ls("[DETECTION] Exiting: TEST_MODE or manualOnly");return}if(M!=="built-in"&&M!=="built-in-v2"){ls("[DETECTION] Exiting: autoscoreProvider is",M);return}const d=vn.getState(),v=pe.getState().preferredCameraLabel,R=v==="Phone Camera",J=d.getVideoElementRef?.()||null,ne=d.getMediaStream?.()||null,q=!!d.isStreaming,ve=b.current;let fe=!!(J&&J.videoWidth>0&&J.videoHeight>0)?J:ve;!fe&&J&&(fe=J);try{q&&ne&&fe&&!fe.srcObject&&(fe.srcObject=ne,typeof fe.play=="function"&&Promise.resolve(fe.play()).catch(()=>{}))}catch{}if(!fe){ls("[DETECTION] Exiting: no sourceVideo",{preferredLabel:v,isPhone:R,phoneFeedActive:Y,sessionStreaming:q,cameraSessionMode:d?.mode,hasSessionVideo:!!J,hasLocalVideo:!!b.current});return}if(!fe.videoWidth||!fe.videoHeight){const vt=performance.now();let rt=!1;const jt=()=>{if(rt)return;const Tn=fe?.videoWidth||0,Dn=fe?.videoHeight||0;if(Tn&&Dn){try{C(!0)}catch{}return}if(performance.now()-vt>2e3){ls("[DETECTION] Exiting: video has no dimensions yet (after retries)",{vw:Tn,vh:Dn,preferredLabel:v,hasSrcObject:!!fe?.srcObject,readyState:fe?.readyState});return}window.setTimeout(jt,120)};return window.setTimeout(jt,60),()=>{rt=!0}}if(!Te)try{C(!0)}catch{}if(!lt||!Je){ls("[DETECTION] Exiting: no H or imageSize",{hasH:!!lt,hasImageSize:!!Je,hydrated:zn});return}ls("[DETECTION] âœ… All conditions met, starting detection loop!");let et=!1;const ue=fe,at=ue.videoWidth||0,$t=ue.videoHeight||0,Ke=Ce.current;if(!Ke)return;const Ze=_n._sizeRef||(_n._sizeRef={w:0,h:0});if(!_n.current||at>0&&$t>0&&(Ze.w!==at||Ze.h!==$t)){let vt=ce,rt=me,jt=xe,Tn=70;const Dn=at*$t;at>0&&$t>0&&Dn<1280*720&&(vt=Math.min(vt,20),rt=Math.min(rt,14),jt=Math.min(jt,2)),at>0&&$t>0&&Dn>=1920*1080&&(Tn=82,jt=Math.max(jt,2)),_n.current=new ym({minArea:vt,thresh:rt,requireStableN:jt,angMaxDeg:Tn}),Ze.w=at,Ze.h=$t}const Lt=()=>{try{const rt=performance.now(),jt=1e3/(E||15);if(rt-Ni.current<jt){Kn.current=requestAnimationFrame(Lt),pn.current=Lt;return}Ni.current=rt}catch{}let vt=!1;if(!et){try{const rt=ue.videoWidth||0,jt=ue.videoHeight||0;if(!rt||!jt){Kn.current=requestAnimationFrame(Lt);return}Ke.width!==rt&&(Ke.width=rt),Ke.height!==jt&&(Ke.height=jt);const Tn=Ke.getContext("2d",{willReadFrequently:!0});if(!Tn){Kn.current=requestAnimationFrame(Lt);return}Tn.drawImage(ue,0,0,rt,jt);const Dn=Tn.getImageData(0,0,rt,jt);(we||typeof window<"u"&&window.localStorage?.getItem("ndn.glareClamp")==="1")&&qm(Dn,{knee:212,strength:.72}),Vt.current++;const Fi=as(lt,{x:0,y:0}),Ui=as(lt,{x:gt.doubleOuter,y:0}),dc=I==="fill"?"fill":"fit",uc=jo({videoW:rt,videoH:jt,calibW:Je.w,calibH:Je.h,fitMode:dc}),_i=rt/Je.w,$i=jt/Je.h,Bi=Fi.x*_i,Vi=Fi.y*$i,mc=Ui.x*_i,hc=Ui.y*$i,fc=Math.hypot(mc-Bi,hc-Vi)*1.08,ar=_n.current;ki>=0&&ar.setROI(Bi,Vi,Math.max(24,Math.min(Math.max(rt,jt),fc)));{const Ct=!vs,Ot=Be<3,Sa=ht.current,Ht=Vt.current>Ra;Le("CameraView: detection conditions",{condPaused:Ct,condPending:Ot,condArmed:Sa,condFrame:Ht,frameCount:Vt.current,minFrames:Ra})}if(!vs&&Be<3&&ht.current&&Vt.current>Ra){Le("CameraView: entering detection branch",{paused:vs,pendingDarts:Be,detectionArmed:ht.current,frameCount:Vt.current,DETECTION_MIN_FRAMES:Ra});const Ct=ar.detect(Dn);Le("CameraView: raw detection",Ct);const Ot=performance.now();try{const _s=Bt.current.pending&&!Ct,Mt=Ot-Bt.current.lastSeenTs;if(_s&&Mt>40&&Mt<900){Bt.current.pending=!1,Z.current=null,Pt(!1);const Ft=Bt.current.lastBullDistanceMm,ct=Bt.current.lastTipVideoPx;try{a&&a(0,"MISS",{sector:null,mult:0,calibrationValid:!0,pBoard:null,bullDistanceMm:typeof Ft=="number"?Ft:void 0,tipVideoPx:ct??void 0,bounceout:!0})}catch{}try{ps({ts:Ot,label:"BOUNCEOUT",value:0,ring:"MISS",confidence:0,ready:!1,accepted:!1,warmup:!1})}catch{}}}catch{}try{const Ht=Dt.current.stableFrames>=wo;!!Ct!==Ht&&(on.current=Ot)}catch{}Z.current&&Ot-Z.current.firstTs>900&&(Z.current=null);const Sa=Math.max(.5,Math.min(.99,Number($)||Aa));if(Ct&&H&&Ct.confidence>0&&Ct.confidence<Sa){if(!Cn){const Ht=Or(Ke,Ct.tip,6),_s=I==="fill"?"fill":"fit",Ft=jo({videoW:rt,videoH:jt,calibW:Je.w,calibH:Je.h,fitMode:_s}).toCalibration({x:Ht.x,y:Ht.y}),ct=jr(lt,Ft,yn??0,Wn??0);let bt=null;try{bt=Ms(lt,Ft)}catch{bt=null}const Gt=ct.ring,Qt=ct.base,$s=ct.sector??null,Bs=Math.max(0,Number(ct.mult)||0);let _t="";Gt==="MISS"?_t="MISS":Gt==="BULL"?_t="BULL 25":Gt==="INNER_BULL"?_t="INNER_BULL 50":$s!=null?_t=`${Bs===3?"T":Bs===2?"D":"S"}${$s} ${Qt}`:_t=`${Gt} ${Qt>0?Qt:""}`.trim();const Zt=!!lt&&!!Je&&z;is({label:_t,value:Qt,ring:Gt,confidence:Ct.confidence,meta:{calibrationValid:Zt,pBoard:bt,source:"camera"}}),ps({ts:Date.now(),label:_t,value:Qt,ring:Gt,confidence:Ct.confidence,ready:!1,accepted:!1,warmup:!1,rejectReason:"below-confidence",pCal:Ft,tip:Ht})}return}if(Ct&&Ct.confidence>=Sa){Le("CameraView: detected raw",Ct.confidence,Ct.tip),Le("CameraView: detected raw",Ct.confidence,Ct.tip);const Ht=Xe.current>0&&Ot-Xe.current<Um,_s=!1,Mt=Or(Ke,Ct.tip,6);let Ft="",ct=0,bt="MISS",Gt=!1,Qt=null;try{const Re=Dt.current.lastTip;Re?Math.hypot(Mt.x-Re.x,Mt.y-Re.y)<=$m?Dt.current={lastTip:{...Mt},stableFrames:Dt.current.stableFrames+1}:(Dt.current={lastTip:{...Mt},stableFrames:1},on.current=Ot):Dt.current={lastTip:{...Mt},stableFrames:1}}catch{}const $s=Ot-on.current>=Bm,Bs=Dt.current.stableFrames>=wo,_t=uc.toCalibration({x:Mt.x,y:Mt.y}),In=jr(lt,_t,yn??0,Wn??0);let Zt=null;try{Zt=Ms(lt,_t)}catch{Zt=null}bt=In.ring,ct=In.base;const Qn=In.sector??null,ws=Math.max(0,Number(In.mult)||0);bt==="MISS"?Ft="MISS":bt==="BULL"?Ft="BULL 25":bt==="INNER_BULL"?Ft="INNER_BULL 50":Qn!=null?Ft=`${ws===3?"T":ws===2?"D":"S"}${Qn} ${ct}`:Ft=`${bt} ${ct>0?ct:""}`.trim();const Ca=3,ka=3,$n=!!lt&&!!Je&&z,Vs=Mt.x>=-Ca&&Mt.x<=rt+Ca&&Mt.y>=-Ca&&Mt.y<=jt+Ca,Hs=Je?_t.x>=-ka&&_t.x<=Je.w+ka&&_t.y>=-ka&&_t.y<=Je.h+ka:!1;let Ea=!1;Zt&&(Ea=Math.hypot(Zt.x,Zt.y)<=gt.doubleOuter+3);const rr=!$n||!Vs||!Hs||!Ea||Ht,Pf=!1;if(a)try{const Re=Am({bullOuterRadiusBoardUnits:gt.bullOuter}),Yt=Zt?Pm({pBoard:Zt,bullCenter:{x:0,y:0},mmPerBoardUnit:Re,bullInnerRadiusBoardUnits:gt.bullInner,bullOuterRadiusBoardUnits:gt.bullOuter}):null;try{!rr&&bt!=="MISS"&&(Bt.current.pending=!0,Bt.current.lastSeenTs=Ot,Bt.current.lastBullDistanceMm=typeof Yt?.distanceMm=="number"?Yt.distanceMm:null,Bt.current.lastTipVideoPx=Mt)}catch{}const bn=`${In.base}|${In.ring}|${In.mult}`,en=performance.now();bn===ga.current&&en-va.current<Js||a(In.base,In.ring,{sector:Qn,mult:ws,calibrationValid:!!$n,pBoard:Zt,tipVideoPx:Mt,bullDistanceMm:Yt?.distanceMm})===!0&&(ga.current=bn,va.current=en)}catch{}Le("CameraView: detection details",{value:ct,ring:bt,calibrationGood:$n,tipInVideo:Vs,pCalInImage:Hs,isGhost:rr});try{di({lastTip:Mt??null,lastPcal:_t??null,lastPboard:Zt??null,lastConfidence:be.current[be.current.length-1]?.confidence??null,lastLabel:Ft??null,lastValue:ct??null,lastRing:bt??null,lastReject:$n?Vs?Hs?Ea?Ht?"warmup":null:"off-board":"pCal-outside-image":"tip-outside-video":"calibration-invalid"})}catch{}$e(Ft),hn(ct),jn(bt);try{if(ye&&bt==="TRIPLE"&&(ct===20||ct===19||ct===18)){const Re={value:ct,until:performance.now()+900};nn.current=Re}}catch{}const pc=async Re=>{if(Le("CameraView: applyAutoHit",Re.value,Re.ring,Re.sector),Le("CameraView: applyAutoHit",Re.value,Re.ring,Re.sector),!$n){Le("CameraView: applyAutoHit blocked (calibrationGood=false)",Re.value,Re.ring);try{di({lastLabel:Re.label??null,lastValue:Re.value??null,lastRing:Re.ring??null,lastConfidence:Ut.current.lastConfidence??be.current[be.current.length-1]?.confidence??null,lastPboard:null,lastReject:"calibration-invalid"})}catch{}try{a&&a(Re.value,Re.ring,{sector:Re.sector,mult:Re.mult,calibrationValid:!1,pBoard:null})}catch{}return}const Yt=performance.now();if(Za.current)return;Za.current=!0;try{window.setTimeout(()=>{Za.current=!1},Math.max(120,Js))}catch{}const bn=`${Re.value}|${Re.ring}|${Re.mult}`;if(!(Yt-Ci.current<Js&&bn===Si.current)){if(Si.current=bn,Ci.current=Yt,Re.value>0){Pt(!0),vi(!0);try{ys.current&&clearTimeout(ys.current)}catch{}ys.current=window.setTimeout(()=>{vi(!1),ys.current=null},1500);try{try{Le("CameraView: committing locally (camera authoritative)",Re.value,Re.label,Re.ring),sn(Re.value,Re.label,Re.ring,{calibrationValid:!0,pBoard:Zt,source:"camera"})}catch{}try{const en=bn,js=performance.now();a&&!(en===ga.current&&js-va.current<Js)&&(a(Re.value,Re.ring,{sector:Re.sector,mult:Re.mult,calibrationValid:!0,pBoard:Zt}),ga.current=en,va.current=js)}catch{}}catch{}}else Pt(!1);if(Re.value<=0)try{a&&a(Re.value,Re.ring,{sector:Re.sector,mult:Re.mult})}catch{}}};if(Ht)Z.current=null,Gt=!0,Qt="warmup";else if(rr){Le("CameraView: ignoring ghost detection (calibrationGood:",$n,"tipInVideo:",Vs,"pCalInImage:",Hs,")"),Z.current=null,Pt(!1),Gt=!1,Qt=$n?Vs?Hs?Ea?"ghost":"off-board":"pCal-outside-image":"tip-outside-video":"calibration-invalid";try{a&&a(ct,bt,{sector:Qn,mult:ws,calibrationValid:!1,pBoard:null})}catch{}ps({ts:Ot,label:Ft,value:ct,ring:bt,pCal:_t,tip:Mt,confidence:Ct.confidence,ready:!1,accepted:!1,warmup:Ht,rejectReason:Qt})}else{const Re=$s&&Bs;if(bt==="MISS"||ct<=0){Z.current=null,Pt(!1);try{a&&a(ct,bt,{sector:Qn,mult:ws,calibrationValid:!!$n,pBoard:$n?Zt:null})}catch{}Gt=!0}else if(!Re)Gt=!1,Qt=$s?Bs?"not-ready":"unstable-tip":"not-settled",ps({ts:Ot,label:Ft,value:ct,ring:bt,pCal:_t,tip:Mt,confidence:Ct.confidence,ready:!1,accepted:!1,warmup:Ht,rejectReason:Qt});else{const Yt=Z.current;!Yt||Yt.value!==ct||Yt.ring!==bt?Z.current={value:ct,ring:bt,label:Ft,sector:Qn,mult:ws,firstTs:Ot,frames:1}:Z.current={...Yt,label:Ft,frames:Yt.frames+1};const bn=Z.current,en=Ot-bn.firstTs,js=bn.frames>=Om||en>=Fm,Hi=Ot-st.current>=Js;js&&Hi?(Le("CameraView: candidate ready and cooled",{value:ct,ring:bt,frames:bn.frames,nowPerf:Ot}),pc(bn),vt=!0,Z.current=null,st.current=Ot,Gt=!0,Qt=null):Qt=js?Hi?null:"cooldown":"candidate-hold"}}ps({ts:Ot,label:Ft,value:ct,ring:bt,pCal:_t,tip:Mt,confidence:Ct.confidence,ready:Gt,accepted:Gt&&ct>0&&bt!=="MISS",warmup:Ht,rejectReason:Qt});try{(Hm||ge)&&he.current&&he.current.getContext("2d")?.clearRect(0,0,he.current.width,he.current.height)}catch{}Gt&&!vt&&ar.accept(Dn,Ct)}else Z.current&&Ot-Z.current.firstTs>800&&(Z.current=null)}else _n.current&&_n.current.updateBackground(Dn,.05)}catch{}Kn.current=requestAnimationFrame(Lt),pn.current=Lt}};return Kn.current=requestAnimationFrame(Lt),()=>{et=!0,Kn.current&&cancelAnimationFrame(Kn.current),Kn.current=null}},[Se,M,Q,lt,Je,vs,Be,ki,ps,Te,ft,E]);const Us=o.useCallback(async()=>{try{if(Ae){const d=Me.find(v=>v.kind==="videoinput");d?re(d.deviceId,d.label||"",!0):re(void 0,"",!0)}await xn()}catch(d){console.warn("[CameraView] Local camera fallback failed:",d)}},[Me,Ae,re]),ac=()=>{if(!i)return null;const d=S||pe.getState().cameraAspect||"wide",v=(I||pe.getState().cameraFitMode||"fit")==="fit",R=d==="square"?"absolute left-0 top-1/2 -translate-y-1/2 min-w-full min-h-full object-cover object-left bg-black":v?"absolute inset-0 w-full h-full object-contain object-center bg-black ndn-video-smooth":"absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 min-w-full min-h-full w-auto h-auto object-cover object-center bg-black ndn-video-smooth",J=k??1,ne=we||typeof window<"u"&&(window.localStorage?.getItem("ndn.glareDimming")==="1"||window.localStorage?.getItem("ndn.glareClamp")==="1"),q={transform:`scale(${J})`,transformOrigin:"center center",filter:ne?"saturate(1.05) contrast(1.25) brightness(0.86)":"saturate(1.25) contrast(1.12) brightness(1.04)",imageRendering:"crisp-edges"},ke=!!(K.getMediaStream?.()||(b.current?.srcObject??null))?.getVideoTracks()?.length,fe=Ae&&!Y;return e.jsxs("div",{className:"relative h-full rounded-xl overflow-hidden bg-black",children:[e.jsxs("div",{className:"relative w-full h-full bg-black",children:[e.jsx("video",{ref:_e,className:R,style:q,playsInline:!0,muted:!0,autoPlay:!0}),e.jsx("canvas",{ref:he,className:"absolute inset-0 w-full h-full",onClick:er}),!ke&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-black/70 text-center px-4",children:e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"text-sm font-semibold text-white",children:fe?"Phone camera not streaming":"Camera not running"}),e.jsxs("div",{className:"flex flex-wrap items-center justify-center gap-2 text-xs",children:[e.jsx("button",{className:"btn px-3 py-1 text-sm",onClick:()=>{try{se(!0)}catch{}xn()},children:"Start camera"}),e.jsx("button",{className:"btn btn--ghost px-3 py-1 text-sm",onClick:Us,children:"Use local device"}),e.jsx("button",{className:"btn btn--ghost px-3 py-1 text-sm",onClick:Fs,children:"Reconnect phone"})]})]})})]}),e.jsx("canvas",{ref:Ce,className:"hidden"})]})},Mi=o.useCallback(()=>{try{if(typeof document>"u")return;const d=b.current||K.getVideoElementRef?.()||null;if(!d){console.warn("[CameraView] capture requested without video element");return}const v=d.videoWidth||d.clientWidth||0,R=d.videoHeight||d.clientHeight||0;if(!v||!R){console.warn("[CameraView] capture aborted: video has no dimensions");return}const J=document.createElement("canvas");J.width=v,J.height=R;const ne=J.getContext("2d");if(!ne){console.warn("[CameraView] capture aborted: no 2d context");return}ne.drawImage(d,0,0,v,R),J.toBlob(q=>{if(!q)return;const ve=URL.createObjectURL(q),ke=new Date().toISOString().replace(/[:.]/g,"-"),fe=document.createElement("a");fe.href=ve,fe.download=`ndn-capture-${ke}.png`,document.body.appendChild(fe),fe.click(),document.body.removeChild(fe),window.setTimeout(()=>URL.revokeObjectURL(ve),4e3)},"image/png")}catch(d){console.warn("[CameraView] capture failed",d)}},[K]);o.useEffect(()=>{try{if(Ue||g)return;const d=Me.find(v=>/obs|virtual/i.test(String(v.label||"")));d&&re(d.deviceId,d.label||"",!0)}catch{}},[Me,g,Ue,re]),o.useEffect(()=>{try{Ts.getState().setCalibrationStatus({hasHomography:!!lt,imageSize:Je})}catch{}},[lt,Je]),o.useEffect(()=>{try{if(!he.current||!Je)return;const d=he.current;typeof Je.w=="number"&&typeof Je.h=="number"&&(d.width!==Je.w||d.height!==Je.h)&&(d.width=Je.w,d.height=Je.h)}catch{}},[he,Je]),o.useEffect(()=>{if(M!=="external-ws"||!L)return;const d=jm(L,v=>{if(!ht.current||performance.now()-Xe.current<5e3)return;const R=v.ring,J=Number(v.value)||0,ne=v.sector??null,q=Math.max(0,Number(v.mult)||0);let ve="";if(R==="MISS"?ve="MISS":R==="BULL"?ve="BULL 25":R==="INNER_BULL"?ve="INNER_BULL 50":ne!=null?ve=`${q===3?"T":q===2?"D":"S"}${ne} ${J}`:ve=`${R} ${J>0?J:""}`.trim(),!ui({value:J,label:ve,ring:R,confidence:v?.confidence,meta:{calibrationValid:!1,pBoard:null,source:"camera"}}))if(a){try{a(v.value,v.ring,{sector:v.sector??null,mult:v.mult??0})}catch{}try{Ja({playerId:ze.players[ze.currentPlayerIdx]?.id??null,sector:v.sector??null,mult:v.mult??0,ring:v.ring,ts:Date.now()})}catch{}}else{sn(v.value,ve,v.ring,{calibrationValid:!1,pBoard:null,source:"camera"});try{Ja({playerId:ze.players[ze.currentPlayerIdx]?.id??null,sector:v.sector??null,mult:v.mult??0,ring:v.ring,ts:Date.now()})}catch{}}});return()=>d.close()},[M,L,ui]);function er(d){if(!he.current||!lt||!Je)return;const v=he.current.getBoundingClientRect(),R=d.clientX-v.left,J=d.clientY-v.top,ne=he.current.width&&Je.w?he.current.width/Je.w:1,q=he.current.height&&Je.h?he.current.height/Je.h:1,ve={x:R/ne,y:J/q},ke=jr(lt,ve),fe=`${ke.ring} ${ke.base>0?ke.base:""}`.trim();$e(fe),hn(ke.base),jn(ke.ring),Pt(!0);try{if(r&&a){a(ke.base,ke.ring,{sector:ke.sector,mult:ke.mult});try{Ja({playerId:ze.players[ze.currentPlayerIdx]?.id??null,sector:ke.sector??null,mult:ke.mult??0,ring:ke.ring,ts:Date.now()})}catch{}Pt(!1)}}catch{}}function Ri(d){const v=d.trim().toUpperCase();if(!v)return null;const R=v==="BULL"||v==="50"||v==="DBULL"||v==="IBULL",J=v==="25"||v==="OBULL";if(R)return{label:"INNER_BULL 50",value:50,ring:"INNER_BULL"};if(J)return{label:"BULL 25",value:25,ring:"BULL"};const ne=v.match(/^(S|D|T)?\s*(\d{1,2})$/);if(!ne)return null;const q=ne[1]||"S",ve=parseInt(ne[2],10);if(ve<1||ve>20)return null;const ke=q==="S"?1:q==="D"?2:3,fe=q==="S"?"SINGLE":q==="D"?"DOUBLE":"TRIPLE";return{label:`${q}${ve} ${ve*ke}`,value:ve*ke,ring:fe}}function tr(){const d=ze;if(!d.players.length)return d.startingScore;const v=d.players[d.currentPlayerIdx],R=v.legs[v.legs.length-1];return R?R.totalScoreRemaining:d.startingScore}function nr(d){if(U&&!(typeof d!="number"||!Number.isFinite(d)))try{const v=window.speechSynthesis;if(!v)return;const R=new SpeechSynthesisUtterance,J=Math.round(d);if(R.text=`${J} millimetres`,R.rate=.95,R.pitch=1,ee){const ne=v.getVoices().find(q=>q.name===ee);ne&&(R.voice=ne)}R.volume=typeof X=="number"?Math.max(0,Math.min(1,X)):1;try{v.cancel()}catch{}v.speak(R)}catch{}}function sr(d){if(U)try{const v=ze.players[ze.currentPlayerIdx]?.name,R=tr();Mm(v||"Player",d,Math.max(0,R),ee,{volume:X,checkoutOnly:P})}catch{}}function sn(d,v,R,J){if(mt&&qe)try{On("event")}catch{}const ne=J??{calibrationValid:!1,pBoard:null,source:"manual"};if(l==="custom"){if(!ne.__allowMultipleBullUp){if(qa.current)return;qa.current=!0}if(u)try{u(d,R,{label:v})}catch{}if((nt.current||0)>=3){Nt(1),At(d),pt([{label:v,value:d,ring:R,meta:ne}]);try{Jt.getState().setVisit([{label:v,value:d,ring:R,meta:ne}],1,d)}catch{}try{ne.source==="camera"&&ma()}catch{}return}const Ke=Be+1;Nt(Ke),nt.current=Ke,At(Ze=>Ze+d),pt(Ze=>[...Ze,{label:v,value:d,ring:R,meta:ne}]);try{const Ze=[...Ve,{label:v,value:d,ring:R,meta:ne}],Kt=Ze.reduce((Lt,vt)=>Lt+(Number(vt?.value)||0),0);Jt.getState().setVisit(Ze,Ke,Kt)}catch{}return}if((nt.current||0)>=3){const Ke=Xt,Ze=Be,Kt=Ls(Ve);Jn(Ke,Ze,{preOpenDarts:F||0,doubleWindowDarts:Ye||0,finishedByDouble:!1,visitTotal:Ke,entries:Kt});try{const rt=ze.players[ze.currentPlayerIdx]?.name;rt&&Ys(rt,Ze,Ke)}catch{}const Lt=!xs||bs||R==="DOUBLE"||R==="INNER_BULL",vt=Lt?d:0;Nt(1),nt.current=1,At(vt),pt([{label:v,value:vt,ring:R,meta:ne}]);try{Jt.getState().setVisit([{label:v,value:vt,ring:R,meta:ne}],1,vt)}catch{}try{ne.source==="camera"&&ma()}catch{}oe(Lt?0:1),Ge(0),xs&&!bs&&(R==="DOUBLE"||R==="INNER_BULL")&&pi(!0),Yn({score:Ke,darts:Ze,finished:!1});return}const q=(nt.current||0)+1,ke=!xs||bs||R==="DOUBLE"||R==="INNER_BULL"?d:0;xs&&!bs&&(R==="DOUBLE"||R==="INNER_BULL")&&pi(!0);const fe=Xt+ke,ue=tr()-fe,at=ue===0&&(R==="DOUBLE"||R==="INNER_BULL");if(ue<0||ue===1||ue===0&&!at){const Ke=Ls([...Ve,{label:v,value:ke,ring:R}]),Kt=(F||0)+(xs&&!bs&&!(R==="DOUBLE"||R==="INNER_BULL")?1:0),Lt=ue,vt=ue+ke,rt=vt>50&&Lt<=50||vt<=50?1:0,jt=(Ye||0)+rt;Jn(0,q,{preOpenDarts:Kt,doubleWindowDarts:jt,finishedByDouble:!1,visitTotal:0,entries:Ke}),Nt(0),nt.current=0,At(0),pt([]),oe(0),Ge(0),Yn({score:0,darts:q,finished:!1});try{Jt.getState().reset()}catch{}return}Nt(q),nt.current=q,At(fe),pt(Ke=>{const Ze=[...Ke,{label:v,value:ke,ring:R,meta:ne}];try{const Kt=Ze.reduce((Lt,vt)=>Lt+(Number(vt?.value)||0),0);Jt.getState().setVisit(Ze,q,Kt)}catch{}return Ze});try{ne.source==="camera"&&ma()}catch{}xs&&!bs&&!(R==="DOUBLE"||R==="INNER_BULL")&&oe(Ke=>(Ke||0)+1);{const Ke=ue,Ze=ue+ke;(Ze>50&&Ke<=50||Ze<=50)&&Ge(Lt=>(Lt||0)+1)}if(at){const Ke=Ls([...Ve,{label:v,value:ke,ring:R}]),Ze=Ga();Jn(fe,q,{preOpenDarts:F||0,doubleWindowDarts:Ye||0,finishedByDouble:!0,visitTotal:fe,entries:Ke}),gi(fe),Nt(0),nt.current=0,At(0),pt([]),oe(0),Ge(0),Yn({score:fe,darts:q,finished:!0,meta:{label:v,ring:R,entries:Ke,frame:Ze}});try{Jt.getState().reset()}catch{}return}if(q>=3){const Ke=Ls([...Ve,{label:v,value:ke,ring:R}]);Jn(fe,q,{preOpenDarts:F||0,doubleWindowDarts:Ye||0,finishedByDouble:!1,visitTotal:fe,entries:Ke});try{ne.source==="camera"&&ma()}catch{}Nt(0),nt.current=0,At(0),pt([]),oe(0),Ge(0),Yn({score:fe,darts:q,finished:!1});try{Jt.getState().reset()}catch{}}}function Ai(){if(!(mt&&qe)&&ie){if(a)try{a(We,Rt,void 0)}catch{}else sn(We,ie,Rt);It(0),Pt(!1)}}function ja(){if(mt&&qe)return;const d=Ri(Fe);if(!d){alert("Enter like T20, D16, 5, 25, 50");return}if(!Xn||!ie||Rt==="MISS"||We===0){const v=kn+1;It(v),v>=5&&cn(!0)}else It(0);sn(d.value,d.label,d.ring),it(""),Pt(!1)}function Pi(){if(mt&&qe)return;const d=Ri(Fe);if(!d){alert("Enter like T20, D16, 5, 25, 50");return}if(Be===0||Ve.length===0){ja();return}if(l==="custom"){if(!Xn||!ie||Rt==="MISS"||We===0){const ue=kn+1;It(ue),ue>=5&&cn(!0)}else It(0);if(pt(ue=>[...ue.slice(0,-1),{label:d.label,value:d.value,ring:d.ring}]),f)try{f(d.value,d.ring,{label:d.label})}catch{}it(""),Pt(!1);return}if(!Xn||!ie||Rt==="MISS"||We===0){const ue=kn+1;It(ue),ue>=5&&cn(!0)}else It(0);const v=Ve[Ve.length-1],R=Be-1,J=Xt-(v?.value||0),ne=tr(),q=J+d.value,ve=R+1,ke=ne-q,fe=ke===0&&(d.ring==="DOUBLE"||d.ring==="INNER_BULL");if(ke<0||ke===1||ke===0&&!fe){Jn(0,ve);try{const ue=ze.players[ze.currentPlayerIdx]?.name;ue&&Ys(ue,ve,0)}catch{}Nt(0),nt.current=0,At(0),pt([]),Yn({score:0,darts:ve,finished:!1}),it(""),Pt(!1);return}if(Nt(ve),nt.current=ve,At(q),pt(ue=>[...ue.slice(0,-1),{label:d.label,value:d.value,ring:d.ring}]),fe){Jn(q,ve),gi(q);try{const ue=ze.players[ze.currentPlayerIdx]?.name;ue&&Ys(ue,ve,q)}catch{}Nt(0),nt.current=0,At(0),pt([]),Yn({score:q,darts:ve,finished:!0}),it(""),Pt(!1);return}if(ve>=3){Jn(q,ve);try{const ue=ze.players[ze.currentPlayerIdx]?.name;ue&&Ys(ue,ve,q)}catch{}Nt(0),nt.current=0,At(0),pt([]),Yn({score:q,darts:ve,finished:!1})}it(""),Pt(!1)}function rc(){cn(!1),It(0);try{window.dispatchEvent(new CustomEvent("ndn:request-calibrate"))}catch{}}function ic(){wn(),cn(!1),It(0)}o.useEffect(()=>{function d(v){try{const J=document.activeElement?.tagName?.toLowerCase();v.key==="m"&&J!=="input"&&J!=="textarea"&&(Fn("manual"),Un(!0))}catch{}}return window.addEventListener("keydown",d),()=>window.removeEventListener("keydown",d)},[]);function Na(d,v){if(Be>=3||mt&&qe)return;const R=d*(v==="S"?1:v==="D"?2:3),J=v==="S"?"SINGLE":v==="D"?"DOUBLE":"TRIPLE";if(!Xn||!ie||Rt==="MISS"||We===0){const ne=kn+1;It(ne),ne>=5&&cn(!0)}else It(0);sn(R,`${v}${d} ${R}`,J),Pt(!1)}function oc(){if(Be===0)return;const d=Ve[Ve.length-1];Nt(v=>v-1),nt.current=Math.max(0,(nt.current||0)-1),At(v=>v-(d?.value||0)),pt(v=>v.slice(0,-1))}function Li(){if(Be===0||mt&&qe)return;if(O){try{window.alert("Cannot commit: pending camera detections are not calibration validated for online matches")}catch{}return}if(l==="custom"){Nt(0),nt.current=0,nt.current=0,At(0),pt([]);return}const d=Xt,v=Be,R=Ls(Ve);Jn(d,v,{entries:R,visitTotal:d});try{const J=ze.players[ze.currentPlayerIdx]?.name;J&&Ys(J,v,d)}catch{}Nt(0),nt.current=0,At(0),pt([]),Yn({score:d,darts:v,finished:!1})}const lc=e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-4 w-full min-w-0",children:[s&&e.jsx("div",{className:"lg:col-span-2",children:e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[!Se&&e.jsx("button",{className:`btn px-3 py-1 text-sm ${yi==="auto"?"tab--active":""}`,onClick:()=>{Fn("auto"),Un(!1),ba(!0)},children:"Autoscore"}),e.jsx("button",{className:`btn px-3 py-1 text-sm ${yi==="manual"?"tab--active":""}`,onClick:()=>{Fn("manual"),Un(!0)},title:"Open Manual Correction",children:"Manual Correction"}),Se&&e.jsx("span",{className:"text-xs opacity-70",children:"Manual scoring mode active"})]})}),!i&&!Se?e.jsx("div",{className:"card relative camera-fullwidth-card lg:col-span-2 w-full min-w-0",children:e.jsxs("div",{className:"camera-fullwidth-body flex flex-col gap-4 w-full min-w-0",children:[e.jsx("h2",{className:"text-xl font-semibold mb-3",children:"Camera"}),e.jsxs(vo,{storageKey:"ndn:camera:size",className:"relative rounded-2xl overflow-hidden bg-black w-full",defaultWidth:480,defaultHeight:360,minWidth:360,minHeight:270,maxWidth:800,maxHeight:600,autoFill:!0,children:[e.jsx(Ii,{}),(()=>{const d=S||pe.getState().cameraAspect||"wide",v=(I||pe.getState().cameraFitMode||"fit")==="fit",R=d==="square"?"absolute left-0 top-1/2 -translate-y-1/2 min-w-full min-h-full object-cover object-left bg-black":v?"absolute inset-0 w-full h-full object-contain object-center bg-black":"absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 min-w-full min-h-full w-auto h-auto object-cover object-center bg-black ndn-video-smooth",J=k??1,ne=typeof window<"u"&&(window.localStorage?.getItem("ndn.glareDimming")==="1"||window.localStorage?.getItem("ndn.glareClamp")==="1"),q={transform:`scale(${J})`,transformOrigin:"center center",filter:ne?"saturate(1.05) contrast(1.25) brightness(0.86)":"saturate(1.25) contrast(1.12) brightness(1.04)",imageRendering:"crisp-edges"},ve=d==="square"?"relative w-full mx-auto aspect-square bg-black":"relative w-full aspect-[4/3] bg-black",ke=()=>e.jsxs("div",{className:`camera-viewport ${ve}`,children:[e.jsx("video",{ref:_e,className:R,style:q,playsInline:!0,muted:!0,autoPlay:!0}),e.jsx("canvas",{ref:he,className:"absolute inset-0 w-full h-full",onClick:er}),e.jsxs("div",{className:"absolute top-2 left-1/2 -translate-x-1/2 z-20 flex items-center gap-3 cursor-pointer select-none",onDoubleClick:ql,"aria-label":`Visit status: ${Ve[0]?Ve[0].value>0?"hit":"miss":"pending"}, ${Ve[1]?Ve[1].value>0?"hit":"miss":"pending"}, ${Ve[2]?Ve[2].value>0?"hit":"miss":"pending"}`,children:[[0,1,2].map(fe=>{const et=Ve[fe],ue=Oe[fe],at=!et,$t=!!et&&ue===Tt,Ke=typeof et?.value=="number"?et.value>0:!1,Ze=(et?.ring&&et.ring!=="MISS")??!1,Lt=$t?$t&&(Ke||Ze)?"bg-emerald-400":"bg-rose-500":"bg-gray-500/70",vt=$t&&!at;return e.jsx("span",{className:`visit-dot ${vt?"active":"inactive"} ${Lt}`},fe)}),Os&&gs!==null&&e.jsxs("span",{className:"px-2 py-0.5 rounded bg-black/60 text-white text-xs font-semibold",children:[Math.max(0,gs),"s"]})]}),mt&&qe?e.jsx("div",{className:"absolute bottom-3 left-1/2 -translate-x-1/2 z-20 bg-black/70 text-amber-200 text-xs font-semibold px-3 py-1 rounded-full shadow",children:"Remove darts to continue"}):null]});return Ae?Y?ke():e.jsx("div",{className:"w-full h-full flex flex-col items-center justify-center bg-gradient-to-br from-blue-900/50 to-purple-900/50",children:e.jsxs("div",{className:"text-center space-y-3 max-w-xs mx-auto",children:[e.jsx("div",{className:"text-2xl font-semibold",children:"CAM"}),e.jsx("div",{className:"text-lg font-semibold text-blue-100",children:"Phone camera selected"}),e.jsx("p",{className:"text-sm text-slate-300",children:"Start streaming from the Calibrator tab or reconnect below."}),e.jsxs("div",{className:"flex items-center justify-center gap-2 flex-wrap",children:[e.jsx("button",{className:"btn bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 text-sm",onClick:Fs,children:"Reconnect Phone"}),e.jsx("button",{className:"btn bg-slate-700 hover:bg-slate-800 text-white px-3 py-1 text-sm",onClick:()=>{try{K.setShowOverlay?.(!0)}catch{}},children:"Show Overlay"}),e.jsx("button",{className:"btn bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-1 text-sm",onClick:Us,disabled:!Me.length,children:"Use Local Camera"})]})]})}):ke()})()]}),e.jsxs("div",{className:"mt-3 flex flex-wrap items-center gap-2 text-xs",children:[e.jsx("span",{className:"uppercase tracking-wide text-slate-400",children:"Cam"}),e.jsx("button",{className:"btn btn--ghost px-2 py-1",onClick:()=>hi(-.05),title:"Decrease camera zoom",children:"âˆ’"}),e.jsxs("span",{className:"w-10 text-center font-semibold text-white",children:[Math.round((k??1)*100),"%"]}),e.jsx("button",{className:"btn btn--ghost px-2 py-1",onClick:()=>hi(.05),title:"Increase camera zoom",children:"+"}),e.jsx("button",{className:`btn btn--ghost px-3 py-1 text-[11px] ${I==="fill"?"bg-emerald-500 text-white":""}`,onClick:Hl,title:"Show dartboard only",children:"Full"}),e.jsx("button",{className:`btn btn--ghost px-3 py-1 text-[11px] ${I!=="fill"?"bg-slate-200 text-slate-900":""}`,onClick:Wl,title:"Letterbox to wide view",children:"Wide"})]}),e.jsxs("div",{className:"mt-3 flex items-center justify-between gap-2",children:[e.jsxs("button",{className:"btn btn--ghost px-3 py-1 text-xs font-semibold",onClick:()=>hs(d=>!d),children:[ln?"Hide":"Show"," detection log"]}),e.jsxs("button",{className:`btn btn--ghost px-3 py-1 text-xs font-semibold ${Ps?"bg-indigo-500/80 text-white":""}`,onClick:()=>ci(d=>!d),title:"Toggle diagnostics overlay (Ctrl+Shift+D)",children:[Ps?"Hide":"Show"," diagnostics"]}),e.jsxs("span",{className:"text-xs text-slate-400",children:["Recent detections: ",Rs.length]})]}),Ps&&e.jsxs("div",{className:"mt-2 rounded-2xl border border-white/15 bg-slate-950/80 p-3 text-[11px] text-white font-mono space-y-1",children:[e.jsxs("div",{className:"flex flex-wrap gap-x-4 gap-y-1 items-center",children:[e.jsx("span",{className:"text-slate-300",children:"Toggle:"}),e.jsx("span",{className:"text-slate-400",children:"Ctrl+Shift+D"}),e.jsx("span",{className:"text-slate-300",children:"Commit:"}),e.jsxs("span",{children:[mt?"wait-for-clear":"immediate",qe?" (awaiting-clear)":""]}),e.jsx("span",{className:"text-slate-300",children:"Online:"}),e.jsx("span",{children:D?"yes":"no"})]}),e.jsxs("div",{className:"flex flex-wrap gap-x-4 gap-y-1",children:[e.jsx("span",{className:"text-slate-300",children:"Calibration:"}),e.jsx("span",{className:z?"text-emerald-300":"text-rose-300",children:z?"VALID":"INVALID"}),e.jsx("span",{className:"text-slate-300",children:"locked:"}),e.jsx("span",{children:qn?"yes":"no"}),e.jsx("span",{className:"text-slate-300",children:"errorPx:"}),e.jsx("span",{children:qt==null?"(missing)":qt.toFixed(2)}),e.jsx("span",{className:"text-slate-300",children:"conf:"}),e.jsx("span",{children:x==null?"(n/a)":`${Math.round(x)}%`})]}),e.jsxs("div",{className:"mt-3 grid grid-cols-1 md:grid-cols-3 gap-3",children:[e.jsxs("div",{className:"col-span-1",children:[e.jsx("div",{className:"font-semibold text-sm mb-1",children:"Last detection"}),Sn?e.jsxs("div",{className:"flex items-center gap-2",children:[Sn.frame?e.jsx("img",{src:Sn.frame,alt:"last-detect",className:"w-20 h-12 object-cover rounded"}):e.jsx("div",{className:"w-20 h-12 bg-slate-800 rounded"}),e.jsxs("div",{className:"text-xs",children:[e.jsx("div",{className:"font-semibold",children:Sn.value}),e.jsxs("div",{className:"text-slate-400",children:[Sn.ring," â€¢"," ",Sn.confidence.toFixed(2)]}),e.jsx("div",{className:"mt-1 flex gap-2",children:e.jsx("button",{className:"btn btn--ghost px-2 py-1 text-xs",onClick:()=>{try{sn(Sn.value,`${Sn.value}`,Sn.ring,{calibrationValid:!0,pBoard:Sn.pCal??null,source:"camera"})}catch{}},children:"Commit"})})]})]}):e.jsx("div",{className:"text-xs text-slate-400",children:"No detections yet."})]}),e.jsxs("div",{className:"col-span-1",children:[e.jsx("div",{className:"font-semibold text-sm mb-1",children:"Last commit"}),fs?e.jsxs("div",{className:"flex items-center gap-2",children:[fs.frame?e.jsx("img",{src:fs.frame,alt:"last-commit",className:"w-20 h-12 object-cover rounded"}):e.jsx("div",{className:"w-20 h-12 bg-slate-800 rounded"}),e.jsxs("div",{className:"text-xs",children:[e.jsx("div",{className:"font-semibold",children:fs.score}),e.jsxs("div",{className:"text-slate-400",children:[fs.darts," darts â€¢"," ",new Date(fs.ts).toLocaleTimeString()]})]})]}):e.jsx("div",{className:"text-xs text-slate-400",children:"No commits yet."})]}),e.jsxs("div",{className:"col-span-1",children:[e.jsx("div",{className:"font-semibold text-sm mb-1",children:"Tests"}),e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx("button",{className:"btn btn--ghost px-3 py-1 text-xs",onClick:()=>{try{pn.current&&pn.current()}catch{}},children:"Run detection test"}),e.jsx("button",{className:"btn btn--ghost px-3 py-1 text-xs",onClick:()=>{try{sn(60,"60","TRIPLE",{calibrationValid:!0,pBoard:null,source:"manual"})}catch{}},children:"Simulate 60 (T20)"})]})]})]}),e.jsxs("div",{className:"mt-2 grid grid-cols-1 sm:grid-cols-2 gap-2",children:[e.jsxs("div",{className:"rounded-xl border border-white/10 bg-black/30 p-2",children:[e.jsx("div",{className:"text-slate-300 mb-1",children:"Last detection"}),e.jsxs("div",{children:["label: ",Ut.current.lastLabel??"(none)"]}),e.jsxs("div",{children:["confidence:"," ",Ut.current.lastConfidence==null?"(n/a)":Number(Ut.current.lastConfidence).toFixed(3)]}),e.jsxs("div",{children:["reject:"," ",e.jsx("span",{className:Ut.current.lastReject?"text-amber-300":"text-emerald-300",children:Ut.current.lastReject??"(accepted)"})]})]}),e.jsxs("div",{className:"rounded-xl border border-white/10 bg-black/30 p-2",children:[e.jsx("div",{className:"text-slate-300 mb-1",children:"Mapping"}),e.jsxs("div",{children:["tip:"," ",Ut.current.lastTip?`${Math.round(Ut.current.lastTip.x)},${Math.round(Ut.current.lastTip.y)}`:"(n/a)"]}),e.jsxs("div",{children:["pCal:"," ",Ut.current.lastPcal?`${Math.round(Ut.current.lastPcal.x)},${Math.round(Ut.current.lastPcal.y)}`:"(n/a)"]}),e.jsxs("div",{children:["pBoard:"," ",Ut.current.lastPboard?`${Math.round(Ut.current.lastPboard.x)},${Math.round(Ut.current.lastPboard.y)}`:"(n/a)"]}),e.jsxs("div",{className:"text-slate-500 mt-1",children:["tipStableFrames: ",Dt.current.stableFrames]})]})]})]}),ln&&e.jsx("div",{className:"mt-2 rounded-2xl border border-white/15 bg-slate-900/80 p-3 text-xs text-white font-mono max-h-36 overflow-y-auto space-y-1",children:Rs.length===0?e.jsx("div",{className:"text-center text-slate-400",children:"No autoscore detections yet."}):Rs.slice().reverse().map(d=>e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsx("span",{className:"truncate flex-1",title:`Value ${d.value} ${d.ring}`,children:He?d.label.padEnd(6," "):`${d.value}`}),e.jsx("span",{className:"text-slate-400",children:d.confidence.toFixed(2)}),e.jsx("span",{className:`px-2 rounded-full text-[10px] font-semibold ${d.accepted?"bg-emerald-500/80":d.ready?"bg-amber-500/80":"bg-rose-500/80"}`,children:d.accepted?"accepted":d.ready?"queued":"ignored"})]},d.ts))}),Ya?e.jsx("div",{className:"sr-only","aria-hidden":"true",children:e.jsx("button",{"data-testid":"commit-visit-btn",onClick:Li,disabled:Be===0||O,children:"Commit"})}):null,e.jsxs("div",{className:"flex flex-wrap items-center gap-2 mt-3",children:[Ae?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:`text-sm px-3 py-2 rounded border flex-1 min-w-[200px] ${Y?"bg-emerald-500/10 border-emerald-400/40 text-emerald-100":"bg-amber-500/10 border-amber-400/40 text-amber-100"}`,children:Y?"CAM Phone camera stream active":"CAM Waiting for phone camera stream"}),e.jsx("button",{className:"btn bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 text-sm",onClick:Fs,children:"Reconnect Phone"}),e.jsx("button",{className:"btn bg-slate-700 hover:bg-slate-800 text-white px-3 py-1 text-sm",onClick:()=>{try{K.setShowOverlay?.(!K.showOverlay)}catch{}},children:K.showOverlay?"Hide Overlay":"Show Overlay"}),e.jsx("button",{className:"btn bg-rose-600 hover:bg-rose-700 text-white px-3 py-1 text-sm",disabled:!Y,onClick:()=>{try{K.clearSession?.()}catch{}},children:"Stop Phone Feed"}),Ti&&e.jsx("button",{className:"btn bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-1 text-sm",onClick:Us,disabled:!Me.length,children:"Use Local Camera"})]}):e.jsx(e.Fragment,{children:Ee?e.jsx("button",{className:"btn bg-rose-600 hover:bg-rose-700",onClick:ya,children:"Stop Camera"}):e.jsx("button",{className:"btn",onClick:xn,disabled:de,children:de?"Connecting Camera...":"Connect Camera"})}),!Se&&e.jsx("button",{className:"btn bg-slate-700 hover:bg-slate-800",onClick:Yl,title:"Open phone, WiFi, and USB camera options",children:"Camera Devices"}),e.jsx("button",{className:"btn btn--ghost px-3 py-1 text-sm",onClick:()=>je(!ge),title:"Toggle the board guide overlay",children:ge?"Show board guides":"Hide board guides"}),e.jsx("button",{className:`btn ${De?"bg-rose-600 hover:bg-rose-700 text-white":"bg-emerald-600 hover:bg-emerald-700 text-white"}`,onClick:()=>se(!De),title:"Toggle whether the camera is used for scoring",children:De?"Disable camera mode":"Enable camera mode"}),e.jsx("button",{className:"btn",onClick:Mi,disabled:!Q,children:"Capture Still"}),ze?.inProgress&&e.jsxs(e.Fragment,{children:[e.jsx(Il,{compact:!0}),e.jsx("button",{className:"btn bg-rose-600 hover:bg-rose-700 text-white px-3 py-1 text-sm",onClick:()=>Nn(!0),children:"Quit / Pause"}),Gn&&e.jsx(Sm,{onClose:()=>Nn(!1),onQuit:()=>{try{window.dispatchEvent(new CustomEvent("ndn:match-quit"));try{un({type:"quit"})}catch{}}catch{}Nn(!1)},onPause:d=>{const v=Date.now()+d*60*1e3;try{zt.getState().setPaused(!0,v);try{un({type:"pause",pauseEndsAt:v,pauseStartedAt:Date.now()})}catch{}}catch{}Nn(!1)}}),e.jsx("button",{className:"btn btn--ghost px-3 py-1 text-sm",onClick:()=>{try{Nr(),window.open(`${window.location.origin}${window.location.pathname}?match=1`,"_blank")}catch{}},children:"Open match in new window"}),e.jsx("button",{className:`btn btn--ghost px-3 py-1 text-sm ${fn?"bg-emerald-600 text-black":""}`,onClick:()=>{try{const d=b.current;if(!d)return;fn?(Rl(),rs(!1)):(Em(d,600),rs(!0))}catch{}},children:fn?"Stop preview forward":"Forward preview (PoC)"}),e.jsx("button",{className:"btn btn--ghost px-3 py-1 text-sm",onClick:async()=>{try{document.documentElement.requestFullscreen?await document.documentElement.requestFullscreen():document.body.requestFullscreen&&await document.body.requestFullscreen()}catch{}},children:"Open full screen"})]}),e.jsx("button",{className:"btn bg-slate-700 hover:bg-slate-800",disabled:!Q,onClick:()=>{_n.current=null,Ei(d=>d+1)},children:"Reset Autoscore Background"}),e.jsx("button",{className:"btn bg-slate-700 hover:bg-slate-800",onClick:()=>{try{window.dispatchEvent(new Event("ndn:camera-reset"))}catch{}},children:"Reset Camera Size"})]})]})}):null,Ya?e.jsx("div",{className:"fixed bottom-6 right-6 z-50",children:e.jsx("button",{className:"btn btn--primary rounded-full w-12 h-12 flex items-center justify-center shadow-lg",title:"Open Manual Correction (M)",onClick:()=>{Fn("manual"),Un(!0)},children:"âœï¸"})}):null,!i&&Se&&e.jsxs("div",{className:"card",children:[e.jsx("h2",{className:"text-xl font-semibold mb-3",children:"Manual Scoring"}),e.jsx("p",{className:"text-sm opacity-80 mb-3",children:"Camera-based autoscore is disabled. Use the manual visit input or open the Manual Correction panel to record darts."}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsx("button",{className:"btn",onClick:()=>{Un(!0),Fn("manual")},children:"Open Manual Correction"}),e.jsx("button",{className:"btn btn--ghost",onClick:()=>{try{window.dispatchEvent(new Event("ndn:open-scoring"))}catch{}},children:"Manage Pending Visit"})]})]}),e.jsx("canvas",{ref:Ce,className:"hidden"}),nc&&!Se&&e.jsx("div",{className:"fixed inset-0 bg-black/60 z-[100]",role:"dialog","aria-modal":"true",children:e.jsx("div",{className:"absolute inset-0 flex items-center justify-center p-4",children:e.jsxs(Dl,{storageKey:"ndn:autoscore:size",className:"w-full max-w-3xl",defaultWidth:720,defaultHeight:520,minWidth:420,minHeight:320,maxWidth:1400,maxHeight:900,initialFitHeight:!0,children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h2",{className:"text-xl font-semibold",children:"Autoscore"}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("button",{className:"btn btn--ghost",onClick:()=>ba(!1),children:"Close"})})]}),e.jsx("div",{className:"text-sm opacity-80 mb-3",children:"Click the camera overlay to autoscore. Use Manual Correction if the last auto is off."}),e.jsxs("div",{className:"flex items-center gap-2 mb-3 flex-wrap",children:[e.jsx("span",{className:"font-semibold",children:"Last auto:"}),e.jsx("span",{children:ie||"â€”"}),e.jsx("button",{className:"btn",onClick:Ai,disabled:Be>=3,children:"Add Auto Dart"}),kn>0&&e.jsxs("span",{className:"text-sm opacity-80",children:["No-registers: ",kn,"/3"]})]}),e.jsxs("div",{className:"mt-2",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"Quick entry"}),e.jsxs("div",{className:"flex flex-wrap gap-2 mb-3",children:[e.jsx("button",{className:"btn",disabled:Be>=3,onClick:()=>{if(!Xn||!ie||Rt==="MISS"||We===0){const d=kn+1;It(d),d>=5&&cn(!0)}else It(0);sn(25,"BULL 25","BULL"),Pt(!1)},children:"25"}),e.jsx("button",{className:"btn",disabled:Be>=3,onClick:()=>{if(!Xn||!ie||Rt==="MISS"||We===0){const d=kn+1;It(d),d>=5&&cn(!0)}else It(0);sn(50,"INNER_BULL 50","INNER_BULL"),Pt(!1)},children:"50"})]}),e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx("input",{className:"input w-full max-w-sm",list:"autoscore-quick-list",placeholder:"Type or select (e.g., D16, T20, S5)",value:pa,onChange:d=>Zl(d.target.value.toUpperCase()),onKeyDown:d=>{if(d.key==="Enter"){const v=pa.match(/^(S|D|T)(\d{1,2})$/);v&&Na(parseInt(v[2],10),v[1])}}}),e.jsx("datalist",{id:"autoscore-quick-list",children:["D","S","T"].map(d=>Array.from({length:20},(v,R)=>R+1).map(v=>e.jsx("option",{value:`${d}${v}`},`${d}${v}`)))}),e.jsx("button",{className:"btn",disabled:!pa||Be>=3,onClick:()=>{const d=pa.match(/^(S|D|T)(\d{1,2})$/);if(!d)return;const v=d[1],R=parseInt(d[2],10);Na(R,v)},children:"Add"})]})]})]})})}),Cn&&e.jsx("div",{className:"fixed inset-0 bg-black/70 z-[120]",role:"dialog","aria-modal":"true",children:e.jsx("div",{className:"absolute inset-0 flex items-center justify-center p-4",children:e.jsxs("div",{className:"card w-full max-w-lg",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Confirm detected dart"}),e.jsx("button",{className:"btn btn--ghost",onClick:()=>is(null),children:"Close"})]}),e.jsx("div",{className:"text-sm opacity-80 mb-3",children:"This hit was detected with lower confidence."}),e.jsxs("div",{className:"flex flex-col gap-2 mb-3",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-semibold",children:"Detected:"})," ",Cn.label]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-semibold",children:"Confidence:"})," ",Cn.confidence.toFixed(2)]})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx("button",{className:"btn",onClick:()=>{try{sn(Cn.value,Cn.label,Cn.ring,Cn.meta)}catch{}is(null)},children:"Accept"}),e.jsx("button",{className:"btn btn--ghost",onClick:()=>is(null),children:"Reject"}),e.jsx("button",{className:"btn bg-slate-700 hover:bg-slate-800",onClick:()=>{is(null),Un(!0),Fn("manual")},children:"Open Manual Correction"})]})]})})}),Xa&&e.jsx("div",{className:"fixed inset-0 bg-black/60 z-[100]",role:"dialog","aria-modal":"true",children:e.jsx("div",{className:"absolute inset-0 flex flex-col",children:e.jsxs(Bn,{returnFocus:!0,children:[e.jsxs("div",{className:"p-3 md:p-4 flex items-center justify-between",children:[e.jsx("h3",{className:"text-xl md:text-2xl font-semibold",children:"Manual Correction"}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("button",{className:"btn bg-slate-700 hover:bg-slate-800",onClick:()=>{Un(!1)},children:"Close"})})]}),e.jsx("div",{className:"flex-1 p-3 md:p-4",children:e.jsxs("div",{className:"h-full grid grid-cols-1 lg:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"card relative flex flex-col",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"Live Preview"}),e.jsx("div",{className:"relative flex-1 rounded-2xl overflow-hidden bg-black",children:e.jsx("canvas",{ref:ji,className:"absolute inset-0 w-full h-full"})})]}),e.jsxs("div",{className:"card flex flex-col",children:[e.jsx("div",{className:"text-sm opacity-80 mb-2",children:"Type a correction or replace the last dart. The preview updates live."}),e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("span",{className:"font-semibold",children:"Last auto:"}),e.jsx("span",{children:ie||"â€”"}),e.jsx("button",{className:"btn",onClick:Ai,disabled:Be>=3,children:"Add Auto Dart"})]}),e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("input",{className:"input flex-[1.2]",placeholder:"Manual (T20, D16, 5, 25, 50)",value:Fe,onChange:d=>it(d.target.value),onKeyDown:d=>{d.key==="Enter"&&!d.shiftKey&&(d.preventDefault(),ja()),d.key==="Enter"&&d.shiftKey&&(d.preventDefault(),Pi())}}),e.jsx("button",{className:"btn btn--ghost",onClick:Pi,disabled:Be===0,children:"Replace Last"}),e.jsx("button",{className:"btn",onClick:ja,disabled:Be>=3,children:"Add"})]}),e.jsx("div",{className:"text-xs opacity-70 mb-4",children:"Press Enter to Add Â· Shift+Enter to Replace Last"}),e.jsxs("div",{className:"mb-4",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"Number pad"}),e.jsxs("div",{className:"grid grid-cols-3 gap-2 max-w-sm",children:[["7","8","9","4","5","6","1","2","3","0"].map(d=>e.jsx("button",{className:"btn text-lg",onClick:()=>{it(v=>/^[SDT]/i.test(v)?v+d:(v||"")+d)},children:d},d)),e.jsx("button",{className:"btn bg-rose-600 hover:bg-rose-700 text-white",onClick:()=>it(""),children:"Clear"}),e.jsx("button",{className:"btn bg-slate-600 hover:bg-slate-700 text-white",onClick:()=>it(d=>(d||"").slice(0,-1)),children:"âŒ«"}),e.jsx("button",{className:"btn bg-emerald-600 hover:bg-emerald-700 text-white",onClick:()=>ja(),disabled:Be>=3,children:"Enter"})]}),e.jsx("div",{className:"text-xs opacity-70 mt-2",children:"Tap numbers then press Enter to submit. Use D/T prefixes for doubles/trebles (e.g., D16)."})]}),e.jsxs("div",{className:"mt-auto",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"Quick entry"}),e.jsxs("div",{className:"flex flex-wrap gap-2 mb-3",children:[e.jsx("button",{className:"btn",disabled:Be>=3,onClick:()=>{if(!Xn||!ie||Rt==="MISS"||We===0){const d=kn+1;It(d),d>=5&&cn(!0)}else It(0);sn(25,"BULL 25","BULL"),Pt(!1)},children:"25"}),e.jsx("button",{className:"btn",disabled:Be>=3,onClick:()=>{if(!Xn||!ie||Rt==="MISS"||We===0){const d=kn+1;It(d),d>=5&&cn(!0)}else It(0);sn(50,"INNER_BULL 50","INNER_BULL"),Pt(!1)},children:"50"})]}),e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx("input",{className:"input w-full max-w-sm",list:"manual-quick-list",placeholder:"Type or select (e.g., D16, T20, S5)",value:xa,onChange:d=>ec(d.target.value.toUpperCase()),onKeyDown:d=>{if(d.key==="Enter"){const v=xa.match(/^(S|D|T)(\d{1,2})$/);v&&Na(parseInt(v[2],10),v[1])}}}),e.jsx("datalist",{id:"manual-quick-list",children:["D","S","T"].map(d=>Array.from({length:20},(v,R)=>R+1).map(v=>e.jsx("option",{value:`${d}${v}`},`${d}${v}`)))}),e.jsx("button",{className:"btn",disabled:!xa||Be>=3,onClick:()=>{const d=xa.match(/^(S|D|T)(\d{1,2})$/);if(!d)return;const v=d[1],R=parseInt(d[2],10);Na(R,v)},children:"Add"})]})]})]})]})})]})})}),sc&&e.jsx("div",{className:"fixed inset-0 bg-black/60 z-[100] flex items-center justify-center",children:e.jsx(Bn,{returnFocus:!0,children:e.jsxs("div",{className:"card w-full max-w-4xl relative text-left bg-[#2d2250] text-white p-6 rounded-xl shadow-xl",role:"dialog","aria-modal":"true",children:[e.jsx("button",{className:"absolute top-2 right-2 btn px-2 py-1 bg-purple-500 text-white font-bold",onClick:()=>wi(!1),"aria-label":"Close scoring dialog",children:"Close"}),e.jsx("h2",{className:"text-xl font-bold mb-4 flex items-center gap-2 text-white",children:"Scoring"}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"bg-black/30 rounded-2xl p-4",children:[e.jsx("h2",{className:"text-lg font-semibold mb-3",children:"Camera"}),e.jsxs(vo,{storageKey:"ndn:camera:size:modal",className:"relative rounded-2xl overflow-hidden bg-black",defaultWidth:480,defaultHeight:360,minWidth:360,minHeight:270,maxWidth:800,maxHeight:600,children:[e.jsx(Ii,{}),(()=>{const v=(pe.getState().cameraFitMode||"fit")==="fit"?"absolute inset-0 w-full h-full object-contain object-center bg-black ndn-video-smooth":"absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 min-w-full min-h-full w-auto h-auto object-cover object-center bg-black ndn-video-smooth",R=()=>e.jsxs("div",{className:"relative w-full aspect-[4/3] bg-black",children:[e.jsx("video",{ref:_e,className:v,style:videoStyle,playsInline:!0,muted:!0,autoPlay:!0}),e.jsx("canvas",{ref:he,className:"absolute inset-0 w-full h-full",onClick:er}),e.jsxs("div",{className:"absolute top-2 left-1/2 -translate-x-1/2 z-20 flex items-center gap-3","aria-label":`Visit status: ${Ve[0]?Ve[0].value>0?"hit":"miss":"pending"}, ${Ve[1]?Ve[1].value>0?"hit":"miss":"pending"}, ${Ve[2]?Ve[2].value>0?"hit":"miss":"pending"}`,children:[[0,1,2].map(J=>{const ne=Ve[J],q=!ne,ve=!!ne&&(typeof ne.value=="number"?ne.value>0:!0),ke=q?"bg-gray-500/70":ve?"bg-emerald-400":"bg-rose-500";return e.jsx("span",{className:`w-3 h-3 rounded-full shadow ${ke}`},J)}),Os&&gs!==null&&e.jsxs("span",{className:"px-2 py-0.5 rounded bg-black/60 text-white text-xs font-semibold",children:[Math.max(0,gs),"s"]})]}),mt&&qe?e.jsx("div",{className:"absolute bottom-3 left-1/2 -translate-x-1/2 z-20 bg-black/70 text-amber-200 text-xs font-semibold px-3 py-1 rounded-full shadow",children:"Remove darts to continue"}):null]});return Ae?Y?R():e.jsx("div",{className:"w-full h-full flex flex-col items-center justify-center bg-gradient-to-br from-blue-900/50 to-purple-900/50",children:e.jsxs("div",{className:"text-center space-y-3 max-w-xs mx-auto",children:[e.jsx("div",{className:"text-2xl font-semibold",children:"CAM"}),e.jsx("div",{className:"text-lg font-semibold text-blue-100",children:"Phone camera selected"}),e.jsx("p",{className:"text-sm text-slate-300",children:"Start streaming from the Calibrator tab or reconnect below."}),e.jsxs("div",{className:"flex items-center justify-center gap-2 flex-wrap",children:[e.jsx("button",{className:"btn bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 text-sm",onClick:Fs,children:"Reconnect Phone"}),e.jsx("button",{className:"btn bg-slate-700 hover:bg-slate-800 text-white px-3 py-1 text-sm",onClick:()=>{try{K.setShowOverlay?.(!0)}catch{}},children:"Show Overlay"}),e.jsx("button",{className:"btn bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-1 text-sm",onClick:Us,disabled:!Me.length,children:"Use Local Camera"})]})]})}):R()})()]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2 mt-3",children:[Ae?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:`text-sm px-3 py-2 rounded border flex-1 min-w-[200px] ${Y?"bg-emerald-500/10 border-emerald-400/40 text-emerald-100":"bg-amber-500/10 border-amber-400/40 text-amber-100"}`,children:Y?"ðŸ“± Phone camera stream active":"ðŸ“± Waiting for phone camera stream"}),e.jsx("button",{className:"btn bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 text-sm",onClick:Fs,children:"Reconnect Phone"}),e.jsx("button",{className:"btn bg-slate-700 hover:bg-slate-800 text-white px-3 py-1 text-sm",onClick:()=>{try{K.setShowOverlay?.(!K.showOverlay)}catch{}},children:K.showOverlay?"Hide Overlay":"Show Overlay"}),e.jsx("button",{className:"btn bg-rose-600 hover:bg-rose-700 text-white px-3 py-1 text-sm",disabled:!Y,onClick:()=>{try{K.clearSession?.()}catch{}},children:"Stop Phone Feed"}),Ti&&e.jsx("button",{className:"btn bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-1 text-sm",onClick:Us,disabled:!Me.length,children:"Use Local Camera"})]}):e.jsx(e.Fragment,{children:Ee?e.jsx("button",{className:"btn bg-gradient-to-r from-rose-600 to-rose-700 text-white font-bold",onClick:ya,children:"Stop Camera"}):e.jsx("button",{className:"btn bg-gradient-to-r from-purple-500 to-purple-700 text-white font-bold",onClick:xn,children:"Connect Camera"})}),e.jsx("button",{className:"btn bg-gradient-to-r from-indigo-500 to-indigo-700 text-white font-bold",onClick:Mi,disabled:!Q,children:"Capture Still"}),e.jsx("button",{className:"btn bg-gradient-to-r from-slate-600 to-slate-800 text-white font-bold",disabled:!Q,onClick:()=>{_n.current=null,Ei(d=>d+1)},children:"Reset Autoscore Background"}),e.jsx("button",{className:"btn bg-gradient-to-r from-slate-500 to-slate-700 text-white font-bold",onClick:()=>{try{window.dispatchEvent(new Event("ndn:camera-reset"))}catch{}},children:"Reset Camera Size"})]})]}),e.jsxs("div",{className:"bg-black/30 rounded-2xl p-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx("h2",{className:"text-lg font-semibold",children:"Pending Visit"}),e.jsxs("div",{className:"flex items-center gap-2 text-xs opacity-80 ml-auto",children:[e.jsx("span",{className:`inline-block w-2.5 h-2.5 rounded-full ${z?"bg-emerald-400":"bg-rose-500"}`}),e.jsx("span",{children:z?"Cal OK":"Cal invalid"})]})]}),e.jsx("div",{className:"text-sm opacity-80 mb-2",children:"Up to 3 darts per visit."}),e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[[0,1,2].map(d=>{const v=Ve[d],R=!v,J=!!v&&(typeof v.value=="number"?v.value>0:!0),ne=R?"bg-gray-500/70":J?"bg-emerald-400":"bg-rose-500";return e.jsx("span",{className:`w-2.5 h-2.5 rounded-full shadow ${ne}`},d)}),Os&&gs!==null&&e.jsxs("span",{className:"ml-2 px-2 py-0.5 rounded bg-black/40 text-white text-xs font-semibold",children:[Math.max(0,gs),"s"]})]}),e.jsx("ul",{className:"text-sm mb-2 list-disc pl-5",children:Ve.length===0?e.jsx("li",{className:"opacity-60",children:"No darts yet"}):Ve.map((d,v)=>e.jsx("li",{children:d.label},v))}),e.jsxs("div",{className:"flex items-center gap-4 mb-2",children:[e.jsxs("div",{className:"font-semibold",children:["Darts: ",Be,"/3"]}),e.jsxs("div",{className:"font-semibold",children:["Total: ",Xt]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{className:"btn bg-gradient-to-r from-purple-500 to-purple-700 text-white font-bold",onClick:oc,disabled:Be===0,children:"Undo Dart"}),e.jsx("button",{className:"btn bg-gradient-to-r from-emerald-500 to-emerald-700 text-white font-bold",onClick:Li,disabled:Be===0||O,"data-testid":"commit-visit-btn",children:"Commit Visit"}),e.jsx("button",{className:"btn bg-gradient-to-r from-slate-500 to-slate-700 text-white font-bold",onClick:Gl,disabled:Be===0,children:"Clear"})]})]})]})]})})}),tc&&e.jsx("div",{className:"fixed inset-0 bg-black/60 z-50 flex items-center justify-center",children:e.jsxs("div",{className:"card max-w-md w-full relative text-left bg-[#2d2250] text-white p-6 rounded-xl shadow-xl",children:[e.jsx("button",{className:"absolute top-2 right-2 btn px-2 py-1 bg-purple-500 text-white font-bold",onClick:()=>{cn(!1),It(0)},children:"Close"}),e.jsx("h3",{className:"text-xl font-bold mb-2 flex items-center gap-2 text-white",children:"Recalibration Recommended"}),e.jsx("div",{className:"mb-4 text-lg font-semibold text-indigo-200",children:"We detected 3 incorrect autoscores in a row. You can recalibrate now or reset calibration and try again."}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{className:"btn bg-gradient-to-r from-purple-500 to-purple-700 text-white font-bold",onClick:rc,children:"Go to Calibrate"}),e.jsx("button",{className:"btn bg-gradient-to-r from-slate-500 to-slate-700 text-white font-bold",onClick:ic,children:"Reset Calibration"}),e.jsx("button",{className:"btn bg-gradient-to-r from-slate-500 to-slate-700 text-white font-bold",onClick:()=>{cn(!1),It(0)},children:"Dismiss"})]})]})})]}),Oi=ac();return i&&Oi?Oi:lc});let Gm=1;const Fr=Vn(t=>({toasts:[],push:(n,s)=>t(a=>{const r=Gm++,i={id:r,message:n,type:s?.type||"info",timeout:s?.timeout??3e3,actionLabel:s?.actionLabel,onAction:s?.onAction};return i.timeout&&i.timeout>0&&setTimeout(()=>{t(l=>({toasts:l.toasts.filter(u=>u.id!==r)}))},i.timeout),{toasts:[...a.toasts,i]}}),remove:n=>t(s=>({toasts:s.toasts.filter(a=>a.id!==n)})),clear:()=>t({toasts:[]})}));function oi(){return Fr(n=>n.push)}function Ym(){const t=Fr(s=>s.toasts),n=Fr(s=>s.remove);return t.length?e.jsxs(e.Fragment,{children:[t.filter(s=>s.type==="success").map(s=>e.jsx("div",{className:"fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-50",children:e.jsx("div",{className:"p-4 rounded-lg shadow-lg border text-sm bg-emerald-700/90 border-emerald-500/60 text-white max-w-sm text-center",children:e.jsx("div",{className:"flex items-center justify-center gap-2",children:e.jsx("span",{className:"flex-1 font-semibold",children:s.message})})})},s.id)),t.filter(s=>s.type!=="success").length>0&&e.jsx("div",{className:"fixed bottom-4 right-4 z-50 space-y-2 sm:right-4 sm:left-auto left-1/2 -translate-x-1/2 sm:translate-x-0 w-[calc(100%-1.5rem)] sm:w-auto max-w-sm",children:t.filter(s=>s.type!=="success").map(s=>e.jsx("div",{className:`p-3 rounded-lg shadow-lg border text-sm ${s.type==="error"?"bg-rose-700/80 border-rose-500/60 text-white":"bg-black/70 border-slate-700 text-slate-100"}`,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"flex-1",children:s.message}),s.actionLabel&&typeof s.onAction=="function"?e.jsx("button",{className:"btn px-2 py-1 text-xs bg-slate-200/10 hover:bg-slate-200/20",onClick:()=>{try{s.onAction?.()}catch{}n(s.id)},children:s.actionLabel}):null,e.jsx("button",{className:"btn btn--ghost px-2 py-1 text-xs",onClick:()=>n(s.id),children:"Dismiss"})]})},s.id))})]}):null}function Jm({data:t,height:n=220,barWidth:s=28,gap:a=6,showValues:r=!1}){const i=Math.max(1,...t.map(u=>u.value)),l=t.length*(s+a);return e.jsx("div",{className:"w-full overflow-x-auto",children:e.jsx("div",{className:"relative",style:{height:n,width:Math.max(600,l)},children:e.jsx("div",{className:"absolute inset-0 flex items-end",children:t.map((u,f)=>{const c=Math.round(u.value/i*(n-40));return e.jsxs("div",{className:"flex flex-col items-center justify-end",style:{width:s,marginRight:a},children:[e.jsx("div",{className:"w-full rounded-t-md bg-gradient-to-b from-indigo-400 to-fuchsia-500 shadow-sm",style:{height:c},title:`${u.label}: ${u.value}`}),r&&e.jsx("div",{className:"text-sm mt-1 text-indigo-200 font-semibold",children:u.value}),e.jsx("div",{className:"text-sm mt-1 text-slate-200 font-medium select-none",children:u.label})]},f)})})})})}function Xm({tabs:t,active:n,onChange:s,className:a}){return e.jsxs("div",{className:`relative ${a||""}`,children:[e.jsx("div",{className:"absolute inset-0 rounded-xl bg-white/5 backdrop-blur-md border border-white/10 pointer-events-none"}),e.jsx("div",{className:"relative overflow-x-auto no-scrollbar py-1 px-1",children:e.jsx("div",{className:"flex items-center gap-2 min-w-max",children:t.map(r=>{const i=r.key===n;return e.jsx("button",{type:"button",onPointerDown:l=>{l.stopPropagation()},onMouseDown:l=>{l.stopPropagation()},onTouchStart:l=>{l.stopPropagation?.()},onClick:()=>s(r.key),className:`transition-all select-none whitespace-nowrap rounded-full px-4 py-2 text-sm font-semibold shadow-sm focus:outline-none focus-visible:ring-2 focus-visible:ring-white/60 active:scale-[0.98]
                  ${i?"bg-gradient-to-r from-indigo-500 to-fuchsia-500 text-white shadow-indigo-500/30":"bg-white/10 text-slate-100 hover:bg-white/15"}
                `,"aria-pressed":i,children:r.label.includes("ðŸŽ¯")?r.label:`${r.label} ðŸŽ¯`},r.key)})})}),e.jsx("style",{children:`
        /* Hide scrollbars on WebKit/Firefox for a cleaner pill row */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
      `})]})}const Km=["X01","Double Practice"],Qm=["Around the Clock","Cricket","Halve It","Shanghai","High-Low","Killer","Bob's 27","Count-Up","High Score","Low Score","Checkout 170","Checkout 121","Treble Practice","Baseball","Golf","Tic Tac Toe","American Cricket","Scam","Fives","Sevens"],No=[...Km,...Qm],li={X01:{startOptions:[301,501,701],modeOptions:["bestof","firstto"],modeValueOptions:{bestof:[1,3,5,7],firstto:[1,2,3,4,5,6]}},"Double Practice":{startOptions:[],modeOptions:["practice"],modeValueOptions:{practice:[30,60,120]}},"Around the Clock":{startOptions:[],modeOptions:["bestof","firstto"],modeValueOptions:{bestof:[1,3,5],firstto:[1,2,3,4]}},Cricket:{startOptions:[],modeOptions:["bestof","firstto","rounds"],modeValueOptions:{bestof:[1,3,5],firstto:[1,2,3,4],rounds:[1,3,5]}},"Halve It":{startOptions:[],modeOptions:["bestof","firstto"],modeValueOptions:{bestof:[1,3,5],firstto:[1,2,3,4]}},Shanghai:{startOptions:[],modeOptions:["bestof","firstto"],modeValueOptions:{bestof:[1,3,5],firstto:[1,2,3,4]}},"High-Low":{startOptions:[],modeOptions:["bestof","firstto"],modeValueOptions:{bestof:[1,3,5],firstto:[1,2,3,4]}},Killer:{startOptions:[],modeOptions:["bestof","firstto"],modeValueOptions:{bestof:[1,3,5],firstto:[1,2,3,4]}},"Bob's 27":{startOptions:[],modeOptions:["bestof","firstto"],modeValueOptions:{bestof:[1,3,5],firstto:[1,2,3,4]}},"Count-Up":{startOptions:[],modeOptions:["bestof","firstto"],modeValueOptions:{bestof:[1,3,5],firstto:[1,2,3,4]}},"High Score":{startOptions:[],modeOptions:["bestof","firstto"],modeValueOptions:{bestof:[1,3,5],firstto:[1,2,3,4]}},"Low Score":{startOptions:[],modeOptions:["bestof","firstto"],modeValueOptions:{bestof:[1,3,5],firstto:[1,2,3,4]}},"Checkout 170":{startOptions:[],modeOptions:["bestof","firstto"],modeValueOptions:{bestof:[1,3,5],firstto:[1,2,3,4]}},"Checkout 121":{startOptions:[],modeOptions:["bestof","firstto"],modeValueOptions:{bestof:[1,3,5],firstto:[1,2,3,4]}},"Treble Practice":{startOptions:[],modeOptions:["practice"],modeValueOptions:{practice:[30,60,120]}},Baseball:{startOptions:[],modeOptions:["bestof","innings"],modeValueOptions:{bestof:[1,3,5],innings:[1,3,5,9]}},Golf:{startOptions:[],modeOptions:["holes","bestof"],modeValueOptions:{holes:[9,18],bestof:[1,3,5]}},"Tic Tac Toe":{startOptions:[],modeOptions:["bestof","firstto"],modeValueOptions:{bestof:[1,3,5],firstto:[1,2,3,4]}},"American Cricket":{startOptions:[],modeOptions:["bestof","firstto"],modeValueOptions:{bestof:[1,3,5],firstto:[1,2,3,4]}},Scam:{startOptions:[],modeOptions:["bestof","firstto"],modeValueOptions:{bestof:[1,3,5],firstto:[1,2,3,4]}},Fives:{startOptions:[],modeOptions:["bestof","firstto"],modeValueOptions:{bestof:[1,3,5],firstto:[1,2,3,4]}},Sevens:{startOptions:[],modeOptions:["bestof","firstto"],modeValueOptions:{bestof:[1,3,5],firstto:[1,2,3,4]}}};function Gf(t){return t==="all"?[301,501,701]:li[t]?.startOptions??[]}function Zm(t){if(t==="all")return["all","bestof","firstto"];const n=li[t];return n?["all",...n.modeOptions]:["all","bestof","firstto"]}function eh(t,n){return t==="all"||n==="all"?[]:li[t]?.modeValueOptions?.[n]??[]}function Pa(t){if(!t)return"";switch(t){case"all":return"All Modes";case"bestof":return"Best of";case"firstto":return"First to";case"innings":return"Innings";case"holes":return"Holes";case"rounds":return"Rounds";case"practice":return"Practice";case"none":return"Mode";default:return String(t).replace(/[-_]/g," ").replace(/\b\w/g,n=>n.toUpperCase())}}const th={},nh=th?.VITE_REMOTE_WS_FALLBACK||"",sh="wss://ninedartnation-1.onrender.com/ws",Ks=Pl(nh.trim()||sh),ah=new Set(["localhost","127.0.0.1"]),Al=8787,rh=3e3;function Pl(t){const n=t.trim();return n?/\/ws$/i.test(n)?n:`${n.replace(/\/$/,"")}/ws`:""}function ih(t){if(!t)return null;try{return new URL(t).hostname.toLowerCase()}catch{return null}}function Sr(t){return!!t&&ah.has(t)}let an=null;function oh(){if(an)return an;const t="ws://localhost:8787".trim();if(t){const n=Pl(t);if(typeof window<"u"){const s=ih(n),a=window.location.hostname;if(Sr(s)&&!Sr(a))return an=Ks,an}return an=n,an}if(typeof window<"u"){const n=window.location.protocol==="https:"?"wss":"ws",s=window.location.hostname,a=`${n}://${window.location.host}/ws`;return Sr(s)?an=`${n}://${s}:${Al}/ws`:s.endsWith("onrender.com")?an=a:(s.endsWith("netlify.app"),an=Ks),an}return an=Ks,an}function Ur(){return oh()}function lh(){if(typeof window>"u")return[Ur()];const t=window.location.protocol==="https:"?"wss":"ws",n=window.location.hostname,s=window.location.host,a=Ur(),r=new Set([a,`${t}://${s}/ws`,`${t}://${n}/ws`,`${t}://${n}:${Al}/ws`,`${t}://${n}:${rh}/ws`,Ks]);return Array.from(r).filter(Boolean)}const Ll=o.createContext(null);function ch({children:t}){const[n,s]=o.useState(!1),[a,r]=o.useState("connecting"),i=o.useRef(null),l=o.useRef(new Set),u=o.useRef(!0),f=o.useRef(0),c=o.useRef(null),m=o.useRef(null),p=o.useRef(null),h=o.useRef(0),N=()=>(p.current||(p.current=lh()),p.current),w=()=>{const I=N();return h.current=(h.current+1)%I.length,I[h.current]},b=()=>{const I=N();return I[h.current]||I[0]},g=o.useCallback(()=>{if(i.current&&(i.current.readyState===WebSocket.OPEN||i.current.readyState===WebSocket.CONNECTING))return;r("connecting");const k=`${b()}`,T=new WebSocket(k);i.current=T,T.onopen=()=>{s(!0),r("connected"),f.current=0,m.current&&clearInterval(m.current),m.current=setInterval(()=>{try{i.current?.readyState===WebSocket.OPEN&&i.current?.send(JSON.stringify({type:"ping",t:Date.now()}))}catch{}},2e4)},T.onmessage=E=>{try{const V=JSON.parse(E.data);l.current.forEach(H=>{try{H(V)}catch{}})}catch{}},T.onerror=()=>{},T.onclose=()=>{if(s(!1),r("disconnected"),m.current&&(clearInterval(m.current),m.current=null),!u.current)return;const E=(f.current||0)+1;f.current=E,E%2===0&&w();const V=1e3*Math.pow(2,E-1),H=Math.floor(Math.random()*1e3);let $=Math.min(3e4,V+H);E===1&&($=0),c.current&&clearTimeout(c.current),$===0?g():c.current=setTimeout(g,$)}},[]),y=o.useCallback(()=>{try{u.current=!1,c.current&&(clearTimeout(c.current),c.current=null),m.current&&(clearInterval(m.current),m.current=null);try{i.current?.close()}catch{}i.current=null}catch{}f.current=0,u.current=!0,r("connecting"),s(!1),g()},[g]);o.useEffect(()=>{u.current=!0,g();const I=()=>{u.current=!1;try{i.current?.close()}catch{}};window.addEventListener("beforeunload",I);const k=()=>{document.visibilityState==="visible"&&(n||g())};return document.addEventListener("visibilitychange",k),window.addEventListener("online",g),()=>{u.current=!1,c.current&&clearTimeout(c.current),m.current&&clearInterval(m.current);try{i.current?.close()}catch{}document.removeEventListener("visibilitychange",k),window.removeEventListener("online",g),window.removeEventListener("beforeunload",I)}},[g]);const M=o.useCallback(I=>{try{i.current&&i.current.readyState===WebSocket.OPEN&&i.current.send(typeof I=="string"?I:JSON.stringify(I))}catch{}},[]),L=o.useCallback(I=>(l.current.add(I),()=>{l.current.delete(I)}),[]),S=o.useMemo(()=>({connected:n,status:a,send:M,addListener:L,reconnect:y}),[n,a,M,L,y]);return e.jsx(Ll.Provider,{value:S,children:t})}function la(){const t=o.useContext(Ll);if(!t)throw new Error("useWS must be used within WSProvider");return t}function dh(){const t=vn(),n=t.getMediaStream?.(),s=t.getVideoElementRef(),a=!!(n||s?.srcObject),r=t.isStreaming&&a,i=r?"Camera Active":"Camera Offline";o.useEffect(()=>{},[r]);const l=()=>{try{window.dispatchEvent(new CustomEvent("ndn:toggle-phone-overlay"))}catch{}};return e.jsxs("button",{type:"button",onClick:l,className:"relative inline-flex items-center gap-2 rounded-lg border border-white/15 bg-white/5 hover:bg-white/10 transition-colors shadow-sm px-3 py-1 text-xs",title:r?"Camera connected âœ… â€“ click to toggle overlay":"Camera not connected âŒ",children:[e.jsx("span",{className:"font-mono text-[0.75rem]",children:Xs("camera")}),e.jsx("span",{className:"hidden xs:inline text-slate-100 select-none",children:i}),e.jsx("span",{className:`ml-2 w-2 h-2 rounded-full shrink-0 ${r?"bg-emerald-400":"bg-rose-400"}`,"aria-hidden":!0})]})}const So={calibration:{keywords:["calibration","calibrate","camera","score","accuracy","aim","setup"],title:"How Calibration Works",explanation:`Calibration helps our AI precisely detect where your darts land on the board. Here's how it works:

1. **D20**: Click on the 20 segment to calibrate that area
2. **D6**: Click on the 6 segment to calibrate that area
3. **D3**: Click on the 3 segment to calibrate that area
4. **D11**: Click on the 11 segment to calibrate that area
5. **Bullseye**: Click on the bullseye to calibrate the center

Each click teaches the system about your board's position and angle. After calibrating all areas, your scoring will be much more accurate!`,actions:[{id:"D20",label:"ðŸ“ Click D20",color:"bg-blue-600"},{id:"D6",label:"ðŸ“ Click D6",color:"bg-purple-600"},{id:"D3",label:"ðŸ“ Click D3",color:"bg-pink-600"},{id:"D11",label:"ðŸ“ Click D11",color:"bg-cyan-600"},{id:"Bullseye",label:"ðŸŽ¯ Click Bullseye",color:"bg-yellow-600"}]},scoring:{keywords:["score","points","counting","how do i score","scoring system"],title:"Dart Scoring",explanation:`In darts, each segment on the board has a value:
- Single areas: Face value (1-20)
- Double ring (outer): 2Ã— the segment number
- Triple ring (inner): 3Ã— the segment number
- Bullseye: 50 points
- Bull (outer bull): 25 points

For example: hitting Triple 20 = 60 points, Double 10 = 20 points`},gameplay:{keywords:["game","how to play","rules","x01","cricket","match","round"],title:"How to Play",explanation:`Nine Dart Nation supports multiple game modes:

**X01** (501, 301, 701): Start from the set score and count down to exactly 0. Final dart must be on a double.

**Cricket**: Players try to "close" numbers 15-20 and bullseye by hitting them. First to close all and have the highest score wins.

**Killer**: Players mark their "number" and try to knock out other players' lives.

Select your game mode when creating a match, and follow the on-screen instructions!`},premium:{keywords:["premium","subscription","features","upgrade","cost","paid"],title:"Premium Features",explanation:`Our Premium subscription gives you:
- Tournament creation and entry
- Advanced statistics and replays
- Priority matchmaking
- Custom profiles and themes
- Ad-free experience

Premium grants are often awarded as tournament prizes!`},connection:{keywords:["connection","disconnect","lag","latency","websocket","error","offline"],title:"Connection Issues",explanation:`If you're experiencing connection issues:
1. Check your internet connection
2. Refresh the page (Ctrl+R or Cmd+R)
3. Clear browser cache
4. Try a different browser
5. Check if the site status page shows any issues

Most connection issues resolve in seconds. Contact admin if problems persist.`},camera:{keywords:["camera","phone camera","mobile","video","pairing","connect"],title:"Camera Setup",explanation:`To use our phone camera feature:
1. Open Nine Dart Nation on your phone
2. Go to Settings > Camera Pairing
3. Scan the QR code or enter the pairing code
4. Position your phone to capture the dartboard
5. Run calibration (see calibration help for details)

Your phone will now act as a live dartboard camera!`},tournament:{keywords:["tournament","compete","bracket","prize","winner","playoffs"],title:"Tournaments",explanation:`Tournaments are competitive events where you can:
- Play against other skilled players
- Win prizes (Premium subscriptions or cash)
- Climb leaderboards
- Compete in structured brackets

Check the Tournaments tab to see upcoming events. Registration typically opens 30 minutes before start time.`}};function uh(t){const n=t.toLowerCase();for(const[,s]of Object.entries(So))for(const a of s.keywords)if(n.includes(a))return{type:"explanation",title:s.title,message:s.explanation,actions:s.actions,followUp:"Do you need further assistance? I can connect you with an admin if needed."};return{type:"suggestion",title:"Need More Help?",message:`I couldn't find a specific answer to your question. Common topics I can help with:

${Object.values(So).map(s=>`Â· ${s.title}`).join(`
`)}

Or I can connect you with an admin who can help further.`,followUp:"Would you like to speak with an admin?"}}function mh(){const t=new Date().getHours();return t>=20||t<7?"20-30 minutes (off-peak hours)":t>=12&&t<14?"10-15 minutes (moderate traffic)":t>=18&&t<20?"15-20 minutes (peak hours)":"5-10 minutes"}function Ol({request:t,user:n,onClose:s}){const a=(()=>{try{return la()}catch{return null}})(),[r,i]=o.useState(t?.messages||[]),[l,u]=o.useState(""),[f,c]=o.useState({}),[m,p]=o.useState(!1),[h,N]=o.useState(""),w=o.useRef(null),b=o.useRef(null),g=o.useRef([]);o.useEffect(()=>{if(!a)return;const S=a.addListener(I=>{try{if(I?.type==="help-message"&&String(I.requestId)===String(t.id)&&i(k=>[...k,I.message]),I?.type==="help-request-updated"&&I.request?.id===t.id&&(i(I.request.messages||[]),p(!!I.request.claimedBy)),I?.type==="help-typing"&&String(I.requestId)===String(t.id)){const k=I.fromName||I.fromEmail||(I.admin?"admin":"user");c(T=>({...T,[k]:Date.now()}))}}catch{}});return()=>{S()}},[a,t?.id]);const y=()=>{if(!l.trim())return;const S=l,I={type:"help-message",requestId:t.id,message:S};try{a?.send(I)}catch{}const k={fromEmail:n?.email||null,fromName:n?.username||null,message:S,ts:Date.now(),admin:!1};if(i(T=>[...T,k]),u(""),!m){const T=window.setTimeout(()=>{const E=uh(S);if(E){const V={fromName:"AI Assistant",message:`${E.title}

${E.message}`,ts:Date.now(),admin:!0,actions:E.actions,followUp:E.followUp};i(H=>[...H,V])}},500);g.current.push(T)}},M=S=>{if(!S){const T={fromName:"You",message:"No, I think I have it now. Thanks!",ts:Date.now(),admin:!1};i(V=>[...V,T]);const E=window.setTimeout(()=>{const V={fromName:"AI Assistant",message:"âœ“ Great! Glad I could help. Feel free to reach out anytime you need assistance.",ts:Date.now(),admin:!0};i(H=>[...H,V])},300);g.current.push(E);return}const I={fromName:"You",message:"Yes, I need to speak with an admin",ts:Date.now(),admin:!1};i(T=>[...T,I]);try{a?.send({type:"help-escalate",requestId:t.id})}catch{}N(mh());const k=window.setTimeout(()=>{const T={fromName:"System",message:`â³ Connecting you with an admin...

ðŸ“Š Estimated wait time: ${h}

An admin will be with you shortly. Please stay on this chat.`,ts:Date.now(),admin:!0};i(E=>[...E,T])},500);g.current.push(k)};o.useEffect(()=>{if(w.current)try{w.current.scrollTop=w.current.scrollHeight}catch{}},[r]);const L=o.useCallback(()=>{try{a?.send({type:"help-typing",requestId:t.id,fromName:n?.username,fromEmail:n?.email,admin:!!n?.isAdmin})}catch{}b.current&&clearTimeout(b.current),b.current=window.setTimeout(()=>{c(S=>{const I={...S};return delete I[n?.username||n?.email||"me"],I})},3e3)},[a,t.id,n]);return o.useEffect(()=>()=>{b.current&&clearTimeout(b.current);for(const S of g.current)clearTimeout(S);g.current=[]},[]),e.jsxs("div",{className:"fixed inset-0 z-50 flex items-end justify-center p-4",children:[e.jsx("div",{className:"absolute inset-0 bg-black/40",onClick:s}),e.jsxs("div",{className:"relative w-full max-w-2xl bg-slate-900 rounded-lg shadow-xl overflow-hidden flex flex-col max-h-[80vh]",children:[e.jsxs("div",{className:"flex items-center justify-between p-3 border-b border-slate-700 bg-slate-800",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"font-semibold flex items-center gap-2",children:[e.jsx(Wi,{className:"w-4 h-4 text-yellow-400"}),"Help Desk â€” ",t.username||"Anonymous"]}),m&&e.jsx("span",{className:"text-xs px-2 py-1 rounded bg-emerald-600",children:"Admin Connected"})]}),e.jsx("button",{"aria-label":"Close",className:"px-2 py-1 rounded bg-neutral-700 hover:bg-neutral-600 text-sm",onClick:s,children:e.jsx(Vr,{className:"w-4 h-4"})})]}),e.jsxs("div",{ref:w,className:"flex-1 overflow-y-auto p-3 space-y-3 bg-black/20",children:[r.map((S,I)=>e.jsx("div",{children:e.jsxs("div",{className:`max-w-[85%] px-3 py-2 rounded ${S.admin?"bg-emerald-600/20 border border-emerald-500/40 text-emerald-100 ml-auto":"bg-slate-700 text-slate-100"}`,children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsxs("div",{className:"text-xs opacity-70 font-semibold flex items-center gap-1",children:[S.admin?e.jsx(Wi,{className:"w-3 h-3"}):e.jsx(Ua,{className:"w-3 h-3"}),S.fromName||S.fromEmail||(S.admin?"AI Assistant":"You")]}),e.jsx("div",{className:"text-xs opacity-50 ml-2",children:S.ts?new Date(S.ts).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):""})]}),e.jsx("div",{className:"whitespace-pre-wrap break-words text-sm",children:S.message}),S.actions&&S.actions.length>0&&e.jsxs("div",{className:"mt-3 space-y-2",children:[e.jsx("div",{className:"text-xs font-semibold opacity-80",children:"ðŸ“ Try these calibration points:"}),e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-5 gap-2",children:S.actions.map(k=>e.jsx("button",{className:`${k.color} text-white text-xs py-2 px-2 rounded font-medium hover:opacity-90 transition-opacity`,onClick:()=>{const T={fromName:"You",message:`Clicked: ${k.label}`,ts:Date.now(),admin:!1};i(E=>[...E,T]);try{a?.send({type:"help-message",requestId:t.id,message:`User clicked: ${k.id}`})}catch{}},children:k.label},k.id))})]}),S.followUp&&!m&&e.jsxs("div",{className:"mt-3 space-y-2",children:[e.jsx("div",{className:"text-xs opacity-80",children:S.followUp}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{className:"flex-1 bg-emerald-600 hover:bg-emerald-700 text-white text-xs py-2 px-3 rounded font-medium transition-colors",onClick:()=>M(!0),children:"âœ… Yes, connect me"}),e.jsx("button",{className:"flex-1 bg-slate-600 hover:bg-slate-700 text-white text-xs py-2 px-3 rounded font-medium transition-colors",onClick:()=>M(!1),children:"âŒ No thanks"})]})]})]})},I)),Object.keys(f).length>0&&e.jsxs("div",{className:"text-xs text-slate-300 opacity-80 flex items-center gap-2",children:[e.jsxs("span",{children:[Object.keys(f).join(", ")," typing"]}),e.jsxs("span",{className:"flex gap-1",children:[e.jsx("span",{className:"w-1 h-1 bg-slate-300 rounded-full animate-bounce"}),e.jsx("span",{className:"w-1 h-1 bg-slate-300 rounded-full animate-bounce delay-100"}),e.jsx("span",{className:"w-1 h-1 bg-slate-300 rounded-full animate-bounce delay-200"})]})]})]}),e.jsxs("div",{className:"p-3 border-t border-slate-700 bg-slate-800 flex gap-2",children:[e.jsx("input",{className:"input flex-1 text-sm",value:l,onChange:S=>{u(S.target.value),L()},onKeyDown:S=>{S.key==="Enter"&&!S.shiftKey&&(S.preventDefault(),y())},placeholder:"Ask a question (e.g., 'How does calibration work?')..."}),e.jsx("button",{"aria-label":"Send message",className:"btn bg-blue-600 hover:bg-blue-700 text-white",onClick:y,children:e.jsx(Hr,{className:"w-4 h-4"})})]})]})]})}const hh="daviesfamily108@gmail.com";function fh({user:t}){const n=(()=>{try{return la()}catch{return null}})(),[s,a]=o.useState([]),[r,i]=o.useState(""),[l,u]=o.useState(""),[f,c]=o.useState("USD"),[m,p]=o.useState(""),[h]=o.useState(null),[N,w]=o.useState(""),[b,g]=o.useState(!1),[y,M]=o.useState([]),[L]=o.useState([]),[S,I]=o.useState(""),[k,T]=o.useState([]),[E,V]=o.useState({title:"Official Tournament",game:"X01",mode:"bestof",value:3,description:"",startAt:new Date(Date.now()+7200*1e3).toISOString().slice(0,16),checkinMinutes:30,capacity:16,prizeType:"premium",prizeAmount:3,currency:"GBP",prizeNotes:""}),[H,$]=o.useState({reset:{},reminder:{},confirmEmail:{},changed:{}}),[ce,me]=o.useState({open:!1}),[xe,we]=o.useState("general"),ye=t?.email?.toLowerCase()===hh,[De]=o.useState([]),[Ue]=o.useState([]),[ge,He]=o.useState([]),[U,P]=o.useState({}),[ee,X]=o.useState(null),[,re]=o.useState([]),[se,je]=o.useState(null),[le,Ne]=o.useState(!1),[Ie,Se]=o.useState(1500),[,Me]=o.useState(!1),G=async()=>{g(!0);try{const x={"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("authToken")}`};(await fetch("/api/admin/tournaments/broadcast",{method:"POST",headers:x})).ok?Te("Tournaments broadcast triggered",{type:"success"}):Te("Broadcast failed",{type:"error"})}catch{Te("Broadcast request failed",{type:"error"})}finally{g(!1)}},[Ce,he]=o.useState(0);o.useEffect(()=>{const x=()=>he(z=>z+1);return window.addEventListener("ndn:stats-updated",x),()=>window.removeEventListener("ndn:stats-updated",x)},[]);const Ee=o.useMemo(()=>kl(No),[Ce]),te=dn(),Te=oi();o.useEffect(()=>{if(!ce.open)return;function x(z){z.key==="Escape"&&me({open:!1})}return document.addEventListener("keydown",x),()=>document.removeEventListener("keydown",x)},[ce.open]);const C=o.useMemo(()=>{const x=te.errorPx??null,z=[];for(const ie of No){const $e=ai(ie,x),Fe=Hu(ie,x);z.push({game:ie,confidence:$e,qualityInfo:Fe})}return z},[te.errorPx]),B=o.useMemo(()=>{const x=[];if(Ee&&typeof Ee=="object")for(const[z,ie]of Object.entries(Ee)){const $e=ie;x.push({label:z,value:$e?.played||0,won:$e?.won||0})}return x},[Ee]);async function A(){try{const x={Authorization:`Bearer ${localStorage.getItem("authToken")}`},[z,ie,$e]=await Promise.all([fetch("/api/admin/help-requests",{headers:x}),fetch("/api/admins",{headers:x}),fetch("/api/tournaments",{headers:x})]);if(z.ok){const Fe=await z.json();He(Array.isArray(Fe)?Fe:Fe.requests||[])}if(ie.ok){const Fe=await ie.json();a(Array.isArray(Fe)?Fe:Fe.admins||[])}if($e.ok){const Fe=await $e.json();M(Array.isArray(Fe)?Fe:Fe.tournaments||Fe)}}catch(x){console.error("refresh failed",x)}}async function W(x){try{await fetch("/api/admins/revoke",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("authToken")}`},body:JSON.stringify({email:x})}),await A()}catch{}}async function ae(x,z){if(x)try{await fetch("/api/admin/premium/grant",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("authToken")}`},body:JSON.stringify({email:x,days:z})}),await A()}catch{}}async function K(x){try{await fetch("/api/admin/premium/revoke",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("authToken")}`},body:JSON.stringify({email:x})}),await A()}catch{}}async function _e(){if(N.trim())try{await fetch("/api/admin/announce",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("authToken")}`},body:JSON.stringify({message:N})}),w(""),await A()}catch{}}async function Ae(x){try{await fetch("/api/admin/maintenance",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("authToken")}`},body:JSON.stringify({maintenance:x})}),await A()}catch{}}o.useEffect(()=>{if(!n)return;const x=n.addListener(ie=>{try{if(ie?.type==="help-typing"){const $e=String(ie.requestId||"");if(!$e)return;P(Fe=>({...Fe,[$e]:{who:ie.fromName||"someone",ts:Date.now()}}));return}if(ie?.type==="help-request"){const $e=ie.request;if(!$e||!$e.id)return;He(Fe=>{const it=(Fe||[]).filter(We=>String(We.id)!==String($e.id));return[$e,...it]});return}ie?.type==="help-request-updated"&&A()}catch{}}),z=setInterval(()=>{const ie=Date.now();let $e=!1;const Fe={...U};for(const it of Object.keys(Fe))ie-Fe[it].ts>3500&&(delete Fe[it],$e=!0);$e&&P(Fe)},1500);return()=>{try{x()}catch{}clearInterval(z)}},[n]);async function ut(x){try{const z={"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("authToken")}`};(await fetch(`/api/admin/help-requests/${encodeURIComponent(x)}/claim`,{method:"POST",headers:z,body:JSON.stringify({})})).ok&&await A()}catch{}}async function _(x){try{const z={"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("authToken")}`};(await fetch(`/api/admin/help-requests/${encodeURIComponent(x)}/resolve`,{method:"POST",headers:z,body:JSON.stringify({})})).ok&&await A()}catch{}}async function Y(){m&&(await fetch("/api/admins/grant",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("authToken")}`},body:JSON.stringify({email:m})}),p(""))}async function Q(){if(S.trim())try{const x={Authorization:`Bearer ${localStorage.getItem("authToken")}`},z=await fetch(`/api/admin/users/search?q=${encodeURIComponent(S)}`,{headers:x});if(z.ok){const ie=await z.json();T(Array.isArray(ie.users)?ie.users:[])}}catch(x){console.error("Search failed:",x)}}async function de(x){try{await fetch("/api/admin/users/ban",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("authToken")}`},body:JSON.stringify({email:x})}),await Q()}catch(z){console.error("Ban failed:",z)}}async function tt(x){try{await fetch("/api/admin/users/unban",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("authToken")}`},body:JSON.stringify({email:x})}),await Q()}catch(z){console.error("Unban failed:",z)}}async function ft(){g(!0);try{const x=new Date(E.startAt).getTime(),z=await fetch("/api/tournaments/create",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:E.title,game:E.game,mode:E.mode,value:Number(E.value),description:E.description,startAt:x,checkinMinutes:Number(E.checkinMinutes),capacity:Number(E.capacity),requireCalibration:!!E.requireCalibration,creatorEmail:t?.email,creatorName:t?.username,requesterEmail:t?.email,official:!0,prizeType:E.prizeType,prizeAmount:Number(E.prizeAmount||0),currency:E.currency,prizeNotes:E.prizeNotes})});await A();try{const ie=await z.json();ie&&ie.tournament&&ie.tournament.id&&window.dispatchEvent(new CustomEvent("ndn:change-tab",{detail:{tab:"tournaments"}}))}catch{}}finally{g(!1)}}async function yt(x,z){g(!0);try{await fetch("/api/admin/tournaments/winner",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("authToken")}`},body:JSON.stringify({tournamentId:x,winnerEmail:z})}),await A()}finally{g(!1)}}async function kt(x){g(!0);try{await fetch("/api/admin/tournaments/mark-paid",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("authToken")}`},body:JSON.stringify({tournamentId:x})}),await A()}finally{g(!1)}}async function lt(x){g(!0);try{await fetch("/api/admin/tournaments/delete",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("authToken")}`},body:JSON.stringify({tournamentId:x})}),await A()}finally{g(!1)}}async function Je(){g(!0);try{await fetch("/api/admin/tournaments/reseed-weekly",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("authToken")}`},body:JSON.stringify({})}),await A()}finally{g(!1)}}async function Hn(x,z){g(!0);try{await fetch("/api/admin/wallet/withdrawals/decide",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("authToken")}`},body:JSON.stringify({id:x,approve:z})}),await A()}finally{g(!1)}}async function yn(x){g(!0);try{await fetch("/api/admin/matches/delete",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("authToken")}`},body:JSON.stringify({matchId:x})}),await A()}finally{g(!1)}}async function Wn(){try{const x={Authorization:`Bearer ${localStorage.getItem("authToken")}`},z=await fetch("/api/admin/logs",{headers:x});if(z.ok){const ie=await z.json();ie?.ok&&re(ie.logs||[])}}catch(x){console.error("Failed to fetch logs:",x)}}async function wn(){try{const x={Authorization:`Bearer ${localStorage.getItem("authToken")}`},z=await fetch("/api/admin/system-health",{headers:x});if(z.ok){const ie=await z.json();ie?.ok&&ie?.health&&(je({database:ie.health.database||!1,websocket:ie.health.websocket||!1,https:ie.health.https||!1,maintenance:ie.health.maintenance||!1,clustering:ie.health.clustering||!1,uptime:ie.health.uptime||0,memory:ie.health.memory||{heapUsed:0},version:ie.health.version||"unknown"}),Ne(ie.health?.clustering||!1))}}catch(x){console.error("Failed to fetch system health:",x)}}async function zn(x){g(!0);try{const ie=await(await fetch("/api/admin/clustering",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("authToken")}`},body:JSON.stringify({enabled:x,maxWorkers:4,capacity:Ie})})).json();console.log("Clustering response:",ie),ie?.ok?(alert(`Clustering ${x?"enabled":"disabled"} successfully. Max capacity: ${Ie.toLocaleString()} concurrent users. NODE_WORKERS environment variable is set to max capacity.`),await wn()):alert(`Failed: ${ie?.error||ie?.message||"Unknown error"}`)}catch(z){console.error("Clustering toggle failed:",z),alert("Clustering toggle failed: "+(z instanceof Error?z.message:String(z)))}finally{g(!1)}}async function qn(x){Se(x)}async function mn(){try{const x={Authorization:`Bearer ${localStorage.getItem("authToken")}`},z=await fetch("/api/admin/email-copy",{headers:x});if(z.ok){const ie=await z.json();ie?.ok&&$(ie.copy||H)}}catch{}}o.useEffect(()=>{ye&&mn()},[ye]),o.useEffect(()=>{ye&&(xe==="general"||xe==="maintenance")&&(Wn(),wn())},[ye,xe]);async function Pn(x,z){await fetch("/api/admin/email-copy",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("authToken")}`},body:JSON.stringify({kind:x,...z})}),await mn()}async function Ln(x,z){try{const ie={Authorization:`Bearer ${localStorage.getItem("authToken")}`},Fe=await(await fetch(`/api/email/preview?kind=${encodeURIComponent(x)}`,{headers:ie})).text();if(z){const it=window.open();if(it){it.document.open(),it.document.write(Fe),it.document.close();return}}me({open:!0,kind:x,html:Fe})}catch{me({open:!0,kind:x,html:'<!doctype html><html><body style="font-family:sans-serif;padding:16px">Failed to load preview.</body></html>'})}}o.useEffect(()=>{if(!ce.open)return;function x(z){z.key==="Escape"&&me({open:!1})}return document.addEventListener("keydown",x),()=>document.removeEventListener("keydown",x)},[ce.open]);function qt({kind:x,label:z}){const $e=H?.[x==="confirm-email"?"confirmEmail":x==="changed"?"changed":x]||{title:"",intro:"",buttonLabel:""},[Fe,it]=o.useState($e.title||""),[We,hn]=o.useState($e.intro||""),[Rt,jn]=o.useState($e.buttonLabel||"");return o.useEffect(()=>{it($e.title||""),hn($e.intro||""),jn($e.buttonLabel||"")},[$e.title,$e.intro,$e.buttonLabel]),e.jsxs("div",{className:"p-2 rounded bg-black/20 space-y-2",children:[e.jsx("div",{className:"font-semibold",children:z}),e.jsx("input",{className:"input w-full",placeholder:"Title (optional)",value:Fe,onChange:nn=>it(nn.target.value)}),e.jsx("textarea",{className:"input w-full",rows:2,placeholder:"Intro line (optional)",value:We,onChange:nn=>hn(nn.target.value)}),e.jsx("input",{className:"input w-full",placeholder:"Button label (optional)",value:Rt,onChange:nn=>jn(nn.target.value)}),e.jsxs("div",{className:"flex gap-2 justify-end",children:[e.jsx("button",{className:"btn",type:"button",onClick:()=>Ln(x,!0),children:"Preview"}),e.jsx("button",{className:"btn",type:"button",onClick:()=>Ln(x),children:"Popup"}),e.jsx("button",{className:"btn",onClick:()=>Pn(x,{title:Fe,intro:We,buttonLabel:Rt}),children:"Save"})]})]})}return ye?e.jsxs("div",{className:"p-4 md:p-8 max-w-7xl mx-auto ndn-page",children:[e.jsxs("div",{className:"flex flex-col md:flex-row items-center justify-between gap-4 mb-8",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-3xl font-black text-white tracking-tight ndn-section-title",children:"Admin ðŸ›¡ï¸"}),e.jsx("p",{className:"text-white/40 font-medium",children:"System management and oversight"})]}),e.jsxs("div",{className:"shrink-0 flex items-center gap-2",children:[e.jsx(dh,{}),n&&n.reconnect&&e.jsx("button",{onClick:()=>n.reconnect(),className:"ml-1 rounded-md bg-neutral-700/60 hover:bg-neutral-600/70 px-2.5 py-1 text-xs border border-white/10",title:"Force close and recreate the WebSocket connection",children:"Recreate WS"})]})]}),ge.length>0&&e.jsxs("div",{className:"p-2 rounded-xl bg-amber-900/10 border border-amber-500/20 mb-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"font-semibold",children:"Open Help Requests ðŸ†˜"}),e.jsxs("span",{className:"text-sm opacity-80",children:[ge.length," open"]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{className:"btn",onClick:()=>X(ge[0]),children:"Open Latest"}),e.jsx("button",{className:"btn btn-ghost",onClick:()=>A(),children:"Refresh"})]})]}),e.jsx("div",{className:"mt-2 flex gap-2 overflow-x-auto",children:ge.slice(0,6).map(x=>e.jsxs("div",{className:"p-2 rounded bg-black/10 border border-white/10 min-w-[220px]",children:[e.jsx("div",{className:"font-medium",children:x.username||"Anonymous"}),e.jsx("div",{className:"text-xs opacity-70",children:new Date(x.ts||0).toLocaleTimeString()}),e.jsx("div",{className:"text-sm truncate mt-1",children:x.message}),e.jsxs("div",{className:"mt-2 flex gap-2",children:[x.status==="open"?e.jsx("button",{className:"btn",onClick:()=>ut(x.id),children:"Claim"}):e.jsxs("span",{className:"text-xs opacity-70",children:[x.status," by ",x.claimedBy||"â€”"]}),e.jsx("button",{className:"btn",onClick:()=>X(x),children:"Chat"})]})]},x.id))})]}),ye&&e.jsx(Xm,{tabs:[{key:"general",label:"General"},{key:"maintenance",label:"Maintenance"},{key:"premium",label:"Premium"},{key:"tourneys",label:"Tourneys"},{key:"helpdesk",label:"Help Desk"}],active:xe,onChange:x=>we(x),className:"mb-4"})," ",xe==="general"&&e.jsxs(e.Fragment,{children:[ye&&e.jsxs("div",{className:"card",children:[e.jsx("h3",{className:"text-xl font-semibold mb-2",children:"Game Usage"}),e.jsxs("div",{className:"rounded-xl border border-indigo-500/40 bg-indigo-500/10 p-3",children:[e.jsx(Jm,{data:B.map(x=>({label:"",value:x.value}))}),e.jsx("div",{className:"mt-2 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-2 text-[11px] opacity-80",children:B.map((x,z)=>e.jsxs("div",{className:"flex items-center justify-between px-2 py-1 rounded-md bg-white/5 border border-white/10",children:[e.jsx("span",{className:"truncate mr-2",children:x.label}),e.jsxs("span",{className:"whitespace-nowrap",children:["Played ",x.value," Â· Won ",x.won]})]},z))})]})]}),ye&&e.jsxs("div",{className:"card",children:[e.jsx("h3",{className:"text-xl font-semibold mb-2",children:"Calibration Quality Status"}),e.jsx("div",{className:"text-sm opacity-80 mb-3",children:"Camera calibration confidence by game mode. Shows current system calibration readiness for each game."}),e.jsx("div",{className:"rounded-xl border border-amber-500/40 bg-amber-500/5 p-3",children:e.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-2 text-[11px]",children:C.map(x=>{const z=x.confidence>=85?"bg-emerald-500/20 border-emerald-500/40 text-emerald-200":x.confidence>=70?"bg-amber-500/20 border-amber-500/40 text-amber-200":"bg-rose-500/20 border-rose-500/40 text-rose-200";return e.jsxs("div",{className:`px-2 py-2 rounded-md border ${z}`,children:[e.jsx("div",{className:"font-semibold text-xs truncate",children:x.game}),e.jsx("div",{className:"text-[10px] opacity-80 truncate",children:x.qualityInfo.quality}),e.jsxs("div",{className:"text-[10px] font-mono mt-0.5",children:[Math.round(x.confidence),"%"]})]},x.game)})})})]}),e.jsxs("div",{className:"card",children:[e.jsx("h2",{className:"text-2xl font-bold mb-2",children:"Admin Control âš™ï¸"}),e.jsx("div",{className:"text-sm opacity-80 mb-3",children:"Grant or revoke Admin to trusted users. Only the owner can perform these actions."}),e.jsxs("div",{className:"flex gap-2 mb-3",children:[e.jsx("input",{className:"input flex-1",placeholder:"user@example.com",value:m,onChange:x=>p(x.target.value)}),e.jsx("button",{className:"btn",disabled:b,onClick:Y,children:"Grant"}),e.jsx("button",{className:"btn bg-rose-600 hover:bg-rose-700",disabled:b,onClick:()=>W(m),children:"Revoke"})]}),e.jsx("div",{className:"text-sm opacity-80 mb-2",children:"Current Admins:"}),e.jsx("div",{className:"flex flex-wrap gap-2 mb-4",children:s.map(x=>e.jsx("div",{className:"px-2 py-1 rounded bg-indigo-600/20 border border-indigo-500/40 text-sm",children:x},x))}),e.jsx("hr",{className:"border-indigo-500/20 my-4"}),e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"Premium Access Control"}),e.jsx("div",{className:"text-sm opacity-80 mb-3",children:"Grant or revoke Premium subscription access to users (grants 30 days)."}),e.jsxs("div",{className:"flex gap-2 mb-3",children:[e.jsx("input",{className:"input flex-1",placeholder:"user@example.com",value:m,onChange:x=>p(x.target.value)}),e.jsx("button",{className:"btn bg-emerald-600 hover:bg-emerald-700",disabled:b||!m.trim(),onClick:()=>ae(m,30),children:"Grant Premium"}),e.jsx("button",{className:"btn bg-rose-600 hover:bg-rose-700",disabled:b,onClick:()=>K(m),children:"Revoke Premium"})]}),e.jsx("div",{className:"text-sm opacity-80",children:"Premium grants provide 30 days of unlimited access to all features."})]}),e.jsxs("div",{className:"card",children:[e.jsx("h3",{className:"text-xl font-bold mb-4 text-white/90",children:"Announcements ðŸ“¢"}),e.jsx("div",{className:"text-sm opacity-80 mb-2",children:"Send a message to all users. This will appear as a toast notification."}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{className:"input flex-1",placeholder:"Announcement message...",value:N,onChange:x=>w(x.target.value)}),e.jsx("button",{className:"btn",disabled:b||!N.trim(),onClick:_e,children:"Send"})]})]}),e.jsxs("div",{className:"card",children:[e.jsx("h3",{className:"text-xl font-semibold mb-2",children:"User Search"}),e.jsx("div",{className:"text-sm opacity-80 mb-2",children:"Search for users by email or name."}),e.jsxs("div",{className:"flex gap-2 mb-3",children:[e.jsx("input",{className:"input flex-1",placeholder:"Search users...",value:S,onChange:x=>I(x.target.value)}),e.jsx("button",{className:"btn",disabled:b,onClick:Q,children:"Search"})]}),k.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-sm opacity-80 mb-2",children:"Results:"}),k.map(x=>e.jsx("div",{className:"p-2 rounded bg-black/20 text-sm flex items-center justify-between",children:e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold",children:x.name||"No name"}),e.jsx("div",{className:"opacity-70",children:x.email}),e.jsxs("div",{className:"opacity-60 text-xs",children:["Joined ",new Date(x.createdAt).toLocaleDateString()]})]})},x.email))]})]}),ye&&e.jsxs("div",{className:"card",children:[e.jsx("h3",{className:"text-xl font-semibold mb-3",children:"Email Templates"}),e.jsx("div",{className:"text-sm opacity-80 mb-2",children:"Customize titles, intro lines, and button text. Previews open in a new tab or as a popup."}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[e.jsx(qt,{kind:"reset",label:"Password reset"}),e.jsx(qt,{kind:"reminder",label:"Password reset reminder"}),e.jsx(qt,{kind:"confirm-email",label:"Confirm new email"}),e.jsx(qt,{kind:"changed",label:"Password changed notice"})]})]})]}),xe==="maintenance"&&ye&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"card",children:[e.jsx("h3",{className:"text-xl font-semibold mb-2",children:"User Management"}),e.jsx("div",{className:"text-sm opacity-80 mb-2",children:"Ban or unban users. Use with caution."}),e.jsxs("div",{className:"flex gap-2 mb-3",children:[e.jsx("input",{className:"input flex-1",placeholder:"user@example.com",value:S,onChange:x=>I(x.target.value)}),e.jsx("button",{className:"btn",disabled:b,onClick:Q,children:"Search"})]}),k.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-sm opacity-80 mb-2",children:"Results:"}),k.map(x=>e.jsxs("div",{className:"p-2 rounded bg-black/20 text-sm flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold",children:x.name||"No name"}),e.jsx("div",{className:"opacity-70",children:x.email}),e.jsxs("div",{className:"opacity-60 text-xs",children:["Joined ",new Date(x.createdAt).toLocaleDateString()]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{className:"btn bg-red-600 hover:bg-red-700 text-xs",onClick:()=>de(x.email),children:"Ban"}),e.jsx("button",{className:"btn bg-green-600 hover:bg-green-700 text-xs",onClick:()=>tt(x.email),children:"Unban"})]})]},x.email))]})]}),e.jsxs("div",{className:"card",children:[e.jsx("h3",{className:"text-xl font-semibold mb-3",children:"Withdrawals"}),e.jsxs("ul",{className:"space-y-2",children:[L.map(x=>e.jsxs("li",{className:"p-2 rounded bg-black/20 text-sm flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-mono text-xs",children:x.id}),e.jsxs("div",{children:[x.email," Â· ",x.currency," ",(x.amountCents/100).toFixed(2)]}),e.jsxs("div",{className:"opacity-70",children:[x.status," Â· ",new Date(x.requestedAt).toLocaleString()]})]}),e.jsx("div",{className:"flex gap-2",children:x.status==="pending"&&e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"btn bg-emerald-600 hover:bg-emerald-700",disabled:b,onClick:()=>Hn(x.id,!0),children:"Approve"}),e.jsx("button",{className:"btn bg-rose-600 hover:bg-rose-700",disabled:b,onClick:()=>Hn(x.id,!1),children:"Reject"})]})})]},x.id)),L.length===0&&e.jsx("li",{className:"opacity-60",children:"No withdrawal requests."})]})]}),e.jsxs("div",{className:"card",children:[e.jsx("h3",{className:"text-xl font-semibold mb-3",children:"Wallet Operations ðŸ’°"}),e.jsx("div",{className:"text-sm opacity-80 mb-3",children:"Manually credit user wallets. Use with caution."}),e.jsx("div",{className:"grid grid-cols-1 gap-4",children:e.jsxs("div",{className:"p-4 rounded-lg bg-black/20 border border-white/5",children:[e.jsx("h4",{className:"font-semibold mb-3",children:"Credit Wallet"}),e.jsxs("div",{className:"flex flex-wrap gap-3",children:[e.jsx("input",{className:"input flex-1 min-w-[200px]",placeholder:"user@example.com",value:r,onChange:x=>i(x.target.value)}),e.jsx("input",{className:"input w-32",placeholder:"Amount (10.00)",value:l,onChange:x=>u(x.target.value)}),e.jsxs("select",{className:"input w-24",value:f,onChange:x=>c(x.target.value),children:[e.jsx("option",{children:"USD"}),e.jsx("option",{children:"GBP"}),e.jsx("option",{children:"EUR"})]}),e.jsx("button",{className:"btn bg-indigo-600 hover:bg-indigo-700",onClick:async()=>{try{const x=localStorage.getItem("authToken"),z={"Content-Type":"application/json"};if(x&&(z.Authorization=`Bearer ${x}`),!(await fetch("/api/admin/wallet/credit",{method:"POST",headers:z,body:JSON.stringify({email:r,currency:f,amount:l})})).ok)throw new Error("Failed");i(""),u(""),alert("Wallet credited")}catch{alert("Failed to credit wallet")}},children:"Credit"})]})]})})]}),e.jsxs("div",{className:"card",children:[e.jsx("h3",{className:"text-xl font-semibold mb-3",children:"System Health"}),e.jsx("div",{className:"text-sm opacity-80 mb-3",children:"Current status of system components and services."}),se?e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{children:"Database"}),e.jsx("span",{className:`px-2 py-1 rounded text-xs ${se.database?"bg-emerald-600":"bg-red-600"}`,children:se.database?"Ready":"Down"})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{children:"WebSocket"}),e.jsx("span",{className:`px-2 py-1 rounded text-xs ${se.websocket?"bg-emerald-600":"bg-red-600"}`,children:se.websocket?"Ready":"Down"})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{children:"HTTPS"}),e.jsx("span",{className:`px-2 py-1 rounded text-xs ${se.https?"bg-emerald-600":"bg-amber-600"}`,children:se.https?"Enabled":"HTTP Only"})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{children:"Maintenance Mode"}),e.jsx("span",{className:`px-2 py-1 rounded text-xs ${se.maintenance?"bg-red-600":"bg-emerald-600"}`,children:se.maintenance?"Active":"Normal"})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{children:"Clustering (Auto-Scaling)"}),e.jsx("span",{className:`px-2 py-1 rounded text-xs ${le?"bg-emerald-600":"bg-amber-600"}`,children:le?"Enabled":"Disabled"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"text-sm",children:[e.jsx("span",{className:"font-semibold",children:"Uptime:"})," ",Math.floor(se.uptime/3600),"h"," ",Math.floor(se.uptime%3600/60),"m"]}),e.jsxs("div",{className:"text-sm",children:[e.jsx("span",{className:"font-semibold",children:"Memory:"})," ",se.memory?Math.round(se.memory.heapUsed/1024/1024):"?","MB used"]}),e.jsxs("div",{className:"text-sm",children:[e.jsx("span",{className:"font-semibold",children:"Version:"})," ",se.version]}),e.jsxs("div",{className:"flex gap-2 flex-wrap",children:[e.jsx("button",{className:"btn",onClick:wn,children:"Refresh"}),e.jsxs("button",{className:`btn ${le?"bg-amber-600 hover:bg-amber-700":"bg-emerald-600 hover:bg-emerald-700"}`,disabled:b,onClick:()=>zn(!le),children:[le?"Disable":"Enable"," Clustering"]})]})]})]}):e.jsxs("div",{className:"text-center py-4",children:[e.jsx("div",{className:"text-sm opacity-60 mb-2",children:"Loading system health..."}),e.jsx("button",{className:"btn",onClick:wn,children:"Load Health Status"})]}),e.jsxs("div",{className:"mt-4 pt-4 border-t border-white/10",children:[e.jsx("h4",{className:"font-semibold mb-3",children:"Clustering Capacity"}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("label",{className:"font-semibold",children:"Max Concurrent Users"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{className:"btn",onClick:()=>Me(!1),children:"Close"}),e.jsx("button",{className:"btn",onClick:G,disabled:!ye||b,children:"Force broadcast"})]})]}),e.jsx("input",{type:"range",min:"1500",max:"50000",step:"500",value:Ie,onChange:x=>qn(Number(x.target.value)),disabled:b,className:"w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed",style:{background:le?`linear-gradient(to right, #3b82f6 0%, #3b82f6 ${(Ie-1500)/48500*100}%, #374151 ${(Ie-1500)/48500*100}%, #374151 100%)`:"#374151"}}),e.jsxs("div",{className:"flex justify-between text-xs opacity-60 mt-1",children:[e.jsx("span",{children:"1.5k"}),e.jsx("span",{children:"50k"})]})]}),e.jsx("div",{className:"flex gap-2 flex-wrap",children:e.jsxs("button",{className:`btn ${le?"bg-amber-600 hover:bg-amber-700":"bg-emerald-600 hover:bg-emerald-700"}`,disabled:b,onClick:()=>zn(!le),children:[le?"Disable":"Enable"," Clustering"]})})]}),e.jsxs("div",{className:"text-xs opacity-70 mt-2 p-2 bg-white/5 rounded",children:["ðŸ’¡ Clustering enables auto-scaling with capacity up to"," ",Ie.toLocaleString()," concurrent users. Adjust the slider to set maximum capacity. NODE_WORKERS environment variable is set to handle the configured load behind a reverse proxy."]})]})]}),e.jsxs("div",{className:"card",children:[e.jsx("h3",{className:"text-xl font-semibold mb-3",children:"User Reports"}),e.jsxs("ul",{className:"space-y-2",children:[Ue.map(x=>e.jsx("li",{className:"p-2 rounded bg-black/20 text-sm",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-mono text-xs",children:x.id}),e.jsxs("div",{children:[e.jsx("span",{className:"font-semibold",children:x.reporter})," â†’"," ",e.jsx("span",{className:"font-semibold",children:x.offender})," Â·"," ",new Date(x.ts).toLocaleString()]}),e.jsxs("div",{className:"opacity-80",children:["Reason: ",x.reason]}),x.messageId&&e.jsxs("div",{className:"opacity-60 text-xs",children:["Message ID: ",x.messageId]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("span",{className:`px-2 py-0.5 rounded text-xs ${x.status==="open"?"bg-amber-600":"bg-emerald-600"}`,children:x.status}),x.status==="open"&&e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"btn bg-emerald-600 hover:bg-emerald-700",disabled:b,onClick:async()=>{await fetch("/api/admin/reports/resolve",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("authToken")}`},body:JSON.stringify({id:x.id,action:"resolved"})}),await A()},children:"Resolve"}),e.jsx("button",{className:"btn bg-rose-600 hover:bg-rose-700",disabled:b,onClick:async()=>{const z=prompt("Enter notes for action taken (e.g., warning, block):")||"";await fetch("/api/admin/reports/resolve",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("authToken")}`},body:JSON.stringify({id:x.id,action:"actioned",notes:z})}),await A()},children:"Action"})]})]})]})},x.id)),Ue.length===0&&e.jsx("li",{className:"opacity-60",children:"No reports."})]})]}),e.jsxs("div",{className:"card",children:[e.jsx("h3",{className:"text-xl font-semibold mb-3",children:"Open Matches"}),e.jsxs("ul",{className:"space-y-1",children:[(h?.matches||[]).map(x=>e.jsxs("li",{className:"flex items-center justify-between p-2 rounded bg-black/20 text-sm",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"font-mono text-xs",children:x.id}),e.jsx("span",{className:"opacity-80",children:x.creatorName}),e.jsxs("span",{className:"opacity-60",children:[x.game," Â· ",Pa(x.mode)," ",x.value," ",x.game==="X01"?`/${x.startingScore}`:""]})]}),e.jsx("button",{className:"btn bg-rose-600 hover:bg-rose-700",disabled:b,onClick:()=>yn(x.id),children:"Remove"})]},x.id)),(!h?.matches||h.matches.length===0)&&e.jsx("li",{className:"text-sm opacity-60",children:"No open matches."})]})]}),e.jsxs("div",{className:"card",children:[e.jsx("h3",{className:"text-xl font-semibold mb-3",children:"Dangerous Operations"}),e.jsx("div",{className:"text-sm opacity-80 mb-3 text-red-400",children:"âš ï¸ These operations can cause data loss or service disruption. Use with extreme caution."}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold mb-2 text-red-400",children:"Tournament Deletion"}),e.jsxs("ul",{className:"space-y-2",children:[y.map(x=>e.jsxs("li",{className:"p-2 rounded bg-red-900/20 border border-red-500/40 text-sm",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"font-semibold",children:x.title}),e.jsx("div",{className:"opacity-70",children:x.status})]}),e.jsxs("div",{className:"opacity-80",children:[x.game," Â· ",Pa(x.mode)," ",x.value]}),e.jsx("div",{className:"mt-2",children:e.jsx("button",{className:"btn bg-red-600 hover:bg-red-700 text-xs",disabled:b,onClick:()=>lt(x.id),children:"Delete Tournament"})})]},x.id)),y.length===0&&e.jsx("li",{className:"opacity-60",children:"No tournaments."})]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold mb-2 text-red-400",children:"System Maintenance"}),e.jsx("div",{className:"space-y-2",children:e.jsxs("div",{className:"p-3 rounded bg-red-900/20 border border-red-500/40",children:[e.jsx("div",{className:"font-semibold text-red-400 mb-2",children:"Maintenance Mode"}),e.jsx("div",{className:"text-sm opacity-80 mb-3",children:"Put the entire site into maintenance mode. Users won't be able to access games or create matches."}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:`px-2 py-1 rounded text-xs ${h?.maintenance?"bg-red-600":"bg-green-600"}`,children:h?.maintenance?"MAINTENANCE ACTIVE":"NORMAL OPERATION"}),e.jsx("button",{className:`btn ${h?.maintenance?"bg-green-600 hover:bg-green-700":"bg-red-600 hover:bg-red-700"}`,disabled:b,onClick:()=>Ae(!h?.maintenance),children:h?.maintenance?"Disable":"Enable"})]})]})})]})]})]}),ee&&e.jsx(Ol,{request:ee,user:{email:t?.email,username:t?.username,isAdmin:!0},onClose:()=>X(null)})]}),xe==="premium"&&ye&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"card",children:[e.jsx("h3",{className:"text-xl font-semibold mb-2",children:"Premium Subscription Grants"}),e.jsx("div",{className:"text-sm opacity-80 mb-3",children:"Grant or revoke premium subscriptions for users (grants 30 days)."}),e.jsxs("div",{className:"flex gap-2 mb-3",children:[e.jsx("input",{className:"input flex-1",placeholder:"user@example.com",value:m,onChange:x=>p(x.target.value)}),e.jsx("button",{className:"btn",disabled:b||!m.trim(),onClick:()=>ae(m,30),children:"Grant"}),e.jsx("button",{className:"btn bg-rose-600 hover:bg-rose-700",disabled:b,onClick:()=>K(m),children:"Revoke"})]}),e.jsx("div",{className:"text-sm opacity-80 mb-2",children:"Premium users get 30 days of access to all features."})]}),e.jsxs("div",{className:"card",children:[e.jsx("h3",{className:"text-xl font-semibold mb-2",children:"Premium Winners"}),e.jsx("div",{className:"text-sm opacity-80 mb-2",children:"Users who have won premium through tournaments."}),e.jsxs("div",{className:"space-y-2",children:[De.map(x=>e.jsxs("div",{className:"p-2 rounded bg-black/20 text-sm flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold",children:x.name||"No name"}),e.jsx("div",{className:"opacity-70",children:x.email}),e.jsxs("div",{className:"opacity-60 text-xs",children:["Expires ",new Date(x.expiresAt).toLocaleDateString()]})]}),e.jsx("div",{className:"flex gap-2",children:x.expired?e.jsx("span",{className:"px-2 py-1 rounded bg-amber-600 text-xs",children:"Premium Expired"}):e.jsx("span",{className:"px-2 py-1 rounded bg-emerald-600 text-xs",children:"Premium Active"})})]},x.email)),De.length===0&&e.jsx("div",{className:"opacity-60",children:"No premium winners."})]})]})]}),xe==="tourneys"&&ye&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"card",children:[e.jsx("h3",{className:"text-xl font-semibold mb-3",children:"Create Official Tournament"}),e.jsx("div",{className:"text-sm opacity-80 mb-3",children:"Set up a new official tournament with custom rules, timing, and prizes."}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("input",{className:"input w-full",placeholder:"Tournament Title",value:E.title,onChange:x=>V(z=>({...z,title:x.target.value}))}),e.jsxs("div",{className:"grid grid-cols-3 gap-2",children:[e.jsx("select",{className:"input",value:E.game,onChange:x=>V(z=>({...z,game:x.target.value})),children:["X01","Around the Clock","Cricket","Halve It","Shanghai","High-Low"].map(x=>e.jsx("option",{value:x,children:x},x))}),e.jsx("select",{className:"input",value:E.mode,onChange:x=>V(z=>({...z,mode:x.target.value})),children:Zm(E.game).map(x=>e.jsx("option",{value:String(x),children:Pa(String(x))},String(x)))}),(()=>{const x=eh(E.game,E.mode);return x&&x.length>0?e.jsx("select",{className:"input",value:String(E.value),onChange:z=>V(ie=>({...ie,value:Number(z.target.value)})),children:x.map(z=>e.jsx("option",{value:String(z),children:z},z))}):e.jsx("input",{className:"input",type:"number",min:1,value:E.value,onChange:z=>V(ie=>({...ie,value:Number(z.target.value)}))})})()]}),e.jsx("textarea",{className:"input w-full",rows:2,placeholder:"Description",value:E.description,onChange:x=>V(z=>({...z,description:x.target.value}))}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx("input",{className:"input",type:"datetime-local",value:E.startAt,onChange:x=>V(z=>({...z,startAt:x.target.value}))}),e.jsx("input",{className:"input",type:"number",min:0,placeholder:"Checkin minutes",value:E.checkinMinutes,onChange:x=>V(z=>({...z,checkinMinutes:Number(x.target.value)}))})]}),e.jsx("input",{className:"input w-full",type:"number",min:6,max:64,placeholder:"Capacity",value:E.capacity,onChange:x=>V(z=>({...z,capacity:Number(x.target.value)}))}),e.jsxs("div",{className:"grid grid-cols-3 gap-2 items-center",children:[e.jsxs("select",{className:"input",value:E.prizeType,onChange:x=>{const z=x.target.value;V(ie=>({...ie,prizeType:z,prizeAmount:z==="premium"?3:0}))},children:[e.jsx("option",{value:"premium",children:"PREMIUM"}),e.jsx("option",{value:"cash",children:"Cash"})]}),E.prizeType==="premium"?e.jsxs("select",{className:"input",value:E.prizeAmount,onChange:x=>V(z=>({...z,prizeAmount:Number(x.target.value)})),children:[e.jsx("option",{value:1,children:"1 month"}),e.jsx("option",{value:3,children:"3 months"})]}):e.jsx("input",{className:"input",type:"number",min:0,value:E.prizeAmount,onChange:x=>V(z=>({...z,prizeAmount:Number(x.target.value)}))}),e.jsxs("select",{className:"input",disabled:E.prizeType!=="cash",value:E.currency,onChange:x=>V(z=>({...z,currency:x.target.value})),children:[e.jsx("option",{value:"GBP",children:"GBP"}),e.jsx("option",{value:"USD",children:"USD"}),e.jsx("option",{value:"EUR",children:"EUR"}),e.jsx("option",{value:"CAD",children:"CAD"}),e.jsx("option",{value:"AUD",children:"AUD"})]})]}),e.jsx("input",{className:"input w-full",placeholder:"Prize notes (optional)",value:E.prizeNotes,onChange:x=>V(z=>({...z,prizeNotes:x.target.value}))}),e.jsx("div",{className:"flex justify-end",children:e.jsx("button",{className:"btn bg-emerald-600 hover:bg-emerald-700",disabled:b,onClick:ft,children:"Create Tournament"})})]})]}),e.jsxs("div",{className:"card",children:[e.jsx("h3",{className:"text-xl font-semibold mb-3",children:"Tournament Premium Winners"}),e.jsx("div",{className:"text-sm opacity-80 mb-3",children:"Users who have won premium prizes in tournaments. Grant them access here."}),e.jsxs("div",{className:"space-y-2",children:[y.filter(x=>x.status==="completed"&&x.winnerEmail&&x.prizeType==="premium").map(x=>{const z=De.find($e=>$e.email===x.winnerEmail),ie=z&&!z.expired;return e.jsxs("div",{className:"p-3 rounded bg-black/20 text-sm",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("div",{className:"font-semibold",children:x.title}),e.jsx("div",{className:"text-xs opacity-70",children:new Date(x.startAt).toLocaleDateString()})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:x.winnerEmail}),e.jsxs("div",{className:"text-xs opacity-70",children:["Prize: ",x.prizeAmount," month",x.prizeAmount>1?"s":""," PREMIUM"]})]}),e.jsx("div",{className:"flex items-center gap-2",children:ie?e.jsx("span",{className:"px-2 py-1 rounded bg-emerald-600 text-xs",children:"âœ“ Access Granted"}):e.jsx("button",{className:"btn bg-emerald-600 hover:bg-emerald-700 text-xs",disabled:b,onClick:()=>ae(x.winnerEmail,x.prizeAmount*30),children:"Grant Access"})})]})]},x.id)}),y.filter(x=>x.status==="completed"&&x.winnerEmail&&x.prizeType==="premium").length===0&&e.jsx("div",{className:"text-center py-4 text-sm opacity-60",children:"No completed premium tournaments."})]})]}),e.jsxs("div",{className:"card",children:[e.jsx("h3",{className:"text-xl font-semibold mb-3",children:"Manage Tournaments"}),e.jsx("div",{className:"text-sm opacity-80 mb-3",children:"View and manage all tournaments. Set winners or mark payouts."}),e.jsxs("ul",{className:"space-y-2",children:[y.map(x=>e.jsxs("li",{className:"p-3 rounded bg-black/20 text-sm",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold",children:x.title}),e.jsxs("div",{className:"opacity-80",children:[x.game," Â· ",Pa(x.mode)," ",x.value]})]}),e.jsx("div",{className:`px-2 py-1 rounded text-xs font-semibold ${x.status==="scheduled"?"bg-blue-600":x.status==="running"?"bg-green-600":x.status==="completed"?"bg-purple-600":"bg-gray-600"}`,children:x.status})]}),e.jsxs("div",{className:"text-xs opacity-70 mb-2",children:["Start: ",new Date(x.startAt).toLocaleString()," Â· Capacity:"," ",x.capacity]}),x.prize&&e.jsxs("div",{className:"text-xs mb-2",children:["Prize:"," ",x.prizeType==="cash"&&x.prizeAmount?`${x.currency||"USD"} ${x.prizeAmount}`:`${x.prizeAmount||3} month${(x.prizeAmount||3)>1?"s":""} PREMIUM`,x.prizeType==="cash"&&x.status==="completed"&&x.payoutStatus&&e.jsx("span",{className:`ml-2 px-1.5 py-0.5 rounded ${x.payoutStatus==="paid"?"bg-emerald-600":"bg-amber-600"}`,children:x.payoutStatus})]}),e.jsxs("div",{className:"mt-2 flex flex-wrap gap-2",children:[e.jsx("button",{className:"btn text-xs",disabled:b||x.status!=="scheduled",onClick:()=>yt(x.id,prompt("Winner email?")||""),children:"Set Winner"}),x.prizeType==="cash"&&x.status==="completed"&&x.payoutStatus!=="paid"&&e.jsx("button",{className:"btn text-xs",disabled:b,onClick:()=>kt(x.id),children:"Mark Paid"}),e.jsx("button",{className:"btn text-xs",disabled:b,onClick:()=>Je(),children:"Reseed"})]})]},x.id)),y.length===0&&e.jsx("li",{className:"opacity-60",children:"No tournaments."})]})]})]}),xe==="helpdesk"&&ye&&e.jsx(e.Fragment,{children:e.jsxs("div",{className:"card",children:[e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"Helpdesk Requests"}),e.jsx("div",{className:"text-sm opacity-80 mb-3",children:"All help requests from users who asked to speak with an admin. Status is shown for each request."}),ge.length===0?e.jsx("div",{className:"text-sm opacity-70",children:"No help requests."}):e.jsx("div",{className:"space-y-2",children:ge.map(x=>e.jsxs("div",{className:"p-2 rounded bg-black/10 border border-white/10 flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:x.username||"Anonymous"}),e.jsx("div",{className:"text-xs opacity-70",children:new Date(x.ts||0).toLocaleString()}),e.jsx("div",{className:"text-sm mt-1",children:x.message}),e.jsxs("div",{className:"mt-1",children:[e.jsx("span",{className:`text-xs px-2 py-1 rounded-full mr-2 ${x.status==="open"?"bg-emerald-700/30 text-emerald-200":x.status==="claimed"?"bg-amber-700/30 text-amber-200":"bg-slate-700/30 text-slate-200"}`,children:x.status||"unknown"}),x.claimedBy&&e.jsxs("span",{className:"text-xs opacity-70",children:["by ",x.claimedBy]})]}),U[x.id]&&e.jsxs("div",{className:"text-xs text-amber-300 mt-1",children:[U[x.id].who," typing..."]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[x.status==="open"&&e.jsx("button",{className:"btn",onClick:()=>ut(x.id),children:"Claim"}),x.status!=="resolved"&&e.jsx("button",{className:"btn btn-ghost",onClick:()=>_(x.id),children:"Resolve"}),e.jsx("button",{className:"btn",onClick:()=>X(x),children:"Chat"})]})]},x.id))})]})}),ce.open&&e.jsxs("div",{className:"fixed inset-0 z-[1000]",onClick:()=>me({open:!1}),children:[e.jsx("div",{className:"absolute inset-0 bg-black/70 backdrop-blur-sm"}),e.jsx("div",{className:"absolute inset-0 p-4 md:p-8 overflow-auto flex items-start md:items-center justify-center",children:e.jsxs("div",{className:"w-full max-w-3xl bg-[#0b1020] rounded-2xl border border-indigo-500/40 shadow-2xl",onClick:x=>x.stopPropagation(),children:[e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b border-indigo-500/20",children:[e.jsxs("div",{className:"font-semibold",children:["Preview: ",ce.kind]}),e.jsx("button",{className:"btn",onClick:()=>me({open:!1}),children:"Close"})]}),e.jsx("div",{className:"p-0 bg-black/30",children:e.jsx("iframe",{title:"Email Preview",style:{width:"100%",height:"70vh",border:"0",background:"transparent"},srcDoc:ce.html||""})}),e.jsx("div",{className:"px-4 py-3 border-t border-indigo-500/20 text-xs opacity-70",children:"Click outside this panel or press Esc to close."})]})})]})]}):e.jsxs("div",{className:"card ndn-page",children:[e.jsx("h2",{className:"text-2xl font-bold mb-2 ndn-section-title",children:"Admin ðŸ›¡ï¸"}),e.jsx("div",{className:"text-sm opacity-80",children:"You don't have permission to manage admins."})]})}const Fl=o.createContext(null),La="ndn:theme";function Co(t=new Date){const n=t.getMonth(),s=t.getDate();return n===9||n===10&&s<=5?"halloween":n===11||n===0||n===1&&s<=14?"christmas":n===2||n===3?"easter":n>=5&&n<=7?"summer":"default"}function ph({children:t}){const[n,s]=o.useState(()=>{try{const u=localStorage.getItem(`${La}:auto`);return u?JSON.parse(u):!0}catch{return!0}}),[a,r]=o.useState(()=>{try{const u=localStorage.getItem(La);if(u)return u}catch{}return Co()});o.useEffect(()=>{try{localStorage.setItem(`${La}:auto`,JSON.stringify(n))}catch{}},[n]),o.useEffect(()=>{const u=n?Co():a;try{u==="default"?document.documentElement.removeAttribute("data-theme"):document.documentElement.setAttribute("data-theme",u)}catch{}},[a,n]);const i=u=>{try{localStorage.setItem(La,u)}catch{}r(u)},l=o.useMemo(()=>({theme:a,setTheme:i,auto:n,setAuto:s}),[a,n]);return e.jsx(Fl.Provider,{value:l,children:t})}function xh(){const t=o.useContext(Fl);if(!t)throw new Error("useTheme must be used inside ThemeProvider");return t}const bh=["default","halloween","easter","summer","christmas"],gh={default:{icon:"ðŸŽ¯",label:"Default",gradient:"from-slate-600 to-slate-800",ring:"ring-slate-400"},christmas:{icon:"ðŸŽ„",label:"Christmas",gradient:"from-red-600 to-green-700",ring:"ring-red-400"},easter:{icon:"ðŸ£",label:"Easter",gradient:"from-pink-400 to-purple-400",ring:"ring-pink-300"},halloween:{icon:"ðŸŽƒ",label:"Halloween",gradient:"from-orange-500 to-purple-800",ring:"ring-orange-400"},summer:{icon:"â˜€ï¸",label:"Summer",gradient:"from-yellow-400 to-sky-400",ring:"ring-yellow-300"}};function ko(){const{theme:t,setTheme:n,auto:s,setAuto:a}=xh();return e.jsxs("div",{className:"theme-toggle space-y-4",role:"group","aria-label":"Theme selector",children:[e.jsxs("label",{className:"flex items-center gap-3 cursor-pointer select-none",children:[e.jsx("div",{onClick:()=>a(!s),className:`relative w-11 h-6 rounded-full transition-colors ${s?"bg-gradient-to-r from-cyan-500 to-blue-500":"bg-white/20"}`,children:e.jsx("span",{className:`absolute top-0.5 left-0.5 w-5 h-5 bg-white rounded-full shadow transition-transform ${s?"translate-x-5":""}`})}),e.jsx("span",{className:"text-sm font-medium",children:"Auto seasonal theme ðŸŽ¯"})]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:bh.map(r=>{const i=gh[r],l=t===r;return e.jsxs("button",{onClick:()=>n(r),disabled:s,"aria-pressed":l,title:`Set ${i.label} theme`,className:`
                relative flex items-center gap-2 px-4 py-2 rounded-full text-sm font-semibold
                transition-all duration-200 shadow-md
                ${s?"opacity-50 cursor-not-allowed":"hover:scale-105 active:scale-95"}
                ${l?`bg-gradient-to-r ${i.gradient} text-white ring-2 ${i.ring} ring-offset-2 ring-offset-black/50`:"bg-white/10 text-white/80 hover:bg-white/20"}
              `,children:[e.jsx("span",{className:"text-lg",children:i.icon}),e.jsxs("span",{children:[i.label," ðŸŽ¯"]}),l&&e.jsx("span",{className:"ml-1 w-2 h-2 rounded-full bg-white animate-pulse"})]},r)})})]})}function vh({user:t}){const{favoriteDouble:n,callerEnabled:s,callerVoice:a,callerVolume:r,speakCheckoutOnly:i,avgMode:l,autoStartOffline:u,rememberLastOffline:f,reducedMotion:c,compactHeader:m,allowSpectate:p,cameraScale:h,cameraAspect:N,cameraFitMode:w,autoscoreProvider:b,autoscoreWsUrl:g,autoCommitMode:y,confirmUncertainDarts:M,autoScoreConfidenceThreshold:L,autoscoreDetectorMinArea:S,autoscoreDetectorThresh:I,autoscoreDetectorRequireStableN:k,harshLightingMode:T,enhanceBigTrebles:E,cameraRecordDarts:V,cameraShowLabels:H,calibrationGuide:$,preferredCameraId:ce,preferredCameraLabel:me,cameraEnabled:xe,offlineLayout:we,textSize:ye,boxSize:De,setFavoriteDouble:Ue,setCallerEnabled:ge,setCallerVoice:He,setCallerVolume:U,setSpeakCheckoutOnly:P,setAvgMode:ee,setAutoStartOffline:X,setRememberLastOffline:re,setReducedMotion:se,setCompactHeader:je,setAllowSpectate:le,setCameraScale:Ne,setCameraAspect:Ie,setCameraFitMode:Se,setAutoscoreProvider:Me,setAutoscoreWsUrl:G,setAutoCommitMode:Ce,setConfirmUncertainDarts:he,setAutoScoreConfidenceThreshold:Ee,setAutoscoreDetectorMinArea:te,setAutoscoreDetectorThresh:Te,setAutoscoreDetectorRequireStableN:C,setHarshLightingMode:B,setEnhanceBigTrebles:A,setCameraRecordDarts:W,setCameraShowLabels:ae,cameraLowLatency:K,setCameraLowLatency:_e,cameraProcessingFps:Ae,setCameraProcessingFps:ut,setCalibrationGuide:_,preserveCalibrationOverlay:Y,setPreserveCalibrationOverlay:Q,preserveCalibrationOnCameraChange:de,setPreserveCalibrationOnCameraChange:tt,setPreferredCamera:ft,setCameraEnabled:yt,setOfflineLayout:kt,setTextSize:lt,setBoxSize:Je,dartTimerEnabled:Hn,dartTimerSeconds:yn,setDartTimerEnabled:Wn,setDartTimerSeconds:wn,x01DoubleIn:zn,setX01DoubleIn:qn}=pe(),[mn,Pn]=o.useState([{key:"first180",label:"First 180",unlocked:!1,icon:"ðŸ”¥",desc:"Score 180 in a match."},{key:"hundredGames",label:"100 Games Played",unlocked:!1,icon:"ðŸ†",desc:"Play 100 games."},{key:"tournamentWin",label:"Tournament Winner",unlocked:!1,icon:"ðŸ¥‡",desc:"Win a tournament."},{key:"bestLeg",label:"Best Leg",unlocked:!1,icon:"âš¡",desc:"Finish a leg in 12 darts or less."},{key:"comeback",label:"Comeback",unlocked:!1,icon:"ðŸ”¥",desc:"Win after trailing by 3 legs."}]);o.useEffect(()=>{const j=t?.username||"";j&&Pn(Z=>Z.map(be=>({...be,unlocked:!!localStorage.getItem(`ndn:achieve:${be.key}:${j}`)})))},[t?.username]),o.useEffect(()=>{function j(){try{xt("user")}catch{}}return window.addEventListener("ndn:open-settings-profile",j),()=>window.removeEventListener("ndn:open-settings-profile",j)},[]);const[Ln,qt]=o.useState(!1),[x,z]=o.useState(""),[ie,$e]=o.useState(""),[Fe,it]=o.useState(""),[We,hn]=o.useState(""),[Rt,jn]=o.useState(""),[nn,Bt]=o.useState(!0),[Be,Nt]=o.useState(null),[nt,Xt]=o.useState(null),[At,Ve]=o.useState([{text:"Hi! I'm your Nine Dart Nation assistant. How can I help you today?",isUser:!1}]),[pt,ze]=o.useState("");o.useEffect(()=>{const j=t?.username||"";if(j)try{z(localStorage.getItem(`ndn:bio:favPlayer:${j}`)||""),$e(localStorage.getItem(`ndn:bio:favTeam:${j}`)||""),it(localStorage.getItem(`ndn:bio:favDarts:${j}`)||""),hn(localStorage.getItem(`ndn:bio:bio:${j}`)||""),jn(localStorage.getItem(`ndn:bio:profilePhoto:${j}`)||""),Bt(localStorage.getItem(`ndn:settings:allowAnalytics:${j}`)!=="false")}catch{}},[t?.username]),o.useEffect(()=>{t?.email&&(ss(`/api/subscription?email=${encodeURIComponent(t.email)}`).then(j=>j.json()).then(Xt).catch(()=>{}),(async()=>{try{const j=localStorage.getItem("authToken"),Z={};j&&(Z.Authorization=`Bearer ${j}`);const be=await fetch(`/api/wallet/balance?email=${encodeURIComponent(t.email)}`,{headers:Z});be.ok&&Nt(await be.json())}catch{}})())},[t?.email]);const Gn=()=>{const j=t?.username||"";if(j)try{localStorage.setItem(`ndn:bio:favPlayer:${j}`,x),localStorage.setItem(`ndn:bio:favTeam:${j}`,ie),localStorage.setItem(`ndn:bio:favDarts:${j}`,Fe),localStorage.setItem(`ndn:bio:bio:${j}`,We),localStorage.setItem(`ndn:bio:profilePhoto:${j}`,Rt);try{window.dispatchEvent(new CustomEvent("ndn:avatar-updated",{detail:{username:j,avatar:Rt}}))}catch{}localStorage.setItem(`ndn:settings:allowAnalytics:${j}`,nn.toString()),qt(!1)}catch{}},Nn={"how to play":"To play darts, select a game mode from the menu. For online play, join a match. For offline, start a local game.",calibration:"Go to Settings > Camera & Vision > Calibration Guide to set up your camera properly.",premium:'Premium unlocks all game modes. Click the "Upgrade to PREMIUM" button in online play.',username:"Change your username once for free in Settings > Account.",voice:"Enable voice caller in Settings > Audio & Voice. Test the voice with the Test Voice button.",friends:"Add friends in the Friends tab to play together.",stats:"View your statistics in the Stats tab.",settings:"Customize your experience in the Settings panel.",support:"Contact support via email or check the FAQ in Settings > Support."},fn=j=>{try{window.dispatchEvent(new CustomEvent("ndn:change-tab",{detail:{tab:j}}))}catch(Z){console.error("Navigation failed:",Z)}},rs=j=>{const Z=j.toLowerCase();if(Z.includes("username")||Z.includes("change name"))return{text:"You can change your username once for free.",links:[{text:"Go to Settings > Account",tab:"settings"}]};if(Z.includes("premium")||Z.includes("upgrade")||Z.includes("subscription"))return{text:"Premium unlocks all game modes and features.",links:[{text:"Go to Online Play",tab:"online"}]};if(Z.includes("calibrat")||Z.includes("camera")||Z.includes("vision"))return{text:"Set up your camera properly in Settings.",links:[{text:"Go to Settings > Camera & Vision",tab:"settings"}]};if(Z.includes("voice")||Z.includes("caller")||Z.includes("audio"))return{text:"Enable voice calling in Settings.",links:[{text:"Go to Settings > Audio & Voice",tab:"settings"}]};if(Z.includes("friend")||Z.includes("play together"))return{text:"Add friends to play together.",links:[{text:"Go to Friends",tab:"friends"}]};if(Z.includes("stat")||Z.includes("score")||Z.includes("performance"))return{text:"View your statistics and performance.",links:[{text:"Go to Stats",tab:"stats"}]};if(Z.includes("setting")||Z.includes("customiz")||Z.includes("configur"))return{text:"Customize your experience.",links:[{text:"Go to Settings",tab:"settings"}]};if(Z.includes("tournament")||Z.includes("competition"))return{text:"Check out tournaments and competitions.",links:[{text:"Go to Tournaments",tab:"tournaments"}]};if(Z.includes("help")||Z.includes("support")||Z.includes("faq"))return{text:"You're already in the help section! Check the Support section above for more resources.",links:[{text:"Scroll to Support",tab:"settings"}]};if(Z.includes("how to play")||Z.includes("game")||Z.includes("start"))return{text:"To play darts, select a game mode from the menu. For online play, join a match. For offline, start a local game.",links:[{text:"Play Online",tab:"online"},{text:"Play Offline",tab:"offline"}]};const be=Object.entries(Nn).find(([st])=>Z.includes(st.toLowerCase()));return be?{text:be[1],links:[{text:"Open FAQ",tab:"settings"}]}:{text:"I'm not sure about that. Try asking about playing, calibration, premium, username changes, voice settings, friends, stats, or settings."}},D=()=>{if(!pt.trim())return;const j=pt.toLowerCase();Ve(be=>[...be,{text:pt,isUser:!0}]),ze("");const Z=rs(j);setTimeout(()=>{Ve(be=>[...be,{text:Z,isUser:!1}])},500)},[O,F]=o.useState(""),[oe,Ye]=o.useState(!1),[Ge,qe]=o.useState(""),[wt,Et]=o.useState([]);o.useEffect(()=>{const j=()=>{const Z=speechSynthesis.getVoices();Et(Z.filter(be=>be.lang.startsWith("en")))};j(),speechSynthesis.onvoiceschanged=j},[]);const[St,mt]=o.useState(!1),[Tt,xt]=o.useState(null),Oe=({label:j,icon:Z,pill:be,color:st})=>e.jsxs("button",{onPointerDown:Xe=>{Xe.stopPropagation()},onMouseDown:Xe=>{Xe.stopPropagation()},onTouchStart:Xe=>{Xe.stopPropagation?.()},onClick:()=>xt(Xe=>Xe===be?null:be),type:"button","data-testid":`pill-button-${be}`,className:`select-none whitespace-nowrap rounded-full px-4 py-2 text-sm font-semibold shadow-sm focus:outline-none focus-visible:ring-2 focus-visible:ring-white/60 active:scale-[0.98] bg-gradient-to-r ${st} text-white flex items-center gap-2`,children:[e.jsx(Z,{className:"w-4 h-4"})," ",j,e.jsx(Nc,{className:`w-4 h-4 transition-transform ${Tt===be?"rotate-180":""}`})]});return e.jsxs("div",{className:"space-y-6 ndn-page",children:[e.jsx("div",{className:"rounded-[28px] border border-white/10 bg-gradient-to-br from-slate-950/70 via-indigo-950/30 to-slate-950/60 p-5 shadow-2xl",children:e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("div",{className:"text-xs uppercase tracking-[0.35em] text-slate-400",children:"Preferences"}),e.jsx("h2",{className:"mt-1 text-2xl font-extrabold text-white",children:"Settings"}),e.jsx("div",{className:"mt-1 text-sm text-slate-300/80",children:"Tune your camera, scoring, and app experience."})]}),e.jsx("div",{className:"shrink-0 rounded-2xl border border-white/10 bg-white/5 px-3 py-2",children:e.jsx(ko,{})})]})}),e.jsx("div",{className:"relative rounded-[22px] bg-gradient-to-br from-white/[0.08] to-white/[0.03] backdrop-blur-md border border-white/10 p-2 shadow-xl",children:e.jsxs("div",{className:"flex items-center gap-2 overflow-x-auto no-scrollbar py-1 px-1",children:[e.jsx(Oe,{label:"User Info ðŸ‘¤",icon:Ua,pill:"user",color:"from-indigo-600 to-indigo-500"}),e.jsx(Oe,{label:"Calibration ðŸ“",icon:Fa,pill:"calibration",color:"from-emerald-600 to-emerald-500"}),e.jsx(Oe,{label:"App Settings âš™ï¸",icon:Qs,pill:"settings",color:"from-purple-600 to-purple-500"})]})}),null,Tt==="user"&&e.jsx("div",{"data-testid":"pill-user-content",className:"p-5 sm:p-6 rounded-[28px] border border-white/10 bg-slate-950/50 shadow-2xl space-y-4",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx("div",{className:"card",children:e.jsxs("div",{className:"p-3 rounded-xl border border-red-500/40 bg-red-500/10",children:[e.jsxs("div",{className:"font-semibold mb-4 flex items-center gap-2 text-red-100",children:[e.jsx(Ua,{className:"w-5 h-5"})," Account ðŸ‘¤"]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex justify-center gap-2",children:[e.jsx("button",{onClick:()=>window.dispatchEvent(new CustomEvent("ndn:logout")),className:"px-6 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium transition-colors",children:"Logout ðŸšª"}),e.jsx("button",{onClick:()=>mt(!0),className:"px-4 py-2 bg-slate-700 hover:bg-slate-800 text-white rounded-lg font-medium transition-colors",children:"Highlights âœ¨"})]}),e.jsxs("div",{className:"mt-4 border-t pt-3",children:[e.jsx("div",{className:"font-medium mb-2",children:"Wallet ðŸ’°"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"text-sm opacity-80 mr-4",children:["Balance:"," ",e.jsx("strong",{children:Be&&Be.wallet&&Object.keys(Be.wallet.balances||{}).length>0?Object.entries(Be.wallet.balances).map(([j,Z])=>`${j} ${(Number(Z)/100).toFixed(2)}`).join(" Â· "):"0.00"})]}),e.jsx("input",{className:"input w-40",placeholder:"Withdraw amount",value:"",onChange:()=>{}}),e.jsxs("select",{className:"input",children:[e.jsx("option",{children:"USD"}),e.jsx("option",{children:"GBP"}),e.jsx("option",{children:"EUR"})]}),e.jsx("button",{className:"btn",onClick:async()=>{const j=t?.email||"";if(!j)return alert("Not signed in");const Z=prompt("Enter withdraw amount (e.g., 10.00)");if(Z)try{const be=localStorage.getItem("authToken"),st={"Content-Type":"application/json"};if(be&&(st.Authorization=`Bearer ${be}`),!(await fetch("/api/wallet/withdraw",{method:"POST",headers:st,body:JSON.stringify({email:j,amount:Z,currency:"USD"})})).ok)throw new Error("Failed");alert("Withdrawal requested")}catch{alert("Failed to request withdrawal")}},children:"Withdraw ðŸ’¸"})]})]}),e.jsxs("div",{className:"border-t border-red-500/20 pt-3",children:[e.jsxs("div",{className:"font-medium mb-2 text-red-100",children:["Change Username âœï¸ (",(()=>{const j=t?.usernameChangeCount||0;return j<2?`${2-j} free changes remaining`:"Â£2 per change"})(),")"]}),e.jsx("div",{className:"text-sm text-red-100 mb-2",children:"You can change your username up to 2 times for free. Additional changes cost Â£2 each."}),t?.usernameChangeCount>=2&&!O.trim()?e.jsx("div",{className:"text-amber-400 text-sm mb-2",children:"âš ï¸ Additional username changes cost Â£2"}):null,e.jsx("input",{className:"input w-full mb-2",type:"text",placeholder:"New username",value:O,onChange:j=>F(j.target.value),disabled:oe}),Ge&&e.jsx("div",{className:"text-red-400 text-sm mb-2",children:Ge}),e.jsx("button",{onClick:async()=>{if(qe(""),!O.trim()){qe("Username required");return}if(O.length<3||O.length>20){qe("Username must be 3-20 characters");return}(t?.usernameChangeCount||0)<2?(localStorage.setItem("pendingUsernameChange",O.trim()),window.location.href="/?username-change=free"):window.location.href="https://buy.stripe.com/eVq4gB3XqeNS0iw6vAfnO02"},disabled:oe||!O.trim(),className:"w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-600 text-white rounded-lg font-medium transition-colors",children:oe?"Processing...":(t?.usernameChangeCount||0)<2?"Change Username (FREE) âœï¸":"Change Username (Â£2) âœï¸"})]})]})]})}),nt&&e.jsx("div",{className:"card",children:e.jsxs("div",{className:"p-3 rounded-xl border border-green-500/40 bg-green-500/10",children:[e.jsxs("div",{className:"font-semibold mb-4 flex items-center gap-2 text-green-100",children:[e.jsx(Ws,{className:"w-5 h-5"})," Premium âœ¨"]}),e.jsxs("div",{className:"space-y-3 text-sm text-green-100",children:[e.jsxs("div",{children:["Status:"," ",e.jsx("span",{className:nt?.status==="active"?"text-green-400":"text-yellow-400",children:nt?.status==="active"?"âœ“ Active âœ…":"Not Active"})]}),nt?.status==="active"&&nt?.nextBillingDate&&e.jsxs("div",{children:["Next Billing:"," ",new Date(nt.nextBillingDate).toLocaleDateString()]}),nt?.source==="tournament"&&nt?.status==="active"&&e.jsx("button",{onClick:()=>window.location.href="https://buy.stripe.com/eVq4gB3XqeNS0iw6vAfnO02",className:"w-full px-3 py-2 bg-red-600 hover:bg-red-700 text-white rounded font-medium transition-colors text-xs",children:"Cancel Subscription âŒ"})]})]})}),e.jsx("div",{className:"card",children:e.jsxs("div",{className:"p-3 rounded-xl border border-cyan-500/40 bg-cyan-500/10",children:[e.jsxs("div",{className:"font-semibold mb-4 flex items-center gap-2 text-cyan-100",children:[e.jsx(kr,{className:"w-5 h-5"})," Profile Photo ðŸ–¼ï¸"]}),e.jsx("input",{type:"file",accept:"image/*",onChange:j=>{const Z=j.target.files?.[0];if(Z){const be=new FileReader;be.onload=()=>jn(be.result),be.readAsDataURL(Z)}},className:"w-full text-xs text-slate-100"})]})}),e.jsx("div",{className:"card",children:e.jsxs("div",{className:"p-3 rounded-xl border border-purple-500/40 bg-purple-500/10",children:[e.jsxs("div",{className:"font-semibold mb-4 flex items-center gap-2 text-purple-100",children:[e.jsx(Rn,{className:"w-5 h-5"})," Online & Socials ï¿½"]}),e.jsx("div",{className:"space-y-3",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{type:"checkbox",id:"allowSpectate",checked:p,onChange:j=>le(j.target.checked),className:"w-4 h-4"}),e.jsx("label",{htmlFor:"allowSpectate",className:"text-sm text-purple-100",children:"Allow spectators ðŸ‘ï¸"})]})})]})}),e.jsx("div",{className:"card",children:e.jsxs("div",{className:"p-3 rounded-xl border border-orange-500/40 bg-orange-500/10",children:[e.jsxs("div",{className:"font-semibold mb-4 flex items-center gap-2 text-orange-100",children:[e.jsx(Ws,{className:"w-5 h-5"})," Data & Privacy ðŸ›¡ï¸"]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{type:"checkbox",id:"allowAnalytics",checked:nn,onChange:j=>Bt(j.target.checked),className:"w-4 h-4"}),e.jsx("label",{htmlFor:"allowAnalytics",className:"text-sm text-orange-100",children:"Allow analytics ðŸ“Š"})]}),e.jsx("button",{onClick:()=>{const j={achievements:mn,bio:{favPlayer:x,favTeam:ie,favDarts:Fe,bio:We}},Z=new Blob([JSON.stringify(j,null,2)],{type:"application/json"}),be=URL.createObjectURL(Z),st=document.createElement("a");st.href=be,st.download=`my-data-${new Date().toISOString().split("T")[0]}.json`,st.click(),URL.revokeObjectURL(be)},className:"btn bg-orange-600 hover:bg-orange-700 w-full",children:"Export My Data ðŸ“¥"})]})]})}),e.jsx("div",{className:"card",children:e.jsxs("div",{className:"p-3 rounded-xl border border-red-500/40 bg-red-500/10",children:[e.jsxs("div",{className:"font-semibold mb-4 flex items-center gap-2",children:[e.jsx(Ws,{className:"w-5 h-5 text-red-400"})," Privacy & Copyright ðŸ›¡ï¸"]}),e.jsx("div",{className:"space-y-3 text-sm text-slate-300",children:e.jsxs("div",{className:"bg-red-500/20 border border-red-500/30 rounded-lg p-3",children:[e.jsx("p",{className:"font-semibold text-red-300 mb-2",children:"âš ï¸ Legal Notice âš–ï¸"}),e.jsxs("p",{className:"mb-2 text-xs",children:[e.jsx("strong",{children:"Copyright:"})," All content is protected by copyright law. ðŸ“œ"]}),e.jsxs("p",{className:"text-xs",children:[e.jsx("strong",{children:"Privacy:"})," Your data is protected and unauthorized access is prohibited. ðŸ”’"]})]})})]})}),e.jsx("div",{className:"card",children:e.jsxs("div",{className:"p-3 rounded-xl border border-yellow-500/40 bg-yellow-500/10",children:[e.jsxs("div",{className:"font-semibold mb-4 flex items-center gap-2 text-yellow-100",children:[e.jsx(Ws,{className:"w-5 h-5"})," Blocked Users"]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("p",{className:"text-sm text-yellow-100",children:"Manage players you've blocked from contacting you."}),e.jsx("button",{onClick:()=>window.dispatchEvent(new CustomEvent("ndn:open-blocklist")),className:"btn bg-yellow-600 hover:bg-yellow-700 w-full text-sm",children:"View Blocked Users ðŸš«"})]})]})}),e.jsx("div",{className:"card",children:e.jsxs("div",{className:"p-3 rounded-xl border border-blue-500/40 bg-blue-500/10",children:[e.jsxs("div",{className:"font-semibold mb-4 flex items-center gap-2 text-blue-100",children:[e.jsx(Rn,{className:"w-5 h-5"})," Contact & Support"]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("a",{href:"mailto:support@ninedartnation.com",className:"flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors text-sm",children:"ðŸ“§ Email Support"}),e.jsx("a",{href:"https://ninedartnation.com/help",target:"_blank",rel:"noopener noreferrer",className:"flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors text-sm",children:"â“ Help Center"}),e.jsx("a",{href:"https://ninedartnation.com/faq",target:"_blank",rel:"noopener noreferrer",className:"flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors text-sm",children:"ðŸ“‹ FAQ"})]})]})}),e.jsx("div",{className:"card",children:e.jsxs("div",{className:"p-3 rounded-xl border border-red-500/40 bg-red-500/10",children:[e.jsxs("div",{className:"font-semibold mb-4 flex items-center gap-2 text-red-100",children:[e.jsx(Ws,{className:"w-5 h-5"})," Delete Account"]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"bg-red-500/20 border border-red-500/30 rounded-lg p-3 text-xs text-red-200",children:[e.jsx("p",{className:"font-semibold mb-1",children:"âš ï¸ Warning"}),e.jsx("p",{children:"Deleting your account is permanent and cannot be undone. All your stats, achievements, and data will be erased."})]}),e.jsx("button",{onClick:()=>{window.confirm(`Are you absolutely sure you want to delete your account? This action cannot be undone.

All your stats, achievements, and data will be permanently erased.`)&&window.confirm("This is your final warning. Click OK to permanently delete your account.")&&window.dispatchEvent(new CustomEvent("ndn:delete-account"))},className:"w-full px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium transition-colors",children:"Permanently Delete Account ðŸ—‘ï¸"})]})]})})]})}),e.jsx("div",{className:"relative rounded-xl bg-white/5 backdrop-blur-md border border-white/10 p-1",children:e.jsx("div",{className:"flex items-center gap-2 overflow-x-auto no-scrollbar py-1 px-1",children:e.jsx(Oe,{label:"Calibration",icon:Fa,pill:"calibration",color:"from-purple-500 to-pink-500 shadow-purple-500/30"})})}),Tt==="calibration"&&e.jsx("div",{"data-testid":"pill-calibration-content",className:"p-6 rounded-2xl border border-white/10 bg-white/[0.02] space-y-4",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx("div",{className:"card",children:e.jsxs("div",{className:"p-3 rounded-xl border border-blue-500/40 bg-blue-500/10",children:[e.jsxs("div",{className:"font-semibold mb-4 flex items-center gap-2",children:[e.jsx(Fa,{className:"w-5 h-5 text-blue-400"})," Camera & Vision"]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{type:"checkbox",id:"cameraEnabled",checked:xe,onChange:j=>yt(j.target.checked),className:"w-4 h-4"}),e.jsx("label",{htmlFor:"cameraEnabled",className:"text-sm",children:"Enable camera"})]}),xe&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"pt-2 border-t border-white/10",children:[e.jsx("div",{className:"font-semibold mb-2 text-sm",children:"Lighting"}),e.jsxs("div",{className:"mt-3 flex flex-col gap-2",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{type:"checkbox",id:"cameraRecordDarts",checked:!!V,onChange:j=>W(j.target.checked),className:"w-4 h-4"}),e.jsx("label",{htmlFor:"cameraRecordDarts",className:"text-sm",children:"Save detection thumbnails (no continuous video)"})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{type:"checkbox",id:"cameraShowLabels",checked:!!H,onChange:j=>ae(j.target.checked),className:"w-4 h-4"}),e.jsx("label",{htmlFor:"cameraShowLabels",className:"text-sm",children:"Show segment labels (e.g., T20)"})]})]}),e.jsx("p",{className:"text-xs opacity-70 mt-1",children:"When enabled, small thumbnails of detections and commits are saved for review. This does not record continuous video or audio."}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{type:"checkbox",id:"harshLightingMode",checked:!!T,onChange:j=>B(j.target.checked),className:"w-4 h-4"}),e.jsx("label",{htmlFor:"harshLightingMode",className:"text-sm",children:"Reduce glare (ring lights / harsh lighting)"})]}),e.jsx("p",{className:"text-xs opacity-70 mt-1",children:"Applies highlight compression for better dart detection and slightly dims the preview."}),e.jsxs("div",{className:"mt-3 flex items-center gap-3",children:[e.jsx("input",{type:"checkbox",id:"enhanceBigTrebles",checked:!!E,onChange:j=>A(j.target.checked),className:"w-4 h-4"}),e.jsx("label",{htmlFor:"enhanceBigTrebles",className:"text-sm",children:"Enhance big trebles (T20/T19/T18)"})]}),e.jsx("p",{className:"text-xs opacity-70 mt-1",children:"Visual aid only. Briefly enlarges/highlights the treble segment when detected."})]}),e.jsxs("div",{children:[e.jsxs("label",{htmlFor:"cameraScale",className:"block text-sm mb-2",children:["Scale: ",h?.toFixed(2)]}),e.jsx("input",{type:"range",id:"cameraScale",min:"0.5",max:"3",step:"0.1",value:h||1,onChange:j=>Ne(parseFloat(j.target.value)),className:"w-full"})]}),e.jsxs("div",{className:"mt-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{type:"checkbox",id:"cameraLowLatency",checked:!!K,onChange:j=>_e(j.target.checked),className:"w-4 h-4"}),e.jsx("label",{htmlFor:"cameraLowLatency",className:"text-sm",children:"Low-latency camera (prefer 720p & lower CPU)"})]}),e.jsx("p",{className:"text-xs opacity-70 mt-1",children:"Reduces preview resolution and throttles detection to improve responsiveness on slower devices."}),e.jsxs("div",{className:"mt-2",children:[e.jsx("label",{className:"text-sm block mb-1",children:"Detection FPS"}),e.jsxs("select",{value:Ae,onChange:j=>ut(Number(j.target.value)),className:"text-sm",children:[e.jsx("option",{value:10,children:"10 fps (very low)"}),e.jsx("option",{value:15,children:"15 fps (balanced)"}),e.jsx("option",{value:20,children:"20 fps (smooth)"}),e.jsx("option",{value:30,children:"30 fps (high)"})]}),e.jsx("p",{className:"text-xs opacity-70 mt-1",children:"Lower FPS reduces CPU usage and improves stability on laggy feeds."})]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"cameraAspect",className:"block text-sm mb-2",children:"Aspect Ratio"}),e.jsxs("select",{onPointerDown:j=>{j.stopPropagation()},onMouseDown:j=>{j.stopPropagation()},onTouchStart:j=>{j.stopPropagation?.()},id:"cameraAspect",value:N||"wide",onChange:j=>Ie(j.target.value),className:"input w-full",children:[e.jsx("option",{value:"wide",children:"Wide (16:9)"}),e.jsx("option",{value:"square",children:"Square (1:1)"})]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"cameraFitMode",className:"block text-sm mb-2",children:"Fit Mode"}),e.jsxs("select",{onPointerDown:j=>{j.stopPropagation()},onMouseDown:j=>{j.stopPropagation()},onTouchStart:j=>{j.stopPropagation?.()},id:"cameraFitMode",value:w||"fit",onChange:j=>Se(j.target.value),className:"input w-full",children:[e.jsx("option",{value:"fill",children:"Fill (crop)"}),e.jsx("option",{value:"fit",children:"Fit (letterbox)"})]})]}),e.jsx("button",{onClick:()=>{},className:"btn bg-indigo-600 hover:bg-indigo-700 w-full",children:"Calibration Guide ðŸ“–"}),e.jsxs("div",{className:"flex items-center gap-3 mt-3",children:[e.jsx("input",{type:"checkbox",id:"preserveOverlaySize",checked:Y,onChange:j=>Q(j.target.checked),className:"w-4 h-4"}),e.jsx("label",{htmlFor:"preserveOverlaySize",className:"text-sm",children:"Preserve overlay display size when locking calibration"})]}),e.jsxs("div",{className:"flex items-center gap-3 mt-3",children:[e.jsx("input",{type:"checkbox",id:"preserveCalOnCamChange",checked:!!de,onChange:j=>tt(j.target.checked),className:"w-4 h-4"}),e.jsx("label",{htmlFor:"preserveCalOnCamChange",className:"text-sm",children:"Preserve calibration when switching camera devices"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"autoscoreProvider",className:"block text-sm mb-2",children:"Auto-score Provider"}),e.jsxs("select",{onPointerDown:j=>{j.stopPropagation()},onMouseDown:j=>{j.stopPropagation()},onTouchStart:j=>{j.stopPropagation?.()},id:"autoscoreProvider",value:b||"manual",onChange:j=>Me(j.target.value),className:"input w-full",children:[e.jsx("option",{value:"manual",children:"Manual Scoring"}),e.jsx("option",{value:"built-in",children:"Built-in Vision"}),e.jsx("option",{value:"built-in-v2",children:"Built-in Vision (v2)"}),e.jsx("option",{value:"external-ws",children:"External (WebSocket)"})]})]}),b==="external-ws"&&e.jsx("input",{type:"text",placeholder:"WebSocket URL",value:g||"",onChange:j=>G(j.target.value),className:"input w-full text-xs"}),b!=="manual"&&e.jsxs("div",{children:[e.jsx("label",{htmlFor:"autoCommitMode",className:"block text-sm mb-2",children:"Turn Advance"}),e.jsxs("select",{onPointerDown:j=>{j.stopPropagation()},onMouseDown:j=>{j.stopPropagation()},onTouchStart:j=>{j.stopPropagation?.()},id:"autoCommitMode",value:y||"wait-for-clear",onChange:j=>Ce(j.target.value),className:"input w-full",children:[e.jsx("option",{value:"wait-for-clear",children:"Wait for darts to be removed"}),e.jsx("option",{value:"immediate",children:"Advance immediately after 3 darts/bust"})]}),e.jsx("p",{className:"text-xs opacity-70 mt-1",children:"Waiting prevents the turn from rotating until you clear the board (or 6.5s pass)."})]}),b!=="manual"&&e.jsxs("div",{className:"pt-2 border-t border-white/10",children:[e.jsx("div",{className:"font-semibold mb-2 text-sm",children:"Auto-score quality"}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{type:"checkbox",id:"confirmUncertainDarts",checked:M??!0,onChange:j=>he(j.target.checked),className:"w-4 h-4"}),e.jsx("label",{htmlFor:"confirmUncertainDarts",className:"text-sm",children:"Confirm uncertain darts"})]}),e.jsx("p",{className:"text-xs opacity-70 mt-1",children:"If the system isnâ€™t confident enough, itâ€™ll pause and ask you to accept/reject (Omni/Scolia-style)."}),e.jsxs("div",{className:"mt-3",children:[e.jsxs("label",{htmlFor:"autoScoreConfidenceThreshold",className:"block text-sm mb-2",children:["Confidence threshold:"," ",(L??.85).toFixed(2)]}),e.jsx("input",{type:"range",id:"autoScoreConfidenceThreshold",min:"0.5",max:"0.99",step:"0.01",value:L??.85,onChange:j=>Ee(parseFloat(j.target.value)),className:"w-full"}),e.jsx("p",{className:"text-xs opacity-70 mt-1",children:"Higher = fewer confirmations, but higher risk of accepting a wrong hit."})]}),e.jsxs("details",{className:"mt-4",children:[e.jsx("summary",{className:"text-sm cursor-pointer select-none opacity-90",children:"Advanced detector tuning"}),e.jsxs("div",{className:"mt-3 space-y-3",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm mb-2",children:["Min blob area:"," ",S??30]}),e.jsx("input",{type:"range",min:"5",max:"200",step:"1",value:S??30,onChange:j=>te(parseInt(j.target.value,10)),className:"w-full"}),e.jsx("p",{className:"text-xs opacity-70 mt-1",children:"Lower = more sensitive (can increase false positives)."})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm mb-2",children:["Foreground threshold:"," ",I??15]}),e.jsx("input",{type:"range",min:"5",max:"40",step:"1",value:I??15,onChange:j=>Te(parseInt(j.target.value,10)),className:"w-full"}),e.jsx("p",{className:"text-xs opacity-70 mt-1",children:"Lower = more motion counts as a dart."})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm mb-2",children:["Stable frames required:"," ",k??2]}),e.jsx("input",{type:"range",min:"1",max:"6",step:"1",value:k??2,onChange:j=>C(parseInt(j.target.value,10)),className:"w-full"}),e.jsx("p",{className:"text-xs opacity-70 mt-1",children:"Higher = fewer false triggers, but slower."})]})]})]})]})]})]})]})}),e.jsx("div",{className:"card",children:e.jsxs("div",{className:"p-3 rounded-xl border border-purple-500/40 bg-purple-500/10",children:[e.jsxs("div",{className:"font-semibold mb-4 flex items-center gap-2",children:[e.jsx(vc,{className:"w-5 h-5 text-purple-400"})," Audio & Voice"]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{type:"checkbox",id:"callerEnabled",checked:s,onChange:j=>ge(j.target.checked),className:"w-4 h-4"}),e.jsx("label",{htmlFor:"callerEnabled",className:"text-sm",children:"Enable voice caller"})]}),s&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"callerVoice",className:"block text-sm mb-2",children:"Voice"}),e.jsxs("select",{onPointerDown:j=>{j.stopPropagation()},onMouseDown:j=>{j.stopPropagation()},onTouchStart:j=>{j.stopPropagation?.()},id:"callerVoice",value:a||"",onChange:j=>He(j.target.value),className:"input w-full text-xs",children:[e.jsx("option",{value:"",children:"Default"}),wt.map((j,Z)=>e.jsx("option",{value:j.voiceURI,children:j.name},Z))]})]}),e.jsxs("div",{children:[e.jsxs("label",{htmlFor:"callerVolume",className:"block text-sm mb-2",children:["Volume: ",Math.round((r||1)*100),"%"]}),e.jsx("input",{type:"range",id:"callerVolume",min:"0",max:"1",step:"0.1",value:r||1,onChange:j=>U(parseFloat(j.target.value)),className:"w-full"})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{type:"checkbox",id:"speakCheckoutOnly",checked:i,onChange:j=>P(j.target.checked),className:"w-4 h-4"}),e.jsx("label",{htmlFor:"speakCheckoutOnly",className:"text-sm",children:"Only speak checkout scores"})]}),e.jsx("button",{onClick:()=>{const j=new SpeechSynthesisUtterance("One hundred and eighty!");if(a){const Z=window.speechSynthesis.getVoices().find(be=>be.voiceURI===a);Z&&(j.voice=Z)}j.volume=r||1,window.speechSynthesis.speak(j)},className:"btn bg-purple-600 hover:bg-purple-700 w-full text-sm",children:"Test Voice ðŸ”Š"})]})]})]})})]})}),e.jsx("div",{className:"relative rounded-xl bg-white/5 backdrop-blur-md border border-white/10 p-1",children:e.jsx("div",{className:"flex items-center gap-2 overflow-x-auto no-scrollbar py-1 px-1",children:e.jsx(Oe,{label:"Settings",icon:Qs,pill:"settings",color:"from-cyan-500 to-blue-500 shadow-cyan-500/30"})})}),Tt==="settings"&&e.jsxs("div",{"data-testid":"pill-settings-content",className:"space-y-4",children:[e.jsx("div",{className:"card",children:e.jsxs("div",{className:"p-3 rounded-xl border border-indigo-500/40 bg-indigo-500/10",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{className:"font-semibold flex items-center gap-2",children:[e.jsx(Ua,{className:"w-5 h-5 text-brand-400"})," Profile Bio ðŸ‘¤"]}),Ln?e.jsxs("button",{onClick:Gn,className:"flex items-center gap-2 px-3 py-1 bg-green-500/20 hover:bg-green-500/30 rounded-lg text-green-400 text-sm transition-colors",children:[e.jsx(wc,{className:"w-4 h-4"})," Save ðŸ’¾"]}):e.jsxs("button",{onClick:()=>qt(!0),className:"flex items-center gap-2 px-3 py-1 bg-blue-500/20 hover:bg-blue-500/30 rounded-lg text-blue-400 text-sm transition-colors",children:[e.jsx(yc,{className:"w-4 h-4"})," Edit âœï¸"]})]}),e.jsx("div",{className:"space-y-3",children:Ln?e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm mb-1",children:"Favorite Player ðŸ‘¤"}),e.jsx("input",{type:"text",value:x,onChange:j=>z(j.target.value),className:"input w-full"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm mb-1",children:"Favorite Team ðŸ›¡ï¸"}),e.jsx("input",{type:"text",value:ie,onChange:j=>$e(j.target.value),className:"input w-full"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm mb-1",children:"Favorite Darts ðŸŽ¯"}),e.jsx("input",{type:"text",value:Fe,onChange:j=>it(j.target.value),className:"input w-full"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm mb-1",children:"Bio / Quote ðŸ’¬"}),e.jsx("textarea",{value:We,onChange:j=>hn(j.target.value),rows:3,className:"input w-full"})]})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:["Favorite Player:"," ",e.jsxs("span",{className:"text-brand-300",children:[x||"Not set"," ðŸ‘¤"]})]}),e.jsxs("div",{children:["Favorite Team:"," ",e.jsxs("span",{className:"text-brand-300",children:[ie||"Not set"," ðŸ›¡ï¸"]})]}),e.jsxs("div",{children:["Favorite Darts:"," ",e.jsxs("span",{className:"text-brand-300",children:[Fe||"Not set"," ðŸŽ¯"]})]}),e.jsxs("div",{children:["Bio:"," ",e.jsxs("span",{className:"text-brand-300",children:[We||"No bio set"," ðŸ’¬"]})]})]})})]})}),e.jsx("div",{className:"card",children:e.jsxs("div",{className:"p-3 rounded-xl border border-green-500/40 bg-green-500/10",children:[e.jsxs("div",{className:"font-semibold mb-4 flex items-center gap-2",children:[e.jsx(jc,{className:"w-5 h-5 text-green-400"})," Game Preferences ï¿½"]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{type:"checkbox",id:"dartTimerEnabled",checked:!!Hn,onChange:j=>Wn(j.target.checked),className:"w-4 h-4"}),e.jsx("label",{htmlFor:"dartTimerEnabled",className:"text-sm",children:"Enable per-dart throw timer â±ï¸"})]}),Hn&&e.jsxs("div",{children:[e.jsxs("label",{className:"block mb-2 text-sm font-medium",children:["Time per throw:"," ",yn?Math.round(yn):0,"s"]}),e.jsx("input",{type:"range",min:"3",max:"30",value:yn||10,onChange:j=>wn(parseInt(j.target.value)),className:"w-full"}),e.jsx("div",{className:"text-xs opacity-70 mt-1",children:"When the timer reaches zero, the dart is recorded as a miss and advances to the next throw."})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"favoriteDouble",className:"block text-sm mb-2",children:"Favorite Finish Double"}),e.jsxs("select",{onPointerDown:j=>{j.stopPropagation()},onMouseDown:j=>{j.stopPropagation()},id:"favoriteDouble",value:n,onChange:j=>Ue(j.target.value),className:"input w-full",children:[e.jsx("option",{value:"any",children:"Any Double"}),e.jsx("option",{value:"D20",children:"Double 20"}),e.jsx("option",{value:"D10",children:"Double 10"}),e.jsx("option",{value:"D5",children:"Double 5"}),e.jsx("option",{value:"D1",children:"Double 1"})]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"avgMode",className:"block text-sm mb-2",children:"Average Display Mode"}),e.jsxs("select",{id:"avgMode",value:l,onChange:j=>ee(j.target.value),className:"input w-full",children:[e.jsx("option",{value:"all-time",children:"All Time Average"}),e.jsx("option",{value:"24h",children:"24 Hour Average"})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{type:"checkbox",id:"x01DoubleIn",checked:!!zn,onChange:j=>qn(j.target.checked),className:"w-4 h-4"}),e.jsx("label",{htmlFor:"x01DoubleIn",className:"text-sm",children:"Require Double-In for X01"})]})]})]})}),e.jsx("div",{className:"card",children:e.jsxs("div",{className:"p-3 rounded-xl border border-pink-500/40 bg-pink-500/10",children:[e.jsxs("div",{className:"font-semibold mb-4 flex items-center gap-2",children:[e.jsx(kr,{className:"w-5 h-5 text-pink-400"})," UI & Accessibility ðŸ‘ï¸"]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{type:"checkbox",id:"autoStartOffline",checked:u,onChange:j=>X(j.target.checked),className:"w-4 h-4"}),e.jsx("label",{htmlFor:"autoStartOffline",className:"text-sm",children:"Auto-start offline games ðŸš€"})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{type:"checkbox",id:"rememberLastOffline",checked:f,onChange:j=>re(j.target.checked),className:"w-4 h-4"}),e.jsx("label",{htmlFor:"rememberLastOffline",className:"text-sm",children:"Remember last offline game settings ðŸ’¾"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"offlineLayout",className:"block text-sm mb-2",children:"Offline Layout"}),e.jsxs("select",{id:"offlineLayout",value:we||"classic",onChange:j=>kt(j.target.value),className:"input w-full",children:[e.jsx("option",{value:"classic",children:"Classic Layout"}),e.jsx("option",{value:"modern",children:"Modern Layout"})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{type:"checkbox",id:"reducedMotion",checked:c,onChange:j=>se(j.target.checked),className:"w-4 h-4"}),e.jsx("label",{htmlFor:"reducedMotion",className:"text-sm",children:"Reduce motion/animations"})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{type:"checkbox",id:"compactHeader",checked:m,onChange:j=>je(j.target.checked),className:"w-4 h-4"}),e.jsx("label",{htmlFor:"compactHeader",className:"text-sm",children:"Compact header"})]})]})]})}),e.jsx("div",{className:"card",children:e.jsxs("div",{className:"p-3 rounded-xl border border-yellow-500/30 bg-yellow-500/6",children:[e.jsxs("div",{className:"font-semibold mb-4 flex items-center gap-2",children:[e.jsx(Qs,{className:"w-5 h-5 text-yellow-400"})," Theme ï¿½"]}),e.jsx("div",{children:e.jsx(ko,{})})]})}),e.jsx("div",{className:"card",children:e.jsxs("div",{className:"p-3 rounded-xl border border-blue-500/40 bg-blue-500/10",children:[e.jsxs("div",{className:"font-semibold mb-4 flex items-center gap-2",children:[e.jsx(Er,{className:"w-5 h-5 text-blue-400"})," Support & Help ï¿½"]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-sm opacity-80",children:"Need help? Contact us via email:"}),e.jsx("a",{href:"mailto:support@ninedartnation.com",className:"btn bg-blue-600 hover:bg-blue-700 w-full text-xs",children:"Email Support ðŸ“§"})]})]})}),e.jsx("div",{className:"card",children:e.jsxs("div",{className:"p-3 rounded-xl border border-cyan-500/40 bg-cyan-500/10",children:[e.jsxs("div",{className:"font-semibold mb-4 flex items-center gap-2",children:[e.jsx(Rn,{className:"w-5 h-5 text-cyan-400"})," Help Assistant ðŸ¤–"]}),e.jsx("div",{className:"space-y-3 max-h-96 overflow-y-auto",children:At.map((j,Z)=>e.jsx("div",{className:`${j.isUser?"text-right":""}`,children:e.jsx("div",{className:`inline-block max-w-xs px-3 py-2 rounded-lg text-sm ${j.isUser?"bg-indigo-600 text-white":"bg-white/10 text-slate-100"}`,children:typeof j.text=="string"?j.text:e.jsxs(e.Fragment,{children:[e.jsx("div",{children:j.text.text}),j.text.links&&e.jsx("div",{className:"mt-2 space-y-1",children:j.text.links.map((be,st)=>e.jsx("button",{onClick:()=>fn(be.tab),className:"block w-full text-left text-xs px-2 py-1 bg-white/20 hover:bg-white/30 rounded transition",children:be.text},st))})]})})},Z))}),e.jsxs("div",{className:"flex gap-2 mt-3",children:[e.jsx("input",{type:"text",value:pt,onChange:j=>ze(j.target.value),onKeyPress:j=>j.key==="Enter"&&D(),placeholder:"Ask me anything...",className:"flex-1 input"}),e.jsx("button",{onClick:D,className:"btn bg-blue-600 hover:bg-blue-700",children:e.jsx(Hr,{className:"w-4 h-4"})})]})]})})]}),e.jsx("div",{className:"card",children:e.jsxs("div",{className:"p-3 rounded-xl border border-yellow-500/40 bg-yellow-500/10",children:[e.jsxs("div",{className:"font-semibold mb-4 flex items-center gap-2",children:[e.jsx(Er,{className:"w-5 h-5 text-yellow-400"})," Achievements & Badges ï¿½"]}),e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-2",children:mn.map(j=>e.jsxs("div",{className:`p-3 rounded-lg border ${j.unlocked?"border-yellow-500/40 bg-yellow-500/10":"border-white/10 bg-white/5"}`,title:j.desc,children:[e.jsx("div",{className:"text-lg",children:j.icon}),e.jsx("div",{className:"text-xs font-semibold mt-1",children:j.label}),e.jsx("div",{className:"text-[10px] opacity-70",children:j.unlocked?"âœ“ Unlocked":"Locked"})]},j.key))})]})})]})}function yh({onAuth:t}){const[n,s]=o.useState("signin"),[a,r]=o.useState(""),[i,l]=o.useState(""),[u,f]=o.useState(""),[c,m]=o.useState(""),[p,h]=o.useState(""),[N,w]=o.useState(!1),[b,g]=o.useState(!1),y=dl();async function M(k){k.preventDefault(),h(""),g(!0);try{rn(()=>import("./Home-LuCsJ0Kz.js"),__vite__mapDeps([0,1,2,3])),rn(()=>import("./OnlinePlay.clean-CN7HYk28.js"),__vite__mapDeps([4,1,2,5])),rn(()=>import("./OfflinePlay-DjuWU6he.js"),__vite__mapDeps([6,1,2,5,3])),rn(()=>import("./Scoreboard-_rvnj03B.js"),__vite__mapDeps([7,3,2,1])),rn(()=>import("./StatsPanel-DoVTHWBw.js"),__vite__mapDeps([8,3,1,2]))}catch{}if(!i||!u){h("Username and password required."),g(!1);return}try{console.time("Auth:signIn roundtrip");const T=await fetch(`${y}/api/auth/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i.includes("@")?{email:i,password:u}:{username:i,password:u})}),E=await T.json();console.timeEnd("Auth:signIn roundtrip"),T.ok&&E?.user&&E?.token?(localStorage.setItem("authToken",E.token),t(E.user)):h(E?.error||"Invalid username or password.")}catch{h("Network error.")}finally{g(!1)}}async function L(k){if(k.preventDefault(),h(""),g(!0),!a||!i||!u){h("Email, username, and password required."),g(!1);return}try{const T=await fetch(`${y}/api/auth/signup`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:a,username:i,password:u})}),E=await T.json();T.ok&&E?.user&&E?.token?(localStorage.setItem("authToken",E.token),t(E.user)):h(E?.error||"Signup failed.")}catch{h("Network error.")}finally{g(!1)}}async function S(k){if(k.preventDefault(),h(""),g(!0),!a||!a.includes("@")){h("Enter your email address."),g(!1);return}try{const E=await(await fetch(`${y}/api/auth/send-reset`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:a})})).json();if(!E?.ok)throw new Error(E?.error||"Failed to send reset email");h("Password reset link sent to your email.")}catch(T){h(T?.message||"Failed to send reset email")}finally{g(!1)}}async function I(k){if(k.preventDefault(),h(""),g(!0),!a||!a.includes("@")){h("Enter your email address."),g(!1);return}try{const E=await(await fetch(`${y}/api/auth/send-username`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:a})})).json();if(!E?.ok)throw new Error(E?.error||"Failed to send username email");h("Your username has been emailed to you.")}catch(T){h(T?.message||"Failed to send username email")}finally{g(!1)}}return e.jsxs("div",{className:"min-h-screen flex items-center justify-center bg-[#0F0C1D] p-4 relative overflow-hidden",children:[e.jsxs("div",{className:"absolute top-0 left-0 w-full h-full overflow-hidden pointer-events-none",children:[e.jsx("div",{className:"absolute -top-[10%] -left-[10%] w-[40%] h-[40%] bg-indigo-500/10 blur-[120px] rounded-full"}),e.jsx("div",{className:"absolute -bottom-[10%] -right-[10%] w-[40%] h-[40%] bg-purple-500/10 blur-[120px] rounded-full"})]}),e.jsxs("div",{className:"w-full max-w-md relative z-10",children:[e.jsxs("div",{className:"text-center mb-8",children:[e.jsx("h1",{className:"text-4xl font-black text-transparent bg-clip-text bg-gradient-to-r from-white via-white to-white/40 tracking-tighter mb-2",children:"NINE-DART-NATION ðŸŽ¯"}),e.jsx("p",{className:"text-white/40 font-medium uppercase tracking-[0.3em] text-xs",children:n==="signin"?"Sign In ðŸ”‘":n==="signup"?"Create Account âœ¨":"Reset Password ðŸ”„"})]}),e.jsx("div",{className:"flex items-center justify-center gap-3 mb-6",children:[{key:"signin",label:"Sign In"},{key:"signup",label:"Sign Up"},{key:"reset",label:"Reset"}].map(k=>e.jsx("button",{type:"button",onClick:()=>s(k.key),className:`px-4 py-1.5 rounded-full text-xs font-bold tracking-wide transition-all ${n===k.key?"bg-white text-indigo-600":"bg-white/5 text-white/70 hover:bg-white/10"}`,children:k.label},k.key))}),e.jsx("div",{className:"bg-white/[0.03] border border-white/10 backdrop-blur-xl rounded-[2.5rem] p-8 shadow-2xl",children:e.jsxs("form",{className:"space-y-4",onSubmit:n==="signin"?M:n==="signup"?L:S,children:[(n==="signup"||n==="reset")&&e.jsx("input",{className:"input w-full",type:"email",placeholder:"Email",value:a,onChange:k=>r(k.target.value),required:!0}),n!=="reset"&&e.jsx("input",{className:"input w-full",type:"text",placeholder:"Username or Email",value:i,onChange:k=>l(k.target.value),required:!0}),n!=="reset"&&e.jsxs("div",{className:"relative",children:[e.jsx("input",{className:"input w-full pr-10",type:N?"text":"password",placeholder:"Password",value:u,onChange:k=>f(k.target.value),autoComplete:"current-password",required:!0,onFocus:()=>w(!1),onBlur:()=>w(!1)}),e.jsx("button",{type:"button",className:"absolute right-2 top-1/2 -translate-y-1/2 text-slate-300 hover:text-white",tabIndex:-1,onMouseDown:k=>{k.preventDefault(),w(!0)},onMouseUp:k=>{k.preventDefault(),w(!1)},onMouseLeave:()=>w(!1),onTouchStart:k=>{k.preventDefault(),w(!0)},onTouchEnd:k=>{k.preventDefault(),w(!1)},"aria-label":"Toggle password visibility",children:N?e.jsx(Sc,{className:"w-5 h-5"}):e.jsx(kr,{className:"w-5 h-5"})})]}),n==="signup"&&e.jsx("input",{className:"input w-full",type:"text",placeholder:"Password Reminder (optional)",value:c,onChange:k=>m(k.target.value)}),p&&e.jsx("div",{className:"text-red-400 font-semibold text-sm",children:p}),e.jsx("button",{type:"submit",disabled:b,className:"w-full py-4 rounded-2xl bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-bold shadow-lg shadow-indigo-500/20 hover:scale-[1.02] active:scale-[0.98] transition-all disabled:opacity-50 disabled:hover:scale-100",children:b?e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("div",{className:"w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"}),"Processing..."]}):n==="signin"?"Sign In ðŸ”‘":n==="signup"?"Sign Up âœ¨":"Send Reset Link ðŸ“§"}),n==="signin"&&e.jsx("button",{type:"button",onClick:I,className:"w-full py-2 text-xs font-bold text-white/30 hover:text-white/60 transition-colors",children:"Email me my username ðŸ“§"})]})}),e.jsx("div",{className:"mt-12 grid grid-cols-1 gap-4",children:e.jsxs("div",{className:"p-6 rounded-3xl bg-white/[0.02] border border-white/5",children:[e.jsx("h3",{className:"text-xl font-bold mb-3 text-white/90",children:"What's inside ðŸ“¦"}),e.jsxs("ul",{className:"space-y-3",children:[e.jsxs("li",{className:"flex items-start gap-3",children:[e.jsx(Va,{className:"w-5 h-5 text-indigo-300 mt-1"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold",children:"Online & Friends"}),e.jsx("div",{className:"text-sm text-slate-200/90",children:"Challenge friends, chat, and join leagues."})]})]}),e.jsxs("li",{className:"flex items-start gap-3",children:[e.jsx(Cc,{className:"w-5 h-5 text-indigo-300 mt-1"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold",children:"Deep Stats"}),e.jsx("div",{className:"text-sm text-slate-200/90",children:"Track 3-dart averages, best legs, and more."})]})]}),e.jsxs("li",{className:"flex items-start gap-3",children:[e.jsx(Cs,{className:"w-5 h-5 text-indigo-300 mt-1"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold",children:"Game Modes"}),e.jsx("div",{className:"text-sm text-slate-200/90",children:"Start with 3 free online games upon signup. After that, PREMIUM is required to play all games."})]})]}),e.jsxs("li",{className:"flex items-start gap-3",children:[e.jsx(kc,{className:"w-5 h-5 text-indigo-300 mt-1"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold",children:"Premium Perks"}),e.jsx("div",{className:"text-sm text-slate-200/90",children:"Polished UI, upcoming features, and early access."})]})]}),e.jsxs("li",{className:"flex items-start gap-3",children:[e.jsx(Rn,{className:"w-5 h-5 text-indigo-300 mt-1"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold",children:"Live Support"}),e.jsx("div",{className:"text-sm text-slate-200/90",children:"Chat with moderators whenever you need a hand."})]})]})]})]})})]})]})}const Eo=ph;function wh({open:t,onClose:n,width:s=700,title:a,footer:r,children:i,side:l="right"}){const[u,f]=dt.useState(null),c=dt.useRef(null),m=dt.useRef(null),p=w=>{c.current={x:w.targetTouches[0].clientX,y:w.targetTouches[0].clientY}},h=w=>{m.current={x:w.targetTouches[0].clientX,y:w.targetTouches[0].clientY}},N=()=>{if(!c.current||!m.current)return;const w=c.current.x-m.current.x,b=c.current.y-m.current.y,g=50;(l==="left"&&w>g||l==="right"&&w<-g||l==="bottom"&&b<-g)&&n(),c.current=null,m.current=null};return o.useEffect(()=>{function w(b){b.key==="Escape"&&n()}return t&&document.addEventListener("keydown",w),()=>document.removeEventListener("keydown",w)},[t,n]),o.useEffect(()=>{if(!t)return;const w=document.body.style.overflow,b=document.body.style.paddingRight,g=window.innerWidth-document.documentElement.clientWidth;return document.body.style.overflow="hidden",g>0&&(document.body.style.paddingRight=`${g}px`),()=>{document.body.style.overflow=w,document.body.style.paddingRight=b}},[t]),o.useEffect(()=>{function w(){try{const y=document.getElementById("ndn-header");if(!y){f(null);return}const M=y.getBoundingClientRect(),L=Math.ceil(M.bottom)+10;f(L)}catch{f(null)}}w(),window.addEventListener("resize",w),window.addEventListener("orientationchange",w);const b=new MutationObserver(w),g=document.getElementById("ndn-header");return g&&b.observe(g,{attributes:!0,childList:!0,subtree:!0}),()=>{window.removeEventListener("resize",w),window.removeEventListener("orientationchange",w),b.disconnect()}},[t]),e.jsxs("div",{className:`fixed inset-0 z-[200] ndn-drawer-root ${t?"":"pointer-events-none"}`,"aria-hidden":!t,children:[e.jsx("div",{className:`absolute inset-0 ndn-drawer-backdrop bg-black/60 transition-opacity ${t?"opacity-100":"opacity-0"}`,onClick:n,role:"button","aria-label":"Close drawer",tabIndex:0,onKeyDown:w=>{(w.key==="Enter"||w.key===" "||w.key==="Escape")&&n()}}),e.jsx("div",{className:`absolute bg-slate-900 border-slate-700 shadow-2xl flex flex-col transition-transform duration-200 ndn-drawer-panel
          ${l==="bottom"?`bottom-0 left-0 right-0 border-t rounded-t-2xl max-h-[85vh] w-full ${t?"translate-y-0":"translate-y-full"}`:`top-0 h-full w-full sm:w-auto ${l==="right"?"right-0 border-l":"left-0 border-r"} ${t?"translate-x-0":l==="right"?"translate-x-full":"-translate-x-full"}`}
        `,style:u&&l!=="bottom"?{top:`${u}px`,height:`calc(100% - ${u}px)`,width:typeof s=="number"?`${s}px`:s}:l==="bottom"?{width:typeof s=="number"?`${s}px`:s}:typeof s=="number"?{width:`${s}px`}:{width:s},"aria-modal":"true",onTouchStart:p,onTouchMove:h,onTouchEnd:N,children:e.jsxs(Bn,{returnFocus:!0,children:[e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b border-slate-800/80 sticky top-0 bg-slate-900/95 backdrop-blur-sm z-40",children:[e.jsx("div",{className:"text-base font-semibold text-white/90",children:a||"Menu"}),e.jsxs("button",{className:"inline-flex items-center gap-2 px-3 py-1.5 rounded-lg bg-white/5 hover:bg-white/10 text-sm font-semibold text-white transition-colors",onClick:n,children:[e.jsx("span",{children:"Close"}),e.jsx(Vr,{className:"w-4 h-4","aria-hidden":"true"})]})]}),e.jsx("div",{className:"flex-1 overflow-auto p-4",children:i}),r&&e.jsx("div",{className:"px-4 py-3 border-t border-slate-700 sticky bottom-0 bg-slate-900 z-10",children:r})]})})]})}function jh(){const[t,n]=o.useState(!1),[s,a]=o.useState([{text:"Hi! I'm your Nine Dart Nation assistant. How can I help you today?",isUser:!1}]),[r,i]=o.useState(""),[l,u]=o.useState(!1),[f,c]=o.useState(""),[m,p]=o.useState(null),h=(()=>{try{return la()}catch{return null}})();o.useEffect(()=>{if(!h)return;const g=h.addListener(y=>{try{y?.type==="help-message"&&m&&(String(y.requestId),String(m.id)),y?.type==="help-request-updated"&&m&&y.request?.id===m.id&&p(y.request)}catch{}});return()=>g()},[h,m]);const N=g=>{try{window.dispatchEvent(new CustomEvent("ndn:change-tab",{detail:{tab:g}})),n(!1)}catch(y){console.error("Navigation failed:",y)}},w=g=>{const y=g.toLowerCase();return y.includes("username")||y.includes("change name")?{text:"You can change your username once for free.",links:[{text:"Go to Settings > Account",tab:"settings"}]}:y.includes("premium")||y.includes("upgrade")||y.includes("subscription")?{text:"Premium unlocks all game modes and features.",links:[{text:"Go to Online Play",tab:"online"}]}:y.includes("calibrat")||y.includes("camera")||y.includes("vision")?{text:"Set up your camera properly in Settings.",links:[{text:"Go to Settings > Camera & Vision",tab:"settings"}]}:y.includes("voice")||y.includes("caller")||y.includes("audio")?{text:"Enable voice calling in Settings.",links:[{text:"Go to Settings > Audio & Voice",tab:"settings"}]}:y.includes("friend")||y.includes("play together")?{text:"Add friends to play together.",links:[{text:"Go to Friends",tab:"friends"}]}:y.includes("stat")||y.includes("score")||y.includes("performance")?{text:"View your statistics and performance.",links:[{text:"Go to Stats",tab:"stats"}]}:y.includes("setting")||y.includes("customiz")||y.includes("configur")?{text:"Customize your experience.",links:[{text:"Go to Settings",tab:"settings"}]}:y.includes("tournament")||y.includes("competition")?{text:"Check out tournaments and competitions.",links:[{text:"Go to Tournaments",tab:"tournaments"}]}:y.includes("score")||y.includes("scoring")||y.includes("autoscore")?{text:"Auto-scoring assigns darts to board segments automatically. You can review and adjust placements in the Match Summary screen.",links:[{text:"Go to Match Summary",tab:"matchsummary"}]}:y.includes("pair")||y.includes("pairing")||y.includes("phone")||y.includes("camera pairing")?{text:"Use the Pairing flow to connect phones and cameras. Make sure devices are on the same Wi-Fi and scan the QR code shown.",links:[{text:"Open Pairing",tab:"pairing"}]}:y.includes("highlight")||y.includes("download")||y.includes("save")?{text:"Highlights can be downloaded or saved to your account from the Highlights section. We keep a record when you hit milestone checkouts or visits.",links:[{text:"Open Highlights",tab:"highlights"}]}:y.includes("privacy")||y.includes("copyright")||y.includes("legal")?{text:"Our Legal Notice and Privacy information are available in the footer. You can view privacy, copyright, and contact details there.",links:[{text:"View Legal Notice",tab:"footer"}]}:y.includes("help")||y.includes("support")||y.includes("faq")?{text:"You're already in the help section! Check Settings for more resources.",links:[{text:"Go to Settings > Support",tab:"settings"}]}:y.includes("how to play")||y.includes("game")||y.includes("start")?{text:"To play darts, select a game mode from the menu. For online play, join a match. For offline, start a local game.",links:[{text:"Play Online",tab:"online"},{text:"Play Offline",tab:"offline"}]}:{text:"I'm not sure about that. Try asking about playing, calibration, premium, username changes, voice settings, friends, stats, or settings."}},b=()=>{if(!r.trim())return;const g=r.trim(),y=g.toLowerCase();if(a(L=>[...L,{text:g,isUser:!0}]),i(""),l)if(y.startsWith("y")){a(L=>[...L,{text:"Okay â€” I will notify an admin. Please wait for them to join the chat.",isUser:!1}]),u(!1),(async()=>{try{const I=await(await ss("/api/help/requests",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:f||g})})).json().catch(()=>null);I&&I.request?(p(I.request),a(k=>[...k,{text:"Okay â€” I will notify an admin. Please wait for them to join the chat.",isUser:!1}])):a(k=>[...k,{text:"Okay â€” I will notify an admin. Please wait for them to join the chat.",isUser:!1}])}catch{a(S=>[...S,{text:"Failed to contact admins. Please try again later.",isUser:!1}])}})();return}else{a(L=>[...L,{text:"Okay â€” I won't notify an admin. If you change your mind, just ask.",isUser:!1}]),u(!1);return}const M=w(y);if(typeof M.text=="string"&&M.text.includes("I'm not sure about that")){c(g),u(!0),setTimeout(()=>{a(L=>[...L,{text:{text:"I can connect you to a member of our admin team â€” would you like that? Type YES or NO.",links:[]},isUser:!1}])},350);return}setTimeout(()=>{a(L=>[...L,{text:M,isUser:!1}])},500)};return e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>n(!0),className:"fixed bottom-4 right-4 z-50 bg-blue-600 hover:bg-blue-700 text-white p-4 rounded-full shadow-lg transition-colors",title:"Help Assistant",children:e.jsx(Er,{className:"w-6 h-6"})}),t&&e.jsxs("div",{className:"fixed inset-0 z-50 flex items-end justify-end p-4",children:[e.jsx("div",{className:"absolute inset-0 bg-black/50",onClick:()=>n(!1)}),e.jsxs("div",{className:"relative bg-slate-800 rounded-lg shadow-xl w-full max-w-md h-96 flex flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 border-b border-slate-700",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Rn,{className:"w-5 h-5 text-blue-400"}),e.jsx("span",{className:"font-semibold",children:"Help Assistant"})]}),e.jsx("button",{onClick:()=>n(!1),className:"text-slate-400 hover:text-white",children:e.jsx(Vr,{className:"w-5 h-5"})})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-4 space-y-3",children:s.map((g,y)=>e.jsx("div",{className:`flex ${g.isUser?"justify-end":"justify-start"}`,children:e.jsx("div",{className:`max-w-xs px-3 py-2 rounded-lg ${g.isUser?"bg-blue-600 text-white":"bg-slate-700 text-slate-200"}`,children:typeof g.text=="string"?g.text:e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{children:g.text.text}),g.text.links&&e.jsx("div",{className:"space-y-1",children:g.text.links.map((M,L)=>e.jsx("button",{onClick:()=>N(M.tab),className:"block w-full text-left text-blue-300 hover:text-blue-200 underline text-sm",children:M.text},L))})]})})},y))}),e.jsx("div",{className:"p-4 border-t border-slate-700",children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{type:"text",value:r,onChange:g=>i(g.target.value),onKeyPress:g=>g.key==="Enter"&&b(),placeholder:"Ask me anything...",className:"flex-1 input"}),e.jsx("button",{onClick:b,className:"btn bg-blue-600 hover:bg-blue-700",children:e.jsx(Hr,{className:"w-4 h-4"})})]})})]})]}),m&&e.jsx(Ol,{request:m,user:{email:null,username:null,isAdmin:!1},onClose:()=>p(null)})]})}function Nh(){const t=vn(),n=o.useRef({}),s=o.useRef({});return o.useEffect(()=>{function a(c="[GlobalCamera]"){try{const m=t.getVideoElementRef(),p=t.getMediaStream(),h=t.getPcRef&&t.getPcRef(),N=t.getWsRef&&t.getWsRef();Le(c,{isStreaming:t.isStreaming,mode:t.mode,showOverlay:t.showOverlay,hasVideoElement:!!m,video:m?{videoWidth:m.videoWidth,videoHeight:m.videoHeight,srcObject:!!m.srcObject}:null,mediaTracks:p?p.getTracks().map(w=>({kind:w.kind,enabled:w.enabled,id:w.id})):null,pcState:h?h.connectionState||h.iceConnectionState:null,wsState:N?N.readyState||"unknown":null})}catch(m){console.warn("[GlobalCamera] dumpState failed",m)}}a("[GlobalCamera] INIT");let r=!0;const i=setInterval(()=>{if(r)try{const c=t.getVideoElementRef(),m=t.getMediaStream(),p=t.getPcRef&&t.getPcRef(),h={isStreaming:t.isStreaming,mode:t.mode,hasVideo:!!c,videoW:c?c.videoWidth:0,videoH:c?c.videoHeight:0,tracks:m?m.getTracks().length:0,pcState:p?p.connectionState||p.iceConnectionState:null},N=n.current;(h.isStreaming!==N.isStreaming||h.hasVideo!==N.hasVideo||h.videoW!==N.videoW||h.videoH!==N.videoH||h.tracks!==N.tracks||h.pcState!==N.pcState||t.showOverlay!==N.showOverlay)&&(n.current=h,a("[GlobalCamera] CHANGE"))}catch(c){console.warn("[GlobalCamera] poll failed",c)}},750);function l(c){try{const m=s.current.video;if(m&&m.el===c)return;if(m&&m.el){try{m.el.removeEventListener("loadedmetadata",m.loadedmetadata)}catch{}try{m.el.removeEventListener("playing",m.playing)}catch{}try{m.el.removeEventListener("pause",m.pause)}catch{}try{m.el.removeEventListener("ended",m.ended)}catch{}}if(s.current.video=null,c){const p=()=>Le("[GlobalCamera] video loadedmetadata",{videoWidth:c.videoWidth,videoHeight:c.videoHeight}),h=()=>{Le("[GlobalCamera] video playing",{paused:c.paused})},N=()=>{Le("[GlobalCamera] video pause")},w=()=>{Le("[GlobalCamera] video ended")};c.addEventListener("loadedmetadata",p),c.addEventListener("playing",h),c.addEventListener("pause",N),c.addEventListener("ended",w),s.current.video={el:c,loadedmetadata:p,playing:h,pause:N,ended:w}}}catch(m){console.warn("[GlobalCamera] attachVideoListeners failed",m)}}function u(c){try{const m=s.current.pc;if(m&&m.pc===c)return;if(m&&m.pc)try{m.pc.removeEventListener("connectionstatechange",m.connChange)}catch{}if(s.current.pc=null,c){const p=()=>Le("[GlobalCamera] pc state change",{connectionState:c.connectionState,iceState:c.iceConnectionState});c.addEventListener("connectionstatechange",p),s.current.pc={pc:c,connChange:p}}}catch(m){console.warn("[GlobalCamera] attachPc failed",m)}}const f=setInterval(()=>{try{l(t.getVideoElementRef()),u(t.getPcRef&&t.getPcRef())}catch{}},1e3);return()=>{r=!1,clearInterval(i),clearInterval(f);try{const c=s.current.video;c&&c.el&&(c.el.removeEventListener("loadedmetadata",c.loadedmetadata),c.el.removeEventListener("playing",c.playing))}catch{}try{const c=s.current.pc;c&&c.pc&&c.pc.removeEventListener("connectionstatechange",c.connChange)}catch{}}},[t]),null}function Sh(){const t=vn(),n=o.useRef(null),s=o.useRef(null),a=o.useRef(0),r=o.useRef(0),i=o.useRef(0),l=o.useRef(0);return o.useEffect(()=>{n.current&&t.setVideoElementRef(n.current)},[t]),o.useEffect(()=>{let u=!0;const f=async()=>{if(u)try{const m=t.getMediaStream(),p=n.current;if(!p||!m)return;(s.current!==m||p.srcObject!==m)&&(p.srcObject=m,s.current=m),p.muted=!0,p.playsInline=!0;try{await p.play()}catch{}}catch{}};f();const c=setInterval(f,750);return()=>{u=!1,clearInterval(c)}},[t]),o.useEffect(()=>{const f=setInterval(()=>{const c=n.current,m=Date.now();if(!c||!t.isStreaming||t.mode!=="phone"){r.current=0;return}if(!c.srcObject){const h=[3e3,6e3,1e4][Math.min(l.current,2)];if(m-i.current>=h){i.current=m,l.current=Math.min(l.current+1,3);try{window.dispatchEvent(new CustomEvent("ndn:phone-camera-reconnect",{detail:{reason:"missing-stream",ts:m}})),c.play().catch(()=>{})}catch{}}return}const p=c.currentTime||0;if(Number.isFinite(p))if(p===a.current?r.current+=1:r.current=0,a.current=p,r.current>=3){const h=[3e3,6e3,1e4][Math.min(l.current,2)];if(m-i.current>=h){i.current=m,l.current=Math.min(l.current+1,3);try{window.dispatchEvent(new CustomEvent("ndn:phone-camera-reconnect",{detail:{reason:"stall",ts:m}})),c.play().catch(()=>{})}catch{}}}else r.current===0&&(l.current=0)},1e3);return()=>clearInterval(f)},[t]),e.jsx("video",{ref:n,style:{position:"fixed",width:1,height:1,left:-9999,top:-9999,opacity:0},muted:!0,playsInline:!0,"aria-hidden":!0})}function Ul(t){const n=vn.getState(),s=pe.getState(),a=Date.now();s.preferredCameraLabel==="Phone Camera"||n.mode==="phone"?window.dispatchEvent(new CustomEvent("ndn:phone-camera-reconnect",{detail:{reason:t,ts:a}})):window.dispatchEvent(new Event("ndn:camera-reset"))}const _r="ndn:camera-recovery";function Ch(t){window.dispatchEvent(new CustomEvent(_r,{detail:t}))}function kh(){const t=pe(m=>!!m.cameraEnabled),n=pe(m=>m.preferredCameraLabel),s=t,a=vn(),r=o.useRef(-1),i=o.useRef(0),l=o.useRef(0),u=o.useRef(0),f=o.useRef(!1),c=o.useRef(null);return o.useEffect(()=>{if(!s)return;const m=b=>{const g=b*.15,y=(Math.random()*2-1)*g;return Math.max(500,Math.round(b+y))},p=b=>{const g=Date.now(),y=[2500,5e3,1e4,18e3,3e4][Math.min(u.current,4)],M=m(y);if(!(g-l.current<M)&&!f.current){f.current=!0,l.current=g,c.current=b,u.current=Math.min(u.current+1,5);try{Ul(b),Ch({reason:b,ts:g})}catch{}window.setTimeout(()=>{f.current=!1},1500)}},h=()=>{try{const b=a.getMediaStream?.()||null;if(!(!!a.isStreaming||!!b)){i.current=0,r.current=-1,u.current=0,f.current=!1,c.current=null;return}const y=a.getVideoElementRef?.()||null;if(!y){i.current=0,r.current=-1,b&&p("watchdog-detached");return}if(b&&!y.srcObject)try{y.srcObject=b}catch{}try{const L=b?.getVideoTracks?.()||[];if(b&&L.length>0&&L.every(S=>S.readyState==="ended"||S.muted)){p("watchdog-ended-track");return}}catch{}try{if(y.paused&&(y.play?.().catch?.(()=>{}),i.current+=1,i.current>=6)){p("watchdog-paused");return}}catch{}const M=Number(y.currentTime||0);if(!Number.isFinite(M)||(r.current===M?i.current+=1:i.current=0,r.current=M,i.current<4))return;p("watchdog-stall")}catch{}},N=()=>{try{if(document.visibilityState==="visible"){const b=a.getVideoElementRef?.()||null;try{b?.play?.().catch?.(()=>{})}catch{}(a.isStreaming||a.getMediaStream?.())&&p("watchdog-visibility-resume")}}catch{}},w=window.setInterval(h,1e3);return document.addEventListener("visibilitychange",N),()=>{window.clearInterval(w),document.removeEventListener("visibilitychange",N)}},[s,n,a]),null}function Eh(t){return t.includes("ended-track")?"Camera stream ended. Recoveringâ€¦":t.includes("paused")?"Camera paused. Recoveringâ€¦":t.includes("detached")?"Camera preview detached. Reconnectingâ€¦":t.includes("visibility")?"Welcome back. Refreshing cameraâ€¦":"Camera froze. Recoveringâ€¦"}function Th(){const t=oi(),n=o.useRef(0);return o.useEffect(()=>{const s=a=>{const i=a.detail;if(!i?.ts)return;const l=Date.now();l-n.current<8e3||(n.current=l,t(Eh(i.reason),{type:"info",actionLabel:"Retry now",onAction:()=>{try{Ul("user-click")}catch{}}}))};return window.addEventListener(_r,s),()=>{window.removeEventListener(_r,s)}},[t]),null}const To={};function Dh(){const[t,n]=o.useState(!1),s=To?.VITE_PLAY_STORE_URL||"",a=To?.VITE_APP_STORE_URL||"",r=o.useRef(null);o.useEffect(()=>{if(!t)return;const l=f=>{f.key==="Escape"&&n(!1)},u=f=>{const c=f.target;c&&(r.current&&r.current.contains(c)||n(!1))};return document.addEventListener("mousedown",u),document.addEventListener("touchstart",u),window.addEventListener("keydown",l),()=>{document.removeEventListener("mousedown",u),document.removeEventListener("touchstart",u),window.removeEventListener("keydown",l)}},[t]);async function i(){try{if(window.promptInstallApp){const l=await window.promptInstallApp()}else navigator?.standalone||"onappinstalled"in window?alert("App is already installed or your browser does not support programmatic install."):alert("Install is not available for your browser. Try using the share menu (iOS) or the install prompt (Chrome/Edge on Android).")}catch{}}return e.jsxs("div",{className:"relative inline-block",ref:r,children:[e.jsx("button",{className:"px-2 py-1 rounded-full border border-white/10 bg-white/5 hover:bg-white/10 text-sm text-white flex items-center gap-2",onClick:()=>n(l=>!l),title:"Install or download app",children:"Install"}),t&&e.jsxs("div",{role:"dialog","aria-modal":"true",className:"absolute right-0 mt-2 z-40 w-80 max-w-[calc(100vw-2rem)] rounded-3xl border border-white/15 bg-slate-900/95 p-5 text-white shadow-2xl",children:[e.jsx("button",{className:"absolute right-3 top-3 flex h-7 w-7 items-center justify-center rounded-full bg-rose-500 text-sm font-bold text-white shadow hover:bg-rose-400",onClick:()=>n(!1),"aria-label":"Close install picker",children:"Ã—"}),e.jsxs("div",{className:"pr-6",children:[e.jsx("div",{className:"text-lg font-semibold",children:"Install or Download"}),e.jsx("p",{className:"text-sm text-white/70",children:"Install the Progressive Web App or jump to the native stores when available."})]}),e.jsxs("div",{className:"mt-4 flex flex-col space-y-2",children:[e.jsx("button",{className:"btn",onClick:()=>i(),children:"Install (PWA)"}),s?e.jsx("a",{className:"btn",target:"_blank",rel:"noreferrer",href:s,children:"Android (Google Play)"}):e.jsx("div",{className:"text-xs opacity-80",children:"Android native build not provided"}),a?e.jsx("a",{className:"btn",target:"_blank",rel:"noreferrer",href:a,children:"iOS (App Store)"}):e.jsx("div",{className:"text-xs opacity-80",children:"iOS native build not provided"}),e.jsx("div",{className:"text-xs opacity-70",children:'iOS: Open Safari â†’ Share â†’ "Add to Home Screen" to pin this dashboard like a native app.'})]})]})]})}function Ih(){const[t,n]=o.useState(!1),[s,a]=o.useState(!1),r=o.useRef(null);o.useEffect(()=>{try{const l=u=>{u.preventDefault(),window.deferredInstallPrompt=u,n(!0)};return window.addEventListener("beforeinstallprompt",l),window.deferredInstallPrompt&&n(!0),()=>window.removeEventListener("beforeinstallprompt",l)}catch{}},[]);async function i(){try{if(window.promptInstallApp)await window.promptInstallApp()||a(!0);else if(window.deferredInstallPrompt){const l=window.deferredInstallPrompt;l.prompt();const u=await l.userChoice;u&&u.outcome==="accepted"?n(!1):a(!0)}else a(!0)}catch{a(!0)}}return o.useEffect(()=>{if(!s)return;const l=f=>{f.key==="Escape"&&a(!1)},u=f=>{const c=f.target;c&&(r.current&&r.current.contains(c)||a(!1))};return document.addEventListener("mousedown",u),document.addEventListener("touchstart",u),window.addEventListener("keydown",l),()=>{document.removeEventListener("mousedown",u),document.removeEventListener("touchstart",u),window.removeEventListener("keydown",l)}},[s]),e.jsxs("div",{className:"relative inline-block",ref:r,children:[e.jsx("button",{onClick:i,className:"px-2 py-1 rounded-full border border-white/10 bg-white/5 hover:bg-white/10 text-sm",title:"Add to Home Screen","data-available":t?"true":"false",children:"Add to Home Screen"}),s&&e.jsxs("div",{className:"absolute right-0 mt-2 z-40 w-80 max-w-[calc(100vw-2rem)] rounded-3xl border border-white/15 bg-slate-900/95 p-5 text-white shadow-2xl",children:[e.jsx("button",{className:"absolute right-3 top-3 flex h-7 w-7 items-center justify-center rounded-full bg-rose-500 text-sm font-bold text-white shadow hover:bg-rose-400",onClick:()=>a(!1),"aria-label":"Close add-to-home instructions",children:"Ã—"}),e.jsx("h3",{className:"text-lg font-semibold pr-6",children:"Add Nine Dart Nation to Home"}),e.jsx("p",{className:"mt-3 text-sm text-white/80 pr-4",children:Mh()?'Open Safari, tap the share icon, then choose "Add to Home Screen".':'Open your browser menu (â‹® or â‹¯) and choose "Install app" or "Add to Home Screen".'}),e.jsx("p",{className:"mt-2 text-xs text-white/60 pr-4",children:"Installing the PWA keeps alerts, matches, and calibration controls a tap away."}),e.jsxs("div",{className:"mt-4 flex flex-wrap justify-end gap-2",children:[e.jsx("button",{className:"btn btn--ghost px-3 py-1 text-sm",onClick:()=>a(!1),children:"Close"}),e.jsx("button",{className:"btn px-3 py-1 text-sm",onClick:()=>a(!1),children:"Got it"})]})]})]})}function Mh(){try{return/iphone|ipad|ipod/i.test(navigator.userAgent)}catch{return!1}}function Rh(){const[t,n]=o.useState(null);o.useEffect(()=>{try{const a=r=>{r.preventDefault(),n(r)};return window.addEventListener("beforeinstallprompt",a),()=>window.removeEventListener("beforeinstallprompt",a)}catch{}},[]);async function s(){if(!t){alert('Open this site in your browser and use "Add to Home Screen" from the share menu (iOS) or use the browser install prompt (Android/Chrome).');return}try{t.prompt();const a=await t.userChoice;a&&a.outcome==="accepted"&&n(null)}catch(a){console.warn("install failed",a)}}return t?e.jsx("button",{className:"rounded bg-violet-600 text-white px-2 py-1",onClick:()=>s(),children:"Install App"}):null}function Ah(){const[t,n]=o.useState(!1),s=new Date().getFullYear();return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"w-full text-center text-xs text-gray-500 py-2 select-none",children:["Â© ",s," Nine Dart Nation â€”"," ",e.jsx("button",{className:"underline",onClick:()=>n(!0),children:"Legal Notice"}),e.jsx("span",{className:"ml-3 inline-block align-middle",children:e.jsx(Rh,{})})]}),t?e.jsx(Dl,{storageKey:"ndn:modal:legal",className:"w-[640px]",defaultWidth:640,defaultHeight:420,minWidth:420,minHeight:220,initialFitHeight:!0,children:e.jsxs("div",{className:"p-4 space-y-3",children:[e.jsx("div",{className:"text-lg font-semibold",children:"Privacy & Copyright Notice"}),e.jsx("div",{className:"text-sm",children:"âš ï¸ IMPORTANT LEGAL NOTICE"}),e.jsx("div",{className:"text-sm",children:"Copyright Protection: All code, assets, and intellectual property in Nine Dart Nation are protected by copyright law. Unauthorized copying, modification, or distribution of this software is strictly prohibited."}),e.jsx("div",{className:"text-sm",children:"Legal Consequences: Any attempt to edit, reverse-engineer, or redistribute this code will result in immediate legal action, including but not limited to copyright infringement lawsuits and potential criminal charges."}),e.jsx("div",{className:"text-sm",children:"Privacy: Your personal data and gameplay information are protected. Any unauthorized access or data collection violates privacy laws and will be prosecuted to the full extent of the law."}),e.jsx("div",{className:"flex items-center gap-2 mt-3",children:e.jsx("button",{className:"btn",onClick:()=>n(!1),children:"Close"})})]})}):null]})}function Ph(){const t=zt(a=>a.paused),n=zt(a=>a.pauseEndsAt),s=zt(a=>a.setPaused);return o.useEffect(()=>{if(!t||!n)return;const a=Date.now();if(n<=a){s(!1,null);return}const r=n-a,i=setTimeout(()=>s(!1,null),r);return()=>clearTimeout(i)},[t,n,s]),null}function Lh({left:t,right:n,className:s="",sticky:a=!0}){return e.jsxs("div",{className:`${a?"sticky top-0":""} card relative overflow-hidden flex items-center justify-between gap-2 mb-2 px-2 sm:px-3 py-2 rounded-xl bg-white/10 border border-white/10 z-10 backdrop-blur-sm ${s}`,children:[e.jsx("div",{className:"pointer-events-none absolute inset-0 bg-gradient-to-b from-slate-900/30 via-slate-900/10 to-transparent"}),e.jsxs("div",{className:"flex items-center gap-2 text-xs sm:text-sm leading-none flex-wrap",children:[t," ðŸŽ¯"]}),e.jsx("div",{className:"flex items-center gap-1 flex-wrap justify-end",children:n})]})}function Oh({gameMode:t,players:n,matchScore:s,gameRules:a}){return!n||n.length===0?null:e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-2 mb-3",children:n.map((r,i)=>e.jsxs("div",{className:`rounded-lg border p-3 ${r.isCurrentTurn?"border-emerald-500/40 bg-emerald-500/10":"border-slate-500/40 bg-slate-500/10"}`,children:[e.jsx("div",{className:`text-sm font-semibold mb-2 uppercase tracking-wide ${r.isCurrentTurn?"text-emerald-300":"text-slate-300"}`,children:r.name}),e.jsxs("div",{className:"space-y-1 text-sm",children:[t==="X01"&&e.jsxs(e.Fragment,{children:[e.jsx(Qe,{label:"Legs Won",value:`â— ${r.legsWon||0}`,highlight:!0}),e.jsx(Qe,{label:"Score",value:r.score||0,mono:!0,bold:!0}),e.jsx(Qe,{label:"Last Score",value:r.lastScore||"0",mono:!0}),e.jsx(Qe,{label:"C/Out Rate",value:`${r.checkoutRate||0}%`,mono:!0}),e.jsx(Qe,{label:"Best Leg",value:r.bestLeg||"â€”",mono:!0}),r.matchAvg!==void 0&&r.allTimeAvg!==void 0&&e.jsx(e.Fragment,{children:e.jsxs("div",{className:"border-t border-white/20 pt-1 mt-1",children:[e.jsx(Qe,{label:"Match Avg",value:r.matchAvg.toFixed(2),mono:!0,bold:!0,highlight:r.matchAvg>0}),e.jsx(Fh,{matchAvg:r.matchAvg,allTimeAvg:r.allTimeAvg})]})})]}),(t==="Cricket"||t==="American Cricket")&&e.jsxs(e.Fragment,{children:[e.jsx(Qe,{label:"Closed",value:Uh(r.closed),mono:!0}),e.jsx(Qe,{label:"Points",value:r.points||0,mono:!0,bold:!0}),e.jsx(Qe,{label:"Status",value:_h(r),highlight:r.isCurrentTurn})]}),(t==="Shanghai"||t==="Halve It")&&e.jsxs(e.Fragment,{children:[e.jsx(Qe,{label:t==="Shanghai"?"Round":"Stage",value:r.round||1,mono:!0}),e.jsx(Qe,{label:"Target",value:r.target||"â€”",mono:!0}),e.jsx(Qe,{label:"Score",value:r.score||0,mono:!0,bold:!0})]}),t==="Killer"&&e.jsxs(e.Fragment,{children:[e.jsx(Qe,{label:"Target #",value:r.number||"â€”",mono:!0,bold:!0}),e.jsx(Qe,{label:"Lives",value:r.lives||0,mono:!0,bold:!0}),r.eliminated&&e.jsx(Qe,{label:"Status",value:"ELIMINATED",highlight:!1})]}),t==="High-Low"&&e.jsxs(e.Fragment,{children:[e.jsx(Qe,{label:"Round",value:r.round||1,mono:!0}),e.jsx(Qe,{label:"Target",value:r.target||"High",mono:!0}),e.jsx(Qe,{label:"Score",value:r.score||0,mono:!0,bold:!0})]}),(t==="Double Practice"||t==="Treble Practice"||t==="Around the Clock")&&e.jsxs(e.Fragment,{children:[e.jsx(Qe,{label:"Target",value:r.target||"â€”",mono:!0,bold:!0}),e.jsx(Qe,{label:"Hits",value:r.hits||0,mono:!0,bold:!0}),r.totalNeeded&&e.jsx(Qe,{label:"Progress",value:`${r.hits||0} / ${r.totalNeeded}`,mono:!0})]}),(t==="Count-Up"||t==="High Score"||t==="Low Score")&&e.jsxs(e.Fragment,{children:[e.jsx(Qe,{label:"Round",value:r.round||1,mono:!0}),e.jsx(Qe,{label:"Score",value:r.score||0,mono:!0,bold:!0}),t==="High Score"&&e.jsx(Qe,{label:"Best",value:r.bestScore||0,mono:!0})]}),(t==="Checkout 170"||t==="Checkout 121")&&e.jsxs(e.Fragment,{children:[e.jsx(Qe,{label:"Remaining",value:r.remaining||0,mono:!0,bold:!0}),e.jsx(Qe,{label:"Attempts",value:r.attempts||0,mono:!0}),e.jsx(Qe,{label:"Successes",value:r.successes||0,mono:!0})]}),t==="Bob's 27"&&e.jsxs(e.Fragment,{children:[e.jsx(Qe,{label:"Target",value:`D${r.target||1}`,mono:!0,bold:!0}),e.jsx(Qe,{label:"Score",value:r.score||0,mono:!0,bold:!0})]}),t==="Baseball"&&e.jsxs(e.Fragment,{children:[e.jsx(Qe,{label:"Inning",value:r.inning||1,mono:!0}),e.jsx(Qe,{label:"Score",value:r.score||0,mono:!0,bold:!0})]}),t==="Golf"&&e.jsxs(e.Fragment,{children:[e.jsx(Qe,{label:"Hole",value:r.hole||1,mono:!0}),e.jsx(Qe,{label:"Strokes",value:r.strokes||0,mono:!0,bold:!0})]}),t==="Tic Tac Toe"&&e.jsxs(e.Fragment,{children:[e.jsx(Qe,{label:"Turn",value:r.turn||1,mono:!0}),r.winner&&e.jsx(Qe,{label:"Result",value:"WINNER!",highlight:!0})]}),s&&(t==="X01"||t==="Cricket"||t==="American Cricket")&&i===1&&e.jsx("div",{className:"border-t border-white/10 pt-1 mt-1",children:e.jsx(Qe,{label:"Match",value:s,mono:!0,bold:!0,highlight:!0})})]})]},i))})}function Qe({label:t,value:n,mono:s=!1,bold:a=!1,highlight:r=!1}){return e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("span",{className:"opacity-70",children:[t," ðŸŽ¯:"]}),e.jsx("span",{className:`${s?"font-mono":""} ${a?"font-semibold":""} ${r?"text-emerald-300":""}`,children:n})]})}function Fh({matchAvg:t,allTimeAvg:n}){const s=t-n,a=s>0,r=Math.abs(s)<.01;let i="",l="text-slate-300";return r?(i="= All-time ðŸŽ¯",l="text-slate-300"):a?(i=`+${s.toFixed(2)} vs avg ðŸŽ¯`,l="text-emerald-400"):(i=`${s.toFixed(2)} vs avg ðŸŽ¯`,l="text-orange-400"),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"opacity-70",children:"AVG vs Avg ðŸŽ¯:"}),e.jsx("span",{className:`font-mono font-semibold ${l}`,children:i})]})}function Uh(t){return!t||Object.keys(t).length===0?"â€”":Object.entries(t).filter(([s,a])=>a===3).map(([s])=>s==="25"?"B":s).join(",")||"â€”"}function _h(t){if(!t.closed)return"Starting ðŸŽ¯";const n=Object.values(t.closed).filter(s=>s===3).length;return n===0?"No marks ðŸŽ¯":n<7?`${n}/7 ðŸŽ¯`:"Closing in ðŸŽ¯"}function $h({inProgress:t=!0,startingScore:n=501,pendingEntries:s=[],onAddVisit:a,onUndo:r,onEndLeg:i,onNextPlayer:l,onEndGame:u,showDartsSelect:f=!0,quickButtons:c=[180,140,100,60]}){const[m,p]=o.useState(0),[h,N]=o.useState(3);return t?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsx("input",{className:"input w-32",type:"number",value:m,onChange:w=>p(parseInt(w.target.value||"0")),onKeyDown:w=>{w.key==="Enter"&&(w.preventDefault(),a(Math.max(0,Number.isFinite(m)?m:0),h),p(0))},placeholder:"Score"}),f&&e.jsxs("select",{className:"input",value:h,onChange:w=>N(parseInt(w.target.value)),children:[e.jsx("option",{value:1,children:"1 dart"}),e.jsx("option",{value:2,children:"2 darts"}),e.jsx("option",{value:3,children:"3 darts"})]}),e.jsx("button",{className:"btn",onClick:()=>{a(Math.max(0,Number.isFinite(m)?m:0),h),p(0)},children:"Add Visit âž•"}),e.jsx("button",{className:"px-3 py-2 rounded-xl border border-slate-200",onClick:()=>r&&r(),title:"Undo",children:e.jsx(Ec,{className:"w-4 h-4"})})]}),c&&c.length>0&&e.jsxs("div",{className:"flex flex-wrap items-center gap-2 mt-2 text-xs",children:[e.jsx("span",{className:"opacity-70",children:"Quick:"}),c.map(w=>e.jsx("button",{className:"btn px-2 py-0.5 text-xs",onClick:()=>a(w,3),children:w},String(w)))]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsxs("button",{className:"btn",onClick:()=>{i&&i(m),p(0)},children:["End Leg (Checkout ",m||0,") ï¿½"]}),e.jsx("button",{className:"btn bg-slate-700 hover:bg-slate-800",onClick:()=>l&&l(),children:"Next Player ðŸ‘¤"}),e.jsx("button",{className:"btn bg-emerald-600 hover:bg-emerald-700",onClick:()=>{u&&u()},children:"End Game ï¿½"})]})]}):e.jsx("p",{className:"text-slate-600",children:"No game in progress."})}const Bh=[...Array.from({length:20},(t,n)=>({label:`D${n+1}`,score:(n+1)*2})),{label:"DBULL",score:50,isBull:!0}];function Yf(t,n){const s=Bh[n];return!!s&&t===s.score}function Cr(t){const n=t.trim().toUpperCase();if(!n)return null;if(n==="50"||n==="BULL"||n==="DBULL"||n==="IBULL")return 50;if(n==="25"||n==="OBULL")return 25;const s=n.match(/^(S|D|T)?\s*(\d{1,2})$/);if(!s)return null;const a=s[1]||"S",r=parseInt(s[2],10);return r<1||r>20?null:r*(a==="S"?1:a==="D"?2:3)}function Vh(t){return new Promise(n=>setTimeout(n,t))}async function Hh(t,n){const s=Date.now();t.readyState>=1||(t.videoWidth??0)>0||await new Promise(a=>{let r=!1;const i=()=>{r||(r=!0,c(),a())},l=()=>i(),u=()=>i(),f=window.setInterval(()=>{Date.now()-s>n&&i(),t.readyState>=1&&i(),(t.videoWidth??0)>0&&i()},50),c=()=>{try{t.removeEventListener("loadedmetadata",l),t.removeEventListener("canplay",u),window.clearInterval(f)}catch{}};try{t.addEventListener("loadedmetadata",l),t.addEventListener("canplay",u)}catch{}})}async function cs(t){const{video:n,stream:s,attach:a=!0,muted:r=!0,playsInline:i=!0,maxAttempts:l=4,metadataTimeoutMs:u=1200,onPlayError:f}=t;if(!n)return{attached:!1,played:!1,reason:"no video"};const c=(s?.getVideoTracks?.()||[]).filter(p=>p.readyState==="live");if(!s||c.length===0)return{attached:!1,played:!1,reason:"no live stream"};try{r&&(n.muted=!0),i&&(n.playsInline=!0)}catch{}let m=!1;if(a)try{n.srcObject!==s&&(n.srcObject=s),m=!0}catch{return{attached:!1,played:!1,reason:"attach failed"}}for(let p=0;p<l;p++){try{await Hh(n,u)}catch{}try{const h=n.play();if(h&&typeof h.then=="function"&&await h,(n.videoWidth??0)>0&&(n.videoHeight??0)>0)return{attached:m,played:!0};if(n.paused===!1)return{attached:m,played:!0}}catch(h){try{f?.(h)}catch{}}await Vh(120+p*150)}return{attached:m,played:!1,reason:"play retries exhausted"}}function Wh({players:t,playerCalibrations:n,calibrationSkipped:s,onSkip:a,onOpenCalibrator:r,onClose:i}){const l=t.filter(c=>s[c.id]),u=t.filter(c=>!s[c.id]),f=u.length===0;return e.jsx("div",{className:"fixed inset-0 z-60 overflow-y-auto bg-black/90 backdrop-blur-sm py-8 px-4",children:e.jsxs("div",{className:"bg-slate-800 border border-slate-600 rounded-2xl p-6 max-w-2xl w-full mx-auto shadow-2xl",children:[e.jsx("h3",{className:"text-xl font-bold mb-4 text-center",children:"Calibration Check ðŸŽ¯"}),e.jsx("p",{className:"text-sm opacity-70 mb-6 text-center",children:"Check your dartboard calibration before the match starts ðŸŽ¯. Both players must skip or confirm to begin ðŸŽ¯."}),l.length>0&&u.length>0&&e.jsx("div",{className:"mb-4 p-3 bg-blue-900/50 border border-blue-600 rounded-lg",children:e.jsxs("p",{className:"text-sm text-blue-200",children:[l.map(c=>c.name).join(", ")," ",l.length===1?"has":"have"," chosen to skip ðŸŽ¯."," ",u.map(c=>c.name).join(", "),", would you like to skip as well ðŸŽ¯?"]})}),e.jsx("div",{className:"space-y-4",children:t.map(c=>e.jsxs("div",{className:"flex items-center justify-between p-4 bg-slate-700/50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-gradient-to-br from-emerald-400 to-blue-500 flex items-center justify-center text-lg font-bold text-white",children:c.name.split(" ").map(m=>m[0]).join("").toUpperCase().slice(0,2)}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:c.name}),e.jsx("div",{className:"text-xs text-slate-400",children:(()=>{const m=n[c.name],p=ri({H:m?.H,imageSize:m?.imageSize,locked:m?.locked,errorPx:m?.errorPx});return p==="verified"?"Calibrated âœ…":p==="unknown"?"Calibration quality unknown":"Needs calibration"})()})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{className:"btn btn-sm btn-ghost",onClick:()=>r(c.id),children:"Bull Up ðŸŽ¯"}),e.jsx("button",{className:"btn btn-sm btn-primary",onClick:()=>a(c.id),disabled:!!s[c.id],children:s[c.id]?"Skipped âœ“":"Skip ðŸŽ¯"})]})]},c.id))}),e.jsx("div",{className:"mt-6 flex justify-center gap-4",children:e.jsx("button",{className:`btn ${f?"btn-primary":"btn-ghost opacity-50 cursor-not-allowed"}`,disabled:!f,onClick:i,children:"Start Match ðŸŽ¯"})})]})})}async function zh(){const t=[];try{const n=await qh();for(const s of n){const a=await Yh(s,[80,8080,8787,8788,3e3,5e3]);for(const r of a){const i=await Xh(r.ip,r.port);i&&t.push(i)}}}catch(n){console.error("Network discovery failed:",n)}return t}async function qh(){const t=[];try{const n=new RTCPeerConnection({iceServers:[]});n.createDataChannel("");const s=await n.createOffer();return await n.setLocalDescription(s),new Promise(a=>{const r=setTimeout(()=>{n.close(),a(t)},5e3);n.onicecandidate=i=>{if(i.candidate){const u=i.candidate.candidate.match(/(\d+\.\d+\.\d+\.\d+)/);if(u&&u[1]&&!t.includes(u[1])){const f=u[1];Gh(f)&&t.push(f)}}else clearTimeout(r),n.close(),a(t)}})}catch(n){return console.error("Failed to get local IPs:",n),["192.168.1.0"]}}function Gh(t){const n=t.split(".").map(Number);return n[0]===10||n[0]===172&&n[1]>=16&&n[1]<=31||n[0]===192&&n[1]===168}async function Yh(t,n){const s=[],a=t.split(".").slice(0,3).join("."),r=[];for(let l=1;l<=254;l++){const u=`${a}.${l}`;for(const f of n)r.push(Jh(u,f))}return(await Promise.allSettled(r)).forEach((l,u)=>{if(l.status==="fulfilled"&&l.value){const f=u%n.length,c=Math.floor(u/n.length),m=`${a}.${c+1}`;s.push({ip:m,port:n[f]})}}),s}async function Jh(t,n){try{return await fetch(`http://${t}:${n}/`,{method:"HEAD",mode:"no-cors",signal:AbortSignal.timeout(2e3)}),!0}catch{return!1}}async function Xh(t,n){try{const s=["/","/api/info","/api/status","/camera","/stream"];for(const a of s)try{const r=await fetch(`http://${t}:${n}${a}`,{method:"GET",signal:AbortSignal.timeout(3e3)});if(r.ok){const i=r.headers.get("content-type")||"",l=await r.text();if(l.includes("OMNI")||l.includes("omni")||a.includes("omni"))return{id:`omni-${t}-${n}`,name:`OMNI Camera (${t})`,ip:t,port:n,type:"omni",capabilities:["video","calibration"],status:"online",connectionType:"wifi"};if(l.includes("VERT")||l.includes("vert")||a.includes("vert"))return{id:`vert-${t}-${n}`,name:`VERT Camera (${t})`,ip:t,port:n,type:"vert",capabilities:["video","calibration"],status:"online",connectionType:"wifi"};if(i.includes("video")||l.includes("stream")||a==="/stream")return{id:`generic-${t}-${n}`,name:`Network Camera (${t})`,ip:t,port:n,type:"generic",capabilities:["video"],status:"online",connectionType:"wifi"}}}catch{}}catch(s){console.error(`Failed to probe device ${t}:${n}:`,s)}return null}async function Kh(){const t=[];try{if(!("serial"in navigator))return console.warn("Web Serial API not supported in this browser"),t;const n=await navigator.serial.getPorts();for(const s of n){const a=await _l(s);a&&t.push(a)}}catch(n){console.error("USB device discovery failed:",n)}return t}async function Qh(){try{if(!("serial"in navigator))return alert("Web Serial API not supported in this browser. Please use a compatible browser like Chrome or Edge."),null;const t=await navigator.serial.requestPort();return await _l(t)}catch(t){return t.name!=="NotFoundError"&&console.error("USB device request failed:",t),null}}async function _l(t){try{await t.open({baudRate:9600,dataBits:8,stopBits:1,parity:"none"});const n=t.readable?.getReader();if(n)try{const s=setTimeout(()=>n.cancel(),2e3),{value:a,done:r}=await n.read();if(clearTimeout(s),!r&&a){const i=new TextDecoder().decode(a);if(i.includes("OMNI")||i.includes("omni"))return n.releaseLock(),{id:`usb-omni-${Date.now()}`,name:"OMNI Camera (USB)",type:"omni",capabilities:["video","calibration"],status:"online",port:t};if(i.includes("VERT")||i.includes("vert"))return n.releaseLock(),{id:`usb-vert-${Date.now()}`,name:"VERT Camera (USB)",type:"vert",capabilities:["video","calibration"],status:"online",port:t}}}catch{}finally{try{n.releaseLock()}catch{}}return{id:`usb-generic-${Date.now()}`,name:"USB Scoring Device",type:"generic",capabilities:["video"],status:"online",port:t}}catch(n){return console.error("Failed to probe USB device:",n),null}}async function Zh(t){try{const n=`http://${t.ip}:${t.port}/stream`,s=document.createElement("video");return s.src=n,s.crossOrigin="anonymous",new Promise((a,r)=>{s.onloadeddata=()=>{const i=document.createElement("canvas"),l=i.getContext("2d");i.width=s.videoWidth,i.height=s.videoHeight;const u=i.captureStream(30),f=()=>{s.readyState>=2&&l.drawImage(s,0,0),requestAnimationFrame(f)};f(),a(u)},s.onerror=()=>r(new Error("Failed to load video stream")),s.load()})}catch(n){return console.error("Failed to connect to network device:",n),null}}async function ef(t){try{if(!t.port)throw new Error("No serial port available");return console.log("USB device connection not fully implemented yet"),null}catch(n){return console.error("Failed to connect to USB device:",n),null}}function tf({label:t,autoStart:n,forceAutoStart:s=!1,scale:a,className:r,aspect:i="inherit",style:l,fill:u=!1,tileFitModeOverride:f}){const c=o.useRef(null),m=vn(),[p,h]=o.useState(!1),[N,w]=o.useState(null),[b,g]=o.useState(null),y=o.useRef(null),[M,L]=o.useState(null),S=o.useRef(null);o.useEffect(()=>{y.current=b},[b]),o.useEffect(()=>{let _=null,Y=!1;try{const Q=c.current;if(!Q)return;const de=()=>{try{const ft=m.getVideoElementRef?.();(!ft||ft===Q)&&m.setVideoElementRef?.(Q)}catch{}},tt=m.getVideoElementRef?.();tt?tt!==Q&&(_=setTimeout(()=>{Y||de()},200)):de()}catch{}return()=>{Y=!0;try{_&&clearTimeout(_)}catch{}}},[m]);const I=o.useCallback((_,Y="local")=>{try{_?(m.setMediaStream(_),c.current,m.setMode(Y),m.setStreaming(!0),S.current=Y):S.current&&S.current!=="phone"&&(m.setStreaming(!1),m.setMediaStream(null),S.current=null)}catch(Q){console.warn("[CameraTile] Failed to register stream with camera session:",Q)}},[m]),k=o.useCallback(async()=>{try{const _=m.getMediaStream();if(!_)return Le("[CameraTile] attachExistingStream: No existing stream found"),!1;if(!c.current)return Le("[CameraTile] attachExistingStream: No video ref"),!1;const Y=await cs({video:c.current,stream:_,onPlayError:Q=>console.warn("[CameraTile] Play failed:",Q)});return h(!!Y.played),!!Y.played}catch(_){return console.warn("[CameraTile] Failed to reuse global camera stream",_),!1}},[m]),T=o.useCallback(()=>{try{window.dispatchEvent(new CustomEvent("ndn:start-camera",{detail:{mode:"local"}}))}catch{}},[]),E=o.useCallback(async()=>{try{const _=c.current;if(!_)return!1;try{const tt=m.getVideoElementRef?.();(!tt||tt===_)&&m.setVideoElementRef?.(_)}catch{}const Y=m.getMediaStream?.()||null,Q=(Y?.getVideoTracks?.()||[]).filter(tt=>tt.readyState==="live");if(!Y||Q.length===0)return!1;const de=await cs({video:_,stream:Y,onPlayError:tt=>console.warn("[CameraTile] Play failed:",tt)});return h(!!de.played),!!de.played}catch{return!1}},[m]),V=pe(_=>_.preferredCameraLabel),[H,$]=o.useState(()=>V==="Phone Camera"?"phone":localStorage.getItem("ndn:camera:mode")||"local"),[,ce]=o.useState(null),[,me]=o.useState(!1),[xe,we]=o.useState(null),[ye,De]=o.useState(null),[Ue,ge]=o.useState(!0),[He,U]=o.useState([]),[P,ee]=o.useState(!1),[X,re]=o.useState([]),[se,je]=o.useState(!1),le=pe(_=>_.autoscoreProvider),Ne=pe(_=>_.cameraEnabled),Ie=pe(_=>_.setPreferredCameraLocked),Se=pe(_=>_.preferredCameraLocked),Me=pe(_=>_.setPreferredCamera),G=pe(_=>_.preferredCameraId);if(le==="manual"&&!s){const Y=[u?"rounded-2xl overflow-hidden bg-black w-full flex flex-col":"rounded-2xl overflow-hidden bg-black w-full mx-auto",r].filter(Boolean).join(" ").trim(),Q={...l||{}};return!u&&Q.aspectRatio===void 0&&Q.height===void 0&&Q.minHeight===void 0&&(Q.aspectRatio="4 / 3"),e.jsx("div",{className:Y,style:Q,children:e.jsx("div",{className:"flex-1 w-full h-full flex items-center justify-center bg-slate-900 text-slate-200 text-xs p-4 text-center",children:"Manual scoring mode active â€” camera feeds are disabled."})})}o.useEffect(()=>{const _=window.location.hostname;(_==="localhost"||_==="127.0.0.1")&&ss("/api/hosts").then(Y=>Y.json()).then(Y=>{const Q=Array.isArray(Y?.hosts)&&Y.hosts.find(de=>de);Q&&we(Q)}).catch(()=>{}),ss("/api/https-info").then(Y=>Y.json()).then(Y=>{Y&&typeof Y.https=="boolean"&&De({https:!!Y.https,port:Number(Y.port)||8788})}).catch(()=>{})},[]);const Ce=o.useMemo(()=>{const _=b||"____",Y="ws://localhost:8787";if(Y.length>0)try{const yt=new URL(Y);return`${`${yt.protocol==="wss:"?"https":"http"}://${yt.host}${yt.pathname.endsWith("/ws")?"":yt.pathname}`.replace(/\/?ws$/i,"")}/mobile-cam.html?code=${_}`}catch{}const Q=xe||window.location.hostname,de=!!ye?.https,tt=de?ye?.port||8788:8787;return`${de?"https":"http"}://${Q}:${tt}/mobile-cam.html?code=${_}`},[b,xe,ye]);o.useEffect(()=>{localStorage.setItem("ndn:camera:mode",H)},[H]),o.useEffect(()=>{m.isStreaming&&k()},[m.isStreaming,k]);const[he,Ee]=o.useState(null);o.useEffect(()=>{pe.getState().ignorePreferredCameraSync||he&&Date.now()-he<3e4||V==="Phone Camera"&&H!=="phone"&&$("phone")},[V,H,he]),o.useEffect(()=>{const _=async()=>{try{if(!(V==="Phone Camera"&&(!he||Date.now()-he>=3e4)||H==="phone"))return;const ft=m.getMediaStream(),yt=c.current;if(!yt||!ft)return;if((ft.getVideoTracks?.()||[]).filter(lt=>lt.readyState==="live").length===0){console.warn("[CameraTile] Phone attach: stream has no live tracks; skipping attach",ft.id),h(!1);return}yt.srcObject!==ft&&(yt.srcObject=ft);try{const lt=await cs({video:yt,stream:ft});h(!!lt.played)}catch{h(!0)}return!0}catch{}return!1};let Y=!1,Q=null;const de=tt=>{if(tt&&Q&&!Y){Y=!0;try{clearInterval(Q)}catch{}}};return Promise.resolve(_()).then(de).catch(()=>{}),Q=setInterval(()=>{Promise.resolve(_()).then(de).catch(()=>{})},800),()=>{try{Q&&clearInterval(Q)}catch{}}},[V,H,m,m.isStreaming]);const te=o.useCallback(async()=>{if(!await k()){if(H==="wifi")return C();if(V==="Phone Camera"||H==="phone"){const _=m.getMediaStream(),Y=(_?.getVideoTracks?.()||[]).filter(Q=>Q.readyState==="live");if(_&&Y.length>0&&c.current)try{const Q=await cs({video:c.current,stream:_});if(h(!!Q.played),Q.played)return}catch{}if(H==="phone")try{await _e();return}catch{}}try{const _=m.getMediaStream?.(),Y=(_?.getVideoTracks?.()||[]).filter(Q=>Q.readyState==="live");if(_&&Y.length>0&&c.current){const Q=await cs({video:c.current,stream:_});if(h(!!Q.played),Q.played)return}}catch{}}},[H,V,m,I,_e,C,k]);o.useEffect(()=>{if(!c.current)return;let Y=0,Q=null;const de=async()=>{if(Y+=1,await E()){Q&&clearInterval(Q),Q=null;return}(s||n)&&Y===1&&T(),Y>=6&&(Q&&clearInterval(Q),Q=null,(s||n)&&te().catch(()=>{}))};return de(),Q=setInterval(de,650),()=>{try{Q&&clearInterval(Q)}catch{}}},[m,s,n,te,m.isStreaming,E,T]);const Te=o.useCallback(()=>{h(!1)},[I]);o.useEffect(()=>{if(!(!s&&(!Ne||le&&le!=="built-in"&&le!=="external-ws"))&&!(n===void 0&&!s)){if(n||s){let _=!1;const Y=V||"default",Q=window.setTimeout(()=>{_||p||te().catch(de=>console.warn(`[CameraTile] Auto-start failed for ${Y}:`,de))},200);return()=>{_=!0,window.clearTimeout(Q)}}Te()}},[n,s,p,Ne,le,V,te,Te]);async function C(){ee(!0);try{const _=await zh();U(_),_.length===0&&alert("No wifi scoring devices found on your network. Make sure devices are powered on and connected to the same network.")}catch(_){console.error("Wifi device discovery failed:",_),alert("Failed to discover wifi devices. Please check your network connection.")}finally{ee(!1)}}async function B(_){try{U(Q=>Q.map(de=>de.id===_.id?{...de,status:"connecting"}:de));const Y=await Zh(_);if(Y&&c.current)c.current.srcObject=Y,await Promise.resolve(c.current.play()).catch(()=>{}),h(!0),I(Y,"wifi"),U(Q=>Q.map(de=>de.id===_.id?{...de,status:"online"}:de));else throw new Error("Failed to get video stream")}catch(Y){console.error("Failed to connect to wifi device:",Y),alert(`Failed to connect to ${_.name}. Please check the device and try again.`),U(Q=>Q.map(de=>de.id===_.id?{...de,status:"offline"}:de))}}async function A(){je(!0);try{const _=await Kh();re(_);const Y=await Qh();Y&&re(Q=>[...Q,Y]),_.length===0&&!Y&&alert("No USB scoring devices found. Please connect a device and try again.")}catch(_){console.error("USB device discovery failed:",_),alert("Failed to discover USB devices. Please check device connections.")}finally{je(!1)}}async function W(_){try{re(Q=>Q.map(de=>de.id===_.id?{...de,status:"connecting"}:de));const Y=await ef(_);if(Y&&c.current)c.current.srcObject=Y,await Promise.resolve(c.current.play()).catch(()=>{}),h(!0),$("wifi"),I(Y,"wifi"),re(Q=>Q.map(de=>de.id===_.id?{...de,status:"online"}:de));else throw new Error("Failed to get video stream")}catch(Y){console.error("Failed to connect to USB device:",Y),alert(`Failed to connect to ${_.name}. Please check the device and try again.`),re(Q=>Q.map(de=>de.id===_.id?{...de,status:"offline"}:de))}}const ae=o.useCallback(_=>{try{$(_==="usb"?"wifi":_),Ee(Date.now());try{if(_==="local"){try{Me(G,"Local",!0)}catch{}try{Ie(!0)}catch{}}else if(_==="phone"){try{Me(void 0,"Phone Camera",!0)}catch{}try{Ie(!0)}catch{}}else if(_==="wifi"||_==="usb"){try{Me(void 0,"WiFi/USB",!0)}catch{}try{Ie(!0)}catch{}}}catch{}_==="local"?te().catch(()=>{}):_==="phone"?_e():_==="wifi"?C():_==="usb"&&A()}catch(Y){console.warn("[CameraTile] handleModeSelect failed",Y)}},[te,_e,C,A,Me,Ie,G]);o.useEffect(()=>{const _=Y=>{try{const Q=Y&&Y.detail&&Y.detail.mode;Q&&["local","phone","wifi","usb"].includes(Q)?(ae(Q),te().catch(()=>{})):te().catch(()=>{})}catch{}};return window.addEventListener("ndn:start-camera",_),()=>{window.removeEventListener("ndn:start-camera",_)}},[te,ae]);function K(){if(N&&N.readyState===WebSocket.OPEN)return N;const _=Ur(),Y=new WebSocket(_);return w(Y),Y}async function _e(){$("phone"),me(!1);const _=K();_.readyState===WebSocket.OPEN?_.send(JSON.stringify({type:"cam-create"})):_.onopen=()=>_.send(JSON.stringify({type:"cam-create"})),_.onmessage=async Y=>{const Q=JSON.parse(Y.data);if(Q.type==="cam-code")g(Q.code),y.current=Q.code,Q.expiresAt&&ce(Q.expiresAt);else if(Q.type==="cam-peer-joined"){me(!0);const de=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}]});L(de),de.onicecandidate=yt=>{const kt=y.current;yt.candidate&&kt&&_.send(JSON.stringify({type:"cam-ice",code:kt,payload:yt.candidate}))},de.ontrack=yt=>{if(c.current){const kt=yt.streams?.[0];if(kt){c.current.srcObject=kt,c.current.play().catch(()=>{});try{I(kt,"phone"),m.setVideoElementRef?.(c.current)}catch{}h(!0)}}};const tt=await de.createOffer({offerToReceiveAudio:!1,offerToReceiveVideo:!0});await de.setLocalDescription(tt);const ft=y.current;ft&&_.send(JSON.stringify({type:"cam-offer",code:ft,payload:tt}))}else if(Q.type==="cam-answer")M&&await M.setRemoteDescription(new RTCSessionDescription(Q.payload));else if(Q.type==="cam-ice"&&M)try{await M.addIceCandidate(Q.payload)}catch{}}}function Ae(){g(null),ce(null),me(!1),N&&N.readyState===WebSocket.OPEN?N.send(JSON.stringify({type:"cam-create"})):_e();try{Ie(!0)}catch{}}function ut(){if(Te(),g(null),me(!1),ce(null),M){try{M.close()}catch{}L(null)}}return e.jsx(nf,{label:t,autoStart:n,start:te,stopAll:ut,startPhonePairing:_e,startWifiConnection:C,startUsbConnection:A,connectToWifiDevice:B,connectToUsbDevice:W,videoRef:c,streaming:p,mode:H,setMode:$,pairCode:b,mobileUrl:Ce,regenerateCode:Ae,httpsInfo:ye,showTips:Ue,setShowTips:ge,wifiDevices:He,usbDevices:X,discoveringWifi:P,discoveringUsb:se,scaleOverride:a,tileFitModeOverride:f,className:r,aspect:i,style:l,fill:u,onModeSelect:ae,preferredCameraLocked:Se})}function nf(t){const n=vn(),{cameraScale:s,cameraAspect:a}=pe(),{label:r,start:i,stopAll:l,startPhonePairing:u,startWifiConnection:f,startUsbConnection:c,connectToWifiDevice:m,connectToUsbDevice:p,videoRef:h,streaming:N,mode:w,setMode:b,onModeSelect:g,pairCode:y,mobileUrl:M,regenerateCode:L,httpsInfo:S,showTips:I,setShowTips:k,wifiDevices:T,usbDevices:E,discoveringWifi:V,discoveringUsb:H,scaleOverride:$,tileFitModeOverride:ce,className:me,aspect:xe,style:we,fill:ye,preferredCameraLocked:De}=t,Ue={local:"Local",phone:"PhoneCam",wifi:"Wi-Fi/USB"},ge=o.useMemo(()=>[{id:"local",title:"Local camera",description:"Use the desktop webcam or capture card.",action:()=>{g&&g("local")}},{id:"phone",title:"PhoneCam",description:"Stream from your phone via the mobile link.",action:()=>{g&&g("phone")}},{id:"wifi",title:"Wi-Fi/USB",description:"Connect to scoring devices on your local network.",action:()=>{g&&g("wifi")}},{id:"usb",title:"USB",description:"Connect a USB capture device (treated like WiFi mode).",action:()=>{g&&g("usb")}}],[b,i,u,f,c]),[He,U]=o.useState(null),P=o.useRef(null);o.useEffect(()=>()=>{P.current&&window.clearTimeout(P.current)},[]);const{cameraFitMode:ee}=pe(),X=ce||(ye?"fill":ee||"fill"),re=(()=>{const te=Number($??s??1),Te=Math.max(.5,Math.min(2,te));return X==="fill"?Math.max(1,Te):Te})(),se=ye&&X==="fill"?"free":xe&&xe!=="inherit"?xe:a||"wide",je=se!=="free",le=je?se==="square"?"aspect-square":se==="portrait"?"aspect-[3/4]":se==="classic"?"aspect-[4/3]":"aspect-video":"",Ie=[ye?"rounded-3xl overflow-hidden bg-transparent w-full flex flex-col shadow-2xl border border-slate-700/30":"rounded-3xl overflow-hidden bg-transparent w-full mx-auto flex flex-col shadow-2xl border border-slate-700/30",me].filter(Boolean).join(" ").trim(),Se={...we||{}},Me=ye?"relative flex-1 min-h-0 bg-black":"relative w-full bg-black",G={style:{transform:`scale(${re})`,transformOrigin:"center"}},Ce=w==="wifi"&&E.some(te=>te.status==="online"),he=(()=>{const Te=X==="fit"?"absolute inset-0 w-full h-full object-contain object-center bg-transparent":"absolute inset-0 w-full h-full object-cover object-center bg-transparent";return ye?je?e.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:e.jsx("div",{className:`relative w-full max-w-full max-h-full ${le}`,children:e.jsx("video",{ref:h,className:Te,...G,autoPlay:!0,playsInline:!0,muted:!0})})}):e.jsx("video",{ref:h,className:Te,...G,autoPlay:!0,playsInline:!0,muted:!0}):je?e.jsx("div",{className:`relative w-full ${le}`,children:e.jsx("video",{ref:h,className:Te,...G,autoPlay:!0,playsInline:!0,muted:!0})}):e.jsx("div",{className:"relative w-full",children:e.jsx("video",{ref:h,className:Te,...G,autoPlay:!0,playsInline:!0,muted:!0})})})();async function Ee(te,Te){if(te)try{if(navigator.clipboard&&navigator.clipboard.writeText)await navigator.clipboard.writeText(te);else{const C=document.createElement("textarea");C.value=te,C.style.position="fixed",C.style.opacity="0",document.body.appendChild(C),C.focus(),C.select(),document.execCommand("copy"),document.body.removeChild(C)}U(Te),P.current&&window.clearTimeout(P.current),P.current=window.setTimeout(()=>U(null),1500)}catch(C){console.warn("Copy to clipboard failed:",C),U(null)}}return e.jsxs("div",{className:Ie,style:Se,children:[e.jsxs("div",{className:Me,children:[he,n.isStreaming&&w==="phone"&&e.jsxs("div",{className:"absolute top-4 left-4 z-10 flex items-center gap-2 px-3 py-1.5 rounded-full bg-black/70 backdrop-blur border border-rose-500/60 text-xs text-rose-200 font-semibold shadow-lg",children:[e.jsx("span",{className:"inline-block w-2.5 h-2.5 rounded-full bg-rose-500 animate-pulse"}),e.jsx("span",{children:"REC"})]})]}),e.jsxs("div",{className:"px-3 py-2 flex items-center justify-between bg-gradient-to-r from-slate-900 to-slate-800 text-white text-[11px] gap-2 border-t border-slate-700/50",children:[e.jsxs("span",{className:"truncate font-medium",children:[r||(N?w==="phone"?"PHONE LIVE":w==="wifi"?"WIFI LIVE":"LIVE":"Camera"),De&&e.jsx("span",{className:"ml-2 text-xs opacity-80",children:"ðŸ”’"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[!N&&e.jsxs(e.Fragment,{children:[e.jsx("button",{className:`px-2 py-1 rounded-md text-xs font-semibold transition-all ${w==="local"?"bg-emerald-500 text-white":"bg-slate-700 text-slate-200 hover:bg-slate-600"}`,onClick:()=>g("local"),children:"Local"}),e.jsx("button",{className:`px-2 py-1 rounded-md text-xs font-semibold transition-all ${w==="phone"?"bg-emerald-500 text-white":"bg-slate-700 text-slate-200 hover:bg-slate-600"}`,onClick:()=>g("phone"),children:"Phone"}),e.jsx("button",{className:`px-2 py-1 rounded-md text-xs font-semibold transition-all ${w==="wifi"?"bg-emerald-500 text-white":"bg-slate-700 text-slate-200 hover:bg-slate-600"}`,onClick:()=>g("wifi"),children:"WiFi"}),e.jsx("button",{className:`px-2 py-1 rounded-md text-xs font-semibold transition-all ${w==="wifi"?"bg-emerald-500 text-white":"bg-slate-700 text-slate-200 hover:bg-slate-600"}`,onClick:()=>g("usb"),children:"USB"})]}),N?e.jsx("button",{className:"px-2 py-1 rounded-md text-xs font-semibold bg-rose-500 text-white hover:bg-rose-600 transition-all",onClick:l,children:"Stop"}):null]})]}),w==="phone"&&y&&!N&&e.jsxs("div",{className:"p-2 text-white text-[10px] bg-black/50",children:[e.jsx("div",{className:"text-xs opacity-80",children:"Launch on your mobile:"}),e.jsxs("button",{type:"button",className:"mt-1 w-full text-left px-2 py-1 rounded bg-white/5 border border-white/10 hover:bg-white/10 transition flex items-center gap-2",onClick:()=>Ee(M,"link"),title:"Copy mobile camera link",children:[e.jsx("span",{className:"flex-1 min-w-0 font-mono break-all",children:M}),e.jsx("span",{className:"text-[9px] uppercase tracking-wide whitespace-nowrap text-emerald-200",children:He==="link"?"Copied!":"Copy"})]}),e.jsxs("div",{className:"mt-1 flex items-center gap-2",children:[e.jsx("a",{href:M,target:"_blank",rel:"noreferrer",className:"px-2 py-1 rounded border border-indigo-500/30 text-indigo-100 hover:bg-indigo-500/20 transition",children:"Open link"}),e.jsxs("button",{type:"button",className:"flex-1 text-left px-2 py-1 rounded bg-white/5 border border-white/10 hover:bg-white/10 transition flex items-center justify-between gap-2",onClick:()=>Ee(y,"code"),title:"Copy pairing code",children:[e.jsx("span",{className:"font-mono tracking-[0.3em] text-sm",children:y}),e.jsx("span",{className:"text-[9px] uppercase tracking-wide whitespace-nowrap text-emerald-200",children:He==="code"?"Copied!":"Copy"})]})]}),e.jsx("div",{className:"mt-1 flex items-center gap-2",children:e.jsx("button",{className:"px-1 py-0.5 rounded bg-slate-700",onClick:L,children:"Regenerate"})}),I&&e.jsxs("div",{className:"mt-2 p-2 rounded bg-slate-900/60 border border-slate-700/50 text-slate-200",children:[e.jsx("div",{className:"font-semibold mb-1",children:"Troubleshooting"}),e.jsxs("ul",{className:"list-disc pl-4 space-y-1",children:[e.jsx("li",{children:"Phone and desktop must be on the same Wi-Fi network."}),e.jsxs("li",{children:["Allow the server through your firewall (ports 8787 and"," ",S?.https?S.port:8788,")."]}),e.jsx("li",{children:"On iPhone, use HTTPS links (QR will prefer https when enabled)."})]}),e.jsx("div",{className:"mt-2 text-right",children:e.jsx("button",{className:"btn btn--ghost px-2 py-1 text-xs",onClick:()=>k(!1),children:"Hide tips"})})]})]}),w==="wifi"&&!N&&e.jsxs("div",{className:"p-2 text-white text-[10px] bg-black/50",children:[e.jsx("div",{className:"font-semibold mb-2",children:"Scoring Devices"}),e.jsxs("div",{className:"mb-3",children:[e.jsx("div",{className:"font-medium mb-1",children:"WiFi Devices"}),V?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"animate-spin rounded-full h-3 w-3 border-b-2 border-white"}),e.jsx("span",{children:"Scanning network..."})]}):T.length>0?e.jsxs("div",{className:"space-y-1",children:[T.map(te=>e.jsxs("div",{className:"flex items-center justify-between p-1 rounded bg-slate-900/60",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"font-medium truncate",children:te.name}),e.jsxs("div",{className:"opacity-70 text-[9px]",children:[te.ip,":",te.port]})]}),e.jsx("button",{className:`px-1 py-0.5 rounded text-[9px] ${te.status==="connecting"?"bg-yellow-600":te.status==="online"?"bg-green-600":"bg-blue-600"}`,onClick:()=>m(te),disabled:te.status==="connecting",children:te.status==="connecting"?"...":"Connect"})]},te.id)),e.jsx("div",{className:"text-center mt-2",children:e.jsx("button",{className:"px-1 py-0.5 rounded bg-slate-700 text-[9px]",onClick:f,children:"Rescan WiFi"})})]}):e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"mb-1 opacity-70",children:"No WiFi devices found"}),e.jsx("button",{className:"px-1 py-0.5 rounded bg-slate-700 text-[9px]",onClick:f,children:"Scan WiFi"})]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium mb-1",children:"USB Devices"}),H?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"animate-spin rounded-full h-3 w-3 border-b-2 border-white"}),e.jsx("span",{children:"Scanning USB..."})]}):E.length>0?e.jsxs("div",{className:"space-y-1",children:[E.map(te=>e.jsxs("div",{className:"flex items-center justify-between p-1 rounded bg-slate-900/60",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"font-medium truncate",children:te.name}),e.jsx("div",{className:"opacity-70 text-[9px]",children:te.type.toUpperCase()})]}),e.jsx("button",{className:`px-1 py-0.5 rounded text-[9px] ${te.status==="connecting"?"bg-yellow-600":te.status==="online"?"bg-green-600":"bg-blue-600"}`,onClick:()=>p(te),disabled:te.status==="connecting",children:te.status==="connecting"?"...":"Connect ðŸ”Œ"})]},te.id)),e.jsx("div",{className:"text-center mt-2",children:e.jsx("button",{className:"px-1 py-0.5 rounded bg-slate-700 text-[9px]",onClick:c,children:"Rescan USB ðŸ”"})})]}):e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"mb-1 opacity-70",children:"No USB devices found âŒ"}),e.jsx("button",{className:"px-1 py-0.5 rounded bg-slate-700 text-[9px]",onClick:c,children:"Scan USB ðŸ”"})]})]})]}),!N&&e.jsxs("div",{className:"mt-3 p-3 rounded-2xl bg-white border border-slate-200 shadow-sm text-slate-900",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-[10px] uppercase tracking-wide text-slate-500",children:"Camera modes âš™ï¸"}),e.jsx("div",{className:"text-sm font-semibold text-slate-900",children:"Reconnect camera ðŸ”„"})]}),e.jsxs("span",{className:"text-xs text-slate-500",children:["Current: ",Ue[w]||"Local"]})]}),e.jsx("p",{className:"text-xs text-slate-500 mb-2",children:"Tap a mode to restart the feed or switch inputs."}),e.jsx("div",{className:"grid grid-cols-2 gap-2",children:ge.map(te=>{const Te=te.id==="usb"?Ce:te.id===w;return e.jsxs("button",{type:"button",onClick:te.action,className:`text-left p-3 rounded-2xl border ${Te?"border-emerald-500 bg-emerald-50 shadow":"border-slate-200 bg-white/80 hover:bg-slate-50"} transition`,children:[e.jsx("div",{className:"text-xs font-semibold uppercase tracking-wide text-slate-500",children:te.title}),e.jsx("div",{className:"text-[11px] text-slate-600 mt-1",children:te.description}),Te&&e.jsx("div",{className:"text-[10px] text-emerald-500 mt-2",children:"Active âœ…"})]},te.id)})})]})]})}const sf={},Oa=o.memo(function({label:n,value:s,className:a="",scale:r=1}){return e.jsxs("div",{className:`flex flex-col items-center gap-0 ${a}`,children:[e.jsx("div",{className:"text-[8px] opacity-70 uppercase font-bold tracking-tighter leading-none",children:n}),e.jsx("div",{className:"text-sm sm:text-base font-black transform transition-transform duration-200 ease-out leading-none",style:{transform:`scale(${r})`},children:s})]})}),af=o.memo(function({player:n,user:s,playerCalibrations:a}){const r=o.useRef(null),i=a[n.name],l=dn(c=>!!c.H),f=!!(s?.username&&n?.name&&n.name.toLowerCase()===s.username.toLowerCase()||n?.name==="You")?l:!!i;return o.useEffect(()=>{const c=r.current;if(!c)return;const m=c.getContext("2d");if(!m)return;const p=c.width/2,h=c.height/2,N=Math.min(p,h)-2;m.clearRect(0,0,c.width,c.height);try{typeof m.stroke=="function"&&(m.strokeStyle="#fff",m.lineWidth=1,m.beginPath(),m.arc(p,h,N,0,2*Math.PI),m.stroke()),typeof m.fill=="function"&&(m.fillStyle="#f00",m.beginPath(),m.arc(p,h,4,0,2*Math.PI),m.fill())}catch{}if(f)try{typeof m.fill=="function"&&(m.fillStyle="#0f0"),[[p-N*.5,h],[p+N*.5,h],[p,h-N*.5],[p,h+N*.5]].forEach(([b,g])=>{try{typeof m.beginPath=="function"&&m.beginPath(),typeof m.arc=="function"&&m.arc(b,g,2,0,2*Math.PI),typeof m.fill=="function"&&m.fill()}catch{}})}catch{}},[f]),e.jsxs("div",{className:"flex items-center gap-2 mt-1 bg-white/5 p-1.5 rounded-lg border border-white/10",children:[e.jsx("canvas",{ref:r,width:40,height:40,className:"border border-white/20 rounded-md bg-black/60 shadow-inner"}),e.jsx("span",{className:`text-xs font-black tracking-tight ${f?"text-emerald-400":"text-rose-400/70"}`,children:f?"Calibrated âœ…":"Not Calibrated âŒ"})]})}),rf=o.memo(function({player:n,limit:s=3}){const a=[];try{const r=n.legs||[];for(let i=r.length-1;i>=0&&a.length<s;i--){const u=r[i].visits||[];for(let f=u.length-1;f>=0&&a.length<s;f--){const c=u[f];a.push({score:Number(c?.score||0),darts:Number(c?.darts||3)})}}}catch{}return a.length?e.jsx("div",{className:"flex gap-1 items-center",children:a.map((r,i)=>e.jsx("div",{className:`text-[10px] px-1.5 py-0.5 rounded-md font-black shadow-sm ${r.score>=100?"bg-emerald-600/70 text-emerald-300 ring-1 ring-emerald-500/50":r.score>=60?"bg-amber-500/60 text-amber-300 ring-1 ring-amber-500/50":"bg-white/20 text-gray-200 ring-1 ring-white/20"}`,children:r.score},i))}):e.jsx("div",{className:"text-[10px] opacity-60",children:"No visits ðŸ“‰"})}),of=o.memo(function({secondsLeft:n,totalSeconds:s,size:a=60,stroke:r=6,color:i="emerald"}){const l=(a-r)/2,u=2*Math.PI*l,f=Math.max(0,Math.min(1,s>0?n/s:0)),c=u*(1-f),m=i==="emerald"?"#34d399":"#f59e0b";return e.jsxs("svg",{width:a,height:a,viewBox:`0 0 ${a} ${a}`,"aria-hidden":!0,children:[e.jsx("defs",{children:e.jsx("filter",{id:"softShadow",x:"-50%",y:"-50%",width:"200%",height:"200%",children:e.jsx("feDropShadow",{dx:"0",dy:"1",stdDeviation:"3",floodColor:"#000",floodOpacity:"0.45"})})}),e.jsx("circle",{cx:a/2,cy:a/2,r:l,fill:"transparent",stroke:"rgba(255,255,255,0.06)",strokeWidth:r}),e.jsx("circle",{cx:a/2,cy:a/2,r:l,fill:"transparent",stroke:m,strokeWidth:r,strokeLinecap:"round",strokeDasharray:u,strokeDashoffset:c,transform:`rotate(-90 ${a/2} ${a/2})`,style:{filter:"drop-shadow(0 1px 2px rgba(0,0,0,0.4))"}}),e.jsx("text",{x:"50%",y:"50%",fill:"white",fontSize:a*.28,fontWeight:900,dominantBaseline:"middle",textAnchor:"middle",children:n>0?n:"GO"})]})});function lf({open:t=!0,players:n,user:s,onDone:a,onRequestClose:r,initialSeconds:i=15,showCalibrationDefault:l=!1,disableEscClose:u=!1}){const[f,c]=o.useState(i||15),m=!!t,p=m,h=vn(),N=pe.getState().setCameraEnabled;o.useEffect(()=>{if(m){try{h.acquireKeepAlive?.("MatchStartShowcase")}catch{}return()=>{try{h.releaseKeepAlive?.("MatchStartShowcase")}catch{}}}},[m,h]);const w=dn(G=>!!G.H),b=dn(G=>!!G.locked),g=dn(G=>G.confidence),y=dn(G=>G.imageSize),M=dn(G=>G.errorPx),L=o.useMemo(()=>({hasHomography:w,locked:b,confidence:g}),[w,b,g]),S=o.useMemo(()=>ri({H:w?dn.getState().H:null,locked:b,imageSize:y,errorPx:M}),[w,b,y,M]),I=h.isStreaming&&S==="verified",[k,T]=o.useState(!1),[E,V]=o.useState(()=>{const G={};if(!l)for(const Ce of n)G[Ce.id]=!0;return G}),[H,$]=o.useState({}),[ce,me]=o.useState(!1),[xe,we]=o.useState(null),ye=o.useRef(null),De=o.useRef(null),Ue=o.useRef(null),ge=o.useRef(null),He=o.useRef(null),U=o.useRef(!1),P=typeof import.meta<"u"&&!!sf&&!1,[ee,X]=o.useState(null),re=o.useRef(null);o.useEffect(()=>(U.current=!0,()=>{U.current=!1}),[]),o.useEffect(()=>{l||V(G=>{const Ce={...G};for(const he of n)Ce[he.id]||(Ce[he.id]=!0);return Ce})},[n,l]);const se=n.every(G=>E[G.id]);o.useEffect(()=>{if(!m)return;try{N(!0)}catch{}let G=null;try{const te=()=>{try{const Te=De.current?.querySelector?.("video"),C=h.getMediaStream?.(),B=C?.getVideoTracks?.()||[],A=B.filter(W=>W?.readyState==="live");X({ts:Date.now(),session:{isStreaming:h.isStreaming,mode:h.mode,showOverlay:h.showOverlay},stream:{exists:!!C,id:C?.id,videoTracks:B.length,liveTracks:A.length,trackStates:B.map(W=>({readyState:W?.readyState,enabled:W?.enabled,muted:W?.muted}))},video:{hasEl:!!Te,hasSrcObject:!!Te?.srcObject,readyState:Te?.readyState??null,paused:Te?.paused??null,ended:Te?.ended??null,videoWidth:Te?.videoWidth??0,videoHeight:Te?.videoHeight??0},lastPlayError:re.current})}catch{}}}catch{}try{const te=h.getMediaStream?.(),Te=(te?.getVideoTracks?.()||[]).filter(B=>B.readyState==="live");te&&Te.length>0&&!h.isStreaming&&h.setStreaming(!0);const C=De.current?.querySelector?.("video");C&&Promise.resolve(cs({video:C,stream:te,onPlayError:B=>{try{re.current=B&&B.name||B?.message||String(B)}catch{}}})).catch(()=>{});try{let B=!1,A=0;const W=12,ae=async()=>{if(!B){A+=1;try{const K=De.current?.querySelector?.("video"),_e=h.getMediaStream?.();if(K){const Ae=await cs({video:K,stream:_e}).catch(()=>({played:!1})),ut=!!K.videoWidth&&!!K.videoHeight,_=Ae.played&&h.isStreaming&&(ut||A>=3);if(_&&me(!0),_&&S==="verified"){we(null),B=!0;return}}}catch{}if(A>=W){me(!1),we("timed out"),B=!0;return}B||setTimeout(ae,500)}};ae()}catch{}}catch{}try{h.setShowOverlay?.(!0)}catch{}try{setTimeout(()=>{try{Ue.current?.focus()}catch{}},0)}catch{}try{He.current=document.activeElement}catch{}const Ce=document.getElementById("root");try{Ce&&Ce.setAttribute("aria-hidden","true")}catch{}const he=se?setInterval(()=>c(te=>te<=0?0:te-1),1e3):null,Ee=te=>{if(U.current&&!u&&(te.key==="Escape"||te.key==="Esc")){te.preventDefault();try{setTimeout(()=>{try{r?.()}catch{}},0)}catch{}try{He.current?.focus()}catch{}}};return document.addEventListener("keydown",Ee),()=>{try{G!=null&&window.clearInterval(G)}catch{}try{Ce&&Ce.removeAttribute("aria-hidden")}catch{}he&&clearInterval(he),document.removeEventListener("keydown",Ee)}},[m,u,r,se,P]),o.useEffect(()=>{m&&(l&&f===(i||15)&&!k&&(T(!0),(async()=>{const Ce={};for(const he of n)if(s?.username&&he.name===s.username){const{H:Ee,imageSize:te,overlaySize:Te,locked:C}=dn.getState();Ee&&(Ce[he.name]={H:Ee,imageSize:te,overlaySize:Te,locked:C})}else try{const Ee=await fetch(`/api/users/${encodeURIComponent(he.name)}/calibration`);if(Ee.ok){const te=await Ee.json();te.calibration&&(Ce[he.name]=te.calibration)}}catch(Ee){console.warn("Failed to fetch calibration for",he.name,Ee)}$(Ce)})()),se&&f<=0&&setTimeout(()=>{try{a?.()}catch{}try{setTimeout(()=>{try{r?.()}catch{}},0)}catch{}try{He.current?.focus()}catch{}},1e3))},[f,a,m,k,se,n,s]);const je=o.useMemo(()=>n.map(G=>{try{const Ce=Sl(G.name),he=im(G.name),Ee=lm(G.name),te=om(G.name),Te=ms(G.name),C=Te.scored||0,B=Te.darts||0,A=cm(G.name);let W=0;try{for(const K of G.legs||[])for(const _e of K.visits||[])Number(_e.score||0)===180&&(W+=1)}catch{}const ae=`${W}/${A}`;return{id:G.id,name:G.name,avg3:Ce.toFixed(1),best9:he.toFixed(1),bestCheckout:Ee,bestLeg:te,one80s:ae,lifetimeScored:C,lifetimeDarts:B}}catch{return{id:G.id,name:G.name,avg3:"â€”",best9:"â€”",bestCheckout:"â€”",bestLeg:"â€”",one80s:"â€”",lifetimeScored:0,lifetimeDarts:0}}}),[n]),le=o.useRef(typeof document<"u"?document.createElement("div"):null);o.useLayoutEffect(()=>{if(!le.current)return;const G=le.current;G.className="ndn-match-start-portal";try{Array.from(document.querySelectorAll(".ndn-match-start-portal")).forEach(he=>{try{he.parentNode?.removeChild(he)}catch{}})}catch{}return document.body.appendChild(G),()=>{try{G&&G.parentNode&&G.parentNode.removeChild(G)}catch{}}},[]);const Ne=o.useCallback(G=>G<=0?1.8:G===1?1.6:G===2?1.4:G===3?1.2:1,[]),Ie=o.useMemo(()=>{const G=L.confidence;return typeof G=="number"?G:G&&typeof G=="object"&&typeof G.percentage=="number"?G.percentage:null},[L.confidence]),Se=I?typeof Ie=="number"?`Calibrated camera linked â€¢ ${Ie.toFixed(0)}% confidence`:"Calibrated camera linked (quality unknown)":L.hasHomography?"Calibration quality unknown (finish calibrating to link)":"Calibrate to link this camera feed";if(!m)return null;const Me=e.jsx("div",{className:"fixed inset-0 z-50 overflow-y-auto bg-black/90 backdrop-blur-sm",children:e.jsx("div",{className:"min-h-full flex items-center justify-center p-4 sm:p-6 lg:p-8",children:e.jsx("div",{role:"dialog","aria-modal":"true","aria-labelledby":"match-start-heading",tabIndex:-1,className:"w-full max-w-4xl",children:e.jsx(Bn,{returnFocus:!0,children:e.jsxs("div",{ref:ye,className:"relative",children:[p&&e.jsx("div",{"aria-hidden":!0,style:{position:"absolute",left:-9999,width:320,height:240,overflow:"hidden",pointerEvents:"none",opacity:0},children:e.jsx(ii,{showToolbar:!1,hideInlinePanels:!0,scoringMode:"custom",immediateAutoCommit:!1})}),e.jsx("div",{className:"absolute -inset-4 bg-gradient-to-r from-indigo-500/20 via-purple-500/20 to-emerald-500/20 rounded-[3rem] blur-3xl -z-10 opacity-50 animate-pulse"}),e.jsxs("div",{className:"bg-[#13111C] border border-white/10 rounded-3xl p-4 md:p-6 w-full shadow-2xl ring-1 ring-white/5 relative overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 bg-[url('https://grainy-gradients.vercel.app/noise.svg')] opacity-20 pointer-events-none mix-blend-overlay"}),e.jsxs("div",{className:"relative z-10 flex flex-col md:flex-row items-center justify-between gap-3 mb-4 border-b border-white/5 pb-3",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-[9px] font-bold text-indigo-400 uppercase tracking-widest mb-0.5",children:"Get Ready ðŸš€"}),e.jsx("div",{id:"match-start-heading",className:"text-2xl md:text-4xl font-black text-transparent bg-clip-text bg-gradient-to-r from-white via-white to-white/10 tracking-tighter",children:"Match Starting Soon ðŸŽ¯"})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs("div",{className:"relative",children:[P,e.jsx("div",{className:"absolute inset-0 bg-emerald-500/70 blur-[4rem] rounded-full animate-pulse"}),e.jsxs("div",{className:"relative",children:[e.jsx(of,{secondsLeft:f,totalSeconds:i||15,size:60,stroke:6,color:f>5?"emerald":"amber"}),e.jsx("div",{className:"absolute inset-0 flex items-center justify-center pointer-events-none",children:e.jsx("span",{className:"text-xl font-black text-white tabular-nums",children:f})})]})]})}),e.jsxs("div",{className:"flex flex-col gap-1.5 sm:flex-row",children:[e.jsx("button",{ref:Ue,className:"px-4 py-1.5 rounded-lg bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-bold shadow-lg shadow-indigo-500/25 hover:shadow-indigo-500/40 hover:scale-105 transition-all duration-200 active:scale-95 text-xs",onClick:()=>{try{a?.()}catch{}try{try{document.getElementById("root")?.removeAttribute("aria-hidden")}catch{}setTimeout(()=>{try{r?.()}catch{}},0)}catch{}},"aria-label":"Start match now",children:"Start Now â–¶ï¸"}),e.jsx("button",{ref:ge,className:"px-3 py-1.5 rounded-lg bg-white/5 text-white/70 font-semibold hover:bg-white/10 hover:text-white transition-colors text-xs","aria-label":"Close match start showcase",onClick:()=>{try{r?.()}catch{}},children:"Close âœ–ï¸"})]})]})]}),e.jsxs("div",{className:"relative grid grid-cols-1 md:grid-cols-2 gap-3 md:gap-5 mb-4",children:[e.jsx("div",{className:"hidden md:flex absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 z-20 w-16 h-16 bg-[#13111C] rounded-full items-center justify-center border-2 border-white/10 shadow-[0_0_30px_rgba(0,0,0,0.8)]",children:e.jsx("span",{className:"text-xl font-black text-white/20 italic tracking-tighter",children:"VS âš”ï¸"})}),je.map((G,Ce)=>e.jsxs("div",{className:`group relative p-3 md:p-4 rounded-3xl border border-white/5 flex flex-col items-center shadow-xl transition-all duration-300 hover:border-white/10 hover:bg-white/[0.02] max-h-[80vh] overflow-hidden ${Ce===0?"bg-gradient-to-br from-indigo-500/5 to-transparent":"bg-gradient-to-bl from-emerald-500/5 to-transparent"}`,children:[e.jsxs("div",{className:"flex items-center gap-3 mb-2 w-full",children:[e.jsx("div",{className:`w-12 h-12 shrink-0 rounded-xl rotate-3 group-hover:rotate-6 transition-transform duration-300 flex items-center justify-center text-xl font-black text-white shadow-lg ring-2 ring-white/10 ${Ce===0?"bg-gradient-to-br from-indigo-500 to-purple-600 shadow-indigo-500/50":"bg-gradient-to-br from-emerald-500 to-teal-600 shadow-emerald-500/50"}`,children:G.name.split(" ").map(he=>he[0]).join("").toUpperCase().slice(0,2)}),e.jsxs("div",{className:"flex flex-col min-w-0",children:[e.jsx("div",{className:"text-2xl font-black text-white tracking-tighter truncate",children:G.name}),e.jsx("div",{className:"text-[10px] font-black tracking-tight text-white/60",children:G.one80s}),e.jsxs("div",{className:"flex items-center gap-2",children:[s&&s.username===G.name&&e.jsx("div",{className:"text-[0.5rem] font-bold uppercase tracking-wider bg-white/10 text-white/60 px-1.5 py-0.5 rounded-md",children:"You â­"}),e.jsx(af,{player:n.find(he=>he.id===G.id),user:s,playerCalibrations:H})]})]})]}),e.jsxs("div",{className:"grid grid-cols-4 gap-1 w-full bg-black/50 rounded-xl p-2 border border-white/10 shadow-2xl",children:[e.jsx(Oa,{label:"Avg ðŸ“Š",value:G.avg3,scale:Ne(f)*.7,className:"p-0.5"}),e.jsx(Oa,{label:"F9 ðŸ“ˆ",value:G.best9,scale:Ne(f)*.7,className:"p-0.5"}),e.jsx(Oa,{label:"CO ðŸ†",value:G.bestCheckout||"â€”",scale:Ne(f)*.7,className:"p-0.5"}),e.jsx(Oa,{label:"Leg âš¡",value:G.bestLeg||"â€”",scale:Ne(f)*.7,className:"p-0.5"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 w-full mt-2 text-[0.6rem]",children:[e.jsxs("div",{className:"flex items-center justify-between px-2 py-1 rounded-lg bg-white/5 border border-white/5",children:[e.jsx("span",{className:"tracking-widest uppercase text-white/40",children:"Lifetime pts"}),e.jsx("span",{className:"text-white/90 font-semibold",children:G.lifetimeScored.toLocaleString()})]}),e.jsxs("div",{className:"flex items-center justify-between px-2 py-1 rounded-lg bg-white/5 border border-white/5",children:[e.jsx("span",{className:"tracking-widest uppercase text-white/40",children:"Lifetime darts"}),e.jsx("span",{className:"text-white/90 font-semibold",children:G.lifetimeDarts.toLocaleString()})]})]}),e.jsxs("div",{className:"mt-2 flex items-center justify-between w-full px-1",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm text-white/40 font-black",children:[e.jsx("span",{children:"180s ðŸ”¥:"}),e.jsxs("span",{className:"text-white/90",children:[G.one80s," âœ¨"]})]}),e.jsx(rf,{player:n.find(he=>he.id===G.id),limit:3})]}),Ce===0&&e.jsx("div",{className:"w-full mt-2",children:e.jsxs("div",{ref:De,className:"rounded-lg overflow-hidden border border-white/10 bg-black/30 relative",children:[e.jsx("div",{className:`absolute top-3 left-3 px-3 py-1 rounded-full text-[0.6rem] font-bold tracking-wide uppercase shadow-lg ${I?"bg-emerald-500/90 text-emerald-50":"bg-rose-500/80 text-white"}`,children:Se}),e.jsxs("div",{className:"w-full h-[240px] sm:h-[300px] md:h-[360px] flex flex-col",children:[e.jsx(tf,{autoStart:!0,forceAutoStart:!0,fill:!0,aspect:"free",tileFitModeOverride:"fit",scale:1}),xe&&e.jsxs("div",{className:"absolute inset-0 flex items-center justify-center pointer-events-none",children:[e.jsx("div",{className:"absolute inset-0 bg-black/10 backdrop-blur-sm"}),e.jsxs("div",{className:"relative text-center px-4 py-3 rounded-md bg-black/60 border border-white/10",children:[e.jsx("div",{className:"flex items-center justify-center mb-2",children:e.jsx("div",{className:"text-sm font-semibold text-white/90",children:"Failed to link calibrated camera"})}),e.jsx("div",{className:"text-xs text-white/70",children:e.jsx("button",{className:"btn btn-ghost btn-sm",onClick:()=>{we(null),me(!1);try{N(!0)}catch{}},children:"Retry"})})]})]})]}),P]})})]},G.id))]}),e.jsx("div",{className:"text-center pt-6 border-t border-white/50",children:f<=1?e.jsx("div",{className:"text-6xl font-black text-transparent bg-clip-text bg-gradient-to-r from-emerald-400 via-cyan-400 to-blue-400 animate-bounce tracking-tighter py-4",children:"GAME ON! ðŸš€"}):e.jsxs("div",{className:"text-lg font-black text-white/80 uppercase tracking-[1em]",children:[n.map(G=>G.name).join(" vs ")," âš”ï¸"]})})]})]})})})})});return Pr.createPortal(e.jsxs(e.Fragment,{children:[k&&e.jsx(Wh,{players:n,playerCalibrations:H,calibrationSkipped:E,onSkip:G=>V(Ce=>({...Ce,[G]:!0})),onOpenCalibrator:G=>{V(Ce=>({...Ce,[G]:!1}));try{window.dispatchEvent(new CustomEvent("ndn:change-tab",{detail:{tab:"calibrate"}}))}catch{}try{setTimeout(()=>{try{r?.()}catch{}},0)}catch{}},onClose:()=>{T(!1)}}),Me]}),le.current)}function cf(){const t=Wt();pe(U=>U.hideInGameSidebar??!0),Wt().importState,zt(U=>U.setPaused),zt();const[n,s]=o.useState(!1);Jt(U=>U.setVisit),Jt(U=>U.reset);const a=Jt(U=>({entries:U.entries,darts:U.darts,total:U.total})),r=Jt(U=>U.entries),[i,l]=o.useState(null),[u,f]=o.useState(null),c=pe(U=>U.lastOffline?.x01Start||501),[m,p]=o.useState(0),[h,N]=o.useState(0),[w,b]=o.useState(""),[g,y]=o.useState(""),[M,L]=o.useState(""),[S,I]=o.useState([]),[k,T]=o.useState(!0),E=dt.useRef(!0);o.useEffect(()=>{E.current&&T(!0)},[]),o.useEffect(()=>{try{pe.getState().setPreserveCalibrationOverlay(!0)}catch{}try{pe.getState().setCameraEnabled(!0)}catch{}try{const P=yo();if(P?.match)try{Wt.getState().importState(P.match)}catch{}else try{Wt.getState().importState({...Wt.getState(),startingScore:c})}catch{}if(P?.control)try{zt.getState().setPaused(P.control.paused,P.control.pauseEndsAt)}catch{}}catch{}s(!0);const U=am(P=>{try{if(!P)return;P.type==="snapshot"&&P.state&&(P.state.match&&Wt.getState().importState(P.state.match),P.state.control&&zt.getState().setPaused(P.state.control.paused,P.state.control.pauseEndsAt));const ee=()=>{try{const X=yo();if(X&&X.match)return Wt.getState().importState(X.match),X.control&&zt.getState().setPaused(X.control.paused,X.control.pauseEndsAt),!0}catch{}return!1};if(P.type==="pause")try{zt.getState().setPaused(!0,P.pauseEndsAt??null)}catch{}if(P.type==="unpause")try{zt.getState().setPaused(!1,null)}catch{}if(P.type==="quit")try{window.close()}catch{}if(P.type==="pendingVisit")try{const X=P.playerIdx??t.currentPlayerIdx;try{Jt.getState().setVisit(P.entries||[],P.darts||0,P.total||0)}catch{}P.frame&&f(P.frame)}catch{}if(P.type==="visit")try{const X=ee();try{P.meta?.frame&&f(P.meta.frame),P.finished&&P.meta&&(l({label:P.meta.label||ye()||void 0,ring:P.meta.ring,frame:P.meta.frame??P.frame??null,ts:Date.now()}),t.endGame())}catch{}try{Jt.getState().reset()}catch{}}catch{}if(P.type==="nextPlayer")try{if(!ee())try{const re=Wt.getState(),se={roomId:re.roomId,players:re.players,currentPlayerIdx:typeof P.currentPlayerIdx=="number"?P.currentPlayerIdx:(re.currentPlayerIdx+1)%(re.players?.length||1),startingScore:re.startingScore,inProgress:re.inProgress,bestLegThisMatch:re.bestLegThisMatch};Wt.getState().importState(se)}catch{}}catch{}if(P.type==="endLeg")try{const X=ee()}catch{}if(P.type==="endGame")try{if(!ee())try{const re=Wt.getState(),se={roomId:re.roomId,players:re.players,currentPlayerIdx:re.currentPlayerIdx,startingScore:re.startingScore,inProgress:!1,bestLegThisMatch:re.bestLegThisMatch};Wt.getState().importState(se)}catch{}}catch{}}catch{}});return()=>{try{typeof U=="function"&&U()}catch{}}},[]);const V=(U,P,ee)=>{const X=t.players?.[t.currentPlayerIdx],re=X?.legs?.[X.legs.length-1],se=re?re.totalScoreRemaining:t.startingScore,je=typeof U=="number"?U:0;let le=se-je;(!Number.isFinite(le)||le<0)&&(le=0),t.addVisit(je,P,ee??{visitTotal:je}),le===0?t.endLeg(je):t.nextPlayer()},H=()=>{I([]),p(0),N(0),b(""),y("")},$=U=>{const P=Math.max(0,Math.min(60,Math.round(U))),ee=[...S,P].slice(0,3),X=ee.length;if(I(ee),p(X),X>=3){const re=ee.reduce((se,je)=>se+je,0);V(re,X,{visitTotal:re}),H()}},ce=()=>{if(S.length===0)return;const U=S.slice(0,-1);I(U),p(U.length)},me=()=>{$(Number(h)||0)},xe=U=>{b(U)},we=()=>{const U=Math.max(0,Math.round(Number(w)||0));Number.isFinite(U)&&(V(U,3,{visitTotal:U}),H())},ye=o.useCallback(()=>{try{const U=[];if((t.players||[]).forEach(X=>{(X.legs||[]).forEach(re=>{if(re?.finished){const se=(re.visits||[]).slice(-1)[0];U.push({ts:re.endTime||Date.now(),visit:se,player:X})}})}),!U.length)return null;const P=U.sort((X,re)=>re.ts-X.ts)[0],ee=(P.visit?.entries||[]).slice(-1)[0];if(ee?.label)return ee.label;if(ee?.ring==="DOUBLE"&&typeof ee?.value=="number")return`Double ${ee.value/2}`;if(typeof P.visit?.visitTotal=="number")return`Checkout ${P.visit.visitTotal}`}catch{}return null},[t.players]),De=()=>{const U=Cr(g);U!=null&&($(U),y(""))},Ue=()=>{if(S.length===0)return;const U=Cr(g);if(U==null)return;const P=[...S];P[P.length-1]=U,I(P),p(P.length),y("")},ge=()=>{const U=M.split(/\n|,/).map(ee=>ee.trim()).filter(Boolean);if(!U.length)return;let P=[...S];for(const ee of U){const X=Cr(ee);if(X!=null&&(P.push(X),P.length>=3)){const re=P.slice(0,3).reduce((se,je)=>se+je,0);V(re,P.length,{visitTotal:re}),P=[]}}I(P),p(P.length)},He=()=>{L("")};return o.useEffect(()=>{if(t.inProgress){l(null);return}if(!i?.label){const U=ye();U&&l(P=>({...P,label:U}))}},[t.inProgress,ye,i?.label]),e.jsxs("div",{className:"min-h-screen bg-slate-900 text-white",style:{paddingBottom:"calc(var(--ndn-bottomnav-h, 0px) + env(safe-area-inset-bottom, 0px) + 16px)"},children:[k&&e.jsx(lf,{open:k,players:t.players||[],onDone:()=>{E.current=!1,T(!1)},onRequestClose:()=>{E.current=!1,T(!1)},showCalibrationDefault:!0}),e.jsxs("div",{className:"p-2 sm:p-3 max-w-6xl mx-auto",children:[e.jsx(Lh,{left:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-medium",children:"Match"}),i?.label&&e.jsxs("span",{className:"text-xs bg-emerald-600/20 text-emerald-200 px-2 py-1 rounded-lg border border-emerald-500/30",children:["Winning double: ",i.label]})]}),right:e.jsxs(e.Fragment,{children:[e.jsx(Il,{}),e.jsx("button",{className:"btn btn--ghost px-3 py-1",onClick:()=>{try{if(window.opener&&!window.opener.closed)try{window.opener.focus()}catch{}window.close()}catch{}},"aria-label":"Return to app and close match window",children:"Return to app"}),e.jsx("button",{className:"btn btn--ghost px-3 py-1",onClick:()=>{try{window.close()}catch{}},"aria-label":"Close match window",children:"Close"})]})}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-[1.6fr_1fr] gap-3 sm:gap-4 mt-3 items-start",children:[e.jsxs("div",{className:"min-w-0 space-y-4",children:[e.jsxs("div",{className:"card p-3 flex flex-col sm:flex-row sm:items-center justify-between gap-3",children:[e.jsx("div",{className:"flex items-center gap-2 text-sm font-medium opacity-80",children:e.jsx("span",{className:"text-xs uppercase tracking-wide text-white/60",children:"Match Controls"})}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsx("button",{className:"btn px-4 py-2 text-sm",onClick:()=>{try{window.dispatchEvent(new CustomEvent("ndn:open-autoscore"))}catch{}},children:"Auto Detect"}),e.jsx("button",{className:"btn px-4 py-2 text-sm",children:"Manual Correction"})]})]}),e.jsxs("div",{className:"card p-3",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2 mb-2",children:[e.jsx("h3",{className:"text-base font-semibold",children:"Score Entry"}),e.jsx("span",{className:"text-xs text-slate-300",children:"Enter visits or dart-by-dart edits"})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-3",children:[e.jsx("div",{className:"space-y-3",children:e.jsx($h,{inProgress:t.inProgress,startingScore:t.startingScore,pendingEntries:r,onAddVisit:(U,P)=>V(U,P,{visitTotal:U}),onUndo:()=>t.undoVisit(),onNextPlayer:()=>t.nextPlayer(),onEndLeg:U=>t.endLeg(U??0),onEndGame:()=>t.endGame(),quickButtons:[180,140,100,60]})}),e.jsx("div",{className:"space-y-3",children:e.jsxs("div",{className:"p-3 rounded-2xl bg-slate-900/60 border border-white/10 text-slate-100 shadow-sm",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2 mb-2",children:[e.jsx("h4",{className:"text-sm font-semibold uppercase tracking-wide text-indigo-200",children:"Manual Scoring"}),e.jsx("span",{className:"text-[11px] text-white/60",children:"Override a visit or enter dart-by-dart"})]}),e.jsxs("div",{className:"space-y-3 text-sm",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsx("label",{className:"text-[11px] uppercase tracking-wide text-white/60",children:"Single Dart"}),e.jsx("input",{className:"input w-20 bg-white/5 border border-white/10 text-white placeholder-white/40 focus:border-emerald-400/60 focus:ring-emerald-500/40",type:"number",min:0,max:60,value:h,onChange:U=>N(Number(U.target.value||0)),onKeyDown:U=>{U.key==="Enter"&&(U.shiftKey?ce():me())},placeholder:"60"}),e.jsx("button",{className:"btn px-3 py-1 text-sm",onClick:me,children:"Add Dart"}),e.jsx("button",{className:"btn btn--ghost px-3 py-1 text-sm",onClick:ce,children:"Replace Last"})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsx("label",{className:"text-[11px] uppercase tracking-wide text-white/60",children:"Three Dart Edit"}),e.jsx("input",{className:"input w-24 bg-white/5 border border-white/10 text-white placeholder-white/40 focus:border-emerald-400/60 focus:ring-emerald-500/40",type:"number",min:0,max:t.startingScore,value:w,onChange:U=>xe(U.target.value),onKeyDown:U=>{U.key==="Enter"&&we()},placeholder:"100"}),e.jsx("button",{className:"btn px-3 py-1 text-sm",onClick:we,children:"Commit Visit"}),e.jsx("button",{className:"btn btn--ghost px-3 py-1 text-sm",onClick:()=>S.length?ce():t.undoVisit(),children:"Undo Visit"})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsx("label",{className:"text-[11px] uppercase tracking-wide text-white/60",children:"Manual"}),e.jsx("input",{className:"input w-28 bg-white/5 border border-white/10 text-white placeholder-white/40 focus:border-emerald-400/60 focus:ring-emerald-500/40",value:g,onChange:U=>y(U.target.value),onKeyDown:U=>{U.key==="Enter"&&(U.shiftKey?Ue():De())},placeholder:"T20"}),e.jsx("button",{className:"btn px-3 py-1 text-sm",onClick:De,children:"Apply"}),e.jsx("button",{className:"btn btn--ghost px-3 py-1 text-sm",onClick:Ue,disabled:m===0,children:"Replace Last"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-[11px] uppercase tracking-wide text-white/60",children:"Multi-entry (one per line)"}),e.jsx("textarea",{className:"w-full rounded-xl bg-slate-950/70 border border-white/10 text-sm text-slate-100 placeholder-white/40 p-3 focus:outline-none focus:border-emerald-400/60 focus:ring-2 focus:ring-emerald-500/30",rows:4,value:M,onChange:U=>L(U.target.value),placeholder:`T20
D16
5`}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx("button",{className:"btn px-3 py-1 text-sm",onClick:ge,children:"Add All Scores"}),e.jsx("button",{className:"btn btn--ghost px-3 py-1 text-sm",onClick:He,children:"Clear"})]})]})]})]})})]})]})]}),e.jsxs("div",{className:"min-w-0 space-y-4",children:[e.jsx("div",{className:"card p-3",children:e.jsx(Oh,{gameMode:t?.game||"X01",players:(t.players||[]).map((U,P)=>({name:U.name||`Player ${P+1}`,isCurrentTurn:P===(t.currentPlayerIdx||0),legsWon:U.legsWon||0,score:U.legs?.[U.legs.length-1]?.totalScoreRemaining??t.startingScore??c,lastScore:U.legs&&U.legs.length&&U.legs[U.legs.length-1].visits.slice(-1)[0]?.score||0}))})}),e.jsxs("div",{className:"card p-2",children:[e.jsxs("div",{className:"text-sm font-semibold mb-2 flex items-center justify-between",children:[e.jsx("span",{children:"Camera"}),e.jsx("span",{className:"text-xs text-slate-300",children:"Compact view"})]}),e.jsxs("div",{className:"relative h-56 rounded-xl overflow-hidden bg-black",children:[e.jsx(ii,{hideInlinePanels:!0,forceAutoStart:!0,onVisitCommitted:(U,P,ee,X)=>{if(!ee)return;const re=X?.frame??u??null;l({label:X?.label||ye()||void 0,ring:X?.ring,frame:re,ts:Date.now()});try{t.endGame()}catch{}}}),i?.frame&&!t.inProgress&&e.jsxs("div",{className:"absolute inset-2 rounded-lg overflow-hidden border border-emerald-400/40 shadow-lg bg-black/70",children:[e.jsx("img",{src:i.frame,alt:"Winning double zoom",className:"w-full h-full object-cover scale-125"}),e.jsxs("div",{className:"absolute bottom-2 left-2 right-2 text-xs text-white bg-black/60 rounded-md px-2 py-1 flex items-center justify-between gap-2",children:[e.jsx("span",{className:"font-semibold",children:"Winning dart zoom"}),i.label&&e.jsx("span",{className:"text-emerald-200",children:i.label})]})]})]})]})]})]})]}),e.jsx("div",{className:"fixed right-4 bottom-4 z-50",children:e.jsxs("div",{className:"w-48 bg-black/70 text-white rounded-xl overflow-hidden shadow-lg border border-white/10",children:[e.jsxs("div",{className:"p-2 flex items-center gap-2",children:[e.jsx("div",{className:"w-16 h-10 bg-black rounded overflow-hidden flex-shrink-0",children:u?e.jsx("img",{src:u,alt:"opponent camera",className:"w-full h-full object-cover"}):e.jsx("div",{className:"w-full h-full bg-gray-800 flex items-center justify-center text-xs",children:"No preview"})}),e.jsxs("div",{className:"flex-1 text-sm",children:[e.jsx("div",{className:"font-medium",children:(t.players||[])[t.currentPlayerIdx]?.name||"Player"}),e.jsxs("div",{className:"text-xs text-slate-300",children:["Remaining:",e.jsx("span",{className:"ml-1 font-semibold",children:(()=>{const U=(t.players||[])[t.currentPlayerIdx],P=U?.legs?.[U.legs?.length-1],ee=P?P.totalScoreRemaining:t.startingScore,X=a&&a.total||0;return typeof ee=="number"?Math.max(0,ee-X):ee})()})]})]})]}),e.jsxs("div",{className:"px-2 pb-2",children:[e.jsx("div",{className:"text-xs text-slate-300",children:"Pending"}),e.jsx("div",{className:"flex gap-1 mt-1",children:a.entries?.length?a.entries.map((U,P)=>e.jsx("div",{className:"px-2 py-1 bg-white/5 rounded text-sm",children:U.rawValue??U.value},P)):e.jsx("div",{className:"px-2 py-1 text-xs text-slate-400",children:"â€”"})})]})]})})]})}const $r="ndn:open-notifications";function Jf(){try{window.dispatchEvent(new CustomEvent($r))}catch{}}function df({className:t,title:n}){let s=!1;try{s=la().connected}catch{s=!1}const a=s?"Connected":"Disconnected";return e.jsx("span",{"aria-label":`Server connection: ${a}`,title:n||a,className:["inline-flex items-center justify-center","w-3 h-3 rounded-full",s?"bg-emerald-400":"bg-red-500","ring-2 ring-black/20",t||""].join(" ")})}const uf={},mf=dt.lazy(()=>rn(()=>import("./Home-LuCsJ0Kz.js"),__vite__mapDeps([0,1,2,3]))),hf=dt.lazy(()=>rn(()=>import("./OfflinePlay-DjuWU6he.js"),__vite__mapDeps([6,1,2,5,3]))),ff=dt.lazy(()=>rn(()=>import("./Friends-BfZdnlzG.js"),__vite__mapDeps([9,1,2]))),pf=dt.lazy(()=>rn(()=>import("./OnlinePlay.clean-CN7HYk28.js"),__vite__mapDeps([4,1,2,5]))),xf=dt.lazy(()=>rn(()=>import("./StatsPanel-DoVTHWBw.js"),__vite__mapDeps([8,3,1,2]))),bf=dt.lazy(()=>rn(()=>import("./Tournaments-JwbXz_UM.js"),__vite__mapDeps([10,1,2,5]))),gf=dt.lazy(()=>rn(()=>import("./AdminAccess-9iGjTPz_.js"),__vite__mapDeps([11,1,2]))),vf=dt.lazy(()=>rn(()=>import("./OpsDashboard-CXAm-VQ7.js"),__vite__mapDeps([12,1,2])));function yf(){const t=o.useRef(null),[n,s]=o.useState(""),[a,r]=o.useState(!1),i=(()=>{try{return la()}catch{return null}})(),[l,u]=o.useState("score"),[f,c]=o.useState(!1),[m,p]=o.useState(!1),[h,N]=o.useState(null);function w(C){if(!C){N(C);return}N(B=>{const A={...B,...C};return B?.subscription&&!C?.subscription&&(A.subscription=B.subscription),C?.subscription&&(A.subscription=C.subscription),A.fullAccess=!!(A.subscription?.fullAccess||C?.fullAccess||A.fullAccess),A})}const b=(uf?.VITE_MINIMAL_AFTER_LOGIN||"").toString()==="1",[g,y]=o.useState(!1),[M,L]=o.useState(0),[S,I]=o.useState(0),{avgMode:k}=pe();pe(C=>C.cameraEnabled);const E=Wt(C=>C.inProgress)&&l!=="score",{H:V,locked:H,imageSize:$,errorPx:ce}=dn(),me=oi(),xe=ri({H:V,locked:H,imageSize:$,errorPx:ce}),we=o.useRef(xe==="verified"),ye=Math.abs(S)>=.05?S:0,De=dl();o.useEffect(()=>{const C=B=>{try{console.warn("Unhandled promise rejection (suppressed):",B.reason),B.preventDefault?.()}catch{try{console.warn("Unhandled promise rejection (suppressed)")}catch{}}};return window.addEventListener("unhandledrejection",C),()=>window.removeEventListener("unhandledrejection",C)},[]),o.useEffect(()=>{const C=xe==="verified";we.current&&!C&&me("Calibration lost. Please recalibrate.",{type:"info"}),we.current=C},[xe,me]),o.useEffect(()=>{const C=localStorage.getItem("authToken");C&&fetch(`${De}/api/auth/me`,{headers:{Authorization:`Bearer ${C}`}}).then(B=>B.json()).then(B=>{if(B?.user){w(B.user);try{const A=localStorage.getItem(`ndn:subscription:${B.user.email}`);A&&w({...B.user,subscription:JSON.parse(A)})}catch{}Ue(B.user)}else localStorage.removeItem("authToken")}).catch(()=>{})},[]),o.useEffect(()=>{if(h&&b){y(!0);const C=setTimeout(()=>y(!1),1500);return()=>clearTimeout(C)}},[b,h]);try{if(new URLSearchParams(window.location.search).get("match")==="1")return e.jsxs(Eo,{children:[e.jsx(Ph,{}),e.jsx(cf,{})]})}catch{}o.useEffect(()=>{const C=()=>{try{localStorage.removeItem("mockUser"),localStorage.removeItem("authToken"),h?.email&&localStorage.removeItem(`ndn:subscription:${h.email}`)}catch{}N(null),u("score")};return window.addEventListener("ndn:logout",C),()=>window.removeEventListener("ndn:logout",C)},[]),o.useEffect(()=>{if(!h?.username){I(0);return}try{localStorage.setItem("ndn:currentUser",h.username),window.ndnCurrentUser=h.username}catch{}const C=()=>{const W=k==="24h"?El(h.username):Sl(h.username);L(W);const ae=`ndn:allTimeAvgSnapshot:${h.username}`,K=Date.now(),_e=1e3*60*60*24;try{const Ae=localStorage.getItem(ae);if(!Ae){localStorage.setItem(ae,JSON.stringify({value:W,ts:K})),I(0);return}const ut=JSON.parse(Ae),_=Number(ut?.value)||0,Y=W-_;I(Number.isFinite(Y)?Y:0),(!ut?.ts||K-Number(ut.ts)>=_e)&&localStorage.setItem(ae,JSON.stringify({value:W,ts:K}))}catch{I(0)}};C();const B=()=>C(),A=W=>{const ae=W.key||"";if(!ae)return;[`ndn_stats_${h.username}`,`ndn_stats_ts_${h.username}`,`ndn_stats_daily_${h.username}`,`ndn:allTimeAvgSnapshot:${h.username}`].some(_e=>ae.startsWith(_e))&&C()};return window.addEventListener("ndn:stats-updated",B),window.addEventListener("storage",A),()=>{window.removeEventListener("ndn:stats-updated",B),window.removeEventListener("storage",A)}},[h?.username,k]),o.useEffect(()=>{if(!h?.username){s("");return}const C=localStorage.getItem(`ndn:bio:profilePhoto:${h.username}`);s(C||"")},[h?.username]),o.useEffect(()=>{const C=ae=>{ae.key?.startsWith("ndn:bio:profilePhoto:")&&h?.username&&ae.key.endsWith(h.username)&&s(ae.newValue||"")},B=ae=>{if(ae.detail?.username===h?.username&&s(ae.detail?.avatar||""),h?.username){const K=localStorage.getItem(`ndn:bio:profilePhoto:${h.username}`);s(K||"")}},A=()=>{if(!document.hidden&&h?.username){const ae=localStorage.getItem(`ndn:bio:profilePhoto:${h.username}`);s(ae||"")}},W=setInterval(()=>{if(h?.username){const ae=localStorage.getItem(`ndn:bio:profilePhoto:${h.username}`);ae&&ae!==n&&s(ae)}},1e4);return window.addEventListener("storage",C),window.addEventListener("ndn:avatar-updated",B),document.addEventListener("visibilitychange",A),()=>{window.removeEventListener("storage",C),window.removeEventListener("ndn:avatar-updated",B),document.removeEventListener("visibilitychange",A),clearInterval(W)}},[h?.username,n]),o.useEffect(()=>{const C=new URLSearchParams(window.location.search),B=C.get("paid"),A=C.get("username-change");if(B==="1"||B==="username-change"||A==="free"){const W=localStorage.getItem("pendingUsernameChange");W&&h?.email&&fetch(`${De}/api/change-username`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:h.email,newUsername:W})}).then(ae=>ae.json()).then(ae=>{ae.ok?(alert("Username changed successfully!"),localStorage.removeItem("pendingUsernameChange"),ae.token&&localStorage.setItem("authToken",ae.token),ae.user&&w(ae.user),window.history.replaceState({},document.title,window.location.pathname)):alert("Failed to change username: "+(ae.error||"Unknown error"))}).catch(()=>{alert("Network error while changing username")})}},[h?.email]),o.useEffect(()=>{const C=()=>r(!!document.fullscreenElement);return document.addEventListener("fullscreenchange",C),r(!!document.fullscreenElement),()=>document.removeEventListener("fullscreenchange",C)},[]),o.useEffect(()=>{new URLSearchParams(window.location.search).get("subscription")==="success"&&h?.email&&fetch(`${De}/api/auth/me`,{headers:{Authorization:`Bearer ${localStorage.getItem("authToken")}`}}).then(A=>A.json()).then(A=>{A?.user&&(w(A.user),alert("Premium subscription activated successfully!"),window.history.replaceState({},document.title,window.location.pathname))}).catch(()=>{alert("Subscription activated, but failed to refresh user data. Please refresh the page.")})},[h?.email]),o.useEffect(()=>{const C=window.matchMedia("(max-width: 768px)"),B=()=>c(C.matches);B();try{C.addEventListener("change",B)}catch{C.addListener(B)}return window.addEventListener("resize",B),window.addEventListener("orientationchange",B),()=>{window.removeEventListener("resize",B),window.removeEventListener("orientationchange",B);try{C.removeEventListener("change",B)}catch{C.removeListener(B)}}},[]),o.useEffect(()=>{function C(){const B=document.getElementById("ndn-header");if(!B)return;const A=Math.ceil(B.getBoundingClientRect().height);document.documentElement.style.setProperty("--ndn-header-h",`${A}px`)}return C(),window.addEventListener("resize",C),window.addEventListener("orientationchange",C),()=>{window.removeEventListener("resize",C),window.removeEventListener("orientationchange",C)}},[E]),o.useEffect(()=>{const C=()=>{try{localStorage.removeItem("ndn:avatar"),h?.email&&localStorage.removeItem(`ndn:subscription:${h.email}`)}catch{}N(null),u("score")};return window.addEventListener("ndn:logout",C),()=>window.removeEventListener("ndn:logout",C)},[]),o.useEffect(()=>{const C=B=>{try{const A=String(B?.detail?.username||"").trim();if(!A)return;N(W=>W&&{...W,username:A});try{const W=(h?.email||"").toLowerCase();i&&A&&W&&i.send({type:"presence",username:A,email:W})}catch{}}catch{}};return window.addEventListener("ndn:username-changed",C),()=>window.removeEventListener("ndn:username-changed",C)},[i,h?.email]),o.useEffect(()=>{const C=B=>{try{const A=String(B?.detail?.tab||"").trim();if(A&&["score","offline","online","stats","settings","admin","tournaments","friends"].includes(A)){u(A);try{const W=document.querySelector(".ndn-mobile-brand");if(W&&window?.getComputedStyle){const _e=W.getBoundingClientRect(),Ae=Math.max(8,Math.round(_e.right+8));document.documentElement.style.setProperty("--ndn-mobile-menu-left",`${Ae}px`)}const K={online:"8mm",tournaments:"10mm",calibrate:"12mm"}[A]||"0px";document.documentElement.style.setProperty("--ndn-section-gap",K)}catch{}}}catch{}};return window.addEventListener("ndn:change-tab",C),()=>window.removeEventListener("ndn:change-tab",C)},[]);async function Ue(C){try{const B=C?.email?`?email=${encodeURIComponent(C.email)}`:"",A=await fetch("/api/subscription"+B);if(!A.ok)return;const W=await A.json();w({...C,fullAccess:!!W?.fullAccess,subscription:W});try{C?.email&&localStorage.setItem(`ndn:subscription:${C.email}`,JSON.stringify(W))}catch{}}catch{}}const[ge,He]=o.useState(!1),[U,P]=o.useState(!1),[ee,X]=o.useState([]),[re,se]=o.useState(0),[je,le]=o.useState(0),Ne=o.useCallback(async()=>{if(!h?.email)return[];try{const C=localStorage.getItem("authToken"),B={};C&&(B.Authorization=`Bearer ${C}`);const A=await fetch(`/api/notifications?email=${encodeURIComponent(h.email)}`,{headers:B});return A.ok?await A.json()||[]:[]}catch{return[]}},[h?.email]),Ie=o.useCallback(async()=>{if(!h?.email){se(0),le(0);return}try{const[C,B]=await Promise.all([ss(`/api/friends/requests?email=${encodeURIComponent(h.email)}`),ss(`/api/friends/messages?email=${encodeURIComponent(h.email)}`)]),A=C.ok?await C.json():{requests:[]},W=B.ok?await B.json():{messages:[]};se(A.requests?.length||0),le((W.messages||[]).filter(ae=>!ae.read).length)}catch(C){return console.error("Failed to refresh friend notifications:",C),!1}return!0},[h?.email]),Se=o.useRef(0),Me=o.useRef(null);if(o.useEffect(()=>{if(!h?.subscription){He(!1);return}const C=h.subscription,B=Date.now();let A=null;C?.expiresAt&&(A=typeof C.expiresAt=="string"?Date.parse(C.expiresAt):Number(C.expiresAt));const W=4320*60*1e3;if(A&&A>B&&A-B<=W){He(!0);return}if(A&&A<=B&&!h?.fullAccess){He(!0);return}if(C?.source==="stripe"&&C?.status&&C.status!=="active"){He(!0);return}He(!1)},[h?.subscription,h?.fullAccess]),o.useEffect(()=>{let C=!0;if(!h?.email)return X([]),()=>{C=!1};const B=async()=>{const W=await Ne();C&&X(W||[])};B();const A=setInterval(B,3e4);return()=>{C=!1,clearInterval(A)}},[Ne,h?.email]),o.useEffect(()=>{if(!h?.email)return;let C=!0;const B=async()=>{try{if(!C||typeof document<"u"&&!document.hasFocus())return;const ae=Me.current;if(ae&&Date.now()<ae)return;await Ie()?(Se.current=0,Me.current=null):(Se.current=(Se.current||0)+1,Se.current>=3&&(Me.current=Date.now()+300*1e3,console.warn("Friend/message polling disabled for 5 minutes due to repeated failures")))}catch{}};B();const A=()=>{try{B()}catch{}};window.addEventListener("focus",A);const W=setInterval(()=>{try{B()}catch{}},3e4);return()=>{C=!1,window.removeEventListener("focus",A),clearInterval(W)}},[Ie,h?.email]),o.useEffect(()=>{h?.email||(se(0),le(0))},[h?.email]),o.useEffect(()=>{if(!h?.subscription||!h?.email)return;const C=h.subscription,B=Date.now();let A=null;C?.expiresAt&&(A=typeof C.expiresAt=="string"?Date.parse(C.expiresAt):Number(C.expiresAt));const W=4320*60*1e3;async function ae(K,_e){try{const Ae=localStorage.getItem("authToken"),ut={"Content-Type":"application/json"};Ae&&(ut.Authorization=`Bearer ${Ae}`),await fetch("/api/notifications",{method:"POST",headers:ut,body:JSON.stringify({email:h.email,message:_e,type:K})})}catch{}}if(A&&A>B&&A-B<=W){ae("sub_expiring",`Your premium subscription expires in ${Math.ceil((A-B)/(1440*60*1e3))} day(s)`);return}if(A&&A<=B&&!h?.fullAccess){ae("sub_expired","Your premium subscription has ended");return}},[h?.email,h?.subscription,h?.fullAccess]),o.useEffect(()=>{if(!U)return;const C=B=>{B.key==="Escape"&&P(!1)};return document.addEventListener("keydown",C),()=>{document.removeEventListener("keydown",C)}},[U]),o.useEffect(()=>{const C=()=>P(!0);return window.addEventListener($r,C),()=>window.removeEventListener($r,C)},[]),!h)return e.jsx(yh,{onAuth:C=>{try{const B=localStorage.getItem(`ndn:subscription:${C.email}`);w(B?{...C,subscription:JSON.parse(B)}:C)}catch{w(C)}Ue(C)}});const G=`https://ui-avatars.com/api/?name=${encodeURIComponent(h.username||"NDN")}&background=8F43EE&color=fff&bold=true&rounded=true&size=64`,Ce=C=>`${C.type||""} ${C.message||""}`.trim(),he=ee.filter(C=>/(tournament|bracket)/i.test(Ce(C))).length,Ee=ee.filter(C=>/(check[-_\s]?in)/i.test(Ce(C))).length,te=ee.filter(C=>/(match|invite)/i.test(Ce(C))).length,Te=[{key:"tournaments",label:"Tournament Closures",description:"Bracket updates, payouts, and notices.",count:he,icon:Cs},{key:"checkins",label:"Check-ins",description:"Venue reminders and start-of-round checks.",count:Ee,icon:Mc},{key:"match-invites",label:"Match Invites",description:"Pending matches ready to accept.",count:te,icon:Rc},{key:"friend-requests",label:"Friend Requests",description:"Accept or decline new connections.",count:re,icon:Va},{key:"messages",label:"Messages",description:"Unread chats and replies.",count:je,icon:Rn}];return e.jsxs(Eo,{children:[e.jsxs("div",{ref:t,className:`${h?.fullAccess?"premium-body":""} h-screen overflow-hidden pt-1 pb-0 px-1 xs:pt-2 xs:pb-0 xs:px-2 sm:pt-3 sm:pb-0 sm:px-3 md:pt-4 md:pb-0 md:px-4`,children:[e.jsx(Ym,{}),e.jsxs("div",{className:"max-w-[1600px] mx-auto grid grid-cols-1 lg:grid-cols-[auto,1fr] gap-4 sm:gap-6 h-full overflow-hidden",children:[!f&&e.jsx("div",{className:"relative hidden lg:block w-72",children:e.jsx(ml,{className:"w-full h-full",active:l,onChange:C=>{u(C)},user:h})}),e.jsxs("div",{className:"flex flex-col h-full overflow-hidden",children:[e.jsxs("div",{className:"pt-1 xs:pt-2 relative z-50",children:[e.jsxs("header",{id:"ndn-header","data-testid":"ndn-header",className:`header glass flex items-center justify-between gap-2 sm:gap-4 transition-all duration-200 ${E?"py-1 px-2":"py-2 px-4"}`,style:{willChange:"transform"},children:[f&&e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"ndn-mobile-brand shrink-0 text-sm font-black px-3 py-1 rounded-xl bg-black/40 text-white/90 hover:bg-black/50 transition-colors",onClick:()=>{u("score"),p(!1)},"aria-label":"Go Home",title:"Go Home",children:"NDN ðŸŽ¯"}),e.jsx("button",{className:"ndn-mobile-menu-btn p-2 -ml-2 mr-2 rounded-xl text-slate-200 hover:bg-white/10 active:scale-95 transition-all shrink-0 relative z-[60]","data-testid":"mobile-menu-button",onClick:()=>p(!0),"aria-label":"Open Menu",children:e.jsx(Tc,{className:"w-6 h-6"})})]}),e.jsxs("div",{className:"flex items-center gap-3 min-w-0 shrink ndn-greeting",children:[!f&&e.jsxs("div",{className:"relative shrink-0",children:[e.jsx("img",{src:n||G,alt:"avatar",className:"w-7 h-7 sm:w-8 sm:h-8 rounded-full ring-1 ring-indigo-400/50 object-cover shadow-sm"}),e.jsx("div",{className:"absolute -bottom-0.5 -right-0.5 w-2 h-2 bg-emerald-500 border border-[#13111C] rounded-full"})]}),e.jsx("div",{className:"min-w-0",children:e.jsxs("div",{className:"flex flex-col gap-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[f&&e.jsxs("div",{className:"relative mr-0",children:[e.jsx("img",{src:n||G,alt:"avatar",className:"w-8 h-8 rounded-full ring-1 ring-indigo-400/50 object-cover shadow-sm"}),e.jsx("div",{className:"absolute -bottom-0.5 -right-0.5 w-2 h-2 bg-emerald-500 border border-[#13111C] rounded-full"})]}),e.jsxs("span",{className:"truncate text-xs text-white/70 ndn-greeting-welcome",children:["Welcome,"," ",e.jsx("span",{className:"font-bold text-white",children:h.username})]})]}),e.jsxs("div",{className:"flex items-center gap-2 shrink-0 text-[11px] sm:text-xs text-white/60 ndn-greeting-avg",children:[e.jsx("span",{className:"uppercase tracking-[0.3em] text-white/35 text-[9px]",children:"All-Time 3-Dart Avg"}),e.jsx("span",{className:"text-sm sm:text-base font-black text-white tracking-tight",children:M.toFixed(1)}),ye!==0&&e.jsxs("span",{className:`flex items-center gap-1 text-[11px] sm:text-xs font-semibold ${ye>0?"text-emerald-300":"text-rose-300"}`,children:[ye>0?e.jsx(Dc,{className:"w-3 h-3"}):e.jsx(Ic,{className:"w-3 h-3"}),ye>0?"+":"",ye.toFixed(1)]})]})]})})]}),!f&&e.jsx("div",{className:"flex-1 flex justify-center px-2",children:e.jsx("h1",{className:"w-full sm:w-auto",children:e.jsxs("button",{type:"button",className:"w-full sm:w-auto flex items-center justify-center rounded-2xl border border-white/10 bg-black/40 px-4 py-2 text-base xs:text-xl sm:text-2xl font-black text-white tracking-tighter drop-shadow-lg whitespace-nowrap cursor-pointer select-none hover:bg-black/50 transition-colors",onClick:()=>{u("score")},title:"Go Home",children:[e.jsx("span",{className:"xs:hidden",children:"NDN ðŸŽ¯"}),e.jsx("span",{className:"hidden xs:inline",children:"NINE-DART-NATION ðŸŽ¯"})]})})}),e.jsxs("div",{className:"flex items-center gap-1.5 sm:gap-3 shrink-0",children:[e.jsx(df,{className:"mr-1"}),!f&&xe!=="none"&&e.jsxs("button",{onClick:()=>u("calibrate"),className:`flex px-3 py-1.5 text-[10px] rounded-full transition-all items-center gap-2 group border ${xe==="verified"?"bg-emerald-500/10 hover:bg-emerald-500/20 text-emerald-400 border-emerald-500/20":"bg-amber-500/10 hover:bg-amber-500/20 text-amber-300 border-amber-500/20"}`,title:"Click to adjust calibration",children:[e.jsxs("div",{className:"relative flex h-2 w-2",children:[e.jsx("span",{className:`animate-ping absolute inline-flex h-full w-full rounded-full opacity-75 ${xe==="verified"?"bg-emerald-400":"bg-amber-400"}`}),e.jsx("span",{className:`relative inline-flex rounded-full h-2 w-2 ${xe==="verified"?"bg-emerald-500":"bg-amber-500"}`})]}),e.jsx("span",{className:"font-bold tracking-wide uppercase hidden lg:inline",children:xe==="verified"?"Calibrated âœ…":"Calibration quality unknown"})]}),e.jsx("div",{className:"flex items-center gap-1 sm:gap-2 bg-black/20 p-1 rounded-full border border-white/5",children:e.jsx("button",{className:"px-2 sm:px-3 py-1 text-[10px] font-bold uppercase tracking-wider rounded-full bg-white/5 hover:bg-white/10 text-white transition-all",onClick:()=>{const C=t.current;C&&(document.fullscreenElement?document.exitFullscreen().catch(()=>{}):C.requestFullscreen().catch(()=>{}))},children:a?"Exit":"Full"})}),!E&&e.jsxs("div",{className:"hidden sm:flex items-center ml-2 space-x-2",children:[e.jsx(Ih,{}),e.jsx(Dh,{})]})]})]}),f&&e.jsx("div",{"aria-hidden":!0,className:"ndn-mobile-menu-slot"})]}),f&&e.jsx(wf,{open:m,onClose:()=>p(!1),active:l,onChange:C=>{u(C),p(!1)},user:h}),e.jsxs("main",{id:"ndn-main-scroll",className:"space-y-4 flex-1 overflow-y-auto pr-1 flex flex-col",style:{willChange:"scroll-position",transform:"translateZ(0)",WebkitOverflowScrolling:"touch"},children:[l==="settings"&&e.jsx(o.Suspense,{fallback:e.jsx("div",{className:"p-4",children:"Loading settings..."}),children:e.jsx(Mn,{className:"flex-1 min-h-0",children:e.jsx(vh,{user:h})})}),l==="score"&&e.jsx(o.Suspense,{fallback:e.jsx("div",{className:"p-4",children:"Loading home..."}),children:e.jsx(Mn,{className:"flex-1 min-h-0",children:e.jsx(mf,{user:h})})}),l==="online"&&e.jsx(o.Suspense,{fallback:e.jsx("div",{className:"p-4",children:"Loading online..."}),children:e.jsx(Mn,{className:"flex-1 min-h-0",children:e.jsx(pf,{user:h})})}),l==="offline"&&e.jsx(o.Suspense,{fallback:e.jsx("div",{className:"p-4",children:"Loading offline..."}),children:e.jsx(Mn,{className:"flex-1 min-h-0",children:e.jsx(hf,{user:h})})}),e.jsx("div",{className:l==="calibrate"?"":"hidden",children:e.jsx(Mn,{children:e.jsx(sm,{})})}),l==="friends"&&e.jsx(o.Suspense,{fallback:e.jsx("div",{className:"p-4",children:"Loading friends..."}),children:e.jsx(Mn,{className:"flex-1 min-h-0",children:e.jsx(ff,{user:h})})}),l==="stats"&&e.jsx(o.Suspense,{fallback:e.jsx("div",{className:"p-4",children:"Loading stats..."}),children:e.jsx(Mn,{className:"flex-1 min-h-0",children:e.jsx(xf,{user:h})})}),l==="tournaments"&&e.jsx(o.Suspense,{fallback:e.jsx("div",{className:"p-4",children:"Loading tournaments..."}),children:e.jsx(Mn,{className:"flex-1 min-h-0",children:e.jsx(bf,{user:h})})}),l==="admin"&&e.jsx(o.Suspense,{fallback:e.jsx("div",{className:"p-4",children:"Loading admin..."}),children:e.jsx(Mn,{className:"flex-1 min-h-0",children:e.jsxs("div",{className:"flex-1 min-h-0 space-y-6",children:[e.jsx(fh,{user:h}),e.jsx(vf,{user:h})]})})}),l==="fullaccess"&&e.jsx(o.Suspense,{fallback:e.jsx("div",{className:"p-4",children:"Loading admin access..."}),children:e.jsx(Mn,{className:"flex-1 min-h-0",children:e.jsx(gf,{user:h})})})]})]})]})]}),e.jsx(jh,{}),e.jsx(Ah,{}),!g&&e.jsx(Nh,{}),!g&&e.jsx(kh,{}),!g&&e.jsx(Th,{}),U&&e.jsx("div",{className:"fixed inset-0 z-[9999] flex items-center justify-center bg-black/90 backdrop-blur-sm p-4",onClick:()=>P(!1),children:e.jsxs("div",{role:"dialog","aria-modal":"true",className:"relative w-full max-w-4xl max-h-[85vh] overflow-y-auto rounded-3xl border border-white/10 bg-[#13111C] p-6 md:p-8 shadow-2xl animate-in fade-in zoom-in-95 duration-200 overflow-hidden",onClick:C=>C.stopPropagation(),children:[e.jsx("div",{className:"absolute inset-0 bg-[url('https://grainy-gradients.vercel.app/noise.svg')] opacity-20 pointer-events-none mix-blend-overlay"}),e.jsx("div",{className:"absolute -top-24 -right-24 w-64 h-64 bg-indigo-500/20 rounded-full blur-3xl pointer-events-none"}),e.jsx("div",{className:"absolute -bottom-24 -left-24 w-64 h-64 bg-emerald-500/20 rounded-full blur-3xl pointer-events-none"}),e.jsx("button",{className:"absolute right-4 top-4 flex h-8 w-8 items-center justify-center rounded-full bg-white/5 hover:bg-white/10 text-white transition z-10",onClick:()=>P(!1),"aria-label":"Close notifications",children:"Ã—"}),e.jsxs("div",{className:"relative z-10 flex items-center gap-4 mb-8 border-b border-white/5 pb-6",children:[e.jsx("div",{className:"p-4 rounded-2xl bg-gradient-to-br from-amber-500/20 to-orange-500/20 text-amber-400 shadow-lg shadow-amber-500/10 ring-1 ring-white/10",children:e.jsx(zi,{className:"h-8 w-8"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r from-white via-white to-white/50 tracking-tight",children:"Notifications"}),e.jsx("p",{className:"text-sm text-white/50 font-medium",children:"Stay updated with your latest activity"})]})]}),e.jsxs("div",{className:"relative z-10",children:[ge&&e.jsxs("div",{className:"mb-8 rounded-2xl bg-gradient-to-r from-amber-500/10 to-orange-500/10 border border-amber-500/20 p-6 flex flex-col sm:flex-row items-start gap-5 shadow-lg shadow-amber-500/5",children:[e.jsx("div",{className:"p-3 rounded-xl bg-amber-500/20 text-amber-400 shrink-0 ring-1 ring-amber-500/30",children:e.jsx(Cs,{className:"h-6 w-6"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"font-bold text-lg text-amber-200",children:"Premium Subscription Alert"}),e.jsx("p",{className:"text-sm text-amber-100/70 mt-1 leading-relaxed",children:"Your premium subscription is expiring soon or has expired. Renew now to keep full access to all features!"}),e.jsx("button",{onClick:()=>{P(!1),u("settings")},className:"mt-4 px-6 py-2.5 rounded-xl bg-gradient-to-r from-amber-500 to-orange-600 text-white font-bold text-sm hover:shadow-lg hover:shadow-amber-500/25 hover:scale-105 transition-all duration-200",children:"Manage Subscription"})]})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 mb-10",children:Te.map(C=>{const B=C.icon;return e.jsxs("div",{className:"group flex items-center gap-4 p-4 rounded-2xl bg-white/5 border border-white/5 hover:bg-white/10 hover:border-white/10 transition-all duration-200 cursor-pointer hover:shadow-xl hover:shadow-black/20 hover:-translate-y-0.5",onClick:()=>{P(!1),(C.key==="friend-requests"||C.key==="messages")&&u("friends"),C.key==="tournaments"&&u("tournaments")},children:[e.jsx("div",{className:"p-3 rounded-xl bg-indigo-500/10 text-indigo-400 group-hover:bg-indigo-500/20 group-hover:text-indigo-300 group-hover:scale-110 transition-all duration-300 ring-1 ring-white/5",children:e.jsx(B,{className:"h-6 w-6"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"font-bold text-white group-hover:text-indigo-200 transition-colors",children:C.label}),e.jsx("p",{className:"text-xs text-white/50 group-hover:text-white/70 transition-colors",children:C.description})]}),C.count>0&&e.jsx("span",{className:"px-3 py-1 rounded-full bg-rose-500 text-white font-bold text-xs shadow-lg shadow-rose-500/30 animate-pulse",children:C.count})]},C.key)})}),e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsx("h3",{className:"text-xs font-bold text-white/40 uppercase tracking-[0.2em]",children:"Recent Activity"}),ee.length>0&&e.jsxs("span",{className:"text-xs font-medium text-white/30 bg-white/5 px-2 py-1 rounded-md",children:[ee.length," total"]})]}),e.jsx("div",{className:"space-y-3",children:ee.length===0?e.jsxs("div",{className:"text-center py-16 rounded-3xl border border-dashed border-white/10 bg-white/[0.02]",children:[e.jsx("div",{className:"w-16 h-16 mx-auto mb-4 rounded-full bg-white/5 flex items-center justify-center text-white/20",children:e.jsx(zi,{className:"h-8 w-8"})}),e.jsx("p",{className:"text-white/40 font-medium",children:"No recent notifications"}),e.jsx("p",{className:"text-xs text-white/20 mt-1",children:"You're all caught up!"})]}):ee.map(C=>e.jsxs("div",{className:`relative overflow-hidden rounded-2xl border p-5 transition-all duration-200 group ${C.read?"bg-white/[0.02] border-white/5 hover:bg-white/5":"bg-white/10 border-white/10 hover:bg-white/15 shadow-lg shadow-black/20"}`,children:[!C.read&&e.jsx("div",{className:"absolute left-0 top-0 bottom-0 w-1 bg-gradient-to-b from-rose-500 to-orange-500"}),e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center justify-between gap-2 mb-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:`text-[0.65rem] font-bold uppercase tracking-wider px-2 py-1 rounded-md ring-1 ring-inset ${C.read?"bg-white/5 text-white/40 ring-white/5":"bg-rose-500/10 text-rose-300 ring-rose-500/20"}`,children:C.type||"General"}),e.jsx("span",{className:"text-xs text-white/30 font-medium",children:new Date(C.createdAt).toLocaleDateString(void 0,{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})})]}),!C.read&&e.jsx("span",{className:"self-start sm:self-auto rounded-full bg-rose-500 px-2 py-0.5 text-[0.6rem] font-bold uppercase tracking-widest text-white shadow-sm shadow-rose-500/20",children:"New"})]}),e.jsx("p",{className:"text-sm font-medium text-white/90 leading-relaxed pl-1",children:C.message}),C.link&&e.jsx("a",{href:C.link,target:"_blank",rel:"noreferrer",className:"mt-4 inline-flex items-center gap-1.5 text-xs font-bold text-emerald-400 hover:text-emerald-300 transition-colors bg-emerald-500/10 px-3 py-1.5 rounded-lg hover:bg-emerald-500/20",children:"Open Link â†—"}),e.jsxs("div",{className:"mt-4 flex items-center gap-3 border-t border-white/5 pt-3 opacity-0 group-hover:opacity-100 transition-opacity duration-200",children:[!C.read&&e.jsx("button",{onClick:async B=>{B.stopPropagation();try{const A=localStorage.getItem("authToken");await fetch(`/api/notifications/${encodeURIComponent(C.id)}?email=${encodeURIComponent(h.email)}`,{method:"PATCH",headers:{"Content-Type":"application/json",Authorization:`Bearer ${A}`},body:JSON.stringify({read:!0})});const W=await Ne();W&&X(W)}catch{}},className:"text-xs font-bold text-white/50 hover:text-white transition-colors uppercase tracking-wider",children:"Mark as read"}),e.jsx("button",{onClick:async B=>{if(B.stopPropagation(),!!confirm("Delete this notification?"))try{const A=localStorage.getItem("authToken");await fetch(`/api/notifications/${encodeURIComponent(C.id)}?email=${encodeURIComponent(h.email)}`,{method:"DELETE",headers:{Authorization:`Bearer ${A}`}});const W=await Ne();W&&X(W)}catch{}},className:"text-xs font-bold text-rose-400/50 hover:text-rose-400 transition-colors ml-auto uppercase tracking-wider",children:"Delete"})]})]},C.id))})]})]})}),!g&&e.jsx(Sh,{}),h&&e.jsx("div",{"aria-hidden":!0,style:{position:"absolute",left:-9999,width:320,height:240,overflow:"hidden",pointerEvents:"none",opacity:0},children:e.jsx(ii,{showToolbar:!1,hideInlinePanels:!0,scoringMode:"custom",immediateAutoCommit:!1})})]})}function wf({open:t,onClose:n,active:s,onChange:a,user:r}){return e.jsx(wh,{open:t,onClose:n,width:320,side:"left",title:"Navigate",children:e.jsxs("div",{className:"mt-0 h-full overflow-y-auto",children:[e.jsx("nav",{className:"mb-3 px-2 sm:hidden ndn-drawer","aria-label":"Drawer tabs",children:e.jsx("div",{className:"mobile-tab-list",children:(()=>{const i=ll(r?.email),l=ul(r,i),u=["score","online","offline","tournaments","friends","calibrate","stats","admin","settings"],f=new Map(l.map(p=>[p.key,p])),c=u.map(p=>f.get(p)).filter(Boolean),m=p=>p.replace(/[\p{Emoji}\u{1F300}-\u{1F9FF}\u{2600}-\u{26FF}]/gu,"").trim();return c.map(p=>e.jsx("button",{onClick:()=>{a(p.key),n()},className:"text-left rounded-md bg-white/3 text-white/90 font-semibold",children:e.jsx("div",{className:"px-3 py-3 text-base truncate",children:m(p.label)})},p.key))})()})}),e.jsx(ml,{active:s,onChange:i=>{a(i),n()},user:r,className:"flex relative static w-full shadow-none bg-transparent p-0 mobile-sidebar-visible"})]})})}function jf(t){return t.length>=10&&/\d/.test(t)&&/[^A-Za-z0-9]/.test(t)}function Nf(){const[t,n]=o.useState(""),[s,a]=o.useState(""),[r,i]=o.useState(""),[l,u]=o.useState(""),[f,c]=o.useState("");o.useEffect(()=>{try{const h=new URLSearchParams(window.location.search).get("token")||"";n(h)}catch{}},[]);async function m(p){if(p.preventDefault(),u(""),c(""),!t){u("Missing or invalid reset token.");return}if(!s||s!==r){u("Passwords do not match.");return}if(!jf(s)){u("Password must be at least 10 chars and include a number and symbol.");return}try{const N=await(await fetch("/api/auth/confirm-reset",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({token:t,newPassword:s})})).json();if(!N?.ok)throw new Error(N?.error||"Reset failed");c("Password changed. You can now sign in.")}catch(h){u(h?.message||"Reset failed")}}return e.jsxs("div",{className:"min-h-screen flex items-center justify-center relative overflow-hidden",children:[e.jsx("div",{className:"background-animated"}),e.jsx("div",{className:"relative z-10 w-full max-w-lg mx-auto p-4",children:e.jsxs("form",{className:"card w-full space-y-4",onSubmit:m,children:[e.jsx("div",{className:"flex flex-col items-center justify-center gap-2 mb-2 text-center",children:e.jsx("h1",{className:"logo text-center",children:"Reset your password"})}),!t&&e.jsx("div",{className:"text-red-400",children:"This reset link is missing a token. Please use the link from your email."}),e.jsx("input",{className:"input w-full",type:"password",placeholder:"New password",value:s,onChange:p=>a(p.target.value),required:!0}),e.jsx("input",{className:"input w-full",type:"password",placeholder:"Confirm password",value:r,onChange:p=>i(p.target.value),required:!0}),l&&e.jsx("div",{className:"text-red-400 font-semibold text-sm",children:l}),f&&e.jsx("div",{className:"text-emerald-400 font-semibold text-sm",children:f}),e.jsx("button",{className:"btn w-full",type:"submit",disabled:!t,children:"Change Password"}),e.jsx("a",{className:"underline text-sm text-center",href:"/",children:"Back to sign in"})]})})]})}class Sf extends o.Component{constructor(n){super(n),this.state={hasError:!1}}static getDerivedStateFromError(n){return{hasError:!0,message:String(n?.message||n)}}componentDidCatch(n,s){console.error("[ErrorBoundary]",n,s)}render(){return this.state.hasError?e.jsx("div",{className:"min-h-screen flex items-center justify-center p-6",children:e.jsxs("div",{className:"card max-w-lg w-full text-center",children:[e.jsx("h2",{className:"text-2xl font-bold mb-2",children:"Something went wrong"}),e.jsx("p",{className:"opacity-80 mb-4",children:"Please refresh the page. If this persists, let us know."}),this.state.message&&e.jsx("pre",{className:"text-xs bg-black/40 rounded p-2 overflow-auto text-left",children:this.state.message}),e.jsx("button",{className:"btn mt-4",onClick:()=>window.location.reload(),children:"Reload"})]})}):this.props.children}}function Cf(){if(!(typeof window>"u"))try{window.deferredInstallPrompt=null,window.addEventListener("beforeinstallprompt",t=>{t.preventDefault(),window.deferredInstallPrompt=t}),window.promptInstallApp=async()=>{try{const t=window.deferredInstallPrompt;if(!t)return!1;t.prompt();const n=await t.userChoice;return!!n&&n.outcome==="accepted"}catch{return!1}}}catch{}}const kf={};function Ef(){if(!(String(kf?.VITE_QUIET_CONSOLE||"").trim()==="1"))return;const n=window;if(n.__ndnQuietConsoleInstalled)return;n.__ndnQuietConsoleInstalled=!0;const s={error:console.error.bind(console),warn:console.warn.bind(console),log:console.log.bind(console)},a=u=>{const f=u.map(c=>typeof c=="string"?c:c?.message||"").join(" ");return!!(/Not implemented: HTMLMediaElement's play\(\) method/i.test(f)||/WebSocket connection to .* failed/i.test(f)||/ERR_NETWORK_IO_SUSPENDED|ERR_NETWORK_CHANGED/i.test(f))},r=new Map,i=2e3,l=u=>(...f)=>{if(a(f))return;const c=String(f[0]??""),m=Date.now(),p=r.get(c)||0;m-p<i||(r.set(c,m),u(...f))};console.error=l(s.error),console.warn=l(s.warn),window.addEventListener("unhandledrejection",u=>{const f=u.reason&&(u.reason.message||String(u.reason))||"unhandledrejection",c=Date.now(),m=r.get(f)||0;c-m<i||(r.set(f,c),s.warn("[ndn] Unhandled promise rejection:",u.reason))})}try{window.React=window.React||{}}catch{}pu();Cf();Ef();Fc.createRoot(document.getElementById("root")).render(e.jsx(o.StrictMode,{children:e.jsx(Sf,{children:e.jsx(ch,{children:e.jsx(Tf,{})})})}));function Tf(){return window.location.pathname==="/reset"?e.jsx(Nf,{}):e.jsx(yf,{})}const Df=new URLSearchParams(window.location.search).get("pwa")==="1"||typeof localStorage<"u"&&localStorage.getItem("NDN_ENABLE_PWA")==="1";if(Df&&typeof navigator<"u"&&"serviceWorker"in navigator)try{navigator.serviceWorker.register("/sw.js").then(t=>{console.debug("[ServiceWorker] Registered",t)}).catch(t=>{console.warn("[ServiceWorker] Registration failed",t)})}catch{}else if(typeof navigator<"u"&&"serviceWorker"in navigator)try{navigator.serviceWorker.getRegistrations().then(t=>{t.forEach(n=>n.unregister())})}catch{}export{$f as $,Uf as A,gt as B,ii as C,Bh as D,tf as E,Bf as F,Lh as G,Vn as H,Pa as I,Gf as J,No as K,la as L,lf as M,Vf as N,Wf as O,Sm as P,Hf as Q,Dl as R,im as S,Xm as T,zf as U,Jm as V,Zm as W,dn as X,ai as Y,_f as Z,Hu as _,ss as a,ra as a0,si as a1,ll as a2,Jt as a3,Sl as b,El as c,kl as d,oi as e,Jf as f,ms as g,dl as h,Nm as i,e as j,Wt as k,zt as l,Mm as m,Ts as n,Km as o,Qm as p,un as q,Pr as r,Xs as s,$h as t,pe as u,Oh as v,qf as w,Yf as x,Cr as y,Ff as z};
//# sourceMappingURL=index-DP0p83X0.js.map
