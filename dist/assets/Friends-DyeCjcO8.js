import{z as A,a as J,j as s,T as D,A as L}from"./index-healTGBH.js";import{r as u}from"./ui-gqBJRRJB.js";import"./vendor-D3F3s8fL.js";const F="ndn:messages:inbox",I="ndn:messages:unread";function G(){try{const i=localStorage.getItem(F),a=i?JSON.parse(i):[],t=Number(localStorage.getItem(I)||"0")||0;return{inbox:Array.isArray(a)?a.filter(l=>l&&typeof l.id=="string").slice(0,200):[],unread:t}}catch{return{inbox:[],unread:0}}}function v(i,a){try{localStorage.setItem(F,JSON.stringify(i))}catch{}try{localStorage.setItem(I,String(a))}catch{}}const W=G(),z=A((i,a)=>({inbox:W.inbox,unread:W.unread,inGame:!1,setInGame:t=>i({inGame:t}),add:t=>i(n=>{const l=n.inbox.some(g=>g.id===t.id&&g.ts===t.ts),h=l?n.inbox:[t,...n.inbox].slice(0,200),b=n.unread+(l?0:1);return v(h,b),{inbox:h,unread:b}}),load:t=>i(n=>{const l=[...t].sort((h,b)=>b.ts-h.ts).slice(0,200);return v(l,n.unread),{inbox:l,unread:n.unread}}),markAllRead:()=>{const t=a();v(t.inbox,0),i({unread:0})},remove:t=>i(n=>{const l=n.inbox.filter(b=>b.id!==t),h=n.unread;return v(l,h),{inbox:l,unread:h}})})),X=[/\b(f+[\W_]*u+[\W_]*c+[\W_]*k+)\b/gi,/\b(s+[\W_]*h+[\W_]*i+[\W_]*t+)\b/gi,/\b(b+[\W_]*i+[\W_]*t+[\W_]*c+[\W_]*h+)\b/gi,/\b(a+[\W_]*s+[\W_]*s+[\W_]*h+[\W_]*o+[\W_]*l+[\W_]*e+)\b/gi,/\b(d+[\W_]*a+[\W_]*m+[\W_]*n+)\b/gi,/\b(c+[\W_]*r+[\W_]*a+[\W_]*p+)\b/gi,/\b(p+[\W_]*i+[\W_]*s+[\W_]*s+)\b/gi];function B(i){return i.replace(/[\p{L}\p{N}]/gu,"*")}function Q(i){if(!i)return i;let a=i;for(const t of X)a=a.replace(t,n=>B(n));return a}function Y(i){if(!i)return"";const a=Math.floor((Date.now()-i)/1e3);if(a<60)return`${a}s ago`;const t=Math.floor(a/60);if(t<60)return`${t}m ago`;const n=Math.floor(t/60);return n<24?`${n}h ago`:`${Math.floor(n/24)}d ago`}function Z({user:i}){const a=J(),t=String(i?.email||"").toLowerCase(),[n,l]=u.useState([]),[h,b]=u.useState([]),[g,w]=u.useState([]),[R,_]=u.useState(""),[p,$]=u.useState("all"),[f,o]=u.useState(!1),y=z(),[S,k]=u.useState([]),[C,j]=u.useState([]),[E,N]=u.useState({show:!1});async function x(){if(t)try{const[e,r,c,d]=await Promise.all([fetch(`/api/friends/list?email=${encodeURIComponent(t)}`).then(m=>m.json()),fetch(`/api/friends/suggested?email=${encodeURIComponent(t)}`).then(m=>m.json()),fetch(`/api/friends/requests?email=${encodeURIComponent(t)}`).then(m=>m.json()),fetch(`/api/friends/outgoing?email=${encodeURIComponent(t)}`).then(m=>m.json())]);l(e.friends||[]),b(r.suggestions||[]),k(c.requests||[]),j(d.requests||[])}catch{}}u.useEffect(()=>{x()},[t]);async function U(e){if(_(e),!e){w([]);return}try{const c=await(await fetch(`/api/friends/search?q=${encodeURIComponent(e)}`)).json();w(c.results||[])}catch{}}async function q(e){if(!(!t||!e)){o(!0);try{await fetch("/api/friends/add",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:t,friend:e})}),await x(),_(""),w([]),a("Friend added",{type:"success"})}finally{o(!1)}}}async function M(e){if(!(!t||!e)){o(!0);try{await fetch("/api/friends/remove",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:t,friend:e})}),await x(),a("Friend removed",{type:"info"})}finally{o(!1)}}}const O=u.useMemo(()=>p==="all"?n:n.filter(e=>(e.status||"offline")===p),[n,p]);async function P(e){if(!e){a("Room unavailable",{type:"error"});return}try{const r=new CustomEvent("ndn:spectate-request",{detail:{roomId:e}});window.dispatchEvent(r),a("Opening spectator view…",{type:"info"})}catch{}}const T=S.length+C.length;return s.jsxs("div",{className:"card ndn-game-shell",children:[s.jsx("h2",{className:"text-2xl font-bold text-brand-700 mb-2",children:"Friends"}),s.jsx("p",{className:"mb-2 text-brand-600",children:"Manage your friends. See who’s online, in-game, or offline; find new teammates; and invite people to play."}),s.jsxs("div",{className:"text-xs opacity-70 mb-3",children:["Online: ",n.filter(e=>e.status==="online").length," · In-game:"," ",n.filter(e=>e.status==="ingame").length," · Offline:"," ",n.filter(e=>!e.status||e.status==="offline").length]}),s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-3 mb-4",children:[s.jsxs("div",{className:"md:col-span-2 p-3 rounded-2xl bg-black/30 border border-white/10",children:[s.jsx("div",{className:"flex items-center justify-between mb-2",children:s.jsx("div",{className:"font-semibold text-white/90",children:"Your Friends"})}),s.jsx(D,{tabs:[{key:"all",label:"All"},{key:"online",label:"Online"},{key:"ingame",label:"In-Game"},{key:"offline",label:"Offline"},{key:"requests",label:`Requests ${T>0?"("+T+")":""}`}],active:p,onChange:e=>$(e),className:"mb-3"}),p==="requests"?s.jsx("ul",{className:"space-y-2",children:T>0?s.jsxs(s.Fragment,{children:[S.length>0&&S.map(e=>s.jsxs("li",{className:"p-3 rounded bg-black/20 flex flex-col gap-2",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("span",{className:"font-semibold text-lg",children:e.fromUsername||e.fromEmail||"Unknown User"}),s.jsx("span",{className:"text-xs bg-blue-600/20 text-blue-400 px-2 py-1 rounded",children:"Incoming"})]}),s.jsxs("div",{className:"flex gap-2",children:[s.jsx("button",{className:"btn bg-emerald-600 hover:bg-emerald-700",onClick:async()=>{o(!0);try{if((await fetch("/api/friends/accept",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:t,requester:e.fromEmail})})).ok){k(d=>d.filter(m=>m.id!==e.id));const c={email:e.fromEmail,username:e.fromUsername,status:"offline"};l(d=>[...d,c]),j(d=>d.filter(m=>m.toEmail!==e.fromEmail)),a("Friend request accepted",{type:"success"}),setTimeout(()=>x(),100)}else a("Failed to accept request",{type:"error"})}catch{a("Error accepting request",{type:"error"})}finally{o(!1)}},children:"Accept"}),s.jsx("button",{className:"btn bg-rose-600 hover:bg-rose-700",onClick:async()=>{o(!0);try{(await fetch("/api/friends/decline",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:t,requester:e.fromEmail})})).ok?(k(c=>c.filter(d=>d.id!==e.id)),j(c=>c.filter(d=>d.toEmail!==e.fromEmail)),a("Friend request declined",{type:"info"}),setTimeout(()=>x(),100)):a("Failed to decline request",{type:"error"})}finally{o(!1)}},children:"Decline"})]})]},`incoming-${e.id||e.fromEmail}`)),C.length>0&&C.map(e=>s.jsxs("li",{className:"p-3 rounded bg-black/20 flex flex-col gap-2",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("span",{className:"font-semibold text-lg",children:e.toUsername||e.toEmail||"Unknown User"}),s.jsx("span",{className:"text-xs bg-amber-600/20 text-amber-400 px-2 py-1 rounded",children:"Pending"})]}),s.jsx("button",{className:"btn bg-slate-600 hover:bg-slate-700 self-start",onClick:async()=>{o(!0);try{(await fetch("/api/friends/cancel",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:t,friend:e.toEmail})})).ok?(j(c=>c.filter(d=>d.id!==e.id)),a("Friend request cancelled",{type:"info"}),setTimeout(()=>x(),100)):a("Failed to cancel request",{type:"error"})}finally{o(!1)}},children:"Cancel"})]},`outgoing-${e.id||e.toEmail}`))]}):s.jsx("li",{className:"text-sm opacity-70",children:"No friend requests yet."})}):s.jsxs("ul",{className:"space-y-2",children:[O.map(e=>s.jsxs("li",{className:"p-2 rounded bg-black/20 flex items-center justify-between",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("span",{className:`inline-block w-2 h-2 rounded-full ${e.status==="online"?"bg-emerald-400":e.status==="ingame"?"bg-amber-400":"bg-slate-400"}`}),s.jsx("span",{className:"font-semibold",children:e.username||e.email}),s.jsxs("span",{className:"text-xs opacity-70",children:[e.status||"offline",e.status!=="online"&&e.lastSeen?` · ${Y(e.lastSeen)}`:""]}),e.status==="ingame"&&e.match&&s.jsxs("span",{className:"text-[10px] opacity-70 px-2 py-0.5 rounded bg-indigo-500/20 border border-indigo-600/30",children:[e.match.game," ",L(e.match.mode)," ",e.match.value,e.match.game==="X01"&&e.match.startingScore?` · ${e.match.startingScore}`:""]})]}),s.jsxs("div",{className:"flex items-center gap-2",children:[e.status==="ingame"&&e.roomId&&s.jsx("button",{className:"btn",onClick:()=>P(e.roomId),children:"Spectate"}),s.jsx("button",{className:"btn",disabled:f||e.status!=="online"&&e.status!=="ingame",onClick:async()=>{o(!0);try{(await(await fetch("/api/friends/invite",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({fromEmail:t,toEmail:e.email,game:"X01",mode:"bestof",value:3,startingScore:501})})).json().catch(()=>({})))?.delivered?a("Invite sent",{type:"success"}):a("Friend is offline; invite queued",{type:"info"})}finally{o(!1)}},children:"Invite"}),s.jsx("button",{className:"btn",disabled:f,onClick:()=>N({show:!0,toUser:e.username||e.email,toEmail:e.email}),children:"Message"}),s.jsx("button",{className:"btn bg-rose-600 hover:bg-rose-700",disabled:f,onClick:()=>M(e.email),children:"Remove"})]})]},e.email)),O.length===0&&s.jsxs("li",{className:"text-sm opacity-70",children:["No friends ",p!=="all"?`in ${p}`:""," yet."]})]})]}),s.jsxs("div",{className:"p-3 rounded-2xl bg-black/20 border border-white/10",children:[s.jsx("div",{className:"font-semibold mb-2 text-white/90",children:"Find Friends"}),s.jsx("input",{className:"input w-full mb-2",placeholder:"Search by name or email",value:R,onChange:e=>U(e.target.value)}),s.jsxs("ul",{className:"space-y-1 mb-3 max-h-48 overflow-auto",children:[g.map(e=>s.jsxs("li",{className:"flex items-center justify-between p-2 rounded bg-black/10",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("span",{className:`inline-block w-2 h-2 rounded-full ${e.status==="online"?"bg-emerald-400":e.status==="ingame"?"bg-amber-400":"bg-slate-400"}`}),s.jsx("span",{children:e.username||e.email})]}),s.jsx("button",{className:"btn",disabled:f,onClick:()=>q(e.email),children:"Add"})]},e.email)),g.length===0&&s.jsx("li",{className:"text-xs opacity-60",children:"Type to search…"})]}),s.jsx("div",{className:"font-semibold mb-1 text-white/90",children:"Suggested"}),s.jsxs("ul",{className:"space-y-1 max-h-48 overflow-auto",children:[h.map(e=>s.jsxs("li",{className:"flex items-center justify-between p-2 rounded bg-black/10",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("span",{className:`inline-block w-2 h-2 rounded-full ${e.status==="online"?"bg-emerald-400":e.status==="ingame"?"bg-amber-400":"bg-slate-400"}`}),s.jsx("span",{children:e.username||e.email})]}),s.jsx("button",{className:"btn",disabled:f,onClick:()=>q(e.email),children:"Add"})]},e.email)),h.length===0&&s.jsx("li",{className:"text-xs opacity-60",children:"No suggestions right now."})]})]})]}),s.jsxs("div",{className:"p-3 rounded-xl bg-indigo-500/10 border border-indigo-500/40",children:[s.jsxs("div",{className:"flex items-center justify-between mb-2",children:[s.jsx("div",{className:"font-semibold",children:"Messages"}),s.jsx("button",{className:"btn px-3 py-1 text-sm",onClick:()=>y.markAllRead(),children:"Mark all read"})]}),y.inbox.length===0?s.jsx("div",{className:"text-sm opacity-70",children:"No messages yet."}):s.jsx("ul",{className:"space-y-2 max-h-72 overflow-auto",children:y.inbox.map(e=>s.jsxs("li",{className:"p-2 rounded bg-black/20 text-sm",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{children:[s.jsx("span",{className:"font-semibold",children:e.from})," ",s.jsxs("span",{className:"opacity-70 text-xs",children:["· ",new Date(e.ts).toLocaleString()]})]}),s.jsxs("div",{className:"flex gap-2",children:[s.jsx("button",{className:"btn px-2 py-1 text-xs",onClick:()=>N({show:!0,toUser:e.from,toEmail:e.from,replyTo:e.from}),children:"Reply"}),s.jsx("button",{className:"btn bg-slate-700 hover:bg-slate-800 px-2 py-1 text-xs",title:"Delete this message",onClick:()=>y.remove(e.id),children:"Delete"}),s.jsx("button",{className:"btn bg-rose-600 hover:bg-rose-700 px-2 py-1 text-xs",onClick:async()=>{const r=prompt("Report reason (what happened)?");if(r)try{await fetch("/api/friends/report",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({reporterEmail:t,offenderEmail:e.from,reason:r,messageId:e.id})}),a("Report sent to admin",{type:"info"})}catch{}},children:"Report"})]})]}),s.jsx("div",{className:"mt-1 whitespace-pre-wrap break-words",children:Q(e.message)})]},e.id))})]}),E.show&&s.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50",children:s.jsxs("div",{className:"bg-slate-800 border border-slate-600 rounded-lg p-6 max-w-md w-full mx-4",children:[s.jsx("div",{className:"text-center mb-4",children:s.jsxs("h3",{className:"text-lg font-semibold text-white",children:["Type Message To ",E.toUser]})}),s.jsx("textarea",{className:"w-full h-32 bg-slate-700 border border-slate-600 rounded p-3 text-white placeholder-slate-400 resize-none",placeholder:"Type your message here...",id:"message-input",autoFocus:!0}),s.jsxs("div",{className:"flex gap-3 mt-4",children:[s.jsx("button",{className:"flex-1 btn bg-emerald-600 hover:bg-emerald-700",onClick:async()=>{const r=document.getElementById("message-input")?.value?.trim();if(r){o(!0);try{await fetch("/api/friends/message",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({fromEmail:t,toEmail:E.toEmail,message:r})}),a("Message sent",{type:"success"}),N({show:!1})}catch{a("Failed to send message",{type:"error"})}finally{o(!1)}}},disabled:f,children:"Send"}),s.jsx("button",{className:"flex-1 btn bg-slate-600 hover:bg-slate-700",onClick:()=>N({show:!1}),children:"Cancel"})]})]})})]})}export{Z as default};
//# sourceMappingURL=Friends-DyeCjcO8.js.map
