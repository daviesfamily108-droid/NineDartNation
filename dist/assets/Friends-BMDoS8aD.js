import{z,e as B,j as s,A as X,D as Q}from"./index-jnU-qcsE.js";import{r}from"./ui-C3zlW9wh.js";import"./vendor-D3F3s8fL.js";const q="ndn:messages:inbox",$="ndn:messages:unread";function Y(){try{const i=localStorage.getItem(q),n=i?JSON.parse(i):[],t=Number(localStorage.getItem($)||"0")||0;return{inbox:Array.isArray(n)?n.filter(o=>o&&typeof o.id=="string").slice(0,200):[],unread:t}}catch{return{inbox:[],unread:0}}}function j(i,n){try{localStorage.setItem(q,JSON.stringify(i))}catch{}try{localStorage.setItem($,String(n))}catch{}}const R=Y(),H=z((i,n)=>({inbox:R.inbox,unread:R.unread,inGame:!1,setInGame:t=>i({inGame:t}),add:t=>i(a=>{const o=a.inbox.some(b=>b.id===t.id&&b.ts===t.ts),d=o?a.inbox:[t,...a.inbox].slice(0,200),c=a.unread+(o?0:1);return j(d,c),{inbox:d,unread:c}}),load:t=>i(a=>{const o=[...t].sort((d,c)=>c.ts-d.ts).slice(0,200);return j(o,a.unread),{inbox:o,unread:a.unread}}),markAllRead:()=>{const t=n();j(t.inbox,0),i({unread:0})},remove:t=>i(a=>{const o=a.inbox.filter(c=>c.id!==t),d=a.unread;return j(o,d),{inbox:o,unread:d}})})),K=[/\b(f+[\W_]*u+[\W_]*c+[\W_]*k+)\b/gi,/\b(s+[\W_]*h+[\W_]*i+[\W_]*t+)\b/gi,/\b(b+[\W_]*i+[\W_]*t+[\W_]*c+[\W_]*h+)\b/gi,/\b(a+[\W_]*s+[\W_]*s+[\W_]*h+[\W_]*o+[\W_]*l+[\W_]*e+)\b/gi,/\b(d+[\W_]*a+[\W_]*m+[\W_]*n+)\b/gi,/\b(c+[\W_]*r+[\W_]*a+[\W_]*p+)\b/gi,/\b(p+[\W_]*i+[\W_]*s+[\W_]*s+)\b/gi];function V(i){return i.replace(/[\p{L}\p{N}]/gu,"*")}function Z(i){if(!i)return i;let n=i;for(const t of K)n=n.replace(t,a=>V(a));return n}function ee(i){if(!i)return"";const n=Math.floor((Date.now()-i)/1e3);if(n<60)return`${n}s ago`;const t=Math.floor(n/60);if(t<60)return`${t}m ago`;const a=Math.floor(t/60);return a<24?`${a}h ago`:`${Math.floor(a/24)}d ago`}function ae({user:i}){const n=B(),t=String(i?.email||"").toLowerCase(),[a,o]=r.useState([]),[d,c]=r.useState([]),[b,N]=r.useState([]),[F,W]=r.useState(""),[m,E]=r.useState("all"),[g,h]=r.useState(!1),p=H(),[w,I]=r.useState([]),[v,M]=r.useState([]),[S,f]=r.useState({show:!1});async function u(){if(t)try{const[e,l,C,G]=await Promise.all([fetch(`/api/friends/list?email=${encodeURIComponent(t)}`).then(x=>x.json()),fetch(`/api/friends/suggested?email=${encodeURIComponent(t)}`).then(x=>x.json()),fetch(`/api/friends/requests?email=${encodeURIComponent(t)}`).then(x=>x.json()),fetch(`/api/friends/outgoing?email=${encodeURIComponent(t)}`).then(x=>x.json())]);o(e.friends||[]),c(l.suggestions||[]),I(C.requests||[]),M(G.requests||[])}catch{}}r.useEffect(()=>{u()},[t]);async function T(e){if(W(e),!e){N([]);return}try{const C=await(await fetch(`/api/friends/search?q=${encodeURIComponent(e)}`)).json();N(C.results||[])}catch{}}async function _(e){if(!(!t||!e)){h(!0);try{await fetch("/api/friends/add",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:t,friend:e})}),await u(),W(""),N([]),n("Friend added",{type:"success"})}finally{h(!1)}}}async function U(e){if(!(!t||!e)){h(!0);try{await fetch("/api/friends/remove",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:t,friend:e})}),await u(),n("Friend removed",{type:"info"})}finally{h(!1)}}}async function P(e){try{await fetch("/api/friends/accept",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:t,requestId:e})}),await u(),n("Friend request accepted",{type:"success"})}catch{}}async function A(e){try{await fetch("/api/friends/decline",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:t,requestId:e})}),await u(),n("Friend request declined",{type:"info"})}catch{}}async function J(e){try{await fetch("/api/friends/cancel",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:t,requestId:e})}),await u(),n("Friend request cancelled",{type:"info"})}catch{}}async function L(){const l=document.getElementById("message-input")?.value;if(!(!l||!S.toEmail))try{await fetch("/api/friends/message",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({fromEmail:t,toEmail:S.toEmail,message:l})}),f({show:!1}),n("Message sent",{type:"success"})}catch{}}const O=r.useMemo(()=>m==="all"?a:a.filter(e=>(e.status||"offline")===m),[a,m]),k=r.useMemo(()=>{const e={online:0,ingame:0,offline:0};for(const l of a)l.status==="online"?e.online+=1:l.status==="ingame"?e.ingame+=1:e.offline+=1;return e},[a]);async function D(e){if(!e){n("Room unavailable",{type:"error"});return}try{const l=new CustomEvent("ndn:spectate-request",{detail:{roomId:e}});window.dispatchEvent(l),n("Opening spectator view...",{type:"info"})}catch{}}const y=w.length+v.length;return s.jsxs("div",{className:"card ndn-game-shell",children:[s.jsx("h2",{className:"text-2xl font-bold text-brand-700 mb-2",children:"Friends ðŸ‘¥"}),s.jsx("p",{className:"mb-2 text-brand-600",children:"Manage your friends. See who's online, in-game, or offline; find new teammates; and invite people to play."}),s.jsx("div",{className:"grid gap-3 mb-4 grid-cols-2 sm:grid-cols-4",children:[{label:"Online",value:k.online,accent:"bg-emerald-500/10 border-emerald-500/40"},{label:"In-Game",value:k.ingame,accent:"bg-amber-500/10 border-amber-500/40"},{label:"Offline",value:k.offline,accent:"bg-slate-500/10 border-slate-500/40"},{label:"Requests",value:y,accent:"bg-indigo-500/10 border-indigo-500/40"}].map(e=>s.jsxs("div",{className:`rounded-2xl border px-3 py-2 text-center ${e.accent}`,children:[s.jsx("div",{className:"text-xs uppercase tracking-[0.3em] text-slate-400",children:e.label}),s.jsx("div",{className:"text-2xl font-semibold text-white",children:e.value})]},e.label))}),s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-3 mb-4",children:[s.jsxs("div",{className:"md:col-span-2 p-4 rounded-[28px] bg-gradient-to-br from-slate-900/80 to-indigo-900/60 border border-white/10 shadow-2xl",children:[s.jsx("div",{className:"flex items-center justify-between mb-2",children:s.jsx("div",{className:"font-semibold text-white/90",children:"Your Friends ðŸ‘¥"})}),s.jsx(X,{tabs:[{key:"all",label:"All ðŸ‘¥"},{key:"online",label:"Online ðŸŸ¢"},{key:"ingame",label:"In-Game ðŸŽ®"},{key:"offline",label:"Offline âšª"},{key:"requests",label:`Requests ${y>0?"("+y+")":""} ðŸ“©`}],active:m,onChange:e=>E(e),className:"mb-3"}),m==="requests"?s.jsx("ul",{className:"space-y-3",children:y>0?s.jsxs(s.Fragment,{children:[w.length>0&&w.map(e=>s.jsxs("li",{className:"p-3 rounded-2xl border border-white/10 bg-slate-900/40 flex flex-col gap-3",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("span",{className:"font-semibold text-lg",children:e.fromUsername||e.fromEmail||"Unknown User"}),s.jsx("span",{className:"text-xs bg-blue-600/20 text-blue-400 px-2 py-1 rounded",children:"Incoming"})]}),s.jsxs("div",{className:"flex gap-2",children:[s.jsx("button",{onClick:()=>P(e.id),className:"px-3 py-1 rounded-lg bg-emerald-500/20 text-emerald-400 text-xs font-bold hover:bg-emerald-500/30 transition-colors",children:"Accept âœ…"}),s.jsx("button",{onClick:()=>A(e.id),className:"px-3 py-1 rounded-lg bg-rose-500/20 text-rose-400 text-xs font-bold hover:bg-rose-500/30 transition-colors",children:"Decline âŒ"})]})]},`incoming-${e.id||e.fromEmail}`)),v.length>0&&v.map(e=>s.jsxs("li",{className:"p-3 rounded-2xl border border-white/10 bg-slate-900/40 flex flex-col gap-3",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("span",{className:"font-semibold text-lg",children:e.toUsername||e.toEmail||"Unknown User"}),s.jsx("div",{className:"px-3 py-1 rounded-lg bg-white/5 text-white/40 text-xs font-bold",children:"Pending â³"})]}),s.jsx("button",{onClick:()=>J(e.id),className:"px-3 py-1 rounded-lg bg-rose-500/20 text-rose-400 text-xs font-bold hover:bg-rose-500/30 transition-colors",children:"Cancel âœ–ï¸"})]},`outgoing-${e.id||e.toEmail}`))]}):s.jsx("li",{className:"text-sm opacity-70",children:"No friend requests yet."})}):s.jsxs("ul",{className:"space-y-3",children:[O.map(e=>s.jsx("li",{className:"rounded-2xl border border-white/10 bg-slate-900/40 p-4 flex flex-col gap-3 shadow-lg",children:s.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-3",children:[s.jsxs("div",{children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("span",{className:`inline-block w-2.5 h-2.5 rounded-full ${e.status==="online"?"bg-emerald-400":e.status==="ingame"?"bg-amber-400":"bg-slate-400"}`}),s.jsx("span",{className:"font-semibold text-white",children:e.username||e.email})]}),s.jsxs("div",{className:"text-xs text-slate-400",children:[e.status||"offline",e.status!=="online"&&e.lastSeen?` Â· ${ee(e.lastSeen)}`:""]}),e.status==="ingame"&&e.match&&s.jsxs("div",{className:"text-[11px] inline-flex items-center gap-1 mt-2 rounded-full border border-indigo-500/40 bg-indigo-500/10 px-3 py-0.5 text-indigo-200",children:[s.jsx("span",{className:"font-medium",children:"Live Match"}),s.jsxs("span",{children:[e.match.game," ",Q(e.match.mode)," ",e.match.value,e.match.game==="X01"&&e.match.startingScore?` Â· ${e.match.startingScore}`:""]})]})]}),s.jsxs("div",{className:"flex gap-2 flex-wrap",children:[e.status==="ingame"&&e.roomId&&s.jsx("button",{onClick:()=>D(e.roomId),className:"px-3 py-1 rounded-lg bg-indigo-500/20 text-indigo-400 text-xs font-bold hover:bg-indigo-500/30 transition-colors",children:"Spectate ðŸ‘ï¸"}),s.jsx("button",{onClick:()=>{f({show:!0,toEmail:e.email,toUser:e.username||e.email})},className:"flex-1 px-3 py-2 rounded-xl bg-indigo-500/20 text-indigo-400 text-xs font-bold hover:bg-indigo-500/30 transition-colors",children:"Message ðŸ’¬"}),s.jsx("button",{onClick:()=>U(e.email),className:"px-3 py-2 rounded-xl bg-rose-500/20 text-rose-400 text-xs font-bold hover:bg-rose-500/30 transition-colors",title:"Remove Friend",children:"Remove ðŸ—‘ï¸"})]})]})},e.email)),O.length===0&&s.jsxs("li",{className:"text-sm opacity-70",children:["No friends ",m!=="all"?`in ${m}`:""," yet."]})]})]}),s.jsxs("div",{className:"p-4 rounded-[28px] bg-slate-950/70 border border-white/10 shadow-xl",children:[s.jsx("div",{className:"font-semibold mb-2 text-white/90",children:"Find Friends"}),s.jsx("input",{className:"input w-full mb-2",placeholder:"Search by name or email",value:F,onChange:e=>T(e.target.value)}),s.jsxs("ul",{className:"space-y-2 mb-3 max-h-48 overflow-auto",children:[b.map(e=>s.jsxs("li",{className:"flex items-center justify-between gap-2 p-3 rounded-2xl border border-white/10 bg-slate-900/40",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("span",{className:`inline-block w-2 h-2 rounded-full ${e.status==="online"?"bg-emerald-400":e.status==="ingame"?"bg-amber-400":"bg-slate-400"}`}),s.jsx("span",{children:e.username||e.email})]}),s.jsx("button",{onClick:()=>_(e.email),disabled:g,className:`px-4 py-2 rounded-xl text-white text-sm font-bold transition-colors ${g?"bg-indigo-900/40 cursor-not-allowed":"bg-indigo-600 hover:bg-indigo-500"}`,children:g?"Workingâ€¦":"Add âž•"})]},e.email)),b.length===0&&s.jsx("li",{className:"text-xs opacity-60",children:"Type to search..."})]}),s.jsx("div",{className:"font-semibold mb-1 text-white/90",children:"Suggested"}),s.jsxs("ul",{className:"space-y-2 max-h-48 overflow-auto",children:[d.map(e=>s.jsxs("li",{className:"flex items-center justify-between gap-2 p-3 rounded-2xl border border-white/10 bg-slate-900/40",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("span",{className:`inline-block w-2 h-2 rounded-full ${e.status==="online"?"bg-emerald-400":e.status==="ingame"?"bg-amber-400":"bg-slate-400"}`}),s.jsx("span",{children:e.username||e.email})]}),s.jsx("button",{onClick:()=>_(e.email),disabled:g,className:`px-4 py-2 rounded-xl text-white text-sm font-bold transition-colors ${g?"bg-indigo-900/40 cursor-not-allowed":"bg-indigo-600 hover:bg-indigo-500"}`,children:g?"Workingâ€¦":"Add âž•"})]},e.email)),d.length===0&&s.jsx("li",{className:"text-xs opacity-60",children:"No suggestions right now."})]})]})]}),s.jsxs("div",{className:"p-3 rounded-xl bg-indigo-500/10 border border-indigo-500/40",children:[s.jsxs("div",{className:"flex items-center justify-between mb-2",children:[s.jsx("div",{className:"font-semibold",children:"Messages ðŸ’¬"}),s.jsx("button",{onClick:()=>p.markAllRead(),className:"text-xs text-indigo-400 font-bold hover:text-indigo-300 transition-colors",children:"Mark all read âœ…"})]}),p.inbox.length===0?s.jsx("div",{className:"text-sm opacity-70",children:"No messages yet."}):s.jsx("ul",{className:"space-y-2 max-h-72 overflow-auto",children:p.inbox.map(e=>s.jsxs("li",{className:"p-2 rounded bg-black/20 text-sm",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{children:[s.jsx("span",{className:"font-semibold",children:e.from})," ",s.jsxs("span",{className:"opacity-70 text-xs",children:["Â· ",new Date(e.ts).toLocaleString()]})]}),s.jsxs("div",{className:"flex gap-2",children:[s.jsx("button",{onClick:()=>{f({show:!0,toEmail:e.from,toUser:e.from})},className:"px-3 py-1 rounded-lg bg-indigo-500/20 text-indigo-400 text-xs font-bold hover:bg-indigo-500/30 transition-colors",children:"Reply â†©ï¸"}),s.jsx("button",{onClick:()=>p.remove(e.id),className:"px-3 py-1 rounded-lg bg-rose-500/20 text-rose-400 text-xs font-bold hover:bg-rose-500/30 transition-colors",children:"Delete ðŸ—‘ï¸"}),s.jsx("button",{className:"btn bg-rose-600 hover:bg-rose-700 px-2 py-1 text-xs",onClick:async()=>{const l=prompt("Report reason (what happened)?");if(l)try{await fetch("/api/friends/report",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({reporterEmail:t,offenderEmail:e.from,reason:l,messageId:e.id})}),n("Report sent to admin",{type:"info"})}catch{}},children:"Report"})]})]}),s.jsx("div",{className:"mt-1 whitespace-pre-wrap break-words",children:Z(e.message)})]},e.id))})]}),S.show&&s.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50",children:s.jsxs("div",{className:"bg-slate-800 border border-slate-600 rounded-lg p-6 max-w-md w-full mx-4",children:[s.jsx("div",{className:"text-center mb-4",children:s.jsx("h3",{className:"text-lg font-semibold text-white",children:"Send Message âœ‰ï¸"})}),s.jsx("textarea",{className:"w-full h-32 bg-slate-700 border border-slate-600 rounded p-3 text-white placeholder-slate-400 resize-none",placeholder:"Type your message here...",id:"message-input",autoFocus:!0}),s.jsxs("div",{className:"flex gap-3 mt-4",children:[s.jsx("button",{onClick:L,className:"px-6 py-2 rounded-xl bg-indigo-600 text-white font-bold hover:bg-indigo-500 transition-colors",children:"Send Message ðŸ“¤"}),s.jsx("button",{className:"btn bg-slate-600 hover:bg-slate-700",onClick:()=>f({show:!1}),children:"Cancel"})]})]})})]})}export{ae as default};
//# sourceMappingURL=Friends-BMDoS8aD.js.map
