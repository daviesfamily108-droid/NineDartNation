import{Z as _,_ as Nn,u as Te,$ as ho,a0 as kn,a1 as Nt,a2 as ft,a3 as Mr,a4 as mo,a5 as go,a6 as En,a7 as ut,a8 as Zt,a9 as Pr,a as kt,j as a,aa as Jn,ab as Et,ac as Mt,ad as bo,i as Pt,ae as Mn,af as po,ag as xo,ah as yo,ai as wo,aj as Co}from"./index-Bwxu4vN5.js";import{r as p}from"./ui-Cl5S-Tv0.js";import{g as vo}from"./vendor-D3F3s8fL.js";function So(e){const t=Array.from({length:7},()=>Array.from({length:7},()=>0)),s=[];for(let o=9;o>=0;o--)s.push(e>>o&1);for(let o=0;o<5;o++){const n=o+1,r=s[2*o]??0,d=s[2*o+1]??0;t[n][2]=r,t[n][4]=d}return t}const No=e=>!!e&&Number.isFinite(e.x)&&Number.isFinite(e.y),ko=e=>Array.isArray(e)&&e.length===9&&e.every(Number.isFinite);function Eo(e,t){const s=e.getContext("2d",{willReadFrequently:!0});if(!s)return null;const o=e.width,n=e.height,r=160,d=r/o,i=Math.floor(n*d),y=new OffscreenCanvas(r,i).getContext("2d",{willReadFrequently:!0});if(!y)return null;y.drawImage(e,0,0,r,i);const k=y.getImageData(0,0,r,i).data,E=new Float32Array(r*i),S=8;for(let F=1;F<i-1;F++)for(let $=1;$<r-1;$++){const J=(F*r+$)*4,X=J-4,Z=J+4,oe=J-r*4,U=J+r*4,he=k[X]*.299+k[X+1]*.587+k[X+2]*.114,ie=k[Z]*.299+k[Z+1]*.587+k[Z+2]*.114,ce=k[oe]*.299+k[oe+1]*.587+k[oe+2]*.114,De=k[U]*.299+k[U+1]*.587+k[U+2]*.114,Re=ie-he,Ue=De-ce,We=Math.sqrt(Re*Re+Ue*Ue);if(We>S){const ht=Re/We,mt=Ue/We,q=r*.03,tt=r*.6;for(let Oe=q;Oe<tt;Oe+=1){const gt=Math.round($+ht*Oe),bt=Math.round(F+mt*Oe);gt>=0&&gt<r&&bt>=0&&bt<i&&E[bt*r+gt]++;const Ke=Math.round($-ht*Oe),pt=Math.round(F-mt*Oe);Ke>=0&&Ke<r&&pt>=0&&pt<i&&E[pt*r+Ke]++}}}const I=new Float32Array(r*i),O=2;for(let F=O;F<i-O;F++)for(let $=O;$<r-O;$++){let J=0;for(let X=-O;X<=O;X++)for(let Z=-O;Z<=O;Z++)J+=E[(F+X)*r+($+Z)];I[F*r+$]=J}let B=0,N=r/2,D=i/2;const R=5;for(let F=R;F<i-R;F++)for(let $=R;$<r-R;$++){const J=I[F*r+$];J>B&&(B=J,N=$,D=F)}let M=N/d,A=D/d;t&&Number.isFinite(t.x)&&Number.isFinite(t.y)&&(M=.7*t.x+.3*M,A=.7*t.y+.3*A),console.log(`[findDartboardRings] Voting Peak: (${Math.round(M)}, ${Math.round(A)}) Votes=${B}`);const m=400,w=m/o,b=Math.floor(n*w),j=new OffscreenCanvas(m,b).getContext("2d");if(!j)return null;j.drawImage(e,0,0,m,b);const h=j.getImageData(0,0,m,b).data,T=new Float32Array(m*b),x=new Float32Array(m*b);for(let F=1;F<b-1;F++)for(let $=1;$<m-1;$++){const J=(F*m+$)*4;h[J]*.299+h[J+1]*.587+h[J+2]*.114;const X=J-4,Z=J+4,oe=J-m*4,U=J+m*4,he=h[X]*.299+h[X+1]*.587+h[X+2]*.114,ie=h[Z]*.299+h[Z+1]*.587+h[Z+2]*.114,ce=h[oe]*.299+h[oe+1]*.587+h[oe+2]*.114,De=h[U]*.299+h[U+1]*.587+h[U+2]*.114,Re=ie-he,Ue=De-ce;T[F*m+$]=Re,x[F*m+$]=Ue}const L=s.getImageData(0,0,o,n).data,G=(F,$)=>{const J=Math.max(0,Math.min(o-1,Math.round(F))),Z=(Math.max(0,Math.min(n-1,Math.round($)))*o+J)*4;return .299*L[Z]+.587*L[Z+1]+.114*L[Z+2]},ge=60,te={};for(let F=0;F<ge;F++){const $=F/ge*Math.PI*2,J=Math.cos($),X=Math.sin($),Z=[];for(let U=30;U<Math.min(o,n)/2;U+=1){const he=M+(U-2)*J,ie=A+(U-2)*X,ce=M+(U+2)*J,De=A+(U+2)*X,Re=G(he,ie),Ue=G(ce,De),We=Math.abs(Ue-Re);We>2&&U>20&&Z.push({r:U,grad:We})}const oe=[];for(let U=0;U<Z.length;U++){const he=U>0?Z[U-1].grad:0,ie=Z[U].grad,ce=U<Z.length-1?Z[U+1].grad:0;ie>he&&ie>ce&&ie>2&&oe.push(Z[U].r)}oe.length>0&&oe.forEach(U=>{const he=Object.keys(te).map(ce=>({key:parseInt(ce),median:te[parseInt(ce)][Math.floor(te[parseInt(ce)].length/2)]})).filter(ce=>Math.abs(ce.median-U)<15).sort((ce,De)=>Math.abs(ce.median-U)-Math.abs(De.median-U))[0],ie=he?he.key:Math.max(-1,...Object.keys(te).map(ce=>parseInt(ce)))+1;te[ie]||(te[ie]=[]),te[ie].push(U)})}const ye=Object.keys(te).map(F=>{const $=te[parseInt(F)].sort((X,Z)=>X-Z),J=$[Math.floor($.length/2)];return{tier:parseInt(F),radius:J,samples:$.length}}).sort((F,$)=>F.radius-$.radius);console.log("[findDartboardRings] Detected ring tiers:",ye);const Q=[...ye];if(Q.length>=2){const F=Q[Q.length-1].radius,$=Q[Q.length-2].radius,J=F/$;(J>1.15&&Q.length>=5||J>1.3)&&(console.log(`[findDartboardRings] Ignoring outermost ring (likely light ring/surround): ${F.toFixed(1)}px (ratio ${J.toFixed(2)} to ${$.toFixed(1)}px)`),Q.pop())}const Ce=Q.length>0?Q[Q.length-1].radius:Math.min(o,n)*.3;let Ee=50+Q.length*6;return Q.length>=7?Ee=98:Q.length===6?Ee=96:Q.length===5&&(Ee=94),{cx:M,cy:A,r:Ce,confidence:Ee,ringCount:Q.length,ringStrength:Q.length>0?Q[Q.length-1].radius:0,detectedRings:Q.map(F=>F.radius)}}function Mo(e,t,s,o){const n=e.getContext("2d");if(!n)return null;const r=e.width,d=e.height,i=720,u=o,y=new Array(i).fill(0),P=Math.max(2,Math.round(u-8)),k=Math.round(u+8),E=n.getImageData(0,0,r,d).data,S=(m,w)=>{const b=Math.round(m),C=Math.round(w);if(b<0||b>=r||C<0||C>=d)return 127;const j=(C*r+b)*4;return E[j]*.299+E[j+1]*.587+E[j+2]*.114};for(let m=0;m<i;m++){const w=m/i*Math.PI*2;let b=0,C=S(t+P*Math.cos(w),s+P*Math.sin(w));for(let j=P+1;j<=k;j++){const h=S(t+j*Math.cos(w),s+j*Math.sin(w)),T=Math.abs(h-C);T>b&&(b=T),C=h}y[m]=b}const I=[];for(let m=0;m<i;m++){const w=y[(m-1+i)%i],b=y[m],C=y[(m+1)%i];b>w&&b>C&&b>10&&I.push(m)}if(I.length<16){const m=y.map((w,b)=>{let C=0,j=0;for(let h=-2;h<=2;h++)C+=y[(b+h+i)%i],j++;return C/j});for(let w=0;w<i;w++){const b=m[(w-1+i)%i],C=m[w],j=m[(w+1)%i];C>b&&C>j&&C>8&&I.push(w)}}if(I.length===0)return 0;const O=I.map(m=>m/i*Math.PI*2);O.sort((m,w)=>m-w);const B=[];for(let m=0;m<O.length;m++){const w=O[m],C=(O[(m+1)%O.length]-w+Math.PI*2)%(Math.PI*2);B.push((w+C/2)%(Math.PI*2))}const N=20,D=new Array(N).fill(0).map((m,w)=>-Math.PI/2+w*(Math.PI*2/N));let R=0,M=1/0;for(let m=0;m<B.length;m++){let w=0;for(let b=0;b<Math.min(N,B.length);b++){const C=B[(b+m)%B.length],j=D[b],h=Math.abs((C-j+Math.PI)%(Math.PI*2)-Math.PI);w+=h*h}w<M&&(M=w,R=(B[m]-D[0]+Math.PI*2)%(Math.PI*2))}return(R+Math.PI)%(Math.PI*2)-Math.PI}function Po(e,t){const s=e.getContext("2d");if(!s)return t;const o=e.width,n=e.height,d=s.getImageData(0,0,o,n).data,i=(N,D)=>{const R=Math.max(0,Math.min(o-1,Math.round(N))),A=(Math.max(0,Math.min(n-1,Math.round(D)))*o+R)*4;return .299*d[A]+.587*d[A+1]+.114*d[A+2]},u=(N,D)=>{const R=i(N+1,D)-i(N-1,D),M=i(N,D+1)-i(N,D-1);return{gx:R,gy:M}},y=ft(t,{x:0,y:0}),P=N=>{const D=[_.trebleOuter,_.doubleOuter];let R=0;for(const M of D){const A=ut(N,M,180);for(let m=0;m<A.length;m++){const w=A[m],b=u(w.x,w.y),C=w.x-y.x,j=w.y-y.y,h=Math.hypot(C,j)||1,T=C/h,x=j/h;R+=Math.abs(b.gx*T+b.gy*x)}}return R/180/2};let k=t,E=P(t);const S=N=>N*Math.PI/180,I=[-4,-2,-1,-.5,0,.5,1,2,4],O=[-3,-2,-1,0,1,2,3],B=[.98,.99,1,1.01,1.02];for(const N of I){const D=go(t,S(N));for(const R of O)for(const M of O){const A=Mr(D,R,M);for(const m of B){const w=En(A,m,m),b=P(w);b>E&&(E=b,k=w)}}}return k}function Kn(e,t){try{const s=e.width,o=e.height,n=s/2,r=o/2;let d=e;if(t?.colorAssist)try{const m=((h,T)=>{try{return new OffscreenCanvas(h,T)}catch{const x=document.createElement("canvas");return x.width=h,x.height=T,x}})(s,o),w=m.getContext("2d");if(!w)throw new Error("Could not get 2D context");w.drawImage(e,0,0,s,o);const b=w.getImageData(0,0,s,o),C=b.data,j=(h,T,x)=>{const L=h/255,G=T/255,ge=x/255,te=Math.max(L,G,ge),ye=Math.min(L,G,ge),Q=te-ye;let Ce=0;Q!==0&&(te===L?Ce=(G-ge)/Q%6:te===G?Ce=(ge-L)/Q+2:Ce=(L-G)/Q+4,Ce*=60,Ce<0&&(Ce+=360));const Ee=te===0?0:Q/te;return{h:Ce,s:Ee,v:te}};for(let h=0;h<C.length;h+=4){const T=C[h],x=C[h+1],L=C[h+2],{h:G,s:ge,v:te}=j(T,x,L),ye=ge>.25&&te>.2&&(G<20||G>340||G>340&&G<=360),Q=ge>.25&&te>.2&&G>=80&&G<=160;ye||Q?(C[h]=Math.min(255,T*1.2),C[h+1]=Math.min(255,x*1.2),C[h+2]=Math.min(255,L*1.2)):C[h]=C[h+1]=C[h+2]=0}w.putImageData(b,0,0),d=m}catch{d=e}const i=Eo(d,t?.centerHint);if(!i)return{success:!1,cx:n,cy:r,bullInner:0,bullOuter:0,trebleInner:0,trebleOuter:0,doubleInner:0,doubleOuter:0,confidence:0,homography:null,errorPx:null,calibrationPoints:[],message:"No dartboard detected. Ensure board is clearly visible with good contrast between rings and background."};const u=(()=>{const A=i.detectedRings||[];if(A.length>=6)return{cx:i.cx,cy:i.cy,bullInner:A[0],bullOuter:A[1],trebleInner:A[2],trebleOuter:A[3],doubleInner:A[4],doubleOuter:A[5]};{const m=i.r/_.doubleOuter;return{cx:i.cx,cy:i.cy,bullInner:_.bullInner*m,bullOuter:_.bullOuter*m,trebleInner:_.trebleInner*m,trebleOuter:_.trebleOuter*m,doubleInner:_.doubleInner*m,doubleOuter:i.r}}})(),y=Mo(e,u.cx,u.cy,u.doubleOuter)||0,P=Nn("outer"),k=P.map(A=>{if(A.x===0&&A.y===0)return{x:u.cx,y:u.cy};const m=Math.cos(y),w=Math.sin(y),b=u.doubleOuter/_.doubleOuter,C=A.x*b,j=A.y*b;return{x:u.cx+(C*m-j*w),y:u.cy+(C*w+j*m)}});let E=null,S=null,I=i.confidence,O=1;try{let A=!0;try{A=!!Te.getState?.()?.calibrationUseRansac}catch{}if(A){const b=ho(P,k,{thresholdPx:8,maxIter:300});b.H?(E=b.H,S=b.errorPx,O=b.inliers.filter(Boolean).length/k.length,I=Math.max(I,Math.round(I*.6+O*40))):(E=kn(P,k),S=Nt(E,P,k))}else E=kn(P,k),S=Nt(E,P,k);if(E&&(E=Po(e,E),S=Nt(E,P,k)),E){const b=ft(E,{x:0,y:0}),C=u.cx-b.x,j=u.cy-b.y;Math.hypot(C,j)>.25&&(E=Mr(E,C,j),S=Nt(E,P,k))}const w=mo(typeof S=="number"?S:null);typeof w=="number"?I=w:I=Math.max(O*100,i.confidence)}catch{I=Math.max(65,i.confidence)}const B=k.every(No),N=ko(E),D=!!N&&B&&I>50,R=i.ringCount??0,M={success:D,cx:u.cx,cy:u.cy,bullInner:u.bullInner,bullOuter:u.bullOuter,trebleInner:u.trebleInner,trebleOuter:u.trebleOuter,doubleInner:u.doubleInner,doubleOuter:u.doubleOuter,confidence:Math.round(I),homography:N?E:null,errorPx:N?S:null,calibrationPoints:B?k:[],theta:typeof y=="number"?y:void 0,message:!B||!N?`âŒ Detection produced unstable calibration data. Adjust camera framing or calibrate manually. (rings: ${R}, r:${Math.round(i.r)})`:I>85?`âœ… Excellent detection (rings: ${R}, r:${Math.round(i.r)})`:`âœ… Board detected - may need angle adjustment (rings: ${R}, r:${Math.round(i.r)})`};return console.log("[detectBoard] Final result:",{success:M.success,confidence:M.confidence,homographyValid:N,pointsValid:B,cx:Math.round(M.cx),cy:Math.round(M.cy),doubleOuter:Math.round(M.doubleOuter),rings:R,errorPx:M.errorPx?M.errorPx.toFixed(2):null,calibrationPoints:k.map(A=>({x:Math.round(A.x),y:Math.round(A.y)}))},M.message),M}catch(s){return{success:!1,cx:e.width/2,cy:e.height/2,bullInner:0,bullOuter:0,trebleInner:0,trebleOuter:0,doubleInner:0,doubleOuter:0,confidence:0,homography:null,errorPx:null,calibrationPoints:[],message:s instanceof Error?s.message:"Board detection failed"}}}async function jo(){const e=[];try{const t=await Io();for(const s of t){const o=await To(s,[80,8080,8787,8788,3e3,5e3]);for(const n of o){const r=await Oo(n.ip,n.port);r&&e.push(r)}}}catch(t){console.error("Network discovery failed:",t)}return e}async function Io(){const e=[];try{const t=new RTCPeerConnection({iceServers:[]});t.createDataChannel("");const s=await t.createOffer();return await t.setLocalDescription(s),new Promise(o=>{const n=setTimeout(()=>{t.close(),o(e)},5e3);t.onicecandidate=r=>{if(r.candidate){const i=r.candidate.candidate.match(/(\d+\.\d+\.\d+\.\d+)/);if(i&&i[1]&&!e.includes(i[1])){const u=i[1];Ro(u)&&e.push(u)}}else clearTimeout(n),t.close(),o(e)}})}catch(t){return console.error("Failed to get local IPs:",t),["192.168.1.0"]}}function Ro(e){const t=e.split(".").map(Number);return t[0]===10||t[0]===172&&t[1]>=16&&t[1]<=31||t[0]===192&&t[1]===168}async function To(e,t){const s=[],o=e.split(".").slice(0,3).join("."),n=[];for(let d=1;d<=254;d++){const i=`${o}.${d}`;for(const u of t)n.push(Do(i,u))}return(await Promise.allSettled(n)).forEach((d,i)=>{if(d.status==="fulfilled"&&d.value){const u=i%t.length,y=Math.floor(i/t.length),P=`${o}.${y+1}`;s.push({ip:P,port:t[u]})}}),s}async function Do(e,t){try{return await fetch(`http://${e}:${t}/`,{method:"HEAD",mode:"no-cors",signal:AbortSignal.timeout(2e3)}),!0}catch{return!1}}async function Oo(e,t){try{const s=["/","/api/info","/api/status","/camera","/stream"];for(const o of s)try{const n=await fetch(`http://${e}:${t}${o}`,{method:"GET",signal:AbortSignal.timeout(3e3)});if(n.ok){const r=n.headers.get("content-type")||"",d=await n.text();if(d.includes("OMNI")||d.includes("omni")||o.includes("omni"))return{id:`omni-${e}-${t}`,name:`OMNI Camera (${e})`,ip:e,port:t,type:"omni",capabilities:["video","calibration"],status:"online",connectionType:"wifi"};if(d.includes("VERT")||d.includes("vert")||o.includes("vert"))return{id:`vert-${e}-${t}`,name:`VERT Camera (${e})`,ip:e,port:t,type:"vert",capabilities:["video","calibration"],status:"online",connectionType:"wifi"};if(r.includes("video")||d.includes("stream")||o==="/stream")return{id:`generic-${e}-${t}`,name:`Network Camera (${e})`,ip:e,port:t,type:"generic",capabilities:["video"],status:"online",connectionType:"wifi"}}}catch{}}catch(s){console.error(`Failed to probe device ${e}:${t}:`,s)}return null}async function Ao(e){try{const t=`http://${e.ip}:${e.port}/stream`,s=document.createElement("video");return s.src=t,s.crossOrigin="anonymous",new Promise((o,n)=>{s.onloadeddata=()=>{const r=document.createElement("canvas"),d=r.getContext("2d");r.width=s.videoWidth,r.height=s.videoHeight;const i=r.captureStream(30),u=()=>{s.readyState>=2&&d.drawImage(s,0,0),requestAnimationFrame(u)};u(),o(i)},s.onerror=()=>n(new Error("Failed to load video stream")),s.load()})}catch(t){return console.error("Failed to connect to network device:",t),null}}var et={},en,Yn;function Bo(){return Yn||(Yn=1,en=function(){return typeof Promise=="function"&&Promise.prototype&&Promise.prototype.then}),en}var tn={},Ve={},Qn;function Ge(){if(Qn)return Ve;Qn=1;let e;const t=[0,26,44,70,100,134,172,196,242,292,346,404,466,532,581,655,733,815,901,991,1085,1156,1258,1364,1474,1588,1706,1828,1921,2051,2185,2323,2465,2611,2761,2876,3034,3196,3362,3532,3706];return Ve.getSymbolSize=function(o){if(!o)throw new Error('"version" cannot be null or undefined');if(o<1||o>40)throw new Error('"version" should be in range from 1 to 40');return o*4+17},Ve.getSymbolTotalCodewords=function(o){return t[o]},Ve.getBCHDigit=function(s){let o=0;for(;s!==0;)o++,s>>>=1;return o},Ve.setToSJISFunction=function(o){if(typeof o!="function")throw new Error('"toSJISFunc" is not a valid function.');e=o},Ve.isKanjiModeEnabled=function(){return typeof e<"u"},Ve.toSJIS=function(o){return e(o)},Ve}var nn={},Xn;function Pn(){return Xn||(Xn=1,(function(e){e.L={bit:1},e.M={bit:0},e.Q={bit:3},e.H={bit:2};function t(s){if(typeof s!="string")throw new Error("Param is not a string");switch(s.toLowerCase()){case"l":case"low":return e.L;case"m":case"medium":return e.M;case"q":case"quartile":return e.Q;case"h":case"high":return e.H;default:throw new Error("Unknown EC Level: "+s)}}e.isValid=function(o){return o&&typeof o.bit<"u"&&o.bit>=0&&o.bit<4},e.from=function(o,n){if(e.isValid(o))return o;try{return t(o)}catch{return n}}})(nn)),nn}var rn,Zn;function Lo(){if(Zn)return rn;Zn=1;function e(){this.buffer=[],this.length=0}return e.prototype={get:function(t){const s=Math.floor(t/8);return(this.buffer[s]>>>7-t%8&1)===1},put:function(t,s){for(let o=0;o<s;o++)this.putBit((t>>>s-o-1&1)===1)},getLengthInBits:function(){return this.length},putBit:function(t){const s=Math.floor(this.length/8);this.buffer.length<=s&&this.buffer.push(0),t&&(this.buffer[s]|=128>>>this.length%8),this.length++}},rn=e,rn}var on,er;function Fo(){if(er)return on;er=1;function e(t){if(!t||t<1)throw new Error("BitMatrix size must be defined and greater than 0");this.size=t,this.data=new Uint8Array(t*t),this.reservedBit=new Uint8Array(t*t)}return e.prototype.set=function(t,s,o,n){const r=t*this.size+s;this.data[r]=o,n&&(this.reservedBit[r]=!0)},e.prototype.get=function(t,s){return this.data[t*this.size+s]},e.prototype.xor=function(t,s,o){this.data[t*this.size+s]^=o},e.prototype.isReserved=function(t,s){return this.reservedBit[t*this.size+s]},on=e,on}var an={},tr;function Uo(){return tr||(tr=1,(function(e){const t=Ge().getSymbolSize;e.getRowColCoords=function(o){if(o===1)return[];const n=Math.floor(o/7)+2,r=t(o),d=r===145?26:Math.ceil((r-13)/(2*n-2))*2,i=[r-7];for(let u=1;u<n-1;u++)i[u]=i[u-1]-d;return i.push(6),i.reverse()},e.getPositions=function(o){const n=[],r=e.getRowColCoords(o),d=r.length;for(let i=0;i<d;i++)for(let u=0;u<d;u++)i===0&&u===0||i===0&&u===d-1||i===d-1&&u===0||n.push([r[i],r[u]]);return n}})(an)),an}var sn={},nr;function _o(){if(nr)return sn;nr=1;const e=Ge().getSymbolSize,t=7;return sn.getPositions=function(o){const n=e(o);return[[0,0],[n-t,0],[0,n-t]]},sn}var cn={},rr;function $o(){return rr||(rr=1,(function(e){e.Patterns={PATTERN000:0,PATTERN001:1,PATTERN010:2,PATTERN011:3,PATTERN100:4,PATTERN101:5,PATTERN110:6,PATTERN111:7};const t={N1:3,N2:3,N3:40,N4:10};e.isValid=function(n){return n!=null&&n!==""&&!isNaN(n)&&n>=0&&n<=7},e.from=function(n){return e.isValid(n)?parseInt(n,10):void 0},e.getPenaltyN1=function(n){const r=n.size;let d=0,i=0,u=0,y=null,P=null;for(let k=0;k<r;k++){i=u=0,y=P=null;for(let E=0;E<r;E++){let S=n.get(k,E);S===y?i++:(i>=5&&(d+=t.N1+(i-5)),y=S,i=1),S=n.get(E,k),S===P?u++:(u>=5&&(d+=t.N1+(u-5)),P=S,u=1)}i>=5&&(d+=t.N1+(i-5)),u>=5&&(d+=t.N1+(u-5))}return d},e.getPenaltyN2=function(n){const r=n.size;let d=0;for(let i=0;i<r-1;i++)for(let u=0;u<r-1;u++){const y=n.get(i,u)+n.get(i,u+1)+n.get(i+1,u)+n.get(i+1,u+1);(y===4||y===0)&&d++}return d*t.N2},e.getPenaltyN3=function(n){const r=n.size;let d=0,i=0,u=0;for(let y=0;y<r;y++){i=u=0;for(let P=0;P<r;P++)i=i<<1&2047|n.get(y,P),P>=10&&(i===1488||i===93)&&d++,u=u<<1&2047|n.get(P,y),P>=10&&(u===1488||u===93)&&d++}return d*t.N3},e.getPenaltyN4=function(n){let r=0;const d=n.data.length;for(let u=0;u<d;u++)r+=n.data[u];return Math.abs(Math.ceil(r*100/d/5)-10)*t.N4};function s(o,n,r){switch(o){case e.Patterns.PATTERN000:return(n+r)%2===0;case e.Patterns.PATTERN001:return n%2===0;case e.Patterns.PATTERN010:return r%3===0;case e.Patterns.PATTERN011:return(n+r)%3===0;case e.Patterns.PATTERN100:return(Math.floor(n/2)+Math.floor(r/3))%2===0;case e.Patterns.PATTERN101:return n*r%2+n*r%3===0;case e.Patterns.PATTERN110:return(n*r%2+n*r%3)%2===0;case e.Patterns.PATTERN111:return(n*r%3+(n+r)%2)%2===0;default:throw new Error("bad maskPattern:"+o)}}e.applyMask=function(n,r){const d=r.size;for(let i=0;i<d;i++)for(let u=0;u<d;u++)r.isReserved(u,i)||r.xor(u,i,s(n,u,i))},e.getBestMask=function(n,r){const d=Object.keys(e.Patterns).length;let i=0,u=1/0;for(let y=0;y<d;y++){r(y),e.applyMask(y,n);const P=e.getPenaltyN1(n)+e.getPenaltyN2(n)+e.getPenaltyN3(n)+e.getPenaltyN4(n);e.applyMask(y,n),P<u&&(u=P,i=y)}return i}})(cn)),cn}var jt={},or;function jr(){if(or)return jt;or=1;const e=Pn(),t=[1,1,1,1,1,1,1,1,1,1,2,2,1,2,2,4,1,2,4,4,2,4,4,4,2,4,6,5,2,4,6,6,2,5,8,8,4,5,8,8,4,5,8,11,4,8,10,11,4,9,12,16,4,9,16,16,6,10,12,18,6,10,17,16,6,11,16,19,6,13,18,21,7,14,21,25,8,16,20,25,8,17,23,25,9,17,23,34,9,18,25,30,10,20,27,32,12,21,29,35,12,23,34,37,12,25,34,40,13,26,35,42,14,28,38,45,15,29,40,48,16,31,43,51,17,33,45,54,18,35,48,57,19,37,51,60,19,38,53,63,20,40,56,66,21,43,59,70,22,45,62,74,24,47,65,77,25,49,68,81],s=[7,10,13,17,10,16,22,28,15,26,36,44,20,36,52,64,26,48,72,88,36,64,96,112,40,72,108,130,48,88,132,156,60,110,160,192,72,130,192,224,80,150,224,264,96,176,260,308,104,198,288,352,120,216,320,384,132,240,360,432,144,280,408,480,168,308,448,532,180,338,504,588,196,364,546,650,224,416,600,700,224,442,644,750,252,476,690,816,270,504,750,900,300,560,810,960,312,588,870,1050,336,644,952,1110,360,700,1020,1200,390,728,1050,1260,420,784,1140,1350,450,812,1200,1440,480,868,1290,1530,510,924,1350,1620,540,980,1440,1710,570,1036,1530,1800,570,1064,1590,1890,600,1120,1680,1980,630,1204,1770,2100,660,1260,1860,2220,720,1316,1950,2310,750,1372,2040,2430];return jt.getBlocksCount=function(n,r){switch(r){case e.L:return t[(n-1)*4+0];case e.M:return t[(n-1)*4+1];case e.Q:return t[(n-1)*4+2];case e.H:return t[(n-1)*4+3];default:return}},jt.getTotalCodewordsCount=function(n,r){switch(r){case e.L:return s[(n-1)*4+0];case e.M:return s[(n-1)*4+1];case e.Q:return s[(n-1)*4+2];case e.H:return s[(n-1)*4+3];default:return}},jt}var ln={},dt={},ar;function qo(){if(ar)return dt;ar=1;const e=new Uint8Array(512),t=new Uint8Array(256);return(function(){let o=1;for(let n=0;n<255;n++)e[n]=o,t[o]=n,o<<=1,o&256&&(o^=285);for(let n=255;n<512;n++)e[n]=e[n-255]})(),dt.log=function(o){if(o<1)throw new Error("log("+o+")");return t[o]},dt.exp=function(o){return e[o]},dt.mul=function(o,n){return o===0||n===0?0:e[t[o]+t[n]]},dt}var sr;function Wo(){return sr||(sr=1,(function(e){const t=qo();e.mul=function(o,n){const r=new Uint8Array(o.length+n.length-1);for(let d=0;d<o.length;d++)for(let i=0;i<n.length;i++)r[d+i]^=t.mul(o[d],n[i]);return r},e.mod=function(o,n){let r=new Uint8Array(o);for(;r.length-n.length>=0;){const d=r[0];for(let u=0;u<n.length;u++)r[u]^=t.mul(n[u],d);let i=0;for(;i<r.length&&r[i]===0;)i++;r=r.slice(i)}return r},e.generateECPolynomial=function(o){let n=new Uint8Array([1]);for(let r=0;r<o;r++)n=e.mul(n,new Uint8Array([1,t.exp(r)]));return n}})(ln)),ln}var dn,ir;function Ho(){if(ir)return dn;ir=1;const e=Wo();function t(s){this.genPoly=void 0,this.degree=s,this.degree&&this.initialize(this.degree)}return t.prototype.initialize=function(o){this.degree=o,this.genPoly=e.generateECPolynomial(this.degree)},t.prototype.encode=function(o){if(!this.genPoly)throw new Error("Encoder not initialized");const n=new Uint8Array(o.length+this.degree);n.set(o);const r=e.mod(n,this.genPoly),d=this.degree-r.length;if(d>0){const i=new Uint8Array(this.degree);return i.set(r,d),i}return r},dn=t,dn}var un={},fn={},hn={},cr;function Ir(){return cr||(cr=1,hn.isValid=function(t){return!isNaN(t)&&t>=1&&t<=40}),hn}var Fe={},lr;function Rr(){if(lr)return Fe;lr=1;const e="[0-9]+",t="[A-Z $%*+\\-./:]+";let s="(?:[u3000-u303F]|[u3040-u309F]|[u30A0-u30FF]|[uFF00-uFFEF]|[u4E00-u9FAF]|[u2605-u2606]|[u2190-u2195]|u203B|[u2010u2015u2018u2019u2025u2026u201Cu201Du2225u2260]|[u0391-u0451]|[u00A7u00A8u00B1u00B4u00D7u00F7])+";s=s.replace(/u/g,"\\u");const o="(?:(?![A-Z0-9 $%*+\\-./:]|"+s+`)(?:.|[\r
]))+`;Fe.KANJI=new RegExp(s,"g"),Fe.BYTE_KANJI=new RegExp("[^A-Z0-9 $%*+\\-./:]+","g"),Fe.BYTE=new RegExp(o,"g"),Fe.NUMERIC=new RegExp(e,"g"),Fe.ALPHANUMERIC=new RegExp(t,"g");const n=new RegExp("^"+s+"$"),r=new RegExp("^"+e+"$"),d=new RegExp("^[A-Z0-9 $%*+\\-./:]+$");return Fe.testKanji=function(u){return n.test(u)},Fe.testNumeric=function(u){return r.test(u)},Fe.testAlphanumeric=function(u){return d.test(u)},Fe}var dr;function Je(){return dr||(dr=1,(function(e){const t=Ir(),s=Rr();e.NUMERIC={id:"Numeric",bit:1,ccBits:[10,12,14]},e.ALPHANUMERIC={id:"Alphanumeric",bit:2,ccBits:[9,11,13]},e.BYTE={id:"Byte",bit:4,ccBits:[8,16,16]},e.KANJI={id:"Kanji",bit:8,ccBits:[8,10,12]},e.MIXED={bit:-1},e.getCharCountIndicator=function(r,d){if(!r.ccBits)throw new Error("Invalid mode: "+r);if(!t.isValid(d))throw new Error("Invalid version: "+d);return d>=1&&d<10?r.ccBits[0]:d<27?r.ccBits[1]:r.ccBits[2]},e.getBestModeForData=function(r){return s.testNumeric(r)?e.NUMERIC:s.testAlphanumeric(r)?e.ALPHANUMERIC:s.testKanji(r)?e.KANJI:e.BYTE},e.toString=function(r){if(r&&r.id)return r.id;throw new Error("Invalid mode")},e.isValid=function(r){return r&&r.bit&&r.ccBits};function o(n){if(typeof n!="string")throw new Error("Param is not a string");switch(n.toLowerCase()){case"numeric":return e.NUMERIC;case"alphanumeric":return e.ALPHANUMERIC;case"kanji":return e.KANJI;case"byte":return e.BYTE;default:throw new Error("Unknown mode: "+n)}}e.from=function(r,d){if(e.isValid(r))return r;try{return o(r)}catch{return d}}})(fn)),fn}var ur;function zo(){return ur||(ur=1,(function(e){const t=Ge(),s=jr(),o=Pn(),n=Je(),r=Ir(),d=7973,i=t.getBCHDigit(d);function u(E,S,I){for(let O=1;O<=40;O++)if(S<=e.getCapacity(O,I,E))return O}function y(E,S){return n.getCharCountIndicator(E,S)+4}function P(E,S){let I=0;return E.forEach(function(O){const B=y(O.mode,S);I+=B+O.getBitsLength()}),I}function k(E,S){for(let I=1;I<=40;I++)if(P(E,I)<=e.getCapacity(I,S,n.MIXED))return I}e.from=function(S,I){return r.isValid(S)?parseInt(S,10):I},e.getCapacity=function(S,I,O){if(!r.isValid(S))throw new Error("Invalid QR Code version");typeof O>"u"&&(O=n.BYTE);const B=t.getSymbolTotalCodewords(S),N=s.getTotalCodewordsCount(S,I),D=(B-N)*8;if(O===n.MIXED)return D;const R=D-y(O,S);switch(O){case n.NUMERIC:return Math.floor(R/10*3);case n.ALPHANUMERIC:return Math.floor(R/11*2);case n.KANJI:return Math.floor(R/13);case n.BYTE:default:return Math.floor(R/8)}},e.getBestVersionForData=function(S,I){let O;const B=o.from(I,o.M);if(Array.isArray(S)){if(S.length>1)return k(S,B);if(S.length===0)return 1;O=S[0]}else O=S;return u(O.mode,O.getLength(),B)},e.getEncodedBits=function(S){if(!r.isValid(S)||S<7)throw new Error("Invalid QR Code version");let I=S<<12;for(;t.getBCHDigit(I)-i>=0;)I^=d<<t.getBCHDigit(I)-i;return S<<12|I}})(un)),un}var mn={},fr;function Vo(){if(fr)return mn;fr=1;const e=Ge(),t=1335,s=21522,o=e.getBCHDigit(t);return mn.getEncodedBits=function(r,d){const i=r.bit<<3|d;let u=i<<10;for(;e.getBCHDigit(u)-o>=0;)u^=t<<e.getBCHDigit(u)-o;return(i<<10|u)^s},mn}var gn={},bn,hr;function Go(){if(hr)return bn;hr=1;const e=Je();function t(s){this.mode=e.NUMERIC,this.data=s.toString()}return t.getBitsLength=function(o){return 10*Math.floor(o/3)+(o%3?o%3*3+1:0)},t.prototype.getLength=function(){return this.data.length},t.prototype.getBitsLength=function(){return t.getBitsLength(this.data.length)},t.prototype.write=function(o){let n,r,d;for(n=0;n+3<=this.data.length;n+=3)r=this.data.substr(n,3),d=parseInt(r,10),o.put(d,10);const i=this.data.length-n;i>0&&(r=this.data.substr(n),d=parseInt(r,10),o.put(d,i*3+1))},bn=t,bn}var pn,mr;function Jo(){if(mr)return pn;mr=1;const e=Je(),t=["0","1","2","3","4","5","6","7","8","9","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z"," ","$","%","*","+","-",".","/",":"];function s(o){this.mode=e.ALPHANUMERIC,this.data=o}return s.getBitsLength=function(n){return 11*Math.floor(n/2)+6*(n%2)},s.prototype.getLength=function(){return this.data.length},s.prototype.getBitsLength=function(){return s.getBitsLength(this.data.length)},s.prototype.write=function(n){let r;for(r=0;r+2<=this.data.length;r+=2){let d=t.indexOf(this.data[r])*45;d+=t.indexOf(this.data[r+1]),n.put(d,11)}this.data.length%2&&n.put(t.indexOf(this.data[r]),6)},pn=s,pn}var xn,gr;function Ko(){if(gr)return xn;gr=1;const e=Je();function t(s){this.mode=e.BYTE,typeof s=="string"?this.data=new TextEncoder().encode(s):this.data=new Uint8Array(s)}return t.getBitsLength=function(o){return o*8},t.prototype.getLength=function(){return this.data.length},t.prototype.getBitsLength=function(){return t.getBitsLength(this.data.length)},t.prototype.write=function(s){for(let o=0,n=this.data.length;o<n;o++)s.put(this.data[o],8)},xn=t,xn}var yn,br;function Yo(){if(br)return yn;br=1;const e=Je(),t=Ge();function s(o){this.mode=e.KANJI,this.data=o}return s.getBitsLength=function(n){return n*13},s.prototype.getLength=function(){return this.data.length},s.prototype.getBitsLength=function(){return s.getBitsLength(this.data.length)},s.prototype.write=function(o){let n;for(n=0;n<this.data.length;n++){let r=t.toSJIS(this.data[n]);if(r>=33088&&r<=40956)r-=33088;else if(r>=57408&&r<=60351)r-=49472;else throw new Error("Invalid SJIS character: "+this.data[n]+`
Make sure your charset is UTF-8`);r=(r>>>8&255)*192+(r&255),o.put(r,13)}},yn=s,yn}var wn={exports:{}},pr;function Qo(){return pr||(pr=1,(function(e){var t={single_source_shortest_paths:function(s,o,n){var r={},d={};d[o]=0;var i=t.PriorityQueue.make();i.push(o,0);for(var u,y,P,k,E,S,I,O,B;!i.empty();){u=i.pop(),y=u.value,k=u.cost,E=s[y]||{};for(P in E)E.hasOwnProperty(P)&&(S=E[P],I=k+S,O=d[P],B=typeof d[P]>"u",(B||O>I)&&(d[P]=I,i.push(P,I),r[P]=y))}if(typeof n<"u"&&typeof d[n]>"u"){var N=["Could not find a path from ",o," to ",n,"."].join("");throw new Error(N)}return r},extract_shortest_path_from_predecessor_list:function(s,o){for(var n=[],r=o;r;)n.push(r),s[r],r=s[r];return n.reverse(),n},find_path:function(s,o,n){var r=t.single_source_shortest_paths(s,o,n);return t.extract_shortest_path_from_predecessor_list(r,n)},PriorityQueue:{make:function(s){var o=t.PriorityQueue,n={},r;s=s||{};for(r in o)o.hasOwnProperty(r)&&(n[r]=o[r]);return n.queue=[],n.sorter=s.sorter||o.default_sorter,n},default_sorter:function(s,o){return s.cost-o.cost},push:function(s,o){var n={value:s,cost:o};this.queue.push(n),this.queue.sort(this.sorter)},pop:function(){return this.queue.shift()},empty:function(){return this.queue.length===0}}};e.exports=t})(wn)),wn.exports}var xr;function Xo(){return xr||(xr=1,(function(e){const t=Je(),s=Go(),o=Jo(),n=Ko(),r=Yo(),d=Rr(),i=Ge(),u=Qo();function y(N){return unescape(encodeURIComponent(N)).length}function P(N,D,R){const M=[];let A;for(;(A=N.exec(R))!==null;)M.push({data:A[0],index:A.index,mode:D,length:A[0].length});return M}function k(N){const D=P(d.NUMERIC,t.NUMERIC,N),R=P(d.ALPHANUMERIC,t.ALPHANUMERIC,N);let M,A;return i.isKanjiModeEnabled()?(M=P(d.BYTE,t.BYTE,N),A=P(d.KANJI,t.KANJI,N)):(M=P(d.BYTE_KANJI,t.BYTE,N),A=[]),D.concat(R,M,A).sort(function(w,b){return w.index-b.index}).map(function(w){return{data:w.data,mode:w.mode,length:w.length}})}function E(N,D){switch(D){case t.NUMERIC:return s.getBitsLength(N);case t.ALPHANUMERIC:return o.getBitsLength(N);case t.KANJI:return r.getBitsLength(N);case t.BYTE:return n.getBitsLength(N)}}function S(N){return N.reduce(function(D,R){const M=D.length-1>=0?D[D.length-1]:null;return M&&M.mode===R.mode?(D[D.length-1].data+=R.data,D):(D.push(R),D)},[])}function I(N){const D=[];for(let R=0;R<N.length;R++){const M=N[R];switch(M.mode){case t.NUMERIC:D.push([M,{data:M.data,mode:t.ALPHANUMERIC,length:M.length},{data:M.data,mode:t.BYTE,length:M.length}]);break;case t.ALPHANUMERIC:D.push([M,{data:M.data,mode:t.BYTE,length:M.length}]);break;case t.KANJI:D.push([M,{data:M.data,mode:t.BYTE,length:y(M.data)}]);break;case t.BYTE:D.push([{data:M.data,mode:t.BYTE,length:y(M.data)}])}}return D}function O(N,D){const R={},M={start:{}};let A=["start"];for(let m=0;m<N.length;m++){const w=N[m],b=[];for(let C=0;C<w.length;C++){const j=w[C],h=""+m+C;b.push(h),R[h]={node:j,lastCount:0},M[h]={};for(let T=0;T<A.length;T++){const x=A[T];R[x]&&R[x].node.mode===j.mode?(M[x][h]=E(R[x].lastCount+j.length,j.mode)-E(R[x].lastCount,j.mode),R[x].lastCount+=j.length):(R[x]&&(R[x].lastCount=j.length),M[x][h]=E(j.length,j.mode)+4+t.getCharCountIndicator(j.mode,D))}}A=b}for(let m=0;m<A.length;m++)M[A[m]].end=0;return{map:M,table:R}}function B(N,D){let R;const M=t.getBestModeForData(N);if(R=t.from(D,M),R!==t.BYTE&&R.bit<M.bit)throw new Error('"'+N+'" cannot be encoded with mode '+t.toString(R)+`.
 Suggested mode is: `+t.toString(M));switch(R===t.KANJI&&!i.isKanjiModeEnabled()&&(R=t.BYTE),R){case t.NUMERIC:return new s(N);case t.ALPHANUMERIC:return new o(N);case t.KANJI:return new r(N);case t.BYTE:return new n(N)}}e.fromArray=function(D){return D.reduce(function(R,M){return typeof M=="string"?R.push(B(M,null)):M.data&&R.push(B(M.data,M.mode)),R},[])},e.fromString=function(D,R){const M=k(D,i.isKanjiModeEnabled()),A=I(M),m=O(A,R),w=u.find_path(m.map,"start","end"),b=[];for(let C=1;C<w.length-1;C++)b.push(m.table[w[C]].node);return e.fromArray(S(b))},e.rawSplit=function(D){return e.fromArray(k(D,i.isKanjiModeEnabled()))}})(gn)),gn}var yr;function Zo(){if(yr)return tn;yr=1;const e=Ge(),t=Pn(),s=Lo(),o=Fo(),n=Uo(),r=_o(),d=$o(),i=jr(),u=Ho(),y=zo(),P=Vo(),k=Je(),E=Xo();function S(m,w){const b=m.size,C=r.getPositions(w);for(let j=0;j<C.length;j++){const h=C[j][0],T=C[j][1];for(let x=-1;x<=7;x++)if(!(h+x<=-1||b<=h+x))for(let L=-1;L<=7;L++)T+L<=-1||b<=T+L||(x>=0&&x<=6&&(L===0||L===6)||L>=0&&L<=6&&(x===0||x===6)||x>=2&&x<=4&&L>=2&&L<=4?m.set(h+x,T+L,!0,!0):m.set(h+x,T+L,!1,!0))}}function I(m){const w=m.size;for(let b=8;b<w-8;b++){const C=b%2===0;m.set(b,6,C,!0),m.set(6,b,C,!0)}}function O(m,w){const b=n.getPositions(w);for(let C=0;C<b.length;C++){const j=b[C][0],h=b[C][1];for(let T=-2;T<=2;T++)for(let x=-2;x<=2;x++)T===-2||T===2||x===-2||x===2||T===0&&x===0?m.set(j+T,h+x,!0,!0):m.set(j+T,h+x,!1,!0)}}function B(m,w){const b=m.size,C=y.getEncodedBits(w);let j,h,T;for(let x=0;x<18;x++)j=Math.floor(x/3),h=x%3+b-8-3,T=(C>>x&1)===1,m.set(j,h,T,!0),m.set(h,j,T,!0)}function N(m,w,b){const C=m.size,j=P.getEncodedBits(w,b);let h,T;for(h=0;h<15;h++)T=(j>>h&1)===1,h<6?m.set(h,8,T,!0):h<8?m.set(h+1,8,T,!0):m.set(C-15+h,8,T,!0),h<8?m.set(8,C-h-1,T,!0):h<9?m.set(8,15-h-1+1,T,!0):m.set(8,15-h-1,T,!0);m.set(C-8,8,1,!0)}function D(m,w){const b=m.size;let C=-1,j=b-1,h=7,T=0;for(let x=b-1;x>0;x-=2)for(x===6&&x--;;){for(let L=0;L<2;L++)if(!m.isReserved(j,x-L)){let G=!1;T<w.length&&(G=(w[T]>>>h&1)===1),m.set(j,x-L,G),h--,h===-1&&(T++,h=7)}if(j+=C,j<0||b<=j){j-=C,C=-C;break}}}function R(m,w,b){const C=new s;b.forEach(function(L){C.put(L.mode.bit,4),C.put(L.getLength(),k.getCharCountIndicator(L.mode,m)),L.write(C)});const j=e.getSymbolTotalCodewords(m),h=i.getTotalCodewordsCount(m,w),T=(j-h)*8;for(C.getLengthInBits()+4<=T&&C.put(0,4);C.getLengthInBits()%8!==0;)C.putBit(0);const x=(T-C.getLengthInBits())/8;for(let L=0;L<x;L++)C.put(L%2?17:236,8);return M(C,m,w)}function M(m,w,b){const C=e.getSymbolTotalCodewords(w),j=i.getTotalCodewordsCount(w,b),h=C-j,T=i.getBlocksCount(w,b),x=C%T,L=T-x,G=Math.floor(C/T),ge=Math.floor(h/T),te=ge+1,ye=G-ge,Q=new u(ye);let Ce=0;const Ee=new Array(T),F=new Array(T);let $=0;const J=new Uint8Array(m.buffer);for(let he=0;he<T;he++){const ie=he<L?ge:te;Ee[he]=J.slice(Ce,Ce+ie),F[he]=Q.encode(Ee[he]),Ce+=ie,$=Math.max($,ie)}const X=new Uint8Array(C);let Z=0,oe,U;for(oe=0;oe<$;oe++)for(U=0;U<T;U++)oe<Ee[U].length&&(X[Z++]=Ee[U][oe]);for(oe=0;oe<ye;oe++)for(U=0;U<T;U++)X[Z++]=F[U][oe];return X}function A(m,w,b,C){let j;if(Array.isArray(m))j=E.fromArray(m);else if(typeof m=="string"){let G=w;if(!G){const ge=E.rawSplit(m);G=y.getBestVersionForData(ge,b)}j=E.fromString(m,G||40)}else throw new Error("Invalid data");const h=y.getBestVersionForData(j,b);if(!h)throw new Error("The amount of data is too big to be stored in a QR Code");if(!w)w=h;else if(w<h)throw new Error(`
The chosen QR Code version cannot contain this amount of data.
Minimum version required to store current data is: `+h+`.
`);const T=R(w,b,j),x=e.getSymbolSize(w),L=new o(x);return S(L,w),I(L),O(L,w),N(L,b,0),w>=7&&B(L,w),D(L,T),isNaN(C)&&(C=d.getBestMask(L,N.bind(null,L,b))),d.applyMask(C,L),N(L,b,C),{modules:L,version:w,errorCorrectionLevel:b,maskPattern:C,segments:j}}return tn.create=function(w,b){if(typeof w>"u"||w==="")throw new Error("No input text");let C=t.M,j,h;return typeof b<"u"&&(C=t.from(b.errorCorrectionLevel,t.M),j=y.from(b.version),h=d.from(b.maskPattern),b.toSJISFunc&&e.setToSJISFunction(b.toSJISFunc)),A(w,j,C,h)},tn}var Cn={},vn={},wr;function Tr(){return wr||(wr=1,(function(e){function t(s){if(typeof s=="number"&&(s=s.toString()),typeof s!="string")throw new Error("Color should be defined as hex string");let o=s.slice().replace("#","").split("");if(o.length<3||o.length===5||o.length>8)throw new Error("Invalid hex color: "+s);(o.length===3||o.length===4)&&(o=Array.prototype.concat.apply([],o.map(function(r){return[r,r]}))),o.length===6&&o.push("F","F");const n=parseInt(o.join(""),16);return{r:n>>24&255,g:n>>16&255,b:n>>8&255,a:n&255,hex:"#"+o.slice(0,6).join("")}}e.getOptions=function(o){o||(o={}),o.color||(o.color={});const n=typeof o.margin>"u"||o.margin===null||o.margin<0?4:o.margin,r=o.width&&o.width>=21?o.width:void 0,d=o.scale||4;return{width:r,scale:r?4:d,margin:n,color:{dark:t(o.color.dark||"#000000ff"),light:t(o.color.light||"#ffffffff")},type:o.type,rendererOpts:o.rendererOpts||{}}},e.getScale=function(o,n){return n.width&&n.width>=o+n.margin*2?n.width/(o+n.margin*2):n.scale},e.getImageWidth=function(o,n){const r=e.getScale(o,n);return Math.floor((o+n.margin*2)*r)},e.qrToImageData=function(o,n,r){const d=n.modules.size,i=n.modules.data,u=e.getScale(d,r),y=Math.floor((d+r.margin*2)*u),P=r.margin*u,k=[r.color.light,r.color.dark];for(let E=0;E<y;E++)for(let S=0;S<y;S++){let I=(E*y+S)*4,O=r.color.light;if(E>=P&&S>=P&&E<y-P&&S<y-P){const B=Math.floor((E-P)/u),N=Math.floor((S-P)/u);O=k[i[B*d+N]?1:0]}o[I++]=O.r,o[I++]=O.g,o[I++]=O.b,o[I]=O.a}}})(vn)),vn}var Cr;function ea(){return Cr||(Cr=1,(function(e){const t=Tr();function s(n,r,d){n.clearRect(0,0,r.width,r.height),r.style||(r.style={}),r.height=d,r.width=d,r.style.height=d+"px",r.style.width=d+"px"}function o(){try{return document.createElement("canvas")}catch{throw new Error("You need to specify a canvas element")}}e.render=function(r,d,i){let u=i,y=d;typeof u>"u"&&(!d||!d.getContext)&&(u=d,d=void 0),d||(y=o()),u=t.getOptions(u);const P=t.getImageWidth(r.modules.size,u),k=y.getContext("2d"),E=k.createImageData(P,P);return t.qrToImageData(E.data,r,u),s(k,y,P),k.putImageData(E,0,0),y},e.renderToDataURL=function(r,d,i){let u=i;typeof u>"u"&&(!d||!d.getContext)&&(u=d,d=void 0),u||(u={});const y=e.render(r,d,u),P=u.type||"image/png",k=u.rendererOpts||{};return y.toDataURL(P,k.quality)}})(Cn)),Cn}var Sn={},vr;function ta(){if(vr)return Sn;vr=1;const e=Tr();function t(n,r){const d=n.a/255,i=r+'="'+n.hex+'"';return d<1?i+" "+r+'-opacity="'+d.toFixed(2).slice(1)+'"':i}function s(n,r,d){let i=n+r;return typeof d<"u"&&(i+=" "+d),i}function o(n,r,d){let i="",u=0,y=!1,P=0;for(let k=0;k<n.length;k++){const E=Math.floor(k%r),S=Math.floor(k/r);!E&&!y&&(y=!0),n[k]?(P++,k>0&&E>0&&n[k-1]||(i+=y?s("M",E+d,.5+S+d):s("m",u,0),u=0,y=!1),E+1<r&&n[k+1]||(i+=s("h",P),P=0)):u++}return i}return Sn.render=function(r,d,i){const u=e.getOptions(d),y=r.modules.size,P=r.modules.data,k=y+u.margin*2,E=u.color.light.a?"<path "+t(u.color.light,"fill")+' d="M0 0h'+k+"v"+k+'H0z"/>':"",S="<path "+t(u.color.dark,"stroke")+' d="'+o(P,y,u.margin)+'"/>',I='viewBox="0 0 '+k+" "+k+'"',B='<svg xmlns="http://www.w3.org/2000/svg" '+(u.width?'width="'+u.width+'" height="'+u.width+'" ':"")+I+' shape-rendering="crispEdges">'+E+S+`</svg>
`;return typeof i=="function"&&i(null,B),B},Sn}var Sr;function na(){if(Sr)return et;Sr=1;const e=Bo(),t=Zo(),s=ea(),o=ta();function n(r,d,i,u,y){const P=[].slice.call(arguments,1),k=P.length,E=typeof P[k-1]=="function";if(!E&&!e())throw new Error("Callback required as last argument");if(E){if(k<2)throw new Error("Too few arguments provided");k===2?(y=i,i=d,d=u=void 0):k===3&&(d.getContext&&typeof y>"u"?(y=u,u=void 0):(y=u,u=i,i=d,d=void 0))}else{if(k<1)throw new Error("Too few arguments provided");return k===1?(i=d,d=u=void 0):k===2&&!d.getContext&&(u=i,i=d,d=void 0),new Promise(function(S,I){try{const O=t.create(i,u);S(r(O,d,u))}catch(O){I(O)}})}try{const S=t.create(i,u);y(null,r(S,d,u))}catch(S){y(S)}}return et.create=t.create,et.toCanvas=n.bind(null,s.render),et.toDataURL=n.bind(null,s.renderToDataURL),et.toString=n.bind(null,function(r,d,i){return o.render(r,i)}),et}var ra=na();const oa=vo(ra);async function Nr(e){return new Promise((t,s)=>{const o=new Image;o.onload=()=>t(o),o.onerror=n=>s(n),o.src=e})}async function aa(e,t){const[s,o]=await Promise.all([Nr(e),Nr(t.logoUrl)]),n=Math.max(160,s.width||160),r=Math.max(160,s.height||160),d=document.createElement("canvas");d.width=n,d.height=r;const i=d.getContext("2d");i.fillStyle="#ffffff",i.fillRect(0,0,n,r),i.imageSmoothingEnabled=!1,i.drawImage(s,0,0,n,r);const u=n/2,y=r/2,P=Math.max(.14,Math.min(.28,t.logoScale??.2)),k=Math.round(Math.min(n,r)*P),E=Math.round(u-k/2),S=Math.round(y-k/2);if(t.mask!==!1){const I=t.shape||"rounded-rect",O=Math.max(2,Math.round(k*.08)),B=E-O,N=S-O,D=k+O*2,R=k+O*2;if(i.beginPath(),I==="circle"){const M=Math.min(D,R)/2;i.arc(B+D/2,N+R/2,M,0,Math.PI*2)}else if(I==="rect")i.rect(B,N,D,R);else{const M=Math.max(4,t.radiusPx??Math.round(k*.12)),A=Math.min(M,D/2,R/2);i.moveTo(B+A,N),i.arcTo(B+D,N,B+D,N+R,A),i.arcTo(B+D,N+R,B,N+R,A),i.arcTo(B,N+R,B,N,A),i.arcTo(B,N,B+D,N,A),i.closePath()}i.fillStyle="#ffffff",i.fill(),i.lineWidth=1,i.strokeStyle=t.maskStroke||"rgba(0,0,0,0.12)",i.stroke()}if(i.save(),t.shape==="circle"){const I=k/2;i.beginPath(),i.arc(E+I,S+I,I,0,Math.PI*2),i.clip()}return i.imageSmoothingEnabled=!0,i.drawImage(o,E,S,k,k),i.restore(),d.toDataURL("image/png")}async function sa(e,t){const{width:s=256,margin:o=2,errorCorrectionLevel:n="H",color:r={dark:"#000000",light:"#ffffff"},logo:d}=t||{},i=await oa.toDataURL(e,{width:s,margin:o,errorCorrectionLevel:n,color:r});return d?aa(i,d):i}const ia=({videoDevices:e,streaming:t,refreshVideoDevices:s,testCamera:o,onSelectPhoneCamera:n,lastDetectedLabel:r,autoCommitTestMode:d,doCommit:i,lastDetectedValue:u,cameraConnected:y})=>{const{preferredCameraId:P,preferredCameraLabel:k,setPreferredCamera:E,cameraEnabled:S,setCameraEnabled:I,preferredCameraLocked:O,setPreferredCameraLocked:B}=Te(),[N,D]=p.useState(""),[R,M]=p.useState(!1),A=p.useRef(null),m=p.useCallback(async()=>{D("");try{await s()}catch(x){console.warn("[DevicePicker] refresh failed",x),D("Unable to list cameras. Grant camera permission in your browser.")}},[s]);p.useEffect(()=>{m()},[m]),p.useEffect(()=>{if(!R)return;function x(L){A.current&&!A.current.contains(L.target)&&(console.debug("[DevicePicker] document.mousedown -> closing dropdown (outside both main+portal)",Date.now()),M(!1))}return document.addEventListener("mousedown",x),()=>document.removeEventListener("mousedown",x)},[R]);const w=e.find(x=>x.deviceId===P),b=w?`${w.label||"Camera"}`:P?"Camera (unavailable)":"Auto (browser default)",C=!!(P&&!w),j=p.useCallback((x,L="")=>{try{E(x,L,!0)}catch(G){console.warn("[DevicePicker] setPreferredCamera failed",G)}M(!1)},[E]),h=p.useCallback(()=>{j(void 0,"Phone Camera"),n()},[j,n]),T=p.useCallback(()=>{B(!O)},[O,B]);return a.jsxs("div",{ref:A,className:"mt-3 rounded-lg border border-indigo-500/30 bg-indigo-500/5 p-3","data-testid":"device-picker-root",children:[a.jsx("div",{className:"mb-2 font-semibold",children:"Select camera device"}),N&&a.jsx("div",{className:"mb-2 text-sm text-rose-400",children:N}),e.length===0&&!N&&a.jsx("div",{className:"mb-2 text-xs text-slate-400",children:'Detecting devices... (click "Rescan" if this hangs)'}),C&&a.jsxs("div",{className:"mb-2 text-sm text-amber-400",children:["Selected camera is no longer available.",a.jsx("button",{className:"ml-1 underline",onClick:()=>j(void 0,""),disabled:t,children:"Use auto-selection"})]}),a.jsxs("div",{className:"mb-2 flex items-center gap-2",children:[O?a.jsx("div",{className:"text-xs text-emerald-400",children:"ðŸ”’ Camera selection locked"}):a.jsx("div",{className:"text-xs text-slate-400",children:"Camera selection unlocked"}),a.jsx("button",{"data-testid":"cam-lock-toggle",className:"btn btn--ghost ml-2 px-2 py-0.5 text-xs",onClick:T,children:O?"Unlock":"Lock"})]}),a.jsxs("div",{className:"mb-3 flex items-center gap-3",children:[a.jsx("input",{type:"checkbox",id:"cameraEnabled-calibrator",checked:S,onChange:x=>I(x.target.checked),className:"h-4 w-4",disabled:t}),a.jsx("label",{htmlFor:"cameraEnabled-calibrator",className:"text-sm",children:"Enable camera for scoring"})]}),a.jsxs("div",{className:"grid grid-cols-3 items-center gap-2 text-sm",children:[a.jsxs("div",{className:"relative col-span-2",children:[a.jsxs("button",{className:"input flex w-full items-center justify-between text-left","data-testid":"device-picker-toggle",onClick:()=>M(!0),onPointerDown:x=>x.stopPropagation(),onMouseDown:x=>x.stopPropagation(),children:[a.jsx("span",{children:b}),a.jsx("span",{className:`transition-transform ${R?"rotate-180":""}`,children:"â–¼"})]}),R&&a.jsx("div",{className:"absolute left-0 right-0 top-full z-50 mt-1 rounded border border-slate-600 bg-slate-800 shadow-lg",children:a.jsxs("div",{className:"max-h-48 overflow-y-auto",children:[a.jsx("button",{"data-testid":"device-option-auto",className:"w-full px-3 py-2 text-left text-sm hover:bg-slate-700",onClick:()=>j(void 0,""),onPointerDown:x=>x.stopPropagation(),onMouseDown:x=>x.stopPropagation(),children:"Auto (browser default)"}),e.map(x=>a.jsx("button",{className:"w-full px-3 py-2 text-left text-sm hover:bg-slate-700",onClick:()=>j(x.deviceId,x.label||""),onPointerDown:L=>L.stopPropagation(),onMouseDown:L=>L.stopPropagation(),children:x.label||"Camera"},x.deviceId)),!Mn()&&a.jsx("button",{className:"w-full px-3 py-2 text-left text-sm hover:bg-slate-700",onClick:h,onPointerDown:x=>x.stopPropagation(),onMouseDown:x=>x.stopPropagation(),children:"ðŸ“± Remote Device / Pair"})]})})]}),e.length===0&&a.jsxs("div",{className:"col-span-1 flex items-center justify-end gap-2",children:[a.jsx("button",{className:"btn btn--ghost btn-sm",onClick:async()=>{try{await o(),await s()}catch(x){console.warn("[DevicePicker] request camera permission failed",x),D("Camera permission denied. Please allow access in your browser.")}},children:"Enable local camera"}),a.jsx("button",{className:"btn btn--ghost btn-sm",onClick:()=>void m(),children:"Rescan"})]}),a.jsxs("div",{className:"col-span-3 text-right",children:[a.jsx("button",{className:"btn px-2 py-1",onClick:()=>{o(P||void 0)},disabled:t,children:"Test"}),a.jsxs("div",{className:"mt-2 flex items-center justify-end gap-2 text-xs opacity-70",children:[a.jsx("span",{"data-testid":"device-picker-detected",children:r?`Detected: ${r}`:"No recent detection"}),(r!=null||d)&&a.jsx("button",{className:"btn btn--ghost btn-sm",onClick:()=>i(),onPointerDown:()=>i(),disabled:u==null,children:"Commit detected"}),a.jsx("span",{className:`inline-block h-2.5 w-2.5 rounded-full ${y?"bg-emerald-400":"bg-rose-500"}`}),a.jsx("span",{className:"text-xs",children:y?"Camera Connected":"Camera not connected"})]})]})]}),k&&a.jsxs("div",{className:"mt-1 text-xs opacity-70",children:["Selected: ",k]}),a.jsx("div",{className:"mt-1 text-xs opacity-70",children:"Tip: Select a camera here for manual scoring."})]})},Rt=["D20","D6","D3","D11","BULL"],kr=Rt.length,ca=[{idx:0,label:"D20 (top double)",sector:20,ring:"DOUBLE",toleranceMm:4.5},{idx:1,label:"D6 (right double)",sector:6,ring:"DOUBLE",toleranceMm:4.5},{idx:2,label:"D3 (bottom double)",sector:3,ring:"DOUBLE",toleranceMm:4.5},{idx:3,label:"D11 (left double)",sector:11,ring:"DOUBLE",toleranceMm:4.5},{idx:4,label:"Bull center",sector:25,ring:"INNER_BULL",toleranceMm:3.5}];function Er(e,t,s){return po(e,[1,0,t,0,1,s,0,0,1])}function la(){const e=p.useRef(null),t=p.useRef(null),s=p.useRef(null);p.useRef(null);const[o,n]=p.useState("unknown"),[r,d]=p.useState([]),[i,u]=p.useState(null),[y,P]=p.useState(!1),[k,E]=p.useState(!1),[S,I]=p.useState(()=>localStorage.getItem("ndn:cal:mode")||"local"),[O,B]=p.useState([]),[N,D]=p.useState(!1),[R,M]=p.useState("idle"),A=p.useCallback(()=>{I("phone"),M("camera"),P(!1),D(!1);try{Te.getState().setPreferredCamera(void 0,"Phone Camera",!0)}catch(c){console.warn("[Camera Connection] Failed to persist phone camera selection",c)}},[I,M,P,D]),[m,w]=p.useState(null),b=Te(c=>c.cameraScale)||1,C=Te(c=>c.setCameraScale),[j,h]=p.useState(()=>{if(typeof window>"u")return!1;try{return window.localStorage.getItem("ndn:cal:forceDesktop")==="1"}catch{return!1}}),[T,x]=p.useState(()=>typeof navigator>"u"?!1:/Android|iPhone|iPad|iPod|Mobi/i.test(navigator.userAgent)),{H:L,setCalibration:G,reset:ge,errorPx:te,locked:ye,overlaySize:Q,imageSize:Ce,anchors:Ee,theta:F,sectorOffset:$}=Zt(),J=6,X=Pr(),{calibrationGuide:Z,setCalibrationGuide:oe,preferredCameraId:U,cameraEnabled:he,setCameraEnabled:ie,preferredCameraLocked:ce,setPreferredCameraLocked:De,setPreferredCamera:Re,preserveCalibrationOverlay:Ue,allowAutocommitInOnline:We,setAllowAutocommitInOnline:ht}=Te(),mt=!0,[q,tt]=p.useState(null),[Oe,gt]=p.useState(!1),[bt,Ke]=p.useState(0),[pt,Ye]=p.useState(!1),[ua,nt]=p.useState(null),[Dr,fa]=p.useState(!0),[ha,Tt]=p.useState(null),[jn,Or]=p.useState(!1),[Dt,Ar]=p.useState(!1),[Br,Lr]=p.useState(!1),[In,ma]=p.useState(null),[Rn,ga]=p.useState(null),[rt,ba]=p.useState(null),[Tn,Fr]=p.useState(!1),Ur=p.useRef(null);p.useCallback(c=>{const f=($??0)+c;G({sectorOffset:f})},[$,G]);const Ot=p.useRef(!1),Dn=p.useRef(null),On=p.useRef(0),An=300,[xt,_r]=p.useState([]),[At,pa]=p.useState({type:null,until:0}),[Ae,Bn]=p.useState(1),[Qe,$r]=p.useState(0),[Xe,qr]=p.useState(0),[Ln,Wr]=p.useState(!1),[Bt,ot]=p.useState(!1),[Lt,Ft]=p.useState(1),[Ut,_t]=p.useState(1),[He,$t]=p.useState(null);function Hr(){Ft(1.02),_t(1),Bn(1),$r(0),qr(0),ot(!1),$t(null)}p.useCallback((c,f=480)=>{if(typeof document>"u")throw new Error("Marker rendering only available in browser context");const v=So(c),g=document.createElement("canvas");g.width=f,g.height=f;const l=g.getContext("2d");if(!l)return"";l.fillStyle="#ffffff",l.fillRect(0,0,f,f);const z=v.length,K=v[0]?.length||z,re=f/K,me=f/z;for(let ae=0;ae<z;ae++)for(let Y=0;Y<K;Y++)v[ae][Y]&&(l.fillStyle="#000000",l.fillRect(Math.round(Y*re),Math.round(ae*me),Math.ceil(re),Math.ceil(me)));return g.toDataURL("image/png")},[]);const[Fn,qt]=p.useState(null),[Me,zr]=p.useState(null),yt=p.useRef(null),[Pe,Vr]=p.useState(null),_e=p.useRef(null),wt=p.useRef([]),[at,Wt]=p.useState(null),[Un,Gr]=p.useState(Date.now()),[_n,Ht]=p.useState(!1);function Ct(c){try{zr(c),yt.current=c}catch{}}const[$n,Jr]=p.useState(null),[Ze,Kr]=p.useState(null),[Yr,Qr]=p.useState(!0),[qn,vt]=p.useState([]),[Xr,Wn]=p.useState(!1),[zt,Vt]=p.useState(null),st=p.useRef(null);p.useEffect(()=>()=>{Ur.current=null},[mt,jn,y,q]),p.useEffect(()=>{const c=window.location.hostname;(c==="localhost"||c==="127.0.0.1")&&kt("/api/hosts").then(f=>f.json()).then(f=>{const v=Array.isArray(f?.hosts)&&f.hosts.find(g=>g);v&&Jr(v)}).catch(()=>{}),kt("/api/https-info").then(f=>f.json()).then(f=>{f&&typeof f.https=="boolean"&&Kr({https:!!f.https,port:Number(f.port)||8788})}).catch(()=>{})},[]);const $e=p.useMemo(()=>{const c=Me||"____",f="ws://localhost:8787";if(f.length>0)try{const K=new URL(f);return`${`${K.protocol==="wss:"?"https":"http"}://${K.host}${K.pathname.endsWith("/ws")?"":K.pathname}`.replace(/\/?ws$/i,"")}/mobile-cam.html?code=${c}`}catch{}const v=$n||window.location.hostname,g=!!Ze?.https,l=g?Ze?.port||8788:8787;return`${g?"https":"http"}://${v}:${l}/mobile-cam.html?code=${c}`},[Me,$n,Ze]),Zr=p.useMemo(()=>{if(!$e)return null;try{const c=new URL($e);return c.searchParams.delete("code"),c.toString().replace(/\?$/,"")}catch{return typeof window<"u"?`${window.location.origin.replace(/\/$/,"")}/mobile-cam.html`:"/mobile-cam.html"}},[$e]);p.useEffect(()=>{if(!$e||!Me){qt(null);return}let c=!1;return sa($e,{width:256,margin:2,errorCorrectionLevel:"H",color:{dark:"#000000",light:"#ffffff"},logo:!1}).then(f=>{c||qt(f)}).catch(()=>{c||qt(null)}),()=>{c=!0}},[$e,Me]),p.useEffect(()=>{localStorage.setItem("ndn:cal:mode",S)},[S]),p.useEffect(()=>{if(!(typeof window>"u"))try{j?window.localStorage.setItem("ndn:cal:forceDesktop","1"):window.localStorage.removeItem("ndn:cal:forceDesktop")}catch{}},[j]),p.useEffect(()=>{if(typeof window>"u")return;const c=window.matchMedia("(pointer: coarse)"),f=()=>{const v=typeof navigator<"u"&&/Android|iPhone|iPad|iPod|Mobi/i.test(navigator.userAgent),g=typeof c.matches=="boolean"?c.matches:!1,l=window.innerWidth<=820;x(v||g||l)};f();try{typeof c.addEventListener=="function"?c.addEventListener("change",f):typeof c.addListener=="function"&&c.addListener(f)}catch{}return window.addEventListener("resize",f),()=>{try{typeof c.removeEventListener=="function"?c.removeEventListener("change",f):typeof c.removeListener=="function"&&c.removeListener(f)}catch{}window.removeEventListener("resize",f)}},[]),p.useEffect(()=>{if(typeof navigator>"u"||!navigator.permissions){n("unsupported");return}let c=!0;return(async()=>{try{const f=await navigator.permissions.query({name:"camera"});if(!c)return;n(f.state||"unknown"),f.onchange=()=>{c&&n(f.state)}}catch{c&&n("unknown")}})(),()=>{c=!1}},[]);async function it(){if(!(typeof navigator>"u"||!navigator.mediaDevices||!navigator.mediaDevices.enumerateDevices))try{const f=(await navigator.mediaDevices.enumerateDevices()).filter(v=>v.kind==="videoinput").map(v=>({deviceId:v.deviceId,label:v.label||"Camera"}));d(f),f.length&&!i&&u(f[0].deviceId)}catch{}}p.useEffect(()=>((async()=>{try{await it()}catch{}try{navigator?.mediaDevices?.addEventListener?navigator.mediaDevices.addEventListener("devicechange",it):navigator.mediaDevices.ondevicechange=it}catch{}})(),()=>{try{navigator?.mediaDevices?.removeEventListener&&navigator.mediaDevices.removeEventListener("devicechange",it)}catch{}}),[]);async function eo(c){if(typeof navigator>"u"||!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia){alert("getUserMedia is not available in this browser");return}const f={video:c?{deviceId:{exact:c}}:{facingMode:"environment"}};let v=null;try{v=await navigator.mediaDevices.getUserMedia(f),v.getTracks().forEach(g=>g.stop()),n("granted");try{c&&typeof Re=="function"&&Re(c)}catch{}alert("Camera access granted â€” your webcam is available and set as preferred.")}catch(g){console.error("[Camera Connection] testCamera failed",g),g&&(g.name==="NotAllowedError"||g.name==="PermissionDeniedError")?(n("denied"),alert("Camera permission denied. Please allow camera access in your browser settings and try again.")):g&&(g.name==="NotFoundError"||g.name==="DevicesNotFoundError")?alert("No camera devices found. Ensure your USB webcam is connected and not in use by another app."):alert("Unable to access the camera: "+(g?.message||g))}finally{v&&v.getTracks().forEach(g=>g.stop())}}p.useEffect(()=>{if(!at)return;const c=setInterval(()=>Gr(Date.now()),1e3);return()=>clearInterval(c)},[at]);const Hn=p.useMemo(()=>at?Math.max(0,Math.ceil((at-Un)/1e3)):null,[at,Un]);p.useEffect(()=>()=>{st.current&&window.clearTimeout(st.current)},[]);const Gt=p.useCallback(async(c,f)=>{if(c)try{if(navigator.clipboard&&navigator.clipboard.writeText)await navigator.clipboard.writeText(c);else{const v=document.createElement("textarea");v.value=c,v.style.position="fixed",v.style.opacity="0",document.body.appendChild(v),v.focus(),v.select(),document.execCommand("copy");try{document.body.removeChild(v)}catch{}}Vt(f),st.current&&window.clearTimeout(st.current),st.current=window.setTimeout(()=>Vt(null),1500)}catch(v){console.warn("[Camera Connection] Copy failed:",v),Vt(null)}},[]);p.useEffect(()=>()=>{},[]),p.useEffect(()=>{const c=f=>{console.log("[Camera Connection] Received reconnect request from PhoneCameraOverlay"),S==="phone"&&_n&&(Be(!1),setTimeout(()=>{Jt()},500))};return window.addEventListener("ndn:phone-camera-reconnect",c),()=>{window.removeEventListener("ndn:phone-camera-reconnect",c)}},[S,_n]),p.useEffect(()=>{console.log("[Camera Connection] ðŸ”„ STREAMING CHANGED:",{streaming:y,videoRefAvailable:!!e.current}),e.current?(console.log("[Camera Connection] âœ… Syncing videoElementRef on streaming change"),X.setVideoElementRef(e.current),e.current.srcObject instanceof MediaStream&&(console.log("[Camera Connection] âœ… Setting mediaStream from video element"),X.setMediaStream(e.current.srcObject))):console.warn("[Camera Connection] âš ï¸ videoRef.current is null on streaming change!")},[y]),p.useEffect(()=>(console.log("[Camera Connection] ðŸš€ MOUNT: Initial mount - syncing videoRef"),console.log("[Camera Connection] videoRef.current available:",!!e.current),console.log("[Camera Connection] videoRef.current type:",e.current?.constructor?.name),e.current?(console.log("[Camera Connection] âœ… Setting videoElementRef on mount"),console.log("[Camera Connection] Video element:",{tagName:e.current.tagName,srcObject:!!e.current.srcObject,videoWidth:e.current.videoWidth,videoHeight:e.current.videoHeight}),X.setVideoElementRef(e.current),console.log("[Camera Connection] âœ… videoElementRef set successfully")):console.error("[Camera Connection] âŒ CRITICAL: videoRef.current is NULL at mount!"),()=>{}),[]);function to(){if(Pe&&(Pe.readyState===WebSocket.OPEN||Pe.readyState===WebSocket.CONNECTING))return console.log("[Camera Connection] ensureWS: Reusing existing WebSocket (state:",Pe.readyState,")"),Pe;const c="ws://localhost:8787",f=c.length>0?c.endsWith("/ws")?c:c.replace(/\/$/,"")+"/ws":void 0,g=`${window.location.protocol==="https:"?"wss":"ws"}://${window.location.host}/ws`,l=window.location.hostname,K=f||(l.endsWith("onrender.com")?g:"wss://ninedartnation.onrender.com/ws");console.log("[Camera Connection] ensureWS: Creating new WebSocket to:",K);const re=new WebSocket(K);return re.onerror=me=>{console.error("[Camera Connection] WebSocket connection error:",me),alert("Failed to connect to camera pairing service. Please check your internet connection and try again.")},re.onclose=me=>{if(console.log("[Camera Connection] WebSocket closed:",me.code,me.reason),_e.current){try{_e.current.close()}catch{}_e.current=null}Ct(null),Wt(null),Ht(!1),me.code!==1e3&&(alert("Camera pairing connection lost. Please try pairing again."),S==="phone"&&I("local"))},Vr(re),re}async function Jt(){I("phone"),Be(!1),zn();try{ie(!0)}catch{}const c=to();c.readyState===WebSocket.OPEN?(console.log("[Camera Connection] WebSocket open, sending cam-create"),c.send(JSON.stringify({type:"cam-create"}))):(console.log("[Camera Connection] WebSocket connecting, will send cam-create on open"),c.addEventListener("open",()=>{console.log("[Camera Connection] WebSocket now open, sending cam-create"),c.send(JSON.stringify({type:"cam-create"}))},{once:!0})),c.onmessage=async f=>{const v=JSON.parse(f.data);if(v.type==="cam-code")Ct(v.code),v.expiresAt&&Wt(v.expiresAt);else if(v.type==="cam-peer-joined"){!yt.current&&v.code&&Ct(v.code),Ht(!0);const g=yt.current||v.code||null;g&&(yt.current=g);try{if(ye&&g){const z=t.current?{w:t.current.width,h:t.current.height}:null,K={H:L,imageSize:z,errorPx:te??null,createdAt:Date.now()};c.send(JSON.stringify({type:"cam-calibration",code:g,payload:K})),console.log("[Camera Connection] Sent calibration to joined phone for code",g)}}catch(z){console.warn("[Camera Connection] Failed to send calibration on peer join",z)}const l=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}],iceCandidatePoolSize:10});_e.current=l,l.onconnectionstatechange=()=>{console.log("WebRTC connection state:",l.connectionState),l.connectionState==="failed"||l.connectionState==="disconnected"?(console.error("WebRTC connection failed"),alert("Camera connection lost. Please try pairing again."),Be(!1)):l.connectionState==="connected"&&console.log("WebRTC connection established")},l.onicecandidate=z=>{z.candidate&&g&&c.send(JSON.stringify({type:"cam-ice",code:g,payload:z.candidate}))},l.ontrack=z=>{if(console.log("[Camera Connection] WebRTC ontrack received:",z.streams?.length,"streams, track kind:",z.track?.kind),e.current){const K=z.streams?.[0];K?(console.log("[Camera Connection] Assigning video stream (tracks:",K.getTracks().length,") to video element"),D(!1),setTimeout(()=>{e.current&&(console.log("[Camera Connection] Setting srcObject and attempting play"),e.current.srcObject&&e.current.srcObject.getTracks().forEach(me=>me.stop()),e.current.srcObject=K,e.current.muted=!0,e.current.playsInline=!0,e.current.play().then(()=>{console.log("[Camera Connection] Video playback started successfully"),P(!0),M("capture"),X.setStreaming(!0),X.setMode("phone"),X.setMediaStream(K);try{Re(void 0,"Phone Camera",!0)}catch{}if(!ce)try{De(!0)}catch{}try{ie(!0)}catch{}E(!1)}).catch(re=>{console.error("[Camera Connection] Video play failed:",re),E(!0),console.warn("[Camera Connection] video play blocked â€” prompting user interaction")}))},100)):console.error("[Camera Connection] No inbound stream received in ontrack")}else console.error("[Camera Connection] Video element not available")};try{l.addTransceiver("video",{direction:"recvonly"});const z=await l.createOffer({offerToReceiveAudio:!1,offerToReceiveVideo:!0});await l.setLocalDescription(z),console.log("[Camera Connection] Sending cam-offer for code:",g),g?c.send(JSON.stringify({type:"cam-offer",code:g,payload:z})):console.warn("[Camera Connection] Missing pairing code when sending offer")}catch(z){console.error("Failed to create WebRTC offer:",z),alert("Failed to establish camera connection. Please try again."),Be(!1)}}else if(v.type==="cam-answer"){console.log("[Camera Connection] Received cam-answer");const g=_e.current;if(g)try{await g.setRemoteDescription(new RTCSessionDescription(v.payload)),console.log("[Camera Connection] Remote description set (answer)");const l=wt.current;console.log(`[Camera Connection] Processing ${l.length} pending ICE candidates`);for(const z of l)try{await g.addIceCandidate(z),console.log("[Camera Connection] Queued ICE candidate added")}catch(K){console.error("Failed to add queued ICE candidate:",K)}wt.current=[]}catch(l){console.error("Failed to set remote description:",l),alert("Camera pairing failed. Please try again."),Be(!1)}else console.warn("[Camera Connection] Received cam-answer but no peer connection exists")}else if(v.type==="cam-ice"){console.log("[Camera Connection] Received cam-ice");const g=_e.current;if(g)if(g.remoteDescription)try{await g.addIceCandidate(v.payload),console.log("[Camera Connection] ICE candidate added")}catch(l){console.error("Failed to add ICE candidate:",l)}else console.log("[Camera Connection] Remote description not set yet, queuing ICE candidate"),wt.current.push(v.payload);else console.warn("[Camera Connection] Received ICE candidate but no peer connection exists")}else if(v.type==="cam-error")console.error("Camera pairing error:",v.code),alert(v.code==="EXPIRED"?"Code expired. Generate a new code.":`Camera error: ${v.code||"Unknown error"}`),Be(!1);else if(v.type==="cam-calibration"){console.log("[Camera Connection] Received calibration from peer:",v.payload);try{if(v.payload){let g=Array.isArray(v.payload.H)?v.payload.H:null;if(!g&&Array.isArray(v.payload.calibrationPoints)&&v.payload.calibrationPoints.length>=4)try{const l=[{x:0,y:-_.doubleOuter},{x:_.doubleOuter,y:0},{x:0,y:_.doubleOuter},{x:-_.doubleOuter,y:0}];g=kn(l,v.payload.calibrationPoints.slice(0,4))}catch(l){console.warn("[Camera Connection] Failed to compute homography from received connection points",l)}if(g){const l=s?.current?{w:s.current.width,h:s.current.height}:e?.current?{w:e.current.clientWidth,h:e.current.clientHeight}:v.payload.imageSize??null;G({H:g,createdAt:v.payload.createdAt||Date.now(),errorPx:v.payload.errorPx,imageSize:v.payload.imageSize,overlaySize:l,locked:!0}),console.log("[Camera Connection] Applied received calibration")}}}catch(g){console.error("[Camera Connection] Failed to apply received calibration",g)}}}}async function St(){Wn(!0);try{const c=await jo();vt(c),c.length===0&&alert("No wifi scoring devices found on your network. Make sure devices are powered on and connected to the same network.")}catch(c){console.error("Wifi device discovery failed:",c),alert("Failed to discover wifi devices. Please check your network connection.")}finally{Wn(!1)}M("camera")}async function no(c){try{vt(v=>v.map(g=>g.id===c.id?{...g,status:"connecting"}:g));const f=await Ao(c);if(f&&e.current)e.current.srcObject&&e.current.srcObject.getTracks().forEach(g=>g.stop()),e.current.srcObject=f,await e.current.play(),P(!0),M("capture"),vt(v=>v.map(g=>g.id===c.id?{...g,status:"online"}:g));else throw new Error("Failed to get video stream")}catch(f){console.error("Failed to connect to wifi device:",f),alert(`Failed to connect to ${c.name}. Please check the device and try again.`),vt(v=>v.map(g=>g.id===c.id?{...g,status:"offline"}:g))}}async function ro(){if(S==="phone")return Jt();if(S==="wifi")return St();console.log("[Camera Connection] ðŸŽ¬ START_CAMERA: mode=",S,"preferredCameraId=",U);try{let c=null;if(U)try{console.log("[Camera Connection] ðŸ“¹ Attempt 1: Using preferred camera ID:",U),c=await navigator.mediaDevices.getUserMedia({video:{deviceId:{exact:U}},audio:!1}),console.log("[Camera Connection] âœ… SUCCESS with preferred camera:",c.getTracks().length,"tracks")}catch(f){console.warn("[Camera Connection] âš ï¸ Preferred camera failed:",f?.name,f?.message)}if(!c)try{console.log("[Camera Connection] ðŸ“¹ Attempt 2: Using ANY available camera"),c=await navigator.mediaDevices.getUserMedia({video:!0,audio:!1}),console.log("[Camera Connection] âœ… SUCCESS with fallback camera:",c.getTracks().length,"tracks")}catch(f){throw console.error("[Camera Connection] âŒ BOTH attempts failed:",f?.name,f?.message),f}if(!c)throw new Error("No stream obtained");if(!e.current)throw new Error("Video element ref is null");console.log("[Camera Connection] ðŸ“º Assigning stream to video element"),e.current.srcObject=c,console.log("[Camera Connection] â–¶ï¸ Calling play()");try{await e.current.play(),console.log("[Camera Connection] âœ… Play succeeded")}catch(f){console.warn("[Camera Connection] âš ï¸ Play failed, retrying in 100ms:",f?.message),await new Promise(v=>setTimeout(v,100)),await e.current.play(),console.log("[Camera Connection] âœ… Play succeeded on retry")}console.log("[Camera Connection] ðŸŸ¢ Setting streaming = true"),P(!0),M("capture"),console.log("[Camera Connection] ðŸŸ¢ State updated")}catch(c){console.error("[Camera Connection] ðŸ”´ FATAL:",c?.message||c),alert(`Camera failed: ${c?.message||"Unknown error"}`),e.current?.srcObject&&(e.current.srcObject.getTracks().forEach(f=>f.stop()),e.current.srcObject=null)}}function Be(c=!1){if(e.current&&e.current.srcObject&&(e.current.srcObject.getTracks().forEach(v=>v.stop()),e.current.srcObject=null,P(!1)),_e.current){try{_e.current.close()}catch{}_e.current=null}wt.current=[],Ct(null),Wt(null),Ht(!1),Tt(null),X.setStreaming(!1),X.setMediaStream(null),c&&(S==="phone"||S==="wifi")&&I("local")}function oo(){Pe&&Pe.readyState===WebSocket.OPEN?Pe.send(JSON.stringify({type:"cam-create"})):Jt(),zn()}function zn(){try{ce||De(!0)}catch{}}function ao(){if(!e.current||!t.current)return;const c=e.current,f=t.current;if(f.width=c.videoWidth,f.height=c.videoHeight,f.getContext("2d").drawImage(c,0,0,f.width,f.height),D(!0),w({w:f.width,h:f.height}),M("select"),console.log("[Camera Connection] captureFrame: resetting dstPoints to []"),B([]),tt(null),ot(!1),Tt(null),s.current){const g=s.current;g.width=f.width,g.height=f.height;const l=g.getContext("2d");l&&l.clearRect(0,0,g.width,g.height)}Oe&&setTimeout(()=>{io()},0)}function Kt(c=O,f=null){if(!t.current||!s.current)return;const v=t.current,g=s.current;g.width=v.width,g.height=v.height;const l=g.getContext("2d");l.clearRect(0,0,g.width,g.height),s.current&&(s.current.onclick=W=>fo(W));const z=f||(c.length>=kr?L:null),K=Ae,re=Qe,me=Xe;let ae=z;ae&&K!==1&&(ae=En(ae,K,1)),ae&&(re!==0||me!==0)&&(ae=Er(ae,re,me));const Y=q?q.cx+Qe:0,be=q?q.cy+Xe:0,ze=1,we={};q&&(we[_.bullInner]=q.bullInner*ze,we[_.bullOuter]=q.bullOuter*ze,we[_.trebleInner]=q.trebleInner*ze,we[_.trebleOuter]=q.trebleOuter*ze,we[_.doubleInner]=q.doubleInner*ze,we[_.doubleOuter]=q.doubleOuter*ze);const ct={};ct[_.doubleOuter]=Lt,ct[_.trebleOuter]=Ut;function uo(){if(!q)return 0;let W=0;try{const H="rgba(52,211,153,0.08)",je="rgba(253,224,71,0.06)",ue="rgba(34,211,238,0.06)",ee=(pe,V,se,fe)=>{const de=we[pe],ne=we[V];if(!de||!ne)return!1;l.save(),l.shadowColor="rgba(0,0,0,0.45)",l.shadowBlur=6,l.beginPath();const ve=ne*(ct[V]||1),Se=de*(ct[pe]||1);return l.arc(Y,be,ve,0,Math.PI*2),l.arc(Y,be,Se,0,Math.PI*2,!0),l.closePath(),l.fillStyle=se,l.fill(),l.restore(),!0};ee(_.bullInner,_.bullOuter,H),W++,ee(_.trebleInner,_.trebleOuter,je),W++,ee(_.doubleInner,_.doubleOuter,ue),W++;const le=360,Ne=[{r:_.bullInner,color:"#00ff66"},{r:_.bullOuter,color:"#ffffff"},{r:_.trebleInner,color:"#fde047"},{r:_.trebleOuter,color:"#fde047"},{r:_.doubleInner,color:"#22d3ee"},{r:_.doubleOuter,color:"#22d3ee"}];for(const pe of Ne){const V=we[pe.r];if(!V)continue;const se=[];for(let fe=0;fe<le;fe++){const de=fe/le*Math.PI*2,ne=V*Ae*(ct[pe.r]||1);se.push({x:Y+ne*Math.cos(de),y:be+ne*Math.sin(de)})}Mt(l,se,"rgba(0,0,0,0.45)",3),Mt(l,se,pe.color,1.5)}}catch{return 0}return 3}function fo(W){if(!He||!s.current||!q)return;const H=s.current.getBoundingClientRect(),je=(W.clientX-H.left)*(s.current.width/H.width),ue=(W.clientY-H.top)*(s.current.height/H.height),ee=je-Y,le=ue-be,Ne=Math.hypot(ee,le);let pe;He==="double"?pe=_.doubleOuter:He==="treble"?pe=_.trebleOuter:pe=_.bullOuter;const V=we[pe];if(!V||V<=0)return;const se=Ne/(V*Ae);He==="double"&&Ft(se),He==="treble"&&_t(se),He==="bull"&&Bn(fe=>fe*(se/fe)),$t(null),console.log("[Camera Connection] Aligned ",He," adjust=",se.toFixed(4))}const Le=ae;if(f&&console.log("[drawOverlay] Using passed homography:",{HH:f.slice(0,6),currentPointsCount:c.length,canvasSize:{w:g.width,h:g.height}}),Bt&&q){const W=uo();console.log("[drawOverlay] Forced detected-only drawing, rings drawn:",W);try{const H=s.current?.getContext("2d");if(!!H&&s.current&&q){H.save(),H.font="12px Sans-Serif",H.fillStyle="#ffffff",H.strokeStyle="#000000",H.lineWidth=3;const ue=Jn,ee=Y,le=be,Ne=(q.doubleInner+q.doubleOuter)/2+14,pe=typeof F=="number"?F:0;for(let V=0;V<ue.length;V++){const se=V/ue.length*Math.PI*2-Math.PI/2-pe,fe=ee+Ne*Math.cos(se),de=le+Ne*Math.sin(se),ne=String(ue[V]),ve=H.measureText(ne).width;H.strokeText(ne,fe-ve/2,de+4),H.fillText(ne,fe-ve/2,de+4)}H.restore()}}catch{}return}if(z){const W=typeof te=="number"?te:null,H=xt&&xt.length>0,je=H?xt.every(V=>V.match):null,ue=typeof W=="number"?W<=1.5:null,ee=je===!0||ue===!0,le=H?xt.some(V=>!V.match):ue===!1;console.log("[drawOverlay] Drawing via homography transform");let Ne=0;const pe=(V,se,fe,de,ne)=>{try{const Se=we[se],qe=we[fe];if(q&&Se&&qe)return l.save(),l.shadowColor="rgba(0,0,0,0.45)",l.shadowBlur=6,l.beginPath(),l.ellipse?(l.ellipse(Y,be,qe*Ae,qe,0,0,Math.PI*2),l.ellipse(Y,be,Se*Ae,Se,0,0,Math.PI*2,!0)):(l.arc(Y,be,qe,0,Math.PI*2),l.arc(Y,be,Se,0,Math.PI*2,!0)),l.closePath(),l.fillStyle=de,l.fill(),ne&&(l.strokeStyle=ne,l.lineWidth=2,l.stroke()),l.restore(),!0;const ke=ut(V,fe,720),Ie=ut(V,se,720).reverse();if(!ke.length||!Ie.length)return!1;l.save(),l.shadowColor="rgba(0,0,0,0.45)",l.shadowBlur=6,l.beginPath(),l.moveTo(ke[0].x,ke[0].y);for(let xe=1;xe<ke.length;xe++)l.lineTo(ke[xe].x,ke[xe].y);for(let xe=0;xe<Ie.length;xe++)l.lineTo(Ie[xe].x,Ie[xe].y);return l.closePath(),l.fillStyle=de,l.fill(),ne&&(l.strokeStyle=ne,l.lineWidth=2,l.stroke()),l.restore(),!0}catch{return!1}};if(Le){const V=ee?"rgba(0,255,102,0.12)":le?"rgba(255,45,45,0.12)":"rgba(52,211,153,0.08)",se=ee?"rgba(0,255,102,0.08)":le?"rgba(255,45,45,0.08)":"rgba(253,224,71,0.06)",fe=ee?"rgba(0,255,102,0.06)":le?"rgba(255,45,45,0.06)":"rgba(34,211,238,0.06)";pe(Le,_.bullInner,_.bullOuter,V,"rgba(255,255,255,0.06)"),Ne++;const de=q?.trebleInner||Et.trebleInner,ne=q?.trebleOuter||Et.trebleOuter;pe(Le,de,ne,se,"rgba(255,255,255,0.06)"),Ne++;const ve=q?.doubleInner||Et.doubleInner,Se=q?.doubleOuter||Et.doubleOuter;pe(Le,ve,Se,fe,"rgba(255,255,255,0.06)"),Ne++;try{const ke=[{r:_.bullInner,color:ee?"#00ff66":le?"#ff2d2d":"#ffffff",key:"bullInner"},{r:_.bullOuter,color:"#ffffff",key:"bullOuter"},{r:de,color:ee?"#00ff66":le?"#ff2d2d":"#fde047",key:"trebleInner"},{r:ne,color:"#fde047",key:"trebleOuter"},{r:ve,color:ee?"#00ff66":le?"#ff2d2d":"#22d3ee",key:"doubleInner"},{r:Se,color:"#22d3ee",key:"doubleOuter"}];for(const Ie of ke){const xe=we[Ie.r];let lt;if(q&&xe){lt=[];for(let Xt=0;Xt<720;Xt++){const Gn=Xt/720*Math.PI*2;lt.push({x:Y+xe*Math.cos(Gn),y:be+xe*Math.sin(Gn)})}}else lt=ut(Le,Ie.r,720);Mt(l,lt,"rgba(0,0,0,0.45)",3),Mt(l,lt,Ie.color,1.5)}}catch{}}console.log("[drawOverlay] Drew",Ne,"rings via homography");try{const V=s.current?.getContext("2d");if(!!V&&s.current){const fe=ft(Le||f,{x:0,y:0}),de=(_.doubleInner+_.doubleOuter)/2+14,ne=Jn;V.save(),V.font="12px Sans-Serif",V.fillStyle="#ffffff",V.strokeStyle="#000000",V.lineWidth=3;const ve=typeof F=="number"?F:0;for(let Se=0;Se<ne.length;Se++){const qe=Se/ne.length*Math.PI*2-Math.PI/2-ve,ke=ft(Le||f,{x:(de-14)*Math.cos(qe),y:(de-14)*Math.sin(qe)}),Ie=String(ne[Se]),xe=V.measureText(Ie).width;V.strokeText(Ie,ke.x-xe/2,ke.y+4),V.fillText(Ie,ke.x-xe/2,ke.y+4)}V.restore()}}catch{}if(At.type&&Date.now()<At.until){const V=At.type==="pass",se=V?"rgba(0,255,102,0.9)":"rgba(255,45,45,0.9)",fe=V?"CALIBRATION PASS":"CALIBRATION FAIL";l.save();const de=12,ne=g.width-240-de,ve=de;l.fillStyle=se,l.strokeStyle="rgba(0,0,0,0.25)",l.lineWidth=2,l.beginPath(),l.roundRect(ne,ve,240,34,8),l.fill(),l.stroke(),l.fillStyle="#00110a",l.font="bold 14px system-ui, sans-serif",l.textBaseline="middle",l.fillText(fe,ne+12,ve+17),l.restore()}}if(q&&Ln){console.log("[drawOverlay] Drawing detected circles overlay:",{adjustedCx:Math.round(Y),adjustedCy:Math.round(be),doubleOuter:Math.round(q.doubleOuter),trebleOuter:Math.round(q.trebleOuter),bullOuter:Math.round(q.bullOuter)});const W=(H,je,ue=2)=>{if(!Number.isFinite(H)||H<=0)return;l.save(),l.strokeStyle=je,l.lineWidth=ue,l.setLineDash([5,5]),l.beginPath();const ee=Ae,le=H*ee,Ne=H*ee;l.ellipse?l.ellipse(Y,be,le,Ne,0,0,Math.PI*2):l.arc(Y,be,H,0,Math.PI*2),l.stroke(),l.restore()};if(W(q.doubleOuter,"#ff6b6b",3),W(q.doubleInner,"#ff6b6b",2),W(q.trebleOuter,"#ffd93d",2),W(q.trebleInner,"#ffd93d",2),W(q.bullOuter,"#6bcf7f",2),W(q.bullInner,"#6bcf7f",3),Le&&!Bt){const H=(je,ue)=>{const ee=ut(Le,je,180);if(ee.length){l.save(),l.setLineDash([6,4]),l.strokeStyle=ue,l.lineWidth=2,l.beginPath(),l.moveTo(ee[0].x,ee[0].y);for(let le=1;le<ee.length;le++)l.lineTo(ee[le].x,ee[le].y);l.closePath(),l.stroke(),l.restore()}};H(_.doubleOuter,"#00ffff"),H(_.trebleOuter,"#ffff00")}}q&&(l.save(),l.fillStyle="rgba(0,0,0,0.65)",l.fillRect(8,8,260,72),l.fillStyle="#fff",l.font="12px system-ui, sans-serif",l.fillText(`Detected cx:${Math.round(q.cx)} cy:${Math.round(q.cy)}`,16,28),l.fillText(`Double: ${Math.round(q.doubleOuter)} Treble: ${Math.round(q.trebleOuter)}`,16,48),l.fillText(`Adjusts: Sx:${Ae.toFixed(3)} Tx:${Qe} Ty:${Xe}`,16,68),l.restore());const Qt=Nn("outer");if(c.length>=4&&c.length<Qt.length&&f){l.save(),l.strokeStyle="rgba(255,193,7,0.4)",l.lineWidth=2,l.setLineDash([4,4]);for(let W=c.length;W<Qt.length;W++)try{const H=ft(Le||f,Qt[W]);l.beginPath(),l.arc(H.x,H.y,12,0,Math.PI*2),l.stroke(),l.save(),l.fillStyle="rgba(255,255,255,0.65)",l.font="12px sans-serif",l.fillText(Rt[W]??String(W+1),H.x+10,H.y-10),l.restore()}catch{}l.restore()}if(c.length<kr&&(l.save(),l.fillStyle="rgba(0,0,0,0.7)",l.fillRect(10,10,200,40),l.fillStyle="#fbbf24",l.font="bold 16px sans-serif",l.fillText(`Click on ${Rt[c.length]}`,20,36),l.restore()),c.forEach((W,H)=>{bo(l,W,"#f472b6"),l.save(),l.fillStyle="#f472b6",l.font="14px sans-serif",l.fillText(Rt[H]??String(H+1),W.x+6,W.y-6),l.restore()}),Z&&!ye){l.save(),l.fillStyle="rgba(59,130,246,0.10)";const W=Math.round(Math.min(g.width,g.height)*.08),H=g.width-W*2,je=g.height-W*2;l.fillRect(W,W,H,je),l.strokeStyle="rgba(34,197,94,0.9)",l.lineWidth=2,l.beginPath(),l.moveTo(W,g.height/2),l.lineTo(g.width-W,g.height/2),l.stroke(),l.beginPath(),l.moveTo(g.width/2,W),l.lineTo(g.width/2,g.height-W),l.stroke(),l.strokeStyle="rgba(234,179,8,0.9)",l.setLineDash([6,4]);const ue=W+30,ee=W+30;l.beginPath(),l.moveTo(ue,ee+30),l.lineTo(ue+60,ee),l.stroke(),l.beginPath(),l.moveTo(g.width-ue,ee+30),l.lineTo(g.width-ue-60,ee),l.stroke(),l.restore(),l.save(),l.scale(1/b,1/b),l.fillStyle="rgba(255,255,255,0.85)",l.font="12px sans-serif",l.fillText("Tip: Frame board centered, edges parallel; slight top-down is okay. Keep bull near center.",W*b,(W+18)*b),l.restore()}}const so=c=>{if(!c)return;Ye(!1),tt(null),ot(!1),c.anchors?.dst&&c.anchors.dst.length>0&&(B(c.anchors.dst),Kt(c.anchors.dst,c.H));let f=c.H;Ae!==1&&(f=En(f,Ae,1)),(Qe!==0||Xe!==0)&&(f=Er(f,Qe,Xe)),G({H:f,createdAt:Date.now(),errorPx:c.errorPx,imageSize:c.imageSize,overlaySize:c.overlaySize,anchors:c.anchors,locked:c.locked}),M(c.phase??"computed"),Ke(c.confidence??100),nt("Test auto-detect applied"),delete globalThis.__TEST_AUTO_DETECT_RESULT};function Yt(c){try{const f=typeof c=="number"?c:In;console.debug("[Camera Connection] doCommit invoked",{v:f,inProgress:Pt.getState().inProgress});const v=Zt.getState?Zt.getState():void 0,g=!!v?.H&&!!v?.imageSize&&(v.locked||typeof v.errorPx=="number"&&v.errorPx<=J);if(f!=null&&Pt.getState().inProgress&&g){const l=`${f}|3`,z=performance.now();if(!Ot.current&&!(l===Dn.current&&z-On.current<An)){Dn.current=l,On.current=z,Ot.current=!0,console.debug("[Camera Connection] doCommit: committing visit",f,{calState:v,curCalValid:g});try{Pt.getState().addVisit(f,3,{visitTotal:f})}catch{}try{window.setTimeout(()=>{Ot.current=!1},Math.max(120,An))}catch{}}else console.debug("[Camera Connection] doCommit: deduped commit skipped",{v:f,curCalValid:g,sig:l})}else console.debug("[Camera Connection] doCommit: NOT committing (invalid cal or no match)",{v:f,inProgress:Pt.getState().inProgress,curCalValid:g,calState:v})}catch{}}async function io(){try{if(console.debug("[Camera Connection] autoDetectRings invoked"),!t.current){alert("Load a photo or capture a frame first."),Ye(!1);return}const c=globalThis.__TEST_AUTO_DETECT_RESULT;if(c){console.debug("[Camera Connection] testAutoDetectResult detected (legacy)"),so(c);return}Ye(!0),nt("Using advanced detection algorithm..."),Tt(null);const f=Kn(t.current,rt?{centerHint:rt,colorAssist:!0}:{colorAssist:!0});if(console.log("[Camera Connection] detectBoard returned:",{success:f.success,confidence:f.confidence,hasHomography:!!f.homography,numPoints:f.calibrationPoints.length},f.message),!f.success||!f.homography||f.confidence<40){console.warn("[Camera Connection] Auto-detect failed, result:",{success:f.success,confidence:f.confidence,hasHomography:!!f.homography}),nt(f.message||"âŒ Detection failed. Try better lighting or different angle."),Ye(!1);return}tt({cx:f.cx,cy:f.cy,bullInner:f.bullInner,bullOuter:f.bullOuter,trebleInner:f.trebleInner,trebleOuter:f.trebleOuter,doubleInner:f.doubleInner,doubleOuter:f.doubleOuter}),ot(!0),B(f.calibrationPoints),Kt(f.calibrationPoints,f.homography);const v=s?.current?{w:s.current.width,h:s.current.height}:e?.current?{w:e.current.clientWidth,h:e.current.clientHeight}:{w:t.current.width,h:t.current.height},g=e.current?{w:e.current.videoWidth,h:e.current.videoHeight}:{w:t.current.width,h:t.current.height},l=xo(f.homography,"outer");G({H:f.homography,createdAt:Date.now(),errorPx:f.errorPx??null,imageSize:g,overlaySize:v,anchors:{src:Nn("outer").slice(0,4),dst:f.calibrationPoints},theta:typeof f.theta=="number"?f.theta:null,sectorOffset:l});const z=co(f.homography,f.calibrationPoints);_r(z),M("verify"),Ke(Dr?100:Math.round(f.confidence)),nt("âœ… Detected rings â€” Please verify alignment by looking at the overlay"),Ye(!1);try{let re=1;for(let ae=1;ae<3;ae++){const Y=document.createElement("canvas");Y.width=Math.max(1,Math.round(t.current.width*.9)),Y.height=Math.max(1,Math.round(t.current.height*.9)),Y.getContext("2d").drawImage(t.current,0,0,Y.width,Y.height);const ze=rt?{centerHint:{x:rt.x*.9,y:rt.y*.9},colorAssist:!0}:{colorAssist:!0},we=Kn(Y,ze);lo(f,we)&&re++}re>=Math.ceil(3*.66)&&console.log("[Camera Connection] Detection is stable")}catch(K){console.warn("[Camera Connection] Legacy stability check failed:",K)}}catch(c){console.error("[Camera Connection] autoDetectRings failed:",c),nt(`âŒ Auto-detect failed: ${c instanceof Error?c.message:String(c)}`),Ye(!1)}}function co(c,f){const v=[];if(!c||!f||f.length===0)return v;for(const g of ca){if(g.idx>=f.length)continue;const l=f[g.idx];let z=null;try{z=yo(c,l)}catch(Y){console.warn("[Camera Connection] Failed to convert image point to board space:",Y)}let K=null,re=null,me=null,ae=!1;if(z)try{if(K=wo(z,typeof F=="number"?F:0,$??0),K.ring===g.ring&&K.sector===g.sector)ae=!0,re=0;else{const Y=_[g.ring==="DOUBLE"?"doubleOuter":g.ring==="INNER_BULL"?"bullInner":g.ring==="BULL"?"bullOuter":"doubleOuter"],be=Math.hypot(z.x,z.y);re=Math.abs(be-Y),me=Math.hypot(l.x-(q?.cx??0),l.y-(q?.cy??0)),ae=re<=g.toleranceMm}}catch(Y){console.warn("[Camera Connection] Failed to score detected point:",Y)}v.push({label:g.label,expected:{ring:g.ring,sector:g.sector},detected:K,deltaMm:re,deltaPx:me,match:ae,note:ae?"âœ… OK":`âŒ Off by ${re?.toFixed(1)}mm`})}return v}function lo(c,f,v=.03){if(!c||!f)return!1;const g=Math.abs((c.cx-f.cx)/(c.cx||1)),l=Math.abs((c.cy-f.cy)/(c.cy||1)),z=Math.abs((c.doubleOuter-f.doubleOuter)/(c.doubleOuter||1));return g<=v&&l<=v&&z<=v}const Vn=p.useRef(null);if(p.useEffect(()=>{let c=null;try{c=new Worker(new URL("/assets/boardDetection.worker-CCEKArUr.js",import.meta.url),{type:"module"}),Vn.current=c,console.log("[Camera Connection] Board detection worker created")}catch(f){console.warn("[Camera Connection] Failed to create board detection worker, will fallback to main thread: ",f),Vn.current=null}return()=>{try{c?.terminate()}catch{}}},[]),p.useEffect(()=>{Kt()},[N,L,Ae,Qe,Xe]),p.useEffect(()=>{if(!Oe||!y)return;let c=0;const f=()=>{try{ao()}catch{}c=requestAnimationFrame(f)};return c=requestAnimationFrame(f),()=>cancelAnimationFrame(c)},[Oe,y]),p.useEffect(()=>{(async()=>{try{if(!ye||!Me)return;const c=t.current?{w:t.current.width,h:t.current.height}:null,f=JSON.stringify({H:L,anchors:null,imageSize:c,errorPx:te??null});try{await kt(`/cam/calibration/${Me}`,{method:"POST",headers:{"Content-Type":"application/json"},body:f}),console.log("[Camera Connection] Posted connection for code",Me)}catch(v){console.warn("[Camera Connection] Upload connection failed",v)}try{const v=localStorage.getItem("authToken");v&&(await kt("/api/user/calibration",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${v}`},body:f}),console.log("[Camera Connection] Synced connection to user account"))}catch(v){console.warn("[Camera Connection] User connection sync failed",v)}}catch{}})()},[ye,Me]),T&&!j){const c=Zr??(typeof window<"u"?`${window.location.origin.replace(/\/$/,"")}/mobile-cam.html`:"/mobile-cam.html");return a.jsxs("div",{className:"mx-auto flex min-h-[calc(100vh-140px)] w-full max-w-xl flex-col justify-center gap-6 p-6",children:[a.jsxs("div",{className:"space-y-5 rounded-3xl border border-indigo-400/30 bg-slate-900/70 p-6 text-slate-100 shadow-xl",children:[a.jsxs("div",{className:"space-y-2",children:[a.jsx("p",{className:"text-xs font-semibold uppercase tracking-wide text-indigo-300",children:"Choose Mode"}),a.jsx("h2",{className:"text-2xl font-semibold leading-tight text-white",children:"How do you want to use this device?"}),a.jsx("p",{className:"text-sm text-slate-200/80",children:"You can stream this camera to another device (Remote Camera) or\\n play and calibrate directly on this screen."})]}),a.jsxs("div",{className:"space-y-2",children:[a.jsx("a",{href:c,className:"btn w-full justify-center px-4 py-2 text-base",children:"Open mobile camera"}),a.jsx("button",{type:"button",className:"btn btn--ghost w-full justify-center px-4 py-2 text-sm",onClick:()=>Gt(c,"link"),children:zt==="link"?"Link copied!":"Copy link"})]}),a.jsxs("p",{className:"text-xs text-slate-300/70",children:["On a desktop, open Camera Connection and generate a pairing code. Then tap ",a.jsx("span",{className:"font-semibold",children:"Pair with Desktop"})," ","from the mobile camera page to connect this device."]})]}),a.jsx("button",{type:"button",className:"self-center text-xs font-medium text-indigo-200 underline decoration-dotted decoration-indigo-300/70 transition hover:text-indigo-100",onClick:()=>h(!0),children:"Continue to desktop connection"})]})}return a.jsxs("div",{className:"space-y-6",children:[T&&j&&a.jsx("div",{className:"rounded-2xl border border-indigo-400/30 bg-indigo-500/10 p-4 text-sm text-indigo-100",children:a.jsxs("div",{className:"flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between",children:[a.jsx("p",{className:"leading-relaxed",children:"Using a phone? Switch back to the streamlined mobile camera interface for an easier pairing flow."}),a.jsx("button",{type:"button",className:"btn btn--ghost px-3 py-1 text-xs",onClick:()=>h(!1),children:"Open mobile camera mode"})]})}),a.jsxs("div",{className:"card space-y-6 p-6",children:[a.jsxs("header",{className:"flex flex-wrap items-start justify-between gap-4",children:[a.jsxs("div",{className:"space-y-2",children:[a.jsx("p",{className:"text-xs font-semibold uppercase tracking-wide text-indigo-300",children:"Camera alignment"}),a.jsx("h2",{className:"text-2xl font-semibold leading-tight text-white",children:"Camera connection"}),a.jsx("p",{className:"max-w-2xl text-sm opacity-80",children:"Select and test your camera. Manual scoring mode does not require calibration."})]}),a.jsxs("div",{className:"flex flex-col items-end gap-2 text-xs font-medium",children:[a.jsxs("span",{className:"inline-flex items-center gap-2 rounded-full border border-indigo-400/50 bg-indigo-500/10 px-3 py-1",children:[a.jsx("span",{className:"opacity-60",children:"Mode"}),a.jsx("span",{children:S==="local"?"Desktop camera":S==="phone"?"Phone camera":"Wifi device"})]}),a.jsxs("span",{className:`inline-flex items-center gap-2 rounded-full border px-3 py-1 ${y?"border-emerald-400/60 bg-emerald-500/10 text-emerald-100":"border-white/20 bg-white/5 text-slate-200"}`,children:[a.jsx("span",{className:`h-2 w-2 rounded-full ${y?"bg-emerald-400":"bg-slate-400"}`}),y?"Live stream active":"Stream idle"]}),ye?a.jsxs("div",{className:"space-y-3 rounded-2xl border border-emerald-400/40 bg-emerald-500/10 p-4 text-sm",children:[a.jsxs("div",{className:"flex items-center justify-between gap-2",children:[a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx("div",{className:"flex h-10 w-10 items-center justify-center rounded-full bg-emerald-500/20",children:a.jsx("span",{className:"text-lg",children:"âœ“"})}),a.jsxs("div",{children:[a.jsx("h4",{className:"font-semibold text-emerald-100",children:"Connection locked"}),a.jsx("p",{className:"text-xs opacity-80",children:"Your camera connection is saved and active across all game modes. It will be used in Online, Offline, and Tournaments."})]})]}),a.jsx("button",{className:"btn btn--ghost px-2 py-1 text-xs whitespace-nowrap",onClick:()=>G({locked:!1}),title:"Unlock to realign",children:"Unlock"})]}),te!=null&&a.jsxs("div",{className:"text-xs opacity-75",children:["Precision: ",te.toFixed(2)," px RMS error"]})]}):null]})]}),a.jsxs("div",{className:"grid gap-6 xl:grid-cols-[minmax(0,2fr)_minmax(320px,1fr)]",children:[a.jsx("section",{className:"space-y-4",children:a.jsxs("div",{className:"space-y-4 rounded-2xl border border-white/10 bg-black/40 p-4",children:[a.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-4 text-xs",children:[a.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[a.jsx("span",{className:"uppercase tracking-wide opacity-60",children:"Video source"}),a.jsxs("div",{className:"flex items-center gap-1",children:[a.jsx("button",{className:`btn px-3 py-1 ${S==="local"?"bg-emerald-600 hover:bg-emerald-700":"bg-slate-700 hover:bg-slate-600"}`,"data-testid":"mode-local",onClick:()=>{I("local"),typeof DROPDOWN_DEBUG<"u"&&DROPDOWN_DEBUG&&console.debug("[Camera Connection] setMode(local)",Date.now()),Be(!1)},title:"Use local camera",children:"Local"}),!T&&a.jsx("button",{className:`btn px-3 py-1 ${S==="phone"?"bg-emerald-600 hover:bg-emerald-700":"bg-slate-700 hover:bg-slate-600"}`,"data-testid":"mode-phone",onClick:()=>{I("phone"),typeof DROPDOWN_DEBUG<"u"&&DROPDOWN_DEBUG&&console.debug("[Camera Connection] setMode(phone)",Date.now()),Be(!1)},title:"Enable camera on this device",children:"Phone"}),a.jsx("button",{className:`btn px-3 py-1 ${S==="wifi"?"bg-emerald-600 hover:bg-emerald-700":"bg-slate-700 hover:bg-slate-600"}`,"data-testid":"mode-wifi",onClick:()=>{I("wifi"),typeof DROPDOWN_DEBUG<"u"&&DROPDOWN_DEBUG&&console.debug("[Camera Connection] setMode(wifi)",Date.now()),Be(!1);try{St()}catch(c){console.debug("[Camera Connection] startWifiConnection failed",c)}},title:"Discover wifi/USB autoscoring devices",children:"Wifi"})]})]}),a.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx("span",{className:"opacity-70",children:"Zoom"}),a.jsx("input",{type:"range",min:50,max:200,step:5,value:Math.round(b*100),onChange:c=>C(Math.max(.5,Math.min(2,Number(c.target.value)/100)))}),a.jsxs("span",{className:"w-12 text-right",children:[Math.round(b*100),"%"]})]}),a.jsx("button",{className:"btn px-3 py-1",onClick:()=>C(1),children:"Actual"})]})]}),a.jsxs("div",{className:"ml-3 relative",children:[a.jsxs("button",{className:"inline-flex items-center gap-2 rounded-full border border-indigo-400/30 bg-indigo-400/10 px-3 py-1 text-sm",onClick:()=>Fr(!Tn),"data-testid":"cal-tools-popper-button",children:[a.jsx("span",{className:"font-semibold",children:"Cam Tools"}),Ue&&a.jsx("span",{className:"ml-2 text-xs opacity-70",children:"(overlay preserved)"})]}),Tn&&a.jsxs("div",{className:"absolute right-0 mt-2 w-64 rounded-lg border bg-gray-900/80 p-3 shadow-lg z-50","data-testid":"cal-tools-popover",role:"dialog",children:[a.jsx("div",{className:"text-xs mb-2",children:"Camera connection quick tools"}),a.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[a.jsx("input",{id:"hdr-show-darts",type:"checkbox",checked:jn,onChange:c=>Or(c.target.checked)}),a.jsx("label",{htmlFor:"hdr-show-darts",className:"text-sm",children:"Show darts overlay"})]}),a.jsx("div",{className:"flex items-center gap-2 mb-2",children:a.jsx("button",{className:"btn btn--ghost btn-sm",onClick:()=>Hr(),children:"Reset visual adjustments"})}),a.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[a.jsx("input",{id:"hdr-autocommit",type:"checkbox",checked:Dt,onChange:c=>Ar(c.target.checked)}),a.jsx("label",{htmlFor:"hdr-autocommit",className:"text-sm",children:"Enable autocommit test"})]}),a.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[a.jsx("input",{id:"hdr-autocommit-online",type:"checkbox",checked:We,onChange:c=>ht(c.target.checked),disabled:!Dt}),a.jsx("label",{htmlFor:"hdr-autocommit-online",className:"text-sm",children:"Allow autocommit in Online/Tournament matches (dangerous)"})]}),a.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[a.jsx("input",{id:"hdr-autocommit-immediate",type:"checkbox",checked:Br,onChange:c=>Lr(c.target.checked)}),a.jsx("label",{htmlFor:"hdr-autocommit-immediate",className:"text-sm",children:"Autocommit immediate when detected"})]}),a.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[a.jsx("input",{id:"hdr-show-detected",type:"checkbox",checked:Ln,onChange:c=>Wr(c.target.checked)}),a.jsx("label",{htmlFor:"hdr-show-detected",className:"text-sm",children:"Show detected rings overlay"})]}),a.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[a.jsx("input",{id:"hdr-force-detected",type:"checkbox",checked:Bt,onChange:c=>ot(c.target.checked)}),a.jsx("label",{htmlFor:"hdr-force-detected",className:"text-sm",children:"Force detected-only overlay (bypass homography)"})]}),a.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[a.jsx("label",{htmlFor:"hdr-double-adjust",className:"text-sm mr-2",children:"Double adj"}),a.jsx("input",{id:"hdr-double-adjust",type:"range",min:.95,max:1.1,step:.005,value:Lt,onChange:c=>Ft(parseFloat(c.target.value))}),a.jsxs("span",{className:"text-xs ml-2",children:[(Lt*100).toFixed(1),"%"]})]}),a.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[a.jsx("label",{htmlFor:"hdr-treble-adjust",className:"text-sm mr-2",children:"Treble adj"}),a.jsx("input",{id:"hdr-treble-adjust",type:"range",min:.95,max:1.1,step:.005,value:Ut,onChange:c=>_t(parseFloat(c.target.value))}),a.jsxs("span",{className:"text-xs ml-2",children:[(Ut*100).toFixed(1),"%"]})]}),a.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[a.jsxs("select",{id:"hdr-align-select",className:"input",value:He||"",onChange:c=>$t(c.target.value?c.target.value:null),children:[a.jsx("option",{value:"",children:"-- Align ring --"}),a.jsx("option",{value:"double",children:"Double Outer"}),a.jsx("option",{value:"treble",children:"Treble Outer"}),a.jsx("option",{value:"bull",children:"Bull Outer"})]}),a.jsx("div",{className:"text-xs opacity-70 ml-2",children:"Click on the physical ring to align"})]}),a.jsxs("div",{className:"flex items-center justify-between mt-2",children:[a.jsx("div",{className:"text-xs opacity-70",children:Rn||"No recent detection"}),a.jsx("div",{children:a.jsx("button",{className:"btn btn--small",onClick:()=>{console.debug("[Camera Connection] popover Commit click (onClick)"),Yt()},onPointerDown:()=>{console.debug("[Camera Connection] popover Commit click (onPointerDown)"),Yt()},children:"Commit"})})]})]})]}),a.jsxs("div",{className:"relative w-full overflow-hidden rounded-2xl border border-indigo-400/30 bg-black",style:{aspectRatio:m?`${m.w} / ${m.h}`:"16 / 9"},children:[a.jsxs("div",{className:"absolute top-2 right-2 z-40 flex items-center gap-2 rounded-full bg-black/40 px-2 py-1 text-[11px] text-white backdrop-blur",children:[a.jsx("span",{className:`inline-block h-2 w-2 rounded-full ${y?"bg-emerald-400":"bg-rose-500"}`,"aria-hidden":"true"}),a.jsx("span",{children:y?"Connected":"Disconnected"})]}),a.jsxs("div",{className:"absolute inset-0",style:{transform:`scale(${b})`,transformOrigin:"center center"},children:[a.jsx("video",{ref:e,onLoadedMetadata:c=>{try{const f=c.currentTarget;f.videoWidth&&f.videoHeight&&w({w:f.videoWidth,h:f.videoHeight})}catch{}},className:`absolute inset-0 h-full w-full object-cover transition-opacity duration-300 ${N?"opacity-0 -z-10":"opacity-100 z-10"}`,autoPlay:!0,playsInline:!0,muted:!0,controls:!1}),k&&a.jsx("div",{className:"absolute inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur",children:a.jsx("button",{className:"rounded-lg bg-white px-4 py-2 font-semibold text-slate-900 shadow-lg",onClick:async()=>{try{await e.current?.play(),E(!1),P(!0),M("capture")}catch(c){console.warn("Tap-to-play retry failed",c),alert("Tap to enable video failed. Please check browser settings or reload the page.")}},children:"Tap to allow video"})}),a.jsx("canvas",{ref:t,className:`absolute inset-0 h-full w-full transition-opacity duration-300 ${N?"opacity-100 z-10":"opacity-0 -z-10"}`})]})]}),a.jsxs("div",{className:"mt-4 flex flex-wrap items-center gap-2",children:[y?a.jsx("button",{className:"btn",onClick:()=>Be(!0),children:"Disconnect"}):a.jsx("button",{className:"btn",onClick:ro,children:"Connect"}),a.jsx("span",{className:"text-xs opacity-70",children:y?"Camera connected":"Camera not connected"})]})]})}),a.jsxs("aside",{className:"space-y-4",children:[a.jsx(ia,{videoDevices:r,streaming:y,refreshVideoDevices:it,testCamera:eo,onSelectPhoneCamera:A,lastDetectedLabel:Rn,autoCommitTestMode:Dt,doCommit:Yt,lastDetectedValue:In,cameraConnected:y}),S==="phone"&&!T&&a.jsxs("section",{className:"space-y-3 rounded-2xl border border-indigo-400/30 bg-black/40 p-4 text-xs text-white",children:[a.jsx("div",{className:"font-semibold",children:"Phone pairing"}),Fn&&Me&&a.jsxs("div",{className:"flex flex-col items-center gap-2 rounded-xl bg-white p-3",children:[a.jsx("img",{src:Fn,alt:"Scan to pair mobile camera",className:"w-48 h-48",draggable:!1}),a.jsx("div",{className:"text-[11px] text-slate-700 text-center font-medium",children:"Scan with your phone to pair"})]}),a.jsxs("button",{type:"button",className:"w-full text-left px-3 py-2 rounded-lg border border-white/10 bg-white/5 hover:bg-white/10 transition flex items-center gap-2",onClick:()=>Gt($e,"link"),title:"Copy mobile camera link",children:[a.jsx("span",{className:"flex-1 min-w-0 font-mono break-all text-[11px]",children:$e}),a.jsx("span",{className:"text-[10px] uppercase tracking-wide whitespace-nowrap text-emerald-200",children:zt==="link"?"Copied!":"Copy link"})]}),a.jsx("div",{className:"flex items-center gap-2 text-[11px]",children:a.jsx("a",{href:$e,target:"_blank",rel:"noreferrer",className:"underline decoration-dotted text-indigo-200 hover:text-indigo-100 transition",children:"Open link in new tab"})}),a.jsxs("div",{className:"opacity-80",children:["WS:"," ",Pe?Pe.readyState===1?"open":Pe.readyState===0?"connecting":Pe.readyState===2?"closing":"closed":"not started"," ","Â· ",Ze?.https?"HTTPS on":"HTTP only"]}),Me&&a.jsxs("button",{type:"button",className:"w-full text-left px-3 py-2 rounded-lg border border-white/10 bg-white/5 hover:bg-white/10 transition flex items-center justify-between gap-2",onClick:()=>Gt(Me,"code"),title:"Copy pairing code",children:[a.jsx("span",{className:"font-mono tracking-[0.3em] text-sm",children:Me}),a.jsx("span",{className:"text-[10px] uppercase tracking-wide whitespace-nowrap text-emerald-200",children:zt==="code"?"Copied!":"Copy code"})]}),a.jsxs("div",{className:"flex items-center gap-2",children:[Hn!==null&&a.jsxs("span",{children:["Expires in ",Hn,"s"]}),a.jsx("button",{className:"btn px-2 py-1 text-xs",onClick:oo,children:"Regenerate"})]}),Yr&&a.jsxs("div",{className:"space-y-2 rounded-lg border border-slate-700/50 bg-slate-900/60 p-3 text-slate-200",children:[a.jsx("div",{className:"font-semibold",children:"Troubleshooting"}),a.jsxs("ul",{className:"list-disc space-y-1 pl-4",children:[a.jsx("li",{children:"Phone and desktop must be on the same Wiâ€‘Fi network."}),a.jsxs("li",{children:["Allow the server through your firewall (ports 8787 and"," ",Ze?.https?Ze.port:8788,")."]}),a.jsx("li",{children:"On iPhone, use HTTPS links (QR will prefer HTTPS when enabled)."})]}),a.jsx("div",{className:"text-right",children:a.jsx("button",{className:"btn btn--ghost px-2 py-1 text-xs",onClick:()=>Qr(!1),children:"Hide tips"})})]})]})]})]}),S==="wifi"&&!y&&a.jsxs("section",{className:"space-y-3 rounded-2xl border border-indigo-400/30 bg-black/40 p-4 text-xs text-white",children:[a.jsx("div",{className:"font-semibold",children:"Wifi scoring devices"}),Xr?a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx("div",{className:"h-4 w-4 animate-spin rounded-full border-b-2 border-white"}),a.jsx("span",{children:"Scanning network for devicesâ€¦"})]}):qn.length>0?a.jsxs("div",{className:"space-y-2",children:[qn.map(c=>a.jsxs("div",{className:"flex items-center justify-between rounded border border-slate-700/50 bg-slate-900/60 p-2",children:[a.jsxs("div",{children:[a.jsx("div",{className:"font-medium",children:c.name}),a.jsxs("div",{className:"opacity-70",children:[c.ip,":",c.port," Â· ",c.type.toUpperCase()]}),a.jsxs("div",{className:"opacity-70 text-xs",children:["Capabilities: ",c.capabilities.join(", ")]})]}),a.jsx("button",{className:`btn px-2 py-1 text-xs ${c.status==="connecting"?"bg-yellow-600":c.status==="online"?"bg-green-600":"bg-blue-600"}`,onClick:()=>no(c),disabled:c.status==="connecting",children:c.status==="connecting"?"Connectingâ€¦":"Connect"})]},c.id)),a.jsx("div",{className:"text-center",children:a.jsx("button",{className:"btn px-2 py-1 text-xs",onClick:St,children:"Rescan network"})})]}):a.jsxs("div",{className:"space-y-2 text-center",children:[a.jsx("div",{children:"No wifi scoring devices found."}),a.jsx("div",{className:"opacity-70",children:"Ensure your wifi cameras are powered on and on the same network."}),a.jsx("button",{className:"btn px-2 py-1 text-xs",onClick:St,children:"Scan again"})]})]})]})]})}function Sa(){const[e,t]=p.useState(()=>Mn());return p.useEffect(()=>{const s=()=>t(Mn());return s(),window.addEventListener("resize",s),()=>window.removeEventListener("resize",s)},[]),e?a.jsx(da,{}):a.jsxs("div",{className:"card ndn-game-shell relative overflow-hidden",children:[a.jsx("h2",{className:"text-3xl font-bold text-brand-700 mb-4",children:"Camera Setup"}),a.jsx("div",{className:"ndn-shell-body",children:a.jsx(la,{})})]})}function It(e){const t=(e||"").toLowerCase();return/vert|scolia|gran\s?board|target\s?nexus|auto\s?score|dart\s?connect|my\s?dart/i.test(t)?"smart":/bluetooth|bt[\s-]/i.test(t)?"bluetooth":/usb|logitech|razer|elgato|obs|virtual|cam\s?link|capture|hdmi|avermedia|magewell/i.test(t)?"usb":"builtin"}function da(){const e=p.useRef(null),[t,s]=p.useState([]),[o,n]=p.useState(!1),[r,d]=p.useState(!1),[i,u]=p.useState(null),[y,P]=p.useState(!1),[k,E]=p.useState(null),S=Te(h=>h.preferredCameraId);Te(h=>h.preferredCameraLabel);const I=Te(h=>h.preferredCameraLocked),O=Te.getState().setPreferredCamera,B=Pr(),N=p.useCallback(async()=>{try{if(!navigator?.mediaDevices?.enumerateDevices)return;const h=await navigator.mediaDevices.enumerateDevices();s(h.filter(T=>T.kind==="videoinput"))}catch{}},[]);p.useEffect(()=>{N();try{navigator.mediaDevices.addEventListener("devicechange",N)}catch{}return()=>{try{navigator.mediaDevices.removeEventListener("devicechange",N)}catch{}}},[N]);const D=p.useCallback(async h=>{if(!r){d(!0),u(null);try{const T={video:h?{deviceId:{exact:h},width:{ideal:1920},height:{ideal:1080},frameRate:{ideal:30}}:{facingMode:"environment",width:{ideal:1920},height:{ideal:1080},frameRate:{ideal:30}},audio:!1};let x;try{x=await navigator.mediaDevices.getUserMedia(T)}catch{x=await navigator.mediaDevices.getUserMedia({video:!0,audio:!1})}e.current&&(e.current.srcObject=x,await Co({video:e.current,stream:x,onPlayError:()=>{}}));try{B.setMediaStream?.(x),B.setMode?.("local"),B.setStreaming?.(!0),B.setStarting?.(!1),e.current&&B.setVideoElementRef?.(e.current)}catch{}n(!0),await N()}catch(T){const x=T?.name||"";u(x==="NotAllowedError"||x==="SecurityError"?"Camera permission denied. Allow camera access in your browser settings.":x==="NotFoundError"||x==="OverconstrainedError"?"Camera not found. Try selecting a different device.":"Could not start camera. Please try again.")}finally{d(!1)}}},[r,B,N]),R=p.useCallback(()=>{try{const h=B.getMediaStream?.();h&&h.getTracks().forEach(T=>T.stop())}catch{}if(e.current)try{e.current.srcObject=null}catch{}try{B.setMediaStream?.(null),B.setStreaming?.(!1),B.setVideoElementRef?.(null)}catch{}n(!1)},[B]);p.useEffect(()=>{const h=B.getMediaStream?.();if(h?.getVideoTracks()?.length){if(e.current&&!e.current.srcObject){e.current.srcObject=h;try{Promise.resolve(e.current.play()).catch(()=>{})}catch{}}n(!0),N()}else D(S||void 0)},[]);const M=p.useCallback(async h=>{const T=t.find(x=>x.deviceId===h)?.label||"";O(h,T,!0),R(),await new Promise(x=>setTimeout(x,150)),await D(h)},[t,O,R,D]),A=p.useCallback(()=>{Te.getState().setPreferredCameraLocked(!I)},[I]),m=p.useCallback(async()=>{E(null),P(!0);try{if(!navigator?.bluetooth?.requestDevice){E("Bluetooth not supported in this browser.");return}await navigator.bluetooth.requestDevice({acceptAllDevices:!0,optionalServices:[]}),await N()}catch(h){h?.name!=="NotFoundError"&&E("Bluetooth scan failed. Make sure Bluetooth is enabled.")}finally{P(!1)}},[N]),w=t.filter(h=>It(h.label)==="smart"),b=t.filter(h=>It(h.label)==="bluetooth"),C=t.filter(h=>It(h.label)==="usb"),j=t.filter(h=>It(h.label)==="builtin");return a.jsx("div",{className:"p-3 text-white",children:a.jsxs("div",{className:"rounded-2xl border border-white/10 bg-slate-950/70 shadow-2xl ring-1 ring-white/5 overflow-hidden",children:[a.jsxs("div",{className:"flex items-center justify-between px-3 py-2 border-b border-white/5 bg-white/5",children:[a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx("div",{className:`w-2 h-2 rounded-full shadow-lg ${o?"bg-emerald-400 shadow-emerald-400/50 animate-pulse":"bg-slate-500"}`}),a.jsx("span",{className:"text-xs sm:text-sm font-semibold text-white/80",children:"Board Camera"})]}),a.jsx("span",{className:"text-[10px] sm:text-xs font-medium text-white/50",children:o?"Live":r?"Startingâ€¦":"Idle"})]}),a.jsxs("div",{className:"relative min-h-[12rem] max-h-[50vh] bg-black aspect-[4/3]",children:[a.jsx("video",{ref:e,className:"absolute inset-0 w-full h-full object-cover bg-black",playsInline:!0,muted:!0,autoPlay:!0}),!o&&!r&&!i&&a.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-black/80",children:a.jsx("button",{className:"bg-indigo-600 hover:bg-indigo-700 text-white font-semibold px-5 py-2.5 rounded-xl text-sm shadow-lg",onClick:()=>D(S||void 0),children:"Start Camera"})}),r&&a.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-black/80",children:a.jsx("div",{className:"text-white/80 text-sm font-medium animate-pulse",children:"Starting cameraâ€¦"})}),i&&a.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-black/80 px-4",children:a.jsxs("div",{className:"text-center space-y-2 max-w-xs",children:[a.jsx("div",{className:"text-rose-300 text-xs font-medium",children:i}),a.jsx("button",{className:"bg-indigo-600 hover:bg-indigo-700 text-white font-semibold px-4 py-2 rounded-xl text-xs",onClick:()=>D(S||void 0),children:"Retry"})]})})]}),a.jsxs("div",{className:"flex flex-col gap-1.5 px-3 py-2 border-t border-white/5 bg-white/[0.03]",children:[a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsxs("select",{className:"flex-1 min-w-0 bg-slate-800 text-white rounded-lg px-2 py-1.5 text-xs border border-white/10 min-h-[2rem]",value:S||"",onChange:h=>M(h.target.value||void 0),disabled:r||I,children:[a.jsx("option",{value:"",children:"Auto (back camera)"}),w.length>0&&a.jsx("optgroup",{label:"ðŸŽ¯ Smart Cameras (Verte Â· Scolia Â· GranBoard)",children:w.map(h=>a.jsx("option",{value:h.deviceId,children:h.label},h.deviceId))}),C.length>0&&a.jsx("optgroup",{label:"ðŸ”Œ USB / Capture Devices",children:C.map(h=>a.jsx("option",{value:h.deviceId,children:h.label||(h.deviceId?`Camera (${h.deviceId.slice(0,8)}â€¦)`:"Camera")},h.deviceId))}),b.length>0&&a.jsx("optgroup",{label:"ðŸ“¶ Bluetooth",children:b.map(h=>a.jsx("option",{value:h.deviceId,children:h.label||(h.deviceId?`BT Camera (${h.deviceId.slice(0,8)}â€¦)`:"BT Camera")},h.deviceId))}),j.length>0&&a.jsx("optgroup",{label:"ðŸ“± Built-in",children:j.map(h=>a.jsx("option",{value:h.deviceId,children:h.label||(h.deviceId?`Camera (${h.deviceId.slice(0,8)}â€¦)`:"Camera")},h.deviceId))})]}),a.jsx("button",{className:`rounded-lg px-2 py-1.5 text-xs font-semibold border min-h-[2rem] transition-colors ${I?"bg-emerald-600/30 border-emerald-400/40 text-emerald-200":"bg-slate-800 border-white/10 text-white/60"}`,onClick:A,children:I?"ðŸ”’":"ðŸ”“"}),a.jsx("button",{className:"rounded-lg px-2 py-1.5 bg-slate-800 border border-white/10 text-white/60 text-xs min-h-[2rem]",onClick:N,title:"Rescan USB & Wi-Fi cameras",children:"â†»"}),o&&a.jsx("button",{className:"rounded-lg px-2 py-1.5 text-xs font-medium text-rose-400 hover:text-rose-300 border border-rose-400/20 min-h-[2rem]",onClick:R,children:"Stop"})]}),a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx("button",{className:"flex-1 rounded-lg px-2 py-1.5 bg-indigo-700/40 hover:bg-indigo-700/60 border border-indigo-400/20 text-indigo-200 text-xs font-medium min-h-[2rem] transition-colors disabled:opacity-40",onClick:m,disabled:y||I,children:y?"Scanningâ€¦":"ðŸ“¶ Pair Bluetooth Camera"}),t.length===0&&a.jsx("span",{className:"text-[10px] text-amber-300/80",children:"No cameras found"})]}),k&&a.jsx("div",{className:"text-[10px] text-rose-300/80",children:k})]})]})})}export{Sa as default};
//# sourceMappingURL=CameraSetup-VI2dBHLj.js.map
