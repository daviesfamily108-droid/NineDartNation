{"version":3,"file":"OnlinePlay-C0UWwdvt.js","sources":["../../src/store/blocklist.ts","../../src/components/OnlinePlay.tsx"],"sourcesContent":["import { create } from 'zustand'\r\n\r\ntype BlockState = {\r\n  blocked: Record<string, number> // email/username -> ts\r\n  isBlocked: (id: string) => boolean\r\n  block: (id: string) => void\r\n  unblock: (id: string) => void\r\n  all: () => string[]\r\n}\r\n\r\nconst LS = 'ndn:blocked:v1'\r\n\r\nfunction load(): Record<string, number> {\r\n  try { const raw = localStorage.getItem(LS); return raw ? JSON.parse(raw) : {} } catch { return {} }\r\n}\r\nfunction save(map: Record<string, number>) {\r\n  try { localStorage.setItem(LS, JSON.stringify(map)) } catch {}\r\n}\r\n\r\nexport const useBlocklist = create<BlockState>((set, get) => ({\r\n  blocked: load(),\r\n  isBlocked: (id) => !!get().blocked[(id||'').toLowerCase()],\r\n  block: (id) => set((s) => { const map = { ...s.blocked }; map[(id||'').toLowerCase()] = Date.now(); save(map); return { blocked: map } }),\r\n  unblock: (id) => set((s) => { const map = { ...s.blocked }; delete map[(id||'').toLowerCase()]; save(map); return { blocked: map } }),\r\n  all: () => Object.keys(get().blocked),\r\n}))\r\n","import { useEffect, useRef, useState } from 'react'\r\nimport { useMatch } from '../store/match'\r\nimport CameraView from './CameraView'\r\nimport CameraTile from './CameraTile'\r\nimport ResizablePanel from './ui/ResizablePanel'\r\nimport { suggestCheckouts, sayScore } from '../utils/checkout'\r\nimport { addSample, getAllTimeAvg } from '../store/profileStats'\r\nimport MatchStartShowcase from './ui/MatchStartShowcase'\r\nimport { getFreeRemaining, incOnlineUsage } from '../utils/quota'\r\nimport { useUserSettings } from '../store/userSettings'\r\nimport { useCalibration } from '../store/calibration'\r\nimport GameCalibrationStatus from './GameCalibrationStatus'\r\nimport MatchSummaryModal from './MatchSummaryModal'\r\nimport { freeGames, premiumGames, allGames, type GameKey } from '../utils/games'\r\nimport { getUserCurrency, formatPriceInCurrency } from '../utils/config'\r\nimport ResizableModal from './ui/ResizableModal'\r\nimport GameHeaderBar from './ui/GameHeaderBar'\r\nimport { useToast } from '../store/toast'\r\n// import { TabKey } from './Sidebar'\r\nimport { useWS } from './WSProvider'\r\nimport { useMessages } from '../store/messages'\r\nimport { censorProfanity, containsProfanity } from '../utils/profanity'\r\nimport { useBlocklist } from '../store/blocklist'\r\nimport TabPills from './ui/TabPills'\r\nimport { DOUBLE_PRACTICE_ORDER, isDoubleHit, parseManualDart, ringSectorToDart } from '../game/types'\r\nimport { ATC_ORDER } from '../game/aroundTheClock'\r\nimport { createCricketState, applyCricketDart, CRICKET_NUMBERS, hasClosedAll as cricketClosedAll, cricketWinner } from '../game/cricket'\r\nimport { createShanghaiState, getRoundTarget as shanghaiTarget, applyShanghaiDart, endShanghaiTurn } from '../game/shanghai'\r\nimport { createDefaultHalveIt, getCurrentHalveTarget, applyHalveItDart, endHalveItTurn } from '../game/halveIt'\r\nimport { createHighLow, applyHighLowDart, endHighLowTurn } from '../game/highLow'\r\nimport { assignKillerNumbers, createKillerState, applyKillerDart, killerWinner } from '../game/killer'\r\nimport { apiFetch } from '../utils/api'\r\n// Phase 2 premium games (Online support)\r\nimport { createAmCricketState, applyAmCricketDart, AM_CRICKET_NUMBERS } from '../game/americanCricket'\r\nimport { createBaseball, applyBaseballDart } from '../game/baseball'\r\nimport { createGolf, applyGolfDart, GOLF_TARGETS } from '../game/golf'\r\nimport { createTicTacToe, tryClaimCell, TTT_TARGETS } from '../game/ticTacToe'\r\nimport { useMatchControl } from '../store/matchControl'\r\nimport GameScoreboard from './scoreboards/GameScoreboard'\r\nimport { useOnlineGameStats } from './scoreboards/useGameStats'\r\n\r\nexport default function OnlinePlay({ user }: { user?: any }) {\r\n  const API_URL = (import.meta as any).env?.VITE_API_URL || ''\r\n  const toast = useToast();\r\n  const match = useMatch();\r\n  const wsGlobal = useWS();\r\n  const wsRef = useRef<WebSocket | null>(null);\r\n  // forward-declare so handlers defined earlier can call it\r\n  let startMobileWebRTC: (code: string) => Promise<void> = async () => { return }\r\n  const blocklist = useBlocklist();\r\n\r\n  // ...existing code...\r\n\r\n  // ...existing code...\r\n\r\n  // Place this after all hooks/variables:\r\n  function sendState() {\r\n    try {\r\n      if (wsGlobal && (wsGlobal as any).connected) {\r\n        wsGlobal.send({ type: 'sync', match })\r\n      } else if (wsRef.current && wsRef.current.readyState === WebSocket.OPEN) {\r\n        wsRef.current.send(JSON.stringify({ type: 'sync', match }))\r\n      }\r\n    } catch (err) {\r\n      // Optionally log or toast error\r\n    }\r\n  }\r\n\r\n  // Request a mobile pairing code from server\r\n  function requestPairingCode(persistent = false) {\r\n    try {\r\n      const payload: any = { type: 'cam-create' }\r\n      if (persistent) payload.persistent = true\r\n      if (wsGlobal && (wsGlobal as any).connected) {\r\n        wsGlobal.send(payload)\r\n      } else if (wsRef.current && wsRef.current.readyState === WebSocket.OPEN) {\r\n        wsRef.current.send(JSON.stringify(payload))\r\n      } else {\r\n        // No WS available\r\n        toast?.('Not connected to server. Unable to request pairing code.', { type: 'error' })\r\n        return\r\n      }\r\n      toast?.('Requested pairing code — check the Camera panel for the code', { type: 'info' })\r\n    } catch (err) {\r\n      try { toast?.('Failed to request pairing code', { type: 'error' }) } catch {}\r\n    }\r\n  }\r\n  const [roomId, setRoomId] = useState('room-1')\r\n  const [connected, setConnected] = useState(false)\r\n  const [chat, setChat] = useState<{from:string;message:string; fromId?: string}[]>([])\r\n  const [showQuick, setShowQuick] = useState(false)\r\n  const [showMessages, setShowMessages] = useState(false)\r\n  // Track last locally-sent chat to avoid duplicating when the server echoes it back\r\n  const lastSentChatRef = useRef<{ text: string; ts: number } | null>(null)\r\n  const [selfId, setSelfId] = useState<string | null>(null)\r\n  // Reconnect handling\r\n  const reconnectAttemptsRef = useRef(0)\r\n  const reconnectTimerRef = useRef<ReturnType<typeof setTimeout> | null>(null)\r\n  const shouldReconnectRef = useRef(true)\r\n  const lastToastRef = useRef(0)\r\n  const firstConnectDoneRef = useRef(false)\r\n  const msgs = useMessages()\r\n  const { favoriteDouble, callerEnabled, callerVoice, callerVolume, speakCheckoutOnly, allowSpectate, cameraScale, setCameraScale, cameraFitMode = 'fill', setCameraFitMode, cameraEnabled, textSize, boxSize, autoscoreProvider, matchType = 'singles', setMatchType, teamAName = 'Team A', setTeamAName, teamBName = 'Team B', setTeamBName, x01DoubleIn: defaultX01DoubleIn } = useUserSettings()\r\n  const manualScoring = autoscoreProvider === 'manual'\r\n  useEffect(() => {\r\n    if (cameraFitMode !== 'fit') {\r\n      setCameraFitMode('fit')\r\n    }\r\n  }, [cameraFitMode, setCameraFitMode])\r\n\r\n  // Button size classes for toolbar buttons\r\n  const getButtonSizeClasses = (size: string) => {\r\n    switch (size) {\r\n      case 'small': return 'px-1.5 py-0.5 text-xs'\r\n      case 'large': return 'px-3 py-1 text-sm'\r\n      default: return 'px-2 py-0.5 text-sm'\r\n    }\r\n  }\r\n  const buttonSizeClass = getButtonSizeClasses(textSize)\r\n  // Camera resize state\r\n  const [cameraColSpan, setCameraColSpan] = useState(2)\r\n  // Turn-by-turn modal\r\n  const [showMatchModal, setShowMatchModal] = useState(false)\r\n  const [participants, setParticipants] = useState<string[]>([])\r\n  // Layout controls (mirror OfflinePlay)\r\n  const [maximized, setMaximized] = useState(false)\r\n  const [fitAll, setFitAll] = useState(false)\r\n  const [fitScale, setFitScale] = useState(1)\r\n  const [turnIdx, setTurnIdx] = useState(0)\r\n  const [visitScore, setVisitScore] = useState(0)\r\n  // Double Practice (online) minimal state synchronized via WS state payload\r\n  const [dpIndex, setDpIndex] = useState(0)\r\n  const [dpHits, setDpHits] = useState(0)\r\n  const [dpManual, setDpManual] = useState('')\r\n  // Around the Clock (online) minimal state\r\n  const [atcIndex, setAtcIndex] = useState(0)\r\n  const [atcHits, setAtcHits] = useState(0)\r\n  const [atcManual, setAtcManual] = useState('')\r\n  // Treble Practice (online)\r\n  const [trebleTarget, setTrebleTarget] = useState<number>(20)\r\n  const [trebleHits, setTrebleHits] = useState<number>(0)\r\n  const [trebleDarts, setTrebleDarts] = useState<number>(0)\r\n  const [trebleManual, setTrebleManual] = useState<string>('')\r\n  const [trebleMaxDarts, setTrebleMaxDarts] = useState<number>(30)\r\n  // X01 Double-In per-match flag (synced over WS)\r\n  const [x01DoubleInMatch, setX01DoubleInMatch] = useState<boolean>(false)\r\n  // Mobile camera pairing\r\n  const [pairingCode, setPairingCode] = useState<string | null>(null)\r\n  const [pairingPending, setPairingPending] = useState(false)\r\n  const [pairingExpiryAt, setPairingExpiryAt] = useState<number | null>(null)\r\n  const pairingTimerRef = useRef<number | null>(null)\r\n  const pairingPendingTimeoutRef = useRef<number | null>(null)\r\n  // Copy pairing code to clipboard\r\n  async function copyPairingCode() {\r\n    if (!pairingCode) return\r\n    try {\r\n      if (navigator.clipboard && navigator.clipboard.writeText) {\r\n        await navigator.clipboard.writeText(pairingCode)\r\n      } else {\r\n        const ta = document.createElement('textarea')\r\n        ta.value = pairingCode\r\n        document.body.appendChild(ta)\r\n        ta.select()\r\n        document.execCommand('copy')\r\n        ta.remove()\r\n      }\r\n      try { toast('Pairing code copied to clipboard', { type: 'success' }) } catch {}\r\n    } catch (err) {\r\n      try { toast('Failed to copy pairing code', { type: 'error' }) } catch {}\r\n    }\r\n  }\r\n  const [pairCountdown, setPairCountdown] = useState<number>(0)\r\n  useEffect(() => {\r\n    return () => {\r\n      try { if (pairingTimerRef.current) window.clearInterval(pairingTimerRef.current) } catch {}\r\n      try { if (pairingPendingTimeoutRef.current) window.clearTimeout(pairingPendingTimeoutRef.current) } catch {}\r\n    }\r\n  }, [])\r\n  // Highlight auto-download UI\r\n  const [highlightCandidate, setHighlightCandidate] = useState<any | null>(null)\r\n  const [showHighlightModal, setShowHighlightModal] = useState(false)\r\n\r\n  // Download highlight to device as a JSON file\r\n  function downloadHighlightToDevice() {\r\n    if (!highlightCandidate) return\r\n    try {\r\n      const blob = new Blob([JSON.stringify(highlightCandidate, null, 2)], { type: 'application/json' })\r\n      const url = URL.createObjectURL(blob)\r\n      const a = document.createElement('a')\r\n      const name = `ndn-highlight-${highlightCandidate.player || 'player'}-${highlightCandidate.ts || Date.now()}.json`\r\n      a.href = url\r\n      a.download = name\r\n      document.body.appendChild(a)\r\n      a.click()\r\n      a.remove()\r\n      URL.revokeObjectURL(url)\r\n  toast?.('Downloaded highlight to device', { type: 'success' })\r\n      setShowHighlightModal(false)\r\n    } catch (err) {\r\n  toast?.('Download failed', { type: 'error' })\r\n    }\r\n  }\r\n\r\n  async function saveHighlightToAccount() {\r\n    if (!highlightCandidate) return\r\n    const token = localStorage.getItem('authToken')\r\n  if (!token) { toast?.('You must be signed in to save to account', { type: 'error' }); return }\r\n    try {\r\n      const res = await apiFetch('/api/user/highlights', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify(highlightCandidate) })\r\n      if (!res.ok) {\r\n        const j = await res.json().catch(()=>({}))\r\n  toast?.(`Save failed: ${j.error || res.statusText}`, { type: 'error' })\r\n        return\r\n      }\r\n      const j = await res.json()\r\n  toast?.('Saved highlight to your account', { type: 'success' })\r\n      setShowHighlightModal(false)\r\n    } catch (err) {\r\n  toast?.('Save failed', { type: 'error' })\r\n    }\r\n  }\r\n  // WebRTC for mobile camera\r\n  const [mobileStream, setMobileStream] = useState<MediaStream | null>(null)\r\n  const mobileVideoRef = useRef<HTMLVideoElement>(null)\r\n  // Tic Tac Toe manual input\r\n  const [tttManual, setTttManual] = useState('')\r\n  // Per-player states for premium games\r\n  const [cricketById, setCricketById] = useState<Record<string, ReturnType<typeof createCricketState>>>({})\r\n  const [shanghaiById, setShanghaiById] = useState<Record<string, ReturnType<typeof createShanghaiState>>>({})\r\n  const [halveById, setHalveById] = useState<Record<string, ReturnType<typeof createDefaultHalveIt>>>({})\r\n  const [highlowById, setHighlowById] = useState<Record<string, ReturnType<typeof createHighLow>>>({})\r\n  const [killerById, setKillerById] = useState<Record<string, ReturnType<typeof createKillerState>>>({})\r\n  const [amCricketById, setAmCricketById] = useState<Record<string, ReturnType<typeof createAmCricketState>>>({})\r\n  const [baseballById, setBaseballById] = useState<Record<string, ReturnType<typeof createBaseball>>>({})\r\n  const [golfById, setGolfById] = useState<Record<string, ReturnType<typeof createGolf>>>({})\r\n  const [ttt, setTTT] = useState<ReturnType<typeof createTicTacToe>>(() => createTicTacToe())\r\n  // Track darts this turn for non-X01 games to auto-advance after 3\r\n  const [turnDarts, setTurnDarts] = useState(0)\r\n  // New: Track if all darts thrown and waiting for removal\r\n  const [awaitingDartRemoval, setAwaitingDartRemoval] = useState(false)\r\n  const dartRemovalTimerRef = useRef<NodeJS.Timeout | null>(null)\r\n  // Pause state (synced over WS)\r\n  const [paused, setPausedLocal] = useState<boolean>(false)\r\n  const [pauseRequestedBy, setPauseRequestedBy] = useState<string | null>(null)\r\n  const [pauseAcceptedBy, setPauseAcceptedBy] = useState<Record<string, boolean>>({})\r\n  const [pauseEndsAt, setPauseEndsAt] = useState<number | null>(null)\r\n  const [pauseDurationSec, setPauseDurationSec] = useState<number>(300)\r\n  const setPausedGlobal = useMatchControl(s => s.setPaused)\r\n  // View mode: compact player-by-player (mobile) vs full overview (desktop)\r\n  const [compactView, setCompactView] = useState<boolean>(() => {\r\n    try { const ua = navigator.userAgent || ''; return /Android|iPhone|iPad|iPod|Mobile/i.test(ua) } catch { return false }\r\n  })\r\n  // Online end-of-match summary modal (appears when inProgress flips from true->false)\r\n  const [showX01EndSummary, setShowX01EndSummary] = useState(false)\r\n  const endSummaryPrevRef = useRef<boolean>(!!useMatch.getState().inProgress)\r\n  const [showStartShowcase, setShowStartShowcase] = useState(false)\r\n  const startedShowcasedRef = useRef(false)\r\n  const [prestartRoomId, setPrestartRoomId] = useState<string | null>(null)\r\n  const [prestartEndsAt, setPrestartEndsAt] = useState<number | null>(null)\r\n  const [prestartTimeLeft, setPrestartTimeLeft] = useState<number | null>(null)\r\n  const [prestartChoices, setPrestartChoices] = useState<Record<string, string>>({})\r\n  const [prestartBullActive, setPrestartBullActive] = useState(false)\r\n  const [prestartBullTie, setPrestartBullTie] = useState(false)\r\n  useEffect(() => {\r\n    let preTimer: any = null\r\n    if (prestartEndsAt) {\r\n      setPrestartTimeLeft(Math.max(0, Math.ceil((prestartEndsAt - Date.now()) / 1000)))\r\n      preTimer = setInterval(() => {\r\n        setPrestartTimeLeft(Math.max(0, Math.ceil((prestartEndsAt - Date.now()) / 1000)))\r\n      }, 1000)\r\n    } else {\r\n      setPrestartTimeLeft(null)\r\n    }\r\n    return () => { if (preTimer) clearInterval(preTimer) }\r\n  }, [prestartEndsAt])\r\n\r\n  useEffect(() => {\r\n    const prev = endSummaryPrevRef.current\r\n    const now = !!match.inProgress\r\n    if (prev && !now) {\r\n      const hasFinished = (match.players || []).some(p => (p.legs||[]).some(L => L.finished))\r\n      if (hasFinished) setShowX01EndSummary(true)\r\n    }\r\n    endSummaryPrevRef.current = now\r\n    // Reset the showcased flag when match ends\r\n    if (!now) startedShowcasedRef.current = false\r\n    // When match starts, show the start showcase once\r\n    if (now && !startedShowcasedRef.current) {\r\n      startedShowcasedRef.current = true\r\n      setShowStartShowcase(true)\r\n    }\r\n  }, [match.inProgress, match.players])\r\n  // Dev-only: auto-simulate a short X01 leg to validate double-out stats via ?autotest=doubleout\r\n  useEffect(() => {\r\n    try {\r\n      if (!(import.meta as any).env?.DEV) return\r\n      const q = new URLSearchParams(window.location.search)\r\n      if (q.get('autotest') !== 'doubleout') return\r\n      // Prevent re-run on HMR\r\n      if ((window as any).__NDN_AUTO_TESTED__) return\r\n      ;(window as any).__NDN_AUTO_TESTED__ = true\r\n      // Create simple 101 match and simulate visits:\r\n      // You: 41 (attempts=0) -> Opp: 26 -> You: 10 (cross into window; attempts=1) -> Opp: 26 -> You: 40 finish on D20 (attempts=1, finishedByDouble=true)\r\n      match.newMatch([user?.username || 'You', 'Opponent'], 101, 'local-dev')\r\n      // You visit 1: 41 (no attempts yet)\r\n      match.addVisit(41, 3, { preOpenDarts: 0, doubleWindowDarts: 0, finishedByDouble: false, visitTotal: 41 })\r\n      match.nextPlayer()\r\n      // Opponent visit: dummy 26\r\n      match.addVisit(26, 3, { preOpenDarts: 0, doubleWindowDarts: 0, finishedByDouble: false, visitTotal: 26 })\r\n      match.nextPlayer()\r\n      // You visit 2: 10 (enters window, attempts=1)\r\n      match.addVisit(10, 3, { preOpenDarts: 0, doubleWindowDarts: 1, finishedByDouble: false, visitTotal: 10 })\r\n      match.nextPlayer()\r\n      // Opponent visit: dummy 26\r\n      match.addVisit(26, 3, { preOpenDarts: 0, doubleWindowDarts: 0, finishedByDouble: false, visitTotal: 26 })\r\n      match.nextPlayer()\r\n      // You visit 3: 40 (D20) finish inside window, attempts=1, hit=1\r\n      match.addVisit(40, 1, { preOpenDarts: 0, doubleWindowDarts: 1, finishedByDouble: true, visitTotal: 40 })\r\n      match.endLeg(40)\r\n      match.endGame()\r\n      // Modal will auto-open via inProgress flip hook\r\n    } catch {}\r\n  }, [])\r\n  // Build doubles stats (double-out only) for summary modal\r\n  const doublesStats = (() => {\r\n    const out: Record<string, { dartsAtDouble?: number; doublesHit?: number }> = {}\r\n    for (const p of (match.players || [])) {\r\n      let attempts = 0\r\n      let hits = 0\r\n      for (const L of (p.legs || [])) {\r\n        for (const v of (L.visits || [])) {\r\n          attempts += Math.max(0, Number(v.doubleWindowDarts || 0))\r\n          if (v.finishedByDouble) hits += 1\r\n        }\r\n      }\r\n      out[p.id] = { dartsAtDouble: attempts, doublesHit: hits }\r\n    }\r\n    return out\r\n  })()\r\n  // Ephemeral celebration overlay (e.g., 180), tied to the current player's turn\r\n  const [celebration, setCelebration] = useState<null | { kind: '180' | 'leg'; by: string; turnIdx: number; ts: number }>(null)\r\n  const lastCelebrationRef = useRef<{ kind: '180'|'leg'; by: string; ts: number } | null>(null)\r\n  const audioCtxRef = useRef<AudioContext | null>(null)\r\n  // Auto-unpause when timer elapses\r\n  useEffect(() => {\r\n    if (!paused || !pauseEndsAt) return\r\n    const id = setInterval(() => {\r\n      if (Date.now() >= (pauseEndsAt || 0)) {\r\n        setPausedLocal(false)\r\n        setPauseRequestedBy(null)\r\n        setPauseAcceptedBy({})\r\n        setPauseEndsAt(null)\r\n        setPausedGlobal(false, null)\r\n        sendState()\r\n      }\r\n    }, 1000)\r\n    return () => clearInterval(id)\r\n  }, [paused, pauseEndsAt])\r\n  function ensureAudio() {\r\n    try {\r\n      if (!audioCtxRef.current) {\r\n        const Ctor: any = (window as any).AudioContext || (window as any).webkitAudioContext\r\n        if (Ctor) audioCtxRef.current = new Ctor()\r\n      }\r\n      audioCtxRef.current?.resume?.().catch(()=>{})\r\n    } catch {}\r\n  }\r\n  function beep(freq: number, durMs: number, whenS = 0, gain = 0.05) {\r\n    const ctx = audioCtxRef.current\r\n    if (!ctx) return\r\n    const o = ctx.createOscillator()\r\n    const g = ctx.createGain()\r\n    o.type = 'square'\r\n    o.frequency.value = freq\r\n    g.gain.value = gain\r\n    o.connect(g)\r\n    g.connect(ctx.destination)\r\n    const now = ctx.currentTime + whenS\r\n    o.start(now)\r\n    o.stop(now + durMs / 1000)\r\n  }\r\n  function playSting(kind: '180'|'leg') {\r\n    ensureAudio()\r\n    const ctx = audioCtxRef.current\r\n    if (!ctx) return\r\n    if (kind === '180') {\r\n      beep(880, 110, 0, 0.06); beep(1175, 110, 0.06, 0.06); beep(1568, 140, 0.12, 0.06)\r\n    } else {\r\n      beep(659, 140, 0, 0.07); beep(784, 140, 0.08, 0.07); beep(987, 200, 0.16, 0.07)\r\n    }\r\n  }\r\n  function triggerCelebration(kind: '180'|'leg', who: string) {\r\n    const now = Date.now()\r\n    const last = lastCelebrationRef.current\r\n    if (last && last.kind === kind && last.by === who && (now - last.ts) < 500) return\r\n    lastCelebrationRef.current = { kind, by: who, ts: now }\r\n    setCelebration({ kind, by: who, turnIdx: match.currentPlayerIdx, ts: now })\r\n    playSting(kind)\r\n  }\r\n  // Lobby & create-match state\r\n  const [showCreate, setShowCreate] = useState(false)\r\n  const [lobby, setLobby] = useState<any[]>([])\r\n  const [mode, setMode] = useState<'bestof'|'firstto'>('bestof')\r\n  const [modeValue, setModeValue] = useState<number>(5)\r\n  const [startScore, setStartScore] = useState<number>(501)\r\n  const [pendingInvite, setPendingInvite] = useState<any | null>(null)\r\n  const [inviteCountdown, setInviteCountdown] = useState<number>(60)\r\n  const [errorMsg, setErrorMsg] = useState<string>('')\r\n  // Stripe checkout error handler\r\n  function handleStripeError(msg: string) {\r\n    setErrorMsg(msg || 'Failed to create Stripe checkout session. Please try again later.')\r\n    setTimeout(() => setErrorMsg(''), 4000)\r\n    try { toast(msg || 'Stripe checkout failed', { type: 'error' }) } catch {}\r\n  }\r\n  const [lastJoinIntent, setLastJoinIntent] = useState<any | null>(null)\r\n  const [offerNewRoom, setOfferNewRoom] = useState<null | { game: string; mode: 'bestof'|'firstto'; value: number; startingScore?: number }>(null)\r\n  // Game selection\r\n  const [game, setGame] = useState<GameKey>('X01')\r\n  const [currentGame, setCurrentGame] = useState<GameKey>('X01')\r\n  const [requireCalibration, setRequireCalibration] = useState<boolean>(false)\r\n  // Create-match: Treble Practice specific setting\r\n  const [createTrebleMaxDarts, setCreateTrebleMaxDarts] = useState<number>(30)\r\n  // Create-match: X01 Double-In per-match toggle (prefilled from Settings)\r\n  const [createX01DoubleIn, setCreateX01DoubleIn] = useState<boolean>(!!defaultX01DoubleIn)\r\n  const freeLeft = user?.username && !user?.fullAccess ? getFreeRemaining(user.username) : Infinity\r\n  const locked = !user?.fullAccess && (freeLeft <= 0)\r\n  // World Lobby filters\r\n  const [filterMode, setFilterMode] = useState<'all'|'bestof'|'firstto'>('all')\r\n  const [filterStart, setFilterStart] = useState<'all'|301|501|701>('all')\r\n  const [filterGame, setFilterGame] = useState<'all'|GameKey>('all')\r\n  const [nearAvg, setNearAvg] = useState(false)\r\n  const [avgTolerance, setAvgTolerance] = useState<number>(10)\r\n  const { H: calibH } = useCalibration()\r\n  const myAvg = user?.username ? getAllTimeAvg(user.username) : 0\r\n  const unread = useMessages(s => s.unread)\r\n  const filteredLobby = (lobby || []).filter((m:any) => {\r\n    if (filterMode !== 'all' && m.mode !== filterMode) return false\r\n    if (filterStart !== 'all' && Number(m.startingScore) !== Number(filterStart)) return false\r\n    if (filterGame !== 'all' && m.game !== filterGame) return false\r\n    if (nearAvg) {\r\n      if (!myAvg || !m.creatorAvg) return false\r\n      const diff = Math.abs(Number(m.creatorAvg) - Number(myAvg))\r\n      if (diff > avgTolerance) return false\r\n    }\r\n    return true\r\n  })\r\n\r\n  // Removed tournaments banner from Online; tournaments live in Tournaments tab only\r\n\r\n  // Demo: prefill Create Match modal from URL (ndn:online-demo)\r\n  useEffect(() => {\r\n    const handler = (e: any) => {\r\n      const d = e?.detail || {}\r\n      if (d.game) setGame(d.game)\r\n      if (d.mode === 'bestof' || d.mode === 'firstto') setMode(d.mode)\r\n      if (typeof d.value === 'number' && isFinite(d.value)) setModeValue(Math.max(1, Math.floor(d.value)))\r\n      if (typeof d.start === 'number' && isFinite(d.start)) setStartScore(Math.max(1, Math.floor(d.start)))\r\n      setShowCreate(true)\r\n    }\r\n    window.addEventListener('ndn:online-demo', handler as any)\r\n    return () => window.removeEventListener('ndn:online-demo', handler as any)\r\n  }, [])\r\n\r\n  // Load inbox on mount for the current user\r\n  useEffect(() => {\r\n    const email = String(user?.email || '').toLowerCase()\r\n    if (!email) return\r\n    apiFetch(`/api/friends/messages?email=${encodeURIComponent(email)}`).then(r=>r.json()).then(d=>{\r\n      if (d?.ok && Array.isArray(d.messages)) msgs.load(d.messages)\r\n    }).catch(()=>{})\r\n  }, [user?.email])\r\n\r\n  // Demo: open a populated Online Match view with fake data (local-only)\r\n  useEffect(() => {\r\n    const handler = (e: any) => {\r\n      try {\r\n        const d = e?.detail || {}\r\n        const start = Number(d.start || 501)\r\n        // Create a quick local match with two players\r\n        match.newMatch([user?.username || 'You', 'Opponent'], start, roomId)\r\n        // Seed a few visits to populate UI\r\n        match.addVisit(60, 3) // You\r\n        match.nextPlayer()\r\n        match.addVisit(85, 3) // Opponent\r\n        match.nextPlayer()\r\n        match.addVisit(100, 3) // You\r\n        setCurrentGame('X01')\r\n        setShowMatchModal(true)\r\n      } catch (err) {\r\n        console.error('Demo error:', err)\r\n      }\r\n    }\r\n    window.addEventListener('ndn:online-match-demo', handler as any)\r\n    return () => window.removeEventListener('ndn:online-match-demo', handler as any)\r\n  }, [])\r\n\r\n  useEffect(() => {\r\n    // Auto-connect on mount and enable auto-reconnect\r\n    shouldReconnectRef.current = true\r\n    connect()\r\n    return () => {\r\n      shouldReconnectRef.current = false\r\n      if (reconnectTimerRef.current) { clearTimeout(reconnectTimerRef.current) }\r\n      try { wsRef.current?.close() } catch {}\r\n    }\r\n  }, [])\r\n\r\n  // Track in-game flag in messages store\r\n  useEffect(() => {\r\n    msgs.setInGame(match.inProgress)\r\n  }, [match.inProgress])\r\n\r\n  // Clear celebration as soon as turn advances to the next player\r\n  useEffect(() => {\r\n    if (celebration && match.currentPlayerIdx !== celebration.turnIdx) {\r\n      setCelebration(null)\r\n    }\r\n  }, [match.currentPlayerIdx, celebration?.turnIdx])\r\n\r\n  // If the user changes the spectate preference, push updated presence to the server\r\n  useEffect(() => {\r\n    try {\r\n      if (wsGlobal && wsGlobal.connected) {\r\n        wsGlobal.send({ type: 'presence', username: user?.username || 'guest', email: (user?.email||'').toLowerCase(), allowSpectate })\r\n      } else if (wsRef.current && wsRef.current.readyState === WebSocket.OPEN) {\r\n        wsRef.current.send(JSON.stringify({ type: 'presence', username: user?.username || 'guest', email: (user?.email||'').toLowerCase(), allowSpectate }))\r\n      }\r\n    } catch {}\r\n  }, [allowSpectate, wsGlobal?.connected])\r\n\r\n  // Spectator flow: listen to spectate events from Friends and join room as readonly\r\n  useEffect(() => {\r\n    const onSpectate = (e: any) => {\r\n      const rid = e?.detail?.roomId\r\n      if (!rid) return\r\n      setRoomId(rid)\r\n      // send spectate message\r\n      if (wsGlobal) wsGlobal.send({ type: 'spectate', roomId: rid })\r\n      else wsRef.current?.send(JSON.stringify({ type: 'spectate', roomId: rid }))\r\n      setShowMatchModal(true)\r\n      setShowCreate(false)\r\n    }\r\n    window.addEventListener('ndn:spectate-room', onSpectate as any)\r\n    return () => window.removeEventListener('ndn:spectate-room', onSpectate as any)\r\n  }, [wsGlobal])\r\n\r\n  // When we receive a pendingInvite, start a 60s countdown\r\n  useEffect(() => {\r\n    let t: any = null\r\n    if (pendingInvite) {\r\n      setInviteCountdown(60)\r\n      t = setInterval(() => setInviteCountdown(c => Math.max(0, c - 1)), 1000)\r\n    } else {\r\n      setInviteCountdown(60)\r\n    }\r\n    return () => { if (t) clearInterval(t) }\r\n  }, [pendingInvite])\r\n\r\n  function respondToInvite(accept: boolean) {\r\n    if (!pendingInvite) return\r\n    try { if (wsGlobal) wsGlobal.send({ type: 'invite-response', matchId: pendingInvite.matchId, accept, toId: pendingInvite.fromId }); else wsRef.current?.send(JSON.stringify({ type: 'invite-response', matchId: pendingInvite.matchId, accept, toId: pendingInvite.fromId })) } catch {}\r\n    setPendingInvite(null)\r\n  }\r\n\r\n  function connect() {\r\n    if (wsGlobal) {\r\n      // If global provider exists, rely on it for connection and just send initial commands\r\n      if (wsGlobal.connected) {\r\n        wsGlobal.send({ type: 'join', roomId })\r\n  wsGlobal.send({ type: 'presence', username: user?.username || 'guest', email: (user?.email||'').toLowerCase(), allowSpectate })\r\n        wsGlobal.send({ type: 'list-matches' })\r\n        setConnected(true)\r\n      }\r\n      return\r\n    }\r\n    // Avoid duplicate sockets\r\n    try { if (wsRef.current && (wsRef.current.readyState === WebSocket.OPEN || wsRef.current.readyState === WebSocket.CONNECTING)) return } catch {}\r\n  const envUrl = (import.meta as any).env?.VITE_WS_URL as string | undefined\r\n  const proto = (window.location.protocol === 'https:' ? 'wss' : 'ws')\r\n  const host = window.location.hostname\r\n  const fallback = `${proto}://${host}${window.location.port ? '' : ':8787'}`\r\n  const url = envUrl && typeof envUrl === 'string' && envUrl.length > 0 ? envUrl : fallback\r\n  const ws = new WebSocket(url)\r\n    wsRef.current = ws\r\n    ws.onopen = () => {\r\n      setConnected(true)\r\n      // Reset backoff\r\n      reconnectAttemptsRef.current = 0\r\n      if (!firstConnectDoneRef.current) {\r\n        toast('Connected to lobby', { type: 'success' })\r\n        firstConnectDoneRef.current = true\r\n      } else {\r\n        toast('Reconnected to lobby', { type: 'success' })\r\n      }\r\n    ws.send(JSON.stringify({ type: 'join', roomId }))\r\n    // send presence\r\n  ws.send(JSON.stringify({ type: 'presence', username: user?.username || 'guest', email: (user?.email||'').toLowerCase(), allowSpectate }))\r\n      // fetch current lobby\r\n      ws.send(JSON.stringify({ type: 'list-matches' }))\r\n    }\r\n    ws.onmessage = (ev) => {\r\n      const data = JSON.parse(ev.data)\r\n      if (data.type === 'state') {\r\n        match.importState(data.payload)\r\n        // Pull Double Practice progress if present\r\n        const di = Number((data.payload as any)._dpIndex)\r\n        const dh = Number((data.payload as any)._dpHits)\r\n        if (Number.isFinite(di)) setDpIndex(Math.max(0, di))\r\n        if (Number.isFinite(dh)) setDpHits(Math.max(0, dh))\r\n        // Pull Around the Clock progress if present\r\n        const ai = Number((data.payload as any)._atcIndex)\r\n        const ah = Number((data.payload as any)._atcHits)\r\n        if (Number.isFinite(ai)) setAtcIndex(Math.max(0, ai))\r\n        if (Number.isFinite(ah)) setAtcHits(Math.max(0, ah))\r\n        // Pull Treble Practice progress if present\r\n        try {\r\n          const tt = Number((data.payload as any)._trebleTarget)\r\n          const th = Number((data.payload as any)._trebleHits)\r\n          const td = Number((data.payload as any)._trebleDarts)\r\n          const tmax = Number((data.payload as any)._trebleMaxDarts)\r\n          if (Number.isFinite(tt)) setTrebleTarget(Math.max(1, Math.min(20, tt)))\r\n          if (Number.isFinite(th)) setTrebleHits(Math.max(0, th))\r\n          if (Number.isFinite(td)) setTrebleDarts(Math.max(0, td))\r\n          if (Number.isFinite(tmax)) setTrebleMaxDarts(Math.max(0, tmax))\r\n        } catch {}\r\n        // Premium per-player states\r\n        try {\r\n          const _cr = (data.payload as any)._cricketById\r\n          if (_cr && typeof _cr === 'object') setCricketById(_cr)\r\n        } catch {}\r\n        try {\r\n          const _sh = (data.payload as any)._shanghaiById\r\n          if (_sh && typeof _sh === 'object') setShanghaiById(_sh)\r\n        } catch {}\r\n        try {\r\n          const _hv = (data.payload as any)._halveById\r\n          if (_hv && typeof _hv === 'object') setHalveById(_hv)\r\n        } catch {}\r\n        try {\r\n          const _hl = (data.payload as any)._highlowById\r\n          if (_hl && typeof _hl === 'object') setHighlowById(_hl)\r\n        } catch {}\r\n        try {\r\n          const _kr = (data.payload as any)._killerById\r\n          if (_kr && typeof _kr === 'object') setKillerById(_kr)\r\n        } catch {}\r\n        try { const _am = (data.payload as any)._amCricketById; if (_am && typeof _am === 'object') setAmCricketById(_am) } catch {}\r\n        try { const _bb = (data.payload as any)._baseballById; if (_bb && typeof _bb === 'object') setBaseballById(_bb) } catch {}\r\n        try { const _gf = (data.payload as any)._golfById; if (_gf && typeof _gf === 'object') setGolfById(_gf) } catch {}\r\n        try { const _tt = (data.payload as any)._tttState; if (_tt && typeof _tt === 'object') setTTT(_tt) } catch {}\r\n        try {\r\n          const _td = Number((data.payload as any)._turnDarts)\r\n          if (Number.isFinite(_td)) setTurnDarts(Math.max(0, _td))\r\n        } catch {}\r\n        // Pull X01 Double-In per-match if present\r\n        try {\r\n          const _di = (data.payload as any)._x01DoubleIn\r\n          if (typeof _di === 'boolean') setX01DoubleInMatch(_di)\r\n        } catch {}\r\n      } else if (data.type === 'joined') {\r\n        // joined room; keep our assigned id to label messages\r\n        if (data.id) setSelfId(data.id)\r\n      } else if (data.type === 'presence' || data.type === 'peer-joined') {\r\n        // Maintain a simple list of participant ids. In a real app we would map id->username.\r\n        setParticipants(prev => {\r\n          const set = new Set(prev)\r\n          if (data.id) set.add(data.id)\r\n          return Array.from(set)\r\n        })\r\n      } else if (data.type === 'chat') {\r\n        const isSelf = !!(data.from && selfId && data.from === selfId)\r\n        const label = isSelf ? (user?.username || 'me') : (data.from || 'peer')\r\n        const idKey = String(data.from || '')\r\n        // Skip messages from blocked senders (only applies to non-self)\r\n        if (!isSelf && idKey && blocklist.isBlocked(idKey)) return\r\n        // De-dupe if this is our own recently-sent quick message already appended locally\r\n        if (isSelf && lastSentChatRef.current && String(data.message||'') === lastSentChatRef.current.text) {\r\n          // Clear marker and do not append again\r\n          lastSentChatRef.current = null\r\n          return\r\n        }\r\n        setChat(prev => [...prev, { from: label, message: data.message, fromId: idKey || undefined }])\r\n      } else if (data.type === 'matches') {\r\n        setLobby(Array.isArray(data.matches) ? data.matches : [])\r\n      } else if (data.type === 'invite') {\r\n        setPendingInvite({ matchId: data.matchId, fromId: data.fromId, fromName: data.fromName, calibrated: !!data.calibrated, boardPreview: data.boardPreview || null, game: data.game, mode: data.mode, value: data.value, startingScore: data.startingScore })\r\n      } else if (data.type === 'match-prestart') {\r\n        // Received prestart: show pregame stats and start prestart countdown\r\n        setRoomId(data.roomId)\r\n        setPrestartRoomId(data.roomId)\r\n        setPrestartEndsAt(Number(data.prestartEndsAt) || (Date.now() + 15000))\r\n        setShowStartShowcase(true)\r\n        setShowCreate(false)\r\n        try {\r\n          // Populate the local match players with minimal details so prestart stats can show\r\n          const creatorName = (data.match && data.match.creatorName) ? data.match.creatorName : (match.players?.[0]?.name || 'Host')\r\n          const guestName = (pendingInvite && pendingInvite.fromName) ? pendingInvite.fromName : 'Opponent'\r\n          const players = [{ id: '0', name: creatorName, legsWon: 0, legs: [] }, { id: '1', name: guestName, legsWon: 0, legs: [] }]\r\n          match.importState({ roomId: data.roomId, players, currentPlayerIdx: 0, startingScore: data.match?.startingScore || 501, inProgress: false })\r\n        } catch (e) {\r\n          console.warn('Failed to seed prestart match players', e)\r\n        }\r\n      } else if (data.type === 'match-start') {\r\n        // Both parties received a room id to join\r\n        setRoomId(data.roomId)\r\n        // Auto-join the room\r\n        ws.send(JSON.stringify({ type: 'join', roomId: data.roomId }))\r\n        setShowMatchModal(true)\r\n        setShowCreate(false)\r\n        if (data.match?.game) setCurrentGame(data.match.game)\r\n        // Consume a free game for non-premium users\r\n        if (user?.username && !user?.fullAccess) {\r\n          incOnlineUsage(user.username)\r\n        }\r\n      } else if (data.type === 'declined') {\r\n        toast('Invite declined', { type: 'info' })\r\n      } else if (data.type === 'error') {\r\n        const msg = typeof data.message === 'string' ? data.message : 'Action not allowed'\r\n        setErrorMsg(msg)\r\n        if (data.code === 'SPECTATE_NOT_ALLOWED') {\r\n          try { toast('This player has spectating turned off.', { type: 'error' }) } catch {}\r\n        }\r\n        if (data.code === 'NOT_FOUND' && lastJoinIntent) {\r\n          setOfferNewRoom({\r\n            game: lastJoinIntent.game,\r\n            mode: lastJoinIntent.mode,\r\n            value: lastJoinIntent.value,\r\n            startingScore: lastJoinIntent.startingScore,\r\n          })\r\n        }\r\n        // auto-clear after a bit\r\n        setTimeout(()=>setErrorMsg(''), 3500)\r\n      } else if (data.type === 'friend-invite') {\r\n        const accept = confirm(`${data.fromName || data.fromEmail} invited you to play ${data.game || 'X01'} (${data.mode==='firstto'?'First To':'Best Of'} ${data.value||1}). Accept?`)\r\n        if (accept) {\r\n          ws.send(JSON.stringify({ type: 'start-friend-match', toEmail: data.fromEmail, game: data.game, mode: data.mode, value: data.value, startingScore: data.startingScore }))\r\n        } else {\r\n          toast('Invite declined', { type: 'info' })\r\n        }\r\n      } else if (data.type === 'friend-message') {\r\n        msgs.add({ id: data.id || `${data.ts}-${data.from}`, from: data.from, message: data.message, ts: data.ts || Date.now() })\r\n        // Show toast only if not currently in a game\r\n        if (!match.inProgress) toast(`${data.from}: ${data.message}`, { type: 'info' })\r\n      } else if (data.type === 'celebration') {\r\n        const who = data.by || 'Player'\r\n        const kind = data.kind === 'leg' ? 'leg' : '180'\r\n        triggerCelebration(kind, who)\r\n      } else if (data.type === 'cam-code') {\r\n            console.log('Received cam-code:', data.code)\r\n            setPairingCode(data.code)\r\n      setPairingPending(false)\r\n      try { if (pairingPendingTimeoutRef.current) window.clearTimeout(pairingPendingTimeoutRef.current) } catch {}\r\n            // expiry (2 minutes)\r\n            const expiryMs = 120 * 1000\r\n            const at = Date.now() + expiryMs\r\n            setPairingExpiryAt(at)\r\n            toast(`Pairing code: ${data.code}`, { type: 'info' })\r\n            // start countdown interval (clears any existing)\r\n            try { if (pairingTimerRef.current) window.clearInterval(pairingTimerRef.current) } catch {}\r\n            pairingTimerRef.current = window.setInterval(() => {\r\n              const rem = Math.max(0, Math.ceil((at - Date.now()) / 1000))\r\n              setPairCountdown(rem)\r\n              if (rem <= 0) {\r\n                try { if (pairingTimerRef.current) window.clearInterval(pairingTimerRef.current) } catch {}\r\n                pairingTimerRef.current = null\r\n                setPairingCode(null)\r\n                setPairingExpiryAt(null)\r\n              }\r\n            }, 1000) as unknown as number\r\n      } else if (data.type === 'prestart-choice-notify') {\r\n        // data: { roomId, playerId, choice }\r\n        setPrestartChoices(prev => ({ ...prev, [String(data.playerId)]: data.choice }))\r\n      } else if (data.type === 'prestart-bull') {\r\n        setPrestartBullActive(true)\r\n      } else if (data.type === 'prestart-bull-tie') {\r\n        setPrestartBullTie(true)\r\n      } else if (data.type === 'prestart-bull-winner') {\r\n        setPrestartBullActive(false)\r\n        setPrestartBullTie(false)\r\n        try { toast(`${data.winnerId ? data.winnerId : 'Player'} wins bull-up`) } catch {}\r\n        // Use voice caller to announce (try/catch optional)\r\n        try { if (callerEnabled) sayScore(data.winnerId?.toString() || 'Player', 0, 0, callerVoice, { volume: callerVolume }) } catch {}\r\n      } else if (data.type === 'cam-peer-joined') {\r\n        console.log('Mobile peer joined for code:', data.code)\r\n        // Mobile camera connected, start WebRTC\r\n        startMobileWebRTC(data.code)\r\n      } else if (data.type === 'cam-answer') {\r\n        console.log('Received cam-answer')\r\n        const pc = (window as any).mobilePC\r\n        if (pc) pc.setRemoteDescription(new RTCSessionDescription(data.payload))\r\n      } else if (data.type === 'cam-ice') {\r\n        console.log('Received cam-ice')\r\n        const pc = (window as any).mobilePC\r\n        if (pc) pc.addIceCandidate(data.payload)\r\n      }\r\n    }\r\n    ws.onclose = () => {\r\n      setConnected(false)\r\n      // Auto-reconnect with exponential backoff\r\n      if (!shouldReconnectRef.current) return\r\n      const attempt = (reconnectAttemptsRef.current || 0) + 1\r\n      reconnectAttemptsRef.current = attempt\r\n      const delay = Math.min(30000, 1000 * Math.pow(2, attempt - 1))\r\n      const now = Date.now()\r\n      if (now - lastToastRef.current > 4000) {\r\n        toast(`Disconnected. Reconnecting in ${Math.round(delay/1000)}s...`, { type: 'error' })\r\n        lastToastRef.current = now\r\n      }\r\n      if (reconnectTimerRef.current) clearTimeout(reconnectTimerRef.current)\r\n      reconnectTimerRef.current = setTimeout(() => {\r\n        connect()\r\n      }, delay)\r\n    }\r\n  }\r\n  // Small helper to render the match summary card\r\n  function RenderMatchSummary() {\r\n    const players = match.players || []\r\n    const curIdx = match.currentPlayerIdx || 0\r\n    const cur = players[curIdx]\r\n    const leg = cur?.legs?.[cur?.legs?.length - 1]\r\n    const remaining = leg ? leg.totalScoreRemaining : match.startingScore\r\n    // TV-style 3-dart average: sum points across all legs / total darts * 3\r\n    const totals = (() => {\r\n      let pts = 0, darts = 0\r\n      if (cur?.legs) {\r\n        for (const L of cur.legs) {\r\n          // Points: sum of scored points this leg\r\n          pts += (L.totalScoreStart - L.totalScoreRemaining)\r\n          // Darts: sum visits darts, subtract pre-open darts (Double-In) if any\r\n          const legDarts = (L.visits || []).reduce((a, v) => a + (v.darts || 0) - (v.preOpenDarts || 0), 0)\r\n          darts += legDarts\r\n        }\r\n      }\r\n      return { pts, darts }\r\n    })()\r\n    const avg3 = totals.darts > 0 ? ((totals.pts / totals.darts) * 3) : 0\r\n    const lastScore = leg?.visits?.[leg.visits.length-1]?.score ?? 0\r\n    let matchScore = 'ÔÇö'\r\n    if (players.length === 2) {\r\n      matchScore = `${players[0]?.legsWon || 0}-${players[1]?.legsWon || 0}`\r\n    } else if (players.length > 2) {\r\n      matchScore = players.map(p => `${p.name}:${p.legsWon||0}`).join(' = ')\r\n    }\r\n    const best = match.bestLegThisMatch\r\n    const bestText = best ? `${best.darts} darts${(() => { const p = players.find(x=>x.id===best.playerId); return p?` (${p.name})`:'' })()}` : '-'\r\n    \r\n    // Text size classes\r\n    const getTextSizeClasses = (size: string) => {\r\n      switch (size) {\r\n        case 'small': return 'text-xs'\r\n        case 'large': return 'text-base'\r\n        default: return 'text-sm'\r\n      }\r\n    }\r\n    const textSizeClass = getTextSizeClasses(textSize)\r\n    \r\n    // Box size classes\r\n    const getBoxSizeClasses = (size: string) => {\r\n      switch (size) {\r\n        case 'small': return 'p-2'\r\n        case 'large': return 'p-4'\r\n        default: return 'p-3'\r\n      }\r\n    }\r\n    const boxSizeClass = getBoxSizeClasses(boxSize)\r\n    \r\n    return (\r\n      <div className={`${boxSizeClass} rounded-2xl bg-slate-900/40 border border-white/10 text-white ${textSizeClass}`}>\r\n        <div className=\"font-semibold mb-2\">Match Summary</div>\r\n        <div className=\"grid grid-cols-2 gap-y-1\">\r\n          <div className=\"opacity-80\">Current score</div>\r\n          <div className=\"font-mono text-right\">{matchScore}</div>\r\n          <div className=\"opacity-80\">Current thrower</div>\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n  function addDpValue(dart: number) {\r\n    const hit = isDoubleHit(dart, dpIndex)\r\n    if (hit) {\r\n      const newHits = dpHits + 1\r\n      const nextIdx = dpIndex + 1\r\n      setDpHits(newHits)\r\n      setDpIndex(nextIdx)\r\n      // Celebrate completion locally\r\n      try {\r\n        if (newHits >= DOUBLE_PRACTICE_ORDER.length) {\r\n          const who = match.players[match.currentPlayerIdx]?.name || 'Player'\r\n          triggerCelebration('leg', who)\r\n          // Reset for another round\r\n          setDpHits(0)\r\n          setDpIndex(0)\r\n        }\r\n      } catch {}\r\n    }\r\n    // Sync to peers\r\n    sendState()\r\n  }\r\n  function addDpNumeric() {\r\n    const v = Math.max(0, Math.floor(visitScore|0))\r\n    addDpValue(v)\r\n    setVisitScore(0)\r\n  }\r\n  function addDpManual() {\r\n    const val = parseManualDart(dpManual)\r\n    if (val == null) return\r\n    addDpValue(val)\r\n    setDpManual('')\r\n  }\r\n\r\n  // Around the Clock handlers\r\n  function isAtcHit(val: number, ring?: 'MISS'|'SINGLE'|'DOUBLE'|'TRIPLE'|'BULL'|'INNER_BULL', sector?: number | null) {\r\n    const target = ATC_ORDER[atcIndex]\r\n    if (target == null) return false\r\n    if (typeof sector === 'number' && sector >= 1 && sector <= 20) {\r\n      if (sector === target && (ring === 'SINGLE' || ring === 'DOUBLE' || ring === 'TRIPLE')) return true\r\n    }\r\n    if (target === 25) {\r\n      return ring === 'BULL' || val === 25\r\n    }\r\n    if (target === 50) {\r\n      return ring === 'INNER_BULL' || val === 50\r\n    }\r\n    return val === target || val === target * 2 || val === target * 3\r\n  }\r\n  function addAtcValue(val: number, ring?: 'MISS'|'SINGLE'|'DOUBLE'|'TRIPLE'|'BULL'|'INNER_BULL', sector?: number | null) {\r\n    if (isAtcHit(val, ring, sector)) {\r\n      const newHits = atcHits + 1\r\n      const nextIdx = atcIndex + 1\r\n      setAtcHits(newHits)\r\n      setAtcIndex(nextIdx)\r\n      try {\r\n        if (newHits >= ATC_ORDER.length) {\r\n          const who = match.players[match.currentPlayerIdx]?.name || 'Player'\r\n          triggerCelebration('leg', who)\r\n          setAtcHits(0)\r\n          setAtcIndex(0)\r\n        }\r\n      } catch {}\r\n    }\r\n    sendState()\r\n  }\r\n  function addAtcNumeric() {\r\n    const v = Math.max(0, Math.floor(visitScore|0))\r\n    addAtcValue(v)\r\n    setVisitScore(0)\r\n  }\r\n  function addAtcManual() {\r\n    const val = parseManualDart(atcManual)\r\n    if (val == null) return\r\n    addAtcValue(val)\r\n    setAtcManual('')\r\n  }\r\n\r\n  // Treble Practice handlers\r\n  function addTrebleValue(value: number, ring?: 'SINGLE'|'DOUBLE'|'TRIPLE'|'BULL'|'INNER_BULL', sector?: number | null) {\r\n    // Stop counting beyond configured throws\r\n    if (trebleMaxDarts > 0 && trebleDarts >= trebleMaxDarts) return\r\n    const hit = (ring === 'TRIPLE' && sector === trebleTarget) || (!ring && value === trebleTarget * 3)\r\n    if (hit) setTrebleHits(h => h + 1)\r\n    setTrebleDarts(d => {\r\n      const nd = d + 1\r\n      // Auto-rotate T20→T19→T18 every 3 darts\r\n      if (nd % 3 === 0 && [20,19,18].includes(trebleTarget)) {\r\n        const cycle = [20,19,18]\r\n        const idx = cycle.indexOf(trebleTarget)\r\n        const next = cycle[(idx + 1) % cycle.length]\r\n        setTrebleTarget(next)\r\n      }\r\n      return nd\r\n    })\r\n    sendState()\r\n  }\r\n  function addTrebleNumeric() {\r\n    const v = Math.max(0, Math.floor(visitScore|0))\r\n    // No ring info, rely on numeric value only\r\n    addTrebleValue(v)\r\n    setVisitScore(0)\r\n  }\r\n  function addTrebleManual() {\r\n    const val = parseManualDart(trebleManual)\r\n    if (val == null) return\r\n    addTrebleValue(val)\r\n    setTrebleManual('')\r\n  }\r\n  function resetTreble() { setTrebleHits(0); setTrebleDarts(0) }\r\n\r\n  // Helpers for premium modes\r\n  function currentPlayerId(): string {\r\n    const p = match.players[match.currentPlayerIdx]\r\n    return p?.id ?? String(match.currentPlayerIdx)\r\n  }\r\n  // Ensure state exists for a given player id\r\n  function ensureCricket(pid: string) {\r\n    if (!cricketById[pid]) setCricketById(s => ({ ...s, [pid]: createCricketState() }))\r\n  }\r\n  function ensureShanghai(pid: string) {\r\n    if (!shanghaiById[pid]) setShanghaiById(s => ({ ...s, [pid]: createShanghaiState() }))\r\n  }\r\n  function ensureHalve(pid: string) {\r\n    if (!halveById[pid]) setHalveById(s => ({ ...s, [pid]: createDefaultHalveIt() }))\r\n  }\r\n  function ensureHighLow(pid: string) {\r\n    if (!highlowById[pid]) setHighlowById(s => ({ ...s, [pid]: createHighLow() }))\r\n  }\r\n  function ensureKiller(pid: string) {\r\n    if (!killerById[pid]) {\r\n      // If any existing assignments, pick the highest density or default to pid index\r\n      const used = new Set<number>(Object.values(killerById || {}).map(s => s.number))\r\n      const pool: number[] = []\r\n      for (let i=1;i<=20;i++){ if (!used.has(i)) pool.push(i) }\r\n      const num = pool.length>0 ? pool[Math.floor(Math.random()*pool.length)] : 20\r\n      setKillerById(s => ({ ...s, [pid]: createKillerState(num, 3) }))\r\n    }\r\n  }\r\n  function ensureAmCricket(pid: string) {\r\n    if (!amCricketById[pid]) setAmCricketById(s => ({ ...s, [pid]: createAmCricketState() }))\r\n  }\r\n  function ensureBaseball(pid: string) {\r\n    if (!baseballById[pid]) setBaseballById(s => ({ ...s, [pid]: createBaseball() }))\r\n  }\r\n  function ensureGolf(pid: string) {\r\n    if (!golfById[pid]) setGolfById(s => ({ ...s, [pid]: createGolf() }))\r\n  }\r\n  // Resets darts count on player change for non-X01 games\r\n  useEffect(() => { setTurnDarts(0) }, [match.currentPlayerIdx, currentGame])\r\n\r\n  // Compute whether all opponents have closed a cricket number\r\n  function allOpponentsClosed(num: 15|16|17|18|19|20|25, selfId: string): boolean {\r\n    const opps = match.players.filter(p => p.id !== selfId)\r\n    if (opps.length === 0) return false\r\n    return opps.every(p => (cricketById[p.id]?.marks?.[num] || 0) >= 3)\r\n  }\r\n\r\n  function applyCricketAuto(value: number, ring?: 'SINGLE'|'DOUBLE'|'TRIPLE'|'BULL'|'INNER_BULL', sector?: number | null) {\r\n    const pid = currentPlayerId()\r\n    ensureCricket(pid)\r\n    setCricketById(prev => {\r\n      const copy = { ...prev }\r\n      const st = { ...(copy[pid] || createCricketState()) }\r\n      const pts = applyCricketDart(st, value, ring, sector, (n)=>allOpponentsClosed(n, pid))\r\n      copy[pid] = st\r\n      return copy\r\n    })\r\n    const nd = turnDarts + 1\r\n    setTurnDarts(nd)\r\n    if (nd >= 3) {\r\n      setAwaitingDartRemoval(true)\r\n      // Start 10s timer for auto-switch\r\n      if (dartRemovalTimerRef.current) clearTimeout(dartRemovalTimerRef.current)\r\n      dartRemovalTimerRef.current = setTimeout(() => {\r\n        setAwaitingDartRemoval(false)\r\n        setTurnDarts(0)\r\n        match.nextPlayer(); sendState()\r\n      }, 10000)\r\n    } else { sendState() }\r\n  }\r\n\r\n  function applyShanghaiAuto(value: number, ring?: 'SINGLE'|'DOUBLE'|'TRIPLE'|'BULL'|'INNER_BULL', sector?: number | null) {\r\n    const pid = currentPlayerId()\r\n    ensureShanghai(pid)\r\n    setShanghaiById(prev => {\r\n      const copy = { ...prev }\r\n      const st = { ...(copy[pid] || createShanghaiState()) }\r\n      applyShanghaiDart(st, value, ring, sector)\r\n      copy[pid] = st\r\n      return copy\r\n    })\r\n    const nd = turnDarts + 1\r\n    setTurnDarts(nd)\r\n    if (nd >= 3) {\r\n      setAwaitingDartRemoval(true)\r\n      if (dartRemovalTimerRef.current) clearTimeout(dartRemovalTimerRef.current)\r\n      dartRemovalTimerRef.current = setTimeout(() => {\r\n        setAwaitingDartRemoval(false)\r\n        setTurnDarts(0)\r\n        setShanghaiById(prev => {\r\n          const copy = { ...prev }\r\n          const st = { ...(copy[pid] || createShanghaiState()) }\r\n          endShanghaiTurn(st)\r\n          copy[pid] = st\r\n          return copy\r\n        })\r\n        match.nextPlayer(); sendState()\r\n      }, 10000)\r\n    } else { sendState() }\r\n  }\r\n\r\n  function applyHalveAuto(value: number, ring?: 'SINGLE'|'DOUBLE'|'TRIPLE'|'BULL'|'INNER_BULL', sector?: number | null) {\r\n    const pid = currentPlayerId()\r\n    ensureHalve(pid)\r\n    setHalveById(prev => {\r\n      const copy = { ...prev }\r\n      const st = { ...(copy[pid] || createDefaultHalveIt()) }\r\n      applyHalveItDart(st, value, ring, sector)\r\n      copy[pid] = st\r\n      return copy\r\n    })\r\n    const nd = turnDarts + 1\r\n    setTurnDarts(nd)\r\n    if (nd >= 3) {\r\n      setAwaitingDartRemoval(true)\r\n      if (dartRemovalTimerRef.current) clearTimeout(dartRemovalTimerRef.current)\r\n      dartRemovalTimerRef.current = setTimeout(() => {\r\n        setAwaitingDartRemoval(false)\r\n        setTurnDarts(0)\r\n        setHalveById(prev => {\r\n          const copy = { ...prev }\r\n          const st = { ...(copy[pid] || createDefaultHalveIt()) }\r\n          endHalveItTurn(st)\r\n          copy[pid] = st\r\n          return copy\r\n        })\r\n        match.nextPlayer(); sendState()\r\n      }, 10000)\r\n    } else { sendState() }\r\n  }\r\n\r\n  function applyHighLowAuto(value: number, ring?: 'SINGLE'|'DOUBLE'|'TRIPLE'|'BULL'|'INNER_BULL', sector?: number | null) {\r\n    const pid = currentPlayerId()\r\n    ensureHighLow(pid)\r\n    setHighlowById(prev => {\r\n      const copy = { ...prev }\r\n      const st = { ...(copy[pid] || createHighLow()) }\r\n      applyHighLowDart(st, value, ring, sector)\r\n      copy[pid] = st\r\n      return copy\r\n    })\r\n    const nd = turnDarts + 1\r\n    setTurnDarts(nd)\r\n    if (nd >= 3) {\r\n      setAwaitingDartRemoval(true)\r\n      if (dartRemovalTimerRef.current) clearTimeout(dartRemovalTimerRef.current)\r\n      dartRemovalTimerRef.current = setTimeout(() => {\r\n        setAwaitingDartRemoval(false)\r\n        setTurnDarts(0)\r\n        setHighlowById(prev => {\r\n          const copy = { ...prev }\r\n          const st = { ...(copy[pid] || createHighLow()) }\r\n          endHighLowTurn(st)\r\n          copy[pid] = st\r\n          return copy\r\n        })\r\n        match.nextPlayer(); sendState()\r\n      }, 10000)\r\n    } else { sendState() }\r\n  }\r\n\r\n  function applyKillerAuto(ring?: 'SINGLE'|'DOUBLE'|'TRIPLE'|'BULL'|'INNER_BULL', sector?: number | null) {\r\n    const pid = currentPlayerId()\r\n    // Ensure every player has an assignment before applying\r\n    match.players.forEach(p => ensureKiller(p.id))\r\n    setKillerById(prev => {\r\n      const copy: Record<string, ReturnType<typeof createKillerState>> = {}\r\n      for (const [id, st] of Object.entries(prev)) copy[id] = { ...st }\r\n      const res = applyKillerDart(pid, copy, ring, sector)\r\n      // Trigger simple winner check\r\n      const win = killerWinner(copy)\r\n      if (win) {\r\n        try { triggerCelebration('leg', match.players.find(p=>p.id===win)?.name || 'Player') } catch {}\r\n      }\r\n      return copy\r\n    })\r\n    const nd = turnDarts + 1\r\n    setTurnDarts(nd)\r\n    if (nd >= 3) {\r\n      setAwaitingDartRemoval(true)\r\n      if (dartRemovalTimerRef.current) clearTimeout(dartRemovalTimerRef.current)\r\n      dartRemovalTimerRef.current = setTimeout(() => {\r\n        setAwaitingDartRemoval(false)\r\n        setTurnDarts(0)\r\n        match.nextPlayer(); sendState()\r\n      }, 10000)\r\n    } else { sendState() }\r\n  }\r\n\r\n  function applyAmCricketAuto(value: number, ring?: 'SINGLE'|'DOUBLE'|'TRIPLE'|'BULL'|'INNER_BULL', sector?: number | null) {\r\n    const pid = currentPlayerId()\r\n    ensureAmCricket(pid)\r\n    setAmCricketById(prev => {\r\n      const copy = { ...prev }\r\n      const base = (copy[pid] || createAmCricketState())\r\n      const st: ReturnType<typeof createAmCricketState> = { ...(base as any) }\r\n      const oppClosed = (n: 12|13|14|15|16|17|18|19|20|25) => match.players.filter(p=>p.id!==pid).every(p => (((amCricketById[p.id]?.marks as any)?.[n]||0) >= 3))\r\n      applyAmCricketDart(st, value, ring, sector, oppClosed)\r\n      copy[pid] = st\r\n      return copy\r\n    })\r\n    const nd = turnDarts + 1\r\n    setTurnDarts(nd)\r\n    if (nd >= 3) {\r\n      setAwaitingDartRemoval(true)\r\n      if (dartRemovalTimerRef.current) clearTimeout(dartRemovalTimerRef.current)\r\n      dartRemovalTimerRef.current = setTimeout(() => {\r\n        setAwaitingDartRemoval(false)\r\n        setTurnDarts(0)\r\n        match.nextPlayer(); sendState()\r\n      }, 10000)\r\n    } else { sendState() }\r\n  }\r\n\r\n  function applyBaseballAuto(value: number, ring?: 'SINGLE'|'DOUBLE'|'TRIPLE', sector?: number | null) {\r\n    const pid = currentPlayerId()\r\n    ensureBaseball(pid)\r\n    setBaseballById(prev => {\r\n      const copy = { ...prev }\r\n      const st = { ...(copy[pid] || createBaseball()) }\r\n      applyBaseballDart(st, value, ring as any, sector)\r\n      copy[pid] = st\r\n      return copy\r\n    })\r\n    const nd = turnDarts + 1\r\n    setTurnDarts(nd)\r\n    if (nd >= 3) {\r\n      setAwaitingDartRemoval(true)\r\n      if (dartRemovalTimerRef.current) clearTimeout(dartRemovalTimerRef.current)\r\n      dartRemovalTimerRef.current = setTimeout(() => {\r\n        setAwaitingDartRemoval(false)\r\n        setTurnDarts(0)\r\n        match.nextPlayer(); sendState()\r\n      }, 10000)\r\n    } else { sendState() }\r\n  }\r\n\r\n  function applyGolfAuto(value: number, ring?: 'SINGLE'|'DOUBLE'|'TRIPLE', sector?: number | null) {\r\n    const pid = currentPlayerId()\r\n    ensureGolf(pid)\r\n    setGolfById(prev => {\r\n      const copy = { ...prev }\r\n      const st = { ...(copy[pid] || createGolf()) }\r\n      applyGolfDart(st, value, ring as any, sector)\r\n      copy[pid] = st\r\n      return copy\r\n    })\r\n    const nd = turnDarts + 1\r\n    setTurnDarts(nd)\r\n    if (nd >= 3) {\r\n      setAwaitingDartRemoval(true)\r\n      if (dartRemovalTimerRef.current) clearTimeout(dartRemovalTimerRef.current)\r\n      dartRemovalTimerRef.current = setTimeout(() => {\r\n        setAwaitingDartRemoval(false)\r\n        setTurnDarts(0)\r\n        match.nextPlayer(); sendState()\r\n      }, 10000)\r\n    } else { sendState() }\r\n  }\r\n\r\n  function applyTttAuto(cell: number, value: number, ring?: 'SINGLE'|'DOUBLE'|'TRIPLE'|'BULL'|'INNER_BULL', sector?: number | null) {\r\n    setTTT(prev => {\r\n      const cp = { ...prev, board: [...prev.board] as any }\r\n      tryClaimCell(cp as any, (cell as any), value, ring as any, sector)\r\n      return cp as any\r\n    })\r\n    const nd = turnDarts + 1\r\n    setTurnDarts(nd)\r\n    if (nd >= 3) {\r\n      setAwaitingDartRemoval(true)\r\n      if (dartRemovalTimerRef.current) clearTimeout(dartRemovalTimerRef.current)\r\n      dartRemovalTimerRef.current = setTimeout(() => {\r\n        setAwaitingDartRemoval(false)\r\n        setTurnDarts(0)\r\n        match.nextPlayer(); sendState()\r\n      }, 10000)\r\n    } else { sendState() }\r\n  }\r\n  // Listen for dart removal event from CameraView\r\n  useEffect(() => {\r\n    function onDartsCleared() {\r\n      if (awaitingDartRemoval) {\r\n        setAwaitingDartRemoval(false)\r\n        setTurnDarts(0)\r\n        // End turn logic (advance player, send state)\r\n        match.nextPlayer(); sendState()\r\n        if (dartRemovalTimerRef.current) clearTimeout(dartRemovalTimerRef.current)\r\n      }\r\n    }\r\n    window.addEventListener('ndn:darts-cleared', onDartsCleared)\r\n    return () => window.removeEventListener('ndn:darts-cleared', onDartsCleared)\r\n  }, [awaitingDartRemoval])\r\n\r\n  // (Manual finalize removed — use camera auto-detect / server-driven events)\r\n\r\n  // Open/close Manual Correction dialog in CameraView\r\n  function openManual() { try { window.dispatchEvent(new Event('ndn:open-manual' as any)) } catch {} }\r\n  function closeManual() { try { window.dispatchEvent(new Event('ndn:close-manual' as any)) } catch {} }\r\n\r\n  // Helper to submit a manual visit with shared logic\r\n  function submitVisitManual(v: number) {\r\n    const score = Math.max(0, v | 0)\r\n    // Estimate double-out attempts and finish for manual numeric entry\r\n    try {\r\n      const p = match.players[match.currentPlayerIdx]\r\n      const leg = p?.legs?.[p.legs.length - 1]\r\n      const preRem = leg ? leg.totalScoreRemaining : match.startingScore\r\n      const postRem = Math.max(0, preRem - score)\r\n      const attempts = preRem <= 50 ? 3 : (postRem <= 50 ? 1 : 0)\r\n      const finished = postRem === 0\r\n      match.addVisit(score, 3, { preOpenDarts: 0, doubleWindowDarts: attempts, finishedByDouble: finished, visitTotal: score })\r\n    } catch {\r\n      match.addVisit(score, 3)\r\n    }\r\n    setVisitScore(0)\r\n    const p = match.players[match.currentPlayerIdx]\r\n    const leg = p.legs[p.legs.length - 1]\r\n    // Instant celebration locally\r\n    try {\r\n      if (score === 180) triggerCelebration('180', p?.name || 'Player')\r\n      if (leg && leg.totalScoreRemaining === 0) triggerCelebration('leg', p?.name || 'Player')\r\n    } catch {}\r\n    if (leg && leg.totalScoreRemaining === 0) { match.endLeg(score) } else { match.nextPlayer() }\r\n    if (callerEnabled) {\r\n      const rem = leg ? leg.totalScoreRemaining : match.startingScore\r\n      sayScore(user?.username || 'Player', score, Math.max(0, rem), callerVoice, { volume: callerVolume, checkoutOnly: speakCheckoutOnly })\r\n    }\r\n    if (user?.username && p?.name === user.username) { addSample(user.username, 3, score) }\r\n    sendState()\r\n  }\r\n\r\n  function reportMessage(offenderId: string | null, text: string) {\r\n    const payload: any = { type: 'report', offenderId, reason: 'Inappropriate language', message: text }\r\n    try { if (wsGlobal) wsGlobal.send(payload); else wsRef.current?.send(JSON.stringify(payload)) } catch {}\r\n    try { toast('Report submitted', { type: 'info' }) } catch {}\r\n  }\r\n\r\n  function sendPrestartChoice(choice: 'bull'|'skip') {\r\n    const r = prestartRoomId || roomId\r\n    if (!r) return\r\n    const payload: any = { type: 'prestart-choice', roomId: r, choice }\r\n    try { if (wsGlobal) wsGlobal.send(payload); else wsRef.current?.send(JSON.stringify(payload)) } catch {}\r\n  }\r\n\r\n  function sendPrestartBullThrow(score: number) {\r\n    const r = prestartRoomId || roomId\r\n    if (!r) return\r\n    try { if (wsGlobal) wsGlobal.send({ type: 'prestart-bull-throw', roomId: r, score }) ; else wsRef.current?.send(JSON.stringify({ type: 'prestart-bull-throw', roomId: r, score })) } catch {}\r\n  }\r\n\r\n  function isMobileLike() {\r\n    if (typeof navigator === 'undefined') return false\r\n    const ua = navigator.userAgent || ''\r\n    return /Android|iPhone|iPad|iPod|Mobile/i.test(ua)\r\n  }\r\n\r\n  // Try to take a quick camera snapshot to show to the match creator (non-blocking)\r\n  async function getBoardPreview(): Promise<string | null> {\r\n    try {\r\n      const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false })\r\n      const track = stream.getVideoTracks?.()[0]\r\n      // Create a hidden video element to draw a frame\r\n      const video = document.createElement('video')\r\n      video.srcObject = stream\r\n      await video.play().catch(()=>{})\r\n      // Wait a moment for first frame\r\n      await new Promise(r => setTimeout(r, 120))\r\n      const w = Math.min(320, video.videoWidth || 320)\r\n      const h = Math.max(1, Math.floor((video.videoHeight || 180) * (w / Math.max(1, video.videoWidth || 320))))\r\n      const canvas = document.createElement('canvas')\r\n      canvas.width = w; canvas.height = h\r\n      const ctx = canvas.getContext('2d')!\r\n      ctx.drawImage(video, 0, 0, w, h)\r\n      const url = canvas.toDataURL('image/jpeg', 0.7)\r\n      // Cleanup\r\n      try { if (track) track.stop() } catch {}\r\n      try { (stream as any).getTracks?.().forEach((t:any)=>t.stop()) } catch {}\r\n      return url\r\n    } catch {\r\n      return null\r\n    }\r\n  }\r\n\r\n  // WebRTC for mobile camera\r\n  startMobileWebRTC = async (code: string) => {\r\n    console.log('Starting WebRTC for code:', code)\r\n    try {\r\n      const pc = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] })\r\n      pc.ontrack = (event) => {\r\n        console.log('Received track:', event.streams[0])\r\n        setMobileStream(event.streams[0])\r\n        if (mobileVideoRef.current) {\r\n          mobileVideoRef.current.srcObject = event.streams[0]\r\n          console.log('Set video srcObject')\r\n        }\r\n      }\r\n      pc.onicecandidate = (event) => {\r\n        if (event.candidate) {\r\n          console.log('Sending ICE candidate')\r\n          if (wsGlobal) {\r\n            wsGlobal.send({ type: 'cam-ice', code, payload: event.candidate })\r\n          } else if (wsRef.current && wsRef.current.readyState === WebSocket.OPEN) {\r\n            wsRef.current.send(JSON.stringify({ type: 'cam-ice', code, payload: event.candidate }))\r\n          }\r\n        }\r\n      }\r\n      pc.onconnectionstatechange = () => console.log('Connection state:', pc.connectionState)\r\n      const offer = await pc.createOffer()\r\n      await pc.setLocalDescription(offer)\r\n      console.log('Sending offer')\r\n      // Try WebSocket first, otherwise fall back to REST POST\r\n      if (wsGlobal) {\r\n        console.log('Sending offer via wsGlobal')\r\n        wsGlobal.send({ type: 'cam-offer', code, payload: offer })\r\n      } else if (wsRef.current && wsRef.current.readyState === WebSocket.OPEN) {\r\n        console.log('Sending offer via wsRef')\r\n        wsRef.current.send(JSON.stringify({ type: 'cam-offer', code, payload: offer }))\r\n      } else {\r\n        console.log('WS not available, POSTing offer to /cam/signal')\r\n        try {\r\n          await apiFetch(`/cam/signal/${code}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ type: 'cam-offer', payload: offer, source: 'desktop' }) })\r\n        } catch (e) { console.warn('REST offer failed', e) }\r\n      }\r\n      // Store pc for later use\r\n      (window as any).mobilePC = pc\r\n    } catch (err) {\r\n      console.error('WebRTC error:', err)\r\n      toast('Failed to start mobile camera', { type: 'error' })\r\n    }\r\n  }\r\n\r\n  return (\r\n    <div className=\"card ndn-game-shell relative overflow-hidden\">\r\n      <h2 className=\"text-3xl font-bold text-brand-700 mb-4\">Online Play</h2>\r\n      <div className=\"ndn-shell-body\">\r\n        <div className=\"grid grid-cols-12 gap-4 min-h-[420px]\">\r\n          {/* Left column: minimal toolbar */}\r\n          <div className=\"col-span-12 md:col-span-4 flex flex-col gap-3\">\r\n            <div className=\"rounded-2xl bg-white/5 backdrop-blur border border-white/10 p-2 flex items-center gap-2\">\r\n              <div className=\"flex items-center gap-2\">\r\n                <label className=\"text-xs opacity-70 shrink-0\">Room</label>\r\n                <input className=\"input w-28\" value={roomId} onChange={e => setRoomId(e.target.value)} placeholder=\"room-1\" />\r\n              </div>\r\n              {connected ? (\r\n                <span className=\"text-[11px] px-2 py-1 rounded-full bg-emerald-600/20 text-emerald-200 border border-emerald-400/40 shrink-0\">Connected</span>\r\n              ) : (\r\n                <button className=\"btn bg-rose-600 hover:bg-rose-700 shrink-0\" onClick={connect}>Connect</button>\r\n              )}\r\n              <button className=\"btn shrink-0\" onClick={sendState} disabled={!connected}>Sync</button>\r\n            </div>\r\n            {/* Keep a small space for optional quick tools */}\r\n            <div className=\"mt-3 p-3 rounded-xl bg-indigo-500/10 border border-indigo-500/40 opacity-60 text-center text-sm\">Lobby tools</div>\r\n          </div>\r\n\r\n          {/* Center column: main area - World Lobby or Scoreboard depending on match state */}\r\n          <div className=\"col-span-12 md:col-span-4\">\r\n            {!match.inProgress ? (\r\n              <div className=\"flex flex-col gap-3\">\r\n                <div className={`p-3 rounded-2xl bg-slate-900/60 border border-white/10 p-3 text-slate-100 shadow-lg backdrop-blur-sm ${(!connected || locked) ? 'opacity-60' : ''}`} role=\"button\" title={!connected ? 'Connect to the lobby first' : (locked ? 'Weekly free games used' : 'Create a new match')} onClick={() => { if (!connected || locked) return; setShowCreate(true); if (wsGlobal) wsGlobal.send({ type: 'list-matches' }); else wsRef.current?.send(JSON.stringify({ type: 'list-matches' })) }}>\r\n                  <div className=\"flex items-center gap-3\">\r\n                    <button className=\"btn btn--primary\">Create Match +</button>\r\n                    <div className=\"text-sm opacity-80 ml-auto\">Matches: {filteredLobby.length}</div>\r\n                  </div>\r\n                </div>\r\n                <div className=\"rounded-2xl bg-slate-900/60 border border-white/10 p-3 text-slate-100 shadow-lg backdrop-blur-sm\">\r\n                  <div className=\"flex items-center justify-between mb-3\">\r\n                    <div className=\"font-semibold\">World Lobby</div>\r\n                    <div className=\"flex items-center gap-2\">\r\n                      <div className=\"text-xs opacity-80\">Matches: {filteredLobby.length}</div>\r\n                      <button className=\"btn px-3 py-1 text-sm\" onClick={()=> (wsGlobal ? wsGlobal.send({ type: 'list-matches' }) : wsRef.current?.send(JSON.stringify({ type: 'list-matches' })))}>Refresh</button>\r\n                    </div>\r\n                  </div>\r\n                  <ul className=\"space-y-2\">\r\n                    {filteredLobby.map((m:any)=> (\r\n                      <li key={m.id} className=\"p-2 rounded bg-white/3 border border-white/6 flex items-center justify-between\">\r\n                        <div className=\"text-sm\">{m.game} · {m.mode} · {m.startingScore}</div>\r\n                        <div className=\"flex items-center gap-2\">\r\n                          <div className=\"text-xs opacity-70\">{m.creator || 'host'}</div>\r\n                          <button className=\"btn btn-sm\" onClick={() => { try { const payload = { type: 'join-match', matchId: m.id, calibrated: !!calibH, boardPreview: null }; if (wsGlobal) wsGlobal.send(payload); else wsRef.current?.send(JSON.stringify(payload)); setLastJoinIntent({ game: m.game, mode: m.mode, value: m.value, startingScore: m.startingScore }); } catch {} }}>Join</button>\r\n                        </div>\r\n                      </li>\r\n                    ))}\r\n                    {filteredLobby.length === 0 && <li className=\"text-sm opacity-60\">No matches found.</li>}\r\n                  </ul>\r\n                </div>\r\n              </div>\r\n            ) : (\r\n              <div className=\"flex flex-col gap-3\">\r\n                <GameHeaderBar\r\n                  left={(\r\n                    <>\r\n                      <span className=\"hidden xs:inline px-2 py-0.5 rounded-full bg-indigo-500/20 text-indigo-200 border border-indigo-400/30 text-[10px] sm:text-xs\">Game Mode</span>\r\n                      <span className=\"font-medium whitespace-nowrap\">{currentGame}{currentGame === 'X01' ? ` / ${match.startingScore}` : ''}</span>\r\n                      <span className=\"opacity-80 whitespace-nowrap\">Players: {match.players?.length || 0}</span>\r\n                    </>\r\n                  )}\r\n                  right={(\r\n                    <>\r\n                      <button className=\"btn btn--ghost px-3 py-1 text-sm\" title={fitAll ? 'Actual Size' : 'Fit All'} onClick={() => setFitAll(v => !v)}>{fitAll ? 'Actual Size' : 'Fit All'}</button>\r\n                      <button className=\"btn btn--ghost px-3 py-1 text-sm\" title={maximized ? 'Restore' : 'Maximize'} onClick={() => setMaximized(m => !m)}>{maximized ? 'Restore' : 'Maximize'}</button>\r\n                    </>\r\n                  )}\r\n                />\r\n                <div className=\"rounded-2xl bg-slate-900/60 border border-white/10 p-3 text-slate-100 shadow-lg backdrop-blur-sm\">\r\n                  {(() => {\r\n                    const players = (match.players || []).map((p:any, i:number) => {\r\n                      const leg = p.legs?.[p.legs.length-1]\r\n                      const remaining = leg ? leg.totalScoreRemaining : match.startingScore\r\n                      const last = leg?.visits?.[leg.visits.length-1]\r\n                      return {\r\n                        name: p.name || p.id || `Player ${i+1}`,\r\n                        isCurrentTurn: (match.currentPlayerIdx || 0) === i,\r\n                        legsWon: p.legsWon || 0,\r\n                        score: remaining,\r\n                        lastScore: last?.score ?? 0,\r\n                        matchAvg: undefined,\r\n                        allTimeAvg: undefined,\r\n                      }\r\n                    })\r\n                    const matchScore = (match.players && match.players.length === 2) ? `${match.players[0]?.legsWon||0}-${match.players[1]?.legsWon||0}` : undefined\r\n                    return <GameScoreboard gameMode={(currentGame as any)} players={players} matchScore={matchScore} />\r\n                  })()}\r\n                </div>\r\n              </div>\r\n            )}\r\n          </div>\r\n\r\n          {/* Right column: camera / preview */}\r\n          <div className=\"col-span-12 md:col-span-4\">\r\n            <div className=\"rounded-2xl p-3 border border-white/10 bg-black/5 h-full min-h-[200px]\">\r\n              <div className=\"flex items-center justify-between mb-2\">\r\n                <div className=\"font-semibold\">Camera Preview</div>\r\n                <div className=\"flex items-center gap-2\">\r\n                  {/* Pairing UI intentionally removed per request (helpers remain). */}\r\n                </div>\r\n              </div>\r\n              {/* Pairing code UI removed; pairing still supported via Calibrator and server flows */}\r\n              {(match.inProgress || (prestartEndsAt && prestartTimeLeft !== null && prestartTimeLeft <= 10)) ? (\r\n                <CameraView />\r\n              ) : (\r\n                <div className=\"rounded-2xl bg-slate-900/40 border border-white/10 p-4 text-slate-200 opacity-70\">\r\n                  <div className=\"font-semibold mb-2\">Camera Preview</div>\r\n                  <div className=\"text-sm\">Camera is only available while a match is in progress. Join or create a match to enable camera pairing and live preview.</div>\r\n                </div>\r\n              )}\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n  {showStartShowcase && <MatchStartShowcase players={(match.players || []) as any} user={user} initialSeconds={prestartTimeLeft ?? 15} roomId={prestartRoomId ?? roomId} onDone={() => { setShowStartShowcase(false); setPrestartRoomId(null); setPrestartEndsAt(null); setPrestartTimeLeft(null); setPrestartChoices({}); setPrestartBullActive(false); setPrestartBullTie(false); }} onChoice={(choice) => { sendPrestartChoice(choice) }} choices={prestartChoices} bullActive={prestartBullActive} onBullThrow={(score) => { sendPrestartBullThrow(score) }} />}\r\n      {pendingInvite && (\r\n        <div className=\"fixed inset-0 z-60 flex items-center justify-center bg-black/80 p-4\">\r\n          <div className=\"bg-slate-800 border border-slate-600 rounded-2xl p-6 max-w-lg w-full\">\r\n            <div className=\"text-lg font-bold mb-2\">Join Request</div>\r\n            <div className=\"opacity-80 mb-4\">{pendingInvite.fromName || 'Player'} wants to join your match ({pendingInvite.game}). Accept?</div>\r\n            <div className=\"flex items-center gap-3\">\r\n              <button className=\"btn btn-primary\" onClick={() => respondToInvite(true)}>Accept ({inviteCountdown}s)</button>\r\n              <button className=\"btn btn-ghost\" onClick={() => respondToInvite(false)}>Decline</button>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      )}\r\n    </div>\r\n  )\r\n}\r\n\r\n"],"names":["LS","load","raw","save","map","useBlocklist","create","set","get","id","s","OnlinePlay","user","toast","useToast","match","useMatch","wsGlobal","useWS","wsRef","useRef","startMobileWebRTC","blocklist","sendState","roomId","setRoomId","useState","connected","setConnected","chat","setChat","showQuick","setShowQuick","showMessages","setShowMessages","lastSentChatRef","selfId","setSelfId","reconnectAttemptsRef","reconnectTimerRef","shouldReconnectRef","lastToastRef","firstConnectDoneRef","msgs","useMessages","favoriteDouble","callerEnabled","callerVoice","callerVolume","speakCheckoutOnly","allowSpectate","cameraScale","setCameraScale","cameraFitMode","setCameraFitMode","cameraEnabled","textSize","boxSize","autoscoreProvider","matchType","setMatchType","teamAName","setTeamAName","teamBName","setTeamBName","defaultX01DoubleIn","useUserSettings","useEffect","cameraColSpan","setCameraColSpan","showMatchModal","setShowMatchModal","participants","setParticipants","maximized","setMaximized","fitAll","setFitAll","fitScale","setFitScale","turnIdx","setTurnIdx","visitScore","setVisitScore","dpIndex","setDpIndex","dpHits","setDpHits","dpManual","setDpManual","atcIndex","setAtcIndex","atcHits","setAtcHits","atcManual","setAtcManual","trebleTarget","setTrebleTarget","trebleHits","setTrebleHits","trebleDarts","setTrebleDarts","trebleManual","setTrebleManual","trebleMaxDarts","setTrebleMaxDarts","x01DoubleInMatch","setX01DoubleInMatch","pairingCode","setPairingCode","pairingPending","setPairingPending","pairingExpiryAt","setPairingExpiryAt","pairingTimerRef","pairingPendingTimeoutRef","pairCountdown","setPairCountdown","highlightCandidate","setHighlightCandidate","showHighlightModal","setShowHighlightModal","mobileStream","setMobileStream","mobileVideoRef","tttManual","setTttManual","cricketById","setCricketById","shanghaiById","setShanghaiById","halveById","setHalveById","highlowById","setHighlowById","killerById","setKillerById","amCricketById","setAmCricketById","baseballById","setBaseballById","golfById","setGolfById","ttt","setTTT","createTicTacToe","turnDarts","setTurnDarts","awaitingDartRemoval","setAwaitingDartRemoval","dartRemovalTimerRef","paused","setPausedLocal","pauseRequestedBy","setPauseRequestedBy","pauseAcceptedBy","setPauseAcceptedBy","pauseEndsAt","setPauseEndsAt","pauseDurationSec","setPauseDurationSec","setPausedGlobal","useMatchControl","compactView","setCompactView","ua","showX01EndSummary","setShowX01EndSummary","endSummaryPrevRef","showStartShowcase","setShowStartShowcase","startedShowcasedRef","prestartRoomId","setPrestartRoomId","prestartEndsAt","setPrestartEndsAt","prestartTimeLeft","setPrestartTimeLeft","prestartChoices","setPrestartChoices","prestartBullActive","setPrestartBullActive","prestartBullTie","setPrestartBullTie","preTimer","prev","now","p","L","out","attempts","hits","v","celebration","setCelebration","lastCelebrationRef","audioCtxRef","ensureAudio","Ctor","beep","freq","durMs","whenS","gain","ctx","o","g","playSting","kind","triggerCelebration","who","last","showCreate","setShowCreate","lobby","setLobby","mode","setMode","modeValue","setModeValue","startScore","setStartScore","pendingInvite","setPendingInvite","inviteCountdown","setInviteCountdown","errorMsg","setErrorMsg","lastJoinIntent","setLastJoinIntent","offerNewRoom","setOfferNewRoom","game","setGame","currentGame","setCurrentGame","requireCalibration","setRequireCalibration","createTrebleMaxDarts","setCreateTrebleMaxDarts","createX01DoubleIn","setCreateX01DoubleIn","freeLeft","getFreeRemaining","locked","filterMode","setFilterMode","filterStart","setFilterStart","filterGame","setFilterGame","nearAvg","setNearAvg","avgTolerance","setAvgTolerance","calibH","useCalibration","myAvg","getAllTimeAvg","filteredLobby","m","handler","e","d","email","apiFetch","start","err","connect","onSpectate","rid","t","c","respondToInvite","accept","envUrl","proto","host","fallback","url","ws","ev","data","di","dh","ai","ah","tt","th","td","tmax","_cr","_sh","_hv","_hl","_kr","_am","_bb","_gf","_tt","_td","_di","isSelf","label","idKey","creatorName","guestName","players","incOnlineUsage","msg","expiryMs","at","rem","sayScore","pc","attempt","delay","onDartsCleared","sendPrestartChoice","choice","payload","sendPrestartBullThrow","score","code","event","offer","jsxs","jsx","GameHeaderBar","Fragment","i","leg","remaining","matchScore","GameScoreboard","CameraView","MatchStartShowcase"],"mappings":"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"}