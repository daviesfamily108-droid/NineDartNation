{"version":3,"mappings":"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AIE,EAAE,CAAC,EAAE,CAAC,EAAIF,EAAE,CAAC,EAAE,CAAC,EAAIE,EAAE,CAAC,EAAE,CAAC,EAAIF,EAAE,CAAC,EAAE,CAAC,EAAIE,EAAE,CAAC,EAAE,CAAC,EAClEN,EAAE,CAAC,EAAE,CAAC,EAAII,EAAE,CAAC,EAAE,CAAC,EAAIE,EAAE,CAAC,EAAE,CAAC,EAAIF,EAAE,CAAC,EAAE,CAAC,EAAIE,EAAE,CAAC,EAAE,CAAC,EAAIF,EAAE,CAAC,EAAE,CAAC,EAAIE,EAAE,CAAC,EAAE,CAAC,EAClEN,EAAE,CAAC,EAAE,CAAC,EAAII,EAAE,CAAC,EAAE,CAAC,EAAIE,EAAE,CAAC,EAAE,CAAC,EAAIF,EAAE,CAAC,EAAE,CAAC,EAAIE,EAAE,CAAC,EAAE,CAAC,EAAIF,EAAE,CAAC,EAAE,CAAC,EAAIE,EAAE,CAAC,EAAE,CAAC,EAClEN,EAAE,CAAC,EAAE,CAAC,EAAII,EAAE,CAAC,EAAE,CAAC,EAAIE,EAAE,CAAC,EAAE,CAAC,EAAIF,EAAE,CAAC,EAAE,CAAC,EAAIE,EAAE,CAAC,EAAE,CAAC,EAAIF,EAAE,CAAC,EAAE,CAAC,EAAIE,EAAE,CAAC,EAAE,CAAC,EAClEN,EAAE,CAAC,EAAE,CAAC,EAAII,EAAE,CAAC,EAAE,CAAC,EAAIE,EAAE,CAAC,EAAE,CAAC,EAAIF,EAAE,CAAC,EAAE,CAAC,EAAIE,EAAE,CAAC,EAAE,CAAC,EAAIF,EAAE,CAAC,EAAE,CAAC,EAAIE,EAAE,CAAC,EAAE,CAAC,EAClEN,EAAE,CAAC,EAAE,CAAC,EAAII,EAAE,CAAC,EAAE,CAAC,EAAIE,EAAE,CAAC,EAAE,CAAC,EAAIF,EAAE,CAAC,EAAE,CAAC,EAAIE,EAAE,CAAC,EAAE,CAAC,EAAIF,EAAE,CAAC,EAAE,CAAC,EAAIE,EAAE,CAAC,EAAE,CAAC,EAClEN,EAAE,CAAC,EAAE,CAAC,EAAII,EAAE,CAAC,EAAE,CAAC,EAAIE,EAAE,CAAC,EAAE,CAAC,EAAIF,EAAE,CAAC,EAAE,CAAC,EAAIE,EAAE,CAAC,EAAE,CAAC,EAAIF,EAAE,CAAC,EAAE,CAAC,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","names":["f","require$$0","k","l","m","p","q","c","a","g","b","d","e","h","reactJsxRuntime_production_min","jsxRuntimeModule","client","KEY","user","getWeekId","date","dayNum","yearStart","weekNo","week","getOnlineUsage","raw","u","currentWeek","setOnlineUsage","usage","incOnlineUsage","cap","next","getFreeRemaining","LS_KEY","getCache","setCache","email","v","fetchIsAdmin","owner","__vite_import_meta_env__","force","hit","useIsAdmin","isAdmin","setIsAdmin","useState","useEffect","on","BASE_PRICE_GBP","FX","formatPriceInCurrency","currency","gbpAmount","cur","rate","val","getUserCurrency","parts","DISCORD_INVITE_URL","cachedBaseUrl","computeApiBase","envUrl","protocol","host","hostname","sameOrigin","normalizePath","path","base","cleanPath","resolveApiUrl","apiFetch","init","url","installApiInterceptor","anyWindow","originalFetch","input","reqUrl","cloned","href","err","getTabs","baseTabs","LayoutDashboard","Users","Trophy","Camera","Settings","PoundSterling","Sidebar","active","onChange","className","tabs","t","idx","adminTab","showDiscord","setShowDiscord","showNDNDiscord","setShowNDNDiscord","freeLeft","notifications","setNotifications","fetchNotifications","requestsRes","messagesRes","requests","unreadMessages","interval","onKey","key","label","Icon","jsxs","jsx","Lock","MessageCircle","createPortal","ScrollFade","children","style","ref","useRef","raf","updateClip","wrapper","header","scroller","scrollTop","headerH","overlap","mask","onScrollOrResize","canPromise","toSJISFunction","CODEWORDS_COUNT","utils","version","data","digit","kanji","exports","fromString","string","level","value","defaultValue","BitBuffer","index","bufIndex","num","length","i","bit","bitBuffer","BitMatrix","size","row","col","reserved","bitMatrix","getSymbolSize","posCount","intervals","positions","coords","pos","posLength","j","FINDER_PATTERN_SIZE","finderPattern","PenaltyScores","points","sameCountCol","sameCountRow","lastCol","lastRow","module","last","bitsCol","bitsRow","darkCount","modulesCount","getMaskAt","maskPattern","pattern","setupFormatFunc","numPatterns","bestPattern","lowerPenalty","penalty","ECLevel","EC_BLOCKS_TABLE","EC_CODEWORDS_TABLE","errorCorrectionCode","errorCorrectionLevel","EXP_TABLE","LOG_TABLE","x","galoisField","n","y","GF","p1","p2","coeff","divident","divisor","result","offset","degree","poly","Polynomial","ReedSolomonEncoder","paddedData","remainder","start","buff","reedSolomonEncoder","versionCheck","numeric","alphanumeric","byte","regex","TEST_KANJI","TEST_NUMERIC","TEST_ALPHANUMERIC","str","VersionCheck","Regex","require$$1","mode","dataStr","Utils","ECCode","require$$2","Mode","require$$3","require$$4","G18","G18_BCH","getBestVersionForDataLength","currentVersion","getReservedBitsCount","getTotalBitsFromDataArray","segments","totalBits","reservedBits","getBestVersionForMixedData","totalCodewords","ecTotalCodewords","dataTotalCodewordsBits","usableBits","seg","ecl","G15","G15_MASK","G15_BCH","formatInfo","NumericData","group","remainingNum","numericData","ALPHA_NUM_CHARS","AlphanumericData","alphanumericData","ByteData","byteData","KanjiData","kanjiData","dijkstra","graph","s","predecessors","costs","open","closest","cost_of_s_to_u","adjacent_nodes","cost_of_e","cost_of_s_to_u_plus_cost_of_e","cost_of_s_to_v","first_visit","msg","nodes","opts","T","cost","item","require$$5","require$$6","require$$7","getStringByteLength","getSegments","getSegmentsFromString","numSegs","alphaNumSegs","byteSegs","kanjiSegs","s1","s2","obj","getSegmentBitsLength","mergeSegments","segs","acc","curr","prevSeg","buildNodes","buildGraph","table","prevNodeIds","nodeGroup","currentNodeIds","node","prevNodeId","buildSingleSegment","modesHint","bestMode","array","optimizedSegs","AlignmentPattern","FinderPattern","MaskPattern","require$$8","Version","require$$9","FormatInfo","require$$10","require$$11","Segments","require$$12","setupFinderPattern","matrix","r","setupTimingPattern","setupAlignmentPattern","setupVersionInfo","bits","mod","setupFormatInfo","setupData","inc","bitIndex","byteIndex","dark","createData","buffer","remainingByte","createCodewords","dataTotalCodewords","ecTotalBlocks","blocksInGroup2","blocksInGroup1","totalCodewordsInGroup1","dataCodewordsInGroup1","dataCodewordsInGroup2","ecCount","rs","dcData","ecData","maxDataSize","dataSize","createSymbol","estimatedVersion","rawSegments","bestVersion","dataBits","moduleCount","modules","qrcode","options","hex2rgba","hex","hexCode","hexValue","margin","width","scale","qrSize","imgData","qr","symbolSize","scaledMargin","palette","posDst","pxColor","iSrc","jSrc","clearCanvas","ctx","canvas","getCanvasElement","qrData","canvasEl","image","type","rendererOpts","getColorAttrib","color","attrib","alpha","svgCmd","cmd","qrToPath","moveBy","newRow","lineLength","svgTag","cb","qrcodesize","bg","viewBox","QRCode","CanvasRenderer","SvgRenderer","renderCanvas","renderFunc","text","args","argsNum","isLastArgCb","resolve","reject","browser","_","loadImage","src","img","composeQrWithLogo","qrDataUrl","qrImg","logoImg","w","cx","cy","logoSize","shape","pad","bx","by","bw","bh","radius","makeQrDataUrlWithLogo","logo","createStoreImpl","createState","state","listeners","setState","partial","replace","nextState","previousState","listener","getState","api","initialState","createStore","React","is","objectIs","useLayoutEffect","useDebugValue","useSyncExternalStore$2","subscribe","getSnapshot","_useState","inst","forceUpdate","checkIfSnapshotChanged","latestGetSnapshot","nextValue","useSyncExternalStore$1","shim","useSyncExternalStoreShim_production","shimModule","useSyncExternalStore","useMemo","withSelector_production","getServerSnapshot","selector","isEqual","instRef","memoizedSelector","nextSnapshot","hasMemo","memoizedSnapshot","currentSelection","memoizedSelection","nextSelection","maybeGetServerSnapshot","withSelectorModule","ReactExports","useSyncExternalStoreWithSelector","useSyncExternalStoreExports","didWarnAboutEqualityFn","identity","arg","useStore","equalityFn","slice","createImpl","useBoundStore","create","createJSONStorage","getStorage","storage","name","_a","parse","str2","newValue","toThenable","fn","onFulfilled","_onRejected","_onFulfilled","onRejected","oldImpl","config","baseOptions","set","get","persistedState","currentState","hasHydrated","hydrationListeners","finishHydrationListeners","thenableSerialize","setItem","errorInSync","thenable","serializedValue","savedSetState","configResult","stateFromStorage","hydrate","postRehydrationCallback","storageValue","deserializedStorageValue","migratedState","_a2","newOptions","newImpl","_b","migrationResult","migrated","persistImpl","persist","useCalibration","error","legacy","videoElementRefHolder","mediaStreamRefHolder","pcRefHolder","wsRefHolder","useCameraSession","streaming","code","time","paired","stream","pc","ws","BoardRadii","SectorOrder","applyHomography","H","nx","ny","invertHomography","A","B","C","D","E","F","G","Hh","I","det","computeHomographyDLT","dst","X","Y","solveLeastSquares","AtA","Atb","gaussianSolve","M","maxRow","tmp","canonicalRimTargets","doubleR","sampleRing","steps","pts","theta","rmsError","e2","dx","dy","imageToBoard","H_boardToImage","pImg","inv","scoreAtBoardPoint","deg","sector","drawPolyline","drawCross","clamp","lo","hi","sobelAtGray","gx","gy","sx","sy","xi","gray","refinePointSobel","best","mag","CV","height","imageSrc","imageDst","len","threshold","tab","kernelSize","hist","sum","sumB","wB","wF","max","mu","between","heightMinus1","widthMinus1","mult","shift","stack","stackStart","imageMean","kernel","horizontal","limit","center","sigma","scale2X","binary","contours","deltas","pix","nbd","outer","hole","point","contour","pos1","pos3","pos4","s_end","epsilon","right_slice","pt","start_pt","end_pt","dist","max_dist","le_eps","warpSize","sx1","sx2","dx1","dx2","sy1","sy2","dy1","dy2","p3","p4","rq","sq","px","py","den","orientation","convex","cur_pt","prev_pt","dxdy0","dydx0","dx0","dy0","min","square","span","nz","posSrc","cv","AR","id","corners","minSize","minLength","candidates","swap","minDist","notTooNear","markers","candidate","marker","minZero","rotations","distances","pair","ids","minSum","rotation","aruco","SVD","flag","its","jj","nm","anorm","z","rv1","at","bt","ct","svd","POS","modelSize","focalLength","half","np","vectors","imagePoints","posRotation1","posRotation2","posTranslation","rotation1","rotation2","translation1","translation2","error1","error2","valid1","valid2","translation","imageVectors","i0","j0","ivec","jvec","row1","row2","row3","i0i0","j0j0","i0j0","delta","lambda","zmin","zi","posRotation","oldSopImagePoints","sopImagePoints","converged","iteration","oldImageDifference","imageDifference","factor","move","projection","errorvec","euclidean","pixels","maximum","wmax","cn","posit1","Vec3","Mat3","eps","yi","xs","ys","ij","inorm","jnorm","temp","prevError","v1","v2","v3","v4","modeled","ia1","ia2","ia3","ia4","ma1","ma2","ma3","ma4","x1","y1","x2","y2","vector","posit2","jsAruco","ROW_PATTERNS","markerIdToMatrix","rows","bit3","bit1","isFinitePoint","isFiniteHomography","findDartboardRings","edges","pidx","bestCenter","bestScore","ringCount","ringStrength","testRadii","testR","strength","pixelCount","edge","refinedCx","refinedCy","maxStrength","confidence","knownR","expectedPixelR","detectBoard","centerX","centerY","detection","detected","calibrationPoints","canonicalSrc","homography","errorPx","errorConfidence","pointsValid","homographyValid","refineRingDetection","expectedRatios","actualRatios","ratioError","ratioCount","expected","actual","avgRatioError","adjustedConfidence","load","save","prev","useUserSettings","vol","cfg","Calibrator","videoRef","canvasRef","overlayRef","cameraPerm","setCameraPerm","videoDevices","setVideoDevices","selectedDeviceId","setSelectedDeviceId","setStreaming","videoPlayBlocked","setVideoPlayBlocked","phase","setPhase","setMode","dstPoints","setDstPoints","snapshotSet","setSnapshotSet","frameSize","setFrameSize","zoom","setZoom","mobileLandingOverride","setMobileLandingOverride","isMobileDevice","setIsMobileDevice","setCalibration","reset","locked","cameraSession","calibrationGuide","setCalibrationGuide","preferredCameraId","cameraEnabled","setCameraEnabled","preferredCameraLocked","setPreferredCameraLocked","setPreferredCamera","setDetected","liveDetect","setLiveDetect","setConfidence","autoCalibrating","setAutoCalibrating","forceConfidence","setForceConfidence","markerResult","setMarkerResult","verificationResults","setVerificationResults","useCallback","cols","cellW","cellH","pairCode","setPairCode","pairCodeRef","setWs","pcRef","pendingIceCandidatesRef","expiresAt","setExpiresAt","now","setNow","setPaired","updatePairCode","setQrDataUrl","lanHost","setLanHost","httpsInfo","setHttpsInfo","showTips","setShowTips","wifiDevices","setWifiDevices","discoveringWifi","setDiscoveringWifi","copyFeedback","setCopyFeedback","copyTimeoutRef","ip","mobileUrl","useHttps","port","coarseQuery","detect","uaMobile","coarse","narrow","logoPath","mounted","textarea","handleReconnectRequest","event","stopCamera","startPhonePairing","ensureWS","normalizedEnv","socket","lockSelectionForPairing","ev","codeForSession","imgSize","payload","peer","inbound","offer","pending","autoRevert","drawOverlay","currentPoints","HH","o","Huse","rings","ringColor","ringWidth","drawCircle","targets","ax","ay","workerRef","boardDetection","shouldLock","confidenceLevel","tick","bodyStr","token","nextId","useToastStore","message","useToast","Toaster","toasts","remove","Fragment","BarChart","barWidth","gap","showValues","totalWidth","TabPills","isActive","keyFor","keySeriesFor","getAllTime","parsed","setAllTime","totals","getAllTimeAvg","darts","scored","getAllTimeFirstNineAvg","fnDarts","fnScored","keyGameModes","getGameModeStats","allModeKeys","setGameModeStats","stats","bumpGameMode","won","current","entry","getSeries","arr","setSeries","entries","pruneOld","maxAgeMs","addSample","when","list","getRollingAvg","windowMs","getRollingFirstNineAvg","getMonthlyAvg3","windowed","matchOnly","use","getMonthlyFirstNineAvg","addMatchToAllTime","players","matchBest3","matchWorst3","matchBestLegDarts","matchBestCheckout","matchWorstLegDarts","matchBestFNAvg","matchWorstFNAvg","leg","legFnDarts","legFnScored","sumFirstNine","legDarts","legScored","legAvg","legFNAvg","co","prior","remain","take","freeGames","premiumGames","allGames","WSContext","createContext","WSProvider","connected","setConnected","status","setStatus","wsRef","listenersRef","shouldReconnectRef","attemptsRef","timerRef","heartbeatRef","endpointsRef","endpointIdxRef","ensureEndpoints","normalized","proto","bases","rotateEndpoint","currentEndpoint","connect","attempt","jitter","delay","reconnect","beforeUnload","onVis","send","addListener","useWS","useContext","StatusDot","title","CameraStatusBadge","camera","rafRef","videoEl","hasActivePhoneStream","running","render","vw","vh","cw","ch","vr","cr","sw","sh","targetW","targetH","onClick","HELP_TOPICS","analyzeUserQuestion","question","lowerQ","topic","keyword","getEstimatedWaitTime","hour","HelpdeskChat","request","onClose","messages","setMessages","setInput","typingUsers","setTypingUsers","adminConnected","setAdminConnected","waitTime","setWaitTime","msgsRef","typingTimeoutRef","un","who","sendMsg","userMessage","msgObj","aiResponse","aiMsg","requestAdminConnection","needsHelp","confirmMsg","waitMsg","sendTyping","copy","Zap","User","action","actionMsg","Send","GAME_CALIBRATION_REQUIREMENTS","getCalibrationConfidenceForGame","gameMode","req","excess","isCalibrationSuitableForGame","getCalibrationQualityText","getRecalibrationRecommendation","OWNER_EMAIL","AdminDashboard","admins","setAdmins","setEmail","announcement","setAnnouncement","loading","setLoading","tournaments","setTournaments","withdrawals","setWithdrawals","userSearch","setUserSearch","userResults","setUserResults","createForm","setCreateForm","emailCopy","setEmailCopy","preview","setPreview","activeTab","setActiveTab","isOwner","winners","setWinners","reports","setReports","helpRequests","setHelpRequests","helpTyping","setHelpTyping","selectedRequest","setSelectedRequest","logs","setLogs","systemHealth","setSystemHealth","clusteringEnabled","setClusteringEnabled","clusterCapacity","setClusterCapacity","gmVersion","setGmVersion","gmStats","cal","calibQuality","items","game","qualityInfo","gmBars","bars","gameKey","refresh","headers","hrRes","adminsRes","tRes","revoke","target","grantPremium","days","revokePremium","sendAnnouncement","toggleMaintenance","unsub","rid","filtered","iv","changed","claimHelp","resolveHelp","grant","searchUsers","authHeader","res","banUser","unbanUser","createOfficialTournament","setWinner","tid","winnerEmail","markPaid","deleteTournament","reseedWeekly","decideWithdrawal","approve","deleteMatch","fetchLogs","fetchSystemHealth","toggleClustering","enable","updateClusterCapacity","newCapacity","loadEmailCopy","saveEmailCopy","kind","openInlinePreview","openInNewTab","html","EmailEditor","setTitle","intro","setIntro","btn","setBtn","hr","colorClass","admin","broadcastTournaments","notes","newType","winner","hasAccess","SettingsPanel","favoriteDouble","callerEnabled","callerVoice","callerVolume","speakCheckoutOnly","avgMode","autoStartOffline","rememberLastOffline","reducedMotion","compactHeader","allowSpectate","cameraScale","cameraAspect","cameraFitMode","autoscoreProvider","autoscoreWsUrl","autoCommitMode","preferredCameraLabel","offlineLayout","textSize","boxSize","setFavoriteDouble","setCallerEnabled","setCallerVoice","setCallerVolume","setSpeakCheckoutOnly","setAvgMode","setAutoStartOffline","setRememberLastOffline","setReducedMotion","setCompactHeader","setAllowSpectate","setCameraScale","setCameraAspect","setCameraFitMode","setAutoscoreProvider","setAutoscoreWsUrl","setAutoCommitMode","setOfflineLayout","setTextSize","setBoxSize","dartTimerEnabled","dartTimerSeconds","setDartTimerEnabled","setDartTimerSeconds","x01DoubleIn","setX01DoubleIn","achievements","setAchievements","uname","isEditing","setIsEditing","favPlayer","setFavPlayer","favTeam","setFavTeam","favDarts","setFavDarts","bio","setBio","profilePhoto","setProfilePhoto","allowAnalytics","setAllowAnalytics","subscription","setSubscription","helpMessages","setHelpMessages","helpInput","setHelpInput","saveBio","navigateToTab","tabKey","getResponseWithLinks","handleHelpSend","response","newUsername","setNewUsername","changingUsername","setChangingUsername","usernameError","setUsernameError","availableVoices","setAvailableVoices","loadVoices","voices","showHighlights","setShowHighlights","expandedPill","setExpandedPill","PillButton","pill","ChevronDown","count","Shield","Eye","file","reader","blob","Volume2","utterance","Save","Edit3","Gamepad2","HelpCircle","link","Auth","onAuth","username","setUsername","password","setPassword","reminder","setReminder","setError","showPassword","setShowPassword","API_URL","handleSignIn","__vitePreload","handleSignUp","handleReset","handleSendUsername","EyeOff","BarChart3","ShieldCheck","ThemeContext","THEME_KEY","ThemeProvider","theme","setTheme","saved","Drawer","footer","side","HelpAssistant","isOpen","setIsOpen","awaitingAdminConfirm","setAwaitingAdminConfirm","lastUserQuestion","setLastUserQuestion","myRequest","setMyRequest","handleSend","userMessageRaw","linkIndex","GlobalCameraLogger","lastStateRef","dumpState","prefix","video","media","snapshot","attachVideoListeners","loadedmetadata","playing","pause","ended","attachPc","connChange","attachInterval","GlobalPhoneVideoSink","vref","lastStreamRef","lastTimeRef","stallSecondsRef","lastReconnectAtRef","attemptRef","apply","vid","minBackoff","ResizableModal","storageKey","defaultWidth","defaultHeight","minWidth","minHeight","maxWidth","maxHeight","fullScreen","initialFitHeight","setSize","startRef","onReset","containerRef","parent","cs","padTop","padBottom","inner","beginResize","dir","el","rect","onMove","endResize","parentInner","effMaxH","baseClass","Footer","show","setShow","year","Home","OfflinePlay","Friends","OnlinePlay","StatsPanel","Tournaments","AdminAccess","OpsDashboard","App","appRef","avatar","setAvatar","isFullscreen","setIsFullscreen","setTab","isMobile","setIsMobile","navOpen","setNavOpen","setUser","MINIMAL_UI","minimalUI","setMinimalUI","allTimeAvg","setAllTimeAvg","calibH","calibLocked","timer","fetchSubscription","onLogout","onUpdate","storedAvatar","handleStorageChange","handleAvatarUpdate","handleVisibilityChange","checkAvatarInterval","urlParams","paid","usernameChange","pendingUsername","update","mqMobile","mqTablet","uaTablet","touchScreen","verySmallScreen","isTablet","onName","onTabChange","fallbackAvatar","MobileNav","Suspense","validatePassword","ResetPassword","setToken","confirm","setConfirm","success","setSuccess","onSubmit","ErrorBoundary","Component","props","info","ReactDOM","StrictMode","Root"],"ignoreList":[0,1,2,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,38,39,40,41,42,43,44,48,49,50,51,52,53],"sources":["../../node_modules/react/cjs/react-jsx-runtime.production.min.js","../../node_modules/react/jsx-runtime.js","../../node_modules/react-dom/client.js","../../src/utils/quota.ts","../../src/utils/admin.ts","../../src/utils/config.ts","../../src/utils/api.ts","../../src/components/Sidebar.tsx","../../src/components/ScrollFade.tsx","../../node_modules/qrcode/lib/can-promise.js","../../node_modules/qrcode/lib/core/utils.js","../../node_modules/qrcode/lib/core/error-correction-level.js","../../node_modules/qrcode/lib/core/bit-buffer.js","../../node_modules/qrcode/lib/core/bit-matrix.js","../../node_modules/qrcode/lib/core/alignment-pattern.js","../../node_modules/qrcode/lib/core/finder-pattern.js","../../node_modules/qrcode/lib/core/mask-pattern.js","../../node_modules/qrcode/lib/core/error-correction-code.js","../../node_modules/qrcode/lib/core/galois-field.js","../../node_modules/qrcode/lib/core/polynomial.js","../../node_modules/qrcode/lib/core/reed-solomon-encoder.js","../../node_modules/qrcode/lib/core/version-check.js","../../node_modules/qrcode/lib/core/regex.js","../../node_modules/qrcode/lib/core/mode.js","../../node_modules/qrcode/lib/core/version.js","../../node_modules/qrcode/lib/core/format-info.js","../../node_modules/qrcode/lib/core/numeric-data.js","../../node_modules/qrcode/lib/core/alphanumeric-data.js","../../node_modules/qrcode/lib/core/byte-data.js","../../node_modules/qrcode/lib/core/kanji-data.js","../../node_modules/dijkstrajs/dijkstra.js","../../node_modules/qrcode/lib/core/segments.js","../../node_modules/qrcode/lib/core/qrcode.js","../../node_modules/qrcode/lib/renderer/utils.js","../../node_modules/qrcode/lib/renderer/canvas.js","../../node_modules/qrcode/lib/renderer/svg-tag.js","../../node_modules/qrcode/lib/browser.js","../../src/utils/qr.ts","../../node_modules/zustand/esm/vanilla.mjs","../../node_modules/use-sync-external-store/cjs/use-sync-external-store-shim.production.js","../../node_modules/use-sync-external-store/shim/index.js","../../node_modules/use-sync-external-store/cjs/use-sync-external-store-shim/with-selector.production.js","../../node_modules/use-sync-external-store/shim/with-selector.js","../../node_modules/zustand/esm/index.mjs","../../node_modules/zustand/esm/middleware.mjs","../../src/store/calibration.ts","../../src/store/cameraSession.ts","../../src/utils/vision.ts","../../node_modules/js-aruco/src/cv.js","../../node_modules/js-aruco/src/aruco.js","../../node_modules/js-aruco/src/svd.js","../../node_modules/js-aruco/src/posit1.js","../../node_modules/js-aruco/src/posit2.js","../../node_modules/js-aruco/index.js","../../src/utils/markerCalibration.ts","../../src/utils/boardDetection.ts","../../src/store/userSettings.ts","../../src/components/Calibrator.tsx","../../src/store/toast.ts","../../src/components/Toaster.tsx","../../src/components/BarChart.tsx","../../src/components/ui/TabPills.tsx","../../src/store/profileStats.ts","../../src/utils/games.ts","../../src/components/WSProvider.tsx","../../src/components/ui/StatusDot.tsx","../../src/components/CameraStatusBadge.tsx","../../src/utils/helpDeskAI.ts","../../src/components/HelpdeskChat.tsx","../../src/utils/gameCalibrationRequirements.ts","../../src/components/AdminDashboard.tsx","../../src/components/SettingsPanel.tsx","../../src/components/Auth.tsx","../../src/components/ThemeContext.tsx","../../src/components/ui/Drawer.tsx","../../src/components/HelpAssistant.tsx","../../src/components/GlobalCameraLogger.tsx","../../src/components/GlobalPhoneVideoSink.tsx","../../src/components/ui/ResizableModal.tsx","../../src/components/Footer.tsx","../../src/App.tsx","../../src/components/ResetPassword.tsx","../../src/components/ErrorBoundary.tsx","../../src/main.tsx"],"sourcesContent":["/**\n * @license React\n * react-jsx-runtime.production.min.js\n *\n * Copyright (c) Facebook, Inc. and its affiliates.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n */\n'use strict';var f=require(\"react\"),k=Symbol.for(\"react.element\"),l=Symbol.for(\"react.fragment\"),m=Object.prototype.hasOwnProperty,n=f.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,p={key:!0,ref:!0,__self:!0,__source:!0};\nfunction q(c,a,g){var b,d={},e=null,h=null;void 0!==g&&(e=\"\"+g);void 0!==a.key&&(e=\"\"+a.key);void 0!==a.ref&&(h=a.ref);for(b in a)m.call(a,b)&&!p.hasOwnProperty(b)&&(d[b]=a[b]);if(c&&c.defaultProps)for(b in a=c.defaultProps,a)void 0===d[b]&&(d[b]=a[b]);return{$$typeof:k,type:c,key:e,ref:h,props:d,_owner:n.current}}exports.Fragment=l;exports.jsx=q;exports.jsxs=q;\n","'use strict';\n\nif (process.env.NODE_ENV === 'production') {\n  module.exports = require('./cjs/react-jsx-runtime.production.min.js');\n} else {\n  module.exports = require('./cjs/react-jsx-runtime.development.js');\n}\n","'use strict';\n\nvar m = require('react-dom');\nif (process.env.NODE_ENV === 'production') {\n  exports.createRoot = m.createRoot;\n  exports.hydrateRoot = m.hydrateRoot;\n} else {\n  var i = m.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED;\n  exports.createRoot = function(c, o) {\n    i.usingClientEntryPoint = true;\n    try {\n      return m.createRoot(c, o);\n    } finally {\n      i.usingClientEntryPoint = false;\n    }\n  };\n  exports.hydrateRoot = function(c, h, o) {\n    i.usingClientEntryPoint = true;\n    try {\n      return m.hydrateRoot(c, h, o);\n    } finally {\n      i.usingClientEntryPoint = false;\n    }\n  };\n}\n","// Simple localStorage-based weekly quota for free online games\r\n// 3 free online games per week per user (by username). Premium users are exempt.\r\n\r\nconst KEY = (user: string) => `ndn_online_quota_${user}`\r\n\r\ntype Usage = {\r\n  week: string // e.g., YYYY-WW\r\n  used: number\r\n}\r\n\r\nfunction getWeekId(d = new Date()): string {\r\n  // ISO week-numbering year and week\r\n  const date = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()))\r\n  // Thursday in current week decides the year\r\n  const dayNum = date.getUTCDay() || 7\r\n  date.setUTCDate(date.getUTCDate() + 4 - dayNum)\r\n  const yearStart = new Date(Date.UTC(date.getUTCFullYear(), 0, 1))\r\n  const weekNo = Math.ceil(((date.getTime() - yearStart.getTime()) / 86400000 + 1) / 7)\r\n  const week = String(weekNo).padStart(2, '0')\r\n  return `${date.getUTCFullYear()}-${week}`\r\n}\r\n\r\nexport function getOnlineUsage(user: string): Usage {\r\n  try {\r\n    const raw = localStorage.getItem(KEY(user))\r\n    if (!raw) return { week: getWeekId(), used: 0 }\r\n    const u = JSON.parse(raw)\r\n    const currentWeek = getWeekId()\r\n    if (!u.week || u.week !== currentWeek) return { week: currentWeek, used: 0 }\r\n    return { week: String(u.week), used: Number(u.used) || 0 }\r\n  } catch {\r\n    return { week: getWeekId(), used: 0 }\r\n  }\r\n}\r\n\r\nexport function setOnlineUsage(user: string, usage: Usage) {\r\n  try { localStorage.setItem(KEY(user), JSON.stringify(usage)) } catch {}\r\n}\r\n\r\nexport function incOnlineUsage(user: string, cap = 3): Usage {\r\n  const currentWeek = getWeekId()\r\n  const u = getOnlineUsage(user)\r\n  const next: Usage = { week: currentWeek, used: (u.week === currentWeek ? u.used : 0) + 1 }\r\n  // clamp to cap, though we still store the number\r\n  setOnlineUsage(user, next)\r\n  return next\r\n}\r\n\r\nexport function getFreeRemaining(user: string, cap = 3): number {\r\n  const u = getOnlineUsage(user)\r\n  return Math.max(0, cap - (u.used || 0))\r\n}\r\n","import { useEffect, useState } from 'react'\r\n\r\nconst LS_KEY = 'ndn:isAdmin:v1'\r\n\r\ntype Cache = { [email: string]: { v: boolean; ts: number } }\r\n\r\nfunction getCache(): Cache {\r\n  try { const raw = localStorage.getItem(LS_KEY); return raw ? JSON.parse(raw) : {} } catch { return {} }\r\n}\r\nfunction setCache(email: string, v: boolean) {\r\n  try {\r\n    const c = getCache()\r\n    c[(email||'').toLowerCase()] = { v, ts: Date.now() }\r\n    localStorage.setItem(LS_KEY, JSON.stringify(c))\r\n  } catch {}\r\n}\r\n\r\nexport async function fetchIsAdmin(email?: string|null): Promise<boolean> {\r\n  const e = String(email || '').toLowerCase()\r\n  if (!e) return false\r\n  // Immediate fallbacks: owner env or local override (dev)\r\n  try {\r\n    const owner = String((import.meta as any)?.env?.VITE_OWNER_EMAIL || '').toLowerCase()\r\n    if (owner && e === owner) return true\r\n  } catch {}\r\n  // Hard fallback to known owner (repo default) if nothing else is set\r\n  if (e === 'daviesfamily108@gmail.com') return true\r\n  try {\r\n    const force = localStorage.getItem('ndn:forceAdmin')\r\n    if (force === '1' || force === 'true') return true\r\n  } catch {}\r\n  // try cache first (5 minutes)\r\n  const c = getCache()\r\n  const hit = c[e]\r\n  if (hit && (Date.now() - hit.ts) < 5 * 60 * 1000) return !!hit.v\r\n  try {\r\n    const res = await fetch(`/api/admins/check?email=${encodeURIComponent(e)}`)\r\n    const data = await res.json().catch(()=>({}))\r\n    const v = !!data?.isAdmin\r\n    setCache(e, v)\r\n    return v\r\n  } catch {\r\n    return !!(hit?.v)\r\n  }\r\n}\r\n\r\nexport function useIsAdmin(email?: string|null) {\r\n  const e = String(email || '').toLowerCase()\r\n  const [isAdmin, setIsAdmin] = useState(false)\r\n  useEffect(() => {\r\n    let on = true\r\n    if (!e) { setIsAdmin(false); return }\r\n    // Instant fallbacks before API\r\n    try {\r\n      const owner = String((import.meta as any)?.env?.VITE_OWNER_EMAIL || '').toLowerCase()\r\n      const force = ((): boolean => { try { const v = localStorage.getItem('ndn:forceAdmin'); return v === '1' || v === 'true' } catch { return false } })()\r\n      if (owner && e === owner) { setIsAdmin(true); return }\r\n      if (force) { setIsAdmin(true); return }\r\n    } catch {}\r\n    if (e === 'daviesfamily108@gmail.com') { setIsAdmin(true); return }\r\n    fetchIsAdmin(e).then(v => { if (on) setIsAdmin(!!v) })\r\n    return () => { on = false }\r\n  }, [e])\r\n  return isAdmin\r\n}\r\n","// Demo pricing: base is 5 GBP. Convert to user currency for display.\r\nexport const BASE_PRICE_GBP = 5\r\n\r\n// Simple static FX rates for display (not for real billing). Updated rarely.\r\nconst FX: Record<string, number> = {\r\n\tGBP: 1,\r\n\tEUR: 1.16, //  per \r\n\tUSD: 1.26, // $ per \r\n\tAUD: 1.92,\r\n\tNZD: 2.08,\r\n\tCAD: 1.73,\r\n}\r\n\r\nexport function formatPriceInCurrency(currency: string, gbpAmount = BASE_PRICE_GBP) {\r\n\tconst cur = (currency || 'GBP').toUpperCase()\r\n\tconst rate = FX[cur] ?? 1\r\n\tconst val = gbpAmount * rate\r\n\ttry {\r\n\t\treturn new Intl.NumberFormat(undefined, { style: 'currency', currency: cur }).format(val)\r\n\t} catch {\r\n\t\t// Fallback\r\n\t\treturn `${cur} ${val.toFixed(2)}`\r\n\t}\r\n}\r\n\r\nexport function getUserCurrency(): string {\r\n\ttry {\r\n\t\t// Heuristic: infer from locale\r\n\t\tconst parts = new Intl.NumberFormat().resolvedOptions()\r\n\t\t// Example: en-GB -> GBP, en-US -> USD, en-AU -> AUD, etc. Not 100% accurate.\r\n\t\tconst m = String(parts.locale).toLowerCase()\r\n\t\tif (m.includes('-gb')) return 'GBP'\r\n\t\tif (m.includes('-ie') || m.includes('-de') || m.includes('-fr') || m.includes('-es') || m.includes('-it') || m.includes('-nl')) return 'EUR'\r\n\t\tif (m.includes('-us')) return 'USD'\r\n\t\tif (m.includes('-au')) return 'AUD'\r\n\t\tif (m.includes('-nz')) return 'NZD'\r\n\t\tif (m.includes('-ca')) return 'CAD'\r\n\t\treturn 'GBP'\r\n\t} catch {\r\n\t\treturn 'GBP'\r\n\t}\r\n}\r\n\r\n// Centralized Discord invite; override via VITE_DISCORD_INVITE_URL in Render/Netlify\r\nexport const DISCORD_INVITE_URL: string = (import.meta as any).env?.VITE_DISCORD_INVITE_URL || 'https://discord.gg/nCfT4hJz'\r\n","export type ApiPath = string;\r\n\r\nlet cachedBaseUrl: string | null = null;\r\n\r\nfunction computeApiBase(): string {\r\n  if (cachedBaseUrl) return cachedBaseUrl;\r\n  const envUrl = ((import.meta as any)?.env?.VITE_API_URL as string | undefined)?.trim();\r\n  if (envUrl) {\r\n    cachedBaseUrl = envUrl.replace(/\\/$/, '');\r\n    return cachedBaseUrl;\r\n  }\r\n  if (typeof window !== 'undefined') {\r\n    const { protocol, host, hostname } = window.location;\r\n    const sameOrigin = `${protocol}//${host}`;\r\n    if (hostname.endsWith('onrender.com') || hostname === 'localhost' || hostname === '127.0.0.1') {\r\n      cachedBaseUrl = sameOrigin.replace(/\\/$/, '');\r\n    } else {\r\n      cachedBaseUrl = 'https://ninedartnation.onrender.com';\r\n    }\r\n    return cachedBaseUrl;\r\n  }\r\n  // Fallback for build/test environments without window\r\n  cachedBaseUrl = 'https://ninedartnation.onrender.com';\r\n  return cachedBaseUrl;\r\n}\r\n\r\nfunction normalizePath(path: ApiPath): string {\r\n  if (/^https?:\\/\\//i.test(path)) return path;\r\n  const base = computeApiBase();\r\n  const cleanPath = path.startsWith('/') ? path : `/${path}`;\r\n  return `${base}${cleanPath}`;\r\n}\r\n\r\nexport function resolveApiUrl(path: ApiPath): string {\r\n  return normalizePath(path);\r\n}\r\n\r\nexport function apiFetch(path: ApiPath, init?: RequestInit) {\r\n  const url = resolveApiUrl(path);\r\n  return fetch(url, init);\r\n}\r\n\r\nexport function installApiInterceptor() {\r\n  if (typeof window === 'undefined' || typeof window.fetch !== 'function') return;\r\n  const anyWindow = window as typeof window & { __ndnApiPatched?: boolean };\r\n  if (anyWindow.__ndnApiPatched) return;\r\n  const originalFetch = window.fetch.bind(window);\r\n  window.fetch = (input: RequestInfo | URL, init?: RequestInit) => {\r\n    try {\r\n      if (typeof input === 'string') {\r\n        if (input.startsWith('/')) {\r\n          return originalFetch(resolveApiUrl(input), init);\r\n        }\r\n        return originalFetch(input, init);\r\n      }\r\n      if (input instanceof Request) {\r\n        const reqUrl = input.url.startsWith('/') ? resolveApiUrl(input.url) : input.url;\r\n        if (reqUrl === input.url) {\r\n          return originalFetch(input, init);\r\n        }\r\n        const cloned = new Request(reqUrl, input);\r\n        return originalFetch(cloned, init);\r\n      }\r\n      if (input instanceof URL) {\r\n        const href = input.href.startsWith('/') ? resolveApiUrl(input.href) : input.href;\r\n        return originalFetch(href, init);\r\n      }\r\n    } catch (err) {\r\n      console.warn('[API] Interceptor failed, falling back to original fetch', err);\r\n    }\r\n    return originalFetch(input as any, init);\r\n  };\r\n  anyWindow.__ndnApiPatched = true;\r\n}\r\n","import { LayoutDashboard, Camera, Users, Trophy, Settings, MessageCircle, Lock, PoundSterling, Bell } from 'lucide-react';\r\nimport { useEffect, useState } from 'react';\r\nimport { createPortal } from 'react-dom';\r\nimport { getFreeRemaining } from '../utils/quota'\r\nimport { useIsAdmin } from '../utils/admin'\r\nimport { DISCORD_INVITE_URL } from '../utils/config'\r\nimport { apiFetch } from '../utils/api'\r\n\r\nexport type TabKey = 'score' | 'online' | 'offline' | 'friends' | 'stats' | 'calibrate' | 'settings' | 'admin' | 'tournaments' | 'fullaccess';\r\n\r\nexport function getTabs(user: any) {\r\n  const baseTabs = [\r\n    { key: 'score', label: 'Home', icon: LayoutDashboard },\r\n    { key: 'online', label: 'Online', icon: Users },\r\n    { key: 'offline', label: 'Offline', icon: Trophy },\r\n    { key: 'tournaments', label: 'Tournaments', icon: Trophy },\r\n    { key: 'friends', label: 'Friends', icon: Users },\r\n    { key: 'stats', label: 'Stats', icon: Trophy },\r\n    { key: 'calibrate', label: 'Calibrate', icon: Camera },\r\n    { key: 'settings', label: 'Settings', icon: Settings },\r\n  ];\r\n  // Admin tab visibility handled in Sidebar via hook (client-side fetch)\r\n  if (!user?.fullAccess) {\r\n    baseTabs.push({ key: 'fullaccess', label: 'PREMIUM $', icon: PoundSterling });\r\n  }\r\n  return baseTabs;\r\n}\r\n\r\nexport function Sidebar({\r\n  active,\r\n  onChange,\r\n  user,\r\n  className,\r\n}: {\r\n  active: TabKey;\r\n  onChange: (key: TabKey) => void;\r\n  user: any;\r\n  className?: string;\r\n}) {\r\n  const tabs = getTabs(user);\r\n  const isAdmin = useIsAdmin(user?.email)\r\n  // IMPORTANT: Admin tab is ONLY shown for explicitly granted admin users\r\n  // Premium status does NOT automatically grant admin access\r\n  // Admin access must be granted via /api/admins/grant endpoint by the owner\r\n  if (isAdmin && !tabs.some(t => t.key === 'admin')) {\r\n    const idx = tabs.findIndex(t => t.key === 'settings')\r\n    const adminTab = { key: 'admin', label: 'Admin', icon: Settings } as const\r\n    if (idx >= 0) tabs.splice(idx, 0, adminTab as any); else tabs.push(adminTab as any)\r\n  }\r\n  const [showDiscord, setShowDiscord] = useState(false);\r\n  const [showNDNDiscord, setShowNDNDiscord] = useState(false);\r\n  const freeLeft = user?.username && !user?.fullAccess ? getFreeRemaining(user.username) : Infinity\r\n  \r\n  // Notification counts\r\n  const [notifications, setNotifications] = useState({\r\n    friendRequests: 0,\r\n    messages: 0,\r\n    tournaments: 0\r\n  });\r\n  \r\n  // Fetch notification counts\r\n  useEffect(() => {\r\n    if (!user?.email) return;\r\n    \r\n    const fetchNotifications = async () => {\r\n      try {\r\n        const [requestsRes, messagesRes] = await Promise.all([\r\n          apiFetch(`/api/friends/requests?email=${encodeURIComponent(user.email)}`),\r\n          apiFetch(`/api/friends/messages?email=${encodeURIComponent(user.email)}`)\r\n        ]);\r\n        \r\n        const requests = requestsRes.ok ? await requestsRes.json() : { requests: [] };\r\n        const messages = messagesRes.ok ? await messagesRes.json() : { messages: [] };\r\n        \r\n        // Count unread messages (messages without read status, assuming all are unread for now)\r\n        const unreadMessages = messages.messages?.filter((m: any) => !m.read).length || 0;\r\n        \r\n        setNotifications({\r\n          friendRequests: requests.requests?.length || 0,\r\n          messages: unreadMessages,\r\n          tournaments: 0 // TODO: Add tournament notifications\r\n        });\r\n      } catch (err) {\r\n        console.error('Failed to fetch notifications:', err);\r\n      }\r\n    };\r\n    \r\n    fetchNotifications();\r\n    // Refresh every 30 seconds\r\n    const interval = setInterval(fetchNotifications, 30000);\r\n    return () => clearInterval(interval);\r\n  }, [user?.email]);\r\n  \r\n  useEffect(() => {\r\n    if (!showDiscord) return\r\n    const onKey = (e: KeyboardEvent) => { if (e.key === 'Escape' || e.key === 'Enter') setShowDiscord(false) }\r\n    document.addEventListener('keydown', onKey)\r\n    return () => document.removeEventListener('keydown', onKey)\r\n  }, [showDiscord])\r\n  return (\r\n    <aside className={`${user?.fullAccess ? 'premium-sidebar' : ''} sidebar glass ${className ? '' : 'w-60'} p-2 sm:p-4 rounded-2xl ${className ?? 'hidden sm:flex'} flex-col gap-2 overflow-y-auto overflow-x-hidden ${className ? '' : 'fixed top-2 bottom-2 sm:top-4 sm:bottom-4'}`}>\r\n      {tabs.map(({ key, label, icon: Icon }) => {\r\n  if (key === 'admin' && !isAdmin) return null\r\n        return (\r\n        <button\r\n          key={key}\r\n          className={`tab whitespace-nowrap flex items-center justify-start gap-3 ${active === key ? 'tab--active' : 'tab--inactive'} ${key === 'fullaccess' ? '' : ''}`}\r\n          onClick={() => onChange(key as TabKey)}\r\n          title={label}\r\n          style={{ fontWeight: 700, fontSize: '1.1rem', color: active === key ? '#fff' : '#E5E7EB', letterSpacing: '0.02em' }}\r\n        >\r\n          <Icon className=\"w-6 h-6\" />\r\n          <span className=\"flex items-center gap-2\">\r\n            {label}\r\n            {key === 'online' && !user?.fullAccess && freeLeft <= 0 && (\r\n              <span title=\"Weekly free games used\" className=\"inline-flex items-center gap-1 text-[0.65rem] px-2 py-0.5 rounded-full bg-rose-600 text-white\">\r\n                <Lock className=\"w-3 h-3\" />\r\n                Locked\r\n              </span>\r\n            )}\r\n            {/* Notification badges */}\r\n            {key === 'friends' && notifications.friendRequests > 0 && (\r\n              <span className=\"inline-flex items-center justify-center w-5 h-5 text-xs font-bold text-white bg-orange-500 rounded-full\">\r\n                {notifications.friendRequests > 9 ? '9+' : notifications.friendRequests}\r\n              </span>\r\n            )}\r\n            {key === 'score' && (notifications.messages > 0 || notifications.tournaments > 0) && (\r\n              <span className=\"inline-flex items-center justify-center w-5 h-5 text-xs font-bold text-white bg-orange-500 rounded-full\">\r\n                {(notifications.messages + notifications.tournaments) > 9 ? '9+' : (notifications.messages + notifications.tournaments)}\r\n              </span>\r\n            )}\r\n          </span>\r\n          {/* Only the tab label should show PREMIUM; remove extra badge */}\r\n        </button>\r\n        )\r\n      })}\r\n      {/* Discord tab at the end */}\r\n      <button\r\n        className=\"tab tab--compact whitespace-nowrap flex items-center justify-start gap-3 bg-[#5865F2] text-white mt-2\"\r\n        onClick={() => setShowDiscord(true)}\r\n        title=\"BullseyeDartsLeague\"\r\n        style={{ fontWeight: 700, fontSize: '1.1rem', letterSpacing: '0.02em' }}\r\n      >\r\n        <MessageCircle className=\"w-6 h-6\" />\r\n        <span className=\"truncate\">BullseyeDartsLeague</span>\r\n      </button>\r\n      {/* NineDartNation Discord tab */}\r\n      <button\r\n        className=\"tab tab--compact whitespace-nowrap flex items-center justify-start gap-3 bg-[#5865F2] text-white mt-1\"\r\n        onClick={() => setShowNDNDiscord(true)}\r\n        title=\"NineDartNation\"\r\n        style={{ fontWeight: 700, fontSize: '1.1rem', letterSpacing: '0.02em' }}\r\n      >\r\n        <MessageCircle className=\"w-6 h-6\" />\r\n        <span className=\"truncate\">NineDartNation</span>\r\n      </button>\r\n      {/* Discord about dialog via portal */}\r\n      {showDiscord && createPortal(\r\n        <div className=\"fixed inset-0 z-[1000]\">\r\n          <div className=\"absolute inset-0 bg-black/50\" onClick={() => setShowDiscord(false)} onTouchStart={() => setShowDiscord(false)} />\r\n          <div className=\"absolute inset-0 flex items-center justify-center p-4\">\r\n            <div role=\"dialog\" aria-modal=\"true\" className=\"card max-w-md w-full relative text-left p-6 rounded-xl\">\r\n              <button className=\"absolute -top-3 -right-3 btn px-3 py-1\" aria-label=\"Close\" onClick={() => setShowDiscord(false)}></button>\r\n              <h3 className=\"text-xl font-bold mb-2 flex items-center gap-2 text-[#8ea1e1]\">\r\n                <MessageCircle className=\"w-6 h-6\" /> BullseyeDartsLeague\r\n              </h3>\r\n              <div className=\"mb-4 text-lg font-semibold\">Join this fantastic Online Darts League with divisions and other cool stuff included</div>\r\n        <a\r\n          href={DISCORD_INVITE_URL}\r\n                target=\"_blank\"\r\n                rel=\"noopener noreferrer nofollow\"\r\n                className=\"btn bg-[#5865F2] text-white w-full font-bold text-lg\"\r\n              >\r\n                Join Discord\r\n              </a>\r\n            </div>\r\n          </div>\r\n        </div>,\r\n        document.body\r\n      )}\r\n      {/* NineDartNation Discord about dialog via portal */}\r\n      {showNDNDiscord && createPortal(\r\n        <div className=\"fixed inset-0 z-[1000]\">\r\n          <div className=\"absolute inset-0 bg-black/50\" onClick={() => setShowNDNDiscord(false)} onTouchStart={() => setShowNDNDiscord(false)} />\r\n          <div className=\"absolute inset-0 flex items-center justify-center p-4\">\r\n            <div role=\"dialog\" aria-modal=\"true\" className=\"card max-w-md w-full relative text-left p-6 rounded-xl\">\r\n              <button className=\"absolute -top-3 -right-3 btn px-3 py-1\" aria-label=\"Close\" onClick={() => setShowNDNDiscord(false)}></button>\r\n              <h3 className=\"text-xl font-bold mb-2 flex items-center gap-2 text-[#8ea1e1]\">\r\n                <MessageCircle className=\"w-6 h-6\" /> NineDartNation\r\n              </h3>\r\n              <div className=\"mb-4 text-lg font-semibold\">Join the NineDartNation Discord community</div>\r\n        <a\r\n          href=\"https://discord.gg/Q33J5FTVve\"\r\n                target=\"_blank\"\r\n                rel=\"noopener noreferrer nofollow\"\r\n                className=\"btn bg-[#5865F2] text-white w-full font-bold text-lg\"\r\n              >\r\n                Join Discord\r\n              </a>\r\n            </div>\r\n          </div>\r\n        </div>,\r\n        document.body\r\n      )}\r\n    </aside>\r\n  )\r\n}\r\n","import React, { PropsWithChildren, useEffect, useRef, type CSSProperties } from 'react'\r\n\r\ntype ScrollFadeProps = PropsWithChildren<{\r\n  className?: string\r\n  style?: CSSProperties\r\n}>\r\n\r\nexport default function ScrollFade({ children, className, style }: ScrollFadeProps) {\r\n  const ref = useRef<HTMLDivElement | null>(null)\r\n\r\n  // Clip content under the sticky header so text never shows over it\r\n  useEffect(() => {\r\n    let raf = 0\r\n    const updateClip = () => {\r\n      const wrapper = ref.current\r\n      if (!wrapper) return\r\n  const header = document.getElementById('ndn-header') as HTMLElement | null\r\n      if (!header) {\r\n        wrapper.style.clipPath = ''\r\n        return\r\n      }\r\n       const scroller = document.getElementById('ndn-main-scroll') as HTMLElement | null\r\n       const scrollTop = scroller ? scroller.scrollTop : (window.scrollY || 0)\r\n       // Hide content under the sticky header by rendering a lightweight mask\r\n       // element at the top of the wrapper. Using an overlay avoids layout shifts\r\n       // and prevents clip-path + transform interactions that can cause rendering\r\n       // artifacts in some browsers.\r\n       const headerH = header.getBoundingClientRect().height\r\n       const overlap = scrollTop > 0 ? headerH : 0\r\n       try {\r\n         // Find or create the mask node\r\n         let mask = wrapper.querySelector('[data-ndn-top-mask]') as HTMLElement | null\r\n         if (!mask) {\r\n           mask = document.createElement('div')\r\n           mask.setAttribute('data-ndn-top-mask', '1')\r\n           // keep it non-interactive and on top of the wrapper content\r\n           Object.assign(mask.style, {\r\n             position: 'absolute',\r\n             left: '0px',\r\n             right: '0px',\r\n             top: '0px',\r\n             height: '0px',\r\n             pointerEvents: 'none',\r\n             zIndex: '20',\r\n             background: 'linear-gradient(to bottom, rgba(17,24,39,1), rgba(17,24,39,0))'\r\n           })\r\n           wrapper.style.position = wrapper.style.position || 'relative'\r\n           wrapper.insertBefore(mask, wrapper.firstChild)\r\n         }\r\n         if (overlap > 0) {\r\n           mask.style.height = `${overlap}px`\r\n           mask.style.display = ''\r\n         } else {\r\n           mask.style.height = '0px'\r\n           mask.style.display = 'none'\r\n         }\r\n         // keep layout position unchanged\r\n         wrapper.style.marginTop = '0px'\r\n       } catch (e) {\r\n         wrapper.style.marginTop = '0px'\r\n       }\r\n    }\r\n    updateClip()\r\n    const onScrollOrResize = () => {\r\n      if (raf) cancelAnimationFrame(raf)\r\n      raf = requestAnimationFrame(updateClip)\r\n    }\r\n    // Listen to the app's main scroll container instead of window\r\n    const scroller = document.getElementById('ndn-main-scroll')\r\n  scroller?.addEventListener('scroll', onScrollOrResize as any, { passive: true } as any)\r\n    // Fallback to window for safety (mobile or non-standard layouts)\r\n    window.addEventListener('scroll', onScrollOrResize, { passive: true })\r\n    window.addEventListener('resize', onScrollOrResize)\r\n    return () => {\r\n  scroller?.removeEventListener('scroll', onScrollOrResize as any)\r\n      window.removeEventListener('scroll', onScrollOrResize)\r\n      window.removeEventListener('resize', onScrollOrResize)\r\n      if (raf) cancelAnimationFrame(raf)\r\n    }\r\n  }, [])\r\n\r\n  return (\r\n    <div ref={ref} className={className} style={style}>\r\n      {children}\r\n    </div>\r\n  )\r\n}\r\n","// can-promise has a crash in some versions of react native that dont have\n// standard global objects\n// https://github.com/soldair/node-qrcode/issues/157\n\nmodule.exports = function () {\n  return typeof Promise === 'function' && Promise.prototype && Promise.prototype.then\n}\n","let toSJISFunction\nconst CODEWORDS_COUNT = [\n  0, // Not used\n  26, 44, 70, 100, 134, 172, 196, 242, 292, 346,\n  404, 466, 532, 581, 655, 733, 815, 901, 991, 1085,\n  1156, 1258, 1364, 1474, 1588, 1706, 1828, 1921, 2051, 2185,\n  2323, 2465, 2611, 2761, 2876, 3034, 3196, 3362, 3532, 3706\n]\n\n/**\n * Returns the QR Code size for the specified version\n *\n * @param  {Number} version QR Code version\n * @return {Number}         size of QR code\n */\nexports.getSymbolSize = function getSymbolSize (version) {\n  if (!version) throw new Error('\"version\" cannot be null or undefined')\n  if (version < 1 || version > 40) throw new Error('\"version\" should be in range from 1 to 40')\n  return version * 4 + 17\n}\n\n/**\n * Returns the total number of codewords used to store data and EC information.\n *\n * @param  {Number} version QR Code version\n * @return {Number}         Data length in bits\n */\nexports.getSymbolTotalCodewords = function getSymbolTotalCodewords (version) {\n  return CODEWORDS_COUNT[version]\n}\n\n/**\n * Encode data with Bose-Chaudhuri-Hocquenghem\n *\n * @param  {Number} data Value to encode\n * @return {Number}      Encoded value\n */\nexports.getBCHDigit = function (data) {\n  let digit = 0\n\n  while (data !== 0) {\n    digit++\n    data >>>= 1\n  }\n\n  return digit\n}\n\nexports.setToSJISFunction = function setToSJISFunction (f) {\n  if (typeof f !== 'function') {\n    throw new Error('\"toSJISFunc\" is not a valid function.')\n  }\n\n  toSJISFunction = f\n}\n\nexports.isKanjiModeEnabled = function () {\n  return typeof toSJISFunction !== 'undefined'\n}\n\nexports.toSJIS = function toSJIS (kanji) {\n  return toSJISFunction(kanji)\n}\n","exports.L = { bit: 1 }\nexports.M = { bit: 0 }\nexports.Q = { bit: 3 }\nexports.H = { bit: 2 }\n\nfunction fromString (string) {\n  if (typeof string !== 'string') {\n    throw new Error('Param is not a string')\n  }\n\n  const lcStr = string.toLowerCase()\n\n  switch (lcStr) {\n    case 'l':\n    case 'low':\n      return exports.L\n\n    case 'm':\n    case 'medium':\n      return exports.M\n\n    case 'q':\n    case 'quartile':\n      return exports.Q\n\n    case 'h':\n    case 'high':\n      return exports.H\n\n    default:\n      throw new Error('Unknown EC Level: ' + string)\n  }\n}\n\nexports.isValid = function isValid (level) {\n  return level && typeof level.bit !== 'undefined' &&\n    level.bit >= 0 && level.bit < 4\n}\n\nexports.from = function from (value, defaultValue) {\n  if (exports.isValid(value)) {\n    return value\n  }\n\n  try {\n    return fromString(value)\n  } catch (e) {\n    return defaultValue\n  }\n}\n","function BitBuffer () {\n  this.buffer = []\n  this.length = 0\n}\n\nBitBuffer.prototype = {\n\n  get: function (index) {\n    const bufIndex = Math.floor(index / 8)\n    return ((this.buffer[bufIndex] >>> (7 - index % 8)) & 1) === 1\n  },\n\n  put: function (num, length) {\n    for (let i = 0; i < length; i++) {\n      this.putBit(((num >>> (length - i - 1)) & 1) === 1)\n    }\n  },\n\n  getLengthInBits: function () {\n    return this.length\n  },\n\n  putBit: function (bit) {\n    const bufIndex = Math.floor(this.length / 8)\n    if (this.buffer.length <= bufIndex) {\n      this.buffer.push(0)\n    }\n\n    if (bit) {\n      this.buffer[bufIndex] |= (0x80 >>> (this.length % 8))\n    }\n\n    this.length++\n  }\n}\n\nmodule.exports = BitBuffer\n","/**\n * Helper class to handle QR Code symbol modules\n *\n * @param {Number} size Symbol size\n */\nfunction BitMatrix (size) {\n  if (!size || size < 1) {\n    throw new Error('BitMatrix size must be defined and greater than 0')\n  }\n\n  this.size = size\n  this.data = new Uint8Array(size * size)\n  this.reservedBit = new Uint8Array(size * size)\n}\n\n/**\n * Set bit value at specified location\n * If reserved flag is set, this bit will be ignored during masking process\n *\n * @param {Number}  row\n * @param {Number}  col\n * @param {Boolean} value\n * @param {Boolean} reserved\n */\nBitMatrix.prototype.set = function (row, col, value, reserved) {\n  const index = row * this.size + col\n  this.data[index] = value\n  if (reserved) this.reservedBit[index] = true\n}\n\n/**\n * Returns bit value at specified location\n *\n * @param  {Number}  row\n * @param  {Number}  col\n * @return {Boolean}\n */\nBitMatrix.prototype.get = function (row, col) {\n  return this.data[row * this.size + col]\n}\n\n/**\n * Applies xor operator at specified location\n * (used during masking process)\n *\n * @param {Number}  row\n * @param {Number}  col\n * @param {Boolean} value\n */\nBitMatrix.prototype.xor = function (row, col, value) {\n  this.data[row * this.size + col] ^= value\n}\n\n/**\n * Check if bit at specified location is reserved\n *\n * @param {Number}   row\n * @param {Number}   col\n * @return {Boolean}\n */\nBitMatrix.prototype.isReserved = function (row, col) {\n  return this.reservedBit[row * this.size + col]\n}\n\nmodule.exports = BitMatrix\n","/**\n * Alignment pattern are fixed reference pattern in defined positions\n * in a matrix symbology, which enables the decode software to re-synchronise\n * the coordinate mapping of the image modules in the event of moderate amounts\n * of distortion of the image.\n *\n * Alignment patterns are present only in QR Code symbols of version 2 or larger\n * and their number depends on the symbol version.\n */\n\nconst getSymbolSize = require('./utils').getSymbolSize\n\n/**\n * Calculate the row/column coordinates of the center module of each alignment pattern\n * for the specified QR Code version.\n *\n * The alignment patterns are positioned symmetrically on either side of the diagonal\n * running from the top left corner of the symbol to the bottom right corner.\n *\n * Since positions are simmetrical only half of the coordinates are returned.\n * Each item of the array will represent in turn the x and y coordinate.\n * @see {@link getPositions}\n *\n * @param  {Number} version QR Code version\n * @return {Array}          Array of coordinate\n */\nexports.getRowColCoords = function getRowColCoords (version) {\n  if (version === 1) return []\n\n  const posCount = Math.floor(version / 7) + 2\n  const size = getSymbolSize(version)\n  const intervals = size === 145 ? 26 : Math.ceil((size - 13) / (2 * posCount - 2)) * 2\n  const positions = [size - 7] // Last coord is always (size - 7)\n\n  for (let i = 1; i < posCount - 1; i++) {\n    positions[i] = positions[i - 1] - intervals\n  }\n\n  positions.push(6) // First coord is always 6\n\n  return positions.reverse()\n}\n\n/**\n * Returns an array containing the positions of each alignment pattern.\n * Each array's element represent the center point of the pattern as (x, y) coordinates\n *\n * Coordinates are calculated expanding the row/column coordinates returned by {@link getRowColCoords}\n * and filtering out the items that overlaps with finder pattern\n *\n * @example\n * For a Version 7 symbol {@link getRowColCoords} returns values 6, 22 and 38.\n * The alignment patterns, therefore, are to be centered on (row, column)\n * positions (6,22), (22,6), (22,22), (22,38), (38,22), (38,38).\n * Note that the coordinates (6,6), (6,38), (38,6) are occupied by finder patterns\n * and are not therefore used for alignment patterns.\n *\n * let pos = getPositions(7)\n * // [[6,22], [22,6], [22,22], [22,38], [38,22], [38,38]]\n *\n * @param  {Number} version QR Code version\n * @return {Array}          Array of coordinates\n */\nexports.getPositions = function getPositions (version) {\n  const coords = []\n  const pos = exports.getRowColCoords(version)\n  const posLength = pos.length\n\n  for (let i = 0; i < posLength; i++) {\n    for (let j = 0; j < posLength; j++) {\n      // Skip if position is occupied by finder patterns\n      if ((i === 0 && j === 0) || // top-left\n          (i === 0 && j === posLength - 1) || // bottom-left\n          (i === posLength - 1 && j === 0)) { // top-right\n        continue\n      }\n\n      coords.push([pos[i], pos[j]])\n    }\n  }\n\n  return coords\n}\n","const getSymbolSize = require('./utils').getSymbolSize\nconst FINDER_PATTERN_SIZE = 7\n\n/**\n * Returns an array containing the positions of each finder pattern.\n * Each array's element represent the top-left point of the pattern as (x, y) coordinates\n *\n * @param  {Number} version QR Code version\n * @return {Array}          Array of coordinates\n */\nexports.getPositions = function getPositions (version) {\n  const size = getSymbolSize(version)\n\n  return [\n    // top-left\n    [0, 0],\n    // top-right\n    [size - FINDER_PATTERN_SIZE, 0],\n    // bottom-left\n    [0, size - FINDER_PATTERN_SIZE]\n  ]\n}\n","/**\n * Data mask pattern reference\n * @type {Object}\n */\nexports.Patterns = {\n  PATTERN000: 0,\n  PATTERN001: 1,\n  PATTERN010: 2,\n  PATTERN011: 3,\n  PATTERN100: 4,\n  PATTERN101: 5,\n  PATTERN110: 6,\n  PATTERN111: 7\n}\n\n/**\n * Weighted penalty scores for the undesirable features\n * @type {Object}\n */\nconst PenaltyScores = {\n  N1: 3,\n  N2: 3,\n  N3: 40,\n  N4: 10\n}\n\n/**\n * Check if mask pattern value is valid\n *\n * @param  {Number}  mask    Mask pattern\n * @return {Boolean}         true if valid, false otherwise\n */\nexports.isValid = function isValid (mask) {\n  return mask != null && mask !== '' && !isNaN(mask) && mask >= 0 && mask <= 7\n}\n\n/**\n * Returns mask pattern from a value.\n * If value is not valid, returns undefined\n *\n * @param  {Number|String} value        Mask pattern value\n * @return {Number}                     Valid mask pattern or undefined\n */\nexports.from = function from (value) {\n  return exports.isValid(value) ? parseInt(value, 10) : undefined\n}\n\n/**\n* Find adjacent modules in row/column with the same color\n* and assign a penalty value.\n*\n* Points: N1 + i\n* i is the amount by which the number of adjacent modules of the same color exceeds 5\n*/\nexports.getPenaltyN1 = function getPenaltyN1 (data) {\n  const size = data.size\n  let points = 0\n  let sameCountCol = 0\n  let sameCountRow = 0\n  let lastCol = null\n  let lastRow = null\n\n  for (let row = 0; row < size; row++) {\n    sameCountCol = sameCountRow = 0\n    lastCol = lastRow = null\n\n    for (let col = 0; col < size; col++) {\n      let module = data.get(row, col)\n      if (module === lastCol) {\n        sameCountCol++\n      } else {\n        if (sameCountCol >= 5) points += PenaltyScores.N1 + (sameCountCol - 5)\n        lastCol = module\n        sameCountCol = 1\n      }\n\n      module = data.get(col, row)\n      if (module === lastRow) {\n        sameCountRow++\n      } else {\n        if (sameCountRow >= 5) points += PenaltyScores.N1 + (sameCountRow - 5)\n        lastRow = module\n        sameCountRow = 1\n      }\n    }\n\n    if (sameCountCol >= 5) points += PenaltyScores.N1 + (sameCountCol - 5)\n    if (sameCountRow >= 5) points += PenaltyScores.N1 + (sameCountRow - 5)\n  }\n\n  return points\n}\n\n/**\n * Find 2x2 blocks with the same color and assign a penalty value\n *\n * Points: N2 * (m - 1) * (n - 1)\n */\nexports.getPenaltyN2 = function getPenaltyN2 (data) {\n  const size = data.size\n  let points = 0\n\n  for (let row = 0; row < size - 1; row++) {\n    for (let col = 0; col < size - 1; col++) {\n      const last = data.get(row, col) +\n        data.get(row, col + 1) +\n        data.get(row + 1, col) +\n        data.get(row + 1, col + 1)\n\n      if (last === 4 || last === 0) points++\n    }\n  }\n\n  return points * PenaltyScores.N2\n}\n\n/**\n * Find 1:1:3:1:1 ratio (dark:light:dark:light:dark) pattern in row/column,\n * preceded or followed by light area 4 modules wide\n *\n * Points: N3 * number of pattern found\n */\nexports.getPenaltyN3 = function getPenaltyN3 (data) {\n  const size = data.size\n  let points = 0\n  let bitsCol = 0\n  let bitsRow = 0\n\n  for (let row = 0; row < size; row++) {\n    bitsCol = bitsRow = 0\n    for (let col = 0; col < size; col++) {\n      bitsCol = ((bitsCol << 1) & 0x7FF) | data.get(row, col)\n      if (col >= 10 && (bitsCol === 0x5D0 || bitsCol === 0x05D)) points++\n\n      bitsRow = ((bitsRow << 1) & 0x7FF) | data.get(col, row)\n      if (col >= 10 && (bitsRow === 0x5D0 || bitsRow === 0x05D)) points++\n    }\n  }\n\n  return points * PenaltyScores.N3\n}\n\n/**\n * Calculate proportion of dark modules in entire symbol\n *\n * Points: N4 * k\n *\n * k is the rating of the deviation of the proportion of dark modules\n * in the symbol from 50% in steps of 5%\n */\nexports.getPenaltyN4 = function getPenaltyN4 (data) {\n  let darkCount = 0\n  const modulesCount = data.data.length\n\n  for (let i = 0; i < modulesCount; i++) darkCount += data.data[i]\n\n  const k = Math.abs(Math.ceil((darkCount * 100 / modulesCount) / 5) - 10)\n\n  return k * PenaltyScores.N4\n}\n\n/**\n * Return mask value at given position\n *\n * @param  {Number} maskPattern Pattern reference value\n * @param  {Number} i           Row\n * @param  {Number} j           Column\n * @return {Boolean}            Mask value\n */\nfunction getMaskAt (maskPattern, i, j) {\n  switch (maskPattern) {\n    case exports.Patterns.PATTERN000: return (i + j) % 2 === 0\n    case exports.Patterns.PATTERN001: return i % 2 === 0\n    case exports.Patterns.PATTERN010: return j % 3 === 0\n    case exports.Patterns.PATTERN011: return (i + j) % 3 === 0\n    case exports.Patterns.PATTERN100: return (Math.floor(i / 2) + Math.floor(j / 3)) % 2 === 0\n    case exports.Patterns.PATTERN101: return (i * j) % 2 + (i * j) % 3 === 0\n    case exports.Patterns.PATTERN110: return ((i * j) % 2 + (i * j) % 3) % 2 === 0\n    case exports.Patterns.PATTERN111: return ((i * j) % 3 + (i + j) % 2) % 2 === 0\n\n    default: throw new Error('bad maskPattern:' + maskPattern)\n  }\n}\n\n/**\n * Apply a mask pattern to a BitMatrix\n *\n * @param  {Number}    pattern Pattern reference number\n * @param  {BitMatrix} data    BitMatrix data\n */\nexports.applyMask = function applyMask (pattern, data) {\n  const size = data.size\n\n  for (let col = 0; col < size; col++) {\n    for (let row = 0; row < size; row++) {\n      if (data.isReserved(row, col)) continue\n      data.xor(row, col, getMaskAt(pattern, row, col))\n    }\n  }\n}\n\n/**\n * Returns the best mask pattern for data\n *\n * @param  {BitMatrix} data\n * @return {Number} Mask pattern reference number\n */\nexports.getBestMask = function getBestMask (data, setupFormatFunc) {\n  const numPatterns = Object.keys(exports.Patterns).length\n  let bestPattern = 0\n  let lowerPenalty = Infinity\n\n  for (let p = 0; p < numPatterns; p++) {\n    setupFormatFunc(p)\n    exports.applyMask(p, data)\n\n    // Calculate penalty\n    const penalty =\n      exports.getPenaltyN1(data) +\n      exports.getPenaltyN2(data) +\n      exports.getPenaltyN3(data) +\n      exports.getPenaltyN4(data)\n\n    // Undo previously applied mask\n    exports.applyMask(p, data)\n\n    if (penalty < lowerPenalty) {\n      lowerPenalty = penalty\n      bestPattern = p\n    }\n  }\n\n  return bestPattern\n}\n","const ECLevel = require('./error-correction-level')\r\n\r\nconst EC_BLOCKS_TABLE = [\r\n// L  M  Q  H\r\n  1, 1, 1, 1,\r\n  1, 1, 1, 1,\r\n  1, 1, 2, 2,\r\n  1, 2, 2, 4,\r\n  1, 2, 4, 4,\r\n  2, 4, 4, 4,\r\n  2, 4, 6, 5,\r\n  2, 4, 6, 6,\r\n  2, 5, 8, 8,\r\n  4, 5, 8, 8,\r\n  4, 5, 8, 11,\r\n  4, 8, 10, 11,\r\n  4, 9, 12, 16,\r\n  4, 9, 16, 16,\r\n  6, 10, 12, 18,\r\n  6, 10, 17, 16,\r\n  6, 11, 16, 19,\r\n  6, 13, 18, 21,\r\n  7, 14, 21, 25,\r\n  8, 16, 20, 25,\r\n  8, 17, 23, 25,\r\n  9, 17, 23, 34,\r\n  9, 18, 25, 30,\r\n  10, 20, 27, 32,\r\n  12, 21, 29, 35,\r\n  12, 23, 34, 37,\r\n  12, 25, 34, 40,\r\n  13, 26, 35, 42,\r\n  14, 28, 38, 45,\r\n  15, 29, 40, 48,\r\n  16, 31, 43, 51,\r\n  17, 33, 45, 54,\r\n  18, 35, 48, 57,\r\n  19, 37, 51, 60,\r\n  19, 38, 53, 63,\r\n  20, 40, 56, 66,\r\n  21, 43, 59, 70,\r\n  22, 45, 62, 74,\r\n  24, 47, 65, 77,\r\n  25, 49, 68, 81\r\n]\r\n\r\nconst EC_CODEWORDS_TABLE = [\r\n// L  M  Q  H\r\n  7, 10, 13, 17,\r\n  10, 16, 22, 28,\r\n  15, 26, 36, 44,\r\n  20, 36, 52, 64,\r\n  26, 48, 72, 88,\r\n  36, 64, 96, 112,\r\n  40, 72, 108, 130,\r\n  48, 88, 132, 156,\r\n  60, 110, 160, 192,\r\n  72, 130, 192, 224,\r\n  80, 150, 224, 264,\r\n  96, 176, 260, 308,\r\n  104, 198, 288, 352,\r\n  120, 216, 320, 384,\r\n  132, 240, 360, 432,\r\n  144, 280, 408, 480,\r\n  168, 308, 448, 532,\r\n  180, 338, 504, 588,\r\n  196, 364, 546, 650,\r\n  224, 416, 600, 700,\r\n  224, 442, 644, 750,\r\n  252, 476, 690, 816,\r\n  270, 504, 750, 900,\r\n  300, 560, 810, 960,\r\n  312, 588, 870, 1050,\r\n  336, 644, 952, 1110,\r\n  360, 700, 1020, 1200,\r\n  390, 728, 1050, 1260,\r\n  420, 784, 1140, 1350,\r\n  450, 812, 1200, 1440,\r\n  480, 868, 1290, 1530,\r\n  510, 924, 1350, 1620,\r\n  540, 980, 1440, 1710,\r\n  570, 1036, 1530, 1800,\r\n  570, 1064, 1590, 1890,\r\n  600, 1120, 1680, 1980,\r\n  630, 1204, 1770, 2100,\r\n  660, 1260, 1860, 2220,\r\n  720, 1316, 1950, 2310,\r\n  750, 1372, 2040, 2430\r\n]\r\n\r\n/**\r\n * Returns the number of error correction block that the QR Code should contain\r\n * for the specified version and error correction level.\r\n *\r\n * @param  {Number} version              QR Code version\r\n * @param  {Number} errorCorrectionLevel Error correction level\r\n * @return {Number}                      Number of error correction blocks\r\n */\r\nexports.getBlocksCount = function getBlocksCount (version, errorCorrectionLevel) {\r\n  switch (errorCorrectionLevel) {\r\n    case ECLevel.L:\r\n      return EC_BLOCKS_TABLE[(version - 1) * 4 + 0]\r\n    case ECLevel.M:\r\n      return EC_BLOCKS_TABLE[(version - 1) * 4 + 1]\r\n    case ECLevel.Q:\r\n      return EC_BLOCKS_TABLE[(version - 1) * 4 + 2]\r\n    case ECLevel.H:\r\n      return EC_BLOCKS_TABLE[(version - 1) * 4 + 3]\r\n    default:\r\n      return undefined\r\n  }\r\n}\r\n\r\n/**\r\n * Returns the number of error correction codewords to use for the specified\r\n * version and error correction level.\r\n *\r\n * @param  {Number} version              QR Code version\r\n * @param  {Number} errorCorrectionLevel Error correction level\r\n * @return {Number}                      Number of error correction codewords\r\n */\r\nexports.getTotalCodewordsCount = function getTotalCodewordsCount (version, errorCorrectionLevel) {\r\n  switch (errorCorrectionLevel) {\r\n    case ECLevel.L:\r\n      return EC_CODEWORDS_TABLE[(version - 1) * 4 + 0]\r\n    case ECLevel.M:\r\n      return EC_CODEWORDS_TABLE[(version - 1) * 4 + 1]\r\n    case ECLevel.Q:\r\n      return EC_CODEWORDS_TABLE[(version - 1) * 4 + 2]\r\n    case ECLevel.H:\r\n      return EC_CODEWORDS_TABLE[(version - 1) * 4 + 3]\r\n    default:\r\n      return undefined\r\n  }\r\n}\r\n","const EXP_TABLE = new Uint8Array(512)\nconst LOG_TABLE = new Uint8Array(256)\n/**\n * Precompute the log and anti-log tables for faster computation later\n *\n * For each possible value in the galois field 2^8, we will pre-compute\n * the logarithm and anti-logarithm (exponential) of this value\n *\n * ref {@link https://en.wikiversity.org/wiki/Reed%E2%80%93Solomon_codes_for_coders#Introduction_to_mathematical_fields}\n */\n;(function initTables () {\n  let x = 1\n  for (let i = 0; i < 255; i++) {\n    EXP_TABLE[i] = x\n    LOG_TABLE[x] = i\n\n    x <<= 1 // multiply by 2\n\n    // The QR code specification says to use byte-wise modulo 100011101 arithmetic.\n    // This means that when a number is 256 or larger, it should be XORed with 0x11D.\n    if (x & 0x100) { // similar to x >= 256, but a lot faster (because 0x100 == 256)\n      x ^= 0x11D\n    }\n  }\n\n  // Optimization: double the size of the anti-log table so that we don't need to mod 255 to\n  // stay inside the bounds (because we will mainly use this table for the multiplication of\n  // two GF numbers, no more).\n  // @see {@link mul}\n  for (let i = 255; i < 512; i++) {\n    EXP_TABLE[i] = EXP_TABLE[i - 255]\n  }\n}())\n\n/**\n * Returns log value of n inside Galois Field\n *\n * @param  {Number} n\n * @return {Number}\n */\nexports.log = function log (n) {\n  if (n < 1) throw new Error('log(' + n + ')')\n  return LOG_TABLE[n]\n}\n\n/**\n * Returns anti-log value of n inside Galois Field\n *\n * @param  {Number} n\n * @return {Number}\n */\nexports.exp = function exp (n) {\n  return EXP_TABLE[n]\n}\n\n/**\n * Multiplies two number inside Galois Field\n *\n * @param  {Number} x\n * @param  {Number} y\n * @return {Number}\n */\nexports.mul = function mul (x, y) {\n  if (x === 0 || y === 0) return 0\n\n  // should be EXP_TABLE[(LOG_TABLE[x] + LOG_TABLE[y]) % 255] if EXP_TABLE wasn't oversized\n  // @see {@link initTables}\n  return EXP_TABLE[LOG_TABLE[x] + LOG_TABLE[y]]\n}\n","const GF = require('./galois-field')\n\n/**\n * Multiplies two polynomials inside Galois Field\n *\n * @param  {Uint8Array} p1 Polynomial\n * @param  {Uint8Array} p2 Polynomial\n * @return {Uint8Array}    Product of p1 and p2\n */\nexports.mul = function mul (p1, p2) {\n  const coeff = new Uint8Array(p1.length + p2.length - 1)\n\n  for (let i = 0; i < p1.length; i++) {\n    for (let j = 0; j < p2.length; j++) {\n      coeff[i + j] ^= GF.mul(p1[i], p2[j])\n    }\n  }\n\n  return coeff\n}\n\n/**\n * Calculate the remainder of polynomials division\n *\n * @param  {Uint8Array} divident Polynomial\n * @param  {Uint8Array} divisor  Polynomial\n * @return {Uint8Array}          Remainder\n */\nexports.mod = function mod (divident, divisor) {\n  let result = new Uint8Array(divident)\n\n  while ((result.length - divisor.length) >= 0) {\n    const coeff = result[0]\n\n    for (let i = 0; i < divisor.length; i++) {\n      result[i] ^= GF.mul(divisor[i], coeff)\n    }\n\n    // remove all zeros from buffer head\n    let offset = 0\n    while (offset < result.length && result[offset] === 0) offset++\n    result = result.slice(offset)\n  }\n\n  return result\n}\n\n/**\n * Generate an irreducible generator polynomial of specified degree\n * (used by Reed-Solomon encoder)\n *\n * @param  {Number} degree Degree of the generator polynomial\n * @return {Uint8Array}    Buffer containing polynomial coefficients\n */\nexports.generateECPolynomial = function generateECPolynomial (degree) {\n  let poly = new Uint8Array([1])\n  for (let i = 0; i < degree; i++) {\n    poly = exports.mul(poly, new Uint8Array([1, GF.exp(i)]))\n  }\n\n  return poly\n}\n","const Polynomial = require('./polynomial')\n\nfunction ReedSolomonEncoder (degree) {\n  this.genPoly = undefined\n  this.degree = degree\n\n  if (this.degree) this.initialize(this.degree)\n}\n\n/**\n * Initialize the encoder.\n * The input param should correspond to the number of error correction codewords.\n *\n * @param  {Number} degree\n */\nReedSolomonEncoder.prototype.initialize = function initialize (degree) {\n  // create an irreducible generator polynomial\n  this.degree = degree\n  this.genPoly = Polynomial.generateECPolynomial(this.degree)\n}\n\n/**\n * Encodes a chunk of data\n *\n * @param  {Uint8Array} data Buffer containing input data\n * @return {Uint8Array}      Buffer containing encoded data\n */\nReedSolomonEncoder.prototype.encode = function encode (data) {\n  if (!this.genPoly) {\n    throw new Error('Encoder not initialized')\n  }\n\n  // Calculate EC for this data block\n  // extends data size to data+genPoly size\n  const paddedData = new Uint8Array(data.length + this.degree)\n  paddedData.set(data)\n\n  // The error correction codewords are the remainder after dividing the data codewords\n  // by a generator polynomial\n  const remainder = Polynomial.mod(paddedData, this.genPoly)\n\n  // return EC data blocks (last n byte, where n is the degree of genPoly)\n  // If coefficients number in remainder are less than genPoly degree,\n  // pad with 0s to the left to reach the needed number of coefficients\n  const start = this.degree - remainder.length\n  if (start > 0) {\n    const buff = new Uint8Array(this.degree)\n    buff.set(remainder, start)\n\n    return buff\n  }\n\n  return remainder\n}\n\nmodule.exports = ReedSolomonEncoder\n","/**\n * Check if QR Code version is valid\n *\n * @param  {Number}  version QR Code version\n * @return {Boolean}         true if valid version, false otherwise\n */\nexports.isValid = function isValid (version) {\n  return !isNaN(version) && version >= 1 && version <= 40\n}\n","const numeric = '[0-9]+'\nconst alphanumeric = '[A-Z $%*+\\\\-./:]+'\nlet kanji = '(?:[u3000-u303F]|[u3040-u309F]|[u30A0-u30FF]|' +\n  '[uFF00-uFFEF]|[u4E00-u9FAF]|[u2605-u2606]|[u2190-u2195]|u203B|' +\n  '[u2010u2015u2018u2019u2025u2026u201Cu201Du2225u2260]|' +\n  '[u0391-u0451]|[u00A7u00A8u00B1u00B4u00D7u00F7])+'\nkanji = kanji.replace(/u/g, '\\\\u')\n\nconst byte = '(?:(?![A-Z0-9 $%*+\\\\-./:]|' + kanji + ')(?:.|[\\r\\n]))+'\n\nexports.KANJI = new RegExp(kanji, 'g')\nexports.BYTE_KANJI = new RegExp('[^A-Z0-9 $%*+\\\\-./:]+', 'g')\nexports.BYTE = new RegExp(byte, 'g')\nexports.NUMERIC = new RegExp(numeric, 'g')\nexports.ALPHANUMERIC = new RegExp(alphanumeric, 'g')\n\nconst TEST_KANJI = new RegExp('^' + kanji + '$')\nconst TEST_NUMERIC = new RegExp('^' + numeric + '$')\nconst TEST_ALPHANUMERIC = new RegExp('^[A-Z0-9 $%*+\\\\-./:]+$')\n\nexports.testKanji = function testKanji (str) {\n  return TEST_KANJI.test(str)\n}\n\nexports.testNumeric = function testNumeric (str) {\n  return TEST_NUMERIC.test(str)\n}\n\nexports.testAlphanumeric = function testAlphanumeric (str) {\n  return TEST_ALPHANUMERIC.test(str)\n}\n","const VersionCheck = require('./version-check')\nconst Regex = require('./regex')\n\n/**\n * Numeric mode encodes data from the decimal digit set (0 - 9)\n * (byte values 30HEX to 39HEX).\n * Normally, 3 data characters are represented by 10 bits.\n *\n * @type {Object}\n */\nexports.NUMERIC = {\n  id: 'Numeric',\n  bit: 1 << 0,\n  ccBits: [10, 12, 14]\n}\n\n/**\n * Alphanumeric mode encodes data from a set of 45 characters,\n * i.e. 10 numeric digits (0 - 9),\n *      26 alphabetic characters (A - Z),\n *   and 9 symbols (SP, $, %, *, +, -, ., /, :).\n * Normally, two input characters are represented by 11 bits.\n *\n * @type {Object}\n */\nexports.ALPHANUMERIC = {\n  id: 'Alphanumeric',\n  bit: 1 << 1,\n  ccBits: [9, 11, 13]\n}\n\n/**\n * In byte mode, data is encoded at 8 bits per character.\n *\n * @type {Object}\n */\nexports.BYTE = {\n  id: 'Byte',\n  bit: 1 << 2,\n  ccBits: [8, 16, 16]\n}\n\n/**\n * The Kanji mode efficiently encodes Kanji characters in accordance with\n * the Shift JIS system based on JIS X 0208.\n * The Shift JIS values are shifted from the JIS X 0208 values.\n * JIS X 0208 gives details of the shift coded representation.\n * Each two-byte character value is compacted to a 13-bit binary codeword.\n *\n * @type {Object}\n */\nexports.KANJI = {\n  id: 'Kanji',\n  bit: 1 << 3,\n  ccBits: [8, 10, 12]\n}\n\n/**\n * Mixed mode will contain a sequences of data in a combination of any of\n * the modes described above\n *\n * @type {Object}\n */\nexports.MIXED = {\n  bit: -1\n}\n\n/**\n * Returns the number of bits needed to store the data length\n * according to QR Code specifications.\n *\n * @param  {Mode}   mode    Data mode\n * @param  {Number} version QR Code version\n * @return {Number}         Number of bits\n */\nexports.getCharCountIndicator = function getCharCountIndicator (mode, version) {\n  if (!mode.ccBits) throw new Error('Invalid mode: ' + mode)\n\n  if (!VersionCheck.isValid(version)) {\n    throw new Error('Invalid version: ' + version)\n  }\n\n  if (version >= 1 && version < 10) return mode.ccBits[0]\n  else if (version < 27) return mode.ccBits[1]\n  return mode.ccBits[2]\n}\n\n/**\n * Returns the most efficient mode to store the specified data\n *\n * @param  {String} dataStr Input data string\n * @return {Mode}           Best mode\n */\nexports.getBestModeForData = function getBestModeForData (dataStr) {\n  if (Regex.testNumeric(dataStr)) return exports.NUMERIC\n  else if (Regex.testAlphanumeric(dataStr)) return exports.ALPHANUMERIC\n  else if (Regex.testKanji(dataStr)) return exports.KANJI\n  else return exports.BYTE\n}\n\n/**\n * Return mode name as string\n *\n * @param {Mode} mode Mode object\n * @returns {String}  Mode name\n */\nexports.toString = function toString (mode) {\n  if (mode && mode.id) return mode.id\n  throw new Error('Invalid mode')\n}\n\n/**\n * Check if input param is a valid mode object\n *\n * @param   {Mode}    mode Mode object\n * @returns {Boolean} True if valid mode, false otherwise\n */\nexports.isValid = function isValid (mode) {\n  return mode && mode.bit && mode.ccBits\n}\n\n/**\n * Get mode object from its name\n *\n * @param   {String} string Mode name\n * @returns {Mode}          Mode object\n */\nfunction fromString (string) {\n  if (typeof string !== 'string') {\n    throw new Error('Param is not a string')\n  }\n\n  const lcStr = string.toLowerCase()\n\n  switch (lcStr) {\n    case 'numeric':\n      return exports.NUMERIC\n    case 'alphanumeric':\n      return exports.ALPHANUMERIC\n    case 'kanji':\n      return exports.KANJI\n    case 'byte':\n      return exports.BYTE\n    default:\n      throw new Error('Unknown mode: ' + string)\n  }\n}\n\n/**\n * Returns mode from a value.\n * If value is not a valid mode, returns defaultValue\n *\n * @param  {Mode|String} value        Encoding mode\n * @param  {Mode}        defaultValue Fallback value\n * @return {Mode}                     Encoding mode\n */\nexports.from = function from (value, defaultValue) {\n  if (exports.isValid(value)) {\n    return value\n  }\n\n  try {\n    return fromString(value)\n  } catch (e) {\n    return defaultValue\n  }\n}\n","const Utils = require('./utils')\nconst ECCode = require('./error-correction-code')\nconst ECLevel = require('./error-correction-level')\nconst Mode = require('./mode')\nconst VersionCheck = require('./version-check')\n\n// Generator polynomial used to encode version information\nconst G18 = (1 << 12) | (1 << 11) | (1 << 10) | (1 << 9) | (1 << 8) | (1 << 5) | (1 << 2) | (1 << 0)\nconst G18_BCH = Utils.getBCHDigit(G18)\n\nfunction getBestVersionForDataLength (mode, length, errorCorrectionLevel) {\n  for (let currentVersion = 1; currentVersion <= 40; currentVersion++) {\n    if (length <= exports.getCapacity(currentVersion, errorCorrectionLevel, mode)) {\n      return currentVersion\n    }\n  }\n\n  return undefined\n}\n\nfunction getReservedBitsCount (mode, version) {\n  // Character count indicator + mode indicator bits\n  return Mode.getCharCountIndicator(mode, version) + 4\n}\n\nfunction getTotalBitsFromDataArray (segments, version) {\n  let totalBits = 0\n\n  segments.forEach(function (data) {\n    const reservedBits = getReservedBitsCount(data.mode, version)\n    totalBits += reservedBits + data.getBitsLength()\n  })\n\n  return totalBits\n}\n\nfunction getBestVersionForMixedData (segments, errorCorrectionLevel) {\n  for (let currentVersion = 1; currentVersion <= 40; currentVersion++) {\n    const length = getTotalBitsFromDataArray(segments, currentVersion)\n    if (length <= exports.getCapacity(currentVersion, errorCorrectionLevel, Mode.MIXED)) {\n      return currentVersion\n    }\n  }\n\n  return undefined\n}\n\n/**\n * Returns version number from a value.\n * If value is not a valid version, returns defaultValue\n *\n * @param  {Number|String} value        QR Code version\n * @param  {Number}        defaultValue Fallback value\n * @return {Number}                     QR Code version number\n */\nexports.from = function from (value, defaultValue) {\n  if (VersionCheck.isValid(value)) {\n    return parseInt(value, 10)\n  }\n\n  return defaultValue\n}\n\n/**\n * Returns how much data can be stored with the specified QR code version\n * and error correction level\n *\n * @param  {Number} version              QR Code version (1-40)\n * @param  {Number} errorCorrectionLevel Error correction level\n * @param  {Mode}   mode                 Data mode\n * @return {Number}                      Quantity of storable data\n */\nexports.getCapacity = function getCapacity (version, errorCorrectionLevel, mode) {\n  if (!VersionCheck.isValid(version)) {\n    throw new Error('Invalid QR Code version')\n  }\n\n  // Use Byte mode as default\n  if (typeof mode === 'undefined') mode = Mode.BYTE\n\n  // Total codewords for this QR code version (Data + Error correction)\n  const totalCodewords = Utils.getSymbolTotalCodewords(version)\n\n  // Total number of error correction codewords\n  const ecTotalCodewords = ECCode.getTotalCodewordsCount(version, errorCorrectionLevel)\n\n  // Total number of data codewords\n  const dataTotalCodewordsBits = (totalCodewords - ecTotalCodewords) * 8\n\n  if (mode === Mode.MIXED) return dataTotalCodewordsBits\n\n  const usableBits = dataTotalCodewordsBits - getReservedBitsCount(mode, version)\n\n  // Return max number of storable codewords\n  switch (mode) {\n    case Mode.NUMERIC:\n      return Math.floor((usableBits / 10) * 3)\n\n    case Mode.ALPHANUMERIC:\n      return Math.floor((usableBits / 11) * 2)\n\n    case Mode.KANJI:\n      return Math.floor(usableBits / 13)\n\n    case Mode.BYTE:\n    default:\n      return Math.floor(usableBits / 8)\n  }\n}\n\n/**\n * Returns the minimum version needed to contain the amount of data\n *\n * @param  {Segment} data                    Segment of data\n * @param  {Number} [errorCorrectionLevel=H] Error correction level\n * @param  {Mode} mode                       Data mode\n * @return {Number}                          QR Code version\n */\nexports.getBestVersionForData = function getBestVersionForData (data, errorCorrectionLevel) {\n  let seg\n\n  const ecl = ECLevel.from(errorCorrectionLevel, ECLevel.M)\n\n  if (Array.isArray(data)) {\n    if (data.length > 1) {\n      return getBestVersionForMixedData(data, ecl)\n    }\n\n    if (data.length === 0) {\n      return 1\n    }\n\n    seg = data[0]\n  } else {\n    seg = data\n  }\n\n  return getBestVersionForDataLength(seg.mode, seg.getLength(), ecl)\n}\n\n/**\n * Returns version information with relative error correction bits\n *\n * The version information is included in QR Code symbols of version 7 or larger.\n * It consists of an 18-bit sequence containing 6 data bits,\n * with 12 error correction bits calculated using the (18, 6) Golay code.\n *\n * @param  {Number} version QR Code version\n * @return {Number}         Encoded version info bits\n */\nexports.getEncodedBits = function getEncodedBits (version) {\n  if (!VersionCheck.isValid(version) || version < 7) {\n    throw new Error('Invalid QR Code version')\n  }\n\n  let d = version << 12\n\n  while (Utils.getBCHDigit(d) - G18_BCH >= 0) {\n    d ^= (G18 << (Utils.getBCHDigit(d) - G18_BCH))\n  }\n\n  return (version << 12) | d\n}\n","const Utils = require('./utils')\n\nconst G15 = (1 << 10) | (1 << 8) | (1 << 5) | (1 << 4) | (1 << 2) | (1 << 1) | (1 << 0)\nconst G15_MASK = (1 << 14) | (1 << 12) | (1 << 10) | (1 << 4) | (1 << 1)\nconst G15_BCH = Utils.getBCHDigit(G15)\n\n/**\n * Returns format information with relative error correction bits\n *\n * The format information is a 15-bit sequence containing 5 data bits,\n * with 10 error correction bits calculated using the (15, 5) BCH code.\n *\n * @param  {Number} errorCorrectionLevel Error correction level\n * @param  {Number} mask                 Mask pattern\n * @return {Number}                      Encoded format information bits\n */\nexports.getEncodedBits = function getEncodedBits (errorCorrectionLevel, mask) {\n  const data = ((errorCorrectionLevel.bit << 3) | mask)\n  let d = data << 10\n\n  while (Utils.getBCHDigit(d) - G15_BCH >= 0) {\n    d ^= (G15 << (Utils.getBCHDigit(d) - G15_BCH))\n  }\n\n  // xor final data with mask pattern in order to ensure that\n  // no combination of Error Correction Level and data mask pattern\n  // will result in an all-zero data string\n  return ((data << 10) | d) ^ G15_MASK\n}\n","const Mode = require('./mode')\n\nfunction NumericData (data) {\n  this.mode = Mode.NUMERIC\n  this.data = data.toString()\n}\n\nNumericData.getBitsLength = function getBitsLength (length) {\n  return 10 * Math.floor(length / 3) + ((length % 3) ? ((length % 3) * 3 + 1) : 0)\n}\n\nNumericData.prototype.getLength = function getLength () {\n  return this.data.length\n}\n\nNumericData.prototype.getBitsLength = function getBitsLength () {\n  return NumericData.getBitsLength(this.data.length)\n}\n\nNumericData.prototype.write = function write (bitBuffer) {\n  let i, group, value\n\n  // The input data string is divided into groups of three digits,\n  // and each group is converted to its 10-bit binary equivalent.\n  for (i = 0; i + 3 <= this.data.length; i += 3) {\n    group = this.data.substr(i, 3)\n    value = parseInt(group, 10)\n\n    bitBuffer.put(value, 10)\n  }\n\n  // If the number of input digits is not an exact multiple of three,\n  // the final one or two digits are converted to 4 or 7 bits respectively.\n  const remainingNum = this.data.length - i\n  if (remainingNum > 0) {\n    group = this.data.substr(i)\n    value = parseInt(group, 10)\n\n    bitBuffer.put(value, remainingNum * 3 + 1)\n  }\n}\n\nmodule.exports = NumericData\n","const Mode = require('./mode')\n\n/**\n * Array of characters available in alphanumeric mode\n *\n * As per QR Code specification, to each character\n * is assigned a value from 0 to 44 which in this case coincides\n * with the array index\n *\n * @type {Array}\n */\nconst ALPHA_NUM_CHARS = [\n  '0', '1', '2', '3', '4', '5', '6', '7', '8', '9',\n  'A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M',\n  'N', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X', 'Y', 'Z',\n  ' ', '$', '%', '*', '+', '-', '.', '/', ':'\n]\n\nfunction AlphanumericData (data) {\n  this.mode = Mode.ALPHANUMERIC\n  this.data = data\n}\n\nAlphanumericData.getBitsLength = function getBitsLength (length) {\n  return 11 * Math.floor(length / 2) + 6 * (length % 2)\n}\n\nAlphanumericData.prototype.getLength = function getLength () {\n  return this.data.length\n}\n\nAlphanumericData.prototype.getBitsLength = function getBitsLength () {\n  return AlphanumericData.getBitsLength(this.data.length)\n}\n\nAlphanumericData.prototype.write = function write (bitBuffer) {\n  let i\n\n  // Input data characters are divided into groups of two characters\n  // and encoded as 11-bit binary codes.\n  for (i = 0; i + 2 <= this.data.length; i += 2) {\n    // The character value of the first character is multiplied by 45\n    let value = ALPHA_NUM_CHARS.indexOf(this.data[i]) * 45\n\n    // The character value of the second digit is added to the product\n    value += ALPHA_NUM_CHARS.indexOf(this.data[i + 1])\n\n    // The sum is then stored as 11-bit binary number\n    bitBuffer.put(value, 11)\n  }\n\n  // If the number of input data characters is not a multiple of two,\n  // the character value of the final character is encoded as a 6-bit binary number.\n  if (this.data.length % 2) {\n    bitBuffer.put(ALPHA_NUM_CHARS.indexOf(this.data[i]), 6)\n  }\n}\n\nmodule.exports = AlphanumericData\n","const Mode = require('./mode')\n\nfunction ByteData (data) {\n  this.mode = Mode.BYTE\n  if (typeof (data) === 'string') {\n    this.data = new TextEncoder().encode(data)\n  } else {\n    this.data = new Uint8Array(data)\n  }\n}\n\nByteData.getBitsLength = function getBitsLength (length) {\n  return length * 8\n}\n\nByteData.prototype.getLength = function getLength () {\n  return this.data.length\n}\n\nByteData.prototype.getBitsLength = function getBitsLength () {\n  return ByteData.getBitsLength(this.data.length)\n}\n\nByteData.prototype.write = function (bitBuffer) {\n  for (let i = 0, l = this.data.length; i < l; i++) {\n    bitBuffer.put(this.data[i], 8)\n  }\n}\n\nmodule.exports = ByteData\n","const Mode = require('./mode')\nconst Utils = require('./utils')\n\nfunction KanjiData (data) {\n  this.mode = Mode.KANJI\n  this.data = data\n}\n\nKanjiData.getBitsLength = function getBitsLength (length) {\n  return length * 13\n}\n\nKanjiData.prototype.getLength = function getLength () {\n  return this.data.length\n}\n\nKanjiData.prototype.getBitsLength = function getBitsLength () {\n  return KanjiData.getBitsLength(this.data.length)\n}\n\nKanjiData.prototype.write = function (bitBuffer) {\n  let i\n\n  // In the Shift JIS system, Kanji characters are represented by a two byte combination.\n  // These byte values are shifted from the JIS X 0208 values.\n  // JIS X 0208 gives details of the shift coded representation.\n  for (i = 0; i < this.data.length; i++) {\n    let value = Utils.toSJIS(this.data[i])\n\n    // For characters with Shift JIS values from 0x8140 to 0x9FFC:\n    if (value >= 0x8140 && value <= 0x9FFC) {\n      // Subtract 0x8140 from Shift JIS value\n      value -= 0x8140\n\n    // For characters with Shift JIS values from 0xE040 to 0xEBBF\n    } else if (value >= 0xE040 && value <= 0xEBBF) {\n      // Subtract 0xC140 from Shift JIS value\n      value -= 0xC140\n    } else {\n      throw new Error(\n        'Invalid SJIS character: ' + this.data[i] + '\\n' +\n        'Make sure your charset is UTF-8')\n    }\n\n    // Multiply most significant byte of result by 0xC0\n    // and add least significant byte to product\n    value = (((value >>> 8) & 0xff) * 0xC0) + (value & 0xff)\n\n    // Convert result to a 13-bit binary string\n    bitBuffer.put(value, 13)\n  }\n}\n\nmodule.exports = KanjiData\n","'use strict';\n\n/******************************************************************************\n * Created 2008-08-19.\n *\n * Dijkstra path-finding functions. Adapted from the Dijkstar Python project.\n *\n * Copyright (C) 2008\n *   Wyatt Baldwin <self@wyattbaldwin.com>\n *   All rights reserved\n *\n * Licensed under the MIT license.\n *\n *   http://www.opensource.org/licenses/mit-license.php\n *\n * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n * THE SOFTWARE.\n *****************************************************************************/\nvar dijkstra = {\n  single_source_shortest_paths: function(graph, s, d) {\n    // Predecessor map for each node that has been encountered.\n    // node ID => predecessor node ID\n    var predecessors = {};\n\n    // Costs of shortest paths from s to all nodes encountered.\n    // node ID => cost\n    var costs = {};\n    costs[s] = 0;\n\n    // Costs of shortest paths from s to all nodes encountered; differs from\n    // `costs` in that it provides easy access to the node that currently has\n    // the known shortest path from s.\n    // XXX: Do we actually need both `costs` and `open`?\n    var open = dijkstra.PriorityQueue.make();\n    open.push(s, 0);\n\n    var closest,\n        u, v,\n        cost_of_s_to_u,\n        adjacent_nodes,\n        cost_of_e,\n        cost_of_s_to_u_plus_cost_of_e,\n        cost_of_s_to_v,\n        first_visit;\n    while (!open.empty()) {\n      // In the nodes remaining in graph that have a known cost from s,\n      // find the node, u, that currently has the shortest path from s.\n      closest = open.pop();\n      u = closest.value;\n      cost_of_s_to_u = closest.cost;\n\n      // Get nodes adjacent to u...\n      adjacent_nodes = graph[u] || {};\n\n      // ...and explore the edges that connect u to those nodes, updating\n      // the cost of the shortest paths to any or all of those nodes as\n      // necessary. v is the node across the current edge from u.\n      for (v in adjacent_nodes) {\n        if (adjacent_nodes.hasOwnProperty(v)) {\n          // Get the cost of the edge running from u to v.\n          cost_of_e = adjacent_nodes[v];\n\n          // Cost of s to u plus the cost of u to v across e--this is *a*\n          // cost from s to v that may or may not be less than the current\n          // known cost to v.\n          cost_of_s_to_u_plus_cost_of_e = cost_of_s_to_u + cost_of_e;\n\n          // If we haven't visited v yet OR if the current known cost from s to\n          // v is greater than the new cost we just found (cost of s to u plus\n          // cost of u to v across e), update v's cost in the cost list and\n          // update v's predecessor in the predecessor list (it's now u).\n          cost_of_s_to_v = costs[v];\n          first_visit = (typeof costs[v] === 'undefined');\n          if (first_visit || cost_of_s_to_v > cost_of_s_to_u_plus_cost_of_e) {\n            costs[v] = cost_of_s_to_u_plus_cost_of_e;\n            open.push(v, cost_of_s_to_u_plus_cost_of_e);\n            predecessors[v] = u;\n          }\n        }\n      }\n    }\n\n    if (typeof d !== 'undefined' && typeof costs[d] === 'undefined') {\n      var msg = ['Could not find a path from ', s, ' to ', d, '.'].join('');\n      throw new Error(msg);\n    }\n\n    return predecessors;\n  },\n\n  extract_shortest_path_from_predecessor_list: function(predecessors, d) {\n    var nodes = [];\n    var u = d;\n    var predecessor;\n    while (u) {\n      nodes.push(u);\n      predecessor = predecessors[u];\n      u = predecessors[u];\n    }\n    nodes.reverse();\n    return nodes;\n  },\n\n  find_path: function(graph, s, d) {\n    var predecessors = dijkstra.single_source_shortest_paths(graph, s, d);\n    return dijkstra.extract_shortest_path_from_predecessor_list(\n      predecessors, d);\n  },\n\n  /**\n   * A very naive priority queue implementation.\n   */\n  PriorityQueue: {\n    make: function (opts) {\n      var T = dijkstra.PriorityQueue,\n          t = {},\n          key;\n      opts = opts || {};\n      for (key in T) {\n        if (T.hasOwnProperty(key)) {\n          t[key] = T[key];\n        }\n      }\n      t.queue = [];\n      t.sorter = opts.sorter || T.default_sorter;\n      return t;\n    },\n\n    default_sorter: function (a, b) {\n      return a.cost - b.cost;\n    },\n\n    /**\n     * Add a new item to the queue and ensure the highest priority element\n     * is at the front of the queue.\n     */\n    push: function (value, cost) {\n      var item = {value: value, cost: cost};\n      this.queue.push(item);\n      this.queue.sort(this.sorter);\n    },\n\n    /**\n     * Return the highest priority element in the queue.\n     */\n    pop: function () {\n      return this.queue.shift();\n    },\n\n    empty: function () {\n      return this.queue.length === 0;\n    }\n  }\n};\n\n\n// node.js module exports\nif (typeof module !== 'undefined') {\n  module.exports = dijkstra;\n}\n","const Mode = require('./mode')\nconst NumericData = require('./numeric-data')\nconst AlphanumericData = require('./alphanumeric-data')\nconst ByteData = require('./byte-data')\nconst KanjiData = require('./kanji-data')\nconst Regex = require('./regex')\nconst Utils = require('./utils')\nconst dijkstra = require('dijkstrajs')\n\n/**\n * Returns UTF8 byte length\n *\n * @param  {String} str Input string\n * @return {Number}     Number of byte\n */\nfunction getStringByteLength (str) {\n  return unescape(encodeURIComponent(str)).length\n}\n\n/**\n * Get a list of segments of the specified mode\n * from a string\n *\n * @param  {Mode}   mode Segment mode\n * @param  {String} str  String to process\n * @return {Array}       Array of object with segments data\n */\nfunction getSegments (regex, mode, str) {\n  const segments = []\n  let result\n\n  while ((result = regex.exec(str)) !== null) {\n    segments.push({\n      data: result[0],\n      index: result.index,\n      mode: mode,\n      length: result[0].length\n    })\n  }\n\n  return segments\n}\n\n/**\n * Extracts a series of segments with the appropriate\n * modes from a string\n *\n * @param  {String} dataStr Input string\n * @return {Array}          Array of object with segments data\n */\nfunction getSegmentsFromString (dataStr) {\n  const numSegs = getSegments(Regex.NUMERIC, Mode.NUMERIC, dataStr)\n  const alphaNumSegs = getSegments(Regex.ALPHANUMERIC, Mode.ALPHANUMERIC, dataStr)\n  let byteSegs\n  let kanjiSegs\n\n  if (Utils.isKanjiModeEnabled()) {\n    byteSegs = getSegments(Regex.BYTE, Mode.BYTE, dataStr)\n    kanjiSegs = getSegments(Regex.KANJI, Mode.KANJI, dataStr)\n  } else {\n    byteSegs = getSegments(Regex.BYTE_KANJI, Mode.BYTE, dataStr)\n    kanjiSegs = []\n  }\n\n  const segs = numSegs.concat(alphaNumSegs, byteSegs, kanjiSegs)\n\n  return segs\n    .sort(function (s1, s2) {\n      return s1.index - s2.index\n    })\n    .map(function (obj) {\n      return {\n        data: obj.data,\n        mode: obj.mode,\n        length: obj.length\n      }\n    })\n}\n\n/**\n * Returns how many bits are needed to encode a string of\n * specified length with the specified mode\n *\n * @param  {Number} length String length\n * @param  {Mode} mode     Segment mode\n * @return {Number}        Bit length\n */\nfunction getSegmentBitsLength (length, mode) {\n  switch (mode) {\n    case Mode.NUMERIC:\n      return NumericData.getBitsLength(length)\n    case Mode.ALPHANUMERIC:\n      return AlphanumericData.getBitsLength(length)\n    case Mode.KANJI:\n      return KanjiData.getBitsLength(length)\n    case Mode.BYTE:\n      return ByteData.getBitsLength(length)\n  }\n}\n\n/**\n * Merges adjacent segments which have the same mode\n *\n * @param  {Array} segs Array of object with segments data\n * @return {Array}      Array of object with segments data\n */\nfunction mergeSegments (segs) {\n  return segs.reduce(function (acc, curr) {\n    const prevSeg = acc.length - 1 >= 0 ? acc[acc.length - 1] : null\n    if (prevSeg && prevSeg.mode === curr.mode) {\n      acc[acc.length - 1].data += curr.data\n      return acc\n    }\n\n    acc.push(curr)\n    return acc\n  }, [])\n}\n\n/**\n * Generates a list of all possible nodes combination which\n * will be used to build a segments graph.\n *\n * Nodes are divided by groups. Each group will contain a list of all the modes\n * in which is possible to encode the given text.\n *\n * For example the text '12345' can be encoded as Numeric, Alphanumeric or Byte.\n * The group for '12345' will contain then 3 objects, one for each\n * possible encoding mode.\n *\n * Each node represents a possible segment.\n *\n * @param  {Array} segs Array of object with segments data\n * @return {Array}      Array of object with segments data\n */\nfunction buildNodes (segs) {\n  const nodes = []\n  for (let i = 0; i < segs.length; i++) {\n    const seg = segs[i]\n\n    switch (seg.mode) {\n      case Mode.NUMERIC:\n        nodes.push([seg,\n          { data: seg.data, mode: Mode.ALPHANUMERIC, length: seg.length },\n          { data: seg.data, mode: Mode.BYTE, length: seg.length }\n        ])\n        break\n      case Mode.ALPHANUMERIC:\n        nodes.push([seg,\n          { data: seg.data, mode: Mode.BYTE, length: seg.length }\n        ])\n        break\n      case Mode.KANJI:\n        nodes.push([seg,\n          { data: seg.data, mode: Mode.BYTE, length: getStringByteLength(seg.data) }\n        ])\n        break\n      case Mode.BYTE:\n        nodes.push([\n          { data: seg.data, mode: Mode.BYTE, length: getStringByteLength(seg.data) }\n        ])\n    }\n  }\n\n  return nodes\n}\n\n/**\n * Builds a graph from a list of nodes.\n * All segments in each node group will be connected with all the segments of\n * the next group and so on.\n *\n * At each connection will be assigned a weight depending on the\n * segment's byte length.\n *\n * @param  {Array} nodes    Array of object with segments data\n * @param  {Number} version QR Code version\n * @return {Object}         Graph of all possible segments\n */\nfunction buildGraph (nodes, version) {\n  const table = {}\n  const graph = { start: {} }\n  let prevNodeIds = ['start']\n\n  for (let i = 0; i < nodes.length; i++) {\n    const nodeGroup = nodes[i]\n    const currentNodeIds = []\n\n    for (let j = 0; j < nodeGroup.length; j++) {\n      const node = nodeGroup[j]\n      const key = '' + i + j\n\n      currentNodeIds.push(key)\n      table[key] = { node: node, lastCount: 0 }\n      graph[key] = {}\n\n      for (let n = 0; n < prevNodeIds.length; n++) {\n        const prevNodeId = prevNodeIds[n]\n\n        if (table[prevNodeId] && table[prevNodeId].node.mode === node.mode) {\n          graph[prevNodeId][key] =\n            getSegmentBitsLength(table[prevNodeId].lastCount + node.length, node.mode) -\n            getSegmentBitsLength(table[prevNodeId].lastCount, node.mode)\n\n          table[prevNodeId].lastCount += node.length\n        } else {\n          if (table[prevNodeId]) table[prevNodeId].lastCount = node.length\n\n          graph[prevNodeId][key] = getSegmentBitsLength(node.length, node.mode) +\n            4 + Mode.getCharCountIndicator(node.mode, version) // switch cost\n        }\n      }\n    }\n\n    prevNodeIds = currentNodeIds\n  }\n\n  for (let n = 0; n < prevNodeIds.length; n++) {\n    graph[prevNodeIds[n]].end = 0\n  }\n\n  return { map: graph, table: table }\n}\n\n/**\n * Builds a segment from a specified data and mode.\n * If a mode is not specified, the more suitable will be used.\n *\n * @param  {String} data             Input data\n * @param  {Mode | String} modesHint Data mode\n * @return {Segment}                 Segment\n */\nfunction buildSingleSegment (data, modesHint) {\n  let mode\n  const bestMode = Mode.getBestModeForData(data)\n\n  mode = Mode.from(modesHint, bestMode)\n\n  // Make sure data can be encoded\n  if (mode !== Mode.BYTE && mode.bit < bestMode.bit) {\n    throw new Error('\"' + data + '\"' +\n      ' cannot be encoded with mode ' + Mode.toString(mode) +\n      '.\\n Suggested mode is: ' + Mode.toString(bestMode))\n  }\n\n  // Use Mode.BYTE if Kanji support is disabled\n  if (mode === Mode.KANJI && !Utils.isKanjiModeEnabled()) {\n    mode = Mode.BYTE\n  }\n\n  switch (mode) {\n    case Mode.NUMERIC:\n      return new NumericData(data)\n\n    case Mode.ALPHANUMERIC:\n      return new AlphanumericData(data)\n\n    case Mode.KANJI:\n      return new KanjiData(data)\n\n    case Mode.BYTE:\n      return new ByteData(data)\n  }\n}\n\n/**\n * Builds a list of segments from an array.\n * Array can contain Strings or Objects with segment's info.\n *\n * For each item which is a string, will be generated a segment with the given\n * string and the more appropriate encoding mode.\n *\n * For each item which is an object, will be generated a segment with the given\n * data and mode.\n * Objects must contain at least the property \"data\".\n * If property \"mode\" is not present, the more suitable mode will be used.\n *\n * @param  {Array} array Array of objects with segments data\n * @return {Array}       Array of Segments\n */\nexports.fromArray = function fromArray (array) {\n  return array.reduce(function (acc, seg) {\n    if (typeof seg === 'string') {\n      acc.push(buildSingleSegment(seg, null))\n    } else if (seg.data) {\n      acc.push(buildSingleSegment(seg.data, seg.mode))\n    }\n\n    return acc\n  }, [])\n}\n\n/**\n * Builds an optimized sequence of segments from a string,\n * which will produce the shortest possible bitstream.\n *\n * @param  {String} data    Input string\n * @param  {Number} version QR Code version\n * @return {Array}          Array of segments\n */\nexports.fromString = function fromString (data, version) {\n  const segs = getSegmentsFromString(data, Utils.isKanjiModeEnabled())\n\n  const nodes = buildNodes(segs)\n  const graph = buildGraph(nodes, version)\n  const path = dijkstra.find_path(graph.map, 'start', 'end')\n\n  const optimizedSegs = []\n  for (let i = 1; i < path.length - 1; i++) {\n    optimizedSegs.push(graph.table[path[i]].node)\n  }\n\n  return exports.fromArray(mergeSegments(optimizedSegs))\n}\n\n/**\n * Splits a string in various segments with the modes which\n * best represent their content.\n * The produced segments are far from being optimized.\n * The output of this function is only used to estimate a QR Code version\n * which may contain the data.\n *\n * @param  {string} data Input string\n * @return {Array}       Array of segments\n */\nexports.rawSplit = function rawSplit (data) {\n  return exports.fromArray(\n    getSegmentsFromString(data, Utils.isKanjiModeEnabled())\n  )\n}\n","const Utils = require('./utils')\nconst ECLevel = require('./error-correction-level')\nconst BitBuffer = require('./bit-buffer')\nconst BitMatrix = require('./bit-matrix')\nconst AlignmentPattern = require('./alignment-pattern')\nconst FinderPattern = require('./finder-pattern')\nconst MaskPattern = require('./mask-pattern')\nconst ECCode = require('./error-correction-code')\nconst ReedSolomonEncoder = require('./reed-solomon-encoder')\nconst Version = require('./version')\nconst FormatInfo = require('./format-info')\nconst Mode = require('./mode')\nconst Segments = require('./segments')\n\n/**\n * QRCode for JavaScript\n *\n * modified by Ryan Day for nodejs support\n * Copyright (c) 2011 Ryan Day\n *\n * Licensed under the MIT license:\n *   http://www.opensource.org/licenses/mit-license.php\n *\n//---------------------------------------------------------------------\n// QRCode for JavaScript\n//\n// Copyright (c) 2009 Kazuhiko Arase\n//\n// URL: http://www.d-project.com/\n//\n// Licensed under the MIT license:\n//   http://www.opensource.org/licenses/mit-license.php\n//\n// The word \"QR Code\" is registered trademark of\n// DENSO WAVE INCORPORATED\n//   http://www.denso-wave.com/qrcode/faqpatent-e.html\n//\n//---------------------------------------------------------------------\n*/\n\n/**\n * Add finder patterns bits to matrix\n *\n * @param  {BitMatrix} matrix  Modules matrix\n * @param  {Number}    version QR Code version\n */\nfunction setupFinderPattern (matrix, version) {\n  const size = matrix.size\n  const pos = FinderPattern.getPositions(version)\n\n  for (let i = 0; i < pos.length; i++) {\n    const row = pos[i][0]\n    const col = pos[i][1]\n\n    for (let r = -1; r <= 7; r++) {\n      if (row + r <= -1 || size <= row + r) continue\n\n      for (let c = -1; c <= 7; c++) {\n        if (col + c <= -1 || size <= col + c) continue\n\n        if ((r >= 0 && r <= 6 && (c === 0 || c === 6)) ||\n          (c >= 0 && c <= 6 && (r === 0 || r === 6)) ||\n          (r >= 2 && r <= 4 && c >= 2 && c <= 4)) {\n          matrix.set(row + r, col + c, true, true)\n        } else {\n          matrix.set(row + r, col + c, false, true)\n        }\n      }\n    }\n  }\n}\n\n/**\n * Add timing pattern bits to matrix\n *\n * Note: this function must be called before {@link setupAlignmentPattern}\n *\n * @param  {BitMatrix} matrix Modules matrix\n */\nfunction setupTimingPattern (matrix) {\n  const size = matrix.size\n\n  for (let r = 8; r < size - 8; r++) {\n    const value = r % 2 === 0\n    matrix.set(r, 6, value, true)\n    matrix.set(6, r, value, true)\n  }\n}\n\n/**\n * Add alignment patterns bits to matrix\n *\n * Note: this function must be called after {@link setupTimingPattern}\n *\n * @param  {BitMatrix} matrix  Modules matrix\n * @param  {Number}    version QR Code version\n */\nfunction setupAlignmentPattern (matrix, version) {\n  const pos = AlignmentPattern.getPositions(version)\n\n  for (let i = 0; i < pos.length; i++) {\n    const row = pos[i][0]\n    const col = pos[i][1]\n\n    for (let r = -2; r <= 2; r++) {\n      for (let c = -2; c <= 2; c++) {\n        if (r === -2 || r === 2 || c === -2 || c === 2 ||\n          (r === 0 && c === 0)) {\n          matrix.set(row + r, col + c, true, true)\n        } else {\n          matrix.set(row + r, col + c, false, true)\n        }\n      }\n    }\n  }\n}\n\n/**\n * Add version info bits to matrix\n *\n * @param  {BitMatrix} matrix  Modules matrix\n * @param  {Number}    version QR Code version\n */\nfunction setupVersionInfo (matrix, version) {\n  const size = matrix.size\n  const bits = Version.getEncodedBits(version)\n  let row, col, mod\n\n  for (let i = 0; i < 18; i++) {\n    row = Math.floor(i / 3)\n    col = i % 3 + size - 8 - 3\n    mod = ((bits >> i) & 1) === 1\n\n    matrix.set(row, col, mod, true)\n    matrix.set(col, row, mod, true)\n  }\n}\n\n/**\n * Add format info bits to matrix\n *\n * @param  {BitMatrix} matrix               Modules matrix\n * @param  {ErrorCorrectionLevel}    errorCorrectionLevel Error correction level\n * @param  {Number}    maskPattern          Mask pattern reference value\n */\nfunction setupFormatInfo (matrix, errorCorrectionLevel, maskPattern) {\n  const size = matrix.size\n  const bits = FormatInfo.getEncodedBits(errorCorrectionLevel, maskPattern)\n  let i, mod\n\n  for (i = 0; i < 15; i++) {\n    mod = ((bits >> i) & 1) === 1\n\n    // vertical\n    if (i < 6) {\n      matrix.set(i, 8, mod, true)\n    } else if (i < 8) {\n      matrix.set(i + 1, 8, mod, true)\n    } else {\n      matrix.set(size - 15 + i, 8, mod, true)\n    }\n\n    // horizontal\n    if (i < 8) {\n      matrix.set(8, size - i - 1, mod, true)\n    } else if (i < 9) {\n      matrix.set(8, 15 - i - 1 + 1, mod, true)\n    } else {\n      matrix.set(8, 15 - i - 1, mod, true)\n    }\n  }\n\n  // fixed module\n  matrix.set(size - 8, 8, 1, true)\n}\n\n/**\n * Add encoded data bits to matrix\n *\n * @param  {BitMatrix}  matrix Modules matrix\n * @param  {Uint8Array} data   Data codewords\n */\nfunction setupData (matrix, data) {\n  const size = matrix.size\n  let inc = -1\n  let row = size - 1\n  let bitIndex = 7\n  let byteIndex = 0\n\n  for (let col = size - 1; col > 0; col -= 2) {\n    if (col === 6) col--\n\n    while (true) {\n      for (let c = 0; c < 2; c++) {\n        if (!matrix.isReserved(row, col - c)) {\n          let dark = false\n\n          if (byteIndex < data.length) {\n            dark = (((data[byteIndex] >>> bitIndex) & 1) === 1)\n          }\n\n          matrix.set(row, col - c, dark)\n          bitIndex--\n\n          if (bitIndex === -1) {\n            byteIndex++\n            bitIndex = 7\n          }\n        }\n      }\n\n      row += inc\n\n      if (row < 0 || size <= row) {\n        row -= inc\n        inc = -inc\n        break\n      }\n    }\n  }\n}\n\n/**\n * Create encoded codewords from data input\n *\n * @param  {Number}   version              QR Code version\n * @param  {ErrorCorrectionLevel}   errorCorrectionLevel Error correction level\n * @param  {ByteData} data                 Data input\n * @return {Uint8Array}                    Buffer containing encoded codewords\n */\nfunction createData (version, errorCorrectionLevel, segments) {\n  // Prepare data buffer\n  const buffer = new BitBuffer()\n\n  segments.forEach(function (data) {\n    // prefix data with mode indicator (4 bits)\n    buffer.put(data.mode.bit, 4)\n\n    // Prefix data with character count indicator.\n    // The character count indicator is a string of bits that represents the\n    // number of characters that are being encoded.\n    // The character count indicator must be placed after the mode indicator\n    // and must be a certain number of bits long, depending on the QR version\n    // and data mode\n    // @see {@link Mode.getCharCountIndicator}.\n    buffer.put(data.getLength(), Mode.getCharCountIndicator(data.mode, version))\n\n    // add binary data sequence to buffer\n    data.write(buffer)\n  })\n\n  // Calculate required number of bits\n  const totalCodewords = Utils.getSymbolTotalCodewords(version)\n  const ecTotalCodewords = ECCode.getTotalCodewordsCount(version, errorCorrectionLevel)\n  const dataTotalCodewordsBits = (totalCodewords - ecTotalCodewords) * 8\n\n  // Add a terminator.\n  // If the bit string is shorter than the total number of required bits,\n  // a terminator of up to four 0s must be added to the right side of the string.\n  // If the bit string is more than four bits shorter than the required number of bits,\n  // add four 0s to the end.\n  if (buffer.getLengthInBits() + 4 <= dataTotalCodewordsBits) {\n    buffer.put(0, 4)\n  }\n\n  // If the bit string is fewer than four bits shorter, add only the number of 0s that\n  // are needed to reach the required number of bits.\n\n  // After adding the terminator, if the number of bits in the string is not a multiple of 8,\n  // pad the string on the right with 0s to make the string's length a multiple of 8.\n  while (buffer.getLengthInBits() % 8 !== 0) {\n    buffer.putBit(0)\n  }\n\n  // Add pad bytes if the string is still shorter than the total number of required bits.\n  // Extend the buffer to fill the data capacity of the symbol corresponding to\n  // the Version and Error Correction Level by adding the Pad Codewords 11101100 (0xEC)\n  // and 00010001 (0x11) alternately.\n  const remainingByte = (dataTotalCodewordsBits - buffer.getLengthInBits()) / 8\n  for (let i = 0; i < remainingByte; i++) {\n    buffer.put(i % 2 ? 0x11 : 0xEC, 8)\n  }\n\n  return createCodewords(buffer, version, errorCorrectionLevel)\n}\n\n/**\n * Encode input data with Reed-Solomon and return codewords with\n * relative error correction bits\n *\n * @param  {BitBuffer} bitBuffer            Data to encode\n * @param  {Number}    version              QR Code version\n * @param  {ErrorCorrectionLevel} errorCorrectionLevel Error correction level\n * @return {Uint8Array}                     Buffer containing encoded codewords\n */\nfunction createCodewords (bitBuffer, version, errorCorrectionLevel) {\n  // Total codewords for this QR code version (Data + Error correction)\n  const totalCodewords = Utils.getSymbolTotalCodewords(version)\n\n  // Total number of error correction codewords\n  const ecTotalCodewords = ECCode.getTotalCodewordsCount(version, errorCorrectionLevel)\n\n  // Total number of data codewords\n  const dataTotalCodewords = totalCodewords - ecTotalCodewords\n\n  // Total number of blocks\n  const ecTotalBlocks = ECCode.getBlocksCount(version, errorCorrectionLevel)\n\n  // Calculate how many blocks each group should contain\n  const blocksInGroup2 = totalCodewords % ecTotalBlocks\n  const blocksInGroup1 = ecTotalBlocks - blocksInGroup2\n\n  const totalCodewordsInGroup1 = Math.floor(totalCodewords / ecTotalBlocks)\n\n  const dataCodewordsInGroup1 = Math.floor(dataTotalCodewords / ecTotalBlocks)\n  const dataCodewordsInGroup2 = dataCodewordsInGroup1 + 1\n\n  // Number of EC codewords is the same for both groups\n  const ecCount = totalCodewordsInGroup1 - dataCodewordsInGroup1\n\n  // Initialize a Reed-Solomon encoder with a generator polynomial of degree ecCount\n  const rs = new ReedSolomonEncoder(ecCount)\n\n  let offset = 0\n  const dcData = new Array(ecTotalBlocks)\n  const ecData = new Array(ecTotalBlocks)\n  let maxDataSize = 0\n  const buffer = new Uint8Array(bitBuffer.buffer)\n\n  // Divide the buffer into the required number of blocks\n  for (let b = 0; b < ecTotalBlocks; b++) {\n    const dataSize = b < blocksInGroup1 ? dataCodewordsInGroup1 : dataCodewordsInGroup2\n\n    // extract a block of data from buffer\n    dcData[b] = buffer.slice(offset, offset + dataSize)\n\n    // Calculate EC codewords for this data block\n    ecData[b] = rs.encode(dcData[b])\n\n    offset += dataSize\n    maxDataSize = Math.max(maxDataSize, dataSize)\n  }\n\n  // Create final data\n  // Interleave the data and error correction codewords from each block\n  const data = new Uint8Array(totalCodewords)\n  let index = 0\n  let i, r\n\n  // Add data codewords\n  for (i = 0; i < maxDataSize; i++) {\n    for (r = 0; r < ecTotalBlocks; r++) {\n      if (i < dcData[r].length) {\n        data[index++] = dcData[r][i]\n      }\n    }\n  }\n\n  // Apped EC codewords\n  for (i = 0; i < ecCount; i++) {\n    for (r = 0; r < ecTotalBlocks; r++) {\n      data[index++] = ecData[r][i]\n    }\n  }\n\n  return data\n}\n\n/**\n * Build QR Code symbol\n *\n * @param  {String} data                 Input string\n * @param  {Number} version              QR Code version\n * @param  {ErrorCorretionLevel} errorCorrectionLevel Error level\n * @param  {MaskPattern} maskPattern     Mask pattern\n * @return {Object}                      Object containing symbol data\n */\nfunction createSymbol (data, version, errorCorrectionLevel, maskPattern) {\n  let segments\n\n  if (Array.isArray(data)) {\n    segments = Segments.fromArray(data)\n  } else if (typeof data === 'string') {\n    let estimatedVersion = version\n\n    if (!estimatedVersion) {\n      const rawSegments = Segments.rawSplit(data)\n\n      // Estimate best version that can contain raw splitted segments\n      estimatedVersion = Version.getBestVersionForData(rawSegments, errorCorrectionLevel)\n    }\n\n    // Build optimized segments\n    // If estimated version is undefined, try with the highest version\n    segments = Segments.fromString(data, estimatedVersion || 40)\n  } else {\n    throw new Error('Invalid data')\n  }\n\n  // Get the min version that can contain data\n  const bestVersion = Version.getBestVersionForData(segments, errorCorrectionLevel)\n\n  // If no version is found, data cannot be stored\n  if (!bestVersion) {\n    throw new Error('The amount of data is too big to be stored in a QR Code')\n  }\n\n  // If not specified, use min version as default\n  if (!version) {\n    version = bestVersion\n\n  // Check if the specified version can contain the data\n  } else if (version < bestVersion) {\n    throw new Error('\\n' +\n      'The chosen QR Code version cannot contain this amount of data.\\n' +\n      'Minimum version required to store current data is: ' + bestVersion + '.\\n'\n    )\n  }\n\n  const dataBits = createData(version, errorCorrectionLevel, segments)\n\n  // Allocate matrix buffer\n  const moduleCount = Utils.getSymbolSize(version)\n  const modules = new BitMatrix(moduleCount)\n\n  // Add function modules\n  setupFinderPattern(modules, version)\n  setupTimingPattern(modules)\n  setupAlignmentPattern(modules, version)\n\n  // Add temporary dummy bits for format info just to set them as reserved.\n  // This is needed to prevent these bits from being masked by {@link MaskPattern.applyMask}\n  // since the masking operation must be performed only on the encoding region.\n  // These blocks will be replaced with correct values later in code.\n  setupFormatInfo(modules, errorCorrectionLevel, 0)\n\n  if (version >= 7) {\n    setupVersionInfo(modules, version)\n  }\n\n  // Add data codewords\n  setupData(modules, dataBits)\n\n  if (isNaN(maskPattern)) {\n    // Find best mask pattern\n    maskPattern = MaskPattern.getBestMask(modules,\n      setupFormatInfo.bind(null, modules, errorCorrectionLevel))\n  }\n\n  // Apply mask pattern\n  MaskPattern.applyMask(maskPattern, modules)\n\n  // Replace format info bits with correct values\n  setupFormatInfo(modules, errorCorrectionLevel, maskPattern)\n\n  return {\n    modules: modules,\n    version: version,\n    errorCorrectionLevel: errorCorrectionLevel,\n    maskPattern: maskPattern,\n    segments: segments\n  }\n}\n\n/**\n * QR Code\n *\n * @param {String | Array} data                 Input data\n * @param {Object} options                      Optional configurations\n * @param {Number} options.version              QR Code version\n * @param {String} options.errorCorrectionLevel Error correction level\n * @param {Function} options.toSJISFunc         Helper func to convert utf8 to sjis\n */\nexports.create = function create (data, options) {\n  if (typeof data === 'undefined' || data === '') {\n    throw new Error('No input text')\n  }\n\n  let errorCorrectionLevel = ECLevel.M\n  let version\n  let mask\n\n  if (typeof options !== 'undefined') {\n    // Use higher error correction level as default\n    errorCorrectionLevel = ECLevel.from(options.errorCorrectionLevel, ECLevel.M)\n    version = Version.from(options.version)\n    mask = MaskPattern.from(options.maskPattern)\n\n    if (options.toSJISFunc) {\n      Utils.setToSJISFunction(options.toSJISFunc)\n    }\n  }\n\n  return createSymbol(data, version, errorCorrectionLevel, mask)\n}\n","function hex2rgba (hex) {\n  if (typeof hex === 'number') {\n    hex = hex.toString()\n  }\n\n  if (typeof hex !== 'string') {\n    throw new Error('Color should be defined as hex string')\n  }\n\n  let hexCode = hex.slice().replace('#', '').split('')\n  if (hexCode.length < 3 || hexCode.length === 5 || hexCode.length > 8) {\n    throw new Error('Invalid hex color: ' + hex)\n  }\n\n  // Convert from short to long form (fff -> ffffff)\n  if (hexCode.length === 3 || hexCode.length === 4) {\n    hexCode = Array.prototype.concat.apply([], hexCode.map(function (c) {\n      return [c, c]\n    }))\n  }\n\n  // Add default alpha value\n  if (hexCode.length === 6) hexCode.push('F', 'F')\n\n  const hexValue = parseInt(hexCode.join(''), 16)\n\n  return {\n    r: (hexValue >> 24) & 255,\n    g: (hexValue >> 16) & 255,\n    b: (hexValue >> 8) & 255,\n    a: hexValue & 255,\n    hex: '#' + hexCode.slice(0, 6).join('')\n  }\n}\n\nexports.getOptions = function getOptions (options) {\n  if (!options) options = {}\n  if (!options.color) options.color = {}\n\n  const margin = typeof options.margin === 'undefined' ||\n    options.margin === null ||\n    options.margin < 0\n    ? 4\n    : options.margin\n\n  const width = options.width && options.width >= 21 ? options.width : undefined\n  const scale = options.scale || 4\n\n  return {\n    width: width,\n    scale: width ? 4 : scale,\n    margin: margin,\n    color: {\n      dark: hex2rgba(options.color.dark || '#000000ff'),\n      light: hex2rgba(options.color.light || '#ffffffff')\n    },\n    type: options.type,\n    rendererOpts: options.rendererOpts || {}\n  }\n}\n\nexports.getScale = function getScale (qrSize, opts) {\n  return opts.width && opts.width >= qrSize + opts.margin * 2\n    ? opts.width / (qrSize + opts.margin * 2)\n    : opts.scale\n}\n\nexports.getImageWidth = function getImageWidth (qrSize, opts) {\n  const scale = exports.getScale(qrSize, opts)\n  return Math.floor((qrSize + opts.margin * 2) * scale)\n}\n\nexports.qrToImageData = function qrToImageData (imgData, qr, opts) {\n  const size = qr.modules.size\n  const data = qr.modules.data\n  const scale = exports.getScale(size, opts)\n  const symbolSize = Math.floor((size + opts.margin * 2) * scale)\n  const scaledMargin = opts.margin * scale\n  const palette = [opts.color.light, opts.color.dark]\n\n  for (let i = 0; i < symbolSize; i++) {\n    for (let j = 0; j < symbolSize; j++) {\n      let posDst = (i * symbolSize + j) * 4\n      let pxColor = opts.color.light\n\n      if (i >= scaledMargin && j >= scaledMargin &&\n        i < symbolSize - scaledMargin && j < symbolSize - scaledMargin) {\n        const iSrc = Math.floor((i - scaledMargin) / scale)\n        const jSrc = Math.floor((j - scaledMargin) / scale)\n        pxColor = palette[data[iSrc * size + jSrc] ? 1 : 0]\n      }\n\n      imgData[posDst++] = pxColor.r\n      imgData[posDst++] = pxColor.g\n      imgData[posDst++] = pxColor.b\n      imgData[posDst] = pxColor.a\n    }\n  }\n}\n","const Utils = require('./utils')\n\nfunction clearCanvas (ctx, canvas, size) {\n  ctx.clearRect(0, 0, canvas.width, canvas.height)\n\n  if (!canvas.style) canvas.style = {}\n  canvas.height = size\n  canvas.width = size\n  canvas.style.height = size + 'px'\n  canvas.style.width = size + 'px'\n}\n\nfunction getCanvasElement () {\n  try {\n    return document.createElement('canvas')\n  } catch (e) {\n    throw new Error('You need to specify a canvas element')\n  }\n}\n\nexports.render = function render (qrData, canvas, options) {\n  let opts = options\n  let canvasEl = canvas\n\n  if (typeof opts === 'undefined' && (!canvas || !canvas.getContext)) {\n    opts = canvas\n    canvas = undefined\n  }\n\n  if (!canvas) {\n    canvasEl = getCanvasElement()\n  }\n\n  opts = Utils.getOptions(opts)\n  const size = Utils.getImageWidth(qrData.modules.size, opts)\n\n  const ctx = canvasEl.getContext('2d')\n  const image = ctx.createImageData(size, size)\n  Utils.qrToImageData(image.data, qrData, opts)\n\n  clearCanvas(ctx, canvasEl, size)\n  ctx.putImageData(image, 0, 0)\n\n  return canvasEl\n}\n\nexports.renderToDataURL = function renderToDataURL (qrData, canvas, options) {\n  let opts = options\n\n  if (typeof opts === 'undefined' && (!canvas || !canvas.getContext)) {\n    opts = canvas\n    canvas = undefined\n  }\n\n  if (!opts) opts = {}\n\n  const canvasEl = exports.render(qrData, canvas, opts)\n\n  const type = opts.type || 'image/png'\n  const rendererOpts = opts.rendererOpts || {}\n\n  return canvasEl.toDataURL(type, rendererOpts.quality)\n}\n","const Utils = require('./utils')\n\nfunction getColorAttrib (color, attrib) {\n  const alpha = color.a / 255\n  const str = attrib + '=\"' + color.hex + '\"'\n\n  return alpha < 1\n    ? str + ' ' + attrib + '-opacity=\"' + alpha.toFixed(2).slice(1) + '\"'\n    : str\n}\n\nfunction svgCmd (cmd, x, y) {\n  let str = cmd + x\n  if (typeof y !== 'undefined') str += ' ' + y\n\n  return str\n}\n\nfunction qrToPath (data, size, margin) {\n  let path = ''\n  let moveBy = 0\n  let newRow = false\n  let lineLength = 0\n\n  for (let i = 0; i < data.length; i++) {\n    const col = Math.floor(i % size)\n    const row = Math.floor(i / size)\n\n    if (!col && !newRow) newRow = true\n\n    if (data[i]) {\n      lineLength++\n\n      if (!(i > 0 && col > 0 && data[i - 1])) {\n        path += newRow\n          ? svgCmd('M', col + margin, 0.5 + row + margin)\n          : svgCmd('m', moveBy, 0)\n\n        moveBy = 0\n        newRow = false\n      }\n\n      if (!(col + 1 < size && data[i + 1])) {\n        path += svgCmd('h', lineLength)\n        lineLength = 0\n      }\n    } else {\n      moveBy++\n    }\n  }\n\n  return path\n}\n\nexports.render = function render (qrData, options, cb) {\n  const opts = Utils.getOptions(options)\n  const size = qrData.modules.size\n  const data = qrData.modules.data\n  const qrcodesize = size + opts.margin * 2\n\n  const bg = !opts.color.light.a\n    ? ''\n    : '<path ' + getColorAttrib(opts.color.light, 'fill') +\n      ' d=\"M0 0h' + qrcodesize + 'v' + qrcodesize + 'H0z\"/>'\n\n  const path =\n    '<path ' + getColorAttrib(opts.color.dark, 'stroke') +\n    ' d=\"' + qrToPath(data, size, opts.margin) + '\"/>'\n\n  const viewBox = 'viewBox=\"' + '0 0 ' + qrcodesize + ' ' + qrcodesize + '\"'\n\n  const width = !opts.width ? '' : 'width=\"' + opts.width + '\" height=\"' + opts.width + '\" '\n\n  const svgTag = '<svg xmlns=\"http://www.w3.org/2000/svg\" ' + width + viewBox + ' shape-rendering=\"crispEdges\">' + bg + path + '</svg>\\n'\n\n  if (typeof cb === 'function') {\n    cb(null, svgTag)\n  }\n\n  return svgTag\n}\n","\nconst canPromise = require('./can-promise')\n\nconst QRCode = require('./core/qrcode')\nconst CanvasRenderer = require('./renderer/canvas')\nconst SvgRenderer = require('./renderer/svg-tag.js')\n\nfunction renderCanvas (renderFunc, canvas, text, opts, cb) {\n  const args = [].slice.call(arguments, 1)\n  const argsNum = args.length\n  const isLastArgCb = typeof args[argsNum - 1] === 'function'\n\n  if (!isLastArgCb && !canPromise()) {\n    throw new Error('Callback required as last argument')\n  }\n\n  if (isLastArgCb) {\n    if (argsNum < 2) {\n      throw new Error('Too few arguments provided')\n    }\n\n    if (argsNum === 2) {\n      cb = text\n      text = canvas\n      canvas = opts = undefined\n    } else if (argsNum === 3) {\n      if (canvas.getContext && typeof cb === 'undefined') {\n        cb = opts\n        opts = undefined\n      } else {\n        cb = opts\n        opts = text\n        text = canvas\n        canvas = undefined\n      }\n    }\n  } else {\n    if (argsNum < 1) {\n      throw new Error('Too few arguments provided')\n    }\n\n    if (argsNum === 1) {\n      text = canvas\n      canvas = opts = undefined\n    } else if (argsNum === 2 && !canvas.getContext) {\n      opts = text\n      text = canvas\n      canvas = undefined\n    }\n\n    return new Promise(function (resolve, reject) {\n      try {\n        const data = QRCode.create(text, opts)\n        resolve(renderFunc(data, canvas, opts))\n      } catch (e) {\n        reject(e)\n      }\n    })\n  }\n\n  try {\n    const data = QRCode.create(text, opts)\n    cb(null, renderFunc(data, canvas, opts))\n  } catch (e) {\n    cb(e)\n  }\n}\n\nexports.create = QRCode.create\nexports.toCanvas = renderCanvas.bind(null, CanvasRenderer.render)\nexports.toDataURL = renderCanvas.bind(null, CanvasRenderer.renderToDataURL)\n\n// only svg for now.\nexports.toString = renderCanvas.bind(null, function (data, _, opts) {\n  return SvgRenderer.render(data, opts)\n})\n","import QRCode from 'qrcode'\r\n\r\nasync function loadImage(src: string): Promise<HTMLImageElement> {\r\n  return new Promise((resolve, reject) => {\r\n    const img = new Image()\r\n    img.onload = () => resolve(img)\r\n    img.onerror = (e) => reject(e)\r\n    img.src = src\r\n  })\r\n}\r\n\r\nexport type QrLogoOptions = {\r\n  logoUrl: string\r\n  // Fraction of the QR's min(width,height) for the logo box. 0.180.24 is typical.\r\n  logoScale?: number\r\n  // Add a white rounded mask under the logo to preserve scan contrast\r\n  mask?: boolean\r\n  // Outline color for the mask box\r\n  maskStroke?: string\r\n  // Corner radius for mask box\r\n  radiusPx?: number\r\n  // Shape of the logo area: 'circle' | 'rounded-rect' | 'rect'\r\n  shape?: 'circle' | 'rounded-rect' | 'rect'\r\n}\r\n\r\nexport async function composeQrWithLogo(qrDataUrl: string, opts: QrLogoOptions): Promise<string> {\r\n  const [qrImg, logoImg] = await Promise.all([\r\n    loadImage(qrDataUrl),\r\n    loadImage(opts.logoUrl),\r\n  ])\r\n  const w = Math.max(160, qrImg.width || 160)\r\n  const h = Math.max(160, qrImg.height || 160)\r\n  const canvas = document.createElement('canvas')\r\n  canvas.width = w\r\n  canvas.height = h\r\n  const ctx = canvas.getContext('2d')!\r\n  ctx.fillStyle = '#ffffff'\r\n  ctx.fillRect(0, 0, w, h)\r\n  // Draw QR without smoothing to keep it crisp\r\n  ctx.imageSmoothingEnabled = false\r\n  ctx.drawImage(qrImg, 0, 0, w, h)\r\n\r\n  const cx = w / 2\r\n  const cy = h / 2\r\n  const scale = Math.max(0.14, Math.min(0.28, opts.logoScale ?? 0.2))\r\n  const logoSize = Math.round(Math.min(w, h) * scale)\r\n  const x = Math.round(cx - logoSize / 2)\r\n  const y = Math.round(cy - logoSize / 2)\r\n\r\n  if (opts.mask !== false) {\r\n    const shape = opts.shape || 'rounded-rect'\r\n    const pad = Math.max(2, Math.round(logoSize * 0.08))\r\n    const bx = x - pad\r\n    const by = y - pad\r\n    const bw = logoSize + pad * 2\r\n    const bh = logoSize + pad * 2\r\n    ctx.beginPath()\r\n    if (shape === 'circle') {\r\n      const r = Math.min(bw, bh) / 2\r\n      ctx.arc(bx + bw/2, by + bh/2, r, 0, Math.PI * 2)\r\n    } else if (shape === 'rect') {\r\n      ctx.rect(bx, by, bw, bh)\r\n    } else {\r\n      const radius = Math.max(4, opts.radiusPx ?? Math.round(logoSize * 0.12))\r\n      const r = Math.min(radius, bw/2, bh/2)\r\n      ctx.moveTo(bx + r, by)\r\n      ctx.arcTo(bx + bw, by, bx + bw, by + bh, r)\r\n      ctx.arcTo(bx + bw, by + bh, bx, by + bh, r)\r\n      ctx.arcTo(bx, by + bh, bx, by, r)\r\n      ctx.arcTo(bx, by, bx + bw, by, r)\r\n      ctx.closePath()\r\n    }\r\n    // Fill white mask\r\n    ctx.fillStyle = '#ffffff'\r\n    ctx.fill()\r\n    // Optional subtle stroke to separate from modules\r\n    ctx.lineWidth = 1\r\n    ctx.strokeStyle = opts.maskStroke || 'rgba(0,0,0,0.12)'\r\n    ctx.stroke()\r\n  }\r\n\r\n  // Draw the logo centered (clip to shape if circle desired)\r\n  ctx.save()\r\n  if (opts.shape === 'circle') {\r\n    const r = logoSize / 2\r\n    ctx.beginPath()\r\n    ctx.arc(x + r, y + r, r, 0, Math.PI * 2)\r\n    ctx.clip()\r\n  }\r\n  ctx.imageSmoothingEnabled = true\r\n  ctx.drawImage(logoImg, x, y, logoSize, logoSize)\r\n  ctx.restore()\r\n  return canvas.toDataURL('image/png')\r\n}\r\n\r\nexport type MakeQrOptions = {\r\n  width?: number\r\n  margin?: number\r\n  errorCorrectionLevel?: 'L'|'M'|'Q'|'H'\r\n  color?: { dark?: string; light?: string }\r\n  logo?: QrLogoOptions | false\r\n}\r\n\r\nexport async function makeQrDataUrlWithLogo(text: string, options: MakeQrOptions): Promise<string> {\r\n  const { width = 256, margin = 2, errorCorrectionLevel = 'H', color = { dark: '#000000', light: '#ffffff' }, logo } = options || {}\r\n  const base = await QRCode.toDataURL(text, { width, margin, errorCorrectionLevel, color })\r\n  if (!logo) return base\r\n  return composeQrWithLogo(base, logo)\r\n}\r\n","const createStoreImpl = (createState) => {\n  let state;\n  const listeners = /* @__PURE__ */ new Set();\n  const setState = (partial, replace) => {\n    const nextState = typeof partial === \"function\" ? partial(state) : partial;\n    if (!Object.is(nextState, state)) {\n      const previousState = state;\n      state = (replace != null ? replace : typeof nextState !== \"object\" || nextState === null) ? nextState : Object.assign({}, state, nextState);\n      listeners.forEach((listener) => listener(state, previousState));\n    }\n  };\n  const getState = () => state;\n  const getInitialState = () => initialState;\n  const subscribe = (listener) => {\n    listeners.add(listener);\n    return () => listeners.delete(listener);\n  };\n  const destroy = () => {\n    if ((import.meta.env ? import.meta.env.MODE : void 0) !== \"production\") {\n      console.warn(\n        \"[DEPRECATED] The `destroy` method will be unsupported in a future version. Instead use unsubscribe function returned by subscribe. Everything will be garbage-collected if store is garbage-collected.\"\n      );\n    }\n    listeners.clear();\n  };\n  const api = { setState, getState, getInitialState, subscribe, destroy };\n  const initialState = state = createState(setState, getState, api);\n  return api;\n};\nconst createStore = (createState) => createState ? createStoreImpl(createState) : createStoreImpl;\nvar vanilla = (createState) => {\n  if ((import.meta.env ? import.meta.env.MODE : void 0) !== \"production\") {\n    console.warn(\n      \"[DEPRECATED] Default export is deprecated. Instead use import { createStore } from 'zustand/vanilla'.\"\n    );\n  }\n  return createStore(createState);\n};\n\nexport { createStore, vanilla as default };\n","/**\n * @license React\n * use-sync-external-store-shim.production.js\n *\n * Copyright (c) Meta Platforms, Inc. and affiliates.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n */\n\n\"use strict\";\nvar React = require(\"react\");\nfunction is(x, y) {\n  return (x === y && (0 !== x || 1 / x === 1 / y)) || (x !== x && y !== y);\n}\nvar objectIs = \"function\" === typeof Object.is ? Object.is : is,\n  useState = React.useState,\n  useEffect = React.useEffect,\n  useLayoutEffect = React.useLayoutEffect,\n  useDebugValue = React.useDebugValue;\nfunction useSyncExternalStore$2(subscribe, getSnapshot) {\n  var value = getSnapshot(),\n    _useState = useState({ inst: { value: value, getSnapshot: getSnapshot } }),\n    inst = _useState[0].inst,\n    forceUpdate = _useState[1];\n  useLayoutEffect(\n    function () {\n      inst.value = value;\n      inst.getSnapshot = getSnapshot;\n      checkIfSnapshotChanged(inst) && forceUpdate({ inst: inst });\n    },\n    [subscribe, value, getSnapshot]\n  );\n  useEffect(\n    function () {\n      checkIfSnapshotChanged(inst) && forceUpdate({ inst: inst });\n      return subscribe(function () {\n        checkIfSnapshotChanged(inst) && forceUpdate({ inst: inst });\n      });\n    },\n    [subscribe]\n  );\n  useDebugValue(value);\n  return value;\n}\nfunction checkIfSnapshotChanged(inst) {\n  var latestGetSnapshot = inst.getSnapshot;\n  inst = inst.value;\n  try {\n    var nextValue = latestGetSnapshot();\n    return !objectIs(inst, nextValue);\n  } catch (error) {\n    return !0;\n  }\n}\nfunction useSyncExternalStore$1(subscribe, getSnapshot) {\n  return getSnapshot();\n}\nvar shim =\n  \"undefined\" === typeof window ||\n  \"undefined\" === typeof window.document ||\n  \"undefined\" === typeof window.document.createElement\n    ? useSyncExternalStore$1\n    : useSyncExternalStore$2;\nexports.useSyncExternalStore =\n  void 0 !== React.useSyncExternalStore ? React.useSyncExternalStore : shim;\n","'use strict';\n\nif (process.env.NODE_ENV === 'production') {\n  module.exports = require('../cjs/use-sync-external-store-shim.production.js');\n} else {\n  module.exports = require('../cjs/use-sync-external-store-shim.development.js');\n}\n","/**\n * @license React\n * use-sync-external-store-shim/with-selector.production.js\n *\n * Copyright (c) Meta Platforms, Inc. and affiliates.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n */\n\n\"use strict\";\nvar React = require(\"react\"),\n  shim = require(\"use-sync-external-store/shim\");\nfunction is(x, y) {\n  return (x === y && (0 !== x || 1 / x === 1 / y)) || (x !== x && y !== y);\n}\nvar objectIs = \"function\" === typeof Object.is ? Object.is : is,\n  useSyncExternalStore = shim.useSyncExternalStore,\n  useRef = React.useRef,\n  useEffect = React.useEffect,\n  useMemo = React.useMemo,\n  useDebugValue = React.useDebugValue;\nexports.useSyncExternalStoreWithSelector = function (\n  subscribe,\n  getSnapshot,\n  getServerSnapshot,\n  selector,\n  isEqual\n) {\n  var instRef = useRef(null);\n  if (null === instRef.current) {\n    var inst = { hasValue: !1, value: null };\n    instRef.current = inst;\n  } else inst = instRef.current;\n  instRef = useMemo(\n    function () {\n      function memoizedSelector(nextSnapshot) {\n        if (!hasMemo) {\n          hasMemo = !0;\n          memoizedSnapshot = nextSnapshot;\n          nextSnapshot = selector(nextSnapshot);\n          if (void 0 !== isEqual && inst.hasValue) {\n            var currentSelection = inst.value;\n            if (isEqual(currentSelection, nextSnapshot))\n              return (memoizedSelection = currentSelection);\n          }\n          return (memoizedSelection = nextSnapshot);\n        }\n        currentSelection = memoizedSelection;\n        if (objectIs(memoizedSnapshot, nextSnapshot)) return currentSelection;\n        var nextSelection = selector(nextSnapshot);\n        if (void 0 !== isEqual && isEqual(currentSelection, nextSelection))\n          return (memoizedSnapshot = nextSnapshot), currentSelection;\n        memoizedSnapshot = nextSnapshot;\n        return (memoizedSelection = nextSelection);\n      }\n      var hasMemo = !1,\n        memoizedSnapshot,\n        memoizedSelection,\n        maybeGetServerSnapshot =\n          void 0 === getServerSnapshot ? null : getServerSnapshot;\n      return [\n        function () {\n          return memoizedSelector(getSnapshot());\n        },\n        null === maybeGetServerSnapshot\n          ? void 0\n          : function () {\n              return memoizedSelector(maybeGetServerSnapshot());\n            }\n      ];\n    },\n    [getSnapshot, getServerSnapshot, selector, isEqual]\n  );\n  var value = useSyncExternalStore(subscribe, instRef[0], instRef[1]);\n  useEffect(\n    function () {\n      inst.hasValue = !0;\n      inst.value = value;\n    },\n    [value]\n  );\n  useDebugValue(value);\n  return value;\n};\n","'use strict';\n\nif (process.env.NODE_ENV === 'production') {\n  module.exports = require('../cjs/use-sync-external-store-shim/with-selector.production.js');\n} else {\n  module.exports = require('../cjs/use-sync-external-store-shim/with-selector.development.js');\n}\n","import { createStore } from 'zustand/vanilla';\nexport * from 'zustand/vanilla';\nimport ReactExports from 'react';\nimport useSyncExternalStoreExports from 'use-sync-external-store/shim/with-selector.js';\n\nconst { useDebugValue } = ReactExports;\nconst { useSyncExternalStoreWithSelector } = useSyncExternalStoreExports;\nlet didWarnAboutEqualityFn = false;\nconst identity = (arg) => arg;\nfunction useStore(api, selector = identity, equalityFn) {\n  if ((import.meta.env ? import.meta.env.MODE : void 0) !== \"production\" && equalityFn && !didWarnAboutEqualityFn) {\n    console.warn(\n      \"[DEPRECATED] Use `createWithEqualityFn` instead of `create` or use `useStoreWithEqualityFn` instead of `useStore`. They can be imported from 'zustand/traditional'. https://github.com/pmndrs/zustand/discussions/1937\"\n    );\n    didWarnAboutEqualityFn = true;\n  }\n  const slice = useSyncExternalStoreWithSelector(\n    api.subscribe,\n    api.getState,\n    api.getServerState || api.getInitialState,\n    selector,\n    equalityFn\n  );\n  useDebugValue(slice);\n  return slice;\n}\nconst createImpl = (createState) => {\n  if ((import.meta.env ? import.meta.env.MODE : void 0) !== \"production\" && typeof createState !== \"function\") {\n    console.warn(\n      \"[DEPRECATED] Passing a vanilla store will be unsupported in a future version. Instead use `import { useStore } from 'zustand'`.\"\n    );\n  }\n  const api = typeof createState === \"function\" ? createStore(createState) : createState;\n  const useBoundStore = (selector, equalityFn) => useStore(api, selector, equalityFn);\n  Object.assign(useBoundStore, api);\n  return useBoundStore;\n};\nconst create = (createState) => createState ? createImpl(createState) : createImpl;\nvar react = (createState) => {\n  if ((import.meta.env ? import.meta.env.MODE : void 0) !== \"production\") {\n    console.warn(\n      \"[DEPRECATED] Default export is deprecated. Instead use `import { create } from 'zustand'`.\"\n    );\n  }\n  return create(createState);\n};\n\nexport { create, react as default, useStore };\n","const reduxImpl = (reducer, initial) => (set, _get, api) => {\n  api.dispatch = (action) => {\n    set((state) => reducer(state, action), false, action);\n    return action;\n  };\n  api.dispatchFromDevtools = true;\n  return { dispatch: (...a) => api.dispatch(...a), ...initial };\n};\nconst redux = reduxImpl;\n\nconst trackedConnections = /* @__PURE__ */ new Map();\nconst getTrackedConnectionState = (name) => {\n  const api = trackedConnections.get(name);\n  if (!api) return {};\n  return Object.fromEntries(\n    Object.entries(api.stores).map(([key, api2]) => [key, api2.getState()])\n  );\n};\nconst extractConnectionInformation = (store, extensionConnector, options) => {\n  if (store === void 0) {\n    return {\n      type: \"untracked\",\n      connection: extensionConnector.connect(options)\n    };\n  }\n  const existingConnection = trackedConnections.get(options.name);\n  if (existingConnection) {\n    return { type: \"tracked\", store, ...existingConnection };\n  }\n  const newConnection = {\n    connection: extensionConnector.connect(options),\n    stores: {}\n  };\n  trackedConnections.set(options.name, newConnection);\n  return { type: \"tracked\", store, ...newConnection };\n};\nconst devtoolsImpl = (fn, devtoolsOptions = {}) => (set, get, api) => {\n  const { enabled, anonymousActionType, store, ...options } = devtoolsOptions;\n  let extensionConnector;\n  try {\n    extensionConnector = (enabled != null ? enabled : (import.meta.env ? import.meta.env.MODE : void 0) !== \"production\") && window.__REDUX_DEVTOOLS_EXTENSION__;\n  } catch (_e) {\n  }\n  if (!extensionConnector) {\n    if ((import.meta.env ? import.meta.env.MODE : void 0) !== \"production\" && enabled) {\n      console.warn(\n        \"[zustand devtools middleware] Please install/enable Redux devtools extension\"\n      );\n    }\n    return fn(set, get, api);\n  }\n  const { connection, ...connectionInformation } = extractConnectionInformation(store, extensionConnector, options);\n  let isRecording = true;\n  api.setState = (state, replace, nameOrAction) => {\n    const r = set(state, replace);\n    if (!isRecording) return r;\n    const action = nameOrAction === void 0 ? { type: anonymousActionType || \"anonymous\" } : typeof nameOrAction === \"string\" ? { type: nameOrAction } : nameOrAction;\n    if (store === void 0) {\n      connection == null ? void 0 : connection.send(action, get());\n      return r;\n    }\n    connection == null ? void 0 : connection.send(\n      {\n        ...action,\n        type: `${store}/${action.type}`\n      },\n      {\n        ...getTrackedConnectionState(options.name),\n        [store]: api.getState()\n      }\n    );\n    return r;\n  };\n  const setStateFromDevtools = (...a) => {\n    const originalIsRecording = isRecording;\n    isRecording = false;\n    set(...a);\n    isRecording = originalIsRecording;\n  };\n  const initialState = fn(api.setState, get, api);\n  if (connectionInformation.type === \"untracked\") {\n    connection == null ? void 0 : connection.init(initialState);\n  } else {\n    connectionInformation.stores[connectionInformation.store] = api;\n    connection == null ? void 0 : connection.init(\n      Object.fromEntries(\n        Object.entries(connectionInformation.stores).map(([key, store2]) => [\n          key,\n          key === connectionInformation.store ? initialState : store2.getState()\n        ])\n      )\n    );\n  }\n  if (api.dispatchFromDevtools && typeof api.dispatch === \"function\") {\n    let didWarnAboutReservedActionType = false;\n    const originalDispatch = api.dispatch;\n    api.dispatch = (...a) => {\n      if ((import.meta.env ? import.meta.env.MODE : void 0) !== \"production\" && a[0].type === \"__setState\" && !didWarnAboutReservedActionType) {\n        console.warn(\n          '[zustand devtools middleware] \"__setState\" action type is reserved to set state from the devtools. Avoid using it.'\n        );\n        didWarnAboutReservedActionType = true;\n      }\n      originalDispatch(...a);\n    };\n  }\n  connection.subscribe((message) => {\n    var _a;\n    switch (message.type) {\n      case \"ACTION\":\n        if (typeof message.payload !== \"string\") {\n          console.error(\n            \"[zustand devtools middleware] Unsupported action format\"\n          );\n          return;\n        }\n        return parseJsonThen(\n          message.payload,\n          (action) => {\n            if (action.type === \"__setState\") {\n              if (store === void 0) {\n                setStateFromDevtools(action.state);\n                return;\n              }\n              if (Object.keys(action.state).length !== 1) {\n                console.error(\n                  `\n                    [zustand devtools middleware] Unsupported __setState action format. \n                    When using 'store' option in devtools(), the 'state' should have only one key, which is a value of 'store' that was passed in devtools(),\n                    and value of this only key should be a state object. Example: { \"type\": \"__setState\", \"state\": { \"abc123Store\": { \"foo\": \"bar\" } } }\n                    `\n                );\n              }\n              const stateFromDevtools = action.state[store];\n              if (stateFromDevtools === void 0 || stateFromDevtools === null) {\n                return;\n              }\n              if (JSON.stringify(api.getState()) !== JSON.stringify(stateFromDevtools)) {\n                setStateFromDevtools(stateFromDevtools);\n              }\n              return;\n            }\n            if (!api.dispatchFromDevtools) return;\n            if (typeof api.dispatch !== \"function\") return;\n            api.dispatch(action);\n          }\n        );\n      case \"DISPATCH\":\n        switch (message.payload.type) {\n          case \"RESET\":\n            setStateFromDevtools(initialState);\n            if (store === void 0) {\n              return connection == null ? void 0 : connection.init(api.getState());\n            }\n            return connection == null ? void 0 : connection.init(getTrackedConnectionState(options.name));\n          case \"COMMIT\":\n            if (store === void 0) {\n              connection == null ? void 0 : connection.init(api.getState());\n              return;\n            }\n            return connection == null ? void 0 : connection.init(getTrackedConnectionState(options.name));\n          case \"ROLLBACK\":\n            return parseJsonThen(message.state, (state) => {\n              if (store === void 0) {\n                setStateFromDevtools(state);\n                connection == null ? void 0 : connection.init(api.getState());\n                return;\n              }\n              setStateFromDevtools(state[store]);\n              connection == null ? void 0 : connection.init(getTrackedConnectionState(options.name));\n            });\n          case \"JUMP_TO_STATE\":\n          case \"JUMP_TO_ACTION\":\n            return parseJsonThen(message.state, (state) => {\n              if (store === void 0) {\n                setStateFromDevtools(state);\n                return;\n              }\n              if (JSON.stringify(api.getState()) !== JSON.stringify(state[store])) {\n                setStateFromDevtools(state[store]);\n              }\n            });\n          case \"IMPORT_STATE\": {\n            const { nextLiftedState } = message.payload;\n            const lastComputedState = (_a = nextLiftedState.computedStates.slice(-1)[0]) == null ? void 0 : _a.state;\n            if (!lastComputedState) return;\n            if (store === void 0) {\n              setStateFromDevtools(lastComputedState);\n            } else {\n              setStateFromDevtools(lastComputedState[store]);\n            }\n            connection == null ? void 0 : connection.send(\n              null,\n              // FIXME no-any\n              nextLiftedState\n            );\n            return;\n          }\n          case \"PAUSE_RECORDING\":\n            return isRecording = !isRecording;\n        }\n        return;\n    }\n  });\n  return initialState;\n};\nconst devtools = devtoolsImpl;\nconst parseJsonThen = (stringified, f) => {\n  let parsed;\n  try {\n    parsed = JSON.parse(stringified);\n  } catch (e) {\n    console.error(\n      \"[zustand devtools middleware] Could not parse the received json\",\n      e\n    );\n  }\n  if (parsed !== void 0) f(parsed);\n};\n\nconst subscribeWithSelectorImpl = (fn) => (set, get, api) => {\n  const origSubscribe = api.subscribe;\n  api.subscribe = (selector, optListener, options) => {\n    let listener = selector;\n    if (optListener) {\n      const equalityFn = (options == null ? void 0 : options.equalityFn) || Object.is;\n      let currentSlice = selector(api.getState());\n      listener = (state) => {\n        const nextSlice = selector(state);\n        if (!equalityFn(currentSlice, nextSlice)) {\n          const previousSlice = currentSlice;\n          optListener(currentSlice = nextSlice, previousSlice);\n        }\n      };\n      if (options == null ? void 0 : options.fireImmediately) {\n        optListener(currentSlice, currentSlice);\n      }\n    }\n    return origSubscribe(listener);\n  };\n  const initialState = fn(set, get, api);\n  return initialState;\n};\nconst subscribeWithSelector = subscribeWithSelectorImpl;\n\nconst combine = (initialState, create) => (...a) => Object.assign({}, initialState, create(...a));\n\nfunction createJSONStorage(getStorage, options) {\n  let storage;\n  try {\n    storage = getStorage();\n  } catch (_e) {\n    return;\n  }\n  const persistStorage = {\n    getItem: (name) => {\n      var _a;\n      const parse = (str2) => {\n        if (str2 === null) {\n          return null;\n        }\n        return JSON.parse(str2, options == null ? void 0 : options.reviver);\n      };\n      const str = (_a = storage.getItem(name)) != null ? _a : null;\n      if (str instanceof Promise) {\n        return str.then(parse);\n      }\n      return parse(str);\n    },\n    setItem: (name, newValue) => storage.setItem(\n      name,\n      JSON.stringify(newValue, options == null ? void 0 : options.replacer)\n    ),\n    removeItem: (name) => storage.removeItem(name)\n  };\n  return persistStorage;\n}\nconst toThenable = (fn) => (input) => {\n  try {\n    const result = fn(input);\n    if (result instanceof Promise) {\n      return result;\n    }\n    return {\n      then(onFulfilled) {\n        return toThenable(onFulfilled)(result);\n      },\n      catch(_onRejected) {\n        return this;\n      }\n    };\n  } catch (e) {\n    return {\n      then(_onFulfilled) {\n        return this;\n      },\n      catch(onRejected) {\n        return toThenable(onRejected)(e);\n      }\n    };\n  }\n};\nconst oldImpl = (config, baseOptions) => (set, get, api) => {\n  let options = {\n    getStorage: () => localStorage,\n    serialize: JSON.stringify,\n    deserialize: JSON.parse,\n    partialize: (state) => state,\n    version: 0,\n    merge: (persistedState, currentState) => ({\n      ...currentState,\n      ...persistedState\n    }),\n    ...baseOptions\n  };\n  let hasHydrated = false;\n  const hydrationListeners = /* @__PURE__ */ new Set();\n  const finishHydrationListeners = /* @__PURE__ */ new Set();\n  let storage;\n  try {\n    storage = options.getStorage();\n  } catch (_e) {\n  }\n  if (!storage) {\n    return config(\n      (...args) => {\n        console.warn(\n          `[zustand persist middleware] Unable to update item '${options.name}', the given storage is currently unavailable.`\n        );\n        set(...args);\n      },\n      get,\n      api\n    );\n  }\n  const thenableSerialize = toThenable(options.serialize);\n  const setItem = () => {\n    const state = options.partialize({ ...get() });\n    let errorInSync;\n    const thenable = thenableSerialize({ state, version: options.version }).then(\n      (serializedValue) => storage.setItem(options.name, serializedValue)\n    ).catch((e) => {\n      errorInSync = e;\n    });\n    if (errorInSync) {\n      throw errorInSync;\n    }\n    return thenable;\n  };\n  const savedSetState = api.setState;\n  api.setState = (state, replace) => {\n    savedSetState(state, replace);\n    void setItem();\n  };\n  const configResult = config(\n    (...args) => {\n      set(...args);\n      void setItem();\n    },\n    get,\n    api\n  );\n  let stateFromStorage;\n  const hydrate = () => {\n    var _a;\n    if (!storage) return;\n    hasHydrated = false;\n    hydrationListeners.forEach((cb) => cb(get()));\n    const postRehydrationCallback = ((_a = options.onRehydrateStorage) == null ? void 0 : _a.call(options, get())) || void 0;\n    return toThenable(storage.getItem.bind(storage))(options.name).then((storageValue) => {\n      if (storageValue) {\n        return options.deserialize(storageValue);\n      }\n    }).then((deserializedStorageValue) => {\n      if (deserializedStorageValue) {\n        if (typeof deserializedStorageValue.version === \"number\" && deserializedStorageValue.version !== options.version) {\n          if (options.migrate) {\n            return options.migrate(\n              deserializedStorageValue.state,\n              deserializedStorageValue.version\n            );\n          }\n          console.error(\n            `State loaded from storage couldn't be migrated since no migrate function was provided`\n          );\n        } else {\n          return deserializedStorageValue.state;\n        }\n      }\n    }).then((migratedState) => {\n      var _a2;\n      stateFromStorage = options.merge(\n        migratedState,\n        (_a2 = get()) != null ? _a2 : configResult\n      );\n      set(stateFromStorage, true);\n      return setItem();\n    }).then(() => {\n      postRehydrationCallback == null ? void 0 : postRehydrationCallback(stateFromStorage, void 0);\n      hasHydrated = true;\n      finishHydrationListeners.forEach((cb) => cb(stateFromStorage));\n    }).catch((e) => {\n      postRehydrationCallback == null ? void 0 : postRehydrationCallback(void 0, e);\n    });\n  };\n  api.persist = {\n    setOptions: (newOptions) => {\n      options = {\n        ...options,\n        ...newOptions\n      };\n      if (newOptions.getStorage) {\n        storage = newOptions.getStorage();\n      }\n    },\n    clearStorage: () => {\n      storage == null ? void 0 : storage.removeItem(options.name);\n    },\n    getOptions: () => options,\n    rehydrate: () => hydrate(),\n    hasHydrated: () => hasHydrated,\n    onHydrate: (cb) => {\n      hydrationListeners.add(cb);\n      return () => {\n        hydrationListeners.delete(cb);\n      };\n    },\n    onFinishHydration: (cb) => {\n      finishHydrationListeners.add(cb);\n      return () => {\n        finishHydrationListeners.delete(cb);\n      };\n    }\n  };\n  hydrate();\n  return stateFromStorage || configResult;\n};\nconst newImpl = (config, baseOptions) => (set, get, api) => {\n  let options = {\n    storage: createJSONStorage(() => localStorage),\n    partialize: (state) => state,\n    version: 0,\n    merge: (persistedState, currentState) => ({\n      ...currentState,\n      ...persistedState\n    }),\n    ...baseOptions\n  };\n  let hasHydrated = false;\n  const hydrationListeners = /* @__PURE__ */ new Set();\n  const finishHydrationListeners = /* @__PURE__ */ new Set();\n  let storage = options.storage;\n  if (!storage) {\n    return config(\n      (...args) => {\n        console.warn(\n          `[zustand persist middleware] Unable to update item '${options.name}', the given storage is currently unavailable.`\n        );\n        set(...args);\n      },\n      get,\n      api\n    );\n  }\n  const setItem = () => {\n    const state = options.partialize({ ...get() });\n    return storage.setItem(options.name, {\n      state,\n      version: options.version\n    });\n  };\n  const savedSetState = api.setState;\n  api.setState = (state, replace) => {\n    savedSetState(state, replace);\n    void setItem();\n  };\n  const configResult = config(\n    (...args) => {\n      set(...args);\n      void setItem();\n    },\n    get,\n    api\n  );\n  api.getInitialState = () => configResult;\n  let stateFromStorage;\n  const hydrate = () => {\n    var _a, _b;\n    if (!storage) return;\n    hasHydrated = false;\n    hydrationListeners.forEach((cb) => {\n      var _a2;\n      return cb((_a2 = get()) != null ? _a2 : configResult);\n    });\n    const postRehydrationCallback = ((_b = options.onRehydrateStorage) == null ? void 0 : _b.call(options, (_a = get()) != null ? _a : configResult)) || void 0;\n    return toThenable(storage.getItem.bind(storage))(options.name).then((deserializedStorageValue) => {\n      if (deserializedStorageValue) {\n        if (typeof deserializedStorageValue.version === \"number\" && deserializedStorageValue.version !== options.version) {\n          if (options.migrate) {\n            return [\n              true,\n              options.migrate(\n                deserializedStorageValue.state,\n                deserializedStorageValue.version\n              )\n            ];\n          }\n          console.error(\n            `State loaded from storage couldn't be migrated since no migrate function was provided`\n          );\n        } else {\n          return [false, deserializedStorageValue.state];\n        }\n      }\n      return [false, void 0];\n    }).then((migrationResult) => {\n      var _a2;\n      const [migrated, migratedState] = migrationResult;\n      stateFromStorage = options.merge(\n        migratedState,\n        (_a2 = get()) != null ? _a2 : configResult\n      );\n      set(stateFromStorage, true);\n      if (migrated) {\n        return setItem();\n      }\n    }).then(() => {\n      postRehydrationCallback == null ? void 0 : postRehydrationCallback(stateFromStorage, void 0);\n      stateFromStorage = get();\n      hasHydrated = true;\n      finishHydrationListeners.forEach((cb) => cb(stateFromStorage));\n    }).catch((e) => {\n      postRehydrationCallback == null ? void 0 : postRehydrationCallback(void 0, e);\n    });\n  };\n  api.persist = {\n    setOptions: (newOptions) => {\n      options = {\n        ...options,\n        ...newOptions\n      };\n      if (newOptions.storage) {\n        storage = newOptions.storage;\n      }\n    },\n    clearStorage: () => {\n      storage == null ? void 0 : storage.removeItem(options.name);\n    },\n    getOptions: () => options,\n    rehydrate: () => hydrate(),\n    hasHydrated: () => hasHydrated,\n    onHydrate: (cb) => {\n      hydrationListeners.add(cb);\n      return () => {\n        hydrationListeners.delete(cb);\n      };\n    },\n    onFinishHydration: (cb) => {\n      finishHydrationListeners.add(cb);\n      return () => {\n        finishHydrationListeners.delete(cb);\n      };\n    }\n  };\n  if (!options.skipHydration) {\n    hydrate();\n  }\n  return stateFromStorage || configResult;\n};\nconst persistImpl = (config, baseOptions) => {\n  if (\"getStorage\" in baseOptions || \"serialize\" in baseOptions || \"deserialize\" in baseOptions) {\n    if ((import.meta.env ? import.meta.env.MODE : void 0) !== \"production\") {\n      console.warn(\n        \"[DEPRECATED] `getStorage`, `serialize` and `deserialize` options are deprecated. Use `storage` option instead.\"\n      );\n    }\n    return oldImpl(config, baseOptions);\n  }\n  return newImpl(config, baseOptions);\n};\nconst persist = persistImpl;\n\nexport { combine, createJSONStorage, devtools, persist, redux, subscribeWithSelector };\n","import { create } from 'zustand'\r\nimport { persist, createJSONStorage } from 'zustand/middleware'\r\nimport type { Homography, Point } from '../utils/vision'\r\n\r\ntype CalibrationState = {\r\n  H: Homography | null // board->image\r\n  createdAt: number | null\r\n  errorPx: number | null\r\n  imageSize: { w: number; h: number } | null\r\n  anchors: { src: Point[]; dst: Point[] } | null\r\n  locked: boolean\r\n  _hydrated: boolean // Track hydration state\r\n  setCalibration: (c: Partial<Omit<CalibrationState, 'setCalibration' | 'reset' | '_hydrated'>>) => void\r\n  reset: () => void\r\n}\r\n\r\nexport const useCalibration = create<CalibrationState>()(persist((set, get) => ({\r\n  H: null,\r\n  createdAt: null,\r\n  errorPx: null,\r\n  imageSize: null,\r\n  anchors: null,\r\n  locked: false,\r\n  _hydrated: false,\r\n  setCalibration: (c) => set((s) => ({ ...s, ...c })),\r\n  reset: () => set({ H: null, createdAt: null, errorPx: null, imageSize: null, anchors: null, locked: false }),\r\n}), {\r\n  name: 'ndn-calibration-v1',\r\n  storage: createJSONStorage(() => localStorage),\r\n  // If we ever had alternate keys (legacy), gently import once after hydration\r\n  onRehydrateStorage: () => (state, error) => {\r\n    // No-op on error; best-effort fallback\r\n    if (error || !state) return\r\n    try {\r\n      if (state && !state.H) {\r\n        const legacy = localStorage.getItem('ndn:calibration:v1')\r\n        if (legacy) {\r\n          const j = JSON.parse(legacy)\r\n          if (j && (j.H || j.imageSize)) {\r\n            state.setCalibration({\r\n              H: j.H ?? null,\r\n              createdAt: j.createdAt ?? null,\r\n              errorPx: j.errorPx ?? null,\r\n              imageSize: j.imageSize ?? null,\r\n              anchors: j.anchors ?? null,\r\n              locked: !!j.locked,\r\n            })\r\n          }\r\n        }\r\n      }\r\n      // Mark as hydrated\r\n      state._hydrated = true\r\n    } catch {}\r\n  },\r\n}))\r\n","import { create } from 'zustand'\r\nimport { persist, createJSONStorage } from 'zustand/middleware'\r\n\r\nexport type CameraStreamMode = 'local' | 'phone' | 'wifi'\r\n\r\n// CRITICAL: All non-serializable objects kept OUTSIDE state to avoid React #185 error\r\n// These must NOT be in Zustand state, even though we set them there momentarily\r\nlet videoElementRefHolder: HTMLVideoElement | null = null\r\nlet mediaStreamRefHolder: MediaStream | null = null\r\nlet pcRefHolder: RTCPeerConnection | null = null\r\nlet wsRefHolder: WebSocket | null = null\r\n\r\ntype CameraSessionState = {\r\n  // Stream state - persists across navigation (ONLY serializable data)\r\n  isStreaming: boolean\r\n  mode: CameraStreamMode\r\n  pairingCode: string | null\r\n  expiresAt: number | null\r\n  isPaired: boolean\r\n  mobileUrl: string | null\r\n  // UI: whether the floating phone overlay is visible\r\n  showOverlay: boolean\r\n  \r\n  // Actions\r\n  setStreaming: (streaming: boolean) => void\r\n  setMode: (mode: CameraStreamMode) => void\r\n  setPairingCode: (code: string | null) => void\r\n  setExpiresAt: (time: number | null) => void\r\n  setPaired: (paired: boolean) => void\r\n  setMobileUrl: (url: string | null) => void\r\n  setShowOverlay: (v: boolean) => void\r\n  \r\n  // Methods for managing non-serializable refs (not in state)\r\n  setMediaStream: (stream: MediaStream | null) => void\r\n  getMediaStream: () => MediaStream | null\r\n  setPcRef: (pc: RTCPeerConnection | null) => void\r\n  getPcRef: () => RTCPeerConnection | null\r\n  setWsRef: (ws: WebSocket | null) => void\r\n  getWsRef: () => WebSocket | null\r\n  \r\n  // Get video element ref (not stored in state to avoid serialization)\r\n  getVideoElementRef: () => HTMLVideoElement | null\r\n  setVideoElementRef: (ref: HTMLVideoElement | null) => void\r\n  \r\n  // Clear session when user stops camera\r\n  clearSession: () => void\r\n}\r\n\r\nexport const useCameraSession = create<CameraSessionState>()(persist((set, get) => ({\r\n  isStreaming: false,\r\n  mode: 'local',\r\n  pairingCode: null,\r\n  expiresAt: null,\r\n  isPaired: false,\r\n  mobileUrl: null,\r\n  showOverlay: true,\r\n  \r\n  setStreaming: (streaming) => {\r\n    console.log('[CAMERA_SESSION] setStreaming:', streaming)\r\n    set({ isStreaming: streaming })\r\n  },\r\n  setMode: (mode) => {\r\n    console.log('[CAMERA_SESSION] setMode:', mode)\r\n    set({ mode })\r\n  },\r\n  setPairingCode: (code) => set({ pairingCode: code }),\r\n  setExpiresAt: (time) => set({ expiresAt: time }),\r\n  setPaired: (paired) => set({ isPaired: paired }),\r\n  setMobileUrl: (url) => set({ mobileUrl: url }),\r\n  setShowOverlay: (v) => set({ showOverlay: !!v }),\r\n  \r\n  // Non-serializable refs stored outside state\r\n  setMediaStream: (stream) => {\r\n    mediaStreamRefHolder = stream\r\n  },\r\n  getMediaStream: () => mediaStreamRefHolder,\r\n  \r\n  setPcRef: (pc) => {\r\n    pcRefHolder = pc\r\n  },\r\n  getPcRef: () => pcRefHolder,\r\n  \r\n  setWsRef: (ws) => {\r\n    wsRefHolder = ws\r\n  },\r\n  getWsRef: () => wsRefHolder,\r\n  \r\n  // Keep video element ref outside of state to avoid serialization issues\r\n  getVideoElementRef: () => {\r\n    const ref = videoElementRefHolder\r\n    if (!ref) {\r\n      console.warn('[cameraSession]  getVideoElementRef called but ref is NULL')\r\n    }\r\n    return ref\r\n  },\r\n  setVideoElementRef: (ref) => {\r\n    if (ref) {\r\n      console.log('[cameraSession]  setVideoElementRef called - storing HTMLVideoElement', {\r\n        tagName: ref.tagName,\r\n        hasStream: !!ref.srcObject,\r\n      })\r\n    } else {\r\n      console.log('[cameraSession]  setVideoElementRef called - clearing ref')\r\n    }\r\n    videoElementRefHolder = ref\r\n  },\r\n  \r\n  clearSession: () => {\r\n    videoElementRefHolder = null\r\n    mediaStreamRefHolder = null\r\n    pcRefHolder = null\r\n    wsRefHolder = null\r\n    set({\r\n      isStreaming: false,\r\n      pairingCode: null,\r\n      expiresAt: null,\r\n      isPaired: false,\r\n      mobileUrl: null,\r\n      // Keep overlay state; do not forcibly hide on clear so user choice persists\r\n    })\r\n  },\r\n}), {\r\n  name: 'ndn-camera-session',\r\n  storage: createJSONStorage(() => localStorage),\r\n  // ONLY persist serializable primitives\r\n  partialize: (state) => ({\r\n    isStreaming: state.isStreaming,\r\n    mode: state.mode,\r\n    pairingCode: state.pairingCode,\r\n    expiresAt: state.expiresAt,\r\n    isPaired: state.isPaired,\r\n    mobileUrl: state.mobileUrl,\r\n    showOverlay: state.showOverlay,\r\n  }),\r\n}))\r\n","// Vision and calibration utilities for dartboard mapping\r\n// Standard dartboard: 18 inches (457.2 mm) outer diameter\r\n// Board dimensions follow standard measurements (millimeters)\r\n// - Inner bull radius: 6.35 mm (12.7 mm diameter)\r\n// - Outer bull radius: 15.9 mm (31.8 mm diameter)\r\n// - Treble inner radius: 99 mm\r\n// - Treble outer radius: 107 mm\r\n// - Double inner radius: 162 mm\r\n// - Double outer radius: 170 mm (playing field outer edge = 340 mm diameter)\r\n\r\nexport type Point = { x: number; y: number }\r\nexport type Homography = [number, number, number, number, number, number, number, number, number] // row-major 3x3\r\n\r\nexport const BoardRadii = {\r\n\tbullInner: 6.35,\r\n\tbullOuter: 15.9,\r\n\ttrebleInner: 99,\r\n\ttrebleOuter: 107,\r\n\tdoubleInner: 162,\r\n\tdoubleOuter: 170,\r\n}\r\n\r\nexport const SectorOrder = [20, 1, 18, 4, 13, 6, 10, 15, 2, 17, 3, 19, 7, 16, 8, 11, 14, 9, 12, 5]\r\n\r\n// Basic 3x3 matrix operations\r\nfunction matMul3(a: Homography, b: Homography): Homography {\r\n\tconst r = new Array(9).fill(0)\r\n\tfor (let i = 0; i < 3; i++) {\r\n\t\tfor (let j = 0; j < 3; j++) {\r\n\t\t\tfor (let k = 0; k < 3; k++) {\r\n\t\t\t\tr[i * 3 + j] += a[i * 3 + k] * b[k * 3 + j]\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\treturn r as Homography\r\n}\r\n\r\nexport function applyHomography(H: Homography, p: Point): Point {\r\n\tconst x = p.x, y = p.y\r\n\tconst w = H[6] * x + H[7] * y + H[8]\r\n\tconst nx = (H[0] * x + H[1] * y + H[2]) / w\r\n\tconst ny = (H[3] * x + H[4] * y + H[5]) / w\r\n\treturn { x: nx, y: ny }\r\n}\r\n\r\n// Scale a homography by sx, sy on the destination/image side: H' = S * H\r\n// Where S = diag([sx, sy, 1])\r\nexport function scaleHomography(H: Homography, sx: number, sy: number): Homography {\r\n\treturn [\r\n\t\tsx * H[0], sx * H[1], sx * H[2],\r\n\t\tsy * H[3], sy * H[4], sy * H[5],\r\n\t\tH[6],     H[7],     H[8],\r\n\t] as Homography\r\n}\r\n\r\nexport function invertHomography(H: Homography): Homography {\r\n\t// Inverse of 3x3 matrix\r\n\tconst m = H\r\n\tconst a = m[0], b = m[1], c = m[2], d = m[3], e = m[4], f = m[5], g = m[6], h = m[7], i = m[8]\r\n\tconst A = e * i - f * h\r\n\tconst B = c * h - b * i\r\n\tconst C = b * f - c * e\r\n\tconst D = f * g - d * i\r\n\tconst E = a * i - c * g\r\n\tconst F = c * d - a * f\r\n\tconst G = d * h - e * g\r\n\tconst Hh = b * g - a * h\r\n\tconst I = a * e - b * d\r\n\tconst det = a * A + b * D + c * G\r\n\tif (Math.abs(det) < 1e-12) throw new Error('Singular homography')\r\n\tconst inv = [\r\n\t\tA / det, B / det, C / det,\r\n\t\tD / det, E / det, F / det,\r\n\t\tG / det, Hh / det, I / det,\r\n\t] as Homography\r\n\treturn inv\r\n}\r\n\r\n// Compute homography H that maps src (board space) -> dst (image space)\r\n// Using N correspondences via DLT (solved by Gaussian elimination) with least-squares fit\r\n// Supports overdetermined systems (N > 4) for improved accuracy\r\nexport function computeHomographyDLT(src: Point[], dst: Point[]): Homography {\r\n\tif (src.length < 4 || dst.length < 4) throw new Error('Need at least 4 correspondences')\r\n\tif (src.length !== dst.length) throw new Error('Correspondences must have equal length')\r\n\t// Build A * h = b where h = [h11 h12 h13 h21 h22 h23 h31 h32]^T and h33 = 1\r\n\tconst A: number[][] = []\r\n\tconst B: number[] = []\r\n\tfor (let k = 0; k < src.length; k++) {\r\n\t\tconst { x: X, y: Y } = src[k]\r\n\t\tconst { x: x, y: y } = dst[k]\r\n\t\t// x = (h11 X + h12 Y + h13) / (h31 X + h32 Y + 1)\r\n\t\t// y = (h21 X + h22 Y + h23) / (h31 X + h32 Y + 1)\r\n\t\t// => x*(h31 X + h32 Y + 1) = h11 X + h12 Y + h13\r\n\t\t// => y*(h31 X + h32 Y + 1) = h21 X + h22 Y + h23\r\n\t\tA.push([X, Y, 1, 0, 0, 0, -x * X, -x * Y])\r\n\t\tB.push(x)\r\n\t\tA.push([0, 0, 0, X, Y, 1, -y * X, -y * Y])\r\n\t\tB.push(y)\r\n\t}\r\n\tconst h = solveLeastSquares(A, B) // length 8\r\n\tconst H: Homography = [h[0], h[1], h[2], h[3], h[4], h[5], h[6], h[7], 1]\r\n\treturn H\r\n}\r\n\r\n// Solve A x = b in least squares sense using Gaussian elimination with partial pivoting\r\nfunction solveLeastSquares(A: number[][], b: number[]): number[] {\r\n\t// Normal equations: (A^T A) x = A^T b\r\n\tconst m = A.length, n = A[0].length\r\n\tconst AtA: number[][] = Array.from({ length: n }, () => new Array(n).fill(0))\r\n\tconst Atb: number[] = new Array(n).fill(0)\r\n\tfor (let r = 0; r < m; r++) {\r\n\t\tfor (let i = 0; i < n; i++) {\r\n\t\t\tAtb[i] += A[r][i] * b[r]\r\n\t\t\tfor (let j = 0; j < n; j++) {\r\n\t\t\t\tAtA[i][j] += A[r][i] * A[r][j]\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\treturn gaussianSolve(AtA, Atb)\r\n}\r\n\r\nfunction gaussianSolve(M: number[][], v: number[]): number[] {\r\n\tconst n = v.length\r\n\t// Augment matrix\r\n\tconst A = M.map((row, i) => row.concat([v[i]]))\r\n\tfor (let i = 0; i < n; i++) {\r\n\t\t// Pivot\r\n\t\tlet maxRow = i\r\n\t\tfor (let r = i + 1; r < n; r++) {\r\n\t\t\tif (Math.abs(A[r][i]) > Math.abs(A[maxRow][i])) maxRow = r\r\n\t\t}\r\n\t\tif (Math.abs(A[maxRow][i]) < 1e-12) throw new Error('Singular matrix')\r\n\t\tif (maxRow !== i) {\r\n\t\t\tconst tmp = A[i]; A[i] = A[maxRow]; A[maxRow] = tmp\r\n\t\t}\r\n\t\t// Eliminate\r\n\t\tfor (let r = i + 1; r < n; r++) {\r\n\t\t\tconst f = A[r][i] / A[i][i]\r\n\t\t\tfor (let c = i; c <= n; c++) A[r][c] -= f * A[i][c]\r\n\t\t}\r\n\t}\r\n\t// Back substitution\r\n\tconst x = new Array(n).fill(0)\r\n\tfor (let i = n - 1; i >= 0; i--) {\r\n\t\tlet s = A[i][n]\r\n\t\tfor (let c = i + 1; c < n; c++) s -= A[i][c] * x[c]\r\n\t\tx[i] = s / A[i][i]\r\n\t}\r\n\treturn x\r\n}\r\n\r\n// Canonical calibration targets in board space (mm)\r\n// We ask the user to click the image positions for: \r\n// 1. TOP, RIGHT, BOTTOM, LEFT of double outer rim (4 points for rim constraint)\r\n// Canonical calibration points in board space (mm)\r\n// 5-point system: TOP, RIGHT, BOTTOM, LEFT of double ring outer edge + CENTER bull\r\n// This matches the actual image points clicked/detected as cardinal directions\r\nexport function canonicalRimTargets(): Point[] {\r\n\tconst doubleR = BoardRadii.doubleOuter\r\n\treturn [\r\n\t\t{ x: 0, y: -doubleR },        // TOP of double ring\r\n\t\t{ x: doubleR, y: 0 },         // RIGHT of double ring\r\n\t\t{ x: 0, y: doubleR },         // BOTTOM of double ring\r\n\t\t{ x: -doubleR, y: 0 },        // LEFT of double ring\r\n\t\t{ x: 0, y: 0 },               // CENTER (bullseye)\r\n\t]\r\n}\r\n\r\n// Given a homography mapping board->image, produce polylines for overlay rings (in image px)\r\nexport function sampleRing(H: Homography, radius: number, steps = 256): Point[] {\r\n\tconst pts: Point[] = []\r\n\tfor (let k = 0; k < steps; k++) {\r\n\t\tconst theta = (k / steps) * Math.PI * 2\r\n\t\tconst p = applyHomography(H, { x: radius * Math.cos(theta), y: radius * Math.sin(theta) })\r\n\t\tpts.push(p)\r\n\t}\r\n\treturn pts\r\n}\r\n\r\nexport function rmsError(H: Homography, src: Point[], dst: Point[]): number {\r\n\tlet e2 = 0\r\n\tfor (let i = 0; i < src.length; i++) {\r\n\t\tconst p = applyHomography(H, src[i])\r\n\t\tconst dx = p.x - dst[i].x\r\n\t\tconst dy = p.y - dst[i].y\r\n\t\te2 += dx * dx + dy * dy\r\n\t}\r\n\treturn Math.sqrt(e2 / src.length)\r\n}\r\n\r\n// Map an image point to board coordinates using inverse homography (image->board)\r\nexport function imageToBoard(H_boardToImage: Homography, pImg: Point): Point {\r\n\tconst inv = invertHomography(H_boardToImage)\r\n\treturn applyHomography(inv as Homography, pImg)\r\n}\r\n\r\n// Compute score for a board coordinate (mm)\r\nexport function scoreAtBoardPoint(p: Point): { base: number; ring: 'MISS'|'SINGLE'|'DOUBLE'|'TRIPLE'|'BULL'|'INNER_BULL'; sector: number | null; mult: 0|1|2|3 } {\r\n\tconst r = Math.hypot(p.x, p.y)\r\n\tconst ang = Math.atan2(p.y, p.x) // 0 rad at +X, increasing CCW\r\n\t// Rotate so that sector 20 is at the top (negative Y). Top corresponds to -90 degrees (or 270)\r\n\tlet deg = ang * 180 / Math.PI\r\n\tdeg = (deg + 360 + 90) % 360 // shift so 0 deg is at top\r\n\tconst sector = SectorOrder[Math.floor(((360 - deg) % 360) / 18)] // clockwise ordering\r\n\r\n\tif (r <= BoardRadii.bullInner) return { base: 50, ring: 'INNER_BULL', sector: 25, mult: 2 }\r\n\tif (r <= BoardRadii.bullOuter) return { base: 25, ring: 'BULL', sector: 25, mult: 1 }\r\n\tif (r >= BoardRadii.doubleOuter) return { base: 0, ring: 'MISS', sector: null, mult: 0 }\r\n\tif (r >= BoardRadii.doubleInner) return { base: sector * 2, ring: 'DOUBLE', sector, mult: 2 }\r\n\tif (r >= BoardRadii.trebleOuter) return { base: sector, ring: 'SINGLE', sector, mult: 1 }\r\n\tif (r >= BoardRadii.trebleInner) return { base: sector * 3, ring: 'TRIPLE', sector, mult: 3 }\r\n\treturn { base: sector, ring: 'SINGLE', sector, mult: 1 }\r\n}\r\n\r\nexport function drawPolyline(ctx: CanvasRenderingContext2D, pts: Point[], color = '#10b981', width = 2) {\r\n\tif (!pts.length) return\r\n\tctx.save()\r\n\tctx.strokeStyle = color\r\n\tctx.lineWidth = width\r\n\tctx.beginPath()\r\n\tctx.moveTo(pts[0].x, pts[0].y)\r\n\tfor (let i = 1; i < pts.length; i++) ctx.lineTo(pts[i].x, pts[i].y)\r\n\tctx.closePath()\r\n\tctx.stroke()\r\n\tctx.restore()\r\n}\r\n\r\nexport function drawCross(ctx: CanvasRenderingContext2D, p: Point, color = '#f59e0b') {\r\n\tctx.save()\r\n\tctx.strokeStyle = color\r\n\tctx.lineWidth = 2\r\n\tctx.beginPath()\r\n\tctx.moveTo(p.x - 8, p.y)\r\n\tctx.lineTo(p.x + 8, p.y)\r\n\tctx.moveTo(p.x, p.y - 8)\r\n\tctx.lineTo(p.x, p.y + 8)\r\n\tctx.stroke()\r\n\tctx.restore()\r\n}\r\n\r\n// --- Point refinement using Sobel gradient ---\r\nfunction clamp(v: number, lo: number, hi: number) { return Math.max(lo, Math.min(hi, v)) }\r\n\r\nfunction sobelAtGray(img: ImageData, x: number, y: number): number {\r\n\tconst { width, data } = img\r\n\t// Sobel kernels\r\n\tconst gx = [[-1,0,1],[-2,0,2],[-1,0,1]]\r\n\tconst gy = [[-1,-2,-1],[0,0,0],[1,2,1]]\r\n\tlet sx = 0, sy = 0\r\n\tfor (let j = -1; j <= 1; j++) {\r\n\t\tfor (let i = -1; i <= 1; i++) {\r\n\t\t\tconst xi = clamp(x + i, 0, width - 1)\r\n\t\t\tconst yi = clamp(y + j, 0, img.height - 1)\r\n\t\t\tconst idx = (yi * width + xi) * 4\r\n\t\t\tconst r = data[idx], g = data[idx+1], b = data[idx+2]\r\n\t\t\tconst gray = 0.299*r + 0.587*g + 0.114*b\r\n\t\t\tsx += gray * gx[j+1][i+1]\r\n\t\t\tsy += gray * gy[j+1][i+1]\r\n\t\t}\r\n\t}\r\n\treturn Math.hypot(sx, sy)\r\n}\r\n\r\nexport function refinePointSobel(canvas: HTMLCanvasElement, p: Point, radius = 6): Point {\r\n\tconst ctx = canvas.getContext('2d')!\r\n\tconst img = ctx.getImageData(0, 0, canvas.width, canvas.height)\r\n\tconst cx = clamp(Math.round(p.x), 1, canvas.width - 2)\r\n\tconst cy = clamp(Math.round(p.y), 1, canvas.height - 2)\r\n\tlet best = { x: cx, y: cy, mag: -1 }\r\n\tfor (let y = cy - radius; y <= cy + radius; y++) {\r\n\t\tfor (let x = cx - radius; x <= cx + radius; x++) {\r\n\t\t\tif (x <= 0 || y <= 0 || x >= canvas.width-1 || y >= canvas.height-1) continue\r\n\t\t\tconst mag = sobelAtGray(img, x, y)\r\n\t\t\tif (mag > best.mag) best = { x, y, mag }\r\n\t\t}\r\n\t}\r\n\treturn { x: best.x, y: best.y }\r\n}\r\n\r\nexport function refinePointsSobel(canvas: HTMLCanvasElement, pts: Point[], radius = 6): Point[] {\r\n\treturn pts.map(p => refinePointSobel(canvas, p, radius))\r\n}\r\n\r\n","/*\nCopyright (c) 2011 Juan Mellado\n\nPermission is hereby granted, free of charge, to any person obtaining a copy\nof this software and associated documentation files (the \"Software\"), to deal\nin the Software without restriction, including without limitation the rights\nto use, copy, modify, merge, publish, distribute, sublicense, and/or sell\ncopies of the Software, and to permit persons to whom the Software is\nfurnished to do so, subject to the following conditions:\n\nThe above copyright notice and this permission notice shall be included in\nall copies or substantial portions of the Software.\n\nTHE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\nIMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\nFITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\nAUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\nLIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\nOUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\nTHE SOFTWARE.\n*/\n\n/*\nReferences:\n- \"OpenCV: Open Computer Vision Library\"\n  http://sourceforge.net/projects/opencvlibrary/\n- \"Stack Blur: Fast But Goodlooking\"\n  http://incubator.quasimondo.com/processing/fast_blur_deluxe.php\n*/\n\nvar CV = CV || {};\n\nCV.Image = function(width, height, data){\n  this.width = width || 0;\n  this.height = height || 0;\n  this.data = data || [];\n};\n\nCV.grayscale = function(imageSrc, imageDst){\n  var src = imageSrc.data, dst = imageDst.data, len = src.length,\n      i = 0, j = 0;\n\n  for (; i < len; i += 4){\n    dst[j ++] =\n      (src[i] * 0.299 + src[i + 1] * 0.587 + src[i + 2] * 0.114 + 0.5) & 0xff;\n  }\n  \n  imageDst.width = imageSrc.width;\n  imageDst.height = imageSrc.height;\n  \n  return imageDst;\n};\n\nCV.threshold = function(imageSrc, imageDst, threshold){\n  var src = imageSrc.data, dst = imageDst.data,\n      len = src.length, tab = [], i;\n\n  for (i = 0; i < 256; ++ i){\n    tab[i] = i <= threshold? 0: 255;\n  }\n\n  for (i = 0; i < len; ++ i){\n    dst[i] = tab[ src[i] ];\n  }\n\n  imageDst.width = imageSrc.width;\n  imageDst.height = imageSrc.height;\n\n  return imageDst;\n};\n\nCV.adaptiveThreshold = function(imageSrc, imageDst, kernelSize, threshold){\n  var src = imageSrc.data, dst = imageDst.data, len = src.length, tab = [], i;\n\n  CV.stackBoxBlur(imageSrc, imageDst, kernelSize);\n\n  for (i = 0; i < 768; ++ i){\n    tab[i] = (i - 255 <= -threshold)? 255: 0;\n  }\n\n  for (i = 0; i < len; ++ i){\n    dst[i] = tab[ src[i] - dst[i] + 255 ];\n  }\n\n  imageDst.width = imageSrc.width;\n  imageDst.height = imageSrc.height;\n  \n  return imageDst;\n};\n\nCV.otsu = function(imageSrc){\n  var src = imageSrc.data, len = src.length, hist = [],\n      threshold = 0, sum = 0, sumB = 0, wB = 0, wF = 0, max = 0,\n      mu, between, i;\n\n  for (i = 0; i < 256; ++ i){\n    hist[i] = 0;\n  }\n  \n  for (i = 0; i < len; ++ i){\n    hist[ src[i] ] ++;\n  }\n\n  for (i = 0; i < 256; ++ i){\n    sum += hist[i] * i;\n  }\n\n  for (i = 0; i < 256; ++ i){\n    wB += hist[i];\n    if (0 !== wB){\n    \n      wF = len - wB;\n      if (0 === wF){\n        break;\n      }\n\n      sumB += hist[i] * i;\n      \n      mu = (sumB / wB) - ( (sum - sumB) / wF );\n\n      between = wB * wF * mu * mu;\n      \n      if (between > max){\n        max = between;\n        threshold = i;\n      }\n    }\n  }\n\n  return threshold;\n};\n\nCV.stackBoxBlurMult =\n  [1, 171, 205, 293, 57, 373, 79, 137, 241, 27, 391, 357, 41, 19, 283, 265];\n\nCV.stackBoxBlurShift =\n  [0, 9, 10, 11, 9, 12, 10, 11, 12, 9, 13, 13, 10, 9, 13, 13];\n\nCV.BlurStack = function(){\n  this.color = 0;\n  this.next = null;\n};\n\nCV.stackBoxBlur = function(imageSrc, imageDst, kernelSize){\n  var src = imageSrc.data, dst = imageDst.data,\n      height = imageSrc.height, width = imageSrc.width,\n      heightMinus1 = height - 1, widthMinus1 = width - 1,\n      size = kernelSize + kernelSize + 1, radius = kernelSize + 1,\n      mult = CV.stackBoxBlurMult[kernelSize],\n      shift = CV.stackBoxBlurShift[kernelSize],\n      stack, stackStart, color, sum, pos, start, p, x, y, i;\n\n  stack = stackStart = new CV.BlurStack();\n  for (i = 1; i < size; ++ i){\n    stack = stack.next = new CV.BlurStack();\n  }\n  stack.next = stackStart;\n\n  pos = 0;\n\n  for (y = 0; y < height; ++ y){\n    start = pos;\n    \n    color = src[pos];\n    sum = radius * color;\n    \n    stack = stackStart;\n    for (i = 0; i < radius; ++ i){\n      stack.color = color;\n      stack = stack.next;\n    }\n    for (i = 1; i < radius; ++ i){\n      stack.color = src[pos + i];\n      sum += stack.color;\n      stack = stack.next;\n    }\n  \n    stack = stackStart;\n    for (x = 0; x < width; ++ x){\n      dst[pos ++] = (sum * mult) >>> shift;\n      \n      p = x + radius;\n      p = start + (p < widthMinus1? p: widthMinus1);\n      sum -= stack.color - src[p];\n      \n      stack.color = src[p];\n      stack = stack.next;\n    }\n  }\n\n  for (x = 0; x < width; ++ x){\n    pos = x;\n    start = pos + width;\n    \n    color = dst[pos];\n    sum = radius * color;\n    \n    stack = stackStart;\n    for (i = 0; i < radius; ++ i){\n      stack.color = color;\n      stack = stack.next;\n    }\n    for (i = 1; i < radius; ++ i){\n      stack.color = dst[start];\n      sum += stack.color;\n      stack = stack.next;\n      \n      start += width;\n    }\n    \n    stack = stackStart;\n    for (y = 0; y < height; ++ y){\n      dst[pos] = (sum * mult) >>> shift;\n      \n      p = y + radius;\n      p = x + ( (p < heightMinus1? p: heightMinus1) * width );\n      sum -= stack.color - dst[p];\n      \n      stack.color = dst[p];\n      stack = stack.next;\n      \n      pos += width;\n    }\n  }\n\n  return imageDst;\n};\n\nCV.gaussianBlur = function(imageSrc, imageDst, imageMean, kernelSize){\n  var kernel = CV.gaussianKernel(kernelSize);\n\n  imageDst.width = imageSrc.width;\n  imageDst.height = imageSrc.height;\n  \n  imageMean.width = imageSrc.width;\n  imageMean.height = imageSrc.height;\n\n  CV.gaussianBlurFilter(imageSrc, imageMean, kernel, true);\n  CV.gaussianBlurFilter(imageMean, imageDst, kernel, false);\n\n  return imageDst;\n};\n\nCV.gaussianBlurFilter = function(imageSrc, imageDst, kernel, horizontal){\n  var src = imageSrc.data, dst = imageDst.data,\n      height = imageSrc.height, width = imageSrc.width,\n      pos = 0, limit = kernel.length >> 1,\n      cur, value, i, j, k;\n      \n  for (i = 0; i < height; ++ i){\n    \n    for (j = 0; j < width; ++ j){\n      value = 0.0;\n    \n      for (k = -limit; k <= limit; ++ k){\n\n        if (horizontal){\n          cur = pos + k;\n          if (j + k < 0){\n            cur = pos;\n          }\n          else if (j + k >= width){\n            cur = pos;\n          }\n        }else{\n          cur = pos + (k * width);\n          if (i + k < 0){\n            cur = pos;\n          }\n          else if (i + k >= height){\n            cur = pos;\n          }\n        }\n\n        value += kernel[limit + k] * src[cur];\n      }\n    \n      dst[pos ++] = horizontal? value: (value + 0.5) & 0xff;\n    }\n  }\n\n  return imageDst;\n};\n\nCV.gaussianKernel = function(kernelSize){\n  var tab =\n    [ [1],\n      [0.25, 0.5, 0.25],\n      [0.0625, 0.25, 0.375, 0.25, 0.0625],\n      [0.03125, 0.109375, 0.21875, 0.28125, 0.21875, 0.109375, 0.03125] ],\n    kernel = [], center, sigma, scale2X, sum, x, i;\n\n  if ( (kernelSize <= 7) && (kernelSize % 2 === 1) ){\n    kernel = tab[kernelSize >> 1];\n  }else{\n    center = (kernelSize - 1.0) * 0.5;\n    sigma = 0.8 + (0.3 * (center - 1.0) );\n    scale2X = -0.5 / (sigma * sigma);\n    sum = 0.0;\n    for (i = 0; i < kernelSize; ++ i){\n      x = i - center;\n      sum += kernel[i] = Math.exp(scale2X * x * x);\n    }\n    sum = 1 / sum;\n    for (i = 0; i < kernelSize; ++ i){\n      kernel[i] *= sum;\n    }  \n  }\n\n  return kernel;\n};\n\nCV.findContours = function(imageSrc, binary){\n  var width = imageSrc.width, height = imageSrc.height, contours = [],\n      src, deltas, pos, pix, nbd, outer, hole, i, j;\n  \n  src = CV.binaryBorder(imageSrc, binary);\n\n  deltas = CV.neighborhoodDeltas(width + 2);\n\n  pos = width + 3;\n  nbd = 1;\n\n  for (i = 0; i < height; ++ i, pos += 2){\n  \n    for (j = 0; j < width; ++ j, ++ pos){\n      pix = src[pos];\n\n      if (0 !== pix){\n        outer = hole = false;\n\n        if (1 === pix && 0 === src[pos - 1]){\n          outer = true;\n        }\n        else if (pix >= 1 && 0 === src[pos + 1]){\n          hole = true;\n        }\n\n        if (outer || hole){\n          ++ nbd;\n          \n          contours.push( CV.borderFollowing(src, pos, nbd, {x: j, y: i}, hole, deltas) );\n        }\n      }\n    }\n  }  \n\n  return contours;\n};\n\nCV.borderFollowing = function(src, pos, nbd, point, hole, deltas){\n  var contour = [], pos1, pos3, pos4, s, s_end, s_prev;\n\n  contour.hole = hole;\n      \n  s = s_end = hole? 0: 4;\n  do{\n    s = (s - 1) & 7;\n    pos1 = pos + deltas[s];\n    if (src[pos1] !== 0){\n      break;\n    }\n  }while(s !== s_end);\n  \n  if (s === s_end){\n    src[pos] = -nbd;\n    contour.push( {x: point.x, y: point.y} );\n\n  }else{\n    pos3 = pos;\n    s_prev = s ^ 4;\n\n    while(true){\n      s_end = s;\n    \n      do{\n        pos4 = pos3 + deltas[++ s];\n      }while(src[pos4] === 0);\n      \n      s &= 7;\n      \n      if ( ( (s - 1) >>> 0) < (s_end >>> 0) ){\n        src[pos3] = -nbd;\n      }\n      else if (src[pos3] === 1){\n        src[pos3] = nbd;\n      }\n\n      contour.push( {x: point.x, y: point.y} );\n      \n      s_prev = s;\n\n      point.x += CV.neighborhood[s][0];\n      point.y += CV.neighborhood[s][1];\n\n      if ( (pos4 === pos) && (pos3 === pos1) ){\n        break;\n      }\n      \n      pos3 = pos4;\n      s = (s + 4) & 7;\n    }\n  }\n\n  return contour;\n};\n\nCV.neighborhood = \n  [ [1, 0], [1, -1], [0, -1], [-1, -1], [-1, 0], [-1, 1], [0, 1], [1, 1] ];\n\nCV.neighborhoodDeltas = function(width){\n  var deltas = [], len = CV.neighborhood.length, i = 0;\n  \n  for (; i < len; ++ i){\n    deltas[i] = CV.neighborhood[i][0] + (CV.neighborhood[i][1] * width);\n  }\n  \n  return deltas.concat(deltas);\n};\n\nCV.approxPolyDP = function(contour, epsilon){\n  var slice = {start_index: 0, end_index: 0},\n      right_slice = {start_index: 0, end_index: 0},\n      poly = [], stack = [], len = contour.length,\n      pt, start_pt, end_pt, dist, max_dist, le_eps,\n      dx, dy, i, j, k;\n  \n  epsilon *= epsilon;\n  \n  k = 0;\n  \n  for (i = 0; i < 3; ++ i){\n    max_dist = 0;\n    \n    k = (k + right_slice.start_index) % len;\n    start_pt = contour[k];\n    if (++ k === len) {k = 0;}\n  \n    for (j = 1; j < len; ++ j){\n      pt = contour[k];\n      if (++ k === len) {k = 0;}\n    \n      dx = pt.x - start_pt.x;\n      dy = pt.y - start_pt.y;\n      dist = dx * dx + dy * dy;\n\n      if (dist > max_dist){\n        max_dist = dist;\n        right_slice.start_index = j;\n      }\n    }\n  }\n\n  if (max_dist <= epsilon){\n    poly.push( {x: start_pt.x, y: start_pt.y} );\n\n  }else{\n    slice.start_index = k;\n    slice.end_index = (right_slice.start_index += slice.start_index);\n  \n    right_slice.start_index -= right_slice.start_index >= len? len: 0;\n    right_slice.end_index = slice.start_index;\n    if (right_slice.end_index < right_slice.start_index){\n      right_slice.end_index += len;\n    }\n    \n    stack.push( {start_index: right_slice.start_index, end_index: right_slice.end_index} );\n    stack.push( {start_index: slice.start_index, end_index: slice.end_index} );\n  }\n\n  while(stack.length !== 0){\n    slice = stack.pop();\n    \n    end_pt = contour[slice.end_index % len];\n    start_pt = contour[k = slice.start_index % len];\n    if (++ k === len) {k = 0;}\n    \n    if (slice.end_index <= slice.start_index + 1){\n      le_eps = true;\n    \n    }else{\n      max_dist = 0;\n\n      dx = end_pt.x - start_pt.x;\n      dy = end_pt.y - start_pt.y;\n      \n      for (i = slice.start_index + 1; i < slice.end_index; ++ i){\n        pt = contour[k];\n        if (++ k === len) {k = 0;}\n        \n        dist = Math.abs( (pt.y - start_pt.y) * dx - (pt.x - start_pt.x) * dy);\n\n        if (dist > max_dist){\n          max_dist = dist;\n          right_slice.start_index = i;\n        }\n      }\n      \n      le_eps = max_dist * max_dist <= epsilon * (dx * dx + dy * dy);\n    }\n    \n    if (le_eps){\n      poly.push( {x: start_pt.x, y: start_pt.y} );\n\n    }else{\n      right_slice.end_index = slice.end_index;\n      slice.end_index = right_slice.start_index;\n\n      stack.push( {start_index: right_slice.start_index, end_index: right_slice.end_index} );\n      stack.push( {start_index: slice.start_index, end_index: slice.end_index} );\n    }\n  }\n  \n  return poly;\n};\n\nCV.warp = function(imageSrc, imageDst, contour, warpSize){\n  var src = imageSrc.data, dst = imageDst.data,\n      width = imageSrc.width, height = imageSrc.height,\n      pos = 0,\n      sx1, sx2, dx1, dx2, sy1, sy2, dy1, dy2, p1, p2, p3, p4,\n      m, r, s, t, u, v, w, x, y, i, j;\n  \n  m = CV.getPerspectiveTransform(contour, warpSize - 1);\n\n  r = m[8];\n  s = m[2];\n  t = m[5];\n  \n  for (i = 0; i < warpSize; ++ i){\n    r += m[7];\n    s += m[1];\n    t += m[4];\n\n    u = r;\n    v = s;\n    w = t;\n    \n    for (j = 0; j < warpSize; ++ j){\n      u += m[6];\n      v += m[0];\n      w += m[3];\n\n      x = v / u;\n      y = w / u;\n\n      sx1 = x >>> 0;\n      sx2 = (sx1 === width - 1)? sx1: sx1 + 1;\n      dx1 = x - sx1;\n      dx2 = 1.0 - dx1;\n\n      sy1 = y >>> 0;\n      sy2 = (sy1 === height - 1)? sy1: sy1 + 1;\n      dy1 = y - sy1;\n      dy2 = 1.0 - dy1;\n\n      p1 = p2 = sy1 * width;\n      p3 = p4 = sy2 * width;\n\n      dst[pos ++] = \n        (dy2 * (dx2 * src[p1 + sx1] + dx1 * src[p2 + sx2]) +\n         dy1 * (dx2 * src[p3 + sx1] + dx1 * src[p4 + sx2]) ) & 0xff;\n\n    }\n  }\n\n  imageDst.width = warpSize;\n  imageDst.height = warpSize;\n\n  return imageDst;\n};\n\nCV.getPerspectiveTransform = function(src, size){\n  var rq = CV.square2quad(src);\n  \n  rq[0] /= size;\n  rq[1] /= size;\n  rq[3] /= size;\n  rq[4] /= size;\n  rq[6] /= size;\n  rq[7] /= size;\n  \n  return rq;\n};\n\nCV.square2quad = function(src){\n  var sq = [], px, py, dx1, dx2, dy1, dy2, den;\n  \n  px = src[0].x - src[1].x + src[2].x - src[3].x;\n  py = src[0].y - src[1].y + src[2].y - src[3].y;\n  \n  if (0 === px && 0 === py){\n    sq[0] = src[1].x - src[0].x;\n    sq[1] = src[2].x - src[1].x;\n    sq[2] = src[0].x;\n    sq[3] = src[1].y - src[0].y;\n    sq[4] = src[2].y - src[1].y;\n    sq[5] = src[0].y;\n    sq[6] = 0;\n    sq[7] = 0;\n    sq[8] = 1;\n\n  }else{\n    dx1 = src[1].x - src[2].x;\n    dx2 = src[3].x - src[2].x;\n    dy1 = src[1].y - src[2].y;\n    dy2 = src[3].y - src[2].y;\n    den = dx1 * dy2 - dx2 * dy1;\n  \n    sq[6] = (px * dy2 - dx2 * py) / den;\n    sq[7] = (dx1 * py - px * dy1) / den;\n    sq[8] = 1;\n    sq[0] = src[1].x - src[0].x + sq[6] * src[1].x;\n    sq[1] = src[3].x - src[0].x + sq[7] * src[3].x;\n    sq[2] = src[0].x;\n    sq[3] = src[1].y - src[0].y + sq[6] * src[1].y;\n    sq[4] = src[3].y - src[0].y + sq[7] * src[3].y;\n    sq[5] = src[0].y;\n  }\n\n  return sq;\n};\n\nCV.isContourConvex = function(contour){\n  var orientation = 0, convex = true,\n      len = contour.length, i = 0, j = 0,\n      cur_pt, prev_pt, dxdy0, dydx0, dx0, dy0, dx, dy;\n\n  prev_pt = contour[len - 1];\n  cur_pt = contour[0];\n\n  dx0 = cur_pt.x - prev_pt.x;\n  dy0 = cur_pt.y - prev_pt.y;\n\n  for (; i < len; ++ i){\n    if (++ j === len) {j = 0;}\n\n    prev_pt = cur_pt;\n    cur_pt = contour[j];\n\n    dx = cur_pt.x - prev_pt.x;\n    dy = cur_pt.y - prev_pt.y;\n    dxdy0 = dx * dy0;\n    dydx0 = dy * dx0;\n\n    orientation |= dydx0 > dxdy0? 1: (dydx0 < dxdy0? 2: 3);\n\n    if (3 === orientation){\n        convex = false;\n        break;\n    }\n\n    dx0 = dx;\n    dy0 = dy;\n  }\n\n  return convex;\n};\n\nCV.perimeter = function(poly){\n  var len = poly.length, i = 0, j = len - 1,\n      p = 0.0, dx, dy;\n\n  for (; i < len; j = i ++){\n    dx = poly[i].x - poly[j].x;\n    dy = poly[i].y - poly[j].y;\n    \n    p += Math.sqrt(dx * dx + dy * dy) ;\n  }\n\n  return p;\n};\n\nCV.minEdgeLength = function(poly){\n  var len = poly.length, i = 0, j = len - 1, \n      min = Infinity, d, dx, dy;\n\n  for (; i < len; j = i ++){\n    dx = poly[i].x - poly[j].x;\n    dy = poly[i].y - poly[j].y;\n\n    d = dx * dx + dy * dy;\n\n    if (d < min){\n      min = d;\n    }\n  }\n  \n  return Math.sqrt(min);\n};\n\nCV.countNonZero = function(imageSrc, square){\n  var src = imageSrc.data, height = square.height, width = square.width,\n      pos = square.x + (square.y * imageSrc.width),\n      span = imageSrc.width - width,\n      nz = 0, i, j;\n  \n  for (i = 0; i < height; ++ i){\n\n    for (j = 0; j < width; ++ j){\n    \n      if ( 0 !== src[pos ++] ){\n        ++ nz;\n      }\n    }\n    \n    pos += span;\n  }\n\n  return nz;\n};\n\nCV.binaryBorder = function(imageSrc, dst){\n  var src = imageSrc.data, height = imageSrc.height, width = imageSrc.width,\n      posSrc = 0, posDst = 0, i, j;\n\n  for (j = -2; j < width; ++ j){\n    dst[posDst ++] = 0;\n  }\n\n  for (i = 0; i < height; ++ i){\n    dst[posDst ++] = 0;\n    \n    for (j = 0; j < width; ++ j){\n      dst[posDst ++] = (0 === src[posSrc ++]? 0: 1);\n    }\n    \n    dst[posDst ++] = 0;\n  }\n\n  for (j = -2; j < width; ++ j){\n    dst[posDst ++] = 0;\n  }\n  \n  return dst;\n};\n\nmodule.exports = CV;","/*\nCopyright (c) 2011 Juan Mellado\n\nPermission is hereby granted, free of charge, to any person obtaining a copy\nof this software and associated documentation files (the \"Software\"), to deal\nin the Software without restriction, including without limitation the rights\nto use, copy, modify, merge, publish, distribute, sublicense, and/or sell\ncopies of the Software, and to permit persons to whom the Software is\nfurnished to do so, subject to the following conditions:\n\nThe above copyright notice and this permission notice shall be included in\nall copies or substantial portions of the Software.\n\nTHE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\nIMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\nFITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\nAUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\nLIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\nOUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\nTHE SOFTWARE.\n*/\n\n/*\nReferences:\n- \"ArUco: a minimal library for Augmented Reality applications based on OpenCv\"\n  http://www.uco.es/investiga/grupos/ava/node/26\n*/\n\nvar CV = require('./cv');\n\nvar AR = AR || {};\n\nAR.Marker = function(id, corners){\n  this.id = id;\n  this.corners = corners;\n};\n\nAR.Detector = function(){\n  this.grey = new CV.Image();\n  this.thres = new CV.Image();\n  this.homography = new CV.Image();\n  this.binary = [];\n  this.contours = [];\n  this.polys = [];\n  this.candidates = [];\n};\n\nAR.Detector.prototype.detect = function(image){\n  CV.grayscale(image, this.grey);\n  CV.adaptiveThreshold(this.grey, this.thres, 2, 7);\n  \n  this.contours = CV.findContours(this.thres, this.binary);\n\n  this.candidates = this.findCandidates(this.contours, image.width * 0.20, 0.05, 10);\n  this.candidates = this.clockwiseCorners(this.candidates);\n  this.candidates = this.notTooNear(this.candidates, 10);\n\n  return this.findMarkers(this.grey, this.candidates, 49);\n};\n\nAR.Detector.prototype.findCandidates = function(contours, minSize, epsilon, minLength){\n  var candidates = [], len = contours.length, contour, poly, i;\n\n  this.polys = [];\n  \n  for (i = 0; i < len; ++ i){\n    contour = contours[i];\n\n    if (contour.length >= minSize){\n      poly = CV.approxPolyDP(contour, contour.length * epsilon);\n\n      this.polys.push(poly);\n\n      if ( (4 === poly.length) && ( CV.isContourConvex(poly) ) ){\n\n        if ( CV.minEdgeLength(poly) >= minLength){\n          candidates.push(poly);\n        }\n      }\n    }\n  }\n\n  return candidates;\n};\n\nAR.Detector.prototype.clockwiseCorners = function(candidates){\n  var len = candidates.length, dx1, dx2, dy1, dy2, swap, i;\n\n  for (i = 0; i < len; ++ i){\n    dx1 = candidates[i][1].x - candidates[i][0].x;\n    dy1 = candidates[i][1].y - candidates[i][0].y;\n    dx2 = candidates[i][2].x - candidates[i][0].x;\n    dy2 = candidates[i][2].y - candidates[i][0].y;\n\n    if ( (dx1 * dy2 - dy1 * dx2) < 0){\n      swap = candidates[i][1];\n      candidates[i][1] = candidates[i][3];\n      candidates[i][3] = swap;\n    }\n  }\n\n  return candidates;\n};\n\nAR.Detector.prototype.notTooNear = function(candidates, minDist){\n  var notTooNear = [], len = candidates.length, dist, dx, dy, i, j, k;\n\n  for (i = 0; i < len; ++ i){\n  \n    for (j = i + 1; j < len; ++ j){\n      dist = 0;\n      \n      for (k = 0; k < 4; ++ k){\n        dx = candidates[i][k].x - candidates[j][k].x;\n        dy = candidates[i][k].y - candidates[j][k].y;\n      \n        dist += dx * dx + dy * dy;\n      }\n      \n      if ( (dist / 4) < (minDist * minDist) ){\n      \n        if ( CV.perimeter( candidates[i] ) < CV.perimeter( candidates[j] ) ){\n          candidates[i].tooNear = true;\n        }else{\n          candidates[j].tooNear = true;\n        }\n      }\n    }\n  }\n\n  for (i = 0; i < len; ++ i){\n    if ( !candidates[i].tooNear ){\n      notTooNear.push( candidates[i] );\n    }\n  }\n\n  return notTooNear;\n};\n\nAR.Detector.prototype.findMarkers = function(imageSrc, candidates, warpSize){\n  var markers = [], len = candidates.length, candidate, marker, i;\n\n  for (i = 0; i < len; ++ i){\n    candidate = candidates[i];\n\n    CV.warp(imageSrc, this.homography, candidate, warpSize);\n  \n    CV.threshold(this.homography, this.homography, CV.otsu(this.homography) );\n\n    marker = this.getMarker(this.homography, candidate);\n    if (marker){\n      markers.push(marker);\n    }\n  }\n  \n  return markers;\n};\n\nAR.Detector.prototype.getMarker = function(imageSrc, candidate){\n  var width = (imageSrc.width / 7) >>> 0,\n      minZero = (width * width) >> 1,\n      bits = [], rotations = [], distances = [],\n      square, pair, inc, i, j;\n\n  for (i = 0; i < 7; ++ i){\n    inc = (0 === i || 6 === i)? 1: 6;\n    \n    for (j = 0; j < 7; j += inc){\n      square = {x: j * width, y: i * width, width: width, height: width};\n      if ( CV.countNonZero(imageSrc, square) > minZero){\n        return null;\n      }\n    }\n  }\n\n  for (i = 0; i < 5; ++ i){\n    bits[i] = [];\n\n    for (j = 0; j < 5; ++ j){\n      square = {x: (j + 1) * width, y: (i + 1) * width, width: width, height: width};\n      \n      bits[i][j] = CV.countNonZero(imageSrc, square) > minZero? 1: 0;\n    }\n  }\n\n  rotations[0] = bits;\n  distances[0] = this.hammingDistance( rotations[0] );\n  \n  pair = {first: distances[0], second: 0};\n  \n  for (i = 1; i < 4; ++ i){\n    rotations[i] = this.rotate( rotations[i - 1] );\n    distances[i] = this.hammingDistance( rotations[i] );\n    \n    if (distances[i] < pair.first){\n      pair.first = distances[i];\n      pair.second = i;\n    }\n  }\n\n  if (0 !== pair.first){\n    return null;\n  }\n\n  return new AR.Marker(\n    this.mat2id( rotations[pair.second] ), \n    this.rotate2(candidate, 4 - pair.second) );\n};\n\nAR.Detector.prototype.hammingDistance = function(bits){\n  var ids = [ [1,0,0,0,0], [1,0,1,1,1], [0,1,0,0,1], [0,1,1,1,0] ],\n      dist = 0, sum, minSum, i, j, k;\n\n  for (i = 0; i < 5; ++ i){\n    minSum = Infinity;\n    \n    for (j = 0; j < 4; ++ j){\n      sum = 0;\n\n      for (k = 0; k < 5; ++ k){\n          sum += bits[i][k] === ids[j][k]? 0: 1;\n      }\n\n      if (sum < minSum){\n        minSum = sum;\n      }\n    }\n\n    dist += minSum;\n  }\n\n  return dist;\n};\n\nAR.Detector.prototype.mat2id = function(bits){\n  var id = 0, i;\n  \n  for (i = 0; i < 5; ++ i){\n    id <<= 1;\n    id |= bits[i][1];\n    id <<= 1;\n    id |= bits[i][3];\n  }\n\n  return id;\n};\n\nAR.Detector.prototype.rotate = function(src){\n  var dst = [], len = src.length, i, j;\n  \n  for (i = 0; i < len; ++ i){\n    dst[i] = [];\n    for (j = 0; j < src[i].length; ++ j){\n      dst[i][j] = src[src[i].length - j - 1][i];\n    }\n  }\n\n  return dst;\n};\n\nAR.Detector.prototype.rotate2 = function(src, rotation){\n  var dst = [], len = src.length, i;\n  \n  for (i = 0; i < len; ++ i){\n    dst[i] = src[ (rotation + i) % len ];\n  }\n\n  return dst;\n};\n\nmodule.exports = AR;","/*\r\nCopyright (c) 2012 Juan Mellado\r\n\r\nPermission is hereby granted, free of charge, to any person obtaining a copy\r\nof this software and associated documentation files (the \"Software\"), to deal\r\nin the Software without restriction, including without limitation the rights\r\nto use, copy, modify, merge, publish, distribute, sublicense, and/or sell\r\ncopies of the Software, and to permit persons to whom the Software is\r\nfurnished to do so, subject to the following conditions:\r\n\r\nThe above copyright notice and this permission notice shall be included in\r\nall copies or substantial portions of the Software.\r\n\r\nTHE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\r\nIMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\r\nFITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\r\nAUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\r\nLIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\r\nOUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\r\nTHE SOFTWARE.\r\n*/\r\n\r\n/*\r\nReferences:\r\n- \"Numerical Recipes in C - Second Edition\"\r\n  http://www.nr.com/\r\n*/\r\n\r\nvar SVD = SVD || {};\r\n\r\nSVD.svdcmp = function(a, m, n, w, v){\r\n  var flag, i, its, j, jj, k, l, nm,\r\n      anorm = 0.0, c, f, g = 0.0, h, s, scale = 0.0, x, y, z, rv1 = [];\r\n      \r\n  //Householder reduction to bidiagonal form\r\n  for (i = 0; i < n; ++ i){\r\n    l = i + 1;\r\n    rv1[i] = scale * g;\r\n    g = s = scale = 0.0;\r\n    if (i < m){\r\n      for (k = i; k < m; ++ k){\r\n        scale += Math.abs( a[k][i] );\r\n      }\r\n      if (0.0 !== scale){\r\n        for (k = i; k < m; ++ k){\r\n          a[k][i] /= scale;\r\n          s += a[k][i] * a[k][i];\r\n        }\r\n        f = a[i][i];\r\n        g = -SVD.sign( Math.sqrt(s), f );\r\n        h = f * g - s;\r\n        a[i][i] = f - g;\r\n        for (j = l; j < n; ++ j){\r\n          for (s = 0.0, k = i; k < m; ++ k){\r\n            s += a[k][i] * a[k][j];\r\n          }\r\n          f = s / h;\r\n          for (k = i; k < m; ++ k){\r\n            a[k][j] += f * a[k][i];\r\n          }\r\n        }\r\n        for (k = i; k < m; ++ k){\r\n          a[k][i] *= scale;\r\n        }\r\n      }\r\n    }\r\n    w[i] = scale * g;\r\n    g = s = scale = 0.0;\r\n    if ( (i < m) && (i !== n - 1) ){\r\n      for (k = l; k < n; ++ k){\r\n        scale += Math.abs( a[i][k] );\r\n      }\r\n      if (0.0 !== scale){\r\n        for (k = l; k < n; ++ k){\r\n          a[i][k] /= scale;\r\n          s += a[i][k] * a[i][k];\r\n        }\r\n        f = a[i][l];\r\n        g = -SVD.sign( Math.sqrt(s), f );\r\n        h = f * g - s;\r\n        a[i][l] = f - g;\r\n        for (k = l; k < n; ++ k){\r\n          rv1[k] = a[i][k] / h;\r\n        }\r\n        for (j = l; j < m; ++ j){\r\n          for (s = 0.0, k = l; k < n; ++ k){\r\n            s += a[j][k] * a[i][k];\r\n          }\r\n          for (k = l; k < n; ++ k){\r\n            a[j][k] += s * rv1[k];\r\n          }\r\n        }\r\n        for (k = l; k < n; ++ k){\r\n          a[i][k] *= scale;\r\n        }\r\n      }\r\n    }\r\n    anorm = Math.max(anorm, ( Math.abs( w[i] ) + Math.abs( rv1[i] ) ) );\r\n  }\r\n\r\n  //Acumulation of right-hand transformation\r\n  for (i = n - 1; i >= 0; -- i){\r\n    if (i < n - 1){\r\n      if (0.0 !== g){\r\n        for (j = l; j < n; ++ j){\r\n          v[j][i] = ( a[i][j] / a[i][l] ) / g;\r\n        }\r\n        for (j = l; j < n; ++ j){\r\n          for (s = 0.0, k = l; k < n; ++ k){\r\n            s += a[i][k] * v[k][j];\r\n          }\r\n          for (k = l; k < n; ++ k){\r\n            v[k][j] += s * v[k][i];\r\n          }\r\n        }\r\n      }\r\n      for (j = l; j < n; ++ j){\r\n        v[i][j] = v[j][i] = 0.0;\r\n      }\r\n    }\r\n    v[i][i] = 1.0;\r\n    g = rv1[i];\r\n    l = i;\r\n  }\r\n\r\n  //Acumulation of left-hand transformation\r\n  for (i = Math.min(n, m) - 1; i >= 0; -- i){\r\n    l = i + 1;\r\n    g = w[i];\r\n    for (j = l; j < n; ++ j){\r\n      a[i][j] = 0.0;\r\n    }\r\n    if (0.0 !== g){\r\n      g = 1.0 / g;\r\n      for (j = l; j < n; ++ j){\r\n        for (s = 0.0, k = l; k < m; ++ k){\r\n          s += a[k][i] * a[k][j];\r\n        }\r\n        f = (s / a[i][i]) * g;\r\n        for (k = i; k < m; ++ k){\r\n          a[k][j] += f * a[k][i];\r\n        }\r\n      }\r\n      for (j = i; j < m; ++ j){\r\n        a[j][i] *= g;\r\n      }\r\n    }else{\r\n        for (j = i; j < m; ++ j){\r\n          a[j][i] = 0.0;\r\n        }\r\n    }\r\n    ++ a[i][i];\r\n  }\r\n\r\n  //Diagonalization of the bidiagonal form\r\n  for (k = n - 1; k >= 0; -- k){\r\n    for (its = 1; its <= 30; ++ its){\r\n      flag = true;\r\n      for (l = k; l >= 0; -- l){\r\n        nm = l - 1;\r\n        if ( Math.abs( rv1[l] ) + anorm === anorm ){\r\n          flag = false;\r\n          break;\r\n        }\r\n        if ( Math.abs( w[nm] ) + anorm === anorm ){\r\n          break;\r\n        }\r\n      }\r\n      if (flag){\r\n        c = 0.0;\r\n        s = 1.0;\r\n        for (i = l; i <= k; ++ i){\r\n          f = s * rv1[i];\r\n          if ( Math.abs(f) + anorm === anorm ){\r\n            break;\r\n          }\r\n          g = w[i];\r\n          h = SVD.pythag(f, g);\r\n          w[i] = h;\r\n          h = 1.0 / h;\r\n          c = g * h;\r\n          s = -f * h;\r\n          for (j = 1; j <= m; ++ j){\r\n            y = a[j][nm];\r\n            z = a[j][i];\r\n            a[j][nm] = y * c + z * s;\r\n            a[j][i] = z * c - y * s;\r\n          }\r\n        }\r\n      }\r\n\r\n      //Convergence\r\n      z = w[k];\r\n      if (l === k){\r\n        if (z < 0.0){\r\n          w[k] = -z;\r\n          for (j = 0; j < n; ++ j){\r\n            v[j][k] = -v[j][k];\r\n          }\r\n        }\r\n        break;\r\n      }\r\n\r\n      if (30 === its){\r\n        return false;\r\n      }\r\n\r\n      //Shift from bottom 2-by-2 minor\r\n      x = w[l];\r\n      nm = k - 1;\r\n      y = w[nm];\r\n      g = rv1[nm];\r\n      h = rv1[k];\r\n      f = ( (y - z) * (y + z) + (g - h) * (g + h) ) / (2.0 * h * y);\r\n      g = SVD.pythag( f, 1.0 );\r\n      f = ( (x - z) * (x + z) + h * ( (y / (f + SVD.sign(g, f) ) ) - h) ) / x;\r\n\r\n      //Next QR transformation\r\n      c = s = 1.0;\r\n      for (j = l; j <= nm; ++ j){\r\n        i = j + 1;\r\n        g = rv1[i];\r\n        y = w[i];\r\n        h = s * g;\r\n        g = c * g;\r\n        z = SVD.pythag(f, h);\r\n        rv1[j] = z;\r\n        c = f / z;\r\n        s = h / z;\r\n        f = x * c + g * s;\r\n        g = g * c - x * s;\r\n        h = y * s;\r\n        y *= c;\r\n        for (jj = 0; jj < n; ++ jj){\r\n          x = v[jj][j];\r\n          z = v[jj][i];\r\n          v[jj][j] = x * c + z * s;\r\n          v[jj][i] = z * c - x * s;\r\n        }\r\n        z = SVD.pythag(f, h);\r\n        w[j] = z;\r\n        if (0.0 !== z){\r\n          z = 1.0 / z;\r\n          c = f * z;\r\n          s = h * z;\r\n        }\r\n        f = c * g + s * y;\r\n        x = c * y - s * g;\r\n        for (jj = 0; jj < m; ++ jj){\r\n          y = a[jj][j];\r\n          z = a[jj][i];\r\n          a[jj][j] = y * c + z * s;\r\n          a[jj][i] = z * c - y * s;\r\n        }\r\n      }\r\n      rv1[l] = 0.0;\r\n      rv1[k] = f;\r\n      w[k] = x;\r\n    }\r\n  }\r\n\r\n  return true;\r\n};\r\n\r\nSVD.pythag = function(a, b){\r\n  var at = Math.abs(a), bt = Math.abs(b), ct;\r\n\r\n  if (at > bt){\r\n    ct = bt / at;\r\n    return at * Math.sqrt(1.0 + ct * ct);\r\n  }\r\n    \r\n  if (0.0 === bt){\r\n    return 0.0;\r\n  }\r\n\r\n  ct = at / bt;\r\n  return bt * Math.sqrt(1.0 + ct * ct);\r\n};\r\n\r\nSVD.sign = function(a, b){\r\n  return b >= 0.0? Math.abs(a): -Math.abs(a);\r\n};\r\n\r\nmodule.exports = SVD;","/*\r\nCopyright (c) 2012 Juan Mellado\r\n\r\nPermission is hereby granted, free of charge, to any person obtaining a copy\r\nof this software and associated documentation files (the \"Software\"), to deal\r\nin the Software without restriction, including without limitation the rights\r\nto use, copy, modify, merge, publish, distribute, sublicense, and/or sell\r\ncopies of the Software, and to permit persons to whom the Software is\r\nfurnished to do so, subject to the following conditions:\r\n\r\nThe above copyright notice and this permission notice shall be included in\r\nall copies or substantial portions of the Software.\r\n\r\nTHE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\r\nIMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\r\nFITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\r\nAUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\r\nLIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\r\nOUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\r\nTHE SOFTWARE.\r\n*/\r\n\r\n/*\r\nReferences:\r\n- \"Iterative Pose Estimation using Coplanar Feature Points\"\r\n  Denis Oberkampf, Daniel F. DeMenthon, Larry S. Davis\r\n  http://www.cfar.umd.edu/~daniel/daniel_papersfordownload/CoplanarPts.pdf\r\n*/\r\n\r\nvar SVD = require('./svd');\r\n\r\nvar POS = POS || {};\r\n\r\nPOS.Posit = function(modelSize, focalLength){\r\n  this.objectPoints = this.buildModel(modelSize);\r\n  this.focalLength = focalLength;\r\n\r\n  this.objectVectors = [];\r\n  this.objectNormal = [];\r\n  this.objectMatrix = [[],[],[]];\r\n  \r\n  this.init();\r\n};\r\n\r\nPOS.Posit.prototype.buildModel = function(modelSize){\r\n  var half = modelSize / 2.0;\r\n  \r\n  return [\r\n    [-half,  half, 0.0],\r\n    [ half,  half, 0.0],\r\n    [ half, -half, 0.0],\r\n    [-half, -half, 0.0] ];\r\n};\r\n\r\nPOS.Posit.prototype.init = function(){\r\n  var np = this.objectPoints.length,\r\n      vectors = [], n = [], len = 0.0, row = 2, i;\r\n  \r\n  for (i = 0; i < np; ++ i){\r\n    this.objectVectors[i] = [this.objectPoints[i][0] - this.objectPoints[0][0],\r\n                             this.objectPoints[i][1] - this.objectPoints[0][1],\r\n                             this.objectPoints[i][2] - this.objectPoints[0][2]];\r\n                             \r\n    vectors[i] = [this.objectVectors[i][0],\r\n                  this.objectVectors[i][1],\r\n                  this.objectVectors[i][2]];\r\n  }\r\n\r\n  while(0.0 === len){\r\n    n[0] = this.objectVectors[1][1] * this.objectVectors[row][2] -\r\n           this.objectVectors[1][2] * this.objectVectors[row][1];\r\n    n[1] = this.objectVectors[1][2] * this.objectVectors[row][0] -\r\n           this.objectVectors[1][0] * this.objectVectors[row][2];\r\n    n[2] = this.objectVectors[1][0] * this.objectVectors[row][1] -\r\n           this.objectVectors[1][1] * this.objectVectors[row][0];\r\n    \r\n    len = Math.sqrt(n[0] * n[0] + n[1] * n[1] + n[2] * n[2]);\r\n    \r\n    ++ row;\r\n  }\r\n\r\n  for (i = 0; i < 3; ++ i){\r\n    this.objectNormal[i] = n[i] / len;\r\n  }\r\n\r\n  POS.pseudoInverse(vectors, np, this.objectMatrix);\r\n};\r\n\r\nPOS.Posit.prototype.pose = function(imagePoints){\r\n  var posRotation1 = [[],[],[]], posRotation2 = [[],[],[]], posTranslation = [],\r\n      rotation1 = [[],[],[]], rotation2 = [[],[],[]], translation1 = [], translation2 = [],\r\n      error1, error2, valid1, valid2, i, j;\r\n\r\n  this.pos(imagePoints, posRotation1, posRotation2, posTranslation);\r\n\r\n  valid1 = this.isValid(posRotation1, posTranslation);\r\n  if (valid1){\r\n    error1 = this.iterate(imagePoints, posRotation1, posTranslation, rotation1, translation1);\r\n  }else{\r\n    error1 = {euclidean: -1.0, pixels: -1, maximum: -1.0};\r\n  }\r\n  \r\n  valid2 = this.isValid(posRotation2, posTranslation);\r\n  if (valid2){\r\n    error2 = this.iterate(imagePoints, posRotation2, posTranslation, rotation2, translation2);\r\n  }else{\r\n    error2 = {euclidean: -1.0, pixels: -1, maximum: -1.0};\r\n  }\r\n\r\n  for (i = 0; i < 3; ++ i){\r\n    for (j = 0; j < 3; ++ j){\r\n      if (valid1){\r\n        translation1[i] -= rotation1[i][j] * this.objectPoints[0][j];\r\n      }\r\n      if (valid2){\r\n        translation2[i] -= rotation2[i][j] * this.objectPoints[0][j];\r\n      }\r\n    }\r\n  }\r\n\r\n  return error1.euclidean < error2.euclidean?\r\n    new POS.Pose(error1.pixels, rotation1, translation1, error2.pixels, rotation2, translation2):\r\n    new POS.Pose(error2.pixels, rotation2, translation2, error1.pixels, rotation1, translation1);\r\n};\r\n\r\nPOS.Posit.prototype.pos = function(imagePoints, rotation1, rotation2, translation){\r\n  var np = this.objectPoints.length, imageVectors = [],\r\n      i0 = [], j0 = [], ivec = [], jvec = [], row1 = [], row2 = [], row3 = [],\r\n      i0i0, j0j0, i0j0, delta, q, lambda, mu, scale, i, j;\r\n\r\n  for (i = 0; i < np; ++ i){\r\n    imageVectors[i] = [imagePoints[i].x - imagePoints[0].x,\r\n                       imagePoints[i].y - imagePoints[0].y];\r\n  }\r\n\r\n  //i0 and j0\r\n  for (i = 0; i < 3; ++ i){\r\n    i0[i] = 0.0;\r\n    j0[i] = 0.0;\r\n    for (j = 0; j < np; ++ j){\r\n      i0[i] += this.objectMatrix[i][j] * imageVectors[j][0];\r\n      j0[i] += this.objectMatrix[i][j] * imageVectors[j][1];\r\n    }\r\n  }\r\n\r\n  i0i0 = i0[0] * i0[0] + i0[1] * i0[1] + i0[2] * i0[2];\r\n  j0j0 = j0[0] * j0[0] + j0[1] * j0[1] + j0[2] * j0[2];\r\n  i0j0 = i0[0] * j0[0] + i0[1] * j0[1] + i0[2] * j0[2];\r\n\r\n  //Lambda and mu\r\n  delta = (j0j0 - i0i0) * (j0j0 - i0i0) + 4.0 * (i0j0 * i0j0);\r\n  \r\n  if (j0j0 - i0i0 >= 0.0){\r\n    q = (j0j0 - i0i0 + Math.sqrt(delta) ) / 2.0;\r\n  }else{\r\n    q = (j0j0 - i0i0 - Math.sqrt(delta) ) / 2.0;\r\n  }\r\n  \r\n  if (q >= 0.0){\r\n    lambda = Math.sqrt(q);\r\n    if (0.0 === lambda){\r\n      mu = 0.0;\r\n    }else{\r\n      mu = -i0j0 / lambda;\r\n    }\r\n  }else{\r\n    lambda = Math.sqrt( -(i0j0 * i0j0) / q);\r\n    if (0.0 === lambda){\r\n      mu = Math.sqrt(i0i0 - j0j0);\r\n    }else{\r\n      mu = -i0j0 / lambda;\r\n    }\r\n  }\r\n\r\n  //First rotation\r\n  for (i = 0; i < 3; ++ i){\r\n    ivec[i] = i0[i] + lambda * this.objectNormal[i];\r\n    jvec[i] = j0[i] + mu * this.objectNormal[i];\r\n  }\r\n  \r\n  scale = Math.sqrt(ivec[0] * ivec[0] + ivec[1] * ivec[1] + ivec[2] * ivec[2]);\r\n  \r\n  for (i = 0; i < 3; ++ i){\r\n    row1[i] = ivec[i] / scale;\r\n    row2[i] = jvec[i] / scale;\r\n  }\r\n  \r\n  row3[0] = row1[1] * row2[2] - row1[2] * row2[1];\r\n  row3[1] = row1[2] * row2[0] - row1[0] * row2[2];\r\n  row3[2] = row1[0] * row2[1] - row1[1] * row2[0];\r\n\r\n  for (i = 0; i < 3; ++ i){\r\n    rotation1[0][i] = row1[i];\r\n    rotation1[1][i] = row2[i];\r\n    rotation1[2][i] = row3[i];\r\n  }\r\n\r\n  //Second rotation\r\n  for (i = 0; i < 3; ++ i){\r\n    ivec[i] = i0[i] - lambda * this.objectNormal[i];\r\n    jvec[i] = j0[i] - mu * this.objectNormal[i];\r\n  }\r\n  \r\n  for (i = 0; i < 3; ++ i){\r\n    row1[i] = ivec[i] / scale;\r\n    row2[i] = jvec[i] / scale;\r\n  }\r\n  \r\n  row3[0] = row1[1] * row2[2] - row1[2] * row2[1];\r\n  row3[1] = row1[2] * row2[0] - row1[0] * row2[2];\r\n  row3[2] = row1[0] * row2[1] - row1[1] * row2[0];\r\n  \r\n  for (i = 0; i < 3; ++ i){\r\n    rotation2[0][i] = row1[i];\r\n    rotation2[1][i] = row2[i];\r\n    rotation2[2][i] = row3[i];\r\n  }\r\n\r\n  //Translation\r\n  translation[0] = imagePoints[0].x / scale;\r\n  translation[1] = imagePoints[0].y / scale;\r\n  translation[2] = this.focalLength / scale;\r\n};\r\n\r\nPOS.Posit.prototype.isValid = function(rotation, translation){\r\n  var np = this.objectPoints.length, zmin = Infinity, i = 0, zi;\r\n\r\n  for (; i < np; ++ i){\r\n    zi = translation[2] +\r\n      (rotation[2][0] * this.objectVectors[i][0] +\r\n       rotation[2][1] * this.objectVectors[i][1] +\r\n       rotation[2][2] * this.objectVectors[i][2]);\r\n    if (zi < zmin){\r\n      zmin = zi;\r\n    }\r\n  }\r\n\r\n  return zmin >= 0.0;\r\n};\r\n\r\nPOS.Posit.prototype.iterate = function(imagePoints, posRotation, posTranslation, rotation, translation){\r\n  var np = this.objectPoints.length,\r\n      oldSopImagePoints = [], sopImagePoints = [],\r\n      rotation1 = [[],[],[]], rotation2 = [[],[],[]],\r\n      translation1 = [], translation2 = [],\r\n      converged = false, iteration = 0,\r\n      oldImageDifference, imageDifference, factor,\r\n      error, error1, error2, delta, i, j;\r\n\r\n  for (i = 0; i < np; ++ i){\r\n    oldSopImagePoints[i] = {x: imagePoints[i].x,\r\n                            y: imagePoints[i].y};\r\n  }\r\n  \r\n  for (i = 0; i < 3; ++ i){\r\n    for (j = 0; j < 3; ++ j){\r\n      rotation[i][j] = posRotation[i][j];\r\n    }\r\n    translation[i] = posTranslation[i];\r\n  }\r\n\r\n  for (i = 0; i < np; ++ i){\r\n    factor = 0.0;\r\n    for (j = 0; j < 3; ++ j){\r\n      factor += this.objectVectors[i][j] * rotation[2][j] / translation[2];\r\n    }\r\n    sopImagePoints[i] = {x: (1.0 + factor) * imagePoints[i].x,\r\n                         y: (1.0 + factor) * imagePoints[i].y};\r\n  }\r\n\r\n  imageDifference = 0.0;\r\n  \r\n  for (i = 0; i < np; ++ i){\r\n    imageDifference += Math.abs(sopImagePoints[i].x - oldSopImagePoints[i].x);\r\n    imageDifference += Math.abs(sopImagePoints[i].y - oldSopImagePoints[i].y);\r\n  }\r\n\r\n  for (i = 0; i < 3; ++ i){\r\n    translation1[i] = translation[i] -\r\n      (rotation[i][0] * this.objectPoints[0][0] +\r\n       rotation[i][1] * this.objectPoints[0][1] +\r\n       rotation[i][2] * this.objectPoints[0][2]);\r\n  }\r\n  \r\n  error = error1 = this.error(imagePoints, rotation, translation1);\r\n\r\n  //Convergence\r\n  converged = (0.0 === error1.pixels) || (imageDifference < 0.01);\r\n  \r\n  while( iteration ++ < 100 && !converged ){\r\n  \r\n    for (i = 0; i < np; ++ i){\r\n      oldSopImagePoints[i].x = sopImagePoints[i].x;\r\n      oldSopImagePoints[i].y = sopImagePoints[i].y;\r\n    }\r\n\r\n    this.pos(sopImagePoints, rotation1, rotation2, translation);\r\n\r\n    for (i = 0; i < 3; ++ i){\r\n      translation1[i] = translation[i] -\r\n        (rotation1[i][0] * this.objectPoints[0][0] +\r\n         rotation1[i][1] * this.objectPoints[0][1] +\r\n         rotation1[i][2] * this.objectPoints[0][2]);\r\n        \r\n      translation2[i] = translation[i] -\r\n        (rotation2[i][0] * this.objectPoints[0][0] +\r\n         rotation2[i][1] * this.objectPoints[0][1] +\r\n         rotation2[i][2] * this.objectPoints[0][2]);\r\n    }\r\n\r\n    error1 = this.error(imagePoints, rotation1, translation1);\r\n    error2 = this.error(imagePoints, rotation2, translation2);\r\n\r\n    if ( (error1.euclidean >= 0.0) && (error2.euclidean >= 0.0) ){\r\n      if (error2.euclidean < error1.euclidean){\r\n        error = error2;\r\n        for (i = 0; i < 3; ++ i){\r\n          for (j = 0; j < 3; ++ j){\r\n            rotation[i][j] = rotation2[i][j];\r\n          }\r\n        }\r\n      }else{\r\n        error = error1;\r\n        for (i = 0; i < 3; ++ i){\r\n          for (j = 0; j < 3; ++ j){\r\n            rotation[i][j] = rotation1[i][j];\r\n          }\r\n        }\r\n      }\r\n    }\r\n\r\n    if ( (error1.euclidean < 0.0) && (error2.euclidean >= 0.0) ){\r\n      error = error2;\r\n      for (i = 0; i < 3; ++ i){\r\n        for (j = 0; j < 3; ++ j){\r\n          rotation[i][j] = rotation2[i][j];\r\n        }\r\n      }\r\n    }\r\n    \r\n    if ( (error2.euclidean < 0.0) && (error1.euclidean >= 0.0) ){\r\n      error = error1;\r\n      for (i = 0; i < 3; ++ i){\r\n        for (j = 0; j < 3; ++ j){\r\n          rotation[i][j] = rotation1[i][j];\r\n        }\r\n      }\r\n    }\r\n\r\n    for (i = 0; i < np; ++ i){\r\n      factor = 0.0;\r\n      for (j = 0; j < 3; ++ j){\r\n        factor += this.objectVectors[i][j] * rotation[2][j] / translation[2];\r\n      }\r\n      sopImagePoints[i].x = (1.0 + factor) * imagePoints[i].x;\r\n      sopImagePoints[i].y = (1.0 + factor) * imagePoints[i].y;\r\n    }\r\n\r\n    oldImageDifference = imageDifference;\r\n    imageDifference = 0.0;\r\n    \r\n    for (i = 0; i < np; ++ i){\r\n      imageDifference += Math.abs(sopImagePoints[i].x - oldSopImagePoints[i].x);\r\n      imageDifference += Math.abs(sopImagePoints[i].y - oldSopImagePoints[i].y);\r\n    }\r\n\r\n    delta = Math.abs(imageDifference - oldImageDifference);\r\n\r\n    converged = (0.0 === error.pixels) || (delta < 0.01);\r\n  }\r\n  \r\n  return error;\r\n};\r\n\r\nPOS.Posit.prototype.error = function(imagePoints, rotation, translation){\r\n  var np = this.objectPoints.length,\r\n      move = [], projection = [], errorvec = [],\r\n      euclidean = 0.0, pixels = 0.0, maximum = 0.0,\r\n      i, j, k;\r\n\r\n  if ( !this.isValid(rotation, translation) ){\r\n    return {euclidean: -1.0, pixels: -1, maximum: -1.0};\r\n  }\r\n  \r\n  for (i = 0; i < np; ++ i){\r\n    move[i] = [];\r\n    for (j = 0; j < 3; ++ j){\r\n      move[i][j] = translation[j];\r\n    }\r\n  }\r\n  \r\n  for (i = 0; i < np; ++ i){\r\n    for (j = 0; j < 3; ++ j){\r\n      for (k = 0; k < 3; ++ k){\r\n        move[i][j] += rotation[j][k] * this.objectPoints[i][k];\r\n      }\r\n    }\r\n  }\r\n\r\n  for (i = 0; i < np; ++ i){\r\n    projection[i] = [];\r\n    for (j = 0; j < 2; ++ j){\r\n      projection[i][j] = this.focalLength * move[i][j] / move[i][2];\r\n    }\r\n  }\r\n  \r\n  for (i = 0; i < np; ++ i){\r\n    errorvec[i] = [projection[i][0] - imagePoints[i].x,\r\n                   projection[i][1] - imagePoints[i].y];\r\n  }\r\n\r\n  for (i = 0; i < np; ++ i){\r\n    euclidean += Math.sqrt(errorvec[i][0] * errorvec[i][0] +\r\n                           errorvec[i][1] * errorvec[i][1]);\r\n                       \r\n    pixels += Math.abs( Math.round(projection[i][0]) - Math.round(imagePoints[i].x) ) +\r\n              Math.abs( Math.round(projection[i][1]) - Math.round(imagePoints[i].y) );\r\n              \r\n    if (Math.abs(errorvec[i][0]) > maximum){\r\n      maximum = Math.abs(errorvec[i][0]);\r\n    }\r\n    if (Math.abs(errorvec[i][1]) > maximum){\r\n      maximum = Math.abs(errorvec[i][1]);\r\n    }\r\n  }\r\n\r\n  return {euclidean: euclidean / np, pixels: pixels, maximum: maximum};\r\n};\r\n\r\nPOS.pseudoInverse = function(a, n, b){\r\n  var w = [], v = [[],[],[]], s = [[],[],[]],\r\n      wmax = 0.0, cn = 0,\r\n      i, j, k;\r\n\r\n  SVD.svdcmp(a, n, 3, w, v);\r\n\r\n  for (i = 0; i < 3; ++ i){\r\n    if (w[i] > wmax){\r\n      wmax = w[i];\r\n    }\r\n  }\r\n\r\n  wmax *= 0.01;\r\n\r\n  for (i = 0; i < 3; ++ i){\r\n    if (w[i] < wmax){\r\n      w[i] = 0.0;\r\n    }\r\n  }\r\n\r\n  for (j = 0; j < 3; ++ j){\r\n    if (0.0 === w[j]){\r\n      ++ cn;\r\n      for (k = j; k < 2; ++ k){\r\n        for (i = 0; i < n; ++ i){\r\n          a[i][k] = a[i][k + 1];\r\n        }\r\n        for (i = 0; i < 3; ++ i){\r\n          v[i][k] = v[i][k + 1];\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  for (j = 0; j < 2; ++ j){\r\n    if (0.0 === w[j]){\r\n      w[j] = w[j + 1];\r\n    }\r\n  }\r\n\r\n  for (i = 0; i < 3; ++ i){\r\n    for (j = 0; j < 3 - cn; ++ j){\r\n      s[i][j] = v[i][j] / w[j];\r\n    }\r\n  }\r\n  \r\n  for (i = 0; i < 3; ++ i){\r\n    for (j = 0; j < n; ++ j){\r\n      b[i][j] = 0.0;\r\n      for (k = 0; k < 3 - cn; ++ k){\r\n        b[i][j] += s[i][k] * a[j][k];\r\n      }\r\n    }\r\n  }\r\n};\r\n\r\nPOS.Pose = function(error1, rotation1, translation1, error2, rotation2, translation2){\r\n  this.bestError = error1;\r\n  this.bestRotation = rotation1;\r\n  this.bestTranslation = translation1;\r\n  this.alternativeError = error2;\r\n  this.alternativeRotation = rotation2;\r\n  this.alternativeTranslation = translation2;\r\n};\r\n\r\nmodule.exports = POS;","/*\r\nCopyright (c) 2012 Juan Mellado\r\n\r\nPermission is hereby granted, free of charge, to any person obtaining a copy\r\nof this software and associated documentation files (the \"Software\"), to deal\r\nin the Software without restriction, including without limitation the rights\r\nto use, copy, modify, merge, publish, distribute, sublicense, and/or sell\r\ncopies of the Software, and to permit persons to whom the Software is\r\nfurnished to do so, subject to the following conditions:\r\n\r\nThe above copyright notice and this permission notice shall be included in\r\nall copies or substantial portions of the Software.\r\n\r\nTHE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\r\nIMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\r\nFITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\r\nAUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\r\nLIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\r\nOUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\r\nTHE SOFTWARE.\r\n*/\r\n\r\n/*\r\nReferences:\r\n- \"3D Pose Estimation\"\r\n  Andrew Kirillow\r\n  http://www.aforgenet.com/articles/posit/\r\n*/\r\n\r\nvar SVD = require('./svd');\r\n\r\nvar POS = POS || {};\r\n\r\nPOS.Posit = function(modelSize, focalLength){\r\n  this.model = this.buildModel(modelSize);\r\n  this.focalLength = focalLength;\r\n\r\n  this.init();\r\n};\r\n\r\nPOS.Posit.prototype.buildModel = function(modelSize){\r\n  var half = modelSize / 2.0;\r\n  \r\n  return [\r\n    new Vec3(-half,  half, 0.0),\r\n    new Vec3( half,  half, 0.0),\r\n    new Vec3( half, -half, 0.0),\r\n    new Vec3(-half, -half, 0.0) ];\r\n};\r\n\r\nPOS.Posit.prototype.init = function(){\r\n  var d = new Vec3(), v = new Mat3(), u;\r\n  \r\n  this.modelVectors = Mat3.fromRows(\r\n      Vec3.sub(this.model[1], this.model[0]),\r\n      Vec3.sub(this.model[2], this.model[0]),\r\n      Vec3.sub(this.model[3], this.model[0]) );\r\n\r\n  u = Mat3.clone(this.modelVectors);\r\n\r\n  SVD.svdcmp(u.m, 3, 3, d.v, v.m);\r\n\r\n  this.modelPseudoInverse = Mat3.mult(\r\n    Mat3.mult(v, Mat3.fromDiagonal( Vec3.inverse(d) ) ), Mat3.transpose(u) );\r\n  \r\n  this.modelNormal = v.column( d.minIndex() );\r\n};\r\n\r\nPOS.Posit.prototype.pose = function(points){\r\n  var eps = new Vec3(1.0, 1.0, 1.0),\r\n      rotation1 = new Mat3(), rotation2 = new Mat3(),\r\n      translation1 = new Vec3(), translation2 = new Vec3(),\r\n      error1, error2;\r\n\r\n  this.pos(points, eps, rotation1, rotation2, translation1, translation2);\r\n\r\n  error1 = this.iterate(points, rotation1, translation1);\r\n  error2 = this.iterate(points, rotation2, translation2);\r\n\r\n  return error1 < error2?\r\n    new POS.Pose(error1, rotation1.m, translation1.v, error2, rotation2.m, translation2.v):\r\n    new POS.Pose(error2, rotation2.m, translation2.v, error1, rotation1.m, translation1.v);\r\n};\r\n\r\nPOS.Posit.prototype.pos = function(points, eps, rotation1, rotation2, translation1, translation2){\r\n  var xi = new Vec3(points[1].x, points[2].x, points[3].x),\r\n      yi = new Vec3(points[1].y, points[2].y, points[3].y),\r\n      xs = Vec3.addScalar( Vec3.mult(xi, eps), -points[0].x),\r\n      ys = Vec3.addScalar( Vec3.mult(yi, eps), -points[0].y),\r\n      i0 = Mat3.multVector(this.modelPseudoInverse, xs),\r\n      j0 = Mat3.multVector(this.modelPseudoInverse, ys),\r\n      s = j0.square() - i0.square(),\r\n      ij = Vec3.dot(i0, j0),\r\n      r = 0.0, theta = 0.0,\r\n      i, j, k, inorm, jnorm, scale, temp, lambda, mu;\r\n\r\n  if (0.0 === s){\r\n    r = Math.sqrt( Math.abs(2.0 * ij) );\r\n    theta = (-Math.PI / 2.0) * (ij < 0.0? -1: (ij > 0.0? 1.0: 0.0) );\r\n  }else{\r\n    r = Math.sqrt( Math.sqrt(s * s + 4.0 * ij * ij) );\r\n    theta = Math.atan(-2.0 * ij / s);\r\n    if (s < 0.0){\r\n      theta += Math.PI;\r\n    }\r\n    theta /= 2.0;\r\n  }\r\n\r\n  lambda = r * Math.cos(theta);\r\n  mu = r * Math.sin(theta);\r\n\r\n  //First possible rotation/translation\r\n  i = Vec3.add(i0, Vec3.multScalar(this.modelNormal, lambda) );\r\n  j = Vec3.add(j0, Vec3.multScalar(this.modelNormal, mu) );\r\n  inorm = i.normalize();\r\n  jnorm = j.normalize();\r\n  k = Vec3.cross(i, j);\r\n  rotation1.copy( Mat3.fromRows(i, j, k) );\r\n  \r\n  scale = (inorm + jnorm) / 2.0;\r\n  temp = Mat3.multVector(rotation1, this.model[0]);\r\n  translation1.v = [\r\n    points[0].x / scale - temp.v[0],\r\n    points[0].y / scale - temp.v[1],\r\n    this.focalLength / scale];\r\n\r\n  //Second possible rotation/translation\r\n  i = Vec3.sub(i0, Vec3.multScalar(this.modelNormal, lambda) );\r\n  j = Vec3.sub(j0, Vec3.multScalar(this.modelNormal, mu) );\r\n  inorm = i.normalize();\r\n  jnorm = j.normalize();\r\n  k = Vec3.cross(i, j);\r\n  rotation2.copy( Mat3.fromRows(i, j, k) );\r\n  \r\n  scale = (inorm + jnorm) / 2.0;\r\n  temp = Mat3.multVector(rotation2, this.model[0]);\r\n  translation2.v = [\r\n    points[0].x / scale - temp.v[0],\r\n    points[0].y / scale - temp.v[1],\r\n    this.focalLength / scale];\r\n};\r\n\r\nPOS.Posit.prototype.iterate = function(points, rotation, translation){\r\n  var prevError = Infinity,\r\n      rotation1 = new Mat3(), rotation2 = new Mat3(),\r\n      translation1 = new Vec3(), translation2 = new Vec3(),\r\n      i = 0, eps, error, error1, error2;\r\n\r\n  for (; i < 100; ++ i){\r\n    eps = Vec3.addScalar( Vec3.multScalar( \r\n      Mat3.multVector( this.modelVectors, rotation.row(2) ), 1.0 / translation.v[2]), 1.0);\r\n\r\n    this.pos(points, eps, rotation1, rotation2, translation1, translation2);\r\n\r\n    error1 = this.getError(points, rotation1, translation1);\r\n    error2 = this.getError(points, rotation2, translation2);\r\n\r\n    if (error1 < error2){\r\n      rotation.copy(rotation1);\r\n      translation.copy(translation1);\r\n      error = error1;\r\n    }else{\r\n      rotation.copy(rotation2);\r\n      translation.copy(translation2);\r\n      error = error2;\r\n    }\r\n\r\n    if ( (error <= 2.0) || (error > prevError) ){\r\n      break;\r\n    }\r\n\r\n    prevError = error;\r\n  }\r\n\r\n  return error;\r\n};\r\n\r\nPOS.Posit.prototype.getError = function(points, rotation, translation){\r\n  var v1 = Vec3.add( Mat3.multVector(rotation, this.model[0]), translation),\r\n      v2 = Vec3.add( Mat3.multVector(rotation, this.model[1]), translation),\r\n      v3 = Vec3.add( Mat3.multVector(rotation, this.model[2]), translation),\r\n      v4 = Vec3.add( Mat3.multVector(rotation, this.model[3]), translation),\r\n      modeled, ia1, ia2, ia3, ia4, ma1, ma2, ma3, ma4;\r\n  \r\n  v1 = v1.v; v2 = v2.v; v3 = v3.v; v4 = v4.v;\r\n  \r\n  v1[0] *= this.focalLength / v1[2];\r\n  v1[1] *= this.focalLength / v1[2];\r\n  v2[0] *= this.focalLength / v2[2];\r\n  v2[1] *= this.focalLength / v2[2];\r\n  v3[0] *= this.focalLength / v3[2];\r\n  v3[1] *= this.focalLength / v3[2];\r\n  v4[0] *= this.focalLength / v4[2];\r\n  v4[1] *= this.focalLength / v4[2];\r\n  \r\n  modeled = [\r\n    {x: v1[0], y: v1[1]},\r\n    {x: v2[0], y: v2[1]},\r\n    {x: v3[0], y: v3[1]},\r\n    {x: v4[0], y: v4[1]}\r\n  ];\r\n\r\n  ia1 = this.angle( points[0], points[1], points[3] );\r\n  ia2 = this.angle( points[1], points[2], points[0] );\r\n  ia3 = this.angle( points[2], points[3], points[1] );\r\n  ia4 = this.angle( points[3], points[0], points[2] );\r\n\r\n  ma1 = this.angle( modeled[0], modeled[1], modeled[3] );\r\n  ma2 = this.angle( modeled[1], modeled[2], modeled[0] );\r\n  ma3 = this.angle( modeled[2], modeled[3], modeled[1] );\r\n  ma4 = this.angle( modeled[3], modeled[0], modeled[2] );\r\n\r\n  return ( Math.abs(ia1 - ma1) +\r\n           Math.abs(ia2 - ma2) +\r\n           Math.abs(ia3 - ma3) +\r\n           Math.abs(ia4 - ma4) ) / 4.0;\r\n};\r\n\r\nPOS.Posit.prototype.angle = function(a, b, c){\r\n  var x1 = b.x - a.x, y1 = b.y - a.y,\r\n      x2 = c.x - a.x, y2 = c.y - a.y;\r\n  \r\n  return Math.acos( (x1 * x2 + y1 * y2) / \r\n    (Math.sqrt(x1 * x1 + y1 * y1) * Math.sqrt(x2 * x2 + y2 * y2) ) ) * 180.0 / Math.PI;\r\n};\r\n\r\nPOS.Pose = function(error1, rotation1, translation1, error2, rotation2, translation2){\r\n  this.bestError = error1;\r\n  this.bestRotation = rotation1;\r\n  this.bestTranslation = translation1;\r\n  this.alternativeError = error2;\r\n  this.alternativeRotation = rotation2;\r\n  this.alternativeTranslation = translation2;\r\n};\r\n\r\nvar Vec3 = function(x, y, z){\r\n  this.v = [x || 0.0, y || 0.0, z || 0.0];\r\n};\r\n\r\nVec3.prototype.copy = function(a){\r\n  var v = this.v;\r\n\r\n  a = a.v;\r\n\r\n  v[0] = a[0];\r\n  v[1] = a[1];\r\n  v[2] = a[2];\r\n\r\n  return this;\r\n};\r\n\r\nVec3.add = function(a, b){\r\n  var vector = new Vec3(), v = vector.v;\r\n  \r\n  a = a.v; b = b.v;\r\n\r\n  v[0] = a[0] + b[0];\r\n  v[1] = a[1] + b[1];\r\n  v[2] = a[2] + b[2];\r\n  \r\n  return vector;\r\n};\r\n\r\nVec3.sub = function(a, b){\r\n  var vector = new Vec3(), v = vector.v;\r\n  \r\n  a = a.v; b = b.v;\r\n\r\n  v[0] = a[0] - b[0];\r\n  v[1] = a[1] - b[1];\r\n  v[2] = a[2] - b[2];\r\n  \r\n  return vector;\r\n};\r\n\r\nVec3.mult = function(a, b){\r\n  var vector = new Vec3(), v = vector.v;\r\n  \r\n  a = a.v; b = b.v;\r\n\r\n  v[0] = a[0] * b[0];\r\n  v[1] = a[1] * b[1];\r\n  v[2] = a[2] * b[2];\r\n  \r\n  return vector;\r\n};\r\n\r\nVec3.addScalar = function(a, b){\r\n  var vector = new Vec3(), v = vector.v;\r\n  \r\n  a = a.v;\r\n\r\n  v[0] = a[0] + b;\r\n  v[1] = a[1] + b;\r\n  v[2] = a[2] + b;\r\n  \r\n  return vector;\r\n};\r\n\r\nVec3.multScalar = function(a, b){\r\n  var vector = new Vec3(), v = vector.v;\r\n  \r\n  a = a.v;\r\n\r\n  v[0] = a[0] * b;\r\n  v[1] = a[1] * b;\r\n  v[2] = a[2] * b;\r\n  \r\n  return vector;\r\n};\r\n\r\nVec3.dot = function(a, b){\r\n  a = a.v; b = b.v;\r\n\r\n  return a[0] * b[0] + a[1] * b[1] + a[2] * b[2];\r\n};\r\n\r\nVec3.cross = function(a, b){\r\n  a = a.v; b = b.v;\r\n\r\n return new Vec3(\r\n    a[1] * b[2] - a[2] * b[1],\r\n    a[2] * b[0] - a[0] * b[2],\r\n    a[0] * b[1] - a[1] * b[0]);\r\n};\r\n\r\nVec3.prototype.normalize = function(){\r\n  var v = this.v,\r\n      len = Math.sqrt(v[0] * v[0] + v[1] * v[1] + v[2] * v[2]);\r\n      \r\n  if (len > 0.0){\r\n    v[0] /= len;\r\n    v[1] /= len;\r\n    v[2] /= len;\r\n  }\r\n\r\n  return len;\r\n};\r\n\r\nVec3.inverse = function(a){\r\n  var vector = new Vec3(), v = vector.v;\r\n  \r\n  a = a.v;\r\n  \r\n  if (a[0] !== 0.0){\r\n    v[0] = 1.0 / a[0];\r\n  }\r\n  if (a[1] !== 0.0){\r\n    v[1] = 1.0 / a[1];\r\n  }\r\n  if (a[2] !== 0.0){\r\n    v[2] = 1.0 / a[2];\r\n  }\r\n  \r\n  return vector;\r\n};\r\n\r\nVec3.prototype.square = function(){\r\n  var v = this.v;\r\n\r\n  return v[0] * v[0] + v[1] * v[1] + v[2] * v[2];\r\n};\r\n\r\nVec3.prototype.minIndex = function(){\r\n  var v = this.v;\r\n\r\n  return v[0] < v[1]? (v[0] < v[2]? 0: 2): (v[1] < v[2]? 1: 2);\r\n};\r\n\r\nvar Mat3 = function(){\r\n  this.m = [ [0.0, 0.0, 0.0],\r\n             [0.0, 0.0, 0.0],\r\n             [0.0, 0.0, 0.0] ];\r\n};\r\n\r\nMat3.clone = function(a){\r\n  var matrix = new Mat3(), m = matrix.m;\r\n  \r\n  a = a.m;\r\n\r\n  m[0][0] = a[0][0];\r\n  m[0][1] = a[0][1];\r\n  m[0][2] = a[0][2];\r\n  m[1][0] = a[1][0];\r\n  m[1][1] = a[1][1];\r\n  m[1][2] = a[1][2];\r\n  m[2][0] = a[2][0];\r\n  m[2][1] = a[2][1];\r\n  m[2][2] = a[2][2];\r\n  \r\n  return matrix;\r\n};\r\n\r\nMat3.prototype.copy = function(a){\r\n  var m = this.m;\r\n\r\n  a = a.m;\r\n\r\n  m[0][0] = a[0][0];\r\n  m[0][1] = a[0][1];\r\n  m[0][2] = a[0][2];\r\n  m[1][0] = a[1][0];\r\n  m[1][1] = a[1][1];\r\n  m[1][2] = a[1][2];\r\n  m[2][0] = a[2][0];\r\n  m[2][1] = a[2][1];\r\n  m[2][2] = a[2][2];\r\n\r\n  return this;\r\n};\r\n\r\nMat3.fromRows = function(a, b, c){\r\n  var matrix = new Mat3(), m = matrix.m;\r\n  \r\n  a = a.v; b = b.v; c = c.v;\r\n  \r\n  m[0][0] = a[0];\r\n  m[0][1] = a[1];\r\n  m[0][2] = a[2];\r\n  m[1][0] = b[0];\r\n  m[1][1] = b[1];\r\n  m[1][2] = b[2];\r\n  m[2][0] = c[0];\r\n  m[2][1] = c[1];\r\n  m[2][2] = c[2];\r\n\r\n  return matrix;\r\n};\r\n\r\nMat3.fromDiagonal = function(a){\r\n  var matrix = new Mat3(), m = matrix.m;\r\n  \r\n  a = a.v;\r\n  \r\n  m[0][0] = a[0];\r\n  m[1][1] = a[1];\r\n  m[2][2] = a[2];\r\n  \r\n  return matrix;\r\n};\r\n\r\nMat3.transpose = function(a){\r\n  var matrix = new Mat3(), m = matrix.m;\r\n  \r\n  a = a.m;\r\n  \r\n  m[0][0] = a[0][0];\r\n  m[0][1] = a[1][0];\r\n  m[0][2] = a[2][0];\r\n  m[1][0] = a[0][1];\r\n  m[1][1] = a[1][1];\r\n  m[1][2] = a[2][1];\r\n  m[2][0] = a[0][2];\r\n  m[2][1] = a[1][2];\r\n  m[2][2] = a[2][2];\r\n            \r\n  return matrix;\r\n};\r\n\r\nMat3.mult = function(a, b){\r\n  var matrix = new Mat3(), m = matrix.m;\r\n  \r\n  a = a.m; b = b.m;\r\n\r\n  m[0][0] = a[0][0] * b[0][0] + a[0][1] * b[1][0] + a[0][2] * b[2][0];\r\n  m[0][1] = a[0][0] * b[0][1] + a[0][1] * b[1][1] + a[0][2] * b[2][1];\r\n  m[0][2] = a[0][0] * b[0][2] + a[0][1] * b[1][2] + a[0][2] * b[2][2];\r\n  m[1][0] = a[1][0] * b[0][0] + a[1][1] * b[1][0] + a[1][2] * b[2][0];\r\n  m[1][1] = a[1][0] * b[0][1] + a[1][1] * b[1][1] + a[1][2] * b[2][1];\r\n  m[1][2] = a[1][0] * b[0][2] + a[1][1] * b[1][2] + a[1][2] * b[2][2];\r\n  m[2][0] = a[2][0] * b[0][0] + a[2][1] * b[1][0] + a[2][2] * b[2][0];\r\n  m[2][1] = a[2][0] * b[0][1] + a[2][1] * b[1][1] + a[2][2] * b[2][1];\r\n  m[2][2] = a[2][0] * b[0][2] + a[2][1] * b[1][2] + a[2][2] * b[2][2];\r\n\r\n  return matrix;\r\n};\r\n\r\nMat3.multVector = function(m, a){\r\n  m = m.m; a = a.v;\r\n  \r\n  return new Vec3(\r\n    m[0][0] * a[0] + m[0][1] * a[1] + m[0][2] * a[2],\r\n    m[1][0] * a[0] + m[1][1] * a[1] + m[1][2] * a[2],\r\n    m[2][0] * a[0] + m[2][1] * a[1] + m[2][2] * a[2]);\r\n};\r\n\r\nMat3.prototype.column = function(index){\r\n  var m = this.m;\r\n  \r\n  return new Vec3( m[0][index], m[1][index], m[2][index] );\r\n};\r\n\r\nMat3.prototype.row = function(index){\r\n  var m = this.m;\r\n  \r\n  return new Vec3( m[index][0], m[index][1], m[index][2] );\r\n};\r\n\r\nmodule.exports = POS;","module.exports = {\n  CV: require('./src/cv'),\n  AR: require('./src/aruco'),\n  SVD: require('./src/svd'),\n  POS1: require('./src/posit1'),\n  POS2: require('./src/posit2')\n}","import { AR } from 'js-aruco'\r\nimport { canonicalRimTargets, computeHomographyDLT, rmsError, type Homography, type Point } from './vision'\r\n\r\nexport type MarkerKey = 'top' | 'right' | 'bottom' | 'left'\r\n\r\nexport const MARKER_ORDER: MarkerKey[] = ['top', 'right', 'bottom', 'left']\r\n\r\nexport const MARKER_TARGETS: Record<MarkerKey, number> = {\r\n  top: 0,\r\n  right: 1,\r\n  bottom: 2,\r\n  left: 3,\r\n}\r\n\r\nexport type MarkerDetection = {\r\n  success: boolean\r\n  points: Point[]\r\n  missing: MarkerKey[]\r\n  markersFound: Array<{ id: number; center: Point }>\r\n  assignments: Partial<Record<MarkerKey, { id: number; center: Point }>>\r\n  homography: Homography | null\r\n  errorPx: number | null\r\n  message?: string\r\n}\r\n\r\nlet detector: AR.Detector | null = null\r\n\r\nfunction ensureDetector() {\r\n  if (!detector) detector = new AR.Detector()\r\n  return detector\r\n}\r\n\r\nfunction centerFromCorners(corners: { x: number; y: number }[]): Point {\r\n  const acc = corners.reduce((sum, corner) => ({ x: sum.x + corner.x, y: sum.y + corner.y }), { x: 0, y: 0 })\r\n  const count = corners.length || 1\r\n  return { x: acc.x / count, y: acc.y / count }\r\n}\r\n\r\nexport function detectMarkersFromImage(image: ImageData): MarkerDetection {\r\n  try {\r\n    const det = ensureDetector()\r\n    const markers = det.detect(image) || []\r\n    const assignments: Partial<Record<MarkerKey, { id: number; center: Point }>> = {}\r\n    const found: Array<{ id: number; center: Point }> = []\r\n    \r\n    // Map detected markers to their positions\r\n    for (const marker of markers) {\r\n      const center = centerFromCorners(marker.corners)\r\n      found.push({ id: marker.id, center })\r\n      const key = (Object.keys(MARKER_TARGETS) as MarkerKey[]).find(k => MARKER_TARGETS[k] === marker.id)\r\n      if (key) assignments[key] = { id: marker.id, center }\r\n    }\r\n    \r\n    const missing = (Object.keys(MARKER_TARGETS) as MarkerKey[]).filter(k => !assignments[k])\r\n    \r\n    // If we found some markers but not all, provide helpful info in the error\r\n    if (missing.length > 0) {\r\n      return {\r\n        success: false,\r\n        points: [],\r\n        missing,\r\n        markersFound: found,\r\n        assignments,\r\n        homography: null,\r\n        errorPx: null,\r\n        message: found.length > 0 \r\n          ? `Detected ${found.length} of 4 markers. Some markers may have incorrect IDs or be unclear.`\r\n          : 'Not all calibration markers were detected.',\r\n      }\r\n    }\r\n    \r\n    // All 4 markers found - compute homography\r\n    const dst = [assignments.top!.center, assignments.right!.center, assignments.bottom!.center, assignments.left!.center]\r\n    // Use only the first 4 canonical rim targets (TOP, RIGHT, BOTTOM, LEFT) to match the 4 marker points\r\n    const allTargets = canonicalRimTargets()\r\n    const src = allTargets.slice(0, 4)\r\n    const H = computeHomographyDLT(src, dst)\r\n    const error = rmsError(H, src, dst)\r\n    return {\r\n      success: true,\r\n      points: dst,\r\n      missing: [],\r\n      markersFound: found,\r\n      assignments,\r\n      homography: H,\r\n      errorPx: error,\r\n    }\r\n  } catch (err) {\r\n    return {\r\n      success: false,\r\n      points: [],\r\n      missing: (Object.keys(MARKER_TARGETS) as MarkerKey[]),\r\n      markersFound: [],\r\n      assignments: {},\r\n      homography: null,\r\n      errorPx: null,\r\n      message: err instanceof Error ? err.message : 'Marker detection failed',\r\n    }\r\n  }\r\n}\r\n\r\nexport function detectMarkersFromCanvas(canvas: HTMLCanvasElement): MarkerDetection {\r\n  const ctx = canvas.getContext('2d')\r\n  if (!ctx) {\r\n    return {\r\n      success: false,\r\n      points: [],\r\n      missing: (Object.keys(MARKER_TARGETS) as MarkerKey[]),\r\n      markersFound: [],\r\n      assignments: {},\r\n      homography: null,\r\n      errorPx: null,\r\n      message: 'Canvas context unavailable for marker detection.',\r\n    }\r\n  }\r\n  const tryDetect = (img: ImageData): MarkerDetection => detectMarkersFromImage(img)\r\n\r\n  // Pass 1: raw image\r\n  let imageData = ctx.getImageData(0, 0, canvas.width, canvas.height)\r\n  let result = tryDetect(imageData)\r\n  if (result.success || (result.markersFound?.length||0) > 0) return result\r\n\r\n  // Pass 2: scale up 1.75x (helps low-resolution streams)\r\n  try {\r\n    const scale = 1.75\r\n    const off = document.createElement('canvas')\r\n    off.width = Math.round(canvas.width * scale)\r\n    off.height = Math.round(canvas.height * scale)\r\n    const octx = off.getContext('2d')!\r\n    octx.imageSmoothingEnabled = false\r\n    octx.drawImage(canvas, 0, 0, off.width, off.height)\r\n    imageData = octx.getImageData(0, 0, off.width, off.height)\r\n    result = tryDetect(imageData)\r\n    if (result.success || (result.markersFound?.length||0) > 0) return result\r\n  } catch {}\r\n\r\n  // Pass 3: contrast boost (simple linear stretch)\r\n  try {\r\n    const w = canvas.width, h = canvas.height\r\n    const id = ctx.getImageData(0, 0, w, h)\r\n    const data = id.data\r\n    let min = 255, max = 0\r\n    // Compute luminance min/max\r\n    for (let i = 0; i < data.length; i += 4) {\r\n      const y = (0.2126 * data[i] + 0.7152 * data[i+1] + 0.0722 * data[i+2])\r\n      if (y < min) min = y\r\n      if (y > max) max = y\r\n    }\r\n    const range = Math.max(1, max - min)\r\n    for (let i = 0; i < data.length; i += 4) {\r\n      const y = (0.2126 * data[i] + 0.7152 * data[i+1] + 0.0722 * data[i+2])\r\n      const yn = Math.max(0, Math.min(255, ((y - min) * 255) / range))\r\n      data[i] = data[i+1] = data[i+2] = yn\r\n    }\r\n    result = tryDetect(id)\r\n    if (result.success || (result.markersFound?.length||0) > 0) return result\r\n  } catch {}\r\n\r\n  // Pass 4: aggressive threshold (convert to pure black & white)\r\n  try {\r\n    const w = canvas.width, h = canvas.height\r\n    const id = ctx.getImageData(0, 0, w, h)\r\n    const data = id.data\r\n    // Find middle gray\r\n    let sum = 0, count = 0\r\n    for (let i = 0; i < data.length; i += 4) {\r\n      const y = (0.2126 * data[i] + 0.7152 * data[i+1] + 0.0722 * data[i+2])\r\n      sum += y; count++\r\n    }\r\n    const threshold = sum / count\r\n    // Convert to pure B&W\r\n    for (let i = 0; i < data.length; i += 4) {\r\n      const y = (0.2126 * data[i] + 0.7152 * data[i+1] + 0.0722 * data[i+2])\r\n      const v = y > threshold ? 255 : 0\r\n      data[i] = data[i+1] = data[i+2] = v\r\n    }\r\n    result = tryDetect(id)\r\n    if (result.success || (result.markersFound?.length||0) > 0) return result\r\n  } catch {}\r\n\r\n  // If still nothing, return the last result (with helpful message)\r\n  return {\r\n    success: false,\r\n    points: [],\r\n    missing: (Object.keys(MARKER_TARGETS) as MarkerKey[]),\r\n    markersFound: result.markersFound || [],\r\n    assignments: result.assignments || {},\r\n\r\n    homography: null,\r\n    errorPx: null,\r\n    message: result.message || 'No calibration markers detected. Ensure you are using the provided TOP/RIGHT/BOTTOM/LEFT ArUco markers printed at 100% on white paper.',\r\n  }\r\n}\r\n\r\nconst ROW_PATTERNS: Record<string, number[]> = {\r\n  '0,0': [1, 0, 0, 0, 0],\r\n  '0,1': [1, 0, 1, 1, 1],\r\n  '1,0': [0, 1, 0, 0, 1],\r\n  '1,1': [0, 1, 1, 1, 0],\r\n}\r\n\r\nexport function markerIdToMatrix(id: number): number[][] {\r\n  const rows: number[][] = new Array(5)\r\n  let bits = id >>> 0\r\n  for (let row = 4; row >= 0; row--) {\r\n    const bit3 = bits & 1; bits >>= 1\r\n    const bit1 = bits & 1; bits >>= 1\r\n    const pattern = ROW_PATTERNS[`${bit1},${bit3}`]\r\n    if (!pattern) throw new Error(`Unsupported marker id pattern for row ${row}`)\r\n    rows[row] = pattern.slice()\r\n  }\r\n  const matrix = Array.from({ length: 7 }, () => new Array(7).fill(0))\r\n  for (let y = 0; y < 5; y++) {\r\n    for (let x = 0; x < 5; x++) {\r\n      matrix[y + 1][x + 1] = rows[y][x]\r\n    }\r\n  }\r\n  return matrix\r\n}\r\n","/**\r\n * Advanced Dartboard Auto-Calibration\r\n * \r\n * Detects dartboard features automatically without markers or manual clicking:\r\n * 1. Detects bull (inner & outer rings) using circle detection\r\n * 2. Detects treble and double rings using edge/circle detection\r\n * 3. Computes board center and orientation\r\n * 4. Generates calibration points from detected rings\r\n * 5. Computes homography without user interaction\r\n */\r\n\r\nimport { BoardRadii, computeHomographyDLT, rmsError, type Homography, type Point } from './vision'\r\n\r\nconst isFinitePoint = (p: Point | undefined): p is Point => !!p && Number.isFinite(p.x) && Number.isFinite(p.y)\r\nconst isFiniteHomography = (H: Homography | null | undefined): H is Homography => Array.isArray(H) && H.length === 9 && H.every(Number.isFinite)\r\n\r\nexport interface BoardDetectionResult {\r\n  success: boolean\r\n  cx: number              // Board center X in image\r\n  cy: number              // Board center Y in image\r\n  bullInner: number       // Detected inner bull radius (pixels)\r\n  bullOuter: number       // Detected outer bull radius (pixels)\r\n  trebleInner: number     // Detected treble inner radius (pixels)\r\n  trebleOuter: number     // Detected treble outer radius (pixels)\r\n  doubleInner: number     // Detected double inner radius (pixels)\r\n  doubleOuter: number     // Detected double outer radius (pixels)\r\n  confidence: number      // 0-100, quality of detection\r\n  homography: Homography | null\r\n  errorPx: number | null\r\n  calibrationPoints: Point[]\r\n  message?: string\r\n}\r\n\r\n/**\r\n * Detect dartboard by finding concentric rings\r\n * Simpler, more direct approach: look for strong circular edges at the right distances\r\n */\r\nfunction findDartboardRings(canvas: HTMLCanvasElement): { cx: number; cy: number; r: number; confidence: number } | null {\r\n  const ctx = canvas.getContext('2d')\r\n  if (!ctx) return null\r\n\r\n  const w = canvas.width\r\n  const h = canvas.height\r\n  const imageData = ctx.getImageData(0, 0, w, h)\r\n  const data = imageData.data\r\n\r\n  // Step 1: Find all strong edges using Canny-like detection\r\n  const edges: Array<{ x: number; y: number; mag: number }> = []\r\n\r\n  for (let y = 2; y < h - 2; y++) {\r\n    for (let x = 2; x < w - 2; x++) {\r\n      const idx = (y * w + x) * 4\r\n      \r\n      // Compute gradients\r\n      let gx = 0, gy = 0\r\n      for (let dy = -1; dy <= 1; dy++) {\r\n        for (let dx = -1; dx <= 1; dx++) {\r\n          const pidx = ((y + dy) * w + (x + dx)) * 4\r\n          const gray = data[pidx] * 0.299 + data[pidx + 1] * 0.587 + data[pidx + 2] * 0.114\r\n          if (dx !== 0) gx += (dx > 0 ? 1 : -1) * gray\r\n          if (dy !== 0) gy += (dy > 0 ? 1 : -1) * gray\r\n        }\r\n      }\r\n      \r\n      const mag = Math.hypot(gx, gy)\r\n      if (mag > 20) {\r\n        edges.push({ x, y, mag })\r\n      }\r\n    }\r\n  }\r\n\r\n  if (edges.length === 0) return null\r\n\r\n  // Step 2: For each potential center, score how many rings we can explain\r\n  let bestCenter = null\r\n  let bestScore = 0\r\n\r\n  // Sample potential centers\r\n  for (let cy = h * 0.3; cy < h * 0.7; cy += 10) {\r\n    for (let cx = w * 0.3; cx < w * 0.7; cx += 10) {\r\n      // For this center, find rings at expected radii\r\n      let ringCount = 0\r\n      let ringStrength = 0\r\n\r\n      // Test for rings at known pixel radii (assuming double radius ~150px)\r\n      const testRadii = [15, 30, 150, 162, 180, 205]\r\n      \r\n      for (const testR of testRadii) {\r\n        let strength = 0\r\n        let pixelCount = 0\r\n\r\n        // Count edge pixels near this radius\r\n        for (const edge of edges) {\r\n          const dist = Math.hypot(edge.x - cx, edge.y - cy)\r\n          if (Math.abs(dist - testR) < 3) {\r\n            strength += edge.mag\r\n            pixelCount++\r\n          }\r\n        }\r\n\r\n        if (pixelCount > 10 && strength > 500) {\r\n          ringCount++\r\n          ringStrength += strength\r\n        }\r\n      }\r\n\r\n      // Want at least 4 strong rings\r\n      if (ringCount >= 4 && ringStrength > bestScore) {\r\n        bestScore = ringStrength\r\n        bestCenter = { cx, cy }\r\n      }\r\n    }\r\n  }\r\n\r\n  if (!bestCenter) return null\r\n\r\n  // Step 3: Refine the center position and find double radius\r\n  const refinedCx = bestCenter.cx\r\n  const refinedCy = bestCenter.cy\r\n\r\n  // Find the strongest ring near where we expect the double outer (165-190 pixels for typical image)\r\n  let doubleR = 170\r\n  let maxStrength = 0\r\n\r\n  for (let testR = 120; testR <= 250; testR += 5) {\r\n    let strength = 0\r\n    let pixelCount = 0\r\n\r\n    for (const edge of edges) {\r\n      const dist = Math.hypot(edge.x - refinedCx, edge.y - refinedCy)\r\n      if (Math.abs(dist - testR) < 2) {\r\n        strength += edge.mag\r\n        pixelCount++\r\n      }\r\n    }\r\n\r\n    if (pixelCount > 20 && strength > maxStrength) {\r\n      maxStrength = strength\r\n      doubleR = testR\r\n    }\r\n  }\r\n\r\n  // Calculate confidence based on how many proper rings we found\r\n  let confidence = 0\r\n  const scale = doubleR / BoardRadii.doubleOuter\r\n  \r\n  for (const knownR of [BoardRadii.bullInner, BoardRadii.bullOuter, BoardRadii.trebleInner, BoardRadii.trebleOuter, BoardRadii.doubleInner, BoardRadii.doubleOuter]) {\r\n    const expectedPixelR = knownR * scale\r\n    let found = false\r\n\r\n    for (const edge of edges) {\r\n      const dist = Math.hypot(edge.x - refinedCx, edge.y - refinedCy)\r\n      if (Math.abs(dist - expectedPixelR) < 3) {\r\n        found = true\r\n        confidence += 15\r\n        break\r\n      }\r\n    }\r\n  }\r\n\r\n  confidence = Math.min(100, confidence)\r\n\r\n  return {\r\n    cx: refinedCx,\r\n    cy: refinedCy,\r\n    r: doubleR,\r\n    confidence,\r\n  }\r\n}\r\n\r\n/**\r\n * Main board detection function\r\n * Uses direct ring detection approach\r\n */\r\nexport function detectBoard(canvas: HTMLCanvasElement): BoardDetectionResult {\r\n  try {\r\n    const w = canvas.width\r\n    const h = canvas.height\r\n    const centerX = w / 2\r\n    const centerY = h / 2\r\n\r\n    // Find dartboard rings\r\n    const detection = findDartboardRings(canvas)\r\n\r\n    if (!detection) {\r\n      return {\r\n        success: false,\r\n        cx: centerX,\r\n        cy: centerY,\r\n        bullInner: 0,\r\n        bullOuter: 0,\r\n        trebleInner: 0,\r\n        trebleOuter: 0,\r\n        doubleInner: 0,\r\n        doubleOuter: 0,\r\n        confidence: 0,\r\n        homography: null,\r\n        errorPx: null,\r\n        calibrationPoints: [],\r\n        message: 'No dartboard detected. Ensure board is clearly visible with good contrast between rings and background.',\r\n      }\r\n    }\r\n\r\n    // Scale all ring radii based on detected double radius\r\n    const scale = detection.r / BoardRadii.doubleOuter\r\n\r\n    const detected = {\r\n      cx: detection.cx,\r\n      cy: detection.cy,\r\n      bullInner: BoardRadii.bullInner * scale,\r\n      bullOuter: BoardRadii.bullOuter * scale,\r\n      trebleInner: BoardRadii.trebleInner * scale,\r\n      trebleOuter: BoardRadii.trebleOuter * scale,\r\n      doubleInner: BoardRadii.doubleInner * scale,\r\n      doubleOuter: detection.r,\r\n    }\r\n\r\n    // Generate 4 calibration points from detected rings (TOP, RIGHT, BOTTOM, LEFT of double)\r\n    const calibrationPoints: Point[] = [\r\n      { x: detected.cx, y: detected.cy - detected.doubleOuter },           // TOP\r\n      { x: detected.cx + detected.doubleOuter, y: detected.cy },           // RIGHT\r\n      { x: detected.cx, y: detected.cy + detected.doubleOuter },           // BOTTOM\r\n      { x: detected.cx - detected.doubleOuter, y: detected.cy },           // LEFT\r\n    ]\r\n\r\n    // Compute homography from these 4 points\r\n    const canonicalSrc = [\r\n      { x: 0, y: -BoardRadii.doubleOuter },\r\n      { x: BoardRadii.doubleOuter, y: 0 },\r\n      { x: 0, y: BoardRadii.doubleOuter },\r\n      { x: -BoardRadii.doubleOuter, y: 0 },\r\n    ]\r\n\r\n    let homography: Homography | null = null\r\n    let errorPx: number | null = null\r\n    let confidence = detection.confidence\r\n\r\n    try {\r\n      homography = computeHomographyDLT(canonicalSrc, calibrationPoints)\r\n      errorPx = rmsError(homography, canonicalSrc, calibrationPoints)\r\n      // Adjust confidence based on homography error\r\n      const errorConfidence = Math.max(10, Math.min(95, 100 - Math.max(0, errorPx - 1) * 10))\r\n      confidence = (confidence + errorConfidence) / 2\r\n    } catch (err) {\r\n      confidence = Math.max(40, confidence)\r\n    }\r\n\r\n    const pointsValid = calibrationPoints.every(isFinitePoint)\r\n    const homographyValid = isFiniteHomography(homography)\r\n    const success = !!homographyValid && pointsValid && confidence > 50\r\n\r\n    return {\r\n      success,\r\n      cx: detected.cx,\r\n      cy: detected.cy,\r\n      bullInner: detected.bullInner,\r\n      bullOuter: detected.bullOuter,\r\n      trebleInner: detected.trebleInner,\r\n      trebleOuter: detected.trebleOuter,\r\n      doubleInner: detected.doubleInner,\r\n      doubleOuter: detected.doubleOuter,\r\n      confidence,\r\n      homography: homographyValid ? homography : null,\r\n      errorPx: homographyValid ? errorPx : null,\r\n      calibrationPoints: pointsValid ? calibrationPoints : [],\r\n      message: !pointsValid || !homographyValid\r\n        ? ' Detection produced unstable calibration data. Adjust camera framing or calibrate manually.'\r\n        : confidence > 80\r\n          ? ' High confidence detection'\r\n          : confidence > 50\r\n            ? ' Detection found but could be better'\r\n            : ' Low confidence - try better lighting',\r\n    }\r\n  } catch (err) {\r\n    return {\r\n      success: false,\r\n      cx: canvas.width / 2,\r\n      cy: canvas.height / 2,\r\n      bullInner: 0,\r\n      bullOuter: 0,\r\n      trebleInner: 0,\r\n      trebleOuter: 0,\r\n      doubleInner: 0,\r\n      doubleOuter: 0,\r\n      confidence: 0,\r\n      homography: null,\r\n      errorPx: null,\r\n      calibrationPoints: [],\r\n      message: err instanceof Error ? err.message : 'Board detection failed',\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Refine detection by looking for concentric rings\r\n * This helps match detected circles to specific board rings\r\n */\r\nexport function refineRingDetection(detected: BoardDetectionResult): BoardDetectionResult {\r\n  // If detection already has good confidence, return as-is\r\n  if (detected.confidence > 70) return detected\r\n\r\n  // Otherwise try to improve by checking ring ratios\r\n  // If rings don't match expected ratios, we can flag for manual refinement\r\n  const expectedRatios = {\r\n    bullInner_to_bullOuter: BoardRadii.bullInner / BoardRadii.bullOuter,\r\n    bullOuter_to_trebleInner: BoardRadii.bullOuter / BoardRadii.trebleInner,\r\n    trebleOuter_to_doubleInner: BoardRadii.trebleOuter / BoardRadii.doubleInner,\r\n    doubleInner_to_doubleOuter: BoardRadii.doubleInner / BoardRadii.doubleOuter,\r\n  }\r\n\r\n  const actualRatios = {\r\n    bullInner_to_bullOuter: detected.bullInner / detected.bullOuter,\r\n    bullOuter_to_trebleInner: detected.bullOuter / detected.trebleInner,\r\n    trebleOuter_to_doubleInner: detected.trebleOuter / detected.doubleInner,\r\n    doubleInner_to_doubleOuter: detected.doubleInner / detected.doubleOuter,\r\n  }\r\n\r\n  // Check ratio errors\r\n  let ratioError = 0\r\n  let ratioCount = 0\r\n  for (const [key, expected] of Object.entries(expectedRatios)) {\r\n    const actual = actualRatios[key as keyof typeof actualRatios]\r\n    const error = Math.abs(actual - expected) / expected\r\n    ratioError += error\r\n    ratioCount++\r\n  }\r\n  const avgRatioError = ratioError / ratioCount\r\n\r\n  // Adjust confidence based on ratio error\r\n  const adjustedConfidence = Math.max(10, detected.confidence - avgRatioError * 100)\r\n\r\n  return {\r\n    ...detected,\r\n    confidence: adjustedConfidence,\r\n    message: adjustedConfidence > 70 ? ' High confidence detection' : adjustedConfidence > 50 ? ' Rings detected but ratios off - may need refinement' : ' Low confidence - try repositioning camera',\r\n  }\r\n}\r\n","import { create } from 'zustand'\r\n\r\ntype LastOffline = { mode: string; x01Start: number; firstTo: number; aiLevel: string }\r\n\r\ntype SettingsState = {\r\n  favoriteDouble: string\r\n  callerEnabled: boolean\r\n  callerVoice: string // voice name\r\n  callerVolume: number // 0..1\r\n  speakCheckoutOnly: boolean\r\n  avgMode: 'all-time' | '24h'\r\n  autoStartOffline: boolean\r\n  rememberLastOffline: boolean\r\n  lastOffline: LastOffline\r\n  reducedMotion: boolean\r\n  compactHeader: boolean\r\n  allowSpectate: boolean\r\n  // UI tuning\r\n  cameraScale: number // 0.5 .. 1.25\r\n  cameraAspect?: 'wide' | 'square'\r\n  cameraFitMode?: 'fit' | 'fill'\r\n  // External autoscore provider\r\n  autoscoreProvider?: 'built-in' | 'external-ws' | 'manual'\r\n  autoscoreWsUrl?: string\r\n  autoCommitMode?: 'wait-for-clear' | 'immediate'\r\n  calibrationGuide: boolean\r\n  // Devices & preferences\r\n  preferredCameraId?: string\r\n  preferredCameraLabel?: string\r\n  preferredCameraLocked?: boolean\r\n  // Camera control\r\n  cameraEnabled: boolean\r\n  hideCameraOverlay: boolean\r\n  ignorePreferredCameraSync: boolean\r\n  // UI variants\r\n  offlineLayout?: 'classic' | 'modern'\r\n  // Text size\r\n  textSize: 'small' | 'medium' | 'large'\r\n  // Box size\r\n  boxSize: 'small' | 'medium' | 'large'\r\n  // Match configuration\r\n  matchType?: 'singles' | 'doubles'\r\n  teamAName?: string\r\n  teamBName?: string\r\n  setFavoriteDouble: (d: string) => void\r\n  setCallerEnabled: (v: boolean) => void\r\n  setCallerVoice: (name: string) => void\r\n  setAvgMode: (mode: 'all-time' | '24h') => void\r\n  setCallerVolume: (v: number) => void\r\n  setSpeakCheckoutOnly: (v: boolean) => void\r\n  setAutoStartOffline: (v: boolean) => void\r\n  setRememberLastOffline: (v: boolean) => void\r\n  setLastOffline: (cfg: Partial<LastOffline>) => void\r\n  setReducedMotion: (v: boolean) => void\r\n  setCompactHeader: (v: boolean) => void\r\n  setAllowSpectate: (v: boolean) => void\r\n  setCameraScale: (n: number) => void\r\n  setCameraAspect: (a: 'wide' | 'square') => void\r\n  setCameraFitMode: (m: 'fit' | 'fill') => void\r\n  setCalibrationGuide: (v: boolean) => void\r\n  setPreferredCamera: (id: string|undefined, label?: string, force?: boolean) => void\r\n  setPreferredCameraLocked: (v: boolean) => void\r\n  setCameraEnabled: (v: boolean) => void\r\n  setIgnorePreferredCameraSync: (v: boolean) => void\r\n  setOfflineLayout: (mode: 'classic'|'modern') => void\r\n  setAutoscoreProvider: (p: 'built-in' | 'external-ws' | 'manual') => void\r\n  setAutoscoreWsUrl: (u: string) => void\r\n  setAutoCommitMode: (mode: 'wait-for-clear' | 'immediate') => void\r\n  setTextSize: (size: 'small' | 'medium' | 'large') => void\r\n  setBoxSize: (size: 'small' | 'medium' | 'large') => void\r\n  setMatchType: (t: 'singles' | 'doubles') => void\r\n  setTeamAName: (name: string) => void\r\n  setTeamBName: (name: string) => void\r\n  // Throw timer per dart\r\n  dartTimerEnabled?: boolean\r\n  dartTimerSeconds?: number\r\n  setDartTimerEnabled: (v: boolean) => void\r\n  setDartTimerSeconds: (n: number) => void\r\n  // X01 rules\r\n  x01DoubleIn?: boolean\r\n  setX01DoubleIn: (v: boolean) => void\r\n}\r\nconst KEY = 'ndn_user_settings'\r\n\r\nfunction load(): Pick<SettingsState, 'favoriteDouble' | 'callerEnabled' | 'callerVoice' | 'avgMode' | 'callerVolume' | 'speakCheckoutOnly' | 'autoStartOffline' | 'rememberLastOffline' | 'lastOffline' | 'reducedMotion' | 'compactHeader' | 'allowSpectate' | 'cameraScale' | 'cameraAspect' | 'cameraFitMode' | 'calibrationGuide' | 'preferredCameraId' | 'preferredCameraLabel' | 'preferredCameraLocked' | 'cameraEnabled' | 'hideCameraOverlay' | 'offlineLayout' | 'autoscoreProvider' | 'autoscoreWsUrl' | 'autoCommitMode' | 'textSize' | 'boxSize' | 'matchType' | 'teamAName' | 'teamBName' | 'dartTimerEnabled' | 'dartTimerSeconds' | 'x01DoubleIn'> {\r\n  try {\r\n    const raw = localStorage.getItem(KEY)\r\n  if (!raw) return { favoriteDouble: 'D16', callerEnabled: true, callerVoice: '', callerVolume: 1, speakCheckoutOnly: false, avgMode: 'all-time', autoStartOffline: false, rememberLastOffline: true, lastOffline: { mode: 'X01', x01Start: 501, firstTo: 1, aiLevel: 'None' }, reducedMotion: false, compactHeader: false, allowSpectate: true, cameraScale: 1.0, cameraAspect: 'wide', cameraFitMode: 'fit', calibrationGuide: true, preferredCameraId: undefined, preferredCameraLabel: undefined, cameraEnabled: true, hideCameraOverlay: false, offlineLayout: 'modern', autoscoreProvider: 'built-in', autoscoreWsUrl: '', autoCommitMode: 'wait-for-clear', textSize: 'medium', boxSize: 'medium', matchType: 'singles', teamAName: 'Team A', teamBName: 'Team B', dartTimerEnabled: false, dartTimerSeconds: 10, x01DoubleIn: false }\r\n    const j = JSON.parse(raw)\r\n    return {\r\n      favoriteDouble: j.favoriteDouble || 'D16',\r\n      callerEnabled: typeof j.callerEnabled === 'boolean' ? j.callerEnabled : true,\r\n      callerVoice: j.callerVoice || '',\r\n      callerVolume: (typeof j.callerVolume === 'number') ? Math.max(0, Math.min(1, j.callerVolume)) : 1,\r\n      speakCheckoutOnly: !!j.speakCheckoutOnly,\r\n      avgMode: j.avgMode === '24h' ? '24h' : 'all-time',\r\n      autoStartOffline: !!j.autoStartOffline,\r\n      rememberLastOffline: (typeof j.rememberLastOffline === 'boolean') ? j.rememberLastOffline : true,\r\n      lastOffline: j.lastOffline && typeof j.lastOffline === 'object' ? {\r\n        mode: j.lastOffline.mode || 'X01',\r\n        x01Start: Number(j.lastOffline.x01Start) || 501,\r\n        firstTo: Number(j.lastOffline.firstTo) || 1,\r\n        aiLevel: j.lastOffline.aiLevel || 'None'\r\n      } : { mode: 'X01', x01Start: 501, firstTo: 1, aiLevel: 'None' },\r\n      reducedMotion: !!j.reducedMotion,\r\n      compactHeader: !!j.compactHeader,\r\n      allowSpectate: (typeof j.allowSpectate === 'boolean') ? j.allowSpectate : true,\r\n      cameraScale: (typeof j.cameraScale === 'number' && isFinite(j.cameraScale)) ? Math.max(0.5, Math.min(1.25, j.cameraScale)) : 1.0,\r\n      cameraAspect: j.cameraAspect === 'square' ? 'square' : 'wide',\r\n      cameraFitMode: (j.cameraFitMode === 'fit' || j.cameraFitMode === 'fill') ? j.cameraFitMode : 'fit',\r\n      autoscoreProvider: (j.autoscoreProvider === 'external-ws') ? 'external-ws' : (j.autoscoreProvider === 'manual' ? 'manual' : 'built-in'),\r\n      autoscoreWsUrl: typeof j.autoscoreWsUrl === 'string' ? j.autoscoreWsUrl : '',\r\n      autoCommitMode: (j.autoCommitMode === 'immediate') ? 'immediate' : 'wait-for-clear',\r\n      calibrationGuide: (typeof j.calibrationGuide === 'boolean') ? j.calibrationGuide : true,\r\n      preferredCameraId: typeof j.preferredCameraId === 'string' ? j.preferredCameraId : undefined,\r\n      preferredCameraLabel: typeof j.preferredCameraLabel === 'string' ? j.preferredCameraLabel : undefined,\r\n      preferredCameraLocked: (typeof j.preferredCameraLocked === 'boolean') ? j.preferredCameraLocked : false,\r\n      cameraEnabled: (typeof j.cameraEnabled === 'boolean') ? j.cameraEnabled : true,\r\n      hideCameraOverlay: (typeof j.hideCameraOverlay === 'boolean') ? j.hideCameraOverlay : false,\r\n      offlineLayout: j.offlineLayout === 'classic' ? 'classic' : 'modern',\r\n      textSize: (j.textSize === 'small' || j.textSize === 'large') ? j.textSize : 'medium',\r\n      boxSize: (j.boxSize === 'small' || j.boxSize === 'large') ? j.boxSize : 'medium',\r\n      matchType: (j.matchType === 'doubles') ? 'doubles' : 'singles',\r\n      teamAName: typeof j.teamAName === 'string' ? j.teamAName : 'Team A',\r\n      teamBName: typeof j.teamBName === 'string' ? j.teamBName : 'Team B',\r\n      dartTimerEnabled: (typeof j.dartTimerEnabled === 'boolean') ? j.dartTimerEnabled : false,\r\n      dartTimerSeconds: (typeof j.dartTimerSeconds === 'number' && isFinite(j.dartTimerSeconds)) ? Math.max(3, Math.min(60, j.dartTimerSeconds)) : 10,\r\n      x01DoubleIn: (typeof j.x01DoubleIn === 'boolean') ? j.x01DoubleIn : false,\r\n    }\r\n  } catch {\r\n  return { favoriteDouble: 'D16', callerEnabled: true, callerVoice: '', callerVolume: 1, speakCheckoutOnly: false, avgMode: 'all-time', autoStartOffline: false, rememberLastOffline: true, lastOffline: { mode: 'X01', x01Start: 501, firstTo: 1, aiLevel: 'None' }, reducedMotion: false, compactHeader: false, allowSpectate: true, cameraScale: 1.0, cameraAspect: 'wide', cameraFitMode: 'fit', calibrationGuide: true, preferredCameraId: undefined, preferredCameraLabel: undefined, preferredCameraLocked: false, cameraEnabled: true, hideCameraOverlay: false, offlineLayout: 'modern', autoscoreProvider: 'built-in', autoscoreWsUrl: '', autoCommitMode: 'wait-for-clear', textSize: 'medium', boxSize: 'medium', matchType: 'singles', teamAName: 'Team A', teamBName: 'Team B', dartTimerEnabled: false, dartTimerSeconds: 10, x01DoubleIn: false }\r\n  }\r\n}\r\n\r\nfunction save(partial: Partial<SettingsState>) {\r\n  try {\r\n    const prev = load()\r\n    localStorage.setItem(KEY, JSON.stringify({ ...prev, ...partial }))\r\n  } catch {}\r\n}\r\n\r\nexport const useUserSettings = create<SettingsState>((set, get) => ({\r\n  ...load(),\r\n  setFavoriteDouble: (d) => { save({ favoriteDouble: d }); set({ favoriteDouble: d }) },\r\n  setCallerEnabled: (v) => { save({ callerEnabled: v }); set({ callerEnabled: v }) },\r\n  setCallerVoice: (name) => { save({ callerVoice: name }); set({ callerVoice: name }) },\r\n  setAvgMode: (mode) => { save({ avgMode: mode }); set({ avgMode: mode }) },\r\n  setCallerVolume: (v) => { const vol = Math.max(0, Math.min(1, v)); save({ callerVolume: vol }); set({ callerVolume: vol }) },\r\n  setSpeakCheckoutOnly: (v) => { save({ speakCheckoutOnly: v }); set({ speakCheckoutOnly: v }) },\r\n  setAutoStartOffline: (v) => { save({ autoStartOffline: v }); set({ autoStartOffline: v }) },\r\n  setRememberLastOffline: (v) => { save({ rememberLastOffline: v }); set({ rememberLastOffline: v }) },\r\n  setLastOffline: (cfg) => { const prev = load().lastOffline; const next = { ...prev, ...cfg }; save({ lastOffline: next }); set({ lastOffline: next }) },\r\n  setReducedMotion: (v) => { save({ reducedMotion: v }); set({ reducedMotion: v }) },\r\n  setCompactHeader: (v) => { save({ compactHeader: v }); set({ compactHeader: v }) },\r\n  setAllowSpectate: (v) => { save({ allowSpectate: v }); set({ allowSpectate: v }) },\r\n  // Temporarily suppress external camera-mode syncing (used while user is interacting with device picker)\r\n  ignorePreferredCameraSync: false,\r\n  setIgnorePreferredCameraSync: (v: boolean) => { save({} as any); set({ ignorePreferredCameraSync: v }) },\r\n  setCameraScale: (n) => { const s = Math.max(0.5, Math.min(1.25, n)); save({ cameraScale: s }); set({ cameraScale: s }) },\r\n  setCameraAspect: (a) => { const v = (a === 'square') ? 'square' : 'wide'; save({ cameraAspect: v }); set({ cameraAspect: v }) },\r\n  setCameraFitMode: (m) => { const v = (m === 'fit') ? 'fit' : 'fill'; save({ cameraFitMode: v }); set({ cameraFitMode: v }) },\r\n  setAutoscoreProvider: (p) => { save({ autoscoreProvider: p }); set({ autoscoreProvider: p }) },\r\n  setAutoscoreWsUrl: (u) => { save({ autoscoreWsUrl: u }); set({ autoscoreWsUrl: u }) },\r\n  setAutoCommitMode: (mode) => {\r\n    const v = mode === 'immediate' ? 'immediate' : 'wait-for-clear'\r\n    save({ autoCommitMode: v })\r\n    set({ autoCommitMode: v })\r\n  },\r\n  setCalibrationGuide: (v) => { save({ calibrationGuide: v }); set({ calibrationGuide: v }) },\r\n  setPreferredCamera: (id, label, force = false) => {\r\n    try {\r\n      const state = get()\r\n      console.log('[USERSETTINGS] setPreferredCamera called:', { id, label, force, locked: state.preferredCameraLocked })\r\n      if (state.preferredCameraLocked && !force) {\r\n        // Locked: ignore programmatic updates unless explicitly forced by user action\r\n        console.log('[USERSETTINGS] Camera selection locked and force=false, ignoring update')\r\n        return\r\n      }\r\n    } catch {}\r\n    console.log('[USERSETTINGS] Saving preferred camera:', { id, label })\r\n    save({ preferredCameraId: id, preferredCameraLabel: label });\r\n    set({ preferredCameraId: id, preferredCameraLabel: label })\r\n  },\r\n  setPreferredCameraLocked: (v) => { save({ preferredCameraLocked: v }); set({ preferredCameraLocked: v }) },\r\n  setCameraEnabled: (v) => { save({ cameraEnabled: v }); set({ cameraEnabled: v }) },\r\n  setHideCameraOverlay: (v) => { save({ hideCameraOverlay: v }); set({ hideCameraOverlay: v }) },\r\n  setOfflineLayout: (mode) => { save({ offlineLayout: mode }); set({ offlineLayout: mode }) },\r\n  setTextSize: (size) => { save({ textSize: size }); set({ textSize: size }) },\r\n  setBoxSize: (size) => { save({ boxSize: size }); set({ boxSize: size }) },\r\n  setMatchType: (t) => { const v = (t === 'doubles') ? 'doubles' : 'singles'; save({ matchType: v }); set({ matchType: v }) },\r\n  setTeamAName: (name) => { const v = name?.trim() || 'Team A'; save({ teamAName: v }); set({ teamAName: v }) },\r\n  setTeamBName: (name) => { const v = name?.trim() || 'Team B'; save({ teamBName: v }); set({ teamBName: v }) },\r\n  setDartTimerEnabled: (v) => { save({ dartTimerEnabled: v }); set({ dartTimerEnabled: v }) },\r\n  setDartTimerSeconds: (n) => { const s = Math.max(3, Math.min(60, Math.round(n))); save({ dartTimerSeconds: s }); set({ dartTimerSeconds: s }) },\r\n  setX01DoubleIn: (v) => { save({ x01DoubleIn: v }); set({ x01DoubleIn: v }) },\r\n}))\r\n","import React, { useCallback, useEffect, useMemo, useRef, useState, type ReactNode } from 'react'\r\nimport ReactDOM from 'react-dom'\r\nimport DartLoader from './DartLoader'\r\n\r\nimport { makeQrDataUrlWithLogo } from '../utils/qr'\r\nimport { useCalibration } from '../store/calibration'\r\nimport { useCameraSession } from '../store/cameraSession'\r\nimport { BoardRadii, canonicalRimTargets, computeHomographyDLT, drawCross, drawPolyline, rmsError, sampleRing, refinePointsSobel, applyHomography, imageToBoard, scoreAtBoardPoint, type Homography, type Point } from '../utils/vision'\r\nimport { detectMarkersFromCanvas, MARKER_ORDER, MARKER_TARGETS, markerIdToMatrix, type MarkerDetection } from '../utils/markerCalibration'\r\nimport { detectBoard, refineRingDetection, type BoardDetectionResult } from '../utils/boardDetection'\r\nimport { useUserSettings } from '../store/userSettings'\r\nimport { discoverNetworkDevices, connectToNetworkDevice, type NetworkDevice } from '../utils/networkDevices'\r\nimport { apiFetch } from '../utils/api'\r\n\r\ntype Phase = 'idle' | 'camera' | 'capture' | 'select' | 'computed'\r\ntype CamMode = 'local' | 'phone' | 'wifi'\r\n\r\n// Center-logo QR helpers moved to ../utils/qr\r\n\r\nexport default function Calibrator() {\r\n\tconst videoRef = useRef<HTMLVideoElement>(null)\r\n\tconst canvasRef = useRef<HTMLCanvasElement>(null)\r\n\tconst overlayRef = useRef<HTMLCanvasElement>(null)\r\n\tconst fileInputRef = useRef<HTMLInputElement>(null)\r\n\t// Camera diagnostics state\r\n\tconst [cameraPerm, setCameraPerm] = useState<'unknown' | 'granted' | 'denied' | 'prompt' | 'unsupported'>('unknown')\r\n\tconst [videoDevices, setVideoDevices] = useState<Array<{ deviceId: string; label: string }>>([])\r\n\tconst [selectedDeviceId, setSelectedDeviceId] = useState<string | null>(null)\r\n\tconst [streaming, setStreaming] = useState(false)\r\n\tconst [videoPlayBlocked, setVideoPlayBlocked] = useState(false)\r\n\tconst [phase, setPhase] = useState<Phase>('camera')\r\n\t// Default to local or last-used mode, but allow user to freely change\r\n\tconst [mode, setMode] = useState<CamMode>(() => (localStorage.getItem('ndn:cal:mode') as CamMode) || 'local')\r\n\tconst [dstPoints, setDstPoints] = useState<Point[]>([]) // image points clicked in order TOP, RIGHT, BOTTOM, LEFT, CENTER (bullseye), OUTER_BULL_TOP\r\n\tconst [snapshotSet, setSnapshotSet] = useState(false)\r\n\t// Track current frame (video/snapshot) size to preserve aspect ratio in the preview container\r\n\tconst [frameSize, setFrameSize] = useState<{ w: number, h: number } | null>(null)\r\n\t// Zoom for pixel-perfect point picking (0.5x  2.0x)\r\n\tconst [zoom, setZoom] = useState<number>(1)\r\n\tconst [mobileLandingOverride, setMobileLandingOverride] = useState<boolean>(() => {\r\n\t\tif (typeof window === 'undefined') return false\r\n\t\ttry {\r\n\t\t\treturn window.localStorage.getItem('ndn:cal:forceDesktop') === '1'\r\n\t\t} catch {\r\n\t\t\treturn false\r\n\t\t}\r\n\t})\r\n\tconst [isMobileDevice, setIsMobileDevice] = useState<boolean>(() => {\r\n\t\tif (typeof navigator === 'undefined') return false\r\n\t\treturn /Android|iPhone|iPad|iPod|Mobi/i.test(navigator.userAgent)\r\n\t})\r\n\tconst { H, setCalibration, reset, errorPx, locked } = useCalibration()\r\n\tconst cameraSession = useCameraSession()\r\n\tconst { calibrationGuide, setCalibrationGuide, preferredCameraId, cameraEnabled, setCameraEnabled, preferredCameraLocked, setPreferredCameraLocked, setPreferredCamera } = useUserSettings()\r\n\t\t// Detected ring data (from auto-detect) in image pixels\r\n\tconst [detected, setDetected] = useState<null | {\r\n\t\tcx: number; cy: number;\r\n\t\tbullInner: number; bullOuter: number;\r\n\t\ttrebleInner: number; trebleOuter: number;\r\n\t\tdoubleInner: number; doubleOuter: number;\r\n\t}>(null)\r\n\t\t// Live detection and confidence state\r\n\t\tconst [liveDetect, setLiveDetect] = useState<boolean>(false)\r\n\t\tconst [confidence, setConfidence] = useState<number>(0)\r\n\t\tconst [autoCalibrating, setAutoCalibrating] = useState<boolean>(false)\r\n\t\t\tconst [forceConfidence, setForceConfidence] = useState<boolean>(true) // Allow forcing 100% for registration reliability\r\n\tconst [markerResult, setMarkerResult] = useState<MarkerDetection | null>(null)\r\n\t// Verification results for UI: {label, expected, detected, match}\r\n\tconst [verificationResults, setVerificationResults] = useState<Array<{ label: string; expected: any; detected: any; match: boolean }>>([])\r\n\r\n\tconst createMarkerDataUrl = useCallback((id: number, size = 480) => {\r\n\t\tif (typeof document === 'undefined') throw new Error('Marker rendering only available in browser context')\r\n\t\tconst matrix = markerIdToMatrix(id)\r\n\t\tconst canvas = document.createElement('canvas')\r\n\t\tcanvas.width = size\r\n\t\tcanvas.height = size\r\n\t\tconst ctx = canvas.getContext('2d')\r\n\t\tif (!ctx) return ''\r\n\t\t// white background\r\n\t\tctx.fillStyle = '#ffffff'\r\n\t\tctx.fillRect(0, 0, size, size)\r\n\r\n\t\tconst rows = matrix.length\r\n\t\tconst cols = matrix[0]?.length || rows\r\n\t\tconst cellW = size / cols\r\n\t\tconst cellH = size / rows\r\n\r\n\t\tfor (let y = 0; y < rows; y++) {\r\n\t\t\tfor (let x = 0; x < cols; x++) {\r\n\t\t\t\tconst v = matrix[y][x]\r\n\t\t\t\tif (v) {\r\n\t\t\t\t\tctx.fillStyle = '#000000'\r\n\t\t\t\t\tctx.fillRect(Math.round(x * cellW), Math.round(y * cellH), Math.ceil(cellW), Math.ceil(cellH))\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\treturn canvas.toDataURL('image/png')\r\n\t}, [])\r\n\t\t// Pairing / phone-camera state (some of these were accidentally removed during edits)\r\n\t\tconst [pairCode, setPairCode] = useState<string | null>(null)\r\n\t\tconst pairCodeRef = useRef<string | null>(null)\r\n\t\tconst [ws, setWs] = useState<WebSocket | null>(null)\r\n\t\tconst pcRef = useRef<RTCPeerConnection | null>(null)\r\n\t\tconst pendingIceCandidatesRef = useRef<RTCIceCandidate[]>([])\r\n\t\tconst [expiresAt, setExpiresAt] = useState<number | null>(null)\r\n\t\tconst [now, setNow] = useState<number>(Date.now())\r\n\t\tconst [paired, setPaired] = useState<boolean>(false)\r\n\r\n\t\tfunction updatePairCode(code: string | null) {\r\n\t\t\ttry {\r\n\t\t\t\tsetPairCode(code)\r\n\t\t\t\tpairCodeRef.current = code\r\n\t\t\t} catch {}\r\n\t\t}\r\n\tconst [qrDataUrl, setQrDataUrl] = useState<string>('')\r\n\tconst [lanHost, setLanHost] = useState<string | null>(null)\r\n\tconst [httpsInfo, setHttpsInfo] = useState<{ https: boolean; port: number } | null>(null)\r\n\tconst [showTips, setShowTips] = useState<boolean>(true)\r\n\tconst [wifiDevices, setWifiDevices] = useState<NetworkDevice[]>([])\r\n\tconst [discoveringWifi, setDiscoveringWifi] = useState<boolean>(false)\r\n\tconst [copyFeedback, setCopyFeedback] = useState<'link' | 'code' | null>(null)\r\n\tconst copyTimeoutRef = useRef<number | null>(null)\r\n\t\r\n\t// Log streaming state changes for debugging\r\n\tuseEffect(() => {\r\n\t\tconsole.log('[Calibrator]  STREAMING STATE CHANGED:', { streaming, phase, videoRefExists: !!videoRef.current })\r\n\t}, [streaming, phase])\r\n\t\r\n\tuseEffect(() => {\r\n\t\tconst h = window.location.hostname\r\n\t\tif (h === 'localhost' || h === '127.0.0.1') {\r\n\t\t\tapiFetch(`/api/hosts`).then(r => r.json()).then(j => {\r\n\t\t\t\tconst ip = Array.isArray(j?.hosts) && j.hosts.find((x: string) => x)\r\n\t\t\t\tif (ip) setLanHost(ip)\r\n\t\t\t}).catch(()=>{})\r\n\t\t}\r\n\t\t// Try to detect if server exposes HTTPS info\r\n\t\tapiFetch(`/api/https-info`).then(r=>r.json()).then(j=>{\r\n\t\t\tif (j && typeof j.https === 'boolean') setHttpsInfo({ https: !!j.https, port: Number(j.port)||8788 })\r\n\t\t}).catch(()=>{})\r\n\t}, [])\r\n\r\n\t// Remove automatic phone pairing on mode change; only pair on explicit user action\r\n\tconst mobileUrl = useMemo(() => {\r\n\t\tconst code = pairCode || '____'\r\n\t\t// Prefer configured WS host (Render) when available to build the correct server origin\r\n\t\tconst envUrl = (import.meta as any).env?.VITE_WS_URL as string | undefined\r\n\t\tif (envUrl && envUrl.length > 0) {\r\n\t\t\ttry {\r\n\t\t\t\tconst u = new URL(envUrl)\r\n\t\t\t\tconst isSecure = u.protocol === 'wss:'\r\n\t\t\t\tconst origin = `${isSecure ? 'https' : 'http'}://${u.host}${u.pathname.endsWith('/ws') ? '' : u.pathname}`\r\n\t\t\t\tconst base = origin.replace(/\\/?ws$/i, '')\r\n\t\t\t\treturn `${base}/mobile-cam.html?code=${code}`\r\n\t\t\t} catch {}\r\n\t\t}\r\n\t\t// Local dev fallback using detected LAN or current host\r\n\t\tconst host = (lanHost || window.location.hostname)\r\n\t\tconst useHttps = !!httpsInfo?.https\r\n\t\tconst port = useHttps ? (httpsInfo?.port || 8788) : 8787\r\n\t\tconst proto = useHttps ? 'https' : 'http'\r\n\t\treturn `${proto}://${host}:${port}/mobile-cam.html?code=${code}`\r\n\t}, [pairCode, lanHost, httpsInfo])\r\n\r\n\tconst mobileLandingLink = useMemo(() => {\r\n\t\tif (!mobileUrl) return null\r\n\t\ttry {\r\n\t\t\tconst url = new URL(mobileUrl)\r\n\t\t\turl.searchParams.delete('code')\r\n\t\t\treturn url.toString().replace(/\\?$/, '')\r\n\t\t} catch {\r\n\t\t\tif (typeof window !== 'undefined') {\r\n\t\t\t\tconst origin = window.location.origin.replace(/\\/$/, '')\r\n\t\t\t\treturn `${origin}/mobile-cam.html`\r\n\t\t\t}\r\n\t\t\treturn '/mobile-cam.html'\r\n\t\t}\r\n\t}, [mobileUrl])\r\n\r\n\tuseEffect(() => { localStorage.setItem('ndn:cal:mode', mode) }, [mode])\r\n\r\n\tuseEffect(() => {\r\n\t\tif (typeof window === 'undefined') return\r\n\t\ttry {\r\n\t\t\tif (mobileLandingOverride) {\r\n\t\t\t\twindow.localStorage.setItem('ndn:cal:forceDesktop', '1')\r\n\t\t\t} else {\r\n\t\t\t\twindow.localStorage.removeItem('ndn:cal:forceDesktop')\r\n\t\t\t}\r\n\t\t} catch {}\r\n\t}, [mobileLandingOverride])\r\n\r\n\tuseEffect(() => {\r\n\t\tif (typeof window === 'undefined') return\r\n\t\tconst coarseQuery = window.matchMedia('(pointer: coarse)')\r\n\t\tconst detect = () => {\r\n\t\t\tconst uaMobile = typeof navigator !== 'undefined' && /Android|iPhone|iPad|iPod|Mobi/i.test(navigator.userAgent)\r\n\t\t\tconst coarse = typeof coarseQuery.matches === 'boolean' ? coarseQuery.matches : false\r\n\t\t\tconst narrow = window.innerWidth <= 820\r\n\t\t\tsetIsMobileDevice(uaMobile || coarse || narrow)\r\n\t\t}\r\n\t\tdetect()\r\n\t\ttry {\r\n\t\t\tif (typeof coarseQuery.addEventListener === 'function') coarseQuery.addEventListener('change', detect)\r\n\t\t\telse if (typeof coarseQuery.addListener === 'function') coarseQuery.addListener(detect)\r\n\t\t} catch {}\r\n\t\twindow.addEventListener('resize', detect)\r\n\t\treturn () => {\r\n\t\t\ttry {\r\n\t\t\t\tif (typeof coarseQuery.removeEventListener === 'function') coarseQuery.removeEventListener('change', detect)\r\n\t\t\t\telse if (typeof coarseQuery.removeListener === 'function') coarseQuery.removeListener(detect)\r\n\t\t\t} catch {}\r\n\t\t\twindow.removeEventListener('resize', detect)\r\n\t\t}\r\n\t}, [])\r\n\r\n\tuseEffect(() => {\r\n\t\tif (!pairCode) { setQrDataUrl(''); return }\r\n\t\t// Generate a crisp QR (H-level error correction) with centered logo and white mask\r\n\t\tconst logoPath = (import.meta as any).env?.VITE_QR_LOGO_URL || '/dart-thrower.svg'\r\n\t\tmakeQrDataUrlWithLogo(mobileUrl, {\r\n\t\t\twidth: 256,\r\n\t\t\tmargin: 2,\r\n\t\t\terrorCorrectionLevel: 'H',\r\n\t\t\tcolor: { dark: '#000000', light: '#ffffff' },\r\n\t\t\tlogo: { logoUrl: logoPath, logoScale: 0.2, mask: true, shape: 'circle' }\r\n\t\t}).then(setQrDataUrl).catch(() => setQrDataUrl(''))\r\n\t}, [mobileUrl, pairCode])\r\n\r\n\t// Detect camera permission status where supported\r\n\tuseEffect(() => {\r\n\t\tif (typeof navigator === 'undefined' || !(navigator as any).permissions) {\r\n\t\t\tsetCameraPerm('unsupported')\r\n\t\t\treturn\r\n\t\t}\r\n\t\tlet mounted = true\r\n\t\t;(async () => {\r\n\t\t\ttry {\r\n\t\t\t\tconst p = await (navigator as any).permissions.query({ name: 'camera' })\r\n\t\t\t\tif (!mounted) return\r\n\t\t\t\tsetCameraPerm(p.state || 'unknown')\r\n\t\t\t\tp.onchange = () => { if (mounted) setCameraPerm(p.state) }\r\n\t\t\t} catch (err) {\r\n\t\t\t\t// Some browsers don't support 'camera' permission query\r\n\t\t\t\tif (mounted) setCameraPerm('unknown')\r\n\t\t\t}\r\n\t\t})()\r\n\t\treturn () => { mounted = false }\r\n\t}, [])\r\n\r\n\tasync function refreshVideoDevices() {\r\n\t\tif (typeof navigator === 'undefined' || !navigator.mediaDevices || !navigator.mediaDevices.enumerateDevices) return\r\n\t\ttry {\r\n\t\t\tconst list = await navigator.mediaDevices.enumerateDevices()\r\n\t\t\tconst vids = list.filter(d => d.kind === 'videoinput').map(d => ({ deviceId: (d as any).deviceId, label: d.label || 'Camera' }))\r\n\t\t\tsetVideoDevices(vids)\r\n\t\t\tif (vids.length && !selectedDeviceId) setSelectedDeviceId(vids[0].deviceId)\r\n\t\t} catch (err) {\r\n\t\t\t// ignore\r\n\t\t}\r\n\t}\r\n\r\n\tasync function testCamera(deviceId?: string) {\r\n\t\tif (typeof navigator === 'undefined' || !navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {\r\n\t\t\talert('getUserMedia is not available in this browser')\r\n\t\t\treturn\r\n\t\t}\r\n\t\tconst constraints: any = { video: deviceId ? { deviceId: { exact: deviceId } } : { facingMode: 'environment' } }\r\n\t\tlet stream: MediaStream | null = null\r\n\t\ttry {\r\n\t\t\tstream = await navigator.mediaDevices.getUserMedia(constraints)\r\n\t\t\t// Immediately stop tracks to test access\r\n\t\t\tstream.getTracks().forEach(t => t.stop())\r\n\t\t\tsetCameraPerm('granted')\r\n\t\t\t// If a deviceId was provided, set it as the preferred camera so Start Camera will use it\r\n\t\t\ttry { if (deviceId && typeof setPreferredCamera === 'function') { setPreferredCamera(deviceId); } } catch {}\r\n\t\t\talert('Camera access granted  your webcam is available and set as preferred.')\r\n\t\t} catch (err: any) {\r\n\t\t\tconsole.error('[Calibrator] testCamera failed', err)\r\n\t\t\tif (err && (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError')) {\r\n\t\t\t\tsetCameraPerm('denied')\r\n\t\t\t\talert('Camera permission denied. Please allow camera access in your browser settings and try again.')\r\n\t\t\t} else if (err && (err.name === 'NotFoundError' || err.name === 'DevicesNotFoundError')) {\r\n\t\t\t\talert('No camera devices found. Ensure your USB webcam is connected and not in use by another app.')\r\n\t\t\t} else {\r\n\t\t\t\talert('Unable to access the camera: ' + (err?.message || err))\r\n\t\t\t}\r\n\t\t} finally {\r\n\t\t\tif (stream) stream.getTracks().forEach(t => t.stop())\r\n\t\t}\r\n\t}\r\n\r\n\tfunction openBrowserSiteSettings() {\r\n\t\tif (typeof window === 'undefined') return\r\n\t\tconst ua = navigator.userAgent || ''\r\n\t\tlet url: string | null = null\r\n\t\tif (/Edg\\//.test(ua) || /Chrome\\//.test(ua) || /Chromium\\//.test(ua)) {\r\n\t\t\t// Chromium-based browsers: open camera content settings\r\n\t\t\turl = 'chrome://settings/content/camera'\r\n\t\t} else if (/Firefox\\//.test(ua)) {\r\n\t\t\turl = 'about:preferences#privacy'\r\n\t\t} else if (/Safari\\//.test(ua) && !/Chrome\\//.test(ua)) {\r\n\t\t\t// Safari has no direct site settings page we can open; show instructions instead\r\n\t\t\turl = null\r\n\t\t}\r\n\t\tif (url) {\r\n\t\t\tconst w = window.open(url, '_blank')\r\n\t\t\tif (!w) {\r\n\t\t\t\talert('Unable to open browser settings automatically. Please open your browser settings and search for \"Camera\" permissions for this site.')\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\t// Fallback instructions\r\n\t\t\talert('Please open your browser settings and locate Site Settings  Camera (or Permissions) and allow camera access for this site. In Safari, use Preferences  Websites  Camera.')\r\n\t\t}\r\n\t}\r\n\r\n\tuseEffect(() => {\r\n\t\tif (!expiresAt) return\r\n\t\tconst t = setInterval(() => setNow(Date.now()), 1000)\r\n\t\treturn () => clearInterval(t)\r\n\t}, [expiresAt])\r\n\tconst ttl = useMemo(() => expiresAt ? Math.max(0, Math.ceil((expiresAt - now)/1000)) : null, [expiresAt, now])\r\n\tuseEffect(() => {\r\n\t\treturn () => {\r\n\t\t\tif (copyTimeoutRef.current) window.clearTimeout(copyTimeoutRef.current)\r\n\t\t}\r\n\t}, [])\r\n\r\n\tconst copyValue = useCallback(async (value: string | null | undefined, type: 'link' | 'code') => {\r\n\t\tif (!value) return\r\n\t\ttry {\r\n\t\t\tif (navigator.clipboard && navigator.clipboard.writeText) {\r\n\t\t\t\tawait navigator.clipboard.writeText(value)\r\n\t\t\t} else {\r\n\t\t\t\tconst textarea = document.createElement('textarea')\r\n\t\t\t\ttextarea.value = value\r\n\t\t\t\ttextarea.style.position = 'fixed'\r\n\t\t\t\ttextarea.style.opacity = '0'\r\n\t\t\t\tdocument.body.appendChild(textarea)\r\n\t\t\t\ttextarea.focus()\r\n\t\t\t\ttextarea.select()\r\n\t\t\t\tdocument.execCommand('copy')\r\n\t\t\t\tdocument.body.removeChild(textarea)\r\n\t\t\t}\r\n\t\t\tsetCopyFeedback(type)\r\n\t\t\tif (copyTimeoutRef.current) window.clearTimeout(copyTimeoutRef.current)\r\n\t\t\tcopyTimeoutRef.current = window.setTimeout(() => setCopyFeedback(null), 1500)\r\n\t\t} catch (err) {\r\n\t\t\tconsole.warn('[Calibrator] Copy failed:', err)\r\n\t\t\tsetCopyFeedback(null)\r\n\t\t}\r\n\t}, [])\r\n\t// Removed automatic regeneration of code when ttl expires. Only regenerate on explicit user action.\r\n\r\n\t// NOTE: Removed automatic permission request on load - it was blocking camera access\r\n\t// Let startCamera() handle the permission request when user clicks \"Enable camera\"\r\n\t// This prevents the camera from being held by the permission test\r\n\r\n\t\tuseEffect(() => {\r\n\t\treturn () => {\r\n\t\t\t// DON'T call stopCamera() on unmount - we want phone camera to persist!\r\n\t\t\t// Just clean up local refs\r\n\t\t\t// The camera stream stays alive so user can see it in Online/Offline/Tournaments\r\n\t\t}\r\n\t}, [])\t// Remove automatic camera restart on preferredCameraId change to prevent flicker\r\n\r\n\t// Listen for reconnect requests from PhoneCameraOverlay\r\n\tuseEffect(() => {\r\n\t\tconst handleReconnectRequest = (event: any) => {\r\n\t\t\tconsole.log('[Calibrator] Received reconnect request from PhoneCameraOverlay')\r\n\t\t\t// If we're in phone mode and already paired, restart the pairing\r\n\t\t\tif (mode === 'phone' && paired) {\r\n\t\t\t\tstopCamera(false)\r\n\t\t\t\t// Give a moment for cleanup, then restart pairing\r\n\t\t\t\tsetTimeout(() => {\r\n\t\t\t\t\tstartPhonePairing()\r\n\t\t\t\t}, 500)\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\twindow.addEventListener('ndn:phone-camera-reconnect', handleReconnectRequest as EventListener)\r\n\t\treturn () => {\r\n\t\t\twindow.removeEventListener('ndn:phone-camera-reconnect', handleReconnectRequest as EventListener)\r\n\t\t}\r\n\t}, [mode, paired])\r\n\r\n\t// Sync video element to camera session so other components can access it\r\n\t// CRITICAL: Run whenever streaming state changes to keep videoRef synced\r\n\tuseEffect(() => {\r\n\t\tconsole.log('[Calibrator]  STREAMING CHANGED:', { streaming, videoRefAvailable: !!videoRef.current })\r\n\t\tif (videoRef.current) {\r\n\t\t\tconsole.log('[Calibrator]  Syncing videoElementRef on streaming change')\r\n\t\t\tcameraSession.setVideoElementRef(videoRef.current)\r\n\t\t\t// Also capture media stream when available\r\n\t\t\tif (videoRef.current.srcObject instanceof MediaStream) {\r\n\t\t\t\tconsole.log('[Calibrator]  Setting mediaStream from video element')\r\n\t\t\t\tcameraSession.setMediaStream(videoRef.current.srcObject)\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\tconsole.warn('[Calibrator]  videoRef.current is null on streaming change!')\r\n\t\t}\r\n\t}, [streaming])\r\n\r\n\t// Also sync on mount to capture initial videoRef\r\n\tuseEffect(() => {\r\n\t\tconsole.log('[Calibrator]  MOUNT: Initial mount - syncing videoRef')\r\n\t\tconsole.log('[Calibrator] videoRef.current available:', !!videoRef.current)\r\n\t\tconsole.log('[Calibrator] videoRef.current type:', videoRef.current?.constructor?.name)\r\n\t\t\r\n\t\tif (videoRef.current) {\r\n\t\t\tconsole.log('[Calibrator]  Setting videoElementRef on mount')\r\n\t\t\tconsole.log('[Calibrator] Video element:', {\r\n\t\t\t\ttagName: videoRef.current.tagName,\r\n\t\t\t\tsrcObject: !!videoRef.current.srcObject,\r\n\t\t\t\tvideoWidth: videoRef.current.videoWidth,\r\n\t\t\t\tvideoHeight: videoRef.current.videoHeight,\r\n\t\t\t})\r\n\t\t\tcameraSession.setVideoElementRef(videoRef.current)\r\n\t\t\tconsole.log('[Calibrator]  videoElementRef set successfully')\r\n\t\t} else {\r\n\t\t\tconsole.error('[Calibrator]  CRITICAL: videoRef.current is NULL at mount!')\r\n\t\t}\r\n\t\t// Do NOT clear the videoElementRef on unmount; we want the stream to persist globally\r\n\t\treturn () => { /* keep global video element ref for overlay */ }\r\n\t}, [])\r\n\r\n\tfunction ensureWS() {\r\n\t\t// Return existing WebSocket if it's open or connecting\r\n\t\tif (ws && (ws.readyState === WebSocket.OPEN || ws.readyState === WebSocket.CONNECTING)) {\r\n\t\t\tconsole.log('[Calibrator] ensureWS: Reusing existing WebSocket (state:', ws.readyState, ')')\r\n\t\t\treturn ws\r\n\t\t}\r\n\t\t// Prefer configured WS endpoint; normalize to include '/ws'. Fallback to same-origin '/ws'.\r\n\t\t\tconst envUrl = (import.meta as any).env?.VITE_WS_URL as string | undefined\r\n\t\t\tconst normalizedEnv = envUrl && envUrl.length > 0\r\n\t\t\t\t? (envUrl.endsWith('/ws') ? envUrl : envUrl.replace(/\\/$/, '') + '/ws')\r\n\t\t\t\t: undefined\r\n\t\t\tconst proto = (window.location.protocol === 'https:' ? 'wss' : 'ws')\r\n\t\t\tconst sameOrigin = `${proto}://${window.location.host}/ws`\r\n\t\t\tconst host = window.location.hostname\r\n\t\t\t// Production safeguard: if we are not on the Render backend host and no env URL is set,\r\n\t\t\t// prefer the known Render service as a fallback instead of Netlify same-origin.\r\n\t\t\tconst renderWS = `wss://ninedartnation.onrender.com/ws`\r\n\t\t\tconst url = normalizedEnv || (host.endsWith('onrender.com') ? sameOrigin : renderWS)\r\n\t\t\tconsole.log('[Calibrator] ensureWS: Creating new WebSocket to:', url)\r\n\t\t\tlet socket: WebSocket = new WebSocket(url)\r\n\t\t\r\n\t\t// Set up handlers BEFORE storing the socket to avoid race conditions\r\n\t\tsocket.onerror = (error) => {\r\n\t\t\tconsole.error('[Calibrator] WebSocket connection error:', error)\r\n\t\t\talert('Failed to connect to camera pairing service. Please check your internet connection and try again.')\r\n\t\t}\r\n\t\tsocket.onclose = (event) => {\r\n\t\t\tconsole.log('[Calibrator] WebSocket closed:', event.code, event.reason)\r\n\t\t\tif (pcRef.current) {\r\n\t\t\t\ttry { pcRef.current.close() } catch {}\r\n\t\t\t\tpcRef.current = null\r\n\t\t\t}\r\n\t\t\tupdatePairCode(null)\r\n\t\t\tsetExpiresAt(null)\r\n\t\t\tsetPaired(false)\r\n\t\t\t// Only show alert if it wasn't a clean close\r\n\t\t\tif (event.code !== 1000) {\r\n\t\t\t\talert('Camera pairing connection lost. Please try pairing again.')\r\n\t\t\t\t// Also revert to local mode on disconnect so user can restart camera\r\n\t\t\t\tif (mode === 'phone') setMode('local')\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\t// Store socket BEFORE setting message handler to ensure it's available for message sending\r\n\t\tsetWs(socket)\r\n\t\treturn socket\r\n\t}\r\n\r\n\tasync function startPhonePairing() {\r\n\t\t// Do not reset paired/streaming/phase state here to keep UI static\r\n\t\t// Switch UI into phone pairing mode so the calibrator shows phone-specific hints\r\n\t\tsetMode('phone')\r\n\t\t// Stop any existing camera streams before switching to phone mode\r\n\t\t// This ensures clean transition and no resource conflicts\r\n\t\t// Use true for autoRevert since we're explicitly switching modes, but we already set mode above\r\n\t\tstopCamera(false)\r\n\t\t// Lock selection and ensure camera UI is enabled while pairing is active\r\n\t\tlockSelectionForPairing()\r\n\t\ttry { setCameraEnabled(true) } catch {}\r\n\t\tconst socket = ensureWS()\r\n\t\t// Send cam-create when socket is ready\r\n\t\tif (socket.readyState === WebSocket.OPEN) {\r\n\t\t\tconsole.log('[Calibrator] WebSocket open, sending cam-create')\r\n\t\t\tsocket.send(JSON.stringify({ type: 'cam-create' }))\r\n\t\t} else {\r\n\t\t\tconsole.log('[Calibrator] WebSocket connecting, will send cam-create on open')\r\n\t\t\tsocket.onopen = () => {\r\n\t\t\t\tconsole.log('[Calibrator] WebSocket now open, sending cam-create')\r\n\t\t\t\tsocket.send(JSON.stringify({ type: 'cam-create' }))\r\n\t\t\t}\r\n\t\t}\r\n\t\tsocket.onmessage = async (ev) => {\r\n\t\t\tconst data = JSON.parse(ev.data)\r\n\t\t\tif (data.type === 'cam-code') {\r\n\t\t\t\tupdatePairCode(data.code)\r\n\t\t\t\tif (data.expiresAt) setExpiresAt(data.expiresAt)\r\n\t\t\t} else if (data.type === 'cam-peer-joined') {\r\n\t\t\t\t// Ensure we have the latest pairing code even if messages arrive out of order\r\n\t\t\t\tif (!pairCodeRef.current && data.code) updatePairCode(data.code)\r\n\t\t\t\tsetPaired(true)\r\n\t\t\t\t// When a phone peer joins, proactively send current calibration (if locked)\r\n\t\t\t\tconst codeForSession = pairCodeRef.current || data.code || null\r\n\t\t\t\tif (codeForSession) pairCodeRef.current = codeForSession\r\n\t\t\t\ttry {\r\n\t\t\t\t\tif (locked && codeForSession) {\r\n\t\t\t\t\t\tconst imgSize = canvasRef.current ? { w: canvasRef.current.width, h: canvasRef.current.height } : null\r\n\t\t\t\t\t\tconst payload = { H, imageSize: imgSize, errorPx: (errorPx ?? null), createdAt: Date.now() }\r\n\t\t\t\t\t\tsocket.send(JSON.stringify({ type: 'cam-calibration', code: codeForSession, payload }))\r\n\t\t\t\t\t\tconsole.log('[Calibrator] Sent calibration to joined phone for code', codeForSession)\r\n\t\t\t\t\t}\r\n\t\t\t\t} catch (e) {\r\n\t\t\t\t\tconsole.warn('[Calibrator] Failed to send calibration on peer join', e)\r\n\t\t\t\t}\r\n\t\t\t\tconst peer = new RTCPeerConnection({ \r\n\t\t\t\t\ticeServers: [{ urls: 'stun:stun.l.google.com:19302' }],\r\n\t\t\t\t\ticeCandidatePoolSize: 10\r\n\t\t\t\t})\r\n\t\t\t\tpcRef.current = peer\r\n\t\t\t\t\r\n\t\t\t\t// Add connection state monitoring\r\n\t\t\t\tpeer.onconnectionstatechange = () => {\r\n\t\t\t\t\tconsole.log('WebRTC connection state:', peer.connectionState)\r\n\t\t\t\t\tif (peer.connectionState === 'failed' || peer.connectionState === 'disconnected') {\r\n\t\t\t\t\t\tconsole.error('WebRTC connection failed')\r\n\t\t\t\t\t\talert('Camera connection lost. Please try pairing again.')\r\n\t\t\t\t\t\tstopCamera(false)\r\n\t\t\t\t\t} else if (peer.connectionState === 'connected') {\r\n\t\t\t\t\t\tconsole.log('WebRTC connection established')\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\tpeer.onicecandidate = (e) => {\r\n\t\t\t\t\tif (e.candidate && codeForSession) {\r\n\t\t\t\t\t\tsocket.send(JSON.stringify({ type: 'cam-ice', code: codeForSession, payload: e.candidate }))\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\tpeer.ontrack = (ev) => {\r\n\t\t\t\tconsole.log('[Calibrator] WebRTC ontrack received:', ev.streams?.length, 'streams, track kind:', ev.track?.kind)\r\n\t\t\t\tif (videoRef.current) {\r\n\t\t\t\t\tconst inbound = ev.streams?.[0]\r\n\t\t\t\t\tif (inbound) {\r\n\t\t\t\t\t\tconsole.log('[Calibrator] Assigning video stream (tracks:', inbound.getTracks().length, ') to video element')\r\n\t\t\t\t\t\t// Ensure video element is visible\r\n\t\t\t\t\t\tsetSnapshotSet(false)\r\n\t\t\t\t\t\t// Use setTimeout to ensure DOM updates before assigning stream\r\n\t\t\t\t\t\tsetTimeout(() => {\r\n\t\t\t\t\t\t\tif (videoRef.current) {\r\n\t\t\t\t\t\t\t\t\t\tconsole.log('[Calibrator] Setting srcObject and attempting play')\r\n\t\t\t\t\t\t\t\t\t\t// Clean up any existing stream before assigning new one\r\n\t\t\t\t\t\t\t\t\t\tif (videoRef.current.srcObject) {\r\n\t\t\t\t\t\t\t\t\t\t\tconst existingTracks = (videoRef.current.srcObject as MediaStream).getTracks()\r\n\t\t\t\t\t\t\t\t\t\t\texistingTracks.forEach(t => t.stop())\r\n\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\tvideoRef.current.srcObject = inbound\r\n\t\t\t\t\t\t\t\t\t\tvideoRef.current.muted = true // Ensure muted for autoplay policy\r\n\t\t\t\t\t\t\t\t\t\tvideoRef.current.playsInline = true // Mobile/iOS support\r\n\t\t\t\t\t\t\t\t\t\tvideoRef.current.play().then(() => {\r\n\t\t\t\t\t\t\t\t\t\t\tconsole.log('[Calibrator] Video playback started successfully')\r\n\t\t\t\t\t\t\t\t\t\t\t// Mark that we're streaming from the phone and transition to capture\r\n\t\t\t\t\t\t\t\t\t\t\tsetStreaming(true)\r\n\t\t\t\t\t\t\t\t\t\t\tsetPhase('capture')\r\n\t\t\t\t\t\t\t\t\t\t\t// Update camera session so other components can see the stream\r\n\t\t\t\t\t\t\t\t\t\t\tcameraSession.setStreaming(true)\r\n\t\t\t\t\t\t\t\t\t\t\tcameraSession.setMode('phone')\r\n\t\t\t\t\t\t\t\t\t\t\tcameraSession.setMediaStream(inbound)\r\n\t\t\t\t\t\t\t\t\t\t\t// Set user settings to reflect that the active camera is the phone\r\n\t\t\t\t\t\t\t\t\t\t\ttry { setPreferredCamera(undefined, 'Phone Camera', true) } catch {}\r\n\t\t\t\t\t\t\t\t\t\t\t\tif (!preferredCameraLocked) {\r\n\t\t\t\t\t\t\t\t\t\t\t\t\ttry {\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tsetPreferredCameraLocked(true)\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t} catch {}\r\n\t\t\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\t\ttry { setCameraEnabled(true) } catch {}\r\n\t\t\t\t\t\t\t\t\t\t\t// If an overlay prompt was shown earlier, hide it now\r\n\t\t\t\t\t\t\t\t\t\t\tsetVideoPlayBlocked(false)\r\n\t\t\t\t\t\t\t\t\t\t}).catch((err) => {\r\n\t\t\t\t\t\t\t\t\t\t\tconsole.error('[Calibrator] Video play failed:', err)\r\n\t\t\t\t\t\t\t\t\t\t\t// Show a friendly tap-to-play overlay so user can enable playback\r\n\t\t\t\t\t\t\t\t\t\t\tsetVideoPlayBlocked(true)\r\n\t\t\t\t\t\t\t\t\t\t\tconsole.warn('[Calibrator] video play blocked  prompting user interaction')\r\n\t\t\t\t\t\t\t\t\t\t})\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}, 100)\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tconsole.error('[Calibrator] No inbound stream received in ontrack')\r\n\t\t\t\t\t}\r\n\t\t\t\t} else {\r\n\t\t\t\t\tconsole.error('[Calibrator] Video element not available')\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\ttry {\r\n\t\t\t\tconst offer = await peer.createOffer({ offerToReceiveAudio: false, offerToReceiveVideo: true })\r\n\t\t\t\t\tawait peer.setLocalDescription(offer)\r\n\t\t\t\t\tconsole.log('[Calibrator] Sending cam-offer for code:', codeForSession)\r\n\t\t\t\t\tif (codeForSession) socket.send(JSON.stringify({ type: 'cam-offer', code: codeForSession, payload: offer }))\r\n\t\t\t\t\telse console.warn('[Calibrator] Missing pairing code when sending offer')\r\n\t\t\t} catch (err) {\r\n\t\t\t\t\tconsole.error('Failed to create WebRTC offer:', err)\r\n\t\t\t\t\talert('Failed to establish camera connection. Please try again.')\r\n\t\t\t\t\tstopCamera(false)\r\n\t\t\t\t}\r\n\t\t\t} else if (data.type === 'cam-answer') {\r\n\t\t\t\tconsole.log('[Calibrator] Received cam-answer')\r\n\t\t\t\tconst peer = pcRef.current\r\n\t\t\t\tif (peer) {\r\n\t\t\t\t\ttry {\r\n\t\t\t\t\t\tawait peer.setRemoteDescription(new RTCSessionDescription(data.payload))\r\n\t\t\t\t\t\tconsole.log('[Calibrator] Remote description set (answer)')\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t// Process any pending ICE candidates that arrived before the answer\r\n\t\t\t\t\t\tconst pending = pendingIceCandidatesRef.current\r\n\t\t\t\t\t\tconsole.log(`[Calibrator] Processing ${pending.length} pending ICE candidates`)\r\n\t\t\t\t\t\tfor (const candidate of pending) {\r\n\t\t\t\t\t\t\ttry {\r\n\t\t\t\t\t\t\t\tawait peer.addIceCandidate(candidate)\r\n\t\t\t\t\t\t\t\tconsole.log('[Calibrator] Queued ICE candidate added')\r\n\t\t\t\t\t\t\t} catch (err) {\r\n\t\t\t\t\t\t\t\tconsole.error('Failed to add queued ICE candidate:', err)\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tpendingIceCandidatesRef.current = []\r\n\t\t\t\t\t} catch (err) {\r\n\t\t\t\t\t\tconsole.error('Failed to set remote description:', err)\r\n\t\t\t\t\t\talert('Camera pairing failed. Please try again.')\r\n\t\t\t\t\t\tstopCamera(false)\r\n\t\t\t\t\t}\r\n\t\t\t\t} else {\r\n\t\t\t\t\tconsole.warn('[Calibrator] Received cam-answer but no peer connection exists')\r\n\t\t\t\t}\r\n\t\t\t} else if (data.type === 'cam-ice') {\r\n\t\t\t\tconsole.log('[Calibrator] Received cam-ice')\r\n\t\t\t\tconst peer = pcRef.current\r\n\t\t\t\tif (peer) {\r\n\t\t\t\t\t// Only add ICE candidate if remote description is already set\r\n\t\t\t\t\t// Otherwise, queue it for later processing\r\n\t\t\t\t\tif (peer.remoteDescription) {\r\n\t\t\t\t\t\ttry {\r\n\t\t\t\t\t\t\tawait peer.addIceCandidate(data.payload)\r\n\t\t\t\t\t\t\tconsole.log('[Calibrator] ICE candidate added')\r\n\t\t\t\t\t\t} catch (err) {\r\n\t\t\t\t\t\t\tconsole.error('Failed to add ICE candidate:', err)\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tconsole.log('[Calibrator] Remote description not set yet, queuing ICE candidate')\r\n\t\t\t\t\t\tpendingIceCandidatesRef.current.push(data.payload)\r\n\t\t\t\t\t}\r\n\t\t\t\t} else {\r\n\t\t\t\t\tconsole.warn('[Calibrator] Received ICE candidate but no peer connection exists')\r\n\t\t\t\t}\r\n\t\t\t} else if (data.type === 'cam-error') {\r\n\t\t\t\tconsole.error('Camera pairing error:', data.code)\r\n\t\t\t\talert(data.code === 'EXPIRED' ? 'Code expired. Generate a new code.' : `Camera error: ${data.code || 'Unknown error'}`)\r\n\t\t\t\tstopCamera(false)\r\n\t\t\t} else if (data.type === 'cam-calibration') {\r\n\t\t\t\t// Desktop receives calibration from phone (via server) or phone receives from desktop\r\n\t\t\t\tconsole.log('[Calibrator] Received calibration from peer:', data.payload)\r\n\t\t\t\ttry {\r\n\t\t\t\t\tif (data.payload && data.payload.H && Array.isArray(data.payload.H)) {\r\n\t\t\t\t\t\t// Apply the received calibration\r\n\t\t\t\t\t\tsetCalibration({\r\n\t\t\t\t\t\t\tH: data.payload.H as Homography,\r\n\t\t\t\t\t\t\tcreatedAt: data.payload.createdAt || Date.now(),\r\n\t\t\t\t\t\t\terrorPx: data.payload.errorPx,\r\n\t\t\t\t\t\t\timageSize: data.payload.imageSize,\r\n\t\t\t\t\t\t\tlocked: true // Assume locked since peer sent it\r\n\t\t\t\t\t\t})\r\n\t\t\t\t\t\tconsole.log('[Calibrator] Applied received calibration')\r\n\t\t\t\t\t}\r\n\t\t\t\t} catch (e) {\r\n\t\t\t\t\tconsole.error('[Calibrator] Failed to apply received calibration', e)\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tasync function startWifiConnection() {\r\n\t\tsetDiscoveringWifi(true)\r\n\t\ttry {\r\n\t\t\tconst devices = await discoverNetworkDevices()\r\n\t\t\tsetWifiDevices(devices)\r\n\t\t\tif (devices.length === 0) {\r\n\t\t\t\talert('No wifi scoring devices found on your network. Make sure devices are powered on and connected to the same network.')\r\n\t\t\t}\r\n\t\t} catch (error) {\r\n\t\t\tconsole.error('Wifi device discovery failed:', error)\r\n\t\t\talert('Failed to discover wifi devices. Please check your network connection.')\r\n\t\t} finally {\r\n\t\t\tsetDiscoveringWifi(false)\r\n\t\t}\r\n\t\tsetPhase('camera')\r\n\t}\r\n\r\n\tasync function connectToWifiDevice(device: NetworkDevice) {\r\n\t\ttry {\r\n\t\t\tsetWifiDevices(devices => devices.map(d => \r\n\t\t\t\td.id === device.id ? { ...d, status: 'connecting' as const } : d\r\n\t\t\t))\r\n\r\n\t\t\tconst stream = await connectToNetworkDevice(device)\r\n\t\t\tif (stream && videoRef.current) {\r\n\t\t\t\t// Clean up any existing stream before assigning new one\r\n\t\t\t\tif (videoRef.current.srcObject) {\r\n\t\t\t\t\tconst existingTracks = (videoRef.current.srcObject as MediaStream).getTracks()\r\n\t\t\t\t\texistingTracks.forEach(t => t.stop())\r\n\t\t\t\t}\r\n\t\t\t\tvideoRef.current.srcObject = stream\r\n\t\t\t\tawait videoRef.current.play()\r\n\t\t\t\tsetStreaming(true)\r\n\t\t\t\tsetPhase('capture')\r\n\t\t\t\tsetWifiDevices(devices => devices.map(d => \r\n\t\t\t\t\td.id === device.id ? { ...d, status: 'online' as const } : d\r\n\t\t\t\t))\r\n\t\t\t} else {\r\n\t\t\t\tthrow new Error('Failed to get video stream')\r\n\t\t\t}\r\n\t\t} catch (error) {\r\n\t\t\tconsole.error('Failed to connect to wifi device:', error)\r\n\t\t\talert(`Failed to connect to ${device.name}. Please check the device and try again.`)\r\n\t\t\tsetWifiDevices(devices => devices.map(d => \r\n\t\t\t\td.id === device.id ? { ...d, status: 'offline' as const } : d\r\n\t\t\t))\r\n\t\t}\r\n\t}\r\n\r\n\tasync function startCamera() {\r\n\t\tif (mode === 'phone') return startPhonePairing()\r\n\t\tif (mode === 'wifi') return startWifiConnection()\r\n\t\tconsole.log('[Calibrator]  START_CAMERA: mode=', mode, 'preferredCameraId=', preferredCameraId)\r\n\t\ttry {\r\n\t\t\tlet stream: MediaStream | null = null\r\n\t\t\t\r\n\t\t\t// Step 1: Try with preferred camera ID if available\r\n\t\t\tif (preferredCameraId) {\r\n\t\t\t\ttry {\r\n\t\t\t\t\tconsole.log('[Calibrator]  Attempt 1: Using preferred camera ID:', preferredCameraId)\r\n\t\t\t\t\tstream = await navigator.mediaDevices.getUserMedia({\r\n\t\t\t\t\t\tvideo: { deviceId: { exact: preferredCameraId } },\r\n\t\t\t\t\t\taudio: false\r\n\t\t\t\t\t})\r\n\t\t\t\t\tconsole.log('[Calibrator]  SUCCESS with preferred camera:', stream.getTracks().length, 'tracks')\r\n\t\t\t\t} catch (err: any) {\r\n\t\t\t\t\tconsole.warn('[Calibrator]  Preferred camera failed:', err?.name, err?.message)\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\t// Step 2: If preferred didn't work, try any camera\r\n\t\t\tif (!stream) {\r\n\t\t\t\ttry {\r\n\t\t\t\t\tconsole.log('[Calibrator]  Attempt 2: Using ANY available camera')\r\n\t\t\t\t\tstream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false })\r\n\t\t\t\t\tconsole.log('[Calibrator]  SUCCESS with fallback camera:', stream.getTracks().length, 'tracks')\r\n\t\t\t\t} catch (err: any) {\r\n\t\t\t\t\tconsole.error('[Calibrator]  BOTH attempts failed:', err?.name, err?.message)\r\n\t\t\t\t\tthrow err\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\t// Step 3: Assign to video element\r\n\t\t\tif (!stream) {\r\n\t\t\t\tthrow new Error('No stream obtained')\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tif (!videoRef.current) {\r\n\t\t\t\tthrow new Error('Video element ref is null')\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tconsole.log('[Calibrator]  Assigning stream to video element')\r\n\t\t\tvideoRef.current.srcObject = stream\r\n\t\t\t\r\n\t\t\tconsole.log('[Calibrator]  Calling play()')\r\n\t\t\ttry {\r\n\t\t\t\tawait videoRef.current.play()\r\n\t\t\t\tconsole.log('[Calibrator]  Play succeeded')\r\n\t\t\t} catch (playErr: any) {\r\n\t\t\t\tconsole.warn('[Calibrator]  Play failed, retrying in 100ms:', playErr?.message)\r\n\t\t\t\tawait new Promise(r => setTimeout(r, 100))\r\n\t\t\t\tawait videoRef.current.play()\r\n\t\t\t\tconsole.log('[Calibrator]  Play succeeded on retry')\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tconsole.log('[Calibrator]  Setting streaming = true')\r\n\t\t\tsetStreaming(true)\r\n\t\t\tsetPhase('capture')\r\n\t\t\tconsole.log('[Calibrator]  State updated')\r\n\t\t} catch (e: any) {\r\n\t\t\tconsole.error('[Calibrator]  FATAL:', e?.message || e)\r\n\t\t\talert(`Camera failed: ${e?.message || 'Unknown error'}`)\r\n\t\t\t// Clean up any partial stream\r\n\t\t\tif (videoRef.current?.srcObject) {\r\n\t\t\t\t(videoRef.current.srcObject as MediaStream).getTracks().forEach(t => t.stop())\r\n\t\t\t\tvideoRef.current.srcObject = null\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tfunction stopCamera(autoRevert: boolean = false) {\r\n\t\tif (videoRef.current && videoRef.current.srcObject) {\r\n\t\t\tconst tracks = (videoRef.current.srcObject as MediaStream).getTracks()\r\n\t\t\ttracks.forEach(t => t.stop())\r\n\t\t\tvideoRef.current.srcObject = null\r\n\t\t\tsetStreaming(false)\r\n\t\t}\r\n\t\tif (pcRef.current) { try { pcRef.current.close() } catch {}; pcRef.current = null }\r\n\t\tpendingIceCandidatesRef.current = []\r\n\t\tupdatePairCode(null)\r\n\t\tsetExpiresAt(null)\r\n\t\tsetPaired(false)\r\n\t\tsetMarkerResult(null)\r\n\t\t// Clear camera session when stopping camera\r\n\t\tcameraSession.setStreaming(false)\r\n\t\tcameraSession.setMediaStream(null)\r\n\t    // Only revert to local mode if EXPLICITLY requested (user clicked Stop button)\r\n\t    // Otherwise preserve the selected mode so user can go to OfflinePlay and come back\r\n\t    if (autoRevert && (mode === 'phone' || mode === 'wifi')) {\r\n\t    \tsetMode('local')\r\n\t    }\r\n\t}\r\n\r\n\tfunction regenerateCode() {\r\n\t\t// Only regenerate code, do not reset UI or camera state\r\n\t\tif (ws && ws.readyState === WebSocket.OPEN) {\r\n\t\t\tws.send(JSON.stringify({ type: 'cam-create' }))\r\n\t\t} else {\r\n\t\t\tstartPhonePairing()\r\n\t\t}\r\n\t\t// Lock the preferred camera selection while pairing is active so it doesn't\r\n\t\t// flip automatically during the pairing flow.\r\n\t\tlockSelectionForPairing()\r\n\t}\r\n\r\n\t// When user regenerates a pairing code we lock the preferred camera selection so\r\n\t// it won't be changed accidentally by other parts of the UI while pairing is active.\r\n\t// This implements the user's request that the camera selection 'stay static' after\r\n\t// generating a code. The lock can be toggled by the user in the DevicePicker UI.\r\n\tfunction lockSelectionForPairing() {\r\n\t\ttry {\r\n\t\t\tif (!preferredCameraLocked) {\r\n\t\t\t\tsetPreferredCameraLocked(true)\r\n\t\t\t}\r\n\t\t} catch {}\r\n\t}\r\n\r\n\t// Allow uploading a photo instead of using a live camera\r\n\tfunction triggerUpload() {\r\n\t\ttry { fileInputRef.current?.click() } catch {}\r\n\t}\r\n\r\n\tfunction openMarkerSheet() {\r\n\t\t// Open the marker sheet page in a new tab for printing\r\n\t\tconst markerSheetUrl = `${window.location.origin}/marker-sheet.html`\r\n\t\twindow.open(markerSheetUrl, '_blank')\r\n\t}\r\n\r\n\tfunction onUploadPhotoChange(e: React.ChangeEvent<HTMLInputElement>) {\r\n\t\tconst f = e.target.files?.[0]\r\n\t\tif (!f) return\r\n\t\tconst img = new Image()\r\n\t\timg.onload = () => {\r\n\t\t\ttry {\r\n\t\t\t\tif (!canvasRef.current) return\r\n\t\t\t\tconst c = canvasRef.current\r\n\t\t\t\tc.width = img.naturalWidth\r\n\t\t\t\tc.height = img.naturalHeight\r\n\t\t\t\tconst ctx = c.getContext('2d')!\r\n\t\t\t\tctx.drawImage(img, 0, 0, c.width, c.height)\r\n\t\t\t\tsetSnapshotSet(true)\r\n\t\t\t\tsetFrameSize({ w: c.width, h: c.height })\r\n\t\t\t\tsetPhase('select')\r\n\t\t\t\tsetDstPoints([])\r\n\t\t\t\tsetMarkerResult(null)\r\n\t\t\t\t// Clear any previous video stream\r\n\t\t\t\tstopCamera(false)\r\n\t\t\t} catch {}\r\n\t\t}\r\n\t\timg.onerror = () => { alert('Could not load image. Please try a different photo.') }\r\n\t\timg.src = URL.createObjectURL(f)\r\n\t\t// reset input value so the same file can be reselected\r\n\t\ttry { e.target.value = '' } catch {}\r\n\t}\r\n\r\n\t\tfunction captureFrame() {\r\n\t\tif (!videoRef.current || !canvasRef.current) return\r\n\t\tconst v = videoRef.current\r\n\t\tconst c = canvasRef.current\r\n\t\tc.width = v.videoWidth\r\n\t\tc.height = v.videoHeight\r\n\t\tconst ctx = c.getContext('2d')!\r\n\t\tctx.drawImage(v, 0, 0, c.width, c.height)\r\n\t\tsetSnapshotSet(true)\r\n\t\tsetFrameSize({ w: c.width, h: c.height })\r\n\t\tsetPhase('select')\r\n\t\tsetDstPoints([])\r\n\t\tsetMarkerResult(null)\r\n\t\t\t// If liveDetect is on, kick a detect on this captured frame\r\n\t\t\tif (liveDetect) setTimeout(() => { autoDetectRings() }, 0)\r\n\t}\r\n\r\n\tfunction drawOverlay(currentPoints = dstPoints, HH: Homography | null = null) {\r\n\t\tif (!canvasRef.current || !overlayRef.current) return\r\n\t\tconst img = canvasRef.current\r\n\t\tconst o = overlayRef.current\r\n\t\to.width = img.width; o.height = img.height\r\n\t\tconst ctx = o.getContext('2d')!\r\n\t\tctx.clearRect(0, 0, o.width, o.height)\r\n\r\n\t\t// If we have a homography, draw rings (precise, perspective-correct)\r\n\t\tconst Huse = HH || H\r\n\t\tif (Huse) {\r\n\t\t\t\t\tconst rings = [BoardRadii.bullInner, BoardRadii.bullOuter, BoardRadii.trebleInner, BoardRadii.trebleOuter, BoardRadii.doubleInner, BoardRadii.doubleOuter]\r\n\t\t\t\t\tfor (const r of rings) {\r\n\t\t\t\t\t\tif (!Number.isFinite(r)) continue\r\n\t\t\t\t\t\t// Use green for all rings when calibration is locked/perfect\r\n\t\t\t\t\t\tconst ringColor = locked ? '#10b981' : (r === BoardRadii.doubleOuter ? '#22d3ee' : '#a78bfa')\r\n\t\t\t\t\t\tconst ringWidth = locked ? 3 : (r === BoardRadii.doubleOuter ? 3 : 2)\r\n\t\t\t\t\t\ttry {\r\n\t\t\t\t\t\t\tconst poly = sampleRing(Huse, r, 360)\r\n\t\t\t\t\t\t\tif (!poly.length || poly.some(p => !Number.isFinite(p.x) || !Number.isFinite(p.y))) continue\r\n\t\t\t\t\t\t\tdrawPolyline(ctx, poly, ringColor, ringWidth)\r\n\t\t\t\t\t\t} catch (err) {\r\n\t\t\t\t\t\t\tconsole.warn('[Calibrator] Skipped invalid ring overlay', { radius: r, err })\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t}\r\n\t\t// Otherwise, if we have detected circles, draw them as previews (circles in image space)\r\n\t\tif (!Huse && detected) {\r\n\t\t\tconst drawCircle = (r: number, color: string, w = 2) => {\r\n\t\t\t\t\t\tif (!Number.isFinite(r) || r <= 0) return\r\n\t\t\t\tctx.save(); ctx.strokeStyle = color; ctx.lineWidth = w\r\n\t\t\t\tctx.beginPath(); ctx.arc(detected.cx, detected.cy, r, 0, Math.PI * 2); ctx.stroke(); ctx.restore()\r\n\t\t\t}\r\n\t\t\tdrawCircle(detected.doubleOuter, '#22d3ee', 3)\r\n\t\t\tdrawCircle(detected.doubleInner, '#22d3ee', 2)\r\n\t\t\tdrawCircle(detected.trebleOuter, '#fde047', 2)\r\n\t\t\tdrawCircle(detected.trebleInner, '#fde047', 2)\r\n\t\t\tdrawCircle(detected.bullOuter, '#34d399', 2)\r\n\t\t\tdrawCircle(detected.bullInner, '#10b981', 3)\r\n\t\t}\r\n\r\n\t\t// Show calibration guide circles when < 6 points and homography exists\r\n\t\tif (currentPoints.length < 6 && Huse) {\r\n\t\t\tctx.save()\r\n\t\t\tctx.strokeStyle = 'rgba(255,193,7,0.4)'\r\n\t\t\tctx.lineWidth = 2\r\n\t\t\tctx.setLineDash([4,4])\r\n\t\t\t// Show the 6 expected click positions\r\n\t\t\tconst targets = canonicalRimTargets()\r\n\t\t\tfor (let i = currentPoints.length; i < 6 && i < targets.length; i++) {\r\n\t\t\t\ttry {\r\n\t\t\t\t\tconst p = applyHomography(Huse, targets[i])\r\n\t\t\t\t\tctx.beginPath()\r\n\t\t\t\t\tctx.arc(p.x, p.y, 12, 0, Math.PI * 2)\r\n\t\t\t\t\tctx.stroke()\r\n\t\t\t\t} catch {}\r\n\t\t\t}\r\n\t\t\tctx.restore()\r\n\t\t}\r\n\r\n\t\t// Draw clicked points (with order labels to guide TOP, RIGHT, BOTTOM, LEFT, CENTER, BULL_TOP)\r\n\t\tcurrentPoints.forEach((p, i) => {\r\n\t\t\tdrawCross(ctx, p, '#f472b6')\r\n\t\t\tctx.save()\r\n\t\t\tctx.fillStyle = '#f472b6'\r\n\t\t\tctx.font = '14px sans-serif'\r\n\t\t\tctx.fillText(String(i + 1), p.x + 6, p.y - 6)\r\n\t\t\tctx.restore()\r\n\t\t})\r\n\r\n\t\t// Preferred-view framing guide (if enabled and not yet calibrated)\r\n\t\tif (calibrationGuide && !locked) {\r\n\t\t\tctx.save()\r\n\t\t\t// Semi-transparent vignette to encourage centered, face-on framing\r\n\t\t\tctx.fillStyle = 'rgba(59,130,246,0.10)'\r\n\t\t\tconst pad = Math.round(Math.min(o.width, o.height) * 0.08)\r\n\t\t\tconst w = o.width - pad*2\r\n\t\t\tconst h = o.height - pad*2\r\n\t\t\tctx.fillRect(pad, pad, w, h)\r\n\t\t\t// Horizon/tilt line and vertical center line\r\n\t\t\tctx.strokeStyle = 'rgba(34,197,94,0.9)'\r\n\t\t\tctx.lineWidth = 2\r\n\t\t\t// Horizontal line roughly through bull height\r\n\t\t\tctx.beginPath(); ctx.moveTo(pad, o.height/2); ctx.lineTo(o.width-pad, o.height/2); ctx.stroke()\r\n\t\t\t// Vertical center\r\n\t\t\tctx.beginPath(); ctx.moveTo(o.width/2, pad); ctx.lineTo(o.width/2, o.height-pad); ctx.stroke()\r\n\t\t\t// Angle brackets to suggest slight top-down 1015\r\n\t\t\tctx.strokeStyle = 'rgba(234,179,8,0.9)'\r\n\t\t\tctx.setLineDash([6,4])\r\n\t\t\tconst ax = pad + 30, ay = pad + 30\r\n\t\t\tctx.beginPath(); ctx.moveTo(ax, ay+30); ctx.lineTo(ax+60, ay); ctx.stroke()\r\n\t\t\tctx.beginPath(); ctx.moveTo(o.width-ax, ay+30); ctx.lineTo(o.width-ax-60, ay); ctx.stroke()\r\n\t\t\tctx.restore()\r\n\t\t\t// Legend - draw at fixed size regardless of zoom\r\n\t\t\tctx.save()\r\n\t\t\tctx.scale(1/zoom, 1/zoom) // Inverse scale to keep text static\r\n\t\t\tctx.fillStyle = 'rgba(255,255,255,0.85)'\r\n\t\t\tctx.font = '12px sans-serif'\r\n\t\t\tctx.fillText('Tip: Frame board centered, edges parallel; slight top-down is okay. Keep bull near center.', pad * zoom, (pad + 18) * zoom)\r\n\t\t\tctx.restore()\r\n\t\t}\r\n\t}\r\n\r\n\tfunction onClickOverlay(e: React.MouseEvent<HTMLCanvasElement>) {\r\n\t\tif (phase !== 'select') return\r\n\t\tconst el = (e.target as HTMLCanvasElement)\r\n\t\tconst rect = el.getBoundingClientRect()\r\n\t\tconst cssX = e.clientX - rect.left\r\n\t\tconst cssY = e.clientY - rect.top\r\n\t\t// Map CSS coordinates back to the overlay canvas pixel coordinates, accounting for CSS scaling and zoom\r\n\t\tconst scaleX = el.width > 0 ? (el.width / rect.width) : 1\r\n\t\tconst scaleY = el.height > 0 ? (el.height / rect.height) : 1\r\n\t\tconst x = cssX * scaleX\r\n\t\tconst y = cssY * scaleY\r\n\t\tconst pts = [...dstPoints, { x, y }]\r\n\t\tif (pts.length <= 6) {\r\n\t\t\tsetDstPoints(pts)\r\n\t\t\tdrawOverlay(pts)\r\n\t\t}\r\n\t}\r\n\r\n\tfunction undoPoint() {\r\n\t\tconst pts = dstPoints.slice(0, -1)\r\n\t\tsetDstPoints(pts)\r\n\t\tdrawOverlay(pts)\r\n\t}\r\n\r\n\t\tfunction refinePoints() {\r\n\t\t\tif (!canvasRef.current || dstPoints.length === 0) return\r\n\t\t\tconst refined = refinePointsSobel(canvasRef.current, dstPoints, 8)\r\n\t\t\tsetDstPoints(refined)\r\n\t\t\tdrawOverlay(refined)\r\n\t\t}\r\n\r\n\tfunction compute() {\r\n\t\tif (!canvasRef.current) return\r\n\t\tif (dstPoints.length < 5) return alert('Please click all 5 calibration points: the 4 corners of the double ring plus the CENTER of the bull.')\r\n\t\tconst src = canonicalRimTargets() // board space mm\r\n\t\tconst Hcalc = computeHomographyDLT(src, dstPoints)\r\n\t\tdrawOverlay(dstPoints, Hcalc)\r\n\t\tconst err = rmsError(Hcalc, src, dstPoints)\r\n\t\tsetCalibration({ H: Hcalc as Homography, createdAt: Date.now(), errorPx: err, imageSize: { w: canvasRef.current.width, h: canvasRef.current.height }, anchors: { src, dst: dstPoints } })\r\n\t\tsetPhase('computed')\r\n\t}\r\n\r\n\t\tfunction runVerification() {\r\n\t\t\tif (!H || !overlayRef.current) return alert('Please compute calibration first (lock) before running verification.')\r\n\t\t\ttry {\r\n\t\t\t\t// Prepare a set of canonical board test points (in mm)\r\n\t\t\t\tconst tests: Array<{ label: string; p: { x: number; y: number } }> = [\r\n\t\t\t\t\t{ label: 'Bull (50)', p: { x: 0, y: 0 } },\r\n\t\t\t\t\t{ label: 'Outer Bull (25)', p: { x: 0, y: -BoardRadii.bullOuter } },\r\n\t\t\t\t\t{ label: 'Triple 20', p: { x: 0, y: -((BoardRadii.trebleInner + BoardRadii.trebleOuter) / 2) } },\r\n\t\t\t\t\t{ label: 'Single 5 (near 5 sector)', p: { x: (BoardRadii.trebleInner + BoardRadii.trebleOuter) / 2 * Math.cos(Math.PI * 0.1), y: (BoardRadii.trebleInner + BoardRadii.trebleOuter) / 2 * Math.sin(Math.PI * 0.1) } },\r\n\t\t\t\t]\r\n\t\t\t\tconst ctx = overlayRef.current.getContext('2d')!\r\n\t\t\t\t// Redraw base overlay so markers are visible\r\n\t\t\t\tdrawOverlay(dstPoints, H)\r\n\t\t\t\tconst results: Array<any> = []\r\n\t\t\t\tfor (const t of tests) {\r\n\t\t\t\t\tconst imgP = applyHomography(H as any, { x: t.p.x, y: t.p.y })\r\n\t\t\t\t\tconst detectedBoard = imageToBoard(H as any, imgP)\r\n\t\t\t\t\tconst detected = scoreAtBoardPoint(detectedBoard)\r\n\t\t\t\t\tconst expected = scoreAtBoardPoint(t.p)\r\n\t\t\t\t\tconst match = (expected.base === detected.base && expected.mult === detected.mult) || (expected.base === detected.base)\r\n\t\t\t\t\tresults.push({ label: t.label, expected, detected, match })\r\n\t\t\t\t\t// draw marker\r\n\t\t\t\t\tdrawCross(ctx, imgP, match ? '#10b981' : '#ef4444')\r\n\t\t\t\t\tctx.fillStyle = match ? '#10b981' : '#ef4444'\r\n\t\t\t\t\tctx.font = '12px sans-serif'\r\n\t\t\t\t\tctx.fillText(t.label, imgP.x + 6, imgP.y - 6)\r\n\t\t\t\t}\r\n\t\t\t\tsetVerificationResults(results)\r\n\t\t\t} catch (err) {\r\n\t\t\t\tconsole.error('Verification failed', err)\r\n\t\t\t\talert('Verification failed: ' + (err as any)?.message)\r\n\t\t\t}\r\n\t\t}\r\n\r\n\tfunction resetAll() {\r\n\t\tsetDstPoints([])\r\n\t\tsetSnapshotSet(false)\r\n\t\tsetPhase('camera')\r\n\t\tdrawOverlay([])\r\n\t\tsetMarkerResult(null)\r\n\t\treset()\r\n\t}\r\n\r\n\t// --- Auto-detect the double rim from the current snapshot and compute homography ---\r\n\t\tasync function autoDetectRings() {\r\n\t\tif (!canvasRef.current) return alert('Load a photo or capture a frame first.')\r\n\t\tsetMarkerResult(null)\r\n\t\tconst src = canvasRef.current\r\n\t\t// Downscale for speed\r\n\t\tconst maxW = 800\r\n\t\tconst scale = Math.min(1, maxW / src.width)\r\n\t\tconst dw = Math.max(1, Math.round(src.width * scale))\r\n\t\tconst dh = Math.max(1, Math.round(src.height * scale))\r\n\t\tconst tmp = document.createElement('canvas')\r\n\t\ttmp.width = dw; tmp.height = dh\r\n\t\tconst tctx = tmp.getContext('2d')!\r\n\t\ttctx.drawImage(src, 0, 0, dw, dh)\r\n\t\tconst img = tctx.getImageData(0, 0, dw, dh)\r\n\t\t// Grayscale + Sobel edge magnitude\r\n\t\tconst gray = new Float32Array(dw * dh)\r\n\t\tfor (let i = 0, p = 0; i < img.data.length; i += 4, p++) {\r\n\t\t\tconst r = img.data[i], g = img.data[i+1], b = img.data[i+2]\r\n\t\t\tgray[p] = 0.299*r + 0.587*g + 0.114*b\r\n\t\t}\r\n\t\tconst gx = new Float32Array(dw * dh)\r\n\t\tconst gy = new Float32Array(dw * dh)\r\n\t\tfor (let y = 1; y < dh-1; y++) {\r\n\t\t\tfor (let x = 1; x < dw-1; x++) {\r\n\t\t\t\tconst i = y*dw + x\r\n\t\t\t\tconst a = gray[i - dw - 1], b = gray[i - dw], c = gray[i - dw + 1]\r\n\t\t\t\tconst d0 = gray[i - 1],        /*e*/       f0 = gray[i + 1]\r\n\t\t\t\tconst g0 = gray[i + dw - 1], h0 = gray[i + dw], j0 = gray[i + dw + 1]\r\n\t\t\t\tgx[i] = (-a - 2*d0 - g0) + (c + 2*f0 + j0)\r\n\t\t\t\tgy[i] = (-a - 2*b - c) + (g0 + 2*h0 + j0)\r\n\t\t\t}\r\n\t\t}\r\n\t\tconst mag = new Float32Array(dw * dh)\r\n\t\tlet maxMag = 1\r\n\t\tfor (let i = 0; i < mag.length; i++) { const m = Math.hypot(gx[i], gy[i]); mag[i] = m; if (m > maxMag) maxMag = m }\r\n\t\t// Coarse circle search around center for double outer\r\n\t\tconst cx0 = Math.floor(dw/2), cy0 = Math.floor(dh/2)\r\n\t\tconst rMin = Math.floor(Math.min(dw, dh) * 0.35)\r\n\t\tconst rMax = Math.floor(Math.min(dw, dh) * 0.52)\r\n\t\tlet best = { score: -1, cx: cx0, cy: cy0, r: Math.floor((rMin + rMax)/2) }\r\n\t\tconst stepC = Math.max(2, Math.floor(Math.min(dw, dh) * 0.01)) // center step\r\n\t\tconst stepR = Math.max(2, Math.floor(Math.min(dw, dh) * 0.01)) // radius step\r\n\t\tfor (let cy = cy0 - Math.floor(dh*0.08); cy <= cy0 + Math.floor(dh*0.08); cy += stepC) {\r\n\t\t\tfor (let cx = cx0 - Math.floor(dw*0.08); cx <= cx0 + Math.floor(dw*0.08); cx += stepC) {\r\n\t\t\t\tfor (let r = rMin; r <= rMax; r += stepR) {\r\n\t\t\t\t\tlet s = 0\r\n\t\t\t\t\tconst samples = 360\r\n\t\t\t\t\tfor (let a = 0; a < samples; a++) {\r\n\t\t\t\t\t\tconst ang = (a * Math.PI) / 180\r\n\t\t\t\t\t\tconst x = Math.round(cx + r * Math.cos(ang))\r\n\t\t\t\t\t\tconst y = Math.round(cy + r * Math.sin(ang))\r\n\t\t\t\t\t\tif (x <= 0 || x >= dw-1 || y <= 0 || y >= dh-1) continue\r\n\t\t\t\t\t\ts += mag[y*dw + x]\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif (s > best.score) best = { score: s, cx, cy, r }\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\t// Map back to original canvas coords\r\n\t\tconst inv = 1/scale\r\n\t\tconst OCX = best.cx * inv\r\n\t\tconst OCY = best.cy * inv\r\n\t\tconst OR  = best.r  * inv\r\n\t\t// With center/doubleOuter radius fixed, locate other rings via 1D radial search\r\n\t\tfunction radialScore(rPx: number) {\r\n\t\t\tlet s = 0\r\n\t\t\tconst rScaled = rPx * scale\r\n\t\t\tconst samples = 360\r\n\t\t\tfor (let a = 0; a < samples; a++) {\r\n\t\t\t\tconst ang = (a * Math.PI) / 180\r\n\t\t\t\tconst x = Math.round(best.cx + rScaled * Math.cos(ang))\r\n\t\t\t\tconst y = Math.round(best.cy + rScaled * Math.sin(ang))\r\n\t\t\t\tif (x <= 0 || x >= dw-1 || y <= 0 || y >= dh-1) continue\r\n\t\t\t\ts += mag[y*dw + x]\r\n\t\t\t}\r\n\t\t\treturn s\r\n\t\t}\r\n\t\tconst ratios = {\r\n\t\t\tbullInner: BoardRadii.bullInner / BoardRadii.doubleOuter,\r\n\t\t\tbullOuter: BoardRadii.bullOuter / BoardRadii.doubleOuter,\r\n\t\t\ttrebleInner: BoardRadii.trebleInner / BoardRadii.doubleOuter,\r\n\t\t\ttrebleOuter: BoardRadii.trebleOuter / BoardRadii.doubleOuter,\r\n\t\t\tdoubleInner: BoardRadii.doubleInner / BoardRadii.doubleOuter,\r\n\t\t\tdoubleOuter: 1,\r\n\t\t} as const\r\n\t\tfunction refineAround(expectedR: number, pctWindow = 0.08) { // Reduced window for more precision\r\n\t\t\tconst lo = Math.max(1, Math.floor(expectedR * (1 - pctWindow)))\r\n\t\t\tconst hi = Math.max(lo+1, Math.floor(expectedR * (1 + pctWindow)))\r\n\t\t\tlet bestR = lo, bestS = -1\r\n\t\t\tfor (let r = lo; r <= hi; r++) {\r\n\t\t\t\tconst s = radialScore(r)\r\n\t\t\t\tif (s > bestS) { bestS = s; bestR = r }\r\n\t\t\t}\r\n\t\t\treturn bestR\r\n\t\t}\r\n\t\tconst dOuter = OR\r\n\t\tconst dInner = refineAround(dOuter * ratios.doubleInner)\r\n\t\tconst tOuter = refineAround(dOuter * ratios.trebleOuter)\r\n\t\tconst tInner = refineAround(dOuter * ratios.trebleInner)\r\n\t\tconst bOuter = refineAround(dOuter * ratios.bullOuter)\r\n\t\tconst bInner = refineAround(dOuter * ratios.bullInner)\r\n\t\t\tsetDetected({ cx: OCX, cy: OCY, bullInner: bInner, bullOuter: bOuter, trebleInner: tInner, trebleOuter: tOuter, doubleInner: dInner, doubleOuter: dOuter })\r\n\t\t\t// Estimate confidence: ratio of ring scores around expected vs local baseline\r\n\t\t\t// Use normalized edge magnitude at found radii to compute a 0-1 score, then scale to percent\r\n\t\t\tconst totalEdge = (r: number) => {\r\n\t\t\t\tconst samples = 180\r\n\t\t\t\tlet s = 0\r\n\t\t\t\tfor (let a = 0; a < samples; a++) {\r\n\t\t\t\t\tconst ang = (a * Math.PI) / 90\r\n\t\t\t\t\tconst x = Math.round(best.cx + (r*scale) * Math.cos(ang))\r\n\t\t\t\t\tconst y = Math.round(best.cy + (r*scale) * Math.sin(ang))\r\n\t\t\t\t\tif (x <= 0 || x >= dw-1 || y <= 0 || y >= dh-1) continue\r\n\t\t\t\t\ts += mag[y*dw + x]\r\n\t\t\t\t}\r\n\t\t\t\treturn s / samples\r\n\t\t\t}\r\n\t\t\tconst score = totalEdge(best.r) + totalEdge(tOuter) + totalEdge(tInner) + totalEdge(dInner) + totalEdge(bOuter) + totalEdge(bInner)\r\n\t\t\tconst norm = score / (maxMag * 6)\r\n\t\t\tconst conf = Math.max(0, Math.min(1, norm))\r\n\t\t\t// Apply stricter confidence calculation for perfect calibration\r\n\t\t\tconst adjustedConf = Math.min(conf, Math.min(\r\n\t\t\t\ttotalEdge(best.r) / maxMag,    // Double outer\r\n\t\t\t\ttotalEdge(tOuter) / maxMag,    // Treble outer  \r\n\t\t\t\ttotalEdge(tInner) / maxMag,    // Treble inner\r\n\t\t\t\ttotalEdge(dInner) / maxMag,    // Double inner\r\n\t\t\t\ttotalEdge(bOuter) / maxMag,    // Bull outer\r\n\t\t\t\ttotalEdge(bInner) / maxMag     // Bull inner\r\n\t\t\t))\r\n\t\t\tsetConfidence(forceConfidence ? 100 : Math.round(adjustedConf * 100))\r\n\t\t// Seed the six calibration points for accurate alignment\r\n\t\t// Points: TOP, RIGHT, BOTTOM, LEFT of double rim, plus bullseye center and outer bull top\r\n\t\tconst pts: Point[] = [\r\n\t\t\t{ x: OCX,       y: OCY - dOuter }, // TOP of double rim\r\n\t\t\t{ x: OCX + dOuter,  y: OCY      }, // RIGHT of double rim\r\n\t\t\t{ x: OCX,       y: OCY + dOuter }, // BOTTOM of double rim\r\n\t\t\t{ x: OCX - dOuter,  y: OCY      }, // LEFT of double rim\r\n\t\t\t{ x: OCX,       y: OCY          }, // CENTER (bullseye inner bull center)\r\n\t\t\t{ x: OCX,       y: OCY - bOuter }, // TOP of outer bull (for vertical center constraint)\r\n\t\t]\r\n\t\tsetDstPoints(pts)\r\n\t\tdrawOverlay(pts)\r\n\t\t// Compute homography with the 6 points\r\n\t\ttry {\r\n\t\t\tconst src = canonicalRimTargets() // board space mm\r\n\t\t\tconst Hcalc = computeHomographyDLT(src, pts)\r\n\t\t\tdrawOverlay(pts, Hcalc)\r\n\t\t\tconst err = rmsError(Hcalc, src, pts)\r\n\t\t\tsetCalibration({ H: Hcalc as Homography, createdAt: Date.now(), errorPx: err, imageSize: { w: canvasRef.current.width, h: canvasRef.current.height }, anchors: { src, dst: pts } })\r\n\t\t\tsetPhase('computed')\r\n\t\t} catch (e) {\r\n\t\t\tconsole.error('[Calibrator] Auto-detect compute failed:', e)\r\n\t\t}\r\n\t\t// Auto-lock if confidence high and error small\r\n\tconst autoLock = forceConfidence ? true : (adjustedConf >= 0.95) // Use adjusted confidence for near-perfect calibration, or force lock\r\n\t\tsetCalibration({ locked: autoLock })\r\n\t}\r\n\r\n\tconst workerRef = useRef<Worker | null>(null)\r\n\tuseEffect(() => {\r\n\t\tlet w: Worker | null = null\r\n\t\ttry {\r\n\t\t\tw = new Worker(new URL('../workers/boardDetection.worker.ts', import.meta.url), { type: 'module' } as any)\r\n\t\t\tworkerRef.current = w\r\n\t\t\tconsole.log('[Calibrator] Board detection worker created')\r\n\t\t} catch (err) {\r\n\t\t\tconsole.warn('[Calibrator] Failed to create board detection worker, will fallback to main thread: ', err)\r\n\t\t\tworkerRef.current = null\r\n\t\t}\r\n\t\treturn () => { try { w?.terminate() } catch {} }\r\n\t}, [])\r\n\r\n\t// Advanced auto-calibration: detect board features without markers or manual clicking\r\nasync function autoCalibrate() {\r\n\t\tif (!canvasRef.current) return alert('Capture a frame or upload a photo first.')\r\n\t\t// If worker is available, use it; otherwise fall back to synchronous detection\r\n\t\tif (workerRef.current) {\r\n\t\t\tsetAutoCalibrating(true)\r\n\t\t\tlet bitmap: ImageBitmap | null = null\r\n\t\t\ttry {\r\n\t\t\t\tbitmap = await createImageBitmap(canvasRef.current)\r\n\t\t\t} catch (err) {\r\n\t\t\t\tconsole.warn('[Calibrator] createImageBitmap failed; falling back to main thread detection', err)\r\n\t\t\t\tbitmap = null\r\n\t\t\t}\r\n\t\t\tif (!bitmap) {\r\n\t\t\t\tsetAutoCalibrating(false)\r\n\t\t\t\t// fallback: run sync detection\r\n\t\t\t\treturn autoCalibrateSync()\r\n\t\t\t}\r\n\t\t\ttry {\r\n\t\t\t\tconst worker = workerRef.current\r\n\t\t\t\tif (!worker) return autoCalibrateSync()\r\n\t\t\t\treturn new Promise<void>((resolve) => {\r\n\t\t\t\t\tlet timeoutId: ReturnType<typeof setTimeout> | undefined\r\n\t\t\t\t\tconst onMessage = (ev: MessageEvent) => {\r\n\t\t\t\t\t\ttry {\r\n\t\t\t\t\t\t\tif (ev.data && ev.data.error) {\r\n\t\t\t\t\t\t\t\talert(`Auto-calibration failed: ${ev.data.error}`)\r\n\t\t\t\t\t\t\t\tsetAutoCalibrating(false)\r\n\t\t\t\t\t\t\t\tif (timeoutId) clearTimeout(timeoutId)\r\n\t\t\t\t\t\t\t\tworker.removeEventListener('message', onMessage)\r\n\t\t\t\t\t\t\t\tresolve()\r\n\t\t\t\t\t\t\t\treturn\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\tif (ev.data && ev.data.type === 'result') {\r\n\t\t\t\t\t\t\t\tconst boardDetection = ev.data.detection as BoardDetectionResult\r\n\t\t\t\t\t\t\t\t// Respect forceConfidence\r\n\t\t\t\t\t\t\t\tif (forceConfidence) boardDetection.confidence = 100\r\n\t\t\t\t\t\t\t\t// If we have missing homography and forceConfidence, try to compute a homography\r\n\t\t\t\t\t\t\t\tif (forceConfidence && (!boardDetection.homography || !Array.isArray(boardDetection.calibrationPoints) || boardDetection.calibrationPoints.length < 4)) {\r\n\t\t\t\t\t\t\t\t\tconst points = boardDetection.calibrationPoints || []\r\n\t\t\t\t\t\t\t\t\tif (points.length >= 4) {\r\n\t\t\t\t\t\t\t\t\t\tconst canonicalSrc = [\r\n\t\t\t\t\t\t\t\t\t\t\t{ x: 0, y: -BoardRadii.doubleOuter },\r\n\t\t\t\t\t\t\t\t\t\t\t{ x: BoardRadii.doubleOuter, y: 0 },\r\n\t\t\t\t\t\t\t\t\t\t\t{ x: 0, y: BoardRadii.doubleOuter },\r\n\t\t\t\t\t\t\t\t\t\t\t{ x: -BoardRadii.doubleOuter, y: 0 },\r\n\t\t\t\t\t\t\t\t\t\t]\r\n\t\t\t\t\t\t\t\t\t\ttry {\r\n\t\t\t\t\t\t\t\t\t\t\tconst H = computeHomographyDLT(canonicalSrc, points.slice(0, 4))\r\n\t\t\t\t\t\t\t\t\t\t\tboardDetection.homography = H\r\n\t\t\t\t\t\t\t\t\t\t\tboardDetection.errorPx = rmsError(H, canonicalSrc, points.slice(0, 4))\r\n\t\t\t\t\t\t\t\t\t\t} catch (err) { console.warn('[Calibrator] Worker forced homography compute failed', err) }\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\tif (!boardDetection.success || !boardDetection.homography || (!forceConfidence && boardDetection.confidence < 50)) {\r\n\t\t\t\t\t\t\t\t\talert(` Board Detection Failed\\n\\nConfidence: ${Math.round(boardDetection.confidence)}%\\n\\n${boardDetection.message}\\n\\nTry:\\n Better lighting\\n Closer camera angle\\n Make sure entire board is visible\\n Use manual calibration instead (click 5 points)`)\r\n\t\t\t\t\t\t\t\t\tsetAutoCalibrating(false)\r\n\t\t\t\t\t\t\t\t\tif (timeoutId) clearTimeout(timeoutId)\r\n\t\t\t\t\t\t\t\t\tworker.removeEventListener('message', onMessage)\r\n\t\t\t\t\t\t\t\t\tresolve()\r\n\t\t\t\t\t\t\t\t\treturn\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t// Apply the calibration\r\n\t\t\t\t\t\t\t\tsetDetected({\r\n\t\t\t\t\t\t\t\t\tcx: boardDetection.cx,\r\n\t\t\t\t\t\t\t\t\tcy: boardDetection.cy,\r\n\t\t\t\t\t\t\t\t\tbullInner: boardDetection.bullInner,\r\n\t\t\t\t\t\t\t\t\tbullOuter: boardDetection.bullOuter,\r\n\t\t\t\t\t\t\t\t\ttrebleInner: boardDetection.trebleInner,\r\n\t\t\t\t\t\t\t\t\ttrebleOuter: boardDetection.trebleOuter,\r\n\t\t\t\t\t\t\t\t\tdoubleInner: boardDetection.doubleInner,\r\n\t\t\t\t\t\t\t\t\tdoubleOuter: boardDetection.doubleOuter,\r\n\t\t\t\t\t\t\t\t})\r\n\t\t\t\t\t\t\t\tsetDstPoints(boardDetection.calibrationPoints)\r\n\t\t\t\t\t\t\t\tdrawOverlay(boardDetection.calibrationPoints, boardDetection.homography)\r\n\t\t\t\t\t\t\t\tconst shouldLock = (boardDetection.errorPx ?? Number.POSITIVE_INFINITY) <= 2.0\r\n\t\t\t\t\t\t\t\tsetCalibration({ H: boardDetection.homography as Homography, createdAt: Date.now(), errorPx: boardDetection.errorPx ?? null, imageSize: { w: canvasRef.current.width, h: canvasRef.current.height }, anchors: { src: canonicalRimTargets().slice(0, 4), dst: boardDetection.calibrationPoints }, locked: shouldLock ? true : locked })\r\n\t\t\t\t\t\t\t\tsetPhase('computed')\r\n\t\t\t\t\t\t\t\tsetConfidence(forceConfidence ? 100 : Math.round(boardDetection.confidence))\r\n\t\t\t\t\t\t\t\tsetErrorPx(boardDetection.errorPx ?? null)\r\n\t\t\t\t\t\t\t\tsetAutoCalibrating(false)\r\n\t\t\t\t\t\t\t\tworker.removeEventListener('message', onMessage)\r\n\t\t\t\t\t\t\t\tresolve()\r\n\t\t\t\t\t\t\t\treturn\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t} catch (err) {\r\n\t\t\t\t\t\t\tconsole.warn('[Calibrator] Worker message processing failed', err)\r\n\t\t\t\t\t\t\tsetAutoCalibrating(false)\r\n\t\t\t\t\t\t\tworker.removeEventListener('message', onMessage)\r\n\t\t\t\t\t\t\tresolve()\r\n\t\t\t\t\t\t\treturn\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\tworker.addEventListener('message', onMessage)\r\n\t\t\t\t\tworker.postMessage({ type: 'detect', bitmap }, [bitmap])\r\n\t\t\t\t\t// safety timeout - fallback to sync after 8s\r\n\t\t\t\t\ttimeoutId = setTimeout(() => {\r\n\t\t\t\t\t\tif (autoCalibrating) {\r\n\t\t\t\t\t\t\tconsole.warn('[Calibrator] Worker timed out, attempting sync fallback')\r\n\t\t\t\t\t\t\tsetAutoCalibrating(false)\r\n\t\t\t\t\t\t\tif (timeoutId) clearTimeout(timeoutId)\r\n\t\t\t\t\t\t\tworker.removeEventListener('message', onMessage)\r\n\t\t\t\t\t\t\tautoCalibrateSync()\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}, 8000)\r\n\t\t\t\t})\r\n\t\t\t} catch (err) {\r\n\t\t\t\tconsole.warn('[Calibrator] AutoCalibrate worker payload failed', err)\r\n\t\t\t\tsetAutoCalibrating(false)\r\n\t\t\t\treturn autoCalibrateSync()\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\treturn autoCalibrateSync()\r\n\t\t}\r\n\t}\r\n\r\n\t// Synchronous fallback for autoCalibrate if no worker available\r\n    async function autoCalibrateSync() {\r\n\t\tsetAutoCalibrating(true)\r\n\t\tlet boardDetection = detectBoard(canvasRef.current!)\r\n\t\tboardDetection = refineRingDetection(boardDetection)\r\n\t\tif (forceConfidence) boardDetection.confidence = 100\r\n\t\tif (forceConfidence && (!boardDetection.homography || !Array.isArray(boardDetection.calibrationPoints) || boardDetection.calibrationPoints.length < 4)) {\r\n\t\t\ttry {\r\n\t\t\t\tconst points = boardDetection.calibrationPoints || []\r\n\t\t\t\tif (points.length >= 4) {\r\n\t\t\t\t\tconst canonicalSrc = [\r\n\t\t\t\t\t\t{ x: 0, y: -BoardRadii.doubleOuter },\r\n\t\t\t\t\t\t{ x: BoardRadii.doubleOuter, y: 0 },\r\n\t\t\t\t\t\t{ x: 0, y: BoardRadii.doubleOuter },\r\n\t\t\t\t\t\t{ x: -BoardRadii.doubleOuter, y: 0 },\r\n\t\t\t\t\t]\r\n\t\t\t\t\tconst H = computeHomographyDLT(canonicalSrc, points.slice(0, 4))\r\n\t\t\t\t\tboardDetection.homography = H\r\n\t\t\t\t\tboardDetection.errorPx = rmsError(H, canonicalSrc, points.slice(0, 4))\r\n\t\t\t\t}\r\n\t\t\t} catch (err) { console.warn('[Calibrator] sync forced homography compute failed', err) }\r\n\t\t}\r\n\t\tif (!boardDetection.success || !boardDetection.homography || (!forceConfidence && boardDetection.confidence < 50)) {\r\n\t\t\talert(` Board Detection Failed\\n\\nConfidence: ${Math.round(boardDetection.confidence)}%\\n\\n${boardDetection.message}\\n\\nTry:\\n Better lighting\\n Closer camera angle\\n Make sure entire board is visible\\n Use manual calibration instead (click 5 points)`)\r\n\t\t\tsetAutoCalibrating(false)\r\n\t\t\treturn\r\n\t\t}\r\n\t\t// Apply detection (same as worker result processing)\r\n\t\tsetDetected({\r\n\t\t\tcx: boardDetection.cx,\r\n\t\t\tcy: boardDetection.cy,\r\n\t\t\tbullInner: boardDetection.bullInner,\r\n\t\t\tbullOuter: boardDetection.bullOuter,\r\n\t\t\ttrebleInner: boardDetection.trebleInner,\r\n\t\t\ttrebleOuter: boardDetection.trebleOuter,\r\n\t\t\tdoubleInner: boardDetection.doubleInner,\r\n\t\t\tdoubleOuter: boardDetection.doubleOuter,\r\n\t\t})\r\n\t\tsetDstPoints(boardDetection.calibrationPoints)\r\n\t\tdrawOverlay(boardDetection.calibrationPoints, boardDetection.homography)\r\n\t\tconst shouldLock = (boardDetection.errorPx ?? Number.POSITIVE_INFINITY) <= 2.0\r\n\t\tsetCalibration({ H: boardDetection.homography as Homography, createdAt: Date.now(), errorPx: boardDetection.errorPx ?? null, imageSize: { w: canvasRef.current!.width, h: canvasRef.current!.height }, anchors: { src: canonicalRimTargets().slice(0, 4), dst: boardDetection.calibrationPoints }, locked: shouldLock ? true : locked })\r\n\t\tsetPhase('computed')\r\n\t\tsetConfidence(forceConfidence ? 100 : Math.round(boardDetection.confidence))\r\n\t\tsetErrorPx(boardDetection.errorPx ?? null)\r\n\t\tsetAutoCalibrating(false)\r\n\t}\r\n\t\tif (!canvasRef.current) return alert('Capture a frame or upload a photo first.')\r\n\t\t\r\n\t\t// Use the new board detection system\r\n\t\t\t\tlet boardDetection = detectBoard(canvasRef.current)\r\n\t\t\t\tboardDetection = refineRingDetection(boardDetection)\r\n\r\n\t\t\t\t// If forcing confidence, override the computed confidence and allow success paths\r\n\t\t\t\tif (forceConfidence) {\r\n\t\t\t\t\ttry { boardDetection.confidence = 100 } catch {}\r\n\t\t\t\t}\r\n\r\n\t\t\t\t// If forcing confidence and homography is missing but we have calibration points available,\r\n\t\t\t\t// attempt to compute a homography directly so we can still apply the calibration.\r\n\t\t\t\tif (forceConfidence && (!boardDetection.homography || !Array.isArray(boardDetection.calibrationPoints) || boardDetection.calibrationPoints.length < 4)) {\r\n\t\t\t\t\ttry {\r\n\t\t\t\t\t\tconst points = boardDetection.calibrationPoints || []\r\n\t\t\t\t\t\tif (points.length >= 4) {\r\n\t\t\t\t\t\t\tconst canonicalSrc = [\r\n\t\t\t\t\t\t\t\t{ x: 0, y: -BoardRadii.doubleOuter },\r\n\t\t\t\t\t\t\t\t{ x: BoardRadii.doubleOuter, y: 0 },\r\n\t\t\t\t\t\t\t\t{ x: 0, y: BoardRadii.doubleOuter },\r\n\t\t\t\t\t\t\t\t{ x: -BoardRadii.doubleOuter, y: 0 },\r\n\t\t\t\t\t\t\t]\r\n\t\t\t\t\t\t\tconst H = computeHomographyDLT(canonicalSrc, points.slice(0, 4))\r\n\t\t\t\t\t\t\tboardDetection.homography = H\r\n\t\t\t\t\t\t\tconst err = rmsError(H, canonicalSrc, points.slice(0, 4))\r\n\t\t\t\t\t\t\tboardDetection.errorPx = err\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t} catch (err) { console.warn('[Calibrator] Forced homography compute failed', err) }\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif (!boardDetection.success || !boardDetection.homography || (!forceConfidence && boardDetection.confidence < 50)) {\r\n\t\t\talert(` Board Detection Failed\\n\\nConfidence: ${Math.round(boardDetection.confidence)}%\\n\\n${boardDetection.message}\\n\\nTry:\\n Better lighting\\n Closer camera angle\\n Make sure entire board is visible\\n Use manual calibration instead (click 5 points)`)\r\n\t\t\treturn\r\n\t\t}\r\n\r\n\t\tconst homography = boardDetection.homography\r\n\t\tconst points = boardDetection.calibrationPoints || []\r\n\t\tconst pointsValid = Array.isArray(points) && points.length >= 4 && points.every(p => p && Number.isFinite(p.x) && Number.isFinite(p.y))\r\n\t\tconst homographyValid = Array.isArray(homography) && homography.length === 9 && homography.every(Number.isFinite)\r\n\t\tif (!pointsValid || !homographyValid) {\r\n\t\t\tconsole.error('[Calibrator] Auto-calibration produced invalid data', { boardDetection })\r\n\t\t\talert(' Auto-calibration produced unstable results. Adjust camera framing or calibrate manually.')\r\n\t\t\treturn\r\n\t\t}\r\n\r\n\t\t// Success! Apply the calibration\r\n\t\tsetDetected({\r\n\t\t\tcx: boardDetection.cx,\r\n\t\t\tcy: boardDetection.cy,\r\n\t\t\tbullInner: boardDetection.bullInner,\r\n\t\t\tbullOuter: boardDetection.bullOuter,\r\n\t\t\ttrebleInner: boardDetection.trebleInner,\r\n\t\t\ttrebleOuter: boardDetection.trebleOuter,\r\n\t\t\tdoubleInner: boardDetection.doubleInner,\r\n\t\t\tdoubleOuter: boardDetection.doubleOuter,\r\n\t\t})\r\n\r\n\t\tsetDstPoints(boardDetection.calibrationPoints)\r\n\t\tdrawOverlay(boardDetection.calibrationPoints, boardDetection.homography)\r\n\r\n\t\tconst shouldLock = (boardDetection.errorPx ?? Number.POSITIVE_INFINITY) <= 2.0\r\n\t\tsetCalibration({\r\n\t\t\tH: boardDetection.homography as Homography,\r\n\t\t\tcreatedAt: Date.now(),\r\n\t\t\terrorPx: boardDetection.errorPx ?? null,\r\n\t\t\timageSize: { w: canvasRef.current.width, h: canvasRef.current.height },\r\n\t\t\tanchors: { src: canonicalRimTargets().slice(0, 4), dst: boardDetection.calibrationPoints },\r\n\t\t\tlocked: shouldLock ? true : locked,\r\n\t\t})\r\n\r\n\t\tsetPhase('computed')\r\n\r\n\t\t// Show success message\r\n\t\tconst confidenceLevel = boardDetection.confidence > 90 ? ' Excellent' : boardDetection.confidence > 80 ? ' Good' : boardDetection.confidence > 70 ? ' Fair' : ' Acceptable'\r\n\t\talert(` Auto-Calibration Successful!\\n\\nConfidence: ${confidenceLevel} (${Math.round(boardDetection.confidence)}%)\\nError: ${boardDetection.errorPx?.toFixed(2) ?? '?'} pixels\\n\\nCalibration has been ${shouldLock ? 'locked' : 'computed (not locked yet)'}.`)\r\n\t}\r\n\r\n\t\t\tfunction detectMarkers() {\r\n\t\t\t\tif (!canvasRef.current) return alert('Capture a frame or upload a photo first.')\r\n\t\t\t\tconst result = detectMarkersFromCanvas(canvasRef.current)\r\n\t\t\t\tsetMarkerResult(result)\r\n\t\t\t\tif (!result.success || !result.homography) {\r\n\t\t\t\t\tconst missingMsg = result.missing.length\r\n\t\t\t\t\t\t? ` Missing markers: ${result.missing.map(k => `${k.toUpperCase()} (ID ${MARKER_TARGETS[k]})`).join(', ')}`\r\n\t\t\t\t\t\t: ''\r\n\t\t\t\t\tconst foundMsg = result.markersFound.length > 0\r\n\t\t\t\t\t\t? `\\n\\nDetected ${result.markersFound.length} markers with IDs: ${result.markersFound.map(m => m.id).join(', ')}`\r\n\t\t\t\t\t\t: '\\n\\nNo markers detected. Make sure markers are on white paper, fully visible, and well-lit.'\r\n\t\t\t\t\tconst fullMsg = `${result.message}${missingMsg}${foundMsg}\\n\\nYou can still use manual calibration: click 5 points on the board instead.`\r\n\t\t\t\t\talert(fullMsg)\r\n\t\t\t\t\treturn\r\n\t\t\t\t}\r\n\t\t\t\tsetDetected(null)\r\n\t\t\t\tsetDstPoints(result.points)\r\n\t\t\t\tdrawOverlay(result.points, result.homography)\r\n\t\t\t\tconst src = canonicalRimTargets()\r\n\t\t\t\tconst imageSize = { w: canvasRef.current.width, h: canvasRef.current.height }\r\n\t\t\t\tconst shouldLock = (result.errorPx ?? Number.POSITIVE_INFINITY) <= 1.2\r\n\t\t\t\tsetCalibration({\r\n\t\t\t\t\tH: result.homography as Homography,\r\n\t\t\t\t\tcreatedAt: Date.now(),\r\n\t\t\t\t\terrorPx: result.errorPx ?? null,\r\n\t\t\t\t\timageSize,\r\n\t\t\t\t\tanchors: { src, dst: result.points },\r\n\t\t\t\t\tlocked: shouldLock ? true : locked,\r\n\t\t\t\t})\r\n\t\t\t\tsetPhase('computed')\r\n\t\t\t}\r\n\r\n\t\tuseEffect(() => {\r\n\t\t\tdrawOverlay()\r\n\t\t// eslint-disable-next-line react-hooks/exhaustive-deps\r\n\t\t}, [snapshotSet, H])\r\n\r\n\t\t// Live detection loop (runs only when streaming and liveDetect is on)\r\n\t\tuseEffect(() => {\r\n\t\t\tif (!liveDetect || !streaming) return\r\n\t\t\tlet raf = 0\r\n\t\t\tconst tick = () => {\r\n\t\t\t\ttry { captureFrame() } catch {}\r\n\t\t\t\traf = requestAnimationFrame(tick)\r\n\t\t\t}\r\n\t\t\traf = requestAnimationFrame(tick)\r\n\t\t\treturn () => cancelAnimationFrame(raf)\r\n\t\t}, [liveDetect, streaming])\r\n\r\n\t\t// When calibration is locked and we have a pairing code, publish calibration to server\r\n\t\tuseEffect(() => {\r\n\t\t\t(async () => {\r\n\t\t\t\ttry {\r\n\t\t\t\t\tif (!locked || !pairCode) return\r\n\t\t\t\t\t// Build a compact calibration payload including current canvas size if available\r\n\t\t\t\t\tconst imgSize = canvasRef.current ? { w: canvasRef.current.width, h: canvasRef.current.height } : null\r\n\t\t\t\t\tconst bodyStr = JSON.stringify({ H, anchors: null, imageSize: imgSize, errorPx: errorPx ?? null })\r\n\t\t\t\t\ttry {\r\n\t\t\t\t\t\tawait apiFetch(`/cam/calibration/${pairCode}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: bodyStr })\r\n\t\t\t\t\t\tconsole.log('[Calibrator] Posted calibration for code', pairCode)\r\n\t\t\t\t\t} catch (err) {\r\n\t\t\t\t\t\tconsole.warn('[Calibrator] Upload calibration failed', err)\r\n\t\t\t\t\t}\r\n\t\t\t\t\t\t// If user is authenticated, persist calibration to their account (Supabase-backed)\r\n\t\t\t\t\t\ttry {\r\n\t\t\t\t\t\t\tconst token = localStorage.getItem('authToken')\r\n\t\t\t\t\t\t\tif (token) {\r\n\t\t\t\t\t\t\t\tawait apiFetch('/api/user/calibration', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: bodyStr })\r\n\t\t\t\t\t\t\t\tconsole.log('[Calibrator] Synced calibration to user account')\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t} catch (err) {\r\n\t\t\t\t\t\t\tconsole.warn('[Calibrator] User calibration sync failed', err)\r\n\t\t\t\t\t\t}\r\n\t\t\t\t} catch (e) { /* ignore */ }\r\n\t\t\t})()\r\n\t\t// eslint-disable-next-line react-hooks/exhaustive-deps\r\n\t\t}, [locked, pairCode])\r\n\r\n\t\t// DevicePicker moved from SettingsPanel\r\n\t\t\tfunction DevicePicker() {\r\n\t\t\t\t// Toggle to enable debug logs for dropdown behavior (set false to disable)\r\n\t\t\t\tconst DROPDOWN_DEBUG = true\r\n\t\t\tconst { preferredCameraId, preferredCameraLabel, setPreferredCamera, cameraEnabled, setCameraEnabled, preferredCameraLocked, setPreferredCameraLocked } = useUserSettings()\r\n\t\t\tconst [devices, setDevices] = useState<MediaDeviceInfo[]>([])\r\n\t\t\t\t\t\tconst [localDevicesSnapshot, setLocalDevicesSnapshot] = useState<MediaDeviceInfo[] | null>(null)\r\n\t\t\tconst [err, setErr] = useState('')\r\n\t\t\tconst [dropdownOpen, setDropdownOpen] = useState(false)\r\n\t\t\tconst dropdownRef = useRef<HTMLDivElement>(null)\r\n\t\t\t\t\t\tconst ignoreCloseUntilRef = useRef<number>(0)\r\n\t\t\t\t\t\t// When true, the document outside-click handler is temporarily suspended\r\n\t\t\t\t\t\tconst suspendDocHandlerRef = useRef<boolean>(false)\r\n\t\t\tconst dropdownPortal = document.getElementById('dropdown-portal-root') || (() => {\r\n\t\t\t\tconst el = document.createElement('div');\r\n\t\t\t\tel.id = 'dropdown-portal-root';\r\n\t\t\t\tdocument.body.appendChild(el);\r\n\t\t\t\treturn el;\r\n\t\t\t})();\r\n\r\n\t\t\tasync function enumerate() {\r\n\t\t\t\tif (DROPDOWN_DEBUG) console.debug('[DevicePicker] enumerate start', Date.now())\r\n\t\t\t\tsetErr('')\r\n\t\t\t\ttry {\r\n\t\t\t\t\t// Ensure we have permission; otherwise labels may be empty.\r\n\t\t\t\t\t// IMPORTANT: Only request permission without blocking the camera\r\n\t\t\t\t\ttry { \r\n\t\t\t\t\t\tconst permStream = await navigator.mediaDevices.getUserMedia({ video: true })\r\n\t\t\t\t\t\t// Stop the test stream immediately - don't hold the camera!\r\n\t\t\t\t\t\tpermStream.getTracks().forEach(t => t.stop())\r\n\t\t\t\t\t} catch {}\r\n\t\t\t\t\tconst list = await navigator.mediaDevices.enumerateDevices()\r\n\t\t\t\t\tconst cams = list.filter(d => d.kind === 'videoinput')\r\n\t\t\t\t\t\t\t\tsetDevices(cams)\r\n\t\t\t\t\t\t\t\t// If the picker is open, keep a stable snapshot so the list doesn't jump while interacting\r\n\t\t\t\t\t\t\t\tif (dropdownRef.current && (dropdownRef.current as any).dataset?.open === 'true') {\r\n\t\t\t\t\t\t\t\t\tsetLocalDevicesSnapshot(cams)\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\tif (DROPDOWN_DEBUG) console.debug('[DevicePicker] enumerate -> devices', cams.map(c=>c.deviceId), 'snapshot?', !!(dropdownRef.current && (dropdownRef.current as any).dataset?.open === 'true'))\r\n\t\t\t\t} catch (e: any) {\r\n\t\t\t\t\tsetErr('Unable to list cameras. Grant camera permission in your browser.')\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tuseEffect(() => { enumerate() }, [])\r\n\r\n\t\t\t\t\t\t// Close dropdown when clicking outside. Guard against immediate close\r\n\t\t\t\t\t\t// caused by focus/stream state churn by briefly ignoring outside clicks\r\n\t\t\t\t\t\tuseEffect(() => {\r\n\t\t\t\t\t\t\t\tfunction handleClickOutside(event: MouseEvent) {\r\n\t\t\t\t\t\t\t\t\ttry {\r\n\t\t\t\t\t\t\t\t\t\tif (DROPDOWN_DEBUG) console.debug('[DevicePicker] document.mousedown', { target: (event && (event.target as any))?.tagName || String(event.target), time: Date.now(), ignoreUntil: ignoreCloseUntilRef.current })\r\n\t\t\t\t\t\t\t\t\t\t// If suspended (recently opened) don't close yet\r\n\t\t\t\t\t\t\t\t\t\tif (suspendDocHandlerRef.current) {\r\n\t\t\t\t\t\t\t\t\t\t\tif (DROPDOWN_DEBUG) console.debug('[DevicePicker] document.mousedown ignored because suspendDocHandlerRef is true', Date.now())\r\n\t\t\t\t\t\t\t\t\t\t\treturn\r\n\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\t// If we're within the ignore window, don't close yet\r\n\t\t\t\t\t\t\t\t\t\tif (Date.now() < (ignoreCloseUntilRef.current || 0)) return\r\n\t\t\t\t\t\t\t\t\t\t// Treat clicks inside the portal as inside the dropdown (portal elements live outside dropdownRef)\r\n\t\t\t\t\t\t\t\t\t\tconst tgt = event.target as Node\r\n\t\t\t\t\t\t\t\t\t\tconst clickedInsideMain = dropdownRef.current && dropdownRef.current.contains(tgt)\r\n\t\t\t\t\t\t\t\t\t\tconst clickedInsidePortal = dropdownPortal && dropdownPortal.contains && dropdownPortal.contains(tgt)\r\n\t\t\t\t\t\t\t\t\t\tif (!clickedInsideMain && !clickedInsidePortal) {\r\n\t\t\t\t\t\t\t\t\t\t\tif (DROPDOWN_DEBUG) console.debug('[DevicePicker] document.mousedown -> closing dropdown (outside both main+portal)', Date.now())\r\n\t\t\t\t\t\t\t\t\t\t\tsetDropdownOpen(false)\r\n\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t} catch {}\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\tdocument.addEventListener('mousedown', handleClickOutside)\r\n\t\t\t\t\t\t\treturn () => document.removeEventListener('mousedown', handleClickOutside)\r\n\t\t\t\t\t\t}, [])\r\n\r\n\t\t\t\t\t\tconst selectedDevice = devices.find(d => d.deviceId === preferredCameraId)\r\n\t\t\t\t\t\tconst selectedLabel = selectedDevice ? \r\n\t\t\t\t\t\t\t`${selectedDevice.label || 'Camera'}` : \r\n\t\t\t\t\t\t\t(preferredCameraId ? 'Camera (unavailable)' : 'Auto (browser default)')\r\n\t\t\t\t\t\t// Local immediate label so UI reflects selection instantly even if global store\r\n\t\t\t\t\t\tconst [localSelectedLabel, setLocalSelectedLabel] = useState<string>(selectedLabel)\r\n\r\n\t\t\t// If preferred camera is set but not found, show a warning\r\n\t\t\tconst preferredCameraUnavailable = preferredCameraId && !selectedDevice\r\n\r\n\t\t\treturn (\r\n\t\t\t\t<div className=\"mt-3 p-3 rounded-lg border border-indigo-500/30 bg-indigo-500/5\">\r\n\t\t\t\t\t<div className=\"font-semibold mb-2\">Select camera device</div>\r\n\t\t\t\t\t{err && <div className=\"text-rose-400 text-sm mb-2\">{err}</div>}\r\n\t\t\t\t\t{preferredCameraUnavailable && (\r\n\t\t\t\t\t\t<div className=\"text-amber-400 text-sm mb-2\">\r\n\t\t\t\t\t\t\tSelected camera is no longer available. \r\n\t\t\t\t\t\t\t<button \r\n\t\t\t\t\t\t\t\tclassName=\"underline ml-1\" \r\n\t\t\t\t\t\t\t\t\t\t\tonClick={() => setPreferredCamera(undefined, '', true)}\r\n\t\t\t\t\t\t\t\tdisabled={streaming}\r\n\t\t\t\t\t\t\t>\r\n\t\t\t\t\t\t\t\tUse auto-selection\r\n\t\t\t\t\t\t\t</button>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t)}\r\n\t\t\t\t\t{/* Lock indicator and toggle for camera selection */}\r\n\t\t\t\t\t<div className=\"flex items-center gap-2 mb-2\">\r\n\t\t\t\t\t\t{preferredCameraLocked ? (\r\n\t\t\t\t\t\t\t<div className=\"text-xs text-emerald-400\"> Camera selection locked</div>\r\n\t\t\t\t\t\t) : (\r\n\t\t\t\t\t\t\t<div className=\"text-xs text-slate-400\">Camera selection unlocked</div>\r\n\t\t\t\t\t\t)}\r\n\t\t\t\t\t\t<button\r\n\t\t\t\t\t\t\tclassName=\"btn btn--ghost px-2 py-0.5 text-xs ml-2\"\r\n\t\t\t\t\t\t\tonClick={() => {\r\n\t\t\t\t\t\t\t\tsetPreferredCameraLocked(!preferredCameraLocked)\r\n\t\t\t\t\t\t\t}}\r\n\t\t\t\t\t\t>\r\n\t\t\t\t\t\t\t{preferredCameraLocked ? 'Unlock' : 'Lock'}\r\n\t\t\t\t\t\t</button>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t\t<div className=\"flex items-center gap-3 mb-3\">\r\n\t\t\t\t\t\t<input\r\n\t\t\t\t\t\t\ttype=\"checkbox\"\r\n\t\t\t\t\t\t\tid=\"cameraEnabled-calibrator\"\r\n\t\t\t\t\t\t\tchecked={cameraEnabled}\r\n\t\t\t\t\t\t\tonChange={e => setCameraEnabled(e.target.checked)}\r\n\t\t\t\t\t\t\tclassName=\"w-4 h-4\"\r\n\t\t\t\t\t\t\tdisabled={streaming}\r\n\t\t\t\t\t\t/>\r\n\t\t\t\t\t\t<label htmlFor=\"cameraEnabled-calibrator\" className=\"text-sm\">Enable camera for scoring</label>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t\t<div className=\"grid grid-cols-3 gap-2 items-center text-sm\">\r\n\t\t\t\t\t\t<select \r\n\t\t\t\t\t\t\tclassName=\"input col-span-2\"\r\n\t\t\t\t\t\t\tvalue={preferredCameraId || 'auto'}\r\n\t\t\t\t\t\t\tonChange={(e) => {\r\n\t\t\t\t\t\t\t\tconst val = e.target.value\r\n\t\t\t\t\t\t\t\tif (DROPDOWN_DEBUG) console.debug('[DevicePicker] select onChange', val, Date.now())\r\n\t\t\t\t\t\t\t\tif (val === 'auto') {\r\n\t\t\t\t\t\t\t\t\ttry { setPreferredCamera(undefined, '', true) } catch {}\r\n\t\t\t\t\t\t\t\t} else if (val === 'phone') {\r\n\t\t\t\t\t\t\t\t\ttry { setPreferredCamera(undefined, 'Phone Camera', true) } catch {}\r\n\t\t\t\t\t\t\t\t\ttry { setMode('phone'); setPhase('camera'); setStreaming(false); setSnapshotSet(false); } catch {}\r\n\t\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\t\tconst device = devices.find(d => d.deviceId === val)\r\n\t\t\t\t\t\t\t\t\tif (device) {\r\n\t\t\t\t\t\t\t\t\t\ttry { setPreferredCamera(device.deviceId, device.label || '', true) } catch {}\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t}}\r\n\t\t\t\t\t\t>\r\n\t\t\t\t\t\t\t<option value=\"auto\">Auto (browser default)</option>\r\n\t\t\t\t\t\t\t{devices.map(d => (\r\n\t\t\t\t\t\t\t\t<option key={d.deviceId} value={d.deviceId}>\r\n\t\t\t\t\t\t\t\t\t{d.label || 'Camera'}\r\n\t\t\t\t\t\t\t\t</option>\r\n\t\t\t\t\t\t\t))}\r\n\t\t\t\t\t\t\t<option value=\"phone\"> Phone Camera</option>\r\n\t\t\t\t\t\t</select>\r\n\t\t\t\t\t\t<div className=\"text-right\">\r\n\t\t\t\t\t\t\t<button className=\"btn px-2 py-1\" onClick={() => { testCamera(preferredCameraId || undefined); }} disabled={streaming}>Test</button>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t\t{preferredCameraLabel && (\r\n\t\t\t\t\t\t<div className=\"text-xs opacity-70 mt-1\">Selected: {preferredCameraLabel}</div>\r\n\t\t\t\t\t)}\r\n\t\t\t\t\t<div className=\"text-xs opacity-70 mt-1\">Tip: All camera technology is supported for autoscoring needsselect your camera here and then open Calibrator to align.</div>\r\n\t\t\t\t</div>\r\n\t\t\t)\r\n\t\tconst showMobileLanding = isMobileDevice && !mobileLandingOverride\r\n\r\n\t\tif (showMobileLanding) {\r\n\t\t\tconst linkForMobile = mobileLandingLink ?? (typeof window !== 'undefined' ? `${window.location.origin.replace(/\\/$/, '')}/mobile-cam.html` : '/mobile-cam.html')\r\n\t\t\treturn (\r\n\t\t\t\t<div className=\"mx-auto flex min-h-[calc(100vh-140px)] w-full max-w-xl flex-col justify-center gap-6 p-6\">\r\n\t\t\t\t\t<div className=\"space-y-5 rounded-3xl border border-indigo-400/30 bg-slate-900/70 p-6 text-slate-100 shadow-xl\">\r\n\t\t\t\t\t\t<div className=\"space-y-2\">\r\n\t\t\t\t\t\t\t<p className=\"text-xs font-semibold uppercase tracking-wide text-indigo-300\">Mobile camera</p>\r\n\t\t\t\t\t\t\t<h2 className=\"text-2xl font-semibold leading-tight text-white\">This device is ready to stream as your dartboard camera</h2>\r\n\t\t\t\t\t\t\t<p className=\"text-sm text-slate-200/80\">\r\n\t\t\t\t\t\t\t\tOpen the lightweight mobile camera page to stream video to your desktop calibrator. You can still come back here if you need the full desktop tools.\r\n\t\t\t\t\t\t\t</p>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t<div className=\"space-y-2\">\r\n\t\t\t\t\t\t\t<a\r\n\t\t\t\t\t\t\t\thref={linkForMobile}\r\n\t\t\t\t\t\t\t\tclassName=\"btn w-full justify-center px-4 py-2 text-base\"\r\n\t\t\t\t\t\t\t>\r\n\t\t\t\t\t\t\t\tOpen mobile camera\r\n\t\t\t\t\t\t\t</a>\r\n\t\t\t\t\t\t\t<button\r\n\t\t\t\t\t\t\t\ttype=\"button\"\r\n\t\t\t\t\t\t\t\tclassName=\"btn btn--ghost w-full justify-center px-4 py-2 text-sm\"\r\n\t\t\t\t\t\t\t\tonClick={() => copyValue(linkForMobile, 'link')}\r\n\t\t\t\t\t\t\t>\r\n\t\t\t\t\t\t\t\t{copyFeedback === 'link' ? 'Link copied!' : 'Copy link'}\r\n\t\t\t\t\t\t\t</button>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t<p className=\"text-xs text-slate-300/70\">\r\n\t\t\t\t\t\t\tOn a desktop, open Calibrator and generate a pairing code. Then tap <span className=\"font-semibold\">Pair with Desktop</span> from the mobile camera page to connect this device.\r\n\t\t\t\t\t\t</p>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t\t<button\r\n\t\t\t\t\t\ttype=\"button\"\r\n\t\t\t\t\t\tclassName=\"self-center text-xs font-medium text-indigo-200 underline decoration-dotted decoration-indigo-300/70 transition hover:text-indigo-100\"\r\n\t\t\t\t\t\tonClick={() => setMobileLandingOverride(true)}\r\n\t\t\t\t\t>\r\n\t\t\t\t\t\tContinue to desktop calibrator\r\n\t\t\t\t\t</button>\r\n\t\t\t\t</div>\r\n\t\t\t)\r\n\t\t}\r\n\r\n\t\treturn (\r\n\t\t\t<div className=\"space-y-6\">\r\n\t\t\t\t{isMobileDevice && mobileLandingOverride && (\r\n\t\t\t\t\t<div className=\"rounded-2xl border border-indigo-400/30 bg-indigo-500/10 p-4 text-sm text-indigo-100\">\r\n\t\t\t\t\t\t<div className=\"flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between\">\r\n\t\t\t\t\t\t\t<p className=\"leading-relaxed\">Using a phone? Switch back to the streamlined mobile camera interface for an easier pairing flow.</p>\r\n\t\t\t\t\t\t\t<button\r\n\t\t\t\t\t\t\t\ttype=\"button\"\r\n\t\t\t\t\t\t\t\tclassName=\"btn btn--ghost px-3 py-1 text-xs\"\r\n\t\t\t\t\t\t\t\tonClick={() => setMobileLandingOverride(false)}\r\n\t\t\t\t\t\t\t>\r\n\t\t\t\t\t\t\t\tOpen mobile camera mode\r\n\t\t\t\t\t\t\t</button>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t)}\r\n\t\t\t\t<div className=\"card space-y-6 p-6\">\r\n\t\t\t\t\t<header className=\"flex flex-wrap items-start justify-between gap-4\">\r\n\t\t\t\t\t\t<div className=\"space-y-2\">\r\n\t\t\t\t\t\t\t<p className=\"text-xs font-semibold uppercase tracking-wide text-indigo-300\">Marker calibration</p>\r\n\t\t\t\t\t\t\t<h2 className=\"text-2xl font-semibold leading-tight text-white\">Align your board with the autoscoring overlay</h2>\r\n\t\t\t\t\t\t\t<p className=\"max-w-2xl text-sm opacity-80\">\r\n\t\t\t\t\t\t\t\tPlace the printable fiducial markers around the double ring, capture a clear frame, and let the calibrator compute a precise homography.\r\n\t\t\t\t\t\t\t</p>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t<div className=\"flex flex-col items-end gap-2 text-xs font-medium\">\r\n\t\t\t\t\t\t\t<span className=\"inline-flex items-center gap-2 rounded-full border border-indigo-400/50 bg-indigo-500/10 px-3 py-1\">\r\n\t\t\t\t\t\t\t\t<span className=\"opacity-60\">Mode</span>\r\n\t\t\t\t\t\t\t\t<span>{mode === 'local' ? 'Desktop camera' : mode === 'phone' ? 'Phone camera' : 'Wifi device'}</span>\r\n\t\t\t\t\t\t\t</span>\r\n\t\t\t\t\t\t\t<span className={`inline-flex items-center gap-2 rounded-full border px-3 py-1 ${streaming ? 'border-emerald-400/60 bg-emerald-500/10 text-emerald-100' : 'border-white/20 bg-white/5 text-slate-200'}`}>\r\n\t\t\t\t\t\t\t\t<span className={`h-2 w-2 rounded-full ${streaming ? 'bg-emerald-400' : 'bg-slate-400'}`} />\r\n\t\t\t\t\t\t\t\t{streaming ? 'Live stream active' : 'Stream idle'}\r\n\t\t\t\t\t\t\t</span>\r\n\t\t\t\t\t\t\t{locked ? (\r\n\t\t\t\t\t\t\t\t<div className=\"space-y-3 rounded-2xl border border-emerald-400/40 bg-emerald-500/10 p-4 text-sm\">\r\n\t\t\t\t\t\t\t\t\t<div className=\"flex items-center justify-between gap-2\">\r\n\t\t\t\t\t\t\t\t\t\t<div className=\"flex items-center gap-3\">\r\n\t\t\t\t\t\t\t\t\t\t\t<div className=\"flex h-10 w-10 items-center justify-center rounded-full bg-emerald-500/20\"><span className=\"text-lg\"></span></div>\r\n\t\t\t\t\t\t\t\t\t\t\t<div>\r\n\t\t\t\t\t\t\t\t\t\t\t\t<h4 className=\"font-semibold text-emerald-100\">Calibration active</h4>\r\n\t\t\t\t\t\t\t\t\t\t\t\t<p className=\"text-xs opacity-80\">Your calibration is saved and active across all game modes. It will be used in Online, Offline, and Tournaments.</p>\r\n\t\t\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t\t\t<button className=\"btn btn--ghost px-2 py-1 text-xs whitespace-nowrap\" onClick={() => setCalibration({ locked: false })} title=\"Unlock to recalibrate\">Unlock</button>\r\n\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t\t{errorPx != null && <div className=\"text-xs opacity-75\">Precision: {errorPx.toFixed(2)} px RMS error</div>}\r\n\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t) : null}\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</header>\r\n\r\n\t\t\t\t\t<div className=\"grid gap-6 xl:grid-cols-[minmax(0,2fr)_minmax(320px,1fr)]\">\r\n\t\t\t\t\t\t<section className=\"space-y-4\">\r\n\t\t\t\t\t\t\t<div className=\"space-y-4 rounded-2xl border border-white/10 bg-black/40 p-4\">\r\n\t\t\t\t\t\t\t\t<div className=\"flex flex-wrap items-center justify-between gap-4 text-xs\">\r\n\t\t\t\t\t\t\t\t\t<div className=\"flex flex-wrap items-center gap-3\">\r\n\t\t\t\t\t\t\t\t\t\t<span className=\"uppercase tracking-wide opacity-60\">Video source</span>\r\n\t\t\t\t\t\t\t\t\t\t<div className=\"flex items-center gap-1\">\r\n\t\t\t\t\t\t\t\t\t\t\t<button\r\n\t\t\t\t\t\t\t\t\t\t\t\tclassName={`btn px-3 py-1 ${mode === 'local' ? 'bg-emerald-600 hover:bg-emerald-700' : 'bg-slate-700 hover:bg-slate-600'}`}\r\n\t\t\t\t\t\t\t\t\t\t\t\tonClick={() => { setMode('local'); stopCamera(false) }}\r\n\t\t\t\t\t\t\t\t\t\t\t\ttitle=\"Use local camera\"\r\n\t\t\t\t\t\t\t\t\t\t\t>\r\n\t\t\t\t\t\t\t\t\t\t\t\tLocal\r\n\t\t\t\t\t\t\t\t\t\t\t</button>\r\n\t\t\t\t\t\t\t\t\t\t\t<button\r\n\t\t\t\t\t\t\t\t\t\t\t\tclassName={`btn px-3 py-1 ${mode === 'phone' ? 'bg-emerald-600 hover:bg-emerald-700' : 'bg-slate-700 hover:bg-slate-600'}`}\r\n\t\t\t\t\t\t\t\t\t\t\t\tonClick={() => { setMode('phone'); stopCamera(false) }}\r\n\t\t\t\t\t\t\t\t\t\t\t\ttitle=\"Enable camera on this device\"\r\n\t\t\t\t\t\t\t\t\t\t\t>\r\n\t\t\t\t\t\t\t\t\t\t\t\tPhone\r\n\t\t\t\t\t\t\t\t\t\t\t</button>\r\n\t\t\t\t\t\t\t\t\t\t\t<button\r\n\t\t\t\t\t\t\t\t\t\t\t\tclassName={`btn px-3 py-1 ${mode === 'wifi' ? 'bg-emerald-600 hover:bg-emerald-700' : 'bg-slate-700 hover:bg-slate-600'}`}\r\n\t\t\t\t\t\t\t\t\t\t\t\tonClick={() => {\r\n\t\t\t\t\t\t\t\t\t\t\t\t\tsetMode('wifi')\r\n\t\t\t\t\t\t\t\t\t\t\t\t\tstopCamera(false)\r\n\t\t\t\t\t\t\t\t\t\t\t\t\tstartWifiConnection()\r\n\t\t\t\t\t\t\t\t\t\t\t\t}}\r\n\t\t\t\t\t\t\t\t\t\t\t\ttitle=\"Discover wifi/USB autoscoring devices\"\r\n\t\t\t\t\t\t\t\t\t\t\t>\r\n\t\t\t\t\t\t\t\t\t\t\t\tWifi\r\n\t\t\t\t\t\t\t\t\t\t\t</button>\r\n\t\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t\t<div className=\"flex flex-wrap items-center gap-3\">\r\n\t\t\t\t\t\t\t\t\t\t<div className=\"flex items-center gap-2\">\r\n\t\t\t\t\t\t\t\t\t\t\t<span className=\"opacity-70\">Zoom</span>\r\n\t\t\t\t\t\t\t\t\t\t\t<input\r\n\t\t\t\t\t\t\t\t\t\t\t\ttype=\"range\"\r\n\t\t\t\t\t\t\t\t\t\t\t\tmin={50}\r\n\t\t\t\t\t\t\t\t\t\t\t\tmax={200}\r\n\t\t\t\t\t\t\t\t\t\t\t\tstep={5}\r\n\t\t\t\t\t\t\t\t\t\t\t\tvalue={Math.round((zoom || 1) * 100)}\r\n\t\t\t\t\t\t\t\t\t\t\t\tonChange={e => setZoom(Math.max(0.5, Math.min(2, Number(e.target.value) / 100)))}\r\n\t\t\t\t\t\t\t\t\t\t\t/>\r\n\t\t\t\t\t\t\t\t\t\t\t<span className=\"w-12 text-right\">{Math.round((zoom || 1) * 100)}%</span>\r\n\t\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t\t\t<button className=\"btn px-3 py-1\" onClick={() => setZoom(1)}>Actual</button>\r\n\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t</div>\r\n\r\n\t\t\t\t\t\t\t\t<div\r\n\t\t\t\t\t\t\t\t\tclassName=\"relative w-full overflow-hidden rounded-2xl border border-indigo-400/30 bg-black\"\r\n\t\t\t\t\t\t\t\t\tstyle={{ aspectRatio: frameSize ? `${frameSize.w} / ${frameSize.h}` : '16 / 9' }}\r\n\t\t\t\t\t\t\t\t>\r\n\t\t\t\t\t\t\t\t\t{(mode === 'phone' ? (!streaming || !paired) : !streaming) && (\r\n\t\t\t\t\t\t\t\t\t\t<div className=\"absolute inset-0 z-20 flex items-center justify-center bg-gradient-to-br from-black/40 to-black/10\">\r\n\t\t\t\t\t\t\t\t\t\t\t<DartLoader calibrationComplete={phase === 'computed'} />\r\n\t\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t\t)}\r\n\t\t\t\t\t\t\t\t\t<div className=\"absolute inset-0\" style={{ transform: `scale(${zoom || 1})`, transformOrigin: 'center center' }}>\r\n\t\t\t\t\t\t\t\t\t\t<video\r\n\t\t\t\t\t\t\t\t\t\t\tref={videoRef}\r\n\t\t\t\t\t\t\t\t\t\t\tonLoadedMetadata={(ev) => {\r\n\t\t\t\t\t\t\t\t\t\t\t\ttry {\r\n\t\t\t\t\t\t\t\t\t\t\t\t\tconst v = ev.currentTarget as HTMLVideoElement\r\n\t\t\t\t\t\t\t\t\t\t\t\t\tif (v.videoWidth && v.videoHeight) setFrameSize({ w: v.videoWidth, h: v.videoHeight })\r\n\t\t\t\t\t\t\t\t\t\t\t\t} catch {}\r\n\t\t\t\t\t\t\t\t\t\t\t}}\r\n\t\t\t\t\t\t\t\t\t\t\tclassName={`absolute inset-0 h-full w-full object-cover transition-opacity duration-300 ${snapshotSet ? 'opacity-0 -z-10' : 'opacity-100 z-10'}`}\r\n\t\t\t\t\t\t\t\t\t\t\tautoPlay\r\n\t\t\t\t\t\t\t\t\t\t\tplaysInline\r\n\t\t\t\t\t\t\t\t\t\t\tmuted\r\n\t\t\t\t\t\t\t\t\t\t\tcontrols={false}\r\n\t\t\t\t\t\t\t\t\t\t/>\r\n\t\t\t\t\t\t\t\t\t\t{videoPlayBlocked && (\r\n\t\t\t\t\t\t\t\t\t\t\t<div className=\"absolute inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur\">\r\n\t\t\t\t\t\t\t\t\t\t\t\t<button\r\n\t\t\t\t\t\t\t\t\t\t\t\t\tclassName=\"rounded-lg bg-white px-4 py-2 font-semibold text-slate-900 shadow-lg\"\r\n\t\t\t\t\t\t\t\t\t\t\t\t\tonClick={async () => {\r\n\t\t\t\t\t\t\t\t\t\t\t\t\ttry {\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tawait videoRef.current?.play()\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tsetVideoPlayBlocked(false)\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tsetStreaming(true)\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tsetPhase('capture')\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t} catch (e) {\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tconsole.warn('Tap-to-play retry failed', e)\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\talert('Tap to enable video failed. Please check browser settings or reload the page.')\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\t\t\t}}\r\n\t\t\t\t\t\t\t\t\t\t\t\t>\r\n\t\t\t\t\t\t\t\t\t\t\t\t\tTap to allow video\r\n\t\t\t\t\t\t\t\t\t\t\t\t</button>\r\n\t\t\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t\t\t)}\r\n\t\t\t\t\t\t\t\t\t\t<canvas ref={canvasRef} className={`absolute inset-0 h-full w-full transition-opacity duration-300 ${snapshotSet ? 'opacity-100 z-10' : 'opacity-0 -z-10'}`} />\r\n\t\t\t\t\t\t\t\t\t\t<canvas ref={overlayRef} onClick={onClickOverlay} className=\"absolute inset-0 z-30 h-full w-full cursor-crosshair\" />\r\n\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t</div>\r\n\r\n\t\t\t\t\t\t\t\t<label className=\"flex items-center gap-2 text-xs\">\r\n\t\t\t\t\t\t\t\t\t<input type=\"checkbox\" className=\"accent-indigo-600\" checked={calibrationGuide} onChange={e => setCalibrationGuide(e.target.checked)} />\r\n\t\t\t\t\t\t\t\t\tShow preferred-view guide overlay\r\n\t\t\t\t\t\t\t\t</label>\r\n\r\n\t\t\t\t\t\t\t\t{/* Stage cards in the main free space  quick access to the three calibration stages */}\r\n\t\t\t\t\t\t\t\t<div className=\"mt-4 grid grid-cols-1 gap-3 sm:grid-cols-3 overflow-visible\">\r\n\t\t\t\t\t\t\t\t\t<div className=\"rounded-2xl border border-white/10 bg-white/5 p-4 overflow-visible\">\r\n\t\t\t\t\t\t\t\t\t\t<h3 className=\"text-sm font-semibold\">Stage 1  Capture</h3>\r\n\t\t\t\t\t\t\t\t\t\t<p className=\"text-xs opacity-70\">Start your camera or upload a photo to capture the board.</p>\r\n\t\t\t\t\t\t\t\t\t\t<div className=\"mt-3 flex flex-col gap-2\">\r\n\t\t\t\t\t\t\t\t\t\t\t{mode === 'local' && <button className=\"btn\" onClick={startCamera}>Enable camera</button>}\r\n\t\t\t\t\t\t\t\t\t\t\t{mode === 'phone' && <button className=\"btn\" title=\"Enable camera on this device\" onClick={() => { try { window.dispatchEvent(new CustomEvent('ndn:start-camera', { detail: { mode: 'phone' } })) } catch { startPhonePairing() } }}>Enable camera</button>}\r\n\t\t\t\t\t\t\t\t\t\t\t{mode === 'wifi' && <button className=\"btn\" onClick={startWifiConnection}>Connect wifi camera</button>}\r\n\t\t\t\t\t\t\t\t\t\t\t<button className=\"btn\" onClick={captureFrame} disabled={!streaming}>Capture frame</button>\r\n\t\t\t\t\t\t\t\t\t\t\t<button className=\"btn\" onClick={triggerUpload}>Upload photo</button>\r\n\t\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t\t</div>\r\n\r\n\t\t\t\t\t\t\t\t\t<div className=\"rounded-2xl border border-white/10 bg-white/5 p-4\">\r\n\t\t\t\t\t\t\t\t\t\t<h3 className=\"text-sm font-semibold\">Stage 2  Auto-Calibrate</h3>\r\n\t\t\t\t\t\t\t\t\t\t<p className=\"text-xs opacity-70\">Automatically detect dartboard rings and compute calibration without any markers or clicking.</p>\r\n\t\t\t\t\t\t\t\t\t\t<div className=\"mt-3 flex flex-col gap-2\">\r\n\t\t\t\t\t\t\t\t\t\t\t<button className=\"btn bg-emerald-600 hover:bg-emerald-700 font-semibold\" disabled={!snapshotSet || autoCalibrating} onClick={autoCalibrate}>{autoCalibrating ? 'Auto-calibrating' : ' Auto-Calibrate (Advanced)'}</button>\r\n\t\t\t\t\t\t\t\t\t\t\t<button className=\"btn\" disabled={!snapshotSet} onClick={autoDetectRings}>Legacy: Auto detect rings</button>\r\n\t\t\t\t\t\t\t\t\t\t\t  {/* Removed Legacy marker buttons per request */}\r\n\t\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t\t\t<div className=\"mt-2 text-xs opacity-70\">Confidence: {forceConfidence ? 100 : confidence}%</div>\r\n\t\t\t\t\t\t\t\t\t\t<div className=\"mt-2 text-xs opacity-70 flex items-center gap-2\">\r\n\t\t\t\t\t\t\t\t\t\t\t<label className=\"flex items-center gap-2\">\r\n\t\t\t\t\t\t\t\t\t\t\t\t<input type=\"checkbox\" className=\"accent-indigo-600\" checked={forceConfidence} onChange={e => setForceConfidence(e.target.checked)} />\r\n\t\t\t\t\t\t\t\t\t\t\t\t<span className=\"text-xs\">Force 100% Confidence</span>\r\n\t\t\t\t\t\t\t\t\t\t\t</label>\r\n\t\t\t\t\t\t\t\t\t\t\t{forceConfidence && <span className=\"text-xs text-yellow-300\"> For testing only  may produce mis-registrations</span>}\r\n\t\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t\t</div>\r\n\r\n\t\t\t\t\t\t\t\t\t<div className=\"rounded-2xl border border-white/10 bg-white/5 p-4\">\r\n\t\t\t\t\t\t\t\t\t\t<h3 className=\"text-sm font-semibold\">Stage 3  Align & lock</h3>\r\n\t\t\t\t\t\t\t\t\t\t<p className=\"text-xs opacity-70\">Click the board points, refine edges and lock calibration when satisfied.</p>\r\n\t\t\t\t\t\t\t\t\t\t<div className=\"mt-3 flex flex-col gap-2\">\r\n\t\t\t\t\t\t\t\t\t\t\t<button className=\"btn\" disabled={dstPoints.length < 4} onClick={compute}>Compute</button>\r\n\t\t\t\t\t\t\t\t\t\t\t<button className={`btn ${locked ? 'bg-emerald-600 hover:bg-emerald-700' : ''}`} onClick={() => setCalibration({ locked: !locked })}>{locked ? 'Unlock' : 'Lock in'}</button>\r\n\t\t\t\t\t\t\t\t\t\t\t<button className=\"btn\" onClick={() => runVerification()}>Verify</button>\r\n\t\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t</div>\r\n\r\n\t\t\t\t\t\t\t{/* Pro tip section */}\r\n\t\t\t\t\t\t\t<div className=\"mt-4 rounded-lg border border-blue-500/30 bg-blue-500/10 p-3\">\r\n\t\t\t\t\t\t\t\t<div className=\"text-xs font-semibold text-blue-300 mb-1\"> Pro Tip for Perfect Calibration</div>\r\n\t\t\t\t\t\t\t\t<div className=\"text-xs opacity-80\">Click the 4 corners of the double ring at <span className=\"font-semibold\">D20, D6, D3, and D11</span>, then click the <span className=\"font-semibold\">center bull</span>. This evenly-spaced layout provides the most accurate calibration.</div>\r\n\t\t\t\t\t\t\t</div>\r\n\r\n\t\t\t\t\t\t\t<div className=\"grid grid-cols-1 gap-3 text-xs sm:grid-cols-3\">\r\n\t\t\t\t\t\t\t\t<div className=\"rounded-xl border border-white/10 bg-white/5 px-3 py-2\">\r\n\t\t\t\t\t\t\t\t\t<div className=\"uppercase tracking-wide opacity-60\">Phase</div>\r\n\t\t\t\t\t\t\t\t\t<div className=\"text-sm font-semibold capitalize\">{phase}</div>\r\n\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t<div className=\"rounded-xl border border-white/10 bg-white/5 px-3 py-2\">\r\n\t\t\t\t\t\t\t\t\t<div className=\"uppercase tracking-wide opacity-60\">Points selected</div>\r\n\t\t\t\t\t\t\t\t\t<div className=\"text-sm font-semibold\">{dstPoints.length} / 5</div>\r\n\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t<div className=\"rounded-xl border border-white/10 bg-white/5 px-3 py-2\">\r\n\t\t\t\t\t\t\t\t\t<div className=\"uppercase tracking-wide opacity-60\">Fit error</div>\r\n\t\t\t\t\t\t\t\t\t<div className=\"text-sm font-semibold\">{errorPx != null ? `${errorPx.toFixed(2)} px` : ''}</div>\r\n\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t</section>\r\n\r\n\t\t\t\t\t\t<aside className=\"space-y-4\">\r\n\t\t\t\t\t\t\t<DevicePicker />\r\n\r\n\t\t\t\t\t\t\t{mode === 'phone' && (\r\n\t\t\t\t\t\t\t\t<section className=\"space-y-3 rounded-2xl border border-indigo-400/30 bg-black/40 p-4 text-xs text-white\">\r\n\t\t\t\t\t\t\t\t\t<div className=\"font-semibold\">Phone pairing</div>\r\n\t\t\t\t\t\t\t\t\t<button\r\n\t\t\t\t\t\t\t\t\t\ttype=\"button\"\r\n\t\t\t\t\t\t\t\t\t\tclassName=\"w-full text-left px-3 py-2 rounded-lg border border-white/10 bg-white/5 hover:bg-white/10 transition flex items-center gap-2\"\r\n\t\t\t\t\t\t\t\t\t\tonClick={() => copyValue(mobileUrl, 'link')}\r\n\t\t\t\t\t\t\t\t\t\ttitle=\"Copy mobile camera link\"\r\n\t\t\t\t\t\t\t\t\t>\r\n\t\t\t\t\t\t\t\t\t\t<span className=\"flex-1 min-w-0 font-mono break-all text-[11px]\">{mobileUrl}</span>\r\n\t\t\t\t\t\t\t\t\t\t<span className=\"text-[10px] uppercase tracking-wide whitespace-nowrap text-emerald-200\">{copyFeedback === 'link' ? 'Copied!' : 'Copy link'}</span>\r\n\t\t\t\t\t\t\t\t\t</button>\r\n\t\t\t\t\t\t\t\t\t<div className=\"flex items-center gap-2 text-[11px]\">\r\n\t\t\t\t\t\t\t\t\t\t<a href={mobileUrl} target=\"_blank\" rel=\"noreferrer\" className=\"underline decoration-dotted text-indigo-200 hover:text-indigo-100 transition\">\r\n\t\t\t\t\t\t\t\t\t\t\tOpen link in new tab\r\n\t\t\t\t\t\t\t\t\t\t</a>\r\n\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t\t<div className=\"opacity-80\">\r\n\t\t\t\t\t\t\t\t\t\tWS: {ws ? (ws.readyState === 1 ? 'open' : ws.readyState === 0 ? 'connecting' : ws.readyState === 2 ? 'closing' : 'closed') : 'not started'}  {httpsInfo?.https ? 'HTTPS on' : 'HTTP only'}\r\n\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t\t{pairCode && (\r\n\t\t\t\t\t\t\t\t\t\t<button\r\n\t\t\t\t\t\t\t\t\t\t\ttype=\"button\"\r\n\t\t\t\t\t\t\t\t\t\t\tclassName=\"w-full text-left px-3 py-2 rounded-lg border border-white/10 bg-white/5 hover:bg-white/10 transition flex items-center justify-between gap-2\"\r\n\t\t\t\t\t\t\t\t\t\t\tonClick={() => copyValue(pairCode, 'code')}\r\n\t\t\t\t\t\t\t\t\t\t\ttitle=\"Copy pairing code\"\r\n\t\t\t\t\t\t\t\t\t\t>\r\n\t\t\t\t\t\t\t\t\t\t\t<span className=\"font-mono tracking-[0.3em] text-sm\">{pairCode}</span>\r\n\t\t\t\t\t\t\t\t\t\t\t<span className=\"text-[10px] uppercase tracking-wide whitespace-nowrap text-emerald-200\">{copyFeedback === 'code' ? 'Copied!' : 'Copy code'}</span>\r\n\t\t\t\t\t\t\t\t\t\t</button>\r\n\t\t\t\t\t\t\t\t\t)}\r\n\t\t\t\t\t\t\t\t\t{qrDataUrl && <img className=\"mt-1 h-40 w-40 bg-white\" alt=\"Scan to open\" src={qrDataUrl} />}\r\n\t\t\t\t\t\t\t\t\t<div className=\"flex items-center gap-2\">\r\n\t\t\t\t\t\t\t\t\t\t{ttl !== null && <span>Expires in {ttl}s</span>}\r\n\t\t\t\t\t\t\t\t\t\t<button className=\"btn px-2 py-1 text-xs\" onClick={regenerateCode}>Regenerate</button>\r\n\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t\t{showTips && (\r\n\t\t\t\t\t\t\t\t\t\t<div className=\"space-y-2 rounded-lg border border-slate-700/50 bg-slate-900/60 p-3 text-slate-200\">\r\n\t\t\t\t\t\t\t\t\t\t\t<div className=\"font-semibold\">Troubleshooting</div>\r\n\t\t\t\t\t\t\t\t\t\t\t<ul className=\"list-disc space-y-1 pl-4\">\r\n\t\t\t\t\t\t\t\t\t\t\t\t<li>Phone and desktop must be on the same WiFi network.</li>\r\n\t\t\t\t\t\t\t\t\t\t\t\t<li>Allow the server through your firewall (ports 8787 and {httpsInfo?.https ? httpsInfo.port : 8788}).</li>\r\n\t\t\t\t\t\t\t\t\t\t\t\t<li>On iPhone, use HTTPS links (QR will prefer HTTPS when enabled).</li>\r\n\t\t\t\t\t\t\t\t\t\t\t</ul>\r\n\t\t\t\t\t\t\t\t\t\t\t<div className=\"text-right\">\r\n\t\t\t\t\t\t\t\t\t\t\t\t<button className=\"btn btn--ghost px-2 py-1 text-xs\" onClick={() => setShowTips(false)}>Hide tips</button>\r\n\t\t\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t\t)}\r\n\t\t\t\t\t\t\t\t</section>\r\n\t\t\t\t\t\t\t)}\r\n\r\n\t\t\t\t\t\t\t{/* Sidebar Step cards intentionally removed  these controls remain available in the main stage cards above to avoid showing duplicate controls in the right-hand sidebar. */}\r\n\t\t\t\t\t\t</aside>\r\n\t\t\t\t\t</div>\r\n\r\n\t\t\t\t\t{mode === 'wifi' && !streaming && (\r\n\t\t\t\t\t\t<div className=\"space-y-3 rounded-2xl border border-indigo-400/30 bg-black/40 p-4 text-xs text-white\">\r\n\t\t\t\t\t\t\t<div className=\"font-semibold\">Wifi scoring devices</div>\r\n\t\t\t\t\t\t\t{discoveringWifi ? (\r\n\t\t\t\t\t\t\t\t<div className=\"flex items-center gap-2\">\r\n\t\t\t\t\t\t\t\t\t<div className=\"h-4 w-4 animate-spin rounded-full border-b-2 border-white\" />\r\n\t\t\t\t\t\t\t\t\t<span>Scanning network for devices</span>\r\n\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t) : wifiDevices.length > 0 ? (\r\n\t\t\t\t\t\t\t\t<div className=\"space-y-2\">\r\n\t\t\t\t\t\t\t\t\t{wifiDevices.map(device => (\r\n\t\t\t\t\t\t\t\t\t\t<div key={device.id} className=\"flex items-center justify-between rounded border border-slate-700/50 bg-slate-900/60 p-2\">\r\n\t\t\t\t\t\t\t\t\t\t\t<div>\r\n\t\t\t\t\t\t\t\t\t\t\t\t<div className=\"font-medium\">{device.name}</div>\r\n\t\t\t\t\t\t\t\t\t\t\t\t<div className=\"opacity-70\">{device.ip}:{device.port}  {device.type.toUpperCase()}</div>\r\n\t\t\t\t\t\t\t\t\t\t\t\t<div className=\"opacity-70 text-xs\">Capabilities: {device.capabilities.join(', ')}</div>\r\n\t\t\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t\t\t\t<button\r\n\t\t\t\t\t\t\t\t\t\t\t\tclassName={`btn px-2 py-1 text-xs ${device.status === 'connecting' ? 'bg-yellow-600' : device.status === 'online' ? 'bg-green-600' : 'bg-blue-600'}`}\r\n\t\t\t\t\t\t\t\t\t\t\t\tonClick={() => connectToWifiDevice(device)}\r\n\t\t\t\t\t\t\t\t\t\t\t\tdisabled={device.status === 'connecting'}\r\n\t\t\t\t\t\t\t\t\t\t\t>\r\n\t\t\t\t\t\t\t\t\t\t\t\t{device.status === 'connecting' ? 'Connecting' : 'Connect'}\r\n\t\t\t\t\t\t\t\t\t\t\t</button>\r\n\t\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t\t))}\r\n\t\t\t\t\t\t\t\t\t<div className=\"text-center\">\r\n\t\t\t\t\t\t\t\t\t\t<button className=\"btn px-2 py-1 text-xs\" onClick={startWifiConnection}>Rescan network</button>\r\n\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t) : (\r\n\t\t\t\t\t\t\t\t<div className=\"space-y-2 text-center\">\r\n\t\t\t\t\t\t\t\t\t<div>No wifi scoring devices found.</div>\r\n\t\t\t\t\t\t\t\t\t<div className=\"opacity-70\">Ensure your wifi cameras are powered on and on the same network.</div>\r\n\t\t\t\t\t\t\t\t\t<button className=\"btn px-2 py-1 text-xs\" onClick={startWifiConnection}>Scan again</button>\r\n\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t)}\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t)}\r\n\t\t\t\t</div>\r\n\t\t\t</div>\r\n\t\t)\r\n}\r\n","import { create } from 'zustand'\r\n\r\ntype Toast = { id: number; message: string; type?: 'info'|'success'|'error'; timeout?: number }\r\n\r\ntype ToastState = {\r\n  toasts: Toast[]\r\n  push: (message: string, opts?: { type?: 'info'|'success'|'error'; timeout?: number }) => void\r\n  remove: (id: number) => void\r\n  clear: () => void\r\n}\r\n\r\nlet nextId = 1\r\n\r\nexport const useToastStore = create<ToastState>((set) => ({\r\n  toasts: [],\r\n  push: (message, opts) => set((s) => {\r\n    const id = nextId++\r\n    const t: Toast = { id, message, type: opts?.type || 'info', timeout: opts?.timeout ?? 3000 }\r\n    // auto-remove after timeout\r\n    if (t.timeout && t.timeout > 0) {\r\n      setTimeout(() => {\r\n        set((cur) => ({ toasts: cur.toasts.filter(x => x.id !== id) }))\r\n      }, t.timeout)\r\n    }\r\n    return { toasts: [...s.toasts, t] }\r\n  }),\r\n  remove: (id) => set((s) => ({ toasts: s.toasts.filter(t => t.id !== id) })),\r\n  clear: () => set({ toasts: [] }),\r\n}))\r\n\r\nexport function useToast() {\r\n  const push = useToastStore(s => s.push)\r\n  return push\r\n}\r\n","import { useToastStore } from '../store/toast'\r\n\r\nexport default function Toaster() {\r\n  const toasts = useToastStore(s => s.toasts)\r\n  const remove = useToastStore(s => s.remove)\r\n  if (!toasts.length) return null\r\n  return (\r\n    <>\r\n      {/* Success messages centered */}\r\n      {toasts.filter(t => t.type === 'success').map(t => (\r\n        <div key={t.id} className=\"fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-50\">\r\n          <div className={`p-4 rounded-lg shadow-lg border text-sm bg-emerald-700/90 border-emerald-500/60 text-white max-w-sm text-center`}>\r\n            <div className=\"flex items-center justify-center gap-2\">\r\n              <span className=\"flex-1 font-semibold\">{t.message}</span>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      ))}\r\n      {/* Other messages bottom right */}\r\n      {toasts.filter(t => t.type !== 'success').length > 0 && (\r\n        <div className=\"fixed bottom-4 right-4 z-50 space-y-2 sm:right-4 sm:left-auto left-1/2 -translate-x-1/2 sm:translate-x-0 w-[calc(100%-1.5rem)] sm:w-auto max-w-sm\">\r\n          {toasts.filter(t => t.type !== 'success').map(t => (\r\n            <div key={t.id} className={`p-3 rounded-lg shadow-lg border text-sm ${\r\n              t.type === 'error' ? 'bg-rose-700/80 border-rose-500/60 text-white' :\r\n              'bg-black/70 border-slate-700 text-slate-100'\r\n            }`}>\r\n              <div className=\"flex items-center gap-2\">\r\n                <span className=\"flex-1\">{t.message}</span>\r\n                <button className=\"btn btn--ghost px-2 py-1 text-xs\" onClick={()=>remove(t.id)}>Dismiss</button>\r\n              </div>\r\n            </div>\r\n          ))}\r\n        </div>\r\n      )}\r\n    </>\r\n  )\r\n}\r\n","import React from 'react'\r\n\r\ntype Datum = { label: string | number; value: number }\r\n\r\nexport default function BarChart({\r\n  data,\r\n  height = 220,\r\n  barWidth = 28,\r\n  gap = 6,\r\n  showValues = false,\r\n}: {\r\n  data: Datum[]\r\n  height?: number\r\n  barWidth?: number\r\n  gap?: number\r\n  showValues?: boolean\r\n}) {\r\n  const max = Math.max(1, ...data.map(d => d.value))\r\n  const totalWidth = data.length * (barWidth + gap)\r\n  return (\r\n    <div className=\"w-full overflow-x-auto\">\r\n      <div className=\"relative\" style={{ height, width: Math.max(600, totalWidth) }}>\r\n        <div className=\"absolute inset-0 flex items-end\">\r\n          {data.map((d, i) => {\r\n            const h = Math.round((d.value / max) * (height - 40)) // leave room for labels\r\n            return (\r\n              <div key={i} className=\"flex flex-col items-center justify-end\" style={{ width: barWidth, marginRight: gap }}>\r\n                <div\r\n                  className=\"w-full rounded-t-md bg-gradient-to-b from-indigo-400 to-fuchsia-500 shadow-sm\"\r\n                  style={{ height: h }}\r\n                  title={`${d.label}: ${d.value}`}\r\n                />\r\n                {showValues && <div className=\"text-[10px] mt-1 text-indigo-200 font-semibold\">{d.value}</div>}\r\n                <div className=\"text-[10px] mt-1 text-slate-200 font-medium select-none\">{d.label}</div>\r\n              </div>\r\n            )\r\n          })}\r\n        </div>\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n","import React from 'react'\r\n\r\ntype Tab = { key: string; label: string }\r\n\r\nexport default function TabPills({\r\n  tabs,\r\n  active,\r\n  onChange,\r\n  className,\r\n}: {\r\n  tabs: Tab[];\r\n  active: string;\r\n  onChange: (key: string) => void;\r\n  className?: string;\r\n}) {\r\n  return (\r\n    <div className={`relative ${className || ''}`}>\r\n      {/* subtle backdrop and border for contrast on mobile */}\r\n      <div className=\"absolute inset-0 rounded-xl bg-white/5 backdrop-blur-md border border-white/10 pointer-events-none\" />\r\n      <div className=\"relative overflow-x-auto no-scrollbar py-1 px-1\">\r\n        <div className=\"flex items-center gap-2 min-w-max\">\r\n          {tabs.map((t) => {\r\n            const isActive = t.key === active\r\n            return (\r\n              <button\r\n                key={t.key}\r\n                type=\"button\"\r\n                onClick={() => onChange(t.key)}\r\n                className={`transition-all select-none whitespace-nowrap rounded-full px-4 py-2 text-sm font-semibold shadow-sm focus:outline-none focus-visible:ring-2 focus-visible:ring-white/60 active:scale-[0.98]\r\n                  ${isActive\r\n                    ? 'bg-gradient-to-r from-indigo-500 to-fuchsia-500 text-white shadow-indigo-500/30'\r\n                    : 'bg-white/10 text-slate-100 hover:bg-white/15'}\r\n                `}\r\n                aria-pressed={isActive}\r\n              >\r\n                {t.label}\r\n              </button>\r\n            )\r\n          })}\r\n        </div>\r\n      </div>\r\n      <style>{`\r\n        /* Hide scrollbars on WebKit/Firefox for a cleaner pill row */\r\n        .no-scrollbar::-webkit-scrollbar { display: none; }\r\n        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }\r\n      `}</style>\r\n    </div>\r\n  )\r\n}\r\n","export type AllTimeTotals = {\r\n  darts: number\r\n  scored: number\r\n  fnDarts?: number\r\n  fnScored?: number\r\n  // All-time quality metrics\r\n  best3?: number // highest 3-dart avg achieved in a finished leg\r\n  worst3?: number // lowest 3-dart avg achieved in a finished leg\r\n  bestLegDarts?: number // fewest darts to finish a winning leg\r\n  bestCheckout?: number // highest checkout score achieved\r\n  worstLegDarts?: number // most darts in a winning leg (optional)\r\n  bestFNAvg?: number // best per-leg first-nine average\r\n  worstFNAvg?: number // worst per-leg first-nine average\r\n}\r\ntype StatEntry = { t: number; darts: number; scored: number; fnDarts?: number; fnScored?: number }\r\nexport type GameModeStat = { played: number; won: number }\r\nexport type GameModeStats = Record<string, GameModeStat>\r\n\r\nconst keyFor = (name: string) => `ndn_stats_${name}`\r\nconst keySeriesFor = (name: string) => `ndn_stats_ts_${name}`\r\nconst keyDailyFor = (name: string) => `ndn_stats_daily_${name}`\r\n\r\nexport function getAllTime(name: string): AllTimeTotals {\r\n  try {\r\n    const raw = localStorage.getItem(keyFor(name))\r\n    if (!raw) return { darts: 0, scored: 0 }\r\n    const parsed = JSON.parse(raw)\r\n    return {\r\n      darts: Number(parsed.darts) || 0,\r\n      scored: Number(parsed.scored) || 0,\r\n      fnDarts: Number(parsed.fnDarts) || 0,\r\n      fnScored: Number(parsed.fnScored) || 0,\r\n      best3: typeof parsed.best3 === 'number' ? parsed.best3 : 0,\r\n      worst3: typeof parsed.worst3 === 'number' ? parsed.worst3 : 0,\r\n      bestLegDarts: typeof parsed.bestLegDarts === 'number' ? parsed.bestLegDarts : 0,\r\n      bestCheckout: typeof parsed.bestCheckout === 'number' ? parsed.bestCheckout : 0,\r\n      worstLegDarts: typeof parsed.worstLegDarts === 'number' ? parsed.worstLegDarts : 0,\r\n      bestFNAvg: typeof parsed.bestFNAvg === 'number' ? parsed.bestFNAvg : 0,\r\n      worstFNAvg: typeof parsed.worstFNAvg === 'number' ? parsed.worstFNAvg : 0,\r\n    }\r\n  } catch {\r\n    return { darts: 0, scored: 0 }\r\n  }\r\n}\r\n\r\nexport function setAllTime(name: string, totals: AllTimeTotals) {\r\n  try {\r\n    localStorage.setItem(keyFor(name), JSON.stringify(totals))\r\n    window.dispatchEvent(new CustomEvent('ndn:stats-updated', { detail: { name, totals } }))\r\n  } catch {}\r\n}\r\n\r\n// Clear all stored stats for a user (all-time totals, time-series, and daily snapshot)\r\nexport function clearAllStats(name: string) {\r\n  try {\r\n    localStorage.removeItem(keyFor(name))\r\n    localStorage.removeItem(keySeriesFor(name))\r\n    localStorage.removeItem(keyDailyFor(name))\r\n  } catch {}\r\n  try {\r\n    window.dispatchEvent(new CustomEvent('ndn:stats-updated', { detail: { name, cleared: true } }))\r\n  } catch {}\r\n}\r\n\r\nexport function getAllTimeAvg(name: string): number {\r\n  const { darts, scored } = getAllTime(name)\r\n  if (!darts) return 0\r\n  return (scored / darts) * 3\r\n}\r\n\r\nexport function getAllTimeFirstNineAvg(name: string): number {\r\n  const { fnDarts = 0, fnScored = 0 } = getAllTime(name)\r\n  if (!fnDarts) return 0\r\n  return (fnScored / fnDarts) * 3\r\n}\r\n\r\n// All-time quality metric getters\r\nexport function getAllTimeBestWorst(name: string): { best3: number; worst3: number } {\r\n  const { best3 = 0, worst3 = 0 } = getAllTime(name)\r\n  return { best3, worst3 }\r\n}\r\nexport function getAllTimeBestLeg(name: string): number {\r\n  const { bestLegDarts = 0 } = getAllTime(name)\r\n  return bestLegDarts || 0\r\n}\r\nexport function getAllTimeBestCheckout(name: string): number {\r\n  const { bestCheckout = 0 } = getAllTime(name)\r\n  return bestCheckout || 0\r\n}\r\n\r\n// --- Per-game-mode played/won stats (local-only demo) ---\r\nconst keyGameModes = 'ndn_game_mode_stats'\r\n\r\nexport function getGameModeStats(allModeKeys?: string[]): GameModeStats {\r\n  let obj: GameModeStats = {}\r\n  try {\r\n    const raw = localStorage.getItem(keyGameModes)\r\n    if (raw) obj = JSON.parse(raw)\r\n  } catch {}\r\n  // Ensure requested keys exist with zeros so charts are stable\r\n  if (Array.isArray(allModeKeys)) {\r\n    for (const k of allModeKeys) {\r\n      if (!obj[k]) obj[k] = { played: 0, won: 0 }\r\n    }\r\n  }\r\n  return obj\r\n}\r\n\r\nexport function setGameModeStats(stats: GameModeStats) {\r\n  try {\r\n    localStorage.setItem(keyGameModes, JSON.stringify(stats))\r\n    window.dispatchEvent(new CustomEvent('ndn:stats-updated', { detail: { gameModes: true } }))\r\n  } catch {}\r\n}\r\n\r\nexport function bumpGameMode(mode: string, won: boolean) {\r\n  const current = getGameModeStats()\r\n  const entry = current[mode] || { played: 0, won: 0 }\r\n  entry.played += 1\r\n  if (won) entry.won += 1\r\n  current[mode] = entry\r\n  setGameModeStats(current)\r\n}\r\n\r\n// Time-series helpers for rolling averages\r\nfunction getSeries(name: string): StatEntry[] {\r\n  try {\r\n    const raw = localStorage.getItem(keySeriesFor(name))\r\n    if (!raw) return []\r\n    const arr = JSON.parse(raw)\r\n    if (!Array.isArray(arr)) return []\r\n    return arr.map((e: any) => ({\r\n      t: Number(e.t)||0,\r\n      darts: Number(e.darts)||0,\r\n      scored: Number(e.scored)||0,\r\n      fnDarts: Number(e.fnDarts)||0,\r\n      fnScored: Number(e.fnScored)||0,\r\n    })).filter(e => e.t > 0)\r\n  } catch { return [] }\r\n}\r\n\r\nfunction setSeries(name: string, entries: StatEntry[]) {\r\n  try {\r\n    localStorage.setItem(keySeriesFor(name), JSON.stringify(entries))\r\n    window.dispatchEvent(new CustomEvent('ndn:stats-updated', { detail: { name } }))\r\n  } catch {}\r\n}\r\n\r\nfunction pruneOld(entries: StatEntry[], maxAgeMs: number): StatEntry[] {\r\n  const now = Date.now()\r\n  return entries.filter(e => now - e.t <= maxAgeMs)\r\n}\r\n\r\nexport function addSample(name: string, darts: number, scored: number, when: number = Date.now(), fnDarts?: number, fnScored?: number) {\r\n  if (darts <= 0) return\r\n  const list = getSeries(name)\r\n  const next = pruneOld([...list, { t: when, darts, scored, fnDarts, fnScored }], 1000 * 60 * 60 * 24 * 30) // keep ~30 days\r\n  setSeries(name, next)\r\n}\r\n\r\nexport function getRollingAvg(name: string, windowMs: number = 1000 * 60 * 60 * 24): number {\r\n  const list = getSeries(name)\r\n  if (!list.length) return 0\r\n  const now = Date.now()\r\n  let darts = 0, scored = 0\r\n  for (const e of list) {\r\n    if (now - e.t <= windowMs) { darts += e.darts; scored += e.scored }\r\n  }\r\n  if (darts <= 0) return 0\r\n  return (scored / darts) * 3\r\n}\r\n\r\nexport function getRollingFirstNineAvg(name: string, windowMs: number = 1000 * 60 * 60 * 24 * 30): number {\r\n  const list = getSeries(name)\r\n  if (!list.length) return 0\r\n  const now = Date.now()\r\n  let darts = 0, scored = 0\r\n  for (const e of list) {\r\n    if (now - e.t <= windowMs) {\r\n      darts += (e.fnDarts || 0)\r\n      scored += (e.fnScored || 0)\r\n    }\r\n  }\r\n  if (darts <= 0) return 0\r\n  return (scored / darts) * 3\r\n}\r\n\r\n// Daily adjusted average: recompute from last 24h at most once per 24h and persist the last value\r\ntype DailySnapshot = { avg: number; ts: number }\r\n\r\nfunction getDailySnapshot(name: string): DailySnapshot | null {\r\n  try {\r\n    const raw = localStorage.getItem(keyDailyFor(name))\r\n    if (!raw) return null\r\n    const j = JSON.parse(raw)\r\n    return { avg: Number(j.avg) || 0, ts: Number(j.ts) || 0 }\r\n  } catch { return null }\r\n}\r\n\r\nfunction setDailySnapshot(name: string, snap: DailySnapshot) {\r\n  try {\r\n    localStorage.setItem(keyDailyFor(name), JSON.stringify(snap))\r\n    window.dispatchEvent(new CustomEvent('ndn:stats-updated', { detail: { name } }))\r\n  } catch {}\r\n}\r\n\r\nexport function getDailyAdjustedAvg(name: string): number {\r\n  const snap = getDailySnapshot(name)\r\n  const now = Date.now()\r\n  const DAY = 1000 * 60 * 60 * 24\r\n  if (snap && now - snap.ts < DAY) return snap.avg\r\n  // Need to compute a new daily value from the last 24h of samples\r\n  const ra = getRollingAvg(name, DAY)\r\n  const next: DailySnapshot = { avg: ra, ts: now }\r\n  setDailySnapshot(name, next)\r\n  return ra\r\n}\r\n\r\n// Convenience helpers for monthly (last ~30 days) averages\r\nexport function getMonthlyAvg3(name: string): number {\r\n  const THIRTY_DAYS = 1000 * 60 * 60 * 24 * 30\r\n  const list = getSeries(name)\r\n  if (!list.length) return 0\r\n  const now = Date.now()\r\n  // Prefer match-aggregated entries (those with fnDarts defined) to avoid double counting with per-visit samples\r\n  const windowed = list.filter(e => now - e.t <= THIRTY_DAYS)\r\n  const matchOnly = windowed.filter(e => typeof e.fnDarts === 'number')\r\n  const use = matchOnly.length ? matchOnly : windowed\r\n  let darts = 0, scored = 0\r\n  for (const e of use) { darts += e.darts; scored += e.scored }\r\n  if (darts <= 0) return 0\r\n  return (scored / darts) * 3\r\n}\r\nexport function getMonthlyFirstNineAvg(name: string): number {\r\n  const THIRTY_DAYS = 1000 * 60 * 60 * 24 * 30\r\n  return getRollingFirstNineAvg(name, THIRTY_DAYS)\r\n}\r\n\r\n// Update all players' all-time totals given a finished match roster\r\nimport type { Player, Leg } from './match'\r\nexport function addMatchToAllTime(players: Player[]) {\r\n  for (const p of players) {\r\n    // Sum over finished legs\r\n    let darts = 0\r\n    let scored = 0\r\n    let fnDarts = 0\r\n    let fnScored = 0\r\n    // Per-match quality metrics\r\n    let matchBest3 = 0\r\n    let matchWorst3 = 0\r\n    let matchBestLegDarts = 0 // track fewest darts on a winning leg only\r\n    let matchBestCheckout = 0\r\n    let matchWorstLegDarts = 0 // most darts on a winning leg\r\n    let matchBestFNAvg = 0\r\n    let matchWorstFNAvg = 0\r\n    for (const leg of p.legs) {\r\n      if (!leg.finished) continue\r\n      darts += leg.dartsThrown\r\n      scored += Math.max(0, leg.totalScoreStart - leg.totalScoreRemaining)\r\n      // First nine darts aggregation (or fewer if leg ended earlier)\r\n      const { d: legFnDarts, s: legFnScored } = sumFirstNine(leg)\r\n      fnDarts += legFnDarts\r\n      fnScored += legFnScored\r\n      // Quality metrics per leg\r\n      const legDarts = Math.max(0, leg.dartsThrown)\r\n      const legScored = Math.max(0, leg.totalScoreStart - leg.totalScoreRemaining)\r\n      const legAvg = legDarts > 0 ? (legScored / legDarts) * 3 : 0\r\n      const legFNAvg = legFnDarts > 0 ? (legFnScored / legFnDarts) * 3 : 0\r\n      if (legAvg > 0) {\r\n        matchBest3 = Math.max(matchBest3, legAvg)\r\n        matchWorst3 = matchWorst3 === 0 ? legAvg : Math.min(matchWorst3, legAvg)\r\n      }\r\n      if (legFNAvg > 0) {\r\n        matchBestFNAvg = Math.max(matchBestFNAvg, legFNAvg)\r\n        matchWorstFNAvg = matchWorstFNAvg === 0 ? legFNAvg : Math.min(matchWorstFNAvg, legFNAvg)\r\n      }\r\n      const wasCheckout = leg.totalScoreRemaining === 0\r\n      if (wasCheckout) {\r\n        if (matchBestLegDarts === 0 || legDarts < matchBestLegDarts) matchBestLegDarts = legDarts\r\n        if (matchWorstLegDarts === 0 || legDarts > matchWorstLegDarts) matchWorstLegDarts = legDarts\r\n        const co = typeof leg.checkoutScore === 'number' ? leg.checkoutScore : 0\r\n        if (co > matchBestCheckout) matchBestCheckout = co\r\n      }\r\n    }\r\n    if (darts > 0) {\r\n      const prev = getAllTime(p.name)\r\n      const next: AllTimeTotals = {\r\n        darts: prev.darts + darts,\r\n        scored: prev.scored + scored,\r\n        fnDarts: (prev.fnDarts || 0) + fnDarts,\r\n        fnScored: (prev.fnScored || 0) + fnScored,\r\n        best3: Math.max(prev.best3 || 0, matchBest3 || 0),\r\n        // For worst3, treat 0 as \"unset\"; choose the min positive across history\r\n        worst3: (() => {\r\n          const prior = prev.worst3 || 0\r\n          if (prior === 0) return matchWorst3 || 0\r\n          if (matchWorst3 === 0) return prior\r\n          return Math.min(prior, matchWorst3)\r\n        })(),\r\n        // Fewest darts on winning leg; 0 means no winning legs recorded yet\r\n        bestLegDarts: (() => {\r\n          const prior = prev.bestLegDarts || 0\r\n          if (prior === 0) return matchBestLegDarts || 0\r\n          if (matchBestLegDarts === 0) return prior\r\n          return Math.min(prior, matchBestLegDarts)\r\n        })(),\r\n        bestCheckout: Math.max(prev.bestCheckout || 0, matchBestCheckout || 0),\r\n        worstLegDarts: (() => {\r\n          const prior = prev.worstLegDarts || 0\r\n          if (prior === 0) return matchWorstLegDarts || 0\r\n          if (matchWorstLegDarts === 0) return prior\r\n          return Math.max(prior, matchWorstLegDarts)\r\n        })(),\r\n        bestFNAvg: Math.max(prev.bestFNAvg || 0, matchBestFNAvg || 0),\r\n        worstFNAvg: (() => {\r\n          const prior = prev.worstFNAvg || 0\r\n          if (prior === 0) return matchWorstFNAvg || 0\r\n          if (matchWorstFNAvg === 0) return prior\r\n          return Math.min(prior, matchWorstFNAvg)\r\n        })(),\r\n      }\r\n      setAllTime(p.name, next)\r\n      // Also add a time-series sample for rolling averages\r\n      addSample(p.name, darts, scored, Date.now(), fnDarts, fnScored)\r\n    }\r\n  }\r\n}\r\n\r\n// Helper: sum points and darts for the first 9 darts of a leg (or fewer if finished earlier)\r\nfunction sumFirstNine(leg: Leg): { d: number; s: number } {\r\n  let remain = Math.min(9, leg.dartsThrown)\r\n  if (remain <= 0) return { d: 0, s: 0 }\r\n  let s = 0\r\n  for (const v of leg.visits) {\r\n    if (remain <= 0) break\r\n    const take = Math.min(remain, v.darts)\r\n    // Pro-rate score if partial darts from a visit are included\r\n    if (take === v.darts) s += v.score\r\n    else s += Math.round((v.score / v.darts) * take)\r\n    remain -= take\r\n  }\r\n  const d = Math.min(9, leg.dartsThrown)\r\n  return { d, s }\r\n}\r\n","export const freeGames = ['X01', 'Double Practice'] as const\r\nexport const premiumGames = [\r\n\t'Around the Clock',\r\n\t'Cricket',\r\n\t'Halve It',\r\n\t'Shanghai',\r\n\t'High-Low',\r\n\t'Killer',\r\n\t\"Bob's 27\",\r\n\t'Count-Up',\r\n\t'High Score',\r\n\t'Low Score',\r\n\t'Checkout 170',\r\n\t'Checkout 121',\r\n\t'Treble Practice',\r\n\t'Baseball',\r\n\t'Golf',\r\n\t'Tic Tac Toe',\r\n\t'American Cricket',\r\n\t'Scam',\r\n\t'Fives',\r\n\t'Sevens',\r\n] as const\r\nexport type GameKey = typeof freeGames[number] | typeof premiumGames[number]\r\nexport const allGames: GameKey[] = [...freeGames, ...premiumGames]\r\n","import React, { createContext, useCallback, useContext, useEffect, useMemo, useRef, useState, type ReactNode } from 'react'\r\n\r\ntype WSMessage = any\r\n\r\ntype WSStatus = 'connecting' | 'connected' | 'disconnected'\r\ntype WSContextType = {\r\n  connected: boolean\r\n  status: WSStatus\r\n  send: (msg: WSMessage) => void\r\n  addListener: (fn: (data: WSMessage) => void) => () => void\r\n  reconnect: () => void\r\n}\r\n\r\nconst WSContext = createContext<WSContextType | null>(null)\r\n\r\nexport function WSProvider({ children }: { children: ReactNode }) {\r\n  const [connected, setConnected] = useState(false)\r\n  const [status, setStatus] = useState<WSStatus>('connecting')\r\n  const wsRef = useRef<WebSocket | null>(null)\r\n  const listenersRef = useRef(new Set<(data: WSMessage) => void>())\r\n  const shouldReconnectRef = useRef(true)\r\n  const attemptsRef = useRef(0)\r\n  const timerRef = useRef<ReturnType<typeof setTimeout> | null>(null)\r\n  const heartbeatRef = useRef<ReturnType<typeof setInterval> | null>(null)\r\n\r\n  const endpointsRef = useRef<string[] | null>(null)\r\n  const endpointIdxRef = useRef(0)\r\n  const debug = false\r\n\r\n  const ensureEndpoints = () => {\r\n    if (endpointsRef.current) return endpointsRef.current\r\n    const envUrl = (import.meta as any).env?.VITE_WS_URL as string | undefined\r\n    if (envUrl && envUrl.length > 0) {\r\n      const normalized = envUrl.endsWith('/ws') ? envUrl : envUrl.replace(/\\/$/, '') + '/ws'\r\n      endpointsRef.current = [normalized]\r\n      return endpointsRef.current\r\n    }\r\n    const proto = (window.location.protocol === 'https:' ? 'wss' : 'ws')\r\n    const host = window.location.hostname\r\n    const sameOrigin = `${proto}://${window.location.host}` // includes port if present\r\n    // Candidate endpoints: prefer same-origin first (works when server serves SPA),\r\n    // then common local ports for dev fallbacks.\r\n    const bases = [\r\n      sameOrigin + '/ws',\r\n      `${proto}://${host}/ws`,\r\n      `${proto}://${host}:8787/ws`,\r\n      `${proto}://${host}:3000/ws`,\r\n    ]\r\n    // Deduplicate\r\n    endpointsRef.current = Array.from(new Set(bases))\r\n    return endpointsRef.current\r\n  }\r\n\r\n  const rotateEndpoint = () => {\r\n    const eps = ensureEndpoints()\r\n    endpointIdxRef.current = (endpointIdxRef.current + 1) % eps.length\r\n    return eps[endpointIdxRef.current]\r\n  }\r\n\r\n  const currentEndpoint = () => {\r\n    const eps = ensureEndpoints()\r\n    return eps[endpointIdxRef.current] || eps[0]\r\n  }\r\n\r\n  const connect = useCallback(() => {\r\n    if (wsRef.current && (wsRef.current.readyState === WebSocket.OPEN || wsRef.current.readyState === WebSocket.CONNECTING)) return\r\n    setStatus('connecting')\r\n    const base = currentEndpoint()\r\n    const url = `${base}`\r\n    if (debug) console.log('[WS] connecting to', url)\r\n    const ws = new WebSocket(url)\r\n    wsRef.current = ws\r\n    ws.onopen = () => {\r\n      setConnected(true)\r\n      setStatus('connected')\r\n      attemptsRef.current = 0\r\n      // start heartbeat\r\n      if (heartbeatRef.current) clearInterval(heartbeatRef.current)\r\n      heartbeatRef.current = setInterval(() => {\r\n        try { wsRef.current?.readyState === WebSocket.OPEN && wsRef.current?.send(JSON.stringify({ type: 'ping', t: Date.now() })) } catch {}\r\n      }, 20000)\r\n      if (debug) console.log('[WS] connected')\r\n    }\r\n    ws.onmessage = (ev) => {\r\n      try {\r\n        const data = JSON.parse(ev.data)\r\n        listenersRef.current.forEach(fn => { try { fn(data) } catch {} })\r\n      } catch {}\r\n    }\r\n    ws.onerror = () => {\r\n      if (debug) console.log('[WS] socket error on', currentEndpoint())\r\n    }\r\n    ws.onclose = () => {\r\n      setConnected(false)\r\n      setStatus('disconnected')\r\n      if (heartbeatRef.current) { clearInterval(heartbeatRef.current); heartbeatRef.current = null }\r\n      if (!shouldReconnectRef.current) return\r\n      const attempt = (attemptsRef.current || 0) + 1\r\n      attemptsRef.current = attempt\r\n      // rotate endpoint every 2 failed attempts for broader coverage\r\n      if (attempt % 2 === 0) rotateEndpoint()\r\n      if (debug) console.log('[WS] closed. attempt', attempt, 'next endpoint', currentEndpoint())\r\n      const base = 1000 * Math.pow(2, attempt - 1)\r\n      const jitter = Math.floor(Math.random() * 1000)\r\n      let delay = Math.min(30000, base + jitter)\r\n      // First retry should be immediate for instant reconnect UX\r\n      if (attempt === 1) delay = 0\r\n      if (timerRef.current) clearTimeout(timerRef.current)\r\n      if (delay === 0) {\r\n        connect()\r\n      } else {\r\n        timerRef.current = setTimeout(connect, delay)\r\n      }\r\n    }\r\n  }, [])\r\n\r\n  const reconnect = useCallback(() => {\r\n    try {\r\n      // Prevent auto-retry logic from racing while we recreate\r\n      shouldReconnectRef.current = false\r\n      if (timerRef.current) { clearTimeout(timerRef.current); timerRef.current = null }\r\n      if (heartbeatRef.current) { clearInterval(heartbeatRef.current); heartbeatRef.current = null }\r\n      try { wsRef.current?.close() } catch {}\r\n      wsRef.current = null\r\n    } catch {}\r\n    // Reset counters and allow reconnect\r\n    attemptsRef.current = 0\r\n    shouldReconnectRef.current = true\r\n    setStatus('connecting')\r\n    setConnected(false)\r\n    // Attempt immediate connect\r\n    connect()\r\n  }, [connect])\r\n\r\n  useEffect(() => {\r\n    shouldReconnectRef.current = true\r\n    connect()\r\n    const beforeUnload = () => {\r\n      shouldReconnectRef.current = false\r\n      try { wsRef.current?.close() } catch {}\r\n    }\r\n    window.addEventListener('beforeunload', beforeUnload)\r\n    const onVis = () => {\r\n      if (document.visibilityState === 'visible') {\r\n        // nudge reconnect if needed\r\n        if (!connected) connect()\r\n      }\r\n    }\r\n    document.addEventListener('visibilitychange', onVis)\r\n    window.addEventListener('online', connect)\r\n    return () => {\r\n      shouldReconnectRef.current = false\r\n      if (timerRef.current) clearTimeout(timerRef.current)\r\n      if (heartbeatRef.current) clearInterval(heartbeatRef.current)\r\n      try { wsRef.current?.close() } catch {}\r\n      document.removeEventListener('visibilitychange', onVis)\r\n      window.removeEventListener('online', connect)\r\n      window.removeEventListener('beforeunload', beforeUnload)\r\n    }\r\n  }, [connect])\r\n\r\n  const send = useCallback((msg: WSMessage) => {\r\n    try {\r\n      if (wsRef.current && wsRef.current.readyState === WebSocket.OPEN) {\r\n        wsRef.current.send(typeof msg === 'string' ? msg : JSON.stringify(msg))\r\n      }\r\n    } catch {}\r\n  }, [])\r\n\r\n  const addListener = useCallback((fn: (data: WSMessage) => void) => {\r\n    listenersRef.current.add(fn)\r\n    return () => { listenersRef.current.delete(fn) }\r\n  }, [])\r\n\r\n  const value = useMemo(() => ({ connected, status, send, addListener, reconnect }), [connected, status, send, addListener, reconnect])\r\n  return <WSContext.Provider value={value}>{children}</WSContext.Provider>\r\n}\r\n\r\nexport function useWS() {\r\n  const ctx = useContext(WSContext)\r\n  if (!ctx) throw new Error('useWS must be used within WSProvider')\r\n  return ctx\r\n}\r\n","import React from 'react'\r\n\r\ntype Props = {\r\n  status: 'connecting' | 'connected' | 'disconnected'\r\n  title?: string\r\n  size?: number // pixels, defaults to 12\r\n}\r\n\r\nexport default function StatusDot({ status, title, size = 12 }: Props) {\r\n  const s = size\r\n  if (status === 'connecting') {\r\n    return (\r\n      <span\r\n        role=\"img\"\r\n        aria-label=\"Connecting\"\r\n        title={title || 'Connecting'}\r\n        className=\"inline-flex items-center justify-center\"\r\n        style={{ width: s, height: s }}\r\n      >\r\n        <svg\r\n          width={s}\r\n          height={s}\r\n          viewBox=\"0 0 24 24\"\r\n          className=\"animate-spin\"\r\n          aria-hidden=\"true\"\r\n        >\r\n          <circle cx=\"12\" cy=\"12\" r=\"10\" stroke=\"#A7F3D0\" strokeWidth=\"3\" fill=\"none\" opacity=\"0.35\" />\r\n          <path d=\"M22 12a10 10 0 0 0-10-10\" stroke=\"#34D399\" strokeWidth=\"3\" strokeLinecap=\"round\" fill=\"none\" />\r\n        </svg>\r\n      </span>\r\n    )\r\n  }\r\n  if (status === 'connected') {\r\n    return (\r\n      <span\r\n        role=\"img\"\r\n        aria-label=\"Connected\"\r\n        title={title || 'Connected'}\r\n        className=\"inline-flex items-center justify-center\"\r\n        style={{ width: s, height: s }}\r\n      >\r\n        <svg width={s} height={s} viewBox=\"0 0 24 24\" aria-hidden=\"true\">\r\n          <circle cx=\"12\" cy=\"12\" r=\"10\" fill=\"#34D399\" />\r\n        </svg>\r\n      </span>\r\n    )\r\n  }\r\n  return (\r\n    <span\r\n      role=\"img\"\r\n      aria-label=\"Disconnected\"\r\n      title={title || 'Not connected'}\r\n      className=\"inline-flex items-center justify-center\"\r\n      style={{ width: s, height: s }}\r\n    >\r\n      <svg width={s} height={s} viewBox=\"0 0 24 24\" aria-hidden=\"true\">\r\n        <circle cx=\"12\" cy=\"12\" r=\"10\" fill=\"#F87171\" opacity=\"0.15\" />\r\n        <circle cx=\"12\" cy=\"12\" r=\"9\" stroke=\"#F87171\" strokeWidth=\"2\" fill=\"none\" />\r\n        <rect x=\"6\" y=\"11\" width=\"12\" height=\"2\" rx=\"1\" fill=\"#F87171\" />\r\n      </svg>\r\n    </span>\r\n  )\r\n}\r\n","import { useEffect, useRef } from 'react'\r\nimport { useCameraSession } from '../store/cameraSession'\r\n\r\n/**\r\n * CameraStatusBadge\r\n * A compact, always-visible header badge that shows a live thumbnail of the phone camera\r\n * when streaming, with a green tick overlay. Clicking toggles the global phone overlay.\r\n */\r\nexport default function CameraStatusBadge() {\r\n  const camera = useCameraSession()\r\n  const canvasRef = useRef<HTMLCanvasElement | null>(null)\r\n  const rafRef = useRef<number | null>(null)\r\n\r\n  const videoEl = camera.getVideoElementRef()\r\n  const sessionStream = camera.getMediaStream?.()\r\n  const hasActivePhoneStream = !!(sessionStream || videoEl?.srcObject)\r\n  const streaming = camera.isStreaming && camera.mode === 'phone' && hasActivePhoneStream\r\n\r\n  useEffect(() => {\r\n    const canvas = canvasRef.current\r\n    if (!canvas) return\r\n\r\n    let running = true\r\n    const ctx = canvas.getContext('2d')\r\n    if (!ctx) return\r\n\r\n    const render = () => {\r\n      if (!running) return\r\n      try {\r\n        ctx.clearRect(0, 0, canvas.width, canvas.height)\r\n        if (streaming && videoEl && (videoEl.readyState >= 2)) {\r\n          const vw = videoEl.videoWidth || 640\r\n          const vh = videoEl.videoHeight || 360\r\n          // Fit cover into canvas (letterbox/crop to preserve aspect)\r\n          const cw = canvas.width\r\n          const ch = canvas.height\r\n          const vr = vw / vh\r\n          const cr = cw / ch\r\n          let sx = 0, sy = 0, sw = vw, sh = vh\r\n          if (vr > cr) {\r\n            // video is wider than canvas; crop sides\r\n            const targetW = vh * cr\r\n            sx = (vw - targetW) / 2\r\n            sw = targetW\r\n          } else if (vr < cr) {\r\n            // video is taller; crop top/bottom\r\n            const targetH = vw / cr\r\n            sy = (vh - targetH) / 2\r\n            sh = targetH\r\n          }\r\n          ctx.drawImage(videoEl, sx, sy, sw, sh, 0, 0, cw, ch)\r\n        } else {\r\n          // Placeholder background when not streaming\r\n          ctx.fillStyle = 'rgba(148, 163, 184, 0.25)'\r\n          ctx.fillRect(0, 0, canvas.width, canvas.height)\r\n          ctx.fillStyle = 'rgba(226,232,240,0.8)'\r\n          ctx.font = '10px system-ui, sans-serif'\r\n          ctx.textAlign = 'center'\r\n          ctx.textBaseline = 'middle'\r\n          ctx.fillText('Camera', canvas.width / 2, canvas.height / 2)\r\n        }\r\n      } catch {}\r\n      rafRef.current = requestAnimationFrame(render)\r\n    }\r\n\r\n    rafRef.current = requestAnimationFrame(render)\r\n    return () => {\r\n      running = false\r\n      if (rafRef.current) cancelAnimationFrame(rafRef.current)\r\n    }\r\n    // Include only essentials; avoid re-creating loop unnecessarily\r\n  }, [streaming, videoEl])\r\n\r\n  const onClick = () => {\r\n    try {\r\n      // Toggle global overlay visibility via event (handled by overlay component)\r\n      window.dispatchEvent(new CustomEvent('ndn:toggle-phone-overlay'))\r\n    } catch {}\r\n  }\r\n\r\n  return (\r\n    <button\r\n      type=\"button\"\r\n      onClick={onClick}\r\n      className=\"relative inline-flex items-center gap-1 rounded-lg border border-white/15 bg-white/5 hover:bg-white/10 transition-colors shadow-sm overflow-hidden\"\r\n      style={{ height: 36 }}\r\n      title={streaming ? 'Camera connected  click to toggle overlay' : 'Camera not connected'}\r\n    >\r\n      <canvas ref={canvasRef} width={64} height={36} className=\"block\" />\r\n      <span className=\"pr-2 text-xs text-slate-100 select-none hidden xs:inline\">\r\n        {streaming ? 'Phone Cam' : 'No Camera'}\r\n      </span>\r\n      {/* Status tick */}\r\n      <span\r\n        className=\"absolute -top-1 -right-1 text-lg pointer-events-none drop-shadow\"\r\n        aria-hidden=\"true\"\r\n      >\r\n        {streaming ? '' : ''}\r\n      </span>\r\n    </button>\r\n  )\r\n}\r\n","// Help Desk AI - Provides intelligent responses to common questions\r\nexport const HELP_TOPICS = {\r\n  calibration: {\r\n    keywords: ['calibration', 'calibrate', 'camera', 'score', 'accuracy', 'aim', 'setup'],\r\n    title: 'How Calibration Works',\r\n    explanation: `Calibration helps our AI precisely detect where your darts land on the board. Here's how it works:\r\n\r\n1. **D20**: Click on the 20 segment to calibrate that area\r\n2. **D6**: Click on the 6 segment to calibrate that area\r\n3. **D3**: Click on the 3 segment to calibrate that area\r\n4. **D11**: Click on the 11 segment to calibrate that area\r\n5. **Bullseye**: Click on the bullseye to calibrate the center\r\n\r\nEach click teaches the system about your board's position and angle. After calibrating all areas, your scoring will be much more accurate!`,\r\n    actions: [\r\n      { id: 'D20', label: ' Click D20', color: 'bg-blue-600' },\r\n      { id: 'D6', label: ' Click D6', color: 'bg-purple-600' },\r\n      { id: 'D3', label: ' Click D3', color: 'bg-pink-600' },\r\n      { id: 'D11', label: ' Click D11', color: 'bg-cyan-600' },\r\n      { id: 'Bullseye', label: ' Click Bullseye', color: 'bg-yellow-600' }\r\n    ]\r\n  },\r\n  scoring: {\r\n    keywords: ['score', 'points', 'counting', 'how do i score', 'scoring system'],\r\n    title: 'Dart Scoring',\r\n    explanation: `In darts, each segment on the board has a value:\r\n- Single areas: Face value (1-20)\r\n- Double ring (outer): 2 the segment number\r\n- Triple ring (inner): 3 the segment number\r\n- Bullseye: 50 points\r\n- Bull (outer bull): 25 points\r\n\r\nFor example: hitting Triple 20 = 60 points, Double 10 = 20 points`\r\n  },\r\n  gameplay: {\r\n    keywords: ['game', 'how to play', 'rules', 'x01', 'cricket', 'match', 'round'],\r\n    title: 'How to Play',\r\n    explanation: `Nine Dart Nation supports multiple game modes:\r\n\r\n**X01** (501, 301, 701): Start from the set score and count down to exactly 0. Final dart must be on a double.\r\n\r\n**Cricket**: Players try to \"close\" numbers 15-20 and bullseye by hitting them. First to close all and have the highest score wins.\r\n\r\n**Killer**: Players mark their \"number\" and try to knock out other players' lives.\r\n\r\nSelect your game mode when creating a match, and follow the on-screen instructions!`\r\n  },\r\n  premium: {\r\n    keywords: ['premium', 'subscription', 'features', 'upgrade', 'cost', 'paid'],\r\n    title: 'Premium Features',\r\n    explanation: `Our Premium subscription gives you:\r\n- Tournament creation and entry\r\n- Advanced statistics and replays\r\n- Priority matchmaking\r\n- Custom profiles and themes\r\n- Ad-free experience\r\n\r\nPremium grants are often awarded as tournament prizes!`\r\n  },\r\n  connection: {\r\n    keywords: ['connection', 'disconnect', 'lag', 'latency', 'websocket', 'error', 'offline'],\r\n    title: 'Connection Issues',\r\n    explanation: `If you're experiencing connection issues:\r\n1. Check your internet connection\r\n2. Refresh the page (Ctrl+R or Cmd+R)\r\n3. Clear browser cache\r\n4. Try a different browser\r\n5. Check if the site status page shows any issues\r\n\r\nMost connection issues resolve in seconds. Contact admin if problems persist.`\r\n  },\r\n  camera: {\r\n    keywords: ['camera', 'phone camera', 'mobile', 'video', 'pairing', 'connect'],\r\n    title: 'Camera Setup',\r\n    explanation: `To use our phone camera feature:\r\n1. Open Nine Dart Nation on your phone\r\n2. Go to Settings > Camera Pairing\r\n3. Scan the QR code or enter the pairing code\r\n4. Position your phone to capture the dartboard\r\n5. Run calibration (see calibration help for details)\r\n\r\nYour phone will now act as a live dartboard camera!`\r\n  },\r\n  tournament: {\r\n    keywords: ['tournament', 'compete', 'bracket', 'prize', 'winner', 'playoffs'],\r\n    title: 'Tournaments',\r\n    explanation: `Tournaments are competitive events where you can:\r\n- Play against other skilled players\r\n- Win prizes (Premium subscriptions or cash)\r\n- Climb leaderboards\r\n- Compete in structured brackets\r\n\r\nCheck the Tournaments tab to see upcoming events. Registration typically opens 30 minutes before start time.`\r\n  }\r\n}\r\n\r\nexport interface AIResponse {\r\n  type: 'explanation' | 'suggestion' | 'escalate'\r\n  title: string\r\n  message: string\r\n  actions?: Array<{ id: string; label: string; color: string }>\r\n  followUp?: string\r\n}\r\n\r\nexport function analyzeUserQuestion(question: string): AIResponse | null {\r\n  const lowerQ = question.toLowerCase()\r\n  \r\n  // Find matching topic\r\n  for (const [key, topic] of Object.entries(HELP_TOPICS)) {\r\n    for (const keyword of topic.keywords) {\r\n      if (lowerQ.includes(keyword)) {\r\n        return {\r\n          type: 'explanation',\r\n          title: topic.title,\r\n          message: topic.explanation,\r\n          actions: (topic as any).actions,\r\n          followUp: 'Do you need further assistance? I can connect you with an admin if needed.'\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  // No match found - suggest escalation\r\n  return {\r\n    type: 'suggestion',\r\n    title: 'Need More Help?',\r\n    message: `I couldn't find a specific answer to your question. Common topics I can help with:\\n\\n${Object.values(HELP_TOPICS).map(t => ` ${t.title}`).join('\\n')}\\n\\nOr I can connect you with an admin who can help further.`,\r\n    followUp: 'Would you like to speak with an admin?'\r\n  }\r\n}\r\n\r\nexport function getEstimatedWaitTime(): string {\r\n  const hour = new Date().getHours()\r\n  \r\n  if (hour >= 20 || hour < 7) {\r\n    return '20-30 minutes (off-peak hours)'\r\n  } else if (hour >= 12 && hour < 14) {\r\n    return '10-15 minutes (moderate traffic)'\r\n  } else if (hour >= 18 && hour < 20) {\r\n    return '15-20 minutes (peak hours)'\r\n  } else {\r\n    return '5-10 minutes'\r\n  }\r\n}\r\n","import React, { useEffect, useState, useRef, useCallback } from 'react'\r\nimport { useWS } from './WSProvider'\r\nimport { X, Send, Zap, Clock, User } from 'lucide-react'\r\nimport { analyzeUserQuestion, getEstimatedWaitTime } from '../utils/helpDeskAI'\r\n\r\nexport default function HelpdeskChat({ request, user, onClose }: { request: any, user: any, onClose?: () => void }) {\r\n  const ws = (() => { try { return useWS() } catch { return null } })()\r\n  const [messages, setMessages] = useState<any[]>(request?.messages || [])\r\n  const [input, setInput] = useState('')\r\n  const [typingUsers, setTypingUsers] = useState<Record<string, number>>({})\r\n  const [adminConnected, setAdminConnected] = useState(false)\r\n  const [waitTime, setWaitTime] = useState('')\r\n  const msgsRef = useRef<HTMLDivElement | null>(null)\r\n  const typingTimeoutRef = useRef<number | null>(null)\r\n\r\n  useEffect(() => {\r\n    if (!ws) return\r\n    const un = ws.addListener((data: any) => {\r\n      try {\r\n        if (data?.type === 'help-message' && String(data.requestId) === String(request.id)) {\r\n          setMessages((m) => [...m, data.message])\r\n        }\r\n        if (data?.type === 'help-request-updated' && data.request?.id === request.id) {\r\n          setMessages(data.request.messages || [])\r\n          setAdminConnected(data.request.claimedBy ? true : false)\r\n        }\r\n        if (data?.type === 'help-typing' && String(data.requestId) === String(request.id)) {\r\n          const who = data.fromName || data.fromEmail || (data.admin ? 'admin' : 'user')\r\n          setTypingUsers(prev => ({ ...prev, [who]: Date.now() }))\r\n        }\r\n      } catch {}\r\n    })\r\n    return () => { un() }\r\n  }, [ws, request?.id])\r\n\r\n  const sendMsg = () => {\r\n    if (!input.trim()) return\r\n    \r\n    // Send user message\r\n    const userMessage = input\r\n    const payload = { type: 'help-message', requestId: request.id, message: userMessage }\r\n    try { ws?.send(payload) } catch {}\r\n    \r\n    const msgObj = { fromEmail: user?.email || null, fromName: user?.username || null, message: userMessage, ts: Date.now(), admin: false }\r\n    setMessages(m => [...m, msgObj])\r\n    setInput('')\r\n\r\n    // If admin not connected, try AI response\r\n    if (!adminConnected) {\r\n      setTimeout(() => {\r\n        const aiResponse = analyzeUserQuestion(userMessage)\r\n        if (aiResponse) {\r\n          const aiMsg = {\r\n            fromName: 'AI Assistant',\r\n            message: `${aiResponse.title}\\n\\n${aiResponse.message}`,\r\n            ts: Date.now(),\r\n            admin: true,\r\n            actions: aiResponse.actions,\r\n            followUp: aiResponse.followUp\r\n          }\r\n          setMessages(m => [...m, aiMsg])\r\n        }\r\n      }, 500)\r\n    }\r\n  }\r\n\r\n  const requestAdminConnection = (needsHelp: boolean) => {\r\n    if (!needsHelp) {\r\n      const confirmMsg = { fromName: 'You', message: 'No, I think I have it now. Thanks!', ts: Date.now(), admin: false }\r\n      setMessages(m => [...m, confirmMsg])\r\n      \r\n      setTimeout(() => {\r\n        const aiMsg = {\r\n          fromName: 'AI Assistant',\r\n          message: ' Great! Glad I could help. Feel free to reach out anytime you need assistance.',\r\n          ts: Date.now(),\r\n          admin: true\r\n        }\r\n        setMessages(m => [...m, aiMsg])\r\n      }, 300)\r\n      return\r\n    }\r\n\r\n    // Request admin connection\r\n    const confirmMsg = { fromName: 'You', message: 'Yes, I need to speak with an admin', ts: Date.now(), admin: false }\r\n    setMessages(m => [...m, confirmMsg])\r\n\r\n    // Send escalation request to admins\r\n    try {\r\n      ws?.send({ type: 'help-escalate', requestId: request.id })\r\n    } catch {}\r\n\r\n    setWaitTime(getEstimatedWaitTime())\r\n\r\n    setTimeout(() => {\r\n      const waitMsg = {\r\n        fromName: 'System',\r\n        message: ` Connecting you with an admin...\\n\\n Estimated wait time: ${waitTime}\\n\\nAn admin will be with you shortly. Please stay on this chat.`,\r\n        ts: Date.now(),\r\n        admin: true\r\n      }\r\n      setMessages(m => [...m, waitMsg])\r\n    }, 500)\r\n  }\r\n\r\n  // auto-scroll to bottom when messages update\r\n  useEffect(() => {\r\n    if (!msgsRef.current) return\r\n    try {\r\n      msgsRef.current.scrollTop = msgsRef.current.scrollHeight\r\n    } catch {}\r\n  }, [messages])\r\n\r\n  // send typing notifications (debounced)\r\n  const sendTyping = useCallback(() => {\r\n    try {\r\n      ws?.send({ type: 'help-typing', requestId: request.id, fromName: user?.username, fromEmail: user?.email, admin: !!user?.isAdmin })\r\n    } catch {}\r\n    if (typingTimeoutRef.current) {\r\n      clearTimeout(typingTimeoutRef.current)\r\n    }\r\n    typingTimeoutRef.current = window.setTimeout(() => {\r\n      setTypingUsers(prev => {\r\n        const copy = { ...prev }\r\n        delete copy[user?.username || user?.email || 'me']\r\n        return copy\r\n      })\r\n    }, 3000)\r\n  }, [ws, request.id, user])\r\n\r\n  useEffect(() => {\r\n    return () => { if (typingTimeoutRef.current) clearTimeout(typingTimeoutRef.current) }\r\n  }, [])\r\n\r\n  return (\r\n    <div className=\"fixed inset-0 z-50 flex items-end justify-center p-4\">\r\n      <div className=\"absolute inset-0 bg-black/40\" onClick={onClose} />\r\n      <div className=\"relative w-full max-w-2xl bg-slate-900 rounded-lg shadow-xl overflow-hidden flex flex-col max-h-[80vh]\">\r\n        <div className=\"flex items-center justify-between p-3 border-b border-slate-700 bg-slate-800\">\r\n          <div className=\"flex items-center gap-3\">\r\n            <div className=\"font-semibold flex items-center gap-2\">\r\n              <Zap className=\"w-4 h-4 text-yellow-400\" />\r\n              Help Desk  {request.username || 'Anonymous'}\r\n            </div>\r\n            {adminConnected && (\r\n              <span className=\"text-xs px-2 py-1 rounded bg-emerald-600\">Admin Connected</span>\r\n            )}\r\n          </div>\r\n          <button className=\"px-2 py-1 rounded bg-neutral-700 hover:bg-neutral-600 text-sm\" onClick={onClose}>\r\n            <X className=\"w-4 h-4\"/>\r\n          </button>\r\n        </div>\r\n\r\n        <div ref={msgsRef} className=\"flex-1 overflow-y-auto p-3 space-y-3 bg-black/20\">\r\n          {messages.map((m, i) => (\r\n            <div key={i}>\r\n              <div className={`max-w-[85%] px-3 py-2 rounded ${m.admin ? 'bg-emerald-600/20 border border-emerald-500/40 text-emerald-100 ml-auto' : 'bg-slate-700 text-slate-100'}`}>\r\n                <div className=\"flex items-center justify-between mb-1\">\r\n                  <div className=\"text-xs opacity-70 font-semibold flex items-center gap-1\">\r\n                    {m.admin ? <Zap className=\"w-3 h-3\" /> : <User className=\"w-3 h-3\" />}\r\n                    {m.fromName || m.fromEmail || (m.admin ? 'AI Assistant' : 'You')}\r\n                  </div>\r\n                  <div className=\"text-xs opacity-50 ml-2\">{m.ts ? new Date(m.ts).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : ''}</div>\r\n                </div>\r\n                <div className=\"whitespace-pre-wrap break-words text-sm\">{m.message}</div>\r\n                \r\n                {/* Calibration actions */}\r\n                {m.actions && m.actions.length > 0 && (\r\n                  <div className=\"mt-3 space-y-2\">\r\n                    <div className=\"text-xs font-semibold opacity-80\"> Try these calibration points:</div>\r\n                    <div className=\"grid grid-cols-2 md:grid-cols-5 gap-2\">\r\n                      {m.actions.map((action: any) => (\r\n                        <button\r\n                          key={action.id}\r\n                          className={`${action.color} text-white text-xs py-2 px-2 rounded font-medium hover:opacity-90 transition-opacity`}\r\n                          onClick={() => {\r\n                            const actionMsg = { fromName: 'You', message: `Clicked: ${action.label}`, ts: Date.now(), admin: false }\r\n                            setMessages(prev => [...prev, actionMsg])\r\n                            try { ws?.send({ type: 'help-message', requestId: request.id, message: `User clicked: ${action.id}` }) } catch {}\r\n                          }}\r\n                        >\r\n                          {action.label}\r\n                        </button>\r\n                      ))}\r\n                    </div>\r\n                  </div>\r\n                )}\r\n\r\n                {/* Follow-up prompt */}\r\n                {m.followUp && !adminConnected && (\r\n                  <div className=\"mt-3 space-y-2\">\r\n                    <div className=\"text-xs opacity-80\">{m.followUp}</div>\r\n                    <div className=\"flex gap-2\">\r\n                      <button\r\n                        className=\"flex-1 bg-emerald-600 hover:bg-emerald-700 text-white text-xs py-2 px-3 rounded font-medium transition-colors\"\r\n                        onClick={() => requestAdminConnection(true)}\r\n                      >\r\n                         Yes, connect me\r\n                      </button>\r\n                      <button\r\n                        className=\"flex-1 bg-slate-600 hover:bg-slate-700 text-white text-xs py-2 px-3 rounded font-medium transition-colors\"\r\n                        onClick={() => requestAdminConnection(false)}\r\n                      >\r\n                         No thanks\r\n                      </button>\r\n                    </div>\r\n                  </div>\r\n                )}\r\n              </div>\r\n            </div>\r\n          ))}\r\n\r\n          {/* typing indicators */}\r\n          {Object.keys(typingUsers).length > 0 && (\r\n            <div className=\"text-xs text-slate-300 opacity-80 flex items-center gap-2\">\r\n              <span>{Object.keys(typingUsers).join(', ')} typing</span>\r\n              <span className=\"flex gap-1\">\r\n                <span className=\"w-1 h-1 bg-slate-300 rounded-full animate-bounce\"></span>\r\n                <span className=\"w-1 h-1 bg-slate-300 rounded-full animate-bounce delay-100\"></span>\r\n                <span className=\"w-1 h-1 bg-slate-300 rounded-full animate-bounce delay-200\"></span>\r\n              </span>\r\n            </div>\r\n          )}\r\n        </div>\r\n\r\n        <div className=\"p-3 border-t border-slate-700 bg-slate-800 flex gap-2\">\r\n          <input\r\n            className=\"input flex-1 text-sm\"\r\n            value={input}\r\n            onChange={e => {\r\n              setInput(e.target.value)\r\n              sendTyping()\r\n            }}\r\n            onKeyDown={(e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMsg() } }}\r\n            placeholder=\"Ask a question (e.g., 'How does calibration work?')...\"\r\n          />\r\n          <button className=\"btn bg-blue-600 hover:bg-blue-700 text-white\" onClick={sendMsg}>\r\n            <Send className=\"w-4 h-4\"/>\r\n          </button>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n","/**\r\n * Game-Mode-Specific Calibration Requirements\r\n * \r\n * Each game mode has different accuracy requirements:\r\n * - X01: Needs all zones (singles, doubles, trebles, bulls)\r\n * - Cricket: Only needs 6 numbers + bullseye\r\n * - Treble Practice: Only needs treble ring (strictest)\r\n * - Checkout modes: Need double precision\r\n */\r\n\r\nexport type CalibrationRequirement = {\r\n  tolerancePx: number // Maximum acceptable error in pixels\r\n  requiredTargets: string[] // Key areas needed for this game\r\n  criticalZones: string[] // Most important areas to focus on during calibration\r\n  minConfidence: number // Minimum acceptable calibration confidence (0-100)\r\n}\r\n\r\nexport const GAME_CALIBRATION_REQUIREMENTS: Record<string, CalibrationRequirement> = {\r\n  // Free Games\r\n  'X01': {\r\n    tolerancePx: 10,\r\n    requiredTargets: ['SINGLE', 'DOUBLE', 'TREBLE', 'BULL', 'OUTER_BULL'],\r\n    criticalZones: ['D20', 'D1', 'BULLSEYE', 'T20', 'SINGLE_20'],\r\n    minConfidence: 80\r\n  },\r\n  'Double Practice': {\r\n    tolerancePx: 12,\r\n    requiredTargets: ['DOUBLE', 'BULL'],\r\n    criticalZones: ['D20', 'D1', 'D6', 'D17'],\r\n    minConfidence: 75\r\n  },\r\n\r\n  // Premium - Accuracy Critical\r\n  'Treble Practice': {\r\n    tolerancePx: 8, // Strictest requirement\r\n    requiredTargets: ['TREBLE'],\r\n    criticalZones: ['T20', 'T1', 'T5'],\r\n    minConfidence: 85\r\n  },\r\n  'Checkout 170': {\r\n    tolerancePx: 9,\r\n    requiredTargets: ['DOUBLE'],\r\n    criticalZones: ['D25', 'D20', 'D8'],\r\n    minConfidence: 82\r\n  },\r\n  'Checkout 121': {\r\n    tolerancePx: 9,\r\n    requiredTargets: ['DOUBLE'],\r\n    criticalZones: ['D20', 'D5', 'D1'],\r\n    minConfidence: 82\r\n  },\r\n\r\n  // Premium - Target Subset\r\n  'Cricket': {\r\n    tolerancePx: 15,\r\n    requiredTargets: ['20', '19', '18', '17', '16', '15', 'BULL'],\r\n    criticalZones: ['20', '15', 'BULL'],\r\n    minConfidence: 70\r\n  },\r\n  'American Cricket': {\r\n    tolerancePx: 15,\r\n    requiredTargets: ['20', '19', '18', '17', '16', '15', 'BULL'],\r\n    criticalZones: ['20', '15', 'BULL'],\r\n    minConfidence: 70\r\n  },\r\n\r\n  // Premium - All Numbers\r\n  'Around the Clock': {\r\n    tolerancePx: 12,\r\n    requiredTargets: ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10', \r\n                      '11', '12', '13', '14', '15', '16', '17', '18', '19', '20'],\r\n    criticalZones: ['1', '20', '6', '15'],\r\n    minConfidence: 78\r\n  },\r\n  'Shanghai': {\r\n    tolerancePx: 13,\r\n    requiredTargets: ['1', '2', '3', '4', '5', '6', '7', 'SINGLE', 'DOUBLE', 'TREBLE'],\r\n    criticalZones: ['1', '7', 'S1', 'D1', 'T1'],\r\n    minConfidence: 75\r\n  },\r\n\r\n  // Premium - Practice/Training\r\n  'High Score': {\r\n    tolerancePx: 14,\r\n    requiredTargets: ['TREBLE', 'DOUBLE', 'BULL'],\r\n    criticalZones: ['T20', 'BULL', 'D20'],\r\n    minConfidence: 72\r\n  },\r\n  'Low Score': {\r\n    tolerancePx: 11,\r\n    requiredTargets: ['SINGLE'],\r\n    criticalZones: ['1', '2', '3'],\r\n    minConfidence: 76\r\n  },\r\n  'Count-Up': {\r\n    tolerancePx: 13,\r\n    requiredTargets: ['SINGLE', 'DOUBLE', 'TREBLE'],\r\n    criticalZones: ['20', 'DOUBLE', 'TREBLE'],\r\n    minConfidence: 74\r\n  },\r\n\r\n  // Premium - Head-to-Head\r\n  'Halve It': {\r\n    tolerancePx: 12,\r\n    requiredTargets: ['TREBLE', 'SINGLE'],\r\n    criticalZones: ['T20', 'T5', 'SINGLE'],\r\n    minConfidence: 73\r\n  },\r\n  'High-Low': {\r\n    tolerancePx: 13,\r\n    requiredTargets: ['SINGLE', 'DOUBLE', 'BULL'],\r\n    criticalZones: ['HIGH (>10)', 'LOW (<5)', 'BULL'],\r\n    minConfidence: 72\r\n  },\r\n  'Killer': {\r\n    tolerancePx: 12,\r\n    requiredTargets: ['ALL_NUMBERS'],\r\n    criticalZones: ['RANDOM_TARGETS'],\r\n    minConfidence: 74\r\n  },\r\n\r\n  // Premium - Skill Games\r\n  'Baseball': {\r\n    tolerancePx: 14,\r\n    requiredTargets: ['1-9', 'SINGLE', 'DOUBLE', 'TREBLE'],\r\n    criticalZones: ['1', '9', 'TRIPLE'],\r\n    minConfidence: 71\r\n  },\r\n  'Golf': {\r\n    tolerancePx: 14,\r\n    requiredTargets: ['1-18', 'TREBLE'],\r\n    criticalZones: ['T1', 'T18'],\r\n    minConfidence: 71\r\n  },\r\n  'Tic Tac Toe': {\r\n    tolerancePx: 16,\r\n    requiredTargets: ['1-9', 'SINGLE'],\r\n    criticalZones: ['CENTER', 'CORNERS'],\r\n    minConfidence: 68\r\n  },\r\n\r\n  // Premium - Variation Games\r\n  \"Bob's 27\": {\r\n    tolerancePx: 13,\r\n    requiredTargets: ['SINGLE', 'DOUBLE'],\r\n    criticalZones: ['1-20', 'BULL'],\r\n    minConfidence: 73\r\n  },\r\n  'Scam': {\r\n    tolerancePx: 14,\r\n    requiredTargets: ['ALL_NUMBERS', 'OUTER_BULL'],\r\n    criticalZones: ['TARGET_NUMBER', 'OUTER_BULL'],\r\n    minConfidence: 70\r\n  },\r\n  'Fives': {\r\n    tolerancePx: 14,\r\n    requiredTargets: ['ALL_NUMBERS', 'OUTER_BULL'],\r\n    criticalZones: ['5', '10', '15', '20'],\r\n    minConfidence: 70\r\n  },\r\n  'Sevens': {\r\n    tolerancePx: 14,\r\n    requiredTargets: ['ALL_NUMBERS', 'OUTER_BULL'],\r\n    criticalZones: ['7', '14'],\r\n    minConfidence: 70\r\n  },\r\n}\r\n\r\n/**\r\n * Evaluate calibration quality for a specific game mode\r\n * Returns confidence level 0-100\r\n */\r\nexport function getCalibrationConfidenceForGame(\r\n  gameMode: string,\r\n  errorPx: number | null\r\n): number {\r\n  if (!errorPx || errorPx < 0) return 0\r\n\r\n  const req = GAME_CALIBRATION_REQUIREMENTS[gameMode]\r\n  if (!req) return 50 // Unknown game, neutral confidence\r\n\r\n  // Confidence drops as error increases beyond tolerance\r\n  if (errorPx <= req.tolerancePx) {\r\n    // Excellent calibration\r\n    return Math.min(100, 100 - (errorPx / req.tolerancePx) * 20)\r\n  } else {\r\n    // Poor calibration - drops steeply\r\n    const excess = errorPx - req.tolerancePx\r\n    return Math.max(0, 50 - excess * 2)\r\n  }\r\n}\r\n\r\n/**\r\n * Check if calibration is suitable for a game\r\n */\r\nexport function isCalibrationSuitableForGame(\r\n  gameMode: string,\r\n  errorPx: number | null\r\n): boolean {\r\n  if (!errorPx) return false\r\n\r\n  const req = GAME_CALIBRATION_REQUIREMENTS[gameMode]\r\n  if (!req) return true // Unknown game, assume suitable\r\n\r\n  const confidence = getCalibrationConfidenceForGame(gameMode, errorPx)\r\n  return confidence >= req.minConfidence\r\n}\r\n\r\n/**\r\n * Get a human-readable assessment of calibration quality\r\n */\r\nexport function getCalibrationQualityText(\r\n  gameMode: string,\r\n  errorPx: number | null\r\n): { quality: 'excellent' | 'good' | 'fair' | 'poor' | 'none'; text: string } {\r\n  if (!errorPx) {\r\n    return { quality: 'none', text: 'Not calibrated' }\r\n  }\r\n\r\n  const confidence = getCalibrationConfidenceForGame(gameMode, errorPx)\r\n\r\n  if (confidence >= 90) {\r\n    return { quality: 'excellent', text: `Excellent (${Math.round(confidence)}%)` }\r\n  } else if (confidence >= 75) {\r\n    return { quality: 'good', text: `Good (${Math.round(confidence)}%)` }\r\n  } else if (confidence >= 50) {\r\n    return { quality: 'fair', text: `Fair (${Math.round(confidence)}%)` }\r\n  } else {\r\n    return { quality: 'poor', text: `Poor (${Math.round(confidence)}%)` }\r\n  }\r\n}\r\n\r\n/**\r\n * Get personalized recalibration recommendation for a game\r\n */\r\nexport function getRecalibrationRecommendation(gameMode: string): string | null {\r\n  const req = GAME_CALIBRATION_REQUIREMENTS[gameMode]\r\n  if (!req || req.criticalZones.length === 0) return null\r\n\r\n  const zones = req.criticalZones.join(', ')\r\n  return `Recalibrate focusing on: ${zones}`\r\n}\r\n\r\n/**\r\n * Get all games sorted by calibration difficulty (strictest first)\r\n */\r\nexport function getGamesByCalibrationDifficulty(): string[] {\r\n  return Object.entries(GAME_CALIBRATION_REQUIREMENTS)\r\n    .sort((a, b) => a[1].tolerancePx - b[1].tolerancePx)\r\n    .map(([name]) => name)\r\n}\r\n","import { useEffect, useMemo, useState } from 'react'\r\nimport BarChart from './BarChart'\r\nimport TabPills from './ui/TabPills'\r\nimport { getGameModeStats } from '../store/profileStats'\r\nimport { allGames } from '../utils/games'\r\nimport { useWS } from './WSProvider'\r\nimport StatusDot from './ui/StatusDot'\r\nimport CameraStatusBadge from './CameraStatusBadge'\r\nimport HelpdeskChat from './HelpdeskChat'\r\nimport { useCalibration } from '../store/calibration'\r\nimport { getCalibrationConfidenceForGame, getCalibrationQualityText } from '../utils/gameCalibrationRequirements'\r\n\r\nconst OWNER_EMAIL = 'daviesfamily108@gmail.com'\r\n\r\nexport default function AdminDashboard({ user }: { user: any }) {\r\n\tconst ws = (() => { try { return useWS() } catch { return null } })()\r\n\tconst [admins, setAdmins] = useState<string[]>([])\r\n\tconst [email, setEmail] = useState('')\r\n\tconst [status, setStatus] = useState<any>(null)\r\n\tconst [announcement, setAnnouncement] = useState('')\r\n\tconst [loading, setLoading] = useState(false)\r\n\tconst [tournaments, setTournaments] = useState<any[]>([])\r\n\t\tconst [withdrawals, setWithdrawals] = useState<any[]>([])\r\n\tconst [userSearch, setUserSearch] = useState('')\r\n\tconst [userResults, setUserResults] = useState<any[]>([])\r\n\tconst [createForm, setCreateForm] = useState<any>({\r\n\t\ttitle: 'Official Tournament',\r\n\t\tgame: 'X01',\r\n\t\tmode: 'bestof',\r\n\t\tvalue: 3,\r\n\t\tdescription: '',\r\n\t\tstartAt: new Date(Date.now() + 2*60*60*1000).toISOString().slice(0,16),\r\n\t\tcheckinMinutes: 30,\r\n\t\tcapacity: 16,\r\n\t\tprizeType: 'premium',\r\n\t\tprizeAmount: 3,\r\n\t\t\tcurrency: 'GBP',\r\n\t\tprizeNotes: '',\r\n\t})\r\n\tconst [emailCopy, setEmailCopy] = useState<any>({ reset:{}, reminder:{}, confirmEmail:{}, changed:{} })\r\n\tconst [preview, setPreview] = useState<{ open: boolean, kind?: string, html?: string }>({ open: false })\r\n\tconst [activeTab, setActiveTab] = useState<'general' | 'maintenance' | 'premium' | 'helpdesk' | 'tourneys'>('general')\r\n\tconst isOwner = user?.email?.toLowerCase() === OWNER_EMAIL\r\n  const [winners, setWinners] = useState<any[]>([])\r\n\t\tconst [reports, setReports] = useState<any[]>([])\r\n\tconst [helpRequests, setHelpRequests] = useState<any[]>([])\r\n\tconst [helpTyping, setHelpTyping] = useState<Record<string, { who: string, ts: number }>>({})\r\n\tconst [selectedRequest, setSelectedRequest] = useState<any | null>(null)\r\n\tconst [logs, setLogs] = useState<any[]>([])\r\n\tconst [systemHealth, setSystemHealth] = useState<any>(null)\r\n\tconst [clusteringEnabled, setClusteringEnabled] = useState(false)\r\n\tconst [clusterCapacity, setClusterCapacity] = useState(1500)\r\n\r\n\t// --- Game usage (played/won per mode) ---\r\n\tconst [gmVersion, setGmVersion] = useState(0)\r\n\tuseEffect(() => {\r\n\t\tconst on = () => setGmVersion(v => v + 1)\r\n\t\twindow.addEventListener('ndn:stats-updated', on as any)\r\n\t\treturn () => window.removeEventListener('ndn:stats-updated', on as any)\r\n\t}, [])\r\n\tconst gmStats = useMemo(() => getGameModeStats(allGames as unknown as string[]), [gmVersion])\r\n\t\r\n\t// Calibration data and preview effect\r\n\tconst cal = useCalibration()\r\n\t\r\n\tuseEffect(() => {\r\n\t\tif (!preview.open) return\r\n\t\tfunction onKey(e: KeyboardEvent) { if (e.key === 'Escape') setPreview({ open: false }) }\r\n\t\tdocument.addEventListener('keydown', onKey)\r\n\t\treturn () => document.removeEventListener('keydown', onKey)\r\n\t}, [preview.open])\r\n\r\n\t// Calibration quality display\r\n\tconst calibQuality = useMemo(() => {\r\n\t\tconst errorPx = cal.errorPx ?? null\r\n\t\tconst items: any[] = []\r\n\t\tfor (const game of allGames) {\r\n\t\t\tconst confidence = getCalibrationConfidenceForGame(game, errorPx)\r\n\t\t\tconst qualityInfo = getCalibrationQualityText(game, errorPx)\r\n\t\t\titems.push({ game, confidence, qualityInfo })\r\n\t\t}\r\n\t\treturn items\r\n\t}, [cal.errorPx])\r\n\r\n\t// Lightweight derived bars for the Game Usage chart\r\n\tconst gmBars: any[] = useMemo(() => {\r\n\t\tconst bars: any[] = []\r\n\t\tif (gmStats && typeof gmStats === 'object') {\r\n\t\t\tfor (const [gameKey, stats] of Object.entries(gmStats as any)) {\r\n\t\t\t\tconst s = stats as any\r\n\t\t\t\tbars.push({\r\n\t\t\t\t\tlabel: gameKey,\r\n\t\t\t\t\tvalue: s?.played || 0,\r\n\t\t\t\t\twon: s?.won || 0\r\n\t\t\t\t})\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn bars\r\n\t}, [gmStats])\r\n\r\n\t// Refresh common admin data (help requests, admins, tournaments)\r\n\tasync function refresh() {\r\n\t\ttry {\r\n\t\t\tconst headers = { Authorization: `Bearer ${localStorage.getItem('authToken')}` }\r\n\t\t\tconst [hrRes, adminsRes, tRes] = await Promise.all([\r\n\t\t\t\tfetch('/api/admin/help-requests', { headers }),\r\n\t\t\t\tfetch('/api/admins', { headers }),\r\n\t\t\t\tfetch('/api/tournaments', { headers }),\r\n\t\t\t])\r\n\t\t\tif (hrRes.ok) {\r\n\t\t\t\tconst d = await hrRes.json();\r\n\t\t\t\tsetHelpRequests(Array.isArray(d) ? d : (d.requests || []))\r\n\t\t\t}\r\n\t\t\tif (adminsRes.ok) {\r\n\t\t\t\tconst d = await adminsRes.json();\r\n\t\t\t\tsetAdmins(Array.isArray(d) ? d : (d.admins || []))\r\n\t\t\t}\r\n\t\t\tif (tRes.ok) {\r\n\t\t\t\tconst d = await tRes.json();\r\n\t\t\t\tsetTournaments(Array.isArray(d) ? d : (d.tournaments || d))\r\n\t\t\t}\r\n\t\t} catch (e) {\r\n\t\t\tconsole.error('refresh failed', e)\r\n\t\t}\r\n\t}\r\n\r\n\tasync function revoke(target: string) {\r\n\t\ttry {\r\n\t\t\tawait fetch('/api/admins/revoke', { method: 'POST', headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${localStorage.getItem('authToken')}` }, body: JSON.stringify({ email: target }) })\r\n\t\t\tawait refresh()\r\n\t\t} catch {}\r\n\t}\r\n\r\n\tasync function grantPremium(email: string, days: number) {\r\n\t\tif (!email) return\r\n\t\ttry {\r\n\t\t\tawait fetch('/api/admin/premium/grant', { method:'POST', headers: { 'Content-Type':'application/json', Authorization: `Bearer ${localStorage.getItem('authToken')}` }, body: JSON.stringify({ email, days }) })\r\n\t\t\tawait refresh()\r\n\t\t} catch {}\r\n\t}\r\n\r\n\tasync function revokePremium(email: string) {\r\n\t\ttry {\r\n\t\t\tawait fetch('/api/admin/premium/revoke', { method:'POST', headers: { 'Content-Type':'application/json', Authorization: `Bearer ${localStorage.getItem('authToken')}` }, body: JSON.stringify({ email }) })\r\n\t\t\tawait refresh()\r\n\t\t} catch {}\r\n\t}\r\n\r\n\tasync function sendAnnouncement() {\r\n\t\tif (!announcement.trim()) return\r\n\t\ttry {\r\n\t\t\tawait fetch('/api/admin/announce', { method: 'POST', headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${localStorage.getItem('authToken')}` }, body: JSON.stringify({ message: announcement }) })\r\n\t\t\tsetAnnouncement('')\r\n\t\t\tawait refresh()\r\n\t\t} catch {}\r\n\t}\r\n\r\n\tasync function toggleMaintenance(next: boolean) {\r\n\t\ttry {\r\n\t\t\tawait fetch('/api/admin/maintenance', { method: 'POST', headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${localStorage.getItem('authToken')}` }, body: JSON.stringify({ maintenance: next }) })\r\n\t\t\tawait refresh()\r\n\t\t} catch {}\r\n\t}\r\n\r\n\r\n\t\t// Listen for help-typing and help-request events over WS to show live typing indicators and new requests\r\n\t\tuseEffect(() => {\r\n\t\t\tif (!ws) return\r\n\t\t\tconst unsub = ws.addListener((data: any) => {\r\n\t\t\t\ttry {\r\n\t\t\t\t\tif (data?.type === 'help-typing') {\r\n\t\t\t\t\t\tconst rid = String(data.requestId || '')\r\n\t\t\t\t\t\tif (!rid) return\r\n\t\t\t\t\t\tsetHelpTyping(prev => ({ ...prev, [rid]: { who: data.fromName || 'someone', ts: Date.now() } }))\r\n\t\t\t\t\t\treturn\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif (data?.type === 'help-request') {\r\n\t\t\t\t\t\tconst req = data.request\r\n\t\t\t\t\t\tif (!req || !req.id) return\r\n\t\t\t\t\t\tsetHelpRequests(prev => {\r\n\t\t\t\t\t\t\tconst filtered = (prev || []).filter((r:any) => String(r.id) !== String(req.id))\r\n\t\t\t\t\t\t\treturn [req, ...filtered]\r\n\t\t\t\t\t\t})\r\n\t\t\t\t\t\treturn\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif (data?.type === 'help-request-updated') {\r\n\t\t\t\t\t\trefresh()\r\n\t\t\t\t\t}\r\n\t\t\t\t} catch {}\r\n\t\t\t})\r\n\t\t\tconst iv = setInterval(() => {\r\n\t\t\t\tconst now = Date.now()\r\n\t\t\t\tlet changed = false\r\n\t\t\t\tconst copy = { ...helpTyping }\r\n\t\t\t\tfor (const k of Object.keys(copy)) {\r\n\t\t\t\t\tif (now - copy[k].ts > 3500) { delete copy[k]; changed = true }\r\n\t\t\t\t}\r\n\t\t\t\tif (changed) setHelpTyping(copy)\r\n\t\t\t}, 1500)\r\n\t\t\treturn () => { try { unsub() } catch {} ; clearInterval(iv) }\r\n\t\t}, [ws])\r\n\r\n\r\n\tasync function claimHelp(id: string) {\r\n\t\ttry {\r\n\t\t\tconst headers = { 'Content-Type': 'application/json', Authorization: `Bearer ${localStorage.getItem('authToken')}` }\r\n\t\t\tconst res = await fetch(`/api/admin/help-requests/${encodeURIComponent(id)}/claim`, { method: 'POST', headers, body: JSON.stringify({ }) })\r\n\t\t\tif (res.ok) { await refresh() }\r\n\t\t} catch {}\r\n\t}\r\n\r\n\tasync function resolveHelp(id: string) {\r\n\t\ttry {\r\n\t\t\tconst headers = { 'Content-Type': 'application/json', Authorization: `Bearer ${localStorage.getItem('authToken')}` }\r\n\t\t\tconst res = await fetch(`/api/admin/help-requests/${encodeURIComponent(id)}/resolve`, { method: 'POST', headers, body: JSON.stringify({ }) })\r\n\t\t\tif (res.ok) { await refresh() }\r\n\t\t} catch {}\r\n\t}\r\n\r\n\tasync function grant() {\r\n\t\tif (!email) return\r\n\t\tawait fetch('/api/admins/grant', { method: 'POST', headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${localStorage.getItem('authToken')}` }, body: JSON.stringify({ email }) })\r\n\t\tsetEmail('')\r\n\t\t\t\t\t\r\n\t}\r\n\r\n\tasync function searchUsers() {\r\n\t\tif (!userSearch.trim()) return\r\n\t\ttry {\r\n\t\t\tconst authHeader = { Authorization: `Bearer ${localStorage.getItem('authToken')}` }\r\n\t\t\tconst res = await fetch(`/api/admin/users/search?q=${encodeURIComponent(userSearch)}`, { headers: authHeader })\r\n\t\t\tif (res.ok) {\r\n\t\t\t\tconst data = await res.json()\r\n\t\t\t\tsetUserResults(Array.isArray(data.users) ? data.users : [])\r\n\t\t\t}\r\n\t\t} catch (error) {\r\n\t\t\tconsole.error('Search failed:', error)\r\n\t\t}\r\n\t}\r\n\r\n\tasync function banUser(email: string) {\r\n\t\ttry {\r\n\t\t\tawait fetch('/api/admin/users/ban', { \r\n\t\t\t\tmethod: 'POST', \r\n\t\t\t\theaders: { 'Content-Type': 'application/json', Authorization: `Bearer ${localStorage.getItem('authToken')}` }, \r\n\t\t\t\tbody: JSON.stringify({ email }) \r\n\t\t\t})\r\n\t\t\tawait searchUsers() // Refresh results\r\n\t\t} catch (error) {\r\n\t\t\tconsole.error('Ban failed:', error)\r\n\t\t}\r\n\t}\r\n\r\n\tasync function unbanUser(email: string) {\r\n\t\ttry {\r\n\t\t\tawait fetch('/api/admin/users/unban', { \r\n\t\t\t\tmethod: 'POST', \r\n\t\t\t\theaders: { 'Content-Type': 'application/json', Authorization: `Bearer ${localStorage.getItem('authToken')}` }, \r\n\t\t\t\tbody: JSON.stringify({ email }) \r\n\t\t\t})\r\n\t\t\tawait searchUsers() // Refresh results\r\n\t\t} catch (error) {\r\n\t\t\tconsole.error('Unban failed:', error)\r\n\t\t}\r\n\t}\r\n\r\n\tasync function flipPremium(next: boolean) {\r\n\t\tsetLoading(true)\r\n\t\ttry {\r\n\t\t\tawait fetch('/api/admin/subscription', { method: 'POST', headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${localStorage.getItem('authToken')}` }, body: JSON.stringify({ fullAccess: next }) })\r\n\t\t\tawait refresh()\r\n\t\t} finally { setLoading(false) }\r\n\t}\r\n\r\n\tasync function createOfficialTournament() {\r\n\t\tsetLoading(true)\r\n\t\ttry {\r\n\t\t\tconst start = new Date(createForm.startAt).getTime()\r\n\t\t\tconst res = await fetch('/api/tournaments/create', {\r\n\t\t\t\tmethod: 'POST', headers: { 'Content-Type': 'application/json' },\r\n\t\t\t\tbody: JSON.stringify({\r\n\t\t\t\t\ttitle: createForm.title,\r\n\t\t\t\t\tgame: createForm.game,\r\n\t\t\t\t\tmode: createForm.mode,\r\n\t\t\t\t\tvalue: Number(createForm.value),\r\n\t\t\t\t\tdescription: createForm.description,\r\n\t\t\t\t\tstartAt: start,\r\n\t\t\t\t\tcheckinMinutes: Number(createForm.checkinMinutes),\r\n\t\t\t\t\tcapacity: Number(createForm.capacity),\r\n\t\t\t\t\trequireCalibration: !!createForm.requireCalibration,\r\n\t\t\t\t\tcreatorEmail: user?.email,\r\n\t\t\t\t\tcreatorName: user?.username,\r\n\t\t\t\t\trequesterEmail: user?.email,\r\n\t\t\t\t\tofficial: true,\r\n\t\t\t\t\tprizeType: createForm.prizeType,\r\n\t\t\t\t\tprizeAmount: Number(createForm.prizeAmount||0),\r\n\t\t\t\t\tcurrency: createForm.currency,\r\n\t\t\t\t\tprizeNotes: createForm.prizeNotes,\r\n\t\t\t\t})\r\n\t\t\t})\r\n\t\t\t// refresh admin view and broadcast will update lobby for connected clients\r\n\t\t\tawait refresh()\r\n\t\t\ttry {\r\n\t\t\t\t// If creation returned the tournament id, navigate the app to the tournaments tab so lobby is visible\r\n\t\t\t\tconst data = await res.json()\r\n\t\t\t\tif (data && data.tournament && data.tournament.id) {\r\n\t\t\t\t\twindow.dispatchEvent(new CustomEvent('ndn:change-tab', { detail: { tab: 'tournaments' } }))\r\n\t\t\t\t}\r\n\t\t\t} catch {}\r\n\t\t} finally { setLoading(false) }\r\n\t}\r\n\r\n\tasync function setWinner(tid: string, winnerEmail: string) {\r\n\t\tsetLoading(true)\r\n\t\ttry {\r\n\t\t\tawait fetch('/api/admin/tournaments/winner', { method: 'POST', headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${localStorage.getItem('authToken')}` }, body: JSON.stringify({ tournamentId: tid, winnerEmail }) })\r\n\t\t\tawait refresh()\r\n\t\t} finally { setLoading(false) }\r\n\t}\r\n\r\n\tasync function markPaid(tid: string) {\r\n\t\tsetLoading(true)\r\n\t\ttry {\r\n\t\t\tawait fetch('/api/admin/tournaments/mark-paid', { method: 'POST', headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${localStorage.getItem('authToken')}` }, body: JSON.stringify({ tournamentId: tid }) })\r\n\t\t\tawait refresh()\r\n\t\t} finally { setLoading(false) }\r\n\t}\r\n\r\n\tasync function deleteTournament(tid: string) {\r\n\t\tsetLoading(true)\r\n\t\ttry {\r\n\t\t\tawait fetch('/api/admin/tournaments/delete', { method: 'POST', headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${localStorage.getItem('authToken')}` }, body: JSON.stringify({ tournamentId: tid }) })\r\n\t\t\tawait refresh()\r\n\t\t} finally { setLoading(false) }\r\n\t}\r\n\r\n\tasync function reseedWeekly() {\r\n\t\tsetLoading(true)\r\n\t\ttry {\r\n\t\t\tawait fetch('/api/admin/tournaments/reseed-weekly', { method: 'POST', headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${localStorage.getItem('authToken')}` }, body: JSON.stringify({ }) })\r\n\t\t\tawait refresh()\r\n\t\t} finally { setLoading(false) }\r\n\t}\r\n\r\n\t\tasync function decideWithdrawal(id: string, approve: boolean) {\r\n\t\t\tsetLoading(true)\r\n\t\t\ttry {\r\n\t\t\t\tawait fetch('/api/admin/wallet/withdrawals/decide', { method: 'POST', headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${localStorage.getItem('authToken')}` }, body: JSON.stringify({ id, approve }) })\r\n\t\t\t\tawait refresh()\r\n\t\t\t} finally { setLoading(false) }\r\n\t\t}\r\n\r\n\tasync function deleteMatch(id: string) {\r\n\t\tsetLoading(true)\r\n\t\ttry {\r\n\t\t\t\tawait fetch('/api/admin/matches/delete', { method: 'POST', headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${localStorage.getItem('authToken')}` }, body: JSON.stringify({ matchId: id }) })\r\n\t\t\tawait refresh()\r\n\t\t} finally { setLoading(false) }\r\n\t}\r\n\r\n\tasync function fetchLogs() {\r\n\t\ttry {\r\n\t\t\tconst authHeader = { Authorization: `Bearer ${localStorage.getItem('authToken')}` }\r\n\t\t\tconst res = await fetch('/api/admin/logs', { headers: authHeader })\r\n\t\t\tif (res.ok) {\r\n\t\t\t\tconst data = await res.json()\r\n\t\t\t\tif (data?.ok) setLogs(data.logs || [])\r\n\t\t\t}\r\n\t\t} catch (error) {\r\n\t\t\tconsole.error('Failed to fetch logs:', error)\r\n\t\t}\r\n\t}\r\n\r\n\tasync function fetchSystemHealth() {\r\n\t\ttry {\r\n\t\t\tconst authHeader = { Authorization: `Bearer ${localStorage.getItem('authToken')}` }\r\n\t\t\tconst res = await fetch('/api/admin/system-health', { headers: authHeader })\r\n\t\t\tif (res.ok) {\r\n\t\t\t\tconst data = await res.json()\r\n\t\t\t\tif (data?.ok && data?.health) {\r\n\t\t\t\t\tsetSystemHealth({\r\n\t\t\t\t\t\tdatabase: data.health.database || false,\r\n\t\t\t\t\t\twebsocket: data.health.websocket || false,\r\n\t\t\t\t\t\thttps: data.health.https || false,\r\n\t\t\t\t\t\tmaintenance: data.health.maintenance || false,\r\n\t\t\t\t\t\tclustering: data.health.clustering || false,\r\n\t\t\t\t\t\tuptime: data.health.uptime || 0,\r\n\t\t\t\t\t\tmemory: data.health.memory || { heapUsed: 0 },\r\n\t\t\t\t\t\tversion: data.health.version || 'unknown'\r\n\t\t\t\t\t})\r\n\t\t\t\t\tsetClusteringEnabled(data.health?.clustering || false)\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t} catch (error) {\r\n\t\t\tconsole.error('Failed to fetch system health:', error)\r\n\t\t}\r\n\t}\r\n\r\n\tasync function toggleClustering(enable: boolean) {\r\n\t\tsetLoading(true)\r\n\t\ttry {\r\n\t\t\tconst res = await fetch('/api/admin/clustering', {\r\n\t\t\t\tmethod: 'POST',\r\n\t\t\t\theaders: { 'Content-Type': 'application/json', Authorization: `Bearer ${localStorage.getItem('authToken')}` },\r\n\t\t\t\tbody: JSON.stringify({ enabled: enable, maxWorkers: 4, capacity: clusterCapacity })\r\n\t\t\t})\r\n\t\t\tconst data = await res.json()\r\n\t\t\tconsole.log('Clustering response:', data)\r\n\t\t\tif (data?.ok) {\r\n\t\t\t\talert(`Clustering ${enable ? 'enabled' : 'disabled'} successfully. Max capacity: ${clusterCapacity.toLocaleString()} concurrent users. NODE_WORKERS environment variable is set to max capacity.`)\r\n\t\t\t\tawait fetchSystemHealth()\r\n\t\t\t} else {\r\n\t\t\t\talert(`Failed: ${data?.error || data?.message || 'Unknown error'}`)\r\n\t\t\t}\r\n\t\t} catch (error) {\r\n\t\t\tconsole.error('Clustering toggle failed:', error)\r\n\t\t\talert('Clustering toggle failed: ' + (error instanceof Error ? error.message : String(error)))\r\n\t\t} finally {\r\n\t\t\tsetLoading(false)\r\n\t\t}\r\n\t}\r\n\r\n\tasync function updateClusterCapacity(newCapacity: number) {\r\n\t\tsetClusterCapacity(newCapacity)\r\n\t\t// Capacity is updated locally and sent when clustering toggle is used\r\n\t}\r\n\r\n\tasync function runQuickFix(action: string) {\r\n\t\tsetLoading(true)\r\n\t\ttry {\r\n\t\t\tconst res = await fetch('/api/admin/quick-fix', {\r\n\t\t\t\tmethod: 'POST',\r\n\t\t\t\theaders: { 'Content-Type': 'application/json', Authorization: `Bearer ${localStorage.getItem('authToken')}` },\r\n\t\t\t\tbody: JSON.stringify({ action })\r\n\t\t\t})\r\n\t\t\tconst data = await res.json()\r\n\t\t\tif (data?.ok) {\r\n\t\t\t\talert(`${action} completed successfully`)\r\n\t\t\t\tawait fetchSystemHealth() // Refresh health data\r\n\t\t\t} else {\r\n\t\t\t\talert(`Failed: ${data?.error || 'Unknown error'}`)\r\n\t\t\t}\r\n\t\t} catch (error) {\r\n\t\t\tconsole.error('Quick fix failed:', error)\r\n\t\t\talert('Quick fix failed')\r\n\t\t} finally {\r\n\t\t\tsetLoading(false)\r\n\t\t}\r\n\t}\r\n\r\n\tasync function loadEmailCopy() {\r\n\t\ttry {\r\n\t\t\tconst authHeader = { Authorization: `Bearer ${localStorage.getItem('authToken')}` }\r\n\t\t\tconst res = await fetch('/api/admin/email-copy', { headers: authHeader })\r\n\t\t\tif (res.ok) {\r\n\t\t\t\tconst d = await res.json()\r\n\t\t\t\tif (d?.ok) setEmailCopy(d.copy || emailCopy)\r\n\t\t\t}\r\n\t\t} catch {}\r\n\t}\r\n\tuseEffect(()=>{ if (isOwner) loadEmailCopy() }, [isOwner])\r\n\r\n\tuseEffect(() => {\r\n\t\tif (isOwner && (activeTab === 'general' || activeTab === 'maintenance')) {\r\n\t\t\tfetchLogs()\r\n\t\t\tfetchSystemHealth()\r\n\t\t}\r\n\t}, [isOwner, activeTab])\r\n\r\n\tasync function saveEmailCopy(kind: string, payload: any) {\r\n\t\tawait fetch('/api/admin/email-copy', { method:'POST', headers:{'Content-Type':'application/json', Authorization: `Bearer ${localStorage.getItem('authToken')}`}, body: JSON.stringify({ kind, ...payload }) })\r\n\t\tawait loadEmailCopy()\r\n\t}\r\n\r\n\tasync function openInlinePreview(kind: string, openInNewTab?: boolean) {\r\n\t\ttry {\r\n\t\t\tconst authHeader = { Authorization: `Bearer ${localStorage.getItem('authToken')}` }\r\n\t\t\tconst res = await fetch(`/api/email/preview?kind=${encodeURIComponent(kind)}`, { headers: authHeader })\r\n\t\t\tconst html = await res.text()\r\n\t\t\tif (openInNewTab) {\r\n\t\t\t\tconst w = window.open()\r\n\t\t\t\tif (w) {\r\n\t\t\t\t\tw.document.open()\r\n\t\t\t\t\tw.document.write(html)\r\n\t\t\t\t\tw.document.close()\r\n\t\t\t\t\treturn\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tsetPreview({ open: true, kind, html })\r\n\t\t} catch {\r\n\t\t\tsetPreview({ open: true, kind, html: '<!doctype html><html><body style=\"font-family:sans-serif;padding:16px\">Failed to load preview.</body></html>' })\r\n\t\t}\r\n\t}\r\n\r\n\tuseEffect(() => {\r\n\t\tif (!preview.open) return\r\n\t\tfunction onKey(e: KeyboardEvent) { if (e.key === 'Escape') setPreview({ open: false }) }\r\n\t\tdocument.addEventListener('keydown', onKey)\r\n\t\treturn () => document.removeEventListener('keydown', onKey)\r\n\t}, [preview.open])\r\n\r\n\tfunction EmailEditor({ kind, label }: { kind:string, label:string }) {\r\n\t\tconst key = kind === 'confirm-email' ? 'confirmEmail' : (kind === 'changed' ? 'changed' : kind)\r\n\t\tconst cfg = emailCopy?.[key] || { title:'', intro:'', buttonLabel:'' }\r\n\t\tconst [title, setTitle] = useState(cfg.title||'')\r\n\t\tconst [intro, setIntro] = useState(cfg.intro||'')\r\n\t\tconst [btn, setBtn] = useState(cfg.buttonLabel||'')\r\n\t\tuseEffect(()=>{ setTitle(cfg.title||''); setIntro(cfg.intro||''); setBtn(cfg.buttonLabel||'') }, [cfg.title, cfg.intro, cfg.buttonLabel])\r\n\r\n\t\treturn (\r\n\t\t\t<div className=\"p-2 rounded bg-black/20 space-y-2\">\r\n\t\t\t\t<div className=\"font-semibold\">{label}</div>\r\n\t\t\t\t<input className=\"input w-full\" placeholder=\"Title (optional)\" value={title} onChange={e=>setTitle(e.target.value)} />\r\n\t\t\t\t<textarea className=\"input w-full\" rows={2} placeholder=\"Intro line (optional)\" value={intro} onChange={e=>setIntro(e.target.value)} />\r\n\t\t\t\t<input className=\"input w-full\" placeholder=\"Button label (optional)\" value={btn} onChange={e=>setBtn(e.target.value)} />\r\n\t\t\t\t<div className=\"flex gap-2 justify-end\">\r\n\t\t\t\t\t<button className=\"btn\" type=\"button\" onClick={()=>openInlinePreview(kind, true)}>Preview</button>\r\n\t\t\t\t\t<button className=\"btn\" type=\"button\" onClick={()=>openInlinePreview(kind)}>Popup</button>\r\n\t\t\t\t\t<button className=\"btn\" onClick={()=>saveEmailCopy(kind, { title, intro, buttonLabel: btn })}>Save</button>\r\n\t\t\t\t</div>\r\n\t\t\t</div>\r\n\t\t)\r\n\t}\r\n\r\n\t\tif (!isOwner) { return (\r\n\t\t<div className=\"card\">\r\n\t\t\t<h2 className=\"text-2xl font-bold mb-2\">Admin</h2>\r\n\t\t\t<div className=\"text-sm opacity-80\">You dont have permission to manage admins.</div>\r\n\t\t</div>\r\n\t\t) }\r\n\r\n\t/* Top help-requests strip for quick admin actions */\r\n\t\t{helpRequests.length > 0 && (\r\n\t\t\t<div className=\"p-2 rounded-xl bg-amber-900/10 border border-amber-500/20 mt-3\">\r\n\t\t\t\t<div className=\"flex items-center justify-between\">\r\n\t\t\t\t\t<div className=\"flex items-center gap-3\">\r\n\t\t\t\t\t\t<span className=\"font-semibold\">Open Help Requests</span>\r\n\t\t\t\t\t\t<span className=\"text-sm opacity-80\">{helpRequests.length} open</span>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t\t<div className=\"flex items-center gap-2\">\r\n\t\t\t\t\t\t<button className=\"btn\" onClick={() => setSelectedRequest(helpRequests[0])}>Open Latest</button>\r\n\t\t\t\t\t\t<button className=\"btn btn-ghost\" onClick={() => refresh()}>Refresh</button>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t</div>\r\n\t\t\t\t<div className=\"mt-2 flex gap-2 overflow-x-auto\">\r\n\t\t\t\t\t{helpRequests.slice(0,6).map((hr:any) => (\r\n\t\t\t\t\t\t<div key={hr.id} className=\"p-2 rounded bg-black/10 border border-white/10 min-w-[220px]\">\r\n\t\t\t\t\t\t\t<div className=\"font-medium\">{hr.username || 'Anonymous'}</div>\r\n\t\t\t\t\t\t\t<div className=\"text-xs opacity-70\">{new Date(hr.ts || 0).toLocaleTimeString()}</div>\r\n\t\t\t\t\t\t\t<div className=\"text-sm truncate mt-1\">{hr.message}</div>\r\n\t\t\t\t\t\t\t<div className=\"mt-2 flex gap-2\">\r\n\t\t\t\t\t\t\t\t{hr.status === 'open' ? (\r\n\t\t\t\t\t\t\t\t\t<button className=\"btn\" onClick={() => claimHelp(hr.id)}>Claim</button>\r\n\t\t\t\t\t\t\t\t) : (\r\n\t\t\t\t\t\t\t\t\t<span className=\"text-xs opacity-70\">{hr.status} by {hr.claimedBy || ''}</span>\r\n\t\t\t\t\t\t\t\t)}\r\n\t\t\t\t\t\t\t\t<button className=\"btn\" onClick={() => setSelectedRequest(hr)}>Chat</button>\r\n\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t))}\r\n\t\t\t\t</div>\r\n\t\t\t</div>\r\n\t\t)}\r\n\r\n\treturn (\r\n\t\t\t<div className=\"space-y-4 ndn-game-shell\">\r\n\t\t\t\t{/* Top connection status strip */}\r\n\t\t\t\t<div className=\"card p-2 rounded-xl bg-white/10 border border-white/10 flex items-center justify-between gap-2 flex-wrap\">\r\n\t\t\t\t\t<div className=\"flex items-center gap-2 text-sm\">\r\n\t\t\t\t\t\t<span className=\"font-semibold\">Connection Status</span>\r\n\t\t\t\t\t\t{ws ? (\r\n\t\t\t\t\t\t\t<span className=\"inline-flex items-center gap-2\">\r\n\t\t\t\t\t\t\t\t<StatusDot status={ws.status} title={`WebSocket: ${ws.status}`} />\r\n\t\t\t\t\t\t\t\t<span className=\"text-xs opacity-80\">WS: {ws.status}</span>\r\n\t\t\t\t\t\t\t</span>\r\n\t\t\t\t\t\t) : (\r\n\t\t\t\t\t\t\t<span className=\"text-xs opacity-70\">WS: unavailable</span>\r\n\t\t\t\t\t\t)}\r\n\t\t\t\t\t</div>\r\n\t\t\t\t\t<div className=\"shrink-0 flex items-center gap-2\">\r\n\t\t\t\t\t\t{/* Keep the green connected badge; no HTTP/HTTPS pills here */}\r\n\t\t\t\t\t\t<CameraStatusBadge />\r\n\t\t\t\t\t\t{ws && (ws as any).reconnect && (\r\n\t\t\t\t\t\t\t<button\r\n\t\t\t\t\t\t\t\tonClick={() => (ws as any).reconnect()}\r\n\t\t\t\t\t\t\t\tclassName=\"ml-1 rounded-md bg-neutral-700/60 hover:bg-neutral-600/70 px-2.5 py-1 text-xs border border-white/10\"\r\n\t\t\t\t\t\t\t\ttitle=\"Force close and recreate the WebSocket connection\"\r\n\t\t\t\t\t\t\t>\r\n\t\t\t\t\t\t\t\tRecreate WS\r\n\t\t\t\t\t\t\t</button>\r\n\t\t\t\t\t\t)}\r\n\t\t\t\t\t</div>\r\n\t\t\t\t</div>\r\n\t\t{isOwner && (\r\n\t\t\t<TabPills\r\n\t\t\t\ttabs={[\r\n\t\t\t\t\t{ key: 'general', label: 'General' },\r\n\t\t\t\t\t{ key: 'maintenance', label: 'Maintenance' },\r\n\t\t\t\t\t{ key: 'premium', label: 'Premium' },\r\n\t\t\t\t\t{ key: 'tourneys', label: 'Tourneys' },\r\n\t\t\t\t\t{ key: 'helpdesk', label: 'Help Desk' }\r\n\t\t\t\t]}\r\n\t\t\t\tactive={activeTab}\r\n\t\t\t\tonChange={(key) => setActiveTab(key as 'general' | 'maintenance' | 'premium' | 'helpdesk' | 'tourneys')}\r\n\t\t\t\tclassName=\"mb-4\"\r\n\t\t\t/>\r\n\t\t)}\t\t\t{activeTab === 'general' && (\r\n\t\t\t\t<>\r\n\t\t\t\t\t{isOwner && (\r\n\t\t\t\t\t\t<div className=\"card\">\r\n\t\t\t\t\t\t\t<h3 className=\"text-xl font-semibold mb-2\">Game Usage</h3>\r\n\t\t\t\t\t\t\t<div className=\"rounded-xl border border-indigo-500/40 bg-indigo-500/10 p-3\">\r\n\t\t\t\t\t\t\t\t<BarChart data={gmBars.map(d => ({ label: '', value: d.value }))} />\r\n\t\t\t\t\t\t\t\t<div className=\"mt-2 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-2 text-[11px] opacity-80\">\r\n\t\t\t\t\t\t\t\t\t{gmBars.map((d, i) => (\r\n\t\t\t\t\t\t\t\t\t\t<div key={i} className=\"flex items-center justify-between px-2 py-1 rounded-md bg-white/5 border border-white/10\">\r\n\t\t\t\t\t\t\t\t\t\t\t<span className=\"truncate mr-2\">{d.label}</span>\r\n\t\t\t\t\t\t\t\t\t\t\t<span className=\"whitespace-nowrap\">Played {d.value}  Won {d.won}</span>\r\n\t\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t\t))}\r\n\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t)}\r\n\r\n\t\t\t\t\t{isOwner && (\r\n\t\t\t\t\t\t<div className=\"card\">\r\n\t\t\t\t\t\t\t<h3 className=\"text-xl font-semibold mb-2\">Calibration Quality Status</h3>\r\n\t\t\t\t\t\t\t<div className=\"text-sm opacity-80 mb-3\">Camera calibration confidence by game mode. Shows current system calibration readiness for each game.</div>\r\n\t\t\t\t\t\t\t<div className=\"rounded-xl border border-amber-500/40 bg-amber-500/5 p-3\">\r\n\t\t\t\t\t\t\t\t<div className=\"grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-2 text-[11px]\">\r\n\t\t\t\t\t\t\t\t\t{calibQuality.map((item) => {\r\n\t\t\t\t\t\t\t\t\t\tconst colorClass = item.confidence >= 85 ? 'bg-emerald-500/20 border-emerald-500/40 text-emerald-200' \r\n\t\t\t\t\t\t\t\t\t\t\t: item.confidence >= 70 ? 'bg-amber-500/20 border-amber-500/40 text-amber-200'\r\n\t\t\t\t\t\t\t\t\t\t\t: 'bg-rose-500/20 border-rose-500/40 text-rose-200'\r\n\t\t\t\t\t\t\t\t\t\treturn (\r\n\t\t\t\t\t\t\t\t\t\t\t<div key={item.game} className={`px-2 py-2 rounded-md border ${colorClass}`}>\r\n\t\t\t\t\t\t\t\t\t\t\t\t<div className=\"font-semibold text-xs truncate\">{item.game}</div>\r\n\t\t\t\t\t\t\t\t\t\t\t\t<div className=\"text-[10px] opacity-80 truncate\">{item.qualityInfo.quality}</div>\r\n\t\t\t\t\t\t\t\t\t\t\t\t<div className=\"text-[10px] font-mono mt-0.5\">{Math.round(item.confidence)}%</div>\r\n\t\t\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t\t\t)\r\n\t\t\t\t\t\t\t\t\t})}\r\n\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t)}\r\n\r\n\t\t\t\t\t<div className=\"card\">\r\n\t\t\t\t\t\t<h2 className=\"text-2xl font-bold mb-2\">Admin Control</h2>\r\n\t\t\t\t\t\t<div className=\"text-sm opacity-80 mb-3\">Grant or revoke Admin to trusted users. Only the owner can perform these actions.</div>\r\n\t\t\t\t\t\t<div className=\"flex gap-2 mb-3\">\r\n\t\t\t\t\t\t\t<input className=\"input flex-1\" placeholder=\"user@example.com\" value={email} onChange={e=>setEmail(e.target.value)} />\r\n\t\t\t\t\t\t\t<button className=\"btn\" disabled={loading} onClick={grant}>Grant</button>\r\n\t\t\t\t\t\t\t<button className=\"btn bg-rose-600 hover:bg-rose-700\" disabled={loading} onClick={() => revoke(email)}>Revoke</button>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t<div className=\"text-sm opacity-80 mb-2\">Current Admins:</div>\r\n\t\t\t\t\t\t<div className=\"flex flex-wrap gap-2 mb-4\">\r\n\t\t\t\t\t\t\t{admins.map((admin)=> (\r\n\t\t\t\t\t\t\t\t<div key={admin} className=\"px-2 py-1 rounded bg-indigo-600/20 border border-indigo-500/40 text-sm\">\r\n\t\t\t\t\t\t\t\t\t{admin}\r\n\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t))}\r\n\t\t\t\t\t\t</div>\r\n\r\n\t\t\t\t\t\t<hr className=\"border-indigo-500/20 my-4\" />\r\n\r\n\t\t\t\t\t\t<h3 className=\"text-lg font-semibold mb-2\">Premium Access Control</h3>\r\n\t\t\t\t\t\t<div className=\"text-sm opacity-80 mb-3\">Grant or revoke Premium subscription access to users (grants 30 days).</div>\r\n\t\t\t\t\t\t<div className=\"flex gap-2 mb-3\">\r\n\t\t\t\t\t\t\t<input className=\"input flex-1\" placeholder=\"user@example.com\" value={email} onChange={e=>setEmail(e.target.value)} />\r\n\t\t\t\t\t\t\t<button className=\"btn bg-emerald-600 hover:bg-emerald-700\" disabled={loading || !email.trim()} onClick={() => grantPremium(email, 30)}>Grant Premium</button>\r\n\t\t\t\t\t\t\t<button className=\"btn bg-rose-600 hover:bg-rose-700\" disabled={loading} onClick={() => revokePremium(email)}>Revoke Premium</button>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t<div className=\"text-sm opacity-80\">Premium grants provide 30 days of unlimited access to all features.</div>\r\n\t\t\t\t\t</div>\r\n\r\n\t\t\t\t\t<div className=\"card\">\r\n\t\t\t\t\t\t<h3 className=\"text-xl font-semibold mb-2\">Announcements</h3>\r\n\t\t\t\t\t\t<div className=\"text-sm opacity-80 mb-2\">Send a message to all users. This will appear as a toast notification.</div>\r\n\t\t\t\t\t\t<div className=\"flex gap-2\">\r\n\t\t\t\t\t\t\t<input className=\"input flex-1\" placeholder=\"Announcement message...\" value={announcement} onChange={e=>setAnnouncement(e.target.value)} />\r\n\t\t\t\t\t\t\t<button className=\"btn\" disabled={loading || !announcement.trim()} onClick={sendAnnouncement}>Send</button>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</div>\r\n\r\n\t\t\t\t\t<div className=\"card\">\r\n\t\t\t\t\t\t<h3 className=\"text-xl font-semibold mb-2\">User Search</h3>\r\n\t\t\t\t\t\t<div className=\"text-sm opacity-80 mb-2\">Search for users by email or name.</div>\r\n\t\t\t\t\t\t<div className=\"flex gap-2 mb-3\">\r\n\t\t\t\t\t\t\t<input className=\"input flex-1\" placeholder=\"Search users...\" value={userSearch} onChange={e=>setUserSearch(e.target.value)} />\r\n\t\t\t\t\t\t\t<button className=\"btn\" disabled={loading} onClick={searchUsers}>Search</button>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t{userResults.length > 0 && (\r\n\t\t\t\t\t\t\t<div className=\"space-y-2\">\r\n\t\t\t\t\t\t\t\t<div className=\"text-sm opacity-80 mb-2\">Results:</div>\r\n\t\t\t\t\t\t\t\t{userResults.map((u)=> (\r\n\t\t\t\t\t\t\t\t\t<div key={u.email} className=\"p-2 rounded bg-black/20 text-sm flex items-center justify-between\">\r\n\t\t\t\t\t\t\t\t\t\t<div>\r\n\t\t\t\t\t\t\t\t\t\t\t<div className=\"font-semibold\">{u.name || 'No name'}</div>\r\n\t\t\t\t\t\t\t\t\t\t\t<div className=\"opacity-70\">{u.email}</div>\r\n\t\t\t\t\t\t\t\t\t\t\t<div className=\"opacity-60 text-xs\">Joined {new Date(u.createdAt).toLocaleDateString()}</div>\r\n\t\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t))}\r\n\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t)}\r\n\t\t\t\t\t</div>\r\n\r\n\t\t\t\t\t{isOwner && (\r\n\t\t\t\t\t\t<div className=\"card\">\r\n\t\t\t\t\t\t\t<h3 className=\"text-xl font-semibold mb-3\">Email Templates</h3>\r\n\t\t\t\t\t\t\t<div className=\"text-sm opacity-80 mb-2\">Customize titles, intro lines, and button text. Previews open in a new tab or as a popup.</div>\r\n\t\t\t\t\t\t\t<div className=\"grid grid-cols-1 md:grid-cols-2 gap-3\">\r\n\t\t\t\t\t\t\t\t<EmailEditor kind=\"reset\" label=\"Password reset\" />\r\n\t\t\t\t\t\t\t\t<EmailEditor kind=\"reminder\" label=\"Password reset reminder\" />\r\n\t\t\t\t\t\t\t\t<EmailEditor kind=\"confirm-email\" label=\"Confirm new email\" />\r\n\t\t\t\t\t\t\t\t<EmailEditor kind=\"changed\" label=\"Password changed notice\" />\r\n\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t)}\r\n\t\t\t\t</>\r\n\t\t\t)}\r\n\r\n\t\t\t{activeTab === 'maintenance' && isOwner && (\r\n\t\t\t\t<>\r\n\t\t\t\t\t<div className=\"card\">\r\n\t\t\t\t\t\t<h3 className=\"text-xl font-semibold mb-2\">User Management</h3>\r\n\t\t\t\t\t\t<div className=\"text-sm opacity-80 mb-2\">Ban or unban users. Use with caution.</div>\r\n\t\t\t\t\t\t<div className=\"flex gap-2 mb-3\">\r\n\t\t\t\t\t\t\t<input className=\"input flex-1\" placeholder=\"user@example.com\" value={userSearch} onChange={e=>setUserSearch(e.target.value)} />\r\n\t\t\t\t\t\t\t<button className=\"btn\" disabled={loading} onClick={searchUsers}>Search</button>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t{userResults.length > 0 && (\r\n\t\t\t\t\t\t\t<div className=\"space-y-2\">\r\n\t\t\t\t\t\t\t\t<div className=\"text-sm opacity-80 mb-2\">Results:</div>\r\n\t\t\t\t\t\t\t\t{userResults.map((u)=> (\r\n\t\t\t\t\t\t\t\t\t<div key={u.email} className=\"p-2 rounded bg-black/20 text-sm flex items-center justify-between\">\r\n\t\t\t\t\t\t\t\t\t\t<div>\r\n\t\t\t\t\t\t\t\t\t\t\t<div className=\"font-semibold\">{u.name || 'No name'}</div>\r\n\t\t\t\t\t\t\t\t\t\t\t<div className=\"opacity-70\">{u.email}</div>\r\n\t\t\t\t\t\t\t\t\t\t\t<div className=\"opacity-60 text-xs\">Joined {new Date(u.createdAt).toLocaleDateString()}</div>\r\n\t\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t\t\t<div className=\"flex gap-2\">\r\n\t\t\t\t\t\t\t\t\t\t\t<button className=\"btn bg-red-600 hover:bg-red-700 text-xs\" onClick={()=>banUser(u.email)}>Ban</button>\r\n\t\t\t\t\t\t\t\t\t\t\t<button className=\"btn bg-green-600 hover:bg-green-700 text-xs\" onClick={()=>unbanUser(u.email)}>Unban</button>\r\n\t\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t))}\r\n\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t)}\r\n\t\t\t\t\t</div>\r\n\r\n\t\t\t\t\t<div className=\"card\">\r\n\t\t\t\t\t\t<h3 className=\"text-xl font-semibold mb-3\">Withdrawals</h3>\r\n\t\t\t\t\t\t<ul className=\"space-y-2\">\r\n\t\t\t\t\t\t\t{withdrawals.map((w:any) => (\r\n\t\t\t\t\t\t\t\t<li key={w.id} className=\"p-2 rounded bg-black/20 text-sm flex items-center justify-between\">\r\n\t\t\t\t\t\t\t\t\t<div>\r\n\t\t\t\t\t\t\t\t\t\t<div className=\"font-mono text-xs\">{w.id}</div>\r\n\t\t\t\t\t\t\t\t\t\t<div>{w.email}  {w.currency} {(w.amountCents/100).toFixed(2)}</div>\r\n\t\t\t\t\t\t\t\t\t\t<div className=\"opacity-70\">{w.status}  {new Date(w.requestedAt).toLocaleString()}</div>\r\n\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t\t<div className=\"flex gap-2\">\r\n\t\t\t\t\t\t\t\t\t\t{w.status==='pending' && (\r\n\t\t\t\t\t\t\t\t\t\t\t<>\r\n\t\t\t\t\t\t\t\t\t\t\t\t<button className=\"btn bg-emerald-600 hover:bg-emerald-700\" disabled={loading} onClick={()=>decideWithdrawal(w.id, true)}>Approve</button>\r\n\t\t\t\t\t\t\t\t\t\t\t\t<button className=\"btn bg-rose-600 hover:bg-rose-700\" disabled={loading} onClick={()=>decideWithdrawal(w.id, false)}>Reject</button>\r\n\t\t\t\t\t\t\t\t\t\t\t</>\r\n\t\t\t\t\t\t\t\t\t\t)}\r\n\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t</li>\r\n\t\t\t\t\t\t\t))}\r\n\t\t\t\t\t\t\t{withdrawals.length===0 && <li className=\"opacity-60\">No withdrawal requests.</li>}\r\n\t\t\t\t\t\t</ul>\r\n\t\t\t\t\t</div>\r\n\r\n\t\t\t\t\t<div className=\"card\">\r\n\t\t\t\t\t\t<h3 className=\"text-xl font-semibold mb-3\">System Health</h3>\r\n\t\t\t\t\t\t<div className=\"text-sm opacity-80 mb-3\">Current status of system components and services.</div>\r\n\t\t\t\t\t\t{systemHealth ? (\r\n\t\t\t\t\t\t\t<div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n\t\t\t\t\t\t\t\t<div className=\"space-y-2\">\r\n\t\t\t\t\t\t\t\t\t<div className=\"flex items-center justify-between\">\r\n\t\t\t\t\t\t\t\t\t\t<span>Database</span>\r\n\t\t\t\t\t\t\t\t\t\t<span className={`px-2 py-1 rounded text-xs ${systemHealth.database ? 'bg-emerald-600' : 'bg-red-600'}`}>\r\n\t\t\t\t\t\t\t\t\t\t\t{systemHealth.database ? 'Ready' : 'Down'}\r\n\t\t\t\t\t\t\t\t\t\t</span>\r\n\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t\t<div className=\"flex items-center justify-between\">\r\n\t\t\t\t\t\t\t\t\t\t<span>WebSocket</span>\r\n\t\t\t\t\t\t\t\t\t\t<span className={`px-2 py-1 rounded text-xs ${systemHealth.websocket ? 'bg-emerald-600' : 'bg-red-600'}`}>\r\n\t\t\t\t\t\t\t\t\t\t\t{systemHealth.websocket ? 'Ready' : 'Down'}\r\n\t\t\t\t\t\t\t\t\t\t</span>\r\n\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t\t<div className=\"flex items-center justify-between\">\r\n\t\t\t\t\t\t\t\t\t\t<span>HTTPS</span>\r\n\t\t\t\t\t\t\t\t\t\t<span className={`px-2 py-1 rounded text-xs ${systemHealth.https ? 'bg-emerald-600' : 'bg-amber-600'}`}>\r\n\t\t\t\t\t\t\t\t\t\t\t{systemHealth.https ? 'Enabled' : 'HTTP Only'}\r\n\t\t\t\t\t\t\t\t\t\t</span>\r\n\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t\t<div className=\"flex items-center justify-between\">\r\n\t\t\t\t\t\t\t\t\t\t<span>Maintenance Mode</span>\r\n\t\t\t\t\t\t\t\t\t\t<span className={`px-2 py-1 rounded text-xs ${!systemHealth.maintenance ? 'bg-emerald-600' : 'bg-red-600'}`}>\r\n\t\t\t\t\t\t\t\t\t\t\t{!systemHealth.maintenance ? 'Normal' : 'Active'}\r\n\t\t\t\t\t\t\t\t\t\t</span>\r\n\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t\t<div className=\"flex items-center justify-between\">\r\n\t\t\t\t\t\t\t\t\t\t<span>Clustering (Auto-Scaling)</span>\r\n\t\t\t\t\t\t\t\t\t\t<span className={`px-2 py-1 rounded text-xs ${clusteringEnabled ? 'bg-emerald-600' : 'bg-amber-600'}`}>\r\n\t\t\t\t\t\t\t\t\t\t\t{clusteringEnabled ? 'Enabled' : 'Disabled'}\r\n\t\t\t\t\t\t\t\t\t\t</span>\r\n\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t<div className=\"space-y-2\">\r\n\t\t\t\t\t\t\t\t\t<div className=\"text-sm\">\r\n\t\t\t\t\t\t\t\t\t\t<span className=\"font-semibold\">Uptime:</span> {Math.floor(systemHealth.uptime / 3600)}h {Math.floor((systemHealth.uptime % 3600) / 60)}m\r\n\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t\t<div className=\"text-sm\">\r\n\t\t\t\t\t\t\t\t\t\t<span className=\"font-semibold\">Memory:</span> {systemHealth.memory ? Math.round(systemHealth.memory.heapUsed / 1024 / 1024) : '?'}MB used\r\n\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t\t<div className=\"text-sm\">\r\n\t\t\t\t\t\t\t\t\t\t<span className=\"font-semibold\">Version:</span> {systemHealth.version}\r\n\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t\t<div className=\"flex gap-2 flex-wrap\">\r\n\t\t\t\t\t\t\t\t\t\t<button className=\"btn\" onClick={fetchSystemHealth}>Refresh</button>\r\n\t\t\t\t\t\t\t\t\t\t<button \r\n\t\t\t\t\t\t\t\t\t\t\tclassName={`btn ${clusteringEnabled ? 'bg-amber-600 hover:bg-amber-700' : 'bg-emerald-600 hover:bg-emerald-700'}`} \r\n\t\t\t\t\t\t\t\t\t\t\tdisabled={loading}\r\n\t\t\t\t\t\t\t\t\t\t\tonClick={() => toggleClustering(!clusteringEnabled)}\r\n\t\t\t\t\t\t\t\t\t\t>\r\n\t\t\t\t\t\t\t\t\t\t\t{clusteringEnabled ? 'Disable' : 'Enable'} Clustering\r\n\t\t\t\t\t\t\t\t\t\t</button>\r\n\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t) : (\r\n\t\t\t\t\t\t\t<div className=\"text-center py-4\">\r\n\t\t\t\t\t\t\t\t<div className=\"text-sm opacity-60 mb-2\">Loading system health...</div>\r\n\t\t\t\t\t\t\t\t<button className=\"btn\" onClick={fetchSystemHealth}>Load Health Status</button>\r\n\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t)}\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t<div className=\"mt-4 pt-4 border-t border-white/10\">\r\n\t\t\t\t\t\t\t<h4 className=\"font-semibold mb-3\">Clustering Capacity</h4>\r\n\t\t\t\t\t\t\t<div className=\"space-y-3\">\r\n\t\t\t\t\t\t\t\t<div>\r\n\t\t\t\t\t\t\t\t\t<div className=\"flex items-center justify-between mb-2\">\r\n\t\t\t\t\t\t\t\t\t\t<label className=\"font-semibold\">Max Concurrent Users</label>\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t<div className=\"flex gap-2\">\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<button className=\"btn\" onClick={()=>setShowCreate(false)}>Close</button>\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<button className=\"btn\" onClick={broadcastTournaments} disabled={!isOwner || loading}>Force broadcast</button>\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t\t<input \r\n\t\t\t\t\t\t\t\t\t\ttype=\"range\" \r\n\t\t\t\t\t\t\t\t\t\tmin=\"1500\" \r\n\t\t\t\t\t\t\t\t\t\tmax=\"50000\" \r\n\t\t\t\t\t\t\t\t\t\tstep=\"500\"\r\n\t\t\t\t\t\t\t\t\t\tvalue={clusterCapacity}\r\n\t\t\t\t\t\t\t\t\t\tonChange={(e) => updateClusterCapacity(Number(e.target.value))}\r\n\t\t\t\t\t\t\t\t\t\tdisabled={loading}\r\n\t\t\t\t\t\t\t\t\t\tclassName=\"w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed\"\r\n\t\t\t\t\t\t\t\t\t\tstyle={{\r\n\t\t\t\t\t\t\t\t\t\t\tbackground: clusteringEnabled ? \r\n\t\t\t\t\t\t\t\t\t\t\t\t`linear-gradient(to right, #3b82f6 0%, #3b82f6 ${((clusterCapacity - 1500) / (50000 - 1500)) * 100}%, #374151 ${((clusterCapacity - 1500) / (50000 - 1500)) * 100}%, #374151 100%)` : \r\n\t\t\t\t\t\t\t\t\t\t\t\t'#374151'\r\n\t\t\t\t\t\t\t\t\t\t}}\r\n\t\t\t\t\t\t\t\t\t/>\r\n\t\t\t\t\t\t\t\t\t<div className=\"flex justify-between text-xs opacity-60 mt-1\">\r\n\t\t\t\t\t\t\t\t\t\t<span>1.5k</span>\r\n\t\t\t\t\t\t\t\t\t\t<span>50k</span>\r\n\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t<div className=\"flex gap-2 flex-wrap\">\r\n\t\t\t\t\t\t\t\t\t<button \r\n\t\t\t\t\t\t\t\t\t\tclassName={`btn ${clusteringEnabled ? 'bg-amber-600 hover:bg-amber-700' : 'bg-emerald-600 hover:bg-emerald-700'}`} \r\n\t\t\t\t\t\t\t\t\t\tdisabled={loading}\r\n\t\t\t\t\t\t\t\t\t\tonClick={() => toggleClustering(!clusteringEnabled)}\r\n\t\t\t\t\t\t\t\t\t>\r\n\t\t\t\t\t\t\t\t\t\t{clusteringEnabled ? 'Disable' : 'Enable'} Clustering\r\n\t\t\t\t\t\t\t\t\t</button>\r\n\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t<div className=\"text-xs opacity-70 mt-2 p-2 bg-white/5 rounded\">\r\n\t\t\t\t\t\t\t\t Clustering enables auto-scaling with capacity up to {clusterCapacity.toLocaleString()} concurrent users. Adjust the slider to set maximum capacity. NODE_WORKERS environment variable is set to handle the configured load behind a reverse proxy.\r\n\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</div>\r\n\r\n\t\t\t\t\t<div className=\"card\">\r\n\t\t\t\t\t\t<h3 className=\"text-xl font-semibold mb-3\">User Reports</h3>\r\n\t\t\t\t\t\t<ul className=\"space-y-2\">\r\n\t\t\t\t\t\t\t{reports.map((r:any)=> (\r\n\t\t\t\t\t\t\t\t<li key={r.id} className=\"p-2 rounded bg-black/20 text-sm\">\r\n\t\t\t\t\t\t\t\t\t<div className=\"flex items-center justify-between\">\r\n\t\t\t\t\t\t\t\t\t\t<div>\r\n\t\t\t\t\t\t\t\t\t\t\t<div className=\"font-mono text-xs\">{r.id}</div>\r\n\t\t\t\t\t\t\t\t\t\t\t<div><span className=\"font-semibold\">{r.reporter}</span>  <span className=\"font-semibold\">{r.offender}</span>  {new Date(r.ts).toLocaleString()}</div>\r\n\t\t\t\t\t\t\t\t\t\t\t<div className=\"opacity-80\">Reason: {r.reason}</div>\r\n\t\t\t\t\t\t\t\t\t\t\t{r.messageId && <div className=\"opacity-60 text-xs\">Message ID: {r.messageId}</div>}\r\n\t\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t\t\t<div className=\"flex gap-2\">\r\n\t\t\t\t\t\t\t\t\t\t\t<span className={`px-2 py-0.5 rounded text-xs ${r.status==='open'?'bg-amber-600':'bg-emerald-600'}`}>{r.status}</span>\r\n\t\t\t\t\t\t\t\t\t\t\t{r.status==='open' && (\r\n\t\t\t\t\t\t\t\t\t\t\t\t<>\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t<button className=\"btn bg-emerald-600 hover:bg-emerald-700\" disabled={loading} onClick={async()=>{\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tawait fetch('/api/admin/reports/resolve', { method:'POST', headers:{'Content-Type':'application/json', Authorization: `Bearer ${localStorage.getItem('authToken')}`}, body: JSON.stringify({ id: r.id, action: 'resolved' }) })\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tawait refresh()\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t}}>Resolve</button>\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t<button className=\"btn bg-rose-600 hover:bg-rose-700\" disabled={loading} onClick={async()=>{\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tconst notes = prompt('Enter notes for action taken (e.g., warning, block):') || ''\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tawait fetch('/api/admin/reports/resolve', { method:'POST', headers:{'Content-Type':'application/json', Authorization: `Bearer ${localStorage.getItem('authToken')}`}, body: JSON.stringify({ id: r.id, action: 'actioned', notes }) })\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tawait refresh()\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t}}>Action</button>\r\n\t\t\t\t\t\t\t\t\t\t\t\t</>\r\n\t\t\t\t\t\t\t\t\t\t\t)}\r\n\t\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t</li>\r\n\t\t\t\t\t\t\t))}\r\n\t\t\t\t\t\t\t{reports.length===0 && <li className=\"opacity-60\">No reports.</li>}\r\n\t\t\t\t\t\t</ul>\r\n\t\t\t\t\t</div>\r\n\r\n\t\t\t\t\t<div className=\"card\">\r\n\t\t\t\t\t\t<h3 className=\"text-xl font-semibold mb-3\">System Health</h3>\r\n\t\t\t\t\t\t<div className=\"text-sm opacity-80 mb-3\">Current status of system components and services.</div>\r\n\t\t\t\t\t\t{systemHealth ? (\r\n\t\t\t\t\t\t\t<div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n\t\t\t\t\t\t\t\t<div className=\"space-y-2\">\r\n\t\t\t\t\t\t\t\t\t<div className=\"flex items-center justify-between\">\r\n\t\t\t\t\t\t\t\t\t\t<span>Database</span>\r\n\t\t\t\t\t\t\t\t\t\t<span className={`px-2 py-1 rounded text-xs ${systemHealth.database ? 'bg-emerald-600' : 'bg-red-600'}`}>\r\n\t\t\t\t\t\t\t\t\t\t\t{systemHealth.database ? 'Ready' : 'Down'}\r\n\t\t\t\t\t\t\t\t\t\t</span>\r\n\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t\t<div className=\"flex items-center justify-between\">\r\n\t\t\t\t\t\t\t\t\t\t<span>WebSocket</span>\r\n\t\t\t\t\t\t\t\t\t\t<span className={`px-2 py-1 rounded text-xs ${systemHealth.websocket ? 'bg-emerald-600' : 'bg-red-600'}`}>\r\n\t\t\t\t\t\t\t\t\t\t\t{systemHealth.websocket ? 'Ready' : 'Down'}\r\n\t\t\t\t\t\t\t\t\t\t</span>\r\n\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t\t<div className=\"flex items-center justify-between\">\r\n\t\t\t\t\t\t\t\t\t\t<span>HTTPS</span>\r\n\t\t\t\t\t\t\t\t\t\t<span className={`px-2 py-1 rounded text-xs ${systemHealth.https ? 'bg-emerald-600' : 'bg-amber-600'}`}>\r\n\t\t\t\t\t\t\t\t\t\t\t{systemHealth.https ? 'Enabled' : 'HTTP Only'}\r\n\t\t\t\t\t\t\t\t\t\t</span>\r\n\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t\t<div className=\"flex items-center justify-between\">\r\n\t\t\t\t\t\t\t\t\t\t<span>Maintenance Mode</span>\r\n\t\t\t\t\t\t\t\t\t\t<span className={`px-2 py-1 rounded text-xs ${!systemHealth.maintenance ? 'bg-emerald-600' : 'bg-red-600'}`}>\r\n\t\t\t\t\t\t\t\t\t\t\t{!systemHealth.maintenance ? 'Normal' : 'Active'}\r\n\t\t\t\t\t\t\t\t\t\t</span>\r\n\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t<div className=\"space-y-2\">\r\n\t\t\t\t\t\t\t\t\t<div className=\"text-sm\">\r\n\t\t\t\t\t\t\t\t\t\t<span className=\"font-semibold\">Uptime:</span> {Math.floor(systemHealth.uptime / 3600)}h {Math.floor((systemHealth.uptime % 3600) / 60)}m\r\n\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t\t<div className=\"text-sm\">\r\n\t\t\t\t\t\t\t\t\t\t<span className=\"font-semibold\">Memory:</span> {Math.round(systemHealth.memory.heapUsed / 1024 / 1024)}MB used\r\n\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t\t<div className=\"text-sm\">\r\n\t\t\t\t\t\t\t\t\t\t<span className=\"font-semibold\">Version:</span> {systemHealth.version}\r\n\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t\t<div className=\"flex gap-2 mt-3\">\r\n\t\t\t\t\t\t\t\t\t\t<button className=\"btn\" onClick={fetchSystemHealth}>Refresh</button>\r\n\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t) : (\r\n\t\t\t\t\t\t\t<div className=\"text-center py-4\">\r\n\t\t\t\t\t\t\t\t<div className=\"text-sm opacity-60 mb-2\">Loading system health...</div>\r\n\t\t\t\t\t\t\t\t<button className=\"btn\" onClick={fetchSystemHealth}>Load Health Status</button>\r\n\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t)}\r\n\t\t\t\t\t</div>\r\n\r\n\t\t\t\t\t<div className=\"card\">\r\n\t\t\t\t\t\t<h3 className=\"text-xl font-semibold mb-3\">Open Matches</h3>\r\n\t\t\t\t\t\t<ul className=\"space-y-1\">\r\n\t\t\t\t\t\t\t{(status?.matches || []).map((m: any) => (\r\n\t\t\t\t\t\t\t\t<li key={m.id} className=\"flex items-center justify-between p-2 rounded bg-black/20 text-sm\">\r\n\t\t\t\t\t\t\t\t\t<div className=\"flex items-center gap-3\">\r\n\t\t\t\t\t\t\t\t\t\t<span className=\"font-mono text-xs\">{m.id}</span>\r\n\t\t\t\t\t\t\t\t\t\t<span className=\"opacity-80\">{m.creatorName}</span>\r\n\t\t\t\t\t\t\t\t\t\t<span className=\"opacity-60\">{m.game} {m.mode==='firstto'?'FT':'BO'} {m.value} {m.game==='X01'?`/${m.startingScore}`:''}</span>\r\n\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t\t<button className=\"btn bg-rose-600 hover:bg-rose-700\" disabled={loading} onClick={()=>deleteMatch(m.id)}>Remove</button>\r\n\t\t\t\t\t\t\t\t</li>\r\n\t\t\t\t\t\t\t))}\r\n\t\t\t\t\t\t\t{(!status?.matches || status.matches.length === 0) && (\r\n\t\t\t\t\t\t\t\t<li className=\"text-sm opacity-60\">No open matches.</li>\r\n\t\t\t\t\t\t\t)}\r\n\t\t\t\t\t\t</ul>\r\n\t\t\t\t\t</div>\r\n\r\n\t\t\t\t\t<div className=\"card\">\r\n\t\t\t\t\t\t<h3 className=\"text-xl font-semibold mb-3\">Dangerous Operations</h3>\r\n\t\t\t\t\t\t<div className=\"text-sm opacity-80 mb-3 text-red-400\"> These operations can cause data loss or service disruption. Use with extreme caution.</div>\r\n\t\t\t\t\t\t<div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n\t\t\t\t\t\t\t<div>\r\n\t\t\t\t\t\t\t\t<div className=\"font-semibold mb-2 text-red-400\">Tournament Deletion</div>\r\n\t\t\t\t\t\t\t\t<ul className=\"space-y-2\">\r\n\t\t\t\t\t\t\t\t\t{tournaments.map((t:any)=> (\r\n\t\t\t\t\t\t\t\t\t\t<li key={t.id} className=\"p-2 rounded bg-red-900/20 border border-red-500/40 text-sm\">\r\n\t\t\t\t\t\t\t\t\t\t\t<div className=\"flex items-center justify-between\">\r\n\t\t\t\t\t\t\t\t\t\t\t\t<div className=\"font-semibold\">{t.title}</div>\r\n\t\t\t\t\t\t\t\t\t\t\t\t<div className=\"opacity-70\">{t.status}</div>\r\n\t\t\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t\t\t\t<div className=\"opacity-80\">{t.game}  {t.mode==='firstto'?'FT':'BO'} {t.value}</div>\r\n\t\t\t\t\t\t\t\t\t\t\t<div className=\"mt-2\">\r\n\t\t\t\t\t\t\t\t\t\t\t\t<button className=\"btn bg-red-600 hover:bg-red-700 text-xs\" disabled={loading} onClick={()=>deleteTournament(t.id)}>Delete Tournament</button>\r\n\t\t\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t\t\t</li>\r\n\t\t\t\t\t\t\t\t\t))}\r\n\t\t\t\t\t\t\t\t\t{tournaments.length===0 && <li className=\"opacity-60\">No tournaments.</li>}\r\n\t\t\t\t\t\t\t\t</ul>\r\n\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t<div>\r\n\t\t\t\t\t\t\t\t<div className=\"font-semibold mb-2 text-red-400\">System Maintenance</div>\r\n\t\t\t\t\t\t\t\t<div className=\"space-y-2\">\r\n\t\t\t\t\t\t\t\t\t<div className=\"p-3 rounded bg-red-900/20 border border-red-500/40\">\r\n\t\t\t\t\t\t\t\t\t\t<div className=\"font-semibold text-red-400 mb-2\">Maintenance Mode</div>\r\n\t\t\t\t\t\t\t\t\t\t<div className=\"text-sm opacity-80 mb-3\">Put the entire site into maintenance mode. Users won't be able to access games or create matches.</div>\r\n\t\t\t\t\t\t\t\t\t\t<div className=\"flex items-center gap-2\">\r\n\t\t\t\t\t\t\t\t\t\t\t<span className={`px-2 py-1 rounded text-xs ${status?.maintenance ? 'bg-red-600' : 'bg-green-600'}`}>\r\n\t\t\t\t\t\t\t\t\t\t\t\t{status?.maintenance ? 'MAINTENANCE ACTIVE' : 'NORMAL OPERATION'}\r\n\t\t\t\t\t\t\t\t\t\t\t</span>\r\n\t\t\t\t\t\t\t\t\t\t\t<button \r\n\t\t\t\t\t\t\t\t\t\t\t\tclassName={`btn ${status?.maintenance ? 'bg-green-600 hover:bg-green-700' : 'bg-red-600 hover:bg-red-700'}`} \r\n\t\t\t\t\t\t\t\t\t\t\t\tdisabled={loading} \r\n\t\t\t\t\t\t\t\t\t\t\t\tonClick={()=>toggleMaintenance(!status?.maintenance)}\r\n\t\t\t\t\t\t\t\t\t\t\t>\r\n\t\t\t\t\t\t\t\t\t\t\t\t{status?.maintenance ? 'Disable' : 'Enable'}\r\n\t\t\t\t\t\t\t\t\t\t\t</button>\r\n\t\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t\t{selectedRequest && (\r\n\t\t\t\t\t\t<HelpdeskChat request={selectedRequest} user={{ email: user?.email, username: user?.username, isAdmin: true }} onClose={() => setSelectedRequest(null)} />\r\n\t\t\t\t\t)}\r\n\t\t\t\t</>\r\n\t\t\t)}\r\n\r\n\t\t\t{activeTab === 'premium' && isOwner && (\r\n\t\t\t\t<>\r\n\t\t\t\t\t<div className=\"card\">\r\n\t\t\t\t\t\t<h3 className=\"text-xl font-semibold mb-2\">Premium Subscription Grants</h3>\r\n\t\t\t\t\t\t<div className=\"text-sm opacity-80 mb-3\">Grant or revoke premium subscriptions for users (grants 30 days).</div>\r\n\t\t\t\t\t\t<div className=\"flex gap-2 mb-3\">\r\n\t\t\t\t\t\t\t<input className=\"input flex-1\" placeholder=\"user@example.com\" value={email} onChange={e=>setEmail(e.target.value)} />\r\n\t\t\t\t\t\t\t<button className=\"btn\" disabled={loading || !email.trim()} onClick={() => grantPremium(email, 30)}>Grant</button>\r\n\t\t\t\t\t\t\t<button className=\"btn bg-rose-600 hover:bg-rose-700\" disabled={loading} onClick={() => revokePremium(email)}>Revoke</button>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t<div className=\"text-sm opacity-80 mb-2\">Premium users get 30 days of access to all features.</div>\r\n\t\t\t\t\t</div>\r\n\r\n\t\t\t\t\t<div className=\"card\">\r\n\t\t\t\t\t\t<h3 className=\"text-xl font-semibold mb-2\">Premium Winners</h3>\r\n\t\t\t\t\t\t<div className=\"text-sm opacity-80 mb-2\">Users who have won premium through tournaments.</div>\r\n\t\t\t\t\t\t<div className=\"space-y-2\">\r\n\t\t\t\t\t\t\t{winners.map((w: any) => (\r\n\t\t\t\t\t\t\t\t<div key={w.email} className=\"p-2 rounded bg-black/20 text-sm flex items-center justify-between\">\r\n\t\t\t\t\t\t\t\t\t<div>\r\n\t\t\t\t\t\t\t\t\t\t<div className=\"font-semibold\">{w.name || 'No name'}</div>\r\n\t\t\t\t\t\t\t\t\t\t<div className=\"opacity-70\">{w.email}</div>\r\n\t\t\t\t\t\t\t\t\t\t<div className=\"opacity-60 text-xs\">Expires {new Date(w.expiresAt).toLocaleDateString()}</div>\r\n\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t\t<div className=\"flex gap-2\">\r\n\t\t\t\t\t\t\t\t\t\t{!w.expired ? (\r\n\t\t\t\t\t\t\t\t\t\t\t<span className=\"px-2 py-1 rounded bg-emerald-600 text-xs\">Premium Active</span>\r\n\t\t\t\t\t\t\t\t\t\t) : (\r\n\t\t\t\t\t\t\t\t\t\t\t<span className=\"px-2 py-1 rounded bg-amber-600 text-xs\">Premium Expired</span>\r\n\t\t\t\t\t\t\t\t\t\t)}\r\n\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t))}\r\n\t\t\t\t\t\t\t{winners.length === 0 && <div className=\"opacity-60\">No premium winners.</div>}\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t</>\r\n\t\t\t)}\r\n\r\n\t\t\t{activeTab === 'tourneys' && isOwner && (\r\n\t\t\t\t<>\r\n\t\t\t\t\t<div className=\"card\">\r\n\t\t\t\t\t\t<h3 className=\"text-xl font-semibold mb-3\">Create Official Tournament</h3>\r\n\t\t\t\t\t\t<div className=\"text-sm opacity-80 mb-3\">Set up a new official tournament with custom rules, timing, and prizes.</div>\r\n\t\t\t\t\t\t<div className=\"space-y-2\">\r\n\t\t\t\t\t\t\t<input className=\"input w-full\" placeholder=\"Tournament Title\" value={createForm.title} onChange={e=>setCreateForm((f:any)=>({ ...f, title: e.target.value }))} />\r\n\t\t\t\t\t\t\t<div className=\"grid grid-cols-3 gap-2\">\r\n\t\t\t\t\t\t\t\t<select className=\"input\" value={createForm.game} onChange={e=>setCreateForm((f:any)=>({ ...f, game: e.target.value }))}>\r\n\t\t\t\t\t\t\t\t\t{['X01','Around the Clock','Cricket','Halve It','Shanghai','High-Low'].map((g)=> <option key={g} value={g}>{g}</option>)}\r\n\t\t\t\t\t\t\t\t</select>\r\n\t\t\t\t\t\t\t\t<select className=\"input\" value={createForm.mode} onChange={e=>setCreateForm((f:any)=>({ ...f, mode: e.target.value }))}>\r\n\t\t\t\t\t\t\t\t\t<option value=\"bestof\">Best of</option>\r\n\t\t\t\t\t\t\t\t\t<option value=\"firstto\">First to</option>\r\n\t\t\t\t\t\t\t\t</select>\r\n\t\t\t\t\t\t\t\t<input className=\"input\" type=\"number\" min={1} value={createForm.value} onChange={e=>setCreateForm((f:any)=>({ ...f, value: Number(e.target.value) }))} />\r\n\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t<textarea className=\"input w-full\" rows={2} placeholder=\"Description\" value={createForm.description} onChange={e=>setCreateForm((f:any)=>({ ...f, description: e.target.value }))} />\r\n\t\t\t\t\t\t\t<div className=\"grid grid-cols-2 gap-2\">\r\n\t\t\t\t\t\t\t\t<input className=\"input\" type=\"datetime-local\" value={createForm.startAt} onChange={e=>setCreateForm((f:any)=>({ ...f, startAt: e.target.value }))} />\r\n\t\t\t\t\t\t\t\t<input className=\"input\" type=\"number\" min={0} placeholder=\"Checkin minutes\" value={createForm.checkinMinutes} onChange={e=>setCreateForm((f:any)=>({ ...f, checkinMinutes: Number(e.target.value) }))} />\r\n\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t<input className=\"input w-full\" type=\"number\" min={6} max={64} placeholder=\"Capacity\" value={createForm.capacity} onChange={e=>setCreateForm((f:any)=>({ ...f, capacity: Number(e.target.value) }))} />\r\n\t\t\t\t\t\t\t<div className=\"grid grid-cols-3 gap-2 items-center\">\r\n\t\t\t\t\t\t\t\t<select className=\"input\" value={createForm.prizeType} onChange={e=>{\r\n\t\t\t\t\t\t\t\t\tconst newType = e.target.value\r\n\t\t\t\t\t\t\t\t\tsetCreateForm((f:any)=>({ ...f, prizeType: newType, prizeAmount: newType === 'premium' ? 3 : 0 }))\r\n\t\t\t\t\t\t\t\t}}>\r\n\t\t\t\t\t\t\t\t\t<option value=\"premium\">PREMIUM</option>\r\n\t\t\t\t\t\t\t\t\t<option value=\"cash\">Cash</option>\r\n\t\t\t\t\t\t\t\t</select>\r\n\t\t\t\t\t\t\t\t{createForm.prizeType === 'premium' ? (\r\n\t\t\t\t\t\t\t\t\t<select className=\"input\" value={createForm.prizeAmount} onChange={e=>setCreateForm((f:any)=>({ ...f, prizeAmount: Number(e.target.value) }))}>\r\n\t\t\t\t\t\t\t\t\t\t<option value={1}>1 month</option>\r\n\t\t\t\t\t\t\t\t\t\t<option value={3}>3 months</option>\r\n\t\t\t\t\t\t\t\t\t</select>\r\n\t\t\t\t\t\t\t\t) : (\r\n\t\t\t\t\t\t\t\t\t<input className=\"input\" type=\"number\" min={0} value={createForm.prizeAmount} onChange={e=>setCreateForm((f:any)=>({ ...f, prizeAmount: Number(e.target.value) }))} />\r\n\t\t\t\t\t\t\t\t)}\r\n\t\t\t\t\t\t\t\t<select className=\"input\" disabled={createForm.prizeType!=='cash'} value={createForm.currency} onChange={e=>setCreateForm((f:any)=>({ ...f, currency: e.target.value }))}>\r\n\t\t\t\t\t\t\t\t\t<option value=\"GBP\">GBP</option>\r\n\t\t\t\t\t\t\t\t\t<option value=\"USD\">USD</option>\r\n\t\t\t\t\t\t\t\t\t<option value=\"EUR\">EUR</option>\r\n\t\t\t\t\t\t\t\t\t<option value=\"CAD\">CAD</option>\r\n\t\t\t\t\t\t\t\t\t<option value=\"AUD\">AUD</option>\r\n\t\t\t\t\t\t\t\t</select>\r\n\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t<input className=\"input w-full\" placeholder=\"Prize notes (optional)\" value={createForm.prizeNotes} onChange={e=>setCreateForm((f:any)=>({ ...f, prizeNotes: e.target.value }))} />\r\n\t\t\t\t\t\t\t<div className=\"flex justify-end\">\r\n\t\t\t\t\t\t\t\t<button className=\"btn bg-emerald-600 hover:bg-emerald-700\" disabled={loading} onClick={createOfficialTournament}>Create Tournament</button>\r\n\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</div>\r\n\r\n\t\t\t\t\t<div className=\"card\">\r\n\t\t\t\t\t\t<h3 className=\"text-xl font-semibold mb-3\">Tournament Premium Winners</h3>\r\n\t\t\t\t\t\t<div className=\"text-sm opacity-80 mb-3\">Users who have won premium prizes in tournaments. Grant them access here.</div>\r\n\t\t\t\t\t\t<div className=\"space-y-2\">\r\n\t\t\t\t\t\t\t{tournaments\r\n\t\t\t\t\t\t\t\t.filter((t: any) => t.status === 'completed' && t.winnerEmail && t.prizeType === 'premium')\r\n\t\t\t\t\t\t\t\t.map((t: any) => {\r\n\t\t\t\t\t\t\t\t\tconst winner = winners.find((w: any) => w.email === t.winnerEmail)\r\n\t\t\t\t\t\t\t\t\tconst hasAccess = winner && !winner.expired\r\n\t\t\t\t\t\t\t\t\treturn (\r\n\t\t\t\t\t\t\t\t\t\t<div key={t.id} className=\"p-3 rounded bg-black/20 text-sm\">\r\n\t\t\t\t\t\t\t\t\t\t\t<div className=\"flex items-center justify-between mb-2\">\r\n\t\t\t\t\t\t\t\t\t\t\t\t<div className=\"font-semibold\">{t.title}</div>\r\n\t\t\t\t\t\t\t\t\t\t\t\t<div className=\"text-xs opacity-70\">{new Date(t.startAt).toLocaleDateString()}</div>\r\n\t\t\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t\t\t\t<div className=\"flex items-center justify-between\">\r\n\t\t\t\t\t\t\t\t\t\t\t\t<div>\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t<div className=\"font-medium\">{t.winnerEmail}</div>\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t<div className=\"text-xs opacity-70\">Prize: {t.prizeAmount} month{t.prizeAmount > 1 ? 's' : ''} PREMIUM</div>\r\n\t\t\t\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t\t\t\t\t<div className=\"flex items-center gap-2\">\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t{hasAccess ? (\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t<span className=\"px-2 py-1 rounded bg-emerald-600 text-xs\"> Access Granted</span>\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t) : (\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t<button \r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tclassName=\"btn bg-emerald-600 hover:bg-emerald-700 text-xs\" \r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tdisabled={loading}\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tonClick={() => grantPremium(t.winnerEmail, t.prizeAmount * 30)}\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t>\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tGrant Access\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t</button>\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t)}\r\n\t\t\t\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t\t)\r\n\t\t\t\t\t\t\t\t})}\r\n\t\t\t\t\t\t\t{tournaments.filter((t: any) => t.status === 'completed' && t.winnerEmail && t.prizeType === 'premium').length === 0 && (\r\n\t\t\t\t\t\t\t\t<div className=\"text-center py-4 text-sm opacity-60\">No completed premium tournaments.</div>\r\n\t\t\t\t\t\t\t)}\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</div>\r\n\r\n\t\t\t\t\t<div className=\"card\">\r\n\t\t\t\t\t\t<h3 className=\"text-xl font-semibold mb-3\">Manage Tournaments</h3>\r\n\t\t\t\t\t\t<div className=\"text-sm opacity-80 mb-3\">View and manage all tournaments. Set winners or mark payouts.</div>\r\n\t\t\t\t\t\t<ul className=\"space-y-2\">\r\n\t\t\t\t\t\t\t{tournaments.map((t:any)=> (\r\n\t\t\t\t\t\t\t\t<li key={t.id} className=\"p-3 rounded bg-black/20 text-sm\">\r\n\t\t\t\t\t\t\t\t\t<div className=\"flex items-center justify-between mb-2\">\r\n\t\t\t\t\t\t\t\t\t\t<div>\r\n\t\t\t\t\t\t\t\t\t\t\t<div className=\"font-semibold\">{t.title}</div>\r\n\t\t\t\t\t\t\t\t\t\t\t<div className=\"opacity-80\">{t.game}  {t.mode==='firstto'?'First to':'Best of'} {t.value}</div>\r\n\t\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t\t\t<div className={`px-2 py-1 rounded text-xs font-semibold ${\r\n\t\t\t\t\t\t\t\t\t\t\tt.status === 'scheduled' ? 'bg-blue-600' :\r\n\t\t\t\t\t\t\t\t\t\t\tt.status === 'running' ? 'bg-green-600' :\r\n\t\t\t\t\t\t\t\t\t\t\tt.status === 'completed' ? 'bg-purple-600' :\r\n\t\t\t\t\t\t\t\t\t\t\t'bg-gray-600'\r\n\t\t\t\t\t\t\t\t\t\t}`}>\r\n\t\t\t\t\t\t\t\t\t\t\t{t.status}\r\n\t\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t\t<div className=\"text-xs opacity-70 mb-2\">\r\n\t\t\t\t\t\t\t\t\t\tStart: {new Date(t.startAt).toLocaleString()}  Capacity: {t.capacity}\r\n\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t\t{t.prize && (\r\n\t\t\t\t\t\t\t\t\t\t<div className=\"text-xs mb-2\">\r\n\t\t\t\t\t\t\t\t\t\t\tPrize: {t.prizeType==='cash' && t.prizeAmount ? `${t.currency||'USD'} ${t.prizeAmount}` : `${t.prizeAmount || 3} month${(t.prizeAmount || 3) > 1 ? 's' : ''} PREMIUM`} \r\n\t\t\t\t\t\t\t\t\t\t\t{t.prizeType==='cash' && t.status==='completed' && t.payoutStatus && (<span className={`ml-2 px-1.5 py-0.5 rounded ${t.payoutStatus==='paid'?'bg-emerald-600':'bg-amber-600'}`}>{t.payoutStatus}</span>)}\r\n\t\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t\t)}\r\n\t\t\t\t\t\t\t\t\t<div className=\"mt-2 flex flex-wrap gap-2\">\r\n\t\t\t\t\t\t\t\t\t\t<button className=\"btn text-xs\" disabled={loading || t.status!=='scheduled'} onClick={()=>setWinner(t.id, prompt('Winner email?')||'')}>Set Winner</button>\r\n\t\t\t\t\t\t\t\t\t\t{t.prizeType==='cash' && t.status==='completed' && t.payoutStatus!=='paid' && (\r\n\t\t\t\t\t\t\t\t\t\t\t<button className=\"btn text-xs\" disabled={loading} onClick={()=>markPaid(t.id)}>Mark Paid</button>\r\n\t\t\t\t\t\t\t\t\t\t)}\r\n\t\t\t\t\t\t\t\t\t\t<button className=\"btn text-xs\" disabled={loading} onClick={()=>reseedWeekly()}>Reseed</button>\r\n\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t</li>\r\n\t\t\t\t\t\t\t))}\r\n\t\t\t\t\t\t\t{tournaments.length===0 && <li className=\"opacity-60\">No tournaments.</li>}\r\n\t\t\t\t\t\t</ul>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t</>\r\n\t\t\t)}\r\n\r\n\t\t\t{activeTab === 'helpdesk' && isOwner && (\r\n\t\t\t\t<>\r\n\t\t\t\t\t<div className=\"card\">\r\n\t\t\t\t\t\t<h3 className=\"text-lg font-semibold mb-2\">Helpdesk Requests</h3>\r\n\t\t\t\t\t\t<div className=\"text-sm opacity-80 mb-3\">Incoming requests from users who asked to speak with an admin. Claim to take over the chat.</div>\r\n\t\t\t\t\t\t{helpRequests.length === 0 ? (\r\n\t\t\t\t\t\t\t<div className=\"text-sm opacity-70\">No open requests.</div>\r\n\t\t\t\t\t\t) : (\r\n\t\t\t\t\t\t\t<div className=\"space-y-2\">\r\n\t\t\t\t\t\t\t\t{helpRequests.map(hr => (\r\n\t\t\t\t\t\t\t\t\t<div key={hr.id} className=\"p-2 rounded bg-black/10 border border-white/10 flex items-center justify-between\">\r\n\t\t\t\t\t\t\t\t\t\t<div>\r\n\t\t\t\t\t\t\t\t\t\t\t<div className=\"font-medium\">{hr.username || 'Anonymous'}</div>\r\n\t\t\t\t\t\t\t\t\t\t\t<div className=\"text-xs opacity-70\">{new Date(hr.ts || 0).toLocaleString()}</div>\r\n\t\t\t\t\t\t\t\t\t\t\t<div className=\"text-sm mt-1\">{hr.message}</div>\r\n\t\t\t\t\t\t\t\t\t\t\t{helpTyping[hr.id] && (\r\n\t\t\t\t\t\t\t\t\t\t\t\t<div className=\"text-xs text-amber-300 mt-1\">{helpTyping[hr.id].who} typing...</div>\r\n\t\t\t\t\t\t\t\t\t\t\t)}\r\n\t\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t\t\t<div className=\"flex items-center gap-2\">\r\n\t\t\t\t\t\t\t\t\t\t\t{hr.status === 'open' ? (\r\n\t\t\t\t\t\t\t\t\t\t\t\t<button className=\"btn\" onClick={() => claimHelp(hr.id)}>Claim</button>\r\n\t\t\t\t\t\t\t\t\t\t\t) : (\r\n\t\t\t\t\t\t\t\t\t\t\t\t<span className=\"text-xs opacity-70\">{hr.status} by {hr.claimedBy || ''}</span>\r\n\t\t\t\t\t\t\t\t\t\t\t)}\r\n\t\t\t\t\t\t\t\t\t\t\t<button className=\"btn btn-ghost\" onClick={() => resolveHelp(hr.id)}>Resolve</button>\r\n\t\t\t\t\t\t\t\t\t\t\t<button className=\"btn\" onClick={() => setSelectedRequest(hr)}>Chat</button>\r\n\t\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t))}\r\n\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t)}\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t</>\r\n\t\t\t)}\r\n\r\n\t\t\t{/* Inline email preview overlay */}\r\n\t\t\t{preview.open && (\r\n\t\t\t\t<div className=\"fixed inset-0 z-[1000]\" onClick={()=>setPreview({ open: false })}>\r\n\t\t\t\t\t<div className=\"absolute inset-0 bg-black/70 backdrop-blur-sm\" />\r\n\t\t\t\t\t<div className=\"absolute inset-0 p-4 md:p-8 overflow-auto flex items-start md:items-center justify-center\">\r\n\t\t\t\t\t\t<div className=\"w-full max-w-3xl bg-[#0b1020] rounded-2xl border border-indigo-500/40 shadow-2xl\" onClick={e=>e.stopPropagation()}>\r\n\t\t\t\t\t\t\t<div className=\"flex items-center justify-between px-4 py-3 border-b border-indigo-500/20\">\r\n\t\t\t\t\t\t\t\t<div className=\"font-semibold\">Preview: {preview.kind}</div>\r\n\t\t\t\t\t\t\t\t<button className=\"btn\" onClick={()=>setPreview({ open: false })}>Close</button>\r\n\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t<div className=\"p-0 bg-black/30\">\r\n\t\t\t\t\t\t\t\t<iframe title=\"Email Preview\" style={{ width: '100%', height: '70vh', border: '0', background: 'transparent' }} srcDoc={preview.html || ''} />\r\n\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t<div className=\"px-4 py-3 border-t border-indigo-500/20 text-xs opacity-70\">Click outside this panel or press Esc to close.</div>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t</div>\r\n\t\t\t)}\r\n\t\t</div>\r\n\t)\r\n}\r\n\r\n\tasync function broadcastTournaments() {\r\n\t\tsetLoading(true)\r\n\t\ttry {\r\n\t\t\tconst headers = { 'Content-Type': 'application/json', Authorization: `Bearer ${localStorage.getItem('authToken')}` }\r\n\t\t\tconst res = await fetch('/api/admin/tournaments/broadcast', { method: 'POST', headers })\r\n\t\t\tif (res.ok) {\r\n\t\t\t\ttoast('Tournaments broadcast triggered', { type: 'success' })\r\n\t\t\t} else {\r\n\t\t\t\ttoast('Broadcast failed', { type: 'error' })\r\n\t\t\t}\r\n\t\t} catch (err) {\r\n\t\t\ttoast('Broadcast request failed', { type: 'error' })\r\n\t\t} finally { setLoading(false) }\r\n\t}\r\n","import React, { useEffect, useState } from 'react';\r\nimport { User, Settings, Volume2, Camera, Gamepad2, Eye, Mic, Save, Edit3, Shield, HelpCircle, MessageCircle, X, Send, ChevronDown } from 'lucide-react';\r\nimport { useUserSettings } from '../store/userSettings';\r\nimport { apiFetch } from '../utils/api';\r\n\r\nexport default function SettingsPanel({ user }: { user?: any }) {\r\n  const {\r\n    favoriteDouble, callerEnabled, callerVoice, callerVolume, speakCheckoutOnly, avgMode,\r\n    autoStartOffline, rememberLastOffline, reducedMotion, compactHeader, allowSpectate,\r\n  cameraScale, cameraAspect, cameraFitMode, autoscoreProvider, autoscoreWsUrl, autoCommitMode, calibrationGuide,\r\n    preferredCameraId, preferredCameraLabel, cameraEnabled, offlineLayout, textSize, boxSize,\r\n    setFavoriteDouble, setCallerEnabled, setCallerVoice, setCallerVolume, setSpeakCheckoutOnly,\r\n    setAvgMode, setAutoStartOffline, setRememberLastOffline, setReducedMotion, setCompactHeader,\r\n  setAllowSpectate, setCameraScale, setCameraAspect, setCameraFitMode, setAutoscoreProvider, setAutoscoreWsUrl,\r\n  setAutoCommitMode, setCalibrationGuide, setPreferredCamera, setCameraEnabled, setOfflineLayout, setTextSize, setBoxSize,\r\n    dartTimerEnabled, dartTimerSeconds, setDartTimerEnabled, setDartTimerSeconds,\r\n    x01DoubleIn, setX01DoubleIn\r\n  } = useUserSettings();\r\n\r\n  // Achievements state\r\n  const [achievements, setAchievements] = useState([\r\n    { key: 'first180', label: 'First 180', unlocked: false, icon: '', desc: 'Score 180 in a match.' },\r\n    { key: 'hundredGames', label: '100 Games Played', unlocked: false, icon: '', desc: 'Play 100 games.' },\r\n    { key: 'tournamentWin', label: 'Tournament Winner', unlocked: false, icon: '', desc: 'Win a tournament.' },\r\n    { key: 'bestLeg', label: 'Best Leg', unlocked: false, icon: '', desc: 'Finish a leg in 12 darts or less.' },\r\n    { key: 'comeback', label: 'Comeback', unlocked: false, icon: '', desc: 'Win after trailing by 3 legs.' },\r\n  ]);\r\n\r\n  useEffect(() => {\r\n    const uname = user?.username || '';\r\n    if (!uname) return;\r\n    setAchievements(prev => prev.map(a => ({\r\n      ...a,\r\n      unlocked: !!localStorage.getItem(`ndn:achieve:${a.key}:${uname}`)\r\n    })));\r\n  }, [user?.username]);\r\n\r\n  // Profile bio fields with edit mode\r\n  const [isEditing, setIsEditing] = useState(false);\r\n  const [favPlayer, setFavPlayer] = useState('');\r\n  const [favTeam, setFavTeam] = useState('');\r\n  const [favDarts, setFavDarts] = useState('');\r\n  const [bio, setBio] = useState('');\r\n  const [profilePhoto, setProfilePhoto] = useState('');\r\n  const [allowAnalytics, setAllowAnalytics] = useState(true);\r\n  const [subscription, setSubscription] = useState<any>(null);\r\n\r\n  // Help Assistant state\r\n  const [helpMessages, setHelpMessages] = useState<Array<{text: string | {text: string, links?: Array<{text: string, tab: string}>}, isUser: boolean}>>([\r\n    { text: \"Hi! I'm your Nine Dart Nation assistant. How can I help you today?\", isUser: false }\r\n  ]);\r\n  const [helpInput, setHelpInput] = useState('');\r\n\r\n  useEffect(() => {\r\n    const uname = user?.username || '';\r\n    if (!uname) return;\r\n    try {\r\n      setFavPlayer(localStorage.getItem(`ndn:bio:favPlayer:${uname}`) || '');\r\n      setFavTeam(localStorage.getItem(`ndn:bio:favTeam:${uname}`) || '');\r\n      setFavDarts(localStorage.getItem(`ndn:bio:favDarts:${uname}`) || '');\r\n      setBio(localStorage.getItem(`ndn:bio:bio:${uname}`) || '');\r\n      setProfilePhoto(localStorage.getItem(`ndn:bio:profilePhoto:${uname}`) || '');\r\n      setAllowAnalytics(localStorage.getItem(`ndn:settings:allowAnalytics:${uname}`) !== 'false');\r\n    } catch {}\r\n  }, [user?.username]);\r\n\r\n  useEffect(() => {\r\n    if (!user?.email) return;\r\n    apiFetch(`/api/subscription?email=${encodeURIComponent(user.email)}`)\r\n      .then(r => r.json())\r\n      .then(setSubscription)\r\n      .catch(() => {});\r\n  }, [user?.email]);\r\n\r\n  const saveBio = () => {\r\n    const uname = user?.username || '';\r\n    if (!uname) return;\r\n    try {\r\n      localStorage.setItem(`ndn:bio:favPlayer:${uname}`, favPlayer);\r\n      localStorage.setItem(`ndn:bio:favTeam:${uname}`, favTeam);\r\n      localStorage.setItem(`ndn:bio:favDarts:${uname}`, favDarts);\r\n      localStorage.setItem(`ndn:bio:bio:${uname}`, bio);\r\n      localStorage.setItem(`ndn:bio:profilePhoto:${uname}`, profilePhoto);\r\n      // Dispatch event to notify avatar update\r\n      try { window.dispatchEvent(new CustomEvent('ndn:avatar-updated', { detail: { username: uname, avatar: profilePhoto } })) } catch {}\r\n      localStorage.setItem(`ndn:settings:allowAnalytics:${uname}`, allowAnalytics.toString());\r\n      setIsEditing(false);\r\n    } catch {}\r\n  };\r\n\r\n  // Help Assistant functions\r\n  const faq = {\r\n    'how to play': 'To play darts, select a game mode from the menu. For online play, join a match. For offline, start a local game.',\r\n    'calibration': 'Go to Settings > Camera & Vision > Calibration Guide to set up your camera properly.',\r\n    'premium': 'Premium unlocks all game modes. Click the \"Upgrade to PREMIUM\" button in online play.',\r\n    'username': 'Change your username once for free in Settings > Account.',\r\n    'voice': 'Enable voice caller in Settings > Audio & Voice. Test the voice with the Test Voice button.',\r\n    'friends': 'Add friends in the Friends tab to play together.',\r\n    'stats': 'View your statistics in the Stats tab.',\r\n    'settings': 'Customize your experience in the Settings panel.',\r\n    'support': 'Contact support via email or check the FAQ in Settings > Support.',\r\n  };\r\n\r\n  const navigateToTab = (tabKey: string) => {\r\n    try {\r\n      window.dispatchEvent(new CustomEvent('ndn:change-tab', { detail: { tab: tabKey } }));\r\n    } catch (error) {\r\n      console.error('Navigation failed:', error);\r\n    }\r\n  };\r\n\r\n  const getResponseWithLinks = (userMessage: string): { text: string, links?: Array<{ text: string, tab: string }> } => {\r\n    const message = userMessage.toLowerCase();\r\n\r\n    if (message.includes('username') || message.includes('change name')) {\r\n      return {\r\n        text: 'You can change your username once for free.',\r\n        links: [{ text: 'Go to Settings > Account', tab: 'settings' }]\r\n      };\r\n    }\r\n    if (message.includes('premium') || message.includes('upgrade') || message.includes('subscription')) {\r\n      return {\r\n        text: 'Premium unlocks all game modes and features.',\r\n        links: [{ text: 'Go to Online Play', tab: 'online' }]\r\n      };\r\n    }\r\n    if (message.includes('calibrat') || message.includes('camera') || message.includes('vision')) {\r\n      return {\r\n        text: 'Set up your camera properly in Settings.',\r\n        links: [{ text: 'Go to Settings > Camera & Vision', tab: 'settings' }]\r\n      };\r\n    }\r\n    if (message.includes('voice') || message.includes('caller') || message.includes('audio')) {\r\n      return {\r\n        text: 'Enable voice calling in Settings.',\r\n        links: [{ text: 'Go to Settings > Audio & Voice', tab: 'settings' }]\r\n      };\r\n    }\r\n    if (message.includes('friend') || message.includes('play together')) {\r\n      return {\r\n        text: 'Add friends to play together.',\r\n        links: [{ text: 'Go to Friends', tab: 'friends' }]\r\n      };\r\n    }\r\n    if (message.includes('stat') || message.includes('score') || message.includes('performance')) {\r\n      return {\r\n        text: 'View your statistics and performance.',\r\n        links: [{ text: 'Go to Stats', tab: 'stats' }]\r\n      };\r\n    }\r\n    if (message.includes('setting') || message.includes('customiz') || message.includes('configur')) {\r\n      return {\r\n        text: 'Customize your experience.',\r\n        links: [{ text: 'Go to Settings', tab: 'settings' }]\r\n      };\r\n    }\r\n    if (message.includes('tournament') || message.includes('competition')) {\r\n      return {\r\n        text: 'Check out tournaments and competitions.',\r\n        links: [{ text: 'Go to Tournaments', tab: 'tournaments' }]\r\n      };\r\n    }\r\n    if (message.includes('help') || message.includes('support') || message.includes('faq')) {\r\n      return {\r\n        text: 'You\\'re already in the help section! Check the Support section above for more resources.',\r\n        links: [{ text: 'Scroll to Support', tab: 'settings' }]\r\n      };\r\n    }\r\n    if (message.includes('how to play') || message.includes('game') || message.includes('start')) {\r\n      return {\r\n        text: 'To play darts, select a game mode from the menu. For online play, join a match. For offline, start a local game.',\r\n        links: [\r\n          { text: 'Play Online', tab: 'online' },\r\n          { text: 'Play Offline', tab: 'offline' }\r\n        ]\r\n      };\r\n    }\r\n\r\n    return { text: \"I'm not sure about that. Try asking about playing, calibration, premium, username changes, voice settings, friends, stats, or settings.\" };\r\n  };\r\n\r\n  const handleHelpSend = () => {\r\n    if (!helpInput.trim()) return;\r\n    const userMessage = helpInput.toLowerCase();\r\n    setHelpMessages(prev => [...prev, { text: helpInput, isUser: true }]);\r\n    setHelpInput('');\r\n\r\n    // Get response with smart link suggestions\r\n    const response = getResponseWithLinks(userMessage);\r\n\r\n    setTimeout(() => {\r\n      setHelpMessages(prev => [...prev, { text: response, isUser: false }]);\r\n    }, 500);\r\n  };\r\n\r\n  // Username change state\r\n  const [newUsername, setNewUsername] = useState('')\r\n  const [changingUsername, setChangingUsername] = useState(false)\r\n  const [usernameError, setUsernameError] = useState('')\r\n\r\n  // Available voices for caller\r\n  const [availableVoices, setAvailableVoices] = useState<SpeechSynthesisVoice[]>([])\r\n\r\n  useEffect(() => {\r\n    const loadVoices = () => {\r\n      const voices = speechSynthesis.getVoices();\r\n      setAvailableVoices(voices.filter(v => v.lang.startsWith('en')));\r\n    };\r\n    loadVoices();\r\n    speechSynthesis.onvoiceschanged = loadVoices;\r\n  }, []);\r\n\r\n  // Highlights state\r\n  const [showHighlights, setShowHighlights] = useState(false);\r\n\r\n  // Collapsible pill state\r\n  const [expandedPill, setExpandedPill] = useState<'user' | 'calibration' | 'settings' | null>(null);\r\n\r\n  const PillButton = ({ label, icon: Icon, pill, color }: { label: string; icon: any; pill: 'user' | 'calibration' | 'settings'; color: string }) => (\r\n    <button\r\n      onClick={() => setExpandedPill(expandedPill === pill ? null : pill)}\r\n      type=\"button\"\r\n      className={`transition-all select-none whitespace-nowrap rounded-full px-4 py-2 text-sm font-semibold shadow-sm focus:outline-none focus-visible:ring-2 focus-visible:ring-white/60 active:scale-[0.98] bg-gradient-to-r ${color} text-white flex items-center gap-2`}\r\n    >\r\n      <Icon className=\"w-4 h-4\" /> {label}\r\n      <ChevronDown className={`w-4 h-4 transition-transform ${expandedPill === pill ? 'rotate-180' : ''}`} />\r\n    </button>\r\n  );\r\n\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      {/* ==== USER INFO PILL ==== */}\r\n      <div className=\"relative rounded-xl bg-white/5 backdrop-blur-md border border-white/10 p-1\">\r\n        <div className=\"flex items-center gap-2 overflow-x-auto no-scrollbar py-1 px-1\">\r\n          <PillButton label=\"User Info\" icon={User} pill=\"user\" color=\"from-indigo-500 to-fuchsia-500 shadow-indigo-500/30\" />\r\n        </div>\r\n      </div>\r\n\r\n      {/* USER INFO CONTENT */}\r\n      {expandedPill === 'user' && (\r\n        <div className=\"p-6 rounded-2xl border border-white/10 bg-white/[0.02] animate-in fade-in duration-200 space-y-4\">\r\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n            {/* Account */}\r\n            <div className=\"card\">\r\n              <div className=\"p-3 rounded-xl border border-red-500/40 bg-red-500/10\">\r\n                <div className=\"font-semibold mb-4 flex items-center gap-2 text-red-100\">\r\n                  <User className=\"w-5 h-5\" /> Account\r\n                </div>\r\n                <div className=\"space-y-3\">\r\n                  <div className=\"flex justify-center gap-2\">\r\n                    <button\r\n                      onClick={() => window.dispatchEvent(new CustomEvent('ndn:logout'))}\r\n                      className=\"px-6 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium transition-colors\"\r\n                    >\r\n                      Logout\r\n                    </button>\r\n                    <button\r\n                      onClick={() => setShowHighlights(true)}\r\n                      className=\"px-4 py-2 bg-slate-700 hover:bg-slate-800 text-white rounded-lg font-medium transition-colors\"\r\n                    >\r\n                      Highlights\r\n                    </button>\r\n                  </div>\r\n                  <div className=\"border-t border-red-500/20 pt-3\">\r\n                    <div className=\"font-medium mb-2 text-red-100\">Change Username ({(() => {\r\n                      const count = user?.usernameChangeCount || 0;\r\n                      if (count < 2) return `${2 - count} free changes remaining`;\r\n                      return '2 per change';\r\n                    })()})</div>\r\n                    <div className=\"text-sm text-red-100 mb-2\">You can change your username up to 2 times for free. Additional changes cost 2 each.</div>\r\n                    {user?.usernameChangeCount >= 2 && !newUsername.trim() ? (\r\n                      <div className=\"text-amber-400 text-sm mb-2\"> Additional username changes cost 2</div>\r\n                    ) : null}\r\n                    <input\r\n                      className=\"input w-full mb-2\"\r\n                      type=\"text\"\r\n                      placeholder=\"New username\"\r\n                      value={newUsername}\r\n                      onChange={e => setNewUsername(e.target.value)}\r\n                      disabled={changingUsername}\r\n                    />\r\n                    {usernameError && <div className=\"text-red-400 text-sm mb-2\">{usernameError}</div>}\r\n                    <button\r\n                      onClick={async () => {\r\n                        setUsernameError('')\r\n                        if (!newUsername.trim()) {\r\n                          setUsernameError('Username required')\r\n                          return\r\n                        }\r\n                        if (newUsername.length < 3 || newUsername.length > 20) {\r\n                          setUsernameError('Username must be 3-20 characters')\r\n                          return\r\n                        }\r\n                        const currentCount = user?.usernameChangeCount || 0;\r\n                        const isFree = currentCount < 2;\r\n                        if (!isFree) {\r\n                          window.location.href = 'https://buy.stripe.com/eVq4gB3XqeNS0iw6vAfnO02'\r\n                        } else {\r\n                          localStorage.setItem('pendingUsernameChange', newUsername.trim())\r\n                          window.location.href = '/?username-change=free'\r\n                        }\r\n                      }}\r\n                      disabled={changingUsername || !newUsername.trim()}\r\n                      className=\"w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-600 text-white rounded-lg font-medium transition-colors\"\r\n                    >\r\n                      {changingUsername ? 'Processing...' : (() => {\r\n                        const count = user?.usernameChangeCount || 0;\r\n                        return count < 2 ? 'Change Username (FREE)' : 'Change Username (2)';\r\n                      })()}\r\n                    </button>\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            </div>\r\n\r\n            {/* Premium */}\r\n            {subscription && (\r\n              <div className=\"card\">\r\n                <div className=\"p-3 rounded-xl border border-green-500/40 bg-green-500/10\">\r\n                  <div className=\"font-semibold mb-4 flex items-center gap-2 text-green-100\">\r\n                    <Shield className=\"w-5 h-5\" /> Premium\r\n                  </div>\r\n                  <div className=\"space-y-3 text-sm text-green-100\">\r\n                    <div>Status: <span className={subscription?.status === 'active' ? 'text-green-400' : 'text-yellow-400'}>{subscription?.status === 'active' ? ' Active' : 'Not Active'}</span></div>\r\n                    {subscription?.status === 'active' && subscription?.nextBillingDate && (\r\n                      <div>Next Billing: {new Date(subscription.nextBillingDate).toLocaleDateString()}</div>\r\n                    )}\r\n                    {subscription?.source === 'tournament' && subscription?.status === 'active' && (\r\n                      <button\r\n                        onClick={() => window.location.href = 'https://buy.stripe.com/eVq4gB3XqeNS0iw6vAfnO02'}\r\n                        className=\"w-full px-3 py-2 bg-red-600 hover:bg-red-700 text-white rounded font-medium transition-colors text-xs\"\r\n                      >\r\n                        Cancel Subscription\r\n                      </button>\r\n                    )}\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            )}\r\n\r\n            {/* Profile Photo */}\r\n            <div className=\"card\">\r\n              <div className=\"p-3 rounded-xl border border-cyan-500/40 bg-cyan-500/10\">\r\n                <div className=\"font-semibold mb-4 flex items-center gap-2 text-cyan-100\">\r\n                  <Eye className=\"w-5 h-5\" /> Profile Photo\r\n                </div>\r\n                <input\r\n                  type=\"file\"\r\n                  accept=\"image/*\"\r\n                  onChange={(e) => {\r\n                    const file = e.target.files?.[0];\r\n                    if (file) {\r\n                      const reader = new FileReader();\r\n                      reader.onload = () => setProfilePhoto(reader.result as string);\r\n                      reader.readAsDataURL(file);\r\n                    }\r\n                  }}\r\n                  className=\"w-full text-xs text-slate-100\"\r\n                />\r\n              </div>\r\n            </div>\r\n\r\n            {/* Online & Socials */}\r\n            <div className=\"card\">\r\n              <div className=\"p-3 rounded-xl border border-purple-500/40 bg-purple-500/10\">\r\n                <div className=\"font-semibold mb-4 flex items-center gap-2 text-purple-100\">\r\n                  <MessageCircle className=\"w-5 h-5\" /> Online & Socials\r\n                </div>\r\n                <div className=\"space-y-3\">\r\n                  <div className=\"flex items-center gap-3\">\r\n                    <input\r\n                      type=\"checkbox\"\r\n                      id=\"allowSpectate\"\r\n                      checked={allowSpectate}\r\n                      onChange={e => setAllowSpectate(e.target.checked)}\r\n                      className=\"w-4 h-4\"\r\n                    />\r\n                    <label htmlFor=\"allowSpectate\" className=\"text-sm text-purple-100\">Allow spectators</label>\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            </div>\r\n\r\n            {/* Data & Privacy */}\r\n            <div className=\"card\">\r\n              <div className=\"p-3 rounded-xl border border-orange-500/40 bg-orange-500/10\">\r\n                <div className=\"font-semibold mb-4 flex items-center gap-2 text-orange-100\">\r\n                  <Shield className=\"w-5 h-5\" /> Data & Privacy\r\n                </div>\r\n                <div className=\"space-y-3\">\r\n                  <div className=\"flex items-center gap-3\">\r\n                    <input\r\n                      type=\"checkbox\"\r\n                      id=\"allowAnalytics\"\r\n                      checked={allowAnalytics}\r\n                      onChange={e => setAllowAnalytics(e.target.checked)}\r\n                      className=\"w-4 h-4\"\r\n                    />\r\n                    <label htmlFor=\"allowAnalytics\" className=\"text-sm text-orange-100\">Allow analytics</label>\r\n                  </div>\r\n                  <button\r\n                    onClick={() => {\r\n                      const data = { achievements, bio: { favPlayer, favTeam, favDarts, bio } };\r\n                      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });\r\n                      const url = URL.createObjectURL(blob);\r\n                      const a = document.createElement('a');\r\n                      a.href = url;\r\n                      a.download = `my-data-${new Date().toISOString().split('T')[0]}.json`;\r\n                      a.click();\r\n                      URL.revokeObjectURL(url);\r\n                    }}\r\n                    className=\"btn bg-orange-600 hover:bg-orange-700 w-full\"\r\n                  >\r\n                    Export My Data\r\n                  </button>\r\n                </div>\r\n              </div>\r\n            </div>\r\n\r\n            {/* Privacy & Copyright Notice */}\r\n            <div className=\"card\">\r\n              <div className=\"p-3 rounded-xl border border-red-500/40 bg-red-500/10\">\r\n                <div className=\"font-semibold mb-4 flex items-center gap-2\">\r\n                  <Shield className=\"w-5 h-5 text-red-400\" /> Privacy & Copyright\r\n                </div>\r\n                <div className=\"space-y-3 text-sm text-slate-300\">\r\n                  <div className=\"bg-red-500/20 border border-red-500/30 rounded-lg p-3\">\r\n                    <p className=\"font-semibold text-red-300 mb-2\"> Legal Notice</p>\r\n                    <p className=\"mb-2 text-xs\">\r\n                      <strong>Copyright:</strong> All content is protected by copyright law.\r\n                    </p>\r\n                    <p className=\"text-xs\">\r\n                      <strong>Privacy:</strong> Your data is protected and unauthorized access is prohibited.\r\n                    </p>\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            </div>\r\n\r\n            {/* Blocked Users */}\r\n            <div className=\"card\">\r\n              <div className=\"p-3 rounded-xl border border-yellow-500/40 bg-yellow-500/10\">\r\n                <div className=\"font-semibold mb-4 flex items-center gap-2 text-yellow-100\">\r\n                  <Shield className=\"w-5 h-5\" /> Blocked Users\r\n                </div>\r\n                <div className=\"space-y-3\">\r\n                  <p className=\"text-sm text-yellow-100\">Manage players you've blocked from contacting you.</p>\r\n                  <button\r\n                    onClick={() => window.dispatchEvent(new CustomEvent('ndn:open-blocklist'))}\r\n                    className=\"btn bg-yellow-600 hover:bg-yellow-700 w-full text-sm\"\r\n                  >\r\n                    View Blocked Users\r\n                  </button>\r\n                </div>\r\n              </div>\r\n            </div>\r\n\r\n            {/* Contact & Support */}\r\n            <div className=\"card\">\r\n              <div className=\"p-3 rounded-xl border border-blue-500/40 bg-blue-500/10\">\r\n                <div className=\"font-semibold mb-4 flex items-center gap-2 text-blue-100\">\r\n                  <MessageCircle className=\"w-5 h-5\" /> Contact & Support\r\n                </div>\r\n                <div className=\"space-y-2\">\r\n                  <a\r\n                    href=\"mailto:support@ninedartnation.com\"\r\n                    className=\"flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors text-sm\"\r\n                  >\r\n                     Email Support\r\n                  </a>\r\n                  <a\r\n                    href=\"https://ninedartnation.com/help\"\r\n                    target=\"_blank\"\r\n                    rel=\"noopener noreferrer\"\r\n                    className=\"flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors text-sm\"\r\n                  >\r\n                     Help Center\r\n                  </a>\r\n                  <a\r\n                    href=\"https://ninedartnation.com/faq\"\r\n                    target=\"_blank\"\r\n                    rel=\"noopener noreferrer\"\r\n                    className=\"flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors text-sm\"\r\n                  >\r\n                     FAQ\r\n                  </a>\r\n                </div>\r\n              </div>\r\n            </div>\r\n\r\n            {/* Account Deletion */}\r\n            <div className=\"card\">\r\n              <div className=\"p-3 rounded-xl border border-red-500/40 bg-red-500/10\">\r\n                <div className=\"font-semibold mb-4 flex items-center gap-2 text-red-100\">\r\n                  <Shield className=\"w-5 h-5\" /> Delete Account\r\n                </div>\r\n                <div className=\"space-y-3\">\r\n                  <div className=\"bg-red-500/20 border border-red-500/30 rounded-lg p-3 text-xs text-red-200\">\r\n                    <p className=\"font-semibold mb-1\"> Warning</p>\r\n                    <p>Deleting your account is permanent and cannot be undone. All your stats, achievements, and data will be erased.</p>\r\n                  </div>\r\n                  <button\r\n                    onClick={() => {\r\n                      const confirm = window.confirm(\r\n                        'Are you absolutely sure you want to delete your account? This action cannot be undone.\\n\\nAll your stats, achievements, and data will be permanently erased.'\r\n                      );\r\n                      if (confirm) {\r\n                        const finalConfirm = window.confirm(\r\n                          'This is your final warning. Click OK to permanently delete your account.'\r\n                        );\r\n                        if (finalConfirm) {\r\n                          window.dispatchEvent(new CustomEvent('ndn:delete-account'));\r\n                        }\r\n                      }\r\n                    }}\r\n                    className=\"w-full px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium transition-colors\"\r\n                  >\r\n                    Permanently Delete Account\r\n                  </button>\r\n                </div>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      )}\r\n\r\n      {/* ==== CALIBRATION PILL ==== */}\r\n      <div className=\"relative rounded-xl bg-white/5 backdrop-blur-md border border-white/10 p-1\">\r\n        <div className=\"flex items-center gap-2 overflow-x-auto no-scrollbar py-1 px-1\">\r\n          <PillButton label=\"Calibration\" icon={Camera} pill=\"calibration\" color=\"from-purple-500 to-pink-500 shadow-purple-500/30\" />\r\n        </div>\r\n      </div>\r\n\r\n      {/* CALIBRATION CONTENT */}\r\n      {expandedPill === 'calibration' && (\r\n        <div className=\"p-6 rounded-2xl border border-white/10 bg-white/[0.02] animate-in fade-in duration-200 space-y-4\">\r\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n            {/* Camera & Vision */}\r\n            <div className=\"card\">\r\n              <div className=\"p-3 rounded-xl border border-blue-500/40 bg-blue-500/10\">\r\n                <div className=\"font-semibold mb-4 flex items-center gap-2\">\r\n                  <Camera className=\"w-5 h-5 text-blue-400\" /> Camera & Vision\r\n                </div>\r\n                <div className=\"space-y-4\">\r\n                  <div className=\"flex items-center gap-3\">\r\n                    <input\r\n                      type=\"checkbox\"\r\n                      id=\"cameraEnabled\"\r\n                      checked={cameraEnabled}\r\n                      onChange={e => setCameraEnabled(e.target.checked)}\r\n                      className=\"w-4 h-4\"\r\n                    />\r\n                    <label htmlFor=\"cameraEnabled\" className=\"text-sm\">Enable camera</label>\r\n                  </div>\r\n                  {cameraEnabled && (\r\n                    <>\r\n                      <div>\r\n                        <label htmlFor=\"cameraScale\" className=\"block text-sm mb-2\">Scale: {cameraScale?.toFixed(2)}</label>\r\n                        <input\r\n                          type=\"range\"\r\n                          id=\"cameraScale\"\r\n                          min=\"0.5\"\r\n                          max=\"3\"\r\n                          step=\"0.1\"\r\n                          value={cameraScale || 1}\r\n                          onChange={e => setCameraScale(parseFloat(e.target.value))}\r\n                          className=\"w-full\"\r\n                        />\r\n                      </div>\r\n                      <div>\r\n                        <label htmlFor=\"cameraAspect\" className=\"block text-sm mb-2\">Aspect Ratio</label>\r\n                        <select\r\n                          id=\"cameraAspect\"\r\n                          value={cameraAspect || 'wide'}\r\n                          onChange={e => setCameraAspect(e.target.value as 'wide' | 'square')}\r\n                          className=\"input w-full\"\r\n                        >\r\n                          <option value=\"wide\">Wide (16:9)</option>\r\n                          <option value=\"square\">Square (1:1)</option>\r\n                        </select>\r\n                      </div>\r\n                      <div>\r\n                        <label htmlFor=\"cameraFitMode\" className=\"block text-sm mb-2\">Fit Mode</label>\r\n                        <select\r\n                          id=\"cameraFitMode\"\r\n                          value={cameraFitMode || 'fit'}\r\n                          onChange={e => setCameraFitMode(e.target.value as 'fill' | 'fit')}\r\n                          className=\"input w-full\"\r\n                        >\r\n                          <option value=\"fill\">Fill (crop)</option>\r\n                          <option value=\"fit\">Fit (letterbox)</option>\r\n                        </select>\r\n                      </div>\r\n                      <button\r\n                        onClick={() => {}}\r\n                        className=\"btn bg-indigo-600 hover:bg-indigo-700 w-full\"\r\n                      >\r\n                        Calibration Guide\r\n                      </button>\r\n                      <div>\r\n                        <label htmlFor=\"autoscoreProvider\" className=\"block text-sm mb-2\">Auto-score Provider</label>\r\n                        <select\r\n                          id=\"autoscoreProvider\"\r\n                          value={autoscoreProvider || 'manual'}\r\n                          onChange={e => setAutoscoreProvider(e.target.value as 'manual' | 'built-in' | 'external-ws')}\r\n                          className=\"input w-full\"\r\n                        >\r\n                          <option value=\"manual\">Manual Scoring</option>\r\n                          <option value=\"built-in\">Built-in Vision</option>\r\n                          <option value=\"external-ws\">External (WebSocket)</option>\r\n                        </select>\r\n                      </div>\r\n                      {autoscoreProvider === 'external-ws' && (\r\n                        <input\r\n                          type=\"text\"\r\n                          placeholder=\"WebSocket URL\"\r\n                          value={autoscoreWsUrl || ''}\r\n                          onChange={e => setAutoscoreWsUrl(e.target.value)}\r\n                          className=\"input w-full text-xs\"\r\n                        />\r\n                      )}\r\n                      {autoscoreProvider !== 'manual' && (\r\n                        <div>\r\n                          <label htmlFor=\"autoCommitMode\" className=\"block text-sm mb-2\">Turn Advance</label>\r\n                          <select\r\n                            id=\"autoCommitMode\"\r\n                            value={autoCommitMode || 'wait-for-clear'}\r\n                            onChange={e => setAutoCommitMode(e.target.value as 'wait-for-clear' | 'immediate')}\r\n                            className=\"input w-full\"\r\n                          >\r\n                            <option value=\"wait-for-clear\">Wait for darts to be removed</option>\r\n                            <option value=\"immediate\">Advance immediately after 3 darts/bust</option>\r\n                          </select>\r\n                          <p className=\"text-xs opacity-70 mt-1\">Waiting prevents the turn from rotating until you clear the board (or 6.5s pass).</p>\r\n                        </div>\r\n                      )}\r\n                    </>\r\n                  )}\r\n                </div>\r\n              </div>\r\n            </div>\r\n\r\n            {/* Audio & Voice */}\r\n            <div className=\"card\">\r\n              <div className=\"p-3 rounded-xl border border-purple-500/40 bg-purple-500/10\">\r\n                <div className=\"font-semibold mb-4 flex items-center gap-2\">\r\n                  <Volume2 className=\"w-5 h-5 text-purple-400\" /> Audio & Voice\r\n                </div>\r\n                <div className=\"space-y-4\">\r\n                  <div className=\"flex items-center gap-3\">\r\n                    <input\r\n                      type=\"checkbox\"\r\n                      id=\"callerEnabled\"\r\n                      checked={callerEnabled}\r\n                      onChange={e => setCallerEnabled(e.target.checked)}\r\n                      className=\"w-4 h-4\"\r\n                    />\r\n                    <label htmlFor=\"callerEnabled\" className=\"text-sm\">Enable voice caller</label>\r\n                  </div>\r\n                  {callerEnabled && (\r\n                    <>\r\n                      <div>\r\n                        <label htmlFor=\"callerVoice\" className=\"block text-sm mb-2\">Voice</label>\r\n                        <select\r\n                          id=\"callerVoice\"\r\n                          value={callerVoice || ''}\r\n                          onChange={e => setCallerVoice(e.target.value)}\r\n                          className=\"input w-full text-xs\"\r\n                        >\r\n                          <option value=\"\">Default</option>\r\n                          {availableVoices.map((v, i) => (\r\n                            <option key={i} value={v.voiceURI}>{v.name}</option>\r\n                          ))}\r\n                        </select>\r\n                      </div>\r\n                      <div>\r\n                        <label htmlFor=\"callerVolume\" className=\"block text-sm mb-2\">Volume: {Math.round((callerVolume || 1) * 100)}%</label>\r\n                        <input\r\n                          type=\"range\"\r\n                          id=\"callerVolume\"\r\n                          min=\"0\"\r\n                          max=\"1\"\r\n                          step=\"0.1\"\r\n                          value={callerVolume || 1}\r\n                          onChange={e => setCallerVolume(parseFloat(e.target.value))}\r\n                          className=\"w-full\"\r\n                        />\r\n                      </div>\r\n                      <div className=\"flex items-center gap-3\">\r\n                        <input\r\n                          type=\"checkbox\"\r\n                          id=\"speakCheckoutOnly\"\r\n                          checked={speakCheckoutOnly}\r\n                          onChange={e => setSpeakCheckoutOnly(e.target.checked)}\r\n                          className=\"w-4 h-4\"\r\n                        />\r\n                        <label htmlFor=\"speakCheckoutOnly\" className=\"text-sm\">Only speak checkout scores</label>\r\n                      </div>\r\n                      <button\r\n                        onClick={() => {\r\n                          const utterance = new SpeechSynthesisUtterance('Test voice. 180!');\r\n                          utterance.voice = availableVoices.find(v => v.voiceURI === callerVoice) || null;\r\n                          utterance.volume = callerVolume || 1;\r\n                          speechSynthesis.cancel();\r\n                          speechSynthesis.speak(utterance);\r\n                        }}\r\n                        className=\"btn bg-purple-600 hover:bg-purple-700 w-full\"\r\n                      >\r\n                        Test Voice\r\n                      </button>\r\n                    </>\r\n                  )}\r\n                </div>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      )}\r\n\r\n      {/* ==== SETTINGS SECTIONS PILL ==== */}\r\n      <div className=\"relative rounded-xl bg-white/5 backdrop-blur-md border border-white/10 p-1\">\r\n        <div className=\"flex items-center gap-2 overflow-x-auto no-scrollbar py-1 px-1\">\r\n          <PillButton label=\"Settings\" icon={Settings} pill=\"settings\" color=\"from-cyan-500 to-blue-500 shadow-cyan-500/30\" />\r\n        </div>\r\n      </div>\r\n\r\n      {/* SETTINGS CONTENT */}\r\n      {expandedPill === 'settings' && (\r\n        <div className=\"space-y-4 animate-in fade-in duration-200\">\r\n\r\n          {/* Profile Bio */}\r\n          <div className=\"card\">\r\n            <div className=\"p-3 rounded-xl border border-indigo-500/40 bg-indigo-500/10\">\r\n              <div className=\"flex items-center justify-between mb-4\">\r\n                <div className=\"font-semibold flex items-center gap-2\">\r\n                  <User className=\"w-5 h-5 text-brand-400\" /> Profile Bio\r\n                </div>\r\n                {!isEditing ? (\r\n                  <button\r\n                    onClick={() => setIsEditing(true)}\r\n                    className=\"flex items-center gap-2 px-3 py-1 bg-blue-500/20 hover:bg-blue-500/30 rounded-lg text-blue-400 text-sm transition-colors\"\r\n                  >\r\n                    <Edit3 className=\"w-4 h-4\" /> Edit\r\n                  </button>\r\n                ) : (\r\n                  <button\r\n                    onClick={saveBio}\r\n                    className=\"flex items-center gap-2 px-3 py-1 bg-green-500/20 hover:bg-green-500/30 rounded-lg text-green-400 text-sm transition-colors\"\r\n                  >\r\n                    <Save className=\"w-4 h-4\" /> Save\r\n                  </button>\r\n                )}\r\n              </div>\r\n\r\n              <div className=\"space-y-3\">\r\n                {isEditing ? (\r\n                  <>\r\n                    <div>\r\n                      <label className=\"block text-sm mb-1\">Favorite Player</label>\r\n                      <input\r\n                        type=\"text\"\r\n                        value={favPlayer}\r\n                        onChange={e => setFavPlayer(e.target.value)}\r\n                        className=\"input w-full\"\r\n                      />\r\n                    </div>\r\n                    <div>\r\n                      <label className=\"block text-sm mb-1\">Favorite Team</label>\r\n                      <input\r\n                        type=\"text\"\r\n                        value={favTeam}\r\n                        onChange={e => setFavTeam(e.target.value)}\r\n                        className=\"input w-full\"\r\n                      />\r\n                    </div>\r\n                    <div>\r\n                      <label className=\"block text-sm mb-1\">Favorite Darts</label>\r\n                      <input\r\n                        type=\"text\"\r\n                        value={favDarts}\r\n                        onChange={e => setFavDarts(e.target.value)}\r\n                        className=\"input w-full\"\r\n                      />\r\n                    </div>\r\n                    <div>\r\n                      <label className=\"block text-sm mb-1\">Bio / Quote</label>\r\n                      <textarea\r\n                        value={bio}\r\n                        onChange={e => setBio(e.target.value)}\r\n                        rows={3}\r\n                        className=\"input w-full\"\r\n                      />\r\n                    </div>\r\n                  </>\r\n                ) : (\r\n                  <>\r\n                    <div>Favorite Player: <span className=\"text-brand-300\">{favPlayer || 'Not set'}</span></div>\r\n                    <div>Favorite Team: <span className=\"text-brand-300\">{favTeam || 'Not set'}</span></div>\r\n                    <div>Favorite Darts: <span className=\"text-brand-300\">{favDarts || 'Not set'}</span></div>\r\n                    <div>Bio: <span className=\"text-brand-300\">{bio || 'No bio set'}</span></div>\r\n                  </>\r\n                )}\r\n              </div>\r\n            </div>\r\n          </div>\r\n\r\n          {/* Game Preferences */}\r\n          <div className=\"card\">\r\n            <div className=\"p-3 rounded-xl border border-green-500/40 bg-green-500/10\">\r\n              <div className=\"font-semibold mb-4 flex items-center gap-2\">\r\n                <Gamepad2 className=\"w-5 h-5 text-green-400\" /> Game Preferences\r\n              </div>\r\n              <div className=\"space-y-3\">\r\n                <div className=\"flex items-center gap-3\">\r\n                  <input\r\n                    type=\"checkbox\"\r\n                    id=\"dartTimerEnabled\"\r\n                    checked={!!dartTimerEnabled}\r\n                    onChange={e => setDartTimerEnabled(e.target.checked)}\r\n                    className=\"w-4 h-4\"\r\n                  />\r\n                  <label htmlFor=\"dartTimerEnabled\" className=\"text-sm\">Enable per-dart throw timer</label>\r\n                </div>\r\n                {dartTimerEnabled && (\r\n                  <div>\r\n                    <label className=\"block mb-2 text-sm font-medium\">Time per throw: {dartTimerSeconds ? Math.round(dartTimerSeconds) : 0}s</label>\r\n                    <input\r\n                      type=\"range\"\r\n                      min=\"3\"\r\n                      max=\"30\"\r\n                      value={dartTimerSeconds || 10}\r\n                      onChange={e => setDartTimerSeconds(parseInt(e.target.value))}\r\n                      className=\"w-full\"\r\n                    />\r\n                    <div className=\"text-xs opacity-70 mt-1\">When the timer reaches zero, the dart is recorded as a miss and advances to the next throw.</div>\r\n                  </div>\r\n                )}\r\n                <div>\r\n                  <label htmlFor=\"favoriteDouble\" className=\"block text-sm mb-2\">Favorite Finish Double</label>\r\n                  <select\r\n                    id=\"favoriteDouble\"\r\n                    value={favoriteDouble}\r\n                    onChange={e => setFavoriteDouble(e.target.value)}\r\n                    className=\"input w-full\"\r\n                  >\r\n                    <option value=\"any\">Any Double</option>\r\n                    <option value=\"D20\">Double 20</option>\r\n                    <option value=\"D10\">Double 10</option>\r\n                    <option value=\"D5\">Double 5</option>\r\n                    <option value=\"D1\">Double 1</option>\r\n                  </select>\r\n                </div>\r\n                <div>\r\n                  <label htmlFor=\"avgMode\" className=\"block text-sm mb-2\">Average Display Mode</label>\r\n                  <select\r\n                    id=\"avgMode\"\r\n                    value={avgMode}\r\n                    onChange={e => setAvgMode(e.target.value as 'all-time' | '24h')}\r\n                    className=\"input w-full\"\r\n                  >\r\n                    <option value=\"all-time\">All Time Average</option>\r\n                    <option value=\"24h\">24 Hour Average</option>\r\n                  </select>\r\n                </div>\r\n                <div className=\"flex items-center gap-3\">\r\n                  <input\r\n                    type=\"checkbox\"\r\n                    id=\"x01DoubleIn\"\r\n                    checked={!!x01DoubleIn}\r\n                    onChange={e => setX01DoubleIn(e.target.checked)}\r\n                    className=\"w-4 h-4\"\r\n                  />\r\n                  <label htmlFor=\"x01DoubleIn\" className=\"text-sm\">Require Double-In for X01</label>\r\n                </div>\r\n              </div>\r\n            </div>\r\n          </div>\r\n\r\n          {/* UI & Accessibility */}\r\n          <div className=\"card\">\r\n            <div className=\"p-3 rounded-xl border border-pink-500/40 bg-pink-500/10\">\r\n              <div className=\"font-semibold mb-4 flex items-center gap-2\">\r\n                <Eye className=\"w-5 h-5 text-pink-400\" /> UI & Accessibility\r\n              </div>\r\n              <div className=\"space-y-3\">\r\n                <div className=\"flex items-center gap-3\">\r\n                  <input\r\n                    type=\"checkbox\"\r\n                    id=\"autoStartOffline\"\r\n                    checked={autoStartOffline}\r\n                    onChange={e => setAutoStartOffline(e.target.checked)}\r\n                    className=\"w-4 h-4\"\r\n                  />\r\n                  <label htmlFor=\"autoStartOffline\" className=\"text-sm\">Auto-start offline games</label>\r\n                </div>\r\n                <div className=\"flex items-center gap-3\">\r\n                  <input\r\n                    type=\"checkbox\"\r\n                    id=\"rememberLastOffline\"\r\n                    checked={rememberLastOffline}\r\n                    onChange={e => setRememberLastOffline(e.target.checked)}\r\n                    className=\"w-4 h-4\"\r\n                  />\r\n                  <label htmlFor=\"rememberLastOffline\" className=\"text-sm\">Remember last offline game settings</label>\r\n                </div>\r\n                <div>\r\n                  <label htmlFor=\"offlineLayout\" className=\"block text-sm mb-2\">Offline Layout</label>\r\n                  <select\r\n                    id=\"offlineLayout\"\r\n                    value={offlineLayout || 'classic'}\r\n                    onChange={e => setOfflineLayout(e.target.value as 'classic' | 'modern')}\r\n                    className=\"input w-full\"\r\n                  >\r\n                    <option value=\"classic\">Classic Layout</option>\r\n                    <option value=\"modern\">Modern Layout</option>\r\n                  </select>\r\n                </div>\r\n                <div className=\"flex items-center gap-3\">\r\n                  <input\r\n                    type=\"checkbox\"\r\n                    id=\"reducedMotion\"\r\n                    checked={reducedMotion}\r\n                    onChange={e => setReducedMotion(e.target.checked)}\r\n                    className=\"w-4 h-4\"\r\n                  />\r\n                  <label htmlFor=\"reducedMotion\" className=\"text-sm\">Reduce motion/animations</label>\r\n                </div>\r\n                <div className=\"flex items-center gap-3\">\r\n                  <input\r\n                    type=\"checkbox\"\r\n                    id=\"compactHeader\"\r\n                    checked={compactHeader}\r\n                    onChange={e => setCompactHeader(e.target.checked)}\r\n                    className=\"w-4 h-4\"\r\n                  />\r\n                  <label htmlFor=\"compactHeader\" className=\"text-sm\">Compact header</label>\r\n                </div>\r\n              </div>\r\n            </div>\r\n          </div>\r\n\r\n          {/* Support & Help */}\r\n          <div className=\"card\">\r\n            <div className=\"p-3 rounded-xl border border-blue-500/40 bg-blue-500/10\">\r\n              <div className=\"font-semibold mb-4 flex items-center gap-2\">\r\n                <HelpCircle className=\"w-5 h-5 text-blue-400\" /> Support & Help\r\n              </div>\r\n              <div className=\"space-y-2\">\r\n                <p className=\"text-sm opacity-80\">Need help? Contact us via email:</p>\r\n                <a href=\"mailto:support@ninedartnation.com\" className=\"btn bg-blue-600 hover:bg-blue-700 w-full text-xs\">\r\n                  Email Support\r\n                </a>\r\n              </div>\r\n            </div>\r\n          </div>\r\n\r\n          {/* Help Assistant */}\r\n          <div className=\"card\">\r\n            <div className=\"p-3 rounded-xl border border-cyan-500/40 bg-cyan-500/10\">\r\n              <div className=\"font-semibold mb-4 flex items-center gap-2\">\r\n                <MessageCircle className=\"w-5 h-5 text-cyan-400\" /> Help Assistant\r\n              </div>\r\n              <div className=\"space-y-3 max-h-96 overflow-y-auto\">\r\n                {helpMessages.map((msg, i) => (\r\n                  <div key={i} className={`${msg.isUser ? 'text-right' : ''}`}>\r\n                    <div className={`inline-block max-w-xs px-3 py-2 rounded-lg text-sm ${msg.isUser ? 'bg-indigo-600 text-white' : 'bg-white/10 text-slate-100'}`}>\r\n                      {typeof msg.text === 'string' ? msg.text : (\r\n                        <>\r\n                          <div>{msg.text.text}</div>\r\n                          {msg.text.links && (\r\n                            <div className=\"mt-2 space-y-1\">\r\n                              {msg.text.links.map((link, j) => (\r\n                                <button\r\n                                  key={j}\r\n                                  onClick={() => navigateToTab(link.tab)}\r\n                                  className=\"block w-full text-left text-xs px-2 py-1 bg-white/20 hover:bg-white/30 rounded transition\"\r\n                                >\r\n                                  {link.text}\r\n                                </button>\r\n                              ))}\r\n                            </div>\r\n                          )}\r\n                        </>\r\n                      )}\r\n                    </div>\r\n                  </div>\r\n                ))}\r\n              </div>\r\n\r\n              {/* Input */}\r\n              <div className=\"flex gap-2 mt-3\">\r\n                <input\r\n                  type=\"text\"\r\n                  value={helpInput}\r\n                  onChange={(e) => setHelpInput(e.target.value)}\r\n                  onKeyPress={(e) => e.key === 'Enter' && handleHelpSend()}\r\n                  placeholder=\"Ask me anything...\"\r\n                  className=\"flex-1 input\"\r\n                />\r\n                <button\r\n                  onClick={handleHelpSend}\r\n                  className=\"btn bg-blue-600 hover:bg-blue-700\"\r\n                >\r\n                  <Send className=\"w-4 h-4\" />\r\n                </button>\r\n              </div>\r\n            </div>\r\n          </div>\r\n\r\n        </div>\r\n      )}\r\n\r\n      {/* ==== ACHIEVEMENTS & BADGES (ALWAYS VISIBLE) ==== */}\r\n      <div className=\"card\">\r\n        <div className=\"p-3 rounded-xl border border-yellow-500/40 bg-yellow-500/10\">\r\n          <div className=\"font-semibold mb-4 flex items-center gap-2\">\r\n            <HelpCircle className=\"w-5 h-5 text-yellow-400\" /> Achievements & Badges\r\n          </div>\r\n          <div className=\"grid grid-cols-2 md:grid-cols-3 gap-2\">\r\n            {achievements.map(a => (\r\n              <div\r\n                key={a.key}\r\n                className={`p-3 rounded-lg border ${a.unlocked ? 'border-yellow-500/40 bg-yellow-500/10' : 'border-white/10 bg-white/5'}`}\r\n                title={a.desc}\r\n              >\r\n                <div className=\"text-lg\">{a.icon}</div>\r\n                <div className=\"text-xs font-semibold mt-1\">{a.label}</div>\r\n                <div className=\"text-[10px] opacity-70\">{a.unlocked ? ' Unlocked' : 'Locked'}</div>\r\n              </div>\r\n            ))}\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n    </div>\r\n  );\r\n}\r\n","import { useState } from 'react';\r\nimport { Eye, EyeOff, Trophy, Users, BarChart3, ShieldCheck, MessageCircle } from 'lucide-react';\r\n\r\n// Demo-only admin credentials. Allow build-time override via Vite env vars so\r\n// deployments (e.g., Netlify) can set their own values without editing code.\r\n// SECURITY NOTE: These live in the client bundle and are NOT secure; for demo only.\r\nconst ADMIN_EMAIL = ((import.meta as any).env?.VITE_ADMIN_EMAIL as string) || 'daviesfamily108@gmail.com';\r\nconst ADMIN_USERNAME = ((import.meta as any).env?.VITE_ADMIN_USERNAME as string) || 'DartsWithG';\r\nconst ADMIN_PASSWORD = ((import.meta as any).env?.VITE_ADMIN_PASSWORD as string) || 'Cymru-2015';\r\n\r\nfunction validatePassword(password: string) {\r\n  return password.length >= 10 && /\\d/.test(password) && /[^A-Za-z0-9]/.test(password);\r\n}\r\n\r\nexport default function Auth({ onAuth }: { onAuth: (user: any) => void }) {\r\n  const [mode, setMode] = useState<'signin' | 'signup' | 'reset'>('signin');\r\n  const [email, setEmail] = useState('');\r\n  const [username, setUsername] = useState('');\r\n  const [password, setPassword] = useState('');\r\n  const [reminder, setReminder] = useState('');\r\n  const [error, setError] = useState('');\r\n  const [showPassword, setShowPassword] = useState(false);\r\n  const [loading, setLoading] = useState(false);\r\n\r\n  // Use VITE_API_URL for API requests, fallback to relative path for local dev\r\n  const API_URL = (import.meta as any).env?.VITE_API_URL || '';\r\n\r\n  async function handleSignIn(e: any) {\r\n    e.preventDefault();\r\n    setError('');\r\n    setLoading(true);\r\n    // Preload main app chunks so switching to the app is faster\r\n    try {\r\n      void import('./Home');\r\n      void import('./OnlinePlay');\r\n      void import('./OfflinePlay');\r\n      void import('./Scoreboard');\r\n      void import('./StatsPanel');\r\n    } catch {}\r\n    if (!username || !password) {\r\n      setError('Username and password required.');\r\n      setLoading(false);\r\n      return;\r\n    }\r\n    try {\r\n      console.time('Auth:signIn roundtrip');\r\n      const res = await fetch(`${API_URL}/api/auth/login`, {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify(username.includes('@') ? { email: username, password } : { username, password })\r\n      });\r\n  const data = await res.json();\r\n  console.timeEnd('Auth:signIn roundtrip');\r\n      if (res.ok && data?.user && data?.token) {\r\n        localStorage.setItem('authToken', data.token);\r\n        onAuth(data.user);\r\n      } else {\r\n        setError(data?.error || 'Invalid username or password.');\r\n      }\r\n    } catch {\r\n      setError('Network error.');\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  }\r\n\r\n  async function handleSignUp(e: any) {\r\n    e.preventDefault();\r\n    setError('');\r\n    setLoading(true);\r\n    if (!email || !username || !password) {\r\n      setError('Email, username, and password required.');\r\n      setLoading(false);\r\n      return;\r\n    }\r\n    try {\r\n      const res = await fetch(`${API_URL}/api/auth/signup`, {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({ email, username, password })\r\n      });\r\n      const data = await res.json();\r\n      if (res.ok && data?.user && data?.token) {\r\n        localStorage.setItem('authToken', data.token);\r\n        onAuth(data.user);\r\n      } else {\r\n        setError(data?.error || 'Signup failed.');\r\n      }\r\n    } catch {\r\n      setError('Network error.');\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  }\r\n\r\n  async function handleReset(e: any) {\r\n    e.preventDefault();\r\n    setError('');\r\n    setLoading(true);\r\n    if (!email || !email.includes('@')) { setError('Enter your email address.'); setLoading(false); return }\r\n    try {\r\n      const r = await fetch(`${API_URL}/api/auth/send-reset`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email }) })\r\n      const j = await r.json()\r\n      if (!j?.ok) throw new Error(j?.error || 'Failed to send reset email')\r\n      setError('Password reset link sent to your email.');\r\n    } catch (err: any) {\r\n      setError(err?.message || 'Failed to send reset email');\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  }\r\n\r\n  async function handleSendUsername(e: any) {\r\n    e.preventDefault();\r\n    setError('');\r\n    setLoading(true);\r\n    if (!email || !email.includes('@')) { setError('Enter your email address.'); setLoading(false); return }\r\n    try {\r\n      const r = await fetch(`${API_URL}/api/auth/send-username`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email }) })\r\n      const j = await r.json()\r\n      if (!j?.ok) throw new Error(j?.error || 'Failed to send username email')\r\n      setError('Your username has been emailed to you.');\r\n    } catch (err: any) {\r\n      setError(err?.message || 'Failed to send username email');\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  }\r\n\r\n  return (\r\n    <div className=\"min-h-screen flex items-center justify-center relative overflow-hidden\">\r\n      {/* Animated background accents */}\r\n      <div className=\"background-animated\" />\r\n      <div className=\"relative z-10 w-full max-w-5xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-6 p-4\">\r\n        {/* Auth Card */}\r\n        <form className=\"card w-full space-y-4\" onSubmit={mode === 'signin' ? handleSignIn : mode === 'signup' ? handleSignUp : handleReset}>\r\n          <div className=\"flex flex-col items-center justify-center gap-2 mb-2 text-center\">\r\n            <h1 className=\"logo text-center\">NINE-DART-NATION </h1>\r\n            <span className=\"badge\">Welcome</span>\r\n          </div>\r\n          <h2 className=\"text-2xl font-bold\">{mode === 'signin' ? 'Sign In' : mode === 'signup' ? 'Create Account' : 'Reset Password'}</h2>\r\n          {(mode === 'signup' || mode === 'reset') && (\r\n            <input className=\"input w-full\" type=\"email\" placeholder=\"Email\" value={email} onChange={e => setEmail(e.target.value)} required />\r\n          )}\r\n          {mode !== 'reset' && (\r\n        <input className=\"input w-full\" type=\"text\" placeholder=\"Username or Email\" value={username} onChange={e => setUsername(e.target.value)} required />\r\n          )}\r\n          {mode !== 'reset' && (\r\n            <div className=\"relative\">\r\n              <input\r\n                className=\"input w-full pr-10\"\r\n                type={showPassword ? 'text' : 'password'}\r\n                placeholder=\"Password\"\r\n                value={password}\r\n                onChange={e => setPassword(e.target.value)}\r\n                autoComplete=\"current-password\"\r\n                required\r\n                onFocus={() => setShowPassword(false)}\r\n                onBlur={() => setShowPassword(false)}\r\n              />\r\n              <button\r\n                type=\"button\"\r\n                className=\"absolute right-2 top-1/2 -translate-y-1/2 text-slate-300 hover:text-white\"\r\n                tabIndex={-1}\r\n                onMouseDown={e => { e.preventDefault(); setShowPassword(true); }}\r\n                onMouseUp={e => { e.preventDefault(); setShowPassword(false); }}\r\n                onMouseLeave={() => setShowPassword(false)}\r\n                onTouchStart={e => { e.preventDefault(); setShowPassword(true); }}\r\n                onTouchEnd={e => { e.preventDefault(); setShowPassword(false); }}\r\n                aria-label=\"Toggle password visibility\"\r\n              >\r\n                {showPassword ? <EyeOff className=\"w-5 h-5\" /> : <Eye className=\"w-5 h-5\" />}\r\n              </button>\r\n            </div>\r\n          )}\r\n          {mode === 'signup' && (\r\n            <input className=\"input w-full\" type=\"text\" placeholder=\"Password Reminder (optional)\" value={reminder} onChange={e => setReminder(e.target.value)} />\r\n          )}\r\n          {error && <div className=\"text-red-400 font-semibold text-sm\">{error}</div>}\r\n          <button className=\"btn w-full\" type=\"submit\" disabled={loading}>{loading ? 'Signing In...' : (mode === 'signin' ? 'Sign In' : mode === 'signup' ? 'Sign Up' : 'Send Reset Link')}</button>\r\n          {mode === 'reset' && (\r\n            <button className=\"btn w-full mt-2 bg-white/10 hover:bg-white/20\" type=\"button\" onClick={handleSendUsername} disabled={loading}>Email me my username</button>\r\n          )}\r\n          <div className=\"flex justify-between text-sm mt-2\">\r\n            <button type=\"button\" className=\"underline\" onClick={() => setMode(mode === 'signin' ? 'signup' : 'signin')} disabled={loading}>{mode === 'signin' ? 'Need an account? Sign Up' : 'Already have an account? Sign In'}</button>\r\n            <button type=\"button\" className=\"underline\" onClick={() => setMode('reset')} disabled={loading}>Forgot password?</button>\r\n          </div>\r\n        </form>\r\n\r\n        {/* Hints / Teaser Panel */}\r\n        <aside className=\"card w-full\">\r\n          <h3 className=\"text-xl font-bold mb-3\">Whats inside</h3>\r\n          <ul className=\"space-y-3\">\r\n            <li className=\"flex items-start gap-3\"><Users className=\"w-5 h-5 text-indigo-300 mt-1\" />\r\n              <div>\r\n                <div className=\"font-semibold\">Online & Friends</div>\r\n                <div className=\"text-sm text-slate-200/90\">Challenge friends, chat, and join leagues.</div>\r\n              </div>\r\n            </li>\r\n            <li className=\"flex items-start gap-3\"><BarChart3 className=\"w-5 h-5 text-indigo-300 mt-1\" />\r\n              <div>\r\n                <div className=\"font-semibold\">Deep Stats</div>\r\n                <div className=\"text-sm text-slate-200/90\">Track 3-dart averages, best legs, and more.</div>\r\n              </div>\r\n            </li>\r\n            <li className=\"flex items-start gap-3\"><Trophy className=\"w-5 h-5 text-indigo-300 mt-1\" />\r\n              <div>\r\n                <div className=\"font-semibold\">Game Modes</div>\r\n                <div className=\"text-sm text-slate-200/90\">Start with 3 free online games upon signup. After that, PREMIUM is required to play all games.</div>\r\n              </div>\r\n            </li>\r\n            <li className=\"flex items-start gap-3\"><ShieldCheck className=\"w-5 h-5 text-indigo-300 mt-1\" />\r\n              <div>\r\n                <div className=\"font-semibold\">Premium Perks</div>\r\n                <div className=\"text-sm text-slate-200/90\">Polished UI, upcoming features, and early access.</div>\r\n              </div>\r\n            </li>\r\n          </ul>\r\n          <a\r\n            href={(import.meta as any).env?.VITE_DISCORD_INVITE_URL || 'https://discord.gg/8GtbZ6RU'}\r\n            target=\"_blank\"\r\n            rel=\"noopener noreferrer\"\r\n            className=\"btn mt-4 flex items-center justify-center gap-2\"\r\n          >\r\n            <MessageCircle className=\"w-5 h-5\" /> Join BullseyeDartsLeague\r\n          </a>\r\n          <a\r\n            href=\"https://discord.gg/NineDartNation\"\r\n            target=\"_blank\"\r\n            rel=\"noopener noreferrer\"\r\n            className=\"btn mt-2 flex items-center justify-center gap-2 bg-white/10 hover:bg-white/20\"\r\n          >\r\n            <MessageCircle className=\"w-5 h-5\" /> Join NineDartNation\r\n          </a>\r\n        </aside>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n","import { createContext, useContext, useEffect, useState } from 'react';\r\n\r\nconst ThemeContext = createContext({\r\n  theme: 'default',\r\n  setTheme: (t: string) => {},\r\n});\r\n\r\nconst THEME_KEY = 'ndn_theme'\r\n\r\nexport function ThemeProvider({ children }: { children: any }) {\r\n  const [theme, setTheme] = useState('default');\r\n\r\n  useEffect(() => {\r\n    try {\r\n      const saved = localStorage.getItem(THEME_KEY)\r\n      if (saved) setTheme(saved)\r\n    } catch {}\r\n  }, [])\r\n\r\n  useEffect(() => {\r\n    try { localStorage.setItem(THEME_KEY, theme) } catch {}\r\n  }, [theme])\r\n  return (\r\n    <ThemeContext.Provider value={{ theme, setTheme }}>\r\n      <div className={`theme-${theme}`}>{children}</div>\r\n    </ThemeContext.Provider>\r\n  );\r\n}\r\n\r\nexport function useTheme() {\r\n  return useContext(ThemeContext);\r\n}\r\n","import React, { useEffect, type ReactNode } from 'react'\r\n\r\ntype DrawerProps = {\r\n  open: boolean\r\n  onClose: () => void\r\n  width?: number | string\r\n  title?: string\r\n  footer?: ReactNode\r\n  children: ReactNode\r\n  side?: 'left' | 'right'\r\n}\r\n\r\nexport default function Drawer({ open, onClose, width = 700, title, footer, children, side = 'right' }: DrawerProps) {\r\n  useEffect(() => {\r\n    function onKey(e: KeyboardEvent) { if (e.key === 'Escape') onClose() }\r\n    if (open) document.addEventListener('keydown', onKey)\r\n    return () => document.removeEventListener('keydown', onKey)\r\n  }, [open, onClose])\r\n\r\n  return (\r\n    <div className={`fixed inset-0 z-50 ${open ? '' : 'pointer-events-none'}`} aria-hidden={!open}>\r\n      {/* Backdrop */}\r\n      <div className={`absolute inset-0 bg-black/60 transition-opacity ${open ? 'opacity-100' : 'opacity-0'}`} onClick={onClose} />\r\n      {/* Panel */}\r\n      <div\r\n        className={`absolute top-0 ${side==='right' ? 'right-0 border-l' : 'left-0 border-r'} h-full bg-slate-900 border-slate-700 shadow-2xl w-full sm:w-auto flex flex-col transition-transform duration-200 ${open ? 'translate-x-0' : (side==='right' ? 'translate-x-full' : '-translate-x-full')}`}\r\n        style={{ width: typeof width === 'number' ? `${width}px` : width }}\r\n        role=\"dialog\"\r\n        aria-modal=\"true\"\r\n      >\r\n        {/* Header */}\r\n        <div className=\"flex items-center justify-between px-4 py-3 border-b border-slate-700 sticky top-0 bg-slate-900 z-10\">\r\n          <div className=\"text-lg font-semibold\">{title}</div>\r\n          <button className=\"btn px-3 py-1 text-sm\" onClick={onClose}>Close</button>\r\n        </div>\r\n        {/* Body */}\r\n        <div className=\"flex-1 overflow-auto p-4\">\r\n          {children}\r\n        </div>\r\n        {/* Footer */}\r\n        {footer && (\r\n          <div className=\"px-4 py-3 border-t border-slate-700 sticky bottom-0 bg-slate-900 z-10\">\r\n            {footer}\r\n          </div>\r\n        )}\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n","import React, { useEffect, useState } from 'react';\r\nimport { HelpCircle, MessageCircle, X, Send } from 'lucide-react';\r\nimport { apiFetch } from '../utils/api'\r\nimport { useWS } from './WSProvider'\r\nimport HelpdeskChat from './HelpdeskChat'\r\n\r\ninterface HelpAssistantProps {}\r\n\r\nexport default function HelpAssistant({}: HelpAssistantProps) {\r\n  const [isOpen, setIsOpen] = useState(false);\r\n  const [messages, setMessages] = useState<Array<{text: string | {text: string, links?: Array<{text: string, tab: string}>}, isUser: boolean}>>([\r\n    { text: \"Hi! I'm your Nine Dart Nation assistant. How can I help you today?\", isUser: false }\r\n  ]);\r\n  const [input, setInput] = useState('');\r\n  const [awaitingAdminConfirm, setAwaitingAdminConfirm] = useState(false)\r\n  const [lastUserQuestion, setLastUserQuestion] = useState('')\r\n  const [myRequest, setMyRequest] = useState<any | null>(null)\r\n  const ws = (() => { try { return useWS() } catch { return null } })()\r\n\r\n  useEffect(() => {\r\n    if (!ws) return\r\n    const unsub = ws.addListener((data: any) => {\r\n      try {\r\n        if (data?.type === 'help-message' && myRequest && String(data.requestId) === String(myRequest.id)) {\r\n          // append message to chat (the HelpdeskChat modal will also get WS events, but keep assistant messages synced)\r\n          // We don't duplicate state here; just forward to help chat placeholder by refreshing request from server\r\n        }\r\n        if (data?.type === 'help-request-updated' && myRequest && data.request?.id === myRequest.id) {\r\n          setMyRequest(data.request)\r\n        }\r\n      } catch {}\r\n    })\r\n    return () => unsub()\r\n  }, [ws, myRequest])\r\n\r\n  const faq = {\r\n    'how to play': 'To play darts, select a game mode from the menu. For online play, join a match. For offline, start a local game.',\r\n    'calibration': 'Go to Settings > Camera & Vision > Calibration Guide to set up your camera properly.',\r\n    'premium': 'Premium unlocks all game modes. Click the \"Upgrade to PREMIUM\" button in online play.',\r\n    'username': 'Change your username once for free in Settings > Account.',\r\n    'voice': 'Enable voice caller in Settings > Audio & Voice. Test the voice with the Test Voice button.',\r\n    'friends': 'Add friends in the Friends tab to play together.',\r\n    'stats': 'View your statistics in the Stats tab.',\r\n    'settings': 'Customize your experience in the Settings panel.',\r\n    'support': 'Contact support via email or check the FAQ in Settings > Support.',\r\n    'scoring': 'Auto-scoring assigns each detected dart to the correct board segment using the detection pipeline. You can review scores in the Match Summary after the round.',\r\n    'autoscore': 'AutoScore attempts to place darts automatically. If a dart placement looks wrong, you can adjust it in the match review screen or disable immediate auto-commit in Settings.',\r\n    'pairing': 'To pair a phone or camera, open the Pairing flow from the main menu and follow the QR / pairing code steps. Ensure both devices are on the same network.',\r\n    'highlights': 'Highlights are saved when you checkout 50+ or visit 100+. You can download them from Settings > Highlights or save to your account.',\r\n    'legal': 'See the Legal Notice in the footer for Privacy & Copyright information. Click the footer link to view the full policy.',\r\n  };\r\n\r\n  const navigateToTab = (tabKey: string) => {\r\n    try {\r\n      window.dispatchEvent(new CustomEvent('ndn:change-tab', { detail: { tab: tabKey } }));\r\n      setIsOpen(false); // Close the help modal after navigation\r\n    } catch (error) {\r\n      console.error('Navigation failed:', error);\r\n    }\r\n  };\r\n\r\n  const getResponseWithLinks = (userMessage: string): { text: string, links?: Array<{ text: string, tab: string }> } => {\r\n    const message = userMessage.toLowerCase();\r\n\r\n    if (message.includes('username') || message.includes('change name')) {\r\n      return {\r\n        text: 'You can change your username once for free.',\r\n        links: [{ text: 'Go to Settings > Account', tab: 'settings' }]\r\n      };\r\n    }\r\n    if (message.includes('premium') || message.includes('upgrade') || message.includes('subscription')) {\r\n      return {\r\n        text: 'Premium unlocks all game modes and features.',\r\n        links: [{ text: 'Go to Online Play', tab: 'online' }]\r\n      };\r\n    }\r\n    if (message.includes('calibrat') || message.includes('camera') || message.includes('vision')) {\r\n      return {\r\n        text: 'Set up your camera properly in Settings.',\r\n        links: [{ text: 'Go to Settings > Camera & Vision', tab: 'settings' }]\r\n      };\r\n    }\r\n    if (message.includes('voice') || message.includes('caller') || message.includes('audio')) {\r\n      return {\r\n        text: 'Enable voice calling in Settings.',\r\n        links: [{ text: 'Go to Settings > Audio & Voice', tab: 'settings' }]\r\n      };\r\n    }\r\n    if (message.includes('friend') || message.includes('play together')) {\r\n      return {\r\n        text: 'Add friends to play together.',\r\n        links: [{ text: 'Go to Friends', tab: 'friends' }]\r\n      };\r\n    }\r\n    if (message.includes('stat') || message.includes('score') || message.includes('performance')) {\r\n      return {\r\n        text: 'View your statistics and performance.',\r\n        links: [{ text: 'Go to Stats', tab: 'stats' }]\r\n      };\r\n    }\r\n    if (message.includes('setting') || message.includes('customiz') || message.includes('configur')) {\r\n      return {\r\n        text: 'Customize your experience.',\r\n        links: [{ text: 'Go to Settings', tab: 'settings' }]\r\n      };\r\n    }\r\n    if (message.includes('tournament') || message.includes('competition')) {\r\n      return {\r\n        text: 'Check out tournaments and competitions.',\r\n        links: [{ text: 'Go to Tournaments', tab: 'tournaments' }]\r\n      };\r\n    }\r\n    if (message.includes('score') || message.includes('scoring') || message.includes('autoscore')) {\r\n      return {\r\n        text: 'Auto-scoring assigns darts to board segments automatically. You can review and adjust placements in the Match Summary screen.',\r\n        links: [{ text: 'Go to Match Summary', tab: 'matchsummary' }]\r\n      }\r\n    }\r\n    if (message.includes('pair') || message.includes('pairing') || message.includes('phone') || message.includes('camera pairing')) {\r\n      return {\r\n        text: 'Use the Pairing flow to connect phones and cameras. Make sure devices are on the same WiFi and scan the QR code shown.',\r\n        links: [{ text: 'Open Pairing', tab: 'pairing' }]\r\n      }\r\n    }\r\n    if (message.includes('highlight') || message.includes('download') || message.includes('save')) {\r\n      return {\r\n        text: 'Highlights can be downloaded or saved to your account from the Highlights section. We keep a record when you hit milestone checkouts or visits.',\r\n        links: [{ text: 'Open Highlights', tab: 'highlights' }]\r\n      }\r\n    }\r\n    if (message.includes('privacy') || message.includes('copyright') || message.includes('legal')) {\r\n      return {\r\n        text: 'Our Legal Notice and Privacy information are available in the footer. You can view privacy, copyright, and contact details there.',\r\n        links: [{ text: 'View Legal Notice', tab: 'footer' }]\r\n      }\r\n    }\r\n    if (message.includes('help') || message.includes('support') || message.includes('faq')) {\r\n      return {\r\n        text: 'You\\'re already in the help section! Check Settings for more resources.',\r\n        links: [{ text: 'Go to Settings > Support', tab: 'settings' }]\r\n      };\r\n    }\r\n    if (message.includes('how to play') || message.includes('game') || message.includes('start')) {\r\n      return {\r\n        text: 'To play darts, select a game mode from the menu. For online play, join a match. For offline, start a local game.',\r\n        links: [\r\n          { text: 'Play Online', tab: 'online' },\r\n          { text: 'Play Offline', tab: 'offline' }\r\n        ]\r\n      };\r\n    }\r\n\r\n    return { text: \"I'm not sure about that. Try asking about playing, calibration, premium, username changes, voice settings, friends, stats, or settings.\" };\r\n  };\r\n\r\n  const handleSend = () => {\r\n    if (!input.trim()) return;\r\n    const userMessageRaw = input.trim()\r\n    const userMessage = userMessageRaw.toLowerCase();\r\n    setMessages(prev => [...prev, { text: userMessageRaw, isUser: true }]);\r\n    setInput('');\r\n\r\n    // If we're awaiting admin confirmation, interpret YES/NO\r\n    if (awaitingAdminConfirm) {\r\n      if (userMessage.startsWith('y')) {\r\n        // Send help request to server\r\n        setMessages(prev => [...prev, { text: 'Okay  I will notify an admin. Please wait for them to join the chat.', isUser: false }]);\r\n  setAwaitingAdminConfirm(false);\r\n        // fire-and-forget\r\n        (async () => {\r\n          try {\r\n            const payload = { message: lastUserQuestion || userMessageRaw }\r\n            const res = await apiFetch('/api/help/requests', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) })\r\n            const j = await res.json().catch(() => null)\r\n            // If server returns the request record, open the live chat\r\n            if (j && j.request) {\r\n              setMyRequest(j.request)\r\n              setMessages(prev => [...prev, { text: 'Okay  I will notify an admin. Please wait for them to join the chat.', isUser: false }])\r\n            } else {\r\n              setMessages(prev => [...prev, { text: 'Okay  I will notify an admin. Please wait for them to join the chat.', isUser: false }])\r\n            }\r\n          } catch (err) {\r\n            setMessages(prev => [...prev, { text: 'Failed to contact admins. Please try again later.', isUser: false }])\r\n          }\r\n        })()\r\n        return\r\n      } else {\r\n        setMessages(prev => [...prev, { text: \"Okay  I won't notify an admin. If you change your mind, just ask.\", isUser: false }]);\r\n  setAwaitingAdminConfirm(false);\r\n        return\r\n      }\r\n    }\r\n\r\n    // Get response with smart link suggestions\r\n    const response = getResponseWithLinks(userMessage);\r\n\r\n    // If the bot couldn't answer well, offer to escalate\r\n    if (typeof response.text === 'string' && response.text.includes(\"I'm not sure about that\")) {\r\n      setLastUserQuestion(userMessageRaw)\r\n  setAwaitingAdminConfirm(true);\r\n      setTimeout(() => {\r\n        setMessages(prev => [...prev, { text: { text: 'I can connect you to a member of our admin team  would you like that? Type YES or NO.', links: [] }, isUser: false }]);\r\n      }, 350)\r\n      return\r\n    }\r\n\r\n    setTimeout(() => {\r\n      setMessages(prev => [...prev, { text: response, isUser: false }]);\r\n    }, 500);\r\n  };\r\n\r\n  return (\r\n    <>\r\n      {/* Floating Button */}\r\n      <button\r\n        onClick={() => setIsOpen(true)}\r\n        className=\"fixed bottom-4 right-4 z-50 bg-blue-600 hover:bg-blue-700 text-white p-4 rounded-full shadow-lg transition-colors\"\r\n        title=\"Help Assistant\"\r\n      >\r\n        <HelpCircle className=\"w-6 h-6\" />\r\n      </button>\r\n\r\n      {/* Modal */}\r\n      {isOpen && (\r\n        <div className=\"fixed inset-0 z-50 flex items-end justify-end p-4\">\r\n          <div className=\"absolute inset-0 bg-black/50\" onClick={() => setIsOpen(false)} />\r\n          <div className=\"relative bg-slate-800 rounded-lg shadow-xl w-full max-w-md h-96 flex flex-col\">\r\n            {/* Header */}\r\n            <div className=\"flex items-center justify-between p-4 border-b border-slate-700\">\r\n              <div className=\"flex items-center gap-2\">\r\n                <MessageCircle className=\"w-5 h-5 text-blue-400\" />\r\n                <span className=\"font-semibold\">Help Assistant</span>\r\n              </div>\r\n              <button\r\n                onClick={() => setIsOpen(false)}\r\n                className=\"text-slate-400 hover:text-white\"\r\n              >\r\n                <X className=\"w-5 h-5\" />\r\n              </button>\r\n            </div>\r\n\r\n            {/* Messages */}\r\n            <div className=\"flex-1 overflow-y-auto p-4 space-y-3\">\r\n              {messages.map((msg, i) => (\r\n                <div key={i} className={`flex ${msg.isUser ? 'justify-end' : 'justify-start'}`}>\r\n                  <div className={`max-w-xs px-3 py-2 rounded-lg ${\r\n                    msg.isUser \r\n                      ? 'bg-blue-600 text-white' \r\n                      : 'bg-slate-700 text-slate-200'\r\n                  }`}>\r\n                    {typeof msg.text === 'string' ? (\r\n                      msg.text\r\n                    ) : (\r\n                      <div className=\"space-y-2\">\r\n                        <div>{msg.text.text}</div>\r\n                        {msg.text.links && (\r\n                          <div className=\"space-y-1\">\r\n                            {msg.text.links.map((link, linkIndex) => (\r\n                              <button\r\n                                key={linkIndex}\r\n                                onClick={() => navigateToTab(link.tab)}\r\n                                className=\"block w-full text-left text-blue-300 hover:text-blue-200 underline text-sm\"\r\n                              >\r\n                                {link.text}\r\n                              </button>\r\n                            ))}\r\n                          </div>\r\n                        )}\r\n                      </div>\r\n                    )}\r\n                  </div>\r\n                </div>\r\n              ))}\r\n            </div>\r\n\r\n            {/* Input */}\r\n            <div className=\"p-4 border-t border-slate-700\">\r\n              <div className=\"flex gap-2\">\r\n                <input\r\n                  type=\"text\"\r\n                  value={input}\r\n                  onChange={(e) => setInput(e.target.value)}\r\n                  onKeyPress={(e) => e.key === 'Enter' && handleSend()}\r\n                  placeholder=\"Ask me anything...\"\r\n                  className=\"flex-1 input\"\r\n                />\r\n                <button\r\n                  onClick={handleSend}\r\n                  className=\"btn bg-blue-600 hover:bg-blue-700\"\r\n                >\r\n                  <Send className=\"w-4 h-4\" />\r\n                </button>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      )}\r\n\r\n        {/* Render live chat modal if a help request exists for this user */}\r\n        {myRequest && (\r\n          <HelpdeskChat request={myRequest} user={{ email: null, username: null, isAdmin: false }} onClose={() => setMyRequest(null)} />\r\n        )}\r\n    </>\r\n  );\r\n}","import { useEffect, useRef } from 'react'\r\nimport { useCameraSession } from '../store/cameraSession'\r\n\r\n// GlobalCameraLogger: attaches to the camera session and emits detailed logs\r\n// about video element, media stream, and peer connection state so logs are\r\n// visible even when navigating away from Calibrator.\r\nexport default function GlobalCameraLogger() {\r\n  const camera = useCameraSession()\r\n  const lastStateRef = useRef<any>({})\r\n  const listenersRef = useRef<any>({})\r\n\r\n  useEffect(() => {\r\n    function dumpState(prefix = '[GlobalCamera]') {\r\n      try {\r\n        const video = camera.getVideoElementRef()\r\n        const media = camera.getMediaStream()\r\n        const pc = camera.getPcRef && camera.getPcRef()\r\n        const ws = camera.getWsRef && camera.getWsRef()\r\n        console.log(prefix, {\r\n          isStreaming: camera.isStreaming,\r\n          mode: camera.mode,\r\n          showOverlay: camera.showOverlay,\r\n          hasVideoElement: !!video,\r\n          video: video ? { videoWidth: video.videoWidth, videoHeight: video.videoHeight, srcObject: !!video.srcObject } : null,\r\n          mediaTracks: media ? media.getTracks().map(t => ({ kind: t.kind, enabled: t.enabled, id: t.id })) : null,\r\n          pcState: pc ? pc.connectionState || pc.iceConnectionState : null,\r\n          wsState: ws ? (ws.readyState || 'unknown') : null\r\n        })\r\n      } catch (e) { console.warn('[GlobalCamera] dumpState failed', e) }\r\n    }\r\n\r\n    // Initial dump\r\n    dumpState('[GlobalCamera] INIT')\r\n\r\n    // Subscribe to Zustand changes by polling minimal differences (safe & simple)\r\n    let mounted = true\r\n    const interval = setInterval(() => {\r\n      if (!mounted) return\r\n      try {\r\n        const video = camera.getVideoElementRef()\r\n        const media = camera.getMediaStream()\r\n        const pc = camera.getPcRef && camera.getPcRef()\r\n        const snapshot = {\r\n          isStreaming: camera.isStreaming,\r\n          mode: camera.mode,\r\n          hasVideo: !!video,\r\n          videoW: video ? video.videoWidth : 0,\r\n          videoH: video ? video.videoHeight : 0,\r\n          tracks: media ? media.getTracks().length : 0,\r\n          pcState: pc ? pc.connectionState || pc.iceConnectionState : null\r\n        }\r\n        const prev = lastStateRef.current\r\n        // Shallow compare a few keys\r\n        if (\r\n          snapshot.isStreaming !== prev.isStreaming ||\r\n          snapshot.hasVideo !== prev.hasVideo ||\r\n          snapshot.videoW !== prev.videoW ||\r\n          snapshot.videoH !== prev.videoH ||\r\n          snapshot.tracks !== prev.tracks ||\r\n          snapshot.pcState !== prev.pcState ||\r\n          camera.showOverlay !== prev.showOverlay\r\n        ) {\r\n          lastStateRef.current = snapshot\r\n          dumpState('[GlobalCamera] CHANGE')\r\n        }\r\n      } catch (e) { console.warn('[GlobalCamera] poll failed', e) }\r\n    }, 750)\r\n\r\n    // Attach video element listeners when available to capture events like loadedmetadata/playing\r\n    function attachVideoListeners(v: HTMLVideoElement | null) {\r\n      try {\r\n        const prev = listenersRef.current.video\r\n        if (prev && prev.el === v) return\r\n        if (prev && prev.el) {\r\n          try { prev.el.removeEventListener('loadedmetadata', prev.loadedmetadata) } catch {}\r\n          try { prev.el.removeEventListener('playing', prev.playing) } catch {}\r\n          try { prev.el.removeEventListener('pause', prev.pause) } catch {}\r\n          try { prev.el.removeEventListener('ended', prev.ended) } catch {}\r\n        }\r\n        listenersRef.current.video = null\r\n        if (v) {\r\n          const loadedmetadata = () => console.log('[GlobalCamera] video loadedmetadata', { videoWidth: v.videoWidth, videoHeight: v.videoHeight })\r\n          const playing = () => {\r\n            console.log('[GlobalCamera] video playing', { paused: v.paused })\r\n            try { camera.setStreaming(true) } catch {}\r\n          }\r\n          const pause = () => {\r\n            console.log('[GlobalCamera] video pause')\r\n            try { camera.setStreaming(false) } catch {}\r\n          }\r\n          const ended = () => {\r\n            console.log('[GlobalCamera] video ended')\r\n            try { camera.setStreaming(false) } catch {}\r\n          }\r\n          v.addEventListener('loadedmetadata', loadedmetadata)\r\n          v.addEventListener('playing', playing)\r\n          v.addEventListener('pause', pause)\r\n          v.addEventListener('ended', ended)\r\n          listenersRef.current.video = { el: v, loadedmetadata, playing, pause, ended }\r\n        }\r\n      } catch (e) { console.warn('[GlobalCamera] attachVideoListeners failed', e) }\r\n    }\r\n\r\n    // Watch for PC state changes if RTCPeerConnection is present\r\n    function attachPc(pc: RTCPeerConnection | null) {\r\n      try {\r\n        const prev = listenersRef.current.pc\r\n        if (prev && prev.pc === pc) return\r\n        if (prev && prev.pc) {\r\n          try { prev.pc.removeEventListener('connectionstatechange', prev.connChange) } catch {}\r\n        }\r\n        listenersRef.current.pc = null\r\n        if (pc) {\r\n          const connChange = () => console.log('[GlobalCamera] pc state change', { connectionState: pc.connectionState, iceState: (pc as any).iceConnectionState })\r\n          pc.addEventListener('connectionstatechange', connChange)\r\n          listenersRef.current.pc = { pc, connChange }\r\n        }\r\n      } catch (e) { console.warn('[GlobalCamera] attachPc failed', e) }\r\n    }\r\n\r\n    // Periodically re-attach listeners if refs change\r\n    const attachInterval = setInterval(() => {\r\n      try {\r\n        attachVideoListeners(camera.getVideoElementRef())\r\n        attachPc(camera.getPcRef && camera.getPcRef())\r\n      } catch (e) {}\r\n    }, 1000)\r\n\r\n    return () => {\r\n      mounted = false\r\n      clearInterval(interval)\r\n      clearInterval(attachInterval)\r\n      // cleanup listeners\r\n      try {\r\n        const v = listenersRef.current.video\r\n        if (v && v.el) {\r\n          v.el.removeEventListener('loadedmetadata', v.loadedmetadata)\r\n          v.el.removeEventListener('playing', v.playing)\r\n        }\r\n      } catch (e) {}\r\n      try {\r\n        const p = listenersRef.current.pc\r\n        if (p && p.pc) p.pc.removeEventListener('connectionstatechange', p.connChange)\r\n      } catch (e) {}\r\n    }\r\n  }, [camera])\r\n\r\n  return null\r\n}\r\n","import { useEffect, useRef } from 'react'\r\nimport { useCameraSession } from '../store/cameraSession'\r\n\r\n/**\r\n * GlobalPhoneVideoSink\r\n * Keeps a hidden video element alive across navigation and feeds it the phone camera stream\r\n * so other components (overlay, badge) can draw frames even when Calibrator unmounts.\r\n */\r\nexport default function GlobalPhoneVideoSink() {\r\n  const camera = useCameraSession()\r\n  const vref = useRef<HTMLVideoElement | null>(null)\r\n  const lastStreamRef = useRef<MediaStream | null>(null)\r\n  const lastTimeRef = useRef<number>(0)\r\n  const stallSecondsRef = useRef<number>(0)\r\n  const lastReconnectAtRef = useRef<number>(0)\r\n  const attemptRef = useRef<number>(0)\r\n\r\n  // Ensure the global ref is registered for others to use\r\n  useEffect(() => {\r\n    if (vref.current) {\r\n      camera.setVideoElementRef(vref.current)\r\n    }\r\n  }, [camera])\r\n\r\n  // Apply the current stream and keep it playing\r\n  useEffect(() => {\r\n    let mounted = true\r\n\r\n    const apply = async () => {\r\n      if (!mounted) return\r\n      try {\r\n        const s = camera.getMediaStream()\r\n        const vid = vref.current\r\n        if (!vid || !s) return\r\n        if (lastStreamRef.current !== s || vid.srcObject !== s) {\r\n          vid.srcObject = s\r\n          lastStreamRef.current = s\r\n        }\r\n        vid.muted = true\r\n        ;(vid as any).playsInline = true\r\n        try { await vid.play() } catch {}\r\n      } catch {}\r\n    }\r\n\r\n    // Try immediately and then poll a bit to catch late streams\r\n    apply()\r\n    const t = setInterval(apply, 750)\r\n    return () => { mounted = false; clearInterval(t) }\r\n  }, [camera])\r\n\r\n  // Watchdog: if the video currentTime doesn't advance for >3s while streaming, request a reconnect with backoff\r\n  useEffect(() => {\r\n    const tick = () => {\r\n      const v = vref.current\r\n      const now = Date.now()\r\n      if (!v || !camera.isStreaming || camera.mode !== 'phone') {\r\n        stallSecondsRef.current = 0\r\n        return\r\n      }\r\n      if (!v.srcObject) {\r\n        const minBackoff = [3000, 6000, 10000][Math.min(attemptRef.current, 2)]\r\n        if (now - lastReconnectAtRef.current >= minBackoff) {\r\n          lastReconnectAtRef.current = now\r\n          attemptRef.current = Math.min(attemptRef.current + 1, 3)\r\n          try {\r\n            window.dispatchEvent(new CustomEvent('ndn:phone-camera-reconnect', { detail: { reason: 'missing-stream', ts: now } }))\r\n            v.play().catch(() => {})\r\n          } catch {}\r\n        }\r\n        return\r\n      }\r\n      const ct = (v as HTMLVideoElement).currentTime || 0\r\n      if (!Number.isFinite(ct)) return\r\n      if (ct === lastTimeRef.current) {\r\n        stallSecondsRef.current += 1\r\n      } else {\r\n        stallSecondsRef.current = 0\r\n      }\r\n      lastTimeRef.current = ct\r\n      if (stallSecondsRef.current >= 3) {\r\n        const minBackoff = [3000, 6000, 10000][Math.min(attemptRef.current, 2)]\r\n        if (now - lastReconnectAtRef.current >= minBackoff) {\r\n          lastReconnectAtRef.current = now\r\n          attemptRef.current = Math.min(attemptRef.current + 1, 3)\r\n          try {\r\n            window.dispatchEvent(new CustomEvent('ndn:phone-camera-reconnect', { detail: { reason: 'stall', ts: now } }))\r\n            // Try to nudge playback locally as well\r\n            v.play().catch(()=>{})\r\n          } catch {}\r\n        }\r\n      } else if (stallSecondsRef.current === 0) {\r\n        // Reset attempts on healthy playback\r\n        attemptRef.current = 0\r\n      }\r\n    }\r\n    const id = setInterval(tick, 1000)\r\n    return () => clearInterval(id)\r\n  }, [camera])\r\n\r\n  // Keep dimensions tiny but visible so playback isn't throttled by display:none in some browsers\r\n  return (\r\n    <video\r\n      ref={vref}\r\n      style={{ position: 'fixed', width: 1, height: 1, left: -9999, top: -9999, opacity: 0 }}\r\n      muted\r\n      playsInline\r\n      aria-hidden\r\n    />\r\n  )\r\n}\r\n","import React, { useEffect, useRef, useState, type ReactNode, type CSSProperties } from 'react'\r\n\r\ntype Props = {\r\n  storageKey: string\r\n  children: ReactNode\r\n  className?: string\r\n  defaultWidth?: number\r\n  defaultHeight?: number\r\n  minWidth?: number\r\n  minHeight?: number\r\n  maxWidth?: number\r\n  maxHeight?: number\r\n  fullScreen?: boolean\r\n  initialFitHeight?: boolean\r\n  onClose?: () => void\r\n}\r\n\r\ntype Size = { width?: number; height?: number }\r\n\r\nexport default function ResizableModal({\r\n  storageKey,\r\n  children,\r\n  className,\r\n  defaultWidth = 520,\r\n  defaultHeight,\r\n  minWidth = 360,\r\n  minHeight = 200,\r\n  maxWidth = 1100,\r\n  maxHeight = 900,\r\n  fullScreen = false,\r\n  initialFitHeight = false,\r\n  onClose,\r\n}: Props) {\r\n  const [size, setSize] = useState<Size>(() => {\r\n    if (!fullScreen) {\r\n      try {\r\n        const raw = localStorage.getItem(storageKey)\r\n        if (raw) return JSON.parse(raw)\r\n      } catch {}\r\n      return { width: defaultWidth, height: defaultHeight }\r\n    }\r\n    return {}\r\n  })\r\n  const startRef = useRef<{ x: number; y: number; w: number; h: number; dir: string } | null>(null)\r\n\r\n  useEffect(() => {\r\n    if (fullScreen) return\r\n    function onReset() {\r\n      try { localStorage.removeItem(storageKey) } catch {}\r\n      // If initialFitHeight is enabled, prefer fitting to parent height on reset\r\n      if (initialFitHeight && containerRef.current?.parentElement) {\r\n        const parent = containerRef.current.parentElement as HTMLElement\r\n        const cs = window.getComputedStyle(parent)\r\n        const padTop = parseFloat(cs.paddingTop || '0') || 0\r\n        const padBottom = parseFloat(cs.paddingBottom || '0') || 0\r\n        const inner = Math.max(0, parent.clientHeight - padTop - padBottom)\r\n        const target = Math.max(minHeight, Math.min(maxHeight, Math.round(inner)))\r\n        setSize({ width: defaultWidth, height: target })\r\n        return\r\n      }\r\n      setSize({ width: defaultWidth, height: defaultHeight })\r\n    }\r\n    window.addEventListener('ndn:layout-reset' as any, onReset)\r\n    return () => window.removeEventListener('ndn:layout-reset' as any, onReset)\r\n  }, [storageKey, defaultWidth, defaultHeight, fullScreen])\r\n\r\n  useEffect(() => {\r\n    if (fullScreen) return\r\n    try { localStorage.setItem(storageKey, JSON.stringify(size)) } catch {}\r\n  }, [size, storageKey, fullScreen])\r\n\r\n  // Optionally fit initial height to the available parent container when no saved size exists\r\n  useEffect(() => {\r\n    if (fullScreen || !initialFitHeight) return\r\n    const parent = containerRef.current?.parentElement as HTMLElement | null\r\n    if (!parent) return\r\n    const cs = window.getComputedStyle(parent)\r\n    const padTop = parseFloat(cs.paddingTop || '0') || 0\r\n    const padBottom = parseFloat(cs.paddingBottom || '0') || 0\r\n    const inner = Math.max(0, parent.clientHeight - padTop - padBottom)\r\n    const target = Math.max(minHeight, Math.min(maxHeight, Math.round(inner)))\r\n    try {\r\n      const saved = localStorage.getItem(storageKey)\r\n      if (saved) {\r\n        const savedSize = JSON.parse(saved) as Size\r\n        const h = savedSize?.height || 0\r\n        // If saved height is smaller than available, bump it to fill the frame bottom\r\n        if (!h || h < target) {\r\n          setSize(s => ({ ...s, height: target }))\r\n        }\r\n        return\r\n      }\r\n    } catch {}\r\n    setSize(s => ({ ...s, height: target }))\r\n  }, [initialFitHeight, fullScreen, storageKey, minHeight, maxHeight])\r\n\r\n  function clamp(n: number, min: number, max: number) {\r\n    return Math.max(min, Math.min(max, n))\r\n  }\r\n\r\n  function beginResize(e: React.MouseEvent, dir: string) {\r\n    e.preventDefault()\r\n    const el = containerRef.current\r\n    if (!el) return\r\n    const rect = el.getBoundingClientRect()\r\n    startRef.current = { x: e.clientX, y: e.clientY, w: rect.width, h: rect.height, dir }\r\n    window.addEventListener('mousemove', onMove)\r\n    window.addEventListener('mouseup', endResize)\r\n  }\r\n\r\n  function onMove(e: MouseEvent) {\r\n    const s = startRef.current\r\n    if (!s) return\r\n    const dx = e.clientX - s.x\r\n    const dy = e.clientY - s.y\r\n    const dir = s.dir\r\n    let w = s.w\r\n    let h = s.h\r\n    // Respect parent's inner height so the modal bottom can align with the frame bottom\r\n    let parentInner = Infinity\r\n    const parent = containerRef.current?.parentElement as HTMLElement | null\r\n    if (parent) {\r\n      const cs = window.getComputedStyle(parent)\r\n      const padTop = parseFloat(cs.paddingTop || '0') || 0\r\n      const padBottom = parseFloat(cs.paddingBottom || '0') || 0\r\n      parentInner = Math.max(0, parent.clientHeight - padTop - padBottom)\r\n    }\r\n    const effMaxH = Math.min(maxHeight, isFinite(parentInner) ? parentInner : maxHeight)\r\n    // We only adjust width/height; the modal stays centered via parent flex\r\n    if (dir.includes('e')) w = clamp(s.w + dx, minWidth, maxWidth)\r\n    if (dir.includes('s')) h = clamp(s.h + dy, minHeight, effMaxH)\r\n    if (dir.includes('w')) w = clamp(s.w - dx, minWidth, maxWidth)\r\n    if (dir.includes('n')) h = clamp(s.h - dy, minHeight, effMaxH)\r\n    setSize({ width: Math.round(w), height: Math.round(h) })\r\n  }\r\n\r\n  function endResize() {\r\n    window.removeEventListener('mousemove', onMove)\r\n    window.removeEventListener('mouseup', endResize)\r\n    startRef.current = null\r\n  }\r\n\r\n  const containerRef = useRef<HTMLDivElement | null>(null)\r\n  const style: CSSProperties = fullScreen\r\n    ? { width: '100%', height: '100%', maxWidth: '100%', maxHeight: '100%' }\r\n    : {\r\n        width: size.width ? `${size.width}px` : undefined,\r\n        height: size.height ? `${size.height}px` : undefined,\r\n        maxWidth: `${maxWidth}px`,\r\n        // Allow filling up to the parent's inner height\r\n        maxHeight: '100%',\r\n      }\r\n\r\n  const baseClass = fullScreen ? 'card relative ndn-modal-full' : 'card relative'\r\n  return (\r\n    <div ref={containerRef} className={`${baseClass} ${className || ''}`} style={style}>\r\n      {/* Content */}\r\n      {children}\r\n      {/* Corner handles */}\r\n      {!fullScreen && <div className=\"resizer resizer-nw\" onMouseDown={(e)=>beginResize(e,'nw')} />}\r\n      {!fullScreen && <div className=\"resizer resizer-ne\" onMouseDown={(e)=>beginResize(e,'ne')} />}\r\n      {!fullScreen && <div className=\"resizer resizer-sw\" onMouseDown={(e)=>beginResize(e,'sw')} />}\r\n      {!fullScreen && <div className=\"resizer resizer-se\" onMouseDown={(e)=>beginResize(e,'se')} />}\r\n      {/* Bottom edge handle for easy vertical stretching */}\r\n      {!fullScreen && <div className=\"resizer-edge resizer-s\" onMouseDown={(e)=>beginResize(e,'s')} />}\r\n    </div>\r\n  )\r\n}\r\n","import React, { useState } from 'react'\r\nimport ResizableModal from './ui/ResizableModal'\r\n\r\nexport default function Footer() {\r\n  const [show, setShow] = useState(false)\r\n  const year = new Date().getFullYear()\r\n  return (\r\n    <>\r\n      <div className=\"w-full text-center text-xs text-gray-500 py-2 select-none\"> {year} Nine Dart Nation  <button className=\"underline\" onClick={() => setShow(true)}>Legal Notice</button></div>\r\n      {show ? (\r\n        <ResizableModal storageKey=\"ndn:modal:legal\" className=\"w-[640px]\" defaultWidth={640} defaultHeight={420} minWidth={420} minHeight={220} initialFitHeight>\r\n          <div className=\"p-4 space-y-3\">\r\n            <div className=\"text-lg font-semibold\">Privacy & Copyright Notice</div>\r\n            <div className=\"text-sm\"> IMPORTANT LEGAL NOTICE</div>\r\n            <div className=\"text-sm\">Copyright Protection: All code, assets, and intellectual property in Nine Dart Nation are protected by copyright law. Unauthorized copying, modification, or distribution of this software is strictly prohibited.</div>\r\n            <div className=\"text-sm\">Legal Consequences: Any attempt to edit, reverse-engineer, or redistribute this code will result in immediate legal action, including but not limited to copyright infringement lawsuits and potential criminal charges.</div>\r\n            <div className=\"text-sm\">Privacy: Your personal data and gameplay information are protected. Any unauthorized access or data collection violates privacy laws and will be prosecuted to the full extent of the law.</div>\r\n            <div className=\"flex items-center gap-2 mt-3\">\r\n              <button className=\"btn\" onClick={() => setShow(false)}>Close</button>\r\n            </div>\r\n          </div>\r\n        </ResizableModal>\r\n      ) : null}\r\n    </>\r\n  )\r\n}\r\n","import React, { useEffect, useRef, useState, Suspense } from 'react'\r\nimport { Sidebar, TabKey } from './components/Sidebar'\r\nconst Home = React.lazy(() => import('./components/Home'))\r\nimport ScrollFade from './components/ScrollFade'\r\nimport Calibrator from './components/Calibrator'\r\nconst OfflinePlay = React.lazy(() => import('./components/OfflinePlay'))\r\nconst Friends = React.lazy(() => import('./components/Friends'))\r\nimport Toaster from './components/Toaster'\r\nimport AdminDashboard from './components/AdminDashboard'\r\nimport SettingsPanel from './components/SettingsPanel'\r\nimport Auth from './components/Auth'\r\nimport { ThemeProvider } from './components/ThemeContext'\r\nimport { useWS } from './components/WSProvider'\r\nimport StatusDot from './components/ui/StatusDot'\r\nimport { getRollingAvg, getAllTimeAvg } from './store/profileStats'\r\nimport { useUserSettings } from './store/userSettings'\r\nimport { useCalibration } from './store/calibration'\r\nimport './styles/premium.css'\r\nconst Scoreboard = React.lazy(() => import('./components/Scoreboard'))\r\nconst CameraView = React.lazy(() => import('./components/CameraView'))\r\nconst OnlinePlay = React.lazy(() => import('./components/OnlinePlay'))\r\nimport MatchSettings from './components/MatchSettings'\r\nconst StatsPanel = React.lazy(() => import('./components/StatsPanel'))\r\nconst Tournaments = React.lazy(() => import('./components/Tournaments'))\r\nconst AdminAccess = React.lazy(() => import('./components/AdminAccess'))\r\n// AdminAccess already imported above\r\nimport Drawer from './components/ui/Drawer'\r\nimport { getDominantColorFromImage, stringToColor } from './utils/color'\r\nconst OpsDashboard = React.lazy(() => import('./components/OpsDashboard'))\r\nimport HelpAssistant from './components/HelpAssistant'\r\nimport GlobalCameraLogger from './components/GlobalCameraLogger'\r\nimport GlobalPhoneVideoSink from './components/GlobalPhoneVideoSink'\r\nimport CameraStatusBadge from './components/CameraStatusBadge'\r\nimport Footer from './components/Footer'\r\n\r\nexport default function App() {\r\n  const appRef = useRef<HTMLDivElement | null>(null);\r\n  const [avatar, setAvatar] = useState<string>('');\r\n  const [isFullscreen, setIsFullscreen] = useState(false);\r\n  const [httpsInfo, setHttpsInfo] = useState<{ https: boolean; port: number } | null>(null);\r\n  const ws = (() => { try { return useWS() } catch { return null } })()\r\n  const [tab, setTab] = useState<TabKey>('score')\r\n  const [isMobile, setIsMobile] = useState<boolean>(false)\r\n  const [navOpen, setNavOpen] = useState<boolean>(false)\r\n  const [user, setUser] = useState<any>(null)\r\n  const MINIMAL_UI = ((import.meta as any).env?.VITE_MINIMAL_AFTER_LOGIN || '').toString() === '1'\r\n  const [minimalUI, setMinimalUI] = useState<boolean>(false)\r\n  const [allTimeAvg, setAllTimeAvg] = useState<number>(0)\r\n  const { avgMode } = useUserSettings()\r\n  const { H: calibH, locked: calibLocked, errorPx } = useCalibration()\r\n\r\n\r\n  // Restore user from token on mount\r\n  useEffect(() => {\r\n    if (user && MINIMAL_UI) {\r\n      setMinimalUI(true)\r\n      const timer = setTimeout(() => setMinimalUI(false), 1500) // Delay heavy component mount\r\n      return () => clearTimeout(timer)\r\n    }\r\n    const token = localStorage.getItem('authToken');\r\n    if (token) {\r\n      // Validate token with server\r\n      const API_URL = (import.meta as any).env?.VITE_API_URL || '';\r\n      fetch(`${API_URL}/api/auth/me`, {\r\n        headers: { 'Authorization': `Bearer ${token}` }\r\n      })\r\n      .then(res => res.json())\r\n      .then(data => {\r\n        if (data?.user) {\r\n          setUser(data.user);\r\n          fetchSubscription(data.user);\r\n        } else {\r\n          // Token invalid, remove it\r\n          localStorage.removeItem('authToken');\r\n        }\r\n      })\r\n      .catch(() => {\r\n        // Network error, keep token for offline retry\r\n      });\r\n    }\r\n  }, []);\r\n\r\n  useEffect(() => {\r\n    const onLogout = () => {\r\n      try {\r\n        localStorage.removeItem('mockUser');\r\n        localStorage.removeItem('authToken');\r\n      } catch {}\r\n      setUser(null);\r\n      setTab('score');\r\n    };\r\n    window.addEventListener('ndn:logout' as any, onLogout as any);\r\n    return () => window.removeEventListener('ndn:logout' as any, onLogout as any);\r\n  }, []);\r\n  // Refresh all-time avg when user changes or stats update\r\n  useEffect(() => {\r\n    if (!user?.username) return\r\n    const refresh = () => setAllTimeAvg(avgMode === '24h' ? getRollingAvg(user.username) : getAllTimeAvg(user.username))\r\n    refresh()\r\n    const onUpdate = () => refresh()\r\n    window.addEventListener('ndn:stats-updated', onUpdate as any)\r\n    return () => window.removeEventListener('ndn:stats-updated', onUpdate as any)\r\n  }, [user?.username, avgMode])\r\n\r\n  // Load avatar from localStorage when user changes\r\n  useEffect(() => {\r\n    if (!user?.username) {\r\n      setAvatar('');\r\n      return;\r\n    }\r\n    const storedAvatar = localStorage.getItem(`ndn:bio:profilePhoto:${user.username}`);\r\n    setAvatar(storedAvatar || '');\r\n  }, [user?.username])\r\n\r\n  // Listen for avatar updates from SettingsPanel\r\n  useEffect(() => {\r\n    const handleStorageChange = (e: StorageEvent) => {\r\n      if (e.key?.startsWith('ndn:bio:profilePhoto:') && user?.username && e.key.endsWith(user.username)) {\r\n        setAvatar(e.newValue || '');\r\n      }\r\n    };\r\n    const handleAvatarUpdate = (e: any) => {\r\n      // Check if this update is for the current user\r\n      if (e.detail?.username === user?.username) {\r\n        setAvatar(e.detail?.avatar || '');\r\n      }\r\n      // Also check localStorage as backup for any avatar update\r\n      if (user?.username) {\r\n        const storedAvatar = localStorage.getItem(`ndn:bio:profilePhoto:${user.username}`);\r\n        setAvatar(storedAvatar || '');\r\n      }\r\n    };\r\n    // Also check localStorage when window becomes visible (user switches tabs)\r\n    const handleVisibilityChange = () => {\r\n      if (!document.hidden && user?.username) {\r\n        const storedAvatar = localStorage.getItem(`ndn:bio:profilePhoto:${user.username}`);\r\n        setAvatar(storedAvatar || '');\r\n      }\r\n    };\r\n    \r\n    // Check localStorage every 2 seconds as a fallback\r\n    const checkAvatarInterval = setInterval(() => {\r\n      if (user?.username) {\r\n        const storedAvatar = localStorage.getItem(`ndn:bio:profilePhoto:${user.username}`);\r\n        if (storedAvatar && storedAvatar !== avatar) {\r\n          setAvatar(storedAvatar);\r\n        }\r\n      }\r\n    }, 2000);\r\n    \r\n    window.addEventListener('storage', handleStorageChange);\r\n    window.addEventListener('ndn:avatar-updated' as any, handleAvatarUpdate as any);\r\n    document.addEventListener('visibilitychange', handleVisibilityChange);\r\n    return () => {\r\n      window.removeEventListener('storage', handleStorageChange);\r\n      window.removeEventListener('ndn:avatar-updated' as any, handleAvatarUpdate as any);\r\n      document.removeEventListener('visibilitychange', handleVisibilityChange);\r\n      clearInterval(checkAvatarInterval);\r\n    };\r\n  }, [user?.username, avatar]);\r\n\r\n  // Handle payment success for username change\r\n  useEffect(() => {\r\n    const urlParams = new URLSearchParams(window.location.search);\r\n    const paid = urlParams.get('paid');\r\n    const usernameChange = urlParams.get('username-change');\r\n    if (paid === '1' || paid === 'username-change' || usernameChange === 'free') {\r\n      const pendingUsername = localStorage.getItem('pendingUsernameChange');\r\n      if (pendingUsername && user?.email) {\r\n        // Call the change username API\r\n        const API_URL = (import.meta as any).env?.VITE_API_URL || '';\r\n        fetch(`${API_URL}/api/change-username`, {\r\n          method: 'POST',\r\n          headers: { 'Content-Type': 'application/json' },\r\n          body: JSON.stringify({ email: user.email, newUsername: pendingUsername })\r\n        })\r\n        .then(res => res.json())\r\n        .then(data => {\r\n          if (data.ok) {\r\n            alert('Username changed successfully!');\r\n            localStorage.removeItem('pendingUsernameChange');\r\n            // Update user data and token\r\n            if (data.token) {\r\n              localStorage.setItem('authToken', data.token);\r\n            }\r\n            if (data.user) {\r\n              setUser(data.user);\r\n            }\r\n            // Clean up URL\r\n            window.history.replaceState({}, document.title, window.location.pathname);\r\n          } else {\r\n            alert('Failed to change username: ' + (data.error || 'Unknown error'));\r\n          }\r\n        })\r\n        .catch(() => {\r\n          alert('Network error while changing username');\r\n        });\r\n      }\r\n    }\r\n  }, [user?.email]);\r\n\r\n  // Handle payment success for premium subscription\r\n  useEffect(() => {\r\n    const urlParams = new URLSearchParams(window.location.search);\r\n    const subscription = urlParams.get('subscription');\r\n    if (subscription === 'success' && user?.email) {\r\n      // Refresh user data to get updated subscription status\r\n      const API_URL = (import.meta as any).env?.VITE_API_URL || '';\r\n      fetch(`${API_URL}/api/auth/me`, {\r\n        headers: { 'Authorization': `Bearer ${localStorage.getItem('authToken')}` }\r\n      })\r\n      .then(res => res.json())\r\n      .then(data => {\r\n        if (data?.user) {\r\n          setUser(data.user);\r\n          alert('Premium subscription activated successfully!');\r\n          // Clean up URL\r\n          window.history.replaceState({}, document.title, window.location.pathname);\r\n        }\r\n      })\r\n      .catch(() => {\r\n        alert('Subscription activated, but failed to refresh user data. Please refresh the page.');\r\n      });\r\n    }\r\n  }, [user?.email]);\r\n\r\n  // Detect mobile/tablet layout via comprehensive device detection\r\n  useEffect(() => {\r\n    const update = () => {\r\n      const width = window.innerWidth\r\n      const height = window.innerHeight\r\n      const pixelRatio = window.devicePixelRatio || 1\r\n\r\n      // Comprehensive mobile/tablet detection\r\n      const mqMobile = window.matchMedia('(max-width: 768px)').matches\r\n      const mqTablet = window.matchMedia('(max-width: 1024px) and (min-width: 769px)').matches\r\n      const uaMobile = /Mobi|Android|iPhone|iPad|iPod|Mobile|BlackBerry|IEMobile|Opera Mini|Windows Phone/i.test(navigator.userAgent || '')\r\n      const uaTablet = /iPad|Android(?=.*\\bMobile\\b)|Tablet|PlayBook|Silk/i.test(navigator.userAgent || '')\r\n      const touchScreen = 'ontouchstart' in window || navigator.maxTouchPoints > 0\r\n      const smallScreen = width < 1025\r\n      const verySmallScreen = width < 769\r\n\r\n      // Determine device type\r\n      const isTablet = (mqTablet && touchScreen) || uaTablet || (width >= 769 && width <= 1024 && touchScreen)\r\n      const isMobile = mqMobile || uaMobile || verySmallScreen || (width < 769 && touchScreen)\r\n      const isMobileDevice = isMobile || isTablet\r\n\r\n      setIsMobile(isMobileDevice)\r\n    }\r\n    update()\r\n    window.addEventListener('resize', update)\r\n    window.addEventListener('orientationchange', update)\r\n\r\n    const mqMobile = window.matchMedia('(max-width: 768px)')\r\n    const mqTablet = window.matchMedia('(max-width: 1024px) and (min-width: 769px)')\r\n\r\n    try {\r\n      mqMobile.addEventListener('change', update)\r\n      mqTablet.addEventListener('change', update)\r\n    } catch {}\r\n\r\n    return () => {\r\n      window.removeEventListener('resize', update)\r\n      window.removeEventListener('orientationchange', update)\r\n      try {\r\n        mqMobile.removeEventListener('change', update)\r\n        mqTablet.removeEventListener('change', update)\r\n      } catch {}\r\n    }\r\n  }, [])\r\n\r\n  // Global logout handler: return to sign-in screen and clear minimal local user context\r\n  useEffect(() => {\r\n    const onLogout = () => {\r\n      try {\r\n        // Clear any lightweight local flags (keep stats unless explicitly reset)\r\n        localStorage.removeItem('ndn:avatar')\r\n      } catch {}\r\n      setUser(null)\r\n      setTab('score')\r\n    }\r\n    window.addEventListener('ndn:logout' as any, onLogout as any)\r\n    return () => window.removeEventListener('ndn:logout' as any, onLogout as any)\r\n  }, [])\r\n\r\n  // Apply username changes from Settings globally and propagate via WS presence\r\n  useEffect(() => {\r\n    const onName = (e: any) => {\r\n      try {\r\n        const next = String(e?.detail?.username || '').trim()\r\n        if (!next) return\r\n        setUser((prev: any) => {\r\n          const u = prev ? { ...prev, username: next } : prev\r\n          return u\r\n        })\r\n        // Recompute name color on next effect pass based on new username/avatar\r\n        // Send presence update so friends/lobby reflect the new name\r\n        try {\r\n          const email = (user?.email || '').toLowerCase()\r\n          if (ws && next && email) ws.send({ type: 'presence', username: next, email })\r\n        } catch {}\r\n      } catch {}\r\n    }\r\n    window.addEventListener('ndn:username-changed' as any, onName as any)\r\n    return () => window.removeEventListener('ndn:username-changed' as any, onName as any)\r\n  }, [ws, user?.email])\r\n\r\n  // Handle tab changes from Home component quick access pills\r\n  useEffect(() => {\r\n    const onTabChange = (e: any) => {\r\n      try {\r\n        const tab = String(e?.detail?.tab || '').trim()\r\n        if (tab && ['score', 'offline', 'online', 'stats', 'settings', 'admin', 'tournaments', 'friends'].includes(tab)) {\r\n          setTab(tab as TabKey)\r\n        }\r\n      } catch {}\r\n    }\r\n    window.addEventListener('ndn:change-tab' as any, onTabChange as any)\r\n    return () => window.removeEventListener('ndn:change-tab' as any, onTabChange as any)\r\n  }, [])\r\n\r\n  async function fetchSubscription(u: any) {\r\n    try {\r\n      const q = u?.email ? `?email=${encodeURIComponent(u.email)}` : ''\r\n      const res = await fetch('/api/subscription' + q);\r\n      if (!res.ok) return;\r\n      const data = await res.json();\r\n      setUser({ ...u, fullAccess: !!data?.fullAccess });\r\n    } catch {}\r\n  }\r\n\r\n  if (!user) {\r\n    return <Auth onAuth={(u:any) => { setUser(u); fetchSubscription(u); }} />;\r\n  }\r\n  const fallbackAvatar = `https://ui-avatars.com/api/?name=${encodeURIComponent(user.username||'NDN')}&background=8F43EE&color=fff&bold=true&rounded=true&size=64`\r\n  return (\r\n    <ThemeProvider>\r\n  <div ref={appRef} className={`${user?.fullAccess ? 'premium-body' : ''} h-screen overflow-hidden pt-1 pb-0 px-1 xs:pt-2 xs:pb-0 xs:px-2 sm:pt-3 sm:pb-0 sm:px-3 md:pt-4 md:pb-0 md:px-4`}>\r\n        <Toaster />\r\n  <div className=\"max-w-[1400px] mx-auto grid grid-cols-1 lg:grid-cols-[auto,1fr] gap-2 xs:gap-3 sm:gap-4 h-full overflow-hidden\">\r\n          {/* Desktop sidebar; hidden on mobile/tablet */}\r\n          {!isMobile && (\r\n            <div className=\"relative hidden lg:block\" style={{ width: 240 }}>\r\n              <Sidebar active={tab} onChange={(k)=>{ setTab(k); }} user={user} />\r\n            </div>\r\n          )}\r\n          {/* Wrap header + scroller in a column so header stays static and only content scrolls below it */}\r\n          <div className=\"flex flex-col h-full overflow-hidden\">\r\n            <div className=\"pt-1 xs:pt-2\">\r\n            <header id=\"ndn-header\" className={`header glass flex-col xs:flex-col sm:flex-row gap-2 xs:gap-2 sm:gap-3`}>\r\n              {/* Left: Brand */}\r\n              <div className=\"flex items-center gap-2 order-1\">\r\n                <h1\r\n                  className=\"text-lg xs:text-xl sm:text-xl md:text-2xl font-bold text-brand-700 whitespace-nowrap cursor-pointer select-none\"\r\n                  onClick={() => { setTab('score') }}\r\n                  title={'Go Home'}\r\n                >\r\n                  NINE-DART-NATION \r\n                </h1>\r\n              </div>\r\n              {/* Middle: Welcome band (full width on mobile) */}\r\n              <div className=\"order-3 xs:order-3 sm:order-2 w-full sm:w-auto flex-1 flex flex-col items-center justify-center text-center sm:text-left !text-black\">\r\n                <span className=\"text-sm xs:text-base sm:text-base md:text-lg font-semibold flex items-center gap-2 max-w-full truncate !text-black\" style={{ color: '#000000', WebkitTextFillColor: '#000000' }}>\r\n                  <span className=\"hidden xs:inline !text-black\">Welcome</span>\r\n                  <img src={avatar || fallbackAvatar} alt=\"avatar\" className=\"w-5 h-5 xs:w-6 xs:h-6 sm:w-6 sm:h-6 md:w-7 md:h-7 rounded-full ring-2 ring-white/20\" />\r\n                  <span className=\"truncate !text-black\" style={{ color: '#000000', WebkitTextFillColor: '#000000' }}>{user.username}</span>\r\n                </span>\r\n                <span className=\"hidden xs:inline text-xs xs:text-xs sm:text-xs md:text-sm !text-black\" style={{ color: '#000000', WebkitTextFillColor: '#000000' }}>All-time 3-dart avg: <span className=\"font-semibold !text-black\" style={{ color: '#000000', WebkitTextFillColor: '#000000' }}>{allTimeAvg.toFixed(2)}</span></span>\r\n                {isMobile && (\r\n                  <button\r\n                    className=\"btn px-3 py-1 xs:px-3 xs:py-1 sm:px-3 sm:py-1 mt-1 text-sm xs:text-sm\"\r\n                    aria-label=\"Open navigation\"\r\n                    onClick={()=> setNavOpen(true)}\r\n                  > Menu</button>\r\n                )}\r\n              </div>\r\n              {/* Calibration Status - visible across all tabs */}\r\n              {calibLocked && calibH && (\r\n                <button\r\n                  onClick={() => setTab('calibrate')}\r\n                  className=\"order-4 sm:order-4 md:order-3 px-3 py-1 text-xs sm:text-sm rounded-full bg-emerald-500/20 hover:bg-emerald-500/30 text-emerald-100 border border-emerald-400/50 transition-colors\"\r\n                  title=\"Click to adjust calibration\"\r\n                >\r\n                   Calibration Active {errorPx != null && ` ${errorPx.toFixed(1)}px`}\r\n                </button>\r\n              )}\r\n              {/* Right: Status + Actions */}\r\n              <div className=\"order-2 md:order-3 ml-0 md:ml-auto flex items-center gap-2 flex-wrap\">\r\n                <button\r\n                  className=\"px-3 py-1 text-sm rounded-full bg-white/5 hover:bg-white/10 border border-white/10\"\r\n                  onClick={() => {\r\n                    const el = appRef.current\r\n                    if (!el) return\r\n                    if (!document.fullscreenElement) el.requestFullscreen().catch(()=>{})\r\n                    else document.exitFullscreen().catch(()=>{})\r\n                  }}\r\n                  title={isFullscreen ? 'Exit Full Screen' : 'Enter Full Screen'}\r\n                >{isFullscreen ? 'Exit Full Screen' : 'Full Screen'}</button>\r\n                {tab === 'online' && (\r\n                  <button\r\n                    className=\"text-[10px] md:text-xs px-3 py-1 rounded-full bg-indigo-500/25 text-indigo-100 border border-indigo-400/40 hover:bg-indigo-500/40\"\r\n                    title=\"Open a simulated online match\"\r\n                    onClick={() => {\r\n                      setTimeout(() => {\r\n                        try { window.dispatchEvent(new CustomEvent('ndn:online-match-demo', { detail: { game: 'X01', start: 501 } })) } catch {}\r\n                      }, 40)\r\n                    }}\r\n                  >ONLINE DEMO</button>\r\n                )}\r\n                {/* Camera status badge */}\r\n                <CameraStatusBadge />\r\n                {ws ? (\r\n                  <span className=\"ml-0 md:ml-2\"><StatusDot status={ws.status} /></span>\r\n                ) : null}\r\n                {/* Protocol pill removed per request: keep green connected badge only */}\r\n              </div>\r\n            </header>\r\n            </div>\r\n            {/* Mobile drawer navigation */}\r\n            {isMobile && (\r\n              <MobileNav\r\n                open={navOpen}\r\n                onClose={()=> setNavOpen(false)}\r\n                active={tab}\r\n                onChange={(k)=>{ setTab(k); setNavOpen(false) }}\r\n                user={user}\r\n              />\r\n            )}\r\n            <main id=\"ndn-main-scroll\" className=\"space-y-4 flex-1 overflow-y-auto pr-1 flex flex-col\">\r\n            {tab === 'settings' && (\r\n                <Suspense fallback={<div className=\"p-4\">Loading settings</div>}>\r\n              <ScrollFade className=\"flex-1 min-h-0\">\r\n                <SettingsPanel user={user} />\r\n              </ScrollFade>\r\n                </Suspense>\r\n            )}\r\n            {tab === 'score' && (\r\n              <Suspense fallback={<div className=\"p-4\">Loading home</div>}>\r\n                <ScrollFade className=\"flex-1 min-h-0\">\r\n                  <Home user={user} />\r\n                </ScrollFade>\r\n              </Suspense>\r\n            )}\r\n            {tab === 'online' && (\r\n              <Suspense fallback={<div className=\"p-4\">Loading online</div>}>\r\n                <ScrollFade className=\"flex-1 min-h-0\">\r\n                  <OnlinePlay user={user} />\r\n                </ScrollFade>\r\n              </Suspense>\r\n            )}\r\n            {tab === 'offline' && (\r\n              <Suspense fallback={<div className=\"p-4\">Loading offline</div>}>\r\n                <ScrollFade className=\"flex-1 min-h-0\">\r\n                  <OfflinePlay user={user} />\r\n                </ScrollFade>\r\n              </Suspense>\r\n            )}\r\n            {/* Always keep Calibrator mounted to preserve phone camera stream, but hide when not active */}\r\n            <div className={tab === 'calibrate' ? '' : 'hidden'}>\r\n              <ScrollFade>\r\n                <Calibrator />\r\n              </ScrollFade>\r\n            </div>\r\n            {tab === 'friends' && (\r\n              <Suspense fallback={<div className=\"p-4\">Loading friends</div>}>\r\n                <ScrollFade className=\"flex-1 min-h-0\">\r\n                  <Friends user={user} />\r\n                </ScrollFade>\r\n              </Suspense>\r\n            )}\r\n            {tab === 'stats' && (\r\n              <Suspense fallback={<div className=\"p-4\">Loading stats</div>}>\r\n                <ScrollFade className=\"flex-1 min-h-0\">\r\n                  <StatsPanel user={user} />\r\n                </ScrollFade>\r\n              </Suspense>\r\n            )}\r\n            {tab === 'tournaments' && (\r\n              <Suspense fallback={<div className=\"p-4\">Loading tournaments</div>}>\r\n                <ScrollFade className=\"flex-1 min-h-0\">\r\n                  <Tournaments user={user} />\r\n                </ScrollFade>\r\n              </Suspense>\r\n            )}\r\n            {tab === 'admin' && (\r\n              <Suspense fallback={<div className=\"p-4\">Loading admin</div>}>\r\n                <ScrollFade className=\"flex-1 min-h-0\">\r\n                  <div className=\"flex-1 min-h-0 space-y-6\">\r\n                    <AdminDashboard user={user} />\r\n                    <OpsDashboard user={user} />\r\n                  </div>\r\n                </ScrollFade>\r\n              </Suspense>\r\n            )}\r\n            {tab === 'fullaccess' && (\r\n              <Suspense fallback={<div className=\"p-4\">Loading admin access</div>}>\r\n                <ScrollFade className=\"flex-1 min-h-0\">\r\n                  <AdminAccess user={user} />\r\n                </ScrollFade>\r\n              </Suspense>\r\n            )}\r\n            </main>\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n  {/* Floating Help Assistant - Always visible */}\r\n  <HelpAssistant />\r\n  {/* App footer with legal notice */}\r\n  <Footer />\r\n  {/* Debug banner removed - not shown to users in production builds */}\r\n  {/* Global camera logger: logs stream lifecycle and video/pc events across site */}\r\n  {!minimalUI && <GlobalCameraLogger />}\r\n      {/* Global phone camera overlay - visibility controlled by store */}\r\n  {/* Keep a hidden global video element alive across navigation */}\r\n  {!minimalUI && <GlobalPhoneVideoSink />}\r\n    </ThemeProvider>\r\n  )\r\n}\r\n\r\n// Lightweight mobile drawer that reuses the same Sidebar\r\nfunction MobileNav({ open, onClose, active, onChange, user }: { open: boolean; onClose: () => void; active: TabKey; onChange: (k: TabKey)=>void; user: any }) {\r\n  return (\r\n    <Drawer open={open} onClose={onClose} width={320} side=\"left\" title=\"Navigate\">\r\n      <div className=\"mt-2\">\r\n        <Sidebar active={active} onChange={onChange} user={user} className=\"flex relative static max-h-[80vh] w-full\" />\r\n      </div>\r\n    </Drawer>\r\n  )\r\n}\r\n","import { useEffect, useState } from 'react'\r\n\r\nfunction validatePassword(password: string) {\r\n  return password.length >= 10 && /\\d/.test(password) && /[^A-Za-z0-9]/.test(password)\r\n}\r\n\r\nexport default function ResetPassword() {\r\n  const [token, setToken] = useState('')\r\n  const [password, setPassword] = useState('')\r\n  const [confirm, setConfirm] = useState('')\r\n  const [error, setError] = useState('')\r\n  const [success, setSuccess] = useState('')\r\n\r\n  useEffect(() => {\r\n    try {\r\n      const sp = new URLSearchParams(window.location.search)\r\n      const t = sp.get('token') || ''\r\n      setToken(t)\r\n    } catch {}\r\n  }, [])\r\n\r\n  async function onSubmit(e: any) {\r\n    e.preventDefault()\r\n    setError(''); setSuccess('')\r\n    if (!token) { setError('Missing or invalid reset token.'); return }\r\n    if (!password || password !== confirm) { setError('Passwords do not match.'); return }\r\n    if (!validatePassword(password)) { setError('Password must be at least 10 chars and include a number and symbol.'); return }\r\n    try {\r\n      const r = await fetch('/api/auth/confirm-reset', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ token, newPassword: password }) })\r\n      const j = await r.json()\r\n      if (!j?.ok) throw new Error(j?.error || 'Reset failed')\r\n      setSuccess('Password changed. You can now sign in.')\r\n    } catch (e: any) {\r\n      setError(e?.message || 'Reset failed')\r\n    }\r\n  }\r\n\r\n  return (\r\n    <div className=\"min-h-screen flex items-center justify-center relative overflow-hidden\">\r\n      <div className=\"background-animated\" />\r\n      <div className=\"relative z-10 w-full max-w-lg mx-auto p-4\">\r\n        <form className=\"card w-full space-y-4\" onSubmit={onSubmit}>\r\n          <div className=\"flex flex-col items-center justify-center gap-2 mb-2 text-center\">\r\n            <h1 className=\"logo text-center\">Reset your password</h1>\r\n          </div>\r\n          {!token && (\r\n            <div className=\"text-red-400\">This reset link is missing a token. Please use the link from your email.</div>\r\n          )}\r\n          <input className=\"input w-full\" type=\"password\" placeholder=\"New password\" value={password} onChange={e=>setPassword(e.target.value)} required />\r\n          <input className=\"input w-full\" type=\"password\" placeholder=\"Confirm password\" value={confirm} onChange={e=>setConfirm(e.target.value)} required />\r\n          {error && <div className=\"text-red-400 font-semibold text-sm\">{error}</div>}\r\n          {success && <div className=\"text-emerald-400 font-semibold text-sm\">{success}</div>}\r\n          <button className=\"btn w-full\" type=\"submit\" disabled={!token}>Change Password</button>\r\n          <a className=\"underline text-sm text-center\" href=\"/\">Back to sign in</a>\r\n        </form>\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n","import { Component, type ReactNode } from 'react'\r\n\r\nexport default class ErrorBoundary extends Component<{\r\n  children: ReactNode\r\n}, { hasError: boolean; message?: string }>{\r\n  constructor(props: any) {\r\n    super(props)\r\n    this.state = { hasError: false }\r\n  }\r\n  static getDerivedStateFromError(err: any) {\r\n    return { hasError: true, message: String(err?.message || err) }\r\n  }\r\n  componentDidCatch(error: any, info: any) {\r\n    // eslint-disable-next-line no-console\r\n    console.error('[ErrorBoundary]', error, info)\r\n  }\r\n  render() {\r\n    if (this.state.hasError) {\r\n      return (\r\n        <div className=\"min-h-screen flex items-center justify-center p-6\">\r\n          <div className=\"card max-w-lg w-full text-center\">\r\n            <h2 className=\"text-2xl font-bold mb-2\">Something went wrong</h2>\r\n            <p className=\"opacity-80 mb-4\">Please refresh the page. If this persists, let us know.</p>\r\n            {this.state.message && (\r\n              <pre className=\"text-xs bg-black/40 rounded p-2 overflow-auto text-left\">{this.state.message}</pre>\r\n            )}\r\n            <button className=\"btn mt-4\" onClick={() => window.location.reload()}>Reload</button>\r\n          </div>\r\n        </div>\r\n      )\r\n    }\r\n    return this.props.children as any\r\n  }\r\n}\r\n","import { StrictMode } from 'react'\r\nimport ReactDOM from 'react-dom/client'\r\nimport './index.css'\r\nimport App from './App'\r\nimport ResetPassword from './components/ResetPassword'\r\nimport { WSProvider } from './components/WSProvider'\r\nimport ErrorBoundary from './components/ErrorBoundary'\r\nimport { installApiInterceptor } from './utils/api'\r\n\r\n// In some hosting setups, third-party or legacy code may expect a global React.\r\n// This ensures `React` is available at runtime to prevent 'React is not defined' errors.\r\ntry { (window as any).React = (window as any).React || {} } catch {}\r\n\r\ninstallApiInterceptor()\r\n\r\nReactDOM.createRoot(document.getElementById('root')!).render(\r\n  <StrictMode>\r\n    <ErrorBoundary>\r\n      <WSProvider>\r\n        <Root />\r\n      </WSProvider>\r\n    </ErrorBoundary>\r\n  </StrictMode>,\r\n)\r\n\r\nfunction Root() {\r\n  const path = window.location.pathname\r\n  if (path === '/reset') return <ResetPassword />\r\n  return <App />\r\n}\r\n\r\n"],"file":"index-QB6Os3F3.js"}