{"version":3,"file":"match-BBhqR8yP.js","sources":["../../src/store/audit.ts","../../src/store/match.ts"],"sourcesContent":["import { create } from \"zustand\";\n\nexport type VisitAudit = {\n  ts: number;\n  mode: string;\n  darts: number;\n  visitTotal: number;\n  preOpenDarts?: number;\n  preRemaining?: number;\n  postRemaining?: number;\n  bust?: boolean;\n  finish?: boolean;\n};\n\ntype CalibrationAudit = {\n  hasHomography: boolean;\n  imageSize?: { w: number; h: number } | null;\n  lastUpdated?: number;\n};\n\ntype AuditState = {\n  // Rolling buffer of recent visits\n  recent: VisitAudit[];\n  // Aggregates\n  totals: {\n    visits: number;\n    darts: number;\n    points: number;\n    finishes: number;\n    busts: number;\n    byMode: Record<string, { visits: number; darts: number; points: number }>;\n  };\n  calibration: CalibrationAudit;\n  recordVisit: (\n    mode: string,\n    darts: number,\n    visitTotal: number,\n    meta?: Partial<VisitAudit>,\n  ) => void;\n  setCalibrationStatus: (c: Partial<CalibrationAudit>) => void;\n  reset: () => void;\n};\n\nexport const useAudit = create<AuditState>((set, get) => ({\n  recent: [],\n  totals: { visits: 0, darts: 0, points: 0, finishes: 0, busts: 0, byMode: {} },\n  calibration: {\n    hasHomography: false,\n    imageSize: null,\n    lastUpdated: undefined,\n  },\n  recordVisit: (mode, darts, visitTotal, meta) =>\n    set((state) => {\n      const ts = Date.now();\n      const item: VisitAudit = {\n        ts,\n        mode,\n        darts,\n        visitTotal,\n        preOpenDarts: meta?.preOpenDarts,\n        preRemaining: meta?.preRemaining,\n        postRemaining: meta?.postRemaining,\n        bust: meta?.bust,\n        finish: meta?.finish,\n      };\n      const recent = [...state.recent, item].slice(-50);\n      const totals = { ...state.totals };\n      totals.visits += 1;\n      totals.darts += darts;\n      totals.points += visitTotal;\n      if (item.finish) totals.finishes += 1;\n      if (item.bust) totals.busts += 1;\n      const bm = totals.byMode[mode] || { visits: 0, darts: 0, points: 0 };\n      bm.visits += 1;\n      bm.darts += darts;\n      bm.points += visitTotal;\n      totals.byMode[mode] = bm;\n      // Console surface for quick verification without UI changes\n      try {\n        const tag = item.finish ? \"FINISH\" : item.bust ? \"BUST\" : \"VISIT\";\n        console.info(`[Audit:${tag}]`, {\n          mode,\n          darts,\n          visitTotal,\n          preOpenDarts: item.preOpenDarts ?? 0,\n          preRemaining: item.preRemaining,\n          postRemaining: item.postRemaining,\n        });\n      } catch {}\n      // Persist recent visits to localStorage so Home can show recent across reloads\n      try {\n        localStorage.setItem(\"ndn_audit_recent\", JSON.stringify(recent));\n      } catch {}\n      return { ...state, recent, totals };\n    }),\n  setCalibrationStatus: (c) =>\n    set((state) => {\n      const updated: CalibrationAudit = {\n        hasHomography: c.hasHomography ?? state.calibration.hasHomography,\n        imageSize:\n          c.imageSize === undefined ? state.calibration.imageSize : c.imageSize,\n        lastUpdated: Date.now(),\n      };\n      try {\n        console.info(\"[Audit:Calibration]\", updated);\n      } catch {}\n      return { ...state, calibration: updated };\n    }),\n  reset: () =>\n    set({\n      recent: [],\n      totals: {\n        visits: 0,\n        darts: 0,\n        points: 0,\n        finishes: 0,\n        busts: 0,\n        byMode: {},\n      },\n      calibration: {\n        hasHomography: false,\n        imageSize: null,\n        lastUpdated: undefined,\n      },\n    }),\n}));\n\n// Expose a tiny debug hook on window for manual checks when needed\ntry {\n  // @ts-ignore\n  if (typeof window !== \"undefined\")\n    (window as any).__NDN_AUDIT__ = {\n      get: () => useAudit.getState(),\n      subscribe: useAudit.subscribe,\n      reset: () => useAudit.getState().reset(),\n    };\n} catch {}\n\n// Initialize persisted recent visits if present\ntry {\n  if (typeof window !== \"undefined\") {\n    const raw = localStorage.getItem(\"ndn_audit_recent\");\n    if (raw) {\n      const arr = JSON.parse(raw);\n      if (Array.isArray(arr) && arr.length) {\n        useAudit.setState((s) => ({ ...s, recent: arr.slice(-50) }));\n      }\n    }\n  }\n} catch {}\n","import { create } from \"zustand\";\nimport { useAudit } from \"./audit\";\n\nexport type ThrowVisit = {\n  darts: number;\n  score: number;\n  preOpenDarts?: number; // exclude from avg in Double-In\n  doubleWindowDarts?: number; // darts thrown while remaining <= 50 (double-out window) in this visit\n  finishedByDouble?: boolean; // visit ended the leg with a double or inner bull\n  visitTotal?: number; // convenience to detect 180s and summaries\n};\nexport type Leg = {\n  visits: ThrowVisit[];\n  totalScoreStart: number; // e.g., 501\n  totalScoreRemaining: number;\n  dartsThrown: number;\n  finished: boolean;\n  checkoutScore: number | null; // score taken on final visit to finish leg\n  startTime: number;\n  endTime?: number;\n};\n\nexport type Player = {\n  id: string;\n  name: string;\n  legsWon: number;\n  legs: Leg[];\n  bestThreeDartAvg?: number;\n  worstThreeDartAvg?: number;\n  bestNineDart?: { darts: number; timestamp: number };\n  bestCheckout?: number;\n};\n\nexport type MatchState = {\n  roomId: string;\n  players: Player[];\n  currentPlayerIdx: number;\n  startingScore: number;\n  inProgress: boolean;\n  bestLegThisMatch?: { playerId: string; darts: number; timestamp: number };\n};\n\nfunction calcThreeDartAvg(leg: Leg): number {\n  if (leg.dartsThrown === 0) return 0;\n  const scored = leg.totalScoreStart - leg.totalScoreRemaining;\n  return (scored / leg.dartsThrown) * 3;\n}\n\nfunction finishedLegStats(leg: Leg) {\n  // compute 3-dart avg, was it a 9-dart (or lowest darts)?\n  const avg = calcThreeDartAvg(leg);\n  const isCompleted = leg.finished;\n  return {\n    avg,\n    isCompleted,\n    darts: leg.dartsThrown,\n    checkout: leg.checkoutScore ?? 0,\n  };\n}\n\nfunction updatePlayerEndOfGameStats(player: Player) {\n  if (player.legs.length === 0) return;\n  const avgs: number[] = [];\n  let bestNine: { darts: number; timestamp: number } | undefined;\n  let bestCheckout = player.bestCheckout ?? 0;\n\n  for (const leg of player.legs) {\n    if (!leg.finished) continue;\n    const st = finishedLegStats(leg);\n    avgs.push(st.avg);\n    // best \"9-dart leg\" meaning fewest darts; if tie pick earliest\n    if (\n      !bestNine ||\n      st.darts < bestNine.darts ||\n      (st.darts === bestNine.darts && (leg.endTime ?? 0) < bestNine.timestamp)\n    ) {\n      bestNine = { darts: st.darts, timestamp: leg.endTime ?? Date.now() };\n    }\n    if (st.checkout > bestCheckout) bestCheckout = st.checkout;\n  }\n\n  if (avgs.length) {\n    player.bestThreeDartAvg = Math.max(...avgs);\n    player.worstThreeDartAvg = Math.min(...avgs);\n  }\n  if (bestNine) player.bestNineDart = bestNine;\n  player.bestCheckout = bestCheckout;\n}\n\nexport type Actions = {\n  newMatch: (players: string[], startingScore: number, roomId?: string) => void;\n  addVisit: (\n    score: number,\n    darts: number,\n    meta?: {\n      preOpenDarts?: number;\n      doubleWindowDarts?: number;\n      finishedByDouble?: boolean;\n      visitTotal?: number;\n    },\n  ) => void;\n  undoVisit: () => void;\n  endLeg: (checkoutScore: number) => void;\n  nextPlayer: () => void;\n  endGame: () => void;\n  importState: (state: MatchState) => void;\n};\n\nexport const useMatch = create<MatchState & Actions>((set, get) => ({\n  roomId: \"\",\n  players: [],\n  currentPlayerIdx: 0,\n  startingScore: 501,\n  inProgress: false,\n\n  newMatch: (playerNames, startingScore, roomId = \"\") =>\n    set(() => {\n      const players = playerNames.map(\n        (name, i) =>\n          ({\n            id: `${i}`,\n            name,\n            legsWon: 0,\n            legs: [],\n          }) as Player,\n      );\n      return {\n        players,\n        currentPlayerIdx: 0,\n        startingScore,\n        inProgress: true,\n        roomId,\n        bestLegThisMatch: undefined,\n      };\n    }),\n\n  addVisit: (score, darts, meta) =>\n    set((state) => {\n      if (!state.inProgress) return state;\n      const p = state.players[state.currentPlayerIdx];\n      // ensure a current leg exists\n      let leg = p.legs[p.legs.length - 1];\n      if (!leg || leg.finished) {\n        leg = {\n          visits: [],\n          totalScoreStart: state.startingScore,\n          totalScoreRemaining: state.startingScore,\n          dartsThrown: 0,\n          finished: false,\n          checkoutScore: null,\n          startTime: Date.now(),\n        };\n        p.legs.push(leg);\n      }\n      const preRem = leg.totalScoreRemaining;\n      const postRem = Math.max(0, preRem - score);\n      leg.visits.push({\n        darts,\n        score,\n        preOpenDarts: meta?.preOpenDarts,\n        doubleWindowDarts: meta?.doubleWindowDarts,\n        finishedByDouble: meta?.finishedByDouble,\n        visitTotal: meta?.visitTotal ?? score,\n      });\n      leg.dartsThrown += darts;\n      leg.totalScoreRemaining = postRem;\n      // Audit record (best-effort; ignore failures)\n      try {\n        const bust = score === 0 && darts > 0 && postRem === preRem;\n        const finish = postRem === 0;\n        useAudit.getState().recordVisit(\"x01-match\", darts, score, {\n          preOpenDarts: meta?.preOpenDarts ?? 0,\n          preRemaining: preRem,\n          postRemaining: postRem,\n          bust,\n          finish,\n        });\n      } catch {}\n      return { ...state };\n    }),\n\n  undoVisit: () =>\n    set((state) => {\n      const p = state.players[state.currentPlayerIdx];\n      const leg = p.legs[p.legs.length - 1];\n      if (!leg || leg.finished || leg.visits.length === 0) return state;\n      const last = leg.visits.pop()!;\n      leg.dartsThrown -= last.darts;\n      leg.totalScoreRemaining += last.score;\n      return { ...state };\n    }),\n\n  endLeg: (checkoutScore) =>\n    set((state) => {\n      const p = state.players[state.currentPlayerIdx];\n      const leg = p.legs[p.legs.length - 1];\n      if (!leg || leg.finished) return state;\n      leg.finished = true;\n      leg.checkoutScore = checkoutScore;\n      leg.endTime = Date.now();\n      if (leg.totalScoreRemaining === 0) {\n        p.legsWon += 1;\n        // Check if this leg is the new best for this match (fewest darts)\n        const best = state.bestLegThisMatch;\n        if (!best || leg.dartsThrown < best.darts) {\n          state.bestLegThisMatch = {\n            playerId: p.id,\n            darts: leg.dartsThrown,\n            timestamp: leg.endTime,\n          };\n        }\n      }\n      return { ...state };\n    }),\n\n  nextPlayer: () =>\n    set((state) => ({\n      ...state,\n      currentPlayerIdx: (state.currentPlayerIdx + 1) % state.players.length,\n    })),\n\n  endGame: () =>\n    set((state) => {\n      // Only now compute best/worst 3-dart, best 9-dart, best checkout\n      for (const p of state.players) updatePlayerEndOfGameStats(p);\n      return { ...state, inProgress: false };\n    }),\n\n  importState: (newState) => set(() => ({ ...newState })),\n}));\n"],"names":["useAudit","create","set","get","mode","darts","visitTotal","meta","state","item","recent","totals","bm","tag","c","updated","raw","arr","s","calcThreeDartAvg","leg","finishedLegStats","avg","isCompleted","updatePlayerEndOfGameStats","player","avgs","bestNine","bestCheckout","st","useMatch","playerNames","startingScore","roomId","name","i","score","p","preRem","postRem","bust","finish","last","checkoutScore","best","newState"],"mappings":"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"}