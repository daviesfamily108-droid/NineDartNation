(function(){"use strict";const s={bullInner:6.35,bullOuter:15.9,trebleInner:99,trebleOuter:107,doubleInner:162,doubleOuter:170};function C(t,c){const l=c.x,r=c.y,u=t[6]*l+t[7]*r+t[8],n=(t[0]*l+t[1]*r+t[2])/u,o=(t[3]*l+t[4]*r+t[5])/u;return{x:n,y:o}}function R(t,c){if(t.length<4||c.length<4)throw new Error("Need at least 4 correspondences");if(t.length!==c.length)throw new Error("Correspondences must have equal length");const l=[],r=[];for(let o=0;o<t.length;o++){const{x:e,y:i}=t[o],{x:b,y:d}=c[o];l.push([e,i,1,0,0,0,-b*e,-b*i]),r.push(b),l.push([0,0,0,e,i,1,-d*e,-d*i]),r.push(d)}const u=P(l,r);return[u[0],u[1],u[2],u[3],u[4],u[5],u[6],u[7],1]}function P(t,c){const l=t.length,r=t[0].length,u=Array.from({length:r},()=>new Array(r).fill(0)),n=new Array(r).fill(0);for(let o=0;o<l;o++)for(let e=0;e<r;e++){n[e]+=t[o][e]*c[o];for(let i=0;i<r;i++)u[e][i]+=t[o][e]*t[o][i]}return A(u,n)}function A(t,c){const l=c.length,r=t.map((n,o)=>n.concat([c[o]]));for(let n=0;n<l;n++){let o=n;for(let e=n+1;e<l;e++)Math.abs(r[e][n])>Math.abs(r[o][n])&&(o=e);if(Math.abs(r[o][n])<1e-12)throw new Error("Singular matrix");if(o!==n){const e=r[n];r[n]=r[o],r[o]=e}for(let e=n+1;e<l;e++){const i=r[e][n]/r[n][n];for(let b=n;b<=l;b++)r[e][b]-=i*r[n][b]}}const u=new Array(l).fill(0);for(let n=l-1;n>=0;n--){let o=r[n][l];for(let e=n+1;e<l;e++)o-=r[n][e]*u[e];u[n]=o/r[n][n]}return u}function D(t,c,l){let r=0;for(let u=0;u<c.length;u++){const n=C(t,c[u]),o=n.x-l[u].x,e=n.y-l[u].y;r+=o*o+e*e}return Math.sqrt(r/c.length)}const E=t=>!!t&&Number.isFinite(t.x)&&Number.isFinite(t.y),S=t=>Array.isArray(t)&&t.length===9&&t.every(Number.isFinite);function k(t){const c=t.getContext("2d");if(!c)return null;const l=t.width,r=t.height,n=c.getImageData(0,0,l,r).data,o=[];for(let f=2;f<r-2;f++)for(let a=2;a<l-2;a++){let y=0,h=0;for(let I=-1;I<=1;I++)for(let x=-1;x<=1;x++){const M=((f+I)*l+(a+x))*4,_=n[M]*.299+n[M+1]*.587+n[M+2]*.114;x!==0&&(y+=(x>0?1:-1)*_),I!==0&&(h+=(I>0?1:-1)*_)}const w=Math.hypot(y,h);w>20&&o.push({x:a,y:f,mag:w})}if(o.length===0)return null;let e=null,i=0;for(let f=r*.3;f<r*.7;f+=10)for(let a=l*.3;a<l*.7;a+=10){let y=0,h=0;const w=[15,30,150,162,180,205];for(const I of w){let x=0,M=0;for(const _ of o){const j=Math.hypot(_.x-a,_.y-f);Math.abs(j-I)<3&&(x+=_.mag,M++)}M>10&&x>500&&(y++,h+=x)}y>=4&&h>i&&(i=h,e={cx:a,cy:f})}if(!e)return null;const b=e.cx,d=e.cy;let m=170,g=0;for(let f=120;f<=250;f+=5){let a=0,y=0;for(const h of o){const w=Math.hypot(h.x-b,h.y-d);Math.abs(w-f)<2&&(a+=h.mag,y++)}y>20&&a>g&&(g=a,m=f)}let O=0;const p=m/s.doubleOuter;for(const f of[s.bullInner,s.bullOuter,s.trebleInner,s.trebleOuter,s.doubleInner,s.doubleOuter]){const a=f*p;for(const y of o){const h=Math.hypot(y.x-b,y.y-d);if(Math.abs(h-a)<3){O+=15;break}}}return O=Math.min(100,O),{cx:b,cy:d,r:m,confidence:O}}function F(t){try{const c=t.width,l=t.height,r=c/2,u=l/2,n=k(t);if(!n)return{success:!1,cx:r,cy:u,bullInner:0,bullOuter:0,trebleInner:0,trebleOuter:0,doubleInner:0,doubleOuter:0,confidence:0,homography:null,errorPx:null,calibrationPoints:[],message:"No dartboard detected. Ensure board is clearly visible with good contrast between rings and background."};const o=n.r/s.doubleOuter,e={cx:n.cx,cy:n.cy,bullInner:s.bullInner*o,bullOuter:s.bullOuter*o,trebleInner:s.trebleInner*o,trebleOuter:s.trebleOuter*o,doubleInner:s.doubleInner*o,doubleOuter:n.r},i=[{x:e.cx,y:e.cy-e.doubleOuter},{x:e.cx+e.doubleOuter,y:e.cy},{x:e.cx,y:e.cy+e.doubleOuter},{x:e.cx-e.doubleOuter,y:e.cy}],b=[{x:0,y:-s.doubleOuter},{x:s.doubleOuter,y:0},{x:0,y:s.doubleOuter},{x:-s.doubleOuter,y:0}];let d=null,m=null,g=n.confidence;try{d=R(b,i),m=D(d,b,i);const a=Math.max(10,Math.min(95,100-Math.max(0,m-1)*10));g=(g+a)/2}catch{g=Math.max(40,g)}const O=i.every(E),p=S(d);return{success:!!p&&O&&g>50,cx:e.cx,cy:e.cy,bullInner:e.bullInner,bullOuter:e.bullOuter,trebleInner:e.trebleInner,trebleOuter:e.trebleOuter,doubleInner:e.doubleInner,doubleOuter:e.doubleOuter,confidence:g,homography:p?d:null,errorPx:p?m:null,calibrationPoints:O?i:[],message:!O||!p?"❌ Detection produced unstable calibration data. Adjust camera framing or calibrate manually.":g>80?"✅ High confidence detection":g>50?"⚠️ Detection found but could be better":"❌ Low confidence - try better lighting"}}catch(c){return{success:!1,cx:t.width/2,cy:t.height/2,bullInner:0,bullOuter:0,trebleInner:0,trebleOuter:0,doubleInner:0,doubleOuter:0,confidence:0,homography:null,errorPx:null,calibrationPoints:[],message:c instanceof Error?c.message:"Board detection failed"}}}function N(t){if(t.confidence>70)return t;const c={bullInner_to_bullOuter:s.bullInner/s.bullOuter,bullOuter_to_trebleInner:s.bullOuter/s.trebleInner,trebleOuter_to_doubleInner:s.trebleOuter/s.doubleInner,doubleInner_to_doubleOuter:s.doubleInner/s.doubleOuter},l={bullInner_to_bullOuter:t.bullInner/t.bullOuter,bullOuter_to_trebleInner:t.bullOuter/t.trebleInner,trebleOuter_to_doubleInner:t.trebleOuter/t.doubleInner,doubleInner_to_doubleOuter:t.doubleInner/t.doubleOuter};let r=0,u=0;for(const[e,i]of Object.entries(c)){const b=l[e],d=Math.abs(b-i)/i;r+=d,u++}const n=r/u,o=Math.max(10,t.confidence-n*100);return{...t,confidence:o,message:o>70?"✅ High confidence detection":o>50?"⚠️ Rings detected but ratios off - may need refinement":"❌ Low confidence - try repositioning camera"}}self.onmessage=async t=>{try{const{type:c,bitmap:l}=t.data||{};if(c!=="detect"||!l)return;const r=new OffscreenCanvas(l.width,l.height),u=r.getContext("2d");if(!u){postMessage({error:"OffscreenCanvas context unavailable"});return}u.drawImage(l,0,0,r.width,r.height);let n=F(r);n=N(n),postMessage({type:"result",detection:n})}catch(c){postMessage({error:c&&c.message||"Worker error"})}}})();
//# sourceMappingURL=boardDetection.worker-DkETM2wk.js.map
