import{a as I,j as s,T as M}from"./index-QB6Os3F3.js";import{r as c}from"./ui-CuWypN7C.js";import{u as J,c as A}from"./profanity-_ZQ4W8dR.js";import"./vendor-D3F3s8fL.js";function D(p){if(!p)return"";const t=Math.floor((Date.now()-p)/1e3);if(t<60)return`${t}s ago`;const a=Math.floor(t/60);if(a<60)return`${a}m ago`;const d=Math.floor(a/60);return d<24?`${d}h ago`:`${Math.floor(d/24)}d ago`}function G({user:p}){const t=I(),a=String(p?.email||"").toLowerCase(),[d,g]=c.useState([]),[S,F]=c.useState([]),[C,y]=c.useState([]),[O,E]=c.useState(""),[m,R]=c.useState("all"),[u,i]=c.useState(!1),f=J(),[j,N]=c.useState([]),[v,x]=c.useState([]),[w,b]=c.useState({show:!1});async function h(){if(a)try{const[e,n,l,r]=await Promise.all([fetch(`/api/friends/list?email=${encodeURIComponent(a)}`).then(o=>o.json()),fetch(`/api/friends/suggested?email=${encodeURIComponent(a)}`).then(o=>o.json()),fetch(`/api/friends/requests?email=${encodeURIComponent(a)}`).then(o=>o.json()),fetch(`/api/friends/outgoing?email=${encodeURIComponent(a)}`).then(o=>o.json())]);g(e.friends||[]),F(n.suggestions||[]),N(l.requests||[]),x(r.requests||[])}catch{}}c.useEffect(()=>{h()},[a]);async function $(e){if(E(e),!e){y([]);return}try{const l=await(await fetch(`/api/friends/search?q=${encodeURIComponent(e)}`)).json();y(l.results||[])}catch{}}async function T(e){if(!(!a||!e)){i(!0);try{await fetch("/api/friends/add",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:a,friend:e})}),await h(),E(""),y([]),t("Friend added",{type:"success"})}finally{i(!1)}}}async function U(e){if(!(!a||!e)){i(!0);try{await fetch("/api/friends/remove",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:a,friend:e})}),await h(),t("Friend removed",{type:"info"})}finally{i(!1)}}}const q=c.useMemo(()=>m==="all"?d:d.filter(e=>(e.status||"offline")===m),[d,m]);async function P(e){if(!e){t("Room unavailable",{type:"error"});return}try{const n=new CustomEvent("ndn:spectate-request",{detail:{roomId:e}});window.dispatchEvent(n),t("Opening spectator view…",{type:"info"})}catch{}}const k=j.length+v.length;return s.jsxs("div",{className:"card ndn-game-shell",children:[s.jsx("h2",{className:"text-2xl font-bold text-brand-700 mb-2",children:"Friends"}),s.jsx("p",{className:"mb-2 text-brand-600",children:"Manage your friends. See who’s online, in-game, or offline; find new teammates; and invite people to play."}),s.jsxs("div",{className:"text-xs opacity-70 mb-3",children:["Online: ",d.filter(e=>e.status==="online").length," · In-game: ",d.filter(e=>e.status==="ingame").length," · Offline: ",d.filter(e=>!e.status||e.status==="offline").length]}),s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-3 mb-4",children:[s.jsxs("div",{className:"md:col-span-2 p-3 rounded-2xl bg-black/30 border border-white/10",children:[s.jsx("div",{className:"flex items-center justify-between mb-2",children:s.jsx("div",{className:"font-semibold text-white/90",children:"Your Friends"})}),s.jsx(M,{tabs:[{key:"all",label:"All"},{key:"online",label:"Online"},{key:"ingame",label:"In-Game"},{key:"offline",label:"Offline"},{key:"requests",label:`Requests ${k>0?"("+k+")":""}`}],active:m,onChange:e=>R(e),className:"mb-3"}),m==="requests"?s.jsx("ul",{className:"space-y-2",children:k>0?s.jsxs(s.Fragment,{children:[j.length>0&&j.map(e=>s.jsxs("li",{className:"p-3 rounded bg-black/20 flex flex-col gap-2",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("span",{className:"font-semibold text-lg",children:e.fromUsername||e.fromEmail||"Unknown User"}),s.jsx("span",{className:"text-xs bg-blue-600/20 text-blue-400 px-2 py-1 rounded",children:"Incoming"})]}),s.jsxs("div",{className:"flex gap-2",children:[s.jsx("button",{className:"btn bg-emerald-600 hover:bg-emerald-700",onClick:async()=>{i(!0);try{if((await fetch("/api/friends/accept",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:a,requester:e.fromEmail})})).ok){N(r=>r.filter(o=>o.id!==e.id));const l={email:e.fromEmail,username:e.fromUsername,status:"offline"};g(r=>[...r,l]),x(r=>r.filter(o=>o.toEmail!==e.fromEmail)),t("Friend request accepted",{type:"success"}),setTimeout(()=>h(),100)}else t("Failed to accept request",{type:"error"})}catch{t("Error accepting request",{type:"error"})}finally{i(!1)}},children:"Accept"}),s.jsx("button",{className:"btn bg-rose-600 hover:bg-rose-700",onClick:async()=>{i(!0);try{(await fetch("/api/friends/decline",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:a,requester:e.fromEmail})})).ok?(N(l=>l.filter(r=>r.id!==e.id)),x(l=>l.filter(r=>r.toEmail!==e.fromEmail)),t("Friend request declined",{type:"info"}),setTimeout(()=>h(),100)):t("Failed to decline request",{type:"error"})}finally{i(!1)}},children:"Decline"})]})]},`incoming-${e.id||e.fromEmail}`)),v.length>0&&v.map(e=>s.jsxs("li",{className:"p-3 rounded bg-black/20 flex flex-col gap-2",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("span",{className:"font-semibold text-lg",children:e.toUsername||e.toEmail||"Unknown User"}),s.jsx("span",{className:"text-xs bg-amber-600/20 text-amber-400 px-2 py-1 rounded",children:"Pending"})]}),s.jsx("button",{className:"btn bg-slate-600 hover:bg-slate-700 self-start",onClick:async()=>{i(!0);try{(await fetch("/api/friends/cancel",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:a,friend:e.toEmail})})).ok?(x(l=>l.filter(r=>r.id!==e.id)),t("Friend request cancelled",{type:"info"}),setTimeout(()=>h(),100)):t("Failed to cancel request",{type:"error"})}finally{i(!1)}},children:"Cancel"})]},`outgoing-${e.id||e.toEmail}`))]}):s.jsx("li",{className:"text-sm opacity-70",children:"No friend requests yet."})}):s.jsxs("ul",{className:"space-y-2",children:[q.map(e=>s.jsxs("li",{className:"p-2 rounded bg-black/20 flex items-center justify-between",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("span",{className:`inline-block w-2 h-2 rounded-full ${e.status==="online"?"bg-emerald-400":e.status==="ingame"?"bg-amber-400":"bg-slate-400"}`}),s.jsx("span",{className:"font-semibold",children:e.username||e.email}),s.jsxs("span",{className:"text-xs opacity-70",children:[e.status||"offline",e.status!=="online"&&e.lastSeen?` · ${D(e.lastSeen)}`:""]}),e.status==="ingame"&&e.match&&s.jsxs("span",{className:"text-[10px] opacity-70 px-2 py-0.5 rounded bg-indigo-500/20 border border-indigo-600/30",children:[e.match.game," ",e.match.mode==="firstto"?"FT":"BO"," ",e.match.value,e.match.game==="X01"&&e.match.startingScore?` · ${e.match.startingScore}`:""]})]}),s.jsxs("div",{className:"flex items-center gap-2",children:[e.status==="ingame"&&e.roomId&&s.jsx("button",{className:"btn",onClick:()=>P(e.roomId),children:"Spectate"}),s.jsx("button",{className:"btn",disabled:u||e.status!=="online"&&e.status!=="ingame",onClick:async()=>{i(!0);try{(await(await fetch("/api/friends/invite",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({fromEmail:a,toEmail:e.email,game:"X01",mode:"bestof",value:3,startingScore:501})})).json().catch(()=>({})))?.delivered?t("Invite sent",{type:"success"}):t("Friend is offline; invite queued",{type:"info"})}finally{i(!1)}},children:"Invite"}),s.jsx("button",{className:"btn",disabled:u,onClick:()=>b({show:!0,toUser:e.username||e.email,toEmail:e.email}),children:"Message"}),s.jsx("button",{className:"btn bg-rose-600 hover:bg-rose-700",disabled:u,onClick:()=>U(e.email),children:"Remove"})]})]},e.email)),q.length===0&&s.jsxs("li",{className:"text-sm opacity-70",children:["No friends ",m!=="all"?`in ${m}`:""," yet."]})]})]}),s.jsxs("div",{className:"p-3 rounded-2xl bg-black/20 border border-white/10",children:[s.jsx("div",{className:"font-semibold mb-2 text-white/90",children:"Find Friends"}),s.jsx("input",{className:"input w-full mb-2",placeholder:"Search by name or email",value:O,onChange:e=>$(e.target.value)}),s.jsxs("ul",{className:"space-y-1 mb-3 max-h-48 overflow-auto",children:[C.map(e=>s.jsxs("li",{className:"flex items-center justify-between p-2 rounded bg-black/10",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("span",{className:`inline-block w-2 h-2 rounded-full ${e.status==="online"?"bg-emerald-400":e.status==="ingame"?"bg-amber-400":"bg-slate-400"}`}),s.jsx("span",{children:e.username||e.email})]}),s.jsx("button",{className:"btn",disabled:u,onClick:()=>T(e.email),children:"Add"})]},e.email)),C.length===0&&s.jsx("li",{className:"text-xs opacity-60",children:"Type to search…"})]}),s.jsx("div",{className:"font-semibold mb-1 text-white/90",children:"Suggested"}),s.jsxs("ul",{className:"space-y-1 max-h-48 overflow-auto",children:[S.map(e=>s.jsxs("li",{className:"flex items-center justify-between p-2 rounded bg-black/10",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("span",{className:`inline-block w-2 h-2 rounded-full ${e.status==="online"?"bg-emerald-400":e.status==="ingame"?"bg-amber-400":"bg-slate-400"}`}),s.jsx("span",{children:e.username||e.email})]}),s.jsx("button",{className:"btn",disabled:u,onClick:()=>T(e.email),children:"Add"})]},e.email)),S.length===0&&s.jsx("li",{className:"text-xs opacity-60",children:"No suggestions right now."})]})]})]}),s.jsxs("div",{className:"p-3 rounded-xl bg-indigo-500/10 border border-indigo-500/40",children:[s.jsxs("div",{className:"flex items-center justify-between mb-2",children:[s.jsx("div",{className:"font-semibold",children:"Messages"}),s.jsx("button",{className:"btn px-3 py-1 text-sm",onClick:()=>f.markAllRead(),children:"Mark all read"})]}),f.inbox.length===0?s.jsx("div",{className:"text-sm opacity-70",children:"No messages yet."}):s.jsx("ul",{className:"space-y-2 max-h-72 overflow-auto",children:f.inbox.map(e=>s.jsxs("li",{className:"p-2 rounded bg-black/20 text-sm",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{children:[s.jsx("span",{className:"font-semibold",children:e.from})," ",s.jsxs("span",{className:"opacity-70 text-xs",children:["· ",new Date(e.ts).toLocaleString()]})]}),s.jsxs("div",{className:"flex gap-2",children:[s.jsx("button",{className:"btn px-2 py-1 text-xs",onClick:()=>b({show:!0,toUser:e.from,toEmail:e.from,replyTo:e.from}),children:"Reply"}),s.jsx("button",{className:"btn bg-slate-700 hover:bg-slate-800 px-2 py-1 text-xs",title:"Delete this message",onClick:()=>f.remove(e.id),children:"Delete"}),s.jsx("button",{className:"btn bg-rose-600 hover:bg-rose-700 px-2 py-1 text-xs",onClick:async()=>{const n=prompt("Report reason (what happened)?");if(n)try{await fetch("/api/friends/report",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({reporterEmail:a,offenderEmail:e.from,reason:n,messageId:e.id})}),t("Report sent to admin",{type:"info"})}catch{}},children:"Report"})]})]}),s.jsx("div",{className:"mt-1 whitespace-pre-wrap break-words",children:A(e.message)})]},e.id))})]}),w.show&&s.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50",children:s.jsxs("div",{className:"bg-slate-800 border border-slate-600 rounded-lg p-6 max-w-md w-full mx-4",children:[s.jsx("div",{className:"text-center mb-4",children:s.jsxs("h3",{className:"text-lg font-semibold text-white",children:["Type Message To ",w.toUser]})}),s.jsx("textarea",{className:"w-full h-32 bg-slate-700 border border-slate-600 rounded p-3 text-white placeholder-slate-400 resize-none",placeholder:"Type your message here...",id:"message-input",autoFocus:!0}),s.jsxs("div",{className:"flex gap-3 mt-4",children:[s.jsx("button",{className:"flex-1 btn bg-emerald-600 hover:bg-emerald-700",onClick:async()=>{const n=document.getElementById("message-input")?.value?.trim();if(n){i(!0);try{await fetch("/api/friends/message",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({fromEmail:a,toEmail:w.toEmail,message:n})}),t("Message sent",{type:"success"}),b({show:!1})}catch{t("Failed to send message",{type:"error"})}finally{i(!1)}}},disabled:u,children:"Send"}),s.jsx("button",{className:"flex-1 btn bg-slate-600 hover:bg-slate-700",onClick:()=>b({show:!1}),children:"Cancel"})]})]})})]})}export{G as default};
//# sourceMappingURL=Friends-M1KU-teV.js.map
