import{Z as $,_ as En,u as Re,$ as bo,a0 as Mn,a1 as Mt,a2 as mt,a3 as Ir,a4 as po,a5 as xo,a6 as Pn,a7 as ht,a8 as tn,a9 as Rr,a as Pt,j as a,aa as Qn,ab as jt,ac as It,ad as yo,i as Rt,ae as jn,af as wo,ag as Co,ah as vo,ai as So,aj as No}from"./index-CE3l0JJh.js";import{r as g}from"./ui-Cl5S-Tv0.js";import{g as ko}from"./vendor-D3F3s8fL.js";function Eo(e){const t=Array.from({length:7},()=>Array.from({length:7},()=>0)),s=[];for(let o=9;o>=0;o--)s.push(e>>o&1);for(let o=0;o<5;o++){const n=o+1,r=s[2*o]??0,d=s[2*o+1]??0;t[n][2]=r,t[n][4]=d}return t}const Mo=e=>!!e&&Number.isFinite(e.x)&&Number.isFinite(e.y),Po=e=>Array.isArray(e)&&e.length===9&&e.every(Number.isFinite);function jo(e,t){const s=e.getContext("2d",{willReadFrequently:!0});if(!s)return null;const o=e.width,n=e.height,r=160,d=r/o,i=Math.floor(n*d),y=new OffscreenCanvas(r,i).getContext("2d",{willReadFrequently:!0});if(!y)return null;y.drawImage(e,0,0,r,i);const k=y.getImageData(0,0,r,i).data,E=new Float32Array(r*i),S=8;for(let F=1;F<i-1;F++)for(let q=1;q<r-1;q++){const K=(F*r+q)*4,X=K-4,Z=K+4,oe=K-r*4,_=K+r*4,he=k[X]*.299+k[X+1]*.587+k[X+2]*.114,ie=k[Z]*.299+k[Z+1]*.587+k[Z+2]*.114,ce=k[oe]*.299+k[oe+1]*.587+k[oe+2]*.114,Te=k[_]*.299+k[_+1]*.587+k[_+2]*.114,Ie=ie-he,Le=Te-ce,qe=Math.sqrt(Ie*Ie+Le*Le);if(qe>S){const gt=Ie/qe,bt=Le/qe,W=r*.03,tt=r*.6;for(let De=W;De<tt;De+=1){const pt=Math.round(q+gt*De),xt=Math.round(F+bt*De);pt>=0&&pt<r&&xt>=0&&xt<i&&E[xt*r+pt]++;const Je=Math.round(q-gt*De),yt=Math.round(F-bt*De);Je>=0&&Je<r&&yt>=0&&yt<i&&E[yt*r+Je]++}}}const R=new Float32Array(r*i),O=2;for(let F=O;F<i-O;F++)for(let q=O;q<r-O;q++){let K=0;for(let X=-O;X<=O;X++)for(let Z=-O;Z<=O;Z++)K+=E[(F+X)*r+(q+Z)];R[F*r+q]=K}let B=0,N=r/2,D=i/2;const I=5;for(let F=I;F<i-I;F++)for(let q=I;q<r-I;q++){const K=R[F*r+q];K>B&&(B=K,N=q,D=F)}let M=N/d,A=D/d;t&&Number.isFinite(t.x)&&Number.isFinite(t.y)&&(M=.7*t.x+.3*M,A=.7*t.y+.3*A),console.log(`[findDartboardRings] Voting Peak: (${Math.round(M)}, ${Math.round(A)}) Votes=${B}`);const m=400,w=m/o,p=Math.floor(n*w),j=new OffscreenCanvas(m,p).getContext("2d");if(!j)return null;j.drawImage(e,0,0,m,p);const h=j.getImageData(0,0,m,p).data,T=new Float32Array(m*p),x=new Float32Array(m*p);for(let F=1;F<p-1;F++)for(let q=1;q<m-1;q++){const K=(F*m+q)*4;h[K]*.299+h[K+1]*.587+h[K+2]*.114;const X=K-4,Z=K+4,oe=K-m*4,_=K+m*4,he=h[X]*.299+h[X+1]*.587+h[X+2]*.114,ie=h[Z]*.299+h[Z+1]*.587+h[Z+2]*.114,ce=h[oe]*.299+h[oe+1]*.587+h[oe+2]*.114,Te=h[_]*.299+h[_+1]*.587+h[_+2]*.114,Ie=ie-he,Le=Te-ce;T[F*m+q]=Ie,x[F*m+q]=Le}const L=s.getImageData(0,0,o,n).data,J=(F,q)=>{const K=Math.max(0,Math.min(o-1,Math.round(F))),Z=(Math.max(0,Math.min(n-1,Math.round(q)))*o+K)*4;return .299*L[Z]+.587*L[Z+1]+.114*L[Z+2]},me=60,te={};for(let F=0;F<me;F++){const q=F/me*Math.PI*2,K=Math.cos(q),X=Math.sin(q),Z=[];for(let _=30;_<Math.min(o,n)/2;_+=1){const he=M+(_-2)*K,ie=A+(_-2)*X,ce=M+(_+2)*K,Te=A+(_+2)*X,Ie=J(he,ie),Le=J(ce,Te),qe=Math.abs(Le-Ie);qe>2&&_>20&&Z.push({r:_,grad:qe})}const oe=[];for(let _=0;_<Z.length;_++){const he=_>0?Z[_-1].grad:0,ie=Z[_].grad,ce=_<Z.length-1?Z[_+1].grad:0;ie>he&&ie>ce&&ie>2&&oe.push(Z[_].r)}oe.length>0&&oe.forEach(_=>{const he=Object.keys(te).map(ce=>({key:parseInt(ce),median:te[parseInt(ce)][Math.floor(te[parseInt(ce)].length/2)]})).filter(ce=>Math.abs(ce.median-_)<15).sort((ce,Te)=>Math.abs(ce.median-_)-Math.abs(Te.median-_))[0],ie=he?he.key:Math.max(-1,...Object.keys(te).map(ce=>parseInt(ce)))+1;te[ie]||(te[ie]=[]),te[ie].push(_)})}const xe=Object.keys(te).map(F=>{const q=te[parseInt(F)].sort((X,Z)=>X-Z),K=q[Math.floor(q.length/2)];return{tier:parseInt(F),radius:K,samples:q.length}}).sort((F,q)=>F.radius-q.radius);console.log("[findDartboardRings] Detected ring tiers:",xe);const Q=[...xe];if(Q.length>=2){const F=Q[Q.length-1].radius,q=Q[Q.length-2].radius,K=F/q;(K>1.15&&Q.length>=5||K>1.3)&&(console.log(`[findDartboardRings] Ignoring outermost ring (likely light ring/surround): ${F.toFixed(1)}px (ratio ${K.toFixed(2)} to ${q.toFixed(1)}px)`),Q.pop())}const we=Q.length>0?Q[Q.length-1].radius:Math.min(o,n)*.3;let ke=50+Q.length*6;return Q.length>=7?ke=98:Q.length===6?ke=96:Q.length===5&&(ke=94),{cx:M,cy:A,r:we,confidence:ke,ringCount:Q.length,ringStrength:Q.length>0?Q[Q.length-1].radius:0,detectedRings:Q.map(F=>F.radius)}}function Io(e,t,s,o){const n=e.getContext("2d");if(!n)return null;const r=e.width,d=e.height,i=720,u=o,y=new Array(i).fill(0),P=Math.max(2,Math.round(u-8)),k=Math.round(u+8),E=n.getImageData(0,0,r,d).data,S=(m,w)=>{const p=Math.round(m),C=Math.round(w);if(p<0||p>=r||C<0||C>=d)return 127;const j=(C*r+p)*4;return E[j]*.299+E[j+1]*.587+E[j+2]*.114};for(let m=0;m<i;m++){const w=m/i*Math.PI*2;let p=0,C=S(t+P*Math.cos(w),s+P*Math.sin(w));for(let j=P+1;j<=k;j++){const h=S(t+j*Math.cos(w),s+j*Math.sin(w)),T=Math.abs(h-C);T>p&&(p=T),C=h}y[m]=p}const R=[];for(let m=0;m<i;m++){const w=y[(m-1+i)%i],p=y[m],C=y[(m+1)%i];p>w&&p>C&&p>10&&R.push(m)}if(R.length<16){const m=y.map((w,p)=>{let C=0,j=0;for(let h=-2;h<=2;h++)C+=y[(p+h+i)%i],j++;return C/j});for(let w=0;w<i;w++){const p=m[(w-1+i)%i],C=m[w],j=m[(w+1)%i];C>p&&C>j&&C>8&&R.push(w)}}if(R.length===0)return 0;const O=R.map(m=>m/i*Math.PI*2);O.sort((m,w)=>m-w);const B=[];for(let m=0;m<O.length;m++){const w=O[m],C=(O[(m+1)%O.length]-w+Math.PI*2)%(Math.PI*2);B.push((w+C/2)%(Math.PI*2))}const N=20,D=new Array(N).fill(0).map((m,w)=>-Math.PI/2+w*(Math.PI*2/N));let I=0,M=1/0;for(let m=0;m<B.length;m++){let w=0;for(let p=0;p<Math.min(N,B.length);p++){const C=B[(p+m)%B.length],j=D[p],h=Math.abs((C-j+Math.PI)%(Math.PI*2)-Math.PI);w+=h*h}w<M&&(M=w,I=(B[m]-D[0]+Math.PI*2)%(Math.PI*2))}return(I+Math.PI)%(Math.PI*2)-Math.PI}function Ro(e,t){const s=e.getContext("2d");if(!s)return t;const o=e.width,n=e.height,d=s.getImageData(0,0,o,n).data,i=(N,D)=>{const I=Math.max(0,Math.min(o-1,Math.round(N))),A=(Math.max(0,Math.min(n-1,Math.round(D)))*o+I)*4;return .299*d[A]+.587*d[A+1]+.114*d[A+2]},u=(N,D)=>{const I=i(N+1,D)-i(N-1,D),M=i(N,D+1)-i(N,D-1);return{gx:I,gy:M}},y=mt(t,{x:0,y:0}),P=N=>{const D=[$.trebleOuter,$.doubleOuter];let I=0;for(const M of D){const A=ht(N,M,180);for(let m=0;m<A.length;m++){const w=A[m],p=u(w.x,w.y),C=w.x-y.x,j=w.y-y.y,h=Math.hypot(C,j)||1,T=C/h,x=j/h;I+=Math.abs(p.gx*T+p.gy*x)}}return I/180/2};let k=t,E=P(t);const S=N=>N*Math.PI/180,R=[-4,-2,-1,-.5,0,.5,1,2,4],O=[-3,-2,-1,0,1,2,3],B=[.98,.99,1,1.01,1.02];for(const N of R){const D=xo(t,S(N));for(const I of O)for(const M of O){const A=Ir(D,I,M);for(const m of B){const w=Pn(A,m,m),p=P(w);p>E&&(E=p,k=w)}}}return k}function Xn(e,t){try{const s=e.width,o=e.height,n=s/2,r=o/2;let d=e;if(t?.colorAssist)try{const m=((h,T)=>{try{return new OffscreenCanvas(h,T)}catch{const x=document.createElement("canvas");return x.width=h,x.height=T,x}})(s,o),w=m.getContext("2d");if(!w)throw new Error("Could not get 2D context");w.drawImage(e,0,0,s,o);const p=w.getImageData(0,0,s,o),C=p.data,j=(h,T,x)=>{const L=h/255,J=T/255,me=x/255,te=Math.max(L,J,me),xe=Math.min(L,J,me),Q=te-xe;let we=0;Q!==0&&(te===L?we=(J-me)/Q%6:te===J?we=(me-L)/Q+2:we=(L-J)/Q+4,we*=60,we<0&&(we+=360));const ke=te===0?0:Q/te;return{h:we,s:ke,v:te}};for(let h=0;h<C.length;h+=4){const T=C[h],x=C[h+1],L=C[h+2],{h:J,s:me,v:te}=j(T,x,L),xe=me>.25&&te>.2&&(J<20||J>340||J>340&&J<=360),Q=me>.25&&te>.2&&J>=80&&J<=160;xe||Q?(C[h]=Math.min(255,T*1.2),C[h+1]=Math.min(255,x*1.2),C[h+2]=Math.min(255,L*1.2)):C[h]=C[h+1]=C[h+2]=0}w.putImageData(p,0,0),d=m}catch{d=e}const i=jo(d,t?.centerHint);if(!i)return{success:!1,cx:n,cy:r,bullInner:0,bullOuter:0,trebleInner:0,trebleOuter:0,doubleInner:0,doubleOuter:0,confidence:0,homography:null,errorPx:null,calibrationPoints:[],message:"No dartboard detected. Ensure board is clearly visible with good contrast between rings and background."};const u=(()=>{const A=i.detectedRings||[];if(A.length>=6)return{cx:i.cx,cy:i.cy,bullInner:A[0],bullOuter:A[1],trebleInner:A[2],trebleOuter:A[3],doubleInner:A[4],doubleOuter:A[5]};{const m=i.r/$.doubleOuter;return{cx:i.cx,cy:i.cy,bullInner:$.bullInner*m,bullOuter:$.bullOuter*m,trebleInner:$.trebleInner*m,trebleOuter:$.trebleOuter*m,doubleInner:$.doubleInner*m,doubleOuter:i.r}}})(),y=Io(e,u.cx,u.cy,u.doubleOuter)||0,P=En("outer"),k=P.map(A=>{if(A.x===0&&A.y===0)return{x:u.cx,y:u.cy};const m=Math.cos(y),w=Math.sin(y),p=u.doubleOuter/$.doubleOuter,C=A.x*p,j=A.y*p;return{x:u.cx+(C*m-j*w),y:u.cy+(C*w+j*m)}});let E=null,S=null,R=i.confidence,O=1;try{let A=!0;try{A=!!Re.getState?.()?.calibrationUseRansac}catch{}if(A){const p=bo(P,k,{thresholdPx:8,maxIter:300});p.H?(E=p.H,S=p.errorPx,O=p.inliers.filter(Boolean).length/k.length,R=Math.max(R,Math.round(R*.6+O*40))):(E=Mn(P,k),S=Mt(E,P,k))}else E=Mn(P,k),S=Mt(E,P,k);if(E&&(E=Ro(e,E),S=Mt(E,P,k)),E){const p=mt(E,{x:0,y:0}),C=u.cx-p.x,j=u.cy-p.y;Math.hypot(C,j)>.25&&(E=Ir(E,C,j),S=Mt(E,P,k))}const w=po(typeof S=="number"?S:null);typeof w=="number"?R=w:R=Math.max(O*100,i.confidence)}catch{R=Math.max(65,i.confidence)}const B=k.every(Mo),N=Po(E),D=!!N&&B&&R>50,I=i.ringCount??0,M={success:D,cx:u.cx,cy:u.cy,bullInner:u.bullInner,bullOuter:u.bullOuter,trebleInner:u.trebleInner,trebleOuter:u.trebleOuter,doubleInner:u.doubleInner,doubleOuter:u.doubleOuter,confidence:Math.round(R),homography:N?E:null,errorPx:N?S:null,calibrationPoints:B?k:[],theta:typeof y=="number"?y:void 0,message:!B||!N?`âŒ Detection produced unstable calibration data. Adjust camera framing or calibrate manually. (rings: ${I}, r:${Math.round(i.r)})`:R>85?`âœ… Excellent detection (rings: ${I}, r:${Math.round(i.r)})`:`âœ… Board detected - may need angle adjustment (rings: ${I}, r:${Math.round(i.r)})`};return console.log("[detectBoard] Final result:",{success:M.success,confidence:M.confidence,homographyValid:N,pointsValid:B,cx:Math.round(M.cx),cy:Math.round(M.cy),doubleOuter:Math.round(M.doubleOuter),rings:I,errorPx:M.errorPx?M.errorPx.toFixed(2):null,calibrationPoints:k.map(A=>({x:Math.round(A.x),y:Math.round(A.y)}))},M.message),M}catch(s){return{success:!1,cx:e.width/2,cy:e.height/2,bullInner:0,bullOuter:0,trebleInner:0,trebleOuter:0,doubleInner:0,doubleOuter:0,confidence:0,homography:null,errorPx:null,calibrationPoints:[],message:s instanceof Error?s.message:"Board detection failed"}}}async function To(){const e=[];try{const t=await Do();for(const s of t){const o=await Ao(s,[80,8080,8787,8788,3e3,5e3]);for(const n of o){const r=await Lo(n.ip,n.port);r&&e.push(r)}}}catch(t){console.error("Network discovery failed:",t)}return e}async function Do(){const e=[];try{const t=new RTCPeerConnection({iceServers:[]});t.createDataChannel("");const s=await t.createOffer();return await t.setLocalDescription(s),new Promise(o=>{const n=setTimeout(()=>{t.close(),o(e)},5e3);t.onicecandidate=r=>{if(r.candidate){const i=r.candidate.candidate.match(/(\d+\.\d+\.\d+\.\d+)/);if(i&&i[1]&&!e.includes(i[1])){const u=i[1];Oo(u)&&e.push(u)}}else clearTimeout(n),t.close(),o(e)}})}catch(t){return console.error("Failed to get local IPs:",t),["192.168.1.0"]}}function Oo(e){const t=e.split(".").map(Number);return t[0]===10||t[0]===172&&t[1]>=16&&t[1]<=31||t[0]===192&&t[1]===168}async function Ao(e,t){const s=[],o=e.split(".").slice(0,3).join("."),n=[];for(let d=1;d<=254;d++){const i=`${o}.${d}`;for(const u of t)n.push(Bo(i,u))}return(await Promise.allSettled(n)).forEach((d,i)=>{if(d.status==="fulfilled"&&d.value){const u=i%t.length,y=Math.floor(i/t.length),P=`${o}.${y+1}`;s.push({ip:P,port:t[u]})}}),s}async function Bo(e,t){try{return await fetch(`http://${e}:${t}/`,{method:"HEAD",mode:"no-cors",signal:AbortSignal.timeout(2e3)}),!0}catch{return!1}}async function Lo(e,t){try{const s=["/","/api/info","/api/status","/camera","/stream"];for(const o of s)try{const n=await fetch(`http://${e}:${t}${o}`,{method:"GET",signal:AbortSignal.timeout(3e3)});if(n.ok){const r=n.headers.get("content-type")||"",d=await n.text();if(d.includes("OMNI")||d.includes("omni")||o.includes("omni"))return{id:`omni-${e}-${t}`,name:`OMNI Camera (${e})`,ip:e,port:t,type:"omni",capabilities:["video","calibration"],status:"online",connectionType:"wifi"};if(d.includes("VERT")||d.includes("vert")||o.includes("vert"))return{id:`vert-${e}-${t}`,name:`VERT Camera (${e})`,ip:e,port:t,type:"vert",capabilities:["video","calibration"],status:"online",connectionType:"wifi"};if(r.includes("video")||d.includes("stream")||o==="/stream")return{id:`generic-${e}-${t}`,name:`Network Camera (${e})`,ip:e,port:t,type:"generic",capabilities:["video"],status:"online",connectionType:"wifi"}}}catch{}}catch(s){console.error(`Failed to probe device ${e}:${t}:`,s)}return null}async function Fo(e){try{const t=`http://${e.ip}:${e.port}/stream`,s=document.createElement("video");return s.src=t,s.crossOrigin="anonymous",new Promise((o,n)=>{s.onloadeddata=()=>{const r=document.createElement("canvas"),d=r.getContext("2d");r.width=s.videoWidth,r.height=s.videoHeight;const i=r.captureStream(30),u=()=>{s.readyState>=2&&d.drawImage(s,0,0),requestAnimationFrame(u)};u(),o(i)},s.onerror=()=>n(new Error("Failed to load video stream")),s.load()})}catch(t){return console.error("Failed to connect to network device:",t),null}}var et={},nn,Zn;function Uo(){return Zn||(Zn=1,nn=function(){return typeof Promise=="function"&&Promise.prototype&&Promise.prototype.then}),nn}var rn={},ze={},er;function Ve(){if(er)return ze;er=1;let e;const t=[0,26,44,70,100,134,172,196,242,292,346,404,466,532,581,655,733,815,901,991,1085,1156,1258,1364,1474,1588,1706,1828,1921,2051,2185,2323,2465,2611,2761,2876,3034,3196,3362,3532,3706];return ze.getSymbolSize=function(o){if(!o)throw new Error('"version" cannot be null or undefined');if(o<1||o>40)throw new Error('"version" should be in range from 1 to 40');return o*4+17},ze.getSymbolTotalCodewords=function(o){return t[o]},ze.getBCHDigit=function(s){let o=0;for(;s!==0;)o++,s>>>=1;return o},ze.setToSJISFunction=function(o){if(typeof o!="function")throw new Error('"toSJISFunc" is not a valid function.');e=o},ze.isKanjiModeEnabled=function(){return typeof e<"u"},ze.toSJIS=function(o){return e(o)},ze}var on={},tr;function In(){return tr||(tr=1,(function(e){e.L={bit:1},e.M={bit:0},e.Q={bit:3},e.H={bit:2};function t(s){if(typeof s!="string")throw new Error("Param is not a string");switch(s.toLowerCase()){case"l":case"low":return e.L;case"m":case"medium":return e.M;case"q":case"quartile":return e.Q;case"h":case"high":return e.H;default:throw new Error("Unknown EC Level: "+s)}}e.isValid=function(o){return o&&typeof o.bit<"u"&&o.bit>=0&&o.bit<4},e.from=function(o,n){if(e.isValid(o))return o;try{return t(o)}catch{return n}}})(on)),on}var an,nr;function _o(){if(nr)return an;nr=1;function e(){this.buffer=[],this.length=0}return e.prototype={get:function(t){const s=Math.floor(t/8);return(this.buffer[s]>>>7-t%8&1)===1},put:function(t,s){for(let o=0;o<s;o++)this.putBit((t>>>s-o-1&1)===1)},getLengthInBits:function(){return this.length},putBit:function(t){const s=Math.floor(this.length/8);this.buffer.length<=s&&this.buffer.push(0),t&&(this.buffer[s]|=128>>>this.length%8),this.length++}},an=e,an}var sn,rr;function $o(){if(rr)return sn;rr=1;function e(t){if(!t||t<1)throw new Error("BitMatrix size must be defined and greater than 0");this.size=t,this.data=new Uint8Array(t*t),this.reservedBit=new Uint8Array(t*t)}return e.prototype.set=function(t,s,o,n){const r=t*this.size+s;this.data[r]=o,n&&(this.reservedBit[r]=!0)},e.prototype.get=function(t,s){return this.data[t*this.size+s]},e.prototype.xor=function(t,s,o){this.data[t*this.size+s]^=o},e.prototype.isReserved=function(t,s){return this.reservedBit[t*this.size+s]},sn=e,sn}var cn={},or;function qo(){return or||(or=1,(function(e){const t=Ve().getSymbolSize;e.getRowColCoords=function(o){if(o===1)return[];const n=Math.floor(o/7)+2,r=t(o),d=r===145?26:Math.ceil((r-13)/(2*n-2))*2,i=[r-7];for(let u=1;u<n-1;u++)i[u]=i[u-1]-d;return i.push(6),i.reverse()},e.getPositions=function(o){const n=[],r=e.getRowColCoords(o),d=r.length;for(let i=0;i<d;i++)for(let u=0;u<d;u++)i===0&&u===0||i===0&&u===d-1||i===d-1&&u===0||n.push([r[i],r[u]]);return n}})(cn)),cn}var ln={},ar;function Wo(){if(ar)return ln;ar=1;const e=Ve().getSymbolSize,t=7;return ln.getPositions=function(o){const n=e(o);return[[0,0],[n-t,0],[0,n-t]]},ln}var dn={},sr;function Ho(){return sr||(sr=1,(function(e){e.Patterns={PATTERN000:0,PATTERN001:1,PATTERN010:2,PATTERN011:3,PATTERN100:4,PATTERN101:5,PATTERN110:6,PATTERN111:7};const t={N1:3,N2:3,N3:40,N4:10};e.isValid=function(n){return n!=null&&n!==""&&!isNaN(n)&&n>=0&&n<=7},e.from=function(n){return e.isValid(n)?parseInt(n,10):void 0},e.getPenaltyN1=function(n){const r=n.size;let d=0,i=0,u=0,y=null,P=null;for(let k=0;k<r;k++){i=u=0,y=P=null;for(let E=0;E<r;E++){let S=n.get(k,E);S===y?i++:(i>=5&&(d+=t.N1+(i-5)),y=S,i=1),S=n.get(E,k),S===P?u++:(u>=5&&(d+=t.N1+(u-5)),P=S,u=1)}i>=5&&(d+=t.N1+(i-5)),u>=5&&(d+=t.N1+(u-5))}return d},e.getPenaltyN2=function(n){const r=n.size;let d=0;for(let i=0;i<r-1;i++)for(let u=0;u<r-1;u++){const y=n.get(i,u)+n.get(i,u+1)+n.get(i+1,u)+n.get(i+1,u+1);(y===4||y===0)&&d++}return d*t.N2},e.getPenaltyN3=function(n){const r=n.size;let d=0,i=0,u=0;for(let y=0;y<r;y++){i=u=0;for(let P=0;P<r;P++)i=i<<1&2047|n.get(y,P),P>=10&&(i===1488||i===93)&&d++,u=u<<1&2047|n.get(P,y),P>=10&&(u===1488||u===93)&&d++}return d*t.N3},e.getPenaltyN4=function(n){let r=0;const d=n.data.length;for(let u=0;u<d;u++)r+=n.data[u];return Math.abs(Math.ceil(r*100/d/5)-10)*t.N4};function s(o,n,r){switch(o){case e.Patterns.PATTERN000:return(n+r)%2===0;case e.Patterns.PATTERN001:return n%2===0;case e.Patterns.PATTERN010:return r%3===0;case e.Patterns.PATTERN011:return(n+r)%3===0;case e.Patterns.PATTERN100:return(Math.floor(n/2)+Math.floor(r/3))%2===0;case e.Patterns.PATTERN101:return n*r%2+n*r%3===0;case e.Patterns.PATTERN110:return(n*r%2+n*r%3)%2===0;case e.Patterns.PATTERN111:return(n*r%3+(n+r)%2)%2===0;default:throw new Error("bad maskPattern:"+o)}}e.applyMask=function(n,r){const d=r.size;for(let i=0;i<d;i++)for(let u=0;u<d;u++)r.isReserved(u,i)||r.xor(u,i,s(n,u,i))},e.getBestMask=function(n,r){const d=Object.keys(e.Patterns).length;let i=0,u=1/0;for(let y=0;y<d;y++){r(y),e.applyMask(y,n);const P=e.getPenaltyN1(n)+e.getPenaltyN2(n)+e.getPenaltyN3(n)+e.getPenaltyN4(n);e.applyMask(y,n),P<u&&(u=P,i=y)}return i}})(dn)),dn}var Tt={},ir;function Tr(){if(ir)return Tt;ir=1;const e=In(),t=[1,1,1,1,1,1,1,1,1,1,2,2,1,2,2,4,1,2,4,4,2,4,4,4,2,4,6,5,2,4,6,6,2,5,8,8,4,5,8,8,4,5,8,11,4,8,10,11,4,9,12,16,4,9,16,16,6,10,12,18,6,10,17,16,6,11,16,19,6,13,18,21,7,14,21,25,8,16,20,25,8,17,23,25,9,17,23,34,9,18,25,30,10,20,27,32,12,21,29,35,12,23,34,37,12,25,34,40,13,26,35,42,14,28,38,45,15,29,40,48,16,31,43,51,17,33,45,54,18,35,48,57,19,37,51,60,19,38,53,63,20,40,56,66,21,43,59,70,22,45,62,74,24,47,65,77,25,49,68,81],s=[7,10,13,17,10,16,22,28,15,26,36,44,20,36,52,64,26,48,72,88,36,64,96,112,40,72,108,130,48,88,132,156,60,110,160,192,72,130,192,224,80,150,224,264,96,176,260,308,104,198,288,352,120,216,320,384,132,240,360,432,144,280,408,480,168,308,448,532,180,338,504,588,196,364,546,650,224,416,600,700,224,442,644,750,252,476,690,816,270,504,750,900,300,560,810,960,312,588,870,1050,336,644,952,1110,360,700,1020,1200,390,728,1050,1260,420,784,1140,1350,450,812,1200,1440,480,868,1290,1530,510,924,1350,1620,540,980,1440,1710,570,1036,1530,1800,570,1064,1590,1890,600,1120,1680,1980,630,1204,1770,2100,660,1260,1860,2220,720,1316,1950,2310,750,1372,2040,2430];return Tt.getBlocksCount=function(n,r){switch(r){case e.L:return t[(n-1)*4+0];case e.M:return t[(n-1)*4+1];case e.Q:return t[(n-1)*4+2];case e.H:return t[(n-1)*4+3];default:return}},Tt.getTotalCodewordsCount=function(n,r){switch(r){case e.L:return s[(n-1)*4+0];case e.M:return s[(n-1)*4+1];case e.Q:return s[(n-1)*4+2];case e.H:return s[(n-1)*4+3];default:return}},Tt}var un={},ft={},cr;function zo(){if(cr)return ft;cr=1;const e=new Uint8Array(512),t=new Uint8Array(256);return(function(){let o=1;for(let n=0;n<255;n++)e[n]=o,t[o]=n,o<<=1,o&256&&(o^=285);for(let n=255;n<512;n++)e[n]=e[n-255]})(),ft.log=function(o){if(o<1)throw new Error("log("+o+")");return t[o]},ft.exp=function(o){return e[o]},ft.mul=function(o,n){return o===0||n===0?0:e[t[o]+t[n]]},ft}var lr;function Vo(){return lr||(lr=1,(function(e){const t=zo();e.mul=function(o,n){const r=new Uint8Array(o.length+n.length-1);for(let d=0;d<o.length;d++)for(let i=0;i<n.length;i++)r[d+i]^=t.mul(o[d],n[i]);return r},e.mod=function(o,n){let r=new Uint8Array(o);for(;r.length-n.length>=0;){const d=r[0];for(let u=0;u<n.length;u++)r[u]^=t.mul(n[u],d);let i=0;for(;i<r.length&&r[i]===0;)i++;r=r.slice(i)}return r},e.generateECPolynomial=function(o){let n=new Uint8Array([1]);for(let r=0;r<o;r++)n=e.mul(n,new Uint8Array([1,t.exp(r)]));return n}})(un)),un}var fn,dr;function Go(){if(dr)return fn;dr=1;const e=Vo();function t(s){this.genPoly=void 0,this.degree=s,this.degree&&this.initialize(this.degree)}return t.prototype.initialize=function(o){this.degree=o,this.genPoly=e.generateECPolynomial(this.degree)},t.prototype.encode=function(o){if(!this.genPoly)throw new Error("Encoder not initialized");const n=new Uint8Array(o.length+this.degree);n.set(o);const r=e.mod(n,this.genPoly),d=this.degree-r.length;if(d>0){const i=new Uint8Array(this.degree);return i.set(r,d),i}return r},fn=t,fn}var hn={},mn={},gn={},ur;function Dr(){return ur||(ur=1,gn.isValid=function(t){return!isNaN(t)&&t>=1&&t<=40}),gn}var Be={},fr;function Or(){if(fr)return Be;fr=1;const e="[0-9]+",t="[A-Z $%*+\\-./:]+";let s="(?:[u3000-u303F]|[u3040-u309F]|[u30A0-u30FF]|[uFF00-uFFEF]|[u4E00-u9FAF]|[u2605-u2606]|[u2190-u2195]|u203B|[u2010u2015u2018u2019u2025u2026u201Cu201Du2225u2260]|[u0391-u0451]|[u00A7u00A8u00B1u00B4u00D7u00F7])+";s=s.replace(/u/g,"\\u");const o="(?:(?![A-Z0-9 $%*+\\-./:]|"+s+`)(?:.|[\r
]))+`;Be.KANJI=new RegExp(s,"g"),Be.BYTE_KANJI=new RegExp("[^A-Z0-9 $%*+\\-./:]+","g"),Be.BYTE=new RegExp(o,"g"),Be.NUMERIC=new RegExp(e,"g"),Be.ALPHANUMERIC=new RegExp(t,"g");const n=new RegExp("^"+s+"$"),r=new RegExp("^"+e+"$"),d=new RegExp("^[A-Z0-9 $%*+\\-./:]+$");return Be.testKanji=function(u){return n.test(u)},Be.testNumeric=function(u){return r.test(u)},Be.testAlphanumeric=function(u){return d.test(u)},Be}var hr;function Ge(){return hr||(hr=1,(function(e){const t=Dr(),s=Or();e.NUMERIC={id:"Numeric",bit:1,ccBits:[10,12,14]},e.ALPHANUMERIC={id:"Alphanumeric",bit:2,ccBits:[9,11,13]},e.BYTE={id:"Byte",bit:4,ccBits:[8,16,16]},e.KANJI={id:"Kanji",bit:8,ccBits:[8,10,12]},e.MIXED={bit:-1},e.getCharCountIndicator=function(r,d){if(!r.ccBits)throw new Error("Invalid mode: "+r);if(!t.isValid(d))throw new Error("Invalid version: "+d);return d>=1&&d<10?r.ccBits[0]:d<27?r.ccBits[1]:r.ccBits[2]},e.getBestModeForData=function(r){return s.testNumeric(r)?e.NUMERIC:s.testAlphanumeric(r)?e.ALPHANUMERIC:s.testKanji(r)?e.KANJI:e.BYTE},e.toString=function(r){if(r&&r.id)return r.id;throw new Error("Invalid mode")},e.isValid=function(r){return r&&r.bit&&r.ccBits};function o(n){if(typeof n!="string")throw new Error("Param is not a string");switch(n.toLowerCase()){case"numeric":return e.NUMERIC;case"alphanumeric":return e.ALPHANUMERIC;case"kanji":return e.KANJI;case"byte":return e.BYTE;default:throw new Error("Unknown mode: "+n)}}e.from=function(r,d){if(e.isValid(r))return r;try{return o(r)}catch{return d}}})(mn)),mn}var mr;function Jo(){return mr||(mr=1,(function(e){const t=Ve(),s=Tr(),o=In(),n=Ge(),r=Dr(),d=7973,i=t.getBCHDigit(d);function u(E,S,R){for(let O=1;O<=40;O++)if(S<=e.getCapacity(O,R,E))return O}function y(E,S){return n.getCharCountIndicator(E,S)+4}function P(E,S){let R=0;return E.forEach(function(O){const B=y(O.mode,S);R+=B+O.getBitsLength()}),R}function k(E,S){for(let R=1;R<=40;R++)if(P(E,R)<=e.getCapacity(R,S,n.MIXED))return R}e.from=function(S,R){return r.isValid(S)?parseInt(S,10):R},e.getCapacity=function(S,R,O){if(!r.isValid(S))throw new Error("Invalid QR Code version");typeof O>"u"&&(O=n.BYTE);const B=t.getSymbolTotalCodewords(S),N=s.getTotalCodewordsCount(S,R),D=(B-N)*8;if(O===n.MIXED)return D;const I=D-y(O,S);switch(O){case n.NUMERIC:return Math.floor(I/10*3);case n.ALPHANUMERIC:return Math.floor(I/11*2);case n.KANJI:return Math.floor(I/13);case n.BYTE:default:return Math.floor(I/8)}},e.getBestVersionForData=function(S,R){let O;const B=o.from(R,o.M);if(Array.isArray(S)){if(S.length>1)return k(S,B);if(S.length===0)return 1;O=S[0]}else O=S;return u(O.mode,O.getLength(),B)},e.getEncodedBits=function(S){if(!r.isValid(S)||S<7)throw new Error("Invalid QR Code version");let R=S<<12;for(;t.getBCHDigit(R)-i>=0;)R^=d<<t.getBCHDigit(R)-i;return S<<12|R}})(hn)),hn}var bn={},gr;function Ko(){if(gr)return bn;gr=1;const e=Ve(),t=1335,s=21522,o=e.getBCHDigit(t);return bn.getEncodedBits=function(r,d){const i=r.bit<<3|d;let u=i<<10;for(;e.getBCHDigit(u)-o>=0;)u^=t<<e.getBCHDigit(u)-o;return(i<<10|u)^s},bn}var pn={},xn,br;function Yo(){if(br)return xn;br=1;const e=Ge();function t(s){this.mode=e.NUMERIC,this.data=s.toString()}return t.getBitsLength=function(o){return 10*Math.floor(o/3)+(o%3?o%3*3+1:0)},t.prototype.getLength=function(){return this.data.length},t.prototype.getBitsLength=function(){return t.getBitsLength(this.data.length)},t.prototype.write=function(o){let n,r,d;for(n=0;n+3<=this.data.length;n+=3)r=this.data.substr(n,3),d=parseInt(r,10),o.put(d,10);const i=this.data.length-n;i>0&&(r=this.data.substr(n),d=parseInt(r,10),o.put(d,i*3+1))},xn=t,xn}var yn,pr;function Qo(){if(pr)return yn;pr=1;const e=Ge(),t=["0","1","2","3","4","5","6","7","8","9","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z"," ","$","%","*","+","-",".","/",":"];function s(o){this.mode=e.ALPHANUMERIC,this.data=o}return s.getBitsLength=function(n){return 11*Math.floor(n/2)+6*(n%2)},s.prototype.getLength=function(){return this.data.length},s.prototype.getBitsLength=function(){return s.getBitsLength(this.data.length)},s.prototype.write=function(n){let r;for(r=0;r+2<=this.data.length;r+=2){let d=t.indexOf(this.data[r])*45;d+=t.indexOf(this.data[r+1]),n.put(d,11)}this.data.length%2&&n.put(t.indexOf(this.data[r]),6)},yn=s,yn}var wn,xr;function Xo(){if(xr)return wn;xr=1;const e=Ge();function t(s){this.mode=e.BYTE,typeof s=="string"?this.data=new TextEncoder().encode(s):this.data=new Uint8Array(s)}return t.getBitsLength=function(o){return o*8},t.prototype.getLength=function(){return this.data.length},t.prototype.getBitsLength=function(){return t.getBitsLength(this.data.length)},t.prototype.write=function(s){for(let o=0,n=this.data.length;o<n;o++)s.put(this.data[o],8)},wn=t,wn}var Cn,yr;function Zo(){if(yr)return Cn;yr=1;const e=Ge(),t=Ve();function s(o){this.mode=e.KANJI,this.data=o}return s.getBitsLength=function(n){return n*13},s.prototype.getLength=function(){return this.data.length},s.prototype.getBitsLength=function(){return s.getBitsLength(this.data.length)},s.prototype.write=function(o){let n;for(n=0;n<this.data.length;n++){let r=t.toSJIS(this.data[n]);if(r>=33088&&r<=40956)r-=33088;else if(r>=57408&&r<=60351)r-=49472;else throw new Error("Invalid SJIS character: "+this.data[n]+`
Make sure your charset is UTF-8`);r=(r>>>8&255)*192+(r&255),o.put(r,13)}},Cn=s,Cn}var vn={exports:{}},wr;function ea(){return wr||(wr=1,(function(e){var t={single_source_shortest_paths:function(s,o,n){var r={},d={};d[o]=0;var i=t.PriorityQueue.make();i.push(o,0);for(var u,y,P,k,E,S,R,O,B;!i.empty();){u=i.pop(),y=u.value,k=u.cost,E=s[y]||{};for(P in E)E.hasOwnProperty(P)&&(S=E[P],R=k+S,O=d[P],B=typeof d[P]>"u",(B||O>R)&&(d[P]=R,i.push(P,R),r[P]=y))}if(typeof n<"u"&&typeof d[n]>"u"){var N=["Could not find a path from ",o," to ",n,"."].join("");throw new Error(N)}return r},extract_shortest_path_from_predecessor_list:function(s,o){for(var n=[],r=o;r;)n.push(r),s[r],r=s[r];return n.reverse(),n},find_path:function(s,o,n){var r=t.single_source_shortest_paths(s,o,n);return t.extract_shortest_path_from_predecessor_list(r,n)},PriorityQueue:{make:function(s){var o=t.PriorityQueue,n={},r;s=s||{};for(r in o)o.hasOwnProperty(r)&&(n[r]=o[r]);return n.queue=[],n.sorter=s.sorter||o.default_sorter,n},default_sorter:function(s,o){return s.cost-o.cost},push:function(s,o){var n={value:s,cost:o};this.queue.push(n),this.queue.sort(this.sorter)},pop:function(){return this.queue.shift()},empty:function(){return this.queue.length===0}}};e.exports=t})(vn)),vn.exports}var Cr;function ta(){return Cr||(Cr=1,(function(e){const t=Ge(),s=Yo(),o=Qo(),n=Xo(),r=Zo(),d=Or(),i=Ve(),u=ea();function y(N){return unescape(encodeURIComponent(N)).length}function P(N,D,I){const M=[];let A;for(;(A=N.exec(I))!==null;)M.push({data:A[0],index:A.index,mode:D,length:A[0].length});return M}function k(N){const D=P(d.NUMERIC,t.NUMERIC,N),I=P(d.ALPHANUMERIC,t.ALPHANUMERIC,N);let M,A;return i.isKanjiModeEnabled()?(M=P(d.BYTE,t.BYTE,N),A=P(d.KANJI,t.KANJI,N)):(M=P(d.BYTE_KANJI,t.BYTE,N),A=[]),D.concat(I,M,A).sort(function(w,p){return w.index-p.index}).map(function(w){return{data:w.data,mode:w.mode,length:w.length}})}function E(N,D){switch(D){case t.NUMERIC:return s.getBitsLength(N);case t.ALPHANUMERIC:return o.getBitsLength(N);case t.KANJI:return r.getBitsLength(N);case t.BYTE:return n.getBitsLength(N)}}function S(N){return N.reduce(function(D,I){const M=D.length-1>=0?D[D.length-1]:null;return M&&M.mode===I.mode?(D[D.length-1].data+=I.data,D):(D.push(I),D)},[])}function R(N){const D=[];for(let I=0;I<N.length;I++){const M=N[I];switch(M.mode){case t.NUMERIC:D.push([M,{data:M.data,mode:t.ALPHANUMERIC,length:M.length},{data:M.data,mode:t.BYTE,length:M.length}]);break;case t.ALPHANUMERIC:D.push([M,{data:M.data,mode:t.BYTE,length:M.length}]);break;case t.KANJI:D.push([M,{data:M.data,mode:t.BYTE,length:y(M.data)}]);break;case t.BYTE:D.push([{data:M.data,mode:t.BYTE,length:y(M.data)}])}}return D}function O(N,D){const I={},M={start:{}};let A=["start"];for(let m=0;m<N.length;m++){const w=N[m],p=[];for(let C=0;C<w.length;C++){const j=w[C],h=""+m+C;p.push(h),I[h]={node:j,lastCount:0},M[h]={};for(let T=0;T<A.length;T++){const x=A[T];I[x]&&I[x].node.mode===j.mode?(M[x][h]=E(I[x].lastCount+j.length,j.mode)-E(I[x].lastCount,j.mode),I[x].lastCount+=j.length):(I[x]&&(I[x].lastCount=j.length),M[x][h]=E(j.length,j.mode)+4+t.getCharCountIndicator(j.mode,D))}}A=p}for(let m=0;m<A.length;m++)M[A[m]].end=0;return{map:M,table:I}}function B(N,D){let I;const M=t.getBestModeForData(N);if(I=t.from(D,M),I!==t.BYTE&&I.bit<M.bit)throw new Error('"'+N+'" cannot be encoded with mode '+t.toString(I)+`.
 Suggested mode is: `+t.toString(M));switch(I===t.KANJI&&!i.isKanjiModeEnabled()&&(I=t.BYTE),I){case t.NUMERIC:return new s(N);case t.ALPHANUMERIC:return new o(N);case t.KANJI:return new r(N);case t.BYTE:return new n(N)}}e.fromArray=function(D){return D.reduce(function(I,M){return typeof M=="string"?I.push(B(M,null)):M.data&&I.push(B(M.data,M.mode)),I},[])},e.fromString=function(D,I){const M=k(D,i.isKanjiModeEnabled()),A=R(M),m=O(A,I),w=u.find_path(m.map,"start","end"),p=[];for(let C=1;C<w.length-1;C++)p.push(m.table[w[C]].node);return e.fromArray(S(p))},e.rawSplit=function(D){return e.fromArray(k(D,i.isKanjiModeEnabled()))}})(pn)),pn}var vr;function na(){if(vr)return rn;vr=1;const e=Ve(),t=In(),s=_o(),o=$o(),n=qo(),r=Wo(),d=Ho(),i=Tr(),u=Go(),y=Jo(),P=Ko(),k=Ge(),E=ta();function S(m,w){const p=m.size,C=r.getPositions(w);for(let j=0;j<C.length;j++){const h=C[j][0],T=C[j][1];for(let x=-1;x<=7;x++)if(!(h+x<=-1||p<=h+x))for(let L=-1;L<=7;L++)T+L<=-1||p<=T+L||(x>=0&&x<=6&&(L===0||L===6)||L>=0&&L<=6&&(x===0||x===6)||x>=2&&x<=4&&L>=2&&L<=4?m.set(h+x,T+L,!0,!0):m.set(h+x,T+L,!1,!0))}}function R(m){const w=m.size;for(let p=8;p<w-8;p++){const C=p%2===0;m.set(p,6,C,!0),m.set(6,p,C,!0)}}function O(m,w){const p=n.getPositions(w);for(let C=0;C<p.length;C++){const j=p[C][0],h=p[C][1];for(let T=-2;T<=2;T++)for(let x=-2;x<=2;x++)T===-2||T===2||x===-2||x===2||T===0&&x===0?m.set(j+T,h+x,!0,!0):m.set(j+T,h+x,!1,!0)}}function B(m,w){const p=m.size,C=y.getEncodedBits(w);let j,h,T;for(let x=0;x<18;x++)j=Math.floor(x/3),h=x%3+p-8-3,T=(C>>x&1)===1,m.set(j,h,T,!0),m.set(h,j,T,!0)}function N(m,w,p){const C=m.size,j=P.getEncodedBits(w,p);let h,T;for(h=0;h<15;h++)T=(j>>h&1)===1,h<6?m.set(h,8,T,!0):h<8?m.set(h+1,8,T,!0):m.set(C-15+h,8,T,!0),h<8?m.set(8,C-h-1,T,!0):h<9?m.set(8,15-h-1+1,T,!0):m.set(8,15-h-1,T,!0);m.set(C-8,8,1,!0)}function D(m,w){const p=m.size;let C=-1,j=p-1,h=7,T=0;for(let x=p-1;x>0;x-=2)for(x===6&&x--;;){for(let L=0;L<2;L++)if(!m.isReserved(j,x-L)){let J=!1;T<w.length&&(J=(w[T]>>>h&1)===1),m.set(j,x-L,J),h--,h===-1&&(T++,h=7)}if(j+=C,j<0||p<=j){j-=C,C=-C;break}}}function I(m,w,p){const C=new s;p.forEach(function(L){C.put(L.mode.bit,4),C.put(L.getLength(),k.getCharCountIndicator(L.mode,m)),L.write(C)});const j=e.getSymbolTotalCodewords(m),h=i.getTotalCodewordsCount(m,w),T=(j-h)*8;for(C.getLengthInBits()+4<=T&&C.put(0,4);C.getLengthInBits()%8!==0;)C.putBit(0);const x=(T-C.getLengthInBits())/8;for(let L=0;L<x;L++)C.put(L%2?17:236,8);return M(C,m,w)}function M(m,w,p){const C=e.getSymbolTotalCodewords(w),j=i.getTotalCodewordsCount(w,p),h=C-j,T=i.getBlocksCount(w,p),x=C%T,L=T-x,J=Math.floor(C/T),me=Math.floor(h/T),te=me+1,xe=J-me,Q=new u(xe);let we=0;const ke=new Array(T),F=new Array(T);let q=0;const K=new Uint8Array(m.buffer);for(let he=0;he<T;he++){const ie=he<L?me:te;ke[he]=K.slice(we,we+ie),F[he]=Q.encode(ke[he]),we+=ie,q=Math.max(q,ie)}const X=new Uint8Array(C);let Z=0,oe,_;for(oe=0;oe<q;oe++)for(_=0;_<T;_++)oe<ke[_].length&&(X[Z++]=ke[_][oe]);for(oe=0;oe<xe;oe++)for(_=0;_<T;_++)X[Z++]=F[_][oe];return X}function A(m,w,p,C){let j;if(Array.isArray(m))j=E.fromArray(m);else if(typeof m=="string"){let J=w;if(!J){const me=E.rawSplit(m);J=y.getBestVersionForData(me,p)}j=E.fromString(m,J||40)}else throw new Error("Invalid data");const h=y.getBestVersionForData(j,p);if(!h)throw new Error("The amount of data is too big to be stored in a QR Code");if(!w)w=h;else if(w<h)throw new Error(`
The chosen QR Code version cannot contain this amount of data.
Minimum version required to store current data is: `+h+`.
`);const T=I(w,p,j),x=e.getSymbolSize(w),L=new o(x);return S(L,w),R(L),O(L,w),N(L,p,0),w>=7&&B(L,w),D(L,T),isNaN(C)&&(C=d.getBestMask(L,N.bind(null,L,p))),d.applyMask(C,L),N(L,p,C),{modules:L,version:w,errorCorrectionLevel:p,maskPattern:C,segments:j}}return rn.create=function(w,p){if(typeof w>"u"||w==="")throw new Error("No input text");let C=t.M,j,h;return typeof p<"u"&&(C=t.from(p.errorCorrectionLevel,t.M),j=y.from(p.version),h=d.from(p.maskPattern),p.toSJISFunc&&e.setToSJISFunction(p.toSJISFunc)),A(w,j,C,h)},rn}var Sn={},Nn={},Sr;function Ar(){return Sr||(Sr=1,(function(e){function t(s){if(typeof s=="number"&&(s=s.toString()),typeof s!="string")throw new Error("Color should be defined as hex string");let o=s.slice().replace("#","").split("");if(o.length<3||o.length===5||o.length>8)throw new Error("Invalid hex color: "+s);(o.length===3||o.length===4)&&(o=Array.prototype.concat.apply([],o.map(function(r){return[r,r]}))),o.length===6&&o.push("F","F");const n=parseInt(o.join(""),16);return{r:n>>24&255,g:n>>16&255,b:n>>8&255,a:n&255,hex:"#"+o.slice(0,6).join("")}}e.getOptions=function(o){o||(o={}),o.color||(o.color={});const n=typeof o.margin>"u"||o.margin===null||o.margin<0?4:o.margin,r=o.width&&o.width>=21?o.width:void 0,d=o.scale||4;return{width:r,scale:r?4:d,margin:n,color:{dark:t(o.color.dark||"#000000ff"),light:t(o.color.light||"#ffffffff")},type:o.type,rendererOpts:o.rendererOpts||{}}},e.getScale=function(o,n){return n.width&&n.width>=o+n.margin*2?n.width/(o+n.margin*2):n.scale},e.getImageWidth=function(o,n){const r=e.getScale(o,n);return Math.floor((o+n.margin*2)*r)},e.qrToImageData=function(o,n,r){const d=n.modules.size,i=n.modules.data,u=e.getScale(d,r),y=Math.floor((d+r.margin*2)*u),P=r.margin*u,k=[r.color.light,r.color.dark];for(let E=0;E<y;E++)for(let S=0;S<y;S++){let R=(E*y+S)*4,O=r.color.light;if(E>=P&&S>=P&&E<y-P&&S<y-P){const B=Math.floor((E-P)/u),N=Math.floor((S-P)/u);O=k[i[B*d+N]?1:0]}o[R++]=O.r,o[R++]=O.g,o[R++]=O.b,o[R]=O.a}}})(Nn)),Nn}var Nr;function ra(){return Nr||(Nr=1,(function(e){const t=Ar();function s(n,r,d){n.clearRect(0,0,r.width,r.height),r.style||(r.style={}),r.height=d,r.width=d,r.style.height=d+"px",r.style.width=d+"px"}function o(){try{return document.createElement("canvas")}catch{throw new Error("You need to specify a canvas element")}}e.render=function(r,d,i){let u=i,y=d;typeof u>"u"&&(!d||!d.getContext)&&(u=d,d=void 0),d||(y=o()),u=t.getOptions(u);const P=t.getImageWidth(r.modules.size,u),k=y.getContext("2d"),E=k.createImageData(P,P);return t.qrToImageData(E.data,r,u),s(k,y,P),k.putImageData(E,0,0),y},e.renderToDataURL=function(r,d,i){let u=i;typeof u>"u"&&(!d||!d.getContext)&&(u=d,d=void 0),u||(u={});const y=e.render(r,d,u),P=u.type||"image/png",k=u.rendererOpts||{};return y.toDataURL(P,k.quality)}})(Sn)),Sn}var kn={},kr;function oa(){if(kr)return kn;kr=1;const e=Ar();function t(n,r){const d=n.a/255,i=r+'="'+n.hex+'"';return d<1?i+" "+r+'-opacity="'+d.toFixed(2).slice(1)+'"':i}function s(n,r,d){let i=n+r;return typeof d<"u"&&(i+=" "+d),i}function o(n,r,d){let i="",u=0,y=!1,P=0;for(let k=0;k<n.length;k++){const E=Math.floor(k%r),S=Math.floor(k/r);!E&&!y&&(y=!0),n[k]?(P++,k>0&&E>0&&n[k-1]||(i+=y?s("M",E+d,.5+S+d):s("m",u,0),u=0,y=!1),E+1<r&&n[k+1]||(i+=s("h",P),P=0)):u++}return i}return kn.render=function(r,d,i){const u=e.getOptions(d),y=r.modules.size,P=r.modules.data,k=y+u.margin*2,E=u.color.light.a?"<path "+t(u.color.light,"fill")+' d="M0 0h'+k+"v"+k+'H0z"/>':"",S="<path "+t(u.color.dark,"stroke")+' d="'+o(P,y,u.margin)+'"/>',R='viewBox="0 0 '+k+" "+k+'"',B='<svg xmlns="http://www.w3.org/2000/svg" '+(u.width?'width="'+u.width+'" height="'+u.width+'" ':"")+R+' shape-rendering="crispEdges">'+E+S+`</svg>
`;return typeof i=="function"&&i(null,B),B},kn}var Er;function aa(){if(Er)return et;Er=1;const e=Uo(),t=na(),s=ra(),o=oa();function n(r,d,i,u,y){const P=[].slice.call(arguments,1),k=P.length,E=typeof P[k-1]=="function";if(!E&&!e())throw new Error("Callback required as last argument");if(E){if(k<2)throw new Error("Too few arguments provided");k===2?(y=i,i=d,d=u=void 0):k===3&&(d.getContext&&typeof y>"u"?(y=u,u=void 0):(y=u,u=i,i=d,d=void 0))}else{if(k<1)throw new Error("Too few arguments provided");return k===1?(i=d,d=u=void 0):k===2&&!d.getContext&&(u=i,i=d,d=void 0),new Promise(function(S,R){try{const O=t.create(i,u);S(r(O,d,u))}catch(O){R(O)}})}try{const S=t.create(i,u);y(null,r(S,d,u))}catch(S){y(S)}}return et.create=t.create,et.toCanvas=n.bind(null,s.render),et.toDataURL=n.bind(null,s.renderToDataURL),et.toString=n.bind(null,function(r,d,i){return o.render(r,i)}),et}var sa=aa();const ia=ko(sa);async function Mr(e){return new Promise((t,s)=>{const o=new Image;o.onload=()=>t(o),o.onerror=n=>s(n),o.src=e})}async function ca(e,t){const[s,o]=await Promise.all([Mr(e),Mr(t.logoUrl)]),n=Math.max(160,s.width||160),r=Math.max(160,s.height||160),d=document.createElement("canvas");d.width=n,d.height=r;const i=d.getContext("2d");i.fillStyle="#ffffff",i.fillRect(0,0,n,r),i.imageSmoothingEnabled=!1,i.drawImage(s,0,0,n,r);const u=n/2,y=r/2,P=Math.max(.14,Math.min(.28,t.logoScale??.2)),k=Math.round(Math.min(n,r)*P),E=Math.round(u-k/2),S=Math.round(y-k/2);if(t.mask!==!1){const R=t.shape||"rounded-rect",O=Math.max(2,Math.round(k*.08)),B=E-O,N=S-O,D=k+O*2,I=k+O*2;if(i.beginPath(),R==="circle"){const M=Math.min(D,I)/2;i.arc(B+D/2,N+I/2,M,0,Math.PI*2)}else if(R==="rect")i.rect(B,N,D,I);else{const M=Math.max(4,t.radiusPx??Math.round(k*.12)),A=Math.min(M,D/2,I/2);i.moveTo(B+A,N),i.arcTo(B+D,N,B+D,N+I,A),i.arcTo(B+D,N+I,B,N+I,A),i.arcTo(B,N+I,B,N,A),i.arcTo(B,N,B+D,N,A),i.closePath()}i.fillStyle="#ffffff",i.fill(),i.lineWidth=1,i.strokeStyle=t.maskStroke||"rgba(0,0,0,0.12)",i.stroke()}if(i.save(),t.shape==="circle"){const R=k/2;i.beginPath(),i.arc(E+R,S+R,R,0,Math.PI*2),i.clip()}return i.imageSmoothingEnabled=!0,i.drawImage(o,E,S,k,k),i.restore(),d.toDataURL("image/png")}async function la(e,t){const{width:s=256,margin:o=2,errorCorrectionLevel:n="H",color:r={dark:"#000000",light:"#ffffff"},logo:d}=t||{},i=await ia.toDataURL(e,{width:s,margin:o,errorCorrectionLevel:n,color:r});return d?ca(i,d):i}const da=({videoDevices:e,streaming:t,refreshVideoDevices:s,testCamera:o,onSelectPhoneCamera:n,lastDetectedLabel:r,autoCommitTestMode:d,doCommit:i,lastDetectedValue:u,cameraConnected:y})=>{const{preferredCameraId:P,preferredCameraLabel:k,setPreferredCamera:E,cameraEnabled:S,setCameraEnabled:R,preferredCameraLocked:O,setPreferredCameraLocked:B}=Re(),[N,D]=g.useState(""),[I,M]=g.useState(!1),A=g.useRef(null),m=g.useCallback(async()=>{D("");try{await s()}catch(x){console.warn("[DevicePicker] refresh failed",x),D("Unable to list cameras. Grant camera permission in your browser.")}},[s]);g.useEffect(()=>{m()},[m]),g.useEffect(()=>{if(!I)return;function x(L){A.current&&!A.current.contains(L.target)&&(console.debug("[DevicePicker] document.mousedown -> closing dropdown (outside both main+portal)",Date.now()),M(!1))}return document.addEventListener("mousedown",x),()=>document.removeEventListener("mousedown",x)},[I]);const w=e.find(x=>x.deviceId===P),p=w?`${w.label||"Camera"}`:P?"Camera (unavailable)":"Auto (browser default)",C=!!(P&&!w),j=g.useCallback((x,L="")=>{try{E(x,L,!0)}catch(J){console.warn("[DevicePicker] setPreferredCamera failed",J)}M(!1)},[E]),h=g.useCallback(()=>{j(void 0,"Phone Camera"),n()},[j,n]),T=g.useCallback(()=>{B(!O)},[O,B]);return a.jsxs("div",{ref:A,className:"mt-3 rounded-lg border border-indigo-500/30 bg-indigo-500/5 p-3","data-testid":"device-picker-root",children:[a.jsx("div",{className:"mb-2 font-semibold",children:"Select camera device"}),N&&a.jsx("div",{className:"mb-2 text-sm text-rose-400",children:N}),e.length===0&&!N&&a.jsx("div",{className:"mb-2 text-xs text-slate-400",children:'Detecting devices... (click "Rescan" if this hangs)'}),C&&a.jsxs("div",{className:"mb-2 text-sm text-amber-400",children:["Selected camera is no longer available.",a.jsx("button",{className:"ml-1 underline",onClick:()=>j(void 0,""),disabled:t,children:"Use auto-selection"})]}),a.jsxs("div",{className:"mb-2 flex items-center gap-2",children:[O?a.jsx("div",{className:"text-xs text-emerald-400",children:"ðŸ”’ Camera selection locked"}):a.jsx("div",{className:"text-xs text-slate-400",children:"Camera selection unlocked"}),a.jsx("button",{"data-testid":"cam-lock-toggle",className:"btn btn--ghost ml-2 px-2 py-0.5 text-xs",onClick:T,children:O?"Unlock":"Lock"})]}),a.jsxs("div",{className:"mb-3 flex items-center gap-3",children:[a.jsx("input",{type:"checkbox",id:"cameraEnabled-calibrator",checked:S,onChange:x=>R(x.target.checked),className:"h-4 w-4",disabled:t}),a.jsx("label",{htmlFor:"cameraEnabled-calibrator",className:"text-sm",children:"Enable camera for scoring"})]}),a.jsxs("div",{className:"grid grid-cols-3 items-center gap-2 text-sm",children:[a.jsxs("div",{className:"relative col-span-2",children:[a.jsxs("button",{className:"input flex w-full items-center justify-between text-left","data-testid":"device-picker-toggle",onClick:()=>M(!0),onPointerDown:x=>x.stopPropagation(),onMouseDown:x=>x.stopPropagation(),children:[a.jsx("span",{children:p}),a.jsx("span",{className:`transition-transform ${I?"rotate-180":""}`,children:"â–¼"})]}),I&&a.jsx("div",{className:"absolute left-0 right-0 top-full z-50 mt-1 rounded border border-slate-600 bg-slate-800 shadow-lg",children:a.jsxs("div",{className:"max-h-48 overflow-y-auto",children:[a.jsx("button",{"data-testid":"device-option-auto",className:"w-full px-3 py-2 text-left text-sm hover:bg-slate-700",onClick:()=>j(void 0,""),onPointerDown:x=>x.stopPropagation(),onMouseDown:x=>x.stopPropagation(),children:"Auto (browser default)"}),e.map(x=>a.jsx("button",{className:"w-full px-3 py-2 text-left text-sm hover:bg-slate-700",onClick:()=>j(x.deviceId,x.label||""),onPointerDown:L=>L.stopPropagation(),onMouseDown:L=>L.stopPropagation(),children:x.label||"Camera"},x.deviceId)),!jn()&&a.jsx("button",{className:"w-full px-3 py-2 text-left text-sm hover:bg-slate-700",onClick:h,onPointerDown:x=>x.stopPropagation(),onMouseDown:x=>x.stopPropagation(),children:"ðŸ“± Remote Device / Pair"})]})})]}),e.length===0&&a.jsxs("div",{className:"col-span-1 flex items-center justify-end gap-2",children:[a.jsx("button",{className:"btn btn--ghost btn-sm",onClick:async()=>{try{await o(),await s()}catch(x){console.warn("[DevicePicker] request camera permission failed",x),D("Camera permission denied. Please allow access in your browser.")}},children:"Enable local camera"}),a.jsx("button",{className:"btn btn--ghost btn-sm",onClick:()=>void m(),children:"Rescan"})]}),a.jsxs("div",{className:"col-span-3 text-right",children:[a.jsx("button",{className:"btn px-2 py-1",onClick:()=>{o(P||void 0)},disabled:t,children:"Test"}),a.jsxs("div",{className:"mt-2 flex items-center justify-end gap-2 text-xs opacity-70",children:[a.jsx("span",{"data-testid":"device-picker-detected",children:r?`Detected: ${r}`:"No recent detection"}),(r!=null||d)&&a.jsx("button",{className:"btn btn--ghost btn-sm",onClick:()=>i(),onPointerDown:()=>i(),disabled:u==null,children:"Commit detected"}),a.jsx("span",{className:`inline-block h-2.5 w-2.5 rounded-full ${y?"bg-emerald-400":"bg-rose-500"}`}),a.jsx("span",{className:"text-xs",children:y?"Camera Connected":"Camera not connected"})]})]})]}),k&&a.jsxs("div",{className:"mt-1 text-xs opacity-70",children:["Selected: ",k]}),a.jsx("div",{className:"mt-1 text-xs opacity-70",children:"Tip: Select a camera here for manual scoring."})]})},Ot=["D20","D6","D3","D11","BULL"],Pr=Ot.length,ua=[{idx:0,label:"D20 (top double)",sector:20,ring:"DOUBLE",toleranceMm:4.5},{idx:1,label:"D6 (right double)",sector:6,ring:"DOUBLE",toleranceMm:4.5},{idx:2,label:"D3 (bottom double)",sector:3,ring:"DOUBLE",toleranceMm:4.5},{idx:3,label:"D11 (left double)",sector:11,ring:"DOUBLE",toleranceMm:4.5},{idx:4,label:"Bull center",sector:25,ring:"INNER_BULL",toleranceMm:3.5}];function jr(e,t,s){return wo(e,[1,0,t,0,1,s,0,0,1])}function fa(){const e=g.useRef(null),t=g.useRef(null),s=g.useRef(null);g.useRef(null);const[o,n]=g.useState("unknown"),[r,d]=g.useState([]),[i,u]=g.useState(null),[y,P]=g.useState(!1),[k,E]=g.useState(!1),[S,R]=g.useState(()=>localStorage.getItem("ndn:cal:mode")||"local"),[O,B]=g.useState([]),[N,D]=g.useState(!1),[I,M]=g.useState("idle"),A=g.useCallback(()=>{try{Re.getState().setPreferredCamera(void 0,"Phone Camera",!0)}catch(c){console.warn("[Camera Connection] Failed to persist phone camera selection",c)}lt()},[]),[m,w]=g.useState(null),p=Re(c=>c.cameraScale)||1,C=Re(c=>c.setCameraScale),[j,h]=g.useState(()=>{if(typeof window>"u")return!1;try{return window.localStorage.getItem("ndn:cal:forceDesktop")==="1"}catch{return!1}}),[T,x]=g.useState(()=>typeof navigator>"u"?!1:/Android|iPhone|iPad|iPod|Mobi/i.test(navigator.userAgent)),{H:L,setCalibration:J,reset:me,errorPx:te,locked:xe,overlaySize:Q,imageSize:we,anchors:ke,theta:F,sectorOffset:q}=tn(),K=6,X=Rr(),{calibrationGuide:Z,setCalibrationGuide:oe,preferredCameraId:_,cameraEnabled:he,setCameraEnabled:ie,preferredCameraLocked:ce,setPreferredCameraLocked:Te,setPreferredCamera:Ie,preserveCalibrationOverlay:Le,allowAutocommitInOnline:qe,setAllowAutocommitInOnline:gt}=Re(),bt=!0,[W,tt]=g.useState(null),[De,pt]=g.useState(!1),[xt,Je]=g.useState(0),[yt,Ke]=g.useState(!1),[ma,nt]=g.useState(null),[Br,ga]=g.useState(!0),[ba,At]=g.useState(null),[Rn,Lr]=g.useState(!1),[Bt,Fr]=g.useState(!1),[Ur,_r]=g.useState(!1),[Tn,pa]=g.useState(null),[Dn,xa]=g.useState(null),[rt,ya]=g.useState(null),[On,$r]=g.useState(!1),qr=g.useRef(null);g.useCallback(c=>{const f=(q??0)+c;J({sectorOffset:f})},[q,J]);const Lt=g.useRef(!1),An=g.useRef(null),Bn=g.useRef(0),Ln=300,[wt,Wr]=g.useState([]),[Ft,wa]=g.useState({type:null,until:0}),[Oe,Fn]=g.useState(1),[Ye,Hr]=g.useState(0),[Qe,zr]=g.useState(0),[Un,Vr]=g.useState(!1),[Ut,ot]=g.useState(!1),[_t,$t]=g.useState(1),[qt,Wt]=g.useState(1),[We,Ht]=g.useState(null);function Gr(){$t(1.02),Wt(1),Fn(1),Hr(0),zr(0),ot(!1),Ht(null)}g.useCallback((c,f=480)=>{if(typeof document>"u")throw new Error("Marker rendering only available in browser context");const v=Eo(c),b=document.createElement("canvas");b.width=f,b.height=f;const l=b.getContext("2d");if(!l)return"";l.fillStyle="#ffffff",l.fillRect(0,0,f,f);const U=v.length,G=v[0]?.length||U,ne=f/G,Me=f/U;for(let ae=0;ae<U;ae++)for(let Y=0;Y<G;Y++)v[ae][Y]&&(l.fillStyle="#000000",l.fillRect(Math.round(Y*ne),Math.round(ae*Me),Math.ceil(ne),Math.ceil(Me)));return b.toDataURL("image/png")},[]);const[_n,zt]=g.useState(null),[Ee,Jr]=g.useState(null),Ct=g.useRef(null),[vt,Kr]=g.useState(null),at=g.useRef(null),$n=g.useRef(S),Xe=g.useRef(!1),Fe=g.useRef(null),St=g.useRef([]),[st,Vt]=g.useState(null),[qn,Yr]=g.useState(Date.now()),[Wn,Gt]=g.useState(!1);function Nt(c){try{Jr(c),Ct.current=c}catch{}}const[Hn,Qr]=g.useState(null),[Ze,Xr]=g.useState(null),[Zr,eo]=g.useState(!0),[zn,kt]=g.useState([]),[to,Vn]=g.useState(!1),[Jt,Kt]=g.useState(null),it=g.useRef(null);g.useEffect(()=>()=>{qr.current=null},[bt,Rn,y,W]),g.useEffect(()=>{const c=window.location.hostname;(c==="localhost"||c==="127.0.0.1")&&Pt("/api/hosts").then(f=>f.json()).then(f=>{const v=Array.isArray(f?.hosts)&&f.hosts.find(b=>b);v&&Qr(v)}).catch(()=>{}),Pt("/api/https-info").then(f=>f.json()).then(f=>{f&&typeof f.https=="boolean"&&Xr({https:!!f.https,port:Number(f.port)||8788})}).catch(()=>{})},[]);const Ue=g.useMemo(()=>{const c=Ee||"____",f=window.location.hostname;if(f.endsWith("onrender.com"))return`${window.location.origin.replace(/\/$/,"")}/mobile-cam.html?code=${c}`;const v="ws://localhost:8787";if(v.length>0)try{const ne=new URL(v);return`${`${ne.protocol==="wss:"?"https":"http"}://${ne.host}${ne.pathname.endsWith("/ws")?"":ne.pathname}`.replace(/\/?ws$/i,"")}/mobile-cam.html?code=${c}`}catch{}const b=Hn||f,l=!!Ze?.https,U=l?Ze?.port||8788:8787;return`${l?"https":"http"}://${b}:${U}/mobile-cam.html?code=${c}`},[Ee,Hn,Ze]),no=g.useMemo(()=>{if(!Ue)return null;try{const c=new URL(Ue);return c.searchParams.delete("code"),c.toString().replace(/\?$/,"")}catch{return typeof window<"u"?`${window.location.origin.replace(/\/$/,"")}/mobile-cam.html`:"/mobile-cam.html"}},[Ue]);g.useEffect(()=>{if(!Ue||!Ee){zt(null);return}let c=!1;return la(Ue,{width:256,margin:2,errorCorrectionLevel:"H",color:{dark:"#000000",light:"#ffffff"},logo:!1}).then(f=>{c||zt(f)}).catch(()=>{c||zt(null)}),()=>{c=!0}},[Ue,Ee]),g.useEffect(()=>{localStorage.setItem("ndn:cal:mode",S),$n.current=S},[S]),g.useEffect(()=>{if(!(typeof window>"u"))try{j?window.localStorage.setItem("ndn:cal:forceDesktop","1"):window.localStorage.removeItem("ndn:cal:forceDesktop")}catch{}},[j]),g.useEffect(()=>{if(typeof window>"u")return;const c=window.matchMedia("(pointer: coarse)"),f=()=>{const v=typeof navigator<"u"&&/Android|iPhone|iPad|iPod|Mobi/i.test(navigator.userAgent),b=typeof c.matches=="boolean"?c.matches:!1,l=window.innerWidth<=820;x(v||b||l)};f();try{typeof c.addEventListener=="function"?c.addEventListener("change",f):typeof c.addListener=="function"&&c.addListener(f)}catch{}return window.addEventListener("resize",f),()=>{try{typeof c.removeEventListener=="function"?c.removeEventListener("change",f):typeof c.removeListener=="function"&&c.removeListener(f)}catch{}window.removeEventListener("resize",f)}},[]),g.useEffect(()=>{if(typeof navigator>"u"||!navigator.permissions){n("unsupported");return}let c=!0;return(async()=>{try{const f=await navigator.permissions.query({name:"camera"});if(!c)return;n(f.state||"unknown"),f.onchange=()=>{c&&n(f.state)}}catch{c&&n("unknown")}})(),()=>{c=!1}},[]);async function ct(){if(!(typeof navigator>"u"||!navigator.mediaDevices||!navigator.mediaDevices.enumerateDevices))try{const f=(await navigator.mediaDevices.enumerateDevices()).filter(v=>v.kind==="videoinput").map(v=>({deviceId:v.deviceId,label:v.label||"Camera"}));d(f),f.length&&!i&&u(f[0].deviceId)}catch{}}g.useEffect(()=>((async()=>{try{await ct()}catch{}try{navigator?.mediaDevices?.addEventListener?navigator.mediaDevices.addEventListener("devicechange",ct):navigator.mediaDevices.ondevicechange=ct}catch{}})(),()=>{try{navigator?.mediaDevices?.removeEventListener&&navigator.mediaDevices.removeEventListener("devicechange",ct)}catch{}}),[]);async function ro(c){if(typeof navigator>"u"||!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia){alert("getUserMedia is not available in this browser");return}const f={video:c?{deviceId:{exact:c}}:{facingMode:"environment"}};let v=null;try{v=await navigator.mediaDevices.getUserMedia(f),v.getTracks().forEach(b=>b.stop()),n("granted");try{c&&typeof Ie=="function"&&Ie(c)}catch{}alert("Camera access granted â€” your webcam is available and set as preferred.")}catch(b){console.error("[Camera Connection] testCamera failed",b),b&&(b.name==="NotAllowedError"||b.name==="PermissionDeniedError")?(n("denied"),alert("Camera permission denied. Please allow camera access in your browser settings and try again.")):b&&(b.name==="NotFoundError"||b.name==="DevicesNotFoundError")?alert("No camera devices found. Ensure your USB webcam is connected and not in use by another app."):alert("Unable to access the camera: "+(b?.message||b))}finally{v&&v.getTracks().forEach(b=>b.stop())}}g.useEffect(()=>{if(!st)return;const c=setInterval(()=>Yr(Date.now()),1e3);return()=>clearInterval(c)},[st]);const Gn=g.useMemo(()=>st?Math.max(0,Math.ceil((st-qn)/1e3)):null,[st,qn]);g.useEffect(()=>()=>{it.current&&window.clearTimeout(it.current)},[]);const Yt=g.useCallback(async(c,f)=>{if(c)try{if(navigator.clipboard&&navigator.clipboard.writeText)await navigator.clipboard.writeText(c);else{const v=document.createElement("textarea");v.value=c,v.style.position="fixed",v.style.opacity="0",document.body.appendChild(v),v.focus(),v.select(),document.execCommand("copy");try{document.body.removeChild(v)}catch{}}Kt(f),it.current&&window.clearTimeout(it.current),it.current=window.setTimeout(()=>Kt(null),1500)}catch(v){console.warn("[Camera Connection] Copy failed:",v),Kt(null)}},[]);g.useEffect(()=>()=>{},[]),g.useEffect(()=>{const c=f=>{console.log("[Camera Connection] Received reconnect request from PhoneCameraOverlay"),S==="phone"&&Wn&&(_e(!1),setTimeout(()=>{lt()},500))};return window.addEventListener("ndn:phone-camera-reconnect",c),()=>{window.removeEventListener("ndn:phone-camera-reconnect",c)}},[S,Wn]),g.useEffect(()=>{console.log("[Camera Connection] ðŸ”„ STREAMING CHANGED:",{streaming:y,videoRefAvailable:!!e.current}),e.current?(console.log("[Camera Connection] âœ… Syncing videoElementRef on streaming change"),X.setVideoElementRef(e.current),e.current.srcObject instanceof MediaStream&&(console.log("[Camera Connection] âœ… Setting mediaStream from video element"),X.setMediaStream(e.current.srcObject))):console.warn("[Camera Connection] âš ï¸ videoRef.current is null on streaming change!")},[y]),g.useEffect(()=>(console.log("[Camera Connection] ðŸš€ MOUNT: Initial mount - syncing videoRef"),console.log("[Camera Connection] videoRef.current available:",!!e.current),console.log("[Camera Connection] videoRef.current type:",e.current?.constructor?.name),e.current?(console.log("[Camera Connection] âœ… Setting videoElementRef on mount"),console.log("[Camera Connection] Video element:",{tagName:e.current.tagName,srcObject:!!e.current.srcObject,videoWidth:e.current.videoWidth,videoHeight:e.current.videoHeight}),X.setVideoElementRef(e.current),console.log("[Camera Connection] âœ… videoElementRef set successfully")):console.error("[Camera Connection] âŒ CRITICAL: videoRef.current is NULL at mount!"),()=>{}),[]);function oo(){const c=at.current;if(c&&(c.readyState===WebSocket.OPEN||c.readyState===WebSocket.CONNECTING))return console.log("[Camera Connection] ensureWS: Reusing existing WebSocket (state:",c.readyState,")"),c;const v=`${window.location.protocol==="https:"?"wss":"ws"}://${window.location.host}/ws`,b=window.location.hostname;let l;if(b.endsWith("onrender.com"))l=v;else{const G="ws://localhost:8787";l=(G.length>0?G.endsWith("/ws")?G:G.replace(/\/$/,"")+"/ws":void 0)||"wss://ninedartnation.onrender.com/ws"}console.log("[Camera Connection] ensureWS: Creating new WebSocket to:",l);const U=new WebSocket(l);return at.current=U,U.onerror=G=>{console.error("[Camera Connection] WebSocket connection error:",G),alert("Failed to connect to camera pairing service. Please check your internet connection and try again.")},U.onclose=G=>{if(console.log("[Camera Connection] WebSocket closed:",G.code,G.reason),at.current===U&&(at.current=null),Fe.current){try{Fe.current.close()}catch{}Fe.current=null}Nt(null),Vt(null),Gt(!1),Xe.current=!1,G.code!==1e3&&(alert("Camera pairing connection lost. Please try pairing again."),$n.current==="phone"&&R("local"))},Kr(U),U}async function lt(){if(Xe.current){console.log("[Camera Connection] startPhonePairing: already in progress, skipping");return}Xe.current=!0,R("phone"),_e(!1),Jn();try{ie(!0)}catch{}const c=oo();c.readyState===WebSocket.OPEN?(console.log("[Camera Connection] WebSocket open, sending cam-create"),c.send(JSON.stringify({type:"cam-create"}))):(console.log("[Camera Connection] WebSocket connecting, will send cam-create on open"),c.addEventListener("open",()=>{console.log("[Camera Connection] WebSocket now open, sending cam-create"),c.send(JSON.stringify({type:"cam-create"}))},{once:!0})),c.onmessage=async f=>{const v=JSON.parse(f.data);if(v.type==="cam-code")console.log("[Camera Connection] âœ… Received cam-code:",v.code),Nt(v.code),v.expiresAt&&Vt(v.expiresAt),Xe.current=!1;else if(v.type==="cam-peer-joined"){console.log("[Camera Connection] âœ… Received cam-peer-joined! Phone has joined."),!Ct.current&&v.code&&Nt(v.code),Gt(!0);const b=Ct.current||v.code||null;b&&(Ct.current=b);try{if(xe&&b){const U=t.current?{w:t.current.width,h:t.current.height}:null,G={H:L,imageSize:U,errorPx:te??null,createdAt:Date.now()};c.send(JSON.stringify({type:"cam-calibration",code:b,payload:G})),console.log("[Camera Connection] Sent calibration to joined phone for code",b)}}catch(U){console.warn("[Camera Connection] Failed to send calibration on peer join",U)}const l=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"},{urls:"stun:stun2.l.google.com:19302"},{urls:"stun:stun.cloudflare.com:3478"}],iceCandidatePoolSize:10});Fe.current=l,l.onconnectionstatechange=()=>{console.log("[Camera Connection] WebRTC connection state:",l.connectionState),l.connectionState==="failed"?(console.error("[Camera Connection] WebRTC connection FAILED"),alert("Camera connection failed. Make sure both devices are on the same WiFi network, then try again."),_e(!1)):l.connectionState==="disconnected"?console.warn("[Camera Connection] WebRTC disconnected â€” may recover"):l.connectionState==="connected"&&console.log("[Camera Connection] âœ… WebRTC connection established!")},l.oniceconnectionstatechange=()=>{console.log("[Camera Connection] ICE connection state:",l.iceConnectionState),l.iceConnectionState==="failed"&&console.error("[Camera Connection] ICE negotiation failed â€” STUN may be blocked")},l.onicecandidate=U=>{U.candidate&&b&&c.send(JSON.stringify({type:"cam-ice",code:b,payload:U.candidate}))},l.ontrack=U=>{if(console.log("[Camera Connection] WebRTC ontrack received:",U.streams?.length,"streams, track kind:",U.track?.kind),e.current){const G=U.streams?.[0];G?(console.log("[Camera Connection] Assigning video stream (tracks:",G.getTracks().length,") to video element"),D(!1),setTimeout(()=>{e.current&&(console.log("[Camera Connection] Setting srcObject and attempting play"),e.current.srcObject&&e.current.srcObject.getTracks().forEach(Me=>Me.stop()),e.current.srcObject=G,e.current.muted=!0,e.current.playsInline=!0,e.current.play().then(()=>{console.log("[Camera Connection] Video playback started successfully"),P(!0),M("capture"),X.setStreaming(!0),X.setMode("phone"),X.setMediaStream(G);try{Ie(void 0,"Phone Camera",!0)}catch{}if(!ce)try{Te(!0)}catch{}try{ie(!0)}catch{}E(!1)}).catch(ne=>{console.error("[Camera Connection] Video play failed:",ne),E(!0),console.warn("[Camera Connection] video play blocked â€” prompting user interaction")}))},100)):console.error("[Camera Connection] No inbound stream received in ontrack")}else console.error("[Camera Connection] Video element not available")};try{l.addTransceiver("video",{direction:"recvonly"});const U=await l.createOffer({offerToReceiveAudio:!1,offerToReceiveVideo:!0});await l.setLocalDescription(U),console.log("[Camera Connection] Sending cam-offer for code:",b),b?c.send(JSON.stringify({type:"cam-offer",code:b,payload:U})):console.warn("[Camera Connection] Missing pairing code when sending offer")}catch(U){console.error("Failed to create WebRTC offer:",U),alert("Failed to establish camera connection. Please try again."),_e(!1)}}else if(v.type==="cam-answer"){console.log("[Camera Connection] Received cam-answer");const b=Fe.current;if(b)try{await b.setRemoteDescription(new RTCSessionDescription(v.payload)),console.log("[Camera Connection] Remote description set (answer)");const l=St.current;console.log(`[Camera Connection] Processing ${l.length} pending ICE candidates`);for(const U of l)try{await b.addIceCandidate(U),console.log("[Camera Connection] Queued ICE candidate added")}catch(G){console.error("Failed to add queued ICE candidate:",G)}St.current=[]}catch(l){console.error("Failed to set remote description:",l),alert("Camera pairing failed. Please try again."),_e(!1)}else console.warn("[Camera Connection] Received cam-answer but no peer connection exists")}else if(v.type==="cam-ice"){console.log("[Camera Connection] Received cam-ice");const b=Fe.current;if(b)if(b.remoteDescription)try{await b.addIceCandidate(v.payload),console.log("[Camera Connection] ICE candidate added")}catch(l){console.error("Failed to add ICE candidate:",l)}else console.log("[Camera Connection] Remote description not set yet, queuing ICE candidate"),St.current.push(v.payload);else console.warn("[Camera Connection] Received ICE candidate but no peer connection exists")}else if(v.type==="cam-error")console.error("Camera pairing error:",v.code),alert(v.code==="EXPIRED"?"Code expired. Generate a new code.":`Camera error: ${v.code||"Unknown error"}`),_e(!1);else if(v.type==="cam-calibration"){console.log("[Camera Connection] Received calibration from peer:",v.payload);try{if(v.payload){let b=Array.isArray(v.payload.H)?v.payload.H:null;if(!b&&Array.isArray(v.payload.calibrationPoints)&&v.payload.calibrationPoints.length>=4)try{const l=[{x:0,y:-$.doubleOuter},{x:$.doubleOuter,y:0},{x:0,y:$.doubleOuter},{x:-$.doubleOuter,y:0}];b=Mn(l,v.payload.calibrationPoints.slice(0,4))}catch(l){console.warn("[Camera Connection] Failed to compute homography from received connection points",l)}if(b){const l=s?.current?{w:s.current.width,h:s.current.height}:e?.current?{w:e.current.clientWidth,h:e.current.clientHeight}:v.payload.imageSize??null;J({H:b,createdAt:v.payload.createdAt||Date.now(),errorPx:v.payload.errorPx,imageSize:v.payload.imageSize,overlaySize:l,locked:!0}),console.log("[Camera Connection] Applied received calibration")}}}catch(b){console.error("[Camera Connection] Failed to apply received calibration",b)}}}}async function Et(){Vn(!0);try{const c=await To();kt(c),c.length===0&&alert("No wifi scoring devices found on your network. Make sure devices are powered on and connected to the same network.")}catch(c){console.error("Wifi device discovery failed:",c),alert("Failed to discover wifi devices. Please check your network connection.")}finally{Vn(!1)}M("camera")}async function ao(c){try{kt(v=>v.map(b=>b.id===c.id?{...b,status:"connecting"}:b));const f=await Fo(c);if(f&&e.current)e.current.srcObject&&e.current.srcObject.getTracks().forEach(b=>b.stop()),e.current.srcObject=f,await e.current.play(),P(!0),M("capture"),kt(v=>v.map(b=>b.id===c.id?{...b,status:"online"}:b));else throw new Error("Failed to get video stream")}catch(f){console.error("Failed to connect to wifi device:",f),alert(`Failed to connect to ${c.name}. Please check the device and try again.`),kt(v=>v.map(b=>b.id===c.id?{...b,status:"offline"}:b))}}async function so(){if(S==="phone")return lt();if(S==="wifi")return Et();console.log("[Camera Connection] ðŸŽ¬ START_CAMERA: mode=",S,"preferredCameraId=",_);try{let c=null;if(_)try{console.log("[Camera Connection] ðŸ“¹ Attempt 1: Using preferred camera ID:",_),c=await navigator.mediaDevices.getUserMedia({video:{deviceId:{exact:_}},audio:!1}),console.log("[Camera Connection] âœ… SUCCESS with preferred camera:",c.getTracks().length,"tracks")}catch(f){console.warn("[Camera Connection] âš ï¸ Preferred camera failed:",f?.name,f?.message)}if(!c)try{console.log("[Camera Connection] ðŸ“¹ Attempt 2: Using ANY available camera"),c=await navigator.mediaDevices.getUserMedia({video:!0,audio:!1}),console.log("[Camera Connection] âœ… SUCCESS with fallback camera:",c.getTracks().length,"tracks")}catch(f){throw console.error("[Camera Connection] âŒ BOTH attempts failed:",f?.name,f?.message),f}if(!c)throw new Error("No stream obtained");if(!e.current)throw new Error("Video element ref is null");console.log("[Camera Connection] ðŸ“º Assigning stream to video element"),e.current.srcObject=c,console.log("[Camera Connection] â–¶ï¸ Calling play()");try{await e.current.play(),console.log("[Camera Connection] âœ… Play succeeded")}catch(f){console.warn("[Camera Connection] âš ï¸ Play failed, retrying in 100ms:",f?.message),await new Promise(v=>setTimeout(v,100)),await e.current.play(),console.log("[Camera Connection] âœ… Play succeeded on retry")}console.log("[Camera Connection] ðŸŸ¢ Setting streaming = true"),P(!0),M("capture"),console.log("[Camera Connection] ðŸŸ¢ State updated")}catch(c){console.error("[Camera Connection] ðŸ”´ FATAL:",c?.message||c),alert(`Camera failed: ${c?.message||"Unknown error"}`),e.current?.srcObject&&(e.current.srcObject.getTracks().forEach(f=>f.stop()),e.current.srcObject=null)}}function _e(c=!1){if(e.current&&e.current.srcObject&&(e.current.srcObject.getTracks().forEach(v=>v.stop()),e.current.srcObject=null,P(!1)),Fe.current){try{Fe.current.close()}catch{}Fe.current=null}St.current=[],Nt(null),Vt(null),Gt(!1),Xe.current=!1,At(null),X.setStreaming(!1),X.setMediaStream(null),c&&(S==="phone"||S==="wifi")&&R("local")}function io(){Xe.current=!1;const c=at.current;c&&c.readyState===WebSocket.OPEN?c.send(JSON.stringify({type:"cam-create"})):lt(),Jn()}function Jn(){try{ce||Te(!0)}catch{}}function co(){if(!e.current||!t.current)return;const c=e.current,f=t.current;if(f.width=c.videoWidth,f.height=c.videoHeight,f.getContext("2d").drawImage(c,0,0,f.width,f.height),D(!0),w({w:f.width,h:f.height}),M("select"),console.log("[Camera Connection] captureFrame: resetting dstPoints to []"),B([]),tt(null),ot(!1),At(null),s.current){const b=s.current;b.width=f.width,b.height=f.height;const l=b.getContext("2d");l&&l.clearRect(0,0,b.width,b.height)}De&&setTimeout(()=>{uo()},0)}function Qt(c=O,f=null){if(!t.current||!s.current)return;const v=t.current,b=s.current;b.width=v.width,b.height=v.height;const l=b.getContext("2d");l.clearRect(0,0,b.width,b.height),s.current&&(s.current.onclick=H=>go(H));const U=f||(c.length>=Pr?L:null),G=Oe,ne=Ye,Me=Qe;let ae=U;ae&&G!==1&&(ae=Pn(ae,G,1)),ae&&(ne!==0||Me!==0)&&(ae=jr(ae,ne,Me));const Y=W?W.cx+Ye:0,ge=W?W.cy+Qe:0,He=1,ye={};W&&(ye[$.bullInner]=W.bullInner*He,ye[$.bullOuter]=W.bullOuter*He,ye[$.trebleInner]=W.trebleInner*He,ye[$.trebleOuter]=W.trebleOuter*He,ye[$.doubleInner]=W.doubleInner*He,ye[$.doubleOuter]=W.doubleOuter*He);const dt={};dt[$.doubleOuter]=_t,dt[$.trebleOuter]=qt;function mo(){if(!W)return 0;let H=0;try{const z="rgba(52,211,153,0.08)",Pe="rgba(253,224,71,0.06)",ue="rgba(34,211,238,0.06)",ee=(be,V,se,fe)=>{const de=ye[be],re=ye[V];if(!de||!re)return!1;l.save(),l.shadowColor="rgba(0,0,0,0.45)",l.shadowBlur=6,l.beginPath();const Ce=re*(dt[V]||1),ve=de*(dt[be]||1);return l.arc(Y,ge,Ce,0,Math.PI*2),l.arc(Y,ge,ve,0,Math.PI*2,!0),l.closePath(),l.fillStyle=se,l.fill(),l.restore(),!0};ee($.bullInner,$.bullOuter,z),H++,ee($.trebleInner,$.trebleOuter,Pe),H++,ee($.doubleInner,$.doubleOuter,ue),H++;const le=360,Se=[{r:$.bullInner,color:"#00ff66"},{r:$.bullOuter,color:"#ffffff"},{r:$.trebleInner,color:"#fde047"},{r:$.trebleOuter,color:"#fde047"},{r:$.doubleInner,color:"#22d3ee"},{r:$.doubleOuter,color:"#22d3ee"}];for(const be of Se){const V=ye[be.r];if(!V)continue;const se=[];for(let fe=0;fe<le;fe++){const de=fe/le*Math.PI*2,re=V*Oe*(dt[be.r]||1);se.push({x:Y+re*Math.cos(de),y:ge+re*Math.sin(de)})}It(l,se,"rgba(0,0,0,0.45)",3),It(l,se,be.color,1.5)}}catch{return 0}return 3}function go(H){if(!We||!s.current||!W)return;const z=s.current.getBoundingClientRect(),Pe=(H.clientX-z.left)*(s.current.width/z.width),ue=(H.clientY-z.top)*(s.current.height/z.height),ee=Pe-Y,le=ue-ge,Se=Math.hypot(ee,le);let be;We==="double"?be=$.doubleOuter:We==="treble"?be=$.trebleOuter:be=$.bullOuter;const V=ye[be];if(!V||V<=0)return;const se=Se/(V*Oe);We==="double"&&$t(se),We==="treble"&&Wt(se),We==="bull"&&Fn(fe=>fe*(se/fe)),Ht(null),console.log("[Camera Connection] Aligned ",We," adjust=",se.toFixed(4))}const Ae=ae;if(f&&console.log("[drawOverlay] Using passed homography:",{HH:f.slice(0,6),currentPointsCount:c.length,canvasSize:{w:b.width,h:b.height}}),Ut&&W){const H=mo();console.log("[drawOverlay] Forced detected-only drawing, rings drawn:",H);try{const z=s.current?.getContext("2d");if(!!z&&s.current&&W){z.save(),z.font="12px Sans-Serif",z.fillStyle="#ffffff",z.strokeStyle="#000000",z.lineWidth=3;const ue=Qn,ee=Y,le=ge,Se=(W.doubleInner+W.doubleOuter)/2+14,be=typeof F=="number"?F:0;for(let V=0;V<ue.length;V++){const se=V/ue.length*Math.PI*2-Math.PI/2-be,fe=ee+Se*Math.cos(se),de=le+Se*Math.sin(se),re=String(ue[V]),Ce=z.measureText(re).width;z.strokeText(re,fe-Ce/2,de+4),z.fillText(re,fe-Ce/2,de+4)}z.restore()}}catch{}return}if(U){const H=typeof te=="number"?te:null,z=wt&&wt.length>0,Pe=z?wt.every(V=>V.match):null,ue=typeof H=="number"?H<=1.5:null,ee=Pe===!0||ue===!0,le=z?wt.some(V=>!V.match):ue===!1;console.log("[drawOverlay] Drawing via homography transform");let Se=0;const be=(V,se,fe,de,re)=>{try{const ve=ye[se],$e=ye[fe];if(W&&ve&&$e)return l.save(),l.shadowColor="rgba(0,0,0,0.45)",l.shadowBlur=6,l.beginPath(),l.ellipse?(l.ellipse(Y,ge,$e*Oe,$e,0,0,Math.PI*2),l.ellipse(Y,ge,ve*Oe,ve,0,0,Math.PI*2,!0)):(l.arc(Y,ge,$e,0,Math.PI*2),l.arc(Y,ge,ve,0,Math.PI*2,!0)),l.closePath(),l.fillStyle=de,l.fill(),re&&(l.strokeStyle=re,l.lineWidth=2,l.stroke()),l.restore(),!0;const Ne=ht(V,fe,720),je=ht(V,se,720).reverse();if(!Ne.length||!je.length)return!1;l.save(),l.shadowColor="rgba(0,0,0,0.45)",l.shadowBlur=6,l.beginPath(),l.moveTo(Ne[0].x,Ne[0].y);for(let pe=1;pe<Ne.length;pe++)l.lineTo(Ne[pe].x,Ne[pe].y);for(let pe=0;pe<je.length;pe++)l.lineTo(je[pe].x,je[pe].y);return l.closePath(),l.fillStyle=de,l.fill(),re&&(l.strokeStyle=re,l.lineWidth=2,l.stroke()),l.restore(),!0}catch{return!1}};if(Ae){const V=ee?"rgba(0,255,102,0.12)":le?"rgba(255,45,45,0.12)":"rgba(52,211,153,0.08)",se=ee?"rgba(0,255,102,0.08)":le?"rgba(255,45,45,0.08)":"rgba(253,224,71,0.06)",fe=ee?"rgba(0,255,102,0.06)":le?"rgba(255,45,45,0.06)":"rgba(34,211,238,0.06)";be(Ae,$.bullInner,$.bullOuter,V,"rgba(255,255,255,0.06)"),Se++;const de=W?.trebleInner||jt.trebleInner,re=W?.trebleOuter||jt.trebleOuter;be(Ae,de,re,se,"rgba(255,255,255,0.06)"),Se++;const Ce=W?.doubleInner||jt.doubleInner,ve=W?.doubleOuter||jt.doubleOuter;be(Ae,Ce,ve,fe,"rgba(255,255,255,0.06)"),Se++;try{const Ne=[{r:$.bullInner,color:ee?"#00ff66":le?"#ff2d2d":"#ffffff",key:"bullInner"},{r:$.bullOuter,color:"#ffffff",key:"bullOuter"},{r:de,color:ee?"#00ff66":le?"#ff2d2d":"#fde047",key:"trebleInner"},{r:re,color:"#fde047",key:"trebleOuter"},{r:Ce,color:ee?"#00ff66":le?"#ff2d2d":"#22d3ee",key:"doubleInner"},{r:ve,color:"#22d3ee",key:"doubleOuter"}];for(const je of Ne){const pe=ye[je.r];let ut;if(W&&pe){ut=[];for(let en=0;en<720;en++){const Yn=en/720*Math.PI*2;ut.push({x:Y+pe*Math.cos(Yn),y:ge+pe*Math.sin(Yn)})}}else ut=ht(Ae,je.r,720);It(l,ut,"rgba(0,0,0,0.45)",3),It(l,ut,je.color,1.5)}}catch{}}console.log("[drawOverlay] Drew",Se,"rings via homography");try{const V=s.current?.getContext("2d");if(!!V&&s.current){const fe=mt(Ae||f,{x:0,y:0}),de=($.doubleInner+$.doubleOuter)/2+14,re=Qn;V.save(),V.font="12px Sans-Serif",V.fillStyle="#ffffff",V.strokeStyle="#000000",V.lineWidth=3;const Ce=typeof F=="number"?F:0;for(let ve=0;ve<re.length;ve++){const $e=ve/re.length*Math.PI*2-Math.PI/2-Ce,Ne=mt(Ae||f,{x:(de-14)*Math.cos($e),y:(de-14)*Math.sin($e)}),je=String(re[ve]),pe=V.measureText(je).width;V.strokeText(je,Ne.x-pe/2,Ne.y+4),V.fillText(je,Ne.x-pe/2,Ne.y+4)}V.restore()}}catch{}if(Ft.type&&Date.now()<Ft.until){const V=Ft.type==="pass",se=V?"rgba(0,255,102,0.9)":"rgba(255,45,45,0.9)",fe=V?"CALIBRATION PASS":"CALIBRATION FAIL";l.save();const de=12,re=b.width-240-de,Ce=de;l.fillStyle=se,l.strokeStyle="rgba(0,0,0,0.25)",l.lineWidth=2,l.beginPath(),l.roundRect(re,Ce,240,34,8),l.fill(),l.stroke(),l.fillStyle="#00110a",l.font="bold 14px system-ui, sans-serif",l.textBaseline="middle",l.fillText(fe,re+12,Ce+17),l.restore()}}if(W&&Un){console.log("[drawOverlay] Drawing detected circles overlay:",{adjustedCx:Math.round(Y),adjustedCy:Math.round(ge),doubleOuter:Math.round(W.doubleOuter),trebleOuter:Math.round(W.trebleOuter),bullOuter:Math.round(W.bullOuter)});const H=(z,Pe,ue=2)=>{if(!Number.isFinite(z)||z<=0)return;l.save(),l.strokeStyle=Pe,l.lineWidth=ue,l.setLineDash([5,5]),l.beginPath();const ee=Oe,le=z*ee,Se=z*ee;l.ellipse?l.ellipse(Y,ge,le,Se,0,0,Math.PI*2):l.arc(Y,ge,z,0,Math.PI*2),l.stroke(),l.restore()};if(H(W.doubleOuter,"#ff6b6b",3),H(W.doubleInner,"#ff6b6b",2),H(W.trebleOuter,"#ffd93d",2),H(W.trebleInner,"#ffd93d",2),H(W.bullOuter,"#6bcf7f",2),H(W.bullInner,"#6bcf7f",3),Ae&&!Ut){const z=(Pe,ue)=>{const ee=ht(Ae,Pe,180);if(ee.length){l.save(),l.setLineDash([6,4]),l.strokeStyle=ue,l.lineWidth=2,l.beginPath(),l.moveTo(ee[0].x,ee[0].y);for(let le=1;le<ee.length;le++)l.lineTo(ee[le].x,ee[le].y);l.closePath(),l.stroke(),l.restore()}};z($.doubleOuter,"#00ffff"),z($.trebleOuter,"#ffff00")}}W&&(l.save(),l.fillStyle="rgba(0,0,0,0.65)",l.fillRect(8,8,260,72),l.fillStyle="#fff",l.font="12px system-ui, sans-serif",l.fillText(`Detected cx:${Math.round(W.cx)} cy:${Math.round(W.cy)}`,16,28),l.fillText(`Double: ${Math.round(W.doubleOuter)} Treble: ${Math.round(W.trebleOuter)}`,16,48),l.fillText(`Adjusts: Sx:${Oe.toFixed(3)} Tx:${Ye} Ty:${Qe}`,16,68),l.restore());const Zt=En("outer");if(c.length>=4&&c.length<Zt.length&&f){l.save(),l.strokeStyle="rgba(255,193,7,0.4)",l.lineWidth=2,l.setLineDash([4,4]);for(let H=c.length;H<Zt.length;H++)try{const z=mt(Ae||f,Zt[H]);l.beginPath(),l.arc(z.x,z.y,12,0,Math.PI*2),l.stroke(),l.save(),l.fillStyle="rgba(255,255,255,0.65)",l.font="12px sans-serif",l.fillText(Ot[H]??String(H+1),z.x+10,z.y-10),l.restore()}catch{}l.restore()}if(c.length<Pr&&(l.save(),l.fillStyle="rgba(0,0,0,0.7)",l.fillRect(10,10,200,40),l.fillStyle="#fbbf24",l.font="bold 16px sans-serif",l.fillText(`Click on ${Ot[c.length]}`,20,36),l.restore()),c.forEach((H,z)=>{yo(l,H,"#f472b6"),l.save(),l.fillStyle="#f472b6",l.font="14px sans-serif",l.fillText(Ot[z]??String(z+1),H.x+6,H.y-6),l.restore()}),Z&&!xe){l.save(),l.fillStyle="rgba(59,130,246,0.10)";const H=Math.round(Math.min(b.width,b.height)*.08),z=b.width-H*2,Pe=b.height-H*2;l.fillRect(H,H,z,Pe),l.strokeStyle="rgba(34,197,94,0.9)",l.lineWidth=2,l.beginPath(),l.moveTo(H,b.height/2),l.lineTo(b.width-H,b.height/2),l.stroke(),l.beginPath(),l.moveTo(b.width/2,H),l.lineTo(b.width/2,b.height-H),l.stroke(),l.strokeStyle="rgba(234,179,8,0.9)",l.setLineDash([6,4]);const ue=H+30,ee=H+30;l.beginPath(),l.moveTo(ue,ee+30),l.lineTo(ue+60,ee),l.stroke(),l.beginPath(),l.moveTo(b.width-ue,ee+30),l.lineTo(b.width-ue-60,ee),l.stroke(),l.restore(),l.save(),l.scale(1/p,1/p),l.fillStyle="rgba(255,255,255,0.85)",l.font="12px sans-serif",l.fillText("Tip: Frame board centered, edges parallel; slight top-down is okay. Keep bull near center.",H*p,(H+18)*p),l.restore()}}const lo=c=>{if(!c)return;Ke(!1),tt(null),ot(!1),c.anchors?.dst&&c.anchors.dst.length>0&&(B(c.anchors.dst),Qt(c.anchors.dst,c.H));let f=c.H;Oe!==1&&(f=Pn(f,Oe,1)),(Ye!==0||Qe!==0)&&(f=jr(f,Ye,Qe)),J({H:f,createdAt:Date.now(),errorPx:c.errorPx,imageSize:c.imageSize,overlaySize:c.overlaySize,anchors:c.anchors,locked:c.locked}),M(c.phase??"computed"),Je(c.confidence??100),nt("Test auto-detect applied"),delete globalThis.__TEST_AUTO_DETECT_RESULT};function Xt(c){try{const f=typeof c=="number"?c:Tn;console.debug("[Camera Connection] doCommit invoked",{v:f,inProgress:Rt.getState().inProgress});const v=tn.getState?tn.getState():void 0,b=!!v?.H&&!!v?.imageSize&&(v.locked||typeof v.errorPx=="number"&&v.errorPx<=K);if(f!=null&&Rt.getState().inProgress&&b){const l=`${f}|3`,U=performance.now();if(!Lt.current&&!(l===An.current&&U-Bn.current<Ln)){An.current=l,Bn.current=U,Lt.current=!0,console.debug("[Camera Connection] doCommit: committing visit",f,{calState:v,curCalValid:b});try{Rt.getState().addVisit(f,3,{visitTotal:f})}catch{}try{window.setTimeout(()=>{Lt.current=!1},Math.max(120,Ln))}catch{}}else console.debug("[Camera Connection] doCommit: deduped commit skipped",{v:f,curCalValid:b,sig:l})}else console.debug("[Camera Connection] doCommit: NOT committing (invalid cal or no match)",{v:f,inProgress:Rt.getState().inProgress,curCalValid:b,calState:v})}catch{}}async function uo(){try{if(console.debug("[Camera Connection] autoDetectRings invoked"),!t.current){alert("Load a photo or capture a frame first."),Ke(!1);return}const c=globalThis.__TEST_AUTO_DETECT_RESULT;if(c){console.debug("[Camera Connection] testAutoDetectResult detected (legacy)"),lo(c);return}Ke(!0),nt("Using advanced detection algorithm..."),At(null);const f=Xn(t.current,rt?{centerHint:rt,colorAssist:!0}:{colorAssist:!0});if(console.log("[Camera Connection] detectBoard returned:",{success:f.success,confidence:f.confidence,hasHomography:!!f.homography,numPoints:f.calibrationPoints.length},f.message),!f.success||!f.homography||f.confidence<40){console.warn("[Camera Connection] Auto-detect failed, result:",{success:f.success,confidence:f.confidence,hasHomography:!!f.homography}),nt(f.message||"âŒ Detection failed. Try better lighting or different angle."),Ke(!1);return}tt({cx:f.cx,cy:f.cy,bullInner:f.bullInner,bullOuter:f.bullOuter,trebleInner:f.trebleInner,trebleOuter:f.trebleOuter,doubleInner:f.doubleInner,doubleOuter:f.doubleOuter}),ot(!0),B(f.calibrationPoints),Qt(f.calibrationPoints,f.homography);const v=s?.current?{w:s.current.width,h:s.current.height}:e?.current?{w:e.current.clientWidth,h:e.current.clientHeight}:{w:t.current.width,h:t.current.height},b=e.current?{w:e.current.videoWidth,h:e.current.videoHeight}:{w:t.current.width,h:t.current.height},l=Co(f.homography,"outer");J({H:f.homography,createdAt:Date.now(),errorPx:f.errorPx??null,imageSize:b,overlaySize:v,anchors:{src:En("outer").slice(0,4),dst:f.calibrationPoints},theta:typeof f.theta=="number"?f.theta:null,sectorOffset:l});const U=fo(f.homography,f.calibrationPoints);Wr(U),M("verify"),Je(Br?100:Math.round(f.confidence)),nt("âœ… Detected rings â€” Please verify alignment by looking at the overlay"),Ke(!1);try{let ne=1;for(let ae=1;ae<3;ae++){const Y=document.createElement("canvas");Y.width=Math.max(1,Math.round(t.current.width*.9)),Y.height=Math.max(1,Math.round(t.current.height*.9)),Y.getContext("2d").drawImage(t.current,0,0,Y.width,Y.height);const He=rt?{centerHint:{x:rt.x*.9,y:rt.y*.9},colorAssist:!0}:{colorAssist:!0},ye=Xn(Y,He);ho(f,ye)&&ne++}ne>=Math.ceil(3*.66)&&console.log("[Camera Connection] Detection is stable")}catch(G){console.warn("[Camera Connection] Legacy stability check failed:",G)}}catch(c){console.error("[Camera Connection] autoDetectRings failed:",c),nt(`âŒ Auto-detect failed: ${c instanceof Error?c.message:String(c)}`),Ke(!1)}}function fo(c,f){const v=[];if(!c||!f||f.length===0)return v;for(const b of ua){if(b.idx>=f.length)continue;const l=f[b.idx];let U=null;try{U=vo(c,l)}catch(Y){console.warn("[Camera Connection] Failed to convert image point to board space:",Y)}let G=null,ne=null,Me=null,ae=!1;if(U)try{if(G=So(U,typeof F=="number"?F:0,q??0),G.ring===b.ring&&G.sector===b.sector)ae=!0,ne=0;else{const Y=$[b.ring==="DOUBLE"?"doubleOuter":b.ring==="INNER_BULL"?"bullInner":b.ring==="BULL"?"bullOuter":"doubleOuter"],ge=Math.hypot(U.x,U.y);ne=Math.abs(ge-Y),Me=Math.hypot(l.x-(W?.cx??0),l.y-(W?.cy??0)),ae=ne<=b.toleranceMm}}catch(Y){console.warn("[Camera Connection] Failed to score detected point:",Y)}v.push({label:b.label,expected:{ring:b.ring,sector:b.sector},detected:G,deltaMm:ne,deltaPx:Me,match:ae,note:ae?"âœ… OK":`âŒ Off by ${ne?.toFixed(1)}mm`})}return v}function ho(c,f,v=.03){if(!c||!f)return!1;const b=Math.abs((c.cx-f.cx)/(c.cx||1)),l=Math.abs((c.cy-f.cy)/(c.cy||1)),U=Math.abs((c.doubleOuter-f.doubleOuter)/(c.doubleOuter||1));return b<=v&&l<=v&&U<=v}const Kn=g.useRef(null);if(g.useEffect(()=>{let c=null;try{c=new Worker(new URL("/assets/boardDetection.worker-CCEKArUr.js",import.meta.url),{type:"module"}),Kn.current=c,console.log("[Camera Connection] Board detection worker created")}catch(f){console.warn("[Camera Connection] Failed to create board detection worker, will fallback to main thread: ",f),Kn.current=null}return()=>{try{c?.terminate()}catch{}}},[]),g.useEffect(()=>{Qt()},[N,L,Oe,Ye,Qe]),g.useEffect(()=>{if(!De||!y)return;let c=0;const f=()=>{try{co()}catch{}c=requestAnimationFrame(f)};return c=requestAnimationFrame(f),()=>cancelAnimationFrame(c)},[De,y]),g.useEffect(()=>{(async()=>{try{if(!xe||!Ee)return;const c=t.current?{w:t.current.width,h:t.current.height}:null,f=JSON.stringify({H:L,anchors:null,imageSize:c,errorPx:te??null});try{await Pt(`/cam/calibration/${Ee}`,{method:"POST",headers:{"Content-Type":"application/json"},body:f}),console.log("[Camera Connection] Posted connection for code",Ee)}catch(v){console.warn("[Camera Connection] Upload connection failed",v)}try{const v=localStorage.getItem("authToken");v&&(await Pt("/api/user/calibration",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${v}`},body:f}),console.log("[Camera Connection] Synced connection to user account"))}catch(v){console.warn("[Camera Connection] User connection sync failed",v)}}catch{}})()},[xe,Ee]),T&&!j){const c=no??(typeof window<"u"?`${window.location.origin.replace(/\/$/,"")}/mobile-cam.html`:"/mobile-cam.html");return a.jsxs("div",{className:"mx-auto flex min-h-[calc(100vh-140px)] w-full max-w-xl flex-col justify-center gap-6 p-6",children:[a.jsxs("div",{className:"space-y-5 rounded-3xl border border-indigo-400/30 bg-slate-900/70 p-6 text-slate-100 shadow-xl",children:[a.jsxs("div",{className:"space-y-2",children:[a.jsx("p",{className:"text-xs font-semibold uppercase tracking-wide text-indigo-300",children:"Choose Mode"}),a.jsx("h2",{className:"text-2xl font-semibold leading-tight text-white",children:"How do you want to use this device?"}),a.jsx("p",{className:"text-sm text-slate-200/80",children:"You can stream this camera to another device (Remote Camera) or\\n play and calibrate directly on this screen."})]}),a.jsxs("div",{className:"space-y-2",children:[a.jsx("a",{href:c,className:"btn w-full justify-center px-4 py-2 text-base",children:"Open mobile camera"}),a.jsx("button",{type:"button",className:"btn btn--ghost w-full justify-center px-4 py-2 text-sm",onClick:()=>Yt(c,"link"),children:Jt==="link"?"Link copied!":"Copy link"})]}),a.jsxs("p",{className:"text-xs text-slate-300/70",children:["On a desktop, open Camera Connection and generate a pairing code. Then tap ",a.jsx("span",{className:"font-semibold",children:"Pair with Desktop"})," ","from the mobile camera page to connect this device."]})]}),a.jsx("button",{type:"button",className:"self-center text-xs font-medium text-indigo-200 underline decoration-dotted decoration-indigo-300/70 transition hover:text-indigo-100",onClick:()=>h(!0),children:"Continue to desktop connection"})]})}return a.jsxs("div",{className:"space-y-6",children:[T&&j&&a.jsx("div",{className:"rounded-2xl border border-indigo-400/30 bg-indigo-500/10 p-4 text-sm text-indigo-100",children:a.jsxs("div",{className:"flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between",children:[a.jsx("p",{className:"leading-relaxed",children:"Using a phone? Switch back to the streamlined mobile camera interface for an easier pairing flow."}),a.jsx("button",{type:"button",className:"btn btn--ghost px-3 py-1 text-xs",onClick:()=>h(!1),children:"Open mobile camera mode"})]})}),a.jsxs("div",{className:"card space-y-6 p-6",children:[a.jsxs("header",{className:"flex flex-wrap items-start justify-between gap-4",children:[a.jsxs("div",{className:"space-y-2",children:[a.jsx("p",{className:"text-xs font-semibold uppercase tracking-wide text-indigo-300",children:"Camera alignment"}),a.jsx("h2",{className:"text-2xl font-semibold leading-tight text-white",children:"Camera connection"}),a.jsx("p",{className:"max-w-2xl text-sm opacity-80",children:"Select and test your camera. Manual scoring mode does not require calibration."})]}),a.jsxs("div",{className:"flex flex-col items-end gap-2 text-xs font-medium",children:[a.jsxs("span",{className:"inline-flex items-center gap-2 rounded-full border border-indigo-400/50 bg-indigo-500/10 px-3 py-1",children:[a.jsx("span",{className:"opacity-60",children:"Mode"}),a.jsx("span",{children:S==="local"?"Desktop camera":S==="phone"?"Phone camera":"Wifi device"})]}),a.jsxs("span",{className:`inline-flex items-center gap-2 rounded-full border px-3 py-1 ${y?"border-emerald-400/60 bg-emerald-500/10 text-emerald-100":"border-white/20 bg-white/5 text-slate-200"}`,children:[a.jsx("span",{className:`h-2 w-2 rounded-full ${y?"bg-emerald-400":"bg-slate-400"}`}),y?"Live stream active":"Stream idle"]}),xe?a.jsxs("div",{className:"space-y-3 rounded-2xl border border-emerald-400/40 bg-emerald-500/10 p-4 text-sm",children:[a.jsxs("div",{className:"flex items-center justify-between gap-2",children:[a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx("div",{className:"flex h-10 w-10 items-center justify-center rounded-full bg-emerald-500/20",children:a.jsx("span",{className:"text-lg",children:"âœ“"})}),a.jsxs("div",{children:[a.jsx("h4",{className:"font-semibold text-emerald-100",children:"Connection locked"}),a.jsx("p",{className:"text-xs opacity-80",children:"Your camera connection is saved and active across all game modes. It will be used in Online, Offline, and Tournaments."})]})]}),a.jsx("button",{className:"btn btn--ghost px-2 py-1 text-xs whitespace-nowrap",onClick:()=>J({locked:!1}),title:"Unlock to realign",children:"Unlock"})]}),te!=null&&a.jsxs("div",{className:"text-xs opacity-75",children:["Precision: ",te.toFixed(2)," px RMS error"]})]}):null]})]}),a.jsxs("div",{className:"grid gap-6 xl:grid-cols-[minmax(0,2fr)_minmax(320px,1fr)]",children:[a.jsx("section",{className:"space-y-4",children:a.jsxs("div",{className:"space-y-4 rounded-2xl border border-white/10 bg-black/40 p-4",children:[a.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-4 text-xs",children:[a.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[a.jsx("span",{className:"uppercase tracking-wide opacity-60",children:"Video source"}),a.jsxs("div",{className:"flex items-center gap-1",children:[a.jsx("button",{className:`btn px-3 py-1 ${S==="local"?"bg-emerald-600 hover:bg-emerald-700":"bg-slate-700 hover:bg-slate-600"}`,"data-testid":"mode-local",onClick:()=>{R("local"),typeof DROPDOWN_DEBUG<"u"&&DROPDOWN_DEBUG&&console.debug("[Camera Connection] setMode(local)",Date.now()),_e(!1)},title:"Use local camera",children:"Local"}),!T&&a.jsx("button",{className:`btn px-3 py-1 ${S==="phone"?"bg-emerald-600 hover:bg-emerald-700":"bg-slate-700 hover:bg-slate-600"}`,"data-testid":"mode-phone",onClick:()=>{typeof DROPDOWN_DEBUG<"u"&&DROPDOWN_DEBUG&&console.debug("[Camera Connection] setMode(phone)",Date.now()),lt()},title:"Pair phone camera via QR code",children:"Phone"}),a.jsx("button",{className:`btn px-3 py-1 ${S==="wifi"?"bg-emerald-600 hover:bg-emerald-700":"bg-slate-700 hover:bg-slate-600"}`,"data-testid":"mode-wifi",onClick:()=>{R("wifi"),typeof DROPDOWN_DEBUG<"u"&&DROPDOWN_DEBUG&&console.debug("[Camera Connection] setMode(wifi)",Date.now()),_e(!1);try{Et()}catch(c){console.debug("[Camera Connection] startWifiConnection failed",c)}},title:"Discover wifi/USB autoscoring devices",children:"Wifi"})]})]}),a.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx("span",{className:"opacity-70",children:"Zoom"}),a.jsx("input",{type:"range",min:50,max:200,step:5,value:Math.round(p*100),onChange:c=>C(Math.max(.5,Math.min(2,Number(c.target.value)/100)))}),a.jsxs("span",{className:"w-12 text-right",children:[Math.round(p*100),"%"]})]}),a.jsx("button",{className:"btn px-3 py-1",onClick:()=>C(1),children:"Actual"})]})]}),a.jsxs("div",{className:"ml-3 relative",children:[a.jsxs("button",{className:"inline-flex items-center gap-2 rounded-full border border-indigo-400/30 bg-indigo-400/10 px-3 py-1 text-sm",onClick:()=>$r(!On),"data-testid":"cal-tools-popper-button",children:[a.jsx("span",{className:"font-semibold",children:"Cam Tools"}),Le&&a.jsx("span",{className:"ml-2 text-xs opacity-70",children:"(overlay preserved)"})]}),On&&a.jsxs("div",{className:"absolute right-0 mt-2 w-64 rounded-lg border bg-gray-900/80 p-3 shadow-lg z-50","data-testid":"cal-tools-popover",role:"dialog",children:[a.jsx("div",{className:"text-xs mb-2",children:"Camera connection quick tools"}),a.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[a.jsx("input",{id:"hdr-show-darts",type:"checkbox",checked:Rn,onChange:c=>Lr(c.target.checked)}),a.jsx("label",{htmlFor:"hdr-show-darts",className:"text-sm",children:"Show darts overlay"})]}),a.jsx("div",{className:"flex items-center gap-2 mb-2",children:a.jsx("button",{className:"btn btn--ghost btn-sm",onClick:()=>Gr(),children:"Reset visual adjustments"})}),a.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[a.jsx("input",{id:"hdr-autocommit",type:"checkbox",checked:Bt,onChange:c=>Fr(c.target.checked)}),a.jsx("label",{htmlFor:"hdr-autocommit",className:"text-sm",children:"Enable autocommit test"})]}),a.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[a.jsx("input",{id:"hdr-autocommit-online",type:"checkbox",checked:qe,onChange:c=>gt(c.target.checked),disabled:!Bt}),a.jsx("label",{htmlFor:"hdr-autocommit-online",className:"text-sm",children:"Allow autocommit in Online/Tournament matches (dangerous)"})]}),a.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[a.jsx("input",{id:"hdr-autocommit-immediate",type:"checkbox",checked:Ur,onChange:c=>_r(c.target.checked)}),a.jsx("label",{htmlFor:"hdr-autocommit-immediate",className:"text-sm",children:"Autocommit immediate when detected"})]}),a.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[a.jsx("input",{id:"hdr-show-detected",type:"checkbox",checked:Un,onChange:c=>Vr(c.target.checked)}),a.jsx("label",{htmlFor:"hdr-show-detected",className:"text-sm",children:"Show detected rings overlay"})]}),a.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[a.jsx("input",{id:"hdr-force-detected",type:"checkbox",checked:Ut,onChange:c=>ot(c.target.checked)}),a.jsx("label",{htmlFor:"hdr-force-detected",className:"text-sm",children:"Force detected-only overlay (bypass homography)"})]}),a.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[a.jsx("label",{htmlFor:"hdr-double-adjust",className:"text-sm mr-2",children:"Double adj"}),a.jsx("input",{id:"hdr-double-adjust",type:"range",min:.95,max:1.1,step:.005,value:_t,onChange:c=>$t(parseFloat(c.target.value))}),a.jsxs("span",{className:"text-xs ml-2",children:[(_t*100).toFixed(1),"%"]})]}),a.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[a.jsx("label",{htmlFor:"hdr-treble-adjust",className:"text-sm mr-2",children:"Treble adj"}),a.jsx("input",{id:"hdr-treble-adjust",type:"range",min:.95,max:1.1,step:.005,value:qt,onChange:c=>Wt(parseFloat(c.target.value))}),a.jsxs("span",{className:"text-xs ml-2",children:[(qt*100).toFixed(1),"%"]})]}),a.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[a.jsxs("select",{id:"hdr-align-select",className:"input",value:We||"",onChange:c=>Ht(c.target.value?c.target.value:null),children:[a.jsx("option",{value:"",children:"-- Align ring --"}),a.jsx("option",{value:"double",children:"Double Outer"}),a.jsx("option",{value:"treble",children:"Treble Outer"}),a.jsx("option",{value:"bull",children:"Bull Outer"})]}),a.jsx("div",{className:"text-xs opacity-70 ml-2",children:"Click on the physical ring to align"})]}),a.jsxs("div",{className:"flex items-center justify-between mt-2",children:[a.jsx("div",{className:"text-xs opacity-70",children:Dn||"No recent detection"}),a.jsx("div",{children:a.jsx("button",{className:"btn btn--small",onClick:()=>{console.debug("[Camera Connection] popover Commit click (onClick)"),Xt()},onPointerDown:()=>{console.debug("[Camera Connection] popover Commit click (onPointerDown)"),Xt()},children:"Commit"})})]})]})]}),a.jsxs("div",{className:"relative w-full overflow-hidden rounded-2xl border border-indigo-400/30 bg-black",style:{aspectRatio:m?`${m.w} / ${m.h}`:"16 / 9"},children:[a.jsxs("div",{className:"absolute top-2 right-2 z-40 flex items-center gap-2 rounded-full bg-black/40 px-2 py-1 text-[11px] text-white backdrop-blur",children:[a.jsx("span",{className:`inline-block h-2 w-2 rounded-full ${y?"bg-emerald-400":"bg-rose-500"}`,"aria-hidden":"true"}),a.jsx("span",{children:y?"Connected":"Disconnected"})]}),a.jsxs("div",{className:"absolute inset-0",style:{transform:`scale(${p})`,transformOrigin:"center center"},children:[a.jsx("video",{ref:e,onLoadedMetadata:c=>{try{const f=c.currentTarget;f.videoWidth&&f.videoHeight&&w({w:f.videoWidth,h:f.videoHeight})}catch{}},className:`absolute inset-0 h-full w-full object-cover transition-opacity duration-300 ${N?"opacity-0 -z-10":"opacity-100 z-10"}`,autoPlay:!0,playsInline:!0,muted:!0,controls:!1}),k&&a.jsx("div",{className:"absolute inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur",children:a.jsx("button",{className:"rounded-lg bg-white px-4 py-2 font-semibold text-slate-900 shadow-lg",onClick:async()=>{try{await e.current?.play(),E(!1),P(!0),M("capture")}catch(c){console.warn("Tap-to-play retry failed",c),alert("Tap to enable video failed. Please check browser settings or reload the page.")}},children:"Tap to allow video"})}),a.jsx("canvas",{ref:t,className:`absolute inset-0 h-full w-full transition-opacity duration-300 ${N?"opacity-100 z-10":"opacity-0 -z-10"}`})]})]}),a.jsxs("div",{className:"mt-4 flex flex-wrap items-center gap-2",children:[y?a.jsx("button",{className:"btn",onClick:()=>_e(!0),children:"Disconnect"}):a.jsx("button",{className:"btn",onClick:so,children:"Connect"}),a.jsx("span",{className:"text-xs opacity-70",children:y?"Camera connected":"Camera not connected"})]})]})}),a.jsxs("aside",{className:"space-y-4",children:[a.jsx(da,{videoDevices:r,streaming:y,refreshVideoDevices:ct,testCamera:ro,onSelectPhoneCamera:A,lastDetectedLabel:Dn,autoCommitTestMode:Bt,doCommit:Xt,lastDetectedValue:Tn,cameraConnected:y}),S==="phone"&&!T&&a.jsxs("section",{className:"space-y-3 rounded-2xl border border-indigo-400/30 bg-black/40 p-4 text-xs text-white",children:[a.jsx("div",{className:"font-semibold",children:"Phone pairing"}),_n&&Ee&&a.jsxs("div",{className:"flex flex-col items-center gap-2 rounded-xl bg-white p-3",children:[a.jsx("img",{src:_n,alt:"Scan to pair mobile camera",className:"w-48 h-48",draggable:!1}),a.jsx("div",{className:"text-[11px] text-slate-700 text-center font-medium",children:"Scan with your phone to pair"})]}),a.jsxs("button",{type:"button",className:"w-full text-left px-3 py-2 rounded-lg border border-white/10 bg-white/5 hover:bg-white/10 transition flex items-center gap-2",onClick:()=>Yt(Ue,"link"),title:"Copy mobile camera link",children:[a.jsx("span",{className:"flex-1 min-w-0 font-mono break-all text-[11px]",children:Ue}),a.jsx("span",{className:"text-[10px] uppercase tracking-wide whitespace-nowrap text-emerald-200",children:Jt==="link"?"Copied!":"Copy link"})]}),a.jsx("div",{className:"flex items-center gap-2 text-[11px]",children:a.jsx("a",{href:Ue,target:"_blank",rel:"noreferrer",className:"underline decoration-dotted text-indigo-200 hover:text-indigo-100 transition",children:"Open link in new tab"})}),a.jsxs("div",{className:"opacity-80",children:["WS:"," ",vt?vt.readyState===1?"open":vt.readyState===0?"connecting":vt.readyState===2?"closing":"closed":"not started"," ","Â· ",Ze?.https?"HTTPS on":"HTTP only"]}),Ee&&a.jsxs("button",{type:"button",className:"w-full text-left px-3 py-2 rounded-lg border border-white/10 bg-white/5 hover:bg-white/10 transition flex items-center justify-between gap-2",onClick:()=>Yt(Ee,"code"),title:"Copy pairing code",children:[a.jsx("span",{className:"font-mono tracking-[0.3em] text-sm",children:Ee}),a.jsx("span",{className:"text-[10px] uppercase tracking-wide whitespace-nowrap text-emerald-200",children:Jt==="code"?"Copied!":"Copy code"})]}),a.jsxs("div",{className:"flex items-center gap-2",children:[Gn!==null&&a.jsxs("span",{children:["Expires in ",Gn,"s"]}),a.jsx("button",{className:"btn px-2 py-1 text-xs",onClick:io,children:"Regenerate"})]}),Zr&&a.jsxs("div",{className:"space-y-2 rounded-lg border border-slate-700/50 bg-slate-900/60 p-3 text-slate-200",children:[a.jsx("div",{className:"font-semibold",children:"Troubleshooting"}),a.jsxs("ul",{className:"list-disc space-y-1 pl-4",children:[a.jsx("li",{children:"Phone and desktop must be on the same Wiâ€‘Fi network."}),a.jsxs("li",{children:["Allow the server through your firewall (ports 8787 and"," ",Ze?.https?Ze.port:8788,")."]}),a.jsx("li",{children:"On iPhone, use HTTPS links (QR will prefer HTTPS when enabled)."})]}),a.jsx("div",{className:"text-right",children:a.jsx("button",{className:"btn btn--ghost px-2 py-1 text-xs",onClick:()=>eo(!1),children:"Hide tips"})})]})]})]})]}),S==="wifi"&&!y&&a.jsxs("section",{className:"space-y-3 rounded-2xl border border-indigo-400/30 bg-black/40 p-4 text-xs text-white",children:[a.jsx("div",{className:"font-semibold",children:"Wifi scoring devices"}),to?a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx("div",{className:"h-4 w-4 animate-spin rounded-full border-b-2 border-white"}),a.jsx("span",{children:"Scanning network for devicesâ€¦"})]}):zn.length>0?a.jsxs("div",{className:"space-y-2",children:[zn.map(c=>a.jsxs("div",{className:"flex items-center justify-between rounded border border-slate-700/50 bg-slate-900/60 p-2",children:[a.jsxs("div",{children:[a.jsx("div",{className:"font-medium",children:c.name}),a.jsxs("div",{className:"opacity-70",children:[c.ip,":",c.port," Â· ",c.type.toUpperCase()]}),a.jsxs("div",{className:"opacity-70 text-xs",children:["Capabilities: ",c.capabilities.join(", ")]})]}),a.jsx("button",{className:`btn px-2 py-1 text-xs ${c.status==="connecting"?"bg-yellow-600":c.status==="online"?"bg-green-600":"bg-blue-600"}`,onClick:()=>ao(c),disabled:c.status==="connecting",children:c.status==="connecting"?"Connectingâ€¦":"Connect"})]},c.id)),a.jsx("div",{className:"text-center",children:a.jsx("button",{className:"btn px-2 py-1 text-xs",onClick:Et,children:"Rescan network"})})]}):a.jsxs("div",{className:"space-y-2 text-center",children:[a.jsx("div",{children:"No wifi scoring devices found."}),a.jsx("div",{className:"opacity-70",children:"Ensure your wifi cameras are powered on and on the same network."}),a.jsx("button",{className:"btn px-2 py-1 text-xs",onClick:Et,children:"Scan again"})]})]})]})]})}function Ea(){const[e,t]=g.useState(()=>jn());return g.useEffect(()=>{const s=()=>t(jn());return s(),window.addEventListener("resize",s),()=>window.removeEventListener("resize",s)},[]),e?a.jsx(ha,{}):a.jsxs("div",{className:"card ndn-game-shell relative overflow-hidden",children:[a.jsx("h2",{className:"text-3xl font-bold text-brand-700 mb-4",children:"Camera Setup"}),a.jsx("div",{className:"ndn-shell-body",children:a.jsx(fa,{})})]})}function Dt(e){const t=(e||"").toLowerCase();return/vert|scolia|gran\s?board|target\s?nexus|auto\s?score|dart\s?connect|my\s?dart/i.test(t)?"smart":/bluetooth|bt[\s-]/i.test(t)?"bluetooth":/usb|logitech|razer|elgato|obs|virtual|cam\s?link|capture|hdmi|avermedia|magewell/i.test(t)?"usb":"builtin"}function ha(){const e=g.useRef(null),[t,s]=g.useState([]),[o,n]=g.useState(!1),[r,d]=g.useState(!1),[i,u]=g.useState(null),[y,P]=g.useState(!1),[k,E]=g.useState(null),S=Re(h=>h.preferredCameraId);Re(h=>h.preferredCameraLabel);const R=Re(h=>h.preferredCameraLocked),O=Re.getState().setPreferredCamera,B=Rr(),N=g.useCallback(async()=>{try{if(!navigator?.mediaDevices?.enumerateDevices)return;const h=await navigator.mediaDevices.enumerateDevices();s(h.filter(T=>T.kind==="videoinput"))}catch{}},[]);g.useEffect(()=>{N();try{navigator.mediaDevices.addEventListener("devicechange",N)}catch{}return()=>{try{navigator.mediaDevices.removeEventListener("devicechange",N)}catch{}}},[N]);const D=g.useCallback(async h=>{if(!r){d(!0),u(null);try{const T={video:h?{deviceId:{exact:h},width:{ideal:1920},height:{ideal:1080},frameRate:{ideal:30}}:{facingMode:"environment",width:{ideal:1920},height:{ideal:1080},frameRate:{ideal:30}},audio:!1};let x;try{x=await navigator.mediaDevices.getUserMedia(T)}catch{x=await navigator.mediaDevices.getUserMedia({video:!0,audio:!1})}e.current&&(e.current.srcObject=x,await No({video:e.current,stream:x,onPlayError:()=>{}}));try{B.setMediaStream?.(x),B.setMode?.("local"),B.setStreaming?.(!0),B.setStarting?.(!1),e.current&&B.setVideoElementRef?.(e.current)}catch{}n(!0),await N()}catch(T){const x=T?.name||"";u(x==="NotAllowedError"||x==="SecurityError"?"Camera permission denied. Allow camera access in your browser settings.":x==="NotFoundError"||x==="OverconstrainedError"?"Camera not found. Try selecting a different device.":"Could not start camera. Please try again.")}finally{d(!1)}}},[r,B,N]),I=g.useCallback(()=>{try{const h=B.getMediaStream?.();h&&h.getTracks().forEach(T=>T.stop())}catch{}if(e.current)try{e.current.srcObject=null}catch{}try{B.setMediaStream?.(null),B.setStreaming?.(!1),B.setVideoElementRef?.(null)}catch{}n(!1)},[B]);g.useEffect(()=>{const h=B.getMediaStream?.();if(h?.getVideoTracks()?.length){if(e.current&&!e.current.srcObject){e.current.srcObject=h;try{Promise.resolve(e.current.play()).catch(()=>{})}catch{}}n(!0),N()}else D(S||void 0)},[]);const M=g.useCallback(async h=>{const T=t.find(x=>x.deviceId===h)?.label||"";O(h,T,!0),I(),await new Promise(x=>setTimeout(x,150)),await D(h)},[t,O,I,D]),A=g.useCallback(()=>{Re.getState().setPreferredCameraLocked(!R)},[R]),m=g.useCallback(async()=>{E(null),P(!0);try{if(!navigator?.bluetooth?.requestDevice){E("Bluetooth not supported in this browser.");return}await navigator.bluetooth.requestDevice({acceptAllDevices:!0,optionalServices:[]}),await N()}catch(h){h?.name!=="NotFoundError"&&E("Bluetooth scan failed. Make sure Bluetooth is enabled.")}finally{P(!1)}},[N]),w=t.filter(h=>Dt(h.label)==="smart"),p=t.filter(h=>Dt(h.label)==="bluetooth"),C=t.filter(h=>Dt(h.label)==="usb"),j=t.filter(h=>Dt(h.label)==="builtin");return a.jsx("div",{className:"p-3 text-white",children:a.jsxs("div",{className:"rounded-2xl border border-white/10 bg-slate-950/70 shadow-2xl ring-1 ring-white/5 overflow-hidden",children:[a.jsxs("div",{className:"flex items-center justify-between px-3 py-2 border-b border-white/5 bg-white/5",children:[a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx("div",{className:`w-2 h-2 rounded-full shadow-lg ${o?"bg-emerald-400 shadow-emerald-400/50 animate-pulse":"bg-slate-500"}`}),a.jsx("span",{className:"text-xs sm:text-sm font-semibold text-white/80",children:"Board Camera"})]}),a.jsx("span",{className:"text-[10px] sm:text-xs font-medium text-white/50",children:o?"Live":r?"Startingâ€¦":"Idle"})]}),a.jsxs("div",{className:"relative min-h-[12rem] max-h-[50vh] bg-black aspect-[4/3]",children:[a.jsx("video",{ref:e,className:"absolute inset-0 w-full h-full object-cover bg-black",playsInline:!0,muted:!0,autoPlay:!0}),!o&&!r&&!i&&a.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-black/80",children:a.jsx("button",{className:"bg-indigo-600 hover:bg-indigo-700 text-white font-semibold px-5 py-2.5 rounded-xl text-sm shadow-lg",onClick:()=>D(S||void 0),children:"Start Camera"})}),r&&a.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-black/80",children:a.jsx("div",{className:"text-white/80 text-sm font-medium animate-pulse",children:"Starting cameraâ€¦"})}),i&&a.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-black/80 px-4",children:a.jsxs("div",{className:"text-center space-y-2 max-w-xs",children:[a.jsx("div",{className:"text-rose-300 text-xs font-medium",children:i}),a.jsx("button",{className:"bg-indigo-600 hover:bg-indigo-700 text-white font-semibold px-4 py-2 rounded-xl text-xs",onClick:()=>D(S||void 0),children:"Retry"})]})})]}),a.jsxs("div",{className:"flex flex-col gap-1.5 px-3 py-2 border-t border-white/5 bg-white/[0.03]",children:[a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsxs("select",{className:"flex-1 min-w-0 bg-slate-800 text-white rounded-lg px-2 py-1.5 text-xs border border-white/10 min-h-[2rem]",value:S||"",onChange:h=>M(h.target.value||void 0),disabled:r||R,children:[a.jsx("option",{value:"",children:"Auto (back camera)"}),w.length>0&&a.jsx("optgroup",{label:"ðŸŽ¯ Smart Cameras (Verte Â· Scolia Â· GranBoard)",children:w.map(h=>a.jsx("option",{value:h.deviceId,children:h.label},h.deviceId))}),C.length>0&&a.jsx("optgroup",{label:"ðŸ”Œ USB / Capture Devices",children:C.map(h=>a.jsx("option",{value:h.deviceId,children:h.label||(h.deviceId?`Camera (${h.deviceId.slice(0,8)}â€¦)`:"Camera")},h.deviceId))}),p.length>0&&a.jsx("optgroup",{label:"ðŸ“¶ Bluetooth",children:p.map(h=>a.jsx("option",{value:h.deviceId,children:h.label||(h.deviceId?`BT Camera (${h.deviceId.slice(0,8)}â€¦)`:"BT Camera")},h.deviceId))}),j.length>0&&a.jsx("optgroup",{label:"ðŸ“± Built-in",children:j.map(h=>a.jsx("option",{value:h.deviceId,children:h.label||(h.deviceId?`Camera (${h.deviceId.slice(0,8)}â€¦)`:"Camera")},h.deviceId))})]}),a.jsx("button",{className:`rounded-lg px-2 py-1.5 text-xs font-semibold border min-h-[2rem] transition-colors ${R?"bg-emerald-600/30 border-emerald-400/40 text-emerald-200":"bg-slate-800 border-white/10 text-white/60"}`,onClick:A,children:R?"ðŸ”’":"ðŸ”“"}),a.jsx("button",{className:"rounded-lg px-2 py-1.5 bg-slate-800 border border-white/10 text-white/60 text-xs min-h-[2rem]",onClick:N,title:"Rescan USB & Wi-Fi cameras",children:"â†»"}),o&&a.jsx("button",{className:"rounded-lg px-2 py-1.5 text-xs font-medium text-rose-400 hover:text-rose-300 border border-rose-400/20 min-h-[2rem]",onClick:I,children:"Stop"})]}),a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx("button",{className:"flex-1 rounded-lg px-2 py-1.5 bg-indigo-700/40 hover:bg-indigo-700/60 border border-indigo-400/20 text-indigo-200 text-xs font-medium min-h-[2rem] transition-colors disabled:opacity-40",onClick:m,disabled:y||R,children:y?"Scanningâ€¦":"ðŸ“¶ Pair Bluetooth Camera"}),t.length===0&&a.jsx("span",{className:"text-[10px] text-amber-300/80",children:"No cameras found"})]}),k&&a.jsx("div",{className:"text-[10px] text-rose-300/80",children:k})]})]})})}export{Ea as default};
//# sourceMappingURL=CameraSetup-C7m8EEOM.js.map
