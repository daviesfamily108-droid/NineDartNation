import{C as I,u as ce,t as ie,j as e,D as oe,E as de}from"./index-Bx2Xb2t1.js";import{r as a,R as G}from"./ui-gqBJRRJB.js";import{G as me}from"./GameCalibrationStatus-TMPMGnpX.js";import{M as Z}from"./MatchStartShowcase-DoCEMchT.js";import{u as _}from"./match-BNL0c8h2.js";import"./vendor-D3F3s8fL.js";function he({open:u,onClose:x,onCreate:S}){const[m]=a.useState(()=>document.createElement("div")),[d,C]=a.useState("X01"),[l,b]=a.useState("bestof"),[k,f]=a.useState(3),p=a.useRef(null),[y,g]=a.useState(0),[N,M]=a.useState(()=>I(d)?.[0]),j=ce().username||"Anonymous";a.useLayoutEffect(()=>(m.className="ndn-create-match-portal",document.body.appendChild(m),()=>{try{m&&m.remove()}catch{}}),[m]),a.useLayoutEffect(()=>{function r(i){i.key==="Escape"&&x()}return u&&document.addEventListener("keydown",r),()=>document.removeEventListener("keydown",r)},[u,x]);const n=()=>{S({createdBy:j,game:d,modeType:l,legs:k,avgChoice:y,startingScore:N}),x()};return!u||!m?null:ie.createPortal(e.jsxs("div",{className:"fixed inset-0 z-60 flex items-center justify-center bg-black/60 p-4",children:[e.jsx("button",{"aria-label":"Close dialog",className:"absolute inset-0 w-full h-full bg-transparent",onClick:x}),e.jsxs("div",{className:"card rounded-xl p-6 max-w-lg w-full relative text-white",role:"dialog",children:[e.jsx("button",{"aria-label":"Close",className:"absolute top-3 right-3 text-rose-400 font-bold",onClick:x,children:"✕"}),e.jsx("h2",{className:"text-lg font-semibold mb-3",children:"Create Match"}),e.jsxs("div",{className:"grid grid-cols-1 gap-3",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm opacity-80",children:"Created By"}),e.jsx("div",{className:"mt-1 p-2 bg-white/5 rounded text-white",children:j})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm opacity-80",htmlFor:"match-game",children:"Match Name (Game)"}),e.jsx("select",{id:"match-game",className:"w-full p-2 border border-white/10 bg-white/5 rounded text-white",value:d,onChange:r=>{const i=r.target.value;C(i);const J=I(i);M(J?.[0])},children:oe.map(r=>e.jsx("option",{value:r,children:r},r))})]}),I(d)?.length?e.jsxs("div",{children:[e.jsx("label",{className:"text-sm opacity-80",htmlFor:"match-start",children:`${d} Starting Score`}),e.jsx("select",{id:"match-start",className:"w-full p-2 border border-white/10 bg-white/5 rounded text-white",value:N,onChange:r=>M(Number(r.target.value)),children:I(d).map(r=>e.jsx("option",{value:r,children:r},r))})]}):null,e.jsxs("div",{children:[e.jsx("div",{className:"text-sm opacity-80",children:"Mode"}),e.jsxs("div",{className:"flex gap-2 mt-1 justify-center",children:[e.jsxs("label",{className:`btn ${l==="bestof"?"btn-primary":"btn-ghost"}`,children:[e.jsx("input",{type:"radio",name:"mode",value:"bestof",checked:l==="bestof",onChange:()=>{b("bestof"),f(r=>{const i=Math.max(1,r||3);return i%2===1?i:i+1}),setTimeout(()=>p.current?.focus(),0)},className:"sr-only"})," ","Best Of"]}),e.jsxs("label",{className:`btn ${l==="firstto"?"btn-primary":"btn-ghost"}`,children:[e.jsx("input",{type:"radio",name:"mode",value:"firstto",checked:l==="firstto",onChange:()=>{b("firstto"),f(r=>Math.max(1,r||3)),setTimeout(()=>p.current?.focus(),0)},className:"sr-only"})," ","First To"]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm opacity-80",htmlFor:"match-legs",children:l==="bestof"?"Best Of":"First To"}),e.jsx("input",{id:"match-legs",type:"number",min:1,value:k,onChange:r=>f(Math.max(1,Number(r.target.value||1))),ref:p,className:"w-full p-2 border border-white/10 bg-white/5 rounded text-white"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm opacity-80",htmlFor:"match-avg",children:"Average Choice (±)"}),e.jsx("input",{id:"match-avg",type:"number",value:y,onChange:r=>g(Number(r.target.value||0)),className:"w-full p-2 border border-white/10 bg-white/5 rounded text-white"})]})]}),e.jsx("div",{className:"flex justify-end mt-4",children:e.jsx("button",{className:"btn btn-primary",onClick:n,children:"Create Match"})})]})]}),m)}function ve({user:u}){const x=u?.username||"You",[S,m]=a.useState(0),[d,C]=a.useState(()=>[{id:1,name:"room-1",matches:[]}]),l=(()=>{try{return de()}catch{return null}})(),[b,k]=a.useState([]),f=_(t=>t.inProgress),p=_(t=>t.players),[y,g]=a.useState(!1),N=G.useRef(!1);a.useEffect(()=>{f&&(N.current||(N.current=!0,g(!0)))},[f]);const[M,j]=a.useState(!1),[n,r]=a.useState(null),i=G.useRef(null),[J,ee]=a.useState(null),[te,q]=a.useState({}),[A,L]=a.useState(30),P=G.useRef(!1),[h,R]=a.useState(null),[$,T]=a.useState({}),[U,B]=a.useState(!1),[D,W]=a.useState(null),[Y,O]=a.useState(null),[z,K]=a.useState(null),[F,E]=a.useState(!1),w=d[S],X=12,H=a.useMemo(()=>b&&b.length?b:d.flatMap(t=>t.matches.map(s=>({...s,roomName:t.name}))),[d,b]),Q=a.useMemo(()=>{const t=w?.matches||[],s=new Set(t.map(o=>o.id)),c=(H||[]).filter(o=>!s.has(o.id));return[...t,...c]},[w,H]),se=t=>{const s={id:`m-${Date.now()}`,createdBy:t.createdBy||x,game:t.game,modeType:t.modeType,legs:t.legs,startingScore:t.startingScore,createdAt:Date.now()};C(c=>c.map((o,v)=>v===S?{...o,matches:[s,...o.matches]}:o));try{l?.connected&&l.send({type:"create-match",game:t.game,mode:t.modeType,value:t.legs,startingScore:t.startingScore,creatorAvg:t.avgChoice||0})}catch{}},ae=()=>{C(t=>{const s=t.length+1,c=[...t,{id:s,name:`room-${s}`,matches:[]}];return m(c.length-1),c})};a.useEffect(()=>l?(l.connected&&l.send({type:"list-matches"}),l.addListener(s=>{try{if(s?.type==="joined"&&s.id&&ee(s.id),s?.type==="presence")try{s.id&&q(c=>({...c,[s.id]:s.username||s.name||s.id}))}catch{}if(s?.type==="matches"&&k(s.matches||[]),s?.type==="match-prestart"){const c=s.match||null;c&&(c.prestartEndsAt=s.prestartEndsAt);try{c?.creatorId&&c?.creatorName&&q(v=>({...v,[c.creatorId]:c.creatorName}))}catch{}P.current=!0,r(c);const o=s.prestartEndsAt||Date.now();L(Math.max(0,Math.ceil(((o||Date.now())-Date.now())/1e3))),setTimeout(()=>{P.current=!1},0),R(null),T({}),B(!1),W(null),O(null)}if(s?.type==="match-start"&&n&&s.roomId===n.id&&(r(null),R(null),T({})),s?.type==="prestart-choice-notify"){const{roomId:c,playerId:o,choice:v}=s;if(!c||!v)return;T(le=>({...le||{},[o]:v}))}s?.type==="prestart-bull"&&(B(!0),E(!1),K(null)),s?.type==="prestart-bull-winner"&&(O(s.winnerId||null),B(!1),E(!1)),s?.type==="prestart-bull-tie"&&(O(null),B(!1),E(!1))}catch{}})):void 0,[l,h]),a.useEffect(()=>{if(!n||P.current||n.prestartEndsAt)return;L(30),R(null),T({});const t=setInterval(()=>L(s=>Math.max(0,s-1)),1e3);return()=>clearInterval(t)},[n]),a.useEffect(()=>{n&&setTimeout(()=>i.current?.focus(),0)},[n]);const re=()=>{try{l?.connected&&n?.id&&l.send({type:"invite-response",matchId:n.id,accept:!0,toId:n.creatorId})}catch{}r(null)},ne=t=>{r(t);try{l?.connected&&l.send({type:"join-match",matchId:t.id,calibrated:!0})}catch{}},V=t=>{R(t);try{l?.connected&&n?.id&&l.send({type:"prestart-choice",roomId:n.id,choice:t})}catch{}};return e.jsx("div",{className:"flex-1 min-h-0",style:{position:"relative",marginTop:0},children:e.jsxs("div",{className:"card ndn-game-shell relative overflow-hidden h-full flex flex-col",children:[y&&e.jsx(Z,{players:p||[],user:u,onDone:()=>g(!1),onRequestClose:()=>g(!1)}),e.jsx("h2",{className:"text-3xl font-bold text-black dark:text-white mb-4",children:"Online Play"}),e.jsx("div",{className:"ndn-shell-body flex-1 overflow-hidden p-3 pb-0",children:e.jsxs("div",{className:"rounded-xl border border-slate-700 bg-black/10 p-3 flex-1 min-h-0 overflow-hidden flex flex-col",children:[e.jsxs("div",{className:"mb-3 p-3 rounded-xl bg-indigo-500/10 border border-indigo-500/40 flex items-center justify-between gap-2 flex-wrap",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("div",{className:"text-sm opacity-80",children:"Room"}),e.jsxs("div",{className:"px-3 py-1 bg-white/5 rounded border border-white/10",children:["Room (",w?.id,")"]}),e.jsx("div",{style:{width:12}}),e.jsx("button",{className:"btn btn-ghost",onClick:ae,children:"New Room"})]}),e.jsxs("div",{className:"shrink-0 flex items-center gap-2",children:[e.jsx("button",{className:"btn btn-primary",onClick:()=>j(!0),disabled:(w?.matches?.length||0)>=X,children:"Create Match +"}),(w?.matches?.length||0)>=X&&e.jsx("div",{className:"text-xs text-rose-400 mt-1",children:"Room full — create a new room"})]})]}),e.jsx("p",{className:"mb-2"}),e.jsxs("div",{className:"flex-1 overflow-auto",children:[e.jsx("h3",{className:"font-semibold underline mb-3",children:"Matches in this Room"}),e.jsx("div",{className:"mb-3 p-3 rounded-xl border border-slate-700 bg-black/10",children:e.jsx("div",{className:"mb-4",children:(Q.length||0)===0?e.jsx("div",{className:"text-sm opacity-60",children:"No matches in this room yet."}):e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3 max-h-[28rem] overflow-auto","data-testid":"matches-grid",children:Q.map(t=>e.jsxs("div",{className:"p-3 rounded border bg-black/10 flex items-start justify-between h-24","data-testid":`match-${t.id}`,children:[e.jsxs("div",{children:[e.jsxs("div",{className:"font-semibold text-sm",children:[t.game," ",t.modeType==="bestof"?"(Best Of)":"(First To)"," ","- ",t.legs," legs"]}),t.startingScore&&e.jsxs("div",{className:"text-xs opacity-80",children:["Starting:"," ",e.jsx("span",{className:"font-mono",children:t.startingScore})]}),e.jsxs("div",{className:"text-xs opacity-70 flex items-center gap-2",children:["Created by: ",t.createdBy,t.roomName&&e.jsxs("div",{className:"ml-2 inline-flex items-center gap-2 text-xs uppercase px-2 py-0.5 rounded-full bg-white/5 border border-white/10",children:["Room: ",t.roomName]})]})]}),e.jsx("div",{className:"ml-4 shrink-0",children:e.jsx("button",{className:"btn btn-sm",onClick:()=>ne(t),children:"Join Now!"})})]},t.id))})})})]})]})}),e.jsx(he,{open:M,onClose:()=>j(!1),onCreate:t=>{se(t),j(!1)}}),n&&e.jsx("div",{role:"dialog","aria-modal":"true","aria-labelledby":"join-heading",tabIndex:-1,className:"fixed inset-0 z-60 flex items-center justify-center bg-black/60 p-4",children:e.jsxs("div",{className:"bg-slate-800 rounded-2xl p-6 max-w-md w-full",children:[e.jsx("div",{id:"join-heading",className:"text-lg font-bold mb-2",children:"Join Match"}),e.jsxs("div",{className:"mb-3",children:[n.game," - ",n.modeType," • ",n.legs," legs"]}),e.jsxs("div",{className:"text-sm opacity-80 mb-3",children:["Created by ",n.createdBy]}),e.jsx("div",{className:"mb-3",children:e.jsx(me,{gameMode:n.game,compact:!0})}),n.startingScore&&e.jsxs("div",{className:"mb-3",children:["Starting score:"," ",e.jsx("span",{className:"font-mono",children:n.startingScore})]}),e.jsx(Z,{open:y,players:p,user:u,onRequestClose:()=>{},onDone:()=>{}}),e.jsxs("div",{className:"mb-3",children:["Timer: ",e.jsxs("span",{className:"font-mono",children:[A,"s"]})]}),(A<=15||n?.prestartEndsAt)&&e.jsxs("div",{className:"mb-3",children:["Choose:"," ",e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{className:`btn ${h==="bull"?"btn-primary":"btn-ghost"}`,onClick:()=>V("bull"),children:"Bull Up"}),e.jsx("button",{className:`btn ${h==="skip"?"btn-primary":"btn-ghost"}`,onClick:()=>V("skip"),children:"Skip"})]}),e.jsx("div",{className:"text-xs opacity-70 mt-2",children:h?`You chose: ${h}`:"Please choose Bull Up or Skip before accepting"}),Object.keys($).length>0&&e.jsx("div",{className:"text-xs opacity-70 mt-2",role:"status","aria-live":"polite",children:Object.entries($).map(([t,s])=>e.jsxs("div",{children:[te[t]||t," chose: ",s]},t))}),h==="skip"&&e.jsx("div",{className:"text-xs opacity-70 mt-2",children:"Skip requires both players to click Skip. Waiting for other player…"}),h==="skip"&&Object.values($).some(t=>t==="skip")&&e.jsx("div",{className:"text-sm font-semibold mt-2",children:"Both players skipped — Left player throws first"}),U&&e.jsxs("div",{className:"text-xs opacity-70 mt-2",children:["Bull Up active —",F?` you threw ${z??50}`:" throw to win the bull!"]}),U&&!F&&e.jsxs("div",{className:"flex items-center gap-2 mt-2",children:[e.jsx("input",{className:"input input-sm","aria-label":"bull-throw",type:"number",min:0,max:50,value:D??50,onChange:t=>W(Math.max(0,Math.min(50,Number(t.target.value||0))))}),e.jsx("button",{className:"btn btn-primary",onClick:()=>{try{l?.connected&&n?.id&&l.send({type:"prestart-bull-throw",roomId:n.id,score:D??50})}catch{}K(D??50),E(!0)},children:"Throw Bull"})]}),F&&e.jsxs("div",{className:"text-sm font-semibold mt-2 animate-pulse",children:["You threw: ",z??50]}),Y&&e.jsxs("div",{className:"text-sm font-semibold mt-2",children:["Bull winner: ",Y]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{ref:i,"aria-label":"Accept invitation",className:"btn btn-primary",onClick:re,disabled:A<=15&&!h,children:"Accept"}),e.jsx("button",{className:"btn btn-ghost",onClick:()=>{r(null)},children:"Cancel"})]})]})})]})})}export{ve as default};
//# sourceMappingURL=OnlinePlay.clean-p0zJr7GC.js.map
