{"version":3,"mappings":"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","names":["f","require$$0","k","l","m","n","p","q","c","a","g","b","d","e","h","reactJsxRuntime_production_min","jsxRuntimeModule","client","_objectWithoutPropertiesLoose","_extends","r","FOCUS_GROUP","FOCUS_DISABLED","FOCUS_ALLOW","FOCUS_AUTO","FOCUS_NO_AUTOFOCUS","assignRef","ref","value","useCallbackRef","initialValue","callback","useState","last","useIsomorphicLayoutEffect","React.useLayoutEffect","React.useEffect","currentValues","useMergeRefs","refs","defaultValue","callbackRef","newValue","oldValue","prevRefs_1","nextRefs_1","current_1","hiddenGuard","__assign","t","s","i","ItoI","innerCreateMedium","defaults","middleware","buffer","assigned","medium","data","item","x","cb","cbs","pendingQueue","executeQueue","cycle","filter","createMedium","createSidecarMedium","options","mediumFocus","_ref","target","currentTarget","mediumBlur","mediumEffect","mediumSidecar","focusScope","createContext","emptyArray","FocusLock","forwardRef","props","parentRef","_extends2","_useState","realObserved","setObserved","observed","useRef","isActive","originalFocusedElement","_useState2","update","children","_props$disabled","disabled","_props$noFocusGuards","noFocusGuards","_props$persistentFocu","persistentFocus","_props$crossFrame","crossFrame","_props$autoFocus","autoFocus","group","className","whiteList","hasPositiveIndices","_props$shards","shards","_props$as","Container","_props$lockProps","containerProps","SideCar","_props$returnFocus","shouldReturnFocus","focusOptions","onActivationCallback","onDeactivationCallback","_useState3","id","onActivation","useCallback","captureFocusRestore","_document","activeElement","onDeactivation","returnFocus","allowDefer","focusRestore","returnFocusTo","howToReturnFocus","returnFocusOptions","onFocus","event","onBlur","setObserveNode","newObserved","lockProps","hasLeadingGuards","hasTailingGuards","mergedRef","focusScopeValue","useMemo","React","Fragment","_setPrototypeOf","_inheritsLoose","o","setPrototypeOf","_typeof","toPrimitive","toPropertyKey","_defineProperty","withSideEffect","reducePropsToState","handleStateChangeOnClient","getDisplayName","WrappedComponent","mountedInstances","state","emitChange","instance","SideEffect","_PureComponent","_proto","index","PureComponent","toArray","ret","asArray","getFirst","isElementHidden","node","computedStyle","getParentNode","isTopNode","isInert","isVisibleUncached","checkParent","isVisibleCached","visibilityCache","cached","result","isAutoFocusAllowedUncached","isAutoFocusAllowed","isAutoFocusAllowedCached","cache","getDataset","isHTMLButtonElement","isHTMLInputElement","isRadioElement","notHiddenInput","attribute","isGuard","_a","isNotAGuard","isDefined","tabSort","aTab","bTab","tabDiff","indexDiff","getTabIndex","orderByTabIndex","nodes","filterNegative","keepGuards","tabIndex","tabbables","queryTabbables","queryGuardTabbables","getFocusablesWithShadowDom","parent","withGuards","acc","child","getFocusablesWithIFrame","getFocusables","parents","focusableWithShadowDom","focusableWithIframes","getParentAutofocusables","parentFocus","filterFocusable","filterAutoFocusable","getTabbableNodes","topNodes","getFocusableNodes","parentAutofocusables","topNode","contains","scope","element","iframeBody","filterNested","contained","j","position","_","getTopParent","getAllAffectedNodes","currentNode","safeProbe","getActiveElement","inDocument","focusInFrame","frame","focusInsideIframe","focusInside","focusIsHidden","findSelectedRadio","el","correctNode","correctNodes","resultSet","pickFirstFocus","pickFocusable","NEW_FOCUS","newFocus","innerNodes","innerTabbables","outerNodes","lastNode","cnt","firstFocus","lastFocus","isOnGuard","activeIndex","lastIndex","lastNodeInside","firstNodeIndex","lastNodeIndex","correctedNodes","currentFocusableIndex","previousFocusableIndex","tabbableNodes","currentTabbableIndex","previousTabbableIndex","focusIndexDiff","returnFirstNode","returnLastNode","findAutoFocused","autoFocusables","autofocus","pickAutofocus","nodesIndexes","orderedNodes","groups","autoFocusable","getParents","getCommonParent","nodeA","nodeB","parentsA","parentsB","currentParent","getTopCommonParent","baseActiveElement","leftEntry","rightEntries","activeElements","leftEntries","topCommon","entry","subEntry","common","allParentAutofocusables","entries","reorderNodes","srcNodes","dstNodes","remap","entity","focusSolver","commonParent","anyFocusable","innerElements","orderedInnerElements","innerFocusables","innerTabbable","newId","focusNode","expandFocusableNodes","focusOn","guardCount","lockDisabled","moveFocusInside","focusable","weakRef","w","recordElementLocation","stack","currentElement","restoreFocusTo","location","_b","_c","_d","_e","ownerDocument","_i","stack_1","line","parent_1","left","savedCurrent","current","right","focusables","aim","_f","focusables_1","targetElement","getRelativeFocusable","useTabbables","shard","getBoundary","set","defaultOptions","moveFocus","fromElement","newOptions","solution","focusNextElement","next","first","focusPrevElement","prev","pickBoundary","what","boundary","focusFirstElement","focusLastElement","deferAction","action","extractRef","focusOnBody","isFreeFocus","lastActiveTrap","lastActiveFocus","tryRestoreFocus","lastPortaledElement","focusWasOutsideWindow","windowFocused","defaultWhitelist","focusWhitelisted","recordPortal","observerNode","portaledElement","focusIsPortaledPair","autoGuard","startIndex","end","step","allNodes","lastGuard","focusWasOutside","crossFrameOption","checkInHost","check","withinHost","workingArea","area","getNodeFocusables","isNotFocusable","activateTrap","_lastActiveTrap","workingNode","newTarget","shouldForceRestoreFocus","newActiveElement","focusedIndex","_ref2","_ref3","guard","_ref4","onTrap","source","FocusWatcher","onWindowFocus","onWindowBlur","attachHandler","detachHandler","propsList","_ref6","focusLockAPI","traps","trap","lastTrap","sameTrap","_ref7","FocusTrap","FocusLockCombination","FocusLockUI","KEY","user","getWeekId","date","dayNum","yearStart","weekNo","week","getOnlineUsage","raw","u","currentWeek","getFreeRemaining","cap","LS_KEY","getCache","setCache","email","v","fetchIsAdmin","owner","__vite_import_meta_env__","force","hit","useIsAdmin","isAdmin","setIsAdmin","useEffect","on","BASE_PRICE_GBP","FX","formatPriceInCurrency","currency","gbpAmount","cur","rate","val","getUserCurrency","parts","DISCORD_INVITE_URL","cachedBaseUrl","computeApiBase","envUrl","protocol","host","hostname","sameOrigin","normalizePath","path","base","cleanPath","resolveApiUrl","apiFetch","init","url","installApiInterceptor","anyWindow","originalFetch","input","reqUrl","cloned","href","err","getTabs","baseTabs","LayoutDashboard","Users","Trophy","Camera","Settings","isSubscriptionActive","sub","exp","PoundSterling","Sidebar","active","onChange","userForTabs","rawGet","subs","tabs","idx","adminTab","showDiscord","setShowDiscord","showNDNDiscord","setShowNDNDiscord","freeLeft","notifications","setNotifications","fetchNotifications","requestsRes","messagesRes","requests","unreadMessages","interval","onKey","jsxs","key","label","Icon","jsx","Lock","MessageCircle","createPortal","ScrollFade","style","raf","updateClip","wrapper","header","scroller","scrollTop","headerH","overlap","mask","onScrollOrResize","DartLoader","calibrationComplete","showTick","setShowTick","fade","setFade","DartDetector","cfg","cx","cy","radius","width","height","alpha","bg","gray","y","dx","dy","recent","diff","sum","sum2","isHighlight","maxc","minc","satApprox","isHi","mu","var_","sigma","dynamicThresh","visited","bestArea","bestIdxs","idxs","qh","nbs","nb","minX","minY","maxX","maxY","meanX","meanY","cxx","cyy","cxy","trace","det","tmp","l1","vx","vy","vlen","dxc","dyc","outward","rlen","rx","ry","cosAng","maxT","tipX","tipY","dxr","dyr","minR2","bboxW","bboxH","bboxArea","fill","radial","confidence","l2","bw","bh","yy","xx","tip","close","out","createStoreImpl","createState","listeners","setState","partial","replace","nextState","previousState","listener","getState","api","initialState","createStore","is","objectIs","useLayoutEffect","useDebugValue","useSyncExternalStore$2","subscribe","getSnapshot","inst","forceUpdate","checkIfSnapshotChanged","latestGetSnapshot","nextValue","useSyncExternalStore$1","shim","useSyncExternalStoreShim_production","shimModule","require$$1","useSyncExternalStore","withSelector_production","getServerSnapshot","selector","isEqual","instRef","memoizedSelector","nextSnapshot","hasMemo","memoizedSnapshot","currentSelection","memoizedSelection","nextSelection","maybeGetServerSnapshot","withSelectorModule","ReactExports","useSyncExternalStoreWithSelector","useSyncExternalStoreExports","didWarnAboutEqualityFn","identity","arg","useStore","equalityFn","slice","createImpl","useBoundStore","create","createJSONStorage","getStorage","storage","name","parse","str2","str","toThenable","fn","onFulfilled","_onRejected","_onFulfilled","onRejected","oldImpl","config","baseOptions","get","persistedState","currentState","hasHydrated","hydrationListeners","finishHydrationListeners","args","thenableSerialize","setItem","errorInSync","thenable","serializedValue","savedSetState","configResult","stateFromStorage","hydrate","postRehydrationCallback","storageValue","deserializedStorageValue","migratedState","_a2","newImpl","migrationResult","migrated","persistImpl","persist","useCalibration","error","legacy","dlog","videoElementRefHolder","mediaStreamRefHolder","pcRefHolder","wsRefHolder","useCameraSession","streaming","mode","code","time","paired","stream","pc","ws","BoardRadii","SectorOrder","applyHomography","H","nx","ny","invertHomography","A","B","C","D","E","F","G","Hh","I","computeHomographyDLT","src","dst","X","Y","solveLeastSquares","AtA","Atb","gaussianSolve","M","row","maxRow","canonicalRimTargets","doubleR","sector","angle","sampleRing","steps","pts","theta","rmsError","e2","imageToBoard","H_boardToImage","pImg","inv","scoreAtBoardPoint","deg","drawPolyline","ctx","color","drawCross","clamp","lo","hi","sobelAtGray","img","gx","gy","sx","sy","xi","refinePointSobel","canvas","best","mag","CV","imageSrc","imageDst","len","threshold","tab","kernelSize","hist","sumB","wB","wF","max","between","heightMinus1","widthMinus1","size","mult","shift","stackStart","pos","start","imageMean","kernel","horizontal","limit","center","scale2X","binary","contours","deltas","pix","nbd","outer","hole","point","contour","pos1","pos3","pos4","s_end","epsilon","right_slice","poly","pt","start_pt","end_pt","dist","max_dist","le_eps","warpSize","sx1","sx2","dx1","dx2","sy1","sy2","dy1","dy2","p1","p2","p3","p4","rq","sq","px","py","den","orientation","convex","cur_pt","prev_pt","dxdy0","dydx0","dx0","dy0","min","square","span","nz","posSrc","posDst","cv","AR","corners","image","minSize","minLength","candidates","swap","minDist","notTooNear","markers","candidate","marker","minZero","bits","rotations","distances","pair","inc","ids","minSum","rotation","aruco","SVD","flag","its","jj","nm","anorm","scale","z","rv1","at","bt","ct","svd","POS","modelSize","focalLength","half","np","vectors","imagePoints","posRotation1","posRotation2","posTranslation","rotation1","rotation2","translation1","translation2","error1","error2","valid1","valid2","translation","imageVectors","i0","j0","ivec","jvec","row1","row2","row3","i0i0","j0j0","i0j0","delta","lambda","zmin","zi","posRotation","oldSopImagePoints","sopImagePoints","converged","iteration","oldImageDifference","imageDifference","factor","move","projection","errorvec","euclidean","pixels","maximum","wmax","cn","posit1","Vec3","Mat3","points","eps","yi","xs","ys","ij","inorm","jnorm","temp","prevError","v1","v2","v3","v4","modeled","ia1","ia2","ia3","ia4","ma1","ma2","ma3","ma4","x1","y1","x2","y2","vector","matrix","posit2","jsAruco","require$$2","require$$3","require$$4","ROW_PATTERNS","markerIdToMatrix","rows","bit3","bit1","pattern","isFinitePoint","isFiniteHomography","findDartboardRings","edges","baseEdgeThreshold","blurred","grayVal","minPixelCount","bestCenter","bestScore","bestRingCount","stride","ringCount","ringStrength","scalePxPerMm","testRadii","maxR","bins","maxBin","edge","peakRadius","peakThreshold","testR","tol","bestPeak","bestDist","pr","refinedCx","refinedCy","approxDoublePixels","minScan","maxScan","maxStrength","strength","pixelCount","knownR","expectedPixelR","detectBoard","centerX","centerY","detection","detected","calibrationPoints","canonicalSrc","homography","errorPx","errorConfidence","pointsValid","homographyValid","success","detRingCount","detRingStrength","refineRingDetection","expectedRatios","actualRatios","ratioError","ratioCount","expected","actual","avgRatioError","adjustedConfidence","load","save","useUserSettings","vol","discoverNetworkDevices","devices","localIPs","getLocalIPs","localIP","scanResults","scanNetwork","device","probeDevice","ips","offer","resolve","timeout","ipMatch","ip","isPrivateIP","ports","results","baseIP","promises","port","checkPort","portIndex","ipIndex","response","endpoints","endpoint","contentType","text","discoverUSBDevices","probeUSBDevice","requestUSBDevice","reader","done","connectToNetworkDevice","streamUrl","video","reject","drawFrame","connectToUSBDevice","useAudit","darts","visitTotal","meta","totals","bm","tag","info","updated","arr","calcThreeDartAvg","leg","finishedLegStats","avg","isCompleted","updatePlayerEndOfGameStats","player","avgs","bestNine","bestCheckout","st","useMatch","playerNames","startingScore","roomId","players","score","preRem","postRem","bust","finish","avgPayload","checkoutScore","newState","playerIndex","WSContext","WSProvider","connected","setConnected","status","setStatus","wsRef","listenersRef","shouldReconnectRef","attemptsRef","timerRef","heartbeatRef","endpointsRef","endpointIdxRef","ensureEndpoints","normalized","proto","bases","rotateEndpoint","currentEndpoint","connect","ev","attempt","jitter","delay","reconnect","beforeUnload","onVis","send","msg","addListener","useWS","useContext","CALIBRATION_POINT_LABELS","REQUIRED_POINT_COUNT","Calibrator","videoRef","canvasRef","overlayRef","fileInputRef","cameraPerm","setCameraPerm","videoDevices","setVideoDevices","selectedDeviceId","setSelectedDeviceId","setStreaming","videoPlayBlocked","setVideoPlayBlocked","phase","setPhase","setMode","dstPoints","setDstPoints","hasSnapshot","setHasSnapshot","frameSize","setFrameSize","zoom","setZoom","mobileLandingOverride","setMobileLandingOverride","isMobileDevice","setIsMobileDevice","setCalibration","reset","locked","overlaySize","imageSize","ERROR_PX_MAX","calibrationValid","cameraSession","calibrationGuide","setCalibrationGuide","preferredCameraId","cameraEnabled","setCameraEnabled","preferredCameraLocked","setPreferredCameraLocked","setPreferredCamera","preserveCalibrationOverlay","allowAutocommitInOnline","setAllowAutocommitInOnline","setDetected","liveDetect","setLiveDetect","setConfidence","autoCalibrating","setAutoCalibrating","detectionMessage","setDetectionMessage","forceConfidence","setForceConfidence","markerResult","setMarkerResult","showDartPreview","setShowDartPreview","autoCommitTestMode","setAutoCommitTestMode","autoCommitImmediate","setAutoCommitImmediate","lastDetectedValue","setLastDetectedValue","lastDetectedLabel","setLastDetectedLabel","toolsPopoverOpen","setToolsPopoverOpen","dartDetectorRef","verificationResults","setVerificationResults","cols","cellW","cellH","pairCode","setPairCode","pairCodeRef","setWs","pcRef","pendingIceCandidatesRef","expiresAt","setExpiresAt","now","setNow","setPaired","updatePairCode","lanHost","setLanHost","httpsInfo","setHttpsInfo","showTips","setShowTips","wifiDevices","setWifiDevices","discoveringWifi","setDiscoveringWifi","copyFeedback","setCopyFeedback","copyTimeoutRef","overlay","octx","fallbackWidth","fallbackHeight","pCal","detectedBoard","scoreObj","TIP_MARGIN_PX","PCAL_MARGIN_PX","calibrationGood","tipInVideo","pCalInImage","onBoard","pBoard","isOnline","mobileUrl","useHttps","mobileLandingLink","coarseQuery","detect","uaMobile","coarse","narrow","mounted","refreshVideoDevices","vids","testCamera","deviceId","constraints","ttl","copyValue","type","textarea","handleReconnectRequest","stopCamera","startPhonePairing","ensureWS","normalizedEnv","socket","lockSelectionForPairing","codeForSession","imgSize","payload","peer","inbound","pending","Hpayload","startWifiConnection","connectToWifiDevice","startCamera","playErr","autoRevert","regenerateCode","triggerUpload","captureFrame","autoDetectRings","drawOverlay","currentPoints","HH","Huse","rings","ringColor","ringWidth","drawCircle","targetPoints","pad","ax","ay","onClickOverlay","rect","cssX","cssY","scaleX","scaleY","calibState","Hcur","rect2","clientWidth","clientHeight","fracX","fracY","calibSt","calibrationValidSt","doCommit","compute","Hcalc","runVerification","tests","imgP","match","maxW","dw","dh","tctx","d0","f0","g0","h0","maxMag","cx0","cy0","rMin","rMax","stepC","stepR","samples","ang","OCX","OCY","OR","radialScore","rPx","rScaled","ratios","refineAround","expectedR","pctWindow","bestR","bestS","dOuter","dInner","tOuter","tInner","bOuter","bInner","totalEdge","norm","conf","adjustedConf","stableCount","tmp2","bd2","isSimilarDetection","stable","runs","tmp3","autoLock","overlaySizeForLock","dr","workerRef","autoCalibrate","bitmap","autoCalibrateSync","worker","timeoutId","onMessage","errMsg","boardDetection","shouldLock","stableCount2","runs2","small","stable2","scales","srcCanvas","bd","invScale","baseCheck","stabilityCount","stabilityRuns","tick","bodyStr","token","DevicePicker","preferredCameraLabel","localDevicesSnapshot","setLocalDevicesSnapshot","setErr","dropdownOpen","setDropdownOpen","dropdownRef","ignoreCloseUntilRef","suspendDocHandlerRef","dropdownPortal","enumerate","cams","handleClickOutside","tgt","clickedInsideMain","clickedInsidePortal","selectedDevice","selectedLabel","localSelectedLabel","setLocalSelectedLabel","preferredCameraUnavailable","linkForMobile","nextId","useToastStore","message","opts","useToast","Toaster","toasts","remove","BarChart","barWidth","gap","showValues","totalWidth","TabPills","keyFor","keySeriesFor","getAllTime","parsed","setAllTime","getAllTimeAvg","scored","getAllTimeFirstNineAvg","fnDarts","fnScored","getAllTimeBestLeg","bestLegDarts","getAllTimeBestCheckout","getAllTime180s","num180s","keyGameModes","getGameModeStats","allModeKeys","obj","setGameModeStats","stats","bumpGameMode","won","getSeries","setSeries","pruneOld","maxAgeMs","addSample","when","list","getRollingAvg","windowMs","getRollingFirstNineAvg","getMonthlyAvg3","windowed","matchOnly","use","getMonthlyFirstNineAvg","addMatchToAllTime","matchBest3","matchWorst3","matchBestLegDarts","matchBestCheckout","matchWorstLegDarts","matchBestFNAvg","matchWorstFNAvg","match180s","legFnDarts","legFnScored","sumFirstNine","legDarts","legScored","legAvg","legFNAvg","co","prior","remain","take","freeGames","premiumGames","allGames","gameConfig","getStartOptionsForGame","getModeOptionsForGame","getModeValueOptionsForGame","labelForMode","opt","StatusDot","title","CameraStatusBadge","camera","rafRef","videoEl","hasActivePhoneStream","running","render","vw","vh","cw","ch","vr","cr","sw","sh","targetW","targetH","onClick","HELP_TOPICS","analyzeUserQuestion","question","lowerQ","topic","keyword","getEstimatedWaitTime","hour","HelpdeskChat","request","onClose","messages","setMessages","setInput","typingUsers","setTypingUsers","adminConnected","setAdminConnected","waitTime","setWaitTime","msgsRef","typingTimeoutRef","timersRef","un","who","sendMsg","userMessage","msgObj","aiResponse","aiMsg","requestAdminConnection","needsHelp","confirmMsg","waitMsg","sendTyping","copy","Zap","User","actionMsg","Send","GAME_CALIBRATION_REQUIREMENTS","getCalibrationConfidenceForGame","gameMode","req","excess","isCalibrationSuitableForGame","getCalibrationQualityText","getRecalibrationRecommendation","OWNER_EMAIL","AdminDashboard","admins","setAdmins","walletCreditEmail","setWalletCreditEmail","walletCreditAmount","setWalletCreditAmount","walletCreditCurrency","setWalletCreditCurrency","setEmail","announcement","setAnnouncement","loading","setLoading","tournaments","setTournaments","withdrawals","userSearch","setUserSearch","userResults","setUserResults","createForm","setCreateForm","emailCopy","setEmailCopy","preview","setPreview","activeTab","setActiveTab","isOwner","winners","reports","helpRequests","setHelpRequests","helpTyping","setHelpTyping","selectedRequest","setSelectedRequest","setLogs","systemHealth","setSystemHealth","clusteringEnabled","setClusteringEnabled","clusterCapacity","setClusterCapacity","setShowCreate","broadcastTournaments","headers","toast","gmVersion","setGmVersion","gmStats","cal","calibQuality","items","game","qualityInfo","gmBars","bars","gameKey","refresh","hrRes","adminsRes","tRes","revoke","grantPremium","days","revokePremium","sendAnnouncement","toggleMaintenance","unsub","rid","filtered","iv","changed","claimHelp","resolveHelp","grant","searchUsers","authHeader","res","banUser","unbanUser","createOfficialTournament","setWinner","tid","winnerEmail","markPaid","deleteTournament","reseedWeekly","decideWithdrawal","approve","deleteMatch","fetchLogs","fetchSystemHealth","toggleClustering","enable","updateClusterCapacity","newCapacity","loadEmailCopy","saveEmailCopy","kind","openInlinePreview","openInNewTab","html","EmailEditor","setTitle","intro","setIntro","btn","setBtn","hr","colorClass","admin","notes","vals","newType","winner","hasAccess","SettingsPanel","favoriteDouble","callerEnabled","callerVoice","callerVolume","speakCheckoutOnly","avgMode","autoStartOffline","rememberLastOffline","reducedMotion","compactHeader","allowSpectate","cameraScale","cameraAspect","cameraFitMode","autoscoreProvider","autoscoreWsUrl","autoCommitMode","offlineLayout","textSize","boxSize","setFavoriteDouble","setCallerEnabled","setCallerVoice","setCallerVolume","setSpeakCheckoutOnly","setAvgMode","setAutoStartOffline","setRememberLastOffline","setReducedMotion","setCompactHeader","setAllowSpectate","setCameraScale","setCameraAspect","setCameraFitMode","setAutoscoreProvider","setAutoscoreWsUrl","setAutoCommitMode","setPreserveCalibrationOverlay","setOfflineLayout","setTextSize","setBoxSize","dartTimerEnabled","dartTimerSeconds","setDartTimerEnabled","setDartTimerSeconds","x01DoubleIn","setX01DoubleIn","achievements","setAchievements","uname","onOpenProfile","setExpandedPill","isEditing","setIsEditing","favPlayer","setFavPlayer","favTeam","setFavTeam","favDarts","setFavDarts","bio","setBio","profilePhoto","setProfilePhoto","allowAnalytics","setAllowAnalytics","wallet","setWallet","subscription","setSubscription","helpMessages","setHelpMessages","helpInput","setHelpInput","saveBio","navigateToTab","tabKey","getResponseWithLinks","handleHelpSend","newUsername","setNewUsername","changingUsername","setChangingUsername","usernameError","setUsernameError","availableVoices","setAvailableVoices","loadVoices","voices","showHighlights","setShowHighlights","expandedPill","PillButton","pill","ChevronDown","amt","count","Shield","Eye","file","blob","Volume2","utterance","Save","Edit3","Gamepad2","HelpCircle","link","Auth","onAuth","username","setUsername","password","setPassword","reminder","setReminder","setError","showPassword","setShowPassword","API_URL","handleSignIn","__vitePreload","handleSignUp","handleReset","handleSendUsername","EyeOff","BarChart3","ShieldCheck","ThemeContext","THEME_KEY","ThemeProvider","theme","setTheme","saved","Drawer","open","footer","side","HelpAssistant","isOpen","setIsOpen","awaitingAdminConfirm","setAwaitingAdminConfirm","lastUserQuestion","setLastUserQuestion","myRequest","setMyRequest","handleSend","userMessageRaw","linkIndex","GlobalCameraLogger","lastStateRef","dumpState","prefix","media","snapshot","attachVideoListeners","loadedmetadata","playing","pause","ended","attachPc","connChange","attachInterval","GlobalPhoneVideoSink","vref","lastStreamRef","lastTimeRef","stallSecondsRef","lastReconnectAtRef","attemptRef","apply","vid","minBackoff","InstallPicker","setOpen","playStore","appStore","installPwa","AddToHomeButton","available","setAvailable","showInstructions","setShowInstructions","handler","handleClick","choice","iosInstructions","isIos","ResizableModal","storageKey","defaultWidth","defaultHeight","minWidth","minHeight","maxWidth","maxHeight","fullScreen","initialFitHeight","setSize","startRef","onReset","containerRef","cs","padTop","padBottom","inner","beginResize","dir","onMove","endResize","handleKeyResize","curW","curH","parentInner","effMaxH","baseClass","InstallAppButton","deferredPrompt","setDeferredPrompt","handleInstall","Footer","show","setShow","year","Home","OfflinePlay","Friends","OnlinePlay","StatsPanel","Tournaments","AdminAccess","OpsDashboard","App","appRef","avatar","setAvatar","isFullscreen","setIsFullscreen","setTab","isMobile","setIsMobile","navOpen","setNavOpen","setUser","setUserWithMerge","merged","MINIMAL_UI","minimalUI","setMinimalUI","allTimeAvg","setAllTimeAvg","calibH","calibLocked","timer","fetchSubscription","onLogout","onUpdate","storedAvatar","handleStorageChange","handleAvatarUpdate","handleVisibilityChange","checkAvatarInterval","urlParams","paid","usernameChange","pendingUsername","onFullscreenChange","mqMobile","mqTablet","uaTablet","touchScreen","verySmallScreen","isTablet","onName","onTabChange","showSubscriptionsBell","setShowSubscriptionsBell","notificationsOpen","setNotificationsOpen","siteNotifications","setSiteNotifications","THREE_DAYS_MS","fetchNotifs","int","addSubscriptionNotification","fallbackAvatar","Bell","btnToken","btnRefetchToken","refetchHeaders","btnDeleteToken","MobileNav","Suspense","validatePassword","ResetPassword","setToken","confirm","setConfirm","setSuccess","onSubmit","ErrorBoundary","Component","ReactDOM","StrictMode","Root","reg"],"ignoreList":[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,55,56,57,58,59,60,61,66,67,68,69,70,71],"sources":["../../node_modules/react/cjs/react-jsx-runtime.production.min.js","../../node_modules/react/jsx-runtime.js","../../node_modules/react-dom/client.js","../../node_modules/@babel/runtime/helpers/esm/objectWithoutPropertiesLoose.js","../../node_modules/@babel/runtime/helpers/esm/extends.js","../../node_modules/focus-lock/dist/es2015/constants.js","../../node_modules/use-callback-ref/dist/es2015/assignRef.js","../../node_modules/use-callback-ref/dist/es2015/useRef.js","../../node_modules/use-callback-ref/dist/es2015/useMergeRef.js","../../node_modules/react-focus-lock/dist/es2015/FocusGuard.js","../../node_modules/tslib/tslib.es6.mjs","../../node_modules/use-sidecar/dist/es2015/medium.js","../../node_modules/react-focus-lock/dist/es2015/medium.js","../../node_modules/react-focus-lock/dist/es2015/scope.js","../../node_modules/react-focus-lock/dist/es2015/Lock.js","../../node_modules/@babel/runtime/helpers/esm/setPrototypeOf.js","../../node_modules/@babel/runtime/helpers/esm/inheritsLoose.js","../../node_modules/@babel/runtime/helpers/esm/typeof.js","../../node_modules/@babel/runtime/helpers/esm/toPrimitive.js","../../node_modules/@babel/runtime/helpers/esm/toPropertyKey.js","../../node_modules/@babel/runtime/helpers/esm/defineProperty.js","../../node_modules/react-clientside-effect/lib/index.es.js","../../node_modules/focus-lock/dist/es2015/utils/array.js","../../node_modules/focus-lock/dist/es2015/utils/is.js","../../node_modules/focus-lock/dist/es2015/utils/tabOrder.js","../../node_modules/focus-lock/dist/es2015/utils/tabbables.js","../../node_modules/focus-lock/dist/es2015/utils/tabUtils.js","../../node_modules/focus-lock/dist/es2015/utils/DOMutils.js","../../node_modules/focus-lock/dist/es2015/utils/all-affected.js","../../node_modules/focus-lock/dist/es2015/utils/safe.js","../../node_modules/focus-lock/dist/es2015/utils/getActiveElement.js","../../node_modules/focus-lock/dist/es2015/focusInside.js","../../node_modules/focus-lock/dist/es2015/focusIsHidden.js","../../node_modules/focus-lock/dist/es2015/utils/correctFocus.js","../../node_modules/focus-lock/dist/es2015/utils/firstFocus.js","../../node_modules/focus-lock/dist/es2015/solver.js","../../node_modules/focus-lock/dist/es2015/utils/auto-focus.js","../../node_modules/focus-lock/dist/es2015/utils/parenting.js","../../node_modules/focus-lock/dist/es2015/focusSolver.js","../../node_modules/focus-lock/dist/es2015/focusables.js","../../node_modules/focus-lock/dist/es2015/commands.js","../../node_modules/focus-lock/dist/es2015/moveFocusInside.js","../../node_modules/focus-lock/dist/es2015/return-focus.js","../../node_modules/focus-lock/dist/es2015/sibling.js","../../node_modules/react-focus-lock/dist/es2015/util.js","../../node_modules/react-focus-lock/dist/es2015/Trap.js","../../node_modules/react-focus-lock/dist/es2015/Combination.js","../../src/utils/quota.ts","../../src/utils/admin.ts","../../src/utils/config.ts","../../src/utils/api.ts","../../src/components/Sidebar.tsx","../../src/components/ScrollFade.tsx","../../src/components/DartLoader.tsx","../../src/utils/dartDetector.ts","../../node_modules/zustand/esm/vanilla.mjs","../../node_modules/use-sync-external-store/cjs/use-sync-external-store-shim.production.js","../../node_modules/use-sync-external-store/shim/index.js","../../node_modules/use-sync-external-store/cjs/use-sync-external-store-shim/with-selector.production.js","../../node_modules/use-sync-external-store/shim/with-selector.js","../../node_modules/zustand/esm/index.mjs","../../node_modules/zustand/esm/middleware.mjs","../../src/store/calibration.ts","../../src/utils/logger.ts","../../src/store/cameraSession.ts","../../src/utils/vision.ts","../../node_modules/js-aruco/src/cv.js","../../node_modules/js-aruco/src/aruco.js","../../node_modules/js-aruco/src/svd.js","../../node_modules/js-aruco/src/posit1.js","../../node_modules/js-aruco/src/posit2.js","../../node_modules/js-aruco/index.js","../../src/utils/markerCalibration.ts","../../src/utils/boardDetection.ts","../../src/store/userSettings.ts","../../src/utils/networkDevices.ts","../../src/store/audit.ts","../../src/store/match.ts","../../src/components/WSProvider.tsx","../../src/components/Calibrator.tsx","../../src/store/toast.ts","../../src/components/Toaster.tsx","../../src/components/BarChart.tsx","../../src/components/ui/TabPills.tsx","../../src/store/profileStats.ts","../../src/utils/games.ts","../../src/components/ui/StatusDot.tsx","../../src/components/CameraStatusBadge.tsx","../../src/utils/helpDeskAI.ts","../../src/components/HelpdeskChat.tsx","../../src/utils/gameCalibrationRequirements.ts","../../src/components/AdminDashboard.tsx","../../src/components/SettingsPanel.tsx","../../src/components/Auth.tsx","../../src/components/ThemeContext.tsx","../../src/components/ui/Drawer.tsx","../../src/components/HelpAssistant.tsx","../../src/components/GlobalCameraLogger.tsx","../../src/components/GlobalPhoneVideoSink.tsx","../../src/components/InstallPicker.tsx","../../src/components/AddToHomeButton.tsx","../../src/components/ui/ResizableModal.tsx","../../src/components/InstallAppButton.tsx","../../src/components/Footer.tsx","../../src/App.tsx","../../src/components/ResetPassword.tsx","../../src/components/ErrorBoundary.tsx","../../src/main.tsx"],"sourcesContent":["/**\n * @license React\n * react-jsx-runtime.production.min.js\n *\n * Copyright (c) Facebook, Inc. and its affiliates.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n */\n'use strict';var f=require(\"react\"),k=Symbol.for(\"react.element\"),l=Symbol.for(\"react.fragment\"),m=Object.prototype.hasOwnProperty,n=f.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,p={key:!0,ref:!0,__self:!0,__source:!0};\nfunction q(c,a,g){var b,d={},e=null,h=null;void 0!==g&&(e=\"\"+g);void 0!==a.key&&(e=\"\"+a.key);void 0!==a.ref&&(h=a.ref);for(b in a)m.call(a,b)&&!p.hasOwnProperty(b)&&(d[b]=a[b]);if(c&&c.defaultProps)for(b in a=c.defaultProps,a)void 0===d[b]&&(d[b]=a[b]);return{$$typeof:k,type:c,key:e,ref:h,props:d,_owner:n.current}}exports.Fragment=l;exports.jsx=q;exports.jsxs=q;\n","'use strict';\n\nif (process.env.NODE_ENV === 'production') {\n  module.exports = require('./cjs/react-jsx-runtime.production.min.js');\n} else {\n  module.exports = require('./cjs/react-jsx-runtime.development.js');\n}\n","'use strict';\n\nvar m = require('react-dom');\nif (process.env.NODE_ENV === 'production') {\n  exports.createRoot = m.createRoot;\n  exports.hydrateRoot = m.hydrateRoot;\n} else {\n  var i = m.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED;\n  exports.createRoot = function(c, o) {\n    i.usingClientEntryPoint = true;\n    try {\n      return m.createRoot(c, o);\n    } finally {\n      i.usingClientEntryPoint = false;\n    }\n  };\n  exports.hydrateRoot = function(c, h, o) {\n    i.usingClientEntryPoint = true;\n    try {\n      return m.hydrateRoot(c, h, o);\n    } finally {\n      i.usingClientEntryPoint = false;\n    }\n  };\n}\n","function _objectWithoutPropertiesLoose(r, e) {\n  if (null == r) return {};\n  var t = {};\n  for (var n in r) if ({}.hasOwnProperty.call(r, n)) {\n    if (-1 !== e.indexOf(n)) continue;\n    t[n] = r[n];\n  }\n  return t;\n}\nexport { _objectWithoutPropertiesLoose as default };","function _extends() {\n  return _extends = Object.assign ? Object.assign.bind() : function (n) {\n    for (var e = 1; e < arguments.length; e++) {\n      var t = arguments[e];\n      for (var r in t) ({}).hasOwnProperty.call(t, r) && (n[r] = t[r]);\n    }\n    return n;\n  }, _extends.apply(null, arguments);\n}\nexport { _extends as default };","/**\n * defines a focus group\n */\nexport var FOCUS_GROUP = 'data-focus-lock';\n/**\n * disables element discovery inside a group marked by key\n */\nexport var FOCUS_DISABLED = 'data-focus-lock-disabled';\n/**\n * allows uncontrolled focus within the marked area, effectively disabling focus lock for it's content\n */\nexport var FOCUS_ALLOW = 'data-no-focus-lock';\n/**\n * instructs autofocus engine to pick default autofocus inside a given node\n * can be set on the element or container\n */\nexport var FOCUS_AUTO = 'data-autofocus-inside';\n/**\n * instructs autofocus to ignore elements within a given node\n * can be set on the element or container\n */\nexport var FOCUS_NO_AUTOFOCUS = 'data-no-autofocus';\n","/**\n * Assigns a value for a given ref, no matter of the ref format\n * @param {RefObject} ref - a callback function or ref object\n * @param value - a new value\n *\n * @see https://github.com/theKashey/use-callback-ref#assignref\n * @example\n * const refObject = useRef();\n * const refFn = (ref) => {....}\n *\n * assignRef(refObject, \"refValue\");\n * assignRef(refFn, \"refValue\");\n */\nexport function assignRef(ref, value) {\n    if (typeof ref === 'function') {\n        ref(value);\n    }\n    else if (ref) {\n        ref.current = value;\n    }\n    return ref;\n}\n","import { useState } from 'react';\n/**\n * creates a MutableRef with ref change callback\n * @param initialValue - initial ref value\n * @param {Function} callback - a callback to run when value changes\n *\n * @example\n * const ref = useCallbackRef(0, (newValue, oldValue) => console.log(oldValue, '->', newValue);\n * ref.current = 1;\n * // prints 0 -> 1\n *\n * @see https://reactjs.org/docs/hooks-reference.html#useref\n * @see https://github.com/theKashey/use-callback-ref#usecallbackref---to-replace-reactuseref\n * @returns {MutableRefObject}\n */\nexport function useCallbackRef(initialValue, callback) {\n    var ref = useState(function () { return ({\n        // value\n        value: initialValue,\n        // last callback\n        callback: callback,\n        // \"memoized\" public interface\n        facade: {\n            get current() {\n                return ref.value;\n            },\n            set current(value) {\n                var last = ref.value;\n                if (last !== value) {\n                    ref.value = value;\n                    ref.callback(value, last);\n                }\n            },\n        },\n    }); })[0];\n    // update callback\n    ref.callback = callback;\n    return ref.facade;\n}\n","import * as React from 'react';\nimport { assignRef } from './assignRef';\nimport { useCallbackRef } from './useRef';\nvar useIsomorphicLayoutEffect = typeof window !== 'undefined' ? React.useLayoutEffect : React.useEffect;\nvar currentValues = new WeakMap();\n/**\n * Merges two or more refs together providing a single interface to set their value\n * @param {RefObject|Ref} refs\n * @returns {MutableRefObject} - a new ref, which translates all changes to {refs}\n *\n * @see {@link mergeRefs} a version without buit-in memoization\n * @see https://github.com/theKashey/use-callback-ref#usemergerefs\n * @example\n * const Component = React.forwardRef((props, ref) => {\n *   const ownRef = useRef();\n *   const domRef = useMergeRefs([ref, ownRef]); //  merge together\n *   return <div ref={domRef}>...</div>\n * }\n */\nexport function useMergeRefs(refs, defaultValue) {\n    var callbackRef = useCallbackRef(defaultValue || null, function (newValue) {\n        return refs.forEach(function (ref) { return assignRef(ref, newValue); });\n    });\n    // handle refs changes - added or removed\n    useIsomorphicLayoutEffect(function () {\n        var oldValue = currentValues.get(callbackRef);\n        if (oldValue) {\n            var prevRefs_1 = new Set(oldValue);\n            var nextRefs_1 = new Set(refs);\n            var current_1 = callbackRef.current;\n            prevRefs_1.forEach(function (ref) {\n                if (!nextRefs_1.has(ref)) {\n                    assignRef(ref, null);\n                }\n            });\n            nextRefs_1.forEach(function (ref) {\n                if (!prevRefs_1.has(ref)) {\n                    assignRef(ref, current_1);\n                }\n            });\n        }\n        currentValues.set(callbackRef, refs);\n    }, [refs]);\n    return callbackRef;\n}\n","import React, { Fragment } from 'react';\nimport PropTypes from 'prop-types';\nexport var hiddenGuard = {\n  width: '1px',\n  height: '0px',\n  padding: 0,\n  overflow: 'hidden',\n  position: 'fixed',\n  top: '1px',\n  left: '1px'\n};\nvar InFocusGuard = function InFocusGuard(_ref) {\n  var _ref$children = _ref.children,\n    children = _ref$children === void 0 ? null : _ref$children;\n  return /*#__PURE__*/React.createElement(Fragment, null, /*#__PURE__*/React.createElement(\"div\", {\n    key: \"guard-first\",\n    \"data-focus-guard\": true,\n    \"data-focus-auto-guard\": true,\n    style: hiddenGuard\n  }), children, children && /*#__PURE__*/React.createElement(\"div\", {\n    key: \"guard-last\",\n    \"data-focus-guard\": true,\n    \"data-focus-auto-guard\": true,\n    style: hiddenGuard\n  }));\n};\nInFocusGuard.propTypes = process.env.NODE_ENV !== \"production\" ? {\n  children: PropTypes.node\n} : {};\nexport default InFocusGuard;","/******************************************************************************\nCopyright (c) Microsoft Corporation.\n\nPermission to use, copy, modify, and/or distribute this software for any\npurpose with or without fee is hereby granted.\n\nTHE SOFTWARE IS PROVIDED \"AS IS\" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH\nREGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY\nAND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,\nINDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM\nLOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR\nOTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR\nPERFORMANCE OF THIS SOFTWARE.\n***************************************************************************** */\n/* global Reflect, Promise, SuppressedError, Symbol, Iterator */\n\nvar extendStatics = function(d, b) {\n  extendStatics = Object.setPrototypeOf ||\n      ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||\n      function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };\n  return extendStatics(d, b);\n};\n\nexport function __extends(d, b) {\n  if (typeof b !== \"function\" && b !== null)\n      throw new TypeError(\"Class extends value \" + String(b) + \" is not a constructor or null\");\n  extendStatics(d, b);\n  function __() { this.constructor = d; }\n  d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\n}\n\nexport var __assign = function() {\n  __assign = Object.assign || function __assign(t) {\n      for (var s, i = 1, n = arguments.length; i < n; i++) {\n          s = arguments[i];\n          for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p)) t[p] = s[p];\n      }\n      return t;\n  }\n  return __assign.apply(this, arguments);\n}\n\nexport function __rest(s, e) {\n  var t = {};\n  for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p) && e.indexOf(p) < 0)\n      t[p] = s[p];\n  if (s != null && typeof Object.getOwnPropertySymbols === \"function\")\n      for (var i = 0, p = Object.getOwnPropertySymbols(s); i < p.length; i++) {\n          if (e.indexOf(p[i]) < 0 && Object.prototype.propertyIsEnumerable.call(s, p[i]))\n              t[p[i]] = s[p[i]];\n      }\n  return t;\n}\n\nexport function __decorate(decorators, target, key, desc) {\n  var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;\n  if (typeof Reflect === \"object\" && typeof Reflect.decorate === \"function\") r = Reflect.decorate(decorators, target, key, desc);\n  else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;\n  return c > 3 && r && Object.defineProperty(target, key, r), r;\n}\n\nexport function __param(paramIndex, decorator) {\n  return function (target, key) { decorator(target, key, paramIndex); }\n}\n\nexport function __esDecorate(ctor, descriptorIn, decorators, contextIn, initializers, extraInitializers) {\n  function accept(f) { if (f !== void 0 && typeof f !== \"function\") throw new TypeError(\"Function expected\"); return f; }\n  var kind = contextIn.kind, key = kind === \"getter\" ? \"get\" : kind === \"setter\" ? \"set\" : \"value\";\n  var target = !descriptorIn && ctor ? contextIn[\"static\"] ? ctor : ctor.prototype : null;\n  var descriptor = descriptorIn || (target ? Object.getOwnPropertyDescriptor(target, contextIn.name) : {});\n  var _, done = false;\n  for (var i = decorators.length - 1; i >= 0; i--) {\n      var context = {};\n      for (var p in contextIn) context[p] = p === \"access\" ? {} : contextIn[p];\n      for (var p in contextIn.access) context.access[p] = contextIn.access[p];\n      context.addInitializer = function (f) { if (done) throw new TypeError(\"Cannot add initializers after decoration has completed\"); extraInitializers.push(accept(f || null)); };\n      var result = (0, decorators[i])(kind === \"accessor\" ? { get: descriptor.get, set: descriptor.set } : descriptor[key], context);\n      if (kind === \"accessor\") {\n          if (result === void 0) continue;\n          if (result === null || typeof result !== \"object\") throw new TypeError(\"Object expected\");\n          if (_ = accept(result.get)) descriptor.get = _;\n          if (_ = accept(result.set)) descriptor.set = _;\n          if (_ = accept(result.init)) initializers.unshift(_);\n      }\n      else if (_ = accept(result)) {\n          if (kind === \"field\") initializers.unshift(_);\n          else descriptor[key] = _;\n      }\n  }\n  if (target) Object.defineProperty(target, contextIn.name, descriptor);\n  done = true;\n};\n\nexport function __runInitializers(thisArg, initializers, value) {\n  var useValue = arguments.length > 2;\n  for (var i = 0; i < initializers.length; i++) {\n      value = useValue ? initializers[i].call(thisArg, value) : initializers[i].call(thisArg);\n  }\n  return useValue ? value : void 0;\n};\n\nexport function __propKey(x) {\n  return typeof x === \"symbol\" ? x : \"\".concat(x);\n};\n\nexport function __setFunctionName(f, name, prefix) {\n  if (typeof name === \"symbol\") name = name.description ? \"[\".concat(name.description, \"]\") : \"\";\n  return Object.defineProperty(f, \"name\", { configurable: true, value: prefix ? \"\".concat(prefix, \" \", name) : name });\n};\n\nexport function __metadata(metadataKey, metadataValue) {\n  if (typeof Reflect === \"object\" && typeof Reflect.metadata === \"function\") return Reflect.metadata(metadataKey, metadataValue);\n}\n\nexport function __awaiter(thisArg, _arguments, P, generator) {\n  function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\n  return new (P || (P = Promise))(function (resolve, reject) {\n      function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n      function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\n      function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\n      step((generator = generator.apply(thisArg, _arguments || [])).next());\n  });\n}\n\nexport function __generator(thisArg, body) {\n  var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g = Object.create((typeof Iterator === \"function\" ? Iterator : Object).prototype);\n  return g.next = verb(0), g[\"throw\"] = verb(1), g[\"return\"] = verb(2), typeof Symbol === \"function\" && (g[Symbol.iterator] = function() { return this; }), g;\n  function verb(n) { return function (v) { return step([n, v]); }; }\n  function step(op) {\n      if (f) throw new TypeError(\"Generator is already executing.\");\n      while (g && (g = 0, op[0] && (_ = 0)), _) try {\n          if (f = 1, y && (t = op[0] & 2 ? y[\"return\"] : op[0] ? y[\"throw\"] || ((t = y[\"return\"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;\n          if (y = 0, t) op = [op[0] & 2, t.value];\n          switch (op[0]) {\n              case 0: case 1: t = op; break;\n              case 4: _.label++; return { value: op[1], done: false };\n              case 5: _.label++; y = op[1]; op = [0]; continue;\n              case 7: op = _.ops.pop(); _.trys.pop(); continue;\n              default:\n                  if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }\n                  if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }\n                  if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }\n                  if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }\n                  if (t[2]) _.ops.pop();\n                  _.trys.pop(); continue;\n          }\n          op = body.call(thisArg, _);\n      } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }\n      if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };\n  }\n}\n\nexport var __createBinding = Object.create ? (function(o, m, k, k2) {\n  if (k2 === undefined) k2 = k;\n  var desc = Object.getOwnPropertyDescriptor(m, k);\n  if (!desc || (\"get\" in desc ? !m.__esModule : desc.writable || desc.configurable)) {\n      desc = { enumerable: true, get: function() { return m[k]; } };\n  }\n  Object.defineProperty(o, k2, desc);\n}) : (function(o, m, k, k2) {\n  if (k2 === undefined) k2 = k;\n  o[k2] = m[k];\n});\n\nexport function __exportStar(m, o) {\n  for (var p in m) if (p !== \"default\" && !Object.prototype.hasOwnProperty.call(o, p)) __createBinding(o, m, p);\n}\n\nexport function __values(o) {\n  var s = typeof Symbol === \"function\" && Symbol.iterator, m = s && o[s], i = 0;\n  if (m) return m.call(o);\n  if (o && typeof o.length === \"number\") return {\n      next: function () {\n          if (o && i >= o.length) o = void 0;\n          return { value: o && o[i++], done: !o };\n      }\n  };\n  throw new TypeError(s ? \"Object is not iterable.\" : \"Symbol.iterator is not defined.\");\n}\n\nexport function __read(o, n) {\n  var m = typeof Symbol === \"function\" && o[Symbol.iterator];\n  if (!m) return o;\n  var i = m.call(o), r, ar = [], e;\n  try {\n      while ((n === void 0 || n-- > 0) && !(r = i.next()).done) ar.push(r.value);\n  }\n  catch (error) { e = { error: error }; }\n  finally {\n      try {\n          if (r && !r.done && (m = i[\"return\"])) m.call(i);\n      }\n      finally { if (e) throw e.error; }\n  }\n  return ar;\n}\n\n/** @deprecated */\nexport function __spread() {\n  for (var ar = [], i = 0; i < arguments.length; i++)\n      ar = ar.concat(__read(arguments[i]));\n  return ar;\n}\n\n/** @deprecated */\nexport function __spreadArrays() {\n  for (var s = 0, i = 0, il = arguments.length; i < il; i++) s += arguments[i].length;\n  for (var r = Array(s), k = 0, i = 0; i < il; i++)\n      for (var a = arguments[i], j = 0, jl = a.length; j < jl; j++, k++)\n          r[k] = a[j];\n  return r;\n}\n\nexport function __spreadArray(to, from, pack) {\n  if (pack || arguments.length === 2) for (var i = 0, l = from.length, ar; i < l; i++) {\n      if (ar || !(i in from)) {\n          if (!ar) ar = Array.prototype.slice.call(from, 0, i);\n          ar[i] = from[i];\n      }\n  }\n  return to.concat(ar || Array.prototype.slice.call(from));\n}\n\nexport function __await(v) {\n  return this instanceof __await ? (this.v = v, this) : new __await(v);\n}\n\nexport function __asyncGenerator(thisArg, _arguments, generator) {\n  if (!Symbol.asyncIterator) throw new TypeError(\"Symbol.asyncIterator is not defined.\");\n  var g = generator.apply(thisArg, _arguments || []), i, q = [];\n  return i = Object.create((typeof AsyncIterator === \"function\" ? AsyncIterator : Object).prototype), verb(\"next\"), verb(\"throw\"), verb(\"return\", awaitReturn), i[Symbol.asyncIterator] = function () { return this; }, i;\n  function awaitReturn(f) { return function (v) { return Promise.resolve(v).then(f, reject); }; }\n  function verb(n, f) { if (g[n]) { i[n] = function (v) { return new Promise(function (a, b) { q.push([n, v, a, b]) > 1 || resume(n, v); }); }; if (f) i[n] = f(i[n]); } }\n  function resume(n, v) { try { step(g[n](v)); } catch (e) { settle(q[0][3], e); } }\n  function step(r) { r.value instanceof __await ? Promise.resolve(r.value.v).then(fulfill, reject) : settle(q[0][2], r); }\n  function fulfill(value) { resume(\"next\", value); }\n  function reject(value) { resume(\"throw\", value); }\n  function settle(f, v) { if (f(v), q.shift(), q.length) resume(q[0][0], q[0][1]); }\n}\n\nexport function __asyncDelegator(o) {\n  var i, p;\n  return i = {}, verb(\"next\"), verb(\"throw\", function (e) { throw e; }), verb(\"return\"), i[Symbol.iterator] = function () { return this; }, i;\n  function verb(n, f) { i[n] = o[n] ? function (v) { return (p = !p) ? { value: __await(o[n](v)), done: false } : f ? f(v) : v; } : f; }\n}\n\nexport function __asyncValues(o) {\n  if (!Symbol.asyncIterator) throw new TypeError(\"Symbol.asyncIterator is not defined.\");\n  var m = o[Symbol.asyncIterator], i;\n  return m ? m.call(o) : (o = typeof __values === \"function\" ? __values(o) : o[Symbol.iterator](), i = {}, verb(\"next\"), verb(\"throw\"), verb(\"return\"), i[Symbol.asyncIterator] = function () { return this; }, i);\n  function verb(n) { i[n] = o[n] && function (v) { return new Promise(function (resolve, reject) { v = o[n](v), settle(resolve, reject, v.done, v.value); }); }; }\n  function settle(resolve, reject, d, v) { Promise.resolve(v).then(function(v) { resolve({ value: v, done: d }); }, reject); }\n}\n\nexport function __makeTemplateObject(cooked, raw) {\n  if (Object.defineProperty) { Object.defineProperty(cooked, \"raw\", { value: raw }); } else { cooked.raw = raw; }\n  return cooked;\n};\n\nvar __setModuleDefault = Object.create ? (function(o, v) {\n  Object.defineProperty(o, \"default\", { enumerable: true, value: v });\n}) : function(o, v) {\n  o[\"default\"] = v;\n};\n\nvar ownKeys = function(o) {\n  ownKeys = Object.getOwnPropertyNames || function (o) {\n    var ar = [];\n    for (var k in o) if (Object.prototype.hasOwnProperty.call(o, k)) ar[ar.length] = k;\n    return ar;\n  };\n  return ownKeys(o);\n};\n\nexport function __importStar(mod) {\n  if (mod && mod.__esModule) return mod;\n  var result = {};\n  if (mod != null) for (var k = ownKeys(mod), i = 0; i < k.length; i++) if (k[i] !== \"default\") __createBinding(result, mod, k[i]);\n  __setModuleDefault(result, mod);\n  return result;\n}\n\nexport function __importDefault(mod) {\n  return (mod && mod.__esModule) ? mod : { default: mod };\n}\n\nexport function __classPrivateFieldGet(receiver, state, kind, f) {\n  if (kind === \"a\" && !f) throw new TypeError(\"Private accessor was defined without a getter\");\n  if (typeof state === \"function\" ? receiver !== state || !f : !state.has(receiver)) throw new TypeError(\"Cannot read private member from an object whose class did not declare it\");\n  return kind === \"m\" ? f : kind === \"a\" ? f.call(receiver) : f ? f.value : state.get(receiver);\n}\n\nexport function __classPrivateFieldSet(receiver, state, value, kind, f) {\n  if (kind === \"m\") throw new TypeError(\"Private method is not writable\");\n  if (kind === \"a\" && !f) throw new TypeError(\"Private accessor was defined without a setter\");\n  if (typeof state === \"function\" ? receiver !== state || !f : !state.has(receiver)) throw new TypeError(\"Cannot write private member to an object whose class did not declare it\");\n  return (kind === \"a\" ? f.call(receiver, value) : f ? f.value = value : state.set(receiver, value)), value;\n}\n\nexport function __classPrivateFieldIn(state, receiver) {\n  if (receiver === null || (typeof receiver !== \"object\" && typeof receiver !== \"function\")) throw new TypeError(\"Cannot use 'in' operator on non-object\");\n  return typeof state === \"function\" ? receiver === state : state.has(receiver);\n}\n\nexport function __addDisposableResource(env, value, async) {\n  if (value !== null && value !== void 0) {\n    if (typeof value !== \"object\" && typeof value !== \"function\") throw new TypeError(\"Object expected.\");\n    var dispose, inner;\n    if (async) {\n      if (!Symbol.asyncDispose) throw new TypeError(\"Symbol.asyncDispose is not defined.\");\n      dispose = value[Symbol.asyncDispose];\n    }\n    if (dispose === void 0) {\n      if (!Symbol.dispose) throw new TypeError(\"Symbol.dispose is not defined.\");\n      dispose = value[Symbol.dispose];\n      if (async) inner = dispose;\n    }\n    if (typeof dispose !== \"function\") throw new TypeError(\"Object not disposable.\");\n    if (inner) dispose = function() { try { inner.call(this); } catch (e) { return Promise.reject(e); } };\n    env.stack.push({ value: value, dispose: dispose, async: async });\n  }\n  else if (async) {\n    env.stack.push({ async: true });\n  }\n  return value;\n}\n\nvar _SuppressedError = typeof SuppressedError === \"function\" ? SuppressedError : function (error, suppressed, message) {\n  var e = new Error(message);\n  return e.name = \"SuppressedError\", e.error = error, e.suppressed = suppressed, e;\n};\n\nexport function __disposeResources(env) {\n  function fail(e) {\n    env.error = env.hasError ? new _SuppressedError(e, env.error, \"An error was suppressed during disposal.\") : e;\n    env.hasError = true;\n  }\n  var r, s = 0;\n  function next() {\n    while (r = env.stack.pop()) {\n      try {\n        if (!r.async && s === 1) return s = 0, env.stack.push(r), Promise.resolve().then(next);\n        if (r.dispose) {\n          var result = r.dispose.call(r.value);\n          if (r.async) return s |= 2, Promise.resolve(result).then(next, function(e) { fail(e); return next(); });\n        }\n        else s |= 1;\n      }\n      catch (e) {\n        fail(e);\n      }\n    }\n    if (s === 1) return env.hasError ? Promise.reject(env.error) : Promise.resolve();\n    if (env.hasError) throw env.error;\n  }\n  return next();\n}\n\nexport function __rewriteRelativeImportExtension(path, preserveJsx) {\n  if (typeof path === \"string\" && /^\\.\\.?\\//.test(path)) {\n      return path.replace(/\\.(tsx)$|((?:\\.d)?)((?:\\.[^./]+?)?)\\.([cm]?)ts$/i, function (m, tsx, d, ext, cm) {\n          return tsx ? preserveJsx ? \".jsx\" : \".js\" : d && (!ext || !cm) ? m : (d + ext + \".\" + cm.toLowerCase() + \"js\");\n      });\n  }\n  return path;\n}\n\nexport default {\n  __extends,\n  __assign,\n  __rest,\n  __decorate,\n  __param,\n  __esDecorate,\n  __runInitializers,\n  __propKey,\n  __setFunctionName,\n  __metadata,\n  __awaiter,\n  __generator,\n  __createBinding,\n  __exportStar,\n  __values,\n  __read,\n  __spread,\n  __spreadArrays,\n  __spreadArray,\n  __await,\n  __asyncGenerator,\n  __asyncDelegator,\n  __asyncValues,\n  __makeTemplateObject,\n  __importStar,\n  __importDefault,\n  __classPrivateFieldGet,\n  __classPrivateFieldSet,\n  __classPrivateFieldIn,\n  __addDisposableResource,\n  __disposeResources,\n  __rewriteRelativeImportExtension,\n};\n","import { __assign } from \"tslib\";\nfunction ItoI(a) {\n    return a;\n}\nfunction innerCreateMedium(defaults, middleware) {\n    if (middleware === void 0) { middleware = ItoI; }\n    var buffer = [];\n    var assigned = false;\n    var medium = {\n        read: function () {\n            if (assigned) {\n                throw new Error('Sidecar: could not `read` from an `assigned` medium. `read` could be used only with `useMedium`.');\n            }\n            if (buffer.length) {\n                return buffer[buffer.length - 1];\n            }\n            return defaults;\n        },\n        useMedium: function (data) {\n            var item = middleware(data, assigned);\n            buffer.push(item);\n            return function () {\n                buffer = buffer.filter(function (x) { return x !== item; });\n            };\n        },\n        assignSyncMedium: function (cb) {\n            assigned = true;\n            while (buffer.length) {\n                var cbs = buffer;\n                buffer = [];\n                cbs.forEach(cb);\n            }\n            buffer = {\n                push: function (x) { return cb(x); },\n                filter: function () { return buffer; },\n            };\n        },\n        assignMedium: function (cb) {\n            assigned = true;\n            var pendingQueue = [];\n            if (buffer.length) {\n                var cbs = buffer;\n                buffer = [];\n                cbs.forEach(cb);\n                pendingQueue = buffer;\n            }\n            var executeQueue = function () {\n                var cbs = pendingQueue;\n                pendingQueue = [];\n                cbs.forEach(cb);\n            };\n            var cycle = function () { return Promise.resolve().then(executeQueue); };\n            cycle();\n            buffer = {\n                push: function (x) {\n                    pendingQueue.push(x);\n                    cycle();\n                },\n                filter: function (filter) {\n                    pendingQueue = pendingQueue.filter(filter);\n                    return buffer;\n                },\n            };\n        },\n    };\n    return medium;\n}\nexport function createMedium(defaults, middleware) {\n    if (middleware === void 0) { middleware = ItoI; }\n    return innerCreateMedium(defaults, middleware);\n}\n// eslint-disable-next-line @typescript-eslint/ban-types\nexport function createSidecarMedium(options) {\n    if (options === void 0) { options = {}; }\n    var medium = innerCreateMedium(null);\n    medium.options = __assign({ async: true, ssr: false }, options);\n    return medium;\n}\n","import { createMedium, createSidecarMedium } from 'use-sidecar';\nexport var mediumFocus = createMedium({}, function (_ref) {\n  var target = _ref.target,\n    currentTarget = _ref.currentTarget;\n  return {\n    target: target,\n    currentTarget: currentTarget\n  };\n});\nexport var mediumBlur = createMedium();\nexport var mediumEffect = createMedium();\nexport var mediumSidecar = createSidecarMedium({\n  async: true,\n  ssr: typeof document !== 'undefined'\n});","import { createContext } from 'react';\nexport var focusScope = /*#__PURE__*/createContext(undefined);","import _extends from \"@babel/runtime/helpers/esm/extends\";\nimport React, { forwardRef, useRef, useState, useCallback, useEffect, useMemo, Fragment } from 'react';\nimport { node, bool, string, any, arrayOf, oneOfType, object, func } from 'prop-types';\nimport { FOCUS_DISABLED, FOCUS_GROUP } from 'focus-lock/constants';\nimport { useMergeRefs } from 'use-callback-ref';\nimport { hiddenGuard } from './FocusGuard';\nimport { mediumFocus, mediumBlur, mediumSidecar } from './medium';\nimport { focusScope } from './scope';\nvar emptyArray = [];\nvar FocusLock = /*#__PURE__*/forwardRef(function FocusLockUI(props, parentRef) {\n  var _extends2;\n  var _useState = useState(),\n    realObserved = _useState[0],\n    setObserved = _useState[1];\n  var observed = useRef();\n  var isActive = useRef(false);\n  var originalFocusedElement = useRef(null);\n  var _useState2 = useState({}),\n    update = _useState2[1];\n  var children = props.children,\n    _props$disabled = props.disabled,\n    disabled = _props$disabled === void 0 ? false : _props$disabled,\n    _props$noFocusGuards = props.noFocusGuards,\n    noFocusGuards = _props$noFocusGuards === void 0 ? false : _props$noFocusGuards,\n    _props$persistentFocu = props.persistentFocus,\n    persistentFocus = _props$persistentFocu === void 0 ? false : _props$persistentFocu,\n    _props$crossFrame = props.crossFrame,\n    crossFrame = _props$crossFrame === void 0 ? true : _props$crossFrame,\n    _props$autoFocus = props.autoFocus,\n    autoFocus = _props$autoFocus === void 0 ? true : _props$autoFocus,\n    allowTextSelection = props.allowTextSelection,\n    group = props.group,\n    className = props.className,\n    whiteList = props.whiteList,\n    hasPositiveIndices = props.hasPositiveIndices,\n    _props$shards = props.shards,\n    shards = _props$shards === void 0 ? emptyArray : _props$shards,\n    _props$as = props.as,\n    Container = _props$as === void 0 ? 'div' : _props$as,\n    _props$lockProps = props.lockProps,\n    containerProps = _props$lockProps === void 0 ? {} : _props$lockProps,\n    SideCar = props.sideCar,\n    _props$returnFocus = props.returnFocus,\n    shouldReturnFocus = _props$returnFocus === void 0 ? false : _props$returnFocus,\n    focusOptions = props.focusOptions,\n    onActivationCallback = props.onActivation,\n    onDeactivationCallback = props.onDeactivation;\n  var _useState3 = useState({}),\n    id = _useState3[0];\n  var onActivation = useCallback(function (_ref) {\n    var captureFocusRestore = _ref.captureFocusRestore;\n    if (!originalFocusedElement.current) {\n      var _document;\n      var activeElement = (_document = document) == null ? void 0 : _document.activeElement;\n      originalFocusedElement.current = activeElement;\n      if (activeElement !== document.body) {\n        originalFocusedElement.current = captureFocusRestore(activeElement);\n      }\n    }\n    if (observed.current && onActivationCallback) {\n      onActivationCallback(observed.current);\n    }\n    isActive.current = true;\n    update();\n  }, [onActivationCallback]);\n  var onDeactivation = useCallback(function () {\n    isActive.current = false;\n    if (onDeactivationCallback) {\n      onDeactivationCallback(observed.current);\n    }\n    update();\n  }, [onDeactivationCallback]);\n  var returnFocus = useCallback(function (allowDefer) {\n    var focusRestore = originalFocusedElement.current;\n    if (focusRestore) {\n      var returnFocusTo = (typeof focusRestore === 'function' ? focusRestore() : focusRestore) || document.body;\n      var howToReturnFocus = typeof shouldReturnFocus === 'function' ? shouldReturnFocus(returnFocusTo) : shouldReturnFocus;\n      if (howToReturnFocus) {\n        var returnFocusOptions = typeof howToReturnFocus === 'object' ? howToReturnFocus : undefined;\n        originalFocusedElement.current = null;\n        if (allowDefer) {\n          Promise.resolve().then(function () {\n            return returnFocusTo.focus(returnFocusOptions);\n          });\n        } else {\n          returnFocusTo.focus(returnFocusOptions);\n        }\n      }\n    }\n  }, [shouldReturnFocus]);\n  var onFocus = useCallback(function (event) {\n    if (isActive.current) {\n      mediumFocus.useMedium(event);\n    }\n  }, []);\n  var onBlur = mediumBlur.useMedium;\n  var setObserveNode = useCallback(function (newObserved) {\n    if (observed.current !== newObserved) {\n      observed.current = newObserved;\n      setObserved(newObserved);\n    }\n  }, []);\n  if (process.env.NODE_ENV !== 'production') {\n    if (typeof allowTextSelection !== 'undefined') {\n      console.warn('React-Focus-Lock: allowTextSelection is deprecated and enabled by default');\n    }\n    useEffect(function () {\n      if (!observed.current && typeof Container !== 'string') {\n        console.error('FocusLock: could not obtain ref to internal node');\n      }\n    }, []);\n  }\n  var lockProps = _extends((_extends2 = {}, _extends2[FOCUS_DISABLED] = disabled && 'disabled', _extends2[FOCUS_GROUP] = group, _extends2), containerProps);\n  var hasLeadingGuards = noFocusGuards !== true;\n  var hasTailingGuards = hasLeadingGuards && noFocusGuards !== 'tail';\n  var mergedRef = useMergeRefs([parentRef, setObserveNode]);\n  var focusScopeValue = useMemo(function () {\n    return {\n      observed: observed,\n      shards: shards,\n      enabled: !disabled,\n      active: isActive.current\n    };\n  }, [disabled, isActive.current, shards, realObserved]);\n  return /*#__PURE__*/React.createElement(Fragment, null, hasLeadingGuards && [\n  /*#__PURE__*/\n  React.createElement(\"div\", {\n    key: \"guard-first\",\n    \"data-focus-guard\": true,\n    tabIndex: disabled ? -1 : 0,\n    style: hiddenGuard\n  }), hasPositiveIndices ? /*#__PURE__*/React.createElement(\"div\", {\n    key: \"guard-nearest\",\n    \"data-focus-guard\": true,\n    tabIndex: disabled ? -1 : 1,\n    style: hiddenGuard\n  }) : null], !disabled && /*#__PURE__*/React.createElement(SideCar, {\n    id: id,\n    sideCar: mediumSidecar,\n    observed: realObserved,\n    disabled: disabled,\n    persistentFocus: persistentFocus,\n    crossFrame: crossFrame,\n    autoFocus: autoFocus,\n    whiteList: whiteList,\n    shards: shards,\n    onActivation: onActivation,\n    onDeactivation: onDeactivation,\n    returnFocus: returnFocus,\n    focusOptions: focusOptions,\n    noFocusGuards: noFocusGuards\n  }), /*#__PURE__*/React.createElement(Container, _extends({\n    ref: mergedRef\n  }, lockProps, {\n    className: className,\n    onBlur: onBlur,\n    onFocus: onFocus\n  }), /*#__PURE__*/React.createElement(focusScope.Provider, {\n    value: focusScopeValue\n  }, children)), hasTailingGuards && /*#__PURE__*/React.createElement(\"div\", {\n    \"data-focus-guard\": true,\n    tabIndex: disabled ? -1 : 0,\n    style: hiddenGuard\n  }));\n});\nFocusLock.propTypes = process.env.NODE_ENV !== \"production\" ? {\n  children: node,\n  disabled: bool,\n  returnFocus: oneOfType([bool, object, func]),\n  focusOptions: object,\n  noFocusGuards: bool,\n  hasPositiveIndices: bool,\n  allowTextSelection: bool,\n  autoFocus: bool,\n  persistentFocus: bool,\n  crossFrame: bool,\n  group: string,\n  className: string,\n  whiteList: func,\n  shards: arrayOf(any),\n  as: oneOfType([string, func, object]),\n  lockProps: object,\n  onActivation: func,\n  onDeactivation: func,\n  sideCar: any.isRequired\n} : {};\nexport default FocusLock;","function _setPrototypeOf(t, e) {\n  return _setPrototypeOf = Object.setPrototypeOf ? Object.setPrototypeOf.bind() : function (t, e) {\n    return t.__proto__ = e, t;\n  }, _setPrototypeOf(t, e);\n}\nexport { _setPrototypeOf as default };","import setPrototypeOf from \"./setPrototypeOf.js\";\nfunction _inheritsLoose(t, o) {\n  t.prototype = Object.create(o.prototype), t.prototype.constructor = t, setPrototypeOf(t, o);\n}\nexport { _inheritsLoose as default };","function _typeof(o) {\n  \"@babel/helpers - typeof\";\n\n  return _typeof = \"function\" == typeof Symbol && \"symbol\" == typeof Symbol.iterator ? function (o) {\n    return typeof o;\n  } : function (o) {\n    return o && \"function\" == typeof Symbol && o.constructor === Symbol && o !== Symbol.prototype ? \"symbol\" : typeof o;\n  }, _typeof(o);\n}\nexport { _typeof as default };","import _typeof from \"./typeof.js\";\nfunction toPrimitive(t, r) {\n  if (\"object\" != _typeof(t) || !t) return t;\n  var e = t[Symbol.toPrimitive];\n  if (void 0 !== e) {\n    var i = e.call(t, r || \"default\");\n    if (\"object\" != _typeof(i)) return i;\n    throw new TypeError(\"@@toPrimitive must return a primitive value.\");\n  }\n  return (\"string\" === r ? String : Number)(t);\n}\nexport { toPrimitive as default };","import _typeof from \"./typeof.js\";\nimport toPrimitive from \"./toPrimitive.js\";\nfunction toPropertyKey(t) {\n  var i = toPrimitive(t, \"string\");\n  return \"symbol\" == _typeof(i) ? i : i + \"\";\n}\nexport { toPropertyKey as default };","import toPropertyKey from \"./toPropertyKey.js\";\nfunction _defineProperty(e, r, t) {\n  return (r = toPropertyKey(r)) in e ? Object.defineProperty(e, r, {\n    value: t,\n    enumerable: !0,\n    configurable: !0,\n    writable: !0\n  }) : e[r] = t, e;\n}\nexport { _defineProperty as default };","import _inheritsLoose from '@babel/runtime/helpers/esm/inheritsLoose';\nimport _defineProperty from '@babel/runtime/helpers/esm/defineProperty';\nimport React, { PureComponent } from 'react';\n\nfunction withSideEffect(reducePropsToState, handleStateChangeOnClient) {\n  if (process.env.NODE_ENV !== \"production\") {\n    if (typeof reducePropsToState !== 'function') {\n      throw new Error('Expected reducePropsToState to be a function.');\n    }\n\n    if (typeof handleStateChangeOnClient !== 'function') {\n      throw new Error('Expected handleStateChangeOnClient to be a function.');\n    }\n  }\n\n  function getDisplayName(WrappedComponent) {\n    return WrappedComponent.displayName || WrappedComponent.name || 'Component';\n  }\n\n  return function wrap(WrappedComponent) {\n    if (process.env.NODE_ENV !== \"production\") {\n      if (typeof WrappedComponent !== 'function') {\n        throw new Error('Expected WrappedComponent to be a React component.');\n      }\n    }\n\n    var mountedInstances = [];\n    var state;\n\n    function emitChange() {\n      state = reducePropsToState(mountedInstances.map(function (instance) {\n        return instance.props;\n      }));\n      handleStateChangeOnClient(state);\n    }\n\n    var SideEffect = /*#__PURE__*/function (_PureComponent) {\n      _inheritsLoose(SideEffect, _PureComponent);\n\n      function SideEffect() {\n        return _PureComponent.apply(this, arguments) || this;\n      }\n\n      // Try to use displayName of wrapped component\n      SideEffect.peek = function peek() {\n        return state;\n      };\n\n      var _proto = SideEffect.prototype;\n\n      _proto.componentDidMount = function componentDidMount() {\n        mountedInstances.push(this);\n        emitChange();\n      };\n\n      _proto.componentDidUpdate = function componentDidUpdate() {\n        emitChange();\n      };\n\n      _proto.componentWillUnmount = function componentWillUnmount() {\n        var index = mountedInstances.indexOf(this);\n        mountedInstances.splice(index, 1);\n        emitChange();\n      };\n\n      _proto.render = function render() {\n        return /*#__PURE__*/React.createElement(WrappedComponent, this.props);\n      };\n\n      return SideEffect;\n    }(PureComponent);\n\n    _defineProperty(SideEffect, \"displayName\", \"SideEffect(\" + getDisplayName(WrappedComponent) + \")\");\n\n    return SideEffect;\n  };\n}\n\nexport default withSideEffect;\n","/*\nIE11 support\n */\nexport var toArray = function (a) {\n    var ret = Array(a.length);\n    for (var i = 0; i < a.length; ++i) {\n        ret[i] = a[i];\n    }\n    return ret;\n};\nexport var asArray = function (a) { return (Array.isArray(a) ? a : [a]); };\nexport var getFirst = function (a) { return (Array.isArray(a) ? a[0] : a); };\n","import { FOCUS_NO_AUTOFOCUS } from '../constants';\nvar isElementHidden = function (node) {\n    // we can measure only \"elements\"\n    // consider others as \"visible\"\n    if (node.nodeType !== Node.ELEMENT_NODE) {\n        return false;\n    }\n    var computedStyle = window.getComputedStyle(node, null);\n    if (!computedStyle || !computedStyle.getPropertyValue) {\n        return false;\n    }\n    return (computedStyle.getPropertyValue('display') === 'none' || computedStyle.getPropertyValue('visibility') === 'hidden');\n};\nvar getParentNode = function (node) {\n    // DOCUMENT_FRAGMENT_NODE can also point on ShadowRoot. In this case .host will point on the next node\n    return node.parentNode && node.parentNode.nodeType === Node.DOCUMENT_FRAGMENT_NODE\n        ? // eslint-disable-next-line @typescript-eslint/no-explicit-any\n            node.parentNode.host\n        : node.parentNode;\n};\nvar isTopNode = function (node) {\n    // @ts-ignore\n    return node === document || (node && node.nodeType === Node.DOCUMENT_NODE);\n};\nvar isInert = function (node) { return node.hasAttribute('inert'); };\n/**\n * @see https://github.com/testing-library/jest-dom/blob/main/src/to-be-visible.js\n */\nvar isVisibleUncached = function (node, checkParent) {\n    return !node || isTopNode(node) || (!isElementHidden(node) && !isInert(node) && checkParent(getParentNode(node)));\n};\nexport var isVisibleCached = function (visibilityCache, node) {\n    var cached = visibilityCache.get(node);\n    if (cached !== undefined) {\n        return cached;\n    }\n    var result = isVisibleUncached(node, isVisibleCached.bind(undefined, visibilityCache));\n    visibilityCache.set(node, result);\n    return result;\n};\nvar isAutoFocusAllowedUncached = function (node, checkParent) {\n    return node && !isTopNode(node) ? (isAutoFocusAllowed(node) ? checkParent(getParentNode(node)) : false) : true;\n};\nexport var isAutoFocusAllowedCached = function (cache, node) {\n    var cached = cache.get(node);\n    if (cached !== undefined) {\n        return cached;\n    }\n    var result = isAutoFocusAllowedUncached(node, isAutoFocusAllowedCached.bind(undefined, cache));\n    cache.set(node, result);\n    return result;\n};\nexport var getDataset = function (node) {\n    // @ts-ignore\n    return node.dataset;\n};\nexport var isHTMLButtonElement = function (node) { return node.tagName === 'BUTTON'; };\nexport var isHTMLInputElement = function (node) { return node.tagName === 'INPUT'; };\nexport var isRadioElement = function (node) {\n    return isHTMLInputElement(node) && node.type === 'radio';\n};\nexport var notHiddenInput = function (node) {\n    return !((isHTMLInputElement(node) || isHTMLButtonElement(node)) && (node.type === 'hidden' || node.disabled));\n};\nexport var isAutoFocusAllowed = function (node) {\n    var attribute = node.getAttribute(FOCUS_NO_AUTOFOCUS);\n    return ![true, 'true', ''].includes(attribute);\n};\nexport var isGuard = function (node) { var _a; return Boolean(node && ((_a = getDataset(node)) === null || _a === void 0 ? void 0 : _a.focusGuard)); };\nexport var isNotAGuard = function (node) { return !isGuard(node); };\nexport var isDefined = function (x) { return Boolean(x); };\n","import { toArray } from './array';\nexport var tabSort = function (a, b) {\n    var aTab = Math.max(0, a.tabIndex);\n    var bTab = Math.max(0, b.tabIndex);\n    var tabDiff = aTab - bTab;\n    var indexDiff = a.index - b.index;\n    if (tabDiff) {\n        if (!aTab) {\n            return 1;\n        }\n        if (!bTab) {\n            return -1;\n        }\n    }\n    return tabDiff || indexDiff;\n};\nvar getTabIndex = function (node) {\n    if (node.tabIndex < 0) {\n        // all \"focusable\" elements are already preselected\n        // but some might have implicit negative tabIndex\n        // return 0 for <audio without tabIndex attribute - it is \"tabbable\"\n        if (!node.hasAttribute('tabindex')) {\n            return 0;\n        }\n    }\n    return node.tabIndex;\n};\nexport var orderByTabIndex = function (nodes, filterNegative, keepGuards) {\n    return toArray(nodes)\n        .map(function (node, index) {\n        var tabIndex = getTabIndex(node);\n        return {\n            node: node,\n            index: index,\n            tabIndex: keepGuards && tabIndex === -1 ? ((node.dataset || {}).focusGuard ? 0 : -1) : tabIndex,\n        };\n    })\n        .filter(function (data) { return !filterNegative || data.tabIndex >= 0; })\n        .sort(tabSort);\n};\n","/**\n * list of the object to be considered as focusable\n */\nexport var tabbables = [\n    'button:enabled',\n    'select:enabled',\n    'textarea:enabled',\n    'input:enabled',\n    // elements with explicit roles will also use explicit tabindex\n    // '[role=\"button\"]',\n    'a[href]',\n    'area[href]',\n    'summary',\n    'iframe',\n    'object',\n    'embed',\n    'audio[controls]',\n    'video[controls]',\n    '[tabindex]',\n    '[contenteditable]',\n    '[autofocus]',\n];\n","import { FOCUS_AUTO } from '../constants';\nimport { toArray } from './array';\nimport { tabbables } from './tabbables';\nvar queryTabbables = tabbables.join(',');\nvar queryGuardTabbables = \"\".concat(queryTabbables, \", [data-focus-guard]\");\nvar getFocusablesWithShadowDom = function (parent, withGuards) {\n    return toArray((parent.shadowRoot || parent).children).reduce(function (acc, child) {\n        return acc.concat(child.matches(withGuards ? queryGuardTabbables : queryTabbables) ? [child] : [], getFocusablesWithShadowDom(child));\n    }, []);\n};\nvar getFocusablesWithIFrame = function (parent, withGuards) {\n    var _a;\n    // contentDocument of iframe will be null if current origin cannot access it\n    if (parent instanceof HTMLIFrameElement && ((_a = parent.contentDocument) === null || _a === void 0 ? void 0 : _a.body)) {\n        return getFocusables([parent.contentDocument.body], withGuards);\n    }\n    return [parent];\n};\nexport var getFocusables = function (parents, withGuards) {\n    return parents.reduce(function (acc, parent) {\n        var _a;\n        var focusableWithShadowDom = getFocusablesWithShadowDom(parent, withGuards);\n        var focusableWithIframes = (_a = []).concat.apply(_a, focusableWithShadowDom.map(function (node) { return getFocusablesWithIFrame(node, withGuards); }));\n        return acc.concat(\n        // add all tabbables inside and within shadow DOMs in DOM order\n        focusableWithIframes, \n        // add if node is tabbable itself\n        parent.parentNode\n            ? toArray(parent.parentNode.querySelectorAll(queryTabbables)).filter(function (node) { return node === parent; })\n            : []);\n    }, []);\n};\n/**\n * return a list of focusable nodes within an area marked as \"auto-focusable\"\n * @param parent\n */\nexport var getParentAutofocusables = function (parent) {\n    var parentFocus = parent.querySelectorAll(\"[\".concat(FOCUS_AUTO, \"]\"));\n    return toArray(parentFocus)\n        .map(function (node) { return getFocusables([node]); })\n        .reduce(function (acc, nodes) { return acc.concat(nodes); }, []);\n};\n","import { toArray } from './array';\nimport { isAutoFocusAllowedCached, isVisibleCached, notHiddenInput } from './is';\nimport { orderByTabIndex } from './tabOrder';\nimport { getFocusables, getParentAutofocusables } from './tabUtils';\n/**\n * given list of focusable elements keeps the ones user can interact with\n * @param nodes\n * @param visibilityCache\n */\nexport var filterFocusable = function (nodes, visibilityCache) {\n    return toArray(nodes)\n        .filter(function (node) { return isVisibleCached(visibilityCache, node); })\n        .filter(function (node) { return notHiddenInput(node); });\n};\nexport var filterAutoFocusable = function (nodes, cache) {\n    if (cache === void 0) { cache = new Map(); }\n    return toArray(nodes).filter(function (node) { return isAutoFocusAllowedCached(cache, node); });\n};\n/**\n * !__WARNING__! Low level API.\n * @returns all tabbable nodes\n *\n * @see {@link getFocusableNodes} to get any focusable element\n *\n * @param topNodes - array of top level HTMLElements to search inside\n * @param visibilityCache - an cache to store intermediate measurements. Expected to be a fresh `new Map` on every call\n */\nexport var getTabbableNodes = function (topNodes, visibilityCache, withGuards) {\n    return orderByTabIndex(filterFocusable(getFocusables(topNodes, withGuards), visibilityCache), true, withGuards);\n};\n/**\n * !__WARNING__! Low level API.\n *\n * @returns anything \"focusable\", not only tabbable. The difference is in `tabIndex=-1`\n * (without guards, as long as they are not expected to be ever focused)\n *\n * @see {@link getTabbableNodes} to get only tabble nodes element\n *\n * @param topNodes - array of top level HTMLElements to search inside\n * @param visibilityCache - an cache to store intermediate measurements. Expected to be a fresh `new Map` on every call\n */\nexport var getFocusableNodes = function (topNodes, visibilityCache) {\n    return orderByTabIndex(filterFocusable(getFocusables(topNodes), visibilityCache), false);\n};\n/**\n * return list of nodes which are expected to be auto-focused\n * @param topNode\n * @param visibilityCache\n */\nexport var parentAutofocusables = function (topNode, visibilityCache) {\n    return filterFocusable(getParentAutofocusables(topNode), visibilityCache);\n};\n/*\n * Determines if element is contained in scope, including nested shadow DOMs\n */\nexport var contains = function (scope, element) {\n    if (scope.shadowRoot) {\n        return contains(scope.shadowRoot, element);\n    }\n    else {\n        if (Object.getPrototypeOf(scope).contains !== undefined &&\n            Object.getPrototypeOf(scope).contains.call(scope, element)) {\n            return true;\n        }\n        return toArray(scope.children).some(function (child) {\n            var _a;\n            if (child instanceof HTMLIFrameElement) {\n                var iframeBody = (_a = child.contentDocument) === null || _a === void 0 ? void 0 : _a.body;\n                if (iframeBody) {\n                    return contains(iframeBody, element);\n                }\n                return false;\n            }\n            return contains(child, element);\n        });\n    }\n};\n","import { FOCUS_DISABLED, FOCUS_GROUP } from '../constants';\nimport { asArray, toArray } from './array';\n/**\n * in case of multiple nodes nested inside each other\n * keeps only top ones\n * this is O(nlogn)\n * @param nodes\n * @returns {*}\n */\nvar filterNested = function (nodes) {\n    var contained = new Set();\n    var l = nodes.length;\n    for (var i = 0; i < l; i += 1) {\n        for (var j = i + 1; j < l; j += 1) {\n            var position = nodes[i].compareDocumentPosition(nodes[j]);\n            /* eslint-disable no-bitwise */\n            if ((position & Node.DOCUMENT_POSITION_CONTAINED_BY) > 0) {\n                contained.add(j);\n            }\n            if ((position & Node.DOCUMENT_POSITION_CONTAINS) > 0) {\n                contained.add(i);\n            }\n            /* eslint-enable */\n        }\n    }\n    return nodes.filter(function (_, index) { return !contained.has(index); });\n};\n/**\n * finds top most parent for a node\n * @param node\n * @returns {*}\n */\nvar getTopParent = function (node) {\n    return node.parentNode ? getTopParent(node.parentNode) : node;\n};\n/**\n * returns all \"focus containers\" inside a given node\n * @param node - node or nodes to look inside\n * @returns Element[]\n */\nexport var getAllAffectedNodes = function (node) {\n    var nodes = asArray(node);\n    return nodes.filter(Boolean).reduce(function (acc, currentNode) {\n        var group = currentNode.getAttribute(FOCUS_GROUP);\n        acc.push.apply(acc, (group\n            ? filterNested(toArray(getTopParent(currentNode).querySelectorAll(\"[\".concat(FOCUS_GROUP, \"=\\\"\").concat(group, \"\\\"]:not([\").concat(FOCUS_DISABLED, \"=\\\"disabled\\\"])\"))))\n            : [currentNode]));\n        return acc;\n    }, []);\n};\n","export var safeProbe = function (cb) {\n    try {\n        return cb();\n    }\n    catch (e) {\n        return undefined;\n    }\n};\n","/**\n * returns active element from document or from nested shadowdoms\n */\nimport { safeProbe } from './safe';\n/**\n * returns current active element. If the active element is a \"container\" itself(shadowRoot or iframe) returns active element inside it\n * @param [inDocument]\n */\nexport var getActiveElement = function (inDocument) {\n    if (inDocument === void 0) { inDocument = document; }\n    if (!inDocument || !inDocument.activeElement) {\n        return undefined;\n    }\n    var activeElement = inDocument.activeElement;\n    return (activeElement.shadowRoot\n        ? getActiveElement(activeElement.shadowRoot)\n        : activeElement instanceof HTMLIFrameElement && safeProbe(function () { return activeElement.contentWindow.document; })\n            ? getActiveElement(activeElement.contentWindow.document)\n            : activeElement);\n};\n","import { contains } from './utils/DOMutils';\nimport { getAllAffectedNodes } from './utils/all-affected';\nimport { getFirst, toArray } from './utils/array';\nimport { getActiveElement } from './utils/getActiveElement';\nvar focusInFrame = function (frame, activeElement) { return frame === activeElement; };\nvar focusInsideIframe = function (topNode, activeElement) {\n    return Boolean(toArray(topNode.querySelectorAll('iframe')).some(function (node) { return focusInFrame(node, activeElement); }));\n};\n/**\n * @returns {Boolean} true, if the current focus is inside given node or nodes.\n * Supports nodes hidden inside shadowDom\n */\nexport var focusInside = function (topNode, activeElement) {\n    // const activeElement = document && getActiveElement();\n    if (activeElement === void 0) { activeElement = getActiveElement(getFirst(topNode).ownerDocument); }\n    if (!activeElement || (activeElement.dataset && activeElement.dataset.focusGuard)) {\n        return false;\n    }\n    return getAllAffectedNodes(topNode).some(function (node) {\n        return contains(node, activeElement) || focusInsideIframe(node, activeElement);\n    });\n};\n","import { FOCUS_ALLOW } from './constants';\nimport { contains } from './utils/DOMutils';\nimport { toArray } from './utils/array';\nimport { getActiveElement } from './utils/getActiveElement';\n/**\n * checks if focus is hidden FROM the focus-lock\n * ie contained inside a node focus-lock shall ignore\n *\n * This is a utility function coupled with {@link FOCUS_ALLOW} constant\n *\n * @returns {boolean} focus is currently is in \"allow\" area\n */\nexport var focusIsHidden = function (inDocument) {\n    if (inDocument === void 0) { inDocument = document; }\n    var activeElement = getActiveElement(inDocument);\n    if (!activeElement) {\n        return false;\n    }\n    // this does not support setting FOCUS_ALLOW within shadow dom\n    return toArray(inDocument.querySelectorAll(\"[\".concat(FOCUS_ALLOW, \"]\"))).some(function (node) { return contains(node, activeElement); });\n};\n","import { isRadioElement } from './is';\nvar findSelectedRadio = function (node, nodes) {\n    return nodes\n        .filter(isRadioElement)\n        .filter(function (el) { return el.name === node.name; })\n        .filter(function (el) { return el.checked; })[0] || node;\n};\nexport var correctNode = function (node, nodes) {\n    if (isRadioElement(node) && node.name) {\n        return findSelectedRadio(node, nodes);\n    }\n    return node;\n};\n/**\n * giving a set of radio inputs keeps only selected (tabbable) ones\n * @param nodes\n */\nexport var correctNodes = function (nodes) {\n    // IE11 has no Set(array) constructor\n    var resultSet = new Set();\n    nodes.forEach(function (node) { return resultSet.add(correctNode(node, nodes)); });\n    // using filter to support IE11\n    return nodes.filter(function (node) { return resultSet.has(node); });\n};\n","import { correctNode } from './correctFocus';\nexport var pickFirstFocus = function (nodes) {\n    if (nodes[0] && nodes.length > 1) {\n        return correctNode(nodes[0], nodes);\n    }\n    return nodes[0];\n};\nexport var pickFocusable = function (nodes, node) {\n    return nodes.indexOf(correctNode(node, nodes));\n};\n","import { correctNodes } from './utils/correctFocus';\nimport { pickFocusable } from './utils/firstFocus';\nimport { isGuard } from './utils/is';\nexport var NEW_FOCUS = 'NEW_FOCUS';\n/**\n * Main solver for the \"find next focus\" question\n * @param innerNodes - used to control \"return focus\"\n * @param innerTabbables - used to control \"autofocus\"\n * @param outerNodes\n * @param activeElement\n * @param lastNode\n * @returns {number|string|undefined|*}\n */\nexport var newFocus = function (innerNodes, innerTabbables, outerNodes, activeElement, lastNode) {\n    var cnt = innerNodes.length;\n    var firstFocus = innerNodes[0];\n    var lastFocus = innerNodes[cnt - 1];\n    var isOnGuard = isGuard(activeElement);\n    // focus is inside\n    if (activeElement && innerNodes.indexOf(activeElement) >= 0) {\n        return undefined;\n    }\n    var activeIndex = activeElement !== undefined ? outerNodes.indexOf(activeElement) : -1;\n    var lastIndex = lastNode ? outerNodes.indexOf(lastNode) : activeIndex;\n    var lastNodeInside = lastNode ? innerNodes.indexOf(lastNode) : -1;\n    // no active focus (or focus is on the body)\n    if (activeIndex === -1) {\n        // known fallback\n        if (lastNodeInside !== -1) {\n            return lastNodeInside;\n        }\n        return NEW_FOCUS;\n    }\n    // new focus, nothing to calculate\n    if (lastNodeInside === -1) {\n        return NEW_FOCUS;\n    }\n    var indexDiff = activeIndex - lastIndex;\n    var firstNodeIndex = outerNodes.indexOf(firstFocus);\n    var lastNodeIndex = outerNodes.indexOf(lastFocus);\n    var correctedNodes = correctNodes(outerNodes);\n    var currentFocusableIndex = activeElement !== undefined ? correctedNodes.indexOf(activeElement) : -1;\n    var previousFocusableIndex = lastNode ? correctedNodes.indexOf(lastNode) : currentFocusableIndex;\n    var tabbableNodes = correctedNodes.filter(function (node) { return node.tabIndex >= 0; });\n    var currentTabbableIndex = activeElement !== undefined ? tabbableNodes.indexOf(activeElement) : -1;\n    var previousTabbableIndex = lastNode ? tabbableNodes.indexOf(lastNode) : currentTabbableIndex;\n    var focusIndexDiff = currentTabbableIndex >= 0 && previousTabbableIndex >= 0\n        ? // old/new are tabbables, measure distance in tabbable space\n            previousTabbableIndex - currentTabbableIndex\n        : // or else measure in focusable space\n            previousFocusableIndex - currentFocusableIndex;\n    // old focus\n    if (!indexDiff && lastNodeInside >= 0) {\n        return lastNodeInside;\n    }\n    // no tabbable elements, autofocus is not possible\n    if (innerTabbables.length === 0) {\n        // an edge case with no tabbable elements\n        // return the last focusable one\n        // with some probability this will prevent focus from cycling across the lock, but there is no tabbale elements to cycle to\n        return lastNodeInside;\n    }\n    var returnFirstNode = pickFocusable(innerNodes, innerTabbables[0]);\n    var returnLastNode = pickFocusable(innerNodes, innerTabbables[innerTabbables.length - 1]);\n    // first element\n    if (activeIndex <= firstNodeIndex && isOnGuard && Math.abs(indexDiff) > 1) {\n        return returnLastNode;\n    }\n    // last element\n    if (activeIndex >= lastNodeIndex && isOnGuard && Math.abs(indexDiff) > 1) {\n        return returnFirstNode;\n    }\n    // jump out, but not on the guard\n    if (indexDiff && Math.abs(focusIndexDiff) > 1) {\n        return lastNodeInside;\n    }\n    // focus above lock\n    if (activeIndex <= firstNodeIndex) {\n        return returnLastNode;\n    }\n    // focus below lock\n    if (activeIndex > lastNodeIndex) {\n        return returnFirstNode;\n    }\n    // index is inside tab order, but outside Lock\n    if (indexDiff) {\n        if (Math.abs(indexDiff) > 1) {\n            return lastNodeInside;\n        }\n        return (cnt + lastNodeInside + indexDiff) % cnt;\n    }\n    // do nothing\n    return undefined;\n};\n","import { filterAutoFocusable } from './DOMutils';\nimport { pickFirstFocus } from './firstFocus';\nimport { getDataset } from './is';\nvar findAutoFocused = function (autoFocusables) {\n    return function (node) {\n        var _a;\n        var autofocus = (_a = getDataset(node)) === null || _a === void 0 ? void 0 : _a.autofocus;\n        return (\n        // @ts-expect-error\n        node.autofocus ||\n            //\n            (autofocus !== undefined && autofocus !== 'false') ||\n            //\n            autoFocusables.indexOf(node) >= 0);\n    };\n};\nexport var pickAutofocus = function (nodesIndexes, orderedNodes, groups) {\n    var nodes = nodesIndexes.map(function (_a) {\n        var node = _a.node;\n        return node;\n    });\n    var autoFocusable = filterAutoFocusable(nodes.filter(findAutoFocused(groups)));\n    if (autoFocusable && autoFocusable.length) {\n        return pickFirstFocus(autoFocusable);\n    }\n    return pickFirstFocus(filterAutoFocusable(orderedNodes));\n};\n","import { parentAutofocusables } from './DOMutils';\nimport { contains } from './DOMutils';\nimport { asArray } from './array';\nvar getParents = function (node, parents) {\n    if (parents === void 0) { parents = []; }\n    parents.push(node);\n    if (node.parentNode) {\n        getParents(node.parentNode.host || node.parentNode, parents);\n    }\n    return parents;\n};\n/**\n * finds a parent for both nodeA and nodeB\n * @param nodeA\n * @param nodeB\n * @returns {boolean|*}\n */\nexport var getCommonParent = function (nodeA, nodeB) {\n    var parentsA = getParents(nodeA);\n    var parentsB = getParents(nodeB);\n    // tslint:disable-next-line:prefer-for-of\n    for (var i = 0; i < parentsA.length; i += 1) {\n        var currentParent = parentsA[i];\n        if (parentsB.indexOf(currentParent) >= 0) {\n            return currentParent;\n        }\n    }\n    return false;\n};\nexport var getTopCommonParent = function (baseActiveElement, leftEntry, rightEntries) {\n    var activeElements = asArray(baseActiveElement);\n    var leftEntries = asArray(leftEntry);\n    var activeElement = activeElements[0];\n    var topCommon = false;\n    leftEntries.filter(Boolean).forEach(function (entry) {\n        topCommon = getCommonParent(topCommon || entry, entry) || topCommon;\n        rightEntries.filter(Boolean).forEach(function (subEntry) {\n            var common = getCommonParent(activeElement, subEntry);\n            if (common) {\n                if (!topCommon || contains(common, topCommon)) {\n                    topCommon = common;\n                }\n                else {\n                    topCommon = getCommonParent(common, topCommon);\n                }\n            }\n        });\n    });\n    // TODO: add assert here?\n    return topCommon;\n};\n/**\n * return list of nodes which are expected to be autofocused inside a given top nodes\n * @param entries\n * @param visibilityCache\n */\nexport var allParentAutofocusables = function (entries, visibilityCache) {\n    return entries.reduce(function (acc, node) { return acc.concat(parentAutofocusables(node, visibilityCache)); }, []);\n};\n","import { NEW_FOCUS, newFocus } from './solver';\nimport { getFocusableNodes } from './utils/DOMutils';\nimport { getAllAffectedNodes } from './utils/all-affected';\nimport { asArray, getFirst } from './utils/array';\nimport { pickAutofocus } from './utils/auto-focus';\nimport { getActiveElement } from './utils/getActiveElement';\nimport { isDefined, isNotAGuard } from './utils/is';\nimport { allParentAutofocusables, getTopCommonParent } from './utils/parenting';\nvar reorderNodes = function (srcNodes, dstNodes) {\n    var remap = new Map();\n    // no Set(dstNodes) for IE11 :(\n    dstNodes.forEach(function (entity) { return remap.set(entity.node, entity); });\n    // remap to dstNodes\n    return srcNodes.map(function (node) { return remap.get(node); }).filter(isDefined);\n};\n/**\n * contains the main logic of the `focus-lock` package.\n *\n * ! you probably dont need this function !\n *\n * given top node(s) and the last active element returns the element to be focused next\n * @returns element which should be focused to move focus inside\n * @param topNode\n * @param lastNode\n */\nexport var focusSolver = function (topNode, lastNode) {\n    var activeElement = getActiveElement(asArray(topNode).length > 0 ? document : getFirst(topNode).ownerDocument);\n    var entries = getAllAffectedNodes(topNode).filter(isNotAGuard);\n    var commonParent = getTopCommonParent(activeElement || topNode, topNode, entries);\n    var visibilityCache = new Map();\n    var anyFocusable = getFocusableNodes(entries, visibilityCache);\n    var innerElements = anyFocusable.filter(function (_a) {\n        var node = _a.node;\n        return isNotAGuard(node);\n    });\n    if (!innerElements[0]) {\n        return undefined;\n    }\n    var outerNodes = getFocusableNodes([commonParent], visibilityCache).map(function (_a) {\n        var node = _a.node;\n        return node;\n    });\n    var orderedInnerElements = reorderNodes(outerNodes, innerElements);\n    // collect inner focusable and separately tabbables\n    var innerFocusables = orderedInnerElements.map(function (_a) {\n        var node = _a.node;\n        return node;\n    });\n    var innerTabbable = orderedInnerElements.filter(function (_a) {\n        var tabIndex = _a.tabIndex;\n        return tabIndex >= 0;\n    }).map(function (_a) {\n        var node = _a.node;\n        return node;\n    });\n    var newId = newFocus(innerFocusables, innerTabbable, outerNodes, activeElement, lastNode);\n    if (newId === NEW_FOCUS) {\n        var focusNode = \n        // first try only tabbable, and the fallback to all focusable, as long as at least one element should be picked for focus\n        pickAutofocus(anyFocusable, innerTabbable, allParentAutofocusables(entries, visibilityCache)) ||\n            pickAutofocus(anyFocusable, innerFocusables, allParentAutofocusables(entries, visibilityCache));\n        if (focusNode) {\n            return { node: focusNode };\n        }\n        else {\n            console.warn('focus-lock: cannot find any node to move focus into');\n            return undefined;\n        }\n    }\n    if (newId === undefined) {\n        return newId;\n    }\n    return orderedInnerElements[newId];\n};\n","import { getAllAffectedNodes } from './utils/all-affected';\nimport { isGuard, isNotAGuard } from './utils/is';\nimport { getTopCommonParent } from './utils/parenting';\nimport { orderByTabIndex } from './utils/tabOrder';\nimport { getFocusables } from './utils/tabUtils';\n/**\n * traverses all related nodes (including groups) returning a list of all nodes(outer and internal) with meta information\n * This is low-level API!\n * @returns list of focusable elements inside a given top(!) node.\n * @see {@link getFocusableNodes} providing a simpler API\n */\nexport var expandFocusableNodes = function (topNode) {\n    var entries = getAllAffectedNodes(topNode).filter(isNotAGuard);\n    var commonParent = getTopCommonParent(topNode, topNode, entries);\n    var outerNodes = orderByTabIndex(getFocusables([commonParent], true), true, true);\n    var innerElements = getFocusables(entries, false);\n    return outerNodes.map(function (_a) {\n        var node = _a.node, index = _a.index;\n        return ({\n            node: node,\n            index: index,\n            lockItem: innerElements.indexOf(node) >= 0,\n            guard: isGuard(node),\n        });\n    });\n};\n","export var focusOn = function (target, focusOptions) {\n    if (!target) {\n        // not clear how, but is possible https://github.com/theKashey/focus-lock/issues/53\n        return;\n    }\n    if ('focus' in target) {\n        target.focus(focusOptions);\n    }\n    if ('contentWindow' in target && target.contentWindow) {\n        target.contentWindow.focus();\n    }\n};\n","import { focusOn } from './commands';\nimport { focusSolver } from './focusSolver';\nvar guardCount = 0;\nvar lockDisabled = false;\n/**\n * The main functionality of the focus-lock package\n *\n * Contains focus at a given node.\n * The last focused element will help to determine which element(first or last) should be focused.\n * The found element will be focused.\n *\n * This is one time action (move), not a persistent focus-lock\n *\n * HTML markers (see {@link import('./constants').FOCUS_AUTO} constants) can control autofocus\n * @see {@link focusSolver} for the same functionality without autofocus\n */\nexport var moveFocusInside = function (topNode, lastNode, options) {\n    if (options === void 0) { options = {}; }\n    var focusable = focusSolver(topNode, lastNode);\n    // global local side effect to countain recursive lock activation and resolve focus-fighting\n    if (lockDisabled) {\n        return;\n    }\n    if (focusable) {\n        /** +FOCUS-FIGHTING prevention **/\n        if (guardCount > 2) {\n            // we have recursive entered back the lock activation\n            console.error('FocusLock: focus-fighting detected. Only one focus management system could be active. ' +\n                'See https://github.com/theKashey/focus-lock/#focus-fighting');\n            lockDisabled = true;\n            setTimeout(function () {\n                lockDisabled = false;\n            }, 1);\n            return;\n        }\n        guardCount++;\n        focusOn(focusable.node, options.focusOptions);\n        guardCount--;\n    }\n};\n","import { getTabbableNodes } from './utils/DOMutils';\nfunction weakRef(value) {\n    if (!value)\n        return null;\n    // #68 Safari 14.1 dont have it yet\n    // FIXME: remove in 2025\n    if (typeof WeakRef === 'undefined') {\n        return function () { return value || null; };\n    }\n    var w = value ? new WeakRef(value) : null;\n    return function () { return (w === null || w === void 0 ? void 0 : w.deref()) || null; };\n}\nexport var recordElementLocation = function (element) {\n    if (!element) {\n        return null;\n    }\n    var stack = [];\n    var currentElement = element;\n    while (currentElement && currentElement !== document.body) {\n        stack.push({\n            current: weakRef(currentElement),\n            parent: weakRef(currentElement.parentElement),\n            left: weakRef(currentElement.previousElementSibling),\n            right: weakRef(currentElement.nextElementSibling),\n        });\n        currentElement = currentElement.parentElement;\n    }\n    return {\n        element: weakRef(element),\n        stack: stack,\n        ownerDocument: element.ownerDocument,\n    };\n};\nvar restoreFocusTo = function (location) {\n    var _a, _b, _c, _d, _e;\n    if (!location) {\n        return undefined;\n    }\n    var stack = location.stack, ownerDocument = location.ownerDocument;\n    var visibilityCache = new Map();\n    for (var _i = 0, stack_1 = stack; _i < stack_1.length; _i++) {\n        var line = stack_1[_i];\n        var parent_1 = (_a = line.parent) === null || _a === void 0 ? void 0 : _a.call(line);\n        // is it still here?\n        if (parent_1 && ownerDocument.contains(parent_1)) {\n            var left = (_b = line.left) === null || _b === void 0 ? void 0 : _b.call(line);\n            var savedCurrent = line.current();\n            var current = parent_1.contains(savedCurrent) ? savedCurrent : undefined;\n            var right = (_c = line.right) === null || _c === void 0 ? void 0 : _c.call(line);\n            var focusables = getTabbableNodes([parent_1], visibilityCache);\n            var aim = \n            // that is element itself\n            (_e = (_d = current !== null && current !== void 0 ? current : \n            // or something in it's place\n            left === null || left === void 0 ? void 0 : left.nextElementSibling) !== null && _d !== void 0 ? _d : \n            // or somebody to the right, still close enough\n            right) !== null && _e !== void 0 ? _e : \n            // or somebody to the left, something?\n            left;\n            while (aim) {\n                for (var _f = 0, focusables_1 = focusables; _f < focusables_1.length; _f++) {\n                    var focusable = focusables_1[_f];\n                    if (aim === null || aim === void 0 ? void 0 : aim.contains(focusable.node)) {\n                        return focusable.node;\n                    }\n                }\n                aim = aim.nextElementSibling;\n            }\n            if (focusables.length) {\n                // if parent contains a focusable - move there\n                return focusables[0].node;\n            }\n        }\n    }\n    // nothing matched\n    return undefined;\n};\n/**\n * Captures the current focused element to restore focus as close as possible in the future\n * Handles situations where the focused element is removed from the DOM or no longer focusable\n * moving focus to the closest focusable element\n * @param targetElement - element where focus should be restored\n * @returns a function returning a new element to focus\n */\nexport var captureFocusRestore = function (targetElement) {\n    var location = recordElementLocation(targetElement);\n    return function () {\n        return restoreFocusTo(location);\n    };\n};\n","import { focusOn } from './commands';\nimport { getTabbableNodes, contains, getFocusableNodes } from './utils/DOMutils';\nimport { asArray } from './utils/array';\n/**\n * for a given `element` in a given `scope` returns focusable siblings\n * @param element - base element\n * @param scope - common parent. Can be document, but better to narrow it down for performance reasons\n * @returns {prev,next} - references to a focusable element before and after\n * @returns undefined - if operation is not applicable\n */\nexport var getRelativeFocusable = function (element, scope, useTabbables) {\n    if (!element || !scope) {\n        console.error('no element or scope given');\n        return {};\n    }\n    var shards = asArray(scope);\n    if (shards.every(function (shard) { return !contains(shard, element); })) {\n        console.error('Active element is not contained in the scope');\n        return {};\n    }\n    var focusables = useTabbables\n        ? getTabbableNodes(shards, new Map())\n        : getFocusableNodes(shards, new Map());\n    var current = focusables.findIndex(function (_a) {\n        var node = _a.node;\n        return node === element;\n    });\n    if (current === -1) {\n        // an edge case, when anchor element is not found\n        return undefined;\n    }\n    return {\n        prev: focusables[current - 1],\n        next: focusables[current + 1],\n        first: focusables[0],\n        last: focusables[focusables.length - 1],\n    };\n};\nvar getBoundary = function (shards, useTabbables) {\n    var set = useTabbables\n        ? getTabbableNodes(asArray(shards), new Map())\n        : getFocusableNodes(asArray(shards), new Map());\n    return {\n        first: set[0],\n        last: set[set.length - 1],\n    };\n};\nvar defaultOptions = function (options) {\n    return Object.assign({\n        scope: document.body,\n        cycle: true,\n        onlyTabbable: true,\n    }, options);\n};\nvar moveFocus = function (fromElement, options, cb) {\n    if (options === void 0) { options = {}; }\n    var newOptions = defaultOptions(options);\n    var solution = getRelativeFocusable(fromElement, newOptions.scope, newOptions.onlyTabbable);\n    if (!solution) {\n        return;\n    }\n    var target = cb(solution, newOptions.cycle);\n    if (target) {\n        focusOn(target.node, newOptions.focusOptions);\n    }\n};\n/**\n * focuses next element in the tab-order\n * @param fromElement - common parent to scope active element search or tab cycle order\n * @param {FocusNextOptions} [options] - focus options\n */\nexport var focusNextElement = function (fromElement, options) {\n    if (options === void 0) { options = {}; }\n    moveFocus(fromElement, options, function (_a, cycle) {\n        var next = _a.next, first = _a.first;\n        return next || (cycle && first);\n    });\n};\n/**\n * focuses prev element in the tab order\n * @param fromElement - common parent to scope active element search or tab cycle order\n * @param {FocusNextOptions} [options] - focus options\n */\nexport var focusPrevElement = function (fromElement, options) {\n    if (options === void 0) { options = {}; }\n    moveFocus(fromElement, options, function (_a, cycle) {\n        var prev = _a.prev, last = _a.last;\n        return prev || (cycle && last);\n    });\n};\nvar pickBoundary = function (scope, options, what) {\n    var _a;\n    var boundary = getBoundary(scope, (_a = options.onlyTabbable) !== null && _a !== void 0 ? _a : true);\n    var node = boundary[what];\n    if (node) {\n        focusOn(node.node, options.focusOptions);\n    }\n};\n/**\n * focuses first element in the tab-order\n * @param {FocusNextOptions} options - focus options\n */\nexport var focusFirstElement = function (scope, options) {\n    if (options === void 0) { options = {}; }\n    pickBoundary(scope, options, 'first');\n};\n/**\n * focuses last element in the tab order\n * @param {FocusNextOptions} options - focus options\n */\nexport var focusLastElement = function (scope, options) {\n    if (options === void 0) { options = {}; }\n    pickBoundary(scope, options, 'last');\n};\n","export function deferAction(action) {\n  setTimeout(action, 1);\n}\nexport var inlineProp = function inlineProp(name, value) {\n  var obj = {};\n  obj[name] = value;\n  return obj;\n};\nexport var extractRef = function extractRef(ref) {\n  return ref && 'current' in ref ? ref.current : ref;\n};","import React from 'react';\nimport PropTypes from 'prop-types';\nimport withSideEffect from 'react-clientside-effect';\nimport { moveFocusInside, focusInside, focusIsHidden, expandFocusableNodes, getFocusableNodes, focusNextElement, focusPrevElement, focusFirstElement, focusLastElement, captureFocusRestore } from 'focus-lock';\nimport { deferAction, extractRef } from './util';\nimport { mediumFocus, mediumBlur, mediumEffect } from './medium';\nvar focusOnBody = function focusOnBody() {\n  return document && document.activeElement === document.body;\n};\nvar isFreeFocus = function isFreeFocus() {\n  return focusOnBody() || focusIsHidden();\n};\nvar lastActiveTrap = null;\nvar lastActiveFocus = null;\nvar tryRestoreFocus = function tryRestoreFocus() {\n  return null;\n};\nvar lastPortaledElement = null;\nvar focusWasOutsideWindow = false;\nvar windowFocused = false;\nvar defaultWhitelist = function defaultWhitelist() {\n  return true;\n};\nvar focusWhitelisted = function focusWhitelisted(activeElement) {\n  return (lastActiveTrap.whiteList || defaultWhitelist)(activeElement);\n};\nvar recordPortal = function recordPortal(observerNode, portaledElement) {\n  lastPortaledElement = {\n    observerNode: observerNode,\n    portaledElement: portaledElement\n  };\n};\nvar focusIsPortaledPair = function focusIsPortaledPair(element) {\n  return lastPortaledElement && lastPortaledElement.portaledElement === element;\n};\nfunction autoGuard(startIndex, end, step, allNodes) {\n  var lastGuard = null;\n  var i = startIndex;\n  do {\n    var item = allNodes[i];\n    if (item.guard) {\n      if (item.node.dataset.focusAutoGuard) {\n        lastGuard = item;\n      }\n    } else if (item.lockItem) {\n      if (i !== startIndex) {\n        return;\n      }\n      lastGuard = null;\n    } else {\n      break;\n    }\n  } while ((i += step) !== end);\n  if (lastGuard) {\n    lastGuard.node.tabIndex = 0;\n  }\n}\nvar focusWasOutside = function focusWasOutside(crossFrameOption) {\n  if (crossFrameOption) {\n    return Boolean(focusWasOutsideWindow);\n  }\n  return focusWasOutsideWindow === 'meanwhile';\n};\nvar checkInHost = function checkInHost(check, el, boundary) {\n  return el && (el.host === check && (!el.activeElement || boundary.contains(el.activeElement)) || el.parentNode && checkInHost(check, el.parentNode, boundary));\n};\nvar withinHost = function withinHost(activeElement, workingArea) {\n  return workingArea.some(function (area) {\n    return checkInHost(activeElement, area, area);\n  });\n};\nvar getNodeFocusables = function getNodeFocusables(nodes) {\n  return getFocusableNodes(nodes, new Map());\n};\nvar isNotFocusable = function isNotFocusable(node) {\n  return !getNodeFocusables([node.parentNode]).some(function (el) {\n    return el.node === node;\n  });\n};\nvar activateTrap = function activateTrap() {\n  var result = false;\n  if (lastActiveTrap) {\n    var _lastActiveTrap = lastActiveTrap,\n      observed = _lastActiveTrap.observed,\n      persistentFocus = _lastActiveTrap.persistentFocus,\n      autoFocus = _lastActiveTrap.autoFocus,\n      shards = _lastActiveTrap.shards,\n      crossFrame = _lastActiveTrap.crossFrame,\n      focusOptions = _lastActiveTrap.focusOptions,\n      noFocusGuards = _lastActiveTrap.noFocusGuards;\n    var workingNode = observed || lastPortaledElement && lastPortaledElement.portaledElement;\n    if (focusOnBody() && lastActiveFocus && lastActiveFocus !== document.body) {\n      if (!document.body.contains(lastActiveFocus) || isNotFocusable(lastActiveFocus)) {\n        var newTarget = tryRestoreFocus();\n        if (newTarget) {\n          newTarget.focus();\n        }\n      }\n    }\n    var activeElement = document && document.activeElement;\n    if (workingNode) {\n      var workingArea = [workingNode].concat(shards.map(extractRef).filter(Boolean));\n      var shouldForceRestoreFocus = function shouldForceRestoreFocus() {\n        if (!focusWasOutside(crossFrame) || !noFocusGuards || !lastActiveFocus || windowFocused) {\n          return false;\n        }\n        var nodes = getNodeFocusables(workingArea);\n        var lastIndex = nodes.findIndex(function (_ref) {\n          var node = _ref.node;\n          return node === lastActiveFocus;\n        });\n        return lastIndex === 0 || lastIndex === nodes.length - 1;\n      };\n      if (!activeElement || focusWhitelisted(activeElement)) {\n        if (persistentFocus || shouldForceRestoreFocus() || !isFreeFocus() || !lastActiveFocus && autoFocus) {\n          if (workingNode && !(focusInside(workingArea) || activeElement && withinHost(activeElement, workingArea) || focusIsPortaledPair(activeElement, workingNode))) {\n            if (document && !lastActiveFocus && activeElement && !autoFocus) {\n              if (activeElement.blur) {\n                activeElement.blur();\n              }\n              document.body.focus();\n            } else {\n              result = moveFocusInside(workingArea, lastActiveFocus, {\n                focusOptions: focusOptions\n              });\n              lastPortaledElement = {};\n            }\n          }\n          lastActiveFocus = document && document.activeElement;\n          if (lastActiveFocus !== document.body) {\n            tryRestoreFocus = captureFocusRestore(lastActiveFocus);\n          }\n          focusWasOutsideWindow = false;\n        }\n      }\n      if (document && activeElement !== document.activeElement && document.querySelector('[data-focus-auto-guard]')) {\n        var newActiveElement = document && document.activeElement;\n        var allNodes = expandFocusableNodes(workingArea);\n        var focusedIndex = allNodes.map(function (_ref2) {\n          var node = _ref2.node;\n          return node;\n        }).indexOf(newActiveElement);\n        if (focusedIndex > -1) {\n          allNodes.filter(function (_ref3) {\n            var guard = _ref3.guard,\n              node = _ref3.node;\n            return guard && node.dataset.focusAutoGuard;\n          }).forEach(function (_ref4) {\n            var node = _ref4.node;\n            return node.removeAttribute('tabIndex');\n          });\n          autoGuard(focusedIndex, allNodes.length, +1, allNodes);\n          autoGuard(focusedIndex, -1, -1, allNodes);\n        }\n      }\n    }\n  }\n  return result;\n};\nvar onTrap = function onTrap(event) {\n  if (activateTrap() && event) {\n    event.stopPropagation();\n    event.preventDefault();\n  }\n};\nvar onBlur = function onBlur() {\n  return deferAction(activateTrap);\n};\nvar onFocus = function onFocus(event) {\n  var source = event.target;\n  var currentNode = event.currentTarget;\n  if (!currentNode.contains(source)) {\n    recordPortal(currentNode, source);\n  }\n};\nvar FocusWatcher = function FocusWatcher() {\n  return null;\n};\nvar FocusTrap = function FocusTrap(_ref5) {\n  var children = _ref5.children;\n  return /*#__PURE__*/React.createElement(\"div\", {\n    onBlur: onBlur,\n    onFocus: onFocus\n  }, children);\n};\nFocusTrap.propTypes = process.env.NODE_ENV !== \"production\" ? {\n  children: PropTypes.node.isRequired\n} : {};\nvar onWindowFocus = function onWindowFocus() {\n  windowFocused = true;\n};\nvar onWindowBlur = function onWindowBlur() {\n  windowFocused = false;\n  focusWasOutsideWindow = 'just';\n  deferAction(function () {\n    focusWasOutsideWindow = 'meanwhile';\n  });\n};\nvar attachHandler = function attachHandler() {\n  document.addEventListener('focusin', onTrap);\n  document.addEventListener('focusout', onBlur);\n  window.addEventListener('focus', onWindowFocus);\n  window.addEventListener('blur', onWindowBlur);\n};\nvar detachHandler = function detachHandler() {\n  document.removeEventListener('focusin', onTrap);\n  document.removeEventListener('focusout', onBlur);\n  window.removeEventListener('focus', onWindowFocus);\n  window.removeEventListener('blur', onWindowBlur);\n};\nfunction reducePropsToState(propsList) {\n  return propsList.filter(function (_ref6) {\n    var disabled = _ref6.disabled;\n    return !disabled;\n  });\n}\nvar focusLockAPI = {\n  moveFocusInside: moveFocusInside,\n  focusInside: focusInside,\n  focusNextElement: focusNextElement,\n  focusPrevElement: focusPrevElement,\n  focusFirstElement: focusFirstElement,\n  focusLastElement: focusLastElement,\n  captureFocusRestore: captureFocusRestore\n};\nfunction handleStateChangeOnClient(traps) {\n  var trap = traps.slice(-1)[0];\n  if (trap && !lastActiveTrap) {\n    attachHandler();\n  }\n  var lastTrap = lastActiveTrap;\n  var sameTrap = lastTrap && trap && trap.id === lastTrap.id;\n  lastActiveTrap = trap;\n  if (lastTrap && !sameTrap) {\n    lastTrap.onDeactivation();\n    if (!traps.filter(function (_ref7) {\n      var id = _ref7.id;\n      return id === lastTrap.id;\n    }).length) {\n      lastTrap.returnFocus(!trap);\n    }\n  }\n  if (trap) {\n    lastActiveFocus = null;\n    if (!sameTrap || lastTrap.observed !== trap.observed) {\n      trap.onActivation(focusLockAPI);\n    }\n    activateTrap(true);\n    deferAction(activateTrap);\n  } else {\n    detachHandler();\n    lastActiveFocus = null;\n  }\n}\nmediumFocus.assignSyncMedium(onFocus);\nmediumBlur.assignMedium(onBlur);\nmediumEffect.assignMedium(function (cb) {\n  return cb(focusLockAPI);\n});\nexport default withSideEffect(reducePropsToState, handleStateChangeOnClient)(FocusWatcher);","import _objectWithoutPropertiesLoose from \"@babel/runtime/helpers/esm/objectWithoutPropertiesLoose\";\nimport _extends from \"@babel/runtime/helpers/esm/extends\";\nimport React, { forwardRef } from 'react';\nimport FocusLockUI from './Lock';\nimport FocusTrap from './Trap';\nvar FocusLockCombination = /*#__PURE__*/forwardRef(function FocusLockUICombination(props, ref) {\n  return /*#__PURE__*/React.createElement(FocusLockUI, _extends({\n    sideCar: FocusTrap,\n    ref: ref\n  }, props));\n});\nvar _ref = FocusLockUI.propTypes || {},\n  sideCar = _ref.sideCar,\n  propTypes = _objectWithoutPropertiesLoose(_ref, [\"sideCar\"]);\nFocusLockCombination.propTypes = process.env.NODE_ENV !== \"production\" ? propTypes : {};\nexport default FocusLockCombination;","// Simple localStorage-based weekly quota for free online games\r\n// 3 free online games per week per user (by username). Premium users are exempt.\r\n\r\nconst KEY = (user: string) => `ndn_online_quota_${user}`;\r\n\r\ntype Usage = {\r\n  week: string; // e.g., YYYY-WW\r\n  used: number;\r\n};\r\n\r\nfunction getWeekId(d = new Date()): string {\r\n  // ISO week-numbering year and week\r\n  const date = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));\r\n  // Thursday in current week decides the year\r\n  const dayNum = date.getUTCDay() || 7;\r\n  date.setUTCDate(date.getUTCDate() + 4 - dayNum);\r\n  const yearStart = new Date(Date.UTC(date.getUTCFullYear(), 0, 1));\r\n  const weekNo = Math.ceil(\r\n    ((date.getTime() - yearStart.getTime()) / 86400000 + 1) / 7,\r\n  );\r\n  const week = String(weekNo).padStart(2, \"0\");\r\n  return `${date.getUTCFullYear()}-${week}`;\r\n}\r\n\r\nexport function getOnlineUsage(user: string): Usage {\r\n  try {\r\n    const raw = localStorage.getItem(KEY(user));\r\n    if (!raw) return { week: getWeekId(), used: 0 };\r\n    const u = JSON.parse(raw);\r\n    const currentWeek = getWeekId();\r\n    if (!u.week || u.week !== currentWeek)\r\n      return { week: currentWeek, used: 0 };\r\n    return { week: String(u.week), used: Number(u.used) || 0 };\r\n  } catch {\r\n    return { week: getWeekId(), used: 0 };\r\n  }\r\n}\r\n\r\nexport function setOnlineUsage(user: string, usage: Usage) {\r\n  try {\r\n    localStorage.setItem(KEY(user), JSON.stringify(usage));\r\n  } catch {}\r\n}\r\n\r\nexport function incOnlineUsage(user: string, cap = 3): Usage {\r\n  const currentWeek = getWeekId();\r\n  const u = getOnlineUsage(user);\r\n  const next: Usage = {\r\n    week: currentWeek,\r\n    used: (u.week === currentWeek ? u.used : 0) + 1,\r\n  };\r\n  // clamp to cap, though we still store the number\r\n  setOnlineUsage(user, next);\r\n  return next;\r\n}\r\n\r\nexport function getFreeRemaining(user: string, cap = 3): number {\r\n  const u = getOnlineUsage(user);\r\n  return Math.max(0, cap - (u.used || 0));\r\n}\r\n","import { useEffect, useState } from \"react\";\r\n\r\nconst LS_KEY = \"ndn:isAdmin:v1\";\r\n\r\ntype Cache = { [email: string]: { v: boolean; ts: number } };\r\n\r\nfunction getCache(): Cache {\r\n  try {\r\n    const raw = localStorage.getItem(LS_KEY);\r\n    return raw ? JSON.parse(raw) : {};\r\n  } catch {\r\n    return {};\r\n  }\r\n}\r\nfunction setCache(email: string, v: boolean) {\r\n  try {\r\n    const c = getCache();\r\n    c[(email || \"\").toLowerCase()] = { v, ts: Date.now() };\r\n    localStorage.setItem(LS_KEY, JSON.stringify(c));\r\n  } catch {}\r\n}\r\n\r\nexport async function fetchIsAdmin(email?: string | null): Promise<boolean> {\r\n  const e = String(email || \"\").toLowerCase();\r\n  if (!e) return false;\r\n  // Immediate fallbacks: owner env or local override (dev)\r\n  try {\r\n    const owner = String(\r\n      (import.meta as any)?.env?.VITE_OWNER_EMAIL || \"\",\r\n    ).toLowerCase();\r\n    if (owner && e === owner) return true;\r\n  } catch {}\r\n  // Hard fallback to known owner (repo default) if nothing else is set\r\n  if (e === \"daviesfamily108@gmail.com\") return true;\r\n  try {\r\n    const force = localStorage.getItem(\"ndn:forceAdmin\");\r\n    if (force === \"1\" || force === \"true\") return true;\r\n  } catch {}\r\n  // try cache first (5 minutes)\r\n  const c = getCache();\r\n  const hit = c[e];\r\n  if (hit && Date.now() - hit.ts < 5 * 60 * 1000) return !!hit.v;\r\n  try {\r\n    const res = await fetch(`/api/admins/check?email=${encodeURIComponent(e)}`);\r\n    const data = await res.json().catch(() => ({}));\r\n    const v = !!data?.isAdmin;\r\n    setCache(e, v);\r\n    return v;\r\n  } catch {\r\n    return !!hit?.v;\r\n  }\r\n}\r\n\r\nexport function useIsAdmin(email?: string | null) {\r\n  const e = String(email || \"\").toLowerCase();\r\n  const [isAdmin, setIsAdmin] = useState(false);\r\n  useEffect(() => {\r\n    let on = true;\r\n    if (!e) {\r\n      setIsAdmin(false);\r\n      return;\r\n    }\r\n    // Instant fallbacks before API\r\n    try {\r\n      const owner = String(\r\n        (import.meta as any)?.env?.VITE_OWNER_EMAIL || \"\",\r\n      ).toLowerCase();\r\n      const force = ((): boolean => {\r\n        try {\r\n          const v = localStorage.getItem(\"ndn:forceAdmin\");\r\n          return v === \"1\" || v === \"true\";\r\n        } catch {\r\n          return false;\r\n        }\r\n      })();\r\n      if (owner && e === owner) {\r\n        setIsAdmin(true);\r\n        return;\r\n      }\r\n      if (force) {\r\n        setIsAdmin(true);\r\n        return;\r\n      }\r\n    } catch {}\r\n    if (e === \"daviesfamily108@gmail.com\") {\r\n      setIsAdmin(true);\r\n      return;\r\n    }\r\n    fetchIsAdmin(e).then((v) => {\r\n      if (on) setIsAdmin(!!v);\r\n    });\r\n    return () => {\r\n      on = false;\r\n    };\r\n  }, [e]);\r\n  return isAdmin;\r\n}\r\n","// Demo pricing: base is 5 GBP. Convert to user currency for display.\r\nexport const BASE_PRICE_GBP = 5;\r\n\r\n// Simple static FX rates for display (not for real billing). Updated rarely.\r\nconst FX: Record<string, number> = {\r\n  GBP: 1,\r\n  EUR: 1.16, //  per \r\n  USD: 1.26, // $ per \r\n  AUD: 1.92,\r\n  NZD: 2.08,\r\n  CAD: 1.73,\r\n};\r\n\r\nexport function formatPriceInCurrency(\r\n  currency: string,\r\n  gbpAmount = BASE_PRICE_GBP,\r\n) {\r\n  const cur = (currency || \"GBP\").toUpperCase();\r\n  const rate = FX[cur] ?? 1;\r\n  const val = gbpAmount * rate;\r\n  try {\r\n    return new Intl.NumberFormat(undefined, {\r\n      style: \"currency\",\r\n      currency: cur,\r\n    }).format(val);\r\n  } catch {\r\n    // Fallback\r\n    return `${cur} ${val.toFixed(2)}`;\r\n  }\r\n}\r\n\r\nexport function getUserCurrency(): string {\r\n  try {\r\n    // Heuristic: infer from locale\r\n    const parts = new Intl.NumberFormat().resolvedOptions();\r\n    // Example: en-GB -> GBP, en-US -> USD, en-AU -> AUD, etc. Not 100% accurate.\r\n    const m = String(parts.locale).toLowerCase();\r\n    if (m.includes(\"-gb\")) return \"GBP\";\r\n    if (\r\n      m.includes(\"-ie\") ||\r\n      m.includes(\"-de\") ||\r\n      m.includes(\"-fr\") ||\r\n      m.includes(\"-es\") ||\r\n      m.includes(\"-it\") ||\r\n      m.includes(\"-nl\")\r\n    )\r\n      return \"EUR\";\r\n    if (m.includes(\"-us\")) return \"USD\";\r\n    if (m.includes(\"-au\")) return \"AUD\";\r\n    if (m.includes(\"-nz\")) return \"NZD\";\r\n    if (m.includes(\"-ca\")) return \"CAD\";\r\n    return \"GBP\";\r\n  } catch {\r\n    return \"GBP\";\r\n  }\r\n}\r\n\r\n// Centralized Discord invite; override via VITE_DISCORD_INVITE_URL in Render/Netlify\r\nexport const DISCORD_INVITE_URL: string =\r\n  (import.meta as any).env?.VITE_DISCORD_INVITE_URL ||\r\n  \"https://discord.gg/nCfT4hJz\";\r\n","export type ApiPath = string;\r\n\r\nlet cachedBaseUrl: string | null = null;\r\n\r\nfunction computeApiBase(): string {\r\n  if (cachedBaseUrl) return cachedBaseUrl;\r\n  const envUrl = (\r\n    (import.meta as any)?.env?.VITE_API_URL as string | undefined\r\n  )?.trim();\r\n  if (envUrl) {\r\n    cachedBaseUrl = envUrl.replace(/\\/$/, \"\");\r\n    return cachedBaseUrl;\r\n  }\r\n  if (typeof window !== \"undefined\") {\r\n    const { protocol, host, hostname } = window.location;\r\n    const sameOrigin = `${protocol}//${host}`;\r\n    if (\r\n      hostname.endsWith(\"onrender.com\") ||\r\n      hostname === \"localhost\" ||\r\n      hostname === \"127.0.0.1\"\r\n    ) {\r\n      cachedBaseUrl = sameOrigin.replace(/\\/$/, \"\");\r\n    } else {\r\n      cachedBaseUrl = \"https://ninedartnation.onrender.com\";\r\n    }\r\n    return cachedBaseUrl;\r\n  }\r\n  // Fallback for build/test environments without window\r\n  cachedBaseUrl = \"https://ninedartnation.onrender.com\";\r\n  return cachedBaseUrl;\r\n}\r\n\r\nfunction normalizePath(path: ApiPath): string {\r\n  if (/^https?:\\/\\//i.test(path)) return path;\r\n  const base = computeApiBase();\r\n  const cleanPath = path.startsWith(\"/\") ? path : `/${path}`;\r\n  return `${base}${cleanPath}`;\r\n}\r\n\r\nexport function resolveApiUrl(path: ApiPath): string {\r\n  return normalizePath(path);\r\n}\r\n\r\nexport function apiFetch(path: ApiPath, init?: RequestInit) {\r\n  const url = resolveApiUrl(path);\r\n  return fetch(url, init);\r\n}\r\n\r\nexport function installApiInterceptor() {\r\n  if (typeof window === \"undefined\" || typeof window.fetch !== \"function\")\r\n    return;\r\n  const anyWindow = window as typeof window & { __ndnApiPatched?: boolean };\r\n  if (anyWindow.__ndnApiPatched) return;\r\n  const originalFetch = window.fetch.bind(window);\r\n  window.fetch = (input: RequestInfo | URL, init?: RequestInit) => {\r\n    try {\r\n      if (typeof input === \"string\") {\r\n        if (input.startsWith(\"/\")) {\r\n          return originalFetch(resolveApiUrl(input), init);\r\n        }\r\n        return originalFetch(input, init);\r\n      }\r\n      if (input instanceof Request) {\r\n        const reqUrl = input.url.startsWith(\"/\")\r\n          ? resolveApiUrl(input.url)\r\n          : input.url;\r\n        if (reqUrl === input.url) {\r\n          return originalFetch(input, init);\r\n        }\r\n        const cloned = new Request(reqUrl, input);\r\n        return originalFetch(cloned, init);\r\n      }\r\n      if (input instanceof URL) {\r\n        const href = input.href.startsWith(\"/\")\r\n          ? resolveApiUrl(input.href)\r\n          : input.href;\r\n        return originalFetch(href, init);\r\n      }\r\n    } catch (err) {\r\n      console.warn(\r\n        \"[API] Interceptor failed, falling back to original fetch\",\r\n        err,\r\n      );\r\n    }\r\n    return originalFetch(input as any, init);\r\n  };\r\n  anyWindow.__ndnApiPatched = true;\r\n}\r\n","import {\r\n  LayoutDashboard,\r\n  Camera,\r\n  Users,\r\n  Trophy,\r\n  Settings,\r\n  MessageCircle,\r\n  Lock,\r\n  PoundSterling,\r\n  Bell,\r\n} from \"lucide-react\";\r\nimport FocusLock from \"react-focus-lock\";\r\nimport { useEffect, useState } from \"react\";\r\nimport { createPortal } from \"react-dom\";\r\nimport { getFreeRemaining } from \"../utils/quota\";\r\nimport { useIsAdmin } from \"../utils/admin\";\r\nimport { DISCORD_INVITE_URL } from \"../utils/config\";\r\nimport { apiFetch } from \"../utils/api\";\r\n\r\nexport type TabKey =\r\n  | \"score\"\r\n  | \"online\"\r\n  | \"offline\"\r\n  | \"friends\"\r\n  | \"stats\"\r\n  | \"calibrate\"\r\n  | \"settings\"\r\n  | \"admin\"\r\n  | \"tournaments\"\r\n  | \"fullaccess\";\r\n\r\nexport function getTabs(user: any) {\r\n  const baseTabs = [\r\n    { key: \"score\", label: \"Home\", icon: LayoutDashboard },\r\n  { key: \"online\", label: \"Online Play\", icon: Users },\r\n    { key: \"offline\", label: \"Offline\", icon: Trophy },\r\n    { key: \"tournaments\", label: \"Tournaments\", icon: Trophy },\r\n    { key: \"friends\", label: \"Friends\", icon: Users },\r\n    { key: \"stats\", label: \"Stats\", icon: Trophy },\r\n    { key: \"calibrate\", label: \"Calibrate\", icon: Camera },\r\n    { key: \"settings\", label: \"Settings\", icon: Settings },\r\n  ];\r\n  // Admin tab visibility handled in Sidebar via hook (client-side fetch)\r\n  // A premium user should not see the 'PREMIUM' tab. Check subscription details\r\n  // when present. If the user's subscription is active (includes tournament\r\n  // winners with a future expiresAt or a stripe subscription with active status),\r\n  // the tab is hidden. Otherwise, show it persistently until purchase.\r\n  function isSubscriptionActive(u: any) {\r\n    if (!u) return false;\r\n    const sub = u.subscription;\r\n    if (!sub) return !!u.fullAccess; // fallback\r\n    if (sub.fullAccess) {\r\n      if (sub.expiresAt) {\r\n        const exp = typeof sub.expiresAt === 'string' ? Date.parse(sub.expiresAt) : Number(sub.expiresAt);\r\n        if (!isNaN(exp)) return exp > Date.now();\r\n      }\r\n      if (sub.status) return sub.status === 'active';\r\n      return true; // generic fullAccess true\r\n    }\r\n    return false;\r\n  }\r\n\r\n  if (!isSubscriptionActive(user)) {\r\n    baseTabs.push({\r\n      key: \"fullaccess\",\r\n      label: \"PREMIUM $\",\r\n      icon: PoundSterling,\r\n    });\r\n  }\r\n  return baseTabs;\r\n}\r\n\r\nexport function Sidebar({\r\n  active,\r\n  onChange,\r\n  user,\r\n  className,\r\n}: {\r\n  active: TabKey;\r\n  onChange: (key: TabKey) => void;\r\n  user: any;\r\n  className?: string;\r\n}) {\r\n  // no-op debug retention removed\r\n  // When the server has not yet returned a subscription, prefer a cached\r\n  // localStorage subscription (if present) to avoid flicker in the UI.\r\n  let userForTabs = user;\r\n  if (!user?.subscription && user?.email) {\r\n    try {\r\n      const rawGet = (localStorage as any)?.getItem;\r\n      const cached = typeof rawGet === \"function\" ? rawGet.call(localStorage, `ndn:subscription:${user.email}`) : null;\r\n      if (cached) {\r\n        const subs = JSON.parse(cached);\r\n        // If we have a cached subscription, also set fullAccess to mirror the\r\n        // subscription (some code paths read user.fullAccess directly). This\r\n        // helps avoid flicker in the UI while the server confirms the\r\n        // subscription state.\r\n        userForTabs = { ...user, subscription: subs, fullAccess: subs.fullAccess || user.fullAccess };\r\n      }\r\n    } catch {\r\n      // If localStorage is missing or getItem is not a function, ignore and\r\n      // fall back to server state; this avoids a hard failure in test\r\n      // environments that may replace localStorage with a raw object.\r\n    }\r\n  }\r\n  const tabs = getTabs(userForTabs);\r\n  const isAdmin = useIsAdmin(user?.email);\r\n  // IMPORTANT: Admin tab is ONLY shown for explicitly granted admin users\r\n  // Premium status does NOT automatically grant admin access\r\n  // Admin access must be granted via /api/admins/grant endpoint by the owner\r\n  if (isAdmin && !tabs.some((t) => t.key === \"admin\")) {\r\n    const idx = tabs.findIndex((t) => t.key === \"settings\");\r\n    const adminTab = { key: \"admin\", label: \"Admin\", icon: Settings } as const;\r\n    if (idx >= 0) tabs.splice(idx, 0, adminTab as any);\r\n    else tabs.push(adminTab as any);\r\n  }\r\n  const [showDiscord, setShowDiscord] = useState(false);\r\n  const [showNDNDiscord, setShowNDNDiscord] = useState(false);\r\n  const freeLeft =\r\n    user?.username && !user?.fullAccess\r\n      ? getFreeRemaining(user.username)\r\n      : Infinity;\r\n\r\n  // Notification counts\r\n  const [notifications, setNotifications] = useState({\r\n    friendRequests: 0,\r\n    messages: 0,\r\n    tournaments: 0,\r\n  });\r\n\r\n  // Fetch notification counts\r\n  useEffect(() => {\r\n    if (!user?.email) return;\r\n\r\n    const fetchNotifications = async () => {\r\n      try {\r\n        const [requestsRes, messagesRes] = await Promise.all([\r\n          apiFetch(\r\n            `/api/friends/requests?email=${encodeURIComponent(user.email)}`,\r\n          ),\r\n          apiFetch(\r\n            `/api/friends/messages?email=${encodeURIComponent(user.email)}`,\r\n          ),\r\n        ]);\r\n\r\n        const requests = requestsRes.ok\r\n          ? await requestsRes.json()\r\n          : { requests: [] };\r\n        const messages = messagesRes.ok\r\n          ? await messagesRes.json()\r\n          : { messages: [] };\r\n\r\n        // Count unread messages (messages without read status, assuming all are unread for now)\r\n        const unreadMessages =\r\n          messages.messages?.filter((m: any) => !m.read).length || 0;\r\n\r\n        setNotifications({\r\n          friendRequests: requests.requests?.length || 0,\r\n          messages: unreadMessages,\r\n          tournaments: 0, // TODO: Add tournament notifications\r\n        });\r\n      } catch (err) {\r\n        console.error(\"Failed to fetch notifications:\", err);\r\n      }\r\n    };\r\n\r\n    fetchNotifications();\r\n    // Refresh every 30 seconds\r\n    const interval = setInterval(fetchNotifications, 30000);\r\n    return () => clearInterval(interval);\r\n  }, [user?.email]);\r\n\r\n  useEffect(() => {\r\n    if (!showDiscord) return;\r\n    const onKey = (e: KeyboardEvent) => {\r\n      if (e.key === \"Escape\" || e.key === \"Enter\") setShowDiscord(false);\r\n    };\r\n    document.addEventListener(\"keydown\", onKey);\r\n    return () => document.removeEventListener(\"keydown\", onKey);\r\n  }, [showDiscord]);\r\n  return (\r\n    <aside\r\n      className={`${user?.fullAccess ? \"premium-sidebar\" : \"\"} sidebar glass ${className ? \"\" : \"w-60\"} p-2 sm:p-4 rounded-2xl ${className ?? \"hidden sm:flex\"} flex-col gap-2 overflow-y-auto overflow-x-hidden ${className ? \"\" : \"fixed top-2 bottom-2 sm:top-4 sm:bottom-4\"}`}\r\n    >\r\n      {tabs.map(({ key, label, icon: Icon }) => {\r\n        if (key === \"admin\" && !isAdmin) return null;\r\n        return (\r\n          <button\r\n            key={key}\r\n            className={`tab whitespace-nowrap flex items-center justify-start gap-3 ${active === key ? \"tab--active\" : \"tab--inactive\"} ${key === \"fullaccess\" ? \"\" : \"\"}`}\r\n            onClick={() => onChange(key as TabKey)}\r\n            title={label}\r\n            style={{\r\n              fontWeight: 700,\r\n              fontSize: \"1.1rem\",\r\n              color: active === key ? \"#fff\" : \"#E5E7EB\",\r\n              letterSpacing: \"0.02em\",\r\n            }}\r\n          >\r\n            <Icon className=\"w-6 h-6\" />\r\n            <span className=\"flex items-center gap-2\">\r\n              {label}\r\n              {key === \"online\" && !user?.fullAccess && freeLeft <= 0 && (\r\n                <span\r\n                  title=\"Weekly free games used\"\r\n                  className=\"inline-flex items-center gap-1 text-[0.65rem] px-2 py-0.5 rounded-full bg-rose-600 text-white\"\r\n                >\r\n                  <Lock className=\"w-3 h-3\" />\r\n                  Locked\r\n                </span>\r\n              )}\r\n              {/* Notification badges */}\r\n              {key === \"friends\" && notifications.friendRequests > 0 && (\r\n                <span className=\"inline-flex items-center justify-center w-5 h-5 text-xs font-bold text-white bg-orange-500 rounded-full\">\r\n                  {notifications.friendRequests > 9\r\n                    ? \"9+\"\r\n                    : notifications.friendRequests}\r\n                </span>\r\n              )}\r\n              {key === \"score\" &&\r\n                (notifications.messages > 0 ||\r\n                  notifications.tournaments > 0) && (\r\n                  <span className=\"inline-flex items-center justify-center w-5 h-5 text-xs font-bold text-white bg-orange-500 rounded-full\">\r\n                    {notifications.messages + notifications.tournaments > 9\r\n                      ? \"9+\"\r\n                      : notifications.messages + notifications.tournaments}\r\n                  </span>\r\n                )}\r\n            </span>\r\n            {/* Only the tab label should show PREMIUM; remove extra badge */}\r\n          </button>\r\n        );\r\n      })}\r\n      {/* Discord tab at the end */}\r\n      <button\r\n        className=\"tab tab--compact whitespace-nowrap flex items-center justify-start gap-3 bg-[#5865F2] text-white mt-2\"\r\n        onClick={() => setShowDiscord(true)}\r\n        title=\"BullseyeDartsLeague\"\r\n        style={{ fontWeight: 700, fontSize: \"1.1rem\", letterSpacing: \"0.02em\" }}\r\n      >\r\n        <MessageCircle className=\"w-6 h-6\" />\r\n        <span className=\"truncate\">BullseyeDartsLeague</span>\r\n      </button>\r\n      {/* NineDartNation Discord tab */}\r\n      <button\r\n        className=\"tab tab--compact whitespace-nowrap flex items-center justify-start gap-3 bg-[#5865F2] text-white mt-1\"\r\n        onClick={() => setShowNDNDiscord(true)}\r\n        title=\"NineDartNation\"\r\n        style={{ fontWeight: 700, fontSize: \"1.1rem\", letterSpacing: \"0.02em\" }}\r\n      >\r\n        <MessageCircle className=\"w-6 h-6\" />\r\n        <span className=\"truncate\">NineDartNation</span>\r\n      </button>\r\n      {/* Discord about dialog via portal */}\r\n      {showDiscord &&\r\n        createPortal(\r\n          <div className=\"fixed inset-0 z-[1000]\">\r\n            <button\r\n              className=\"absolute inset-0 bg-black/50\"\r\n              onClick={() => setShowDiscord(false)}\r\n              onTouchStart={() => setShowDiscord(false)}\r\n              aria-label=\"Close Discord dialog\"\r\n            />\r\n            <div className=\"absolute inset-0 flex items-center justify-center p-4\">\r\n              <FocusLock returnFocus>\r\n                <div\r\n                  role=\"dialog\"\r\n                  aria-modal=\"true\"\r\n                  className=\"card max-w-md w-full relative text-left p-6 rounded-xl\"\r\n                >\r\n                  <button\r\n                    className=\"absolute -top-3 -right-3 btn px-3 py-1\"\r\n                    aria-label=\"Close\"\r\n                    onClick={() => setShowDiscord(false)}\r\n                  >\r\n                    \r\n                  </button>\r\n                  <h3 className=\"text-xl font-bold mb-2 flex items-center gap-2 text-[#8ea1e1]\">\r\n                    <MessageCircle className=\"w-6 h-6\" /> BullseyeDartsLeague\r\n                  </h3>\r\n                  <div className=\"mb-4 text-lg font-semibold\">\r\n                    Join this fantastic Online Darts League with divisions and\r\n                    other cool stuff included\r\n                  </div>\r\n                  <a\r\n                    href={DISCORD_INVITE_URL}\r\n                    target=\"_blank\"\r\n                    rel=\"noopener noreferrer nofollow\"\r\n                    className=\"btn bg-[#5865F2] text-white w-full font-bold text-lg\"\r\n                  >\r\n                    Join Discord\r\n                  </a>\r\n                </div>\r\n              </FocusLock>\r\n            </div>\r\n          </div>,\r\n          document.body,\r\n        )}\r\n      {/* NineDartNation Discord about dialog via portal */}\r\n      {showNDNDiscord &&\r\n        createPortal(\r\n          <div className=\"fixed inset-0 z-[1000]\">\r\n            <button\r\n              className=\"absolute inset-0 bg-black/50\"\r\n              onClick={() => setShowNDNDiscord(false)}\r\n              onTouchStart={() => setShowNDNDiscord(false)}\r\n              aria-label=\"Close NineDartNation dialog\"\r\n            />\r\n            <div className=\"absolute inset-0 flex items-center justify-center p-4\">\r\n              <FocusLock returnFocus>\r\n                <div\r\n                  role=\"dialog\"\r\n                  aria-modal=\"true\"\r\n                  className=\"card max-w-md w-full relative text-left p-6 rounded-xl\"\r\n                >\r\n                  <button\r\n                    className=\"absolute -top-3 -right-3 btn px-3 py-1\"\r\n                    aria-label=\"Close\"\r\n                    onClick={() => setShowNDNDiscord(false)}\r\n                  >\r\n                    \r\n                  </button>\r\n                  <h3 className=\"text-xl font-bold mb-2 flex items-center gap-2 text-[#8ea1e1]\">\r\n                    <MessageCircle className=\"w-6 h-6\" /> NineDartNation\r\n                  </h3>\r\n                  <div className=\"mb-4 text-lg font-semibold\">\r\n                    Join the NineDartNation Discord community\r\n                  </div>\r\n                  <a\r\n                    href=\"https://discord.gg/Q33J5FTVve\"\r\n                    target=\"_blank\"\r\n                    rel=\"noopener noreferrer nofollow\"\r\n                    className=\"btn bg-[#5865F2] text-white w-full font-bold text-lg\"\r\n                  >\r\n                    Join Discord\r\n                  </a>\r\n                </div>\r\n              </FocusLock>\r\n            </div>\r\n          </div>,\r\n          document.body,\r\n        )}\r\n    </aside>\r\n  );\r\n}\r\n","import React, {\r\n  PropsWithChildren,\r\n  useEffect,\r\n  useRef,\r\n  type CSSProperties,\r\n} from \"react\";\r\n\r\ntype ScrollFadeProps = PropsWithChildren<{\r\n  className?: string;\r\n  style?: CSSProperties;\r\n}>;\r\n\r\nexport default function ScrollFade({\r\n  children,\r\n  className,\r\n  style,\r\n}: ScrollFadeProps) {\r\n  const ref = useRef<HTMLDivElement | null>(null);\r\n\r\n  // Clip content under the sticky header so text never shows over it\r\n  useEffect(() => {\r\n    let raf = 0;\r\n    const updateClip = () => {\r\n      const wrapper = ref.current;\r\n      if (!wrapper) return;\r\n      const header = document.getElementById(\r\n        \"ndn-header\",\r\n      ) as HTMLElement | null;\r\n      if (!header) {\r\n        wrapper.style.clipPath = \"\";\r\n        return;\r\n      }\r\n      const scroller = document.getElementById(\r\n        \"ndn-main-scroll\",\r\n      ) as HTMLElement | null;\r\n      const scrollTop = scroller ? scroller.scrollTop : window.scrollY || 0;\r\n      // Hide content under the sticky header by rendering a lightweight mask\r\n      // element at the top of the wrapper. Using an overlay avoids layout shifts\r\n      // and prevents clip-path + transform interactions that can cause rendering\r\n      // artifacts in some browsers.\r\n      const headerH = header.getBoundingClientRect().height;\r\n      const overlap = scrollTop > 0 ? headerH : 0;\r\n      try {\r\n        // Find or create the mask node\r\n        let mask = wrapper.querySelector(\r\n          \"[data-ndn-top-mask]\",\r\n        ) as HTMLElement | null;\r\n        if (!mask) {\r\n          mask = document.createElement(\"div\");\r\n          mask.setAttribute(\"data-ndn-top-mask\", \"1\");\r\n          // keep it non-interactive and on top of the wrapper content\r\n          Object.assign(mask.style, {\r\n            position: \"absolute\",\r\n            left: \"0px\",\r\n            right: \"0px\",\r\n            top: \"0px\",\r\n            height: \"0px\",\r\n            pointerEvents: \"none\",\r\n            zIndex: \"20\",\r\n            background:\r\n              \"linear-gradient(to bottom, rgba(17,24,39,1), rgba(17,24,39,0))\",\r\n          });\r\n          wrapper.style.position = wrapper.style.position || \"relative\";\r\n          wrapper.insertBefore(mask, wrapper.firstChild);\r\n        }\r\n        if (overlap > 0) {\r\n          mask.style.height = `${overlap}px`;\r\n          mask.style.display = \"\";\r\n        } else {\r\n          mask.style.height = \"0px\";\r\n          mask.style.display = \"none\";\r\n        }\r\n        // keep layout position unchanged\r\n        wrapper.style.marginTop = \"0px\";\r\n      } catch (e) {\r\n        wrapper.style.marginTop = \"0px\";\r\n      }\r\n    };\r\n    updateClip();\r\n    const onScrollOrResize = () => {\r\n      if (raf) cancelAnimationFrame(raf);\r\n      raf = requestAnimationFrame(updateClip);\r\n    };\r\n    // Listen to the app's main scroll container instead of window\r\n    const scroller = document.getElementById(\"ndn-main-scroll\");\r\n    scroller?.addEventListener(\r\n      \"scroll\",\r\n      onScrollOrResize as any,\r\n      { passive: true } as any,\r\n    );\r\n    // Fallback to window for safety (mobile or non-standard layouts)\r\n    window.addEventListener(\"scroll\", onScrollOrResize, { passive: true });\r\n    window.addEventListener(\"resize\", onScrollOrResize);\r\n    return () => {\r\n      scroller?.removeEventListener(\"scroll\", onScrollOrResize as any);\r\n      window.removeEventListener(\"scroll\", onScrollOrResize);\r\n      window.removeEventListener(\"resize\", onScrollOrResize);\r\n      if (raf) cancelAnimationFrame(raf);\r\n    };\r\n  }, []);\r\n\r\n  return (\r\n    <div ref={ref} className={className} style={style}>\r\n      {children}\r\n    </div>\r\n  );\r\n}\r\n","import React, { useState, useEffect } from \"react\";\r\n\r\ninterface DartLoaderProps {\r\n  calibrationComplete: boolean;\r\n}\r\n\r\nconst DartLoader: React.FC<DartLoaderProps> = ({ calibrationComplete }) => {\r\n  const [showTick, setShowTick] = useState(false);\r\n  const [fade, setFade] = useState(false);\r\n\r\n  useEffect(() => {\r\n    if (calibrationComplete) {\r\n      setShowTick(true);\r\n      setTimeout(() => setFade(true), 1200);\r\n    } else {\r\n      setShowTick(false);\r\n      setFade(false);\r\n    }\r\n  }, [calibrationComplete]);\r\n\r\n  return (\r\n    <div\r\n      className={`flex flex-col items-center justify-center w-full h-full transition-opacity duration-700 ${fade ? \"opacity-0\" : \"opacity-100\"}`}\r\n      style={{\r\n        pointerEvents: \"none\",\r\n        position: \"absolute\",\r\n        inset: 0,\r\n        zIndex: 10,\r\n      }}\r\n    >\r\n      <div className=\"flex items-center justify-center\">\r\n        <svg\r\n          width=\"80\"\r\n          height=\"80\"\r\n          viewBox=\"0 0 80 80\"\r\n          className={`animate-spin-slow ${showTick ? \"opacity-0\" : \"opacity-100\"} transition-opacity duration-500`}\r\n          style={{ transition: \"opacity 0.5s\" }}\r\n        >\r\n          {/* Dart graphic */}\r\n          <g>\r\n            <rect x=\"36\" y=\"10\" width=\"8\" height=\"40\" rx=\"3\" fill=\"#a78bfa\" />\r\n            <polygon points=\"40,10 44,22 36,22\" fill=\"#f472b6\" />\r\n            <rect x=\"36\" y=\"50\" width=\"8\" height=\"18\" rx=\"2\" fill=\"#22d3ee\" />\r\n            <polygon points=\"36,68 44,68 40,78\" fill=\"#10b981\" />\r\n          </g>\r\n        </svg>\r\n        {showTick && (\r\n          <svg\r\n            width=\"80\"\r\n            height=\"80\"\r\n            viewBox=\"0 0 80 80\"\r\n            className=\"absolute\"\r\n            style={{ left: 0, top: 0 }}\r\n          >\r\n            <circle\r\n              cx=\"40\"\r\n              cy=\"40\"\r\n              r=\"32\"\r\n              fill=\"none\"\r\n              stroke=\"#10b981\"\r\n              strokeWidth=\"6\"\r\n            />\r\n            <polyline\r\n              points=\"28,44 38,54 54,30\"\r\n              fill=\"none\"\r\n              stroke=\"#10b981\"\r\n              strokeWidth=\"6\"\r\n              strokeLinecap=\"round\"\r\n              strokeLinejoin=\"round\"\r\n            />\r\n          </svg>\r\n        )}\r\n      </div>\r\n      <div className=\"mt-4 text-lg font-semibold text-indigo-200\">\r\n        {showTick ? \"Calibration Complete!\" : \"Initializing Camera...\"}\r\n      </div>\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default DartLoader;\r\n","// High-accuracy dart detector for built-in autoscore\r\n// Strategy:\r\n// - Maintain a grayscale background model (running average) when no darts are present\r\n// - For each frame, compute abs-diff mask vs background and apply a 3x3 morphological closing to reduce noise\r\n// - Restrict detection to a circular ROI around board center (from calibration) to ignore background\r\n// - Find the largest foreground blob; compute PCA on blob pixels to estimate shaft orientation\r\n// - Estimate the tip as the extreme along the principal axis in the outward radial direction from board center\r\n// - Stabilize across consecutive frames (2+) before emitting a detection; debounce between darts\r\n\r\nexport type Point = { x: number; y: number };\r\n\r\nexport type DartDetection = {\r\n  tip: Point;\r\n  axis?: { x1: number; y1: number; x2: number; y2: number };\r\n  area: number;\r\n  bbox: { x: number; y: number; w: number; h: number };\r\n  confidence: number; // 0..1 heuristic\r\n};\r\n\r\nexport class DartDetector {\r\n  private width = 0;\r\n  private height = 0;\r\n  private bg: Float32Array | null = null; // grayscale background\r\n  private lastAcceptTs = 0;\r\n  private cooldownMs = 600;\r\n  private roiRadius = 0; // pixels; 0 means disabled\r\n  private roiCx = 0;\r\n  private roiCy = 0;\r\n  private initialized = false;\r\n\r\n  // Tuning (defaults intentionally more permissive)\r\n  private thresh = 18; // intensity threshold for foreground (was 28)\r\n  private minArea = 60; // min connected pixels to consider a dart (was 90)\r\n  private maxArea = 6000; // guard against massive motion\r\n  private angMaxDeg = 70; // how far from radial to tolerate\r\n  // temporal stabilization\r\n  private prevTip: Point | null = null;\r\n  private prevArea: number = 0;\r\n  private stableCount = 0;\r\n  private requireStableN = 3;\r\n\r\n  constructor(cfg?: {\r\n    thresh?: number;\r\n    minArea?: number;\r\n    maxArea?: number;\r\n    requireStableN?: number;\r\n    angMaxDeg?: number;\r\n  }) {\r\n    if (cfg?.thresh !== undefined) this.thresh = cfg.thresh;\r\n    if (cfg?.minArea !== undefined) this.minArea = cfg.minArea;\r\n    if (cfg?.maxArea !== undefined) this.maxArea = cfg.maxArea;\r\n    if (cfg?.requireStableN !== undefined)\r\n      this.requireStableN = cfg.requireStableN;\r\n    if (cfg?.angMaxDeg !== undefined) this.angMaxDeg = cfg.angMaxDeg;\r\n  }\r\n\r\n  setROI(cx: number, cy: number, radius: number) {\r\n    this.roiCx = cx;\r\n    this.roiCy = cy;\r\n    this.roiRadius = Math.max(0, radius | 0);\r\n  }\r\n\r\n  reset(width: number, height: number) {\r\n    this.width = width;\r\n    this.height = height;\r\n    this.bg = new Float32Array(width * height);\r\n    this.initialized = false;\r\n  }\r\n\r\n  // Seed or update background model with the provided frame\r\n  // If not initialized, copy; else running average with small alpha\r\n  updateBackground(frame: ImageData, alpha = 0.05) {\r\n    const { width: w, height: h, data } = frame;\r\n    if (!this.bg || w !== this.width || h !== this.height) {\r\n      this.reset(w, h);\r\n    }\r\n    const bg = this.bg!;\r\n    const n = w * h;\r\n    for (let i = 0, p = 0; i < n; i++, p += 4) {\r\n      const r = data[p],\r\n        g = data[p + 1],\r\n        b = data[p + 2];\r\n      const gray = 0.299 * r + 0.587 * g + 0.114 * b;\r\n      if (!this.initialized) bg[i] = gray;\r\n      else bg[i] = (1 - alpha) * bg[i] + alpha * gray;\r\n    }\r\n    this.initialized = true;\r\n  }\r\n\r\n  private inRoi(x: number, y: number): boolean {\r\n    if (this.roiRadius <= 0) return true;\r\n    const dx = x - this.roiCx;\r\n    const dy = y - this.roiCy;\r\n    return dx * dx + dy * dy <= this.roiRadius * this.roiRadius;\r\n  }\r\n\r\n  // Returns a detection if a new dart-like blob is found; null otherwise\r\n  detect(frame: ImageData): DartDetection | null {\r\n    const now = Date.now();\r\n    const recent = now - this.lastAcceptTs < this.cooldownMs;\r\n    const { width: w, height: h, data } = frame;\r\n    if (!this.bg || w !== this.width || h !== this.height) this.reset(w, h);\r\n    const bg = this.bg!;\r\n    if (!this.initialized) {\r\n      this.updateBackground(frame, 1.0);\r\n      return null;\r\n    }\r\n\r\n    // Build diff buffer and compute dynamic threshold excluding specular highlights\r\n    const n = w * h;\r\n    const mask = new Uint8Array(n);\r\n    const diff = new Float32Array(n);\r\n    let sum = 0,\r\n      sum2 = 0,\r\n      cnt = 0;\r\n    const isHighlight = new Uint8Array(n);\r\n    for (let i = 0, p = 0; i < n; i++, p += 4) {\r\n      const r = data[p],\r\n        g = data[p + 1],\r\n        b = data[p + 2];\r\n      const maxc = Math.max(r, g, b);\r\n      const minc = Math.min(r, g, b);\r\n      const gray = 0.299 * r + 0.587 * g + 0.114 * b;\r\n      const d = Math.abs(gray - bg[i]);\r\n      diff[i] = d;\r\n      const y = Math.floor(i / w);\r\n      const x = i - y * w;\r\n      // specular highlight heuristic: very bright with low chroma\r\n      const satApprox = maxc === 0 ? 0 : (maxc - minc) / maxc;\r\n      const isHi = maxc >= 250 && satApprox <= 0.12;\r\n      if (isHi) isHighlight[i] = 1;\r\n      if (this.inRoi(x, y) && !isHi) {\r\n        sum += d;\r\n        sum2 += d * d;\r\n        cnt++;\r\n      }\r\n    }\r\n    const mu = cnt ? sum / cnt : 0;\r\n    const var_ = cnt ? Math.max(0, sum2 / cnt - mu * mu) : 0;\r\n    const sigma = Math.sqrt(var_);\r\n    const dynamicThresh = Math.max(this.thresh, mu + 1.2 * sigma);\r\n    // Rebuild mask using dynamic threshold and ignoring highlights\r\n    for (let i = 0; i < n; i++) {\r\n      if (isHighlight[i]) {\r\n        mask[i] = 0;\r\n        continue;\r\n      }\r\n      if (diff[i] > dynamicThresh) {\r\n        const y = Math.floor(i / w);\r\n        const x = i - y * w;\r\n        mask[i] = this.inRoi(x, y) ? 1 : 0;\r\n      }\r\n    }\r\n\r\n    // Morphological closing (dilate then erode) to consolidate thin shapes\r\n    this._dilate(mask, w, h);\r\n    this._erode(mask, w, h);\r\n\r\n    // Connected components (single pass using queue BFS); track largest blob\r\n    const visited = new Uint8Array(n);\r\n    let bestArea = 0;\r\n    let bestIdxs: number[] | null = null;\r\n    for (let i = 0; i < n; i++) {\r\n      if (mask[i] === 0 || visited[i]) continue;\r\n      const idxs: number[] = [];\r\n      let area = 0;\r\n      let qh = 0;\r\n      const q: number[] = [i];\r\n      visited[i] = 1;\r\n      while (qh < q.length) {\r\n        const cur = q[qh++];\r\n        idxs.push(cur);\r\n        area++;\r\n        const y = (cur / w) | 0;\r\n        const x = cur - y * w;\r\n        // 4-neighborhood\r\n        const nbs = [cur - 1, cur + 1, cur - w, cur + w];\r\n        for (const nb of nbs) {\r\n          if (nb < 0 || nb >= n) continue;\r\n          if (visited[nb]) continue;\r\n          // bounds checks for left/right\r\n          if ((nb === cur - 1 || nb === cur + 1) && ((nb / w) | 0) !== y)\r\n            continue;\r\n          if (mask[nb]) {\r\n            visited[nb] = 1;\r\n            q.push(nb);\r\n          }\r\n        }\r\n      }\r\n      if (area > bestArea) {\r\n        bestArea = area;\r\n        bestIdxs = idxs;\r\n      }\r\n    }\r\n\r\n    if (!bestIdxs || bestArea < this.minArea || bestArea > this.maxArea) {\r\n      // Slowly update background when no valid detection to adapt lighting\r\n      if (!recent) this.updateBackground(frame, 0.02);\r\n      return null;\r\n    }\r\n\r\n    // Compute PCA (covariance) on blob pixels to estimate shaft orientation\r\n    let minX = w,\r\n      minY = h,\r\n      maxX = 0,\r\n      maxY = 0;\r\n    let meanX = 0,\r\n      meanY = 0;\r\n    for (const idx of bestIdxs) {\r\n      const y = (idx / w) | 0;\r\n      const x = idx - y * w;\r\n      meanX += x;\r\n      meanY += y;\r\n      if (x < minX) minX = x;\r\n      if (x > maxX) maxX = x;\r\n      if (y < minY) minY = y;\r\n      if (y > maxY) maxY = y;\r\n    }\r\n    meanX /= bestArea;\r\n    meanY /= bestArea;\r\n    let cxx = 0,\r\n      cyy = 0,\r\n      cxy = 0;\r\n    for (const idx of bestIdxs) {\r\n      const y = (idx / w) | 0;\r\n      const x = idx - y * w;\r\n      const dx = x - meanX;\r\n      const dy = y - meanY;\r\n      cxx += dx * dx;\r\n      cyy += dy * dy;\r\n      cxy += dx * dy;\r\n    }\r\n    cxx /= bestArea;\r\n    cyy /= bestArea;\r\n    cxy /= bestArea;\r\n    // Principal axis (eigenvector of covariance with largest eigenvalue)\r\n    // For 2x2 symmetric matrix [[cxx,cxy],[cxy,cyy]], eigenvector for largest eigenvalue lambda satisfies (cxx-l)x + cxy y = 0\r\n    const trace = cxx + cyy;\r\n    const det = cxx * cyy - cxy * cxy;\r\n    const tmp = Math.sqrt(Math.max(0, (trace * trace) / 4 - det));\r\n    const l1 = trace / 2 + tmp; // largest eigenvalue\r\n    // eigenvector v = (cxy, l1 - cxx) or (l1 - cyy, cxy); choose longer\r\n    let vx = cxy,\r\n      vy = l1 - cxx;\r\n    if (Math.hypot(vx, vy) < 1e-6) {\r\n      vx = l1 - cyy;\r\n      vy = cxy;\r\n    }\r\n    const vlen = Math.hypot(vx, vy) || 1;\r\n    vx /= vlen;\r\n    vy /= vlen;\r\n\r\n    // Determine which direction along the axis points outward from board center\r\n    const dxc = meanX - this.roiCx;\r\n    const dyc = meanY - this.roiCy;\r\n    const outward = dxc * vx + dyc * vy > 0 ? 1 : -1;\r\n    vx *= outward;\r\n    vy *= outward;\r\n\r\n    // Enforce radial alignment: reject if principal axis deviates too much from radial direction\r\n    const rlen = Math.hypot(dxc, dyc) || 1;\r\n    const rx = dxc / rlen,\r\n      ry = dyc / rlen;\r\n    const cosAng = Math.max(-1, Math.min(1, vx * rx + vy * ry));\r\n    const angDeg = (Math.acos(cosAng) * 180) / Math.PI;\r\n  if (angDeg > this.angMaxDeg) {\r\n      // likely glare or non-radial artifact\r\n      if (!recent) this.updateBackground(frame, 0.02);\r\n      return null;\r\n    }\r\n\r\n    // Project all blob points onto axis and pick extreme (max t) as tip candidate\r\n    let maxT = -Infinity;\r\n    let tipX = meanX,\r\n      tipY = meanY;\r\n    for (const idx of bestIdxs) {\r\n      const y = (idx / w) | 0;\r\n      const x = idx - y * w;\r\n      const t = (x - meanX) * vx + (y - meanY) * vy;\r\n      if (t > maxT) {\r\n        maxT = t;\r\n        tipX = x;\r\n        tipY = y;\r\n      }\r\n    }\r\n\r\n    // Distance to center for confidence heuristic\r\n    const dxr = tipX - this.roiCx;\r\n    const dyr = tipY - this.roiCy;\r\n    const minR2 = dxr * dxr + dyr * dyr;\r\n\r\n    // Confidence heuristic based on compactness and radial extent\r\n    const bboxW = Math.max(1, maxX - minX + 1);\r\n    const bboxH = Math.max(1, maxY - minY + 1);\r\n    const bboxArea = bboxW * bboxH;\r\n    const fill = bestArea / bboxArea; // 0..1 (thin dart should be small fill)\r\n    const radial = Math.sqrt(minR2) / Math.max(1, this.roiRadius);\r\n    let confidence = 0.5;\r\n    // Prefer thin elongated shapes with small fill and inside ROI\r\n    if (fill < 0.45) confidence += 0.2;\r\n    if (fill < 0.25) confidence += 0.15;\r\n    if (radial < 1.1) confidence += 0.1;\r\n    // Orientation confidence: larger principal eigenvalue vs minor\r\n    const l2 = trace - l1;\r\n    const elong = l1 > 0 ? 1 - l2 / l1 : 0;\r\n    if (elong > 0.3) confidence += 0.1;\r\n    confidence = Math.max(0, Math.min(1, confidence));\r\n\r\n    // Update background outside the blob to keep stability\r\n    // Optionally, we can inpaint the blob into background upon acceptance by caller\r\n\r\n    // Temporal stabilization: require 2+ consistent frames for the same dart\r\n  const stable = this._isStable({ x: tipX + 0.5, y: tipY + 0.5 }, bestArea);\r\n    if (!stable) return null;\r\n    // Debounce\r\n    if (recent) return null;\r\n\r\n    return {\r\n      tip: { x: tipX + 0.5, y: tipY + 0.5 },\r\n      axis: {\r\n        x1: meanX - vx * 20,\r\n        y1: meanY - vy * 20,\r\n        x2: meanX + vx * 20,\r\n        y2: meanY + vy * 20,\r\n      },\r\n      area: bestArea,\r\n      bbox: { x: minX, y: minY, w: bboxW, h: bboxH },\r\n      confidence,\r\n    };\r\n  }\r\n\r\n  // Incorporate the accepted detection into background so it won't trigger again\r\n  accept(frame: ImageData, det: DartDetection) {\r\n    this.lastAcceptTs = Date.now();\r\n    // reset temporal stabilization for next dart\r\n    this.prevTip = null;\r\n    this.prevArea = 0;\r\n    this.stableCount = 0;\r\n    if (!this.bg) return;\r\n    const { width: w } = frame;\r\n    const bg = this.bg;\r\n    const { x, y, w: bw, h: bh } = det.bbox;\r\n    const alpha = 0.5;\r\n    for (let yy = y; yy < y + bh; yy++) {\r\n      for (let xx = x; xx < x + bw; xx++) {\r\n        const i = yy * w + xx;\r\n        const p = i * 4;\r\n        const r = frame.data[p],\r\n          g = frame.data[p + 1],\r\n          b = frame.data[p + 2];\r\n        const gray = 0.299 * r + 0.587 * g + 0.114 * b;\r\n        bg[i] = (1 - alpha) * bg[i] + alpha * gray;\r\n      }\r\n    }\r\n  }\r\n\r\n  // --- helpers ---\r\n  private _isStable(tip: Point, area: number): boolean {\r\n    const close = (a: Point, b: Point) => Math.hypot(a.x - b.x, a.y - b.y) <= 6;\r\n    if (!this.prevTip) {\r\n      this.prevTip = { ...tip };\r\n      this.prevArea = area;\r\n      this.stableCount = 1;\r\n      return false;\r\n    }\r\n    if (\r\n      close(this.prevTip, tip) &&\r\n      Math.abs(area - this.prevArea) / Math.max(1, area) < 0.3\r\n    ) {\r\n      this.prevTip = { ...tip };\r\n      this.prevArea = area;\r\n      this.stableCount++;\r\n    } else {\r\n      this.prevTip = { ...tip };\r\n      this.prevArea = area;\r\n      this.stableCount = 1;\r\n      return false;\r\n    }\r\n    return this.stableCount >= this.requireStableN;\r\n  }\r\n\r\n  private _dilate(mask: Uint8Array, w: number, h: number) {\r\n    const out = new Uint8Array(mask.length);\r\n    for (let y = 0; y < h; y++) {\r\n      for (let x = 0; x < w; x++) {\r\n        let on = 0;\r\n        for (let j = -1; j <= 1; j++) {\r\n          for (let i = -1; i <= 1; i++) {\r\n            const yy = y + j,\r\n              xx = x + i;\r\n            if (yy < 0 || yy >= h || xx < 0 || xx >= w) continue;\r\n            if (mask[yy * w + xx]) {\r\n              on = 1;\r\n              break;\r\n            }\r\n          }\r\n          if (on) break;\r\n        }\r\n        out[y * w + x] = on;\r\n      }\r\n    }\r\n    mask.set(out);\r\n  }\r\n\r\n  private _erode(mask: Uint8Array, w: number, h: number) {\r\n    const out = new Uint8Array(mask.length);\r\n    for (let y = 0; y < h; y++) {\r\n      for (let x = 0; x < w; x++) {\r\n        let on = 1;\r\n        for (let j = -1; j <= 1; j++) {\r\n          for (let i = -1; i <= 1; i++) {\r\n            const yy = y + j,\r\n              xx = x + i;\r\n            if (yy < 0 || yy >= h || xx < 0 || xx >= w) continue;\r\n            if (!mask[yy * w + xx]) {\r\n              on = 0;\r\n              break;\r\n            }\r\n          }\r\n          if (!on) break;\r\n        }\r\n        out[y * w + x] = on;\r\n      }\r\n    }\r\n    mask.set(out);\r\n  }\r\n}\r\n","const createStoreImpl = (createState) => {\n  let state;\n  const listeners = /* @__PURE__ */ new Set();\n  const setState = (partial, replace) => {\n    const nextState = typeof partial === \"function\" ? partial(state) : partial;\n    if (!Object.is(nextState, state)) {\n      const previousState = state;\n      state = (replace != null ? replace : typeof nextState !== \"object\" || nextState === null) ? nextState : Object.assign({}, state, nextState);\n      listeners.forEach((listener) => listener(state, previousState));\n    }\n  };\n  const getState = () => state;\n  const getInitialState = () => initialState;\n  const subscribe = (listener) => {\n    listeners.add(listener);\n    return () => listeners.delete(listener);\n  };\n  const destroy = () => {\n    if ((import.meta.env ? import.meta.env.MODE : void 0) !== \"production\") {\n      console.warn(\n        \"[DEPRECATED] The `destroy` method will be unsupported in a future version. Instead use unsubscribe function returned by subscribe. Everything will be garbage-collected if store is garbage-collected.\"\n      );\n    }\n    listeners.clear();\n  };\n  const api = { setState, getState, getInitialState, subscribe, destroy };\n  const initialState = state = createState(setState, getState, api);\n  return api;\n};\nconst createStore = (createState) => createState ? createStoreImpl(createState) : createStoreImpl;\nvar vanilla = (createState) => {\n  if ((import.meta.env ? import.meta.env.MODE : void 0) !== \"production\") {\n    console.warn(\n      \"[DEPRECATED] Default export is deprecated. Instead use import { createStore } from 'zustand/vanilla'.\"\n    );\n  }\n  return createStore(createState);\n};\n\nexport { createStore, vanilla as default };\n","/**\n * @license React\n * use-sync-external-store-shim.production.js\n *\n * Copyright (c) Meta Platforms, Inc. and affiliates.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n */\n\n\"use strict\";\nvar React = require(\"react\");\nfunction is(x, y) {\n  return (x === y && (0 !== x || 1 / x === 1 / y)) || (x !== x && y !== y);\n}\nvar objectIs = \"function\" === typeof Object.is ? Object.is : is,\n  useState = React.useState,\n  useEffect = React.useEffect,\n  useLayoutEffect = React.useLayoutEffect,\n  useDebugValue = React.useDebugValue;\nfunction useSyncExternalStore$2(subscribe, getSnapshot) {\n  var value = getSnapshot(),\n    _useState = useState({ inst: { value: value, getSnapshot: getSnapshot } }),\n    inst = _useState[0].inst,\n    forceUpdate = _useState[1];\n  useLayoutEffect(\n    function () {\n      inst.value = value;\n      inst.getSnapshot = getSnapshot;\n      checkIfSnapshotChanged(inst) && forceUpdate({ inst: inst });\n    },\n    [subscribe, value, getSnapshot]\n  );\n  useEffect(\n    function () {\n      checkIfSnapshotChanged(inst) && forceUpdate({ inst: inst });\n      return subscribe(function () {\n        checkIfSnapshotChanged(inst) && forceUpdate({ inst: inst });\n      });\n    },\n    [subscribe]\n  );\n  useDebugValue(value);\n  return value;\n}\nfunction checkIfSnapshotChanged(inst) {\n  var latestGetSnapshot = inst.getSnapshot;\n  inst = inst.value;\n  try {\n    var nextValue = latestGetSnapshot();\n    return !objectIs(inst, nextValue);\n  } catch (error) {\n    return !0;\n  }\n}\nfunction useSyncExternalStore$1(subscribe, getSnapshot) {\n  return getSnapshot();\n}\nvar shim =\n  \"undefined\" === typeof window ||\n  \"undefined\" === typeof window.document ||\n  \"undefined\" === typeof window.document.createElement\n    ? useSyncExternalStore$1\n    : useSyncExternalStore$2;\nexports.useSyncExternalStore =\n  void 0 !== React.useSyncExternalStore ? React.useSyncExternalStore : shim;\n","'use strict';\n\nif (process.env.NODE_ENV === 'production') {\n  module.exports = require('../cjs/use-sync-external-store-shim.production.js');\n} else {\n  module.exports = require('../cjs/use-sync-external-store-shim.development.js');\n}\n","/**\n * @license React\n * use-sync-external-store-shim/with-selector.production.js\n *\n * Copyright (c) Meta Platforms, Inc. and affiliates.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n */\n\n\"use strict\";\nvar React = require(\"react\"),\n  shim = require(\"use-sync-external-store/shim\");\nfunction is(x, y) {\n  return (x === y && (0 !== x || 1 / x === 1 / y)) || (x !== x && y !== y);\n}\nvar objectIs = \"function\" === typeof Object.is ? Object.is : is,\n  useSyncExternalStore = shim.useSyncExternalStore,\n  useRef = React.useRef,\n  useEffect = React.useEffect,\n  useMemo = React.useMemo,\n  useDebugValue = React.useDebugValue;\nexports.useSyncExternalStoreWithSelector = function (\n  subscribe,\n  getSnapshot,\n  getServerSnapshot,\n  selector,\n  isEqual\n) {\n  var instRef = useRef(null);\n  if (null === instRef.current) {\n    var inst = { hasValue: !1, value: null };\n    instRef.current = inst;\n  } else inst = instRef.current;\n  instRef = useMemo(\n    function () {\n      function memoizedSelector(nextSnapshot) {\n        if (!hasMemo) {\n          hasMemo = !0;\n          memoizedSnapshot = nextSnapshot;\n          nextSnapshot = selector(nextSnapshot);\n          if (void 0 !== isEqual && inst.hasValue) {\n            var currentSelection = inst.value;\n            if (isEqual(currentSelection, nextSnapshot))\n              return (memoizedSelection = currentSelection);\n          }\n          return (memoizedSelection = nextSnapshot);\n        }\n        currentSelection = memoizedSelection;\n        if (objectIs(memoizedSnapshot, nextSnapshot)) return currentSelection;\n        var nextSelection = selector(nextSnapshot);\n        if (void 0 !== isEqual && isEqual(currentSelection, nextSelection))\n          return (memoizedSnapshot = nextSnapshot), currentSelection;\n        memoizedSnapshot = nextSnapshot;\n        return (memoizedSelection = nextSelection);\n      }\n      var hasMemo = !1,\n        memoizedSnapshot,\n        memoizedSelection,\n        maybeGetServerSnapshot =\n          void 0 === getServerSnapshot ? null : getServerSnapshot;\n      return [\n        function () {\n          return memoizedSelector(getSnapshot());\n        },\n        null === maybeGetServerSnapshot\n          ? void 0\n          : function () {\n              return memoizedSelector(maybeGetServerSnapshot());\n            }\n      ];\n    },\n    [getSnapshot, getServerSnapshot, selector, isEqual]\n  );\n  var value = useSyncExternalStore(subscribe, instRef[0], instRef[1]);\n  useEffect(\n    function () {\n      inst.hasValue = !0;\n      inst.value = value;\n    },\n    [value]\n  );\n  useDebugValue(value);\n  return value;\n};\n","'use strict';\n\nif (process.env.NODE_ENV === 'production') {\n  module.exports = require('../cjs/use-sync-external-store-shim/with-selector.production.js');\n} else {\n  module.exports = require('../cjs/use-sync-external-store-shim/with-selector.development.js');\n}\n","import { createStore } from 'zustand/vanilla';\nexport * from 'zustand/vanilla';\nimport ReactExports from 'react';\nimport useSyncExternalStoreExports from 'use-sync-external-store/shim/with-selector.js';\n\nconst { useDebugValue } = ReactExports;\nconst { useSyncExternalStoreWithSelector } = useSyncExternalStoreExports;\nlet didWarnAboutEqualityFn = false;\nconst identity = (arg) => arg;\nfunction useStore(api, selector = identity, equalityFn) {\n  if ((import.meta.env ? import.meta.env.MODE : void 0) !== \"production\" && equalityFn && !didWarnAboutEqualityFn) {\n    console.warn(\n      \"[DEPRECATED] Use `createWithEqualityFn` instead of `create` or use `useStoreWithEqualityFn` instead of `useStore`. They can be imported from 'zustand/traditional'. https://github.com/pmndrs/zustand/discussions/1937\"\n    );\n    didWarnAboutEqualityFn = true;\n  }\n  const slice = useSyncExternalStoreWithSelector(\n    api.subscribe,\n    api.getState,\n    api.getServerState || api.getInitialState,\n    selector,\n    equalityFn\n  );\n  useDebugValue(slice);\n  return slice;\n}\nconst createImpl = (createState) => {\n  if ((import.meta.env ? import.meta.env.MODE : void 0) !== \"production\" && typeof createState !== \"function\") {\n    console.warn(\n      \"[DEPRECATED] Passing a vanilla store will be unsupported in a future version. Instead use `import { useStore } from 'zustand'`.\"\n    );\n  }\n  const api = typeof createState === \"function\" ? createStore(createState) : createState;\n  const useBoundStore = (selector, equalityFn) => useStore(api, selector, equalityFn);\n  Object.assign(useBoundStore, api);\n  return useBoundStore;\n};\nconst create = (createState) => createState ? createImpl(createState) : createImpl;\nvar react = (createState) => {\n  if ((import.meta.env ? import.meta.env.MODE : void 0) !== \"production\") {\n    console.warn(\n      \"[DEPRECATED] Default export is deprecated. Instead use `import { create } from 'zustand'`.\"\n    );\n  }\n  return create(createState);\n};\n\nexport { create, react as default, useStore };\n","const reduxImpl = (reducer, initial) => (set, _get, api) => {\n  api.dispatch = (action) => {\n    set((state) => reducer(state, action), false, action);\n    return action;\n  };\n  api.dispatchFromDevtools = true;\n  return { dispatch: (...a) => api.dispatch(...a), ...initial };\n};\nconst redux = reduxImpl;\n\nconst trackedConnections = /* @__PURE__ */ new Map();\nconst getTrackedConnectionState = (name) => {\n  const api = trackedConnections.get(name);\n  if (!api) return {};\n  return Object.fromEntries(\n    Object.entries(api.stores).map(([key, api2]) => [key, api2.getState()])\n  );\n};\nconst extractConnectionInformation = (store, extensionConnector, options) => {\n  if (store === void 0) {\n    return {\n      type: \"untracked\",\n      connection: extensionConnector.connect(options)\n    };\n  }\n  const existingConnection = trackedConnections.get(options.name);\n  if (existingConnection) {\n    return { type: \"tracked\", store, ...existingConnection };\n  }\n  const newConnection = {\n    connection: extensionConnector.connect(options),\n    stores: {}\n  };\n  trackedConnections.set(options.name, newConnection);\n  return { type: \"tracked\", store, ...newConnection };\n};\nconst devtoolsImpl = (fn, devtoolsOptions = {}) => (set, get, api) => {\n  const { enabled, anonymousActionType, store, ...options } = devtoolsOptions;\n  let extensionConnector;\n  try {\n    extensionConnector = (enabled != null ? enabled : (import.meta.env ? import.meta.env.MODE : void 0) !== \"production\") && window.__REDUX_DEVTOOLS_EXTENSION__;\n  } catch (_e) {\n  }\n  if (!extensionConnector) {\n    if ((import.meta.env ? import.meta.env.MODE : void 0) !== \"production\" && enabled) {\n      console.warn(\n        \"[zustand devtools middleware] Please install/enable Redux devtools extension\"\n      );\n    }\n    return fn(set, get, api);\n  }\n  const { connection, ...connectionInformation } = extractConnectionInformation(store, extensionConnector, options);\n  let isRecording = true;\n  api.setState = (state, replace, nameOrAction) => {\n    const r = set(state, replace);\n    if (!isRecording) return r;\n    const action = nameOrAction === void 0 ? { type: anonymousActionType || \"anonymous\" } : typeof nameOrAction === \"string\" ? { type: nameOrAction } : nameOrAction;\n    if (store === void 0) {\n      connection == null ? void 0 : connection.send(action, get());\n      return r;\n    }\n    connection == null ? void 0 : connection.send(\n      {\n        ...action,\n        type: `${store}/${action.type}`\n      },\n      {\n        ...getTrackedConnectionState(options.name),\n        [store]: api.getState()\n      }\n    );\n    return r;\n  };\n  const setStateFromDevtools = (...a) => {\n    const originalIsRecording = isRecording;\n    isRecording = false;\n    set(...a);\n    isRecording = originalIsRecording;\n  };\n  const initialState = fn(api.setState, get, api);\n  if (connectionInformation.type === \"untracked\") {\n    connection == null ? void 0 : connection.init(initialState);\n  } else {\n    connectionInformation.stores[connectionInformation.store] = api;\n    connection == null ? void 0 : connection.init(\n      Object.fromEntries(\n        Object.entries(connectionInformation.stores).map(([key, store2]) => [\n          key,\n          key === connectionInformation.store ? initialState : store2.getState()\n        ])\n      )\n    );\n  }\n  if (api.dispatchFromDevtools && typeof api.dispatch === \"function\") {\n    let didWarnAboutReservedActionType = false;\n    const originalDispatch = api.dispatch;\n    api.dispatch = (...a) => {\n      if ((import.meta.env ? import.meta.env.MODE : void 0) !== \"production\" && a[0].type === \"__setState\" && !didWarnAboutReservedActionType) {\n        console.warn(\n          '[zustand devtools middleware] \"__setState\" action type is reserved to set state from the devtools. Avoid using it.'\n        );\n        didWarnAboutReservedActionType = true;\n      }\n      originalDispatch(...a);\n    };\n  }\n  connection.subscribe((message) => {\n    var _a;\n    switch (message.type) {\n      case \"ACTION\":\n        if (typeof message.payload !== \"string\") {\n          console.error(\n            \"[zustand devtools middleware] Unsupported action format\"\n          );\n          return;\n        }\n        return parseJsonThen(\n          message.payload,\n          (action) => {\n            if (action.type === \"__setState\") {\n              if (store === void 0) {\n                setStateFromDevtools(action.state);\n                return;\n              }\n              if (Object.keys(action.state).length !== 1) {\n                console.error(\n                  `\n                    [zustand devtools middleware] Unsupported __setState action format. \n                    When using 'store' option in devtools(), the 'state' should have only one key, which is a value of 'store' that was passed in devtools(),\n                    and value of this only key should be a state object. Example: { \"type\": \"__setState\", \"state\": { \"abc123Store\": { \"foo\": \"bar\" } } }\n                    `\n                );\n              }\n              const stateFromDevtools = action.state[store];\n              if (stateFromDevtools === void 0 || stateFromDevtools === null) {\n                return;\n              }\n              if (JSON.stringify(api.getState()) !== JSON.stringify(stateFromDevtools)) {\n                setStateFromDevtools(stateFromDevtools);\n              }\n              return;\n            }\n            if (!api.dispatchFromDevtools) return;\n            if (typeof api.dispatch !== \"function\") return;\n            api.dispatch(action);\n          }\n        );\n      case \"DISPATCH\":\n        switch (message.payload.type) {\n          case \"RESET\":\n            setStateFromDevtools(initialState);\n            if (store === void 0) {\n              return connection == null ? void 0 : connection.init(api.getState());\n            }\n            return connection == null ? void 0 : connection.init(getTrackedConnectionState(options.name));\n          case \"COMMIT\":\n            if (store === void 0) {\n              connection == null ? void 0 : connection.init(api.getState());\n              return;\n            }\n            return connection == null ? void 0 : connection.init(getTrackedConnectionState(options.name));\n          case \"ROLLBACK\":\n            return parseJsonThen(message.state, (state) => {\n              if (store === void 0) {\n                setStateFromDevtools(state);\n                connection == null ? void 0 : connection.init(api.getState());\n                return;\n              }\n              setStateFromDevtools(state[store]);\n              connection == null ? void 0 : connection.init(getTrackedConnectionState(options.name));\n            });\n          case \"JUMP_TO_STATE\":\n          case \"JUMP_TO_ACTION\":\n            return parseJsonThen(message.state, (state) => {\n              if (store === void 0) {\n                setStateFromDevtools(state);\n                return;\n              }\n              if (JSON.stringify(api.getState()) !== JSON.stringify(state[store])) {\n                setStateFromDevtools(state[store]);\n              }\n            });\n          case \"IMPORT_STATE\": {\n            const { nextLiftedState } = message.payload;\n            const lastComputedState = (_a = nextLiftedState.computedStates.slice(-1)[0]) == null ? void 0 : _a.state;\n            if (!lastComputedState) return;\n            if (store === void 0) {\n              setStateFromDevtools(lastComputedState);\n            } else {\n              setStateFromDevtools(lastComputedState[store]);\n            }\n            connection == null ? void 0 : connection.send(\n              null,\n              // FIXME no-any\n              nextLiftedState\n            );\n            return;\n          }\n          case \"PAUSE_RECORDING\":\n            return isRecording = !isRecording;\n        }\n        return;\n    }\n  });\n  return initialState;\n};\nconst devtools = devtoolsImpl;\nconst parseJsonThen = (stringified, f) => {\n  let parsed;\n  try {\n    parsed = JSON.parse(stringified);\n  } catch (e) {\n    console.error(\n      \"[zustand devtools middleware] Could not parse the received json\",\n      e\n    );\n  }\n  if (parsed !== void 0) f(parsed);\n};\n\nconst subscribeWithSelectorImpl = (fn) => (set, get, api) => {\n  const origSubscribe = api.subscribe;\n  api.subscribe = (selector, optListener, options) => {\n    let listener = selector;\n    if (optListener) {\n      const equalityFn = (options == null ? void 0 : options.equalityFn) || Object.is;\n      let currentSlice = selector(api.getState());\n      listener = (state) => {\n        const nextSlice = selector(state);\n        if (!equalityFn(currentSlice, nextSlice)) {\n          const previousSlice = currentSlice;\n          optListener(currentSlice = nextSlice, previousSlice);\n        }\n      };\n      if (options == null ? void 0 : options.fireImmediately) {\n        optListener(currentSlice, currentSlice);\n      }\n    }\n    return origSubscribe(listener);\n  };\n  const initialState = fn(set, get, api);\n  return initialState;\n};\nconst subscribeWithSelector = subscribeWithSelectorImpl;\n\nconst combine = (initialState, create) => (...a) => Object.assign({}, initialState, create(...a));\n\nfunction createJSONStorage(getStorage, options) {\n  let storage;\n  try {\n    storage = getStorage();\n  } catch (_e) {\n    return;\n  }\n  const persistStorage = {\n    getItem: (name) => {\n      var _a;\n      const parse = (str2) => {\n        if (str2 === null) {\n          return null;\n        }\n        return JSON.parse(str2, options == null ? void 0 : options.reviver);\n      };\n      const str = (_a = storage.getItem(name)) != null ? _a : null;\n      if (str instanceof Promise) {\n        return str.then(parse);\n      }\n      return parse(str);\n    },\n    setItem: (name, newValue) => storage.setItem(\n      name,\n      JSON.stringify(newValue, options == null ? void 0 : options.replacer)\n    ),\n    removeItem: (name) => storage.removeItem(name)\n  };\n  return persistStorage;\n}\nconst toThenable = (fn) => (input) => {\n  try {\n    const result = fn(input);\n    if (result instanceof Promise) {\n      return result;\n    }\n    return {\n      then(onFulfilled) {\n        return toThenable(onFulfilled)(result);\n      },\n      catch(_onRejected) {\n        return this;\n      }\n    };\n  } catch (e) {\n    return {\n      then(_onFulfilled) {\n        return this;\n      },\n      catch(onRejected) {\n        return toThenable(onRejected)(e);\n      }\n    };\n  }\n};\nconst oldImpl = (config, baseOptions) => (set, get, api) => {\n  let options = {\n    getStorage: () => localStorage,\n    serialize: JSON.stringify,\n    deserialize: JSON.parse,\n    partialize: (state) => state,\n    version: 0,\n    merge: (persistedState, currentState) => ({\n      ...currentState,\n      ...persistedState\n    }),\n    ...baseOptions\n  };\n  let hasHydrated = false;\n  const hydrationListeners = /* @__PURE__ */ new Set();\n  const finishHydrationListeners = /* @__PURE__ */ new Set();\n  let storage;\n  try {\n    storage = options.getStorage();\n  } catch (_e) {\n  }\n  if (!storage) {\n    return config(\n      (...args) => {\n        console.warn(\n          `[zustand persist middleware] Unable to update item '${options.name}', the given storage is currently unavailable.`\n        );\n        set(...args);\n      },\n      get,\n      api\n    );\n  }\n  const thenableSerialize = toThenable(options.serialize);\n  const setItem = () => {\n    const state = options.partialize({ ...get() });\n    let errorInSync;\n    const thenable = thenableSerialize({ state, version: options.version }).then(\n      (serializedValue) => storage.setItem(options.name, serializedValue)\n    ).catch((e) => {\n      errorInSync = e;\n    });\n    if (errorInSync) {\n      throw errorInSync;\n    }\n    return thenable;\n  };\n  const savedSetState = api.setState;\n  api.setState = (state, replace) => {\n    savedSetState(state, replace);\n    void setItem();\n  };\n  const configResult = config(\n    (...args) => {\n      set(...args);\n      void setItem();\n    },\n    get,\n    api\n  );\n  let stateFromStorage;\n  const hydrate = () => {\n    var _a;\n    if (!storage) return;\n    hasHydrated = false;\n    hydrationListeners.forEach((cb) => cb(get()));\n    const postRehydrationCallback = ((_a = options.onRehydrateStorage) == null ? void 0 : _a.call(options, get())) || void 0;\n    return toThenable(storage.getItem.bind(storage))(options.name).then((storageValue) => {\n      if (storageValue) {\n        return options.deserialize(storageValue);\n      }\n    }).then((deserializedStorageValue) => {\n      if (deserializedStorageValue) {\n        if (typeof deserializedStorageValue.version === \"number\" && deserializedStorageValue.version !== options.version) {\n          if (options.migrate) {\n            return options.migrate(\n              deserializedStorageValue.state,\n              deserializedStorageValue.version\n            );\n          }\n          console.error(\n            `State loaded from storage couldn't be migrated since no migrate function was provided`\n          );\n        } else {\n          return deserializedStorageValue.state;\n        }\n      }\n    }).then((migratedState) => {\n      var _a2;\n      stateFromStorage = options.merge(\n        migratedState,\n        (_a2 = get()) != null ? _a2 : configResult\n      );\n      set(stateFromStorage, true);\n      return setItem();\n    }).then(() => {\n      postRehydrationCallback == null ? void 0 : postRehydrationCallback(stateFromStorage, void 0);\n      hasHydrated = true;\n      finishHydrationListeners.forEach((cb) => cb(stateFromStorage));\n    }).catch((e) => {\n      postRehydrationCallback == null ? void 0 : postRehydrationCallback(void 0, e);\n    });\n  };\n  api.persist = {\n    setOptions: (newOptions) => {\n      options = {\n        ...options,\n        ...newOptions\n      };\n      if (newOptions.getStorage) {\n        storage = newOptions.getStorage();\n      }\n    },\n    clearStorage: () => {\n      storage == null ? void 0 : storage.removeItem(options.name);\n    },\n    getOptions: () => options,\n    rehydrate: () => hydrate(),\n    hasHydrated: () => hasHydrated,\n    onHydrate: (cb) => {\n      hydrationListeners.add(cb);\n      return () => {\n        hydrationListeners.delete(cb);\n      };\n    },\n    onFinishHydration: (cb) => {\n      finishHydrationListeners.add(cb);\n      return () => {\n        finishHydrationListeners.delete(cb);\n      };\n    }\n  };\n  hydrate();\n  return stateFromStorage || configResult;\n};\nconst newImpl = (config, baseOptions) => (set, get, api) => {\n  let options = {\n    storage: createJSONStorage(() => localStorage),\n    partialize: (state) => state,\n    version: 0,\n    merge: (persistedState, currentState) => ({\n      ...currentState,\n      ...persistedState\n    }),\n    ...baseOptions\n  };\n  let hasHydrated = false;\n  const hydrationListeners = /* @__PURE__ */ new Set();\n  const finishHydrationListeners = /* @__PURE__ */ new Set();\n  let storage = options.storage;\n  if (!storage) {\n    return config(\n      (...args) => {\n        console.warn(\n          `[zustand persist middleware] Unable to update item '${options.name}', the given storage is currently unavailable.`\n        );\n        set(...args);\n      },\n      get,\n      api\n    );\n  }\n  const setItem = () => {\n    const state = options.partialize({ ...get() });\n    return storage.setItem(options.name, {\n      state,\n      version: options.version\n    });\n  };\n  const savedSetState = api.setState;\n  api.setState = (state, replace) => {\n    savedSetState(state, replace);\n    void setItem();\n  };\n  const configResult = config(\n    (...args) => {\n      set(...args);\n      void setItem();\n    },\n    get,\n    api\n  );\n  api.getInitialState = () => configResult;\n  let stateFromStorage;\n  const hydrate = () => {\n    var _a, _b;\n    if (!storage) return;\n    hasHydrated = false;\n    hydrationListeners.forEach((cb) => {\n      var _a2;\n      return cb((_a2 = get()) != null ? _a2 : configResult);\n    });\n    const postRehydrationCallback = ((_b = options.onRehydrateStorage) == null ? void 0 : _b.call(options, (_a = get()) != null ? _a : configResult)) || void 0;\n    return toThenable(storage.getItem.bind(storage))(options.name).then((deserializedStorageValue) => {\n      if (deserializedStorageValue) {\n        if (typeof deserializedStorageValue.version === \"number\" && deserializedStorageValue.version !== options.version) {\n          if (options.migrate) {\n            return [\n              true,\n              options.migrate(\n                deserializedStorageValue.state,\n                deserializedStorageValue.version\n              )\n            ];\n          }\n          console.error(\n            `State loaded from storage couldn't be migrated since no migrate function was provided`\n          );\n        } else {\n          return [false, deserializedStorageValue.state];\n        }\n      }\n      return [false, void 0];\n    }).then((migrationResult) => {\n      var _a2;\n      const [migrated, migratedState] = migrationResult;\n      stateFromStorage = options.merge(\n        migratedState,\n        (_a2 = get()) != null ? _a2 : configResult\n      );\n      set(stateFromStorage, true);\n      if (migrated) {\n        return setItem();\n      }\n    }).then(() => {\n      postRehydrationCallback == null ? void 0 : postRehydrationCallback(stateFromStorage, void 0);\n      stateFromStorage = get();\n      hasHydrated = true;\n      finishHydrationListeners.forEach((cb) => cb(stateFromStorage));\n    }).catch((e) => {\n      postRehydrationCallback == null ? void 0 : postRehydrationCallback(void 0, e);\n    });\n  };\n  api.persist = {\n    setOptions: (newOptions) => {\n      options = {\n        ...options,\n        ...newOptions\n      };\n      if (newOptions.storage) {\n        storage = newOptions.storage;\n      }\n    },\n    clearStorage: () => {\n      storage == null ? void 0 : storage.removeItem(options.name);\n    },\n    getOptions: () => options,\n    rehydrate: () => hydrate(),\n    hasHydrated: () => hasHydrated,\n    onHydrate: (cb) => {\n      hydrationListeners.add(cb);\n      return () => {\n        hydrationListeners.delete(cb);\n      };\n    },\n    onFinishHydration: (cb) => {\n      finishHydrationListeners.add(cb);\n      return () => {\n        finishHydrationListeners.delete(cb);\n      };\n    }\n  };\n  if (!options.skipHydration) {\n    hydrate();\n  }\n  return stateFromStorage || configResult;\n};\nconst persistImpl = (config, baseOptions) => {\n  if (\"getStorage\" in baseOptions || \"serialize\" in baseOptions || \"deserialize\" in baseOptions) {\n    if ((import.meta.env ? import.meta.env.MODE : void 0) !== \"production\") {\n      console.warn(\n        \"[DEPRECATED] `getStorage`, `serialize` and `deserialize` options are deprecated. Use `storage` option instead.\"\n      );\n    }\n    return oldImpl(config, baseOptions);\n  }\n  return newImpl(config, baseOptions);\n};\nconst persist = persistImpl;\n\nexport { combine, createJSONStorage, devtools, persist, redux, subscribeWithSelector };\n","import { create } from \"zustand\";\r\nimport { persist, createJSONStorage } from \"zustand/middleware\";\r\nimport type { Homography, Point } from \"../utils/vision\";\r\n\r\ntype CalibrationState = {\r\n  H: Homography | null; // board->image\r\n  createdAt: number | null;\r\n  errorPx: number | null;\r\n  imageSize: { w: number; h: number } | null;\r\n  // The visual overlay size (in pixels) used when calibration was locked.\r\n  // If present, we preserve this display size for drawing overlays so it \"sticks\".\r\n  overlaySize: { w: number; h: number } | null;\r\n  anchors: { src: Point[]; dst: Point[] } | null;\r\n  locked: boolean;\r\n  _hydrated: boolean; // Track hydration state\r\n  setCalibration: (\r\n    c: Partial<\r\n      Omit<CalibrationState, \"setCalibration\" | \"reset\" | \"_hydrated\">\r\n    >,\r\n  ) => void;\r\n  reset: () => void;\r\n};\r\n\r\nexport const useCalibration = create<CalibrationState>()(\r\n  persist(\r\n    (set, get) => ({\r\n      H: null,\r\n      createdAt: null,\r\n      errorPx: null,\r\n      imageSize: null,\r\n        overlaySize: null,\r\n      anchors: null,\r\n      locked: false,\r\n      _hydrated: false,\r\n      setCalibration: (c) => set((s) => ({ ...s, ...c })),\r\n      reset: () =>\r\n        set({\r\n          H: null,\r\n          createdAt: null,\r\n          errorPx: null,\r\n          imageSize: null,\r\n          overlaySize: null,\r\n          anchors: null,\r\n          locked: false,\r\n        }),\r\n    }),\r\n    {\r\n      name: \"ndn-calibration-v1\",\r\n      storage: createJSONStorage(() => localStorage),\r\n      // If we ever had alternate keys (legacy), gently import once after hydration\r\n      onRehydrateStorage: () => (state, error) => {\r\n        // No-op on error; best-effort fallback\r\n        if (error || !state) return;\r\n        try {\r\n          if (state && !state.H) {\r\n            const legacy = localStorage.getItem(\"ndn:calibration:v1\");\r\n            if (legacy) {\r\n              const j = JSON.parse(legacy);\r\n              if (j && (j.H || j.imageSize)) {\r\n                state.setCalibration({\r\n                  H: j.H ?? null,\r\n                  createdAt: j.createdAt ?? null,\r\n                  errorPx: j.errorPx ?? null,\r\n                  imageSize: j.imageSize ?? null,\r\n                  overlaySize: j.overlaySize ?? null,\r\n                  anchors: j.anchors ?? null,\r\n                  locked: !!j.locked,\r\n                });\r\n              }\r\n            }\r\n          }\r\n          // Mark as hydrated\r\n          state._hydrated = true;\r\n        } catch {}\r\n      },\r\n    },\r\n  ),\r\n);\r\n","export const isDev = ((import.meta as any).env?.DEV || false) as boolean;\r\nexport function dlog(...args: any[]) {\r\n  if (isDev) console.debug(...args);\r\n}\r\nexport function dinfo(...args: any[]) {\r\n  if (isDev) console.info(...args);\r\n}\r\nexport function dwarn(...args: any[]) {\r\n  if (isDev) console.warn(...args);\r\n}\r\nexport function derror(...args: any[]) {\r\n  if (isDev) console.error(...args);\r\n}\r\n","import { create } from \"zustand\";\r\nimport { dlog } from \"../utils/logger\";\r\nimport { persist, createJSONStorage } from \"zustand/middleware\";\r\n\r\nexport type CameraStreamMode = \"local\" | \"phone\" | \"wifi\";\r\n\r\n// CRITICAL: All non-serializable objects kept OUTSIDE state to avoid React #185 error\r\n// These must NOT be in Zustand state, even though we set them there momentarily\r\nlet videoElementRefHolder: HTMLVideoElement | null = null;\r\nlet mediaStreamRefHolder: MediaStream | null = null;\r\nlet pcRefHolder: RTCPeerConnection | null = null;\r\nlet wsRefHolder: WebSocket | null = null;\r\n\r\ntype CameraSessionState = {\r\n  // Stream state - persists across navigation (ONLY serializable data)\r\n  isStreaming: boolean;\r\n  mode: CameraStreamMode;\r\n  pairingCode: string | null;\r\n  expiresAt: number | null;\r\n  isPaired: boolean;\r\n  mobileUrl: string | null;\r\n  // UI: whether the floating phone overlay is visible\r\n  showOverlay: boolean;\r\n\r\n  // Actions\r\n  setStreaming: (streaming: boolean) => void;\r\n  setMode: (mode: CameraStreamMode) => void;\r\n  setPairingCode: (code: string | null) => void;\r\n  setExpiresAt: (time: number | null) => void;\r\n  setPaired: (paired: boolean) => void;\r\n  setMobileUrl: (url: string | null) => void;\r\n  setShowOverlay: (v: boolean) => void;\r\n\r\n  // Methods for managing non-serializable refs (not in state)\r\n  setMediaStream: (stream: MediaStream | null) => void;\r\n  getMediaStream: () => MediaStream | null;\r\n  setPcRef: (pc: RTCPeerConnection | null) => void;\r\n  getPcRef: () => RTCPeerConnection | null;\r\n  setWsRef: (ws: WebSocket | null) => void;\r\n  getWsRef: () => WebSocket | null;\r\n\r\n  // Get video element ref (not stored in state to avoid serialization)\r\n  getVideoElementRef: () => HTMLVideoElement | null;\r\n  setVideoElementRef: (ref: HTMLVideoElement | null) => void;\r\n\r\n  // Clear session when user stops camera\r\n  clearSession: () => void;\r\n};\r\n\r\nexport const useCameraSession = create<CameraSessionState>()(\r\n  persist(\r\n    (set, get) => ({\r\n      isStreaming: false,\r\n      mode: \"local\",\r\n      pairingCode: null,\r\n      expiresAt: null,\r\n      isPaired: false,\r\n      mobileUrl: null,\r\n      showOverlay: true,\r\n\r\n      setStreaming: (streaming) => {\r\n        dlog(\"[CAMERA_SESSION] setStreaming:\", streaming);\r\n        set({ isStreaming: streaming });\r\n      },\r\n      setMode: (mode) => {\r\n        dlog(\"[CAMERA_SESSION] setMode:\", mode);\r\n        set({ mode });\r\n      },\r\n      setPairingCode: (code) => set({ pairingCode: code }),\r\n      setExpiresAt: (time) => set({ expiresAt: time }),\r\n      setPaired: (paired) => set({ isPaired: paired }),\r\n      setMobileUrl: (url) => set({ mobileUrl: url }),\r\n      setShowOverlay: (v) => set({ showOverlay: !!v }),\r\n\r\n      // Non-serializable refs stored outside state\r\n      setMediaStream: (stream) => {\r\n        mediaStreamRefHolder = stream;\r\n      },\r\n      getMediaStream: () => mediaStreamRefHolder,\r\n\r\n      setPcRef: (pc) => {\r\n        pcRefHolder = pc;\r\n      },\r\n      getPcRef: () => pcRefHolder,\r\n\r\n      setWsRef: (ws) => {\r\n        wsRefHolder = ws;\r\n      },\r\n      getWsRef: () => wsRefHolder,\r\n\r\n      // Keep video element ref outside of state to avoid serialization issues\r\n      getVideoElementRef: () => {\r\n        const ref = videoElementRefHolder;\r\n        if (!ref) {\r\n          dlog(\"[cameraSession]  getVideoElementRef called but ref is NULL\");\r\n        }\r\n        return ref;\r\n      },\r\n      setVideoElementRef: (ref) => {\r\n        if (ref) {\r\n          dlog(\r\n            \"[cameraSession]  setVideoElementRef called - storing HTMLVideoElement\",\r\n            {\r\n              tagName: ref.tagName,\r\n              hasStream: !!ref.srcObject,\r\n            },\r\n          );\r\n        } else {\r\n          dlog(\"[cameraSession]  setVideoElementRef called - clearing ref\");\r\n        }\r\n        videoElementRefHolder = ref;\r\n      },\r\n\r\n      clearSession: () => {\r\n        videoElementRefHolder = null;\r\n        mediaStreamRefHolder = null;\r\n        pcRefHolder = null;\r\n        wsRefHolder = null;\r\n        set({\r\n          isStreaming: false,\r\n          pairingCode: null,\r\n          expiresAt: null,\r\n          isPaired: false,\r\n          mobileUrl: null,\r\n          // Keep overlay state; do not forcibly hide on clear so user choice persists\r\n        });\r\n      },\r\n    }),\r\n    {\r\n      name: \"ndn-camera-session\",\r\n      storage: createJSONStorage(() => localStorage),\r\n      // ONLY persist serializable primitives\r\n      partialize: (state) => ({\r\n        isStreaming: state.isStreaming,\r\n        mode: state.mode,\r\n        pairingCode: state.pairingCode,\r\n        expiresAt: state.expiresAt,\r\n        isPaired: state.isPaired,\r\n        mobileUrl: state.mobileUrl,\r\n        showOverlay: state.showOverlay,\r\n      }),\r\n    },\r\n  ),\r\n);\r\n","// Vision and calibration utilities for dartboard mapping\r\n// Standard dartboard: 18 inches (457.2 mm) outer diameter\r\n// Board dimensions follow standard measurements (millimeters)\r\n// - Inner bull radius: 6.35 mm (12.7 mm diameter)\r\n// - Outer bull radius: 15.9 mm (31.8 mm diameter)\r\n// - Treble inner radius: 99 mm\r\n// - Treble outer radius: 107 mm\r\n// - Double inner radius: 162 mm\r\n// - Double outer radius: 170 mm (playing field outer edge = 340 mm diameter)\r\n\r\nexport type Point = { x: number; y: number };\r\nexport type Homography = [\r\n  number,\r\n  number,\r\n  number,\r\n  number,\r\n  number,\r\n  number,\r\n  number,\r\n  number,\r\n  number,\r\n]; // row-major 3x3\r\n\r\nexport const BoardRadii = {\r\n  bullInner: 6.35,\r\n  bullOuter: 15.9,\r\n  trebleInner: 99,\r\n  trebleOuter: 107,\r\n  doubleInner: 162,\r\n  doubleOuter: 170,\r\n};\r\n\r\nexport const SectorOrder = [\r\n  20, 1, 18, 4, 13, 6, 10, 15, 2, 17, 3, 19, 7, 16, 8, 11, 14, 9, 12, 5,\r\n];\r\n\r\n// Basic 3x3 matrix operations\r\nfunction matMul3(a: Homography, b: Homography): Homography {\r\n  const r = new Array(9).fill(0);\r\n  for (let i = 0; i < 3; i++) {\r\n    for (let j = 0; j < 3; j++) {\r\n      for (let k = 0; k < 3; k++) {\r\n        r[i * 3 + j] += a[i * 3 + k] * b[k * 3 + j];\r\n      }\r\n    }\r\n  }\r\n  return r as Homography;\r\n}\r\n\r\nexport function applyHomography(H: Homography, p: Point): Point {\r\n  const x = p.x,\r\n    y = p.y;\r\n  const w = H[6] * x + H[7] * y + H[8];\r\n  const nx = (H[0] * x + H[1] * y + H[2]) / w;\r\n  const ny = (H[3] * x + H[4] * y + H[5]) / w;\r\n  return { x: nx, y: ny };\r\n}\r\n\r\n// Scale a homography by sx, sy on the destination/image side: H' = S * H\r\n// Where S = diag([sx, sy, 1])\r\nexport function scaleHomography(\r\n  H: Homography,\r\n  sx: number,\r\n  sy: number,\r\n): Homography {\r\n  return [\r\n    sx * H[0],\r\n    sx * H[1],\r\n    sx * H[2],\r\n    sy * H[3],\r\n    sy * H[4],\r\n    sy * H[5],\r\n    H[6],\r\n    H[7],\r\n    H[8],\r\n  ] as Homography;\r\n}\r\n\r\nexport function invertHomography(H: Homography): Homography {\r\n  // Inverse of 3x3 matrix\r\n  const m = H;\r\n  const a = m[0],\r\n    b = m[1],\r\n    c = m[2],\r\n    d = m[3],\r\n    e = m[4],\r\n    f = m[5],\r\n    g = m[6],\r\n    h = m[7],\r\n    i = m[8];\r\n  const A = e * i - f * h;\r\n  const B = c * h - b * i;\r\n  const C = b * f - c * e;\r\n  const D = f * g - d * i;\r\n  const E = a * i - c * g;\r\n  const F = c * d - a * f;\r\n  const G = d * h - e * g;\r\n  const Hh = b * g - a * h;\r\n  const I = a * e - b * d;\r\n  const det = a * A + b * D + c * G;\r\n  if (Math.abs(det) < 1e-12) throw new Error(\"Singular homography\");\r\n  const inv = [\r\n    A / det,\r\n    B / det,\r\n    C / det,\r\n    D / det,\r\n    E / det,\r\n    F / det,\r\n    G / det,\r\n    Hh / det,\r\n    I / det,\r\n  ] as Homography;\r\n  return inv;\r\n}\r\n\r\n// Compute homography H that maps src (board space) -> dst (image space)\r\n// Using N correspondences via DLT (solved by Gaussian elimination) with least-squares fit\r\n// Supports overdetermined systems (N > 4) for improved accuracy\r\nexport function computeHomographyDLT(src: Point[], dst: Point[]): Homography {\r\n  if (src.length < 4 || dst.length < 4)\r\n    throw new Error(\"Need at least 4 correspondences\");\r\n  if (src.length !== dst.length)\r\n    throw new Error(\"Correspondences must have equal length\");\r\n  // Build A * h = b where h = [h11 h12 h13 h21 h22 h23 h31 h32]^T and h33 = 1\r\n  const A: number[][] = [];\r\n  const B: number[] = [];\r\n  for (let k = 0; k < src.length; k++) {\r\n    const { x: X, y: Y } = src[k];\r\n    const { x: x, y: y } = dst[k];\r\n    // x = (h11 X + h12 Y + h13) / (h31 X + h32 Y + 1)\r\n    // y = (h21 X + h22 Y + h23) / (h31 X + h32 Y + 1)\r\n    // => x*(h31 X + h32 Y + 1) = h11 X + h12 Y + h13\r\n    // => y*(h31 X + h32 Y + 1) = h21 X + h22 Y + h23\r\n    A.push([X, Y, 1, 0, 0, 0, -x * X, -x * Y]);\r\n    B.push(x);\r\n    A.push([0, 0, 0, X, Y, 1, -y * X, -y * Y]);\r\n    B.push(y);\r\n  }\r\n  const h = solveLeastSquares(A, B); // length 8\r\n  const H: Homography = [h[0], h[1], h[2], h[3], h[4], h[5], h[6], h[7], 1];\r\n  return H;\r\n}\r\n\r\n// Solve A x = b in least squares sense using Gaussian elimination with partial pivoting\r\nfunction solveLeastSquares(A: number[][], b: number[]): number[] {\r\n  // Normal equations: (A^T A) x = A^T b\r\n  const m = A.length,\r\n    n = A[0].length;\r\n  const AtA: number[][] = Array.from({ length: n }, () => new Array(n).fill(0));\r\n  const Atb: number[] = new Array(n).fill(0);\r\n  for (let r = 0; r < m; r++) {\r\n    for (let i = 0; i < n; i++) {\r\n      Atb[i] += A[r][i] * b[r];\r\n      for (let j = 0; j < n; j++) {\r\n        AtA[i][j] += A[r][i] * A[r][j];\r\n      }\r\n    }\r\n  }\r\n  return gaussianSolve(AtA, Atb);\r\n}\r\n\r\nfunction gaussianSolve(M: number[][], v: number[]): number[] {\r\n  const n = v.length;\r\n  // Augment matrix\r\n  const A = M.map((row, i) => row.concat([v[i]]));\r\n  for (let i = 0; i < n; i++) {\r\n    // Pivot\r\n    let maxRow = i;\r\n    for (let r = i + 1; r < n; r++) {\r\n      if (Math.abs(A[r][i]) > Math.abs(A[maxRow][i])) maxRow = r;\r\n    }\r\n    if (Math.abs(A[maxRow][i]) < 1e-12) throw new Error(\"Singular matrix\");\r\n    if (maxRow !== i) {\r\n      const tmp = A[i];\r\n      A[i] = A[maxRow];\r\n      A[maxRow] = tmp;\r\n    }\r\n    // Eliminate\r\n    for (let r = i + 1; r < n; r++) {\r\n      const f = A[r][i] / A[i][i];\r\n      for (let c = i; c <= n; c++) A[r][c] -= f * A[i][c];\r\n    }\r\n  }\r\n  // Back substitution\r\n  const x = new Array(n).fill(0);\r\n  for (let i = n - 1; i >= 0; i--) {\r\n    let s = A[i][n];\r\n    for (let c = i + 1; c < n; c++) s -= A[i][c] * x[c];\r\n    x[i] = s / A[i][i];\r\n  }\r\n  return x;\r\n}\r\n\r\n// Canonical calibration targets in board space (mm)\r\n// We now anchor the homography with four evenly spaced double-ring sectors:\r\n// D20 (top), D6 (right), D3 (bottom), and D11 (left).\r\nexport function canonicalRimTargets(): Point[] {\r\n  const doubleR = BoardRadii.doubleOuter;\r\n  const targetSectors = [20, 6, 3, 11] as const;\r\n  return targetSectors.map((sector) => {\r\n    const idx = SectorOrder.indexOf(sector);\r\n    const angle = (idx / SectorOrder.length) * Math.PI * 2 - Math.PI / 2;\r\n    const x = doubleR * Math.cos(angle);\r\n    const y = doubleR * Math.sin(angle);\r\n    return {\r\n      x: Math.abs(x) < 1e-9 ? 0 : x,\r\n      y: Math.abs(y) < 1e-9 ? 0 : y,\r\n    };\r\n  });\r\n}\r\n\r\n// Given a homography mapping board->image, produce polylines for overlay rings (in image px)\r\nexport function sampleRing(\r\n  H: Homography,\r\n  radius: number,\r\n  steps = 256,\r\n): Point[] {\r\n  const pts: Point[] = [];\r\n  for (let k = 0; k < steps; k++) {\r\n    const theta = (k / steps) * Math.PI * 2;\r\n    const p = applyHomography(H, {\r\n      x: radius * Math.cos(theta),\r\n      y: radius * Math.sin(theta),\r\n    });\r\n    pts.push(p);\r\n  }\r\n  return pts;\r\n}\r\n\r\nexport function rmsError(H: Homography, src: Point[], dst: Point[]): number {\r\n  let e2 = 0;\r\n  for (let i = 0; i < src.length; i++) {\r\n    const p = applyHomography(H, src[i]);\r\n    const dx = p.x - dst[i].x;\r\n    const dy = p.y - dst[i].y;\r\n    e2 += dx * dx + dy * dy;\r\n  }\r\n  return Math.sqrt(e2 / src.length);\r\n}\r\n\r\n// Map an image point to board coordinates using inverse homography (image->board)\r\nexport function imageToBoard(H_boardToImage: Homography, pImg: Point): Point {\r\n  const inv = invertHomography(H_boardToImage);\r\n  return applyHomography(inv as Homography, pImg);\r\n}\r\n\r\n// Compute score for a board coordinate (mm)\r\nexport function scoreAtBoardPoint(p: Point): {\r\n  base: number;\r\n  ring: \"MISS\" | \"SINGLE\" | \"DOUBLE\" | \"TRIPLE\" | \"BULL\" | \"INNER_BULL\";\r\n  sector: number | null;\r\n  mult: 0 | 1 | 2 | 3;\r\n} {\r\n  const r = Math.hypot(p.x, p.y);\r\n  const ang = Math.atan2(p.y, p.x); // 0 rad at +X, increasing CCW\r\n  // Rotate so that sector 20 is at the top (negative Y). Top corresponds to -90 degrees (or 270)\r\n  let deg = (ang * 180) / Math.PI;\r\n  deg = (deg + 360 + 90) % 360; // shift so 0 deg is at top\r\n  const sector = SectorOrder[Math.floor(deg / 18)]; // deg now ranges 0..360 with 0 at top (clockwise ordering using array)\r\n\r\n  if (r <= BoardRadii.bullInner)\r\n    return { base: 50, ring: \"INNER_BULL\", sector: 25, mult: 2 };\r\n  if (r <= BoardRadii.bullOuter)\r\n    return { base: 25, ring: \"BULL\", sector: 25, mult: 1 };\r\n  if (r >= BoardRadii.doubleOuter)\r\n    return { base: 0, ring: \"MISS\", sector: null, mult: 0 };\r\n  if (r >= BoardRadii.doubleInner)\r\n    return { base: sector * 2, ring: \"DOUBLE\", sector, mult: 2 };\r\n  if (r >= BoardRadii.trebleOuter)\r\n    return { base: sector, ring: \"SINGLE\", sector, mult: 1 };\r\n  if (r >= BoardRadii.trebleInner)\r\n    return { base: sector * 3, ring: \"TRIPLE\", sector, mult: 3 };\r\n  return { base: sector, ring: \"SINGLE\", sector, mult: 1 };\r\n}\r\n\r\nexport function drawPolyline(\r\n  ctx: CanvasRenderingContext2D,\r\n  pts: Point[],\r\n  color = \"#10b981\",\r\n  width = 2,\r\n) {\r\n  if (!pts.length) return;\r\n  ctx.save();\r\n  ctx.strokeStyle = color;\r\n  ctx.lineWidth = width;\r\n  ctx.beginPath();\r\n  ctx.moveTo(pts[0].x, pts[0].y);\r\n  for (let i = 1; i < pts.length; i++) ctx.lineTo(pts[i].x, pts[i].y);\r\n  ctx.closePath();\r\n  ctx.stroke();\r\n  ctx.restore();\r\n}\r\n\r\nexport function drawCross(\r\n  ctx: CanvasRenderingContext2D,\r\n  p: Point,\r\n  color = \"#f59e0b\",\r\n) {\r\n  ctx.save();\r\n  ctx.strokeStyle = color;\r\n  ctx.lineWidth = 2;\r\n  ctx.beginPath();\r\n  ctx.moveTo(p.x - 8, p.y);\r\n  ctx.lineTo(p.x + 8, p.y);\r\n  ctx.moveTo(p.x, p.y - 8);\r\n  ctx.lineTo(p.x, p.y + 8);\r\n  ctx.stroke();\r\n  ctx.restore();\r\n}\r\n\r\n// --- Point refinement using Sobel gradient ---\r\nfunction clamp(v: number, lo: number, hi: number) {\r\n  return Math.max(lo, Math.min(hi, v));\r\n}\r\n\r\nfunction sobelAtGray(img: ImageData, x: number, y: number): number {\r\n  const { width, data } = img;\r\n  // Sobel kernels\r\n  const gx = [\r\n    [-1, 0, 1],\r\n    [-2, 0, 2],\r\n    [-1, 0, 1],\r\n  ];\r\n  const gy = [\r\n    [-1, -2, -1],\r\n    [0, 0, 0],\r\n    [1, 2, 1],\r\n  ];\r\n  let sx = 0,\r\n    sy = 0;\r\n  for (let j = -1; j <= 1; j++) {\r\n    for (let i = -1; i <= 1; i++) {\r\n      const xi = clamp(x + i, 0, width - 1);\r\n      const yi = clamp(y + j, 0, img.height - 1);\r\n      const idx = (yi * width + xi) * 4;\r\n      const r = data[idx],\r\n        g = data[idx + 1],\r\n        b = data[idx + 2];\r\n      const gray = 0.299 * r + 0.587 * g + 0.114 * b;\r\n      sx += gray * gx[j + 1][i + 1];\r\n      sy += gray * gy[j + 1][i + 1];\r\n    }\r\n  }\r\n  return Math.hypot(sx, sy);\r\n}\r\n\r\nexport function refinePointSobel(\r\n  canvas: HTMLCanvasElement,\r\n  p: Point,\r\n  radius = 6,\r\n): Point {\r\n  const ctx = canvas.getContext(\"2d\")!;\r\n  const img = ctx.getImageData(0, 0, canvas.width, canvas.height);\r\n  const cx = clamp(Math.round(p.x), 1, canvas.width - 2);\r\n  const cy = clamp(Math.round(p.y), 1, canvas.height - 2);\r\n  let best = { x: cx, y: cy, mag: -1 };\r\n  for (let y = cy - radius; y <= cy + radius; y++) {\r\n    for (let x = cx - radius; x <= cx + radius; x++) {\r\n      if (x <= 0 || y <= 0 || x >= canvas.width - 1 || y >= canvas.height - 1)\r\n        continue;\r\n      const mag = sobelAtGray(img, x, y);\r\n      if (mag > best.mag) best = { x, y, mag };\r\n    }\r\n  }\r\n  return { x: best.x, y: best.y };\r\n}\r\n\r\nexport function refinePointsSobel(\r\n  canvas: HTMLCanvasElement,\r\n  pts: Point[],\r\n  radius = 6,\r\n): Point[] {\r\n  return pts.map((p) => refinePointSobel(canvas, p, radius));\r\n}\r\n","/*\nCopyright (c) 2011 Juan Mellado\n\nPermission is hereby granted, free of charge, to any person obtaining a copy\nof this software and associated documentation files (the \"Software\"), to deal\nin the Software without restriction, including without limitation the rights\nto use, copy, modify, merge, publish, distribute, sublicense, and/or sell\ncopies of the Software, and to permit persons to whom the Software is\nfurnished to do so, subject to the following conditions:\n\nThe above copyright notice and this permission notice shall be included in\nall copies or substantial portions of the Software.\n\nTHE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\nIMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\nFITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\nAUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\nLIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\nOUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\nTHE SOFTWARE.\n*/\n\n/*\nReferences:\n- \"OpenCV: Open Computer Vision Library\"\n  http://sourceforge.net/projects/opencvlibrary/\n- \"Stack Blur: Fast But Goodlooking\"\n  http://incubator.quasimondo.com/processing/fast_blur_deluxe.php\n*/\n\nvar CV = CV || {};\n\nCV.Image = function(width, height, data){\n  this.width = width || 0;\n  this.height = height || 0;\n  this.data = data || [];\n};\n\nCV.grayscale = function(imageSrc, imageDst){\n  var src = imageSrc.data, dst = imageDst.data, len = src.length,\n      i = 0, j = 0;\n\n  for (; i < len; i += 4){\n    dst[j ++] =\n      (src[i] * 0.299 + src[i + 1] * 0.587 + src[i + 2] * 0.114 + 0.5) & 0xff;\n  }\n  \n  imageDst.width = imageSrc.width;\n  imageDst.height = imageSrc.height;\n  \n  return imageDst;\n};\n\nCV.threshold = function(imageSrc, imageDst, threshold){\n  var src = imageSrc.data, dst = imageDst.data,\n      len = src.length, tab = [], i;\n\n  for (i = 0; i < 256; ++ i){\n    tab[i] = i <= threshold? 0: 255;\n  }\n\n  for (i = 0; i < len; ++ i){\n    dst[i] = tab[ src[i] ];\n  }\n\n  imageDst.width = imageSrc.width;\n  imageDst.height = imageSrc.height;\n\n  return imageDst;\n};\n\nCV.adaptiveThreshold = function(imageSrc, imageDst, kernelSize, threshold){\n  var src = imageSrc.data, dst = imageDst.data, len = src.length, tab = [], i;\n\n  CV.stackBoxBlur(imageSrc, imageDst, kernelSize);\n\n  for (i = 0; i < 768; ++ i){\n    tab[i] = (i - 255 <= -threshold)? 255: 0;\n  }\n\n  for (i = 0; i < len; ++ i){\n    dst[i] = tab[ src[i] - dst[i] + 255 ];\n  }\n\n  imageDst.width = imageSrc.width;\n  imageDst.height = imageSrc.height;\n  \n  return imageDst;\n};\n\nCV.otsu = function(imageSrc){\n  var src = imageSrc.data, len = src.length, hist = [],\n      threshold = 0, sum = 0, sumB = 0, wB = 0, wF = 0, max = 0,\n      mu, between, i;\n\n  for (i = 0; i < 256; ++ i){\n    hist[i] = 0;\n  }\n  \n  for (i = 0; i < len; ++ i){\n    hist[ src[i] ] ++;\n  }\n\n  for (i = 0; i < 256; ++ i){\n    sum += hist[i] * i;\n  }\n\n  for (i = 0; i < 256; ++ i){\n    wB += hist[i];\n    if (0 !== wB){\n    \n      wF = len - wB;\n      if (0 === wF){\n        break;\n      }\n\n      sumB += hist[i] * i;\n      \n      mu = (sumB / wB) - ( (sum - sumB) / wF );\n\n      between = wB * wF * mu * mu;\n      \n      if (between > max){\n        max = between;\n        threshold = i;\n      }\n    }\n  }\n\n  return threshold;\n};\n\nCV.stackBoxBlurMult =\n  [1, 171, 205, 293, 57, 373, 79, 137, 241, 27, 391, 357, 41, 19, 283, 265];\n\nCV.stackBoxBlurShift =\n  [0, 9, 10, 11, 9, 12, 10, 11, 12, 9, 13, 13, 10, 9, 13, 13];\n\nCV.BlurStack = function(){\n  this.color = 0;\n  this.next = null;\n};\n\nCV.stackBoxBlur = function(imageSrc, imageDst, kernelSize){\n  var src = imageSrc.data, dst = imageDst.data,\n      height = imageSrc.height, width = imageSrc.width,\n      heightMinus1 = height - 1, widthMinus1 = width - 1,\n      size = kernelSize + kernelSize + 1, radius = kernelSize + 1,\n      mult = CV.stackBoxBlurMult[kernelSize],\n      shift = CV.stackBoxBlurShift[kernelSize],\n      stack, stackStart, color, sum, pos, start, p, x, y, i;\n\n  stack = stackStart = new CV.BlurStack();\n  for (i = 1; i < size; ++ i){\n    stack = stack.next = new CV.BlurStack();\n  }\n  stack.next = stackStart;\n\n  pos = 0;\n\n  for (y = 0; y < height; ++ y){\n    start = pos;\n    \n    color = src[pos];\n    sum = radius * color;\n    \n    stack = stackStart;\n    for (i = 0; i < radius; ++ i){\n      stack.color = color;\n      stack = stack.next;\n    }\n    for (i = 1; i < radius; ++ i){\n      stack.color = src[pos + i];\n      sum += stack.color;\n      stack = stack.next;\n    }\n  \n    stack = stackStart;\n    for (x = 0; x < width; ++ x){\n      dst[pos ++] = (sum * mult) >>> shift;\n      \n      p = x + radius;\n      p = start + (p < widthMinus1? p: widthMinus1);\n      sum -= stack.color - src[p];\n      \n      stack.color = src[p];\n      stack = stack.next;\n    }\n  }\n\n  for (x = 0; x < width; ++ x){\n    pos = x;\n    start = pos + width;\n    \n    color = dst[pos];\n    sum = radius * color;\n    \n    stack = stackStart;\n    for (i = 0; i < radius; ++ i){\n      stack.color = color;\n      stack = stack.next;\n    }\n    for (i = 1; i < radius; ++ i){\n      stack.color = dst[start];\n      sum += stack.color;\n      stack = stack.next;\n      \n      start += width;\n    }\n    \n    stack = stackStart;\n    for (y = 0; y < height; ++ y){\n      dst[pos] = (sum * mult) >>> shift;\n      \n      p = y + radius;\n      p = x + ( (p < heightMinus1? p: heightMinus1) * width );\n      sum -= stack.color - dst[p];\n      \n      stack.color = dst[p];\n      stack = stack.next;\n      \n      pos += width;\n    }\n  }\n\n  return imageDst;\n};\n\nCV.gaussianBlur = function(imageSrc, imageDst, imageMean, kernelSize){\n  var kernel = CV.gaussianKernel(kernelSize);\n\n  imageDst.width = imageSrc.width;\n  imageDst.height = imageSrc.height;\n  \n  imageMean.width = imageSrc.width;\n  imageMean.height = imageSrc.height;\n\n  CV.gaussianBlurFilter(imageSrc, imageMean, kernel, true);\n  CV.gaussianBlurFilter(imageMean, imageDst, kernel, false);\n\n  return imageDst;\n};\n\nCV.gaussianBlurFilter = function(imageSrc, imageDst, kernel, horizontal){\n  var src = imageSrc.data, dst = imageDst.data,\n      height = imageSrc.height, width = imageSrc.width,\n      pos = 0, limit = kernel.length >> 1,\n      cur, value, i, j, k;\n      \n  for (i = 0; i < height; ++ i){\n    \n    for (j = 0; j < width; ++ j){\n      value = 0.0;\n    \n      for (k = -limit; k <= limit; ++ k){\n\n        if (horizontal){\n          cur = pos + k;\n          if (j + k < 0){\n            cur = pos;\n          }\n          else if (j + k >= width){\n            cur = pos;\n          }\n        }else{\n          cur = pos + (k * width);\n          if (i + k < 0){\n            cur = pos;\n          }\n          else if (i + k >= height){\n            cur = pos;\n          }\n        }\n\n        value += kernel[limit + k] * src[cur];\n      }\n    \n      dst[pos ++] = horizontal? value: (value + 0.5) & 0xff;\n    }\n  }\n\n  return imageDst;\n};\n\nCV.gaussianKernel = function(kernelSize){\n  var tab =\n    [ [1],\n      [0.25, 0.5, 0.25],\n      [0.0625, 0.25, 0.375, 0.25, 0.0625],\n      [0.03125, 0.109375, 0.21875, 0.28125, 0.21875, 0.109375, 0.03125] ],\n    kernel = [], center, sigma, scale2X, sum, x, i;\n\n  if ( (kernelSize <= 7) && (kernelSize % 2 === 1) ){\n    kernel = tab[kernelSize >> 1];\n  }else{\n    center = (kernelSize - 1.0) * 0.5;\n    sigma = 0.8 + (0.3 * (center - 1.0) );\n    scale2X = -0.5 / (sigma * sigma);\n    sum = 0.0;\n    for (i = 0; i < kernelSize; ++ i){\n      x = i - center;\n      sum += kernel[i] = Math.exp(scale2X * x * x);\n    }\n    sum = 1 / sum;\n    for (i = 0; i < kernelSize; ++ i){\n      kernel[i] *= sum;\n    }  \n  }\n\n  return kernel;\n};\n\nCV.findContours = function(imageSrc, binary){\n  var width = imageSrc.width, height = imageSrc.height, contours = [],\n      src, deltas, pos, pix, nbd, outer, hole, i, j;\n  \n  src = CV.binaryBorder(imageSrc, binary);\n\n  deltas = CV.neighborhoodDeltas(width + 2);\n\n  pos = width + 3;\n  nbd = 1;\n\n  for (i = 0; i < height; ++ i, pos += 2){\n  \n    for (j = 0; j < width; ++ j, ++ pos){\n      pix = src[pos];\n\n      if (0 !== pix){\n        outer = hole = false;\n\n        if (1 === pix && 0 === src[pos - 1]){\n          outer = true;\n        }\n        else if (pix >= 1 && 0 === src[pos + 1]){\n          hole = true;\n        }\n\n        if (outer || hole){\n          ++ nbd;\n          \n          contours.push( CV.borderFollowing(src, pos, nbd, {x: j, y: i}, hole, deltas) );\n        }\n      }\n    }\n  }  \n\n  return contours;\n};\n\nCV.borderFollowing = function(src, pos, nbd, point, hole, deltas){\n  var contour = [], pos1, pos3, pos4, s, s_end, s_prev;\n\n  contour.hole = hole;\n      \n  s = s_end = hole? 0: 4;\n  do{\n    s = (s - 1) & 7;\n    pos1 = pos + deltas[s];\n    if (src[pos1] !== 0){\n      break;\n    }\n  }while(s !== s_end);\n  \n  if (s === s_end){\n    src[pos] = -nbd;\n    contour.push( {x: point.x, y: point.y} );\n\n  }else{\n    pos3 = pos;\n    s_prev = s ^ 4;\n\n    while(true){\n      s_end = s;\n    \n      do{\n        pos4 = pos3 + deltas[++ s];\n      }while(src[pos4] === 0);\n      \n      s &= 7;\n      \n      if ( ( (s - 1) >>> 0) < (s_end >>> 0) ){\n        src[pos3] = -nbd;\n      }\n      else if (src[pos3] === 1){\n        src[pos3] = nbd;\n      }\n\n      contour.push( {x: point.x, y: point.y} );\n      \n      s_prev = s;\n\n      point.x += CV.neighborhood[s][0];\n      point.y += CV.neighborhood[s][1];\n\n      if ( (pos4 === pos) && (pos3 === pos1) ){\n        break;\n      }\n      \n      pos3 = pos4;\n      s = (s + 4) & 7;\n    }\n  }\n\n  return contour;\n};\n\nCV.neighborhood = \n  [ [1, 0], [1, -1], [0, -1], [-1, -1], [-1, 0], [-1, 1], [0, 1], [1, 1] ];\n\nCV.neighborhoodDeltas = function(width){\n  var deltas = [], len = CV.neighborhood.length, i = 0;\n  \n  for (; i < len; ++ i){\n    deltas[i] = CV.neighborhood[i][0] + (CV.neighborhood[i][1] * width);\n  }\n  \n  return deltas.concat(deltas);\n};\n\nCV.approxPolyDP = function(contour, epsilon){\n  var slice = {start_index: 0, end_index: 0},\n      right_slice = {start_index: 0, end_index: 0},\n      poly = [], stack = [], len = contour.length,\n      pt, start_pt, end_pt, dist, max_dist, le_eps,\n      dx, dy, i, j, k;\n  \n  epsilon *= epsilon;\n  \n  k = 0;\n  \n  for (i = 0; i < 3; ++ i){\n    max_dist = 0;\n    \n    k = (k + right_slice.start_index) % len;\n    start_pt = contour[k];\n    if (++ k === len) {k = 0;}\n  \n    for (j = 1; j < len; ++ j){\n      pt = contour[k];\n      if (++ k === len) {k = 0;}\n    \n      dx = pt.x - start_pt.x;\n      dy = pt.y - start_pt.y;\n      dist = dx * dx + dy * dy;\n\n      if (dist > max_dist){\n        max_dist = dist;\n        right_slice.start_index = j;\n      }\n    }\n  }\n\n  if (max_dist <= epsilon){\n    poly.push( {x: start_pt.x, y: start_pt.y} );\n\n  }else{\n    slice.start_index = k;\n    slice.end_index = (right_slice.start_index += slice.start_index);\n  \n    right_slice.start_index -= right_slice.start_index >= len? len: 0;\n    right_slice.end_index = slice.start_index;\n    if (right_slice.end_index < right_slice.start_index){\n      right_slice.end_index += len;\n    }\n    \n    stack.push( {start_index: right_slice.start_index, end_index: right_slice.end_index} );\n    stack.push( {start_index: slice.start_index, end_index: slice.end_index} );\n  }\n\n  while(stack.length !== 0){\n    slice = stack.pop();\n    \n    end_pt = contour[slice.end_index % len];\n    start_pt = contour[k = slice.start_index % len];\n    if (++ k === len) {k = 0;}\n    \n    if (slice.end_index <= slice.start_index + 1){\n      le_eps = true;\n    \n    }else{\n      max_dist = 0;\n\n      dx = end_pt.x - start_pt.x;\n      dy = end_pt.y - start_pt.y;\n      \n      for (i = slice.start_index + 1; i < slice.end_index; ++ i){\n        pt = contour[k];\n        if (++ k === len) {k = 0;}\n        \n        dist = Math.abs( (pt.y - start_pt.y) * dx - (pt.x - start_pt.x) * dy);\n\n        if (dist > max_dist){\n          max_dist = dist;\n          right_slice.start_index = i;\n        }\n      }\n      \n      le_eps = max_dist * max_dist <= epsilon * (dx * dx + dy * dy);\n    }\n    \n    if (le_eps){\n      poly.push( {x: start_pt.x, y: start_pt.y} );\n\n    }else{\n      right_slice.end_index = slice.end_index;\n      slice.end_index = right_slice.start_index;\n\n      stack.push( {start_index: right_slice.start_index, end_index: right_slice.end_index} );\n      stack.push( {start_index: slice.start_index, end_index: slice.end_index} );\n    }\n  }\n  \n  return poly;\n};\n\nCV.warp = function(imageSrc, imageDst, contour, warpSize){\n  var src = imageSrc.data, dst = imageDst.data,\n      width = imageSrc.width, height = imageSrc.height,\n      pos = 0,\n      sx1, sx2, dx1, dx2, sy1, sy2, dy1, dy2, p1, p2, p3, p4,\n      m, r, s, t, u, v, w, x, y, i, j;\n  \n  m = CV.getPerspectiveTransform(contour, warpSize - 1);\n\n  r = m[8];\n  s = m[2];\n  t = m[5];\n  \n  for (i = 0; i < warpSize; ++ i){\n    r += m[7];\n    s += m[1];\n    t += m[4];\n\n    u = r;\n    v = s;\n    w = t;\n    \n    for (j = 0; j < warpSize; ++ j){\n      u += m[6];\n      v += m[0];\n      w += m[3];\n\n      x = v / u;\n      y = w / u;\n\n      sx1 = x >>> 0;\n      sx2 = (sx1 === width - 1)? sx1: sx1 + 1;\n      dx1 = x - sx1;\n      dx2 = 1.0 - dx1;\n\n      sy1 = y >>> 0;\n      sy2 = (sy1 === height - 1)? sy1: sy1 + 1;\n      dy1 = y - sy1;\n      dy2 = 1.0 - dy1;\n\n      p1 = p2 = sy1 * width;\n      p3 = p4 = sy2 * width;\n\n      dst[pos ++] = \n        (dy2 * (dx2 * src[p1 + sx1] + dx1 * src[p2 + sx2]) +\n         dy1 * (dx2 * src[p3 + sx1] + dx1 * src[p4 + sx2]) ) & 0xff;\n\n    }\n  }\n\n  imageDst.width = warpSize;\n  imageDst.height = warpSize;\n\n  return imageDst;\n};\n\nCV.getPerspectiveTransform = function(src, size){\n  var rq = CV.square2quad(src);\n  \n  rq[0] /= size;\n  rq[1] /= size;\n  rq[3] /= size;\n  rq[4] /= size;\n  rq[6] /= size;\n  rq[7] /= size;\n  \n  return rq;\n};\n\nCV.square2quad = function(src){\n  var sq = [], px, py, dx1, dx2, dy1, dy2, den;\n  \n  px = src[0].x - src[1].x + src[2].x - src[3].x;\n  py = src[0].y - src[1].y + src[2].y - src[3].y;\n  \n  if (0 === px && 0 === py){\n    sq[0] = src[1].x - src[0].x;\n    sq[1] = src[2].x - src[1].x;\n    sq[2] = src[0].x;\n    sq[3] = src[1].y - src[0].y;\n    sq[4] = src[2].y - src[1].y;\n    sq[5] = src[0].y;\n    sq[6] = 0;\n    sq[7] = 0;\n    sq[8] = 1;\n\n  }else{\n    dx1 = src[1].x - src[2].x;\n    dx2 = src[3].x - src[2].x;\n    dy1 = src[1].y - src[2].y;\n    dy2 = src[3].y - src[2].y;\n    den = dx1 * dy2 - dx2 * dy1;\n  \n    sq[6] = (px * dy2 - dx2 * py) / den;\n    sq[7] = (dx1 * py - px * dy1) / den;\n    sq[8] = 1;\n    sq[0] = src[1].x - src[0].x + sq[6] * src[1].x;\n    sq[1] = src[3].x - src[0].x + sq[7] * src[3].x;\n    sq[2] = src[0].x;\n    sq[3] = src[1].y - src[0].y + sq[6] * src[1].y;\n    sq[4] = src[3].y - src[0].y + sq[7] * src[3].y;\n    sq[5] = src[0].y;\n  }\n\n  return sq;\n};\n\nCV.isContourConvex = function(contour){\n  var orientation = 0, convex = true,\n      len = contour.length, i = 0, j = 0,\n      cur_pt, prev_pt, dxdy0, dydx0, dx0, dy0, dx, dy;\n\n  prev_pt = contour[len - 1];\n  cur_pt = contour[0];\n\n  dx0 = cur_pt.x - prev_pt.x;\n  dy0 = cur_pt.y - prev_pt.y;\n\n  for (; i < len; ++ i){\n    if (++ j === len) {j = 0;}\n\n    prev_pt = cur_pt;\n    cur_pt = contour[j];\n\n    dx = cur_pt.x - prev_pt.x;\n    dy = cur_pt.y - prev_pt.y;\n    dxdy0 = dx * dy0;\n    dydx0 = dy * dx0;\n\n    orientation |= dydx0 > dxdy0? 1: (dydx0 < dxdy0? 2: 3);\n\n    if (3 === orientation){\n        convex = false;\n        break;\n    }\n\n    dx0 = dx;\n    dy0 = dy;\n  }\n\n  return convex;\n};\n\nCV.perimeter = function(poly){\n  var len = poly.length, i = 0, j = len - 1,\n      p = 0.0, dx, dy;\n\n  for (; i < len; j = i ++){\n    dx = poly[i].x - poly[j].x;\n    dy = poly[i].y - poly[j].y;\n    \n    p += Math.sqrt(dx * dx + dy * dy) ;\n  }\n\n  return p;\n};\n\nCV.minEdgeLength = function(poly){\n  var len = poly.length, i = 0, j = len - 1, \n      min = Infinity, d, dx, dy;\n\n  for (; i < len; j = i ++){\n    dx = poly[i].x - poly[j].x;\n    dy = poly[i].y - poly[j].y;\n\n    d = dx * dx + dy * dy;\n\n    if (d < min){\n      min = d;\n    }\n  }\n  \n  return Math.sqrt(min);\n};\n\nCV.countNonZero = function(imageSrc, square){\n  var src = imageSrc.data, height = square.height, width = square.width,\n      pos = square.x + (square.y * imageSrc.width),\n      span = imageSrc.width - width,\n      nz = 0, i, j;\n  \n  for (i = 0; i < height; ++ i){\n\n    for (j = 0; j < width; ++ j){\n    \n      if ( 0 !== src[pos ++] ){\n        ++ nz;\n      }\n    }\n    \n    pos += span;\n  }\n\n  return nz;\n};\n\nCV.binaryBorder = function(imageSrc, dst){\n  var src = imageSrc.data, height = imageSrc.height, width = imageSrc.width,\n      posSrc = 0, posDst = 0, i, j;\n\n  for (j = -2; j < width; ++ j){\n    dst[posDst ++] = 0;\n  }\n\n  for (i = 0; i < height; ++ i){\n    dst[posDst ++] = 0;\n    \n    for (j = 0; j < width; ++ j){\n      dst[posDst ++] = (0 === src[posSrc ++]? 0: 1);\n    }\n    \n    dst[posDst ++] = 0;\n  }\n\n  for (j = -2; j < width; ++ j){\n    dst[posDst ++] = 0;\n  }\n  \n  return dst;\n};\n\nmodule.exports = CV;","/*\nCopyright (c) 2011 Juan Mellado\n\nPermission is hereby granted, free of charge, to any person obtaining a copy\nof this software and associated documentation files (the \"Software\"), to deal\nin the Software without restriction, including without limitation the rights\nto use, copy, modify, merge, publish, distribute, sublicense, and/or sell\ncopies of the Software, and to permit persons to whom the Software is\nfurnished to do so, subject to the following conditions:\n\nThe above copyright notice and this permission notice shall be included in\nall copies or substantial portions of the Software.\n\nTHE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\nIMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\nFITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\nAUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\nLIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\nOUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\nTHE SOFTWARE.\n*/\n\n/*\nReferences:\n- \"ArUco: a minimal library for Augmented Reality applications based on OpenCv\"\n  http://www.uco.es/investiga/grupos/ava/node/26\n*/\n\nvar CV = require('./cv');\n\nvar AR = AR || {};\n\nAR.Marker = function(id, corners){\n  this.id = id;\n  this.corners = corners;\n};\n\nAR.Detector = function(){\n  this.grey = new CV.Image();\n  this.thres = new CV.Image();\n  this.homography = new CV.Image();\n  this.binary = [];\n  this.contours = [];\n  this.polys = [];\n  this.candidates = [];\n};\n\nAR.Detector.prototype.detect = function(image){\n  CV.grayscale(image, this.grey);\n  CV.adaptiveThreshold(this.grey, this.thres, 2, 7);\n  \n  this.contours = CV.findContours(this.thres, this.binary);\n\n  this.candidates = this.findCandidates(this.contours, image.width * 0.20, 0.05, 10);\n  this.candidates = this.clockwiseCorners(this.candidates);\n  this.candidates = this.notTooNear(this.candidates, 10);\n\n  return this.findMarkers(this.grey, this.candidates, 49);\n};\n\nAR.Detector.prototype.findCandidates = function(contours, minSize, epsilon, minLength){\n  var candidates = [], len = contours.length, contour, poly, i;\n\n  this.polys = [];\n  \n  for (i = 0; i < len; ++ i){\n    contour = contours[i];\n\n    if (contour.length >= minSize){\n      poly = CV.approxPolyDP(contour, contour.length * epsilon);\n\n      this.polys.push(poly);\n\n      if ( (4 === poly.length) && ( CV.isContourConvex(poly) ) ){\n\n        if ( CV.minEdgeLength(poly) >= minLength){\n          candidates.push(poly);\n        }\n      }\n    }\n  }\n\n  return candidates;\n};\n\nAR.Detector.prototype.clockwiseCorners = function(candidates){\n  var len = candidates.length, dx1, dx2, dy1, dy2, swap, i;\n\n  for (i = 0; i < len; ++ i){\n    dx1 = candidates[i][1].x - candidates[i][0].x;\n    dy1 = candidates[i][1].y - candidates[i][0].y;\n    dx2 = candidates[i][2].x - candidates[i][0].x;\n    dy2 = candidates[i][2].y - candidates[i][0].y;\n\n    if ( (dx1 * dy2 - dy1 * dx2) < 0){\n      swap = candidates[i][1];\n      candidates[i][1] = candidates[i][3];\n      candidates[i][3] = swap;\n    }\n  }\n\n  return candidates;\n};\n\nAR.Detector.prototype.notTooNear = function(candidates, minDist){\n  var notTooNear = [], len = candidates.length, dist, dx, dy, i, j, k;\n\n  for (i = 0; i < len; ++ i){\n  \n    for (j = i + 1; j < len; ++ j){\n      dist = 0;\n      \n      for (k = 0; k < 4; ++ k){\n        dx = candidates[i][k].x - candidates[j][k].x;\n        dy = candidates[i][k].y - candidates[j][k].y;\n      \n        dist += dx * dx + dy * dy;\n      }\n      \n      if ( (dist / 4) < (minDist * minDist) ){\n      \n        if ( CV.perimeter( candidates[i] ) < CV.perimeter( candidates[j] ) ){\n          candidates[i].tooNear = true;\n        }else{\n          candidates[j].tooNear = true;\n        }\n      }\n    }\n  }\n\n  for (i = 0; i < len; ++ i){\n    if ( !candidates[i].tooNear ){\n      notTooNear.push( candidates[i] );\n    }\n  }\n\n  return notTooNear;\n};\n\nAR.Detector.prototype.findMarkers = function(imageSrc, candidates, warpSize){\n  var markers = [], len = candidates.length, candidate, marker, i;\n\n  for (i = 0; i < len; ++ i){\n    candidate = candidates[i];\n\n    CV.warp(imageSrc, this.homography, candidate, warpSize);\n  \n    CV.threshold(this.homography, this.homography, CV.otsu(this.homography) );\n\n    marker = this.getMarker(this.homography, candidate);\n    if (marker){\n      markers.push(marker);\n    }\n  }\n  \n  return markers;\n};\n\nAR.Detector.prototype.getMarker = function(imageSrc, candidate){\n  var width = (imageSrc.width / 7) >>> 0,\n      minZero = (width * width) >> 1,\n      bits = [], rotations = [], distances = [],\n      square, pair, inc, i, j;\n\n  for (i = 0; i < 7; ++ i){\n    inc = (0 === i || 6 === i)? 1: 6;\n    \n    for (j = 0; j < 7; j += inc){\n      square = {x: j * width, y: i * width, width: width, height: width};\n      if ( CV.countNonZero(imageSrc, square) > minZero){\n        return null;\n      }\n    }\n  }\n\n  for (i = 0; i < 5; ++ i){\n    bits[i] = [];\n\n    for (j = 0; j < 5; ++ j){\n      square = {x: (j + 1) * width, y: (i + 1) * width, width: width, height: width};\n      \n      bits[i][j] = CV.countNonZero(imageSrc, square) > minZero? 1: 0;\n    }\n  }\n\n  rotations[0] = bits;\n  distances[0] = this.hammingDistance( rotations[0] );\n  \n  pair = {first: distances[0], second: 0};\n  \n  for (i = 1; i < 4; ++ i){\n    rotations[i] = this.rotate( rotations[i - 1] );\n    distances[i] = this.hammingDistance( rotations[i] );\n    \n    if (distances[i] < pair.first){\n      pair.first = distances[i];\n      pair.second = i;\n    }\n  }\n\n  if (0 !== pair.first){\n    return null;\n  }\n\n  return new AR.Marker(\n    this.mat2id( rotations[pair.second] ), \n    this.rotate2(candidate, 4 - pair.second) );\n};\n\nAR.Detector.prototype.hammingDistance = function(bits){\n  var ids = [ [1,0,0,0,0], [1,0,1,1,1], [0,1,0,0,1], [0,1,1,1,0] ],\n      dist = 0, sum, minSum, i, j, k;\n\n  for (i = 0; i < 5; ++ i){\n    minSum = Infinity;\n    \n    for (j = 0; j < 4; ++ j){\n      sum = 0;\n\n      for (k = 0; k < 5; ++ k){\n          sum += bits[i][k] === ids[j][k]? 0: 1;\n      }\n\n      if (sum < minSum){\n        minSum = sum;\n      }\n    }\n\n    dist += minSum;\n  }\n\n  return dist;\n};\n\nAR.Detector.prototype.mat2id = function(bits){\n  var id = 0, i;\n  \n  for (i = 0; i < 5; ++ i){\n    id <<= 1;\n    id |= bits[i][1];\n    id <<= 1;\n    id |= bits[i][3];\n  }\n\n  return id;\n};\n\nAR.Detector.prototype.rotate = function(src){\n  var dst = [], len = src.length, i, j;\n  \n  for (i = 0; i < len; ++ i){\n    dst[i] = [];\n    for (j = 0; j < src[i].length; ++ j){\n      dst[i][j] = src[src[i].length - j - 1][i];\n    }\n  }\n\n  return dst;\n};\n\nAR.Detector.prototype.rotate2 = function(src, rotation){\n  var dst = [], len = src.length, i;\n  \n  for (i = 0; i < len; ++ i){\n    dst[i] = src[ (rotation + i) % len ];\n  }\n\n  return dst;\n};\n\nmodule.exports = AR;","/*\r\nCopyright (c) 2012 Juan Mellado\r\n\r\nPermission is hereby granted, free of charge, to any person obtaining a copy\r\nof this software and associated documentation files (the \"Software\"), to deal\r\nin the Software without restriction, including without limitation the rights\r\nto use, copy, modify, merge, publish, distribute, sublicense, and/or sell\r\ncopies of the Software, and to permit persons to whom the Software is\r\nfurnished to do so, subject to the following conditions:\r\n\r\nThe above copyright notice and this permission notice shall be included in\r\nall copies or substantial portions of the Software.\r\n\r\nTHE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\r\nIMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\r\nFITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\r\nAUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\r\nLIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\r\nOUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\r\nTHE SOFTWARE.\r\n*/\r\n\r\n/*\r\nReferences:\r\n- \"Numerical Recipes in C - Second Edition\"\r\n  http://www.nr.com/\r\n*/\r\n\r\nvar SVD = SVD || {};\r\n\r\nSVD.svdcmp = function(a, m, n, w, v){\r\n  var flag, i, its, j, jj, k, l, nm,\r\n      anorm = 0.0, c, f, g = 0.0, h, s, scale = 0.0, x, y, z, rv1 = [];\r\n      \r\n  //Householder reduction to bidiagonal form\r\n  for (i = 0; i < n; ++ i){\r\n    l = i + 1;\r\n    rv1[i] = scale * g;\r\n    g = s = scale = 0.0;\r\n    if (i < m){\r\n      for (k = i; k < m; ++ k){\r\n        scale += Math.abs( a[k][i] );\r\n      }\r\n      if (0.0 !== scale){\r\n        for (k = i; k < m; ++ k){\r\n          a[k][i] /= scale;\r\n          s += a[k][i] * a[k][i];\r\n        }\r\n        f = a[i][i];\r\n        g = -SVD.sign( Math.sqrt(s), f );\r\n        h = f * g - s;\r\n        a[i][i] = f - g;\r\n        for (j = l; j < n; ++ j){\r\n          for (s = 0.0, k = i; k < m; ++ k){\r\n            s += a[k][i] * a[k][j];\r\n          }\r\n          f = s / h;\r\n          for (k = i; k < m; ++ k){\r\n            a[k][j] += f * a[k][i];\r\n          }\r\n        }\r\n        for (k = i; k < m; ++ k){\r\n          a[k][i] *= scale;\r\n        }\r\n      }\r\n    }\r\n    w[i] = scale * g;\r\n    g = s = scale = 0.0;\r\n    if ( (i < m) && (i !== n - 1) ){\r\n      for (k = l; k < n; ++ k){\r\n        scale += Math.abs( a[i][k] );\r\n      }\r\n      if (0.0 !== scale){\r\n        for (k = l; k < n; ++ k){\r\n          a[i][k] /= scale;\r\n          s += a[i][k] * a[i][k];\r\n        }\r\n        f = a[i][l];\r\n        g = -SVD.sign( Math.sqrt(s), f );\r\n        h = f * g - s;\r\n        a[i][l] = f - g;\r\n        for (k = l; k < n; ++ k){\r\n          rv1[k] = a[i][k] / h;\r\n        }\r\n        for (j = l; j < m; ++ j){\r\n          for (s = 0.0, k = l; k < n; ++ k){\r\n            s += a[j][k] * a[i][k];\r\n          }\r\n          for (k = l; k < n; ++ k){\r\n            a[j][k] += s * rv1[k];\r\n          }\r\n        }\r\n        for (k = l; k < n; ++ k){\r\n          a[i][k] *= scale;\r\n        }\r\n      }\r\n    }\r\n    anorm = Math.max(anorm, ( Math.abs( w[i] ) + Math.abs( rv1[i] ) ) );\r\n  }\r\n\r\n  //Acumulation of right-hand transformation\r\n  for (i = n - 1; i >= 0; -- i){\r\n    if (i < n - 1){\r\n      if (0.0 !== g){\r\n        for (j = l; j < n; ++ j){\r\n          v[j][i] = ( a[i][j] / a[i][l] ) / g;\r\n        }\r\n        for (j = l; j < n; ++ j){\r\n          for (s = 0.0, k = l; k < n; ++ k){\r\n            s += a[i][k] * v[k][j];\r\n          }\r\n          for (k = l; k < n; ++ k){\r\n            v[k][j] += s * v[k][i];\r\n          }\r\n        }\r\n      }\r\n      for (j = l; j < n; ++ j){\r\n        v[i][j] = v[j][i] = 0.0;\r\n      }\r\n    }\r\n    v[i][i] = 1.0;\r\n    g = rv1[i];\r\n    l = i;\r\n  }\r\n\r\n  //Acumulation of left-hand transformation\r\n  for (i = Math.min(n, m) - 1; i >= 0; -- i){\r\n    l = i + 1;\r\n    g = w[i];\r\n    for (j = l; j < n; ++ j){\r\n      a[i][j] = 0.0;\r\n    }\r\n    if (0.0 !== g){\r\n      g = 1.0 / g;\r\n      for (j = l; j < n; ++ j){\r\n        for (s = 0.0, k = l; k < m; ++ k){\r\n          s += a[k][i] * a[k][j];\r\n        }\r\n        f = (s / a[i][i]) * g;\r\n        for (k = i; k < m; ++ k){\r\n          a[k][j] += f * a[k][i];\r\n        }\r\n      }\r\n      for (j = i; j < m; ++ j){\r\n        a[j][i] *= g;\r\n      }\r\n    }else{\r\n        for (j = i; j < m; ++ j){\r\n          a[j][i] = 0.0;\r\n        }\r\n    }\r\n    ++ a[i][i];\r\n  }\r\n\r\n  //Diagonalization of the bidiagonal form\r\n  for (k = n - 1; k >= 0; -- k){\r\n    for (its = 1; its <= 30; ++ its){\r\n      flag = true;\r\n      for (l = k; l >= 0; -- l){\r\n        nm = l - 1;\r\n        if ( Math.abs( rv1[l] ) + anorm === anorm ){\r\n          flag = false;\r\n          break;\r\n        }\r\n        if ( Math.abs( w[nm] ) + anorm === anorm ){\r\n          break;\r\n        }\r\n      }\r\n      if (flag){\r\n        c = 0.0;\r\n        s = 1.0;\r\n        for (i = l; i <= k; ++ i){\r\n          f = s * rv1[i];\r\n          if ( Math.abs(f) + anorm === anorm ){\r\n            break;\r\n          }\r\n          g = w[i];\r\n          h = SVD.pythag(f, g);\r\n          w[i] = h;\r\n          h = 1.0 / h;\r\n          c = g * h;\r\n          s = -f * h;\r\n          for (j = 1; j <= m; ++ j){\r\n            y = a[j][nm];\r\n            z = a[j][i];\r\n            a[j][nm] = y * c + z * s;\r\n            a[j][i] = z * c - y * s;\r\n          }\r\n        }\r\n      }\r\n\r\n      //Convergence\r\n      z = w[k];\r\n      if (l === k){\r\n        if (z < 0.0){\r\n          w[k] = -z;\r\n          for (j = 0; j < n; ++ j){\r\n            v[j][k] = -v[j][k];\r\n          }\r\n        }\r\n        break;\r\n      }\r\n\r\n      if (30 === its){\r\n        return false;\r\n      }\r\n\r\n      //Shift from bottom 2-by-2 minor\r\n      x = w[l];\r\n      nm = k - 1;\r\n      y = w[nm];\r\n      g = rv1[nm];\r\n      h = rv1[k];\r\n      f = ( (y - z) * (y + z) + (g - h) * (g + h) ) / (2.0 * h * y);\r\n      g = SVD.pythag( f, 1.0 );\r\n      f = ( (x - z) * (x + z) + h * ( (y / (f + SVD.sign(g, f) ) ) - h) ) / x;\r\n\r\n      //Next QR transformation\r\n      c = s = 1.0;\r\n      for (j = l; j <= nm; ++ j){\r\n        i = j + 1;\r\n        g = rv1[i];\r\n        y = w[i];\r\n        h = s * g;\r\n        g = c * g;\r\n        z = SVD.pythag(f, h);\r\n        rv1[j] = z;\r\n        c = f / z;\r\n        s = h / z;\r\n        f = x * c + g * s;\r\n        g = g * c - x * s;\r\n        h = y * s;\r\n        y *= c;\r\n        for (jj = 0; jj < n; ++ jj){\r\n          x = v[jj][j];\r\n          z = v[jj][i];\r\n          v[jj][j] = x * c + z * s;\r\n          v[jj][i] = z * c - x * s;\r\n        }\r\n        z = SVD.pythag(f, h);\r\n        w[j] = z;\r\n        if (0.0 !== z){\r\n          z = 1.0 / z;\r\n          c = f * z;\r\n          s = h * z;\r\n        }\r\n        f = c * g + s * y;\r\n        x = c * y - s * g;\r\n        for (jj = 0; jj < m; ++ jj){\r\n          y = a[jj][j];\r\n          z = a[jj][i];\r\n          a[jj][j] = y * c + z * s;\r\n          a[jj][i] = z * c - y * s;\r\n        }\r\n      }\r\n      rv1[l] = 0.0;\r\n      rv1[k] = f;\r\n      w[k] = x;\r\n    }\r\n  }\r\n\r\n  return true;\r\n};\r\n\r\nSVD.pythag = function(a, b){\r\n  var at = Math.abs(a), bt = Math.abs(b), ct;\r\n\r\n  if (at > bt){\r\n    ct = bt / at;\r\n    return at * Math.sqrt(1.0 + ct * ct);\r\n  }\r\n    \r\n  if (0.0 === bt){\r\n    return 0.0;\r\n  }\r\n\r\n  ct = at / bt;\r\n  return bt * Math.sqrt(1.0 + ct * ct);\r\n};\r\n\r\nSVD.sign = function(a, b){\r\n  return b >= 0.0? Math.abs(a): -Math.abs(a);\r\n};\r\n\r\nmodule.exports = SVD;","/*\r\nCopyright (c) 2012 Juan Mellado\r\n\r\nPermission is hereby granted, free of charge, to any person obtaining a copy\r\nof this software and associated documentation files (the \"Software\"), to deal\r\nin the Software without restriction, including without limitation the rights\r\nto use, copy, modify, merge, publish, distribute, sublicense, and/or sell\r\ncopies of the Software, and to permit persons to whom the Software is\r\nfurnished to do so, subject to the following conditions:\r\n\r\nThe above copyright notice and this permission notice shall be included in\r\nall copies or substantial portions of the Software.\r\n\r\nTHE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\r\nIMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\r\nFITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\r\nAUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\r\nLIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\r\nOUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\r\nTHE SOFTWARE.\r\n*/\r\n\r\n/*\r\nReferences:\r\n- \"Iterative Pose Estimation using Coplanar Feature Points\"\r\n  Denis Oberkampf, Daniel F. DeMenthon, Larry S. Davis\r\n  http://www.cfar.umd.edu/~daniel/daniel_papersfordownload/CoplanarPts.pdf\r\n*/\r\n\r\nvar SVD = require('./svd');\r\n\r\nvar POS = POS || {};\r\n\r\nPOS.Posit = function(modelSize, focalLength){\r\n  this.objectPoints = this.buildModel(modelSize);\r\n  this.focalLength = focalLength;\r\n\r\n  this.objectVectors = [];\r\n  this.objectNormal = [];\r\n  this.objectMatrix = [[],[],[]];\r\n  \r\n  this.init();\r\n};\r\n\r\nPOS.Posit.prototype.buildModel = function(modelSize){\r\n  var half = modelSize / 2.0;\r\n  \r\n  return [\r\n    [-half,  half, 0.0],\r\n    [ half,  half, 0.0],\r\n    [ half, -half, 0.0],\r\n    [-half, -half, 0.0] ];\r\n};\r\n\r\nPOS.Posit.prototype.init = function(){\r\n  var np = this.objectPoints.length,\r\n      vectors = [], n = [], len = 0.0, row = 2, i;\r\n  \r\n  for (i = 0; i < np; ++ i){\r\n    this.objectVectors[i] = [this.objectPoints[i][0] - this.objectPoints[0][0],\r\n                             this.objectPoints[i][1] - this.objectPoints[0][1],\r\n                             this.objectPoints[i][2] - this.objectPoints[0][2]];\r\n                             \r\n    vectors[i] = [this.objectVectors[i][0],\r\n                  this.objectVectors[i][1],\r\n                  this.objectVectors[i][2]];\r\n  }\r\n\r\n  while(0.0 === len){\r\n    n[0] = this.objectVectors[1][1] * this.objectVectors[row][2] -\r\n           this.objectVectors[1][2] * this.objectVectors[row][1];\r\n    n[1] = this.objectVectors[1][2] * this.objectVectors[row][0] -\r\n           this.objectVectors[1][0] * this.objectVectors[row][2];\r\n    n[2] = this.objectVectors[1][0] * this.objectVectors[row][1] -\r\n           this.objectVectors[1][1] * this.objectVectors[row][0];\r\n    \r\n    len = Math.sqrt(n[0] * n[0] + n[1] * n[1] + n[2] * n[2]);\r\n    \r\n    ++ row;\r\n  }\r\n\r\n  for (i = 0; i < 3; ++ i){\r\n    this.objectNormal[i] = n[i] / len;\r\n  }\r\n\r\n  POS.pseudoInverse(vectors, np, this.objectMatrix);\r\n};\r\n\r\nPOS.Posit.prototype.pose = function(imagePoints){\r\n  var posRotation1 = [[],[],[]], posRotation2 = [[],[],[]], posTranslation = [],\r\n      rotation1 = [[],[],[]], rotation2 = [[],[],[]], translation1 = [], translation2 = [],\r\n      error1, error2, valid1, valid2, i, j;\r\n\r\n  this.pos(imagePoints, posRotation1, posRotation2, posTranslation);\r\n\r\n  valid1 = this.isValid(posRotation1, posTranslation);\r\n  if (valid1){\r\n    error1 = this.iterate(imagePoints, posRotation1, posTranslation, rotation1, translation1);\r\n  }else{\r\n    error1 = {euclidean: -1.0, pixels: -1, maximum: -1.0};\r\n  }\r\n  \r\n  valid2 = this.isValid(posRotation2, posTranslation);\r\n  if (valid2){\r\n    error2 = this.iterate(imagePoints, posRotation2, posTranslation, rotation2, translation2);\r\n  }else{\r\n    error2 = {euclidean: -1.0, pixels: -1, maximum: -1.0};\r\n  }\r\n\r\n  for (i = 0; i < 3; ++ i){\r\n    for (j = 0; j < 3; ++ j){\r\n      if (valid1){\r\n        translation1[i] -= rotation1[i][j] * this.objectPoints[0][j];\r\n      }\r\n      if (valid2){\r\n        translation2[i] -= rotation2[i][j] * this.objectPoints[0][j];\r\n      }\r\n    }\r\n  }\r\n\r\n  return error1.euclidean < error2.euclidean?\r\n    new POS.Pose(error1.pixels, rotation1, translation1, error2.pixels, rotation2, translation2):\r\n    new POS.Pose(error2.pixels, rotation2, translation2, error1.pixels, rotation1, translation1);\r\n};\r\n\r\nPOS.Posit.prototype.pos = function(imagePoints, rotation1, rotation2, translation){\r\n  var np = this.objectPoints.length, imageVectors = [],\r\n      i0 = [], j0 = [], ivec = [], jvec = [], row1 = [], row2 = [], row3 = [],\r\n      i0i0, j0j0, i0j0, delta, q, lambda, mu, scale, i, j;\r\n\r\n  for (i = 0; i < np; ++ i){\r\n    imageVectors[i] = [imagePoints[i].x - imagePoints[0].x,\r\n                       imagePoints[i].y - imagePoints[0].y];\r\n  }\r\n\r\n  //i0 and j0\r\n  for (i = 0; i < 3; ++ i){\r\n    i0[i] = 0.0;\r\n    j0[i] = 0.0;\r\n    for (j = 0; j < np; ++ j){\r\n      i0[i] += this.objectMatrix[i][j] * imageVectors[j][0];\r\n      j0[i] += this.objectMatrix[i][j] * imageVectors[j][1];\r\n    }\r\n  }\r\n\r\n  i0i0 = i0[0] * i0[0] + i0[1] * i0[1] + i0[2] * i0[2];\r\n  j0j0 = j0[0] * j0[0] + j0[1] * j0[1] + j0[2] * j0[2];\r\n  i0j0 = i0[0] * j0[0] + i0[1] * j0[1] + i0[2] * j0[2];\r\n\r\n  //Lambda and mu\r\n  delta = (j0j0 - i0i0) * (j0j0 - i0i0) + 4.0 * (i0j0 * i0j0);\r\n  \r\n  if (j0j0 - i0i0 >= 0.0){\r\n    q = (j0j0 - i0i0 + Math.sqrt(delta) ) / 2.0;\r\n  }else{\r\n    q = (j0j0 - i0i0 - Math.sqrt(delta) ) / 2.0;\r\n  }\r\n  \r\n  if (q >= 0.0){\r\n    lambda = Math.sqrt(q);\r\n    if (0.0 === lambda){\r\n      mu = 0.0;\r\n    }else{\r\n      mu = -i0j0 / lambda;\r\n    }\r\n  }else{\r\n    lambda = Math.sqrt( -(i0j0 * i0j0) / q);\r\n    if (0.0 === lambda){\r\n      mu = Math.sqrt(i0i0 - j0j0);\r\n    }else{\r\n      mu = -i0j0 / lambda;\r\n    }\r\n  }\r\n\r\n  //First rotation\r\n  for (i = 0; i < 3; ++ i){\r\n    ivec[i] = i0[i] + lambda * this.objectNormal[i];\r\n    jvec[i] = j0[i] + mu * this.objectNormal[i];\r\n  }\r\n  \r\n  scale = Math.sqrt(ivec[0] * ivec[0] + ivec[1] * ivec[1] + ivec[2] * ivec[2]);\r\n  \r\n  for (i = 0; i < 3; ++ i){\r\n    row1[i] = ivec[i] / scale;\r\n    row2[i] = jvec[i] / scale;\r\n  }\r\n  \r\n  row3[0] = row1[1] * row2[2] - row1[2] * row2[1];\r\n  row3[1] = row1[2] * row2[0] - row1[0] * row2[2];\r\n  row3[2] = row1[0] * row2[1] - row1[1] * row2[0];\r\n\r\n  for (i = 0; i < 3; ++ i){\r\n    rotation1[0][i] = row1[i];\r\n    rotation1[1][i] = row2[i];\r\n    rotation1[2][i] = row3[i];\r\n  }\r\n\r\n  //Second rotation\r\n  for (i = 0; i < 3; ++ i){\r\n    ivec[i] = i0[i] - lambda * this.objectNormal[i];\r\n    jvec[i] = j0[i] - mu * this.objectNormal[i];\r\n  }\r\n  \r\n  for (i = 0; i < 3; ++ i){\r\n    row1[i] = ivec[i] / scale;\r\n    row2[i] = jvec[i] / scale;\r\n  }\r\n  \r\n  row3[0] = row1[1] * row2[2] - row1[2] * row2[1];\r\n  row3[1] = row1[2] * row2[0] - row1[0] * row2[2];\r\n  row3[2] = row1[0] * row2[1] - row1[1] * row2[0];\r\n  \r\n  for (i = 0; i < 3; ++ i){\r\n    rotation2[0][i] = row1[i];\r\n    rotation2[1][i] = row2[i];\r\n    rotation2[2][i] = row3[i];\r\n  }\r\n\r\n  //Translation\r\n  translation[0] = imagePoints[0].x / scale;\r\n  translation[1] = imagePoints[0].y / scale;\r\n  translation[2] = this.focalLength / scale;\r\n};\r\n\r\nPOS.Posit.prototype.isValid = function(rotation, translation){\r\n  var np = this.objectPoints.length, zmin = Infinity, i = 0, zi;\r\n\r\n  for (; i < np; ++ i){\r\n    zi = translation[2] +\r\n      (rotation[2][0] * this.objectVectors[i][0] +\r\n       rotation[2][1] * this.objectVectors[i][1] +\r\n       rotation[2][2] * this.objectVectors[i][2]);\r\n    if (zi < zmin){\r\n      zmin = zi;\r\n    }\r\n  }\r\n\r\n  return zmin >= 0.0;\r\n};\r\n\r\nPOS.Posit.prototype.iterate = function(imagePoints, posRotation, posTranslation, rotation, translation){\r\n  var np = this.objectPoints.length,\r\n      oldSopImagePoints = [], sopImagePoints = [],\r\n      rotation1 = [[],[],[]], rotation2 = [[],[],[]],\r\n      translation1 = [], translation2 = [],\r\n      converged = false, iteration = 0,\r\n      oldImageDifference, imageDifference, factor,\r\n      error, error1, error2, delta, i, j;\r\n\r\n  for (i = 0; i < np; ++ i){\r\n    oldSopImagePoints[i] = {x: imagePoints[i].x,\r\n                            y: imagePoints[i].y};\r\n  }\r\n  \r\n  for (i = 0; i < 3; ++ i){\r\n    for (j = 0; j < 3; ++ j){\r\n      rotation[i][j] = posRotation[i][j];\r\n    }\r\n    translation[i] = posTranslation[i];\r\n  }\r\n\r\n  for (i = 0; i < np; ++ i){\r\n    factor = 0.0;\r\n    for (j = 0; j < 3; ++ j){\r\n      factor += this.objectVectors[i][j] * rotation[2][j] / translation[2];\r\n    }\r\n    sopImagePoints[i] = {x: (1.0 + factor) * imagePoints[i].x,\r\n                         y: (1.0 + factor) * imagePoints[i].y};\r\n  }\r\n\r\n  imageDifference = 0.0;\r\n  \r\n  for (i = 0; i < np; ++ i){\r\n    imageDifference += Math.abs(sopImagePoints[i].x - oldSopImagePoints[i].x);\r\n    imageDifference += Math.abs(sopImagePoints[i].y - oldSopImagePoints[i].y);\r\n  }\r\n\r\n  for (i = 0; i < 3; ++ i){\r\n    translation1[i] = translation[i] -\r\n      (rotation[i][0] * this.objectPoints[0][0] +\r\n       rotation[i][1] * this.objectPoints[0][1] +\r\n       rotation[i][2] * this.objectPoints[0][2]);\r\n  }\r\n  \r\n  error = error1 = this.error(imagePoints, rotation, translation1);\r\n\r\n  //Convergence\r\n  converged = (0.0 === error1.pixels) || (imageDifference < 0.01);\r\n  \r\n  while( iteration ++ < 100 && !converged ){\r\n  \r\n    for (i = 0; i < np; ++ i){\r\n      oldSopImagePoints[i].x = sopImagePoints[i].x;\r\n      oldSopImagePoints[i].y = sopImagePoints[i].y;\r\n    }\r\n\r\n    this.pos(sopImagePoints, rotation1, rotation2, translation);\r\n\r\n    for (i = 0; i < 3; ++ i){\r\n      translation1[i] = translation[i] -\r\n        (rotation1[i][0] * this.objectPoints[0][0] +\r\n         rotation1[i][1] * this.objectPoints[0][1] +\r\n         rotation1[i][2] * this.objectPoints[0][2]);\r\n        \r\n      translation2[i] = translation[i] -\r\n        (rotation2[i][0] * this.objectPoints[0][0] +\r\n         rotation2[i][1] * this.objectPoints[0][1] +\r\n         rotation2[i][2] * this.objectPoints[0][2]);\r\n    }\r\n\r\n    error1 = this.error(imagePoints, rotation1, translation1);\r\n    error2 = this.error(imagePoints, rotation2, translation2);\r\n\r\n    if ( (error1.euclidean >= 0.0) && (error2.euclidean >= 0.0) ){\r\n      if (error2.euclidean < error1.euclidean){\r\n        error = error2;\r\n        for (i = 0; i < 3; ++ i){\r\n          for (j = 0; j < 3; ++ j){\r\n            rotation[i][j] = rotation2[i][j];\r\n          }\r\n        }\r\n      }else{\r\n        error = error1;\r\n        for (i = 0; i < 3; ++ i){\r\n          for (j = 0; j < 3; ++ j){\r\n            rotation[i][j] = rotation1[i][j];\r\n          }\r\n        }\r\n      }\r\n    }\r\n\r\n    if ( (error1.euclidean < 0.0) && (error2.euclidean >= 0.0) ){\r\n      error = error2;\r\n      for (i = 0; i < 3; ++ i){\r\n        for (j = 0; j < 3; ++ j){\r\n          rotation[i][j] = rotation2[i][j];\r\n        }\r\n      }\r\n    }\r\n    \r\n    if ( (error2.euclidean < 0.0) && (error1.euclidean >= 0.0) ){\r\n      error = error1;\r\n      for (i = 0; i < 3; ++ i){\r\n        for (j = 0; j < 3; ++ j){\r\n          rotation[i][j] = rotation1[i][j];\r\n        }\r\n      }\r\n    }\r\n\r\n    for (i = 0; i < np; ++ i){\r\n      factor = 0.0;\r\n      for (j = 0; j < 3; ++ j){\r\n        factor += this.objectVectors[i][j] * rotation[2][j] / translation[2];\r\n      }\r\n      sopImagePoints[i].x = (1.0 + factor) * imagePoints[i].x;\r\n      sopImagePoints[i].y = (1.0 + factor) * imagePoints[i].y;\r\n    }\r\n\r\n    oldImageDifference = imageDifference;\r\n    imageDifference = 0.0;\r\n    \r\n    for (i = 0; i < np; ++ i){\r\n      imageDifference += Math.abs(sopImagePoints[i].x - oldSopImagePoints[i].x);\r\n      imageDifference += Math.abs(sopImagePoints[i].y - oldSopImagePoints[i].y);\r\n    }\r\n\r\n    delta = Math.abs(imageDifference - oldImageDifference);\r\n\r\n    converged = (0.0 === error.pixels) || (delta < 0.01);\r\n  }\r\n  \r\n  return error;\r\n};\r\n\r\nPOS.Posit.prototype.error = function(imagePoints, rotation, translation){\r\n  var np = this.objectPoints.length,\r\n      move = [], projection = [], errorvec = [],\r\n      euclidean = 0.0, pixels = 0.0, maximum = 0.0,\r\n      i, j, k;\r\n\r\n  if ( !this.isValid(rotation, translation) ){\r\n    return {euclidean: -1.0, pixels: -1, maximum: -1.0};\r\n  }\r\n  \r\n  for (i = 0; i < np; ++ i){\r\n    move[i] = [];\r\n    for (j = 0; j < 3; ++ j){\r\n      move[i][j] = translation[j];\r\n    }\r\n  }\r\n  \r\n  for (i = 0; i < np; ++ i){\r\n    for (j = 0; j < 3; ++ j){\r\n      for (k = 0; k < 3; ++ k){\r\n        move[i][j] += rotation[j][k] * this.objectPoints[i][k];\r\n      }\r\n    }\r\n  }\r\n\r\n  for (i = 0; i < np; ++ i){\r\n    projection[i] = [];\r\n    for (j = 0; j < 2; ++ j){\r\n      projection[i][j] = this.focalLength * move[i][j] / move[i][2];\r\n    }\r\n  }\r\n  \r\n  for (i = 0; i < np; ++ i){\r\n    errorvec[i] = [projection[i][0] - imagePoints[i].x,\r\n                   projection[i][1] - imagePoints[i].y];\r\n  }\r\n\r\n  for (i = 0; i < np; ++ i){\r\n    euclidean += Math.sqrt(errorvec[i][0] * errorvec[i][0] +\r\n                           errorvec[i][1] * errorvec[i][1]);\r\n                       \r\n    pixels += Math.abs( Math.round(projection[i][0]) - Math.round(imagePoints[i].x) ) +\r\n              Math.abs( Math.round(projection[i][1]) - Math.round(imagePoints[i].y) );\r\n              \r\n    if (Math.abs(errorvec[i][0]) > maximum){\r\n      maximum = Math.abs(errorvec[i][0]);\r\n    }\r\n    if (Math.abs(errorvec[i][1]) > maximum){\r\n      maximum = Math.abs(errorvec[i][1]);\r\n    }\r\n  }\r\n\r\n  return {euclidean: euclidean / np, pixels: pixels, maximum: maximum};\r\n};\r\n\r\nPOS.pseudoInverse = function(a, n, b){\r\n  var w = [], v = [[],[],[]], s = [[],[],[]],\r\n      wmax = 0.0, cn = 0,\r\n      i, j, k;\r\n\r\n  SVD.svdcmp(a, n, 3, w, v);\r\n\r\n  for (i = 0; i < 3; ++ i){\r\n    if (w[i] > wmax){\r\n      wmax = w[i];\r\n    }\r\n  }\r\n\r\n  wmax *= 0.01;\r\n\r\n  for (i = 0; i < 3; ++ i){\r\n    if (w[i] < wmax){\r\n      w[i] = 0.0;\r\n    }\r\n  }\r\n\r\n  for (j = 0; j < 3; ++ j){\r\n    if (0.0 === w[j]){\r\n      ++ cn;\r\n      for (k = j; k < 2; ++ k){\r\n        for (i = 0; i < n; ++ i){\r\n          a[i][k] = a[i][k + 1];\r\n        }\r\n        for (i = 0; i < 3; ++ i){\r\n          v[i][k] = v[i][k + 1];\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  for (j = 0; j < 2; ++ j){\r\n    if (0.0 === w[j]){\r\n      w[j] = w[j + 1];\r\n    }\r\n  }\r\n\r\n  for (i = 0; i < 3; ++ i){\r\n    for (j = 0; j < 3 - cn; ++ j){\r\n      s[i][j] = v[i][j] / w[j];\r\n    }\r\n  }\r\n  \r\n  for (i = 0; i < 3; ++ i){\r\n    for (j = 0; j < n; ++ j){\r\n      b[i][j] = 0.0;\r\n      for (k = 0; k < 3 - cn; ++ k){\r\n        b[i][j] += s[i][k] * a[j][k];\r\n      }\r\n    }\r\n  }\r\n};\r\n\r\nPOS.Pose = function(error1, rotation1, translation1, error2, rotation2, translation2){\r\n  this.bestError = error1;\r\n  this.bestRotation = rotation1;\r\n  this.bestTranslation = translation1;\r\n  this.alternativeError = error2;\r\n  this.alternativeRotation = rotation2;\r\n  this.alternativeTranslation = translation2;\r\n};\r\n\r\nmodule.exports = POS;","/*\r\nCopyright (c) 2012 Juan Mellado\r\n\r\nPermission is hereby granted, free of charge, to any person obtaining a copy\r\nof this software and associated documentation files (the \"Software\"), to deal\r\nin the Software without restriction, including without limitation the rights\r\nto use, copy, modify, merge, publish, distribute, sublicense, and/or sell\r\ncopies of the Software, and to permit persons to whom the Software is\r\nfurnished to do so, subject to the following conditions:\r\n\r\nThe above copyright notice and this permission notice shall be included in\r\nall copies or substantial portions of the Software.\r\n\r\nTHE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\r\nIMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\r\nFITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\r\nAUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\r\nLIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\r\nOUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\r\nTHE SOFTWARE.\r\n*/\r\n\r\n/*\r\nReferences:\r\n- \"3D Pose Estimation\"\r\n  Andrew Kirillow\r\n  http://www.aforgenet.com/articles/posit/\r\n*/\r\n\r\nvar SVD = require('./svd');\r\n\r\nvar POS = POS || {};\r\n\r\nPOS.Posit = function(modelSize, focalLength){\r\n  this.model = this.buildModel(modelSize);\r\n  this.focalLength = focalLength;\r\n\r\n  this.init();\r\n};\r\n\r\nPOS.Posit.prototype.buildModel = function(modelSize){\r\n  var half = modelSize / 2.0;\r\n  \r\n  return [\r\n    new Vec3(-half,  half, 0.0),\r\n    new Vec3( half,  half, 0.0),\r\n    new Vec3( half, -half, 0.0),\r\n    new Vec3(-half, -half, 0.0) ];\r\n};\r\n\r\nPOS.Posit.prototype.init = function(){\r\n  var d = new Vec3(), v = new Mat3(), u;\r\n  \r\n  this.modelVectors = Mat3.fromRows(\r\n      Vec3.sub(this.model[1], this.model[0]),\r\n      Vec3.sub(this.model[2], this.model[0]),\r\n      Vec3.sub(this.model[3], this.model[0]) );\r\n\r\n  u = Mat3.clone(this.modelVectors);\r\n\r\n  SVD.svdcmp(u.m, 3, 3, d.v, v.m);\r\n\r\n  this.modelPseudoInverse = Mat3.mult(\r\n    Mat3.mult(v, Mat3.fromDiagonal( Vec3.inverse(d) ) ), Mat3.transpose(u) );\r\n  \r\n  this.modelNormal = v.column( d.minIndex() );\r\n};\r\n\r\nPOS.Posit.prototype.pose = function(points){\r\n  var eps = new Vec3(1.0, 1.0, 1.0),\r\n      rotation1 = new Mat3(), rotation2 = new Mat3(),\r\n      translation1 = new Vec3(), translation2 = new Vec3(),\r\n      error1, error2;\r\n\r\n  this.pos(points, eps, rotation1, rotation2, translation1, translation2);\r\n\r\n  error1 = this.iterate(points, rotation1, translation1);\r\n  error2 = this.iterate(points, rotation2, translation2);\r\n\r\n  return error1 < error2?\r\n    new POS.Pose(error1, rotation1.m, translation1.v, error2, rotation2.m, translation2.v):\r\n    new POS.Pose(error2, rotation2.m, translation2.v, error1, rotation1.m, translation1.v);\r\n};\r\n\r\nPOS.Posit.prototype.pos = function(points, eps, rotation1, rotation2, translation1, translation2){\r\n  var xi = new Vec3(points[1].x, points[2].x, points[3].x),\r\n      yi = new Vec3(points[1].y, points[2].y, points[3].y),\r\n      xs = Vec3.addScalar( Vec3.mult(xi, eps), -points[0].x),\r\n      ys = Vec3.addScalar( Vec3.mult(yi, eps), -points[0].y),\r\n      i0 = Mat3.multVector(this.modelPseudoInverse, xs),\r\n      j0 = Mat3.multVector(this.modelPseudoInverse, ys),\r\n      s = j0.square() - i0.square(),\r\n      ij = Vec3.dot(i0, j0),\r\n      r = 0.0, theta = 0.0,\r\n      i, j, k, inorm, jnorm, scale, temp, lambda, mu;\r\n\r\n  if (0.0 === s){\r\n    r = Math.sqrt( Math.abs(2.0 * ij) );\r\n    theta = (-Math.PI / 2.0) * (ij < 0.0? -1: (ij > 0.0? 1.0: 0.0) );\r\n  }else{\r\n    r = Math.sqrt( Math.sqrt(s * s + 4.0 * ij * ij) );\r\n    theta = Math.atan(-2.0 * ij / s);\r\n    if (s < 0.0){\r\n      theta += Math.PI;\r\n    }\r\n    theta /= 2.0;\r\n  }\r\n\r\n  lambda = r * Math.cos(theta);\r\n  mu = r * Math.sin(theta);\r\n\r\n  //First possible rotation/translation\r\n  i = Vec3.add(i0, Vec3.multScalar(this.modelNormal, lambda) );\r\n  j = Vec3.add(j0, Vec3.multScalar(this.modelNormal, mu) );\r\n  inorm = i.normalize();\r\n  jnorm = j.normalize();\r\n  k = Vec3.cross(i, j);\r\n  rotation1.copy( Mat3.fromRows(i, j, k) );\r\n  \r\n  scale = (inorm + jnorm) / 2.0;\r\n  temp = Mat3.multVector(rotation1, this.model[0]);\r\n  translation1.v = [\r\n    points[0].x / scale - temp.v[0],\r\n    points[0].y / scale - temp.v[1],\r\n    this.focalLength / scale];\r\n\r\n  //Second possible rotation/translation\r\n  i = Vec3.sub(i0, Vec3.multScalar(this.modelNormal, lambda) );\r\n  j = Vec3.sub(j0, Vec3.multScalar(this.modelNormal, mu) );\r\n  inorm = i.normalize();\r\n  jnorm = j.normalize();\r\n  k = Vec3.cross(i, j);\r\n  rotation2.copy( Mat3.fromRows(i, j, k) );\r\n  \r\n  scale = (inorm + jnorm) / 2.0;\r\n  temp = Mat3.multVector(rotation2, this.model[0]);\r\n  translation2.v = [\r\n    points[0].x / scale - temp.v[0],\r\n    points[0].y / scale - temp.v[1],\r\n    this.focalLength / scale];\r\n};\r\n\r\nPOS.Posit.prototype.iterate = function(points, rotation, translation){\r\n  var prevError = Infinity,\r\n      rotation1 = new Mat3(), rotation2 = new Mat3(),\r\n      translation1 = new Vec3(), translation2 = new Vec3(),\r\n      i = 0, eps, error, error1, error2;\r\n\r\n  for (; i < 100; ++ i){\r\n    eps = Vec3.addScalar( Vec3.multScalar( \r\n      Mat3.multVector( this.modelVectors, rotation.row(2) ), 1.0 / translation.v[2]), 1.0);\r\n\r\n    this.pos(points, eps, rotation1, rotation2, translation1, translation2);\r\n\r\n    error1 = this.getError(points, rotation1, translation1);\r\n    error2 = this.getError(points, rotation2, translation2);\r\n\r\n    if (error1 < error2){\r\n      rotation.copy(rotation1);\r\n      translation.copy(translation1);\r\n      error = error1;\r\n    }else{\r\n      rotation.copy(rotation2);\r\n      translation.copy(translation2);\r\n      error = error2;\r\n    }\r\n\r\n    if ( (error <= 2.0) || (error > prevError) ){\r\n      break;\r\n    }\r\n\r\n    prevError = error;\r\n  }\r\n\r\n  return error;\r\n};\r\n\r\nPOS.Posit.prototype.getError = function(points, rotation, translation){\r\n  var v1 = Vec3.add( Mat3.multVector(rotation, this.model[0]), translation),\r\n      v2 = Vec3.add( Mat3.multVector(rotation, this.model[1]), translation),\r\n      v3 = Vec3.add( Mat3.multVector(rotation, this.model[2]), translation),\r\n      v4 = Vec3.add( Mat3.multVector(rotation, this.model[3]), translation),\r\n      modeled, ia1, ia2, ia3, ia4, ma1, ma2, ma3, ma4;\r\n  \r\n  v1 = v1.v; v2 = v2.v; v3 = v3.v; v4 = v4.v;\r\n  \r\n  v1[0] *= this.focalLength / v1[2];\r\n  v1[1] *= this.focalLength / v1[2];\r\n  v2[0] *= this.focalLength / v2[2];\r\n  v2[1] *= this.focalLength / v2[2];\r\n  v3[0] *= this.focalLength / v3[2];\r\n  v3[1] *= this.focalLength / v3[2];\r\n  v4[0] *= this.focalLength / v4[2];\r\n  v4[1] *= this.focalLength / v4[2];\r\n  \r\n  modeled = [\r\n    {x: v1[0], y: v1[1]},\r\n    {x: v2[0], y: v2[1]},\r\n    {x: v3[0], y: v3[1]},\r\n    {x: v4[0], y: v4[1]}\r\n  ];\r\n\r\n  ia1 = this.angle( points[0], points[1], points[3] );\r\n  ia2 = this.angle( points[1], points[2], points[0] );\r\n  ia3 = this.angle( points[2], points[3], points[1] );\r\n  ia4 = this.angle( points[3], points[0], points[2] );\r\n\r\n  ma1 = this.angle( modeled[0], modeled[1], modeled[3] );\r\n  ma2 = this.angle( modeled[1], modeled[2], modeled[0] );\r\n  ma3 = this.angle( modeled[2], modeled[3], modeled[1] );\r\n  ma4 = this.angle( modeled[3], modeled[0], modeled[2] );\r\n\r\n  return ( Math.abs(ia1 - ma1) +\r\n           Math.abs(ia2 - ma2) +\r\n           Math.abs(ia3 - ma3) +\r\n           Math.abs(ia4 - ma4) ) / 4.0;\r\n};\r\n\r\nPOS.Posit.prototype.angle = function(a, b, c){\r\n  var x1 = b.x - a.x, y1 = b.y - a.y,\r\n      x2 = c.x - a.x, y2 = c.y - a.y;\r\n  \r\n  return Math.acos( (x1 * x2 + y1 * y2) / \r\n    (Math.sqrt(x1 * x1 + y1 * y1) * Math.sqrt(x2 * x2 + y2 * y2) ) ) * 180.0 / Math.PI;\r\n};\r\n\r\nPOS.Pose = function(error1, rotation1, translation1, error2, rotation2, translation2){\r\n  this.bestError = error1;\r\n  this.bestRotation = rotation1;\r\n  this.bestTranslation = translation1;\r\n  this.alternativeError = error2;\r\n  this.alternativeRotation = rotation2;\r\n  this.alternativeTranslation = translation2;\r\n};\r\n\r\nvar Vec3 = function(x, y, z){\r\n  this.v = [x || 0.0, y || 0.0, z || 0.0];\r\n};\r\n\r\nVec3.prototype.copy = function(a){\r\n  var v = this.v;\r\n\r\n  a = a.v;\r\n\r\n  v[0] = a[0];\r\n  v[1] = a[1];\r\n  v[2] = a[2];\r\n\r\n  return this;\r\n};\r\n\r\nVec3.add = function(a, b){\r\n  var vector = new Vec3(), v = vector.v;\r\n  \r\n  a = a.v; b = b.v;\r\n\r\n  v[0] = a[0] + b[0];\r\n  v[1] = a[1] + b[1];\r\n  v[2] = a[2] + b[2];\r\n  \r\n  return vector;\r\n};\r\n\r\nVec3.sub = function(a, b){\r\n  var vector = new Vec3(), v = vector.v;\r\n  \r\n  a = a.v; b = b.v;\r\n\r\n  v[0] = a[0] - b[0];\r\n  v[1] = a[1] - b[1];\r\n  v[2] = a[2] - b[2];\r\n  \r\n  return vector;\r\n};\r\n\r\nVec3.mult = function(a, b){\r\n  var vector = new Vec3(), v = vector.v;\r\n  \r\n  a = a.v; b = b.v;\r\n\r\n  v[0] = a[0] * b[0];\r\n  v[1] = a[1] * b[1];\r\n  v[2] = a[2] * b[2];\r\n  \r\n  return vector;\r\n};\r\n\r\nVec3.addScalar = function(a, b){\r\n  var vector = new Vec3(), v = vector.v;\r\n  \r\n  a = a.v;\r\n\r\n  v[0] = a[0] + b;\r\n  v[1] = a[1] + b;\r\n  v[2] = a[2] + b;\r\n  \r\n  return vector;\r\n};\r\n\r\nVec3.multScalar = function(a, b){\r\n  var vector = new Vec3(), v = vector.v;\r\n  \r\n  a = a.v;\r\n\r\n  v[0] = a[0] * b;\r\n  v[1] = a[1] * b;\r\n  v[2] = a[2] * b;\r\n  \r\n  return vector;\r\n};\r\n\r\nVec3.dot = function(a, b){\r\n  a = a.v; b = b.v;\r\n\r\n  return a[0] * b[0] + a[1] * b[1] + a[2] * b[2];\r\n};\r\n\r\nVec3.cross = function(a, b){\r\n  a = a.v; b = b.v;\r\n\r\n return new Vec3(\r\n    a[1] * b[2] - a[2] * b[1],\r\n    a[2] * b[0] - a[0] * b[2],\r\n    a[0] * b[1] - a[1] * b[0]);\r\n};\r\n\r\nVec3.prototype.normalize = function(){\r\n  var v = this.v,\r\n      len = Math.sqrt(v[0] * v[0] + v[1] * v[1] + v[2] * v[2]);\r\n      \r\n  if (len > 0.0){\r\n    v[0] /= len;\r\n    v[1] /= len;\r\n    v[2] /= len;\r\n  }\r\n\r\n  return len;\r\n};\r\n\r\nVec3.inverse = function(a){\r\n  var vector = new Vec3(), v = vector.v;\r\n  \r\n  a = a.v;\r\n  \r\n  if (a[0] !== 0.0){\r\n    v[0] = 1.0 / a[0];\r\n  }\r\n  if (a[1] !== 0.0){\r\n    v[1] = 1.0 / a[1];\r\n  }\r\n  if (a[2] !== 0.0){\r\n    v[2] = 1.0 / a[2];\r\n  }\r\n  \r\n  return vector;\r\n};\r\n\r\nVec3.prototype.square = function(){\r\n  var v = this.v;\r\n\r\n  return v[0] * v[0] + v[1] * v[1] + v[2] * v[2];\r\n};\r\n\r\nVec3.prototype.minIndex = function(){\r\n  var v = this.v;\r\n\r\n  return v[0] < v[1]? (v[0] < v[2]? 0: 2): (v[1] < v[2]? 1: 2);\r\n};\r\n\r\nvar Mat3 = function(){\r\n  this.m = [ [0.0, 0.0, 0.0],\r\n             [0.0, 0.0, 0.0],\r\n             [0.0, 0.0, 0.0] ];\r\n};\r\n\r\nMat3.clone = function(a){\r\n  var matrix = new Mat3(), m = matrix.m;\r\n  \r\n  a = a.m;\r\n\r\n  m[0][0] = a[0][0];\r\n  m[0][1] = a[0][1];\r\n  m[0][2] = a[0][2];\r\n  m[1][0] = a[1][0];\r\n  m[1][1] = a[1][1];\r\n  m[1][2] = a[1][2];\r\n  m[2][0] = a[2][0];\r\n  m[2][1] = a[2][1];\r\n  m[2][2] = a[2][2];\r\n  \r\n  return matrix;\r\n};\r\n\r\nMat3.prototype.copy = function(a){\r\n  var m = this.m;\r\n\r\n  a = a.m;\r\n\r\n  m[0][0] = a[0][0];\r\n  m[0][1] = a[0][1];\r\n  m[0][2] = a[0][2];\r\n  m[1][0] = a[1][0];\r\n  m[1][1] = a[1][1];\r\n  m[1][2] = a[1][2];\r\n  m[2][0] = a[2][0];\r\n  m[2][1] = a[2][1];\r\n  m[2][2] = a[2][2];\r\n\r\n  return this;\r\n};\r\n\r\nMat3.fromRows = function(a, b, c){\r\n  var matrix = new Mat3(), m = matrix.m;\r\n  \r\n  a = a.v; b = b.v; c = c.v;\r\n  \r\n  m[0][0] = a[0];\r\n  m[0][1] = a[1];\r\n  m[0][2] = a[2];\r\n  m[1][0] = b[0];\r\n  m[1][1] = b[1];\r\n  m[1][2] = b[2];\r\n  m[2][0] = c[0];\r\n  m[2][1] = c[1];\r\n  m[2][2] = c[2];\r\n\r\n  return matrix;\r\n};\r\n\r\nMat3.fromDiagonal = function(a){\r\n  var matrix = new Mat3(), m = matrix.m;\r\n  \r\n  a = a.v;\r\n  \r\n  m[0][0] = a[0];\r\n  m[1][1] = a[1];\r\n  m[2][2] = a[2];\r\n  \r\n  return matrix;\r\n};\r\n\r\nMat3.transpose = function(a){\r\n  var matrix = new Mat3(), m = matrix.m;\r\n  \r\n  a = a.m;\r\n  \r\n  m[0][0] = a[0][0];\r\n  m[0][1] = a[1][0];\r\n  m[0][2] = a[2][0];\r\n  m[1][0] = a[0][1];\r\n  m[1][1] = a[1][1];\r\n  m[1][2] = a[2][1];\r\n  m[2][0] = a[0][2];\r\n  m[2][1] = a[1][2];\r\n  m[2][2] = a[2][2];\r\n            \r\n  return matrix;\r\n};\r\n\r\nMat3.mult = function(a, b){\r\n  var matrix = new Mat3(), m = matrix.m;\r\n  \r\n  a = a.m; b = b.m;\r\n\r\n  m[0][0] = a[0][0] * b[0][0] + a[0][1] * b[1][0] + a[0][2] * b[2][0];\r\n  m[0][1] = a[0][0] * b[0][1] + a[0][1] * b[1][1] + a[0][2] * b[2][1];\r\n  m[0][2] = a[0][0] * b[0][2] + a[0][1] * b[1][2] + a[0][2] * b[2][2];\r\n  m[1][0] = a[1][0] * b[0][0] + a[1][1] * b[1][0] + a[1][2] * b[2][0];\r\n  m[1][1] = a[1][0] * b[0][1] + a[1][1] * b[1][1] + a[1][2] * b[2][1];\r\n  m[1][2] = a[1][0] * b[0][2] + a[1][1] * b[1][2] + a[1][2] * b[2][2];\r\n  m[2][0] = a[2][0] * b[0][0] + a[2][1] * b[1][0] + a[2][2] * b[2][0];\r\n  m[2][1] = a[2][0] * b[0][1] + a[2][1] * b[1][1] + a[2][2] * b[2][1];\r\n  m[2][2] = a[2][0] * b[0][2] + a[2][1] * b[1][2] + a[2][2] * b[2][2];\r\n\r\n  return matrix;\r\n};\r\n\r\nMat3.multVector = function(m, a){\r\n  m = m.m; a = a.v;\r\n  \r\n  return new Vec3(\r\n    m[0][0] * a[0] + m[0][1] * a[1] + m[0][2] * a[2],\r\n    m[1][0] * a[0] + m[1][1] * a[1] + m[1][2] * a[2],\r\n    m[2][0] * a[0] + m[2][1] * a[1] + m[2][2] * a[2]);\r\n};\r\n\r\nMat3.prototype.column = function(index){\r\n  var m = this.m;\r\n  \r\n  return new Vec3( m[0][index], m[1][index], m[2][index] );\r\n};\r\n\r\nMat3.prototype.row = function(index){\r\n  var m = this.m;\r\n  \r\n  return new Vec3( m[index][0], m[index][1], m[index][2] );\r\n};\r\n\r\nmodule.exports = POS;","module.exports = {\n  CV: require('./src/cv'),\n  AR: require('./src/aruco'),\n  SVD: require('./src/svd'),\n  POS1: require('./src/posit1'),\n  POS2: require('./src/posit2')\n}","import { AR } from \"js-aruco\";\r\nimport {\r\n  canonicalRimTargets,\r\n  computeHomographyDLT,\r\n  rmsError,\r\n  type Homography,\r\n  type Point,\r\n} from \"./vision\";\r\n\r\nexport type MarkerKey = \"top\" | \"right\" | \"bottom\" | \"left\";\r\n\r\nexport const MARKER_ORDER: MarkerKey[] = [\"top\", \"right\", \"bottom\", \"left\"];\r\n\r\nexport const MARKER_TARGETS: Record<MarkerKey, number> = {\r\n  top: 0,\r\n  right: 1,\r\n  bottom: 2,\r\n  left: 3,\r\n};\r\n\r\nexport type MarkerDetection = {\r\n  success: boolean;\r\n  points: Point[];\r\n  missing: MarkerKey[];\r\n  markersFound: Array<{ id: number; center: Point }>;\r\n  assignments: Partial<Record<MarkerKey, { id: number; center: Point }>>;\r\n  homography: Homography | null;\r\n  errorPx: number | null;\r\n  message?: string;\r\n};\r\n\r\nlet detector: AR.Detector | null = null;\r\n\r\nfunction ensureDetector() {\r\n  if (!detector) detector = new AR.Detector();\r\n  return detector;\r\n}\r\n\r\nfunction centerFromCorners(corners: { x: number; y: number }[]): Point {\r\n  const acc = corners.reduce(\r\n    (sum, corner) => ({ x: sum.x + corner.x, y: sum.y + corner.y }),\r\n    { x: 0, y: 0 },\r\n  );\r\n  const count = corners.length || 1;\r\n  return { x: acc.x / count, y: acc.y / count };\r\n}\r\n\r\nexport function detectMarkersFromImage(image: ImageData): MarkerDetection {\r\n  try {\r\n    const det = ensureDetector();\r\n    const markers = det.detect(image) || [];\r\n    const assignments: Partial<\r\n      Record<MarkerKey, { id: number; center: Point }>\r\n    > = {};\r\n    const found: Array<{ id: number; center: Point }> = [];\r\n\r\n    // Map detected markers to their positions\r\n    for (const marker of markers) {\r\n      const center = centerFromCorners(marker.corners);\r\n      found.push({ id: marker.id, center });\r\n      const key = (Object.keys(MARKER_TARGETS) as MarkerKey[]).find(\r\n        (k) => MARKER_TARGETS[k] === marker.id,\r\n      );\r\n      if (key) assignments[key] = { id: marker.id, center };\r\n    }\r\n\r\n    const missing = (Object.keys(MARKER_TARGETS) as MarkerKey[]).filter(\r\n      (k) => !assignments[k],\r\n    );\r\n\r\n    // If we found some markers but not all, provide helpful info in the error\r\n    if (missing.length > 0) {\r\n      return {\r\n        success: false,\r\n        points: [],\r\n        missing,\r\n        markersFound: found,\r\n        assignments,\r\n        homography: null,\r\n        errorPx: null,\r\n        message:\r\n          found.length > 0\r\n            ? `Detected ${found.length} of 4 markers. Some markers may have incorrect IDs or be unclear.`\r\n            : \"Not all calibration markers were detected.\",\r\n      };\r\n    }\r\n\r\n    // All 4 markers found - compute homography\r\n    const dst = [\r\n      assignments.top!.center,\r\n      assignments.right!.center,\r\n      assignments.bottom!.center,\r\n      assignments.left!.center,\r\n    ];\r\n    // Use only the first 4 canonical rim targets (TOP, RIGHT, BOTTOM, LEFT) to match the 4 marker points\r\n    const allTargets = canonicalRimTargets();\r\n    const src = allTargets.slice(0, 4);\r\n    const H = computeHomographyDLT(src, dst);\r\n    const error = rmsError(H, src, dst);\r\n    return {\r\n      success: true,\r\n      points: dst,\r\n      missing: [],\r\n      markersFound: found,\r\n      assignments,\r\n      homography: H,\r\n      errorPx: error,\r\n    };\r\n  } catch (err) {\r\n    return {\r\n      success: false,\r\n      points: [],\r\n      missing: Object.keys(MARKER_TARGETS) as MarkerKey[],\r\n      markersFound: [],\r\n      assignments: {},\r\n      homography: null,\r\n      errorPx: null,\r\n      message: err instanceof Error ? err.message : \"Marker detection failed\",\r\n    };\r\n  }\r\n}\r\n\r\nexport function detectMarkersFromCanvas(\r\n  canvas: HTMLCanvasElement,\r\n): MarkerDetection {\r\n  const ctx = canvas.getContext(\"2d\");\r\n  if (!ctx) {\r\n    return {\r\n      success: false,\r\n      points: [],\r\n      missing: Object.keys(MARKER_TARGETS) as MarkerKey[],\r\n      markersFound: [],\r\n      assignments: {},\r\n      homography: null,\r\n      errorPx: null,\r\n      message: \"Canvas context unavailable for marker detection.\",\r\n    };\r\n  }\r\n  const tryDetect = (img: ImageData): MarkerDetection =>\r\n    detectMarkersFromImage(img);\r\n\r\n  // Pass 1: raw image\r\n  let imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);\r\n  let result = tryDetect(imageData);\r\n  if (result.success || (result.markersFound?.length || 0) > 0) return result;\r\n\r\n  // Pass 2: scale up 1.75x (helps low-resolution streams)\r\n  try {\r\n    const scale = 1.75;\r\n    const off = document.createElement(\"canvas\");\r\n    off.width = Math.round(canvas.width * scale);\r\n    off.height = Math.round(canvas.height * scale);\r\n    const octx = off.getContext(\"2d\")!;\r\n    octx.imageSmoothingEnabled = false;\r\n    octx.drawImage(canvas, 0, 0, off.width, off.height);\r\n    imageData = octx.getImageData(0, 0, off.width, off.height);\r\n    result = tryDetect(imageData);\r\n    if (result.success || (result.markersFound?.length || 0) > 0) return result;\r\n  } catch {}\r\n\r\n  // Pass 3: contrast boost (simple linear stretch)\r\n  try {\r\n    const w = canvas.width,\r\n      h = canvas.height;\r\n    const id = ctx.getImageData(0, 0, w, h);\r\n    const data = id.data;\r\n    let min = 255,\r\n      max = 0;\r\n    // Compute luminance min/max\r\n    for (let i = 0; i < data.length; i += 4) {\r\n      const y = 0.2126 * data[i] + 0.7152 * data[i + 1] + 0.0722 * data[i + 2];\r\n      if (y < min) min = y;\r\n      if (y > max) max = y;\r\n    }\r\n    const range = Math.max(1, max - min);\r\n    for (let i = 0; i < data.length; i += 4) {\r\n      const y = 0.2126 * data[i] + 0.7152 * data[i + 1] + 0.0722 * data[i + 2];\r\n      const yn = Math.max(0, Math.min(255, ((y - min) * 255) / range));\r\n      data[i] = data[i + 1] = data[i + 2] = yn;\r\n    }\r\n    result = tryDetect(id);\r\n    if (result.success || (result.markersFound?.length || 0) > 0) return result;\r\n  } catch {}\r\n\r\n  // Pass 4: aggressive threshold (convert to pure black & white)\r\n  try {\r\n    const w = canvas.width,\r\n      h = canvas.height;\r\n    const id = ctx.getImageData(0, 0, w, h);\r\n    const data = id.data;\r\n    // Find middle gray\r\n    let sum = 0,\r\n      count = 0;\r\n    for (let i = 0; i < data.length; i += 4) {\r\n      const y = 0.2126 * data[i] + 0.7152 * data[i + 1] + 0.0722 * data[i + 2];\r\n      sum += y;\r\n      count++;\r\n    }\r\n    const threshold = sum / count;\r\n    // Convert to pure B&W\r\n    for (let i = 0; i < data.length; i += 4) {\r\n      const y = 0.2126 * data[i] + 0.7152 * data[i + 1] + 0.0722 * data[i + 2];\r\n      const v = y > threshold ? 255 : 0;\r\n      data[i] = data[i + 1] = data[i + 2] = v;\r\n    }\r\n    result = tryDetect(id);\r\n    if (result.success || (result.markersFound?.length || 0) > 0) return result;\r\n  } catch {}\r\n\r\n  // If still nothing, return the last result (with helpful message)\r\n  return {\r\n    success: false,\r\n    points: [],\r\n    missing: Object.keys(MARKER_TARGETS) as MarkerKey[],\r\n    markersFound: result.markersFound || [],\r\n    assignments: result.assignments || {},\r\n\r\n    homography: null,\r\n    errorPx: null,\r\n    message:\r\n      result.message ||\r\n      \"No calibration markers detected. Ensure you are using the provided TOP/RIGHT/BOTTOM/LEFT ArUco markers printed at 100% on white paper.\",\r\n  };\r\n}\r\n\r\nconst ROW_PATTERNS: Record<string, number[]> = {\r\n  \"0,0\": [1, 0, 0, 0, 0],\r\n  \"0,1\": [1, 0, 1, 1, 1],\r\n  \"1,0\": [0, 1, 0, 0, 1],\r\n  \"1,1\": [0, 1, 1, 1, 0],\r\n};\r\n\r\nexport function markerIdToMatrix(id: number): number[][] {\r\n  const rows: number[][] = new Array(5);\r\n  let bits = id >>> 0;\r\n  for (let row = 4; row >= 0; row--) {\r\n    const bit3 = bits & 1;\r\n    bits >>= 1;\r\n    const bit1 = bits & 1;\r\n    bits >>= 1;\r\n    const pattern = ROW_PATTERNS[`${bit1},${bit3}`];\r\n    if (!pattern)\r\n      throw new Error(`Unsupported marker id pattern for row ${row}`);\r\n    rows[row] = pattern.slice();\r\n  }\r\n  const matrix = Array.from({ length: 7 }, () => new Array(7).fill(0));\r\n  for (let y = 0; y < 5; y++) {\r\n    for (let x = 0; x < 5; x++) {\r\n      matrix[y + 1][x + 1] = rows[y][x];\r\n    }\r\n  }\r\n  return matrix;\r\n}\r\n","/**\r\n * Advanced Dartboard Auto-Calibration\r\n *\r\n * Detects dartboard features automatically without markers or manual clicking:\r\n * 1. Detects bull (inner & outer rings) using circle detection\r\n * 2. Detects treble and double rings using edge/circle detection\r\n * 3. Computes board center and orientation\r\n * 4. Generates calibration points from detected rings\r\n * 5. Computes homography without user interaction\r\n */\r\n\r\nimport {\r\n  BoardRadii,\r\n  computeHomographyDLT,\r\n  rmsError,\r\n  type Homography,\r\n  type Point,\r\n} from \"./vision\";\r\n\r\nconst isFinitePoint = (p: Point | undefined): p is Point =>\r\n  !!p && Number.isFinite(p.x) && Number.isFinite(p.y);\r\nconst isFiniteHomography = (\r\n  H: Homography | null | undefined,\r\n): H is Homography =>\r\n  Array.isArray(H) && H.length === 9 && H.every(Number.isFinite);\r\n\r\nexport interface BoardDetectionResult {\r\n  success: boolean;\r\n  cx: number; // Board center X in image\r\n  cy: number; // Board center Y in image\r\n  bullInner: number; // Detected inner bull radius (pixels)\r\n  bullOuter: number; // Detected outer bull radius (pixels)\r\n  trebleInner: number; // Detected treble inner radius (pixels)\r\n  trebleOuter: number; // Detected treble outer radius (pixels)\r\n  doubleInner: number; // Detected double inner radius (pixels)\r\n  doubleOuter: number; // Detected double outer radius (pixels)\r\n  confidence: number; // 0-100, quality of detection\r\n  homography: Homography | null;\r\n  errorPx: number | null;\r\n  calibrationPoints: Point[];\r\n  message?: string;\r\n}\r\n\r\n/**\r\n * Detect dartboard by finding concentric rings\r\n * Simpler, more direct approach: look for strong circular edges at the right distances\r\n */\r\nfunction findDartboardRings(\r\n  canvas: HTMLCanvasElement,\r\n): { cx: number; cy: number; r: number; confidence: number; ringCount?: number; ringStrength?: number } | null {\r\n  const ctx = canvas.getContext(\"2d\");\r\n  if (!ctx) return null;\r\n\r\n  const w = canvas.width;\r\n  const h = canvas.height;\r\n  const imageData = ctx.getImageData(0, 0, w, h);\r\n  const data = imageData.data;\r\n\r\n  // Step 1: Find all strong edges using Canny-like detection\r\n  const edges: Array<{ x: number; y: number; mag: number }> = [];\r\n\r\n  // dynamic gradient threshold based on image size (lower-res -> lower threshold)\r\n  const baseEdgeThreshold = Math.round(Math.max(8, Math.min(32, (w + h) / 120)));\r\n\r\n  // Precompute grayscale and apply a small blur to reduce high-frequency noise\r\n  const gray = new Float32Array(w * h);\r\n  for (let y = 0; y < h; y++) {\r\n    for (let x = 0; x < w; x++) {\r\n      const idx = (y * w + x) * 4;\r\n      gray[y * w + x] = data[idx] * 0.299 + data[idx + 1] * 0.587 + data[idx + 2] * 0.114;\r\n    }\r\n  }\r\n  // 3x3 box blur into blurred array\r\n  const blurred = new Float32Array(w * h);\r\n  for (let y = 1; y < h - 1; y++) {\r\n    for (let x = 1; x < w - 1; x++) {\r\n      let sum = 0;\r\n      for (let dy = -1; dy <= 1; dy++) {\r\n        for (let dx = -1; dx <= 1; dx++) {\r\n          sum += gray[(y + dy) * w + (x + dx)];\r\n        }\r\n      }\r\n      blurred[y * w + x] = sum / 9;\r\n    }\r\n  }\r\n  // Compute gradients using blurred values\r\n  for (let y = 2; y < h - 2; y++) {\r\n    for (let x = 2; x < w - 2; x++) {\r\n      let gx = 0,\r\n        gy = 0;\r\n      for (let dy = -1; dy <= 1; dy++) {\r\n        for (let dx = -1; dx <= 1; dx++) {\r\n          const grayVal = blurred[(y + dy) * w + (x + dx)];\r\n          if (dx !== 0) gx += (dx > 0 ? 1 : -1) * grayVal;\r\n          if (dy !== 0) gy += (dy > 0 ? 1 : -1) * grayVal;\r\n        }\r\n      }\r\n      const mag = Math.hypot(gx, gy);\r\n      if (mag > baseEdgeThreshold) {\r\n        edges.push({ x, y, mag });\r\n      }\r\n    }\r\n  }\r\n\r\n  if (edges.length === 0) return null;\r\n\r\n  // global thresholds scaled by image resolution\r\n  const minPixelCount = Math.max(3, Math.round((w * h) / (640 * 480) * 10));\r\n  const minStrength = Math.max(80, Math.round((w * h) / (640 * 480) * 500));\r\n\r\n  // Step 2: For each potential center, score how many rings we can explain\r\n  let bestCenter = null;\r\n  let bestScore = 0;\r\n  let bestRingCount = 0;\r\n\r\n  // Sample potential centers\r\n  // Use a dynamic sampling stride based on image size\r\n  const stride = Math.max(6, Math.round(Math.min(w, h) / 40));\r\n  for (let cy = Math.round(h * 0.3); cy < Math.round(h * 0.7); cy += stride) {\r\n    for (let cx = Math.round(w * 0.3); cx < Math.round(w * 0.7); cx += stride) {\r\n      // For this center, find rings at expected radii\r\n      let ringCount = 0;\r\n      let ringStrength = 0;\r\n\r\n      // Estimate scale for pixels-per-mm by assuming the board double diameter occupies ~45% of min dimension\r\n      const approxDoublePixels = Math.min(w, h) * 0.45; // expected double radius in px\r\n      const scalePxPerMm = approxDoublePixels / BoardRadii.doubleOuter;\r\n      const testRadii = [\r\n        BoardRadii.bullInner * scalePxPerMm,\r\n        BoardRadii.bullOuter * scalePxPerMm,\r\n        BoardRadii.trebleInner * scalePxPerMm,\r\n        BoardRadii.trebleOuter * scalePxPerMm,\r\n        BoardRadii.doubleInner * scalePxPerMm,\r\n        BoardRadii.doubleOuter * scalePxPerMm,\r\n      ];\r\n\r\n      // Build radial histogram (bins) of edge magnitudes per radius for this center\r\n      const maxR = Math.round(Math.min(\r\n        Math.min(cx, w - cx),\r\n        Math.min(cy, h - cy),\r\n      ));\r\n      const bins = new Float32Array(maxR + 1);\r\n      let maxBin = 0;\r\n      for (const edge of edges) {\r\n        const dist = Math.round(Math.hypot(edge.x - cx, edge.y - cy));\r\n        if (dist <= 0 || dist > maxR) continue;\r\n        bins[dist] += edge.mag;\r\n        if (bins[dist] > maxBin) maxBin = bins[dist];\r\n      }\r\n\r\n      // Find significant peaks in histogram\r\n      const peakRadius: number[] = [];\r\n      const peakThreshold = Math.max(12, maxBin * 0.08);\r\n      for (let r = 2; r < maxR - 2; r++) {\r\n        const v = bins[r];\r\n        if (v <= peakThreshold) continue;\r\n        // local maxima\r\n        if (v > bins[r - 1] && v >= bins[r + 1]) {\r\n          peakRadius.push(r);\r\n        }\r\n      }\r\n\r\n      // Match expected radii against peaks\r\n      for (const testR of testRadii) {\r\n        // compute tolerance based on expected radius\r\n        const tol = Math.max(3, Math.round(testR * 0.02));\r\n        // find the peak nearest to testR\r\n        let bestPeak = -1;\r\n        let bestDist = Infinity;\r\n        for (const pr of peakRadius) {\r\n          const d = Math.abs(pr - testR);\r\n          if (d < bestDist) {\r\n            bestDist = d;\r\n            bestPeak = pr;\r\n          }\r\n        }\r\n        if (bestPeak >= 0 && bestDist <= tol) {\r\n          // ring strength is bin magnitude at that peak\r\n          ringCount++;\r\n          ringStrength += bins[bestPeak] || 0;\r\n        }\r\n      }\r\n\r\n      // Want at least 3 strong rings (loosened for small/partial crops)\r\n      if (ringCount >= 3 && ringStrength > bestScore) {\r\n        bestScore = ringStrength;\r\n        bestCenter = { cx, cy };\r\n        bestRingCount = ringCount;\r\n      }\r\n    }\r\n  }\r\n\r\n  if (!bestCenter) return null;\r\n\r\n  // Step 3: Refine the center position and find double radius\r\n  const refinedCx = bestCenter.cx;\r\n  const refinedCy = bestCenter.cy;\r\n\r\n  // Find the strongest ring near where we expect the double outer\r\n  // Use an adaptive scan range based on image size\r\n  const approxDoublePixels = Math.min(w, h) * 0.45;\r\n  const minScan = Math.max(6, Math.round(approxDoublePixels * 0.5));\r\n  const maxScan = Math.min(Math.round(Math.max(w, h) - 4), Math.round(approxDoublePixels * 1.5));\r\n  let doubleR = Math.round(approxDoublePixels);\r\n  let maxStrength = 0;\r\n\r\n  for (let testR = minScan; testR <= maxScan; testR += Math.max(2, Math.round((maxScan - minScan) / 60))) {\r\n    let strength = 0;\r\n    let pixelCount = 0;\r\n\r\n    for (const edge of edges) {\r\n      const dist = Math.hypot(edge.x - refinedCx, edge.y - refinedCy);\r\n      const tol = Math.max(2, Math.round(testR * 0.01));\r\n      if (Math.abs(dist - testR) < tol) {\r\n        strength += edge.mag;\r\n        pixelCount++;\r\n      }\r\n    }\r\n\r\n    if (pixelCount > Math.max(6, Math.round(minPixelCount * 0.6)) && strength > maxStrength) {\r\n      maxStrength = strength;\r\n      doubleR = testR;\r\n    }\r\n  }\r\n\r\n  // Calculate confidence based on how many proper rings we found\r\n  let confidence = 0;\r\n  const scale = doubleR / BoardRadii.doubleOuter;\r\n\r\n  for (const knownR of [\r\n    BoardRadii.bullInner,\r\n    BoardRadii.bullOuter,\r\n    BoardRadii.trebleInner,\r\n    BoardRadii.trebleOuter,\r\n    BoardRadii.doubleInner,\r\n    BoardRadii.doubleOuter,\r\n  ]) {\r\n    const expectedPixelR = knownR * scale;\r\n    let found = false;\r\n\r\n    for (const edge of edges) {\r\n      const dist = Math.hypot(edge.x - refinedCx, edge.y - refinedCy);\r\n      const tol = Math.max(3, Math.round(expectedPixelR * 0.02));\r\n      if (Math.abs(dist - expectedPixelR) < tol) {\r\n        found = true;\r\n        confidence += 15;\r\n        break;\r\n      }\r\n    }\r\n  }\r\n\r\n  confidence = Math.min(100, confidence);\r\n\r\n  return {\r\n    cx: refinedCx,\r\n    cy: refinedCy,\r\n    r: doubleR,\r\n    confidence,\r\n    ringCount: bestRingCount,\r\n    ringStrength: Math.round(bestScore),\r\n  };\r\n}\r\n\r\n/**\r\n * Main board detection function\r\n * Uses direct ring detection approach\r\n */\r\nexport function detectBoard(canvas: HTMLCanvasElement): BoardDetectionResult {\r\n  try {\r\n    const w = canvas.width;\r\n    const h = canvas.height;\r\n    const centerX = w / 2;\r\n    const centerY = h / 2;\r\n\r\n    // Find dartboard rings\r\n    const detection = findDartboardRings(canvas);\r\n\r\n    if (!detection) {\r\n      return {\r\n        success: false,\r\n        cx: centerX,\r\n        cy: centerY,\r\n        bullInner: 0,\r\n        bullOuter: 0,\r\n        trebleInner: 0,\r\n        trebleOuter: 0,\r\n        doubleInner: 0,\r\n        doubleOuter: 0,\r\n        confidence: 0,\r\n        homography: null,\r\n        errorPx: null,\r\n        calibrationPoints: [],\r\n        message:\r\n          \"No dartboard detected. Ensure board is clearly visible with good contrast between rings and background.\",\r\n      };\r\n    }\r\n\r\n    // Scale all ring radii based on detected double radius\r\n    const scale = detection.r / BoardRadii.doubleOuter;\r\n\r\n    const detected = {\r\n      cx: detection.cx,\r\n      cy: detection.cy,\r\n      bullInner: BoardRadii.bullInner * scale,\r\n      bullOuter: BoardRadii.bullOuter * scale,\r\n      trebleInner: BoardRadii.trebleInner * scale,\r\n      trebleOuter: BoardRadii.trebleOuter * scale,\r\n      doubleInner: BoardRadii.doubleInner * scale,\r\n      doubleOuter: detection.r,\r\n    };\r\n\r\n    // Generate 4 calibration points from detected rings (TOP, RIGHT, BOTTOM, LEFT of double)\r\n    const calibrationPoints: Point[] = [\r\n      { x: detected.cx, y: detected.cy - detected.doubleOuter }, // TOP\r\n      { x: detected.cx + detected.doubleOuter, y: detected.cy }, // RIGHT\r\n      { x: detected.cx, y: detected.cy + detected.doubleOuter }, // BOTTOM\r\n      { x: detected.cx - detected.doubleOuter, y: detected.cy }, // LEFT\r\n    ];\r\n\r\n    // Compute homography from these 4 points\r\n    const canonicalSrc = [\r\n      { x: 0, y: -BoardRadii.doubleOuter },\r\n      { x: BoardRadii.doubleOuter, y: 0 },\r\n      { x: 0, y: BoardRadii.doubleOuter },\r\n      { x: -BoardRadii.doubleOuter, y: 0 },\r\n    ];\r\n\r\n  let homography: Homography | null = null;\r\n    let errorPx: number | null = null;\r\n    let confidence = detection.confidence;\r\n\r\n    try {\r\n      homography = computeHomographyDLT(canonicalSrc, calibrationPoints);\r\n      errorPx = rmsError(homography, canonicalSrc, calibrationPoints);\r\n      // Adjust confidence based on homography error\r\n      const errorConfidence = Math.max(\r\n        10,\r\n        Math.min(95, 100 - Math.max(0, errorPx - 1) * 10),\r\n      );\r\n      confidence = (confidence + errorConfidence) / 2;\r\n    } catch (err) {\r\n      confidence = Math.max(40, confidence);\r\n    }\r\n\r\n  const pointsValid = calibrationPoints.every(isFinitePoint);\r\n    const homographyValid = isFiniteHomography(homography);\r\n    const success = !!homographyValid && pointsValid && confidence > 50;\r\n  const detRingCount = detection.ringCount ?? 0;\r\n  const detRingStrength = detection.ringStrength ?? 0;\r\n\r\n    return {\r\n      success,\r\n      cx: detected.cx,\r\n      cy: detected.cy,\r\n      bullInner: detected.bullInner,\r\n      bullOuter: detected.bullOuter,\r\n      trebleInner: detected.trebleInner,\r\n      trebleOuter: detected.trebleOuter,\r\n      doubleInner: detected.doubleInner,\r\n      doubleOuter: detected.doubleOuter,\r\n      confidence,\r\n      homography: homographyValid ? homography : null,\r\n      errorPx: homographyValid ? errorPx : null,\r\n      calibrationPoints: pointsValid ? calibrationPoints : [],\r\n      message:\r\n        !pointsValid || !homographyValid\r\n          ? ` Detection produced unstable calibration data. Adjust camera framing or calibrate manually. (rings: ${detRingCount}, r:${Math.round(detection.r)})`\r\n          : confidence > 80\r\n          ? ` High confidence detection (rings: ${detRingCount}, r:${Math.round(detection.r)})`\r\n          : confidence > 50\r\n          ? ` Detection found but could be better (rings: ${detRingCount}, r:${Math.round(detection.r)})`\r\n          : ` Low confidence - try better lighting (rings: ${detRingCount}, r:${Math.round(detection.r)})`,\r\n    };\r\n  } catch (err) {\r\n    return {\r\n      success: false,\r\n      cx: canvas.width / 2,\r\n      cy: canvas.height / 2,\r\n      bullInner: 0,\r\n      bullOuter: 0,\r\n      trebleInner: 0,\r\n      trebleOuter: 0,\r\n      doubleInner: 0,\r\n      doubleOuter: 0,\r\n      confidence: 0,\r\n      homography: null,\r\n      errorPx: null,\r\n      calibrationPoints: [],\r\n      message: err instanceof Error ? err.message : \"Board detection failed\",\r\n    };\r\n  }\r\n}\r\n\r\n/**\r\n * Refine detection by looking for concentric rings\r\n * This helps match detected circles to specific board rings\r\n */\r\nexport function refineRingDetection(\r\n  detected: BoardDetectionResult,\r\n): BoardDetectionResult {\r\n  // If detection already has good confidence, return as-is\r\n  if (detected.confidence > 70) return detected;\r\n\r\n  // Otherwise try to improve by checking ring ratios\r\n  // If rings don't match expected ratios, we can flag for manual refinement\r\n  const expectedRatios = {\r\n    bullInner_to_bullOuter: BoardRadii.bullInner / BoardRadii.bullOuter,\r\n    bullOuter_to_trebleInner: BoardRadii.bullOuter / BoardRadii.trebleInner,\r\n    trebleOuter_to_doubleInner: BoardRadii.trebleOuter / BoardRadii.doubleInner,\r\n    doubleInner_to_doubleOuter: BoardRadii.doubleInner / BoardRadii.doubleOuter,\r\n  };\r\n\r\n  const actualRatios = {\r\n    bullInner_to_bullOuter: detected.bullInner / detected.bullOuter,\r\n    bullOuter_to_trebleInner: detected.bullOuter / detected.trebleInner,\r\n    trebleOuter_to_doubleInner: detected.trebleOuter / detected.doubleInner,\r\n    doubleInner_to_doubleOuter: detected.doubleInner / detected.doubleOuter,\r\n  };\r\n\r\n  // Check ratio errors\r\n  let ratioError = 0;\r\n  let ratioCount = 0;\r\n  for (const [key, expected] of Object.entries(expectedRatios)) {\r\n    const actual = actualRatios[key as keyof typeof actualRatios];\r\n    const error = Math.abs(actual - expected) / expected;\r\n    ratioError += error;\r\n    ratioCount++;\r\n  }\r\n  const avgRatioError = ratioError / ratioCount;\r\n\r\n  // Adjust confidence based on ratio error\r\n  const adjustedConfidence = Math.max(\r\n    10,\r\n    detected.confidence - avgRatioError * 100,\r\n  );\r\n\r\n  return {\r\n    ...detected,\r\n    confidence: adjustedConfidence,\r\n    message:\r\n      adjustedConfidence > 70\r\n        ? \" High confidence detection\"\r\n        : adjustedConfidence > 50\r\n          ? \" Rings detected but ratios off - may need refinement\"\r\n          : \" Low confidence - try repositioning camera\",\r\n  };\r\n}\r\n","import { create } from \"zustand\";\r\nimport { dlog, dinfo } from \"../utils/logger\";\r\n\r\ntype LastOffline = {\r\n  mode: string;\r\n  x01Start: number;\r\n  firstTo: number;\r\n  aiLevel: string;\r\n};\r\n\r\ntype SettingsState = {\r\n  favoriteDouble: string;\r\n  callerEnabled: boolean;\r\n  callerVoice: string; // voice name\r\n  callerVolume: number; // 0..1\r\n  speakCheckoutOnly: boolean;\r\n  avgMode: \"all-time\" | \"24h\";\r\n  autoStartOffline: boolean;\r\n  rememberLastOffline: boolean;\r\n  lastOffline: LastOffline;\r\n  reducedMotion: boolean;\r\n  compactHeader: boolean;\r\n  allowSpectate: boolean;\r\n  // UI tuning\r\n  cameraScale: number; // 0.5 .. 1.25\r\n  cameraAspect?: \"wide\" | \"square\";\r\n  cameraFitMode?: \"fit\" | \"fill\";\r\n  // External autoscore provider\r\n  autoscoreProvider?: \"built-in\" | \"external-ws\" | \"manual\";\r\n  autoscoreWsUrl?: string;\r\n  autoCommitMode?: \"wait-for-clear\" | \"immediate\";\r\n  // Allow immediate autocommit when playing online/tournaments\r\n  allowAutocommitInOnline?: boolean;\r\n  calibrationGuide: boolean;\r\n  // Preserve calibration overlay display size when calibration is locked\r\n  preserveCalibrationOverlay: boolean;\r\n  // Devices & preferences\r\n  preferredCameraId?: string;\r\n  preferredCameraLabel?: string;\r\n  preferredCameraLocked?: boolean;\r\n  // Camera control\r\n  cameraEnabled: boolean;\r\n  hideCameraOverlay: boolean;\r\n  ignorePreferredCameraSync: boolean;\r\n  // UI variants\r\n  offlineLayout?: \"classic\" | \"modern\";\r\n  // Text size\r\n  textSize: \"small\" | \"medium\" | \"large\";\r\n  // Box size\r\n  boxSize: \"small\" | \"medium\" | \"large\";\r\n  // Match configuration\r\n  matchType?: \"singles\" | \"doubles\";\r\n  teamAName?: string;\r\n  teamBName?: string;\r\n  setFavoriteDouble: (d: string) => void;\r\n  setCallerEnabled: (v: boolean) => void;\r\n  setCallerVoice: (name: string) => void;\r\n  setAvgMode: (mode: \"all-time\" | \"24h\") => void;\r\n  setCallerVolume: (v: number) => void;\r\n  setSpeakCheckoutOnly: (v: boolean) => void;\r\n  setAutoStartOffline: (v: boolean) => void;\r\n  setRememberLastOffline: (v: boolean) => void;\r\n  setLastOffline: (cfg: Partial<LastOffline>) => void;\r\n  setReducedMotion: (v: boolean) => void;\r\n  setCompactHeader: (v: boolean) => void;\r\n  setAllowSpectate: (v: boolean) => void;\r\n  setCameraScale: (n: number) => void;\r\n  setCameraAspect: (a: \"wide\" | \"square\") => void;\r\n  setCameraFitMode: (m: \"fit\" | \"fill\") => void;\r\n  setCalibrationGuide: (v: boolean) => void;\r\n  setPreserveCalibrationOverlay: (v: boolean) => void;\r\n  setPreferredCamera: (\r\n    id: string | undefined,\r\n    label?: string,\r\n    force?: boolean,\r\n  ) => void;\r\n  setPreferredCameraLocked: (v: boolean) => void;\r\n  setCameraEnabled: (v: boolean) => void;\r\n  setHideCameraOverlay: (v: boolean) => void;\r\n  setIgnorePreferredCameraSync: (v: boolean) => void;\r\n  setOfflineLayout: (mode: \"classic\" | \"modern\") => void;\r\n  setAutoscoreProvider: (p: \"built-in\" | \"external-ws\" | \"manual\") => void;\r\n  setAutoscoreWsUrl: (u: string) => void;\r\n  setAutoCommitMode: (mode: \"wait-for-clear\" | \"immediate\") => void;\r\n  setAllowAutocommitInOnline: (v: boolean) => void;\r\n  setTextSize: (size: \"small\" | \"medium\" | \"large\") => void;\r\n  setBoxSize: (size: \"small\" | \"medium\" | \"large\") => void;\r\n  setMatchType: (t: \"singles\" | \"doubles\") => void;\r\n  setTeamAName: (name: string) => void;\r\n  setTeamBName: (name: string) => void;\r\n  // Throw timer per dart\r\n  dartTimerEnabled?: boolean;\r\n  dartTimerSeconds?: number;\r\n  setDartTimerEnabled: (v: boolean) => void;\r\n  setDartTimerSeconds: (n: number) => void;\r\n  // X01 rules\r\n  x01DoubleIn?: boolean;\r\n  setX01DoubleIn: (v: boolean) => void;\r\n};\r\nconst KEY = \"ndn_user_settings\";\r\n\r\nfunction load(): Pick<\r\n  SettingsState,\r\n  | \"favoriteDouble\"\r\n  | \"callerEnabled\"\r\n  | \"callerVoice\"\r\n  | \"avgMode\"\r\n  | \"callerVolume\"\r\n  | \"speakCheckoutOnly\"\r\n  | \"autoStartOffline\"\r\n  | \"rememberLastOffline\"\r\n  | \"lastOffline\"\r\n  | \"reducedMotion\"\r\n  | \"compactHeader\"\r\n  | \"allowSpectate\"\r\n  | \"cameraScale\"\r\n  | \"cameraAspect\"\r\n  | \"cameraFitMode\"\r\n  | \"calibrationGuide\"\r\n  | \"preserveCalibrationOverlay\"\r\n  | \"preferredCameraId\"\r\n  | \"preferredCameraLabel\"\r\n  | \"preferredCameraLocked\"\r\n  | \"cameraEnabled\"\r\n  | \"hideCameraOverlay\"\r\n  | \"offlineLayout\"\r\n  | \"autoscoreProvider\"\r\n  | \"autoscoreWsUrl\"\r\n  | \"autoCommitMode\"\r\n  | \"textSize\"\r\n  | \"boxSize\"\r\n  | \"matchType\"\r\n  | \"teamAName\"\r\n  | \"teamBName\"\r\n  | \"dartTimerEnabled\"\r\n  | \"dartTimerSeconds\"\r\n  | \"x01DoubleIn\"\r\n> {\r\n  try {\r\n    const raw = localStorage.getItem(KEY);\r\n    if (!raw)\r\n      return {\r\n        favoriteDouble: \"D16\",\r\n        callerEnabled: true,\r\n        callerVoice: \"\",\r\n        callerVolume: 1,\r\n        speakCheckoutOnly: false,\r\n        avgMode: \"all-time\",\r\n        autoStartOffline: false,\r\n        rememberLastOffline: true,\r\n        lastOffline: {\r\n          mode: \"X01\",\r\n          x01Start: 501,\r\n          firstTo: 1,\r\n          aiLevel: \"None\",\r\n        },\r\n        reducedMotion: false,\r\n        compactHeader: false,\r\n        allowSpectate: true,\r\n        cameraScale: 1.0,\r\n        cameraAspect: \"wide\",\r\n        cameraFitMode: \"fit\",\r\n        calibrationGuide: true,\r\n        preferredCameraId: undefined,\r\n        preferredCameraLabel: undefined,\r\n          preserveCalibrationOverlay: true,\r\n        cameraEnabled: true,\r\n        hideCameraOverlay: false,\r\n        offlineLayout: \"modern\",\r\n        autoscoreProvider: \"built-in\",\r\n        autoscoreWsUrl: \"\",\r\n        autoCommitMode: \"wait-for-clear\",\r\n  allowAutocommitInOnline: false,\r\n        textSize: \"medium\",\r\n        boxSize: \"medium\",\r\n        matchType: \"singles\",\r\n        teamAName: \"Team A\",\r\n        teamBName: \"Team B\",\r\n        dartTimerEnabled: false,\r\n        dartTimerSeconds: 10,\r\n        x01DoubleIn: false,\r\n      };\r\n    const j = JSON.parse(raw);\r\n    return {\r\n      favoriteDouble: j.favoriteDouble || \"D16\",\r\n      callerEnabled:\r\n        typeof j.callerEnabled === \"boolean\" ? j.callerEnabled : true,\r\n      callerVoice: j.callerVoice || \"\",\r\n      callerVolume:\r\n        typeof j.callerVolume === \"number\"\r\n          ? Math.max(0, Math.min(1, j.callerVolume))\r\n          : 1,\r\n      speakCheckoutOnly: !!j.speakCheckoutOnly,\r\n      avgMode: j.avgMode === \"24h\" ? \"24h\" : \"all-time\",\r\n      autoStartOffline: !!j.autoStartOffline,\r\n      rememberLastOffline:\r\n        typeof j.rememberLastOffline === \"boolean\"\r\n          ? j.rememberLastOffline\r\n          : true,\r\n      lastOffline:\r\n        j.lastOffline && typeof j.lastOffline === \"object\"\r\n          ? {\r\n              mode: j.lastOffline.mode || \"X01\",\r\n              x01Start: Number(j.lastOffline.x01Start) || 501,\r\n              firstTo: Number(j.lastOffline.firstTo) || 1,\r\n              aiLevel: j.lastOffline.aiLevel || \"None\",\r\n            }\r\n          : { mode: \"X01\", x01Start: 501, firstTo: 1, aiLevel: \"None\" },\r\n      reducedMotion: !!j.reducedMotion,\r\n      compactHeader: !!j.compactHeader,\r\n      allowSpectate:\r\n        typeof j.allowSpectate === \"boolean\" ? j.allowSpectate : true,\r\n      cameraScale:\r\n        typeof j.cameraScale === \"number\" && isFinite(j.cameraScale)\r\n          ? Math.max(0.5, Math.min(1.25, j.cameraScale))\r\n          : 1.0,\r\n      cameraAspect: j.cameraAspect === \"square\" ? \"square\" : \"wide\",\r\n      cameraFitMode:\r\n        j.cameraFitMode === \"fit\" || j.cameraFitMode === \"fill\"\r\n          ? j.cameraFitMode\r\n          : \"fit\",\r\n      autoscoreProvider:\r\n        j.autoscoreProvider === \"external-ws\"\r\n          ? \"external-ws\"\r\n          : j.autoscoreProvider === \"manual\"\r\n            ? \"manual\"\r\n            : \"built-in\",\r\n      autoscoreWsUrl:\r\n        typeof j.autoscoreWsUrl === \"string\" ? j.autoscoreWsUrl : \"\",\r\n      autoCommitMode:\r\n        j.autoCommitMode === \"immediate\" ? \"immediate\" : \"wait-for-clear\",\r\n      allowAutocommitInOnline: !!j.allowAutocommitInOnline,\r\n      calibrationGuide:\r\n        typeof j.calibrationGuide === \"boolean\" ? j.calibrationGuide : true,\r\n      preferredCameraId:\r\n        typeof j.preferredCameraId === \"string\"\r\n          ? j.preferredCameraId\r\n          : undefined,\r\n      preserveCalibrationOverlay:\r\n        typeof j.preserveCalibrationOverlay === \"boolean\"\r\n          ? j.preserveCalibrationOverlay\r\n          : true,\r\n      preferredCameraLabel:\r\n        typeof j.preferredCameraLabel === \"string\"\r\n          ? j.preferredCameraLabel\r\n          : undefined,\r\n      preferredCameraLocked:\r\n        typeof j.preferredCameraLocked === \"boolean\"\r\n          ? j.preferredCameraLocked\r\n          : false,\r\n      cameraEnabled:\r\n        typeof j.cameraEnabled === \"boolean\" ? j.cameraEnabled : true,\r\n      hideCameraOverlay:\r\n        typeof j.hideCameraOverlay === \"boolean\" ? j.hideCameraOverlay : false,\r\n      offlineLayout: j.offlineLayout === \"classic\" ? \"classic\" : \"modern\",\r\n      textSize:\r\n        j.textSize === \"small\" || j.textSize === \"large\"\r\n          ? j.textSize\r\n          : \"medium\",\r\n      boxSize:\r\n        j.boxSize === \"small\" || j.boxSize === \"large\" ? j.boxSize : \"medium\",\r\n      matchType: j.matchType === \"doubles\" ? \"doubles\" : \"singles\",\r\n      teamAName: typeof j.teamAName === \"string\" ? j.teamAName : \"Team A\",\r\n      teamBName: typeof j.teamBName === \"string\" ? j.teamBName : \"Team B\",\r\n      dartTimerEnabled:\r\n        typeof j.dartTimerEnabled === \"boolean\" ? j.dartTimerEnabled : false,\r\n      dartTimerSeconds:\r\n        typeof j.dartTimerSeconds === \"number\" && isFinite(j.dartTimerSeconds)\r\n          ? Math.max(3, Math.min(60, j.dartTimerSeconds))\r\n          : 10,\r\n    x01DoubleIn: typeof j.x01DoubleIn === \"boolean\" ? j.x01DoubleIn : false,\r\n    };\r\n  } catch {\r\n    return {\r\n      favoriteDouble: \"D16\",\r\n      callerEnabled: true,\r\n      callerVoice: \"\",\r\n      callerVolume: 1,\r\n      speakCheckoutOnly: false,\r\n      avgMode: \"all-time\",\r\n      autoStartOffline: false,\r\n      rememberLastOffline: true,\r\n      lastOffline: { mode: \"X01\", x01Start: 501, firstTo: 1, aiLevel: \"None\" },\r\n      reducedMotion: false,\r\n      compactHeader: false,\r\n      allowSpectate: true,\r\n      cameraScale: 1.0,\r\n      cameraAspect: \"wide\",\r\n      cameraFitMode: \"fit\",\r\n      calibrationGuide: true,\r\n      preferredCameraId: undefined,\r\n      preferredCameraLabel: undefined,\r\n      preferredCameraLocked: false,\r\n        preserveCalibrationOverlay: true,\r\n      cameraEnabled: true,\r\n      hideCameraOverlay: false,\r\n      offlineLayout: \"modern\",\r\n      autoscoreProvider: \"built-in\",\r\n      autoscoreWsUrl: \"\",\r\n      autoCommitMode: \"wait-for-clear\",\r\n      textSize: \"medium\",\r\n      boxSize: \"medium\",\r\n      matchType: \"singles\",\r\n      teamAName: \"Team A\",\r\n      teamBName: \"Team B\",\r\n      dartTimerEnabled: false,\r\n      dartTimerSeconds: 10,\r\n      x01DoubleIn: false,\r\n    };\r\n  }\r\n}\r\n\r\nfunction save(partial: Partial<SettingsState>) {\r\n  try {\r\n    const prev = load();\r\n    localStorage.setItem(KEY, JSON.stringify({ ...prev, ...partial }));\r\n  } catch {}\r\n}\r\n\r\nexport const useUserSettings = create<SettingsState>((set, get) => ({\r\n  ...load(),\r\n  setFavoriteDouble: (d) => {\r\n    save({ favoriteDouble: d });\r\n    set({ favoriteDouble: d });\r\n  },\r\n  setCallerEnabled: (v) => {\r\n    save({ callerEnabled: v });\r\n    set({ callerEnabled: v });\r\n  },\r\n  setCallerVoice: (name) => {\r\n    save({ callerVoice: name });\r\n    set({ callerVoice: name });\r\n  },\r\n  setAvgMode: (mode) => {\r\n    save({ avgMode: mode });\r\n    set({ avgMode: mode });\r\n  },\r\n  setCallerVolume: (v) => {\r\n    const vol = Math.max(0, Math.min(1, v));\r\n    save({ callerVolume: vol });\r\n    set({ callerVolume: vol });\r\n  },\r\n  setSpeakCheckoutOnly: (v) => {\r\n    save({ speakCheckoutOnly: v });\r\n    set({ speakCheckoutOnly: v });\r\n  },\r\n  setAutoStartOffline: (v) => {\r\n    save({ autoStartOffline: v });\r\n    set({ autoStartOffline: v });\r\n  },\r\n  setRememberLastOffline: (v) => {\r\n    save({ rememberLastOffline: v });\r\n    set({ rememberLastOffline: v });\r\n  },\r\n  setLastOffline: (cfg) => {\r\n    const prev = load().lastOffline;\r\n    const next = { ...prev, ...cfg };\r\n    save({ lastOffline: next });\r\n    set({ lastOffline: next });\r\n  },\r\n  setReducedMotion: (v) => {\r\n    save({ reducedMotion: v });\r\n    set({ reducedMotion: v });\r\n  },\r\n  setCompactHeader: (v) => {\r\n    save({ compactHeader: v });\r\n    set({ compactHeader: v });\r\n  },\r\n  setAllowSpectate: (v) => {\r\n    save({ allowSpectate: v });\r\n    set({ allowSpectate: v });\r\n  },\r\n  // Temporarily suppress external camera-mode syncing (used while user is interacting with device picker)\r\n  ignorePreferredCameraSync: false,\r\n  setIgnorePreferredCameraSync: (v: boolean) => {\r\n    save({} as any);\r\n    set({ ignorePreferredCameraSync: v });\r\n  },\r\n  setCameraScale: (n) => {\r\n    const s = Math.max(0.5, Math.min(1.25, n));\r\n    save({ cameraScale: s });\r\n    set({ cameraScale: s });\r\n  },\r\n  setCameraAspect: (a) => {\r\n    const v = a === \"square\" ? \"square\" : \"wide\";\r\n    save({ cameraAspect: v });\r\n    set({ cameraAspect: v });\r\n  },\r\n  setCameraFitMode: (m) => {\r\n    const v = m === \"fit\" ? \"fit\" : \"fill\";\r\n    save({ cameraFitMode: v });\r\n    set({ cameraFitMode: v });\r\n  },\r\n  setAutoscoreProvider: (p) => {\r\n    save({ autoscoreProvider: p });\r\n    set({ autoscoreProvider: p });\r\n  },\r\n  setAutoscoreWsUrl: (u) => {\r\n    save({ autoscoreWsUrl: u });\r\n    set({ autoscoreWsUrl: u });\r\n  },\r\n  setAutoCommitMode: (mode) => {\r\n    const v = mode === \"immediate\" ? \"immediate\" : \"wait-for-clear\";\r\n    save({ autoCommitMode: v });\r\n    set({ autoCommitMode: v });\r\n  },\r\n  setAllowAutocommitInOnline: (v) => {\r\n    save({ allowAutocommitInOnline: v } as any);\r\n    set({ allowAutocommitInOnline: v });\r\n  },\r\n  setCalibrationGuide: (v) => {\r\n    save({ calibrationGuide: v });\r\n    set({ calibrationGuide: v });\r\n  },\r\n  setPreserveCalibrationOverlay: (v) => {\r\n    save({ preserveCalibrationOverlay: v } as any);\r\n    set({ preserveCalibrationOverlay: v });\r\n  },\r\n  setPreferredCamera: (id, label, force = false) => {\r\n    try {\r\n      const state = get();\r\n        // Intentionally no logs here to avoid noisy console output in user flows\r\n      if (state.preferredCameraLocked && !force) {\r\n        // Locked: ignore programmatic updates unless explicitly forced by user action\r\n        console.log(\r\n          \"[USERSETTINGS] Camera selection locked and force=false, ignoring update\",\r\n        );\r\n        return;\r\n      }\r\n    } catch {}\r\n  // Avoid redundant writes and accidental clears when values are unchanged.\r\n    try {\r\n      const prev = get();\r\n      if (prev.preferredCameraId === id && prev.preferredCameraLabel === label) {\r\n        // Nothing changed; avoid writing to storage to reduce unexpected updates\r\n        return;\r\n      }\r\n    } catch {}\r\n  // No logging on successful save to keep runtime output quiet\r\n    save({ preferredCameraId: id, preferredCameraLabel: label });\r\n    set({ preferredCameraId: id, preferredCameraLabel: label });\r\n  },\r\n  setPreferredCameraLocked: (v) => {\r\n    save({ preferredCameraLocked: v });\r\n    set({ preferredCameraLocked: v });\r\n  },\r\n  setCameraEnabled: (v) => {\r\n    save({ cameraEnabled: v });\r\n    set({ cameraEnabled: v });\r\n  },\r\n  setHideCameraOverlay: (v) => {\r\n    save({ hideCameraOverlay: v });\r\n    set({ hideCameraOverlay: v });\r\n  },\r\n  setOfflineLayout: (mode) => {\r\n    save({ offlineLayout: mode });\r\n    set({ offlineLayout: mode });\r\n  },\r\n  setTextSize: (size) => {\r\n    save({ textSize: size });\r\n    set({ textSize: size });\r\n  },\r\n  setBoxSize: (size) => {\r\n    save({ boxSize: size });\r\n    set({ boxSize: size });\r\n  },\r\n  setMatchType: (t) => {\r\n    const v = t === \"doubles\" ? \"doubles\" : \"singles\";\r\n    save({ matchType: v });\r\n    set({ matchType: v });\r\n  },\r\n  setTeamAName: (name) => {\r\n    const v = name?.trim() || \"Team A\";\r\n    save({ teamAName: v });\r\n    set({ teamAName: v });\r\n  },\r\n  setTeamBName: (name) => {\r\n    const v = name?.trim() || \"Team B\";\r\n    save({ teamBName: v });\r\n    set({ teamBName: v });\r\n  },\r\n  setDartTimerEnabled: (v) => {\r\n    save({ dartTimerEnabled: v });\r\n    set({ dartTimerEnabled: v });\r\n  },\r\n  setDartTimerSeconds: (n) => {\r\n    const s = Math.max(3, Math.min(60, Math.round(n)));\r\n    save({ dartTimerSeconds: s });\r\n    set({ dartTimerSeconds: s });\r\n  },\r\n  setX01DoubleIn: (v) => {\r\n    save({ x01DoubleIn: v });\r\n    set({ x01DoubleIn: v });\r\n  },\r\n}));\r\n","/**\r\n * Network device discovery utilities for wifi scoring devices\r\n */\r\n\r\n// Web Serial API types\r\ndeclare global {\r\n  interface Navigator {\r\n    serial: Serial;\r\n  }\r\n  interface Serial extends EventTarget {\r\n    getPorts(): Promise<SerialPort[]>;\r\n    requestPort(options?: SerialOptions): Promise<SerialPort>;\r\n  }\r\n  interface SerialPort {\r\n    open(options: SerialOptions): Promise<void>;\r\n    close(): Promise<void>;\r\n    readable: ReadableStream<Uint8Array> | null;\r\n    writable: WritableStream<Uint8Array> | null;\r\n  }\r\n  interface SerialOptions {\r\n    baudRate?: number;\r\n    dataBits?: number;\r\n    stopBits?: number;\r\n    parity?: \"none\" | \"even\" | \"odd\";\r\n    bufferSize?: number;\r\n    flowControl?: \"none\" | \"hardware\";\r\n  }\r\n}\r\n\r\nexport interface NetworkDevice {\r\n  id: string;\r\n  name: string;\r\n  ip: string;\r\n  port: number;\r\n  type: \"omni\" | \"vert\" | \"generic\";\r\n  capabilities: string[];\r\n  status: \"online\" | \"offline\" | \"connecting\";\r\n  connectionType: \"wifi\" | \"usb\";\r\n}\r\n\r\n/**\r\n * USB device interface for serial-connected scoring devices\r\n */\r\nexport interface USBDevice {\r\n  id: string;\r\n  name: string;\r\n  type: \"omni\" | \"vert\" | \"generic\";\r\n  capabilities: string[];\r\n  status: \"online\" | \"offline\" | \"connecting\";\r\n  port: SerialPort | null;\r\n}\r\n\r\n/**\r\n * Discover wifi scoring devices on the local network\r\n */\r\nexport async function discoverNetworkDevices(): Promise<NetworkDevice[]> {\r\n  const devices: NetworkDevice[] = [];\r\n\r\n  try {\r\n    // Get local network info\r\n    const localIPs = await getLocalIPs();\r\n\r\n    for (const localIP of localIPs) {\r\n      // Scan common ports for dart scoring devices\r\n      const scanResults = await scanNetwork(\r\n        localIP,\r\n        [80, 8080, 8787, 8788, 3000, 5000],\r\n      );\r\n\r\n      for (const result of scanResults) {\r\n        const device = await probeDevice(result.ip, result.port);\r\n        if (device) {\r\n          devices.push(device);\r\n        }\r\n      }\r\n    }\r\n  } catch (error) {\r\n    console.error(\"Network discovery failed:\", error);\r\n  }\r\n\r\n  return devices;\r\n}\r\n\r\n/**\r\n * Get local IP addresses\r\n */\r\nasync function getLocalIPs(): Promise<string[]> {\r\n  const ips: string[] = [];\r\n\r\n  try {\r\n    // Try to get local IPs via WebRTC\r\n    const pc = new RTCPeerConnection({ iceServers: [] });\r\n    pc.createDataChannel(\"\");\r\n\r\n    const offer = await pc.createOffer();\r\n    await pc.setLocalDescription(offer);\r\n\r\n    return new Promise((resolve) => {\r\n      const timeout = setTimeout(() => {\r\n        pc.close();\r\n        resolve(ips);\r\n      }, 5000);\r\n\r\n      pc.onicecandidate = (event) => {\r\n        if (event.candidate) {\r\n          const candidate = event.candidate.candidate;\r\n          const ipMatch = candidate.match(/(\\d+\\.\\d+\\.\\d+\\.\\d+)/);\r\n          if (ipMatch && ipMatch[1] && !ips.includes(ipMatch[1])) {\r\n            const ip = ipMatch[1];\r\n            // Only include private IPs\r\n            if (isPrivateIP(ip)) {\r\n              ips.push(ip);\r\n            }\r\n          }\r\n        } else {\r\n          clearTimeout(timeout);\r\n          pc.close();\r\n          resolve(ips);\r\n        }\r\n      };\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Failed to get local IPs:\", error);\r\n    return [\"192.168.1.0\"]; // fallback\r\n  }\r\n}\r\n\r\n/**\r\n * Check if IP is in private range\r\n */\r\nfunction isPrivateIP(ip: string): boolean {\r\n  const parts = ip.split(\".\").map(Number);\r\n  return (\r\n    parts[0] === 10 ||\r\n    (parts[0] === 172 && parts[1] >= 16 && parts[1] <= 31) ||\r\n    (parts[0] === 192 && parts[1] === 168)\r\n  );\r\n}\r\n\r\n/**\r\n * Scan network for open ports\r\n */\r\nasync function scanNetwork(\r\n  localIP: string,\r\n  ports: number[],\r\n): Promise<{ ip: string; port: number }[]> {\r\n  const results: { ip: string; port: number }[] = [];\r\n  const baseIP = localIP.split(\".\").slice(0, 3).join(\".\");\r\n\r\n  // Scan a reasonable range (e.g., .1 to .254)\r\n  const promises = [];\r\n  for (let i = 1; i <= 254; i++) {\r\n    const ip = `${baseIP}.${i}`;\r\n    for (const port of ports) {\r\n      promises.push(checkPort(ip, port));\r\n    }\r\n  }\r\n\r\n  const portResults = await Promise.allSettled(promises);\r\n\r\n  portResults.forEach((result, index) => {\r\n    if (result.status === \"fulfilled\" && result.value) {\r\n      const portIndex = index % ports.length;\r\n      const ipIndex = Math.floor(index / ports.length);\r\n      const ip = `${baseIP}.${ipIndex + 1}`;\r\n      results.push({ ip, port: ports[portIndex] });\r\n    }\r\n  });\r\n\r\n  return results;\r\n}\r\n\r\n/**\r\n * Check if a specific port is open on an IP\r\n */\r\nasync function checkPort(ip: string, port: number): Promise<boolean> {\r\n  try {\r\n    const response = await fetch(`http://${ip}:${port}/`, {\r\n      method: \"HEAD\",\r\n      mode: \"no-cors\",\r\n      signal: AbortSignal.timeout(2000),\r\n    });\r\n    return true;\r\n  } catch {\r\n    return false;\r\n  }\r\n}\r\n\r\n/**\r\n * Probe a device to identify its type and capabilities\r\n */\r\nasync function probeDevice(\r\n  ip: string,\r\n  port: number,\r\n): Promise<NetworkDevice | null> {\r\n  try {\r\n    // Try common endpoints for dart scoring devices\r\n    const endpoints = [\"/\", \"/api/info\", \"/api/status\", \"/camera\", \"/stream\"];\r\n\r\n    for (const endpoint of endpoints) {\r\n      try {\r\n        const response = await fetch(`http://${ip}:${port}${endpoint}`, {\r\n          method: \"GET\",\r\n          signal: AbortSignal.timeout(3000),\r\n        });\r\n\r\n        if (response.ok) {\r\n          const contentType = response.headers.get(\"content-type\") || \"\";\r\n          const text = await response.text();\r\n\r\n          // Check for OMNI device\r\n          if (\r\n            text.includes(\"OMNI\") ||\r\n            text.includes(\"omni\") ||\r\n            endpoint.includes(\"omni\")\r\n          ) {\r\n            return {\r\n              id: `omni-${ip}-${port}`,\r\n              name: `OMNI Camera (${ip})`,\r\n              ip,\r\n              port,\r\n              type: \"omni\",\r\n              capabilities: [\"video\", \"calibration\"],\r\n              status: \"online\",\r\n              connectionType: \"wifi\",\r\n            };\r\n          }\r\n\r\n          // Check for VERT device\r\n          if (\r\n            text.includes(\"VERT\") ||\r\n            text.includes(\"vert\") ||\r\n            endpoint.includes(\"vert\")\r\n          ) {\r\n            return {\r\n              id: `vert-${ip}-${port}`,\r\n              name: `VERT Camera (${ip})`,\r\n              ip,\r\n              port,\r\n              type: \"vert\",\r\n              capabilities: [\"video\", \"calibration\"],\r\n              status: \"online\",\r\n              connectionType: \"wifi\",\r\n            };\r\n          }\r\n\r\n          // Check for generic video streaming device\r\n          if (\r\n            contentType.includes(\"video\") ||\r\n            text.includes(\"stream\") ||\r\n            endpoint === \"/stream\"\r\n          ) {\r\n            return {\r\n              id: `generic-${ip}-${port}`,\r\n              name: `Network Camera (${ip})`,\r\n              ip,\r\n              port,\r\n              type: \"generic\",\r\n              capabilities: [\"video\"],\r\n              status: \"online\",\r\n              connectionType: \"wifi\",\r\n            };\r\n          }\r\n        }\r\n      } catch {\r\n        // Continue to next endpoint\r\n      }\r\n    }\r\n  } catch (error) {\r\n    console.error(`Failed to probe device ${ip}:${port}:`, error);\r\n  }\r\n\r\n  return null;\r\n}\r\n\r\n/**\r\n * Discover USB scoring devices connected via serial\r\n */\r\nexport async function discoverUSBDevices(): Promise<USBDevice[]> {\r\n  const devices: USBDevice[] = [];\r\n\r\n  try {\r\n    // Check if Web Serial API is supported\r\n    if (!(\"serial\" in navigator)) {\r\n      console.warn(\"Web Serial API not supported in this browser\");\r\n      return devices;\r\n    }\r\n\r\n    // Get already paired ports\r\n    const ports = await navigator.serial.getPorts();\r\n\r\n    for (const port of ports) {\r\n      const device = await probeUSBDevice(port);\r\n      if (device) {\r\n        devices.push(device);\r\n      }\r\n    }\r\n\r\n    // Also try to request a new port (this will show user selection dialog)\r\n    // Note: This is optional and will be handled separately in the UI\r\n  } catch (error) {\r\n    console.error(\"USB device discovery failed:\", error);\r\n  }\r\n\r\n  return devices;\r\n}\r\n\r\n/**\r\n * Request user to select a USB device\r\n */\r\nexport async function requestUSBDevice(): Promise<USBDevice | null> {\r\n  try {\r\n    if (!(\"serial\" in navigator)) {\r\n      alert(\r\n        \"Web Serial API not supported in this browser. Please use a compatible browser like Chrome or Edge.\",\r\n      );\r\n      return null;\r\n    }\r\n\r\n    const port = await navigator.serial.requestPort();\r\n    return await probeUSBDevice(port);\r\n  } catch (error) {\r\n    if ((error as any).name !== \"NotFoundError\") {\r\n      console.error(\"USB device request failed:\", error);\r\n    }\r\n    return null;\r\n  }\r\n}\r\n\r\n/**\r\n * Probe a USB serial port to identify the device type\r\n */\r\nasync function probeUSBDevice(port: SerialPort): Promise<USBDevice | null> {\r\n  try {\r\n    // Open the port with common settings for dart scoring devices\r\n    await port.open({\r\n      baudRate: 9600,\r\n      dataBits: 8,\r\n      stopBits: 1,\r\n      parity: \"none\",\r\n    });\r\n\r\n    // Try to read some data to identify the device\r\n    const reader = port.readable?.getReader();\r\n    if (reader) {\r\n      try {\r\n        // Set a timeout for reading\r\n        const timeout = setTimeout(() => reader.cancel(), 2000);\r\n\r\n        const { value, done } = await reader.read();\r\n        clearTimeout(timeout);\r\n\r\n        if (!done && value) {\r\n          const text = new TextDecoder().decode(value);\r\n\r\n          // Check for OMNI device\r\n          if (text.includes(\"OMNI\") || text.includes(\"omni\")) {\r\n            reader.releaseLock();\r\n            return {\r\n              id: `usb-omni-${Date.now()}`,\r\n              name: \"OMNI Camera (USB)\",\r\n              type: \"omni\",\r\n              capabilities: [\"video\", \"calibration\"],\r\n              status: \"online\",\r\n              port,\r\n            };\r\n          }\r\n\r\n          // Check for VERT device\r\n          if (text.includes(\"VERT\") || text.includes(\"vert\")) {\r\n            reader.releaseLock();\r\n            return {\r\n              id: `usb-vert-${Date.now()}`,\r\n              name: \"VERT Camera (USB)\",\r\n              type: \"vert\",\r\n              capabilities: [\"video\", \"calibration\"],\r\n              status: \"online\",\r\n              port,\r\n            };\r\n          }\r\n        }\r\n      } catch {\r\n        // Continue\r\n      } finally {\r\n        try {\r\n          reader.releaseLock();\r\n        } catch {}\r\n      }\r\n    }\r\n\r\n    // If we can't identify, assume it's a generic device\r\n    return {\r\n      id: `usb-generic-${Date.now()}`,\r\n      name: \"USB Scoring Device\",\r\n      type: \"generic\",\r\n      capabilities: [\"video\"],\r\n      status: \"online\",\r\n      port,\r\n    };\r\n  } catch (error) {\r\n    console.error(\"Failed to probe USB device:\", error);\r\n    return null;\r\n  }\r\n}\r\n\r\n/**\r\n * Connect to a network device and get video stream\r\n */\r\nexport async function connectToNetworkDevice(\r\n  device: NetworkDevice,\r\n): Promise<MediaStream | null> {\r\n  try {\r\n    // For now, assume devices provide an MJPEG or HLS stream\r\n    // This would need to be adapted based on the actual device API\r\n    const streamUrl = `http://${device.ip}:${device.port}/stream`;\r\n\r\n    // Create a video element to capture the stream\r\n    const video = document.createElement(\"video\");\r\n    video.src = streamUrl;\r\n    video.crossOrigin = \"anonymous\";\r\n\r\n    return new Promise((resolve, reject) => {\r\n      video.onloadeddata = () => {\r\n        const canvas = document.createElement(\"canvas\");\r\n        const ctx = canvas.getContext(\"2d\")!;\r\n        canvas.width = video.videoWidth;\r\n        canvas.height = video.videoHeight;\r\n\r\n        // Create a MediaStream from the video\r\n        const stream = canvas.captureStream(30); // 30 FPS\r\n\r\n        const drawFrame = () => {\r\n          if (video.readyState >= 2) {\r\n            ctx.drawImage(video, 0, 0);\r\n          }\r\n          requestAnimationFrame(drawFrame);\r\n        };\r\n        drawFrame();\r\n\r\n        resolve(stream);\r\n      };\r\n\r\n      video.onerror = () => reject(new Error(\"Failed to load video stream\"));\r\n      video.load();\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Failed to connect to network device:\", error);\r\n    return null;\r\n  }\r\n}\r\n\r\n/**\r\n * Connect to a USB device and get video stream\r\n */\r\nexport async function connectToUSBDevice(\r\n  device: USBDevice,\r\n): Promise<MediaStream | null> {\r\n  try {\r\n    if (!device.port) {\r\n      throw new Error(\"No serial port available\");\r\n    }\r\n\r\n    // For USB devices, we assume they provide video through a companion app or driver\r\n    // This is a placeholder - actual implementation would depend on the device protocol\r\n    console.log(\"USB device connection not fully implemented yet\");\r\n    return null;\r\n  } catch (error) {\r\n    console.error(\"Failed to connect to USB device:\", error);\r\n    return null;\r\n  }\r\n}\r\n","import { create } from \"zustand\";\r\n\r\nexport type VisitAudit = {\r\n  ts: number;\r\n  mode: string;\r\n  darts: number;\r\n  visitTotal: number;\r\n  preOpenDarts?: number;\r\n  preRemaining?: number;\r\n  postRemaining?: number;\r\n  bust?: boolean;\r\n  finish?: boolean;\r\n  threeDartAvg?: number;\r\n};\r\n\r\ntype CalibrationAudit = {\r\n  hasHomography: boolean;\r\n  imageSize?: { w: number; h: number } | null;\r\n  lastUpdated?: number;\r\n};\r\n\r\ntype AuditState = {\r\n  // Rolling buffer of recent visits\r\n  recent: VisitAudit[];\r\n  // Aggregates\r\n  totals: {\r\n    visits: number;\r\n    darts: number;\r\n    points: number;\r\n    finishes: number;\r\n    busts: number;\r\n    byMode: Record<string, { visits: number; darts: number; points: number }>;\r\n  };\r\n  calibration: CalibrationAudit;\r\n  recordVisit: (\r\n    mode: string,\r\n    darts: number,\r\n    visitTotal: number,\r\n    meta?: Partial<VisitAudit>,\r\n  ) => void;\r\n  setCalibrationStatus: (c: Partial<CalibrationAudit>) => void;\r\n  reset: () => void;\r\n};\r\n\r\nexport const useAudit = create<AuditState>((set, get) => ({\r\n  recent: [],\r\n  totals: { visits: 0, darts: 0, points: 0, finishes: 0, busts: 0, byMode: {} },\r\n  calibration: {\r\n    hasHomography: false,\r\n    imageSize: null,\r\n    lastUpdated: undefined,\r\n  },\r\n  recordVisit: (mode, darts, visitTotal, meta) =>\r\n    set((state) => {\r\n      const ts = Date.now();\r\n      const item: VisitAudit = {\r\n        ts,\r\n        mode,\r\n        darts,\r\n        visitTotal,\r\n        preOpenDarts: meta?.preOpenDarts,\r\n        preRemaining: meta?.preRemaining,\r\n        postRemaining: meta?.postRemaining,\r\n        bust: meta?.bust,\r\n        finish: meta?.finish,\r\n        threeDartAvg: meta?.threeDartAvg,\r\n      };\r\n      const recent = [...state.recent, item].slice(-50);\r\n      const totals = { ...state.totals };\r\n      totals.visits += 1;\r\n      totals.darts += darts;\r\n      totals.points += visitTotal;\r\n      if (item.finish) totals.finishes += 1;\r\n      if (item.bust) totals.busts += 1;\r\n      const bm = totals.byMode[mode] || { visits: 0, darts: 0, points: 0 };\r\n      bm.visits += 1;\r\n      bm.darts += darts;\r\n      bm.points += visitTotal;\r\n      totals.byMode[mode] = bm;\r\n      // Console surface for quick verification without UI changes\r\n      try {\r\n        const tag = item.finish ? \"FINISH\" : item.bust ? \"BUST\" : \"VISIT\";\r\n        const info = {\r\n          mode,\r\n          darts,\r\n          visitTotal,\r\n          preOpenDarts: item.preOpenDarts ?? 0,\r\n          preRemaining: item.preRemaining,\r\n          postRemaining: item.postRemaining,\r\n          threeDartAvg: item.threeDartAvg,\r\n        } as any;\r\n        console.info(`[Audit:${tag}]`, info);\r\n      } catch {}\r\n      // Persist recent visits to localStorage so Home can show recent across reloads\r\n      try {\r\n        localStorage.setItem(\"ndn_audit_recent\", JSON.stringify(recent));\r\n      } catch {}\r\n      return { ...state, recent, totals };\r\n    }),\r\n  setCalibrationStatus: (c) =>\r\n    set((state) => {\r\n      const updated: CalibrationAudit = {\r\n        hasHomography: c.hasHomography ?? state.calibration.hasHomography,\r\n        imageSize:\r\n          c.imageSize === undefined ? state.calibration.imageSize : c.imageSize,\r\n        lastUpdated: Date.now(),\r\n      };\r\n      try {\r\n        console.info(\"[Audit:Calibration]\", updated);\r\n      } catch {}\r\n      return { ...state, calibration: updated };\r\n    }),\r\n  reset: () =>\r\n    set({\r\n      recent: [],\r\n      totals: {\r\n        visits: 0,\r\n        darts: 0,\r\n        points: 0,\r\n        finishes: 0,\r\n        busts: 0,\r\n        byMode: {},\r\n      },\r\n      calibration: {\r\n        hasHomography: false,\r\n        imageSize: null,\r\n        lastUpdated: undefined,\r\n      },\r\n    }),\r\n}));\r\n\r\n// Expose a tiny debug hook on window for manual checks when needed\r\ntry {\r\n  // @ts-ignore\r\n  if (typeof window !== \"undefined\")\r\n    (window as any).__NDN_AUDIT__ = {\r\n      get: () => useAudit.getState(),\r\n      subscribe: useAudit.subscribe,\r\n      reset: () => useAudit.getState().reset(),\r\n    };\r\n} catch {}\r\n\r\n// Initialize persisted recent visits if present\r\ntry {\r\n  if (typeof window !== \"undefined\") {\r\n    const raw = localStorage.getItem(\"ndn_audit_recent\");\r\n    if (raw) {\r\n      const arr = JSON.parse(raw);\r\n      if (Array.isArray(arr) && arr.length) {\r\n        useAudit.setState((s) => ({ ...s, recent: arr.slice(-50) }));\r\n      }\r\n    }\r\n  }\r\n} catch {}\r\n","import { create } from \"zustand\";\r\nimport { useAudit } from \"./audit\";\r\n\r\nexport type ThrowVisit = {\r\n  darts: number;\r\n  score: number;\r\n  preOpenDarts?: number; // exclude from avg in Double-In\r\n  doubleWindowDarts?: number; // darts thrown while remaining <= 50 (double-out window) in this visit\r\n  finishedByDouble?: boolean; // visit ended the leg with a double or inner bull\r\n  visitTotal?: number; // convenience to detect 180s and summaries\r\n};\r\nexport type Leg = {\r\n  visits: ThrowVisit[];\r\n  totalScoreStart: number; // e.g., 501\r\n  totalScoreRemaining: number;\r\n  dartsThrown: number;\r\n  finished: boolean;\r\n  checkoutScore: number | null; // score taken on final visit to finish leg\r\n  startTime: number;\r\n  endTime?: number;\r\n};\r\n\r\nexport type Player = {\r\n  id: string;\r\n  name: string;\r\n  legsWon: number;\r\n  legs: Leg[];\r\n  bestThreeDartAvg?: number;\r\n  worstThreeDartAvg?: number;\r\n  bestNineDart?: { darts: number; timestamp: number };\r\n  bestCheckout?: number;\r\n  currentThreeDartAvg?: number; // Live stat that updates after every 3 darts\r\n};\r\n\r\nexport type MatchState = {\r\n  roomId: string;\r\n  players: Player[];\r\n  currentPlayerIdx: number;\r\n  startingScore: number;\r\n  inProgress: boolean;\r\n  bestLegThisMatch?: { playerId: string; darts: number; timestamp: number };\r\n};\r\n\r\nfunction calcThreeDartAvg(leg: Leg): number {\r\n  if (leg.dartsThrown === 0) return 0;\r\n  const scored = leg.totalScoreStart - leg.totalScoreRemaining;\r\n  return (scored / leg.dartsThrown) * 3;\r\n}\r\n\r\nfunction finishedLegStats(leg: Leg) {\r\n  // compute 3-dart avg, was it a 9-dart (or lowest darts)?\r\n  const avg = calcThreeDartAvg(leg);\r\n  const isCompleted = leg.finished;\r\n  return {\r\n    avg,\r\n    isCompleted,\r\n    darts: leg.dartsThrown,\r\n    checkout: leg.checkoutScore ?? 0,\r\n  };\r\n}\r\n\r\nfunction updatePlayerEndOfGameStats(player: Player) {\r\n  if (player.legs.length === 0) return;\r\n  const avgs: number[] = [];\r\n  let bestNine: { darts: number; timestamp: number } | undefined;\r\n  let bestCheckout = player.bestCheckout ?? 0;\r\n\r\n  for (const leg of player.legs) {\r\n    if (!leg.finished) continue;\r\n    const st = finishedLegStats(leg);\r\n    avgs.push(st.avg);\r\n    // best \"9-dart leg\" meaning fewest darts; if tie pick earliest\r\n    if (\r\n      !bestNine ||\r\n      st.darts < bestNine.darts ||\r\n      (st.darts === bestNine.darts && (leg.endTime ?? 0) < bestNine.timestamp)\r\n    ) {\r\n      bestNine = { darts: st.darts, timestamp: leg.endTime ?? Date.now() };\r\n    }\r\n    if (st.checkout > bestCheckout) bestCheckout = st.checkout;\r\n  }\r\n\r\n  if (avgs.length) {\r\n    player.bestThreeDartAvg = Math.max(...avgs);\r\n    player.worstThreeDartAvg = Math.min(...avgs);\r\n  }\r\n  if (bestNine) player.bestNineDart = bestNine;\r\n  player.bestCheckout = bestCheckout;\r\n}\r\n\r\nexport type Actions = {\r\n  newMatch: (players: string[], startingScore: number, roomId?: string) => void;\r\n  addVisit: (\r\n    score: number,\r\n    darts: number,\r\n    meta?: {\r\n      preOpenDarts?: number;\r\n      doubleWindowDarts?: number;\r\n      finishedByDouble?: boolean;\r\n      visitTotal?: number;\r\n    },\r\n  ) => void;\r\n  undoVisit: () => void;\r\n  endLeg: (checkoutScore: number) => void;\r\n  nextPlayer: () => void;\r\n  endGame: () => void;\r\n  importState: (state: MatchState) => void;\r\n  setPlayerCurrentAverage: (playerIndex: number, avg: number) => void;\r\n};\r\n\r\nexport const useMatch = create<MatchState & Actions>((set, get) => ({\r\n  roomId: \"\",\r\n  players: [],\r\n  currentPlayerIdx: 0,\r\n  startingScore: 501,\r\n  inProgress: false,\r\n\r\n  newMatch: (playerNames, startingScore, roomId = \"\") =>\r\n    set(() => {\r\n      const players = playerNames.map(\r\n        (name, i) =>\r\n          ({\r\n            id: `${i}`,\r\n            name,\r\n            legsWon: 0,\r\n            legs: [],\r\n          }) as Player,\r\n      );\r\n      console.debug('[useMatch] newMatch', playerNames, startingScore, roomId);\r\n      return {\r\n        players,\r\n        currentPlayerIdx: 0,\r\n        startingScore,\r\n        inProgress: true,\r\n        roomId,\r\n        bestLegThisMatch: undefined,\r\n      };\r\n    }),\r\n\r\n  addVisit: (score, darts, meta) =>\r\n    set((state) => {\r\n      console.debug('[useMatch] addVisit', { score, darts, inProgress: state.inProgress, currentPlayerIdx: state.currentPlayerIdx, players: state.players.length });\r\n      if (!state.inProgress) return state;\r\n      const p = state.players[state.currentPlayerIdx];\r\n      // ensure a current leg exists\r\n      let leg = p.legs[p.legs.length - 1];\r\n      if (!leg || leg.finished) {\r\n        leg = {\r\n          visits: [],\r\n          totalScoreStart: state.startingScore,\r\n          totalScoreRemaining: state.startingScore,\r\n          dartsThrown: 0,\r\n          finished: false,\r\n          checkoutScore: null,\r\n          startTime: Date.now(),\r\n        };\r\n        p.legs.push(leg);\r\n      }\r\n      const preRem = leg.totalScoreRemaining;\r\n      const postRem = Math.max(0, preRem - score);\r\n      leg.visits.push({\r\n        darts,\r\n        score,\r\n        preOpenDarts: meta?.preOpenDarts,\r\n        doubleWindowDarts: meta?.doubleWindowDarts,\r\n        finishedByDouble: meta?.finishedByDouble,\r\n        visitTotal: meta?.visitTotal ?? score,\r\n      });\r\n      leg.dartsThrown += darts;\r\n      leg.totalScoreRemaining = postRem;\r\n      // Audit record (best-effort; ignore failures)\r\n      try {\r\n        const bust = score === 0 && darts > 0 && postRem === preRem;\r\n        const finish = postRem === 0;\r\n        const avgPayload: any = {};\r\n        if (leg.dartsThrown % 3 === 0) {\r\n          const avg = calcThreeDartAvg(leg);\r\n          if (Math.abs((p.currentThreeDartAvg ?? 0) - avg) > 0.0001) {\r\n            p.currentThreeDartAvg = avg;\r\n          }\r\n          avgPayload.threeDartAvg = avg;\r\n        }\r\n  useAudit.getState().recordVisit(\"x01-match\", darts, score, {\r\n          preOpenDarts: meta?.preOpenDarts ?? 0,\r\n          preRemaining: preRem,\r\n          postRemaining: postRem,\r\n          ...avgPayload,\r\n          bust,\r\n          finish,\r\n        });\r\n      } catch {}\r\n      return { ...state };\r\n    }),\r\n\r\n  undoVisit: () =>\r\n    set((state) => {\r\n      const p = state.players[state.currentPlayerIdx];\r\n      const leg = p.legs[p.legs.length - 1];\r\n      if (!leg || leg.finished || leg.visits.length === 0) return state;\r\n      const last = leg.visits.pop()!;\r\n      leg.dartsThrown -= last.darts;\r\n      leg.totalScoreRemaining += last.score;\r\n      return { ...state };\r\n    }),\r\n\r\n  endLeg: (checkoutScore) =>\r\n    set((state) => {\r\n      const p = state.players[state.currentPlayerIdx];\r\n      const leg = p.legs[p.legs.length - 1];\r\n      if (!leg || leg.finished) return state;\r\n      leg.finished = true;\r\n      leg.checkoutScore = checkoutScore;\r\n      leg.endTime = Date.now();\r\n      if (leg.totalScoreRemaining === 0) {\r\n        p.legsWon += 1;\r\n        // Check if this leg is the new best for this match (fewest darts)\r\n        const best = state.bestLegThisMatch;\r\n        if (!best || leg.dartsThrown < best.darts) {\r\n          state.bestLegThisMatch = {\r\n            playerId: p.id,\r\n            darts: leg.dartsThrown,\r\n            timestamp: leg.endTime,\r\n          };\r\n        }\r\n      }\r\n      return { ...state };\r\n    }),\r\n\r\n  nextPlayer: () =>\r\n    set((state) => ({\r\n      ...state,\r\n      currentPlayerIdx: (state.currentPlayerIdx + 1) % state.players.length,\r\n    })),\r\n\r\n  endGame: () =>\r\n    set((state) => {\r\n      // Only now compute best/worst 3-dart, best 9-dart, best checkout\r\n      for (const p of state.players) updatePlayerEndOfGameStats(p);\r\n      return { ...state, inProgress: false };\r\n    }),\r\n\r\n  importState: (newState) => set(() => ({ ...newState })),\r\n  setPlayerCurrentAverage: (playerIndex, avg) =>\r\n    set((state) => {\r\n      const p = state.players[playerIndex];\r\n      if (!p) return state;\r\n      if (Math.abs((p.currentThreeDartAvg ?? 0) - avg) > 0.0001) {\r\n        p.currentThreeDartAvg = avg;\r\n        return { ...state };\r\n      }\r\n      return state;\r\n    }),\r\n}));\r\n","import React, {\r\n  createContext,\r\n  useCallback,\r\n  useContext,\r\n  useEffect,\r\n  useMemo,\r\n  useRef,\r\n  useState,\r\n  type ReactNode,\r\n} from \"react\";\r\n\r\ntype WSMessage = any;\r\n\r\ntype WSStatus = \"connecting\" | \"connected\" | \"disconnected\";\r\ntype WSContextType = {\r\n  connected: boolean;\r\n  status: WSStatus;\r\n  send: (msg: WSMessage) => void;\r\n  addListener: (fn: (data: WSMessage) => void) => () => void;\r\n  reconnect: () => void;\r\n};\r\n\r\nconst WSContext = createContext<WSContextType | null>(null);\r\n\r\nexport function WSProvider({ children }: { children: ReactNode }) {\r\n  const [connected, setConnected] = useState(false);\r\n  const [status, setStatus] = useState<WSStatus>(\"connecting\");\r\n  const wsRef = useRef<WebSocket | null>(null);\r\n  const listenersRef = useRef(new Set<(data: WSMessage) => void>());\r\n  const shouldReconnectRef = useRef(true);\r\n  const attemptsRef = useRef(0);\r\n  const timerRef = useRef<ReturnType<typeof setTimeout> | null>(null);\r\n  const heartbeatRef = useRef<ReturnType<typeof setInterval> | null>(null);\r\n\r\n  const endpointsRef = useRef<string[] | null>(null);\r\n  const endpointIdxRef = useRef(0);\r\n  const debug = false;\r\n\r\n  const ensureEndpoints = () => {\r\n    if (endpointsRef.current) return endpointsRef.current;\r\n    const envUrl = (import.meta as any).env?.VITE_WS_URL as string | undefined;\r\n    if (envUrl && envUrl.length > 0) {\r\n      const normalized = envUrl.endsWith(\"/ws\")\r\n        ? envUrl\r\n        : envUrl.replace(/\\/$/, \"\") + \"/ws\";\r\n      endpointsRef.current = [normalized];\r\n      return endpointsRef.current;\r\n    }\r\n    const proto = window.location.protocol === \"https:\" ? \"wss\" : \"ws\";\r\n    const host = window.location.hostname;\r\n    const sameOrigin = `${proto}://${window.location.host}`; // includes port if present\r\n    // Candidate endpoints: prefer same-origin first (works when server serves SPA),\r\n    // then common local ports for dev fallbacks.\r\n    const bases = [\r\n      sameOrigin + \"/ws\",\r\n      `${proto}://${host}/ws`,\r\n      `${proto}://${host}:8787/ws`,\r\n      `${proto}://${host}:3000/ws`,\r\n    ];\r\n    // Deduplicate\r\n    endpointsRef.current = Array.from(new Set(bases));\r\n    return endpointsRef.current;\r\n  };\r\n\r\n  const rotateEndpoint = () => {\r\n    const eps = ensureEndpoints();\r\n    endpointIdxRef.current = (endpointIdxRef.current + 1) % eps.length;\r\n    return eps[endpointIdxRef.current];\r\n  };\r\n\r\n  const currentEndpoint = () => {\r\n    const eps = ensureEndpoints();\r\n    return eps[endpointIdxRef.current] || eps[0];\r\n  };\r\n\r\n  const connect = useCallback(() => {\r\n    if (\r\n      wsRef.current &&\r\n      (wsRef.current.readyState === WebSocket.OPEN ||\r\n        wsRef.current.readyState === WebSocket.CONNECTING)\r\n    )\r\n      return;\r\n    setStatus(\"connecting\");\r\n    const base = currentEndpoint();\r\n    const url = `${base}`;\r\n    if (debug) console.log(\"[WS] connecting to\", url);\r\n    const ws = new WebSocket(url);\r\n    wsRef.current = ws;\r\n    ws.onopen = () => {\r\n      setConnected(true);\r\n      setStatus(\"connected\");\r\n      attemptsRef.current = 0;\r\n      // start heartbeat\r\n      if (heartbeatRef.current) clearInterval(heartbeatRef.current);\r\n      heartbeatRef.current = setInterval(() => {\r\n        try {\r\n          wsRef.current?.readyState === WebSocket.OPEN &&\r\n            wsRef.current?.send(\r\n              JSON.stringify({ type: \"ping\", t: Date.now() }),\r\n            );\r\n        } catch {}\r\n      }, 20000);\r\n      if (debug) console.log(\"[WS] connected\");\r\n    };\r\n    ws.onmessage = (ev) => {\r\n      try {\r\n        const data = JSON.parse(ev.data);\r\n        listenersRef.current.forEach((fn) => {\r\n          try {\r\n            fn(data);\r\n          } catch {}\r\n        });\r\n      } catch {}\r\n    };\r\n    ws.onerror = () => {\r\n      if (debug) console.log(\"[WS] socket error on\", currentEndpoint());\r\n    };\r\n    ws.onclose = () => {\r\n      setConnected(false);\r\n      setStatus(\"disconnected\");\r\n      if (heartbeatRef.current) {\r\n        clearInterval(heartbeatRef.current);\r\n        heartbeatRef.current = null;\r\n      }\r\n      if (!shouldReconnectRef.current) return;\r\n      const attempt = (attemptsRef.current || 0) + 1;\r\n      attemptsRef.current = attempt;\r\n      // rotate endpoint every 2 failed attempts for broader coverage\r\n      if (attempt % 2 === 0) rotateEndpoint();\r\n      if (debug)\r\n        console.log(\r\n          \"[WS] closed. attempt\",\r\n          attempt,\r\n          \"next endpoint\",\r\n          currentEndpoint(),\r\n        );\r\n      const base = 1000 * Math.pow(2, attempt - 1);\r\n      const jitter = Math.floor(Math.random() * 1000);\r\n      let delay = Math.min(30000, base + jitter);\r\n      // First retry should be immediate for instant reconnect UX\r\n      if (attempt === 1) delay = 0;\r\n      if (timerRef.current) clearTimeout(timerRef.current);\r\n      if (delay === 0) {\r\n        connect();\r\n      } else {\r\n        timerRef.current = setTimeout(connect, delay);\r\n      }\r\n    };\r\n  }, []);\r\n\r\n  const reconnect = useCallback(() => {\r\n    try {\r\n      // Prevent auto-retry logic from racing while we recreate\r\n      shouldReconnectRef.current = false;\r\n      if (timerRef.current) {\r\n        clearTimeout(timerRef.current);\r\n        timerRef.current = null;\r\n      }\r\n      if (heartbeatRef.current) {\r\n        clearInterval(heartbeatRef.current);\r\n        heartbeatRef.current = null;\r\n      }\r\n      try {\r\n        wsRef.current?.close();\r\n      } catch {}\r\n      wsRef.current = null;\r\n    } catch {}\r\n    // Reset counters and allow reconnect\r\n    attemptsRef.current = 0;\r\n    shouldReconnectRef.current = true;\r\n    setStatus(\"connecting\");\r\n    setConnected(false);\r\n    // Attempt immediate connect\r\n    connect();\r\n  }, [connect]);\r\n\r\n  useEffect(() => {\r\n    shouldReconnectRef.current = true;\r\n    connect();\r\n    const beforeUnload = () => {\r\n      shouldReconnectRef.current = false;\r\n      try {\r\n        wsRef.current?.close();\r\n      } catch {}\r\n    };\r\n    window.addEventListener(\"beforeunload\", beforeUnload);\r\n    const onVis = () => {\r\n      if (document.visibilityState === \"visible\") {\r\n        // nudge reconnect if needed\r\n        if (!connected) connect();\r\n      }\r\n    };\r\n    document.addEventListener(\"visibilitychange\", onVis);\r\n    window.addEventListener(\"online\", connect);\r\n    return () => {\r\n      shouldReconnectRef.current = false;\r\n      if (timerRef.current) clearTimeout(timerRef.current);\r\n      if (heartbeatRef.current) clearInterval(heartbeatRef.current);\r\n      try {\r\n        wsRef.current?.close();\r\n      } catch {}\r\n      document.removeEventListener(\"visibilitychange\", onVis);\r\n      window.removeEventListener(\"online\", connect);\r\n      window.removeEventListener(\"beforeunload\", beforeUnload);\r\n    };\r\n  }, [connect]);\r\n\r\n  const send = useCallback((msg: WSMessage) => {\r\n    try {\r\n      if (wsRef.current && wsRef.current.readyState === WebSocket.OPEN) {\r\n        wsRef.current.send(typeof msg === \"string\" ? msg : JSON.stringify(msg));\r\n      }\r\n    } catch {}\r\n  }, []);\r\n\r\n  const addListener = useCallback((fn: (data: WSMessage) => void) => {\r\n    listenersRef.current.add(fn);\r\n    return () => {\r\n      listenersRef.current.delete(fn);\r\n    };\r\n  }, []);\r\n\r\n  const value = useMemo(\r\n    () => ({ connected, status, send, addListener, reconnect }),\r\n    [connected, status, send, addListener, reconnect],\r\n  );\r\n  return <WSContext.Provider value={value}>{children}</WSContext.Provider>;\r\n}\r\n\r\nexport function useWS() {\r\n  const ctx = useContext(WSContext);\r\n  if (!ctx) throw new Error(\"useWS must be used within WSProvider\");\r\n  return ctx;\r\n}\r\n","import React, {\r\n  useCallback,\r\n  useEffect,\r\n  useMemo,\r\n  useRef,\r\n  useState,\r\n} from \"react\";\r\nimport DartLoader from \"./DartLoader\";\r\nimport { DartDetector } from \"../utils/dartDetector\";\r\n\r\nimport { useCalibration } from \"../store/calibration\";\r\nimport { useCameraSession } from \"../store/cameraSession\";\r\nimport {\r\n  BoardRadii,\r\n  canonicalRimTargets,\r\n  computeHomographyDLT,\r\n  drawCross,\r\n  drawPolyline,\r\n  rmsError,\r\n  sampleRing,\r\n  refinePointsSobel,\r\n  applyHomography,\r\n  imageToBoard,\r\n  scoreAtBoardPoint,\r\n  type Homography,\r\n  type Point,\r\n} from \"../utils/vision\";\r\nimport {\r\n  detectMarkersFromCanvas,\r\n  MARKER_TARGETS,\r\n  markerIdToMatrix,\r\n  type MarkerDetection,\r\n} from \"../utils/markerCalibration\";\r\nimport {\r\n  detectBoard,\r\n  refineRingDetection,\r\n  type BoardDetectionResult,\r\n} from \"../utils/boardDetection\";\r\nimport { useUserSettings } from \"../store/userSettings\";\r\nimport {\r\n  discoverNetworkDevices,\r\n  connectToNetworkDevice,\r\n  type NetworkDevice,\r\n} from \"../utils/networkDevices\";\r\nimport { apiFetch } from \"../utils/api\";\r\nimport { useMatch } from \"../store/match\";\r\nimport { useWS } from \"./WSProvider\";\r\n\r\ntype Phase = \"idle\" | \"camera\" | \"capture\" | \"select\" | \"computed\";\r\ntype CamMode = \"local\" | \"phone\" | \"wifi\";\r\n\r\nconst CALIBRATION_POINT_LABELS = [\"D20\", \"D6\", \"D3\", \"D11\"] as const;\r\nconst REQUIRED_POINT_COUNT = CALIBRATION_POINT_LABELS.length;\r\n\r\n// Center-logo QR helpers moved to ../utils/qr\r\n\r\nexport default function Calibrator() {\r\n  const videoRef = useRef<HTMLVideoElement>(null);\r\n  const canvasRef = useRef<HTMLCanvasElement>(null);\r\n  const overlayRef = useRef<HTMLCanvasElement>(null);\r\n  const fileInputRef = useRef<HTMLInputElement>(null);\r\n  // Camera diagnostics state\r\n  const [cameraPerm, setCameraPerm] = useState<\r\n    \"unknown\" | \"granted\" | \"denied\" | \"prompt\" | \"unsupported\"\r\n  >(\"unknown\");\r\n  const [videoDevices, setVideoDevices] = useState<\r\n    Array<{ deviceId: string; label: string }>\r\n  >([]);\r\n  const [selectedDeviceId, setSelectedDeviceId] = useState<string | null>(null);\r\n  const [streaming, setStreaming] = useState(false);\r\n  const [videoPlayBlocked, setVideoPlayBlocked] = useState(false);\r\n  const [phase, setPhase] = useState<Phase>(\"camera\");\r\n  // Default to local or last-used mode, but allow user to freely change\r\n  const [mode, setMode] = useState<CamMode>(\r\n    () => (localStorage.getItem(\"ndn:cal:mode\") as CamMode) || \"local\",\r\n  );\r\n  const [dstPoints, setDstPoints] = useState<Point[]>([]); // image points clicked in order D20 (top), D6 (right), D3 (bottom), D11 (left)\r\n  const [hasSnapshot, setHasSnapshot] = useState(false);\r\n  // Track current frame (video/snapshot) size to preserve aspect ratio in the preview container\r\n  const [frameSize, setFrameSize] = useState<{ w: number; h: number } | null>(\r\n    null,\r\n  );\r\n  // Zoom for pixel-perfect point picking (0.5x  2.0x)\r\n  const [zoom, setZoom] = useState<number>(1);\r\n  const [mobileLandingOverride, setMobileLandingOverride] = useState<boolean>(\r\n    () => {\r\n      if (typeof window === \"undefined\") return false;\r\n      try {\r\n        return window.localStorage.getItem(\"ndn:cal:forceDesktop\") === \"1\";\r\n      } catch {\r\n        return false;\r\n      }\r\n    },\r\n  );\r\n  const [isMobileDevice, setIsMobileDevice] = useState<boolean>(() => {\r\n    if (typeof navigator === \"undefined\") return false;\r\n    return /Android|iPhone|iPad|iPod|Mobi/i.test(navigator.userAgent);\r\n  });\r\n  const { H, setCalibration, reset, errorPx, locked, overlaySize, imageSize } = useCalibration();\r\n  const ERROR_PX_MAX = 6;\r\n  const calibrationValid = !!H && !!imageSize && (locked || (typeof errorPx === 'number' && errorPx <= ERROR_PX_MAX));\r\n  const cameraSession = useCameraSession();\r\n  const {\r\n    calibrationGuide,\r\n    setCalibrationGuide,\r\n    preferredCameraId,\r\n    cameraEnabled,\r\n    setCameraEnabled,\r\n    preferredCameraLocked,\r\n    setPreferredCameraLocked,\r\n    setPreferredCamera,\r\n    preserveCalibrationOverlay,\r\n  allowAutocommitInOnline,\r\n  setAllowAutocommitInOnline,\r\n  } = useUserSettings();\r\n  // Detected ring data (from auto-detect) in image pixels\r\n  const [detected, setDetected] = useState<null | {\r\n    cx: number;\r\n    cy: number;\r\n    bullInner: number;\r\n    bullOuter: number;\r\n    trebleInner: number;\r\n    trebleOuter: number;\r\n    doubleInner: number;\r\n    doubleOuter: number;\r\n  }>(null);\r\n  // Live detection and confidence state\r\n  const [liveDetect, setLiveDetect] = useState<boolean>(false);\r\n  const [confidence, setConfidence] = useState<number>(0);\r\n  const [autoCalibrating, setAutoCalibrating] = useState<boolean>(false);\r\n  const [detectionMessage, setDetectionMessage] = useState<string | null>(null);\r\n  const [forceConfidence, setForceConfidence] = useState<boolean>(true); // Allow forcing 100% for registration reliability\r\n  const [markerResult, setMarkerResult] = useState<MarkerDetection | null>(\r\n    null,\r\n  );\r\n  const [showDartPreview, setShowDartPreview] = useState<boolean>(false);\r\n  const [autoCommitTestMode, setAutoCommitTestMode] = useState<boolean>(false);\r\n  const [autoCommitImmediate, setAutoCommitImmediate] = useState<boolean>(false);\r\n  const [lastDetectedValue, setLastDetectedValue] = useState<number | null>(null);\r\n  const [lastDetectedLabel, setLastDetectedLabel] = useState<string | null>(null);\r\n  const [toolsPopoverOpen, setToolsPopoverOpen] = useState<boolean>(false);\r\n  const dartDetectorRef = useRef<DartDetector | null>(null);\r\n  // Verification results for UI: {label, expected, detected, match}\r\n  const [verificationResults, setVerificationResults] = useState<\r\n    Array<{ label: string; expected: any; detected: any; match: boolean }>\r\n  >([]);\r\n\r\n  const createMarkerDataUrl = useCallback((id: number, size = 480) => {\r\n    if (typeof document === \"undefined\")\r\n      throw new Error(\"Marker rendering only available in browser context\");\r\n    const matrix = markerIdToMatrix(id);\r\n    const canvas = document.createElement(\"canvas\");\r\n    canvas.width = size;\r\n    canvas.height = size;\r\n    const ctx = canvas.getContext(\"2d\");\r\n    if (!ctx) return \"\";\r\n    // white background\r\n    ctx.fillStyle = \"#ffffff\";\r\n    ctx.fillRect(0, 0, size, size);\r\n\r\n    const rows = matrix.length;\r\n    const cols = matrix[0]?.length || rows;\r\n    const cellW = size / cols;\r\n    const cellH = size / rows;\r\n\r\n    for (let y = 0; y < rows; y++) {\r\n      for (let x = 0; x < cols; x++) {\r\n        const v = matrix[y][x];\r\n        if (v) {\r\n          ctx.fillStyle = \"#000000\";\r\n          ctx.fillRect(\r\n            Math.round(x * cellW),\r\n            Math.round(y * cellH),\r\n            Math.ceil(cellW),\r\n            Math.ceil(cellH),\r\n          );\r\n        }\r\n      }\r\n    }\r\n\r\n    return canvas.toDataURL(\"image/png\");\r\n  }, []);\r\n  // Pairing / phone-camera state (some of these were accidentally removed during edits)\r\n  const [pairCode, setPairCode] = useState<string | null>(null);\r\n  const pairCodeRef = useRef<string | null>(null);\r\n  const [ws, setWs] = useState<WebSocket | null>(null);\r\n  const pcRef = useRef<RTCPeerConnection | null>(null);\r\n  const pendingIceCandidatesRef = useRef<RTCIceCandidate[]>([]);\r\n  const [expiresAt, setExpiresAt] = useState<number | null>(null);\r\n  const [now, setNow] = useState<number>(Date.now());\r\n  const [paired, setPaired] = useState<boolean>(false);\r\n\r\n  function updatePairCode(code: string | null) {\r\n    try {\r\n      setPairCode(code);\r\n      pairCodeRef.current = code;\r\n  } catch (e) {}\r\n  }\r\n  const [lanHost, setLanHost] = useState<string | null>(null);\r\n  const [httpsInfo, setHttpsInfo] = useState<{\r\n    https: boolean;\r\n    port: number;\r\n  } | null>(null);\r\n  const [showTips, setShowTips] = useState<boolean>(true);\r\n  const [wifiDevices, setWifiDevices] = useState<NetworkDevice[]>([]);\r\n  const [discoveringWifi, setDiscoveringWifi] = useState<boolean>(false);\r\n  const [copyFeedback, setCopyFeedback] = useState<\"link\" | \"code\" | null>(\r\n    null,\r\n  );\r\n  const copyTimeoutRef = useRef<number | null>(null);\r\n\r\n  // Log streaming state changes for debugging\r\n  useEffect(() => {\r\n    let interval: number | null = null;\r\n    if (showDartPreview && streaming && videoRef.current && overlayRef.current) {\r\n      // Initialize detector\r\n      try {\r\n        const video = videoRef.current! as HTMLVideoElement;\r\n        const det = new DartDetector({ requireStableN: 2, thresh: 18, minArea: 40 });\r\n        const w = video.videoWidth || (videoRef.current as any).clientWidth || 640;\r\n        const h = video.videoHeight || (videoRef.current as any).clientHeight || 480;\r\n        det.reset(w, h);\r\n        // Set ROI roughly to the full board if we have detection\r\n        if (detected) {\r\n          const r = Math.max(detected.doubleOuter * 1.1, detected.trebleOuter * 1.1);\r\n          det.setROI(detected.cx, detected.cy, Math.round(r));\r\n        }\r\n        dartDetectorRef.current = det;\r\n        interval = window.setInterval(() => {\r\n          try {\r\n            const canvas = document.createElement('canvas');\r\n            canvas.width = w; canvas.height = h;\r\n            const ctx = canvas.getContext('2d');\r\n            if (!ctx) return;\r\n            ctx.drawImage(video, 0, 0, w, h);\r\n            const img = ctx.getImageData(0, 0, w, h);\r\n            // feed background model\r\n            det.updateBackground(img);\r\n            const d = det.detect(img);\r\n            const overlay = overlayRef.current! as HTMLCanvasElement;\r\n            const octx = overlay.getContext('2d');\r\n            if (!octx) return;\r\n            octx.clearRect(0, 0, overlay.width, overlay.height);\r\n            // overlay is same size as canvas/image\r\n            if (d) {\r\n              try {\r\n                // Map to calibration space and extract score\r\n                if (H && imageSize) {\r\n                  const pImg = { x: d.tip.x, y: d.tip.y };\r\n                  // convert canvas coords to calibration image space\r\n                  const fallbackWidth = (overlayRef.current && overlayRef.current.width) || imageSize.w || 1;\r\n                  const fallbackHeight = (overlayRef.current && overlayRef.current.height) || imageSize.h || 1;\r\n                  const pCal = { x: pImg.x / ((fallbackWidth) / imageSize.w), y: pImg.y / ((fallbackHeight) / imageSize.h) };\r\n                  const detectedBoard = imageToBoard(H as any, pCal);\r\n                  const scoreObj = scoreAtBoardPoint(detectedBoard);\r\n                  const val = scoreObj.base;\r\n                  const label = `${scoreObj.ring} ${val}`.trim();\r\n                  const ERROR_PX_MAX = 6;\r\n                  const TIP_MARGIN_PX = 3;\r\n                  const PCAL_MARGIN_PX = 3;\r\n                  const calibrationGood = !!H && !!imageSize && (locked || (typeof errorPx === \"number\" && errorPx <= ERROR_PX_MAX));\r\n                  const tipInVideo = d.tip.x >= -TIP_MARGIN_PX && d.tip.x <= fallbackWidth + TIP_MARGIN_PX && d.tip.y >= -TIP_MARGIN_PX && d.tip.y <= fallbackHeight + TIP_MARGIN_PX;\r\n                  const pCalInImage = pCal.x >= -PCAL_MARGIN_PX && pCal.x <= imageSize.w + PCAL_MARGIN_PX && pCal.y >= -PCAL_MARGIN_PX && pCal.y <= imageSize.h + PCAL_MARGIN_PX;\r\n                  let onBoard = false;\r\n                  try {\r\n                    const pBoard = imageToBoard(H as any, pCal);\r\n                    const boardR = Math.hypot(pBoard.x, pBoard.y);\r\n                    const BOARD_MARGIN_MM = 3;\r\n                    onBoard = boardR <= BoardRadii.doubleOuter + BOARD_MARGIN_MM;\r\n                  } catch (e) {\r\n                    // ignore board mapping errors\r\n                  }\r\n                  if (!calibrationGood || !tipInVideo || !pCalInImage || !onBoard) {\r\n                    // ignore ghost detection\r\n                    dlog(\"Calibrator: ignoring ghost preview detection\", calibrationGood, tipInVideo, pCalInImage);\r\n                  } else {\r\n                    setLastDetectedValue(val);\r\n                    setLastDetectedLabel(label);\r\n                    try {\r\n                      if (autoCommitTestMode && autoCommitImmediate && useMatch.getState().inProgress && useMatch.getState().roomId === \"\") {\r\n                        // commit as offline match visit (3 darts)\r\n                        useMatch.getState().addVisit(val, 3, { visitTotal: val });\r\n                      }\r\n                    } catch (e) {\r\n                      // ignore commit errors in preview\r\n                    }\r\n                    // For online autocommit in test mode, send the message if allowed\r\n                    try {\r\n                      const isOnline = useMatch.getState().roomId !== \"\";\r\n                      if (autoCommitTestMode && autoCommitImmediate && useMatch.getState().inProgress && isOnline && allowAutocommitInOnline) {\r\n                        const pBoard = imageToBoard(H as any, pCal);\r\n                        useWS().send({ type: 'auto-visit', roomId: useMatch.getState().roomId, value: val, darts: 3, ring: scoreObj.ring, sector: scoreObj.sector, pBoard, calibrationValid: true });\r\n                      }\r\n                    } catch (e) {\r\n                      // ignore online commit errors in preview\r\n                    }\r\n                  }\r\n                }\r\n              } catch (err) {\r\n                // ignore detection mapping errors\r\n              }\r\n              octx.fillStyle = 'rgba(0,255,0,0.9)';\r\n              octx.beginPath();\r\n              octx.arc(d.tip.x, d.tip.y, 6, 0, Math.PI * 2);\r\n              octx.fill();\r\n              // draw axis\r\n              octx.strokeStyle = 'rgba(0,255,0,0.8)';\r\n              octx.lineWidth = 2;\r\n              if (d.axis) {\r\n                octx.beginPath();\r\n                octx.moveTo(d.axis.x1, d.axis.y1);\r\n                octx.lineTo(d.axis.x2, d.axis.y2);\r\n                octx.stroke();\r\n              }\r\n            }\r\n          } catch (err) {\r\n            // ignore animation errors\r\n          }\r\n        }, 300);\r\n      } catch (err) {\r\n        console.warn('[Calibrator] failed to start dart preview', err);\r\n      }\r\n    }\r\n    return () => {\r\n      if (interval) {\r\n        clearInterval(interval);\r\n      }\r\n      dartDetectorRef.current = null;\r\n    };\r\n  }, [showDartPreview, streaming, detected]);\r\n\r\n  useEffect(() => {\r\n    const h = window.location.hostname;\r\n    if (h === \"localhost\" || h === \"127.0.0.1\") {\r\n      apiFetch(`/api/hosts`)\r\n        .then((r) => r.json())\r\n        .then((j) => {\r\n          const ip = Array.isArray(j?.hosts) && j.hosts.find((x: string) => x);\r\n          if (ip) setLanHost(ip);\r\n        })\r\n        .catch(() => {});\r\n    }\r\n    // Try to detect if server exposes HTTPS info\r\n    apiFetch(`/api/https-info`)\r\n      .then((r) => r.json())\r\n      .then((j) => {\r\n        if (j && typeof j.https === \"boolean\")\r\n          setHttpsInfo({ https: !!j.https, port: Number(j.port) || 8788 });\r\n      })\r\n      .catch(() => {});\r\n  }, []);\r\n\r\n  // Remove automatic phone pairing on mode change; only pair on explicit user action\r\n  const mobileUrl = useMemo(() => {\r\n    const code = pairCode || \"____\";\r\n    // Prefer configured WS host (Render) when available to build the correct server origin\r\n    const envUrl = (import.meta as any).env?.VITE_WS_URL as string | undefined;\r\n    if (envUrl && envUrl.length > 0) {\r\n      try {\r\n        const u = new URL(envUrl);\r\n        const isSecure = u.protocol === \"wss:\";\r\n        const origin = `${isSecure ? \"https\" : \"http\"}://${u.host}${u.pathname.endsWith(\"/ws\") ? \"\" : u.pathname}`;\r\n        const base = origin.replace(/\\/?ws$/i, \"\");\r\n        return `${base}/mobile-cam.html?code=${code}`;\r\n                    } catch (e) {}\r\n    }\r\n    // Local dev fallback using detected LAN or current host\r\n    const host = lanHost || window.location.hostname;\r\n    const useHttps = !!httpsInfo?.https;\r\n    const port = useHttps ? httpsInfo?.port || 8788 : 8787;\r\n    const proto = useHttps ? \"https\" : \"http\";\r\n    return `${proto}://${host}:${port}/mobile-cam.html?code=${code}`;\r\n  }, [pairCode, lanHost, httpsInfo]);\r\n\r\n  const mobileLandingLink = useMemo(() => {\r\n    if (!mobileUrl) return null;\r\n    try {\r\n      const url = new URL(mobileUrl);\r\n      url.searchParams.delete(\"code\");\r\n      return url.toString().replace(/\\?$/, \"\");\r\n    } catch {\r\n      if (typeof window !== \"undefined\") {\r\n        const origin = window.location.origin.replace(/\\/$/, \"\");\r\n        return `${origin}/mobile-cam.html`;\r\n      }\r\n      return \"/mobile-cam.html\";\r\n    }\r\n  }, [mobileUrl]);\r\n\r\n  useEffect(() => {\r\n    localStorage.setItem(\"ndn:cal:mode\", mode);\r\n  }, [mode]);\r\n\r\n  useEffect(() => {\r\n    if (typeof window === \"undefined\") return;\r\n    try {\r\n      if (mobileLandingOverride) {\r\n        window.localStorage.setItem(\"ndn:cal:forceDesktop\", \"1\");\r\n      } else {\r\n        window.localStorage.removeItem(\"ndn:cal:forceDesktop\");\r\n      }\r\n  } catch (e) {}\r\n  }, [mobileLandingOverride]);\r\n\r\n  useEffect(() => {\r\n    if (typeof window === \"undefined\") return;\r\n    const coarseQuery = window.matchMedia(\"(pointer: coarse)\");\r\n    const detect = () => {\r\n      const uaMobile =\r\n        typeof navigator !== \"undefined\" &&\r\n        /Android|iPhone|iPad|iPod|Mobi/i.test(navigator.userAgent);\r\n      const coarse =\r\n        typeof coarseQuery.matches === \"boolean\" ? coarseQuery.matches : false;\r\n      const narrow = window.innerWidth <= 820;\r\n      setIsMobileDevice(uaMobile || coarse || narrow);\r\n    };\r\n    detect();\r\n    try {\r\n      if (typeof coarseQuery.addEventListener === \"function\")\r\n        coarseQuery.addEventListener(\"change\", detect);\r\n      else if (typeof coarseQuery.addListener === \"function\")\r\n        coarseQuery.addListener(detect);\r\n  } catch (e) {}\r\n    window.addEventListener(\"resize\", detect);\r\n    return () => {\r\n      try {\r\n        if (typeof coarseQuery.removeEventListener === \"function\")\r\n          coarseQuery.removeEventListener(\"change\", detect);\r\n        else if (typeof coarseQuery.removeListener === \"function\")\r\n          coarseQuery.removeListener(detect);\r\n  } catch (e) {}\r\n      window.removeEventListener(\"resize\", detect);\r\n    };\r\n  }, []);\r\n\r\n  // Detect camera permission status where supported\r\n  useEffect(() => {\r\n    if (typeof navigator === \"undefined\" || !(navigator as any).permissions) {\r\n      setCameraPerm(\"unsupported\");\r\n      return;\r\n    }\r\n    let mounted = true;\r\n    (async () => {\r\n      try {\r\n        const p = await (navigator as any).permissions.query({\r\n          name: \"camera\",\r\n        });\r\n        if (!mounted) return;\r\n        setCameraPerm(p.state || \"unknown\");\r\n        p.onchange = () => {\r\n          if (mounted) setCameraPerm(p.state);\r\n        };\r\n      } catch (err) {\r\n        // Some browsers don't support 'camera' permission query\r\n        if (mounted) setCameraPerm(\"unknown\");\r\n      }\r\n    })();\r\n    return () => {\r\n      mounted = false;\r\n    };\r\n  }, []);\r\n\r\n  async function refreshVideoDevices() {\r\n    if (\r\n      typeof navigator === \"undefined\" ||\r\n      !navigator.mediaDevices ||\r\n      !navigator.mediaDevices.enumerateDevices\r\n    )\r\n      return;\r\n    try {\r\n      const list = await navigator.mediaDevices.enumerateDevices();\r\n      const vids = list\r\n        .filter((d) => d.kind === \"videoinput\")\r\n        .map((d) => ({\r\n          deviceId: (d as any).deviceId,\r\n          label: d.label || \"Camera\",\r\n        }));\r\n      setVideoDevices(vids);\r\n      if (vids.length && !selectedDeviceId)\r\n        setSelectedDeviceId(vids[0].deviceId);\r\n    } catch (err) {\r\n      // ignore\r\n    }\r\n  }\r\n\r\n  useEffect(() => {\r\n    let mounted = true;\r\n    (async () => {\r\n      try {\r\n        await refreshVideoDevices();\r\n  } catch (e) {}\r\n      try {\r\n        if (navigator?.mediaDevices?.addEventListener) {\r\n          navigator.mediaDevices.addEventListener('devicechange', refreshVideoDevices);\r\n        } else {\r\n          (navigator.mediaDevices as any).ondevicechange = refreshVideoDevices;\r\n        }\r\n  } catch (e) {}\r\n    })();\r\n    return () => {\r\n      try {\r\n        if (navigator?.mediaDevices?.removeEventListener)\r\n          navigator.mediaDevices.removeEventListener('devicechange', refreshVideoDevices);\r\n                    } catch (e) {}\r\n    };\r\n  }, []);\r\n\r\n  async function testCamera(deviceId?: string) {\r\n    if (\r\n      typeof navigator === \"undefined\" ||\r\n      !navigator.mediaDevices ||\r\n      !navigator.mediaDevices.getUserMedia\r\n    ) {\r\n      alert(\"getUserMedia is not available in this browser\");\r\n      return;\r\n    }\r\n    const constraints: any = {\r\n      video: deviceId\r\n        ? { deviceId: { exact: deviceId } }\r\n        : { facingMode: \"environment\" },\r\n    };\r\n    let stream: MediaStream | null = null;\r\n    try {\r\n      stream = await navigator.mediaDevices.getUserMedia(constraints);\r\n      // Immediately stop tracks to test access\r\n      stream.getTracks().forEach((t) => t.stop());\r\n      setCameraPerm(\"granted\");\r\n      // If a deviceId was provided, set it as the preferred camera so Start Camera will use it\r\n      try {\r\n        if (deviceId && typeof setPreferredCamera === \"function\") {\r\n          setPreferredCamera(deviceId);\r\n        }\r\n      } catch {}\r\n      alert(\r\n        \"Camera access granted  your webcam is available and set as preferred.\",\r\n      );\r\n    } catch (err: any) {\r\n      console.error(\"[Calibrator] testCamera failed\", err);\r\n      if (\r\n        err &&\r\n        (err.name === \"NotAllowedError\" || err.name === \"PermissionDeniedError\")\r\n      ) {\r\n        setCameraPerm(\"denied\");\r\n        alert(\r\n          \"Camera permission denied. Please allow camera access in your browser settings and try again.\",\r\n        );\r\n      } else if (\r\n        err &&\r\n        (err.name === \"NotFoundError\" || err.name === \"DevicesNotFoundError\")\r\n      ) {\r\n        alert(\r\n          \"No camera devices found. Ensure your USB webcam is connected and not in use by another app.\",\r\n        );\r\n      } else {\r\n        alert(\"Unable to access the camera: \" + (err?.message || err));\r\n      }\r\n    } finally {\r\n      if (stream) stream.getTracks().forEach((t) => t.stop());\r\n    }\r\n  }\r\n\r\n  function openBrowserSiteSettings() {\r\n    if (typeof window === \"undefined\") return;\r\n    const ua = navigator.userAgent || \"\";\r\n    let url: string | null = null;\r\n    if (/Edg\\//.test(ua) || /Chrome\\//.test(ua) || /Chromium\\//.test(ua)) {\r\n      // Chromium-based browsers: open camera content settings\r\n      url = \"chrome://settings/content/camera\";\r\n    } else if (/Firefox\\//.test(ua)) {\r\n      url = \"about:preferences#privacy\";\r\n    } else if (/Safari\\//.test(ua) && !/Chrome\\//.test(ua)) {\r\n      // Safari has no direct site settings page we can open; show instructions instead\r\n      url = null;\r\n    }\r\n    if (url) {\r\n      const w = window.open(url, \"_blank\");\r\n      if (!w) {\r\n        alert(\r\n          'Unable to open browser settings automatically. Please open your browser settings and search for \"Camera\" permissions for this site.',\r\n        );\r\n      }\r\n    } else {\r\n      // Fallback instructions\r\n      alert(\r\n        \"Please open your browser settings and locate Site Settings  Camera (or Permissions) and allow camera access for this site. In Safari, use Preferences  Websites  Camera.\",\r\n      );\r\n    }\r\n  }\r\n\r\n  useEffect(() => {\r\n    if (!expiresAt) return;\r\n    const t = setInterval(() => setNow(Date.now()), 1000);\r\n    return () => clearInterval(t);\r\n  }, [expiresAt]);\r\n  const ttl = useMemo(\r\n    () => (expiresAt ? Math.max(0, Math.ceil((expiresAt - now) / 1000)) : null),\r\n    [expiresAt, now],\r\n  );\r\n  useEffect(() => {\r\n    return () => {\r\n      if (copyTimeoutRef.current) window.clearTimeout(copyTimeoutRef.current);\r\n    };\r\n  }, []);\r\n\r\n  const copyValue = useCallback(\r\n    async (value: string | null | undefined, type: \"link\" | \"code\") => {\r\n      if (!value) return;\r\n      try {\r\n        if (navigator.clipboard && navigator.clipboard.writeText) {\r\n          await navigator.clipboard.writeText(value);\r\n        } else {\r\n          const textarea = document.createElement(\"textarea\");\r\n          textarea.value = value;\r\n          textarea.style.position = \"fixed\";\r\n          textarea.style.opacity = \"0\";\r\n          document.body.appendChild(textarea);\r\n          textarea.focus();\r\n          textarea.select();\r\n          document.execCommand(\"copy\");\r\n          document.body.removeChild(textarea);\r\n        }\r\n        setCopyFeedback(type);\r\n        if (copyTimeoutRef.current) window.clearTimeout(copyTimeoutRef.current);\r\n        copyTimeoutRef.current = window.setTimeout(\r\n          () => setCopyFeedback(null),\r\n          1500,\r\n        );\r\n      } catch (err) {\r\n        console.warn(\"[Calibrator] Copy failed:\", err);\r\n        setCopyFeedback(null);\r\n      }\r\n    },\r\n    [],\r\n  );\r\n  // Removed automatic regeneration of code when ttl expires. Only regenerate on explicit user action.\r\n\r\n  // NOTE: Removed automatic permission request on load - it was blocking camera access\r\n  // Let startCamera() handle the permission request when user clicks \"Enable camera\"\r\n  // This prevents the camera from being held by the permission test\r\n\r\n  useEffect(() => {\r\n    return () => {\r\n      // DON'T call stopCamera() on unmount - we want phone camera to persist!\r\n      // Just clean up local refs\r\n      // The camera stream stays alive so user can see it in Online/Offline/Tournaments\r\n    };\r\n  }, []); // Remove automatic camera restart on preferredCameraId change to prevent flicker\r\n\r\n  // Listen for reconnect requests from PhoneCameraOverlay\r\n  useEffect(() => {\r\n    const handleReconnectRequest = (event: any) => {\r\n      console.log(\r\n        \"[Calibrator] Received reconnect request from PhoneCameraOverlay\",\r\n      );\r\n      // If we're in phone mode and already paired, restart the pairing\r\n      if (mode === \"phone\" && paired) {\r\n        stopCamera(false);\r\n        // Give a moment for cleanup, then restart pairing\r\n        setTimeout(() => {\r\n          startPhonePairing();\r\n        }, 500);\r\n      }\r\n    };\r\n\r\n    window.addEventListener(\r\n      \"ndn:phone-camera-reconnect\",\r\n      handleReconnectRequest as EventListener,\r\n    );\r\n    return () => {\r\n      window.removeEventListener(\r\n        \"ndn:phone-camera-reconnect\",\r\n        handleReconnectRequest as EventListener,\r\n      );\r\n    };\r\n  }, [mode, paired]);\r\n\r\n  // Sync video element to camera session so other components can access it\r\n  // CRITICAL: Run whenever streaming state changes to keep videoRef synced\r\n  useEffect(() => {\r\n    console.log(\"[Calibrator]  STREAMING CHANGED:\", {\r\n      streaming,\r\n      videoRefAvailable: !!videoRef.current,\r\n    });\r\n    if (videoRef.current) {\r\n      console.log(\r\n        \"[Calibrator]  Syncing videoElementRef on streaming change\",\r\n      );\r\n      cameraSession.setVideoElementRef(videoRef.current);\r\n      // Also capture media stream when available\r\n      if (videoRef.current.srcObject instanceof MediaStream) {\r\n        console.log(\"[Calibrator]  Setting mediaStream from video element\");\r\n        cameraSession.setMediaStream(videoRef.current.srcObject);\r\n      }\r\n    } else {\r\n      console.warn(\r\n        \"[Calibrator]  videoRef.current is null on streaming change!\",\r\n      );\r\n    }\r\n  }, [streaming]);\r\n\r\n  // Also sync on mount to capture initial videoRef\r\n  useEffect(() => {\r\n    console.log(\"[Calibrator]  MOUNT: Initial mount - syncing videoRef\");\r\n    console.log(\"[Calibrator] videoRef.current available:\", !!videoRef.current);\r\n    console.log(\r\n      \"[Calibrator] videoRef.current type:\",\r\n      videoRef.current?.constructor?.name,\r\n    );\r\n\r\n    if (videoRef.current) {\r\n      console.log(\"[Calibrator]  Setting videoElementRef on mount\");\r\n      console.log(\"[Calibrator] Video element:\", {\r\n        tagName: videoRef.current.tagName,\r\n        srcObject: !!videoRef.current.srcObject,\r\n        videoWidth: videoRef.current.videoWidth,\r\n        videoHeight: videoRef.current.videoHeight,\r\n      });\r\n      cameraSession.setVideoElementRef(videoRef.current);\r\n      console.log(\"[Calibrator]  videoElementRef set successfully\");\r\n    } else {\r\n      console.error(\r\n        \"[Calibrator]  CRITICAL: videoRef.current is NULL at mount!\",\r\n      );\r\n    }\r\n    // Do NOT clear the videoElementRef on unmount; we want the stream to persist globally\r\n    return () => {\r\n      /* keep global video element ref for overlay */\r\n    };\r\n  }, []);\r\n\r\n  function ensureWS() {\r\n    // Return existing WebSocket if it's open or connecting\r\n    if (\r\n      ws &&\r\n      (ws.readyState === WebSocket.OPEN ||\r\n        ws.readyState === WebSocket.CONNECTING)\r\n    ) {\r\n      console.log(\r\n        \"[Calibrator] ensureWS: Reusing existing WebSocket (state:\",\r\n        ws.readyState,\r\n        \")\",\r\n      );\r\n      return ws;\r\n    }\r\n    // Prefer configured WS endpoint; normalize to include '/ws'. Fallback to same-origin '/ws'.\r\n    const envUrl = (import.meta as any).env?.VITE_WS_URL as string | undefined;\r\n    const normalizedEnv =\r\n      envUrl && envUrl.length > 0\r\n        ? envUrl.endsWith(\"/ws\")\r\n          ? envUrl\r\n          : envUrl.replace(/\\/$/, \"\") + \"/ws\"\r\n        : undefined;\r\n    const proto = window.location.protocol === \"https:\" ? \"wss\" : \"ws\";\r\n    const sameOrigin = `${proto}://${window.location.host}/ws`;\r\n    const host = window.location.hostname;\r\n    // Production safeguard: if we are not on the Render backend host and no env URL is set,\r\n    // prefer the known Render service as a fallback instead of Netlify same-origin.\r\n    const renderWS = `wss://ninedartnation.onrender.com/ws`;\r\n    const url =\r\n      normalizedEnv || (host.endsWith(\"onrender.com\") ? sameOrigin : renderWS);\r\n    console.log(\"[Calibrator] ensureWS: Creating new WebSocket to:\", url);\r\n    const socket: WebSocket = new WebSocket(url);\r\n\r\n    // Set up handlers BEFORE storing the socket to avoid race conditions\r\n    socket.onerror = (error) => {\r\n      console.error(\"[Calibrator] WebSocket connection error:\", error);\r\n      alert(\r\n        \"Failed to connect to camera pairing service. Please check your internet connection and try again.\",\r\n      );\r\n    };\r\n    socket.onclose = (event) => {\r\n      console.log(\"[Calibrator] WebSocket closed:\", event.code, event.reason);\r\n      if (pcRef.current) {\r\n        try {\r\n          pcRef.current.close();\r\n        } catch {}\r\n        pcRef.current = null;\r\n      }\r\n      updatePairCode(null);\r\n      setExpiresAt(null);\r\n      setPaired(false);\r\n      // Only show alert if it wasn't a clean close\r\n      if (event.code !== 1000) {\r\n        alert(\"Camera pairing connection lost. Please try pairing again.\");\r\n        // Also revert to local mode on disconnect so user can restart camera\r\n        if (mode === \"phone\") setMode(\"local\");\r\n      }\r\n    };\r\n\r\n    // Store socket BEFORE setting message handler to ensure it's available for message sending\r\n    setWs(socket);\r\n    return socket;\r\n  }\r\n\r\n  async function startPhonePairing() {\r\n    // Do not reset paired/streaming/phase state here to keep UI static\r\n    // Switch UI into phone pairing mode so the calibrator shows phone-specific hints\r\n    setMode(\"phone\");\r\n    // Stop any existing camera streams before switching to phone mode\r\n    // This ensures clean transition and no resource conflicts\r\n    // Use true for autoRevert since we're explicitly switching modes, but we already set mode above\r\n    stopCamera(false);\r\n    // Lock selection and ensure camera UI is enabled while pairing is active\r\n    lockSelectionForPairing();\r\n    try {\r\n      setCameraEnabled(true);\r\n  } catch (e) {}\r\n    const socket = ensureWS();\r\n    // Send cam-create when socket is ready\r\n    if (socket.readyState === WebSocket.OPEN) {\r\n      console.log(\"[Calibrator] WebSocket open, sending cam-create\");\r\n      socket.send(JSON.stringify({ type: \"cam-create\" }));\r\n    } else {\r\n      console.log(\r\n        \"[Calibrator] WebSocket connecting, will send cam-create on open\",\r\n      );\r\n      socket.onopen = () => {\r\n        console.log(\"[Calibrator] WebSocket now open, sending cam-create\");\r\n        socket.send(JSON.stringify({ type: \"cam-create\" }));\r\n      };\r\n    }\r\n    socket.onmessage = async (ev) => {\r\n      const data = JSON.parse(ev.data);\r\n      if (data.type === \"cam-code\") {\r\n        updatePairCode(data.code);\r\n        if (data.expiresAt) setExpiresAt(data.expiresAt);\r\n      } else if (data.type === \"cam-peer-joined\") {\r\n        // Ensure we have the latest pairing code even if messages arrive out of order\r\n        if (!pairCodeRef.current && data.code) updatePairCode(data.code);\r\n        setPaired(true);\r\n        // When a phone peer joins, proactively send current calibration (if locked)\r\n        const codeForSession = pairCodeRef.current || data.code || null;\r\n        if (codeForSession) pairCodeRef.current = codeForSession;\r\n        try {\r\n          if (locked && codeForSession) {\r\n            const imgSize = canvasRef.current\r\n              ? { w: canvasRef.current.width, h: canvasRef.current.height }\r\n              : null;\r\n            const payload = {\r\n              H,\r\n              imageSize: imgSize,\r\n              errorPx: errorPx ?? null,\r\n              createdAt: Date.now(),\r\n            };\r\n            socket.send(\r\n              JSON.stringify({\r\n                type: \"cam-calibration\",\r\n                code: codeForSession,\r\n                payload,\r\n              }),\r\n            );\r\n            console.log(\r\n              \"[Calibrator] Sent calibration to joined phone for code\",\r\n              codeForSession,\r\n            );\r\n          }\r\n        } catch (e) {\r\n          console.warn(\r\n            \"[Calibrator] Failed to send calibration on peer join\",\r\n            e,\r\n          );\r\n        }\r\n        const peer = new RTCPeerConnection({\r\n          iceServers: [{ urls: \"stun:stun.l.google.com:19302\" }],\r\n          iceCandidatePoolSize: 10,\r\n        });\r\n        pcRef.current = peer;\r\n\r\n        // Add connection state monitoring\r\n        peer.onconnectionstatechange = () => {\r\n          console.log(\"WebRTC connection state:\", peer.connectionState);\r\n          if (\r\n            peer.connectionState === \"failed\" ||\r\n            peer.connectionState === \"disconnected\"\r\n          ) {\r\n            console.error(\"WebRTC connection failed\");\r\n            alert(\"Camera connection lost. Please try pairing again.\");\r\n            stopCamera(false);\r\n          } else if (peer.connectionState === \"connected\") {\r\n            console.log(\"WebRTC connection established\");\r\n          }\r\n        };\r\n\r\n        peer.onicecandidate = (e) => {\r\n          if (e.candidate && codeForSession) {\r\n            socket.send(\r\n              JSON.stringify({\r\n                type: \"cam-ice\",\r\n                code: codeForSession,\r\n                payload: e.candidate,\r\n              }),\r\n            );\r\n          }\r\n        };\r\n\r\n        peer.ontrack = (ev) => {\r\n          console.log(\r\n            \"[Calibrator] WebRTC ontrack received:\",\r\n            ev.streams?.length,\r\n            \"streams, track kind:\",\r\n            ev.track?.kind,\r\n          );\r\n          if (videoRef.current) {\r\n            const inbound = ev.streams?.[0];\r\n            if (inbound) {\r\n              console.log(\r\n                \"[Calibrator] Assigning video stream (tracks:\",\r\n                inbound.getTracks().length,\r\n                \") to video element\",\r\n              );\r\n              // Ensure video element is visible\r\n              setHasSnapshot(false);\r\n              // Use setTimeout to ensure DOM updates before assigning stream\r\n              setTimeout(() => {\r\n                if (videoRef.current) {\r\n                  console.log(\r\n                    \"[Calibrator] Setting srcObject and attempting play\",\r\n                  );\r\n                  // Clean up any existing stream before assigning new one\r\n                  if (videoRef.current.srcObject) {\r\n                    const existingTracks = (\r\n                      videoRef.current.srcObject as MediaStream\r\n                    ).getTracks();\r\n                    existingTracks.forEach((t) => t.stop());\r\n                  }\r\n                  videoRef.current.srcObject = inbound;\r\n                  videoRef.current.muted = true; // Ensure muted for autoplay policy\r\n                  videoRef.current.playsInline = true; // Mobile/iOS support\r\n                  videoRef.current\r\n                    .play()\r\n                    .then(() => {\r\n                      console.log(\r\n                        \"[Calibrator] Video playback started successfully\",\r\n                      );\r\n                      // Mark that we're streaming from the phone and transition to capture\r\n                      setStreaming(true);\r\n                      setPhase(\"capture\");\r\n                      // Update camera session so other components can see the stream\r\n                      cameraSession.setStreaming(true);\r\n                      cameraSession.setMode(\"phone\");\r\n                      cameraSession.setMediaStream(inbound);\r\n                      // Set user settings to reflect that the active camera is the phone\r\n                      try {\r\n                        setPreferredCamera(undefined, \"Phone Camera\", true);\r\n                      } catch {}\r\n                      if (!preferredCameraLocked) {\r\n                        try {\r\n                          setPreferredCameraLocked(true);\r\n                        } catch {}\r\n                      }\r\n                      try {\r\n                        setCameraEnabled(true);\r\n                      } catch {}\r\n                      // If an overlay prompt was shown earlier, hide it now\r\n                      setVideoPlayBlocked(false);\r\n                    })\r\n                    .catch((err) => {\r\n                      console.error(\"[Calibrator] Video play failed:\", err);\r\n                      // Show a friendly tap-to-play overlay so user can enable playback\r\n                      setVideoPlayBlocked(true);\r\n                      console.warn(\r\n                        \"[Calibrator] video play blocked  prompting user interaction\",\r\n                      );\r\n                    });\r\n                }\r\n              }, 100);\r\n            } else {\r\n              console.error(\r\n                \"[Calibrator] No inbound stream received in ontrack\",\r\n              );\r\n            }\r\n          } else {\r\n            console.error(\"[Calibrator] Video element not available\");\r\n          }\r\n        };\r\n\r\n        try {\r\n          const offer = await peer.createOffer({\r\n            offerToReceiveAudio: false,\r\n            offerToReceiveVideo: true,\r\n          });\r\n          await peer.setLocalDescription(offer);\r\n          console.log(\r\n            \"[Calibrator] Sending cam-offer for code:\",\r\n            codeForSession,\r\n          );\r\n          if (codeForSession)\r\n            socket.send(\r\n              JSON.stringify({\r\n                type: \"cam-offer\",\r\n                code: codeForSession,\r\n                payload: offer,\r\n              }),\r\n            );\r\n          else\r\n            console.warn(\r\n              \"[Calibrator] Missing pairing code when sending offer\",\r\n            );\r\n        } catch (err) {\r\n          console.error(\"Failed to create WebRTC offer:\", err);\r\n          alert(\"Failed to establish camera connection. Please try again.\");\r\n          stopCamera(false);\r\n        }\r\n      } else if (data.type === \"cam-answer\") {\r\n        console.log(\"[Calibrator] Received cam-answer\");\r\n        const peer = pcRef.current;\r\n        if (peer) {\r\n          try {\r\n            await peer.setRemoteDescription(\r\n              new RTCSessionDescription(data.payload),\r\n            );\r\n            console.log(\"[Calibrator] Remote description set (answer)\");\r\n\r\n            // Process any pending ICE candidates that arrived before the answer\r\n            const pending = pendingIceCandidatesRef.current;\r\n            console.log(\r\n              `[Calibrator] Processing ${pending.length} pending ICE candidates`,\r\n            );\r\n            for (const candidate of pending) {\r\n              try {\r\n                await peer.addIceCandidate(candidate);\r\n                console.log(\"[Calibrator] Queued ICE candidate added\");\r\n              } catch (err) {\r\n                console.error(\"Failed to add queued ICE candidate:\", err);\r\n              }\r\n            }\r\n            pendingIceCandidatesRef.current = [];\r\n          } catch (err) {\r\n            console.error(\"Failed to set remote description:\", err);\r\n            alert(\"Camera pairing failed. Please try again.\");\r\n            stopCamera(false);\r\n          }\r\n        } else {\r\n          console.warn(\r\n            \"[Calibrator] Received cam-answer but no peer connection exists\",\r\n          );\r\n        }\r\n      } else if (data.type === \"cam-ice\") {\r\n        console.log(\"[Calibrator] Received cam-ice\");\r\n        const peer = pcRef.current;\r\n        if (peer) {\r\n          // Only add ICE candidate if remote description is already set\r\n          // Otherwise, queue it for later processing\r\n          if (peer.remoteDescription) {\r\n            try {\r\n              await peer.addIceCandidate(data.payload);\r\n              console.log(\"[Calibrator] ICE candidate added\");\r\n            } catch (err) {\r\n              console.error(\"Failed to add ICE candidate:\", err);\r\n            }\r\n          } else {\r\n            console.log(\r\n              \"[Calibrator] Remote description not set yet, queuing ICE candidate\",\r\n            );\r\n            pendingIceCandidatesRef.current.push(data.payload);\r\n          }\r\n        } else {\r\n          console.warn(\r\n            \"[Calibrator] Received ICE candidate but no peer connection exists\",\r\n          );\r\n        }\r\n      } else if (data.type === \"cam-error\") {\r\n        console.error(\"Camera pairing error:\", data.code);\r\n        alert(\r\n          data.code === \"EXPIRED\"\r\n            ? \"Code expired. Generate a new code.\"\r\n            : `Camera error: ${data.code || \"Unknown error\"}`,\r\n        );\r\n        stopCamera(false);\r\n      } else if (data.type === \"cam-calibration\") {\r\n        // Desktop receives calibration from phone (via server) or phone receives from desktop\r\n        console.log(\r\n          \"[Calibrator] Received calibration from peer:\",\r\n          data.payload,\r\n        );\r\n        try {\r\n            if (data.payload) {\r\n              // If payload has a homography, use it. Otherwise if we have 4 calibration points, attempt to compute H.\r\n              let Hpayload = Array.isArray(data.payload.H) ? (data.payload.H as Homography) : null;\r\n              if (!Hpayload && Array.isArray(data.payload.calibrationPoints) && data.payload.calibrationPoints.length >= 4) {\r\n                try {\r\n                  const canonicalSrc = [\r\n                    { x: 0, y: -BoardRadii.doubleOuter },\r\n                    { x: BoardRadii.doubleOuter, y: 0 },\r\n                    { x: 0, y: BoardRadii.doubleOuter },\r\n                    { x: -BoardRadii.doubleOuter, y: 0 },\r\n                  ];\r\n                  Hpayload = computeHomographyDLT(canonicalSrc, data.payload.calibrationPoints.slice(0, 4));\r\n                } catch (err) {\r\n                  console.warn(\"[Calibrator] Failed to compute homography from received calibration points\", err);\r\n                }\r\n              }\r\n              if (Hpayload) {\r\n                // Apply the received calibration\r\n                // Use overlay size from current preview (video or overlay/canvas) if available so visual scale stays consistent\r\n                const overlaySize = overlayRef?.current\r\n                  ? { w: overlayRef.current.width, h: overlayRef.current.height }\r\n                  : videoRef?.current\r\n                  ? { w: videoRef.current.clientWidth, h: videoRef.current.clientHeight }\r\n                  : data.payload.imageSize ?? null;\r\n                setCalibration({\r\n                  H: Hpayload as Homography,\r\n                  createdAt: data.payload.createdAt || Date.now(),\r\n                  errorPx: data.payload.errorPx,\r\n                  imageSize: data.payload.imageSize,\r\n                  overlaySize,\r\n                  locked: true, // Assume locked since peer sent it\r\n                });\r\n                console.log(\"[Calibrator] Applied received calibration\");\r\n              }\r\n            }\r\n        } catch (e) {\r\n          console.error(\"[Calibrator] Failed to apply received calibration\", e);\r\n        }\r\n      }\r\n    };\r\n  }\r\n\r\n  async function startWifiConnection() {\r\n    setDiscoveringWifi(true);\r\n    try {\r\n      const devices = await discoverNetworkDevices();\r\n      setWifiDevices(devices);\r\n      if (devices.length === 0) {\r\n        alert(\r\n          \"No wifi scoring devices found on your network. Make sure devices are powered on and connected to the same network.\",\r\n        );\r\n      }\r\n    } catch (error) {\r\n      console.error(\"Wifi device discovery failed:\", error);\r\n      alert(\r\n        \"Failed to discover wifi devices. Please check your network connection.\",\r\n      );\r\n    } finally {\r\n      setDiscoveringWifi(false);\r\n    }\r\n    setPhase(\"camera\");\r\n  }\r\n\r\n  async function connectToWifiDevice(device: NetworkDevice) {\r\n    try {\r\n      setWifiDevices((devices) =>\r\n        devices.map((d) =>\r\n          d.id === device.id ? { ...d, status: \"connecting\" as const } : d,\r\n        ),\r\n      );\r\n\r\n      const stream = await connectToNetworkDevice(device);\r\n      if (stream && videoRef.current) {\r\n        // Clean up any existing stream before assigning new one\r\n        if (videoRef.current.srcObject) {\r\n          const existingTracks = (\r\n            videoRef.current.srcObject as MediaStream\r\n          ).getTracks();\r\n          existingTracks.forEach((t) => t.stop());\r\n        }\r\n        videoRef.current.srcObject = stream;\r\n        await videoRef.current.play();\r\n        setStreaming(true);\r\n        setPhase(\"capture\");\r\n        setWifiDevices((devices) =>\r\n          devices.map((d) =>\r\n            d.id === device.id ? { ...d, status: \"online\" as const } : d,\r\n          ),\r\n        );\r\n      } else {\r\n        throw new Error(\"Failed to get video stream\");\r\n      }\r\n    } catch (error) {\r\n      console.error(\"Failed to connect to wifi device:\", error);\r\n      alert(\r\n        `Failed to connect to ${device.name}. Please check the device and try again.`,\r\n      );\r\n      setWifiDevices((devices) =>\r\n        devices.map((d) =>\r\n          d.id === device.id ? { ...d, status: \"offline\" as const } : d,\r\n        ),\r\n      );\r\n    }\r\n  }\r\n\r\n  async function startCamera() {\r\n    if (mode === \"phone\") return startPhonePairing();\r\n    if (mode === \"wifi\") return startWifiConnection();\r\n    console.log(\r\n      \"[Calibrator]  START_CAMERA: mode=\",\r\n      mode,\r\n      \"preferredCameraId=\",\r\n      preferredCameraId,\r\n    );\r\n    try {\r\n      let stream: MediaStream | null = null;\r\n\r\n      // Step 1: Try with preferred camera ID if available\r\n      if (preferredCameraId) {\r\n        try {\r\n          console.log(\r\n            \"[Calibrator]  Attempt 1: Using preferred camera ID:\",\r\n            preferredCameraId,\r\n          );\r\n          stream = await navigator.mediaDevices.getUserMedia({\r\n            video: { deviceId: { exact: preferredCameraId } },\r\n            audio: false,\r\n          });\r\n          console.log(\r\n            \"[Calibrator]  SUCCESS with preferred camera:\",\r\n            stream.getTracks().length,\r\n            \"tracks\",\r\n          );\r\n        } catch (err: any) {\r\n          console.warn(\r\n            \"[Calibrator]  Preferred camera failed:\",\r\n            err?.name,\r\n            err?.message,\r\n          );\r\n        }\r\n      }\r\n\r\n      // Step 2: If preferred didn't work, try any camera\r\n      if (!stream) {\r\n        try {\r\n          console.log(\"[Calibrator]  Attempt 2: Using ANY available camera\");\r\n          stream = await navigator.mediaDevices.getUserMedia({\r\n            video: true,\r\n            audio: false,\r\n          });\r\n          console.log(\r\n            \"[Calibrator]  SUCCESS with fallback camera:\",\r\n            stream.getTracks().length,\r\n            \"tracks\",\r\n          );\r\n        } catch (err: any) {\r\n          console.error(\r\n            \"[Calibrator]  BOTH attempts failed:\",\r\n            err?.name,\r\n            err?.message,\r\n          );\r\n          throw err;\r\n        }\r\n      }\r\n\r\n      // Step 3: Assign to video element\r\n      if (!stream) {\r\n        throw new Error(\"No stream obtained\");\r\n      }\r\n\r\n      if (!videoRef.current) {\r\n        throw new Error(\"Video element ref is null\");\r\n      }\r\n\r\n      console.log(\"[Calibrator]  Assigning stream to video element\");\r\n      videoRef.current.srcObject = stream;\r\n\r\n      console.log(\"[Calibrator]  Calling play()\");\r\n      try {\r\n        await videoRef.current.play();\r\n        console.log(\"[Calibrator]  Play succeeded\");\r\n      } catch (playErr: any) {\r\n        console.warn(\r\n          \"[Calibrator]  Play failed, retrying in 100ms:\",\r\n          playErr?.message,\r\n        );\r\n        await new Promise((r) => setTimeout(r, 100));\r\n        await videoRef.current.play();\r\n        console.log(\"[Calibrator]  Play succeeded on retry\");\r\n      }\r\n\r\n      console.log(\"[Calibrator]  Setting streaming = true\");\r\n      setStreaming(true);\r\n      setPhase(\"capture\");\r\n      console.log(\"[Calibrator]  State updated\");\r\n    } catch (e: any) {\r\n      console.error(\"[Calibrator]  FATAL:\", e?.message || e);\r\n      alert(`Camera failed: ${e?.message || \"Unknown error\"}`);\r\n      // Clean up any partial stream\r\n      if (videoRef.current?.srcObject) {\r\n        (videoRef.current.srcObject as MediaStream)\r\n          .getTracks()\r\n          .forEach((t) => t.stop());\r\n        videoRef.current.srcObject = null;\r\n      }\r\n    }\r\n  }\r\n\r\n  function stopCamera(autoRevert: boolean = false) {\r\n    if (videoRef.current && videoRef.current.srcObject) {\r\n      const tracks = (videoRef.current.srcObject as MediaStream).getTracks();\r\n      tracks.forEach((t) => t.stop());\r\n      videoRef.current.srcObject = null;\r\n      setStreaming(false);\r\n    }\r\n    if (pcRef.current) {\r\n      try {\r\n        pcRef.current.close();\r\n      } catch {}\r\n      pcRef.current = null;\r\n    }\r\n    pendingIceCandidatesRef.current = [];\r\n    updatePairCode(null);\r\n    setExpiresAt(null);\r\n    setPaired(false);\r\n    setMarkerResult(null);\r\n    // Clear camera session when stopping camera\r\n    cameraSession.setStreaming(false);\r\n    cameraSession.setMediaStream(null);\r\n    // Only revert to local mode if EXPLICITLY requested (user clicked Stop button)\r\n    // Otherwise preserve the selected mode so user can go to OfflinePlay and come back\r\n    if (autoRevert && (mode === \"phone\" || mode === \"wifi\")) {\r\n      setMode(\"local\");\r\n    }\r\n  }\r\n\r\n  function regenerateCode() {\r\n    // Only regenerate code, do not reset UI or camera state\r\n    if (ws && ws.readyState === WebSocket.OPEN) {\r\n      ws.send(JSON.stringify({ type: \"cam-create\" }));\r\n    } else {\r\n      startPhonePairing();\r\n    }\r\n    // Lock the preferred camera selection while pairing is active so it doesn't\r\n    // flip automatically during the pairing flow.\r\n    lockSelectionForPairing();\r\n  }\r\n\r\n  // When user regenerates a pairing code we lock the preferred camera selection so\r\n  // it won't be changed accidentally by other parts of the UI while pairing is active.\r\n  // This implements the user's request that the camera selection 'stay static' after\r\n  // generating a code. The lock can be toggled by the user in the DevicePicker UI.\r\n  function lockSelectionForPairing() {\r\n    try {\r\n      if (!preferredCameraLocked) {\r\n        setPreferredCameraLocked(true);\r\n      }\r\n    } catch {}\r\n  }\r\n\r\n  // Allow uploading a photo instead of using a live camera\r\n  function triggerUpload() {\r\n    try {\r\n      fileInputRef.current?.click();\r\n    } catch {}\r\n  }\r\n\r\n  function openMarkerSheet() {\r\n    // Open the marker sheet page in a new tab for printing\r\n    const markerSheetUrl = `${window.location.origin}/marker-sheet.html`;\r\n    window.open(markerSheetUrl, \"_blank\");\r\n  }\r\n\r\n  function onUploadPhotoChange(e: React.ChangeEvent<HTMLInputElement>) {\r\n    const f = e.target.files?.[0];\r\n    if (!f) return;\r\n    const img = new Image();\r\n    img.onload = () => {\r\n      try {\r\n        if (!canvasRef.current) return;\r\n        const c = canvasRef.current;\r\n        c.width = img.naturalWidth;\r\n        c.height = img.naturalHeight;\r\n        const ctx = c.getContext(\"2d\")!;\r\n        ctx.drawImage(img, 0, 0, c.width, c.height);\r\n        setHasSnapshot(true);\r\n        setFrameSize({ w: c.width, h: c.height });\r\n        setPhase(\"select\");\r\n        setDstPoints([]);\r\n        setMarkerResult(null);\r\n        // Clear any previous video stream\r\n        stopCamera(false);\r\n      } catch {}\r\n    };\r\n    img.onerror = () => {\r\n      alert(\"Could not load image. Please try a different photo.\");\r\n    };\r\n    img.src = URL.createObjectURL(f);\r\n    // reset input value so the same file can be reselected\r\n    try {\r\n      e.target.value = \"\";\r\n    } catch {}\r\n  }\r\n\r\n  function captureFrame() {\r\n    if (!videoRef.current || !canvasRef.current) return;\r\n    const v = videoRef.current;\r\n    const c = canvasRef.current;\r\n    c.width = v.videoWidth;\r\n    c.height = v.videoHeight;\r\n    const ctx = c.getContext(\"2d\")!;\r\n    ctx.drawImage(v, 0, 0, c.width, c.height);\r\n    setHasSnapshot(true);\r\n    setFrameSize({ w: c.width, h: c.height });\r\n    setPhase(\"select\");\r\n    setDstPoints([]);\r\n    setMarkerResult(null);\r\n    // If liveDetect is on, kick a detect on this captured frame\r\n    if (liveDetect)\r\n      setTimeout(() => {\r\n        autoDetectRings();\r\n      }, 0);\r\n  }\r\n\r\n  function drawOverlay(\r\n    currentPoints = dstPoints,\r\n    HH: Homography | null = null,\r\n  ) {\r\n    if (!canvasRef.current || !overlayRef.current) return;\r\n    const img = canvasRef.current;\r\n    const o = overlayRef.current;\r\n    o.width = img.width;\r\n    o.height = img.height;\r\n    const ctx = o.getContext(\"2d\")!;\r\n    ctx.clearRect(0, 0, o.width, o.height);\r\n\r\n    // If we have a homography, draw rings (precise, perspective-correct)\r\n    const Huse = HH || H;\r\n    if (Huse) {\r\n      const rings = [\r\n        BoardRadii.bullInner,\r\n        BoardRadii.bullOuter,\r\n        BoardRadii.trebleInner,\r\n        BoardRadii.trebleOuter,\r\n        BoardRadii.doubleInner,\r\n        BoardRadii.doubleOuter,\r\n      ];\r\n      for (const r of rings) {\r\n        if (!Number.isFinite(r)) continue;\r\n        // Use green for all rings when calibration is locked/perfect\r\n        const ringColor = locked\r\n          ? \"#10b981\"\r\n          : r === BoardRadii.doubleOuter\r\n            ? \"#22d3ee\"\r\n            : \"#a78bfa\";\r\n        const ringWidth = locked ? 3 : r === BoardRadii.doubleOuter ? 3 : 2;\r\n        try {\r\n          const poly = sampleRing(Huse, r, 360);\r\n          if (\r\n            !poly.length ||\r\n            poly.some((p) => !Number.isFinite(p.x) || !Number.isFinite(p.y))\r\n          )\r\n            continue;\r\n          drawPolyline(ctx, poly, ringColor, ringWidth);\r\n        } catch (err) {\r\n          console.warn(\"[Calibrator] Skipped invalid ring overlay\", {\r\n            radius: r,\r\n            err,\r\n          });\r\n        }\r\n      }\r\n    }\r\n    // Otherwise, if we have detected circles, draw them as previews (circles in image space)\r\n    if (!Huse && detected) {\r\n      const drawCircle = (r: number, color: string, w = 2) => {\r\n        if (!Number.isFinite(r) || r <= 0) return;\r\n        ctx.save();\r\n        ctx.strokeStyle = color;\r\n        ctx.lineWidth = w;\r\n        ctx.beginPath();\r\n        ctx.arc(detected.cx, detected.cy, r, 0, Math.PI * 2);\r\n        ctx.stroke();\r\n        ctx.restore();\r\n      };\r\n      drawCircle(detected.doubleOuter, \"#22d3ee\", 3);\r\n      drawCircle(detected.doubleInner, \"#22d3ee\", 2);\r\n      drawCircle(detected.trebleOuter, \"#fde047\", 2);\r\n      drawCircle(detected.trebleInner, \"#fde047\", 2);\r\n      drawCircle(detected.bullOuter, \"#34d399\", 2);\r\n      drawCircle(detected.bullInner, \"#10b981\", 3);\r\n    }\r\n\r\n    // Show calibration guide circles when not all rim points are selected and homography exists\r\n    const targetPoints = canonicalRimTargets();\r\n    if (currentPoints.length < targetPoints.length && Huse) {\r\n      ctx.save();\r\n      ctx.strokeStyle = \"rgba(255,193,7,0.4)\";\r\n      ctx.lineWidth = 2;\r\n      ctx.setLineDash([4, 4]);\r\n      // Show the remaining expected click positions (D20, D6, D3, D11)\r\n      for (let i = currentPoints.length; i < targetPoints.length; i++) {\r\n        try {\r\n          const p = applyHomography(Huse, targetPoints[i]);\r\n          ctx.beginPath();\r\n          ctx.arc(p.x, p.y, 12, 0, Math.PI * 2);\r\n          ctx.stroke();\r\n          ctx.save();\r\n          ctx.fillStyle = \"rgba(255,255,255,0.65)\";\r\n          ctx.font = \"12px sans-serif\";\r\n          ctx.fillText(\r\n            CALIBRATION_POINT_LABELS[i] ?? String(i + 1),\r\n            p.x + 10,\r\n            p.y - 10,\r\n          );\r\n          ctx.restore();\r\n        } catch {}\r\n      }\r\n      ctx.restore();\r\n    }\r\n\r\n    // Draw clicked points with sector labels so users know which doubles have been mapped\r\n    currentPoints.forEach((p, i) => {\r\n      drawCross(ctx, p, \"#f472b6\");\r\n      ctx.save();\r\n      ctx.fillStyle = \"#f472b6\";\r\n      ctx.font = \"14px sans-serif\";\r\n      ctx.fillText(\r\n        CALIBRATION_POINT_LABELS[i] ?? String(i + 1),\r\n        p.x + 6,\r\n        p.y - 6,\r\n      );\r\n      ctx.restore();\r\n    });\r\n\r\n    // Preferred-view framing guide (if enabled and not yet calibrated)\r\n    if (calibrationGuide && !locked) {\r\n      ctx.save();\r\n      // Semi-transparent vignette to encourage centered, face-on framing\r\n      ctx.fillStyle = \"rgba(59,130,246,0.10)\";\r\n      const pad = Math.round(Math.min(o.width, o.height) * 0.08);\r\n      const w = o.width - pad * 2;\r\n      const h = o.height - pad * 2;\r\n      ctx.fillRect(pad, pad, w, h);\r\n      // Horizon/tilt line and vertical center line\r\n      ctx.strokeStyle = \"rgba(34,197,94,0.9)\";\r\n      ctx.lineWidth = 2;\r\n      // Horizontal line roughly through bull height\r\n      ctx.beginPath();\r\n      ctx.moveTo(pad, o.height / 2);\r\n      ctx.lineTo(o.width - pad, o.height / 2);\r\n      ctx.stroke();\r\n      // Vertical center\r\n      ctx.beginPath();\r\n      ctx.moveTo(o.width / 2, pad);\r\n      ctx.lineTo(o.width / 2, o.height - pad);\r\n      ctx.stroke();\r\n      // Angle brackets to suggest slight top-down 1015\r\n      ctx.strokeStyle = \"rgba(234,179,8,0.9)\";\r\n      ctx.setLineDash([6, 4]);\r\n      const ax = pad + 30,\r\n        ay = pad + 30;\r\n      ctx.beginPath();\r\n      ctx.moveTo(ax, ay + 30);\r\n      ctx.lineTo(ax + 60, ay);\r\n      ctx.stroke();\r\n      ctx.beginPath();\r\n      ctx.moveTo(o.width - ax, ay + 30);\r\n      ctx.lineTo(o.width - ax - 60, ay);\r\n      ctx.stroke();\r\n      ctx.restore();\r\n      // Legend - draw at fixed size regardless of zoom\r\n      ctx.save();\r\n      ctx.scale(1 / zoom, 1 / zoom); // Inverse scale to keep text static\r\n      ctx.fillStyle = \"rgba(255,255,255,0.85)\";\r\n      ctx.font = \"12px sans-serif\";\r\n      ctx.fillText(\r\n        \"Tip: Frame board centered, edges parallel; slight top-down is okay. Keep bull near center.\",\r\n        pad * zoom,\r\n        (pad + 18) * zoom,\r\n      );\r\n      ctx.restore();\r\n    }\r\n  }\r\n\r\n  function onClickOverlay(e: React.MouseEvent<HTMLCanvasElement>) {\r\n    console.debug('[Calibrator] onClickOverlay entry', phase, e.type);\r\n    // For selection mode allow adding anchor points, but for computed mode we interpret as a test click\r\n    // Also allow camera mode when autocommit test mode is enabled so tests can simulate a click-to-detect\r\n  const allowCameraClick = (phase === \"camera\" || phase === \"capture\") && autoCommitTestMode;\r\n    if (phase !== \"select\" && phase !== \"computed\" && !allowCameraClick) return;\r\n    const el = e.target as HTMLCanvasElement;\r\n    const rect = el.getBoundingClientRect();\r\n    const cssX = e.clientX - rect.left;\r\n    const cssY = e.clientY - rect.top;\r\n    // Map CSS coordinates back to the overlay canvas pixel coordinates, accounting for CSS scaling and zoom\r\n  const scaleX = el.width > 0 ? el.width / (rect.width || (canvasRef.current?.clientWidth || rect.width)) : 1;\r\n  const scaleY = el.height > 0 ? el.height / (rect.height || (canvasRef.current?.clientHeight || rect.height)) : 1;\r\n  const x = cssX * scaleX;\r\n  const y = cssY * scaleY;\r\n  console.debug('[Calibrator] onClickOverlay css/x/y', { cssX, cssY, scaleX, scaleY, x, y });\r\n    if (phase === \"select\") {\r\n      const pts = [...dstPoints, { x, y }];\r\n      if (pts.length <= REQUIRED_POINT_COUNT) {\r\n        setDstPoints(pts);\r\n        drawOverlay(pts);\r\n      }\r\n      return;\r\n    }\r\n    // Phase 'computed' or verification mode: compute a score under calibration\r\n    try {\r\n      const calibState = (useCalibration as any).getState\r\n        ? (useCalibration as any).getState()\r\n        : undefined;\r\n      const Hcur = calibState?.H ?? H;\r\n      const imgSize = calibState?.imageSize ?? imageSize;\r\n  console.debug('[Calibrator] onClickOverlay state', { Hcur, imgSize });\r\n  if (!Hcur || !overlayRef.current || !imgSize) return;\r\n  const o = overlayRef.current;\r\n  // Some test environments may not set canvas width/height; fall back to CSS bounding rect\r\n  const rect2 = o.getBoundingClientRect();\r\n  const fallbackWidth = (canvasRef.current && canvasRef.current.width) ? canvasRef.current.width : rect2.width;\r\n  const fallbackHeight = (canvasRef.current && canvasRef.current.height) ? canvasRef.current.height : rect2.height;\r\n  const sx = (o.width && imgSize.w) ? o.width / imgSize.w : fallbackWidth / imgSize.w;\r\n  const sy = (o.height && imgSize.h) ? o.height / imgSize.h : fallbackHeight / imgSize.h;\r\n  console.debug('[Calibrator] onClickOverlay dims', { oWidth: o.width, oHeight: o.height, rectWidth: rect2.width, rectHeight: rect2.height, fallbackWidth, fallbackHeight, sx, sy });\r\n  // Compute fraction across the visible overlay (fall back to pixel fallbackWidth if rect width is missing)\r\n  const clientWidth = rect2.width || fallbackWidth;\r\n  const clientHeight = rect2.height || fallbackHeight;\r\n  const fracX = clientWidth ? cssX / clientWidth : 0;\r\n  const fracY = clientHeight ? cssY / clientHeight : 0;\r\n  const pCal = { x: fracX * imgSize.w, y: fracY * imgSize.h };\r\n      // Use helper to compute score\r\n  const pBoard = imageToBoard(Hcur as any, pCal);\r\n  console.debug('[Calibrator] onClickOverlay pCal/pBoard', pCal, pBoard);\r\n  const scoreObj = scoreAtBoardPoint(pBoard);\r\n      let val = scoreObj.base;\r\n      // In autocommit test mode, if mapping yields a MISS (0), fallback to a reasonable default value\r\n      // to allow test harnesses to validate commit flows when calibration units don't align.\r\n  console.debug('[Calibrator] autoCommitTestMode', autoCommitTestMode);\r\n  if (autoCommitTestMode && val === 0) {\r\n        val = 25;\r\n      }\r\n      const label = `${scoreObj.ring} ${val}`.trim();\r\n  setLastDetectedValue(val);\r\n  console.debug('[Calibrator] onClickOverlay detected', val, label);\r\n      setLastDetectedLabel(label);\r\n      // For test harness convenience: when autocommit test-mode is enabled but immediate commit is disabled\r\n      // allow a manual commit simulated by a pointer click to commit automatically if calibration is valid.\r\n      try {\r\n        const calibSt = (useCalibration as any).getState ? (useCalibration as any).getState() : undefined;\r\n        const calibrationValidSt = !!calibSt?.H && !!calibSt?.imageSize && (calibSt.locked || (typeof calibSt.errorPx === 'number' && calibSt.errorPx <= ERROR_PX_MAX));\r\n        if (autoCommitTestMode && !autoCommitImmediate && calibrationValidSt && useMatch.getState().inProgress) {\r\n          doCommit(val);\r\n        }\r\n      } catch {}\r\n          // Autofire commit if test autocommit enabled and immediate toggled and a match is active\r\n          if (autoCommitTestMode && autoCommitImmediate && useMatch.getState().inProgress) {\r\n            try {\r\n              const isOnline = useMatch.getState().roomId !== \"\";\r\n              // Offline: commit locally\r\n              if (!isOnline) {\r\n                useMatch.getState().addVisit(val, 3, { visitTotal: val });\r\n              } else {\r\n                // Online: if the user wants server autocommit, request server to apply\r\n                  if (allowAutocommitInOnline) {\r\n                  try {\r\n                    const pBoard = imageToBoard(H as any, pCal);\r\n                    useWS().send({ type: 'auto-visit', roomId: useMatch.getState().roomId, value: val, darts: 3, ring: scoreObj.ring, sector: scoreObj.sector, pBoard, calibrationValid: true })\r\n                  } catch (e) {}\r\n                }\r\n              }\r\n            } catch {}\r\n          }\r\n    } catch (err) {\r\n      /* ignore */\r\n    }\r\n  }\r\n\r\n  function doCommit(val?: number) {\r\n    try {\r\n      const v = typeof val === 'number' ? val : lastDetectedValue;\r\n      console.debug('[Calibrator] doCommit invoked', { v, inProgress: useMatch.getState().inProgress });\r\n      if (v != null && useMatch.getState().inProgress) {\r\n        useMatch.getState().addVisit(v, 3, { visitTotal: v });\r\n      }\r\n    } catch (e) {}\r\n  }\r\n\r\n  function undoPoint() {\r\n    const pts = dstPoints.slice(0, -1);\r\n    setDstPoints(pts);\r\n    drawOverlay(pts);\r\n  }\r\n\r\n  function refinePoints() {\r\n    if (!canvasRef.current || dstPoints.length === 0) return;\r\n    const refined = refinePointsSobel(canvasRef.current, dstPoints, 8);\r\n    setDstPoints(refined);\r\n    drawOverlay(refined);\r\n  }\r\n\r\n  function compute() {\r\n    if (!canvasRef.current) return;\r\n    if (dstPoints.length < REQUIRED_POINT_COUNT) {\r\n      return alert(\r\n        \"Please click all 4 calibration points on the double ring: D20, D6, D3, and D11.\",\r\n      );\r\n    }\r\n    const src = canonicalRimTargets(); // board space mm\r\n    const Hcalc = computeHomographyDLT(src, dstPoints);\r\n    drawOverlay(dstPoints, Hcalc);\r\n    const err = rmsError(Hcalc, src, dstPoints);\r\n    const overlaySize = overlayRef?.current\r\n      ? { w: overlayRef.current.width, h: overlayRef.current.height }\r\n      : videoRef?.current\r\n      ? { w: videoRef.current.clientWidth, h: videoRef.current.clientHeight }\r\n      : { w: canvasRef.current.width, h: canvasRef.current.height };\r\n    setCalibration({\r\n      H: Hcalc as Homography,\r\n      createdAt: Date.now(),\r\n      errorPx: err,\r\n      imageSize: { w: canvasRef.current.width, h: canvasRef.current.height },\r\n      overlaySize,\r\n      anchors: { src, dst: dstPoints },\r\n    });\r\n    setConfidence(100);\r\n    setPhase(\"computed\");\r\n  }\r\n\r\n  function runVerification() {\r\n    if (!H || !overlayRef.current)\r\n      return alert(\r\n        \"Please compute calibration first (lock) before running verification.\",\r\n      );\r\n    try {\r\n      // Prepare a set of canonical board test points (in mm)\r\n      const tests: Array<{ label: string; p: { x: number; y: number } }> = [\r\n        { label: \"Bull (50)\", p: { x: 0, y: 0 } },\r\n        { label: \"Outer Bull (25)\", p: { x: 0, y: -BoardRadii.bullOuter } },\r\n        {\r\n          label: \"Triple 20\",\r\n          p: {\r\n            x: 0,\r\n            y: -((BoardRadii.trebleInner + BoardRadii.trebleOuter) / 2),\r\n          },\r\n        },\r\n        {\r\n          label: \"Single 5 (near 5 sector)\",\r\n          p: {\r\n            x:\r\n              ((BoardRadii.trebleInner + BoardRadii.trebleOuter) / 2) *\r\n              Math.cos(Math.PI * 0.1),\r\n            y:\r\n              ((BoardRadii.trebleInner + BoardRadii.trebleOuter) / 2) *\r\n              Math.sin(Math.PI * 0.1),\r\n          },\r\n        },\r\n      ];\r\n      const ctx = overlayRef.current.getContext(\"2d\")!;\r\n      // Redraw base overlay so markers are visible\r\n      drawOverlay(dstPoints, H);\r\n      const results: Array<any> = [];\r\n      for (const t of tests) {\r\n        const imgP = applyHomography(H as any, { x: t.p.x, y: t.p.y });\r\n        const detectedBoard = imageToBoard(H as any, imgP);\r\n        const detected = scoreAtBoardPoint(detectedBoard);\r\n        const expected = scoreAtBoardPoint(t.p);\r\n        const match =\r\n          (expected.base === detected.base &&\r\n            expected.mult === detected.mult) ||\r\n          expected.base === detected.base;\r\n        results.push({ label: t.label, expected, detected, match });\r\n        // draw marker\r\n        drawCross(ctx, imgP, match ? \"#10b981\" : \"#ef4444\");\r\n        ctx.fillStyle = match ? \"#10b981\" : \"#ef4444\";\r\n        ctx.font = \"12px sans-serif\";\r\n        ctx.fillText(t.label, imgP.x + 6, imgP.y - 6);\r\n      }\r\n      setVerificationResults(results);\r\n    } catch (err) {\r\n      console.error(\"Verification failed\", err);\r\n      alert(\"Verification failed: \" + (err as any)?.message);\r\n    }\r\n  }\r\n\r\n  function resetAll() {\r\n    setDstPoints([]);\r\n    setHasSnapshot(false);\r\n    setPhase(\"camera\");\r\n    drawOverlay([]);\r\n    setMarkerResult(null);\r\n    reset();\r\n  }\r\n\r\n  // --- Auto-detect the double rim from the current snapshot and compute homography ---\r\n  async function autoDetectRings() {\r\n    if (!canvasRef.current)\r\n      return alert(\"Load a photo or capture a frame first.\");\r\n    setAutoCalibrating(true);\r\n    setDetectionMessage(null);\r\n    setMarkerResult(null);\r\n    const src = canvasRef.current;\r\n    // Downscale for speed\r\n    const maxW = 800;\r\n    const scale = Math.min(1, maxW / src.width);\r\n    const dw = Math.max(1, Math.round(src.width * scale));\r\n    const dh = Math.max(1, Math.round(src.height * scale));\r\n    const tmp = document.createElement(\"canvas\");\r\n    tmp.width = dw;\r\n    tmp.height = dh;\r\n    const tctx = tmp.getContext(\"2d\")!;\r\n    tctx.drawImage(src, 0, 0, dw, dh);\r\n    const img = tctx.getImageData(0, 0, dw, dh);\r\n    // Grayscale + Sobel edge magnitude\r\n    const gray = new Float32Array(dw * dh);\r\n    for (let i = 0, p = 0; i < img.data.length; i += 4, p++) {\r\n      const r = img.data[i],\r\n        g = img.data[i + 1],\r\n        b = img.data[i + 2];\r\n      gray[p] = 0.299 * r + 0.587 * g + 0.114 * b;\r\n    }\r\n    const gx = new Float32Array(dw * dh);\r\n    const gy = new Float32Array(dw * dh);\r\n    for (let y = 1; y < dh - 1; y++) {\r\n      for (let x = 1; x < dw - 1; x++) {\r\n        const i = y * dw + x;\r\n        const a = gray[i - dw - 1],\r\n          b = gray[i - dw],\r\n          c = gray[i - dw + 1];\r\n        const d0 = gray[i - 1],\r\n          /*e*/ f0 = gray[i + 1];\r\n        const g0 = gray[i + dw - 1],\r\n          h0 = gray[i + dw],\r\n          j0 = gray[i + dw + 1];\r\n        gx[i] = -a - 2 * d0 - g0 + (c + 2 * f0 + j0);\r\n        gy[i] = -a - 2 * b - c + (g0 + 2 * h0 + j0);\r\n      }\r\n    }\r\n    const mag = new Float32Array(dw * dh);\r\n    let maxMag = 1;\r\n    for (let i = 0; i < mag.length; i++) {\r\n      const m = Math.hypot(gx[i], gy[i]);\r\n      mag[i] = m;\r\n      if (m > maxMag) maxMag = m;\r\n    }\r\n  // Coarse circle search around center for double outer\r\n    const cx0 = Math.floor(dw / 2),\r\n      cy0 = Math.floor(dh / 2);\r\n    const rMin = Math.floor(Math.min(dw, dh) * 0.35);\r\n    const rMax = Math.floor(Math.min(dw, dh) * 0.52);\r\n    let best = {\r\n      score: -1,\r\n      cx: cx0,\r\n      cy: cy0,\r\n      r: Math.floor((rMin + rMax) / 2),\r\n    };\r\n    const stepC = Math.max(2, Math.floor(Math.min(dw, dh) * 0.01)); // center step\r\n    const stepR = Math.max(2, Math.floor(Math.min(dw, dh) * 0.01)); // radius step\r\n    for (\r\n      let cy = cy0 - Math.floor(dh * 0.08);\r\n      cy <= cy0 + Math.floor(dh * 0.08);\r\n      cy += stepC\r\n    ) {\r\n      for (\r\n        let cx = cx0 - Math.floor(dw * 0.08);\r\n        cx <= cx0 + Math.floor(dw * 0.08);\r\n        cx += stepC\r\n      ) {\r\n        for (let r = rMin; r <= rMax; r += stepR) {\r\n          let s = 0;\r\n          const samples = 360;\r\n          for (let a = 0; a < samples; a++) {\r\n            const ang = (a * Math.PI) / 180;\r\n            const x = Math.round(cx + r * Math.cos(ang));\r\n            const y = Math.round(cy + r * Math.sin(ang));\r\n            if (x <= 0 || x >= dw - 1 || y <= 0 || y >= dh - 1) continue;\r\n            s += mag[y * dw + x];\r\n          }\r\n          if (s > best.score) best = { score: s, cx, cy, r };\r\n        }\r\n      }\r\n    }\r\n  // Map back to original canvas coords\r\n    const inv = 1 / scale;\r\n    const OCX = best.cx * inv;\r\n    const OCY = best.cy * inv;\r\n    const OR = best.r * inv;\r\n    // With center/doubleOuter radius fixed, locate other rings via 1D radial search\r\n    function radialScore(rPx: number) {\r\n      let s = 0;\r\n      const rScaled = rPx * scale;\r\n      const samples = 360;\r\n      for (let a = 0; a < samples; a++) {\r\n        const ang = (a * Math.PI) / 180;\r\n        const x = Math.round(best.cx + rScaled * Math.cos(ang));\r\n        const y = Math.round(best.cy + rScaled * Math.sin(ang));\r\n        if (x <= 0 || x >= dw - 1 || y <= 0 || y >= dh - 1) continue;\r\n        s += mag[y * dw + x];\r\n      }\r\n      return s;\r\n    }\r\n    const ratios = {\r\n      bullInner: BoardRadii.bullInner / BoardRadii.doubleOuter,\r\n      bullOuter: BoardRadii.bullOuter / BoardRadii.doubleOuter,\r\n      trebleInner: BoardRadii.trebleInner / BoardRadii.doubleOuter,\r\n      trebleOuter: BoardRadii.trebleOuter / BoardRadii.doubleOuter,\r\n      doubleInner: BoardRadii.doubleInner / BoardRadii.doubleOuter,\r\n      doubleOuter: 1,\r\n    } as const;\r\n    function refineAround(expectedR: number, pctWindow = 0.08) {\r\n      // Reduced window for more precision\r\n      const lo = Math.max(1, Math.floor(expectedR * (1 - pctWindow)));\r\n      const hi = Math.max(lo + 1, Math.floor(expectedR * (1 + pctWindow)));\r\n      let bestR = lo,\r\n        bestS = -1;\r\n      for (let r = lo; r <= hi; r++) {\r\n        const s = radialScore(r);\r\n        if (s > bestS) {\r\n          bestS = s;\r\n          bestR = r;\r\n        }\r\n      }\r\n      return bestR;\r\n    }\r\n  const dOuter = OR;\r\n    const dInner = refineAround(dOuter * ratios.doubleInner);\r\n    const tOuter = refineAround(dOuter * ratios.trebleOuter);\r\n    const tInner = refineAround(dOuter * ratios.trebleInner);\r\n    const bOuter = refineAround(dOuter * ratios.bullOuter);\r\n    const bInner = refineAround(dOuter * ratios.bullInner);\r\n  setDetected({\r\n      cx: OCX,\r\n      cy: OCY,\r\n      bullInner: bInner,\r\n      bullOuter: bOuter,\r\n      trebleInner: tInner,\r\n      trebleOuter: tOuter,\r\n      doubleInner: dInner,\r\n      doubleOuter: dOuter,\r\n    });\r\n    // Estimate confidence: ratio of ring scores around expected vs local baseline\r\n    // Use normalized edge magnitude at found radii to compute a 0-1 score, then scale to percent\r\n    const totalEdge = (r: number) => {\r\n      const samples = 180;\r\n      let s = 0;\r\n      for (let a = 0; a < samples; a++) {\r\n        const ang = (a * Math.PI) / 90;\r\n        const x = Math.round(best.cx + r * scale * Math.cos(ang));\r\n        const y = Math.round(best.cy + r * scale * Math.sin(ang));\r\n        if (x <= 0 || x >= dw - 1 || y <= 0 || y >= dh - 1) continue;\r\n        s += mag[y * dw + x];\r\n      }\r\n      return s / samples;\r\n    };\r\n    const score =\r\n      totalEdge(best.r) +\r\n      totalEdge(tOuter) +\r\n      totalEdge(tInner) +\r\n      totalEdge(dInner) +\r\n      totalEdge(bOuter) +\r\n      totalEdge(bInner);\r\n    const norm = score / (maxMag * 6);\r\n    const conf = Math.max(0, Math.min(1, norm));\r\n    // Apply stricter confidence calculation for perfect calibration\r\n    const adjustedConf = Math.min(\r\n      conf,\r\n      Math.min(\r\n        totalEdge(best.r) / maxMag, // Double outer\r\n        totalEdge(tOuter) / maxMag, // Treble outer\r\n        totalEdge(tInner) / maxMag, // Treble inner\r\n        totalEdge(dInner) / maxMag, // Double inner\r\n        totalEdge(bOuter) / maxMag, // Bull outer\r\n        totalEdge(bInner) / maxMag, // Bull inner\r\n      ),\r\n    );\r\n    setConfidence(forceConfidence ? 100 : Math.round(adjustedConf * 100));\r\n    // Seed the four calibration points for accurate alignment on the double ring\r\n    // Points map to D20 (top), D6 (right), D3 (bottom), D11 (left)\r\n    const pts: Point[] = [\r\n      { x: OCX, y: OCY - dOuter }, // D20\r\n      { x: OCX + dOuter, y: OCY }, // D6\r\n      { x: OCX, y: OCY + dOuter }, // D3\r\n      { x: OCX - dOuter, y: OCY }, // D11\r\n    ];\r\n    setDstPoints(pts);\r\n    drawOverlay(pts);\r\n  // Compute homography with the four rim points\r\n  try {\r\n      const src = canonicalRimTargets(); // board space mm\r\n      const Hcalc = computeHomographyDLT(src, pts);\r\n      drawOverlay(pts, Hcalc);\r\n      const err = rmsError(Hcalc, src, pts);\r\n      const overlaySize = overlayRef?.current\r\n        ? { w: overlayRef.current.width, h: overlayRef.current.height }\r\n        : videoRef?.current\r\n        ? { w: videoRef.current.clientWidth, h: videoRef.current.clientHeight }\r\n        : { w: canvasRef.current.width, h: canvasRef.current.height };\r\n      setCalibration({\r\n        H: Hcalc as Homography,\r\n        createdAt: Date.now(),\r\n        errorPx: err,\r\n        imageSize: { w: canvasRef.current.width, h: canvasRef.current.height },\r\n        overlaySize,\r\n        anchors: { src, dst: pts },\r\n      });\r\n  setPhase(\"computed\");\r\n  setAutoCalibrating(false);\r\n    } catch (e) {\r\n      console.error(\"[Calibrator] Auto-detect compute failed:\", e);\r\n      setAutoCalibrating(false);\r\n    }\r\n    // Run the detection a couple more times and ensure stability using detectBoard which includes a refined algorithm\r\n    try {\r\n      const testRuns = 3;\r\n      let stableCount = 1;\r\n      for (let i = 1; i < testRuns; i++) {\r\n        const tmp2 = document.createElement(\"canvas\");\r\n        tmp2.width = Math.max(1, Math.round(src.width * Math.min(1, maxW / src.width)));\r\n        tmp2.height = Math.max(1, Math.round(src.height * Math.min(1, maxW / src.width)));\r\n        const tctx2 = tmp2.getContext(\"2d\")!;\r\n        tctx2.drawImage(src, 0, 0, tmp2.width, tmp2.height);\r\n        const bd2 = detectBoard(tmp2 as any as HTMLCanvasElement);\r\n        if (bd2 && bd2.success) {\r\n          if (\r\n            isSimilarDetection(\r\n              { cx: OCX, cy: OCY, doubleOuter: OR },\r\n              { cx: bd2.cx, cy: bd2.cy, doubleOuter: bd2.doubleOuter },\r\n            )\r\n          ) stableCount++;\r\n        }\r\n      }\r\n      const stable = stableCount >= Math.ceil(testRuns * 0.66);\r\n      if (!stable) {\r\n        console.warn(\"Auto-detect inconsistent across quick samples, skipping auto-lock\");\r\n      }\r\n      // If not stable, reduce adjustedConf so autoLock will not be triggered\r\n      if (!stable) setConfidence(0);\r\n    } catch (err) {\r\n      // ignore errors\r\n    }\r\n    // Run quick stability checks (rerun detection a couple of times)\r\n    const runs = 3;\r\n    let stableCount = 1;\r\n    for (let i = 1; i < runs; i++) {\r\n      try {\r\n        const tmp3 = document.createElement(\"canvas\");\r\n        tmp3.width = Math.max(1, Math.round(src.width * Math.min(1, maxW / src.width)));\r\n        tmp3.height = Math.max(1, Math.round(src.height * Math.min(1, maxW / src.width)));\r\n        const tctx3 = tmp3.getContext(\"2d\")!;\r\n        tctx3.drawImage(src, 0, 0, tmp3.width, tmp3.height);\r\n        // use detectBoard for consistency\r\n        const bd2 = detectBoard(tmp3 as any as HTMLCanvasElement);\r\n        if (isSimilarDetection({ cx: OCX, cy: OCY, doubleOuter: OR }, { cx: bd2.cx, cy: bd2.cy, doubleOuter: bd2.doubleOuter })) {\r\n          stableCount++;\r\n        }\r\n      } catch (err) {\r\n        // ignore\r\n      }\r\n    }\r\n    const stable = stableCount >= Math.ceil(runs * 0.66);\r\n    // Auto-lock if confidence high, error small and stable across runs\r\n  // Require stability regardless of forceConfidence; allow forceConfidence to help reach confidence thresholds,\r\n  // but never bypass the stability check to set a locked calibration from a single noisy frame.\r\n  const autoLock = (forceConfidence ? true : adjustedConf >= 0.95) && stable;\r\n    const overlaySizeForLock = overlayRef?.current\r\n      ? { w: overlayRef.current.width, h: overlayRef.current.height }\r\n      : videoRef?.current\r\n      ? { w: videoRef.current.clientWidth, h: videoRef.current.clientHeight }\r\n      : canvasRef?.current\r\n      ? { w: canvasRef.current.width, h: canvasRef.current.height }\r\n      : null;\r\n    if (autoLock) {\r\n      setCalibration({ locked: true, overlaySize: overlaySizeForLock });\r\n    } else {\r\n      setCalibration({ locked: false });\r\n    }\r\n    setDetectionMessage(`Auto-detect completed  confidence: ${Math.round(adjustedConf * 100)}%`);\r\n    setAutoCalibrating(false);\r\n  }\r\n\r\n  // Helper: refine detection stability by running the same ring detection a few times and ensure values are close\r\n  function isSimilarDetection(a: any, b: any, tol = 0.03) {\r\n    if (!a || !b) return false;\r\n    const dx = Math.abs((a.cx - b.cx) / (a.cx || 1));\r\n    const dy = Math.abs((a.cy - b.cy) / (a.cy || 1));\r\n    const dr = Math.abs((a.doubleOuter - b.doubleOuter) / (a.doubleOuter || 1));\r\n    return dx <= tol && dy <= tol && dr <= tol;\r\n  }\r\n\r\n  const workerRef = useRef<Worker | null>(null);\r\n  useEffect(() => {\r\n    let w: Worker | null = null;\r\n    try {\r\n      w = new Worker(\r\n        new URL(\"../workers/boardDetection.worker.ts\", import.meta.url),\r\n        { type: \"module\" } as any,\r\n      );\r\n      workerRef.current = w;\r\n      console.log(\"[Calibrator] Board detection worker created\");\r\n    } catch (err) {\r\n      console.warn(\r\n        \"[Calibrator] Failed to create board detection worker, will fallback to main thread: \",\r\n        err,\r\n      );\r\n      workerRef.current = null;\r\n    }\r\n    return () => {\r\n      try {\r\n        w?.terminate();\r\n      } catch {}\r\n    };\r\n  }, []);\r\n\r\n  // Advanced auto-calibration: detect board features without markers or manual clicking\r\n  async function autoCalibrate() {\r\n    if (!canvasRef.current)\r\n      return alert(\"Capture a frame or upload a photo first.\");\r\n    // If worker is available, use it; otherwise fall back to synchronous detection\r\n    if (workerRef.current) {\r\n      setAutoCalibrating(true);\r\n      let bitmap: ImageBitmap | null = null;\r\n      try {\r\n        bitmap = await createImageBitmap(canvasRef.current);\r\n      } catch (err) {\r\n        console.warn(\r\n          \"[Calibrator] createImageBitmap failed; falling back to main thread detection\",\r\n          err,\r\n        );\r\n        bitmap = null;\r\n      }\r\n      if (!bitmap) {\r\n        setAutoCalibrating(false);\r\n        // fallback: run sync detection\r\n        return autoCalibrateSync();\r\n      }\r\n      try {\r\n        const worker = workerRef.current;\r\n        if (!worker) return autoCalibrateSync();\r\n        return new Promise<void>((resolve) => {\r\n          // eslint-disable-next-line prefer-const\r\n          let timeoutId: ReturnType<typeof setTimeout> | undefined;\r\n          const onMessage = (ev: MessageEvent) => {\r\n            try {\r\n              if (ev.data && ev.data.error) {\r\n                const errMsg = ev.data.error || \"Auto-calibration failed\";\r\n                alert(`Auto-calibration failed: ${errMsg}`);\r\n                setDetectionMessage(errMsg);\r\n                setAutoCalibrating(false);\r\n                if (timeoutId) clearTimeout(timeoutId);\r\n                worker.removeEventListener(\"message\", onMessage);\r\n                resolve();\r\n                return;\r\n              }\r\n              if (ev.data && ev.data.type === \"result\") {\r\n                const boardDetection = ev.data\r\n                  .detection as BoardDetectionResult;\r\n                // Respect forceConfidence\r\n                if (forceConfidence) boardDetection.confidence = 100;\r\n                // If we have missing homography, try to compute a homography from detected points\r\n                if (\r\n                    (!boardDetection.homography ||\r\n                      !Array.isArray(boardDetection.calibrationPoints) ||\r\n                      boardDetection.calibrationPoints.length < 4)\r\n                  ) {\r\n                  const points = boardDetection.calibrationPoints || [];\r\n                    if (points.length >= 4) {\r\n                    const canonicalSrc = [\r\n                      { x: 0, y: -BoardRadii.doubleOuter },\r\n                      { x: BoardRadii.doubleOuter, y: 0 },\r\n                      { x: 0, y: BoardRadii.doubleOuter },\r\n                      { x: -BoardRadii.doubleOuter, y: 0 },\r\n                    ];\r\n                    try {\r\n                      const H = computeHomographyDLT(\r\n                        canonicalSrc,\r\n                        points.slice(0, 4),\r\n                      );\r\n                      boardDetection.homography = H;\r\n                      boardDetection.errorPx = rmsError(\r\n                        H,\r\n                        canonicalSrc,\r\n                        points.slice(0, 4),\r\n                      );\r\n                    } catch (err) {\r\n                      console.warn(\r\n                          \"[Calibrator] Worker homography compute failed\",\r\n                        err,\r\n                      );\r\n                    }\r\n                  }\r\n                }\r\n                if (\r\n                  !boardDetection.success ||\r\n                  !boardDetection.homography ||\r\n                  (!forceConfidence && boardDetection.confidence < 50)\r\n                ) {\r\n                  alert(\r\n                    ` Board Detection Failed\\n\\nConfidence: ${Math.round(boardDetection.confidence)}%\\n\\n${boardDetection.message}\\n\\nTry:\\n Better lighting\\n Closer camera angle\\n Make sure entire board is visible\\n Use manual calibration instead (click the 4 double-ring points: D20, D6, D3, D11)`,\r\n                  );\r\n                  setAutoCalibrating(false);\r\n                  if (timeoutId) clearTimeout(timeoutId);\r\n                  worker.removeEventListener(\"message\", onMessage);\r\n                  resolve();\r\n                  return;\r\n                }\r\n                // Apply the calibration\r\n                setDetected({\r\n                  cx: boardDetection.cx,\r\n                  cy: boardDetection.cy,\r\n                  bullInner: boardDetection.bullInner,\r\n                  bullOuter: boardDetection.bullOuter,\r\n                  trebleInner: boardDetection.trebleInner,\r\n                  trebleOuter: boardDetection.trebleOuter,\r\n                  doubleInner: boardDetection.doubleInner,\r\n                  doubleOuter: boardDetection.doubleOuter,\r\n                });\r\n                setDstPoints(boardDetection.calibrationPoints);\r\n                drawOverlay(\r\n                  boardDetection.calibrationPoints,\r\n                  boardDetection.homography,\r\n                );\r\n                let shouldLock =\r\n                  (boardDetection.errorPx ?? Number.POSITIVE_INFINITY) <= 2.0;\r\n                // Validate detection stability by rerunning local detection a couple times\r\n                try {\r\n                  let stableCount2 = 1;\r\n                  const runs2 = 3;\r\n                  for (let i = 1; i < runs2; i++) {\r\n                    const small = document.createElement(\"canvas\");\r\n                    small.width = Math.max(1, Math.round(canvasRef.current!.width * 0.8));\r\n                    small.height = Math.max(1, Math.round(canvasRef.current!.height * 0.8));\r\n                    const sctx = small.getContext(\"2d\")!;\r\n                    sctx.drawImage(canvasRef.current!, 0, 0, small.width, small.height);\r\n                    const bd2 = detectBoard(small as any as HTMLCanvasElement);\r\n                    if (isSimilarDetection(boardDetection as any, bd2 as any)) stableCount2++;\r\n                  }\r\n                  const stable2 = stableCount2 >= Math.ceil(runs2 * 0.66);\r\n                  shouldLock = shouldLock && stable2;\r\n                } catch (err) {\r\n                  // ignore stability failures\r\n                }\r\n                const overlaySize = overlayRef?.current\r\n                  ? { w: overlayRef.current.width, h: overlayRef.current.height }\r\n                  : videoRef?.current\r\n                  ? { w: videoRef.current.clientWidth, h: videoRef.current.clientHeight }\r\n                  : { w: canvasRef.current?.width ?? 0, h: canvasRef.current?.height ?? 0 };\r\n                setCalibration({\r\n                  H: boardDetection.homography as Homography,\r\n                  createdAt: Date.now(),\r\n                  errorPx: boardDetection.errorPx ?? null,\r\n                  imageSize: {\r\n                    w: canvasRef.current?.width ?? 0,\r\n                    h: canvasRef.current?.height ?? 0,\r\n                  },\r\n                  overlaySize,\r\n                  anchors: {\r\n                    src: canonicalRimTargets().slice(0, 4),\r\n                    dst: boardDetection.calibrationPoints,\r\n                  },\r\n                  locked: shouldLock ? true : locked,\r\n                });\r\n                setDetectionMessage(boardDetection.message ?? `Auto-calibration success (confidence ${Math.round(boardDetection.confidence)}%)`);\r\n                setPhase(\"computed\");\r\n                setConfidence(\r\n                  forceConfidence ? 100 : Math.round(boardDetection.confidence),\r\n                );\r\n                setCalibration({ errorPx: boardDetection.errorPx ?? null });\r\n                setAutoCalibrating(false);\r\n                worker.removeEventListener(\"message\", onMessage);\r\n                resolve();\r\n                return;\r\n              }\r\n            } catch (err) {\r\n              console.warn(\r\n                \"[Calibrator] Worker message processing failed\",\r\n                err,\r\n              );\r\n              setAutoCalibrating(false);\r\n              worker.removeEventListener(\"message\", onMessage);\r\n              resolve();\r\n              return;\r\n            }\r\n          };\r\n          worker.addEventListener(\"message\", onMessage);\r\n          worker.postMessage({ type: \"detect\", bitmap }, [bitmap]);\r\n          // safety timeout - fallback to sync after 8s\r\n          timeoutId = setTimeout(() => {\r\n            if (autoCalibrating) {\r\n              console.warn(\r\n                \"[Calibrator] Worker timed out, attempting sync fallback\",\r\n              );\r\n              setAutoCalibrating(false);\r\n              if (timeoutId) clearTimeout(timeoutId);\r\n              worker.removeEventListener(\"message\", onMessage);\r\n              autoCalibrateSync();\r\n            }\r\n          }, 8000);\r\n        });\r\n      } catch (err) {\r\n        console.warn(\"[Calibrator] AutoCalibrate worker payload failed\", err);\r\n        setAutoCalibrating(false);\r\n        return autoCalibrateSync();\r\n      }\r\n    } else {\r\n      return autoCalibrateSync();\r\n    }\r\n  }\r\n\r\n  // Synchronous fallback for autoCalibrate if no worker available\r\n  async function autoCalibrateSync() {\r\n    setAutoCalibrating(true);\r\n    let boardDetection = detectBoard(canvasRef.current!);\r\n    boardDetection = refineRingDetection(boardDetection);\r\n    if (forceConfidence) boardDetection.confidence = 100;\r\n    if (\r\n      (!boardDetection.homography ||\r\n        !Array.isArray(boardDetection.calibrationPoints) ||\r\n        boardDetection.calibrationPoints.length < 4)\r\n    ) {\r\n      try {\r\n        const points = boardDetection.calibrationPoints || [];\r\n        if (points.length >= 4) {\r\n          const canonicalSrc = [\r\n            { x: 0, y: -BoardRadii.doubleOuter },\r\n            { x: BoardRadii.doubleOuter, y: 0 },\r\n            { x: 0, y: BoardRadii.doubleOuter },\r\n            { x: -BoardRadii.doubleOuter, y: 0 },\r\n          ];\r\n          const H = computeHomographyDLT(canonicalSrc, points.slice(0, 4));\r\n          boardDetection.homography = H;\r\n          boardDetection.errorPx = rmsError(\r\n            H,\r\n            canonicalSrc,\r\n            points.slice(0, 4),\r\n          );\r\n        }\r\n      } catch (err) {\r\n        console.warn(\"[Calibrator] sync forced homography compute failed\", err);\r\n      }\r\n    }\r\n    if (\r\n      !boardDetection.success ||\r\n      !boardDetection.homography ||\r\n      (!forceConfidence && boardDetection.confidence < 50)\r\n    ) {\r\n      // Try multi-scale detection attempts to increase robustness on blurry/low-res images\r\n      const scales = [0.9, 0.8, 1.1, 1.2];\r\n      for (const scale of scales) {\r\n        try {\r\n          const srcCanvas = canvasRef.current!;\r\n          const tmp = document.createElement('canvas');\r\n          tmp.width = Math.max(1, Math.round(srcCanvas.width * scale));\r\n          tmp.height = Math.max(1, Math.round(srcCanvas.height * scale));\r\n          const tctx = tmp.getContext('2d');\r\n          if (!tctx) continue;\r\n          tctx.drawImage(srcCanvas, 0, 0, tmp.width, tmp.height);\r\n          let bd = detectBoard(tmp as any as HTMLCanvasElement);\r\n          bd = refineRingDetection(bd);\r\n          if (bd.success && bd.homography) {\r\n            // Scale found points back to original coordinate space\r\n            const invScale = 1 / scale;\r\n            bd.cx *= invScale;\r\n            bd.cy *= invScale;\r\n            bd.bullInner *= invScale;\r\n            bd.bullOuter *= invScale;\r\n            bd.trebleInner *= invScale;\r\n            bd.trebleOuter *= invScale;\r\n            bd.doubleInner *= invScale;\r\n            bd.doubleOuter *= invScale;\r\n            bd.calibrationPoints = bd.calibrationPoints.map((p) => ({ x: p.x * invScale, y: p.y * invScale }));\r\n            boardDetection = bd;\r\n            break;\r\n          }\r\n        } catch (err) {\r\n          // continue on error\r\n        }\r\n      }\r\n    }\r\n    // Re-run the post-success checks after potential multi-scale detection\r\n    if (\r\n      !boardDetection.success ||\r\n      !boardDetection.homography ||\r\n      (!forceConfidence && boardDetection.confidence < 50)\r\n    ) {\r\n      alert(\r\n        ` Board Detection Failed\\n\\nConfidence: ${Math.round(boardDetection.confidence)}%\\n\\n${boardDetection.message}\\n\\nTry:\\n Better lighting\\n Closer camera angle\\n Make sure entire board is visible\\n Use manual calibration instead (click the 4 double-ring points: D20, D6, D3, D11)`,\r\n      );\r\n      setDetectionMessage(boardDetection.message ?? null);\r\n      setAutoCalibrating(false);\r\n      return;\r\n    }\r\n    // Apply detection (same as worker result processing)\r\n    setDetected({\r\n      cx: boardDetection.cx,\r\n      cy: boardDetection.cy,\r\n      bullInner: boardDetection.bullInner,\r\n      bullOuter: boardDetection.bullOuter,\r\n      trebleInner: boardDetection.trebleInner,\r\n      trebleOuter: boardDetection.trebleOuter,\r\n      doubleInner: boardDetection.doubleInner,\r\n      doubleOuter: boardDetection.doubleOuter,\r\n    });\r\n    setDstPoints(boardDetection.calibrationPoints);\r\n    drawOverlay(boardDetection.calibrationPoints, boardDetection.homography);\r\n    // Check stability of the detection across quick re-runs to avoid locking from noisy frames\r\n    const baseCheck = (boardDetection.errorPx ?? Number.POSITIVE_INFINITY) <= 2.0;\r\n    let stabilityCount = 1;\r\n    const stabilityRuns = 3;\r\n    for (let i = 1; i < stabilityRuns; i++) {\r\n      try {\r\n        const tmp = document.createElement(\"canvas\");\r\n        tmp.width = Math.max(1, Math.round(canvasRef.current!.width * 0.9));\r\n        tmp.height = Math.max(1, Math.round(canvasRef.current!.height * 0.9));\r\n        const tctx = tmp.getContext(\"2d\")!;\r\n        tctx.drawImage(canvasRef.current!, 0, 0, tmp.width, tmp.height);\r\n        const bd2 = detectBoard(tmp as any as HTMLCanvasElement);\r\n        if (isSimilarDetection(boardDetection as any, bd2 as any)) stabilityCount++;\r\n      } catch (err) {\r\n        // ignore\r\n      }\r\n    }\r\n    const stable = stabilityCount >= Math.ceil(stabilityRuns * 0.66);\r\n    const shouldLock = baseCheck && stable;\r\n    const overlaySize = overlayRef?.current\r\n      ? { w: overlayRef.current.width, h: overlayRef.current.height }\r\n      : videoRef?.current\r\n      ? { w: videoRef.current.clientWidth, h: videoRef.current.clientHeight }\r\n      : { w: canvasRef.current!.width, h: canvasRef.current!.height };\r\n    setCalibration({\r\n      H: boardDetection.homography as Homography,\r\n      createdAt: Date.now(),\r\n      errorPx: boardDetection.errorPx ?? null,\r\n      imageSize: { w: canvasRef.current!.width, h: canvasRef.current!.height },\r\n      overlaySize,\r\n      anchors: {\r\n        src: canonicalRimTargets().slice(0, 4),\r\n        dst: boardDetection.calibrationPoints,\r\n      },\r\n      locked: shouldLock ? true : locked,\r\n    });\r\n    setPhase(\"computed\");\r\n    setConfidence(\r\n      forceConfidence ? 100 : Math.round(boardDetection.confidence),\r\n    );\r\n    setCalibration({ errorPx: boardDetection.errorPx ?? null });\r\n  setDetectionMessage(boardDetection.message ?? null);\r\n  setAutoCalibrating(false);\r\n  }\r\n\r\n  function detectMarkers() {\r\n    if (!canvasRef.current)\r\n      return alert(\"Capture a frame or upload a photo first.\");\r\n    const result = detectMarkersFromCanvas(canvasRef.current);\r\n    setMarkerResult(result);\r\n    if (!result.success || !result.homography) {\r\n      const missingMsg = result.missing.length\r\n        ? ` Missing markers: ${result.missing.map((k) => `${k.toUpperCase()} (ID ${MARKER_TARGETS[k]})`).join(\", \")}`\r\n        : \"\";\r\n      const foundMsg =\r\n        result.markersFound.length > 0\r\n          ? `\\n\\nDetected ${result.markersFound.length} markers with IDs: ${result.markersFound.map((m) => m.id).join(\", \")}`\r\n          : \"\\n\\nNo markers detected. Make sure markers are on white paper, fully visible, and well-lit.\";\r\n      const fullMsg = `${result.message}${missingMsg}${foundMsg}\\n\\nYou can still use manual calibration: click the 4 double-ring points (D20, D6, D3, D11).`;\r\n      alert(fullMsg);\r\n      return;\r\n    }\r\n    setDetected(null);\r\n    setDstPoints(result.points);\r\n    drawOverlay(result.points, result.homography);\r\n    const src = canonicalRimTargets();\r\n    const imageSize = {\r\n      w: canvasRef.current.width,\r\n      h: canvasRef.current.height,\r\n    };\r\n    const overlaySize = overlayRef?.current\r\n      ? { w: overlayRef.current.width, h: overlayRef.current.height }\r\n      : videoRef?.current\r\n      ? { w: videoRef.current.clientWidth, h: videoRef.current.clientHeight }\r\n      : { w: canvasRef.current.width, h: canvasRef.current.height };\r\n    const shouldLock = (result.errorPx ?? Number.POSITIVE_INFINITY) <= 1.2;\r\n    setCalibration({\r\n      H: result.homography as Homography,\r\n      createdAt: Date.now(),\r\n      errorPx: result.errorPx ?? null,\r\n      imageSize,\r\n      overlaySize,\r\n      anchors: { src, dst: result.points },\r\n      locked: shouldLock ? true : locked,\r\n    });\r\n    setPhase(\"computed\");\r\n  }\r\n\r\n  useEffect(() => {\r\n    drawOverlay();\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  }, [hasSnapshot, H]);\r\n\r\n  // Live detection loop (runs only when streaming and liveDetect is on)\r\n  useEffect(() => {\r\n    if (!liveDetect || !streaming) return;\r\n    let raf = 0;\r\n    const tick = () => {\r\n      try {\r\n        captureFrame();\r\n      } catch {}\r\n      raf = requestAnimationFrame(tick);\r\n    };\r\n    raf = requestAnimationFrame(tick);\r\n    return () => cancelAnimationFrame(raf);\r\n  }, [liveDetect, streaming]);\r\n\r\n  // When calibration is locked and we have a pairing code, publish calibration to server\r\n  useEffect(() => {\r\n    (async () => {\r\n      try {\r\n        if (!locked || !pairCode) return;\r\n        // Build a compact calibration payload including current canvas size if available\r\n        const imgSize = canvasRef.current\r\n          ? { w: canvasRef.current.width, h: canvasRef.current.height }\r\n          : null;\r\n        const bodyStr = JSON.stringify({\r\n          H,\r\n          anchors: null,\r\n          imageSize: imgSize,\r\n          errorPx: errorPx ?? null,\r\n        });\r\n        try {\r\n          await apiFetch(`/cam/calibration/${pairCode}`, {\r\n            method: \"POST\",\r\n            headers: { \"Content-Type\": \"application/json\" },\r\n            body: bodyStr,\r\n          });\r\n          console.log(\"[Calibrator] Posted calibration for code\", pairCode);\r\n        } catch (err) {\r\n          console.warn(\"[Calibrator] Upload calibration failed\", err);\r\n        }\r\n        // If user is authenticated, persist calibration to their account (Supabase-backed)\r\n        try {\r\n          const token = localStorage.getItem(\"authToken\");\r\n          if (token) {\r\n            await apiFetch(\"/api/user/calibration\", {\r\n              method: \"POST\",\r\n              headers: {\r\n                \"Content-Type\": \"application/json\",\r\n                Authorization: `Bearer ${token}`,\r\n              },\r\n              body: bodyStr,\r\n            });\r\n            console.log(\"[Calibrator] Synced calibration to user account\");\r\n          }\r\n        } catch (err) {\r\n          console.warn(\"[Calibrator] User calibration sync failed\", err);\r\n        }\r\n      } catch (e) {\r\n        /* ignore */\r\n      }\r\n    })();\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  }, [locked, pairCode]);\r\n\r\n  // DevicePicker moved from SettingsPanel\r\n  function DevicePicker() {\r\n    // Toggle to enable debug logs for dropdown behavior (set false to disable)\r\n    const DROPDOWN_DEBUG = true;\r\n    const {\r\n      preferredCameraId,\r\n      preferredCameraLabel,\r\n      setPreferredCamera,\r\n      cameraEnabled,\r\n      setCameraEnabled,\r\n      preferredCameraLocked,\r\n      setPreferredCameraLocked,\r\n    } = useUserSettings();\r\n    // Use outer videoDevices and refreshVideoDevices instead of local enumerate\r\n    const [localDevicesSnapshot, setLocalDevicesSnapshot] = useState<\r\n      Array<{ deviceId: string; label: string }> | null\r\n    >(null);\r\n    const [err, setErr] = useState(\"\");\r\n    const [dropdownOpen, setDropdownOpen] = useState(false);\r\n    const dropdownRef = useRef<HTMLDivElement>(null);\r\n    const ignoreCloseUntilRef = useRef<number>(0);\r\n    // When true, the document outside-click handler is temporarily suspended\r\n    const suspendDocHandlerRef = useRef<boolean>(false);\r\n    const dropdownPortal =\r\n      document.getElementById(\"dropdown-portal-root\") ||\r\n      (() => {\r\n        const el = document.createElement(\"div\");\r\n        el.id = \"dropdown-portal-root\";\r\n        document.body.appendChild(el);\r\n        return el;\r\n      })();\r\n\r\n    async function enumerate() {\r\n      // Prefer the global device refresh; it's fast and doesn't prompt for permission\r\n      if (DROPDOWN_DEBUG) console.debug(\"[DevicePicker] enumerate -> using global refreshVideoDevices\", Date.now());\r\n      setErr(\"\");\r\n      try {\r\n        await refreshVideoDevices();\r\n        const cams = videoDevices;\r\n        // If the picker is open, keep a stable snapshot so the list doesn't jump while interacting\r\n        if (\r\n          dropdownRef.current &&\r\n          (dropdownRef.current as any).dataset?.open === \"true\"\r\n        ) {\r\n          setLocalDevicesSnapshot(cams);\r\n        }\r\n        if (DROPDOWN_DEBUG)\r\n          console.debug(\r\n            \"[DevicePicker] enumerate -> devices (global)\",\r\n            cams.map((c) => c.deviceId),\r\n            \"snapshot?\",\r\n            !!(\r\n              dropdownRef.current &&\r\n              (dropdownRef.current as any).dataset?.open === \"true\"\r\n            ),\r\n          );\r\n      } catch (e: any) {\r\n        setErr(\r\n          \"Unable to list cameras. Grant camera permission in your browser.\",\r\n        );\r\n      }\r\n    }\r\n\r\n    useEffect(() => {\r\n      // enumerate device list with global refresh; display quickly\r\n      enumerate();\r\n    }, [videoDevices.length]);\r\n\r\n    // Close dropdown when clicking outside. Guard against immediate close\r\n    // caused by focus/stream state churn by briefly ignoring outside clicks\r\n    useEffect(() => {\r\n      function handleClickOutside(event: MouseEvent) {\r\n        try {\r\n          if (DROPDOWN_DEBUG)\r\n            console.debug(\"[DevicePicker] document.mousedown\", {\r\n              target:\r\n                (event && (event.target as any))?.tagName ||\r\n                String(event.target),\r\n              time: Date.now(),\r\n              ignoreUntil: ignoreCloseUntilRef.current,\r\n            });\r\n          // If suspended (recently opened) don't close yet\r\n          if (suspendDocHandlerRef.current) {\r\n            if (DROPDOWN_DEBUG)\r\n              console.debug(\r\n                \"[DevicePicker] document.mousedown ignored because suspendDocHandlerRef is true\",\r\n                Date.now(),\r\n              );\r\n            return;\r\n          }\r\n          // If we're within the ignore window, don't close yet\r\n          if (Date.now() < (ignoreCloseUntilRef.current || 0)) return;\r\n          // Treat clicks inside the portal as inside the dropdown (portal elements live outside dropdownRef)\r\n          const tgt = event.target as Node;\r\n          const clickedInsideMain =\r\n            dropdownRef.current && dropdownRef.current.contains(tgt);\r\n          const clickedInsidePortal =\r\n            dropdownPortal &&\r\n            dropdownPortal.contains &&\r\n            dropdownPortal.contains(tgt);\r\n          if (!clickedInsideMain && !clickedInsidePortal) {\r\n            if (DROPDOWN_DEBUG)\r\n              console.debug(\r\n                \"[DevicePicker] document.mousedown -> closing dropdown (outside both main+portal)\",\r\n                Date.now(),\r\n              );\r\n            setDropdownOpen(false);\r\n          }\r\n        } catch {}\r\n      }\r\n    document.addEventListener(\"mousedown\", handleClickOutside);\r\n    // pointerdown covers pointer devices; touchstart covers legacy touch-only devices\r\n    document.addEventListener(\"pointerdown\", handleClickOutside as any);\r\n    document.addEventListener(\"touchstart\", handleClickOutside as any);\r\n      return () => {\r\n    document.removeEventListener(\"mousedown\", handleClickOutside);\r\n    document.removeEventListener(\"pointerdown\", handleClickOutside as any);\r\n    document.removeEventListener(\"touchstart\", handleClickOutside as any);\r\n      };\r\n    }, []);\r\n\r\n    const selectedDevice = (localDevicesSnapshot || videoDevices).find(\r\n      (d) => d.deviceId === preferredCameraId,\r\n    );\r\n    const selectedLabel = selectedDevice\r\n      ? `${selectedDevice.label || \"Camera\"}`\r\n      : preferredCameraId\r\n        ? \"Camera (unavailable)\"\r\n        : \"Auto (browser default)\";\r\n    // Local immediate label so UI reflects selection instantly even if global store\r\n    const [localSelectedLabel, setLocalSelectedLabel] =\r\n      useState<string>(selectedLabel);\r\n\r\n    // If preferred camera is set but not found, show a warning\r\n  const preferredCameraUnavailable = preferredCameraId && !selectedDevice;\r\n\r\n    return (\r\n      <div ref={dropdownRef} className=\"mt-3 p-3 rounded-lg border border-indigo-500/30 bg-indigo-500/5\">\r\n        <div className=\"font-semibold mb-2\">Select camera device</div>\r\n        {err && <div className=\"text-rose-400 text-sm mb-2\">{err}</div>}\r\n        {videoDevices.length === 0 && !err && (\r\n          <div className=\"text-xs text-slate-400 mb-2\">Detecting devices... (click \"Rescan\" if this hangs)</div>\r\n        )}\r\n        {preferredCameraUnavailable && (\r\n          <div className=\"text-amber-400 text-sm mb-2\">\r\n            Selected camera is no longer available.\r\n            <button\r\n              className=\"underline ml-1\"\r\n              onClick={() => setPreferredCamera(undefined, \"\", true)}\r\n              disabled={streaming}\r\n            >\r\n              Use auto-selection\r\n            </button>\r\n          </div>\r\n        )}\r\n        {/* Lock indicator and toggle for camera selection */}\r\n        <div className=\"flex items-center gap-2 mb-2\">\r\n          {preferredCameraLocked ? (\r\n            <div className=\"text-xs text-emerald-400\">\r\n               Camera selection locked\r\n            </div>\r\n          ) : (\r\n            <div className=\"text-xs text-slate-400\">\r\n              Camera selection unlocked\r\n            </div>\r\n          )}\r\n          <button\r\n            className=\"btn btn--ghost px-2 py-0.5 text-xs ml-2\"\r\n            onClick={() => {\r\n              setPreferredCameraLocked(!preferredCameraLocked);\r\n            }}\r\n          >\r\n            {preferredCameraLocked ? \"Unlock\" : \"Lock\"}\r\n          </button>\r\n        </div>\r\n        <div className=\"flex items-center gap-3 mb-3\">\r\n          <input\r\n            type=\"checkbox\"\r\n            id=\"cameraEnabled-calibrator\"\r\n            checked={cameraEnabled}\r\n            onChange={(e) => setCameraEnabled(e.target.checked)}\r\n            className=\"w-4 h-4\"\r\n            disabled={streaming}\r\n          />\r\n          <label htmlFor=\"cameraEnabled-calibrator\" className=\"text-sm\">\r\n            Enable camera for scoring\r\n          </label>\r\n        </div>\r\n        <div className=\"grid grid-cols-3 gap-2 items-center text-sm\">\r\n          <select\r\n            onFocus={() => {\r\n              try {\r\n                if (dropdownRef.current) (dropdownRef.current as any).dataset.open = \"true\";\r\n                ignoreCloseUntilRef.current = Date.now() + 350; // give a short ignore window\r\n              } catch (e) {}\r\n              try { enumerate(); } catch {}\r\n            }}\r\n            onBlur={() => {\r\n              try {\r\n                if (dropdownRef.current) (dropdownRef.current as any).dataset.open = \"false\";\r\n              } catch (e) {}\r\n            }}\r\n            onPointerDown={(e) => { (e as any).stopPropagation(); }}\r\n            onMouseDown={(e) => { e.stopPropagation(); }}\r\n            onTouchStart={(e) => { (e as any).stopPropagation?.(); }}\r\n            className=\"input col-span-2\"\r\n            value={preferredCameraId || \"auto\"}\r\n            onChange={(e) => {\r\n              const val = e.target.value;\r\n              if (DROPDOWN_DEBUG)\r\n                console.debug(\r\n                  \"[DevicePicker] select onChange\",\r\n                  val,\r\n                  Date.now(),\r\n                );\r\n              if (val === \"auto\") {\r\n                try {\r\n                  setPreferredCamera(undefined, \"\", true);\r\n                } catch {}\r\n              } else if (val === \"phone\") {\r\n                try {\r\n                  setPreferredCamera(undefined, \"Phone Camera\", true);\r\n                } catch {}\r\n                try {\r\n                  setMode(\"phone\");\r\n                  setPhase(\"camera\");\r\n                  setStreaming(false);\r\n                  setHasSnapshot(false);\r\n                } catch {}\r\n              } else {\r\n                const device = (localDevicesSnapshot || videoDevices).find((d) => d.deviceId === val);\r\n                if (device) {\r\n                  try {\r\n                    setPreferredCamera(\r\n                      device.deviceId,\r\n                      device.label || \"\",\r\n                      true,\r\n                    );\r\n                  } catch {}\r\n                }\r\n              }\r\n            }}\r\n          >\r\n            <option value=\"auto\">Auto (browser default)</option>\r\n            {(localDevicesSnapshot || videoDevices).map((d) => (\r\n              <option key={d.deviceId} value={d.deviceId}>\r\n                {d.label || \"Camera\"}\r\n              </option>\r\n            ))}\r\n            <option value=\"phone\"> Phone Camera</option>\r\n          </select>\r\n          {videoDevices.length === 0 && (\r\n            <div className=\"col-span-1 flex gap-2 items-center justify-end\">\r\n              <button\r\n                className=\"btn btn--ghost btn-sm\"\r\n                onClick={async () => {\r\n                  try {\r\n                    await testCamera();\r\n                    await refreshVideoDevices();\r\n                  } catch (err) {\r\n                    console.warn('[Calibrator] request camera permission failed', err);\r\n                  }\r\n                }}\r\n              >\r\n                Enable local camera\r\n              </button>\r\n              <button\r\n                className=\"btn btn--ghost btn-sm\"\r\n                onClick={async () => await refreshVideoDevices()}\r\n              >\r\n                Rescan\r\n              </button>\r\n            </div>\r\n          )}\r\n            <div className=\"text-right\">\r\n            <button\r\n              className=\"btn px-2 py-1\"\r\n              onClick={() => {\r\n                testCamera(preferredCameraId || undefined);\r\n              }}\r\n              disabled={streaming}\r\n            >\r\n              Test\r\n            </button>\r\n                <div className=\"text-xs mt-2 flex items-center justify-end gap-2\">\r\n                <div className=\"text-xs opacity-70 flex items-center gap-2\">\r\n                  <span>{lastDetectedLabel ? `Detected: ${lastDetectedLabel}` : \"No recent detection\"}</span>\r\n                    {(lastDetectedLabel != null || autoCommitTestMode) && (\r\n                      <button\r\n                        className=\"btn btn--ghost btn-sm\"\r\n                        onClick={() => {\r\n                          console.debug('[Calibrator] top Commit detected click (onClick)');// eslint-disable-line no-console\r\n                          doCommit();\r\n                        }}\r\n                        onPointerDown={() => {\r\n                          console.debug('[Calibrator] top Commit detected click (onPointerDown)');// eslint-disable-line no-console\r\n                          doCommit();\r\n                        }}\r\n                        disabled={lastDetectedValue == null}\r\n                      >\r\n                        Commit detected\r\n                      </button>\r\n                  )}\r\n                  <span className={`inline-block w-2.5 h-2.5 rounded-full ${calibrationValid ? 'bg-emerald-400' : 'bg-rose-500'}`} />\r\n                  <span className=\"text-xs opacity-70\">{calibrationValid ? 'Cal OK' : 'Cal invalid'}</span>\r\n                </div>\r\n              </div>\r\n          </div>\r\n        </div>\r\n        {preferredCameraLabel && (\r\n          <div className=\"text-xs opacity-70 mt-1\">\r\n            Selected: {preferredCameraLabel}\r\n          </div>\r\n        )}\r\n        <div className=\"text-xs opacity-70 mt-1\">\r\n          Tip: All camera technology is supported for autoscoring needsselect\r\n          your camera here and then open Calibrator to align.\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n  const showMobileLanding = isMobileDevice && !mobileLandingOverride;\r\n\r\n  if (showMobileLanding) {\r\n    const linkForMobile =\r\n      mobileLandingLink ??\r\n      (typeof window !== \"undefined\"\r\n        ? `${window.location.origin.replace(/\\/$/, \"\")}/mobile-cam.html`\r\n        : \"/mobile-cam.html\");\r\n    return (\r\n      <div className=\"mx-auto flex min-h-[calc(100vh-140px)] w-full max-w-xl flex-col justify-center gap-6 p-6\">\r\n        <div className=\"space-y-5 rounded-3xl border border-indigo-400/30 bg-slate-900/70 p-6 text-slate-100 shadow-xl\">\r\n          <div className=\"space-y-2\">\r\n            <p className=\"text-xs font-semibold uppercase tracking-wide text-indigo-300\">\r\n              Mobile camera\r\n            </p>\r\n            <h2 className=\"text-2xl font-semibold leading-tight text-white\">\r\n              This device is ready to stream as your dartboard camera\r\n            </h2>\r\n            <p className=\"text-sm text-slate-200/80\">\r\n              Open the lightweight mobile camera page to stream video to your\r\n              desktop calibrator. You can still come back here if you need the\r\n              full desktop tools.\r\n            </p>\r\n          </div>\r\n          <div className=\"space-y-2\">\r\n            <a\r\n              href={linkForMobile}\r\n              className=\"btn w-full justify-center px-4 py-2 text-base\"\r\n            >\r\n              Open mobile camera\r\n            </a>\r\n            <button\r\n              type=\"button\"\r\n              className=\"btn btn--ghost w-full justify-center px-4 py-2 text-sm\"\r\n              onClick={() => copyValue(linkForMobile, \"link\")}\r\n            >\r\n              {copyFeedback === \"link\" ? \"Link copied!\" : \"Copy link\"}\r\n            </button>\r\n          </div>\r\n          <p className=\"text-xs text-slate-300/70\">\r\n            On a desktop, open Calibrator and generate a pairing code. Then tap{\" \"}\r\n            <span className=\"font-semibold\">Pair with Desktop</span> from the\r\n            mobile camera page to connect this device.\r\n          </p>\r\n        </div>\r\n        <button\r\n          type=\"button\"\r\n          className=\"self-center text-xs font-medium text-indigo-200 underline decoration-dotted decoration-indigo-300/70 transition hover:text-indigo-100\"\r\n          onClick={() => setMobileLandingOverride(true)}\r\n        >\r\n          Continue to desktop calibrator\r\n        </button>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      {isMobileDevice && mobileLandingOverride && (\r\n        <div className=\"rounded-2xl border border-indigo-400/30 bg-indigo-500/10 p-4 text-sm text-indigo-100\">\r\n          <div className=\"flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between\">\r\n            <p className=\"leading-relaxed\">\r\n              Using a phone? Switch back to the streamlined mobile camera\r\n              interface for an easier pairing flow.\r\n            </p>\r\n            <button\r\n              type=\"button\"\r\n              className=\"btn btn--ghost px-3 py-1 text-xs\"\r\n              onClick={() => setMobileLandingOverride(false)}\r\n            >\r\n              Open mobile camera mode\r\n            </button>\r\n          </div>\r\n        </div>\r\n      )}\r\n      <div className=\"card space-y-6 p-6\">\r\n        <header className=\"flex flex-wrap items-start justify-between gap-4\">\r\n          <div className=\"space-y-2\">\r\n            <p className=\"text-xs font-semibold uppercase tracking-wide text-indigo-300\">\r\n              Marker calibration\r\n            </p>\r\n            <h2 className=\"text-2xl font-semibold leading-tight text-white\">\r\n              Align your board with the autoscoring overlay\r\n            </h2>\r\n            <p className=\"max-w-2xl text-sm opacity-80\">\r\n              Place the printable fiducial markers around the double ring,\r\n              capture a clear frame, and let the calibrator compute a precise\r\n              homography.\r\n            </p>\r\n          </div>\r\n          <div className=\"flex flex-col items-end gap-2 text-xs font-medium\">\r\n            <span className=\"inline-flex items-center gap-2 rounded-full border border-indigo-400/50 bg-indigo-500/10 px-3 py-1\">\r\n              <span className=\"opacity-60\">Mode</span>\r\n              <span>\r\n                {mode === \"local\"\r\n                  ? \"Desktop camera\"\r\n                  : mode === \"phone\"\r\n                    ? \"Phone camera\"\r\n                    : \"Wifi device\"}\r\n              </span>\r\n            </span>\r\n            <span\r\n              className={`inline-flex items-center gap-2 rounded-full border px-3 py-1 ${streaming ? \"border-emerald-400/60 bg-emerald-500/10 text-emerald-100\" : \"border-white/20 bg-white/5 text-slate-200\"}`}\r\n            >\r\n              <span\r\n                className={`h-2 w-2 rounded-full ${streaming ? \"bg-emerald-400\" : \"bg-slate-400\"}`}\r\n              />\r\n              {streaming ? \"Live stream active\" : \"Stream idle\"}\r\n            </span>\r\n            {locked ? (\r\n              <div className=\"space-y-3 rounded-2xl border border-emerald-400/40 bg-emerald-500/10 p-4 text-sm\">\r\n                <div className=\"flex items-center justify-between gap-2\">\r\n                  <div className=\"flex items-center gap-3\">\r\n                    <div className=\"flex h-10 w-10 items-center justify-center rounded-full bg-emerald-500/20\">\r\n                      <span className=\"text-lg\"></span>\r\n                    </div>\r\n                    <div>\r\n                      <h4 className=\"font-semibold text-emerald-100\">\r\n                        Calibration active\r\n                      </h4>\r\n                      <p className=\"text-xs opacity-80\">\r\n                        Your calibration is saved and active across all game\r\n                        modes. It will be used in Online, Offline, and\r\n                        Tournaments.\r\n                      </p>\r\n                    </div>\r\n                  </div>\r\n                  <button\r\n                    className=\"btn btn--ghost px-2 py-1 text-xs whitespace-nowrap\"\r\n                    onClick={() => setCalibration({ locked: false })}\r\n                    title=\"Unlock to recalibrate\"\r\n                  >\r\n                    Unlock\r\n                  </button>\r\n                </div>\r\n                {errorPx != null && (\r\n                  <div className=\"text-xs opacity-75\">\r\n                    Precision: {errorPx.toFixed(2)} px RMS error\r\n                  </div>\r\n                )}\r\n              </div>\r\n            ) : null}\r\n          </div>\r\n        </header>\r\n\r\n        <div className=\"grid gap-6 xl:grid-cols-[minmax(0,2fr)_minmax(320px,1fr)]\">\r\n          <section className=\"space-y-4\">\r\n            <div className=\"space-y-4 rounded-2xl border border-white/10 bg-black/40 p-4\">\r\n              <div className=\"flex flex-wrap items-center justify-between gap-4 text-xs\">\r\n                <div className=\"flex flex-wrap items-center gap-3\">\r\n                  <span className=\"uppercase tracking-wide opacity-60\">\r\n                    Video source\r\n                  </span>\r\n                  <div className=\"flex items-center gap-1\">\r\n                    <button\r\n                      className={`btn px-3 py-1 ${mode === \"local\" ? \"bg-emerald-600 hover:bg-emerald-700\" : \"bg-slate-700 hover:bg-slate-600\"}`}\r\n                      onClick={() => {\r\n                        setMode(\"local\");\r\n                        stopCamera(false);\r\n                      }}\r\n                      title=\"Use local camera\"\r\n                    >\r\n                      Local\r\n                    </button>\r\n                    <button\r\n                      className={`btn px-3 py-1 ${mode === \"phone\" ? \"bg-emerald-600 hover:bg-emerald-700\" : \"bg-slate-700 hover:bg-slate-600\"}`}\r\n                      onClick={() => {\r\n                        setMode(\"phone\");\r\n                        stopCamera(false);\r\n                      }}\r\n                      title=\"Enable camera on this device\"\r\n                    >\r\n                      Phone\r\n                    </button>\r\n                    <button\r\n                      className={`btn px-3 py-1 ${mode === \"wifi\" ? \"bg-emerald-600 hover:bg-emerald-700\" : \"bg-slate-700 hover:bg-slate-600\"}`}\r\n                      onClick={() => {\r\n                        setMode(\"wifi\");\r\n                        stopCamera(false);\r\n                        startWifiConnection();\r\n                      }}\r\n                      title=\"Discover wifi/USB autoscoring devices\"\r\n                    >\r\n                      Wifi\r\n                    </button>\r\n                  </div>\r\n                </div>\r\n                <div className=\"flex flex-wrap items-center gap-3\">\r\n                  <div className=\"flex items-center gap-2\">\r\n                    <span className=\"opacity-70\">Zoom</span>\r\n                    <input\r\n                      type=\"range\"\r\n                      min={50}\r\n                      max={200}\r\n                      step={5}\r\n                      value={Math.round((zoom || 1) * 100)}\r\n                      onChange={(e) =>\r\n                        setZoom(\r\n                          Math.max(\r\n                            0.5,\r\n                            Math.min(2, Number(e.target.value) / 100),\r\n                          ),\r\n                        )\r\n                      }\r\n                    />\r\n                    <span className=\"w-12 text-right\">\r\n                      {Math.round((zoom || 1) * 100)}%\r\n                    </span>\r\n                  </div>\r\n                  <button className=\"btn px-3 py-1\" onClick={() => setZoom(1)}>\r\n                    Actual\r\n                  </button>\r\n                </div>\r\n              </div>\r\n              {/* Tools pill (always visible) */}\r\n              <div className=\"ml-3 relative\">\r\n                <button\r\n                  className=\"inline-flex items-center gap-2 rounded-full border border-indigo-400/30 bg-indigo-400/10 px-3 py-1 text-sm\"\r\n                  onClick={() => setToolsPopoverOpen(!toolsPopoverOpen)}\r\n                  data-testid=\"cal-tools-popper-button\"\r\n                >\r\n                  <span className=\"font-semibold\">Cal. Tools</span>\r\n                  {preserveCalibrationOverlay && (\r\n                    <span className=\"ml-2 text-xs opacity-70\">(overlay preserved)</span>\r\n                  )}\r\n                </button>\r\n                {toolsPopoverOpen && (\r\n                  <div\r\n                    className=\"absolute right-0 mt-2 w-64 rounded-lg border bg-gray-900/80 p-3 shadow-lg z-50\"\r\n                    data-testid=\"cal-tools-popover\"\r\n                    role=\"dialog\"\r\n                  >\r\n                    <div className=\"text-xs mb-2\">Calibrator quick tools</div>\r\n                    <div className=\"flex items-center gap-2 mb-2\">\r\n                      <input\r\n                        id=\"hdr-show-darts\"\r\n                        type=\"checkbox\"\r\n                        checked={showDartPreview}\r\n                        onChange={(e) => setShowDartPreview(e.target.checked)}\r\n                      />\r\n                      <label htmlFor=\"hdr-show-darts\" className=\"text-sm\">\r\n                        Show darts overlay\r\n                      </label>\r\n                    </div>\r\n                    <div className=\"flex items-center gap-2 mb-2\">\r\n                      <input\r\n                        id=\"hdr-autocommit\"\r\n                        type=\"checkbox\"\r\n                        checked={autoCommitTestMode}\r\n                        onChange={(e) => setAutoCommitTestMode(e.target.checked)}\r\n                      />\r\n                      <label htmlFor=\"hdr-autocommit\" className=\"text-sm\">\r\n                        Enable autocommit test\r\n                      </label>\r\n                    </div>\r\n                    <div className=\"flex items-center gap-2 mb-2\">\r\n                      <input\r\n                        id=\"hdr-autocommit-online\"\r\n                        type=\"checkbox\"\r\n                        checked={allowAutocommitInOnline}\r\n                        onChange={(e) => setAllowAutocommitInOnline(e.target.checked)}\r\n                        disabled={!autoCommitTestMode}\r\n                      />\r\n                      <label htmlFor=\"hdr-autocommit-online\" className=\"text-sm\">\r\n                        Allow autocommit in Online/Tournament matches (dangerous)\r\n                      </label>\r\n                    </div>\r\n                    <div className=\"flex items-center gap-2 mb-2\">\r\n                      <input\r\n                        id=\"hdr-autocommit-immediate\"\r\n                        type=\"checkbox\"\r\n                        checked={autoCommitImmediate}\r\n                        onChange={(e) => setAutoCommitImmediate(e.target.checked)}\r\n                      />\r\n                      <label\r\n                        htmlFor=\"hdr-autocommit-immediate\"\r\n                        className=\"text-sm\"\r\n                      >\r\n                        Autocommit immediate when detected\r\n                      </label>\r\n                    </div>\r\n                    <div className=\"flex items-center justify-between mt-2\">\r\n                      <div className=\"text-xs opacity-70\">\r\n                        {lastDetectedLabel || \"No recent detection\"}\r\n                      </div>\r\n                      <div>\r\n                        <button\r\n                          className=\"btn btn--small\"\r\n                          onClick={() => {\r\n                            console.debug('[Calibrator] popover Commit click (onClick)');// eslint-disable-line no-console\r\n                            doCommit();\r\n                          }}\r\n                          onPointerDown={() => {\r\n                            console.debug('[Calibrator] popover Commit click (onPointerDown)');// eslint-disable-line no-console\r\n                            doCommit();\r\n                          }}\r\n                        >\r\n                          Commit\r\n                        </button>\r\n                      </div>\r\n                    </div>\r\n                  </div>\r\n                )}\r\n              </div>\r\n\r\n              <div\r\n                className=\"relative w-full overflow-hidden rounded-2xl border border-indigo-400/30 bg-black\"\r\n                style={{\r\n                  aspectRatio: frameSize\r\n                    ? `${frameSize.w} / ${frameSize.h}`\r\n                    : \"16 / 9\",\r\n                }}\r\n              >\r\n                {(mode === \"phone\" ? !streaming || !paired : !streaming) && (\r\n                  <div className=\"absolute inset-0 z-20 flex items-center justify-center bg-gradient-to-br from-black/40 to-black/10\">\r\n                    <DartLoader calibrationComplete={phase === \"computed\"} />\r\n                  </div>\r\n                )}\r\n                <div\r\n                  className=\"absolute inset-0\"\r\n                  style={{\r\n                    transform: `scale(${zoom || 1})`,\r\n                    transformOrigin: \"center center\",\r\n                  }}\r\n                >\r\n                  <video\r\n                    ref={videoRef}\r\n                    onLoadedMetadata={(ev) => {\r\n                      try {\r\n                        const v = ev.currentTarget as HTMLVideoElement;\r\n                        if (v.videoWidth && v.videoHeight)\r\n                          setFrameSize({ w: v.videoWidth, h: v.videoHeight });\r\n                      } catch {}\r\n                    }}\r\n                    className={`absolute inset-0 h-full w-full object-cover transition-opacity duration-300 ${hasSnapshot ? \"opacity-0 -z-10\" : \"opacity-100 z-10\"}`}\r\n                    autoPlay\r\n                    playsInline\r\n                    muted\r\n                    controls={false}\r\n                  />\r\n                  {videoPlayBlocked && (\r\n                    <div className=\"absolute inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur\">\r\n                      <button\r\n                        className=\"rounded-lg bg-white px-4 py-2 font-semibold text-slate-900 shadow-lg\"\r\n                        onClick={async () => {\r\n                          try {\r\n                            await videoRef.current?.play();\r\n                            setVideoPlayBlocked(false);\r\n                            setStreaming(true);\r\n                            setPhase(\"capture\");\r\n                          } catch (e) {\r\n                            console.warn(\"Tap-to-play retry failed\", e);\r\n                            alert(\r\n                              \"Tap to enable video failed. Please check browser settings or reload the page.\",\r\n                            );\r\n                          }\r\n                        }}\r\n                      >\r\n                        Tap to allow video\r\n                      </button>\r\n                    </div>\r\n                  )}\r\n                  <canvas\r\n                    ref={canvasRef}\r\n                    onPointerDown={onClickOverlay}\r\n                    className={`absolute inset-0 h-full w-full transition-opacity duration-300 ${hasSnapshot ? \"opacity-100 z-10\" : \"opacity-0 -z-10\"}`}\r\n                  />\r\n                  <canvas\r\n                    ref={overlayRef}\r\n                    onClick={onClickOverlay}\r\n                    onPointerDown={onClickOverlay}\r\n                    className=\"absolute inset-0 z-30 h-full w-full cursor-crosshair\"\r\n                  />\r\n                </div>\r\n              </div>\r\n\r\n              <label className=\"flex items-center gap-2 text-xs\">\r\n                <input\r\n                  type=\"checkbox\"\r\n                  className=\"accent-indigo-600\"\r\n                  checked={calibrationGuide}\r\n                  onChange={(e) => setCalibrationGuide(e.target.checked)}\r\n                />\r\n                Show preferred-view guide overlay\r\n              </label>\r\n\r\n              {/* Stage cards in the main free space  quick access to the three calibration stages */}\r\n              <div className=\"mt-4 grid grid-cols-1 gap-3 sm:grid-cols-3 overflow-visible\">\r\n                <div className=\"rounded-2xl border border-white/10 bg-white/5 p-4 overflow-visible\">\r\n                  <h3 className=\"text-sm font-semibold\">Stage 1  Capture</h3>\r\n                  <p className=\"text-xs opacity-70\">\r\n                    Start your camera or upload a photo to capture the board.\r\n                  </p>\r\n                  <div className=\"mt-3 flex flex-col gap-2\">\r\n                    {mode === \"local\" && (\r\n                      <button className=\"btn\" onClick={startCamera}>\r\n                        Enable camera\r\n                      </button>\r\n                    )}\r\n                    {mode === \"phone\" && (\r\n                      <button\r\n                        className=\"btn\"\r\n                        title=\"Enable camera on this device\"\r\n                        onClick={() => {\r\n                          try {\r\n                            window.dispatchEvent(\r\n                              new CustomEvent(\"ndn:start-camera\", {\r\n                                detail: { mode: \"phone\" },\r\n                              }),\r\n                            );\r\n                          } catch {\r\n                            startPhonePairing();\r\n                          }\r\n                        }}\r\n                      >\r\n                        Enable camera\r\n                      </button>\r\n                    )}\r\n                    {mode === \"wifi\" && (\r\n                      <button className=\"btn\" onClick={startWifiConnection}>\r\n                        Connect wifi camera\r\n                      </button>\r\n                    )}\r\n                    <button\r\n                      className=\"btn\"\r\n                      onClick={captureFrame}\r\n                      disabled={!streaming}\r\n                    >\r\n                      Capture frame\r\n                    </button>\r\n                    <button className=\"btn\" onClick={triggerUpload}>\r\n                      Upload photo\r\n                    </button>\r\n                  </div>\r\n                </div>\r\n\r\n                <div className=\"rounded-2xl border border-white/10 bg-white/5 p-4\">\r\n                  <h3 className=\"text-sm font-semibold\">\r\n                    Stage 2  Auto-Calibrate\r\n                  </h3>\r\n                  <p className=\"text-xs opacity-70\">\r\n                    Automatically detect dartboard rings and compute calibration\r\n                    without any markers or clicking.\r\n                  </p>\r\n                  <div className=\"mt-3 flex flex-col gap-2\">\r\n                    <button\r\n                      className=\"btn bg-emerald-600 hover:bg-emerald-700 font-semibold\"\r\n                      disabled={!hasSnapshot || autoCalibrating}\r\n                      onClick={autoCalibrate}\r\n                      data-testid=\"autocalibrate-advanced\"\r\n                    >\r\n                      {autoCalibrating\r\n                        ? \"Auto-calibrating\"\r\n                        : \" Auto-Calibrate (Advanced)\"}\r\n                    </button>\r\n                    <button\r\n                      className=\"btn\"\r\n                      disabled={!hasSnapshot || autoCalibrating}\r\n                      onClick={autoDetectRings}\r\n                      data-testid=\"autodetect-legacy\"\r\n                    >\r\n                      {autoCalibrating ? \"Auto-calibrating\" : \"Legacy: Auto detect rings\"}\r\n                    </button>\r\n                    {/* Removed Legacy marker buttons per request */}\r\n                  </div>\r\n                  <div className=\"mt-2 text-xs opacity-70\">\r\n                    Confidence: {forceConfidence ? 100 : confidence}%\r\n                  </div>\r\n                  <div className=\"mt-2 text-xs opacity-70\">\r\n                    Scoring image size: {imageSize ? `${imageSize.w} x ${imageSize.h}` : \"\"}\r\n                  </div>\r\n                  <div className=\"mt-2 text-xs opacity-70\">\r\n                    Overlay display size: {overlaySize ? `${overlaySize.w} x ${overlaySize.h}` : \"\"}\r\n                  </div>\r\n                  <div className=\"mt-2\">\r\n                    <button\r\n                      className=\"btn btn-secondary text-xs\"\r\n                      onClick={() => {\r\n                        if (autoCalibrating) return;\r\n                        autoCalibrate();\r\n                      }}\r\n                      disabled={!hasSnapshot || autoCalibrating}\r\n                    >\r\n                      Re-run Auto-Calibrate\r\n                    </button>\r\n                  </div>\r\n                  {detectionMessage && (\r\n                    <div className=\"mt-2 text-xs text-yellow-300\">\r\n                      {detectionMessage}\r\n                    </div>\r\n                  )}\r\n                  <div className=\"mt-2 text-xs opacity-70 flex items-center gap-2\">\r\n                    <label className=\"flex items-center gap-2\">\r\n                      <input\r\n                        type=\"checkbox\"\r\n                        className=\"accent-indigo-600\"\r\n                        checked={forceConfidence}\r\n                        onChange={(e) => setForceConfidence(e.target.checked)}\r\n                      />\r\n                      <span className=\"text-xs\">Force 100% Confidence</span>\r\n                    </label>\r\n                    {forceConfidence && (\r\n                      <span className=\"text-xs text-yellow-300\">\r\n                         For testing only  may produce mis-registrations\r\n                      </span>\r\n                    )}\r\n                  </div>\r\n                </div>\r\n\r\n                <div className=\"rounded-2xl border border-white/10 bg-white/5 p-4\">\r\n                  <h3 className=\"text-sm font-semibold\">\r\n                    Stage 3  Align & lock\r\n                  </h3>\r\n                  <p className=\"text-xs opacity-70\">\r\n                    Click the board points, refine edges and lock calibration\r\n                    when satisfied.\r\n                  </p>\r\n                  <div className=\"mt-3 flex flex-col gap-2\">\r\n                    <button\r\n                      className=\"btn\"\r\n                      disabled={dstPoints.length < REQUIRED_POINT_COUNT}\r\n                      onClick={compute}\r\n                    >\r\n                      Compute\r\n                    </button>\r\n                    <button\r\n                      className={`btn ${locked ? \"bg-emerald-600 hover:bg-emerald-700\" : \"\"}`}\r\n                      onClick={() => {\r\n                        const newLocked = !locked;\r\n                        if (!newLocked) {\r\n                          setCalibration({ locked: false });\r\n                        } else {\r\n                          const overlaySize = overlayRef?.current\r\n                            ? { w: overlayRef.current.width, h: overlayRef.current.height }\r\n                            : videoRef?.current\r\n                            ? { w: videoRef.current.clientWidth, h: videoRef.current.clientHeight }\r\n                            : canvasRef?.current\r\n                            ? { w: canvasRef.current.width, h: canvasRef.current.height }\r\n                            : null;\r\n                          setCalibration({ locked: true, overlaySize });\r\n                        }\r\n                      }}\r\n                    >\r\n                      {locked ? \"Unlock\" : \"Lock in\"}\r\n                    </button>\r\n                    {preserveCalibrationOverlay ? (\r\n                      <div className=\"text-xs opacity-70 mt-1\">\r\n                        Overlay preservation <span className=\"font-semibold\">enabled</span>  locked calibration will preserve display size\r\n                      </div>\r\n                    ) : (\r\n                      <div className=\"text-xs opacity-70 mt-1\">\r\n                        Overlay preservation <span className=\"font-semibold\">disabled</span>  locked calibration uses current canvas size\r\n                      </div>\r\n                    )}\r\n                    {locked && preserveCalibrationOverlay && overlaySize && (\r\n                      <div className=\"text-xs opacity-60 mt-1\">\r\n                        Overlay display size preserved: {overlaySize.w} x {overlaySize.h}\r\n                      </div>\r\n                    )}\r\n                    <button className=\"btn\" onClick={() => runVerification()}>\r\n                      Verify\r\n                    </button>\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            </div>\r\n\r\n            {/* Pro tip section */}\r\n            <div className=\"mt-4 rounded-lg border border-blue-500/30 bg-blue-500/10 p-3\">\r\n              <div className=\"text-xs font-semibold text-blue-300 mb-1\">\r\n                 Pro Tip for Perfect Calibration\r\n              </div>\r\n              <div className=\"text-xs opacity-80\">\r\n                Click the 4 corners of the double ring at{\" \"}\r\n                <span className=\"font-semibold\">D20, D6, D3, and D11</span>.\r\n                These evenly-spaced doubles lock the board orientation and yield\r\n                a perfect (100%) confidence score.\r\n              </div>\r\n            </div>\r\n\r\n            <div className=\"grid grid-cols-1 gap-3 text-xs sm:grid-cols-3\">\r\n              <div className=\"rounded-xl border border-white/10 bg-white/5 px-3 py-2\">\r\n                <div className=\"uppercase tracking-wide opacity-60\">Phase</div>\r\n                <div className=\"text-sm font-semibold capitalize\">{phase}</div>\r\n              </div>\r\n              <div className=\"rounded-xl border border-white/10 bg-white/5 px-3 py-2\">\r\n                <div className=\"uppercase tracking-wide opacity-60\">\r\n                  Points selected\r\n                </div>\r\n                <div className=\"text-sm font-semibold\">\r\n                  {dstPoints.length} / {REQUIRED_POINT_COUNT}\r\n                </div>\r\n              </div>\r\n              <div className=\"rounded-xl border border-white/10 bg-white/5 px-3 py-2\">\r\n                <div className=\"uppercase tracking-wide opacity-60\">\r\n                  Fit error\r\n                </div>\r\n                <div className=\"text-sm font-semibold\">\r\n                  {errorPx != null ? `${errorPx.toFixed(2)} px` : \"\"}\r\n                </div>\r\n              </div>\r\n            </div>\r\n          </section>\r\n\r\n          <aside className=\"space-y-4\">\r\n            <DevicePicker />\r\n\r\n            {mode === \"phone\" && (\r\n              <section className=\"space-y-3 rounded-2xl border border-indigo-400/30 bg-black/40 p-4 text-xs text-white\">\r\n                <div className=\"font-semibold\">Phone pairing</div>\r\n                <button\r\n                  type=\"button\"\r\n                  className=\"w-full text-left px-3 py-2 rounded-lg border border-white/10 bg-white/5 hover:bg-white/10 transition flex items-center gap-2\"\r\n                  onClick={() => copyValue(mobileUrl, \"link\")}\r\n                  title=\"Copy mobile camera link\"\r\n                >\r\n                  <span className=\"flex-1 min-w-0 font-mono break-all text-[11px]\">\r\n                    {mobileUrl}\r\n                  </span>\r\n                  <span className=\"text-[10px] uppercase tracking-wide whitespace-nowrap text-emerald-200\">\r\n                    {copyFeedback === \"link\" ? \"Copied!\" : \"Copy link\"}\r\n                  </span>\r\n                </button>\r\n                <div className=\"flex items-center gap-2 text-[11px]\">\r\n                  <a\r\n                    href={mobileUrl}\r\n                    target=\"_blank\"\r\n                    rel=\"noreferrer\"\r\n                    className=\"underline decoration-dotted text-indigo-200 hover:text-indigo-100 transition\"\r\n                  >\r\n                    Open link in new tab\r\n                  </a>\r\n                </div>\r\n                <div className=\"opacity-80\">\r\n                  WS:{\" \"}\r\n                  {ws\r\n                    ? ws.readyState === 1\r\n                      ? \"open\"\r\n                      : ws.readyState === 0\r\n                        ? \"connecting\"\r\n                        : ws.readyState === 2\r\n                          ? \"closing\"\r\n                          : \"closed\"\r\n                    : \"not started\"}{\" \"}\r\n                   {httpsInfo?.https ? \"HTTPS on\" : \"HTTP only\"}\r\n                </div>\r\n                {pairCode && (\r\n                  <button\r\n                    type=\"button\"\r\n                    className=\"w-full text-left px-3 py-2 rounded-lg border border-white/10 bg-white/5 hover:bg-white/10 transition flex items-center justify-between gap-2\"\r\n                    onClick={() => copyValue(pairCode, \"code\")}\r\n                    title=\"Copy pairing code\"\r\n                  >\r\n                    <span className=\"font-mono tracking-[0.3em] text-sm\">\r\n                      {pairCode}\r\n                    </span>\r\n                    <span className=\"text-[10px] uppercase tracking-wide whitespace-nowrap text-emerald-200\">\r\n                      {copyFeedback === \"code\" ? \"Copied!\" : \"Copy code\"}\r\n                    </span>\r\n                  </button>\r\n                )}\r\n                <div className=\"flex items-center gap-2\">\r\n                  {ttl !== null && <span>Expires in {ttl}s</span>}\r\n                  <button\r\n                    className=\"btn px-2 py-1 text-xs\"\r\n                    onClick={regenerateCode}\r\n                  >\r\n                    Regenerate\r\n                  </button>\r\n                </div>\r\n                {showTips && (\r\n                  <div className=\"space-y-2 rounded-lg border border-slate-700/50 bg-slate-900/60 p-3 text-slate-200\">\r\n                    <div className=\"font-semibold\">Troubleshooting</div>\r\n                    <ul className=\"list-disc space-y-1 pl-4\">\r\n                      <li>\r\n                        Phone and desktop must be on the same WiFi network.\r\n                      </li>\r\n                      <li>\r\n                        Allow the server through your firewall (ports 8787 and{\" \"}\r\n                        {httpsInfo?.https ? httpsInfo.port : 8788}).\r\n                      </li>\r\n                      <li>\r\n                        On iPhone, use HTTPS links (QR will prefer HTTPS when\r\n                        enabled).\r\n                      </li>\r\n                    </ul>\r\n                    <div className=\"text-right\">\r\n                      <button\r\n                        className=\"btn btn--ghost px-2 py-1 text-xs\"\r\n                        onClick={() => setShowTips(false)}\r\n                      >\r\n                        Hide tips\r\n                      </button>\r\n                    </div>\r\n                  </div>\r\n                )}\r\n              </section>\r\n            )}\r\n\r\n            {/* Sidebar Step cards intentionally removed  these controls remain available in the main stage cards above to avoid showing duplicate controls in the right-hand sidebar. */}\r\n          </aside>\r\n        </div>\r\n\r\n        {mode === \"wifi\" && !streaming && (\r\n          <div className=\"space-y-3 rounded-2xl border border-indigo-400/30 bg-black/40 p-4 text-xs text-white\">\r\n            <div className=\"font-semibold\">Wifi scoring devices</div>\r\n            {discoveringWifi ? (\r\n              <div className=\"flex items-center gap-2\">\r\n                <div className=\"h-4 w-4 animate-spin rounded-full border-b-2 border-white\" />\r\n                <span>Scanning network for devices</span>\r\n              </div>\r\n            ) : wifiDevices.length > 0 ? (\r\n              <div className=\"space-y-2\">\r\n                {wifiDevices.map((device) => (\r\n                  <div\r\n                    key={device.id}\r\n                    className=\"flex items-center justify-between rounded border border-slate-700/50 bg-slate-900/60 p-2\"\r\n                  >\r\n                    <div>\r\n                      <div className=\"font-medium\">{device.name}</div>\r\n                      <div className=\"opacity-70\">\r\n                        {device.ip}:{device.port}  {device.type.toUpperCase()}\r\n                      </div>\r\n                      <div className=\"opacity-70 text-xs\">\r\n                        Capabilities: {device.capabilities.join(\", \")}\r\n                      </div>\r\n                    </div>\r\n                    <button\r\n                      className={`btn px-2 py-1 text-xs ${device.status === \"connecting\" ? \"bg-yellow-600\" : device.status === \"online\" ? \"bg-green-600\" : \"bg-blue-600\"}`}\r\n                      onClick={() => connectToWifiDevice(device)}\r\n                      disabled={device.status === \"connecting\"}\r\n                    >\r\n                      {device.status === \"connecting\"\r\n                        ? \"Connecting\"\r\n                        : \"Connect\"}\r\n                    </button>\r\n                  </div>\r\n                ))}\r\n                <div className=\"text-center\">\r\n                  <button\r\n                    className=\"btn px-2 py-1 text-xs\"\r\n                    onClick={startWifiConnection}\r\n                  >\r\n                    Rescan network\r\n                  </button>\r\n                </div>\r\n              </div>\r\n            ) : (\r\n              <div className=\"space-y-2 text-center\">\r\n                <div>No wifi scoring devices found.</div>\r\n                <div className=\"opacity-70\">\r\n                  Ensure your wifi cameras are powered on and on the same\r\n                  network.\r\n                </div>\r\n                <button\r\n                  className=\"btn px-2 py-1 text-xs\"\r\n                  onClick={startWifiConnection}\r\n                >\r\n                  Scan again\r\n                </button>\r\n              </div>\r\n            )}\r\n          </div>\r\n        )}\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n","import { create } from \"zustand\";\r\n\r\ntype Toast = {\r\n  id: number;\r\n  message: string;\r\n  type?: \"info\" | \"success\" | \"error\";\r\n  timeout?: number;\r\n};\r\n\r\ntype ToastState = {\r\n  toasts: Toast[];\r\n  push: (\r\n    message: string,\r\n    opts?: { type?: \"info\" | \"success\" | \"error\"; timeout?: number },\r\n  ) => void;\r\n  remove: (id: number) => void;\r\n  clear: () => void;\r\n};\r\n\r\nlet nextId = 1;\r\n\r\nexport const useToastStore = create<ToastState>((set) => ({\r\n  toasts: [],\r\n  push: (message, opts) =>\r\n    set((s) => {\r\n      const id = nextId++;\r\n      const t: Toast = {\r\n        id,\r\n        message,\r\n        type: opts?.type || \"info\",\r\n        timeout: opts?.timeout ?? 3000,\r\n      };\r\n      // auto-remove after timeout\r\n      if (t.timeout && t.timeout > 0) {\r\n        setTimeout(() => {\r\n          set((cur) => ({ toasts: cur.toasts.filter((x) => x.id !== id) }));\r\n        }, t.timeout);\r\n      }\r\n      return { toasts: [...s.toasts, t] };\r\n    }),\r\n  remove: (id) => set((s) => ({ toasts: s.toasts.filter((t) => t.id !== id) })),\r\n  clear: () => set({ toasts: [] }),\r\n}));\r\n\r\nexport function useToast() {\r\n  const push = useToastStore((s) => s.push);\r\n  return push;\r\n}\r\n","import { useToastStore } from \"../store/toast\";\r\n\r\nexport default function Toaster() {\r\n  const toasts = useToastStore((s) => s.toasts);\r\n  const remove = useToastStore((s) => s.remove);\r\n  if (!toasts.length) return null;\r\n  return (\r\n    <>\r\n      {/* Success messages centered */}\r\n      {toasts\r\n        .filter((t) => t.type === \"success\")\r\n        .map((t) => (\r\n          <div\r\n            key={t.id}\r\n            className=\"fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-50\"\r\n          >\r\n            <div\r\n              className={`p-4 rounded-lg shadow-lg border text-sm bg-emerald-700/90 border-emerald-500/60 text-white max-w-sm text-center`}\r\n            >\r\n              <div className=\"flex items-center justify-center gap-2\">\r\n                <span className=\"flex-1 font-semibold\">{t.message}</span>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        ))}\r\n      {/* Other messages bottom right */}\r\n      {toasts.filter((t) => t.type !== \"success\").length > 0 && (\r\n        <div className=\"fixed bottom-4 right-4 z-50 space-y-2 sm:right-4 sm:left-auto left-1/2 -translate-x-1/2 sm:translate-x-0 w-[calc(100%-1.5rem)] sm:w-auto max-w-sm\">\r\n          {toasts\r\n            .filter((t) => t.type !== \"success\")\r\n            .map((t) => (\r\n              <div\r\n                key={t.id}\r\n                className={`p-3 rounded-lg shadow-lg border text-sm ${\r\n                  t.type === \"error\"\r\n                    ? \"bg-rose-700/80 border-rose-500/60 text-white\"\r\n                    : \"bg-black/70 border-slate-700 text-slate-100\"\r\n                }`}\r\n              >\r\n                <div className=\"flex items-center gap-2\">\r\n                  <span className=\"flex-1\">{t.message}</span>\r\n                  <button\r\n                    className=\"btn btn--ghost px-2 py-1 text-xs\"\r\n                    onClick={() => remove(t.id)}\r\n                  >\r\n                    Dismiss\r\n                  </button>\r\n                </div>\r\n              </div>\r\n            ))}\r\n        </div>\r\n      )}\r\n    </>\r\n  );\r\n}\r\n","import React from \"react\";\r\n\r\ntype Datum = { label: string | number; value: number };\r\n\r\nexport default function BarChart({\r\n  data,\r\n  height = 220,\r\n  barWidth = 28,\r\n  gap = 6,\r\n  showValues = false,\r\n}: {\r\n  data: Datum[];\r\n  height?: number;\r\n  barWidth?: number;\r\n  gap?: number;\r\n  showValues?: boolean;\r\n}) {\r\n  const max = Math.max(1, ...data.map((d) => d.value));\r\n  const totalWidth = data.length * (barWidth + gap);\r\n  return (\r\n    <div className=\"w-full overflow-x-auto\">\r\n      <div\r\n        className=\"relative\"\r\n        style={{ height, width: Math.max(600, totalWidth) }}\r\n      >\r\n        <div className=\"absolute inset-0 flex items-end\">\r\n          {data.map((d, i) => {\r\n            const h = Math.round((d.value / max) * (height - 40)); // leave room for labels\r\n            return (\r\n              <div\r\n                key={i}\r\n                className=\"flex flex-col items-center justify-end\"\r\n                style={{ width: barWidth, marginRight: gap }}\r\n              >\r\n                <div\r\n                  className=\"w-full rounded-t-md bg-gradient-to-b from-indigo-400 to-fuchsia-500 shadow-sm\"\r\n                  style={{ height: h }}\r\n                  title={`${d.label}: ${d.value}`}\r\n                />\r\n                {showValues && (\r\n                  <div className=\"text-sm mt-1 text-indigo-200 font-semibold\">\r\n                    {d.value}\r\n                  </div>\r\n                )}\r\n                <div className=\"text-sm mt-1 text-slate-200 font-medium select-none\">\r\n                  {d.label}\r\n                </div>\r\n              </div>\r\n            );\r\n          })}\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n","import React from \"react\";\r\n\r\ntype Tab = { key: string; label: string };\r\n\r\nexport default function TabPills({\r\n  tabs,\r\n  active,\r\n  onChange,\r\n  className,\r\n}: {\r\n  tabs: Tab[];\r\n  active: string;\r\n  onChange: (key: string) => void;\r\n  className?: string;\r\n}) {\r\n  return (\r\n    <div className={`relative ${className || \"\"}`}>\r\n      {/* subtle backdrop and border for contrast on mobile */}\r\n      <div className=\"absolute inset-0 rounded-xl bg-white/5 backdrop-blur-md border border-white/10 pointer-events-none\" />\r\n      <div className=\"relative overflow-x-auto no-scrollbar py-1 px-1\">\r\n        <div className=\"flex items-center gap-2 min-w-max\">\r\n          {tabs.map((t) => {\r\n            const isActive = t.key === active;\r\n            return (\r\n              <button\r\n                key={t.key}\r\n                type=\"button\"\r\n                onPointerDown={(e) => { (e as any).stopPropagation(); }}\r\n                onMouseDown={(e) => { e.stopPropagation(); }}\r\n                onTouchStart={(e) => { (e as any).stopPropagation?.(); }}\r\n                onClick={() => onChange(t.key)}\r\n                className={`transition-all select-none whitespace-nowrap rounded-full px-4 py-2 text-sm font-semibold shadow-sm focus:outline-none focus-visible:ring-2 focus-visible:ring-white/60 active:scale-[0.98]\r\n                  ${\r\n                    isActive\r\n                      ? \"bg-gradient-to-r from-indigo-500 to-fuchsia-500 text-white shadow-indigo-500/30\"\r\n                      : \"bg-white/10 text-slate-100 hover:bg-white/15\"\r\n                  }\r\n                `}\r\n                aria-pressed={isActive}\r\n              >\r\n                {t.label}\r\n              </button>\r\n            );\r\n          })}\r\n        </div>\r\n      </div>\r\n      <style>{`\r\n        /* Hide scrollbars on WebKit/Firefox for a cleaner pill row */\r\n        .no-scrollbar::-webkit-scrollbar { display: none; }\r\n        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }\r\n      `}</style>\r\n    </div>\r\n  );\r\n}\r\n","export type AllTimeTotals = {\r\n  darts: number;\r\n  scored: number;\r\n  fnDarts?: number;\r\n  fnScored?: number;\r\n  // All-time quality metrics\r\n  best3?: number; // highest 3-dart avg achieved in a finished leg\r\n  worst3?: number; // lowest 3-dart avg achieved in a finished leg\r\n  bestLegDarts?: number; // fewest darts to finish a winning leg\r\n  bestCheckout?: number; // highest checkout score achieved\r\n  worstLegDarts?: number; // most darts in a winning leg (optional)\r\n  bestFNAvg?: number; // best per-leg first-nine average\r\n  worstFNAvg?: number; // worst per-leg first-nine average\r\n  num180s?: number;\r\n};\r\ntype StatEntry = {\r\n  t: number;\r\n  darts: number;\r\n  scored: number;\r\n  fnDarts?: number;\r\n  fnScored?: number;\r\n};\r\nexport type GameModeStat = { played: number; won: number };\r\nexport type GameModeStats = Record<string, GameModeStat>;\r\n\r\nconst keyFor = (name: string) => `ndn_stats_${name}`;\r\nconst keySeriesFor = (name: string) => `ndn_stats_ts_${name}`;\r\nconst keyDailyFor = (name: string) => `ndn_stats_daily_${name}`;\r\n\r\nexport function getAllTime(name: string): AllTimeTotals {\r\n  try {\r\n    const raw = localStorage.getItem(keyFor(name));\r\n    if (!raw) return { darts: 0, scored: 0 };\r\n    const parsed = JSON.parse(raw);\r\n    return {\r\n      darts: Number(parsed.darts) || 0,\r\n      scored: Number(parsed.scored) || 0,\r\n      fnDarts: Number(parsed.fnDarts) || 0,\r\n      fnScored: Number(parsed.fnScored) || 0,\r\n      best3: typeof parsed.best3 === \"number\" ? parsed.best3 : 0,\r\n      worst3: typeof parsed.worst3 === \"number\" ? parsed.worst3 : 0,\r\n      bestLegDarts:\r\n        typeof parsed.bestLegDarts === \"number\" ? parsed.bestLegDarts : 0,\r\n      bestCheckout:\r\n        typeof parsed.bestCheckout === \"number\" ? parsed.bestCheckout : 0,\r\n      worstLegDarts:\r\n        typeof parsed.worstLegDarts === \"number\" ? parsed.worstLegDarts : 0,\r\n      bestFNAvg: typeof parsed.bestFNAvg === \"number\" ? parsed.bestFNAvg : 0,\r\n      worstFNAvg: typeof parsed.worstFNAvg === \"number\" ? parsed.worstFNAvg : 0,\r\n      num180s: typeof parsed.num180s === \"number\" ? parsed.num180s : 0,\r\n    };\r\n  } catch {\r\n    return { darts: 0, scored: 0 };\r\n  }\r\n}\r\n\r\nexport function setAllTime(name: string, totals: AllTimeTotals) {\r\n  try {\r\n    localStorage.setItem(keyFor(name), JSON.stringify(totals));\r\n    window.dispatchEvent(\r\n      new CustomEvent(\"ndn:stats-updated\", { detail: { name, totals } }),\r\n    );\r\n  } catch {}\r\n}\r\n\r\n// Clear all stored stats for a user (all-time totals, time-series, and daily snapshot)\r\nexport function clearAllStats(name: string) {\r\n  try {\r\n    localStorage.removeItem(keyFor(name));\r\n    localStorage.removeItem(keySeriesFor(name));\r\n    localStorage.removeItem(keyDailyFor(name));\r\n  } catch {}\r\n  try {\r\n    window.dispatchEvent(\r\n      new CustomEvent(\"ndn:stats-updated\", { detail: { name, cleared: true } }),\r\n    );\r\n  } catch {}\r\n}\r\n\r\nexport function getAllTimeAvg(name: string): number {\r\n  const { darts, scored } = getAllTime(name);\r\n  if (!darts) return 0;\r\n  return (scored / darts) * 3;\r\n}\r\n\r\nexport function getAllTimeFirstNineAvg(name: string): number {\r\n  const { fnDarts = 0, fnScored = 0 } = getAllTime(name);\r\n  if (!fnDarts) return 0;\r\n  return (fnScored / fnDarts) * 3;\r\n}\r\n\r\n// All-time quality metric getters\r\nexport function getAllTimeBestWorst(name: string): {\r\n  best3: number;\r\n  worst3: number;\r\n} {\r\n  const { best3 = 0, worst3 = 0 } = getAllTime(name);\r\n  return { best3, worst3 };\r\n}\r\nexport function getAllTimeBestLeg(name: string): number {\r\n  const { bestLegDarts = 0 } = getAllTime(name);\r\n  return bestLegDarts || 0;\r\n}\r\nexport function getAllTimeBestCheckout(name: string): number {\r\n  const { bestCheckout = 0 } = getAllTime(name);\r\n  return bestCheckout || 0;\r\n}\r\n\r\nexport function getAllTime180s(name: string): number {\r\n  const { num180s = 0 } = getAllTime(name);\r\n  return Number(num180s || 0);\r\n}\r\n\r\n// --- Per-game-mode played/won stats (local-only demo) ---\r\nconst keyGameModes = \"ndn_game_mode_stats\";\r\n\r\nexport function getGameModeStats(allModeKeys?: string[]): GameModeStats {\r\n  let obj: GameModeStats = {};\r\n  try {\r\n    const raw = localStorage.getItem(keyGameModes);\r\n    if (raw) obj = JSON.parse(raw);\r\n  } catch {}\r\n  // Ensure requested keys exist with zeros so charts are stable\r\n  if (Array.isArray(allModeKeys)) {\r\n    for (const k of allModeKeys) {\r\n      if (!obj[k]) obj[k] = { played: 0, won: 0 };\r\n    }\r\n  }\r\n  return obj;\r\n}\r\n\r\nexport function setGameModeStats(stats: GameModeStats) {\r\n  try {\r\n    localStorage.setItem(keyGameModes, JSON.stringify(stats));\r\n    window.dispatchEvent(\r\n      new CustomEvent(\"ndn:stats-updated\", { detail: { gameModes: true } }),\r\n    );\r\n  } catch {}\r\n}\r\n\r\nexport function bumpGameMode(mode: string, won: boolean) {\r\n  const current = getGameModeStats();\r\n  const entry = current[mode] || { played: 0, won: 0 };\r\n  entry.played += 1;\r\n  if (won) entry.won += 1;\r\n  current[mode] = entry;\r\n  setGameModeStats(current);\r\n}\r\n\r\n// Time-series helpers for rolling averages\r\nfunction getSeries(name: string): StatEntry[] {\r\n  try {\r\n    const raw = localStorage.getItem(keySeriesFor(name));\r\n    if (!raw) return [];\r\n    const arr = JSON.parse(raw);\r\n    if (!Array.isArray(arr)) return [];\r\n    return arr\r\n      .map((e: any) => ({\r\n        t: Number(e.t) || 0,\r\n        darts: Number(e.darts) || 0,\r\n        scored: Number(e.scored) || 0,\r\n        fnDarts: Number(e.fnDarts) || 0,\r\n        fnScored: Number(e.fnScored) || 0,\r\n      }))\r\n      .filter((e) => e.t > 0);\r\n  } catch {\r\n    return [];\r\n  }\r\n}\r\n\r\nfunction setSeries(name: string, entries: StatEntry[]) {\r\n  try {\r\n    localStorage.setItem(keySeriesFor(name), JSON.stringify(entries));\r\n    window.dispatchEvent(\r\n      new CustomEvent(\"ndn:stats-updated\", { detail: { name } }),\r\n    );\r\n  } catch {}\r\n}\r\n\r\nfunction pruneOld(entries: StatEntry[], maxAgeMs: number): StatEntry[] {\r\n  const now = Date.now();\r\n  return entries.filter((e) => now - e.t <= maxAgeMs);\r\n}\r\n\r\nexport function addSample(\r\n  name: string,\r\n  darts: number,\r\n  scored: number,\r\n  when: number = Date.now(),\r\n  fnDarts?: number,\r\n  fnScored?: number,\r\n) {\r\n  if (darts <= 0) return;\r\n  const list = getSeries(name);\r\n  const next = pruneOld(\r\n    [...list, { t: when, darts, scored, fnDarts, fnScored }],\r\n    1000 * 60 * 60 * 24 * 30,\r\n  ); // keep ~30 days\r\n  setSeries(name, next);\r\n}\r\n\r\nexport function getRollingAvg(\r\n  name: string,\r\n  windowMs: number = 1000 * 60 * 60 * 24,\r\n): number {\r\n  const list = getSeries(name);\r\n  if (!list.length) return 0;\r\n  const now = Date.now();\r\n  let darts = 0,\r\n    scored = 0;\r\n  for (const e of list) {\r\n    if (now - e.t <= windowMs) {\r\n      darts += e.darts;\r\n      scored += e.scored;\r\n    }\r\n  }\r\n  if (darts <= 0) return 0;\r\n  return (scored / darts) * 3;\r\n}\r\n\r\nexport function getRollingFirstNineAvg(\r\n  name: string,\r\n  windowMs: number = 1000 * 60 * 60 * 24 * 30,\r\n): number {\r\n  const list = getSeries(name);\r\n  if (!list.length) return 0;\r\n  const now = Date.now();\r\n  let darts = 0,\r\n    scored = 0;\r\n  for (const e of list) {\r\n    if (now - e.t <= windowMs) {\r\n      darts += e.fnDarts || 0;\r\n      scored += e.fnScored || 0;\r\n    }\r\n  }\r\n  if (darts <= 0) return 0;\r\n  return (scored / darts) * 3;\r\n}\r\n\r\n// Daily adjusted average: recompute from last 24h at most once per 24h and persist the last value\r\ntype DailySnapshot = { avg: number; ts: number };\r\n\r\nfunction getDailySnapshot(name: string): DailySnapshot | null {\r\n  try {\r\n    const raw = localStorage.getItem(keyDailyFor(name));\r\n    if (!raw) return null;\r\n    const j = JSON.parse(raw);\r\n    return { avg: Number(j.avg) || 0, ts: Number(j.ts) || 0 };\r\n  } catch {\r\n    return null;\r\n  }\r\n}\r\n\r\nfunction setDailySnapshot(name: string, snap: DailySnapshot) {\r\n  try {\r\n    localStorage.setItem(keyDailyFor(name), JSON.stringify(snap));\r\n    window.dispatchEvent(\r\n      new CustomEvent(\"ndn:stats-updated\", { detail: { name } }),\r\n    );\r\n  } catch {}\r\n}\r\n\r\nexport function getDailyAdjustedAvg(name: string): number {\r\n  const snap = getDailySnapshot(name);\r\n  const now = Date.now();\r\n  const DAY = 1000 * 60 * 60 * 24;\r\n  if (snap && now - snap.ts < DAY) return snap.avg;\r\n  // Need to compute a new daily value from the last 24h of samples\r\n  const ra = getRollingAvg(name, DAY);\r\n  const next: DailySnapshot = { avg: ra, ts: now };\r\n  setDailySnapshot(name, next);\r\n  return ra;\r\n}\r\n\r\n// Convenience helpers for monthly (last ~30 days) averages\r\nexport function getMonthlyAvg3(name: string): number {\r\n  const THIRTY_DAYS = 1000 * 60 * 60 * 24 * 30;\r\n  const list = getSeries(name);\r\n  if (!list.length) return 0;\r\n  const now = Date.now();\r\n  // Prefer match-aggregated entries (those with fnDarts defined) to avoid double counting with per-visit samples\r\n  const windowed = list.filter((e) => now - e.t <= THIRTY_DAYS);\r\n  const matchOnly = windowed.filter((e) => typeof e.fnDarts === \"number\");\r\n  const use = matchOnly.length ? matchOnly : windowed;\r\n  let darts = 0,\r\n    scored = 0;\r\n  for (const e of use) {\r\n    darts += e.darts;\r\n    scored += e.scored;\r\n  }\r\n  if (darts <= 0) return 0;\r\n  return (scored / darts) * 3;\r\n}\r\nexport function getMonthlyFirstNineAvg(name: string): number {\r\n  const THIRTY_DAYS = 1000 * 60 * 60 * 24 * 30;\r\n  return getRollingFirstNineAvg(name, THIRTY_DAYS);\r\n}\r\n\r\n// Update all players' all-time totals given a finished match roster\r\nimport type { Player, Leg } from \"./match\";\r\nexport function addMatchToAllTime(players: Player[]) {\r\n  for (const p of players) {\r\n    // Sum over finished legs\r\n    let darts = 0;\r\n    let scored = 0;\r\n    let fnDarts = 0;\r\n    let fnScored = 0;\r\n    // Per-match quality metrics\r\n    let matchBest3 = 0;\r\n    let matchWorst3 = 0;\r\n    let matchBestLegDarts = 0; // track fewest darts on a winning leg only\r\n    let matchBestCheckout = 0;\r\n    let matchWorstLegDarts = 0; // most darts on a winning leg\r\n    let matchBestFNAvg = 0;\r\n    let matchWorstFNAvg = 0;\r\n    let match180s = 0;\r\n    for (const leg of p.legs) {\r\n      if (!leg.finished) continue;\r\n      darts += leg.dartsThrown;\r\n      scored += Math.max(0, leg.totalScoreStart - leg.totalScoreRemaining);\r\n      // First nine darts aggregation (or fewer if leg ended earlier)\r\n      const { d: legFnDarts, s: legFnScored } = sumFirstNine(leg);\r\n      fnDarts += legFnDarts;\r\n      fnScored += legFnScored;\r\n      // Quality metrics per leg\r\n      const legDarts = Math.max(0, leg.dartsThrown);\r\n      const legScored = Math.max(\r\n        0,\r\n        leg.totalScoreStart - leg.totalScoreRemaining,\r\n      );\r\n      const legAvg = legDarts > 0 ? (legScored / legDarts) * 3 : 0;\r\n      const legFNAvg = legFnDarts > 0 ? (legFnScored / legFnDarts) * 3 : 0;\r\n      if (legAvg > 0) {\r\n        matchBest3 = Math.max(matchBest3, legAvg);\r\n        matchWorst3 =\r\n          matchWorst3 === 0 ? legAvg : Math.min(matchWorst3, legAvg);\r\n      }\r\n      if (legFNAvg > 0) {\r\n        matchBestFNAvg = Math.max(matchBestFNAvg, legFNAvg);\r\n        matchWorstFNAvg =\r\n          matchWorstFNAvg === 0\r\n            ? legFNAvg\r\n            : Math.min(matchWorstFNAvg, legFNAvg);\r\n      }\r\n      const wasCheckout = leg.totalScoreRemaining === 0;\r\n      if (wasCheckout) {\r\n        if (matchBestLegDarts === 0 || legDarts < matchBestLegDarts)\r\n          matchBestLegDarts = legDarts;\r\n        if (matchWorstLegDarts === 0 || legDarts > matchWorstLegDarts)\r\n          matchWorstLegDarts = legDarts;\r\n        const co =\r\n          typeof leg.checkoutScore === \"number\" ? leg.checkoutScore : 0;\r\n        if (co > matchBestCheckout) matchBestCheckout = co;\r\n      }\r\n      // Count 180s from visits\r\n      try {\r\n        for (const v of leg.visits || []) {\r\n          if (Number(v.score || 0) === 180) match180s += 1;\r\n        }\r\n      } catch {}\r\n    }\r\n    if (darts > 0) {\r\n      const prev = getAllTime(p.name);\r\n      const next: AllTimeTotals = {\r\n        darts: prev.darts + darts,\r\n        scored: prev.scored + scored,\r\n        fnDarts: (prev.fnDarts || 0) + fnDarts,\r\n        fnScored: (prev.fnScored || 0) + fnScored,\r\n        best3: Math.max(prev.best3 || 0, matchBest3 || 0),\r\n        // For worst3, treat 0 as \"unset\"; choose the min positive across history\r\n        worst3: (() => {\r\n          const prior = prev.worst3 || 0;\r\n          if (prior === 0) return matchWorst3 || 0;\r\n          if (matchWorst3 === 0) return prior;\r\n          return Math.min(prior, matchWorst3);\r\n        })(),\r\n        // Fewest darts on winning leg; 0 means no winning legs recorded yet\r\n        bestLegDarts: (() => {\r\n          const prior = prev.bestLegDarts || 0;\r\n          if (prior === 0) return matchBestLegDarts || 0;\r\n          if (matchBestLegDarts === 0) return prior;\r\n          return Math.min(prior, matchBestLegDarts);\r\n        })(),\r\n        bestCheckout: Math.max(prev.bestCheckout || 0, matchBestCheckout || 0),\r\n        worstLegDarts: (() => {\r\n          const prior = prev.worstLegDarts || 0;\r\n          if (prior === 0) return matchWorstLegDarts || 0;\r\n          if (matchWorstLegDarts === 0) return prior;\r\n          return Math.max(prior, matchWorstLegDarts);\r\n        })(),\r\n        bestFNAvg: Math.max(prev.bestFNAvg || 0, matchBestFNAvg || 0),\r\n        worstFNAvg: (() => {\r\n          const prior = prev.worstFNAvg || 0;\r\n          if (prior === 0) return matchWorstFNAvg || 0;\r\n          if (matchWorstFNAvg === 0) return prior;\r\n          return Math.min(prior, matchWorstFNAvg);\r\n        })(),\r\n        num180s: (prev.num180s || 0) + (match180s || 0),\r\n      };\r\n      setAllTime(p.name, next);\r\n      // Also add a time-series sample for rolling averages\r\n      addSample(p.name, darts, scored, Date.now(), fnDarts, fnScored);\r\n    }\r\n  }\r\n}\r\n\r\n// Helper: sum points and darts for the first 9 darts of a leg (or fewer if finished earlier)\r\nfunction sumFirstNine(leg: Leg): { d: number; s: number } {\r\n  let remain = Math.min(9, leg.dartsThrown);\r\n  if (remain <= 0) return { d: 0, s: 0 };\r\n  let s = 0;\r\n  for (const v of leg.visits) {\r\n    if (remain <= 0) break;\r\n    const take = Math.min(remain, v.darts);\r\n    // Pro-rate score if partial darts from a visit are included\r\n    if (take === v.darts) s += v.score;\r\n    else s += Math.round((v.score / v.darts) * take);\r\n    remain -= take;\r\n  }\r\n  const d = Math.min(9, leg.dartsThrown);\r\n  return { d, s };\r\n}\r\n","export const freeGames = [\"X01\", \"Double Practice\"] as const;\r\nexport type ModeKey =\r\n  | \"bestof\"\r\n  | \"firstto\"\r\n  | \"rounds\"\r\n  | \"practice\"\r\n  | \"none\"\r\n  | \"innings\"\r\n  | \"holes\";\r\nexport interface GameConfig {\r\n  startOptions: number[];\r\n  modeOptions: ModeKey[];\r\n  modeValueOptions?: Partial<Record<ModeKey, number[]>>;\r\n}\r\nexport const premiumGames = [\r\n  \"Around the Clock\",\r\n  \"Cricket\",\r\n  \"Halve It\",\r\n  \"Shanghai\",\r\n  \"High-Low\",\r\n  \"Killer\",\r\n  \"Bob's 27\",\r\n  \"Count-Up\",\r\n  \"High Score\",\r\n  \"Low Score\",\r\n  \"Checkout 170\",\r\n  \"Checkout 121\",\r\n  \"Treble Practice\",\r\n  \"Baseball\",\r\n  \"Golf\",\r\n  \"Tic Tac Toe\",\r\n  \"American Cricket\",\r\n  \"Scam\",\r\n  \"Fives\",\r\n  \"Sevens\",\r\n] as const;\r\nexport type GameKey =\r\n  | (typeof freeGames)[number]\r\n  | (typeof premiumGames)[number];\r\nexport const allGames: GameKey[] = [...freeGames, ...premiumGames];\r\n\r\n// Per-game configuration for UI helpers and filtering\r\nexport const gameConfig: Record<GameKey, GameConfig> = {\r\n  X01: {\r\n    startOptions: [301, 501, 701],\r\n    modeOptions: [\"bestof\", \"firstto\"],\r\n    modeValueOptions: { bestof: [1, 3, 5, 7], firstto: [1, 2, 3, 4, 5, 6] },\r\n  },\r\n  \"Double Practice\": {\r\n    startOptions: [],\r\n    modeOptions: [\"practice\"],\r\n    modeValueOptions: { practice: [30, 60, 120] },\r\n  },\r\n  \"Around the Clock\": {\r\n    startOptions: [],\r\n    modeOptions: [\"bestof\", \"firstto\"],\r\n    modeValueOptions: { bestof: [1, 3, 5], firstto: [1, 2, 3, 4] },\r\n  },\r\n  Cricket: {\r\n    startOptions: [],\r\n    modeOptions: [\"bestof\", \"firstto\", \"rounds\"],\r\n    modeValueOptions: {\r\n      bestof: [1, 3, 5],\r\n      firstto: [1, 2, 3, 4],\r\n      rounds: [1, 3, 5],\r\n    },\r\n  },\r\n  \"Halve It\": {\r\n    startOptions: [],\r\n    modeOptions: [\"bestof\", \"firstto\"],\r\n    modeValueOptions: { bestof: [1, 3, 5], firstto: [1, 2, 3, 4] },\r\n  },\r\n  Shanghai: {\r\n    startOptions: [],\r\n    modeOptions: [\"bestof\", \"firstto\"],\r\n    modeValueOptions: { bestof: [1, 3, 5], firstto: [1, 2, 3, 4] },\r\n  },\r\n  \"High-Low\": {\r\n    startOptions: [],\r\n    modeOptions: [\"bestof\", \"firstto\"],\r\n    modeValueOptions: { bestof: [1, 3, 5], firstto: [1, 2, 3, 4] },\r\n  },\r\n  Killer: {\r\n    startOptions: [],\r\n    modeOptions: [\"bestof\", \"firstto\"],\r\n    modeValueOptions: { bestof: [1, 3, 5], firstto: [1, 2, 3, 4] },\r\n  },\r\n  \"Bob's 27\": {\r\n    startOptions: [],\r\n    modeOptions: [\"bestof\", \"firstto\"],\r\n    modeValueOptions: { bestof: [1, 3, 5], firstto: [1, 2, 3, 4] },\r\n  },\r\n  \"Count-Up\": {\r\n    startOptions: [],\r\n    modeOptions: [\"bestof\", \"firstto\"],\r\n    modeValueOptions: { bestof: [1, 3, 5], firstto: [1, 2, 3, 4] },\r\n  },\r\n  \"High Score\": {\r\n    startOptions: [],\r\n    modeOptions: [\"bestof\", \"firstto\"],\r\n    modeValueOptions: { bestof: [1, 3, 5], firstto: [1, 2, 3, 4] },\r\n  },\r\n  \"Low Score\": {\r\n    startOptions: [],\r\n    modeOptions: [\"bestof\", \"firstto\"],\r\n    modeValueOptions: { bestof: [1, 3, 5], firstto: [1, 2, 3, 4] },\r\n  },\r\n  \"Checkout 170\": {\r\n    startOptions: [],\r\n    modeOptions: [\"bestof\", \"firstto\"],\r\n    modeValueOptions: { bestof: [1, 3, 5], firstto: [1, 2, 3, 4] },\r\n  },\r\n  \"Checkout 121\": {\r\n    startOptions: [],\r\n    modeOptions: [\"bestof\", \"firstto\"],\r\n    modeValueOptions: { bestof: [1, 3, 5], firstto: [1, 2, 3, 4] },\r\n  },\r\n  \"Treble Practice\": {\r\n    startOptions: [],\r\n    modeOptions: [\"practice\"],\r\n    modeValueOptions: { practice: [30, 60, 120] },\r\n  },\r\n  Baseball: {\r\n    startOptions: [],\r\n    modeOptions: [\"bestof\", \"innings\"],\r\n    modeValueOptions: { bestof: [1, 3, 5], innings: [1, 3, 5, 9] },\r\n  },\r\n  Golf: {\r\n    startOptions: [],\r\n    modeOptions: [\"holes\", \"bestof\"],\r\n    modeValueOptions: { holes: [9, 18], bestof: [1, 3, 5] },\r\n  },\r\n  \"Tic Tac Toe\": {\r\n    startOptions: [],\r\n    modeOptions: [\"bestof\", \"firstto\"],\r\n    modeValueOptions: { bestof: [1, 3, 5], firstto: [1, 2, 3, 4] },\r\n  },\r\n  \"American Cricket\": {\r\n    startOptions: [],\r\n    modeOptions: [\"bestof\", \"firstto\"],\r\n    modeValueOptions: { bestof: [1, 3, 5], firstto: [1, 2, 3, 4] },\r\n  },\r\n  Scam: {\r\n    startOptions: [],\r\n    modeOptions: [\"bestof\", \"firstto\"],\r\n    modeValueOptions: { bestof: [1, 3, 5], firstto: [1, 2, 3, 4] },\r\n  },\r\n  Fives: {\r\n    startOptions: [],\r\n    modeOptions: [\"bestof\", \"firstto\"],\r\n    modeValueOptions: { bestof: [1, 3, 5], firstto: [1, 2, 3, 4] },\r\n  },\r\n  Sevens: {\r\n    startOptions: [],\r\n    modeOptions: [\"bestof\", \"firstto\"],\r\n    modeValueOptions: { bestof: [1, 3, 5], firstto: [1, 2, 3, 4] },\r\n  },\r\n};\r\n\r\nexport function getStartOptionsForGame(g: \"all\" | GameKey): number[] {\r\n  if (g === \"all\") return [301, 501, 701];\r\n  const cfg = gameConfig[g];\r\n  return cfg?.startOptions ?? [];\r\n}\r\n\r\nexport function getModeOptionsForGame(g: \"all\" | GameKey): (ModeKey | \"all\")[] {\r\n  if (g === \"all\") return [\"all\", \"bestof\", \"firstto\"];\r\n  const cfg = gameConfig[g];\r\n  if (!cfg) return [\"all\", \"bestof\", \"firstto\"];\r\n  return [\"all\", ...cfg.modeOptions];\r\n}\r\n\r\nexport function getModeValueOptionsForGame(\r\n  g: \"all\" | GameKey,\r\n  mode: ModeKey | \"all\",\r\n): number[] {\r\n  if (g === \"all\" || mode === \"all\") return [];\r\n  const cfg = gameConfig[g];\r\n  return cfg?.modeValueOptions?.[mode] ?? [];\r\n}\r\n\r\nexport function labelForMode(opt: string | undefined | null) {\r\n  if (!opt) return \"\";\r\n  switch (opt) {\r\n    case \"all\":\r\n      return \"All Modes\";\r\n    case \"bestof\":\r\n      return \"Best of\";\r\n    case \"firstto\":\r\n      return \"First to\";\r\n    case \"innings\":\r\n      return \"Innings\";\r\n    case \"holes\":\r\n      return \"Holes\";\r\n    case \"rounds\":\r\n      return \"Rounds\";\r\n    case \"practice\":\r\n      return \"Practice\";\r\n    case \"none\":\r\n      return \"Mode\";\r\n    default:\r\n      return String(opt)\r\n        .replace(/[-_]/g, \" \")\r\n        .replace(/\\b\\w/g, (s) => s.toUpperCase());\r\n  }\r\n}\r\n","import React from \"react\";\r\n\r\ntype Props = {\r\n  status: \"connecting\" | \"connected\" | \"disconnected\";\r\n  title?: string;\r\n  size?: number; // pixels, defaults to 12\r\n};\r\n\r\nexport default function StatusDot({ status, title, size = 12 }: Props) {\r\n  const s = size;\r\n  if (status === \"connecting\") {\r\n    return (\r\n      <span\r\n        role=\"img\"\r\n        aria-label=\"Connecting\"\r\n        title={title || \"Connecting\"}\r\n        className=\"inline-flex items-center justify-center\"\r\n        style={{ width: s, height: s }}\r\n      >\r\n        <svg\r\n          width={s}\r\n          height={s}\r\n          viewBox=\"0 0 24 24\"\r\n          className=\"animate-spin\"\r\n          aria-hidden=\"true\"\r\n        >\r\n          <circle\r\n            cx=\"12\"\r\n            cy=\"12\"\r\n            r=\"10\"\r\n            stroke=\"#A7F3D0\"\r\n            strokeWidth=\"3\"\r\n            fill=\"none\"\r\n            opacity=\"0.35\"\r\n          />\r\n          <path\r\n            d=\"M22 12a10 10 0 0 0-10-10\"\r\n            stroke=\"#34D399\"\r\n            strokeWidth=\"3\"\r\n            strokeLinecap=\"round\"\r\n            fill=\"none\"\r\n          />\r\n        </svg>\r\n      </span>\r\n    );\r\n  }\r\n  if (status === \"connected\") {\r\n    return (\r\n      <span\r\n        role=\"img\"\r\n        aria-label=\"Connected\"\r\n        title={title || \"Connected\"}\r\n        className=\"inline-flex items-center justify-center\"\r\n        style={{ width: s, height: s }}\r\n      >\r\n        <svg width={s} height={s} viewBox=\"0 0 24 24\" aria-hidden=\"true\">\r\n          <circle cx=\"12\" cy=\"12\" r=\"10\" fill=\"#34D399\" />\r\n        </svg>\r\n      </span>\r\n    );\r\n  }\r\n  return (\r\n    <span\r\n      role=\"img\"\r\n      aria-label=\"Disconnected\"\r\n      title={title || \"Not connected\"}\r\n      className=\"inline-flex items-center justify-center\"\r\n      style={{ width: s, height: s }}\r\n    >\r\n      <svg width={s} height={s} viewBox=\"0 0 24 24\" aria-hidden=\"true\">\r\n        <circle cx=\"12\" cy=\"12\" r=\"10\" fill=\"#F87171\" opacity=\"0.15\" />\r\n        <circle\r\n          cx=\"12\"\r\n          cy=\"12\"\r\n          r=\"9\"\r\n          stroke=\"#F87171\"\r\n          strokeWidth=\"2\"\r\n          fill=\"none\"\r\n        />\r\n        <rect x=\"6\" y=\"11\" width=\"12\" height=\"2\" rx=\"1\" fill=\"#F87171\" />\r\n      </svg>\r\n    </span>\r\n  );\r\n}\r\n","import { useEffect, useRef } from \"react\";\r\nimport { useCameraSession } from \"../store/cameraSession\";\r\n\r\n/**\r\n * CameraStatusBadge\r\n * A compact, always-visible header badge that shows a live thumbnail of the phone camera\r\n * when streaming, with a green tick overlay. Clicking toggles the global phone overlay.\r\n */\r\nexport default function CameraStatusBadge() {\r\n  const camera = useCameraSession();\r\n  const canvasRef = useRef<HTMLCanvasElement | null>(null);\r\n  const rafRef = useRef<number | null>(null);\r\n\r\n  const videoEl = camera.getVideoElementRef();\r\n  const sessionStream = camera.getMediaStream?.();\r\n  const hasActivePhoneStream = !!(sessionStream || videoEl?.srcObject);\r\n  const streaming =\r\n    camera.isStreaming && camera.mode === \"phone\" && hasActivePhoneStream;\r\n\r\n  useEffect(() => {\r\n    const canvas = canvasRef.current;\r\n    if (!canvas) return;\r\n\r\n    let running = true;\r\n    const ctx = canvas.getContext(\"2d\");\r\n    if (!ctx) return;\r\n\r\n    const render = () => {\r\n      if (!running) return;\r\n      try {\r\n        ctx.clearRect(0, 0, canvas.width, canvas.height);\r\n        if (streaming && videoEl && videoEl.readyState >= 2) {\r\n          const vw = videoEl.videoWidth || 640;\r\n          const vh = videoEl.videoHeight || 360;\r\n          // Fit cover into canvas (letterbox/crop to preserve aspect)\r\n          const cw = canvas.width;\r\n          const ch = canvas.height;\r\n          const vr = vw / vh;\r\n          const cr = cw / ch;\r\n          let sx = 0,\r\n            sy = 0,\r\n            sw = vw,\r\n            sh = vh;\r\n          if (vr > cr) {\r\n            // video is wider than canvas; crop sides\r\n            const targetW = vh * cr;\r\n            sx = (vw - targetW) / 2;\r\n            sw = targetW;\r\n          } else if (vr < cr) {\r\n            // video is taller; crop top/bottom\r\n            const targetH = vw / cr;\r\n            sy = (vh - targetH) / 2;\r\n            sh = targetH;\r\n          }\r\n          ctx.drawImage(videoEl, sx, sy, sw, sh, 0, 0, cw, ch);\r\n        } else {\r\n          // Placeholder background when not streaming\r\n          ctx.fillStyle = \"rgba(148, 163, 184, 0.25)\";\r\n          ctx.fillRect(0, 0, canvas.width, canvas.height);\r\n          ctx.fillStyle = \"rgba(226,232,240,0.8)\";\r\n          ctx.font = \"10px system-ui, sans-serif\";\r\n          ctx.textAlign = \"center\";\r\n          ctx.textBaseline = \"middle\";\r\n          ctx.fillText(\"Camera\", canvas.width / 2, canvas.height / 2);\r\n        }\r\n  } catch (e) {}\r\n      rafRef.current = requestAnimationFrame(render);\r\n    };\r\n\r\n    rafRef.current = requestAnimationFrame(render);\r\n    return () => {\r\n      running = false;\r\n      if (rafRef.current) cancelAnimationFrame(rafRef.current);\r\n    };\r\n    // Include only essentials; avoid re-creating loop unnecessarily\r\n  }, [streaming, videoEl]);\r\n\r\n  const onClick = () => {\r\n    try {\r\n      // Toggle global overlay visibility via event (handled by overlay component)\r\n      window.dispatchEvent(new CustomEvent(\"ndn:toggle-phone-overlay\"));\r\n  } catch (e) {}\r\n  };\r\n\r\n  return (\r\n    <button\r\n      type=\"button\"\r\n      onClick={onClick}\r\n      className=\"relative inline-flex items-center gap-1 rounded-lg border border-white/15 bg-white/5 hover:bg-white/10 transition-colors shadow-sm overflow-hidden\"\r\n      style={{ height: 36 }}\r\n      title={\r\n        streaming\r\n          ? \"Camera connected  click to toggle overlay\"\r\n          : \"Camera not connected\"\r\n      }\r\n    >\r\n      <canvas ref={canvasRef} width={64} height={36} className=\"block\" />\r\n      <span className=\"pr-2 text-xs text-slate-100 select-none hidden xs:inline\">\r\n        {streaming ? \"Phone Cam\" : \"No Camera\"}\r\n      </span>\r\n      {/* Status tick */}\r\n      <span\r\n        className=\"absolute -top-1 -right-1 text-lg pointer-events-none drop-shadow\"\r\n        aria-hidden=\"true\"\r\n      >\r\n        {streaming ? \"\" : \"\"}\r\n      </span>\r\n    </button>\r\n  );\r\n}\r\n","// Help Desk AI - Provides intelligent responses to common questions\r\nexport const HELP_TOPICS = {\r\n  calibration: {\r\n    keywords: [\r\n      \"calibration\",\r\n      \"calibrate\",\r\n      \"camera\",\r\n      \"score\",\r\n      \"accuracy\",\r\n      \"aim\",\r\n      \"setup\",\r\n    ],\r\n    title: \"How Calibration Works\",\r\n    explanation: `Calibration helps our AI precisely detect where your darts land on the board. Here's how it works:\r\n\r\n1. **D20**: Click on the 20 segment to calibrate that area\r\n2. **D6**: Click on the 6 segment to calibrate that area\r\n3. **D3**: Click on the 3 segment to calibrate that area\r\n4. **D11**: Click on the 11 segment to calibrate that area\r\n5. **Bullseye**: Click on the bullseye to calibrate the center\r\n\r\nEach click teaches the system about your board's position and angle. After calibrating all areas, your scoring will be much more accurate!`,\r\n    actions: [\r\n      { id: \"D20\", label: \" Click D20\", color: \"bg-blue-600\" },\r\n      { id: \"D6\", label: \" Click D6\", color: \"bg-purple-600\" },\r\n      { id: \"D3\", label: \" Click D3\", color: \"bg-pink-600\" },\r\n      { id: \"D11\", label: \" Click D11\", color: \"bg-cyan-600\" },\r\n      { id: \"Bullseye\", label: \" Click Bullseye\", color: \"bg-yellow-600\" },\r\n    ],\r\n  },\r\n  scoring: {\r\n    keywords: [\r\n      \"score\",\r\n      \"points\",\r\n      \"counting\",\r\n      \"how do i score\",\r\n      \"scoring system\",\r\n    ],\r\n    title: \"Dart Scoring\",\r\n    explanation: `In darts, each segment on the board has a value:\r\n- Single areas: Face value (1-20)\r\n- Double ring (outer): 2 the segment number\r\n- Triple ring (inner): 3 the segment number\r\n- Bullseye: 50 points\r\n- Bull (outer bull): 25 points\r\n\r\nFor example: hitting Triple 20 = 60 points, Double 10 = 20 points`,\r\n  },\r\n  gameplay: {\r\n    keywords: [\r\n      \"game\",\r\n      \"how to play\",\r\n      \"rules\",\r\n      \"x01\",\r\n      \"cricket\",\r\n      \"match\",\r\n      \"round\",\r\n    ],\r\n    title: \"How to Play\",\r\n    explanation: `Nine Dart Nation supports multiple game modes:\r\n\r\n**X01** (501, 301, 701): Start from the set score and count down to exactly 0. Final dart must be on a double.\r\n\r\n**Cricket**: Players try to \"close\" numbers 15-20 and bullseye by hitting them. First to close all and have the highest score wins.\r\n\r\n**Killer**: Players mark their \"number\" and try to knock out other players' lives.\r\n\r\nSelect your game mode when creating a match, and follow the on-screen instructions!`,\r\n  },\r\n  premium: {\r\n    keywords: [\r\n      \"premium\",\r\n      \"subscription\",\r\n      \"features\",\r\n      \"upgrade\",\r\n      \"cost\",\r\n      \"paid\",\r\n    ],\r\n    title: \"Premium Features\",\r\n    explanation: `Our Premium subscription gives you:\r\n- Tournament creation and entry\r\n- Advanced statistics and replays\r\n- Priority matchmaking\r\n- Custom profiles and themes\r\n- Ad-free experience\r\n\r\nPremium grants are often awarded as tournament prizes!`,\r\n  },\r\n  connection: {\r\n    keywords: [\r\n      \"connection\",\r\n      \"disconnect\",\r\n      \"lag\",\r\n      \"latency\",\r\n      \"websocket\",\r\n      \"error\",\r\n      \"offline\",\r\n    ],\r\n    title: \"Connection Issues\",\r\n    explanation: `If you're experiencing connection issues:\r\n1. Check your internet connection\r\n2. Refresh the page (Ctrl+R or Cmd+R)\r\n3. Clear browser cache\r\n4. Try a different browser\r\n5. Check if the site status page shows any issues\r\n\r\nMost connection issues resolve in seconds. Contact admin if problems persist.`,\r\n  },\r\n  camera: {\r\n    keywords: [\r\n      \"camera\",\r\n      \"phone camera\",\r\n      \"mobile\",\r\n      \"video\",\r\n      \"pairing\",\r\n      \"connect\",\r\n    ],\r\n    title: \"Camera Setup\",\r\n    explanation: `To use our phone camera feature:\r\n1. Open Nine Dart Nation on your phone\r\n2. Go to Settings > Camera Pairing\r\n3. Scan the QR code or enter the pairing code\r\n4. Position your phone to capture the dartboard\r\n5. Run calibration (see calibration help for details)\r\n\r\nYour phone will now act as a live dartboard camera!`,\r\n  },\r\n  tournament: {\r\n    keywords: [\r\n      \"tournament\",\r\n      \"compete\",\r\n      \"bracket\",\r\n      \"prize\",\r\n      \"winner\",\r\n      \"playoffs\",\r\n    ],\r\n    title: \"Tournaments\",\r\n    explanation: `Tournaments are competitive events where you can:\r\n- Play against other skilled players\r\n- Win prizes (Premium subscriptions or cash)\r\n- Climb leaderboards\r\n- Compete in structured brackets\r\n\r\nCheck the Tournaments tab to see upcoming events. Registration typically opens 30 minutes before start time.`,\r\n  },\r\n};\r\n\r\nexport interface AIResponse {\r\n  type: \"explanation\" | \"suggestion\" | \"escalate\";\r\n  title: string;\r\n  message: string;\r\n  actions?: Array<{ id: string; label: string; color: string }>;\r\n  followUp?: string;\r\n}\r\n\r\nexport function analyzeUserQuestion(question: string): AIResponse | null {\r\n  const lowerQ = question.toLowerCase();\r\n\r\n  // Find matching topic\r\n  for (const [key, topic] of Object.entries(HELP_TOPICS)) {\r\n    for (const keyword of topic.keywords) {\r\n      if (lowerQ.includes(keyword)) {\r\n        return {\r\n          type: \"explanation\",\r\n          title: topic.title,\r\n          message: topic.explanation,\r\n          actions: (topic as any).actions,\r\n          followUp:\r\n            \"Do you need further assistance? I can connect you with an admin if needed.\",\r\n        };\r\n      }\r\n    }\r\n  }\r\n\r\n  // No match found - suggest escalation\r\n  return {\r\n    type: \"suggestion\",\r\n    title: \"Need More Help?\",\r\n    message: `I couldn't find a specific answer to your question. Common topics I can help with:\\n\\n${Object.values(\r\n      HELP_TOPICS,\r\n    )\r\n      .map((t) => ` ${t.title}`)\r\n      .join(\"\\n\")}\\n\\nOr I can connect you with an admin who can help further.`,\r\n    followUp: \"Would you like to speak with an admin?\",\r\n  };\r\n}\r\n\r\nexport function getEstimatedWaitTime(): string {\r\n  const hour = new Date().getHours();\r\n\r\n  if (hour >= 20 || hour < 7) {\r\n    return \"20-30 minutes (off-peak hours)\";\r\n  } else if (hour >= 12 && hour < 14) {\r\n    return \"10-15 minutes (moderate traffic)\";\r\n  } else if (hour >= 18 && hour < 20) {\r\n    return \"15-20 minutes (peak hours)\";\r\n  } else {\r\n    return \"5-10 minutes\";\r\n  }\r\n}\r\n","import React, { useEffect, useState, useRef, useCallback } from \"react\";\r\nimport { useWS } from \"./WSProvider\";\r\nimport { X, Send, Zap, Clock, User } from \"lucide-react\";\r\nimport { analyzeUserQuestion, getEstimatedWaitTime } from \"../utils/helpDeskAI\";\r\n\r\nexport default function HelpdeskChat({\r\n  request,\r\n  user,\r\n  onClose,\r\n}: {\r\n  request: any;\r\n  user: any;\r\n  onClose?: () => void;\r\n}) {\r\n  const ws = (() => {\r\n    try {\r\n      return useWS();\r\n    } catch {\r\n      return null;\r\n    }\r\n  })();\r\n  const [messages, setMessages] = useState<any[]>(request?.messages || []);\r\n  const [input, setInput] = useState(\"\");\r\n  const [typingUsers, setTypingUsers] = useState<Record<string, number>>({});\r\n  const [adminConnected, setAdminConnected] = useState(false);\r\n  const [waitTime, setWaitTime] = useState(\"\");\r\n  const msgsRef = useRef<HTMLDivElement | null>(null);\r\n  const typingTimeoutRef = useRef<number | null>(null);\r\n  const timersRef = useRef<number[]>([]);\r\n\r\n  useEffect(() => {\r\n    if (!ws) return;\r\n    const un = ws.addListener((data: any) => {\r\n      try {\r\n        if (\r\n          data?.type === \"help-message\" &&\r\n          String(data.requestId) === String(request.id)\r\n        ) {\r\n          setMessages((m) => [...m, data.message]);\r\n        }\r\n        if (\r\n          data?.type === \"help-request-updated\" &&\r\n          data.request?.id === request.id\r\n        ) {\r\n          setMessages(data.request.messages || []);\r\n          setAdminConnected(data.request.claimedBy ? true : false);\r\n        }\r\n        if (\r\n          data?.type === \"help-typing\" &&\r\n          String(data.requestId) === String(request.id)\r\n        ) {\r\n          const who =\r\n            data.fromName || data.fromEmail || (data.admin ? \"admin\" : \"user\");\r\n          setTypingUsers((prev) => ({ ...prev, [who]: Date.now() }));\r\n        }\r\n      } catch {}\r\n    });\r\n    return () => {\r\n      un();\r\n    };\r\n  }, [ws, request?.id]);\r\n\r\n  const sendMsg = () => {\r\n    if (!input.trim()) return;\r\n\r\n    // Send user message\r\n    const userMessage = input;\r\n    const payload = {\r\n      type: \"help-message\",\r\n      requestId: request.id,\r\n      message: userMessage,\r\n    };\r\n    try {\r\n      ws?.send(payload);\r\n    } catch {}\r\n\r\n    const msgObj = {\r\n      fromEmail: user?.email || null,\r\n      fromName: user?.username || null,\r\n      message: userMessage,\r\n      ts: Date.now(),\r\n      admin: false,\r\n    };\r\n    setMessages((m) => [...m, msgObj]);\r\n    setInput(\"\");\r\n\r\n    // If admin not connected, try AI response\r\n    if (!adminConnected) {\r\n      const t = window.setTimeout(() => {\r\n        const aiResponse = analyzeUserQuestion(userMessage);\r\n        if (aiResponse) {\r\n          const aiMsg = {\r\n            fromName: \"AI Assistant\",\r\n            message: `${aiResponse.title}\\n\\n${aiResponse.message}`,\r\n            ts: Date.now(),\r\n            admin: true,\r\n            actions: aiResponse.actions,\r\n            followUp: aiResponse.followUp,\r\n          };\r\n          setMessages((m) => [...m, aiMsg]);\r\n        }\r\n      }, 500);\r\n      timersRef.current.push(t);\r\n    }\r\n  };\r\n\r\n  const requestAdminConnection = (needsHelp: boolean) => {\r\n    if (!needsHelp) {\r\n      const confirmMsg = {\r\n        fromName: \"You\",\r\n        message: \"No, I think I have it now. Thanks!\",\r\n        ts: Date.now(),\r\n        admin: false,\r\n      };\r\n      setMessages((m) => [...m, confirmMsg]);\r\n\r\n      const t = window.setTimeout(() => {\r\n        const aiMsg = {\r\n          fromName: \"AI Assistant\",\r\n          message:\r\n            \" Great! Glad I could help. Feel free to reach out anytime you need assistance.\",\r\n          ts: Date.now(),\r\n          admin: true,\r\n        };\r\n        setMessages((m) => [...m, aiMsg]);\r\n      }, 300);\r\n      timersRef.current.push(t);\r\n      return;\r\n    }\r\n\r\n    // Request admin connection\r\n    const confirmMsg = {\r\n      fromName: \"You\",\r\n      message: \"Yes, I need to speak with an admin\",\r\n      ts: Date.now(),\r\n      admin: false,\r\n    };\r\n    setMessages((m) => [...m, confirmMsg]);\r\n\r\n    // Send escalation request to admins\r\n    try {\r\n      ws?.send({ type: \"help-escalate\", requestId: request.id });\r\n    } catch {}\r\n\r\n    setWaitTime(getEstimatedWaitTime());\r\n\r\n    const t = window.setTimeout(() => {\r\n      const waitMsg = {\r\n        fromName: \"System\",\r\n        message: ` Connecting you with an admin...\\n\\n Estimated wait time: ${waitTime}\\n\\nAn admin will be with you shortly. Please stay on this chat.`,\r\n        ts: Date.now(),\r\n        admin: true,\r\n      };\r\n      setMessages((m) => [...m, waitMsg]);\r\n    }, 500);\r\n    timersRef.current.push(t);\r\n  };\r\n\r\n  // auto-scroll to bottom when messages update\r\n  useEffect(() => {\r\n    if (!msgsRef.current) return;\r\n    try {\r\n      msgsRef.current.scrollTop = msgsRef.current.scrollHeight;\r\n    } catch {}\r\n  }, [messages]);\r\n\r\n  // send typing notifications (debounced)\r\n  const sendTyping = useCallback(() => {\r\n    try {\r\n      ws?.send({\r\n        type: \"help-typing\",\r\n        requestId: request.id,\r\n        fromName: user?.username,\r\n        fromEmail: user?.email,\r\n        admin: !!user?.isAdmin,\r\n      });\r\n    } catch {}\r\n    if (typingTimeoutRef.current) {\r\n      clearTimeout(typingTimeoutRef.current);\r\n    }\r\n    typingTimeoutRef.current = window.setTimeout(() => {\r\n      setTypingUsers((prev) => {\r\n        const copy = { ...prev };\r\n        delete copy[user?.username || user?.email || \"me\"];\r\n        return copy;\r\n      });\r\n    }, 3000);\r\n  }, [ws, request.id, user]);\r\n\r\n  useEffect(() => {\r\n    return () => {\r\n      if (typingTimeoutRef.current) clearTimeout(typingTimeoutRef.current);\r\n      for (const t of timersRef.current) clearTimeout(t);\r\n      timersRef.current = [];\r\n    };\r\n  }, []);\r\n\r\n  return (\r\n    <div className=\"fixed inset-0 z-50 flex items-end justify-center p-4\">\r\n      <div className=\"absolute inset-0 bg-black/40\" onClick={onClose} />\r\n      <div className=\"relative w-full max-w-2xl bg-slate-900 rounded-lg shadow-xl overflow-hidden flex flex-col max-h-[80vh]\">\r\n        <div className=\"flex items-center justify-between p-3 border-b border-slate-700 bg-slate-800\">\r\n          <div className=\"flex items-center gap-3\">\r\n            <div className=\"font-semibold flex items-center gap-2\">\r\n              <Zap className=\"w-4 h-4 text-yellow-400\" />\r\n              Help Desk  {request.username || \"Anonymous\"}\r\n            </div>\r\n            {adminConnected && (\r\n              <span className=\"text-xs px-2 py-1 rounded bg-emerald-600\">\r\n                Admin Connected\r\n              </span>\r\n            )}\r\n          </div>\r\n          <button\r\n            aria-label=\"Close\"\r\n            className=\"px-2 py-1 rounded bg-neutral-700 hover:bg-neutral-600 text-sm\"\r\n            onClick={onClose}\r\n          >\r\n            <X className=\"w-4 h-4\" />\r\n          </button>\r\n        </div>\r\n\r\n        <div\r\n          ref={msgsRef}\r\n          className=\"flex-1 overflow-y-auto p-3 space-y-3 bg-black/20\"\r\n        >\r\n          {messages.map((m, i) => (\r\n            <div key={i}>\r\n              <div\r\n                className={`max-w-[85%] px-3 py-2 rounded ${m.admin ? \"bg-emerald-600/20 border border-emerald-500/40 text-emerald-100 ml-auto\" : \"bg-slate-700 text-slate-100\"}`}\r\n              >\r\n                <div className=\"flex items-center justify-between mb-1\">\r\n                  <div className=\"text-xs opacity-70 font-semibold flex items-center gap-1\">\r\n                    {m.admin ? (\r\n                      <Zap className=\"w-3 h-3\" />\r\n                    ) : (\r\n                      <User className=\"w-3 h-3\" />\r\n                    )}\r\n                    {m.fromName ||\r\n                      m.fromEmail ||\r\n                      (m.admin ? \"AI Assistant\" : \"You\")}\r\n                  </div>\r\n                  <div className=\"text-xs opacity-50 ml-2\">\r\n                    {m.ts\r\n                      ? new Date(m.ts).toLocaleTimeString([], {\r\n                          hour: \"2-digit\",\r\n                          minute: \"2-digit\",\r\n                        })\r\n                      : \"\"}\r\n                  </div>\r\n                </div>\r\n                <div className=\"whitespace-pre-wrap break-words text-sm\">\r\n                  {m.message}\r\n                </div>\r\n\r\n                {/* Calibration actions */}\r\n                {m.actions && m.actions.length > 0 && (\r\n                  <div className=\"mt-3 space-y-2\">\r\n                    <div className=\"text-xs font-semibold opacity-80\">\r\n                       Try these calibration points:\r\n                    </div>\r\n                    <div className=\"grid grid-cols-2 md:grid-cols-5 gap-2\">\r\n                      {m.actions.map((action: any) => (\r\n                        <button\r\n                          key={action.id}\r\n                          className={`${action.color} text-white text-xs py-2 px-2 rounded font-medium hover:opacity-90 transition-opacity`}\r\n                          onClick={() => {\r\n                            const actionMsg = {\r\n                              fromName: \"You\",\r\n                              message: `Clicked: ${action.label}`,\r\n                              ts: Date.now(),\r\n                              admin: false,\r\n                            };\r\n                            setMessages((prev) => [...prev, actionMsg]);\r\n                            try {\r\n                              ws?.send({\r\n                                type: \"help-message\",\r\n                                requestId: request.id,\r\n                                message: `User clicked: ${action.id}`,\r\n                              });\r\n                            } catch {}\r\n                          }}\r\n                        >\r\n                          {action.label}\r\n                        </button>\r\n                      ))}\r\n                    </div>\r\n                  </div>\r\n                )}\r\n\r\n                {/* Follow-up prompt */}\r\n                {m.followUp && !adminConnected && (\r\n                  <div className=\"mt-3 space-y-2\">\r\n                    <div className=\"text-xs opacity-80\">{m.followUp}</div>\r\n                    <div className=\"flex gap-2\">\r\n                      <button\r\n                        className=\"flex-1 bg-emerald-600 hover:bg-emerald-700 text-white text-xs py-2 px-3 rounded font-medium transition-colors\"\r\n                        onClick={() => requestAdminConnection(true)}\r\n                      >\r\n                         Yes, connect me\r\n                      </button>\r\n                      <button\r\n                        className=\"flex-1 bg-slate-600 hover:bg-slate-700 text-white text-xs py-2 px-3 rounded font-medium transition-colors\"\r\n                        onClick={() => requestAdminConnection(false)}\r\n                      >\r\n                         No thanks\r\n                      </button>\r\n                    </div>\r\n                  </div>\r\n                )}\r\n              </div>\r\n            </div>\r\n          ))}\r\n\r\n          {/* typing indicators */}\r\n          {Object.keys(typingUsers).length > 0 && (\r\n            <div className=\"text-xs text-slate-300 opacity-80 flex items-center gap-2\">\r\n              <span>{Object.keys(typingUsers).join(\", \")} typing</span>\r\n              <span className=\"flex gap-1\">\r\n                <span className=\"w-1 h-1 bg-slate-300 rounded-full animate-bounce\"></span>\r\n                <span className=\"w-1 h-1 bg-slate-300 rounded-full animate-bounce delay-100\"></span>\r\n                <span className=\"w-1 h-1 bg-slate-300 rounded-full animate-bounce delay-200\"></span>\r\n              </span>\r\n            </div>\r\n          )}\r\n        </div>\r\n\r\n        <div className=\"p-3 border-t border-slate-700 bg-slate-800 flex gap-2\">\r\n          <input\r\n            className=\"input flex-1 text-sm\"\r\n            value={input}\r\n            onChange={(e) => {\r\n              setInput(e.target.value);\r\n              sendTyping();\r\n            }}\r\n            onKeyDown={(e) => {\r\n              if (e.key === \"Enter\" && !e.shiftKey) {\r\n                e.preventDefault();\r\n                sendMsg();\r\n              }\r\n            }}\r\n            placeholder=\"Ask a question (e.g., 'How does calibration work?')...\"\r\n          />\r\n          <button\r\n            aria-label=\"Send message\"\r\n            className=\"btn bg-blue-600 hover:bg-blue-700 text-white\"\r\n            onClick={sendMsg}\r\n          >\r\n            <Send className=\"w-4 h-4\" />\r\n          </button>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n","/**\r\n * Game-Mode-Specific Calibration Requirements\r\n *\r\n * Each game mode has different accuracy requirements:\r\n * - X01: Needs all zones (singles, doubles, trebles, bulls)\r\n * - Cricket: Only needs 6 numbers + bullseye\r\n * - Treble Practice: Only needs treble ring (strictest)\r\n * - Checkout modes: Need double precision\r\n */\r\n\r\nexport type CalibrationRequirement = {\r\n  tolerancePx: number; // Maximum acceptable error in pixels\r\n  requiredTargets: string[]; // Key areas needed for this game\r\n  criticalZones: string[]; // Most important areas to focus on during calibration\r\n  minConfidence: number; // Minimum acceptable calibration confidence (0-100)\r\n};\r\n\r\nexport const GAME_CALIBRATION_REQUIREMENTS: Record<\r\n  string,\r\n  CalibrationRequirement\r\n> = {\r\n  // Free Games\r\n  X01: {\r\n    tolerancePx: 10,\r\n    requiredTargets: [\"SINGLE\", \"DOUBLE\", \"TREBLE\", \"BULL\", \"OUTER_BULL\"],\r\n    criticalZones: [\"D20\", \"D1\", \"BULLSEYE\", \"T20\", \"SINGLE_20\"],\r\n    minConfidence: 80,\r\n  },\r\n  \"Double Practice\": {\r\n    tolerancePx: 12,\r\n    requiredTargets: [\"DOUBLE\", \"BULL\"],\r\n    criticalZones: [\"D20\", \"D1\", \"D6\", \"D17\"],\r\n    minConfidence: 75,\r\n  },\r\n\r\n  // Premium - Accuracy Critical\r\n  \"Treble Practice\": {\r\n    tolerancePx: 8, // Strictest requirement\r\n    requiredTargets: [\"TREBLE\"],\r\n    criticalZones: [\"T20\", \"T1\", \"T5\"],\r\n    minConfidence: 85,\r\n  },\r\n  \"Checkout 170\": {\r\n    tolerancePx: 9,\r\n    requiredTargets: [\"DOUBLE\"],\r\n    criticalZones: [\"D25\", \"D20\", \"D8\"],\r\n    minConfidence: 82,\r\n  },\r\n  \"Checkout 121\": {\r\n    tolerancePx: 9,\r\n    requiredTargets: [\"DOUBLE\"],\r\n    criticalZones: [\"D20\", \"D5\", \"D1\"],\r\n    minConfidence: 82,\r\n  },\r\n\r\n  // Premium - Target Subset\r\n  Cricket: {\r\n    tolerancePx: 15,\r\n    requiredTargets: [\"20\", \"19\", \"18\", \"17\", \"16\", \"15\", \"BULL\"],\r\n    criticalZones: [\"20\", \"15\", \"BULL\"],\r\n    minConfidence: 70,\r\n  },\r\n  \"American Cricket\": {\r\n    tolerancePx: 15,\r\n    requiredTargets: [\"20\", \"19\", \"18\", \"17\", \"16\", \"15\", \"BULL\"],\r\n    criticalZones: [\"20\", \"15\", \"BULL\"],\r\n    minConfidence: 70,\r\n  },\r\n\r\n  // Premium - All Numbers\r\n  \"Around the Clock\": {\r\n    tolerancePx: 12,\r\n    requiredTargets: [\r\n      \"1\",\r\n      \"2\",\r\n      \"3\",\r\n      \"4\",\r\n      \"5\",\r\n      \"6\",\r\n      \"7\",\r\n      \"8\",\r\n      \"9\",\r\n      \"10\",\r\n      \"11\",\r\n      \"12\",\r\n      \"13\",\r\n      \"14\",\r\n      \"15\",\r\n      \"16\",\r\n      \"17\",\r\n      \"18\",\r\n      \"19\",\r\n      \"20\",\r\n    ],\r\n    criticalZones: [\"1\", \"20\", \"6\", \"15\"],\r\n    minConfidence: 78,\r\n  },\r\n  Shanghai: {\r\n    tolerancePx: 13,\r\n    requiredTargets: [\r\n      \"1\",\r\n      \"2\",\r\n      \"3\",\r\n      \"4\",\r\n      \"5\",\r\n      \"6\",\r\n      \"7\",\r\n      \"SINGLE\",\r\n      \"DOUBLE\",\r\n      \"TREBLE\",\r\n    ],\r\n    criticalZones: [\"1\", \"7\", \"S1\", \"D1\", \"T1\"],\r\n    minConfidence: 75,\r\n  },\r\n\r\n  // Premium - Practice/Training\r\n  \"High Score\": {\r\n    tolerancePx: 14,\r\n    requiredTargets: [\"TREBLE\", \"DOUBLE\", \"BULL\"],\r\n    criticalZones: [\"T20\", \"BULL\", \"D20\"],\r\n    minConfidence: 72,\r\n  },\r\n  \"Low Score\": {\r\n    tolerancePx: 11,\r\n    requiredTargets: [\"SINGLE\"],\r\n    criticalZones: [\"1\", \"2\", \"3\"],\r\n    minConfidence: 76,\r\n  },\r\n  \"Count-Up\": {\r\n    tolerancePx: 13,\r\n    requiredTargets: [\"SINGLE\", \"DOUBLE\", \"TREBLE\"],\r\n    criticalZones: [\"20\", \"DOUBLE\", \"TREBLE\"],\r\n    minConfidence: 74,\r\n  },\r\n\r\n  // Premium - Head-to-Head\r\n  \"Halve It\": {\r\n    tolerancePx: 12,\r\n    requiredTargets: [\"TREBLE\", \"SINGLE\"],\r\n    criticalZones: [\"T20\", \"T5\", \"SINGLE\"],\r\n    minConfidence: 73,\r\n  },\r\n  \"High-Low\": {\r\n    tolerancePx: 13,\r\n    requiredTargets: [\"SINGLE\", \"DOUBLE\", \"BULL\"],\r\n    criticalZones: [\"HIGH (>10)\", \"LOW (<5)\", \"BULL\"],\r\n    minConfidence: 72,\r\n  },\r\n  Killer: {\r\n    tolerancePx: 12,\r\n    requiredTargets: [\"ALL_NUMBERS\"],\r\n    criticalZones: [\"RANDOM_TARGETS\"],\r\n    minConfidence: 74,\r\n  },\r\n\r\n  // Premium - Skill Games\r\n  Baseball: {\r\n    tolerancePx: 14,\r\n    requiredTargets: [\"1-9\", \"SINGLE\", \"DOUBLE\", \"TREBLE\"],\r\n    criticalZones: [\"1\", \"9\", \"TRIPLE\"],\r\n    minConfidence: 71,\r\n  },\r\n  Golf: {\r\n    tolerancePx: 14,\r\n    requiredTargets: [\"1-18\", \"TREBLE\"],\r\n    criticalZones: [\"T1\", \"T18\"],\r\n    minConfidence: 71,\r\n  },\r\n  \"Tic Tac Toe\": {\r\n    tolerancePx: 16,\r\n    requiredTargets: [\"1-9\", \"SINGLE\"],\r\n    criticalZones: [\"CENTER\", \"CORNERS\"],\r\n    minConfidence: 68,\r\n  },\r\n\r\n  // Premium - Variation Games\r\n  \"Bob's 27\": {\r\n    tolerancePx: 13,\r\n    requiredTargets: [\"SINGLE\", \"DOUBLE\"],\r\n    criticalZones: [\"1-20\", \"BULL\"],\r\n    minConfidence: 73,\r\n  },\r\n  Scam: {\r\n    tolerancePx: 14,\r\n    requiredTargets: [\"ALL_NUMBERS\", \"OUTER_BULL\"],\r\n    criticalZones: [\"TARGET_NUMBER\", \"OUTER_BULL\"],\r\n    minConfidence: 70,\r\n  },\r\n  Fives: {\r\n    tolerancePx: 14,\r\n    requiredTargets: [\"ALL_NUMBERS\", \"OUTER_BULL\"],\r\n    criticalZones: [\"5\", \"10\", \"15\", \"20\"],\r\n    minConfidence: 70,\r\n  },\r\n  Sevens: {\r\n    tolerancePx: 14,\r\n    requiredTargets: [\"ALL_NUMBERS\", \"OUTER_BULL\"],\r\n    criticalZones: [\"7\", \"14\"],\r\n    minConfidence: 70,\r\n  },\r\n};\r\n\r\n/**\r\n * Evaluate calibration quality for a specific game mode\r\n * Returns confidence level 0-100\r\n */\r\nexport function getCalibrationConfidenceForGame(\r\n  gameMode: string,\r\n  errorPx: number | null,\r\n): number {\r\n  if (!errorPx || errorPx < 0) return 0;\r\n\r\n  const req = GAME_CALIBRATION_REQUIREMENTS[gameMode];\r\n  if (!req) return 50; // Unknown game, neutral confidence\r\n\r\n  // Confidence drops as error increases beyond tolerance\r\n  if (errorPx <= req.tolerancePx) {\r\n    // Excellent calibration\r\n    return Math.min(100, 100 - (errorPx / req.tolerancePx) * 20);\r\n  } else {\r\n    // Poor calibration - drops steeply\r\n    const excess = errorPx - req.tolerancePx;\r\n    return Math.max(0, 50 - excess * 2);\r\n  }\r\n}\r\n\r\n/**\r\n * Check if calibration is suitable for a game\r\n */\r\nexport function isCalibrationSuitableForGame(\r\n  gameMode: string,\r\n  errorPx: number | null,\r\n): boolean {\r\n  if (!errorPx) return false;\r\n\r\n  const req = GAME_CALIBRATION_REQUIREMENTS[gameMode];\r\n  if (!req) return true; // Unknown game, assume suitable\r\n\r\n  const confidence = getCalibrationConfidenceForGame(gameMode, errorPx);\r\n  return confidence >= req.minConfidence;\r\n}\r\n\r\n/**\r\n * Get a human-readable assessment of calibration quality\r\n */\r\nexport function getCalibrationQualityText(\r\n  gameMode: string,\r\n  errorPx: number | null,\r\n): { quality: \"excellent\" | \"good\" | \"fair\" | \"poor\" | \"none\"; text: string } {\r\n  if (!errorPx) {\r\n    return { quality: \"none\", text: \"Not calibrated\" };\r\n  }\r\n\r\n  const confidence = getCalibrationConfidenceForGame(gameMode, errorPx);\r\n\r\n  if (confidence >= 90) {\r\n    return {\r\n      quality: \"excellent\",\r\n      text: `Excellent (${Math.round(confidence)}%)`,\r\n    };\r\n  } else if (confidence >= 75) {\r\n    return { quality: \"good\", text: `Good (${Math.round(confidence)}%)` };\r\n  } else if (confidence >= 50) {\r\n    return { quality: \"fair\", text: `Fair (${Math.round(confidence)}%)` };\r\n  } else {\r\n    return { quality: \"poor\", text: `Poor (${Math.round(confidence)}%)` };\r\n  }\r\n}\r\n\r\n/**\r\n * Get personalized recalibration recommendation for a game\r\n */\r\nexport function getRecalibrationRecommendation(\r\n  gameMode: string,\r\n): string | null {\r\n  const req = GAME_CALIBRATION_REQUIREMENTS[gameMode];\r\n  if (!req || req.criticalZones.length === 0) return null;\r\n\r\n  const zones = req.criticalZones.join(\", \");\r\n  return `Recalibrate focusing on: ${zones}`;\r\n}\r\n\r\n/**\r\n * Get all games sorted by calibration difficulty (strictest first)\r\n */\r\nexport function getGamesByCalibrationDifficulty(): string[] {\r\n  return Object.entries(GAME_CALIBRATION_REQUIREMENTS)\r\n    .sort((a, b) => a[1].tolerancePx - b[1].tolerancePx)\r\n    .map(([name]) => name);\r\n}\r\n","import { useEffect, useMemo, useState } from \"react\";\r\nimport BarChart from \"./BarChart\";\r\nimport TabPills from \"./ui/TabPills\";\r\nimport { getGameModeStats } from \"../store/profileStats\";\r\nimport {\r\n  allGames,\r\n  labelForMode,\r\n  getModeOptionsForGame,\r\n  getModeValueOptionsForGame,\r\n} from \"../utils/games\";\r\nimport { useWS } from \"./WSProvider\";\r\nimport StatusDot from \"./ui/StatusDot\";\r\nimport CameraStatusBadge from \"./CameraStatusBadge\";\r\nimport HelpdeskChat from \"./HelpdeskChat\";\r\nimport { useCalibration } from \"../store/calibration\";\r\nimport { useToast } from \"../store/toast\";\r\nimport {\r\n  getCalibrationConfidenceForGame,\r\n  getCalibrationQualityText,\r\n} from \"../utils/gameCalibrationRequirements\";\r\n\r\nconst OWNER_EMAIL = \"daviesfamily108@gmail.com\";\r\n\r\nexport default function AdminDashboard({ user }: { user: any }) {\r\n  const ws = (() => {\r\n    try {\r\n      return useWS();\r\n    } catch {\r\n      return null;\r\n    }\r\n  })();\r\n  const [admins, setAdmins] = useState<string[]>([]);\r\n  const [walletCreditEmail, setWalletCreditEmail] = useState('');\r\n  const [walletCreditAmount, setWalletCreditAmount] = useState('');\r\n  const [walletCreditCurrency, setWalletCreditCurrency] = useState('USD');\r\n  const [email, setEmail] = useState(\"\");\r\n  // status state removed: unused in current UI\r\n  const [announcement, setAnnouncement] = useState(\"\");\r\n  const [loading, setLoading] = useState(false);\r\n  const [tournaments, setTournaments] = useState<any[]>([]);\r\n  const [withdrawals] = useState<any[]>([]);\r\n  const [userSearch, setUserSearch] = useState(\"\");\r\n  const [userResults, setUserResults] = useState<any[]>([]);\r\n  const [createForm, setCreateForm] = useState<any>({\r\n    title: \"Official Tournament\",\r\n    game: \"X01\",\r\n    mode: \"bestof\",\r\n    value: 3,\r\n    description: \"\",\r\n    startAt: new Date(Date.now() + 2 * 60 * 60 * 1000)\r\n      .toISOString()\r\n      .slice(0, 16),\r\n    checkinMinutes: 30,\r\n    capacity: 16,\r\n    prizeType: \"premium\",\r\n    prizeAmount: 3,\r\n    currency: \"GBP\",\r\n    prizeNotes: \"\",\r\n  });\r\n  const [emailCopy, setEmailCopy] = useState<any>({\r\n    reset: {},\r\n    reminder: {},\r\n    confirmEmail: {},\r\n    changed: {},\r\n  });\r\n  const [preview, setPreview] = useState<{\r\n    open: boolean;\r\n    kind?: string;\r\n    html?: string;\r\n  }>({ open: false });\r\n  const [activeTab, setActiveTab] = useState<\r\n    \"general\" | \"maintenance\" | \"premium\" | \"helpdesk\" | \"tourneys\"\r\n  >(\"general\");\r\n  const isOwner = user?.email?.toLowerCase() === OWNER_EMAIL;\r\n  const [winners] = useState<any[]>([]);\r\n  const [reports] = useState<any[]>([]);\r\n  const [helpRequests, setHelpRequests] = useState<any[]>([]);\r\n  const [helpTyping, setHelpTyping] = useState<\r\n    Record<string, { who: string; ts: number }>\r\n  >({});\r\n  const [selectedRequest, setSelectedRequest] = useState<any | null>(null);\r\n  const [, setLogs] = useState<any[]>([]);\r\n  const [systemHealth, setSystemHealth] = useState<any>(null);\r\n  const [clusteringEnabled, setClusteringEnabled] = useState(false);\r\n  const [clusterCapacity, setClusterCapacity] = useState(1500);\r\n  const [, setShowCreate] = useState(false);\r\n\r\n  const broadcastTournaments = async () => {\r\n    setLoading(true);\r\n    try {\r\n      const headers = {\r\n        \"Content-Type\": \"application/json\",\r\n        Authorization: `Bearer ${localStorage.getItem(\"authToken\")}`,\r\n      };\r\n      const res = await fetch(\"/api/admin/tournaments/broadcast\", {\r\n        method: \"POST\",\r\n        headers,\r\n      });\r\n      if (res.ok) {\r\n        toast(\"Tournaments broadcast triggered\", { type: \"success\" });\r\n      } else {\r\n        toast(\"Broadcast failed\", { type: \"error\" });\r\n      }\r\n    } catch (err) {\r\n      toast(\"Broadcast request failed\", { type: \"error\" });\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  // --- Game usage (played/won per mode) ---\r\n  const [gmVersion, setGmVersion] = useState(0);\r\n  useEffect(() => {\r\n    const on = () => setGmVersion((v) => v + 1);\r\n    window.addEventListener(\"ndn:stats-updated\", on as any);\r\n    return () => window.removeEventListener(\"ndn:stats-updated\", on as any);\r\n  }, []);\r\n  const gmStats = useMemo(\r\n    () => getGameModeStats(allGames as unknown as string[]),\r\n    [gmVersion],\r\n  );\r\n\r\n  // Calibration data and preview effect\r\n  const cal = useCalibration();\r\n  const toast = useToast();\r\n\r\n  useEffect(() => {\r\n    if (!preview.open) return;\r\n    function onKey(e: KeyboardEvent) {\r\n      if (e.key === \"Escape\") setPreview({ open: false });\r\n    }\r\n    document.addEventListener(\"keydown\", onKey);\r\n    return () => document.removeEventListener(\"keydown\", onKey);\r\n  }, [preview.open]);\r\n\r\n  // Calibration quality display\r\n  const calibQuality = useMemo(() => {\r\n    const errorPx = cal.errorPx ?? null;\r\n    const items: any[] = [];\r\n    for (const game of allGames) {\r\n      const confidence = getCalibrationConfidenceForGame(game, errorPx);\r\n      const qualityInfo = getCalibrationQualityText(game, errorPx);\r\n      items.push({ game, confidence, qualityInfo });\r\n    }\r\n    return items;\r\n  }, [cal.errorPx]);\r\n\r\n  // Lightweight derived bars for the Game Usage chart\r\n  const gmBars: any[] = useMemo(() => {\r\n    const bars: any[] = [];\r\n    if (gmStats && typeof gmStats === \"object\") {\r\n      for (const [gameKey, stats] of Object.entries(gmStats as any)) {\r\n        const s = stats as any;\r\n        bars.push({\r\n          label: gameKey,\r\n          value: s?.played || 0,\r\n          won: s?.won || 0,\r\n        });\r\n      }\r\n    }\r\n    return bars;\r\n  }, [gmStats]);\r\n\r\n  // Refresh common admin data (help requests, admins, tournaments)\r\n  async function refresh() {\r\n    try {\r\n      const headers = {\r\n        Authorization: `Bearer ${localStorage.getItem(\"authToken\")}`,\r\n      };\r\n      const [hrRes, adminsRes, tRes] = await Promise.all([\r\n        fetch(\"/api/admin/help-requests\", { headers }),\r\n        fetch(\"/api/admins\", { headers }),\r\n        fetch(\"/api/tournaments\", { headers }),\r\n      ]);\r\n      if (hrRes.ok) {\r\n        const d = await hrRes.json();\r\n        setHelpRequests(Array.isArray(d) ? d : d.requests || []);\r\n      }\r\n      if (adminsRes.ok) {\r\n        const d = await adminsRes.json();\r\n        setAdmins(Array.isArray(d) ? d : d.admins || []);\r\n      }\r\n      if (tRes.ok) {\r\n        const d = await tRes.json();\r\n        setTournaments(Array.isArray(d) ? d : d.tournaments || d);\r\n      }\r\n    } catch (e) {\r\n      console.error(\"refresh failed\", e);\r\n    }\r\n  }\r\n\r\n  async function revoke(target: string) {\r\n    try {\r\n      await fetch(\"/api/admins/revoke\", {\r\n        method: \"POST\",\r\n        headers: {\r\n          \"Content-Type\": \"application/json\",\r\n          Authorization: `Bearer ${localStorage.getItem(\"authToken\")}`,\r\n        },\r\n        body: JSON.stringify({ email: target }),\r\n      });\r\n      await refresh();\r\n    } catch {}\r\n  }\r\n\r\n  async function grantPremium(email: string, days: number) {\r\n    if (!email) return;\r\n    try {\r\n      await fetch(\"/api/admin/premium/grant\", {\r\n        method: \"POST\",\r\n        headers: {\r\n          \"Content-Type\": \"application/json\",\r\n          Authorization: `Bearer ${localStorage.getItem(\"authToken\")}`,\r\n        },\r\n        body: JSON.stringify({ email, days }),\r\n      });\r\n      await refresh();\r\n    } catch {}\r\n  }\r\n\r\n  async function revokePremium(email: string) {\r\n    try {\r\n      await fetch(\"/api/admin/premium/revoke\", {\r\n        method: \"POST\",\r\n        headers: {\r\n          \"Content-Type\": \"application/json\",\r\n          Authorization: `Bearer ${localStorage.getItem(\"authToken\")}`,\r\n        },\r\n        body: JSON.stringify({ email }),\r\n      });\r\n      await refresh();\r\n    } catch {}\r\n  }\r\n\r\n  async function sendAnnouncement() {\r\n    if (!announcement.trim()) return;\r\n    try {\r\n      await fetch(\"/api/admin/announce\", {\r\n        method: \"POST\",\r\n        headers: {\r\n          \"Content-Type\": \"application/json\",\r\n          Authorization: `Bearer ${localStorage.getItem(\"authToken\")}`,\r\n        },\r\n        body: JSON.stringify({ message: announcement }),\r\n      });\r\n      setAnnouncement(\"\");\r\n      await refresh();\r\n    } catch {}\r\n  }\r\n\r\n  async function toggleMaintenance(next: boolean) {\r\n    try {\r\n      await fetch(\"/api/admin/maintenance\", {\r\n        method: \"POST\",\r\n        headers: {\r\n          \"Content-Type\": \"application/json\",\r\n          Authorization: `Bearer ${localStorage.getItem(\"authToken\")}`,\r\n        },\r\n        body: JSON.stringify({ maintenance: next }),\r\n      });\r\n      await refresh();\r\n    } catch {}\r\n  }\r\n\r\n  // Listen for help-typing and help-request events over WS to show live typing indicators and new requests\r\n  useEffect(() => {\r\n    if (!ws) return;\r\n    const unsub = ws.addListener((data: any) => {\r\n      try {\r\n        if (data?.type === \"help-typing\") {\r\n          const rid = String(data.requestId || \"\");\r\n          if (!rid) return;\r\n          setHelpTyping((prev) => ({\r\n            ...prev,\r\n            [rid]: { who: data.fromName || \"someone\", ts: Date.now() },\r\n          }));\r\n          return;\r\n        }\r\n        if (data?.type === \"help-request\") {\r\n          const req = data.request;\r\n          if (!req || !req.id) return;\r\n          setHelpRequests((prev) => {\r\n            const filtered = (prev || []).filter(\r\n              (r: any) => String(r.id) !== String(req.id),\r\n            );\r\n            return [req, ...filtered];\r\n          });\r\n          return;\r\n        }\r\n        if (data?.type === \"help-request-updated\") {\r\n          refresh();\r\n        }\r\n      } catch {}\r\n    });\r\n    const iv = setInterval(() => {\r\n      const now = Date.now();\r\n      let changed = false;\r\n      const copy = { ...helpTyping };\r\n      for (const k of Object.keys(copy)) {\r\n        if (now - copy[k].ts > 3500) {\r\n          delete copy[k];\r\n          changed = true;\r\n        }\r\n      }\r\n      if (changed) setHelpTyping(copy);\r\n    }, 1500);\r\n    return () => {\r\n      try {\r\n        unsub();\r\n      } catch {}\r\n      clearInterval(iv);\r\n    };\r\n  }, [ws]);\r\n\r\n  async function claimHelp(id: string) {\r\n    try {\r\n      const headers = {\r\n        \"Content-Type\": \"application/json\",\r\n        Authorization: `Bearer ${localStorage.getItem(\"authToken\")}`,\r\n      };\r\n      const res = await fetch(\r\n        `/api/admin/help-requests/${encodeURIComponent(id)}/claim`,\r\n        { method: \"POST\", headers, body: JSON.stringify({}) },\r\n      );\r\n      if (res.ok) {\r\n        await refresh();\r\n      }\r\n    } catch {}\r\n  }\r\n\r\n  async function resolveHelp(id: string) {\r\n    try {\r\n      const headers = {\r\n        \"Content-Type\": \"application/json\",\r\n        Authorization: `Bearer ${localStorage.getItem(\"authToken\")}`,\r\n      };\r\n      const res = await fetch(\r\n        `/api/admin/help-requests/${encodeURIComponent(id)}/resolve`,\r\n        { method: \"POST\", headers, body: JSON.stringify({}) },\r\n      );\r\n      if (res.ok) {\r\n        await refresh();\r\n      }\r\n    } catch {}\r\n  }\r\n\r\n  async function grant() {\r\n    if (!email) return;\r\n    await fetch(\"/api/admins/grant\", {\r\n      method: \"POST\",\r\n      headers: {\r\n        \"Content-Type\": \"application/json\",\r\n        Authorization: `Bearer ${localStorage.getItem(\"authToken\")}`,\r\n      },\r\n      body: JSON.stringify({ email }),\r\n    });\r\n    setEmail(\"\");\r\n  }\r\n\r\n  async function searchUsers() {\r\n    if (!userSearch.trim()) return;\r\n    try {\r\n      const authHeader = {\r\n        Authorization: `Bearer ${localStorage.getItem(\"authToken\")}`,\r\n      };\r\n      const res = await fetch(\r\n        `/api/admin/users/search?q=${encodeURIComponent(userSearch)}`,\r\n        { headers: authHeader },\r\n      );\r\n      if (res.ok) {\r\n        const data = await res.json();\r\n        setUserResults(Array.isArray(data.users) ? data.users : []);\r\n      }\r\n    } catch (error) {\r\n      console.error(\"Search failed:\", error);\r\n    }\r\n  }\r\n\r\n  async function banUser(email: string) {\r\n    try {\r\n      await fetch(\"/api/admin/users/ban\", {\r\n        method: \"POST\",\r\n        headers: {\r\n          \"Content-Type\": \"application/json\",\r\n          Authorization: `Bearer ${localStorage.getItem(\"authToken\")}`,\r\n        },\r\n        body: JSON.stringify({ email }),\r\n      });\r\n      await searchUsers(); // Refresh results\r\n    } catch (error) {\r\n      console.error(\"Ban failed:\", error);\r\n    }\r\n  }\r\n\r\n  async function unbanUser(email: string) {\r\n    try {\r\n      await fetch(\"/api/admin/users/unban\", {\r\n        method: \"POST\",\r\n        headers: {\r\n          \"Content-Type\": \"application/json\",\r\n          Authorization: `Bearer ${localStorage.getItem(\"authToken\")}`,\r\n        },\r\n        body: JSON.stringify({ email }),\r\n      });\r\n      await searchUsers(); // Refresh results\r\n    } catch (error) {\r\n      console.error(\"Unban failed:\", error);\r\n    }\r\n  }\r\n\r\n  // flipPremium removed: not used in current UI\r\n\r\n  async function createOfficialTournament() {\r\n    setLoading(true);\r\n    try {\r\n      const start = new Date(createForm.startAt).getTime();\r\n      const res = await fetch(\"/api/tournaments/create\", {\r\n        method: \"POST\",\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n        body: JSON.stringify({\r\n          title: createForm.title,\r\n          game: createForm.game,\r\n          mode: createForm.mode,\r\n          value: Number(createForm.value),\r\n          description: createForm.description,\r\n          startAt: start,\r\n          checkinMinutes: Number(createForm.checkinMinutes),\r\n          capacity: Number(createForm.capacity),\r\n          requireCalibration: !!createForm.requireCalibration,\r\n          creatorEmail: user?.email,\r\n          creatorName: user?.username,\r\n          requesterEmail: user?.email,\r\n          official: true,\r\n          prizeType: createForm.prizeType,\r\n          prizeAmount: Number(createForm.prizeAmount || 0),\r\n          currency: createForm.currency,\r\n          prizeNotes: createForm.prizeNotes,\r\n        }),\r\n      });\r\n      // refresh admin view and broadcast will update lobby for connected clients\r\n      await refresh();\r\n      try {\r\n        // If creation returned the tournament id, navigate the app to the tournaments tab so lobby is visible\r\n        const data = await res.json();\r\n        if (data && data.tournament && data.tournament.id) {\r\n          window.dispatchEvent(\r\n            new CustomEvent(\"ndn:change-tab\", {\r\n              detail: { tab: \"tournaments\" },\r\n            }),\r\n          );\r\n        }\r\n      } catch {}\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  }\r\n\r\n  async function setWinner(tid: string, winnerEmail: string) {\r\n    setLoading(true);\r\n    try {\r\n      await fetch(\"/api/admin/tournaments/winner\", {\r\n        method: \"POST\",\r\n        headers: {\r\n          \"Content-Type\": \"application/json\",\r\n          Authorization: `Bearer ${localStorage.getItem(\"authToken\")}`,\r\n        },\r\n        body: JSON.stringify({ tournamentId: tid, winnerEmail }),\r\n      });\r\n      await refresh();\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  }\r\n\r\n  async function markPaid(tid: string) {\r\n    setLoading(true);\r\n    try {\r\n      await fetch(\"/api/admin/tournaments/mark-paid\", {\r\n        method: \"POST\",\r\n        headers: {\r\n          \"Content-Type\": \"application/json\",\r\n          Authorization: `Bearer ${localStorage.getItem(\"authToken\")}`,\r\n        },\r\n        body: JSON.stringify({ tournamentId: tid }),\r\n      });\r\n      await refresh();\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  }\r\n\r\n  async function deleteTournament(tid: string) {\r\n    setLoading(true);\r\n    try {\r\n      await fetch(\"/api/admin/tournaments/delete\", {\r\n        method: \"POST\",\r\n        headers: {\r\n          \"Content-Type\": \"application/json\",\r\n          Authorization: `Bearer ${localStorage.getItem(\"authToken\")}`,\r\n        },\r\n        body: JSON.stringify({ tournamentId: tid }),\r\n      });\r\n      await refresh();\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  }\r\n\r\n  async function reseedWeekly() {\r\n    setLoading(true);\r\n    try {\r\n      await fetch(\"/api/admin/tournaments/reseed-weekly\", {\r\n        method: \"POST\",\r\n        headers: {\r\n          \"Content-Type\": \"application/json\",\r\n          Authorization: `Bearer ${localStorage.getItem(\"authToken\")}`,\r\n        },\r\n        body: JSON.stringify({}),\r\n      });\r\n      await refresh();\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  }\r\n\r\n  async function decideWithdrawal(id: string, approve: boolean) {\r\n    setLoading(true);\r\n    try {\r\n      await fetch(\"/api/admin/wallet/withdrawals/decide\", {\r\n        method: \"POST\",\r\n        headers: {\r\n          \"Content-Type\": \"application/json\",\r\n          Authorization: `Bearer ${localStorage.getItem(\"authToken\")}`,\r\n        },\r\n        body: JSON.stringify({ id, approve }),\r\n      });\r\n      await refresh();\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  }\r\n\r\n  async function deleteMatch(id: string) {\r\n    setLoading(true);\r\n    try {\r\n      await fetch(\"/api/admin/matches/delete\", {\r\n        method: \"POST\",\r\n        headers: {\r\n          \"Content-Type\": \"application/json\",\r\n          Authorization: `Bearer ${localStorage.getItem(\"authToken\")}`,\r\n        },\r\n        body: JSON.stringify({ matchId: id }),\r\n      });\r\n      await refresh();\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  }\r\n\r\n  async function fetchLogs() {\r\n    try {\r\n      const authHeader = {\r\n        Authorization: `Bearer ${localStorage.getItem(\"authToken\")}`,\r\n      };\r\n      const res = await fetch(\"/api/admin/logs\", { headers: authHeader });\r\n      if (res.ok) {\r\n        const data = await res.json();\r\n        if (data?.ok) setLogs(data.logs || []);\r\n      }\r\n    } catch (error) {\r\n      console.error(\"Failed to fetch logs:\", error);\r\n    }\r\n  }\r\n\r\n  async function fetchSystemHealth() {\r\n    try {\r\n      const authHeader = {\r\n        Authorization: `Bearer ${localStorage.getItem(\"authToken\")}`,\r\n      };\r\n      const res = await fetch(\"/api/admin/system-health\", {\r\n        headers: authHeader,\r\n      });\r\n      if (res.ok) {\r\n        const data = await res.json();\r\n        if (data?.ok && data?.health) {\r\n          setSystemHealth({\r\n            database: data.health.database || false,\r\n            websocket: data.health.websocket || false,\r\n            https: data.health.https || false,\r\n            maintenance: data.health.maintenance || false,\r\n            clustering: data.health.clustering || false,\r\n            uptime: data.health.uptime || 0,\r\n            memory: data.health.memory || { heapUsed: 0 },\r\n            version: data.health.version || \"unknown\",\r\n          });\r\n          setClusteringEnabled(data.health?.clustering || false);\r\n        }\r\n      }\r\n    } catch (error) {\r\n      console.error(\"Failed to fetch system health:\", error);\r\n    }\r\n  }\r\n\r\n  async function toggleClustering(enable: boolean) {\r\n    setLoading(true);\r\n    try {\r\n      const res = await fetch(\"/api/admin/clustering\", {\r\n        method: \"POST\",\r\n        headers: {\r\n          \"Content-Type\": \"application/json\",\r\n          Authorization: `Bearer ${localStorage.getItem(\"authToken\")}`,\r\n        },\r\n        body: JSON.stringify({\r\n          enabled: enable,\r\n          maxWorkers: 4,\r\n          capacity: clusterCapacity,\r\n        }),\r\n      });\r\n      const data = await res.json();\r\n      console.log(\"Clustering response:\", data);\r\n      if (data?.ok) {\r\n        alert(\r\n          `Clustering ${enable ? \"enabled\" : \"disabled\"} successfully. Max capacity: ${clusterCapacity.toLocaleString()} concurrent users. NODE_WORKERS environment variable is set to max capacity.`,\r\n        );\r\n        await fetchSystemHealth();\r\n      } else {\r\n        alert(`Failed: ${data?.error || data?.message || \"Unknown error\"}`);\r\n      }\r\n    } catch (error) {\r\n      console.error(\"Clustering toggle failed:\", error);\r\n      alert(\r\n        \"Clustering toggle failed: \" +\r\n          (error instanceof Error ? error.message : String(error)),\r\n      );\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  }\r\n\r\n  async function updateClusterCapacity(newCapacity: number) {\r\n    setClusterCapacity(newCapacity);\r\n    // Capacity is updated locally and sent when clustering toggle is used\r\n  }\r\n\r\n  // quick-fix helper removed: not used in current UI\r\n\r\n  async function loadEmailCopy() {\r\n    try {\r\n      const authHeader = {\r\n        Authorization: `Bearer ${localStorage.getItem(\"authToken\")}`,\r\n      };\r\n      const res = await fetch(\"/api/admin/email-copy\", { headers: authHeader });\r\n      if (res.ok) {\r\n        const d = await res.json();\r\n        if (d?.ok) setEmailCopy(d.copy || emailCopy);\r\n      }\r\n    } catch {}\r\n  }\r\n  useEffect(() => {\r\n    if (isOwner) loadEmailCopy();\r\n  }, [isOwner]);\r\n\r\n  useEffect(() => {\r\n    if (isOwner && (activeTab === \"general\" || activeTab === \"maintenance\")) {\r\n      fetchLogs();\r\n      fetchSystemHealth();\r\n    }\r\n  }, [isOwner, activeTab]);\r\n\r\n  async function saveEmailCopy(kind: string, payload: any) {\r\n    await fetch(\"/api/admin/email-copy\", {\r\n      method: \"POST\",\r\n      headers: {\r\n        \"Content-Type\": \"application/json\",\r\n        Authorization: `Bearer ${localStorage.getItem(\"authToken\")}`,\r\n      },\r\n      body: JSON.stringify({ kind, ...payload }),\r\n    });\r\n    await loadEmailCopy();\r\n  }\r\n\r\n  async function openInlinePreview(kind: string, openInNewTab?: boolean) {\r\n    try {\r\n      const authHeader = {\r\n        Authorization: `Bearer ${localStorage.getItem(\"authToken\")}`,\r\n      };\r\n      const res = await fetch(\r\n        `/api/email/preview?kind=${encodeURIComponent(kind)}`,\r\n        { headers: authHeader },\r\n      );\r\n      const html = await res.text();\r\n      if (openInNewTab) {\r\n        const w = window.open();\r\n        if (w) {\r\n          w.document.open();\r\n          w.document.write(html);\r\n          w.document.close();\r\n          return;\r\n        }\r\n      }\r\n      setPreview({ open: true, kind, html });\r\n    } catch {\r\n      setPreview({\r\n        open: true,\r\n        kind,\r\n        html: '<!doctype html><html><body style=\"font-family:sans-serif;padding:16px\">Failed to load preview.</body></html>',\r\n      });\r\n    }\r\n  }\r\n\r\n  useEffect(() => {\r\n    if (!preview.open) return;\r\n    function onKey(e: KeyboardEvent) {\r\n      if (e.key === \"Escape\") setPreview({ open: false });\r\n    }\r\n    document.addEventListener(\"keydown\", onKey);\r\n    return () => document.removeEventListener(\"keydown\", onKey);\r\n  }, [preview.open]);\r\n\r\n  function EmailEditor({ kind, label }: { kind: string; label: string }) {\r\n    const key =\r\n      kind === \"confirm-email\"\r\n        ? \"confirmEmail\"\r\n        : kind === \"changed\"\r\n          ? \"changed\"\r\n          : kind;\r\n    const cfg = emailCopy?.[key] || { title: \"\", intro: \"\", buttonLabel: \"\" };\r\n    const [title, setTitle] = useState(cfg.title || \"\");\r\n    const [intro, setIntro] = useState(cfg.intro || \"\");\r\n    const [btn, setBtn] = useState(cfg.buttonLabel || \"\");\r\n    useEffect(() => {\r\n      setTitle(cfg.title || \"\");\r\n      setIntro(cfg.intro || \"\");\r\n      setBtn(cfg.buttonLabel || \"\");\r\n    }, [cfg.title, cfg.intro, cfg.buttonLabel]);\r\n\r\n    return (\r\n      <div className=\"p-2 rounded bg-black/20 space-y-2\">\r\n        <div className=\"font-semibold\">{label}</div>\r\n        <input\r\n          className=\"input w-full\"\r\n          placeholder=\"Title (optional)\"\r\n          value={title}\r\n          onChange={(e) => setTitle(e.target.value)}\r\n        />\r\n        <textarea\r\n          className=\"input w-full\"\r\n          rows={2}\r\n          placeholder=\"Intro line (optional)\"\r\n          value={intro}\r\n          onChange={(e) => setIntro(e.target.value)}\r\n        />\r\n        <input\r\n          className=\"input w-full\"\r\n          placeholder=\"Button label (optional)\"\r\n          value={btn}\r\n          onChange={(e) => setBtn(e.target.value)}\r\n        />\r\n        <div className=\"flex gap-2 justify-end\">\r\n          <button\r\n            className=\"btn\"\r\n            type=\"button\"\r\n            onClick={() => openInlinePreview(kind, true)}\r\n          >\r\n            Preview\r\n          </button>\r\n          <button\r\n            className=\"btn\"\r\n            type=\"button\"\r\n            onClick={() => openInlinePreview(kind)}\r\n          >\r\n            Popup\r\n          </button>\r\n          <button\r\n            className=\"btn\"\r\n            onClick={() =>\r\n              saveEmailCopy(kind, { title, intro, buttonLabel: btn })\r\n            }\r\n          >\r\n            Save\r\n          </button>\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  if (!isOwner) {\r\n    return (\r\n      <div className=\"card\">\r\n        <h2 className=\"text-2xl font-bold mb-2\">Admin</h2>\r\n        <div className=\"text-sm opacity-80\">\r\n          You dont have permission to manage admins.\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  /* Top help-requests strip for quick admin actions */\r\n  {\r\n    helpRequests.length > 0 && (\r\n      <div className=\"p-2 rounded-xl bg-amber-900/10 border border-amber-500/20 mt-3\">\r\n        <div className=\"flex items-center justify-between\">\r\n          <div className=\"flex items-center gap-3\">\r\n            <span className=\"font-semibold\">Open Help Requests</span>\r\n            <span className=\"text-sm opacity-80\">\r\n              {helpRequests.length} open\r\n            </span>\r\n          </div>\r\n          <div className=\"card mt-4\">\r\n            <h3 className=\"text-xl font-semibold mb-3\">Wallet Operations</h3>\r\n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-2\">\r\n              <div className=\"p-4\">\r\n                <h4 className=\"font-semibold mb-2\">Credit Wallet</h4>\r\n                <div className=\"flex gap-2\">\r\n                  <input className=\"input\" placeholder=\"user@example.com\" value={walletCreditEmail} onChange={(e) => setWalletCreditEmail(e.target.value)} />\r\n                  <input className=\"input\" placeholder=\"Amount (10.00)\" value={walletCreditAmount} onChange={(e) => setWalletCreditAmount(e.target.value)} />\r\n                  <select className=\"input\" value={walletCreditCurrency} onChange={(e) => setWalletCreditCurrency(e.target.value)}><option>USD</option><option>GBP</option><option>EUR</option></select>\r\n                  <button className=\"btn\" onClick={async () => {\r\n                    try {\r\n                      const token = localStorage.getItem('authToken')\r\n                      const headers: any = {'Content-Type': 'application/json'}\r\n                      if (token) headers.Authorization = `Bearer ${token}`\r\n                      const res = await fetch('/api/admin/wallet/credit', { method: 'POST', headers, body: JSON.stringify({ email: walletCreditEmail, currency: walletCreditCurrency, amount: walletCreditAmount }) })\r\n                      if (!res.ok) throw new Error('Failed')\r\n                      setWalletCreditEmail('')\r\n                      setWalletCreditAmount('')\r\n                      alert('Wallet credited')\r\n                    } catch (err) { alert('Failed to credit wallet') }\r\n                  }}>Credit</button>\r\n                </div>\r\n              </div>\r\n            </div>\r\n          </div>\r\n          <div className=\"flex items-center gap-2\">\r\n            <button\r\n              className=\"btn\"\r\n              onClick={() => setSelectedRequest(helpRequests[0])}\r\n            >\r\n              Open Latest\r\n            </button>\r\n            <button className=\"btn btn-ghost\" onClick={() => refresh()}>\r\n              Refresh\r\n            </button>\r\n          </div>\r\n        </div>\r\n        <div className=\"mt-2 flex gap-2 overflow-x-auto\">\r\n          {helpRequests.slice(0, 6).map((hr: any) => (\r\n            <div\r\n              key={hr.id}\r\n              className=\"p-2 rounded bg-black/10 border border-white/10 min-w-[220px]\"\r\n            >\r\n              <div className=\"font-medium\">{hr.username || \"Anonymous\"}</div>\r\n              <div className=\"text-xs opacity-70\">\r\n                {new Date(hr.ts || 0).toLocaleTimeString()}\r\n              </div>\r\n              <div className=\"text-sm truncate mt-1\">{hr.message}</div>\r\n              <div className=\"mt-2 flex gap-2\">\r\n                {hr.status === \"open\" ? (\r\n                  <button className=\"btn\" onClick={() => claimHelp(hr.id)}>\r\n                    Claim\r\n                  </button>\r\n                ) : (\r\n                  <span className=\"text-xs opacity-70\">\r\n                    {hr.status} by {hr.claimedBy || \"\"}\r\n                  </span>\r\n                )}\r\n                <button className=\"btn\" onClick={() => setSelectedRequest(hr)}>\r\n                  Chat\r\n                </button>\r\n              </div>\r\n            </div>\r\n          ))}\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div className=\"space-y-4 ndn-game-shell\">\r\n      {/* Top connection status strip */}\r\n      <div className=\"card p-2 rounded-xl bg-white/10 border border-white/10 flex items-center justify-between gap-2 flex-wrap\">\r\n        <div className=\"flex items-center gap-2 text-sm\">\r\n          <span className=\"font-semibold\">Connection Status</span>\r\n          {ws ? (\r\n            <span className=\"inline-flex items-center gap-2\">\r\n              <StatusDot status={ws.status} title={`WebSocket: ${ws.status}`} />\r\n              <span className=\"text-xs opacity-80\">WS: {ws.status}</span>\r\n            </span>\r\n          ) : (\r\n            <span className=\"text-xs opacity-70\">WS: unavailable</span>\r\n          )}\r\n        </div>\r\n        <div className=\"shrink-0 flex items-center gap-2\">\r\n          {/* Keep the green connected badge; no HTTP/HTTPS pills here */}\r\n          <CameraStatusBadge />\r\n          {ws && (ws as any).reconnect && (\r\n            <button\r\n              onClick={() => (ws as any).reconnect()}\r\n              className=\"ml-1 rounded-md bg-neutral-700/60 hover:bg-neutral-600/70 px-2.5 py-1 text-xs border border-white/10\"\r\n              title=\"Force close and recreate the WebSocket connection\"\r\n            >\r\n              Recreate WS\r\n            </button>\r\n          )}\r\n        </div>\r\n      </div>\r\n      {isOwner && (\r\n        <TabPills\r\n          tabs={[\r\n            { key: \"general\", label: \"General\" },\r\n            { key: \"maintenance\", label: \"Maintenance\" },\r\n            { key: \"premium\", label: \"Premium\" },\r\n            { key: \"tourneys\", label: \"Tourneys\" },\r\n            { key: \"helpdesk\", label: \"Help Desk\" },\r\n          ]}\r\n          active={activeTab}\r\n          onChange={(key) =>\r\n            setActiveTab(\r\n              key as\r\n                | \"general\"\r\n                | \"maintenance\"\r\n                | \"premium\"\r\n                | \"helpdesk\"\r\n                | \"tourneys\",\r\n            )\r\n          }\r\n          className=\"mb-4\"\r\n        />\r\n      )}{\" \"}\r\n      {activeTab === \"general\" && (\r\n        <>\r\n          {isOwner && (\r\n            <div className=\"card\">\r\n              <h3 className=\"text-xl font-semibold mb-2\">Game Usage</h3>\r\n              <div className=\"rounded-xl border border-indigo-500/40 bg-indigo-500/10 p-3\">\r\n                <BarChart\r\n                  data={gmBars.map((d) => ({ label: \"\", value: d.value }))}\r\n                />\r\n                <div className=\"mt-2 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-2 text-[11px] opacity-80\">\r\n                  {gmBars.map((d, i) => (\r\n                    <div\r\n                      key={i}\r\n                      className=\"flex items-center justify-between px-2 py-1 rounded-md bg-white/5 border border-white/10\"\r\n                    >\r\n                      <span className=\"truncate mr-2\">{d.label}</span>\r\n                      <span className=\"whitespace-nowrap\">\r\n                        Played {d.value}  Won {d.won}\r\n                      </span>\r\n                    </div>\r\n                  ))}\r\n                </div>\r\n              </div>\r\n            </div>\r\n          )}\r\n\r\n          {isOwner && (\r\n            <div className=\"card\">\r\n              <h3 className=\"text-xl font-semibold mb-2\">\r\n                Calibration Quality Status\r\n              </h3>\r\n              <div className=\"text-sm opacity-80 mb-3\">\r\n                Camera calibration confidence by game mode. Shows current system\r\n                calibration readiness for each game.\r\n              </div>\r\n              <div className=\"rounded-xl border border-amber-500/40 bg-amber-500/5 p-3\">\r\n                <div className=\"grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-2 text-[11px]\">\r\n                  {calibQuality.map((item) => {\r\n                    const colorClass =\r\n                      item.confidence >= 85\r\n                        ? \"bg-emerald-500/20 border-emerald-500/40 text-emerald-200\"\r\n                        : item.confidence >= 70\r\n                          ? \"bg-amber-500/20 border-amber-500/40 text-amber-200\"\r\n                          : \"bg-rose-500/20 border-rose-500/40 text-rose-200\";\r\n                    return (\r\n                      <div\r\n                        key={item.game}\r\n                        className={`px-2 py-2 rounded-md border ${colorClass}`}\r\n                      >\r\n                        <div className=\"font-semibold text-xs truncate\">\r\n                          {item.game}\r\n                        </div>\r\n                        <div className=\"text-[10px] opacity-80 truncate\">\r\n                          {item.qualityInfo.quality}\r\n                        </div>\r\n                        <div className=\"text-[10px] font-mono mt-0.5\">\r\n                          {Math.round(item.confidence)}%\r\n                        </div>\r\n                      </div>\r\n                    );\r\n                  })}\r\n                </div>\r\n              </div>\r\n            </div>\r\n          )}\r\n\r\n          <div className=\"card\">\r\n            <h2 className=\"text-2xl font-bold mb-2\">Admin Control</h2>\r\n            <div className=\"text-sm opacity-80 mb-3\">\r\n              Grant or revoke Admin to trusted users. Only the owner can perform\r\n              these actions.\r\n            </div>\r\n            <div className=\"flex gap-2 mb-3\">\r\n              <input\r\n                className=\"input flex-1\"\r\n                placeholder=\"user@example.com\"\r\n                value={email}\r\n                onChange={(e) => setEmail(e.target.value)}\r\n              />\r\n              <button className=\"btn\" disabled={loading} onClick={grant}>\r\n                Grant\r\n              </button>\r\n              <button\r\n                className=\"btn bg-rose-600 hover:bg-rose-700\"\r\n                disabled={loading}\r\n                onClick={() => revoke(email)}\r\n              >\r\n                Revoke\r\n              </button>\r\n            </div>\r\n            <div className=\"text-sm opacity-80 mb-2\">Current Admins:</div>\r\n            <div className=\"flex flex-wrap gap-2 mb-4\">\r\n              {admins.map((admin) => (\r\n                <div\r\n                  key={admin}\r\n                  className=\"px-2 py-1 rounded bg-indigo-600/20 border border-indigo-500/40 text-sm\"\r\n                >\r\n                  {admin}\r\n                </div>\r\n              ))}\r\n            </div>\r\n\r\n            <hr className=\"border-indigo-500/20 my-4\" />\r\n\r\n            <h3 className=\"text-lg font-semibold mb-2\">\r\n              Premium Access Control\r\n            </h3>\r\n            <div className=\"text-sm opacity-80 mb-3\">\r\n              Grant or revoke Premium subscription access to users (grants 30\r\n              days).\r\n            </div>\r\n            <div className=\"flex gap-2 mb-3\">\r\n              <input\r\n                className=\"input flex-1\"\r\n                placeholder=\"user@example.com\"\r\n                value={email}\r\n                onChange={(e) => setEmail(e.target.value)}\r\n              />\r\n              <button\r\n                className=\"btn bg-emerald-600 hover:bg-emerald-700\"\r\n                disabled={loading || !email.trim()}\r\n                onClick={() => grantPremium(email, 30)}\r\n              >\r\n                Grant Premium\r\n              </button>\r\n              <button\r\n                className=\"btn bg-rose-600 hover:bg-rose-700\"\r\n                disabled={loading}\r\n                onClick={() => revokePremium(email)}\r\n              >\r\n                Revoke Premium\r\n              </button>\r\n            </div>\r\n            <div className=\"text-sm opacity-80\">\r\n              Premium grants provide 30 days of unlimited access to all\r\n              features.\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"card\">\r\n            <h3 className=\"text-xl font-semibold mb-2\">Announcements</h3>\r\n            <div className=\"text-sm opacity-80 mb-2\">\r\n              Send a message to all users. This will appear as a toast\r\n              notification.\r\n            </div>\r\n            <div className=\"flex gap-2\">\r\n              <input\r\n                className=\"input flex-1\"\r\n                placeholder=\"Announcement message...\"\r\n                value={announcement}\r\n                onChange={(e) => setAnnouncement(e.target.value)}\r\n              />\r\n              <button\r\n                className=\"btn\"\r\n                disabled={loading || !announcement.trim()}\r\n                onClick={sendAnnouncement}\r\n              >\r\n                Send\r\n              </button>\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"card\">\r\n            <h3 className=\"text-xl font-semibold mb-2\">User Search</h3>\r\n            <div className=\"text-sm opacity-80 mb-2\">\r\n              Search for users by email or name.\r\n            </div>\r\n            <div className=\"flex gap-2 mb-3\">\r\n              <input\r\n                className=\"input flex-1\"\r\n                placeholder=\"Search users...\"\r\n                value={userSearch}\r\n                onChange={(e) => setUserSearch(e.target.value)}\r\n              />\r\n              <button className=\"btn\" disabled={loading} onClick={searchUsers}>\r\n                Search\r\n              </button>\r\n            </div>\r\n            {userResults.length > 0 && (\r\n              <div className=\"space-y-2\">\r\n                <div className=\"text-sm opacity-80 mb-2\">Results:</div>\r\n                {userResults.map((u) => (\r\n                  <div\r\n                    key={u.email}\r\n                    className=\"p-2 rounded bg-black/20 text-sm flex items-center justify-between\"\r\n                  >\r\n                    <div>\r\n                      <div className=\"font-semibold\">{u.name || \"No name\"}</div>\r\n                      <div className=\"opacity-70\">{u.email}</div>\r\n                      <div className=\"opacity-60 text-xs\">\r\n                        Joined {new Date(u.createdAt).toLocaleDateString()}\r\n                      </div>\r\n                    </div>\r\n                  </div>\r\n                ))}\r\n              </div>\r\n            )}\r\n          </div>\r\n\r\n          {isOwner && (\r\n            <div className=\"card\">\r\n              <h3 className=\"text-xl font-semibold mb-3\">Email Templates</h3>\r\n              <div className=\"text-sm opacity-80 mb-2\">\r\n                Customize titles, intro lines, and button text. Previews open in\r\n                a new tab or as a popup.\r\n              </div>\r\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-3\">\r\n                <EmailEditor kind=\"reset\" label=\"Password reset\" />\r\n                <EmailEditor kind=\"reminder\" label=\"Password reset reminder\" />\r\n                <EmailEditor kind=\"confirm-email\" label=\"Confirm new email\" />\r\n                <EmailEditor kind=\"changed\" label=\"Password changed notice\" />\r\n              </div>\r\n            </div>\r\n          )}\r\n        </>\r\n      )}\r\n      {activeTab === \"maintenance\" && isOwner && (\r\n        <>\r\n          <div className=\"card\">\r\n            <h3 className=\"text-xl font-semibold mb-2\">User Management</h3>\r\n            <div className=\"text-sm opacity-80 mb-2\">\r\n              Ban or unban users. Use with caution.\r\n            </div>\r\n            <div className=\"flex gap-2 mb-3\">\r\n              <input\r\n                className=\"input flex-1\"\r\n                placeholder=\"user@example.com\"\r\n                value={userSearch}\r\n                onChange={(e) => setUserSearch(e.target.value)}\r\n              />\r\n              <button className=\"btn\" disabled={loading} onClick={searchUsers}>\r\n                Search\r\n              </button>\r\n            </div>\r\n            {userResults.length > 0 && (\r\n              <div className=\"space-y-2\">\r\n                <div className=\"text-sm opacity-80 mb-2\">Results:</div>\r\n                {userResults.map((u) => (\r\n                  <div\r\n                    key={u.email}\r\n                    className=\"p-2 rounded bg-black/20 text-sm flex items-center justify-between\"\r\n                  >\r\n                    <div>\r\n                      <div className=\"font-semibold\">{u.name || \"No name\"}</div>\r\n                      <div className=\"opacity-70\">{u.email}</div>\r\n                      <div className=\"opacity-60 text-xs\">\r\n                        Joined {new Date(u.createdAt).toLocaleDateString()}\r\n                      </div>\r\n                    </div>\r\n                    <div className=\"flex gap-2\">\r\n                      <button\r\n                        className=\"btn bg-red-600 hover:bg-red-700 text-xs\"\r\n                        onClick={() => banUser(u.email)}\r\n                      >\r\n                        Ban\r\n                      </button>\r\n                      <button\r\n                        className=\"btn bg-green-600 hover:bg-green-700 text-xs\"\r\n                        onClick={() => unbanUser(u.email)}\r\n                      >\r\n                        Unban\r\n                      </button>\r\n                    </div>\r\n                  </div>\r\n                ))}\r\n              </div>\r\n            )}\r\n          </div>\r\n\r\n          <div className=\"card\">\r\n            <h3 className=\"text-xl font-semibold mb-3\">Withdrawals</h3>\r\n            <ul className=\"space-y-2\">\r\n              {withdrawals.map((w: any) => (\r\n                <li\r\n                  key={w.id}\r\n                  className=\"p-2 rounded bg-black/20 text-sm flex items-center justify-between\"\r\n                >\r\n                  <div>\r\n                    <div className=\"font-mono text-xs\">{w.id}</div>\r\n                    <div>\r\n                      {w.email}  {w.currency}{\" \"}\r\n                      {(w.amountCents / 100).toFixed(2)}\r\n                    </div>\r\n                    <div className=\"opacity-70\">\r\n                      {w.status}  {new Date(w.requestedAt).toLocaleString()}\r\n                    </div>\r\n                  </div>\r\n                  <div className=\"flex gap-2\">\r\n                    {w.status === \"pending\" && (\r\n                      <>\r\n                        <button\r\n                          className=\"btn bg-emerald-600 hover:bg-emerald-700\"\r\n                          disabled={loading}\r\n                          onClick={() => decideWithdrawal(w.id, true)}\r\n                        >\r\n                          Approve\r\n                        </button>\r\n                        <button\r\n                          className=\"btn bg-rose-600 hover:bg-rose-700\"\r\n                          disabled={loading}\r\n                          onClick={() => decideWithdrawal(w.id, false)}\r\n                        >\r\n                          Reject\r\n                        </button>\r\n                      </>\r\n                    )}\r\n                  </div>\r\n                </li>\r\n              ))}\r\n              {withdrawals.length === 0 && (\r\n                <li className=\"opacity-60\">No withdrawal requests.</li>\r\n              )}\r\n            </ul>\r\n          </div>\r\n\r\n          <div className=\"card\">\r\n            <h3 className=\"text-xl font-semibold mb-3\">System Health</h3>\r\n            <div className=\"text-sm opacity-80 mb-3\">\r\n              Current status of system components and services.\r\n            </div>\r\n            {systemHealth ? (\r\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n                <div className=\"space-y-2\">\r\n                  <div className=\"flex items-center justify-between\">\r\n                    <span>Database</span>\r\n                    <span\r\n                      className={`px-2 py-1 rounded text-xs ${systemHealth.database ? \"bg-emerald-600\" : \"bg-red-600\"}`}\r\n                    >\r\n                      {systemHealth.database ? \"Ready\" : \"Down\"}\r\n                    </span>\r\n                  </div>\r\n                  <div className=\"flex items-center justify-between\">\r\n                    <span>WebSocket</span>\r\n                    <span\r\n                      className={`px-2 py-1 rounded text-xs ${systemHealth.websocket ? \"bg-emerald-600\" : \"bg-red-600\"}`}\r\n                    >\r\n                      {systemHealth.websocket ? \"Ready\" : \"Down\"}\r\n                    </span>\r\n                  </div>\r\n                  <div className=\"flex items-center justify-between\">\r\n                    <span>HTTPS</span>\r\n                    <span\r\n                      className={`px-2 py-1 rounded text-xs ${systemHealth.https ? \"bg-emerald-600\" : \"bg-amber-600\"}`}\r\n                    >\r\n                      {systemHealth.https ? \"Enabled\" : \"HTTP Only\"}\r\n                    </span>\r\n                  </div>\r\n                  <div className=\"flex items-center justify-between\">\r\n                    <span>Maintenance Mode</span>\r\n                    <span\r\n                      className={`px-2 py-1 rounded text-xs ${!systemHealth.maintenance ? \"bg-emerald-600\" : \"bg-red-600\"}`}\r\n                    >\r\n                      {!systemHealth.maintenance ? \"Normal\" : \"Active\"}\r\n                    </span>\r\n                  </div>\r\n                  <div className=\"flex items-center justify-between\">\r\n                    <span>Clustering (Auto-Scaling)</span>\r\n                    <span\r\n                      className={`px-2 py-1 rounded text-xs ${clusteringEnabled ? \"bg-emerald-600\" : \"bg-amber-600\"}`}\r\n                    >\r\n                      {clusteringEnabled ? \"Enabled\" : \"Disabled\"}\r\n                    </span>\r\n                  </div>\r\n                </div>\r\n                <div className=\"space-y-2\">\r\n                  <div className=\"text-sm\">\r\n                    <span className=\"font-semibold\">Uptime:</span>{\" \"}\r\n                    {Math.floor(systemHealth.uptime / 3600)}h{\" \"}\r\n                    {Math.floor((systemHealth.uptime % 3600) / 60)}m\r\n                  </div>\r\n                  <div className=\"text-sm\">\r\n                    <span className=\"font-semibold\">Memory:</span>{\" \"}\r\n                    {systemHealth.memory\r\n                      ? Math.round(systemHealth.memory.heapUsed / 1024 / 1024)\r\n                      : \"?\"}\r\n                    MB used\r\n                  </div>\r\n                  <div className=\"text-sm\">\r\n                    <span className=\"font-semibold\">Version:</span>{\" \"}\r\n                    {systemHealth.version}\r\n                  </div>\r\n                  <div className=\"flex gap-2 flex-wrap\">\r\n                    <button className=\"btn\" onClick={fetchSystemHealth}>\r\n                      Refresh\r\n                    </button>\r\n                    <button\r\n                      className={`btn ${clusteringEnabled ? \"bg-amber-600 hover:bg-amber-700\" : \"bg-emerald-600 hover:bg-emerald-700\"}`}\r\n                      disabled={loading}\r\n                      onClick={() => toggleClustering(!clusteringEnabled)}\r\n                    >\r\n                      {clusteringEnabled ? \"Disable\" : \"Enable\"} Clustering\r\n                    </button>\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            ) : (\r\n              <div className=\"text-center py-4\">\r\n                <div className=\"text-sm opacity-60 mb-2\">\r\n                  Loading system health...\r\n                </div>\r\n                <button className=\"btn\" onClick={fetchSystemHealth}>\r\n                  Load Health Status\r\n                </button>\r\n              </div>\r\n            )}\r\n\r\n            <div className=\"mt-4 pt-4 border-t border-white/10\">\r\n              <h4 className=\"font-semibold mb-3\">Clustering Capacity</h4>\r\n              <div className=\"space-y-3\">\r\n                <div>\r\n                  <div className=\"flex items-center justify-between mb-2\">\r\n                    <label className=\"font-semibold\">\r\n                      Max Concurrent Users\r\n                    </label>\r\n                    <div className=\"flex gap-2\">\r\n                      <button\r\n                        className=\"btn\"\r\n                        onClick={() => setShowCreate(false)}\r\n                      >\r\n                        Close\r\n                      </button>\r\n                      <button\r\n                        className=\"btn\"\r\n                        onClick={broadcastTournaments}\r\n                        disabled={!isOwner || loading}\r\n                      >\r\n                        Force broadcast\r\n                      </button>\r\n                    </div>\r\n                  </div>\r\n                  <input\r\n                    type=\"range\"\r\n                    min=\"1500\"\r\n                    max=\"50000\"\r\n                    step=\"500\"\r\n                    value={clusterCapacity}\r\n                    onChange={(e) =>\r\n                      updateClusterCapacity(Number(e.target.value))\r\n                    }\r\n                    disabled={loading}\r\n                    className=\"w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed\"\r\n                    style={{\r\n                      background: clusteringEnabled\r\n                        ? `linear-gradient(to right, #3b82f6 0%, #3b82f6 ${((clusterCapacity - 1500) / (50000 - 1500)) * 100}%, #374151 ${((clusterCapacity - 1500) / (50000 - 1500)) * 100}%, #374151 100%)`\r\n                        : \"#374151\",\r\n                    }}\r\n                  />\r\n                  <div className=\"flex justify-between text-xs opacity-60 mt-1\">\r\n                    <span>1.5k</span>\r\n                    <span>50k</span>\r\n                  </div>\r\n                </div>\r\n                <div className=\"flex gap-2 flex-wrap\">\r\n                  <button\r\n                    className={`btn ${clusteringEnabled ? \"bg-amber-600 hover:bg-amber-700\" : \"bg-emerald-600 hover:bg-emerald-700\"}`}\r\n                    disabled={loading}\r\n                    onClick={() => toggleClustering(!clusteringEnabled)}\r\n                  >\r\n                    {clusteringEnabled ? \"Disable\" : \"Enable\"} Clustering\r\n                  </button>\r\n                </div>\r\n              </div>\r\n              <div className=\"text-xs opacity-70 mt-2 p-2 bg-white/5 rounded\">\r\n                 Clustering enables auto-scaling with capacity up to{\" \"}\r\n                {clusterCapacity.toLocaleString()} concurrent users. Adjust the\r\n                slider to set maximum capacity. NODE_WORKERS environment\r\n                variable is set to handle the configured load behind a reverse\r\n                proxy.\r\n              </div>\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"card\">\r\n            <h3 className=\"text-xl font-semibold mb-3\">User Reports</h3>\r\n            <ul className=\"space-y-2\">\r\n              {reports.map((r: any) => (\r\n                <li key={r.id} className=\"p-2 rounded bg-black/20 text-sm\">\r\n                  <div className=\"flex items-center justify-between\">\r\n                    <div>\r\n                      <div className=\"font-mono text-xs\">{r.id}</div>\r\n                      <div>\r\n                        <span className=\"font-semibold\">{r.reporter}</span> {\" \"}\r\n                        <span className=\"font-semibold\">{r.offender}</span> {\" \"}\r\n                        {new Date(r.ts).toLocaleString()}\r\n                      </div>\r\n                      <div className=\"opacity-80\">Reason: {r.reason}</div>\r\n                      {r.messageId && (\r\n                        <div className=\"opacity-60 text-xs\">\r\n                          Message ID: {r.messageId}\r\n                        </div>\r\n                      )}\r\n                    </div>\r\n                    <div className=\"flex gap-2\">\r\n                      <span\r\n                        className={`px-2 py-0.5 rounded text-xs ${r.status === \"open\" ? \"bg-amber-600\" : \"bg-emerald-600\"}`}\r\n                      >\r\n                        {r.status}\r\n                      </span>\r\n                      {r.status === \"open\" && (\r\n                        <>\r\n                          <button\r\n                            className=\"btn bg-emerald-600 hover:bg-emerald-700\"\r\n                            disabled={loading}\r\n                            onClick={async () => {\r\n                              await fetch(\"/api/admin/reports/resolve\", {\r\n                                method: \"POST\",\r\n                                headers: {\r\n                                  \"Content-Type\": \"application/json\",\r\n                                  Authorization: `Bearer ${localStorage.getItem(\"authToken\")}`,\r\n                                },\r\n                                body: JSON.stringify({\r\n                                  id: r.id,\r\n                                  action: \"resolved\",\r\n                                }),\r\n                              });\r\n                              await refresh();\r\n                            }}\r\n                          >\r\n                            Resolve\r\n                          </button>\r\n                          <button\r\n                            className=\"btn bg-rose-600 hover:bg-rose-700\"\r\n                            disabled={loading}\r\n                            onClick={async () => {\r\n                              const notes =\r\n                                prompt(\r\n                                  \"Enter notes for action taken (e.g., warning, block):\",\r\n                                ) || \"\";\r\n                              await fetch(\"/api/admin/reports/resolve\", {\r\n                                method: \"POST\",\r\n                                headers: {\r\n                                  \"Content-Type\": \"application/json\",\r\n                                  Authorization: `Bearer ${localStorage.getItem(\"authToken\")}`,\r\n                                },\r\n                                body: JSON.stringify({\r\n                                  id: r.id,\r\n                                  action: \"actioned\",\r\n                                  notes,\r\n                                }),\r\n                              });\r\n                              await refresh();\r\n                            }}\r\n                          >\r\n                            Action\r\n                          </button>\r\n                        </>\r\n                      )}\r\n                    </div>\r\n                  </div>\r\n                </li>\r\n              ))}\r\n              {reports.length === 0 && (\r\n                <li className=\"opacity-60\">No reports.</li>\r\n              )}\r\n            </ul>\r\n          </div>\r\n\r\n          <div className=\"card\">\r\n            <h3 className=\"text-xl font-semibold mb-3\">Open Matches</h3>\r\n            <ul className=\"space-y-1\">\r\n              {(status?.matches || []).map((m: any) => (\r\n                <li\r\n                  key={m.id}\r\n                  className=\"flex items-center justify-between p-2 rounded bg-black/20 text-sm\"\r\n                >\r\n                  <div className=\"flex items-center gap-3\">\r\n                    <span className=\"font-mono text-xs\">{m.id}</span>\r\n                    <span className=\"opacity-80\">{m.creatorName}</span>\r\n                    <span className=\"opacity-60\">\r\n                      {m.game} {labelForMode(m.mode)} {m.value}{\" \"}\r\n                      {m.game === \"X01\" ? `/${m.startingScore}` : \"\"}\r\n                    </span>\r\n                  </div>\r\n                  <button\r\n                    className=\"btn bg-rose-600 hover:bg-rose-700\"\r\n                    disabled={loading}\r\n                    onClick={() => deleteMatch(m.id)}\r\n                  >\r\n                    Remove\r\n                  </button>\r\n                </li>\r\n              ))}\r\n              {(!status?.matches || status.matches.length === 0) && (\r\n                <li className=\"text-sm opacity-60\">No open matches.</li>\r\n              )}\r\n            </ul>\r\n          </div>\r\n\r\n          <div className=\"card\">\r\n            <h3 className=\"text-xl font-semibold mb-3\">Dangerous Operations</h3>\r\n            <div className=\"text-sm opacity-80 mb-3 text-red-400\">\r\n               These operations can cause data loss or service disruption. Use\r\n              with extreme caution.\r\n            </div>\r\n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n              <div>\r\n                <div className=\"font-semibold mb-2 text-red-400\">\r\n                  Tournament Deletion\r\n                </div>\r\n                <ul className=\"space-y-2\">\r\n                  {tournaments.map((t: any) => (\r\n                    <li\r\n                      key={t.id}\r\n                      className=\"p-2 rounded bg-red-900/20 border border-red-500/40 text-sm\"\r\n                    >\r\n                      <div className=\"flex items-center justify-between\">\r\n                        <div className=\"font-semibold\">{t.title}</div>\r\n                        <div className=\"opacity-70\">{t.status}</div>\r\n                      </div>\r\n                      <div className=\"opacity-80\">\r\n                        {t.game}  {labelForMode(t.mode)} {t.value}\r\n                      </div>\r\n                      <div className=\"mt-2\">\r\n                        <button\r\n                          className=\"btn bg-red-600 hover:bg-red-700 text-xs\"\r\n                          disabled={loading}\r\n                          onClick={() => deleteTournament(t.id)}\r\n                        >\r\n                          Delete Tournament\r\n                        </button>\r\n                      </div>\r\n                    </li>\r\n                  ))}\r\n                  {tournaments.length === 0 && (\r\n                    <li className=\"opacity-60\">No tournaments.</li>\r\n                  )}\r\n                </ul>\r\n              </div>\r\n              <div>\r\n                <div className=\"font-semibold mb-2 text-red-400\">\r\n                  System Maintenance\r\n                </div>\r\n                <div className=\"space-y-2\">\r\n                  <div className=\"p-3 rounded bg-red-900/20 border border-red-500/40\">\r\n                    <div className=\"font-semibold text-red-400 mb-2\">\r\n                      Maintenance Mode\r\n                    </div>\r\n                    <div className=\"text-sm opacity-80 mb-3\">\r\n                      Put the entire site into maintenance mode. Users won't be\r\n                      able to access games or create matches.\r\n                    </div>\r\n                    <div className=\"flex items-center gap-2\">\r\n                      <span\r\n                        className={`px-2 py-1 rounded text-xs ${status?.maintenance ? \"bg-red-600\" : \"bg-green-600\"}`}\r\n                      >\r\n                        {status?.maintenance\r\n                          ? \"MAINTENANCE ACTIVE\"\r\n                          : \"NORMAL OPERATION\"}\r\n                      </span>\r\n                      <button\r\n                        className={`btn ${status?.maintenance ? \"bg-green-600 hover:bg-green-700\" : \"bg-red-600 hover:bg-red-700\"}`}\r\n                        disabled={loading}\r\n                        onClick={() => toggleMaintenance(!status?.maintenance)}\r\n                      >\r\n                        {status?.maintenance ? \"Disable\" : \"Enable\"}\r\n                      </button>\r\n                    </div>\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            </div>\r\n          </div>\r\n          {selectedRequest && (\r\n            <HelpdeskChat\r\n              request={selectedRequest}\r\n              user={{\r\n                email: user?.email,\r\n                username: user?.username,\r\n                isAdmin: true,\r\n              }}\r\n              onClose={() => setSelectedRequest(null)}\r\n            />\r\n          )}\r\n        </>\r\n      )}\r\n      {activeTab === \"premium\" && isOwner && (\r\n        <>\r\n          <div className=\"card\">\r\n            <h3 className=\"text-xl font-semibold mb-2\">\r\n              Premium Subscription Grants\r\n            </h3>\r\n            <div className=\"text-sm opacity-80 mb-3\">\r\n              Grant or revoke premium subscriptions for users (grants 30 days).\r\n            </div>\r\n            <div className=\"flex gap-2 mb-3\">\r\n              <input\r\n                className=\"input flex-1\"\r\n                placeholder=\"user@example.com\"\r\n                value={email}\r\n                onChange={(e) => setEmail(e.target.value)}\r\n              />\r\n              <button\r\n                className=\"btn\"\r\n                disabled={loading || !email.trim()}\r\n                onClick={() => grantPremium(email, 30)}\r\n              >\r\n                Grant\r\n              </button>\r\n              <button\r\n                className=\"btn bg-rose-600 hover:bg-rose-700\"\r\n                disabled={loading}\r\n                onClick={() => revokePremium(email)}\r\n              >\r\n                Revoke\r\n              </button>\r\n            </div>\r\n            <div className=\"text-sm opacity-80 mb-2\">\r\n              Premium users get 30 days of access to all features.\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"card\">\r\n            <h3 className=\"text-xl font-semibold mb-2\">Premium Winners</h3>\r\n            <div className=\"text-sm opacity-80 mb-2\">\r\n              Users who have won premium through tournaments.\r\n            </div>\r\n            <div className=\"space-y-2\">\r\n              {winners.map((w: any) => (\r\n                <div\r\n                  key={w.email}\r\n                  className=\"p-2 rounded bg-black/20 text-sm flex items-center justify-between\"\r\n                >\r\n                  <div>\r\n                    <div className=\"font-semibold\">{w.name || \"No name\"}</div>\r\n                    <div className=\"opacity-70\">{w.email}</div>\r\n                    <div className=\"opacity-60 text-xs\">\r\n                      Expires {new Date(w.expiresAt).toLocaleDateString()}\r\n                    </div>\r\n                  </div>\r\n                  <div className=\"flex gap-2\">\r\n                    {!w.expired ? (\r\n                      <span className=\"px-2 py-1 rounded bg-emerald-600 text-xs\">\r\n                        Premium Active\r\n                      </span>\r\n                    ) : (\r\n                      <span className=\"px-2 py-1 rounded bg-amber-600 text-xs\">\r\n                        Premium Expired\r\n                      </span>\r\n                    )}\r\n                  </div>\r\n                </div>\r\n              ))}\r\n              {winners.length === 0 && (\r\n                <div className=\"opacity-60\">No premium winners.</div>\r\n              )}\r\n            </div>\r\n          </div>\r\n        </>\r\n      )}\r\n      {activeTab === \"tourneys\" && isOwner && (\r\n        <>\r\n          <div className=\"card\">\r\n            <h3 className=\"text-xl font-semibold mb-3\">\r\n              Create Official Tournament\r\n            </h3>\r\n            <div className=\"text-sm opacity-80 mb-3\">\r\n              Set up a new official tournament with custom rules, timing, and\r\n              prizes.\r\n            </div>\r\n            <div className=\"space-y-2\">\r\n              <input\r\n                className=\"input w-full\"\r\n                placeholder=\"Tournament Title\"\r\n                value={createForm.title}\r\n                onChange={(e) =>\r\n                  setCreateForm((f: any) => ({ ...f, title: e.target.value }))\r\n                }\r\n              />\r\n              <div className=\"grid grid-cols-3 gap-2\">\r\n                <select\r\n                  className=\"input\"\r\n                  value={createForm.game}\r\n                  onChange={(e) =>\r\n                    setCreateForm((f: any) => ({ ...f, game: e.target.value }))\r\n                  }\r\n                >\r\n                  {[\r\n                    \"X01\",\r\n                    \"Around the Clock\",\r\n                    \"Cricket\",\r\n                    \"Halve It\",\r\n                    \"Shanghai\",\r\n                    \"High-Low\",\r\n                  ].map((g) => (\r\n                    <option key={g} value={g}>\r\n                      {g}\r\n                    </option>\r\n                  ))}\r\n                </select>\r\n                <select\r\n                  className=\"input\"\r\n                  value={createForm.mode}\r\n                  onChange={(e) =>\r\n                    setCreateForm((f: any) => ({ ...f, mode: e.target.value }))\r\n                  }\r\n                >\r\n                  {getModeOptionsForGame(createForm.game).map((opt) => (\r\n                    <option key={String(opt)} value={String(opt)}>\r\n                      {labelForMode(String(opt))}\r\n                    </option>\r\n                  ))}\r\n                </select>\r\n                {(() => {\r\n                  const vals = getModeValueOptionsForGame(\r\n                    createForm.game,\r\n                    createForm.mode,\r\n                  );\r\n                  if (vals && vals.length > 0) {\r\n                    return (\r\n                      <select\r\n                        className=\"input\"\r\n                        value={String(createForm.value)}\r\n                        onChange={(e) =>\r\n                          setCreateForm((f: any) => ({\r\n                            ...f,\r\n                            value: Number(e.target.value),\r\n                          }))\r\n                        }\r\n                      >\r\n                        {vals.map((v) => (\r\n                          <option key={v} value={String(v)}>\r\n                            {v}\r\n                          </option>\r\n                        ))}\r\n                      </select>\r\n                    );\r\n                  }\r\n                  return (\r\n                    <input\r\n                      className=\"input\"\r\n                      type=\"number\"\r\n                      min={1}\r\n                      value={createForm.value}\r\n                      onChange={(e) =>\r\n                        setCreateForm((f: any) => ({\r\n                          ...f,\r\n                          value: Number(e.target.value),\r\n                        }))\r\n                      }\r\n                    />\r\n                  );\r\n                })()}\r\n              </div>\r\n              <textarea\r\n                className=\"input w-full\"\r\n                rows={2}\r\n                placeholder=\"Description\"\r\n                value={createForm.description}\r\n                onChange={(e) =>\r\n                  setCreateForm((f: any) => ({\r\n                    ...f,\r\n                    description: e.target.value,\r\n                  }))\r\n                }\r\n              />\r\n              <div className=\"grid grid-cols-2 gap-2\">\r\n                <input\r\n                  className=\"input\"\r\n                  type=\"datetime-local\"\r\n                  value={createForm.startAt}\r\n                  onChange={(e) =>\r\n                    setCreateForm((f: any) => ({\r\n                      ...f,\r\n                      startAt: e.target.value,\r\n                    }))\r\n                  }\r\n                />\r\n                <input\r\n                  className=\"input\"\r\n                  type=\"number\"\r\n                  min={0}\r\n                  placeholder=\"Checkin minutes\"\r\n                  value={createForm.checkinMinutes}\r\n                  onChange={(e) =>\r\n                    setCreateForm((f: any) => ({\r\n                      ...f,\r\n                      checkinMinutes: Number(e.target.value),\r\n                    }))\r\n                  }\r\n                />\r\n              </div>\r\n              <input\r\n                className=\"input w-full\"\r\n                type=\"number\"\r\n                min={6}\r\n                max={64}\r\n                placeholder=\"Capacity\"\r\n                value={createForm.capacity}\r\n                onChange={(e) =>\r\n                  setCreateForm((f: any) => ({\r\n                    ...f,\r\n                    capacity: Number(e.target.value),\r\n                  }))\r\n                }\r\n              />\r\n              <div className=\"grid grid-cols-3 gap-2 items-center\">\r\n                <select\r\n                  className=\"input\"\r\n                  value={createForm.prizeType}\r\n                  onChange={(e) => {\r\n                    const newType = e.target.value;\r\n                    setCreateForm((f: any) => ({\r\n                      ...f,\r\n                      prizeType: newType,\r\n                      prizeAmount: newType === \"premium\" ? 3 : 0,\r\n                    }));\r\n                  }}\r\n                >\r\n                  <option value=\"premium\">PREMIUM</option>\r\n                  <option value=\"cash\">Cash</option>\r\n                </select>\r\n                {createForm.prizeType === \"premium\" ? (\r\n                  <select\r\n                    className=\"input\"\r\n                    value={createForm.prizeAmount}\r\n                    onChange={(e) =>\r\n                      setCreateForm((f: any) => ({\r\n                        ...f,\r\n                        prizeAmount: Number(e.target.value),\r\n                      }))\r\n                    }\r\n                  >\r\n                    <option value={1}>1 month</option>\r\n                    <option value={3}>3 months</option>\r\n                  </select>\r\n                ) : (\r\n                  <input\r\n                    className=\"input\"\r\n                    type=\"number\"\r\n                    min={0}\r\n                    value={createForm.prizeAmount}\r\n                    onChange={(e) =>\r\n                      setCreateForm((f: any) => ({\r\n                        ...f,\r\n                        prizeAmount: Number(e.target.value),\r\n                      }))\r\n                    }\r\n                  />\r\n                )}\r\n                <select\r\n                  className=\"input\"\r\n                  disabled={createForm.prizeType !== \"cash\"}\r\n                  value={createForm.currency}\r\n                  onChange={(e) =>\r\n                    setCreateForm((f: any) => ({\r\n                      ...f,\r\n                      currency: e.target.value,\r\n                    }))\r\n                  }\r\n                >\r\n                  <option value=\"GBP\">GBP</option>\r\n                  <option value=\"USD\">USD</option>\r\n                  <option value=\"EUR\">EUR</option>\r\n                  <option value=\"CAD\">CAD</option>\r\n                  <option value=\"AUD\">AUD</option>\r\n                </select>\r\n              </div>\r\n              <input\r\n                className=\"input w-full\"\r\n                placeholder=\"Prize notes (optional)\"\r\n                value={createForm.prizeNotes}\r\n                onChange={(e) =>\r\n                  setCreateForm((f: any) => ({\r\n                    ...f,\r\n                    prizeNotes: e.target.value,\r\n                  }))\r\n                }\r\n              />\r\n              <div className=\"flex justify-end\">\r\n                <button\r\n                  className=\"btn bg-emerald-600 hover:bg-emerald-700\"\r\n                  disabled={loading}\r\n                  onClick={createOfficialTournament}\r\n                >\r\n                  Create Tournament\r\n                </button>\r\n              </div>\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"card\">\r\n            <h3 className=\"text-xl font-semibold mb-3\">\r\n              Tournament Premium Winners\r\n            </h3>\r\n            <div className=\"text-sm opacity-80 mb-3\">\r\n              Users who have won premium prizes in tournaments. Grant them\r\n              access here.\r\n            </div>\r\n            <div className=\"space-y-2\">\r\n              {tournaments\r\n                .filter(\r\n                  (t: any) =>\r\n                    t.status === \"completed\" &&\r\n                    t.winnerEmail &&\r\n                    t.prizeType === \"premium\",\r\n                )\r\n                .map((t: any) => {\r\n                  const winner = winners.find(\r\n                    (w: any) => w.email === t.winnerEmail,\r\n                  );\r\n                  const hasAccess = winner && !winner.expired;\r\n                  return (\r\n                    <div key={t.id} className=\"p-3 rounded bg-black/20 text-sm\">\r\n                      <div className=\"flex items-center justify-between mb-2\">\r\n                        <div className=\"font-semibold\">{t.title}</div>\r\n                        <div className=\"text-xs opacity-70\">\r\n                          {new Date(t.startAt).toLocaleDateString()}\r\n                        </div>\r\n                      </div>\r\n                      <div className=\"flex items-center justify-between\">\r\n                        <div>\r\n                          <div className=\"font-medium\">{t.winnerEmail}</div>\r\n                          <div className=\"text-xs opacity-70\">\r\n                            Prize: {t.prizeAmount} month\r\n                            {t.prizeAmount > 1 ? \"s\" : \"\"} PREMIUM\r\n                          </div>\r\n                        </div>\r\n                        <div className=\"flex items-center gap-2\">\r\n                          {hasAccess ? (\r\n                            <span className=\"px-2 py-1 rounded bg-emerald-600 text-xs\">\r\n                               Access Granted\r\n                            </span>\r\n                          ) : (\r\n                            <button\r\n                              className=\"btn bg-emerald-600 hover:bg-emerald-700 text-xs\"\r\n                              disabled={loading}\r\n                              onClick={() =>\r\n                                grantPremium(t.winnerEmail, t.prizeAmount * 30)\r\n                              }\r\n                            >\r\n                              Grant Access\r\n                            </button>\r\n                          )}\r\n                        </div>\r\n                      </div>\r\n                    </div>\r\n                  );\r\n                })}\r\n              {tournaments.filter(\r\n                (t: any) =>\r\n                  t.status === \"completed\" &&\r\n                  t.winnerEmail &&\r\n                  t.prizeType === \"premium\",\r\n              ).length === 0 && (\r\n                <div className=\"text-center py-4 text-sm opacity-60\">\r\n                  No completed premium tournaments.\r\n                </div>\r\n              )}\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"card\">\r\n            <h3 className=\"text-xl font-semibold mb-3\">Manage Tournaments</h3>\r\n            <div className=\"text-sm opacity-80 mb-3\">\r\n              View and manage all tournaments. Set winners or mark payouts.\r\n            </div>\r\n            <ul className=\"space-y-2\">\r\n              {tournaments.map((t: any) => (\r\n                <li key={t.id} className=\"p-3 rounded bg-black/20 text-sm\">\r\n                  <div className=\"flex items-center justify-between mb-2\">\r\n                    <div>\r\n                      <div className=\"font-semibold\">{t.title}</div>\r\n                      <div className=\"opacity-80\">\r\n                        {t.game}  {labelForMode(t.mode)} {t.value}\r\n                      </div>\r\n                    </div>\r\n                    <div\r\n                      className={`px-2 py-1 rounded text-xs font-semibold ${\r\n                        t.status === \"scheduled\"\r\n                          ? \"bg-blue-600\"\r\n                          : t.status === \"running\"\r\n                            ? \"bg-green-600\"\r\n                            : t.status === \"completed\"\r\n                              ? \"bg-purple-600\"\r\n                              : \"bg-gray-600\"\r\n                      }`}\r\n                    >\r\n                      {t.status}\r\n                    </div>\r\n                  </div>\r\n                  <div className=\"text-xs opacity-70 mb-2\">\r\n                    Start: {new Date(t.startAt).toLocaleString()}  Capacity:{\" \"}\r\n                    {t.capacity}\r\n                  </div>\r\n                  {t.prize && (\r\n                    <div className=\"text-xs mb-2\">\r\n                      Prize:{\" \"}\r\n                      {t.prizeType === \"cash\" && t.prizeAmount\r\n                        ? `${t.currency || \"USD\"} ${t.prizeAmount}`\r\n                        : `${t.prizeAmount || 3} month${(t.prizeAmount || 3) > 1 ? \"s\" : \"\"} PREMIUM`}\r\n                      {t.prizeType === \"cash\" &&\r\n                        t.status === \"completed\" &&\r\n                        t.payoutStatus && (\r\n                          <span\r\n                            className={`ml-2 px-1.5 py-0.5 rounded ${t.payoutStatus === \"paid\" ? \"bg-emerald-600\" : \"bg-amber-600\"}`}\r\n                          >\r\n                            {t.payoutStatus}\r\n                          </span>\r\n                        )}\r\n                    </div>\r\n                  )}\r\n                  <div className=\"mt-2 flex flex-wrap gap-2\">\r\n                    <button\r\n                      className=\"btn text-xs\"\r\n                      disabled={loading || t.status !== \"scheduled\"}\r\n                      onClick={() =>\r\n                        setWinner(t.id, prompt(\"Winner email?\") || \"\")\r\n                      }\r\n                    >\r\n                      Set Winner\r\n                    </button>\r\n                    {t.prizeType === \"cash\" &&\r\n                      t.status === \"completed\" &&\r\n                      t.payoutStatus !== \"paid\" && (\r\n                        <button\r\n                          className=\"btn text-xs\"\r\n                          disabled={loading}\r\n                          onClick={() => markPaid(t.id)}\r\n                        >\r\n                          Mark Paid\r\n                        </button>\r\n                      )}\r\n                    <button\r\n                      className=\"btn text-xs\"\r\n                      disabled={loading}\r\n                      onClick={() => reseedWeekly()}\r\n                    >\r\n                      Reseed\r\n                    </button>\r\n                  </div>\r\n                </li>\r\n              ))}\r\n              {tournaments.length === 0 && (\r\n                <li className=\"opacity-60\">No tournaments.</li>\r\n              )}\r\n            </ul>\r\n          </div>\r\n        </>\r\n      )}\r\n      {activeTab === \"helpdesk\" && isOwner && (\r\n        <>\r\n          <div className=\"card\">\r\n            <h3 className=\"text-lg font-semibold mb-2\">Helpdesk Requests</h3>\r\n            <div className=\"text-sm opacity-80 mb-3\">\r\n              All help requests from users who asked to speak with an admin.\r\n              Status is shown for each request.\r\n            </div>\r\n            {helpRequests.length === 0 ? (\r\n              <div className=\"text-sm opacity-70\">No help requests.</div>\r\n            ) : (\r\n              <div className=\"space-y-2\">\r\n                {helpRequests.map((hr) => (\r\n                  <div\r\n                    key={hr.id}\r\n                    className=\"p-2 rounded bg-black/10 border border-white/10 flex items-center justify-between\"\r\n                  >\r\n                    <div>\r\n                      <div className=\"font-medium\">\r\n                        {hr.username || \"Anonymous\"}\r\n                      </div>\r\n                      <div className=\"text-xs opacity-70\">\r\n                        {new Date(hr.ts || 0).toLocaleString()}\r\n                      </div>\r\n                      <div className=\"text-sm mt-1\">{hr.message}</div>\r\n                      <div className=\"mt-1\">\r\n                        <span\r\n                          className={`text-xs px-2 py-1 rounded-full mr-2 ${hr.status === \"open\" ? \"bg-emerald-700/30 text-emerald-200\" : hr.status === \"claimed\" ? \"bg-amber-700/30 text-amber-200\" : \"bg-slate-700/30 text-slate-200\"}`}\r\n                        >\r\n                          {hr.status || \"unknown\"}\r\n                        </span>\r\n                        {hr.claimedBy && (\r\n                          <span className=\"text-xs opacity-70\">\r\n                            by {hr.claimedBy}\r\n                          </span>\r\n                        )}\r\n                      </div>\r\n                      {helpTyping[hr.id] && (\r\n                        <div className=\"text-xs text-amber-300 mt-1\">\r\n                          {helpTyping[hr.id].who} typing...\r\n                        </div>\r\n                      )}\r\n                    </div>\r\n                    <div className=\"flex items-center gap-2\">\r\n                      {hr.status === \"open\" && (\r\n                        <button\r\n                          className=\"btn\"\r\n                          onClick={() => claimHelp(hr.id)}\r\n                        >\r\n                          Claim\r\n                        </button>\r\n                      )}\r\n                      {hr.status !== \"resolved\" && (\r\n                        <button\r\n                          className=\"btn btn-ghost\"\r\n                          onClick={() => resolveHelp(hr.id)}\r\n                        >\r\n                          Resolve\r\n                        </button>\r\n                      )}\r\n                      <button\r\n                        className=\"btn\"\r\n                        onClick={() => setSelectedRequest(hr)}\r\n                      >\r\n                        Chat\r\n                      </button>\r\n                    </div>\r\n                  </div>\r\n                ))}\r\n              </div>\r\n            )}\r\n          </div>\r\n        </>\r\n      )}\r\n      {/* Inline email preview overlay */}\r\n      {preview.open && (\r\n        <div\r\n          className=\"fixed inset-0 z-[1000]\"\r\n          onClick={() => setPreview({ open: false })}\r\n        >\r\n          <div className=\"absolute inset-0 bg-black/70 backdrop-blur-sm\" />\r\n          <div className=\"absolute inset-0 p-4 md:p-8 overflow-auto flex items-start md:items-center justify-center\">\r\n            <div\r\n              className=\"w-full max-w-3xl bg-[#0b1020] rounded-2xl border border-indigo-500/40 shadow-2xl\"\r\n              onClick={(e) => e.stopPropagation()}\r\n            >\r\n              <div className=\"flex items-center justify-between px-4 py-3 border-b border-indigo-500/20\">\r\n                <div className=\"font-semibold\">Preview: {preview.kind}</div>\r\n                <button\r\n                  className=\"btn\"\r\n                  onClick={() => setPreview({ open: false })}\r\n                >\r\n                  Close\r\n                </button>\r\n              </div>\r\n              <div className=\"p-0 bg-black/30\">\r\n                <iframe\r\n                  title=\"Email Preview\"\r\n                  style={{\r\n                    width: \"100%\",\r\n                    height: \"70vh\",\r\n                    border: \"0\",\r\n                    background: \"transparent\",\r\n                  }}\r\n                  srcDoc={preview.html || \"\"}\r\n                />\r\n              </div>\r\n              <div className=\"px-4 py-3 border-t border-indigo-500/20 text-xs opacity-70\">\r\n                Click outside this panel or press Esc to close.\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n","import React, { useEffect, useState } from \"react\";\r\nimport {\r\n  User,\r\n  Settings,\r\n  Volume2,\r\n  Camera,\r\n  Gamepad2,\r\n  Eye,\r\n  Mic,\r\n  Save,\r\n  Edit3,\r\n  Shield,\r\n  HelpCircle,\r\n  MessageCircle,\r\n  X,\r\n  Send,\r\n  ChevronDown,\r\n} from \"lucide-react\";\r\nimport { useUserSettings } from \"../store/userSettings\";\r\nimport { apiFetch } from \"../utils/api\";\r\n\r\nexport default function SettingsPanel({ user }: { user?: any }) {\r\n  const {\r\n    favoriteDouble,\r\n    callerEnabled,\r\n    callerVoice,\r\n    callerVolume,\r\n    speakCheckoutOnly,\r\n    avgMode,\r\n    autoStartOffline,\r\n    rememberLastOffline,\r\n    reducedMotion,\r\n    compactHeader,\r\n    allowSpectate,\r\n    cameraScale,\r\n    cameraAspect,\r\n    cameraFitMode,\r\n    autoscoreProvider,\r\n    autoscoreWsUrl,\r\n    autoCommitMode,\r\n    calibrationGuide,\r\n    preferredCameraId,\r\n    preferredCameraLabel,\r\n    cameraEnabled,\r\n    offlineLayout,\r\n    textSize,\r\n    boxSize,\r\n    setFavoriteDouble,\r\n    setCallerEnabled,\r\n    setCallerVoice,\r\n    setCallerVolume,\r\n    setSpeakCheckoutOnly,\r\n    setAvgMode,\r\n    setAutoStartOffline,\r\n    setRememberLastOffline,\r\n    setReducedMotion,\r\n    setCompactHeader,\r\n    setAllowSpectate,\r\n    setCameraScale,\r\n    setCameraAspect,\r\n    setCameraFitMode,\r\n    setAutoscoreProvider,\r\n    setAutoscoreWsUrl,\r\n    setAutoCommitMode,\r\n    setCalibrationGuide,\r\n      preserveCalibrationOverlay,\r\n      setPreserveCalibrationOverlay,\r\n    setPreferredCamera,\r\n    setCameraEnabled,\r\n    setOfflineLayout,\r\n    setTextSize,\r\n    setBoxSize,\r\n    dartTimerEnabled,\r\n    dartTimerSeconds,\r\n    setDartTimerEnabled,\r\n    setDartTimerSeconds,\r\n    x01DoubleIn,\r\n    setX01DoubleIn,\r\n  } = useUserSettings();\r\n\r\n  // Achievements state\r\n  const [achievements, setAchievements] = useState([\r\n    {\r\n      key: \"first180\",\r\n      label: \"First 180\",\r\n      unlocked: false,\r\n      icon: \"\",\r\n      desc: \"Score 180 in a match.\",\r\n    },\r\n    {\r\n      key: \"hundredGames\",\r\n      label: \"100 Games Played\",\r\n      unlocked: false,\r\n      icon: \"\",\r\n      desc: \"Play 100 games.\",\r\n    },\r\n    {\r\n      key: \"tournamentWin\",\r\n      label: \"Tournament Winner\",\r\n      unlocked: false,\r\n      icon: \"\",\r\n      desc: \"Win a tournament.\",\r\n    },\r\n    {\r\n      key: \"bestLeg\",\r\n      label: \"Best Leg\",\r\n      unlocked: false,\r\n      icon: \"\",\r\n      desc: \"Finish a leg in 12 darts or less.\",\r\n    },\r\n    {\r\n      key: \"comeback\",\r\n      label: \"Comeback\",\r\n      unlocked: false,\r\n      icon: \"\",\r\n      desc: \"Win after trailing by 3 legs.\",\r\n    },\r\n  ]);\r\n\r\n  useEffect(() => {\r\n    const uname = user?.username || \"\";\r\n    if (!uname) return;\r\n    setAchievements((prev) =>\r\n      prev.map((a) => ({\r\n        ...a,\r\n        unlocked: !!localStorage.getItem(`ndn:achieve:${a.key}:${uname}`),\r\n      })),\r\n    );\r\n  }, [user?.username]);\r\n\r\n  // Listen for external requests to open the Profile/User pill (from Home or elsewhere)\r\n  useEffect(() => {\r\n    function onOpenProfile(e: any) {\r\n      try {\r\n        setExpandedPill(\"user\");\r\n      } catch {}\r\n    }\r\n    window.addEventListener(\"ndn:open-settings-profile\", onOpenProfile as any);\r\n    return () =>\r\n      window.removeEventListener(\r\n        \"ndn:open-settings-profile\",\r\n        onOpenProfile as any,\r\n      );\r\n  }, []);\r\n\r\n  // Profile bio fields with edit mode\r\n  const [isEditing, setIsEditing] = useState(false);\r\n  const [favPlayer, setFavPlayer] = useState(\"\");\r\n  const [favTeam, setFavTeam] = useState(\"\");\r\n  const [favDarts, setFavDarts] = useState(\"\");\r\n  const [bio, setBio] = useState(\"\");\r\n  const [profilePhoto, setProfilePhoto] = useState(\"\");\r\n  const [allowAnalytics, setAllowAnalytics] = useState(true);\r\n  const [wallet, setWallet] = useState<any | null>(null);\r\n  const [subscription, setSubscription] = useState<any>(null);\r\n\r\n  // Help Assistant state\r\n  const [helpMessages, setHelpMessages] = useState<\r\n    Array<{\r\n      text:\r\n        | string\r\n        | { text: string; links?: Array<{ text: string; tab: string }> };\r\n      isUser: boolean;\r\n    }>\r\n  >([\r\n    {\r\n      text: \"Hi! I'm your Nine Dart Nation assistant. How can I help you today?\",\r\n      isUser: false,\r\n    },\r\n  ]);\r\n  const [helpInput, setHelpInput] = useState(\"\");\r\n\r\n  useEffect(() => {\r\n    const uname = user?.username || \"\";\r\n    if (!uname) return;\r\n    try {\r\n      setFavPlayer(localStorage.getItem(`ndn:bio:favPlayer:${uname}`) || \"\");\r\n      setFavTeam(localStorage.getItem(`ndn:bio:favTeam:${uname}`) || \"\");\r\n      setFavDarts(localStorage.getItem(`ndn:bio:favDarts:${uname}`) || \"\");\r\n      setBio(localStorage.getItem(`ndn:bio:bio:${uname}`) || \"\");\r\n      setProfilePhoto(\r\n        localStorage.getItem(`ndn:bio:profilePhoto:${uname}`) || \"\",\r\n      );\r\n      setAllowAnalytics(\r\n        localStorage.getItem(`ndn:settings:allowAnalytics:${uname}`) !==\r\n          \"false\",\r\n      );\r\n    } catch {}\r\n  }, [user?.username]);\r\n\r\n  useEffect(() => {\r\n    if (!user?.email) return;\r\n    apiFetch(`/api/subscription?email=${encodeURIComponent(user.email)}`)\r\n      .then((r) => r.json())\r\n      .then(setSubscription)\r\n      .catch(() => {});\r\n    // Fetch wallet balance\r\n    (async () => {\r\n      try {\r\n        const token = localStorage.getItem('authToken');\r\n        const headers: any = {};\r\n        if (token) headers.Authorization = `Bearer ${token}`;\r\n        const res = await fetch(`/api/wallet/balance?email=${encodeURIComponent(user.email)}`, { headers })\r\n        if (res.ok) setWallet(await res.json())\r\n      } catch {}\r\n    })()\r\n  }, [user?.email]);\r\n\r\n  const saveBio = () => {\r\n    const uname = user?.username || \"\";\r\n    if (!uname) return;\r\n    try {\r\n      localStorage.setItem(`ndn:bio:favPlayer:${uname}`, favPlayer);\r\n      localStorage.setItem(`ndn:bio:favTeam:${uname}`, favTeam);\r\n      localStorage.setItem(`ndn:bio:favDarts:${uname}`, favDarts);\r\n      localStorage.setItem(`ndn:bio:bio:${uname}`, bio);\r\n      localStorage.setItem(`ndn:bio:profilePhoto:${uname}`, profilePhoto);\r\n      // Dispatch event to notify avatar update\r\n      try {\r\n        window.dispatchEvent(\r\n          new CustomEvent(\"ndn:avatar-updated\", {\r\n            detail: { username: uname, avatar: profilePhoto },\r\n          }),\r\n        );\r\n      } catch {}\r\n      localStorage.setItem(\r\n        `ndn:settings:allowAnalytics:${uname}`,\r\n        allowAnalytics.toString(),\r\n      );\r\n      setIsEditing(false);\r\n    } catch {}\r\n  };\r\n\r\n  // Help Assistant functions\r\n  const faq = {\r\n    \"how to play\":\r\n      \"To play darts, select a game mode from the menu. For online play, join a match. For offline, start a local game.\",\r\n    calibration:\r\n      \"Go to Settings > Camera & Vision > Calibration Guide to set up your camera properly.\",\r\n    premium:\r\n      'Premium unlocks all game modes. Click the \"Upgrade to PREMIUM\" button in online play.',\r\n    username: \"Change your username once for free in Settings > Account.\",\r\n    voice:\r\n      \"Enable voice caller in Settings > Audio & Voice. Test the voice with the Test Voice button.\",\r\n    friends: \"Add friends in the Friends tab to play together.\",\r\n    stats: \"View your statistics in the Stats tab.\",\r\n    settings: \"Customize your experience in the Settings panel.\",\r\n    support:\r\n      \"Contact support via email or check the FAQ in Settings > Support.\",\r\n  };\r\n\r\n  const navigateToTab = (tabKey: string) => {\r\n    try {\r\n      window.dispatchEvent(\r\n        new CustomEvent(\"ndn:change-tab\", { detail: { tab: tabKey } }),\r\n      );\r\n    } catch (error) {\r\n      console.error(\"Navigation failed:\", error);\r\n    }\r\n  };\r\n\r\n  const getResponseWithLinks = (\r\n    userMessage: string,\r\n  ): { text: string; links?: Array<{ text: string; tab: string }> } => {\r\n    const message = userMessage.toLowerCase();\r\n\r\n    if (message.includes(\"username\") || message.includes(\"change name\")) {\r\n      return {\r\n        text: \"You can change your username once for free.\",\r\n        links: [{ text: \"Go to Settings > Account\", tab: \"settings\" }],\r\n      };\r\n    }\r\n    if (\r\n      message.includes(\"premium\") ||\r\n      message.includes(\"upgrade\") ||\r\n      message.includes(\"subscription\")\r\n    ) {\r\n      return {\r\n        text: \"Premium unlocks all game modes and features.\",\r\n        links: [{ text: \"Go to Online Play\", tab: \"online\" }],\r\n      };\r\n    }\r\n    if (\r\n      message.includes(\"calibrat\") ||\r\n      message.includes(\"camera\") ||\r\n      message.includes(\"vision\")\r\n    ) {\r\n      return {\r\n        text: \"Set up your camera properly in Settings.\",\r\n        links: [{ text: \"Go to Settings > Camera & Vision\", tab: \"settings\" }],\r\n      };\r\n    }\r\n    if (\r\n      message.includes(\"voice\") ||\r\n      message.includes(\"caller\") ||\r\n      message.includes(\"audio\")\r\n    ) {\r\n      return {\r\n        text: \"Enable voice calling in Settings.\",\r\n        links: [{ text: \"Go to Settings > Audio & Voice\", tab: \"settings\" }],\r\n      };\r\n    }\r\n    if (message.includes(\"friend\") || message.includes(\"play together\")) {\r\n      return {\r\n        text: \"Add friends to play together.\",\r\n        links: [{ text: \"Go to Friends\", tab: \"friends\" }],\r\n      };\r\n    }\r\n    if (\r\n      message.includes(\"stat\") ||\r\n      message.includes(\"score\") ||\r\n      message.includes(\"performance\")\r\n    ) {\r\n      return {\r\n        text: \"View your statistics and performance.\",\r\n        links: [{ text: \"Go to Stats\", tab: \"stats\" }],\r\n      };\r\n    }\r\n    if (\r\n      message.includes(\"setting\") ||\r\n      message.includes(\"customiz\") ||\r\n      message.includes(\"configur\")\r\n    ) {\r\n      return {\r\n        text: \"Customize your experience.\",\r\n        links: [{ text: \"Go to Settings\", tab: \"settings\" }],\r\n      };\r\n    }\r\n    if (message.includes(\"tournament\") || message.includes(\"competition\")) {\r\n      return {\r\n        text: \"Check out tournaments and competitions.\",\r\n        links: [{ text: \"Go to Tournaments\", tab: \"tournaments\" }],\r\n      };\r\n    }\r\n    if (\r\n      message.includes(\"help\") ||\r\n      message.includes(\"support\") ||\r\n      message.includes(\"faq\")\r\n    ) {\r\n      return {\r\n        text: \"You're already in the help section! Check the Support section above for more resources.\",\r\n        links: [{ text: \"Scroll to Support\", tab: \"settings\" }],\r\n      };\r\n    }\r\n    if (\r\n      message.includes(\"how to play\") ||\r\n      message.includes(\"game\") ||\r\n      message.includes(\"start\")\r\n    ) {\r\n      return {\r\n        text: \"To play darts, select a game mode from the menu. For online play, join a match. For offline, start a local game.\",\r\n        links: [\r\n          { text: \"Play Online\", tab: \"online\" },\r\n          { text: \"Play Offline\", tab: \"offline\" },\r\n        ],\r\n      };\r\n    }\r\n\r\n    return {\r\n      text: \"I'm not sure about that. Try asking about playing, calibration, premium, username changes, voice settings, friends, stats, or settings.\",\r\n    };\r\n  };\r\n\r\n  const handleHelpSend = () => {\r\n    if (!helpInput.trim()) return;\r\n    const userMessage = helpInput.toLowerCase();\r\n    setHelpMessages((prev) => [...prev, { text: helpInput, isUser: true }]);\r\n    setHelpInput(\"\");\r\n\r\n    // Get response with smart link suggestions\r\n    const response = getResponseWithLinks(userMessage);\r\n\r\n    setTimeout(() => {\r\n      setHelpMessages((prev) => [...prev, { text: response, isUser: false }]);\r\n    }, 500);\r\n  };\r\n\r\n  // Username change state\r\n  const [newUsername, setNewUsername] = useState(\"\");\r\n  const [changingUsername, setChangingUsername] = useState(false);\r\n  const [usernameError, setUsernameError] = useState(\"\");\r\n\r\n  // Available voices for caller\r\n  const [availableVoices, setAvailableVoices] = useState<\r\n    SpeechSynthesisVoice[]\r\n  >([]);\r\n\r\n  useEffect(() => {\r\n    const loadVoices = () => {\r\n      const voices = speechSynthesis.getVoices();\r\n      setAvailableVoices(voices.filter((v) => v.lang.startsWith(\"en\")));\r\n    };\r\n    loadVoices();\r\n    speechSynthesis.onvoiceschanged = loadVoices;\r\n  }, []);\r\n\r\n  // Highlights state\r\n  const [showHighlights, setShowHighlights] = useState(false);\r\n\r\n  // Collapsible pill state\r\n  const [expandedPill, setExpandedPill] = useState<\r\n    \"user\" | \"calibration\" | \"settings\" | null\r\n  >(null);\r\n\r\n  const PillButton = ({\r\n    label,\r\n    icon: Icon,\r\n    pill,\r\n    color,\r\n  }: {\r\n    label: string;\r\n    icon: any;\r\n    pill: \"user\" | \"calibration\" | \"settings\";\r\n    color: string;\r\n  }) => (\r\n    <button\r\n      onPointerDown={(e) => { (e as any).stopPropagation(); }}\r\n      onMouseDown={(e) => { e.stopPropagation(); }}\r\n      onTouchStart={(e) => { (e as any).stopPropagation?.(); }}\r\n      onClick={() => setExpandedPill(expandedPill === pill ? null : pill)}\r\n      type=\"button\"\r\n      className={`transition-all select-none whitespace-nowrap rounded-full px-4 py-2 text-sm font-semibold shadow-sm focus:outline-none focus-visible:ring-2 focus-visible:ring-white/60 active:scale-[0.98] bg-gradient-to-r ${color} text-white flex items-center gap-2`}\r\n    >\r\n      <Icon className=\"w-4 h-4\" /> {label}\r\n      <ChevronDown\r\n        className={`w-4 h-4 transition-transform ${expandedPill === pill ? \"rotate-180\" : \"\"}`}\r\n      />\r\n    </button>\r\n  );\r\n\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      {/* ==== USER INFO PILL ==== */}\r\n      <div className=\"relative rounded-xl bg-white/5 backdrop-blur-md border border-white/10 p-1\">\r\n        <div className=\"flex items-center gap-2 overflow-x-auto no-scrollbar py-1 px-1\">\r\n          <PillButton\r\n            label=\"User Info\"\r\n            icon={User}\r\n            pill=\"user\"\r\n            color=\"from-indigo-500 to-fuchsia-500 shadow-indigo-500/30\"\r\n          />\r\n        </div>\r\n      </div>\r\n\r\n      {/* USER INFO CONTENT */}\r\n      {expandedPill === \"user\" && (\r\n        <div className=\"p-6 rounded-2xl border border-white/10 bg-white/[0.02] animate-in fade-in duration-200 space-y-4\">\r\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n            {/* Account */}\r\n            <div className=\"card\">\r\n              <div className=\"p-3 rounded-xl border border-red-500/40 bg-red-500/10\">\r\n                <div className=\"font-semibold mb-4 flex items-center gap-2 text-red-100\">\r\n                  <User className=\"w-5 h-5\" /> Account\r\n                </div>\r\n                <div className=\"space-y-3\">\r\n                  <div className=\"flex justify-center gap-2\">\r\n                    <button\r\n                      onClick={() =>\r\n                        window.dispatchEvent(new CustomEvent(\"ndn:logout\"))\r\n                      }\r\n                      className=\"px-6 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium transition-colors\"\r\n                    >\r\n                      Logout\r\n                    </button>\r\n                    <button\r\n                      onClick={() => setShowHighlights(true)}\r\n                      className=\"px-4 py-2 bg-slate-700 hover:bg-slate-800 text-white rounded-lg font-medium transition-colors\"\r\n                    >\r\n                      Highlights\r\n                    </button>\r\n                  </div>\r\n                  <div className=\"mt-4 border-t pt-3\">\r\n                    <div className=\"font-medium mb-2\">Wallet</div>\r\n                    <div className=\"flex items-center gap-2\">\r\n                      <div className=\"text-sm opacity-80 mr-4\">Balance:{' '}\r\n                        <strong>{ wallet && wallet.wallet && Object.keys(wallet.wallet.balances || {}).length > 0 ?\r\n                          Object.entries(wallet.wallet.balances).map(([c, v]) => `${c} ${(v/100).toFixed(2)}`).join('  ') : '0.00' }\r\n                        </strong>\r\n                      </div>\r\n                      <input className=\"input w-40\" placeholder=\"Withdraw amount\" value={''} onChange={() => {}} />\r\n                      <select className=\"input\">\r\n                        <option>USD</option>\r\n                        <option>GBP</option>\r\n                        <option>EUR</option>\r\n                      </select>\r\n                      <button className=\"btn\" onClick={async () => {\r\n                        const email = user?.email || ''\r\n                        if (!email) return alert('Not signed in')\r\n                        const amt = prompt('Enter withdraw amount (e.g., 10.00)')\r\n                        if (!amt) return\r\n                        try {\r\n                          const token = localStorage.getItem('authToken')\r\n                          const headers: any = {'Content-Type': 'application/json'}\r\n                          if (token) headers.Authorization = `Bearer ${token}`\r\n                          const res = await fetch('/api/wallet/withdraw', { method: 'POST', headers, body: JSON.stringify({ email, amount: amt, currency: 'USD' }) })\r\n                          if (!res.ok) throw new Error('Failed')\r\n                          alert('Withdrawal requested')\r\n                        } catch (err) {\r\n                          alert('Failed to request withdrawal')\r\n                        }\r\n                      }}>Withdraw</button>\r\n                    </div>\r\n                  </div>\r\n                  <div className=\"border-t border-red-500/20 pt-3\">\r\n                    <div className=\"font-medium mb-2 text-red-100\">\r\n                      Change Username (\r\n                      {(() => {\r\n                        const count = user?.usernameChangeCount || 0;\r\n                        if (count < 2)\r\n                          return `${2 - count} free changes remaining`;\r\n                        return \"2 per change\";\r\n                      })()}\r\n                      )\r\n                    </div>\r\n                    <div className=\"text-sm text-red-100 mb-2\">\r\n                      You can change your username up to 2 times for free.\r\n                      Additional changes cost 2 each.\r\n                    </div>\r\n                    {user?.usernameChangeCount >= 2 && !newUsername.trim() ? (\r\n                      <div className=\"text-amber-400 text-sm mb-2\">\r\n                         Additional username changes cost 2\r\n                      </div>\r\n                    ) : null}\r\n                    <input\r\n                      className=\"input w-full mb-2\"\r\n                      type=\"text\"\r\n                      placeholder=\"New username\"\r\n                      value={newUsername}\r\n                      onChange={(e) => setNewUsername(e.target.value)}\r\n                      disabled={changingUsername}\r\n                    />\r\n                    {usernameError && (\r\n                      <div className=\"text-red-400 text-sm mb-2\">\r\n                        {usernameError}\r\n                      </div>\r\n                    )}\r\n                    <button\r\n                      onClick={async () => {\r\n                        setUsernameError(\"\");\r\n                        if (!newUsername.trim()) {\r\n                          setUsernameError(\"Username required\");\r\n                          return;\r\n                        }\r\n                        if (newUsername.length < 3 || newUsername.length > 20) {\r\n                          setUsernameError(\"Username must be 3-20 characters\");\r\n                          return;\r\n                        }\r\n                        const currentCount = user?.usernameChangeCount || 0;\r\n                        const isFree = currentCount < 2;\r\n                        if (!isFree) {\r\n                          window.location.href =\r\n                            \"https://buy.stripe.com/eVq4gB3XqeNS0iw6vAfnO02\";\r\n                        } else {\r\n                          localStorage.setItem(\r\n                            \"pendingUsernameChange\",\r\n                            newUsername.trim(),\r\n                          );\r\n                          window.location.href = \"/?username-change=free\";\r\n                        }\r\n                      }}\r\n                      disabled={changingUsername || !newUsername.trim()}\r\n                      className=\"w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-600 text-white rounded-lg font-medium transition-colors\"\r\n                    >\r\n                      {changingUsername\r\n                        ? \"Processing...\"\r\n                        : (() => {\r\n                            const count = user?.usernameChangeCount || 0;\r\n                            return count < 2\r\n                              ? \"Change Username (FREE)\"\r\n                              : \"Change Username (2)\";\r\n                          })()}\r\n                    </button>\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            </div>\r\n\r\n            {/* Premium */}\r\n            {subscription && (\r\n              <div className=\"card\">\r\n                <div className=\"p-3 rounded-xl border border-green-500/40 bg-green-500/10\">\r\n                  <div className=\"font-semibold mb-4 flex items-center gap-2 text-green-100\">\r\n                    <Shield className=\"w-5 h-5\" /> Premium\r\n                  </div>\r\n                  <div className=\"space-y-3 text-sm text-green-100\">\r\n                    <div>\r\n                      Status:{\" \"}\r\n                      <span\r\n                        className={\r\n                          subscription?.status === \"active\"\r\n                            ? \"text-green-400\"\r\n                            : \"text-yellow-400\"\r\n                        }\r\n                      >\r\n                        {subscription?.status === \"active\"\r\n                          ? \" Active\"\r\n                          : \"Not Active\"}\r\n                      </span>\r\n                    </div>\r\n                    {subscription?.status === \"active\" &&\r\n                      subscription?.nextBillingDate && (\r\n                        <div>\r\n                          Next Billing:{\" \"}\r\n                          {new Date(\r\n                            subscription.nextBillingDate,\r\n                          ).toLocaleDateString()}\r\n                        </div>\r\n                      )}\r\n                    {subscription?.source === \"tournament\" &&\r\n                      subscription?.status === \"active\" && (\r\n                        <button\r\n                          onClick={() =>\r\n                            (window.location.href =\r\n                              \"https://buy.stripe.com/eVq4gB3XqeNS0iw6vAfnO02\")\r\n                          }\r\n                          className=\"w-full px-3 py-2 bg-red-600 hover:bg-red-700 text-white rounded font-medium transition-colors text-xs\"\r\n                        >\r\n                          Cancel Subscription\r\n                        </button>\r\n                      )}\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            )}\r\n\r\n            {/* Profile Photo */}\r\n            <div className=\"card\">\r\n              <div className=\"p-3 rounded-xl border border-cyan-500/40 bg-cyan-500/10\">\r\n                <div className=\"font-semibold mb-4 flex items-center gap-2 text-cyan-100\">\r\n                  <Eye className=\"w-5 h-5\" /> Profile Photo\r\n                </div>\r\n                <input\r\n                  type=\"file\"\r\n                  accept=\"image/*\"\r\n                  onChange={(e) => {\r\n                    const file = e.target.files?.[0];\r\n                    if (file) {\r\n                      const reader = new FileReader();\r\n                      reader.onload = () =>\r\n                        setProfilePhoto(reader.result as string);\r\n                      reader.readAsDataURL(file);\r\n                    }\r\n                  }}\r\n                  className=\"w-full text-xs text-slate-100\"\r\n                />\r\n              </div>\r\n            </div>\r\n\r\n            {/* Online & Socials */}\r\n            <div className=\"card\">\r\n              <div className=\"p-3 rounded-xl border border-purple-500/40 bg-purple-500/10\">\r\n                <div className=\"font-semibold mb-4 flex items-center gap-2 text-purple-100\">\r\n                  <MessageCircle className=\"w-5 h-5\" /> Online & Socials\r\n                </div>\r\n                <div className=\"space-y-3\">\r\n                  <div className=\"flex items-center gap-3\">\r\n                    <input\r\n                      type=\"checkbox\"\r\n                      id=\"allowSpectate\"\r\n                      checked={allowSpectate}\r\n                      onChange={(e) => setAllowSpectate(e.target.checked)}\r\n                      className=\"w-4 h-4\"\r\n                    />\r\n                    <label\r\n                      htmlFor=\"allowSpectate\"\r\n                      className=\"text-sm text-purple-100\"\r\n                    >\r\n                      Allow spectators\r\n                    </label>\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            </div>\r\n\r\n            {/* Data & Privacy */}\r\n            <div className=\"card\">\r\n              <div className=\"p-3 rounded-xl border border-orange-500/40 bg-orange-500/10\">\r\n                <div className=\"font-semibold mb-4 flex items-center gap-2 text-orange-100\">\r\n                  <Shield className=\"w-5 h-5\" /> Data & Privacy\r\n                </div>\r\n                <div className=\"space-y-3\">\r\n                  <div className=\"flex items-center gap-3\">\r\n                    <input\r\n                      type=\"checkbox\"\r\n                      id=\"allowAnalytics\"\r\n                      checked={allowAnalytics}\r\n                      onChange={(e) => setAllowAnalytics(e.target.checked)}\r\n                      className=\"w-4 h-4\"\r\n                    />\r\n                    <label\r\n                      htmlFor=\"allowAnalytics\"\r\n                      className=\"text-sm text-orange-100\"\r\n                    >\r\n                      Allow analytics\r\n                    </label>\r\n                  </div>\r\n                  <button\r\n                    onClick={() => {\r\n                      const data = {\r\n                        achievements,\r\n                        bio: { favPlayer, favTeam, favDarts, bio },\r\n                      };\r\n                      const blob = new Blob([JSON.stringify(data, null, 2)], {\r\n                        type: \"application/json\",\r\n                      });\r\n                      const url = URL.createObjectURL(blob);\r\n                      const a = document.createElement(\"a\");\r\n                      a.href = url;\r\n                      a.download = `my-data-${new Date().toISOString().split(\"T\")[0]}.json`;\r\n                      a.click();\r\n                      URL.revokeObjectURL(url);\r\n                    }}\r\n                    className=\"btn bg-orange-600 hover:bg-orange-700 w-full\"\r\n                  >\r\n                    Export My Data\r\n                  </button>\r\n                </div>\r\n              </div>\r\n            </div>\r\n\r\n            {/* Privacy & Copyright Notice */}\r\n            <div className=\"card\">\r\n              <div className=\"p-3 rounded-xl border border-red-500/40 bg-red-500/10\">\r\n                <div className=\"font-semibold mb-4 flex items-center gap-2\">\r\n                  <Shield className=\"w-5 h-5 text-red-400\" /> Privacy &\r\n                  Copyright\r\n                </div>\r\n                <div className=\"space-y-3 text-sm text-slate-300\">\r\n                  <div className=\"bg-red-500/20 border border-red-500/30 rounded-lg p-3\">\r\n                    <p className=\"font-semibold text-red-300 mb-2\">\r\n                       Legal Notice\r\n                    </p>\r\n                    <p className=\"mb-2 text-xs\">\r\n                      <strong>Copyright:</strong> All content is protected by\r\n                      copyright law.\r\n                    </p>\r\n                    <p className=\"text-xs\">\r\n                      <strong>Privacy:</strong> Your data is protected and\r\n                      unauthorized access is prohibited.\r\n                    </p>\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            </div>\r\n\r\n            {/* Blocked Users */}\r\n            <div className=\"card\">\r\n              <div className=\"p-3 rounded-xl border border-yellow-500/40 bg-yellow-500/10\">\r\n                <div className=\"font-semibold mb-4 flex items-center gap-2 text-yellow-100\">\r\n                  <Shield className=\"w-5 h-5\" /> Blocked Users\r\n                </div>\r\n                <div className=\"space-y-3\">\r\n                  <p className=\"text-sm text-yellow-100\">\r\n                    Manage players you've blocked from contacting you.\r\n                  </p>\r\n                  <button\r\n                    onClick={() =>\r\n                      window.dispatchEvent(\r\n                        new CustomEvent(\"ndn:open-blocklist\"),\r\n                      )\r\n                    }\r\n                    className=\"btn bg-yellow-600 hover:bg-yellow-700 w-full text-sm\"\r\n                  >\r\n                    View Blocked Users\r\n                  </button>\r\n                </div>\r\n              </div>\r\n            </div>\r\n\r\n            {/* Contact & Support */}\r\n            <div className=\"card\">\r\n              <div className=\"p-3 rounded-xl border border-blue-500/40 bg-blue-500/10\">\r\n                <div className=\"font-semibold mb-4 flex items-center gap-2 text-blue-100\">\r\n                  <MessageCircle className=\"w-5 h-5\" /> Contact & Support\r\n                </div>\r\n                <div className=\"space-y-2\">\r\n                  <a\r\n                    href=\"mailto:support@ninedartnation.com\"\r\n                    className=\"flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors text-sm\"\r\n                  >\r\n                     Email Support\r\n                  </a>\r\n                  <a\r\n                    href=\"https://ninedartnation.com/help\"\r\n                    target=\"_blank\"\r\n                    rel=\"noopener noreferrer\"\r\n                    className=\"flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors text-sm\"\r\n                  >\r\n                     Help Center\r\n                  </a>\r\n                  <a\r\n                    href=\"https://ninedartnation.com/faq\"\r\n                    target=\"_blank\"\r\n                    rel=\"noopener noreferrer\"\r\n                    className=\"flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors text-sm\"\r\n                  >\r\n                     FAQ\r\n                  </a>\r\n                </div>\r\n              </div>\r\n            </div>\r\n\r\n            {/* Account Deletion */}\r\n            <div className=\"card\">\r\n              <div className=\"p-3 rounded-xl border border-red-500/40 bg-red-500/10\">\r\n                <div className=\"font-semibold mb-4 flex items-center gap-2 text-red-100\">\r\n                  <Shield className=\"w-5 h-5\" /> Delete Account\r\n                </div>\r\n                <div className=\"space-y-3\">\r\n                  <div className=\"bg-red-500/20 border border-red-500/30 rounded-lg p-3 text-xs text-red-200\">\r\n                    <p className=\"font-semibold mb-1\"> Warning</p>\r\n                    <p>\r\n                      Deleting your account is permanent and cannot be undone.\r\n                      All your stats, achievements, and data will be erased.\r\n                    </p>\r\n                  </div>\r\n                  <button\r\n                    onClick={() => {\r\n                      const confirm = window.confirm(\r\n                        \"Are you absolutely sure you want to delete your account? This action cannot be undone.\\n\\nAll your stats, achievements, and data will be permanently erased.\",\r\n                      );\r\n                      if (confirm) {\r\n                        const finalConfirm = window.confirm(\r\n                          \"This is your final warning. Click OK to permanently delete your account.\",\r\n                        );\r\n                        if (finalConfirm) {\r\n                          window.dispatchEvent(\r\n                            new CustomEvent(\"ndn:delete-account\"),\r\n                          );\r\n                        }\r\n                      }\r\n                    }}\r\n                    className=\"w-full px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium transition-colors\"\r\n                  >\r\n                    Permanently Delete Account\r\n                  </button>\r\n                </div>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      )}\r\n\r\n      {/* ==== CALIBRATION PILL ==== */}\r\n      <div className=\"relative rounded-xl bg-white/5 backdrop-blur-md border border-white/10 p-1\">\r\n        <div className=\"flex items-center gap-2 overflow-x-auto no-scrollbar py-1 px-1\">\r\n          <PillButton\r\n            label=\"Calibration\"\r\n            icon={Camera}\r\n            pill=\"calibration\"\r\n            color=\"from-purple-500 to-pink-500 shadow-purple-500/30\"\r\n          />\r\n        </div>\r\n      </div>\r\n\r\n      {/* CALIBRATION CONTENT */}\r\n      {expandedPill === \"calibration\" && (\r\n        <div className=\"p-6 rounded-2xl border border-white/10 bg-white/[0.02] animate-in fade-in duration-200 space-y-4\">\r\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n            {/* Camera & Vision */}\r\n            <div className=\"card\">\r\n              <div className=\"p-3 rounded-xl border border-blue-500/40 bg-blue-500/10\">\r\n                <div className=\"font-semibold mb-4 flex items-center gap-2\">\r\n                  <Camera className=\"w-5 h-5 text-blue-400\" /> Camera & Vision\r\n                </div>\r\n                <div className=\"space-y-4\">\r\n                  <div className=\"flex items-center gap-3\">\r\n                    <input\r\n                      type=\"checkbox\"\r\n                      id=\"cameraEnabled\"\r\n                      checked={cameraEnabled}\r\n                      onChange={(e) => setCameraEnabled(e.target.checked)}\r\n                      className=\"w-4 h-4\"\r\n                    />\r\n                    <label htmlFor=\"cameraEnabled\" className=\"text-sm\">\r\n                      Enable camera\r\n                    </label>\r\n                  </div>\r\n                  {cameraEnabled && (\r\n                    <>\r\n                      <div>\r\n                        <label\r\n                          htmlFor=\"cameraScale\"\r\n                          className=\"block text-sm mb-2\"\r\n                        >\r\n                          Scale: {cameraScale?.toFixed(2)}\r\n                        </label>\r\n                        <input\r\n                          type=\"range\"\r\n                          id=\"cameraScale\"\r\n                          min=\"0.5\"\r\n                          max=\"3\"\r\n                          step=\"0.1\"\r\n                          value={cameraScale || 1}\r\n                          onChange={(e) =>\r\n                            setCameraScale(parseFloat(e.target.value))\r\n                          }\r\n                          className=\"w-full\"\r\n                        />\r\n                      </div>\r\n                      <div>\r\n                        <label\r\n                          htmlFor=\"cameraAspect\"\r\n                          className=\"block text-sm mb-2\"\r\n                        >\r\n                          Aspect Ratio\r\n                        </label>\r\n                        <select\r\n                          onPointerDown={(e) => { (e as any).stopPropagation(); }}\r\n                          onMouseDown={(e) => { e.stopPropagation(); }}\r\n                          onTouchStart={(e) => { (e as any).stopPropagation?.(); }}\r\n                          id=\"cameraAspect\"\r\n                          value={cameraAspect || \"wide\"}\r\n                          onChange={(e) =>\r\n                            setCameraAspect(e.target.value as \"wide\" | \"square\")\r\n                          }\r\n                          className=\"input w-full\"\r\n                        >\r\n                          <option value=\"wide\">Wide (16:9)</option>\r\n                          <option value=\"square\">Square (1:1)</option>\r\n                        </select>\r\n                      </div>\r\n                      <div>\r\n                        <label\r\n                          htmlFor=\"cameraFitMode\"\r\n                          className=\"block text-sm mb-2\"\r\n                        >\r\n                          Fit Mode\r\n                        </label>\r\n                        <select\r\n                          onPointerDown={(e) => { (e as any).stopPropagation(); }}\r\n                          onMouseDown={(e) => { e.stopPropagation(); }}\r\n                          onTouchStart={(e) => { (e as any).stopPropagation?.(); }}\r\n                          id=\"cameraFitMode\"\r\n                          value={cameraFitMode || \"fit\"}\r\n                          onChange={(e) =>\r\n                            setCameraFitMode(e.target.value as \"fill\" | \"fit\")\r\n                          }\r\n                          className=\"input w-full\"\r\n                        >\r\n                          <option value=\"fill\">Fill (crop)</option>\r\n                          <option value=\"fit\">Fit (letterbox)</option>\r\n                        </select>\r\n                      </div>\r\n                      <button\r\n                        onClick={() => {}}\r\n                        className=\"btn bg-indigo-600 hover:bg-indigo-700 w-full\"\r\n                      >\r\n                        Calibration Guide\r\n                      </button>\r\n                      <div className=\"flex items-center gap-3 mt-3\">\r\n                        <input\r\n                          type=\"checkbox\"\r\n                          id=\"preserveOverlaySize\"\r\n                          checked={preserveCalibrationOverlay}\r\n                          onChange={(e) => setPreserveCalibrationOverlay(e.target.checked)}\r\n                          className=\"w-4 h-4\"\r\n                        />\r\n                        <label htmlFor=\"preserveOverlaySize\" className=\"text-sm\">\r\n                          Preserve overlay display size when locking calibration\r\n                        </label>\r\n                      </div>\r\n                      <div>\r\n                        <label\r\n                          htmlFor=\"autoscoreProvider\"\r\n                          className=\"block text-sm mb-2\"\r\n                        >\r\n                          Auto-score Provider\r\n                        </label>\r\n                        <select\r\n                          onPointerDown={(e) => { (e as any).stopPropagation(); }}\r\n                          onMouseDown={(e) => { e.stopPropagation(); }}\r\n                          onTouchStart={(e) => { (e as any).stopPropagation?.(); }}\r\n                          id=\"autoscoreProvider\"\r\n                          value={autoscoreProvider || \"manual\"}\r\n                          onChange={(e) =>\r\n                            setAutoscoreProvider(\r\n                              e.target.value as\r\n                                | \"manual\"\r\n                                | \"built-in\"\r\n                                | \"external-ws\",\r\n                            )\r\n                          }\r\n                          className=\"input w-full\"\r\n                        >\r\n                          <option value=\"manual\">Manual Scoring</option>\r\n                          <option value=\"built-in\">Built-in Vision</option>\r\n                          <option value=\"external-ws\">\r\n                            External (WebSocket)\r\n                          </option>\r\n                        </select>\r\n                      </div>\r\n                      {autoscoreProvider === \"external-ws\" && (\r\n                        <input\r\n                          type=\"text\"\r\n                          placeholder=\"WebSocket URL\"\r\n                          value={autoscoreWsUrl || \"\"}\r\n                          onChange={(e) => setAutoscoreWsUrl(e.target.value)}\r\n                          className=\"input w-full text-xs\"\r\n                        />\r\n                      )}\r\n                      {autoscoreProvider !== \"manual\" && (\r\n                        <div>\r\n                          <label\r\n                            htmlFor=\"autoCommitMode\"\r\n                            className=\"block text-sm mb-2\"\r\n                          >\r\n                            Turn Advance\r\n                          </label>\r\n                          <select\r\n                            onPointerDown={(e) => { (e as any).stopPropagation(); }}\r\n                            onMouseDown={(e) => { e.stopPropagation(); }}\r\n                            onTouchStart={(e) => { (e as any).stopPropagation?.(); }}\r\n                            id=\"autoCommitMode\"\r\n                            value={autoCommitMode || \"wait-for-clear\"}\r\n                            onChange={(e) =>\r\n                              setAutoCommitMode(\r\n                                e.target.value as\r\n                                  | \"wait-for-clear\"\r\n                                  | \"immediate\",\r\n                              )\r\n                            }\r\n                            className=\"input w-full\"\r\n                          >\r\n                            <option value=\"wait-for-clear\">\r\n                              Wait for darts to be removed\r\n                            </option>\r\n                            <option value=\"immediate\">\r\n                              Advance immediately after 3 darts/bust\r\n                            </option>\r\n                          </select>\r\n                          <p className=\"text-xs opacity-70 mt-1\">\r\n                            Waiting prevents the turn from rotating until you\r\n                            clear the board (or 6.5s pass).\r\n                          </p>\r\n                        </div>\r\n                      )}\r\n                    </>\r\n                  )}\r\n                </div>\r\n              </div>\r\n            </div>\r\n\r\n            {/* Audio & Voice */}\r\n            <div className=\"card\">\r\n              <div className=\"p-3 rounded-xl border border-purple-500/40 bg-purple-500/10\">\r\n                <div className=\"font-semibold mb-4 flex items-center gap-2\">\r\n                  <Volume2 className=\"w-5 h-5 text-purple-400\" /> Audio & Voice\r\n                </div>\r\n                <div className=\"space-y-4\">\r\n                  <div className=\"flex items-center gap-3\">\r\n                    <input\r\n                      type=\"checkbox\"\r\n                      id=\"callerEnabled\"\r\n                      checked={callerEnabled}\r\n                      onChange={(e) => setCallerEnabled(e.target.checked)}\r\n                      className=\"w-4 h-4\"\r\n                    />\r\n                    <label htmlFor=\"callerEnabled\" className=\"text-sm\">\r\n                      Enable voice caller\r\n                    </label>\r\n                  </div>\r\n                  {callerEnabled && (\r\n                    <>\r\n                      <div>\r\n                        <label\r\n                          htmlFor=\"callerVoice\"\r\n                          className=\"block text-sm mb-2\"\r\n                        >\r\n                          Voice\r\n                        </label>\r\n                            <select\r\n                              onPointerDown={(e) => { (e as any).stopPropagation(); }}\r\n                              onMouseDown={(e) => { e.stopPropagation(); }}\r\n                              onTouchStart={(e) => { (e as any).stopPropagation?.(); }}\r\n                          id=\"callerVoice\"\r\n                          value={callerVoice || \"\"}\r\n                          onChange={(e) => setCallerVoice(e.target.value)}\r\n                          className=\"input w-full text-xs\"\r\n                        >\r\n                          <option value=\"\">Default</option>\r\n                          {availableVoices.map((v, i) => (\r\n                            <option key={i} value={v.voiceURI}>\r\n                              {v.name}\r\n                            </option>\r\n                          ))}\r\n                        </select>\r\n                      </div>\r\n                      <div>\r\n                        <label\r\n                          htmlFor=\"callerVolume\"\r\n                          className=\"block text-sm mb-2\"\r\n                        >\r\n                          Volume: {Math.round((callerVolume || 1) * 100)}%\r\n                        </label>\r\n                        <input\r\n                          type=\"range\"\r\n                          id=\"callerVolume\"\r\n                          min=\"0\"\r\n                          max=\"1\"\r\n                          step=\"0.1\"\r\n                          value={callerVolume || 1}\r\n                          onChange={(e) =>\r\n                            setCallerVolume(parseFloat(e.target.value))\r\n                          }\r\n                          className=\"w-full\"\r\n                        />\r\n                      </div>\r\n                      <div className=\"flex items-center gap-3\">\r\n                        <input\r\n                          type=\"checkbox\"\r\n                          id=\"speakCheckoutOnly\"\r\n                          checked={speakCheckoutOnly}\r\n                          onChange={(e) =>\r\n                            setSpeakCheckoutOnly(e.target.checked)\r\n                          }\r\n                          className=\"w-4 h-4\"\r\n                        />\r\n                        <label htmlFor=\"speakCheckoutOnly\" className=\"text-sm\">\r\n                          Only speak checkout scores\r\n                        </label>\r\n                      </div>\r\n                      <button\r\n                        onClick={() => {\r\n                          const utterance = new SpeechSynthesisUtterance(\r\n                            \"Test voice. 180!\",\r\n                          );\r\n                          utterance.voice =\r\n                            availableVoices.find(\r\n                              (v) => v.voiceURI === callerVoice,\r\n                            ) || null;\r\n                          utterance.volume = callerVolume || 1;\r\n                          speechSynthesis.cancel();\r\n                          speechSynthesis.speak(utterance);\r\n                        }}\r\n                        className=\"btn bg-purple-600 hover:bg-purple-700 w-full\"\r\n                      >\r\n                        Test Voice\r\n                      </button>\r\n                    </>\r\n                  )}\r\n                </div>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      )}\r\n\r\n      {/* ==== SETTINGS SECTIONS PILL ==== */}\r\n      <div className=\"relative rounded-xl bg-white/5 backdrop-blur-md border border-white/10 p-1\">\r\n        <div className=\"flex items-center gap-2 overflow-x-auto no-scrollbar py-1 px-1\">\r\n          <PillButton\r\n            label=\"Settings\"\r\n            icon={Settings}\r\n            pill=\"settings\"\r\n            color=\"from-cyan-500 to-blue-500 shadow-cyan-500/30\"\r\n          />\r\n        </div>\r\n      </div>\r\n\r\n      {/* SETTINGS CONTENT */}\r\n      {expandedPill === \"settings\" && (\r\n        <div className=\"space-y-4 animate-in fade-in duration-200\">\r\n          {/* Profile Bio */}\r\n          <div className=\"card\">\r\n            <div className=\"p-3 rounded-xl border border-indigo-500/40 bg-indigo-500/10\">\r\n              <div className=\"flex items-center justify-between mb-4\">\r\n                <div className=\"font-semibold flex items-center gap-2\">\r\n                  <User className=\"w-5 h-5 text-brand-400\" /> Profile Bio\r\n                </div>\r\n                {!isEditing ? (\r\n                  <button\r\n                    onClick={() => setIsEditing(true)}\r\n                    className=\"flex items-center gap-2 px-3 py-1 bg-blue-500/20 hover:bg-blue-500/30 rounded-lg text-blue-400 text-sm transition-colors\"\r\n                  >\r\n                    <Edit3 className=\"w-4 h-4\" /> Edit\r\n                  </button>\r\n                ) : (\r\n                  <button\r\n                    onClick={saveBio}\r\n                    className=\"flex items-center gap-2 px-3 py-1 bg-green-500/20 hover:bg-green-500/30 rounded-lg text-green-400 text-sm transition-colors\"\r\n                  >\r\n                    <Save className=\"w-4 h-4\" /> Save\r\n                  </button>\r\n                )}\r\n              </div>\r\n\r\n              <div className=\"space-y-3\">\r\n                {isEditing ? (\r\n                  <>\r\n                    <div>\r\n                      <label className=\"block text-sm mb-1\">\r\n                        Favorite Player\r\n                      </label>\r\n                      <input\r\n                        type=\"text\"\r\n                        value={favPlayer}\r\n                        onChange={(e) => setFavPlayer(e.target.value)}\r\n                        className=\"input w-full\"\r\n                      />\r\n                    </div>\r\n                    <div>\r\n                      <label className=\"block text-sm mb-1\">\r\n                        Favorite Team\r\n                      </label>\r\n                      <input\r\n                        type=\"text\"\r\n                        value={favTeam}\r\n                        onChange={(e) => setFavTeam(e.target.value)}\r\n                        className=\"input w-full\"\r\n                      />\r\n                    </div>\r\n                    <div>\r\n                      <label className=\"block text-sm mb-1\">\r\n                        Favorite Darts\r\n                      </label>\r\n                      <input\r\n                        type=\"text\"\r\n                        value={favDarts}\r\n                        onChange={(e) => setFavDarts(e.target.value)}\r\n                        className=\"input w-full\"\r\n                      />\r\n                    </div>\r\n                    <div>\r\n                      <label className=\"block text-sm mb-1\">Bio / Quote</label>\r\n                      <textarea\r\n                        value={bio}\r\n                        onChange={(e) => setBio(e.target.value)}\r\n                        rows={3}\r\n                        className=\"input w-full\"\r\n                      />\r\n                    </div>\r\n                  </>\r\n                ) : (\r\n                  <>\r\n                    <div>\r\n                      Favorite Player:{\" \"}\r\n                      <span className=\"text-brand-300\">\r\n                        {favPlayer || \"Not set\"}\r\n                      </span>\r\n                    </div>\r\n                    <div>\r\n                      Favorite Team:{\" \"}\r\n                      <span className=\"text-brand-300\">\r\n                        {favTeam || \"Not set\"}\r\n                      </span>\r\n                    </div>\r\n                    <div>\r\n                      Favorite Darts:{\" \"}\r\n                      <span className=\"text-brand-300\">\r\n                        {favDarts || \"Not set\"}\r\n                      </span>\r\n                    </div>\r\n                    <div>\r\n                      Bio:{\" \"}\r\n                      <span className=\"text-brand-300\">\r\n                        {bio || \"No bio set\"}\r\n                      </span>\r\n                    </div>\r\n                  </>\r\n                )}\r\n              </div>\r\n            </div>\r\n          </div>\r\n\r\n          {/* Game Preferences */}\r\n          <div className=\"card\">\r\n            <div className=\"p-3 rounded-xl border border-green-500/40 bg-green-500/10\">\r\n              <div className=\"font-semibold mb-4 flex items-center gap-2\">\r\n                <Gamepad2 className=\"w-5 h-5 text-green-400\" /> Game Preferences\r\n              </div>\r\n              <div className=\"space-y-3\">\r\n                <div className=\"flex items-center gap-3\">\r\n                  <input\r\n                    type=\"checkbox\"\r\n                    id=\"dartTimerEnabled\"\r\n                    checked={!!dartTimerEnabled}\r\n                    onChange={(e) => setDartTimerEnabled(e.target.checked)}\r\n                    className=\"w-4 h-4\"\r\n                  />\r\n                  <label htmlFor=\"dartTimerEnabled\" className=\"text-sm\">\r\n                    Enable per-dart throw timer\r\n                  </label>\r\n                </div>\r\n                {dartTimerEnabled && (\r\n                  <div>\r\n                    <label className=\"block mb-2 text-sm font-medium\">\r\n                      Time per throw:{\" \"}\r\n                      {dartTimerSeconds ? Math.round(dartTimerSeconds) : 0}s\r\n                    </label>\r\n                    <input\r\n                      type=\"range\"\r\n                      min=\"3\"\r\n                      max=\"30\"\r\n                      value={dartTimerSeconds || 10}\r\n                      onChange={(e) =>\r\n                        setDartTimerSeconds(parseInt(e.target.value))\r\n                      }\r\n                      className=\"w-full\"\r\n                    />\r\n                    <div className=\"text-xs opacity-70 mt-1\">\r\n                      When the timer reaches zero, the dart is recorded as a\r\n                      miss and advances to the next throw.\r\n                    </div>\r\n                  </div>\r\n                )}\r\n                <div>\r\n                  <label\r\n                    htmlFor=\"favoriteDouble\"\r\n                    className=\"block text-sm mb-2\"\r\n                  >\r\n                    Favorite Finish Double\r\n                  </label>\r\n                        <select\r\n                          onPointerDown={(e) => { (e as any).stopPropagation(); }}\r\n                          onMouseDown={(e) => { e.stopPropagation(); }}\r\n                    id=\"favoriteDouble\"\r\n                    value={favoriteDouble}\r\n                    onChange={(e) => setFavoriteDouble(e.target.value)}\r\n                    className=\"input w-full\"\r\n                  >\r\n                    <option value=\"any\">Any Double</option>\r\n                    <option value=\"D20\">Double 20</option>\r\n                    <option value=\"D10\">Double 10</option>\r\n                    <option value=\"D5\">Double 5</option>\r\n                    <option value=\"D1\">Double 1</option>\r\n                  </select>\r\n                </div>\r\n                <div>\r\n                  <label htmlFor=\"avgMode\" className=\"block text-sm mb-2\">\r\n                    Average Display Mode\r\n                  </label>\r\n                  <select\r\n                    id=\"avgMode\"\r\n                    value={avgMode}\r\n                    onChange={(e) =>\r\n                      setAvgMode(e.target.value as \"all-time\" | \"24h\")\r\n                    }\r\n                    className=\"input w-full\"\r\n                  >\r\n                    <option value=\"all-time\">All Time Average</option>\r\n                    <option value=\"24h\">24 Hour Average</option>\r\n                  </select>\r\n                </div>\r\n                <div className=\"flex items-center gap-3\">\r\n                  <input\r\n                    type=\"checkbox\"\r\n                    id=\"x01DoubleIn\"\r\n                    checked={!!x01DoubleIn}\r\n                    onChange={(e) => setX01DoubleIn(e.target.checked)}\r\n                    className=\"w-4 h-4\"\r\n                  />\r\n                  <label htmlFor=\"x01DoubleIn\" className=\"text-sm\">\r\n                    Require Double-In for X01\r\n                  </label>\r\n                </div>\r\n              </div>\r\n            </div>\r\n          </div>\r\n\r\n          {/* UI & Accessibility */}\r\n          <div className=\"card\">\r\n            <div className=\"p-3 rounded-xl border border-pink-500/40 bg-pink-500/10\">\r\n              <div className=\"font-semibold mb-4 flex items-center gap-2\">\r\n                <Eye className=\"w-5 h-5 text-pink-400\" /> UI & Accessibility\r\n              </div>\r\n              <div className=\"space-y-3\">\r\n                <div className=\"flex items-center gap-3\">\r\n                  <input\r\n                    type=\"checkbox\"\r\n                    id=\"autoStartOffline\"\r\n                    checked={autoStartOffline}\r\n                    onChange={(e) => setAutoStartOffline(e.target.checked)}\r\n                    className=\"w-4 h-4\"\r\n                  />\r\n                  <label htmlFor=\"autoStartOffline\" className=\"text-sm\">\r\n                    Auto-start offline games\r\n                  </label>\r\n                </div>\r\n                <div className=\"flex items-center gap-3\">\r\n                  <input\r\n                    type=\"checkbox\"\r\n                    id=\"rememberLastOffline\"\r\n                    checked={rememberLastOffline}\r\n                    onChange={(e) => setRememberLastOffline(e.target.checked)}\r\n                    className=\"w-4 h-4\"\r\n                  />\r\n                  <label htmlFor=\"rememberLastOffline\" className=\"text-sm\">\r\n                    Remember last offline game settings\r\n                  </label>\r\n                </div>\r\n                <div>\r\n                  <label htmlFor=\"offlineLayout\" className=\"block text-sm mb-2\">\r\n                    Offline Layout\r\n                  </label>\r\n                  <select\r\n                    id=\"offlineLayout\"\r\n                    value={offlineLayout || \"classic\"}\r\n                    onChange={(e) =>\r\n                      setOfflineLayout(e.target.value as \"classic\" | \"modern\")\r\n                    }\r\n                    className=\"input w-full\"\r\n                  >\r\n                    <option value=\"classic\">Classic Layout</option>\r\n                    <option value=\"modern\">Modern Layout</option>\r\n                  </select>\r\n                </div>\r\n                <div className=\"flex items-center gap-3\">\r\n                  <input\r\n                    type=\"checkbox\"\r\n                    id=\"reducedMotion\"\r\n                    checked={reducedMotion}\r\n                    onChange={(e) => setReducedMotion(e.target.checked)}\r\n                    className=\"w-4 h-4\"\r\n                  />\r\n                  <label htmlFor=\"reducedMotion\" className=\"text-sm\">\r\n                    Reduce motion/animations\r\n                  </label>\r\n                </div>\r\n                <div className=\"flex items-center gap-3\">\r\n                  <input\r\n                    type=\"checkbox\"\r\n                    id=\"compactHeader\"\r\n                    checked={compactHeader}\r\n                    onChange={(e) => setCompactHeader(e.target.checked)}\r\n                    className=\"w-4 h-4\"\r\n                  />\r\n                  <label htmlFor=\"compactHeader\" className=\"text-sm\">\r\n                    Compact header\r\n                  </label>\r\n                </div>\r\n              </div>\r\n            </div>\r\n          </div>\r\n\r\n          {/* Support & Help */}\r\n          <div className=\"card\">\r\n            <div className=\"p-3 rounded-xl border border-blue-500/40 bg-blue-500/10\">\r\n              <div className=\"font-semibold mb-4 flex items-center gap-2\">\r\n                <HelpCircle className=\"w-5 h-5 text-blue-400\" /> Support & Help\r\n              </div>\r\n              <div className=\"space-y-2\">\r\n                <p className=\"text-sm opacity-80\">\r\n                  Need help? Contact us via email:\r\n                </p>\r\n                <a\r\n                  href=\"mailto:support@ninedartnation.com\"\r\n                  className=\"btn bg-blue-600 hover:bg-blue-700 w-full text-xs\"\r\n                >\r\n                  Email Support\r\n                </a>\r\n              </div>\r\n            </div>\r\n          </div>\r\n\r\n          {/* Help Assistant */}\r\n          <div className=\"card\">\r\n            <div className=\"p-3 rounded-xl border border-cyan-500/40 bg-cyan-500/10\">\r\n              <div className=\"font-semibold mb-4 flex items-center gap-2\">\r\n                <MessageCircle className=\"w-5 h-5 text-cyan-400\" /> Help\r\n                Assistant\r\n              </div>\r\n              <div className=\"space-y-3 max-h-96 overflow-y-auto\">\r\n                {helpMessages.map((msg, i) => (\r\n                  <div key={i} className={`${msg.isUser ? \"text-right\" : \"\"}`}>\r\n                    <div\r\n                      className={`inline-block max-w-xs px-3 py-2 rounded-lg text-sm ${msg.isUser ? \"bg-indigo-600 text-white\" : \"bg-white/10 text-slate-100\"}`}\r\n                    >\r\n                      {typeof msg.text === \"string\" ? (\r\n                        msg.text\r\n                      ) : (\r\n                        <>\r\n                          <div>{msg.text.text}</div>\r\n                          {msg.text.links && (\r\n                            <div className=\"mt-2 space-y-1\">\r\n                              {msg.text.links.map((link, j) => (\r\n                                <button\r\n                                  key={j}\r\n                                  onClick={() => navigateToTab(link.tab)}\r\n                                  className=\"block w-full text-left text-xs px-2 py-1 bg-white/20 hover:bg-white/30 rounded transition\"\r\n                                >\r\n                                  {link.text}\r\n                                </button>\r\n                              ))}\r\n                            </div>\r\n                          )}\r\n                        </>\r\n                      )}\r\n                    </div>\r\n                  </div>\r\n                ))}\r\n              </div>\r\n\r\n              {/* Input */}\r\n              <div className=\"flex gap-2 mt-3\">\r\n                <input\r\n                  type=\"text\"\r\n                  value={helpInput}\r\n                  onChange={(e) => setHelpInput(e.target.value)}\r\n                  onKeyPress={(e) => e.key === \"Enter\" && handleHelpSend()}\r\n                  placeholder=\"Ask me anything...\"\r\n                  className=\"flex-1 input\"\r\n                />\r\n                <button\r\n                  onClick={handleHelpSend}\r\n                  className=\"btn bg-blue-600 hover:bg-blue-700\"\r\n                >\r\n                  <Send className=\"w-4 h-4\" />\r\n                </button>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      )}\r\n\r\n      {/* ==== ACHIEVEMENTS & BADGES (ALWAYS VISIBLE) ==== */}\r\n      <div className=\"card\">\r\n        <div className=\"p-3 rounded-xl border border-yellow-500/40 bg-yellow-500/10\">\r\n          <div className=\"font-semibold mb-4 flex items-center gap-2\">\r\n            <HelpCircle className=\"w-5 h-5 text-yellow-400\" /> Achievements &\r\n            Badges\r\n          </div>\r\n          <div className=\"grid grid-cols-2 md:grid-cols-3 gap-2\">\r\n            {achievements.map((a) => (\r\n              <div\r\n                key={a.key}\r\n                className={`p-3 rounded-lg border ${a.unlocked ? \"border-yellow-500/40 bg-yellow-500/10\" : \"border-white/10 bg-white/5\"}`}\r\n                title={a.desc}\r\n              >\r\n                <div className=\"text-lg\">{a.icon}</div>\r\n                <div className=\"text-xs font-semibold mt-1\">{a.label}</div>\r\n                <div className=\"text-[10px] opacity-70\">\r\n                  {a.unlocked ? \" Unlocked\" : \"Locked\"}\r\n                </div>\r\n              </div>\r\n            ))}\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n","import { useState } from \"react\";\r\nimport {\r\n  Eye,\r\n  EyeOff,\r\n  Trophy,\r\n  Users,\r\n  BarChart3,\r\n  ShieldCheck,\r\n  MessageCircle,\r\n} from \"lucide-react\";\r\n\r\n// Demo admin values removed: unused in codebase\r\n\r\nexport default function Auth({ onAuth }: { onAuth: (user: any) => void }) {\r\n  const [mode, setMode] = useState<\"signin\" | \"signup\" | \"reset\">(\"signin\");\r\n  const [email, setEmail] = useState(\"\");\r\n  const [username, setUsername] = useState(\"\");\r\n  const [password, setPassword] = useState(\"\");\r\n  const [reminder, setReminder] = useState(\"\");\r\n  const [error, setError] = useState(\"\");\r\n  const [showPassword, setShowPassword] = useState(false);\r\n  const [loading, setLoading] = useState(false);\r\n\r\n  // Use VITE_API_URL for API requests, fallback to relative path for local dev\r\n  const API_URL = (import.meta as any).env?.VITE_API_URL || \"\";\r\n\r\n  async function handleSignIn(e: any) {\r\n    e.preventDefault();\r\n    setError(\"\");\r\n    setLoading(true);\r\n    // Preload main app chunks so switching to the app is faster\r\n    try {\r\n      void import(\"./Home\");\r\n      void import(\"./OnlinePlay.clean\");\r\n      void import(\"./OfflinePlay\");\r\n      void import(\"./Scoreboard\");\r\n      void import(\"./StatsPanel\");\r\n  } catch (e) {}\r\n    if (!username || !password) {\r\n      setError(\"Username and password required.\");\r\n      setLoading(false);\r\n      return;\r\n    }\r\n    try {\r\n      console.time(\"Auth:signIn roundtrip\");\r\n      const res = await fetch(`${API_URL}/api/auth/login`, {\r\n        method: \"POST\",\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n        body: JSON.stringify(\r\n          username.includes(\"@\")\r\n            ? { email: username, password }\r\n            : { username, password },\r\n        ),\r\n      });\r\n      const data = await res.json();\r\n      console.timeEnd(\"Auth:signIn roundtrip\");\r\n      if (res.ok && data?.user && data?.token) {\r\n        localStorage.setItem(\"authToken\", data.token);\r\n        onAuth(data.user);\r\n      } else {\r\n        setError(data?.error || \"Invalid username or password.\");\r\n      }\r\n    } catch {\r\n      setError(\"Network error.\");\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  }\r\n\r\n  async function handleSignUp(e: any) {\r\n    e.preventDefault();\r\n    setError(\"\");\r\n    setLoading(true);\r\n    if (!email || !username || !password) {\r\n      setError(\"Email, username, and password required.\");\r\n      setLoading(false);\r\n      return;\r\n    }\r\n    try {\r\n      const res = await fetch(`${API_URL}/api/auth/signup`, {\r\n        method: \"POST\",\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n        body: JSON.stringify({ email, username, password }),\r\n      });\r\n      const data = await res.json();\r\n      if (res.ok && data?.user && data?.token) {\r\n        localStorage.setItem(\"authToken\", data.token);\r\n        onAuth(data.user);\r\n      } else {\r\n        setError(data?.error || \"Signup failed.\");\r\n      }\r\n    } catch {\r\n      setError(\"Network error.\");\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  }\r\n\r\n  async function handleReset(e: any) {\r\n    e.preventDefault();\r\n    setError(\"\");\r\n    setLoading(true);\r\n    if (!email || !email.includes(\"@\")) {\r\n      setError(\"Enter your email address.\");\r\n      setLoading(false);\r\n      return;\r\n    }\r\n    try {\r\n      const r = await fetch(`${API_URL}/api/auth/send-reset`, {\r\n        method: \"POST\",\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n        body: JSON.stringify({ email }),\r\n      });\r\n      const j = await r.json();\r\n      if (!j?.ok) throw new Error(j?.error || \"Failed to send reset email\");\r\n      setError(\"Password reset link sent to your email.\");\r\n    } catch (err: any) {\r\n      setError(err?.message || \"Failed to send reset email\");\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  }\r\n\r\n  async function handleSendUsername(e: any) {\r\n    e.preventDefault();\r\n    setError(\"\");\r\n    setLoading(true);\r\n    if (!email || !email.includes(\"@\")) {\r\n      setError(\"Enter your email address.\");\r\n      setLoading(false);\r\n      return;\r\n    }\r\n    try {\r\n      const r = await fetch(`${API_URL}/api/auth/send-username`, {\r\n        method: \"POST\",\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n        body: JSON.stringify({ email }),\r\n      });\r\n      const j = await r.json();\r\n      if (!j?.ok) throw new Error(j?.error || \"Failed to send username email\");\r\n      setError(\"Your username has been emailed to you.\");\r\n    } catch (err: any) {\r\n      setError(err?.message || \"Failed to send username email\");\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  }\r\n\r\n  return (\r\n    <div className=\"min-h-screen flex items-center justify-center relative overflow-hidden\">\r\n      {/* Animated background accents */}\r\n      <div className=\"background-animated\" />\r\n      <div className=\"relative z-10 w-full max-w-5xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-6 p-4\">\r\n        {/* Auth Card */}\r\n        <form\r\n          className=\"card w-full space-y-4\"\r\n          onSubmit={\r\n            mode === \"signin\"\r\n              ? handleSignIn\r\n              : mode === \"signup\"\r\n                ? handleSignUp\r\n                : handleReset\r\n          }\r\n        >\r\n          <div className=\"flex flex-col items-center justify-center gap-2 mb-2 text-center\">\r\n            <h1 className=\"logo text-center\">NINE-DART-NATION </h1>\r\n            <span className=\"badge\">Welcome</span>\r\n          </div>\r\n          <h2 className=\"text-2xl font-bold\">\r\n            {mode === \"signin\"\r\n              ? \"Sign In\"\r\n              : mode === \"signup\"\r\n                ? \"Create Account\"\r\n                : \"Reset Password\"}\r\n          </h2>\r\n          {(mode === \"signup\" || mode === \"reset\") && (\r\n            <input\r\n              className=\"input w-full\"\r\n              type=\"email\"\r\n              placeholder=\"Email\"\r\n              value={email}\r\n              onChange={(e) => setEmail(e.target.value)}\r\n              required\r\n            />\r\n          )}\r\n          {mode !== \"reset\" && (\r\n            <input\r\n              className=\"input w-full\"\r\n              type=\"text\"\r\n              placeholder=\"Username or Email\"\r\n              value={username}\r\n              onChange={(e) => setUsername(e.target.value)}\r\n              required\r\n            />\r\n          )}\r\n          {mode !== \"reset\" && (\r\n            <div className=\"relative\">\r\n              <input\r\n                className=\"input w-full pr-10\"\r\n                type={showPassword ? \"text\" : \"password\"}\r\n                placeholder=\"Password\"\r\n                value={password}\r\n                onChange={(e) => setPassword(e.target.value)}\r\n                autoComplete=\"current-password\"\r\n                required\r\n                onFocus={() => setShowPassword(false)}\r\n                onBlur={() => setShowPassword(false)}\r\n              />\r\n              <button\r\n                type=\"button\"\r\n                className=\"absolute right-2 top-1/2 -translate-y-1/2 text-slate-300 hover:text-white\"\r\n                tabIndex={-1}\r\n                onMouseDown={(e) => {\r\n                  e.preventDefault();\r\n                  setShowPassword(true);\r\n                }}\r\n                onMouseUp={(e) => {\r\n                  e.preventDefault();\r\n                  setShowPassword(false);\r\n                }}\r\n                onMouseLeave={() => setShowPassword(false)}\r\n                onTouchStart={(e) => {\r\n                  e.preventDefault();\r\n                  setShowPassword(true);\r\n                }}\r\n                onTouchEnd={(e) => {\r\n                  e.preventDefault();\r\n                  setShowPassword(false);\r\n                }}\r\n                aria-label=\"Toggle password visibility\"\r\n              >\r\n                {showPassword ? (\r\n                  <EyeOff className=\"w-5 h-5\" />\r\n                ) : (\r\n                  <Eye className=\"w-5 h-5\" />\r\n                )}\r\n              </button>\r\n            </div>\r\n          )}\r\n          {mode === \"signup\" && (\r\n            <input\r\n              className=\"input w-full\"\r\n              type=\"text\"\r\n              placeholder=\"Password Reminder (optional)\"\r\n              value={reminder}\r\n              onChange={(e) => setReminder(e.target.value)}\r\n            />\r\n          )}\r\n          {error && (\r\n            <div className=\"text-red-400 font-semibold text-sm\">{error}</div>\r\n          )}\r\n          <button className=\"btn w-full\" type=\"submit\" disabled={loading}>\r\n            {loading\r\n              ? \"Signing In...\"\r\n              : mode === \"signin\"\r\n                ? \"Sign In\"\r\n                : mode === \"signup\"\r\n                  ? \"Sign Up\"\r\n                  : \"Send Reset Link\"}\r\n          </button>\r\n          {mode === \"reset\" && (\r\n            <button\r\n              className=\"btn w-full mt-2 bg-white/10 hover:bg-white/20\"\r\n              type=\"button\"\r\n              onClick={handleSendUsername}\r\n              disabled={loading}\r\n            >\r\n              Email me my username\r\n            </button>\r\n          )}\r\n          <div className=\"flex justify-between text-sm mt-2\">\r\n            <button\r\n              type=\"button\"\r\n              className=\"underline\"\r\n              onClick={() => setMode(mode === \"signin\" ? \"signup\" : \"signin\")}\r\n              disabled={loading}\r\n            >\r\n              {mode === \"signin\"\r\n                ? \"Need an account? Sign Up\"\r\n                : \"Already have an account? Sign In\"}\r\n            </button>\r\n            <button\r\n              type=\"button\"\r\n              className=\"underline\"\r\n              onClick={() => setMode(\"reset\")}\r\n              disabled={loading}\r\n            >\r\n              Forgot password?\r\n            </button>\r\n          </div>\r\n        </form>\r\n\r\n        {/* Hints / Teaser Panel */}\r\n        <aside className=\"card w-full\">\r\n          <h3 className=\"text-xl font-bold mb-3\">Whats inside</h3>\r\n          <ul className=\"space-y-3\">\r\n            <li className=\"flex items-start gap-3\">\r\n              <Users className=\"w-5 h-5 text-indigo-300 mt-1\" />\r\n              <div>\r\n                <div className=\"font-semibold\">Online & Friends</div>\r\n                <div className=\"text-sm text-slate-200/90\">\r\n                  Challenge friends, chat, and join leagues.\r\n                </div>\r\n              </div>\r\n            </li>\r\n            <li className=\"flex items-start gap-3\">\r\n              <BarChart3 className=\"w-5 h-5 text-indigo-300 mt-1\" />\r\n              <div>\r\n                <div className=\"font-semibold\">Deep Stats</div>\r\n                <div className=\"text-sm text-slate-200/90\">\r\n                  Track 3-dart averages, best legs, and more.\r\n                </div>\r\n              </div>\r\n            </li>\r\n            <li className=\"flex items-start gap-3\">\r\n              <Trophy className=\"w-5 h-5 text-indigo-300 mt-1\" />\r\n              <div>\r\n                <div className=\"font-semibold\">Game Modes</div>\r\n                <div className=\"text-sm text-slate-200/90\">\r\n                  Start with 3 free online games upon signup. After that,\r\n                  PREMIUM is required to play all games.\r\n                </div>\r\n              </div>\r\n            </li>\r\n            <li className=\"flex items-start gap-3\">\r\n              <ShieldCheck className=\"w-5 h-5 text-indigo-300 mt-1\" />\r\n              <div>\r\n                <div className=\"font-semibold\">Premium Perks</div>\r\n                <div className=\"text-sm text-slate-200/90\">\r\n                  Polished UI, upcoming features, and early access.\r\n                </div>\r\n              </div>\r\n            </li>\r\n          </ul>\r\n          <a\r\n            href={\r\n              (import.meta as any).env?.VITE_DISCORD_INVITE_URL ||\r\n              \"https://discord.gg/8GtbZ6RU\"\r\n            }\r\n            target=\"_blank\"\r\n            rel=\"noopener noreferrer\"\r\n            className=\"btn mt-4 flex items-center justify-center gap-2\"\r\n          >\r\n            <MessageCircle className=\"w-5 h-5\" /> Join BullseyeDartsLeague\r\n          </a>\r\n          <a\r\n            href=\"https://discord.gg/NineDartNation\"\r\n            target=\"_blank\"\r\n            rel=\"noopener noreferrer\"\r\n            className=\"btn mt-2 flex items-center justify-center gap-2 bg-white/10 hover:bg-white/20\"\r\n          >\r\n            <MessageCircle className=\"w-5 h-5\" /> Join NineDartNation\r\n          </a>\r\n        </aside>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n","import { createContext, useContext, useEffect, useState } from \"react\";\r\n\r\nconst ThemeContext = createContext({\r\n  theme: \"default\",\r\n  setTheme: (t: string) => {},\r\n});\r\n\r\nconst THEME_KEY = \"ndn_theme\";\r\n\r\nexport function ThemeProvider({ children }: { children: any }) {\r\n  const [theme, setTheme] = useState(\"default\");\r\n\r\n  useEffect(() => {\r\n    try {\r\n      const saved = localStorage.getItem(THEME_KEY);\r\n      if (saved) setTheme(saved);\r\n    } catch {}\r\n  }, []);\r\n\r\n  useEffect(() => {\r\n    try {\r\n      localStorage.setItem(THEME_KEY, theme);\r\n    } catch {}\r\n  }, [theme]);\r\n  return (\r\n    <ThemeContext.Provider value={{ theme, setTheme }}>\r\n      <div className={`theme-${theme}`}>{children}</div>\r\n    </ThemeContext.Provider>\r\n  );\r\n}\r\n\r\nexport function useTheme() {\r\n  return useContext(ThemeContext);\r\n}\r\n","import React, { useEffect, type ReactNode } from \"react\";\r\nimport FocusLock from \"react-focus-lock\";\r\n\r\ntype DrawerProps = {\r\n  open: boolean;\r\n  onClose: () => void;\r\n  width?: number | string;\r\n  title?: string;\r\n  footer?: ReactNode;\r\n  children: ReactNode;\r\n  side?: \"left\" | \"right\";\r\n};\r\n\r\nexport default function Drawer({\r\n  open,\r\n  onClose,\r\n  width = 700,\r\n  title,\r\n  footer,\r\n  children,\r\n  side = \"right\",\r\n}: DrawerProps) {\r\n  useEffect(() => {\r\n    function onKey(e: KeyboardEvent) {\r\n      if (e.key === \"Escape\") onClose();\r\n    }\r\n    if (open) document.addEventListener(\"keydown\", onKey);\r\n    return () => document.removeEventListener(\"keydown\", onKey);\r\n  }, [open, onClose]);\r\n\r\n  return (\r\n    <div\r\n      className={`fixed inset-0 z-50 ${open ? \"\" : \"pointer-events-none\"}`}\r\n      aria-hidden={!open}\r\n    >\r\n      {/* Backdrop */}\r\n      <div\r\n        className={`absolute inset-0 bg-black/60 transition-opacity ${open ? \"opacity-100\" : \"opacity-0\"}`}\r\n        onClick={onClose}\r\n        role=\"button\"\r\n        aria-label=\"Close drawer\"\r\n        tabIndex={0}\r\n        onKeyDown={(e) => {\r\n          if (e.key === \"Enter\" || e.key === \" \" || e.key === \"Escape\")\r\n            onClose();\r\n        }}\r\n      />\r\n      {/* Panel */}\r\n      <div\r\n        className={`absolute top-0 ${side === \"right\" ? \"right-0 border-l\" : \"left-0 border-r\"} h-full bg-slate-900 border-slate-700 shadow-2xl w-full sm:w-auto flex flex-col transition-transform duration-200 ${open ? \"translate-x-0\" : side === \"right\" ? \"translate-x-full\" : \"-translate-x-full\"}`}\r\n        style={{ width: typeof width === \"number\" ? `${width}px` : width }}\r\n        role=\"dialog\"\r\n        aria-modal=\"true\"\r\n      >\r\n        <FocusLock returnFocus={true}>\r\n          {/* Header */}\r\n          <div className=\"flex items-center justify-between px-4 py-3 border-b border-slate-700 sticky top-0 bg-slate-900 z-10\">\r\n            <div className=\"text-lg font-semibold\">{title}</div>\r\n            <button className=\"btn px-3 py-1 text-sm\" onClick={onClose}>\r\n              Close\r\n            </button>\r\n          </div>\r\n          {/* Body */}\r\n          <div className=\"flex-1 overflow-auto p-4\">{children}</div>\r\n          {/* Footer */}\r\n          {footer && (\r\n            <div className=\"px-4 py-3 border-t border-slate-700 sticky bottom-0 bg-slate-900 z-10\">\r\n              {footer}\r\n            </div>\r\n          )}\r\n        </FocusLock>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n","import React, { useEffect, useState } from \"react\";\r\nimport { HelpCircle, MessageCircle, X, Send } from \"lucide-react\";\r\nimport { apiFetch } from \"../utils/api\";\r\nimport { useWS } from \"./WSProvider\";\r\nimport HelpdeskChat from \"./HelpdeskChat\";\r\n\r\ninterface HelpAssistantProps {}\r\n\r\nexport default function HelpAssistant(_: HelpAssistantProps) {\r\n  const [isOpen, setIsOpen] = useState(false);\r\n  const [messages, setMessages] = useState<\r\n    Array<{\r\n      text:\r\n        | string\r\n        | { text: string; links?: Array<{ text: string; tab: string }> };\r\n      isUser: boolean;\r\n    }>\r\n  >([\r\n    {\r\n      text: \"Hi! I'm your Nine Dart Nation assistant. How can I help you today?\",\r\n      isUser: false,\r\n    },\r\n  ]);\r\n  const [input, setInput] = useState(\"\");\r\n  const [awaitingAdminConfirm, setAwaitingAdminConfirm] = useState(false);\r\n  const [lastUserQuestion, setLastUserQuestion] = useState(\"\");\r\n  const [myRequest, setMyRequest] = useState<any | null>(null);\r\n  const ws = (() => {\r\n    try {\r\n      return useWS();\r\n    } catch {\r\n      return null;\r\n    }\r\n  })();\r\n\r\n  useEffect(() => {\r\n    if (!ws) return;\r\n    const unsub = ws.addListener((data: any) => {\r\n      try {\r\n        if (\r\n          data?.type === \"help-message\" &&\r\n          myRequest &&\r\n          String(data.requestId) === String(myRequest.id)\r\n        ) {\r\n          // append message to chat (the HelpdeskChat modal will also get WS events, but keep assistant messages synced)\r\n          // We don't duplicate state here; just forward to help chat placeholder by refreshing request from server\r\n        }\r\n        if (\r\n          data?.type === \"help-request-updated\" &&\r\n          myRequest &&\r\n          data.request?.id === myRequest.id\r\n        ) {\r\n          setMyRequest(data.request);\r\n        }\r\n      } catch {}\r\n    });\r\n    return () => unsub();\r\n  }, [ws, myRequest]);\r\n\r\n  const faq = {\r\n    \"how to play\":\r\n      \"To play darts, select a game mode from the menu. For online play, join a match. For offline, start a local game.\",\r\n    calibration:\r\n      \"Go to Settings > Camera & Vision > Calibration Guide to set up your camera properly.\",\r\n    premium:\r\n      'Premium unlocks all game modes. Click the \"Upgrade to PREMIUM\" button in online play.',\r\n    username: \"Change your username once for free in Settings > Account.\",\r\n    voice:\r\n      \"Enable voice caller in Settings > Audio & Voice. Test the voice with the Test Voice button.\",\r\n    friends: \"Add friends in the Friends tab to play together.\",\r\n    stats: \"View your statistics in the Stats tab.\",\r\n    settings: \"Customize your experience in the Settings panel.\",\r\n    support:\r\n      \"Contact support via email or check the FAQ in Settings > Support.\",\r\n    scoring:\r\n      \"Auto-scoring assigns each detected dart to the correct board segment using the detection pipeline. You can review scores in the Match Summary after the round.\",\r\n    autoscore:\r\n      \"AutoScore attempts to place darts automatically. If a dart placement looks wrong, you can adjust it in the match review screen or disable immediate auto-commit in Settings.\",\r\n    pairing:\r\n      \"To pair a phone or camera, open the Pairing flow from the main menu and follow the QR / pairing code steps. Ensure both devices are on the same network.\",\r\n    highlights:\r\n      \"Highlights are saved when you checkout 50+ or visit 100+. You can download them from Settings > Highlights or save to your account.\",\r\n    legal:\r\n      \"See the Legal Notice in the footer for Privacy & Copyright information. Click the footer link to view the full policy.\",\r\n  };\r\n\r\n  const navigateToTab = (tabKey: string) => {\r\n    try {\r\n      window.dispatchEvent(\r\n        new CustomEvent(\"ndn:change-tab\", { detail: { tab: tabKey } }),\r\n      );\r\n      setIsOpen(false); // Close the help modal after navigation\r\n    } catch (error) {\r\n      console.error(\"Navigation failed:\", error);\r\n    }\r\n  };\r\n\r\n  const getResponseWithLinks = (\r\n    userMessage: string,\r\n  ): { text: string; links?: Array<{ text: string; tab: string }> } => {\r\n    const message = userMessage.toLowerCase();\r\n\r\n    if (message.includes(\"username\") || message.includes(\"change name\")) {\r\n      return {\r\n        text: \"You can change your username once for free.\",\r\n        links: [{ text: \"Go to Settings > Account\", tab: \"settings\" }],\r\n      };\r\n    }\r\n    if (\r\n      message.includes(\"premium\") ||\r\n      message.includes(\"upgrade\") ||\r\n      message.includes(\"subscription\")\r\n    ) {\r\n      return {\r\n        text: \"Premium unlocks all game modes and features.\",\r\n        links: [{ text: \"Go to Online Play\", tab: \"online\" }],\r\n      };\r\n    }\r\n    if (\r\n      message.includes(\"calibrat\") ||\r\n      message.includes(\"camera\") ||\r\n      message.includes(\"vision\")\r\n    ) {\r\n      return {\r\n        text: \"Set up your camera properly in Settings.\",\r\n        links: [{ text: \"Go to Settings > Camera & Vision\", tab: \"settings\" }],\r\n      };\r\n    }\r\n    if (\r\n      message.includes(\"voice\") ||\r\n      message.includes(\"caller\") ||\r\n      message.includes(\"audio\")\r\n    ) {\r\n      return {\r\n        text: \"Enable voice calling in Settings.\",\r\n        links: [{ text: \"Go to Settings > Audio & Voice\", tab: \"settings\" }],\r\n      };\r\n    }\r\n    if (message.includes(\"friend\") || message.includes(\"play together\")) {\r\n      return {\r\n        text: \"Add friends to play together.\",\r\n        links: [{ text: \"Go to Friends\", tab: \"friends\" }],\r\n      };\r\n    }\r\n    if (\r\n      message.includes(\"stat\") ||\r\n      message.includes(\"score\") ||\r\n      message.includes(\"performance\")\r\n    ) {\r\n      return {\r\n        text: \"View your statistics and performance.\",\r\n        links: [{ text: \"Go to Stats\", tab: \"stats\" }],\r\n      };\r\n    }\r\n    if (\r\n      message.includes(\"setting\") ||\r\n      message.includes(\"customiz\") ||\r\n      message.includes(\"configur\")\r\n    ) {\r\n      return {\r\n        text: \"Customize your experience.\",\r\n        links: [{ text: \"Go to Settings\", tab: \"settings\" }],\r\n      };\r\n    }\r\n    if (message.includes(\"tournament\") || message.includes(\"competition\")) {\r\n      return {\r\n        text: \"Check out tournaments and competitions.\",\r\n        links: [{ text: \"Go to Tournaments\", tab: \"tournaments\" }],\r\n      };\r\n    }\r\n    if (\r\n      message.includes(\"score\") ||\r\n      message.includes(\"scoring\") ||\r\n      message.includes(\"autoscore\")\r\n    ) {\r\n      return {\r\n        text: \"Auto-scoring assigns darts to board segments automatically. You can review and adjust placements in the Match Summary screen.\",\r\n        links: [{ text: \"Go to Match Summary\", tab: \"matchsummary\" }],\r\n      };\r\n    }\r\n    if (\r\n      message.includes(\"pair\") ||\r\n      message.includes(\"pairing\") ||\r\n      message.includes(\"phone\") ||\r\n      message.includes(\"camera pairing\")\r\n    ) {\r\n      return {\r\n        text: \"Use the Pairing flow to connect phones and cameras. Make sure devices are on the same WiFi and scan the QR code shown.\",\r\n        links: [{ text: \"Open Pairing\", tab: \"pairing\" }],\r\n      };\r\n    }\r\n    if (\r\n      message.includes(\"highlight\") ||\r\n      message.includes(\"download\") ||\r\n      message.includes(\"save\")\r\n    ) {\r\n      return {\r\n        text: \"Highlights can be downloaded or saved to your account from the Highlights section. We keep a record when you hit milestone checkouts or visits.\",\r\n        links: [{ text: \"Open Highlights\", tab: \"highlights\" }],\r\n      };\r\n    }\r\n    if (\r\n      message.includes(\"privacy\") ||\r\n      message.includes(\"copyright\") ||\r\n      message.includes(\"legal\")\r\n    ) {\r\n      return {\r\n        text: \"Our Legal Notice and Privacy information are available in the footer. You can view privacy, copyright, and contact details there.\",\r\n        links: [{ text: \"View Legal Notice\", tab: \"footer\" }],\r\n      };\r\n    }\r\n    if (\r\n      message.includes(\"help\") ||\r\n      message.includes(\"support\") ||\r\n      message.includes(\"faq\")\r\n    ) {\r\n      return {\r\n        text: \"You're already in the help section! Check Settings for more resources.\",\r\n        links: [{ text: \"Go to Settings > Support\", tab: \"settings\" }],\r\n      };\r\n    }\r\n    if (\r\n      message.includes(\"how to play\") ||\r\n      message.includes(\"game\") ||\r\n      message.includes(\"start\")\r\n    ) {\r\n      return {\r\n        text: \"To play darts, select a game mode from the menu. For online play, join a match. For offline, start a local game.\",\r\n        links: [\r\n          { text: \"Play Online\", tab: \"online\" },\r\n          { text: \"Play Offline\", tab: \"offline\" },\r\n        ],\r\n      };\r\n    }\r\n\r\n    return {\r\n      text: \"I'm not sure about that. Try asking about playing, calibration, premium, username changes, voice settings, friends, stats, or settings.\",\r\n    };\r\n  };\r\n\r\n  const handleSend = () => {\r\n    if (!input.trim()) return;\r\n    const userMessageRaw = input.trim();\r\n    const userMessage = userMessageRaw.toLowerCase();\r\n    setMessages((prev) => [...prev, { text: userMessageRaw, isUser: true }]);\r\n    setInput(\"\");\r\n\r\n    // If we're awaiting admin confirmation, interpret YES/NO\r\n    if (awaitingAdminConfirm) {\r\n      if (userMessage.startsWith(\"y\")) {\r\n        // Send help request to server\r\n        setMessages((prev) => [\r\n          ...prev,\r\n          {\r\n            text: \"Okay  I will notify an admin. Please wait for them to join the chat.\",\r\n            isUser: false,\r\n          },\r\n        ]);\r\n        setAwaitingAdminConfirm(false);\r\n        // fire-and-forget\r\n        (async () => {\r\n          try {\r\n            const payload = { message: lastUserQuestion || userMessageRaw };\r\n            const res = await apiFetch(\"/api/help/requests\", {\r\n              method: \"POST\",\r\n              headers: { \"Content-Type\": \"application/json\" },\r\n              body: JSON.stringify(payload),\r\n            });\r\n            const j = await res.json().catch(() => null);\r\n            // If server returns the request record, open the live chat\r\n            if (j && j.request) {\r\n              setMyRequest(j.request);\r\n              setMessages((prev) => [\r\n                ...prev,\r\n                {\r\n                  text: \"Okay  I will notify an admin. Please wait for them to join the chat.\",\r\n                  isUser: false,\r\n                },\r\n              ]);\r\n            } else {\r\n              setMessages((prev) => [\r\n                ...prev,\r\n                {\r\n                  text: \"Okay  I will notify an admin. Please wait for them to join the chat.\",\r\n                  isUser: false,\r\n                },\r\n              ]);\r\n            }\r\n          } catch (err) {\r\n            setMessages((prev) => [\r\n              ...prev,\r\n              {\r\n                text: \"Failed to contact admins. Please try again later.\",\r\n                isUser: false,\r\n              },\r\n            ]);\r\n          }\r\n        })();\r\n        return;\r\n      } else {\r\n        setMessages((prev) => [\r\n          ...prev,\r\n          {\r\n            text: \"Okay  I won't notify an admin. If you change your mind, just ask.\",\r\n            isUser: false,\r\n          },\r\n        ]);\r\n        setAwaitingAdminConfirm(false);\r\n        return;\r\n      }\r\n    }\r\n\r\n    // Get response with smart link suggestions\r\n    const response = getResponseWithLinks(userMessage);\r\n\r\n    // If the bot couldn't answer well, offer to escalate\r\n    if (\r\n      typeof response.text === \"string\" &&\r\n      response.text.includes(\"I'm not sure about that\")\r\n    ) {\r\n      setLastUserQuestion(userMessageRaw);\r\n      setAwaitingAdminConfirm(true);\r\n      setTimeout(() => {\r\n        setMessages((prev) => [\r\n          ...prev,\r\n          {\r\n            text: {\r\n              text: \"I can connect you to a member of our admin team  would you like that? Type YES or NO.\",\r\n              links: [],\r\n            },\r\n            isUser: false,\r\n          },\r\n        ]);\r\n      }, 350);\r\n      return;\r\n    }\r\n\r\n    setTimeout(() => {\r\n      setMessages((prev) => [...prev, { text: response, isUser: false }]);\r\n    }, 500);\r\n  };\r\n\r\n  return (\r\n    <>\r\n      {/* Floating Button */}\r\n      <button\r\n        onClick={() => setIsOpen(true)}\r\n        className=\"fixed bottom-4 right-4 z-50 bg-blue-600 hover:bg-blue-700 text-white p-4 rounded-full shadow-lg transition-colors\"\r\n        title=\"Help Assistant\"\r\n      >\r\n        <HelpCircle className=\"w-6 h-6\" />\r\n      </button>\r\n\r\n      {/* Modal */}\r\n      {isOpen && (\r\n        <div className=\"fixed inset-0 z-50 flex items-end justify-end p-4\">\r\n          <div\r\n            className=\"absolute inset-0 bg-black/50\"\r\n            onClick={() => setIsOpen(false)}\r\n          />\r\n          <div className=\"relative bg-slate-800 rounded-lg shadow-xl w-full max-w-md h-96 flex flex-col\">\r\n            {/* Header */}\r\n            <div className=\"flex items-center justify-between p-4 border-b border-slate-700\">\r\n              <div className=\"flex items-center gap-2\">\r\n                <MessageCircle className=\"w-5 h-5 text-blue-400\" />\r\n                <span className=\"font-semibold\">Help Assistant</span>\r\n              </div>\r\n              <button\r\n                onClick={() => setIsOpen(false)}\r\n                className=\"text-slate-400 hover:text-white\"\r\n              >\r\n                <X className=\"w-5 h-5\" />\r\n              </button>\r\n            </div>\r\n\r\n            {/* Messages */}\r\n            <div className=\"flex-1 overflow-y-auto p-4 space-y-3\">\r\n              {messages.map((msg, i) => (\r\n                <div\r\n                  key={i}\r\n                  className={`flex ${msg.isUser ? \"justify-end\" : \"justify-start\"}`}\r\n                >\r\n                  <div\r\n                    className={`max-w-xs px-3 py-2 rounded-lg ${\r\n                      msg.isUser\r\n                        ? \"bg-blue-600 text-white\"\r\n                        : \"bg-slate-700 text-slate-200\"\r\n                    }`}\r\n                  >\r\n                    {typeof msg.text === \"string\" ? (\r\n                      msg.text\r\n                    ) : (\r\n                      <div className=\"space-y-2\">\r\n                        <div>{msg.text.text}</div>\r\n                        {msg.text.links && (\r\n                          <div className=\"space-y-1\">\r\n                            {msg.text.links.map((link, linkIndex) => (\r\n                              <button\r\n                                key={linkIndex}\r\n                                onClick={() => navigateToTab(link.tab)}\r\n                                className=\"block w-full text-left text-blue-300 hover:text-blue-200 underline text-sm\"\r\n                              >\r\n                                {link.text}\r\n                              </button>\r\n                            ))}\r\n                          </div>\r\n                        )}\r\n                      </div>\r\n                    )}\r\n                  </div>\r\n                </div>\r\n              ))}\r\n            </div>\r\n\r\n            {/* Input */}\r\n            <div className=\"p-4 border-t border-slate-700\">\r\n              <div className=\"flex gap-2\">\r\n                <input\r\n                  type=\"text\"\r\n                  value={input}\r\n                  onChange={(e) => setInput(e.target.value)}\r\n                  onKeyPress={(e) => e.key === \"Enter\" && handleSend()}\r\n                  placeholder=\"Ask me anything...\"\r\n                  className=\"flex-1 input\"\r\n                />\r\n                <button\r\n                  onClick={handleSend}\r\n                  className=\"btn bg-blue-600 hover:bg-blue-700\"\r\n                >\r\n                  <Send className=\"w-4 h-4\" />\r\n                </button>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      )}\r\n\r\n      {/* Render live chat modal if a help request exists for this user */}\r\n      {myRequest && (\r\n        <HelpdeskChat\r\n          request={myRequest}\r\n          user={{ email: null, username: null, isAdmin: false }}\r\n          onClose={() => setMyRequest(null)}\r\n        />\r\n      )}\r\n    </>\r\n  );\r\n}\r\n","import { useEffect, useRef } from \"react\";\r\nimport { dlog } from \"../utils/logger\";\r\nimport { useCameraSession } from \"../store/cameraSession\";\r\n\r\n// GlobalCameraLogger: attaches to the camera session and emits detailed logs\r\n// about video element, media stream, and peer connection state so logs are\r\n// visible even when navigating away from Calibrator.\r\nexport default function GlobalCameraLogger() {\r\n  const camera = useCameraSession();\r\n  const lastStateRef = useRef<any>({});\r\n  const listenersRef = useRef<any>({});\r\n\r\n  useEffect(() => {\r\n    function dumpState(prefix = \"[GlobalCamera]\") {\r\n      try {\r\n        const video = camera.getVideoElementRef();\r\n        const media = camera.getMediaStream();\r\n        const pc = camera.getPcRef && camera.getPcRef();\r\n        const ws = camera.getWsRef && camera.getWsRef();\r\n        dlog(prefix, {\r\n          isStreaming: camera.isStreaming,\r\n          mode: camera.mode,\r\n          showOverlay: camera.showOverlay,\r\n          hasVideoElement: !!video,\r\n          video: video\r\n            ? {\r\n                videoWidth: video.videoWidth,\r\n                videoHeight: video.videoHeight,\r\n                srcObject: !!video.srcObject,\r\n              }\r\n            : null,\r\n          mediaTracks: media\r\n            ? media\r\n                .getTracks()\r\n                .map((t) => ({ kind: t.kind, enabled: t.enabled, id: t.id }))\r\n            : null,\r\n          pcState: pc ? pc.connectionState || pc.iceConnectionState : null,\r\n          wsState: ws ? ws.readyState || \"unknown\" : null,\r\n        });\r\n      } catch (e) {\r\n        console.warn(\"[GlobalCamera] dumpState failed\", e);\r\n      }\r\n    }\r\n\r\n    // Initial dump\r\n    dumpState(\"[GlobalCamera] INIT\");\r\n\r\n    // Subscribe to Zustand changes by polling minimal differences (safe & simple)\r\n    let mounted = true;\r\n    const interval = setInterval(() => {\r\n      if (!mounted) return;\r\n      try {\r\n        const video = camera.getVideoElementRef();\r\n        const media = camera.getMediaStream();\r\n        const pc = camera.getPcRef && camera.getPcRef();\r\n        const snapshot = {\r\n          isStreaming: camera.isStreaming,\r\n          mode: camera.mode,\r\n          hasVideo: !!video,\r\n          videoW: video ? video.videoWidth : 0,\r\n          videoH: video ? video.videoHeight : 0,\r\n          tracks: media ? media.getTracks().length : 0,\r\n          pcState: pc ? pc.connectionState || pc.iceConnectionState : null,\r\n        };\r\n        const prev = lastStateRef.current;\r\n        // Shallow compare a few keys\r\n        if (\r\n          snapshot.isStreaming !== prev.isStreaming ||\r\n          snapshot.hasVideo !== prev.hasVideo ||\r\n          snapshot.videoW !== prev.videoW ||\r\n          snapshot.videoH !== prev.videoH ||\r\n          snapshot.tracks !== prev.tracks ||\r\n          snapshot.pcState !== prev.pcState ||\r\n          camera.showOverlay !== prev.showOverlay\r\n        ) {\r\n          lastStateRef.current = snapshot;\r\n          dumpState(\"[GlobalCamera] CHANGE\");\r\n        }\r\n      } catch (e) {\r\n        console.warn(\"[GlobalCamera] poll failed\", e);\r\n      }\r\n    }, 750);\r\n\r\n    // Attach video element listeners when available to capture events like loadedmetadata/playing\r\n    function attachVideoListeners(v: HTMLVideoElement | null) {\r\n      try {\r\n        const prev = listenersRef.current.video;\r\n        if (prev && prev.el === v) return;\r\n        if (prev && prev.el) {\r\n          try {\r\n            prev.el.removeEventListener(\"loadedmetadata\", prev.loadedmetadata);\r\n          } catch {}\r\n          try {\r\n            prev.el.removeEventListener(\"playing\", prev.playing);\r\n          } catch {}\r\n          try {\r\n            prev.el.removeEventListener(\"pause\", prev.pause);\r\n          } catch {}\r\n          try {\r\n            prev.el.removeEventListener(\"ended\", prev.ended);\r\n          } catch {}\r\n        }\r\n        listenersRef.current.video = null;\r\n        if (v) {\r\n          const loadedmetadata = () =>\r\n            dlog(\"[GlobalCamera] video loadedmetadata\", {\r\n              videoWidth: v.videoWidth,\r\n              videoHeight: v.videoHeight,\r\n            });\r\n          const playing = () => {\r\n            dlog(\"[GlobalCamera] video playing\", { paused: v.paused });\r\n            try {\r\n              camera.setStreaming(true);\r\n            } catch {}\r\n          };\r\n          const pause = () => {\r\n            dlog(\"[GlobalCamera] video pause\");\r\n            try {\r\n              camera.setStreaming(false);\r\n            } catch {}\r\n          };\r\n          const ended = () => {\r\n            dlog(\"[GlobalCamera] video ended\");\r\n            try {\r\n              camera.setStreaming(false);\r\n            } catch {}\r\n          };\r\n          v.addEventListener(\"loadedmetadata\", loadedmetadata);\r\n          v.addEventListener(\"playing\", playing);\r\n          v.addEventListener(\"pause\", pause);\r\n          v.addEventListener(\"ended\", ended);\r\n          listenersRef.current.video = {\r\n            el: v,\r\n            loadedmetadata,\r\n            playing,\r\n            pause,\r\n            ended,\r\n          };\r\n        }\r\n      } catch (e) {\r\n        console.warn(\"[GlobalCamera] attachVideoListeners failed\", e);\r\n      }\r\n    }\r\n\r\n    // Watch for PC state changes if RTCPeerConnection is present\r\n    function attachPc(pc: RTCPeerConnection | null) {\r\n      try {\r\n        const prev = listenersRef.current.pc;\r\n        if (prev && prev.pc === pc) return;\r\n        if (prev && prev.pc) {\r\n          try {\r\n            prev.pc.removeEventListener(\r\n              \"connectionstatechange\",\r\n              prev.connChange,\r\n            );\r\n          } catch {}\r\n        }\r\n        listenersRef.current.pc = null;\r\n        if (pc) {\r\n          const connChange = () =>\r\n            dlog(\"[GlobalCamera] pc state change\", {\r\n              connectionState: pc.connectionState,\r\n              iceState: (pc as any).iceConnectionState,\r\n            });\r\n          pc.addEventListener(\"connectionstatechange\", connChange);\r\n          listenersRef.current.pc = { pc, connChange };\r\n        }\r\n      } catch (e) {\r\n        console.warn(\"[GlobalCamera] attachPc failed\", e);\r\n      }\r\n    }\r\n\r\n    // Periodically re-attach listeners if refs change\r\n    const attachInterval = setInterval(() => {\r\n      try {\r\n        attachVideoListeners(camera.getVideoElementRef());\r\n        attachPc(camera.getPcRef && camera.getPcRef());\r\n      } catch (e) {}\r\n    }, 1000);\r\n\r\n    return () => {\r\n      mounted = false;\r\n      clearInterval(interval);\r\n      clearInterval(attachInterval);\r\n      // cleanup listeners\r\n      try {\r\n        const v = listenersRef.current.video;\r\n        if (v && v.el) {\r\n          v.el.removeEventListener(\"loadedmetadata\", v.loadedmetadata);\r\n          v.el.removeEventListener(\"playing\", v.playing);\r\n        }\r\n      } catch (e) {}\r\n      try {\r\n        const p = listenersRef.current.pc;\r\n        if (p && p.pc)\r\n          p.pc.removeEventListener(\"connectionstatechange\", p.connChange);\r\n      } catch (e) {}\r\n    };\r\n  }, [camera]);\r\n\r\n  return null;\r\n}\r\n","import { useEffect, useRef } from \"react\";\r\nimport { useCameraSession } from \"../store/cameraSession\";\r\n\r\n/**\r\n * GlobalPhoneVideoSink\r\n * Keeps a hidden video element alive across navigation and feeds it the phone camera stream\r\n * so other components (overlay, badge) can draw frames even when Calibrator unmounts.\r\n */\r\nexport default function GlobalPhoneVideoSink() {\r\n  const camera = useCameraSession();\r\n  const vref = useRef<HTMLVideoElement | null>(null);\r\n  const lastStreamRef = useRef<MediaStream | null>(null);\r\n  const lastTimeRef = useRef<number>(0);\r\n  const stallSecondsRef = useRef<number>(0);\r\n  const lastReconnectAtRef = useRef<number>(0);\r\n  const attemptRef = useRef<number>(0);\r\n\r\n  // Ensure the global ref is registered for others to use\r\n  useEffect(() => {\r\n    if (vref.current) {\r\n      camera.setVideoElementRef(vref.current);\r\n    }\r\n  }, [camera]);\r\n\r\n  // Apply the current stream and keep it playing\r\n  useEffect(() => {\r\n    let mounted = true;\r\n\r\n    const apply = async () => {\r\n      if (!mounted) return;\r\n      try {\r\n        const s = camera.getMediaStream();\r\n        const vid = vref.current;\r\n        if (!vid || !s) return;\r\n        if (lastStreamRef.current !== s || vid.srcObject !== s) {\r\n          vid.srcObject = s;\r\n          lastStreamRef.current = s;\r\n        }\r\n        vid.muted = true;\r\n        (vid as any).playsInline = true;\r\n        try {\r\n          await vid.play();\r\n        } catch {}\r\n      } catch {}\r\n    };\r\n\r\n    // Try immediately and then poll a bit to catch late streams\r\n    apply();\r\n    const t = setInterval(apply, 750);\r\n    return () => {\r\n      mounted = false;\r\n      clearInterval(t);\r\n    };\r\n  }, [camera]);\r\n\r\n  // Watchdog: if the video currentTime doesn't advance for >3s while streaming, request a reconnect with backoff\r\n  useEffect(() => {\r\n    const tick = () => {\r\n      const v = vref.current;\r\n      const now = Date.now();\r\n      if (!v || !camera.isStreaming || camera.mode !== \"phone\") {\r\n        stallSecondsRef.current = 0;\r\n        return;\r\n      }\r\n      if (!v.srcObject) {\r\n        const minBackoff = [3000, 6000, 10000][Math.min(attemptRef.current, 2)];\r\n        if (now - lastReconnectAtRef.current >= minBackoff) {\r\n          lastReconnectAtRef.current = now;\r\n          attemptRef.current = Math.min(attemptRef.current + 1, 3);\r\n          try {\r\n            window.dispatchEvent(\r\n              new CustomEvent(\"ndn:phone-camera-reconnect\", {\r\n                detail: { reason: \"missing-stream\", ts: now },\r\n              }),\r\n            );\r\n            v.play().catch(() => {});\r\n          } catch {}\r\n        }\r\n        return;\r\n      }\r\n      const ct = (v as HTMLVideoElement).currentTime || 0;\r\n      if (!Number.isFinite(ct)) return;\r\n      if (ct === lastTimeRef.current) {\r\n        stallSecondsRef.current += 1;\r\n      } else {\r\n        stallSecondsRef.current = 0;\r\n      }\r\n      lastTimeRef.current = ct;\r\n      if (stallSecondsRef.current >= 3) {\r\n        const minBackoff = [3000, 6000, 10000][Math.min(attemptRef.current, 2)];\r\n        if (now - lastReconnectAtRef.current >= minBackoff) {\r\n          lastReconnectAtRef.current = now;\r\n          attemptRef.current = Math.min(attemptRef.current + 1, 3);\r\n          try {\r\n            window.dispatchEvent(\r\n              new CustomEvent(\"ndn:phone-camera-reconnect\", {\r\n                detail: { reason: \"stall\", ts: now },\r\n              }),\r\n            );\r\n            // Try to nudge playback locally as well\r\n            v.play().catch(() => {});\r\n          } catch {}\r\n        }\r\n      } else if (stallSecondsRef.current === 0) {\r\n        // Reset attempts on healthy playback\r\n        attemptRef.current = 0;\r\n      }\r\n    };\r\n    const id = setInterval(tick, 1000);\r\n    return () => clearInterval(id);\r\n  }, [camera]);\r\n\r\n  // Keep dimensions tiny but visible so playback isn't throttled by display:none in some browsers\r\n  return (\r\n    <video\r\n      ref={vref}\r\n      style={{\r\n        position: \"fixed\",\r\n        width: 1,\r\n        height: 1,\r\n        left: -9999,\r\n        top: -9999,\r\n        opacity: 0,\r\n      }}\r\n      muted\r\n      playsInline\r\n      aria-hidden\r\n    />\r\n  );\r\n}\r\n","import React, { useState } from 'react';\r\n\r\n/**\r\n * Small header pill that allows installing the PWA or linking to app store pages.\r\n * - Tries to prompt the PWA install if available\r\n * - Shows links to Play Store / App Store if configured via environment variables\r\n */\r\nexport default function InstallPicker() {\r\n  const [open, setOpen] = useState(false);\r\n  const playStore = (import.meta as any).env?.VITE_PLAY_STORE_URL || '';\r\n  const appStore = (import.meta as any).env?.VITE_APP_STORE_URL || '';\r\n\r\n  async function installPwa() {\r\n    try {\r\n      // Global promptInstallApp() is added to index.html and stores `beforeinstallprompt`\r\n      if ((window as any).promptInstallApp) {\r\n        const result = await (window as any).promptInstallApp();\r\n        if (result) {\r\n          // installed\r\n        }\r\n      } else if (navigator?.standalone || 'onappinstalled' in window) {\r\n        // Already installed or installed via other prompt\r\n        alert('App is already installed or your browser does not support programmatic install.');\r\n      } else {\r\n        alert('Install is not available for your browser. Try using the share menu (iOS) or the install prompt (Chrome/Edge on Android).');\r\n      }\r\n    } catch (e) {\r\n      // ignore\r\n    }\r\n  }\r\n\r\n  return (\r\n    <div className=\"relative inline-block\">\r\n      <button\r\n        className=\"px-2 py-1 rounded-full border border-white/10 bg-white/5 hover:bg-white/10 text-sm text-white flex items-center gap-2\"\r\n        onClick={() => setOpen((v) => !v)}\r\n        title=\"Install or download app\"\r\n      >\r\n        Install\r\n      </button>\r\n      {open && (\r\n        <div className=\"absolute right-0 mt-2 w-64 bg-white/5 text-black card p-3 z-50\">\r\n          <div className=\"font-semibold mb-2\">Install or Download</div>\r\n          <div className=\"text-sm mb-2\">\r\n            Install the app as a Progressive Web App or install a native version if available\r\n          </div>\r\n          <div className=\"flex flex-col space-y-2\">\r\n            <button className=\"btn\" onClick={installPwa}>Install (PWA)</button>\r\n            {playStore ? (\r\n              <a className=\"btn\" target=\"_blank\" rel=\"noreferrer\" href={playStore}>Android (Google Play)</a>\r\n            ) : (\r\n              <div className=\"text-xs opacity-80\">Android native build not provided</div>\r\n            )}\r\n            {appStore ? (\r\n              <a className=\"btn\" target=\"_blank\" rel=\"noreferrer\" href={appStore}>iOS (App Store)</a>\r\n            ) : (\r\n              <div className=\"text-xs opacity-80\">iOS native build not provided</div>\r\n            )}\r\n            <div className=\"text-xs opacity-70\">iOS: Use Safari &rarr; Share &rarr; \"Add to Home Screen\" to add this site to your home screen.</div>\r\n          </div>\r\n        </div>\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n","import React, { useState, useEffect } from 'react';\r\n\r\nexport default function AddToHomeButton() {\r\n  const [available, setAvailable] = useState(false);\r\n  const [showInstructions, setShowInstructions] = useState(false);\r\n\r\n  useEffect(() => {\r\n    try {\r\n      const handler = (e: any) => {\r\n        e.preventDefault();\r\n        (window as any).deferredInstallPrompt = e;\r\n        setAvailable(true);\r\n      };\r\n      window.addEventListener('beforeinstallprompt', handler as any);\r\n      // if there is an existing prompt saved by global handler in index.html\r\n      if ((window as any).deferredInstallPrompt) setAvailable(true);\r\n      return () => window.removeEventListener('beforeinstallprompt', handler as any);\r\n    } catch (e) {\r\n      // nothing\r\n    }\r\n  }, []);\r\n\r\n  async function handleClick() {\r\n    try {\r\n      if ((window as any).promptInstallApp) {\r\n        const ok = await (window as any).promptInstallApp();\r\n        if (!ok) setShowInstructions(true);\r\n      } else if ((window as any).deferredInstallPrompt) {\r\n        // fallback (should call promptInstallApp already, but just in case)\r\n        const p = (window as any).deferredInstallPrompt;\r\n        p.prompt();\r\n        const choice = await p.userChoice;\r\n        if (choice && choice.outcome === 'accepted') {\r\n          setAvailable(false);\r\n        } else setShowInstructions(true);\r\n      } else {\r\n        setShowInstructions(true);\r\n      }\r\n    } catch (e) {\r\n      setShowInstructions(true);\r\n    }\r\n  }\r\n\r\n  function iosInstructions(): string {\r\n    return 'Open Safari &rarr; Tap the share button &rarr; \"Add to Home Screen\".';\r\n  }\r\n\r\n  if (showInstructions) {\r\n    return (\r\n      <div className=\"relative inline-block\">\r\n        <button onClick={() => setShowInstructions(false)} className=\"px-2 py-1 rounded-full border border-white/10 bg-white/5 text-sm\">\r\n          Close\r\n        </button>\r\n        <div className=\"text-sm p-2 mt-1 text-black card\">{isIos() ? iosInstructions() : 'Use your browser \"Install\" menu or the share button (iOS) to add to home screen.'}</div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <button\r\n      onClick={handleClick}\r\n      className=\"px-2 py-1 rounded-full border border-white/10 bg-white/5 hover:bg-white/10 text-sm\"\r\n      title=\"Add to Home Screen\"\r\n    >\r\n      Add to Home Screen\r\n    </button>\r\n  );\r\n}\r\n\r\nfunction isIos() {\r\n  try {\r\n    return /iphone|ipad|ipod/i.test(navigator.userAgent);\r\n  } catch (e) {\r\n    return false;\r\n  }\r\n}\r\n","import React, {\r\n  useEffect,\r\n  useRef,\r\n  useState,\r\n  type ReactNode,\r\n  type CSSProperties,\r\n} from \"react\";\r\nimport FocusLock from \"react-focus-lock\";\r\n\r\ntype Props = {\r\n  storageKey: string;\r\n  children: ReactNode;\r\n  className?: string;\r\n  defaultWidth?: number;\r\n  defaultHeight?: number;\r\n  minWidth?: number;\r\n  minHeight?: number;\r\n  maxWidth?: number;\r\n  maxHeight?: number;\r\n  fullScreen?: boolean;\r\n  initialFitHeight?: boolean;\r\n  onClose?: () => void;\r\n};\r\n\r\ntype Size = { width?: number; height?: number };\r\n\r\nexport default function ResizableModal({\r\n  storageKey,\r\n  children,\r\n  className,\r\n  defaultWidth = 520,\r\n  defaultHeight,\r\n  minWidth = 360,\r\n  minHeight = 200,\r\n  maxWidth = 1100,\r\n  maxHeight = 900,\r\n  fullScreen = false,\r\n  initialFitHeight = false,\r\n  onClose,\r\n}: Props) {\r\n  const [size, setSize] = useState<Size>(() => {\r\n    if (!fullScreen) {\r\n      try {\r\n        const raw = localStorage.getItem(storageKey);\r\n        if (raw) return JSON.parse(raw);\r\n      } catch {}\r\n      return { width: defaultWidth, height: defaultHeight };\r\n    }\r\n    return {};\r\n  });\r\n  const startRef = useRef<{\r\n    x: number;\r\n    y: number;\r\n    w: number;\r\n    h: number;\r\n    dir: string;\r\n  } | null>(null);\r\n\r\n  useEffect(() => {\r\n    if (fullScreen) return;\r\n    function onReset() {\r\n      try {\r\n        localStorage.removeItem(storageKey);\r\n      } catch {}\r\n      // If initialFitHeight is enabled, prefer fitting to parent height on reset\r\n      if (initialFitHeight && containerRef.current?.parentElement) {\r\n        const parent = containerRef.current.parentElement as HTMLElement;\r\n        const cs = window.getComputedStyle(parent);\r\n        const padTop = parseFloat(cs.paddingTop || \"0\") || 0;\r\n        const padBottom = parseFloat(cs.paddingBottom || \"0\") || 0;\r\n        const inner = Math.max(0, parent.clientHeight - padTop - padBottom);\r\n        const target = Math.max(\r\n          minHeight,\r\n          Math.min(maxHeight, Math.round(inner)),\r\n        );\r\n        setSize({ width: defaultWidth, height: target });\r\n        return;\r\n      }\r\n      setSize({ width: defaultWidth, height: defaultHeight });\r\n    }\r\n    window.addEventListener(\"ndn:layout-reset\" as any, onReset);\r\n    return () => window.removeEventListener(\"ndn:layout-reset\" as any, onReset);\r\n  }, [storageKey, defaultWidth, defaultHeight, fullScreen]);\r\n\r\n  useEffect(() => {\r\n    if (fullScreen) return;\r\n    try {\r\n      localStorage.setItem(storageKey, JSON.stringify(size));\r\n    } catch {}\r\n  }, [size, storageKey, fullScreen]);\r\n\r\n  // Optionally fit initial height to the available parent container when no saved size exists\r\n  useEffect(() => {\r\n    if (fullScreen || !initialFitHeight) return;\r\n    const parent = containerRef.current?.parentElement as HTMLElement | null;\r\n    if (!parent) return;\r\n    const cs = window.getComputedStyle(parent);\r\n    const padTop = parseFloat(cs.paddingTop || \"0\") || 0;\r\n    const padBottom = parseFloat(cs.paddingBottom || \"0\") || 0;\r\n    const inner = Math.max(0, parent.clientHeight - padTop - padBottom);\r\n    const target = Math.max(minHeight, Math.min(maxHeight, Math.round(inner)));\r\n    try {\r\n      const saved = localStorage.getItem(storageKey);\r\n      if (saved) {\r\n        const savedSize = JSON.parse(saved) as Size;\r\n        const h = savedSize?.height || 0;\r\n        // If saved height is smaller than available, bump it to fill the frame bottom\r\n        if (!h || h < target) {\r\n          setSize((s) => ({ ...s, height: target }));\r\n        }\r\n        return;\r\n      }\r\n    } catch {}\r\n    setSize((s) => ({ ...s, height: target }));\r\n  }, [initialFitHeight, fullScreen, storageKey, minHeight, maxHeight]);\r\n\r\n  function clamp(n: number, min: number, max: number) {\r\n    return Math.max(min, Math.min(max, n));\r\n  }\r\n\r\n  function beginResize(e: React.MouseEvent, dir: string) {\r\n    e.preventDefault();\r\n    const el = containerRef.current;\r\n    if (!el) return;\r\n    const rect = el.getBoundingClientRect();\r\n    startRef.current = {\r\n      x: e.clientX,\r\n      y: e.clientY,\r\n      w: rect.width,\r\n      h: rect.height,\r\n      dir,\r\n    };\r\n    window.addEventListener(\"mousemove\", onMove);\r\n    window.addEventListener(\"mouseup\", endResize);\r\n  }\r\n\r\n  function handleKeyResize(e: React.KeyboardEvent, dir: string) {\r\n    const step = 20;\r\n    const k = e.key;\r\n    if (\r\n      ![\r\n        \"ArrowLeft\",\r\n        \"ArrowRight\",\r\n        \"ArrowUp\",\r\n        \"ArrowDown\",\r\n        \"Enter\",\r\n        \" \",\r\n      ].includes(k)\r\n    )\r\n      return;\r\n    e.preventDefault();\r\n    const delta = k === \"ArrowLeft\" || k === \"ArrowUp\" ? -step : step;\r\n    setSize((s) => {\r\n      const curW = s.width || defaultWidth;\r\n      const curH = s.height || defaultHeight || minHeight;\r\n      let w = curW;\r\n      let h = curH;\r\n      if (dir.includes(\"e\")) w = clamp(curW + delta, minWidth, maxWidth);\r\n      if (dir.includes(\"w\")) w = clamp(curW - delta, minWidth, maxWidth);\r\n      if (dir.includes(\"s\")) h = clamp(curH + delta, minHeight, maxHeight);\r\n      if (dir.includes(\"n\")) h = clamp(curH - delta, minHeight, maxHeight);\r\n      return { width: Math.round(w), height: Math.round(h) };\r\n    });\r\n  }\r\n\r\n  function onMove(e: MouseEvent) {\r\n    const s = startRef.current;\r\n    if (!s) return;\r\n    const dx = e.clientX - s.x;\r\n    const dy = e.clientY - s.y;\r\n    const dir = s.dir;\r\n    let w = s.w;\r\n    let h = s.h;\r\n    // Respect parent's inner height so the modal bottom can align with the frame bottom\r\n    let parentInner = Infinity;\r\n    const parent = containerRef.current?.parentElement as HTMLElement | null;\r\n    if (parent) {\r\n      const cs = window.getComputedStyle(parent);\r\n      const padTop = parseFloat(cs.paddingTop || \"0\") || 0;\r\n      const padBottom = parseFloat(cs.paddingBottom || \"0\") || 0;\r\n      parentInner = Math.max(0, parent.clientHeight - padTop - padBottom);\r\n    }\r\n    const effMaxH = Math.min(\r\n      maxHeight,\r\n      isFinite(parentInner) ? parentInner : maxHeight,\r\n    );\r\n    // We only adjust width/height; the modal stays centered via parent flex\r\n    if (dir.includes(\"e\")) w = clamp(s.w + dx, minWidth, maxWidth);\r\n    if (dir.includes(\"s\")) h = clamp(s.h + dy, minHeight, effMaxH);\r\n    if (dir.includes(\"w\")) w = clamp(s.w - dx, minWidth, maxWidth);\r\n    if (dir.includes(\"n\")) h = clamp(s.h - dy, minHeight, effMaxH);\r\n    setSize({ width: Math.round(w), height: Math.round(h) });\r\n  }\r\n\r\n  function endResize() {\r\n    window.removeEventListener(\"mousemove\", onMove);\r\n    window.removeEventListener(\"mouseup\", endResize);\r\n    startRef.current = null;\r\n  }\r\n\r\n  const containerRef = useRef<HTMLDivElement | null>(null);\r\n  const style: CSSProperties = fullScreen\r\n    ? { width: \"100%\", height: \"100%\", maxWidth: \"100%\", maxHeight: \"100%\" }\r\n    : {\r\n        width: size.width ? `${size.width}px` : undefined,\r\n        height: size.height ? `${size.height}px` : undefined,\r\n        maxWidth: `${maxWidth}px`,\r\n        // Allow filling up to the parent's inner height\r\n        maxHeight: \"100%\",\r\n      };\r\n\r\n  const baseClass = fullScreen\r\n    ? \"card relative ndn-modal-full\"\r\n    : \"card relative\";\r\n  return (\r\n    <div\r\n      ref={containerRef}\r\n      className={`${baseClass} ${className || \"\"}`}\r\n      style={style}\r\n    >\r\n      <FocusLock returnFocus className=\"flex-1 flex flex-col min-h-0 w-full\">\r\n        {/* Content */}\r\n        {children}\r\n      </FocusLock>\r\n      {/* Corner handles */}\r\n      {!fullScreen && (\r\n        <div\r\n          className=\"resizer resizer-nw\"\r\n          onMouseDown={(e) => beginResize(e, \"nw\")}\r\n          role=\"button\"\r\n          tabIndex={0}\r\n          aria-label=\"Resize north-west\"\r\n          onKeyDown={(e) => handleKeyResize(e, \"nw\")}\r\n        />\r\n      )}\r\n      {!fullScreen && (\r\n        <div\r\n          className=\"resizer resizer-ne\"\r\n          onMouseDown={(e) => beginResize(e, \"ne\")}\r\n          role=\"button\"\r\n          tabIndex={0}\r\n          aria-label=\"Resize north-east\"\r\n          onKeyDown={(e) => handleKeyResize(e, \"ne\")}\r\n        />\r\n      )}\r\n      {!fullScreen && (\r\n        <div\r\n          className=\"resizer resizer-sw\"\r\n          onMouseDown={(e) => beginResize(e, \"sw\")}\r\n          role=\"button\"\r\n          tabIndex={0}\r\n          aria-label=\"Resize south-west\"\r\n          onKeyDown={(e) => handleKeyResize(e, \"sw\")}\r\n        />\r\n      )}\r\n      {!fullScreen && (\r\n        <div\r\n          className=\"resizer resizer-se\"\r\n          onMouseDown={(e) => beginResize(e, \"se\")}\r\n          role=\"button\"\r\n          tabIndex={0}\r\n          aria-label=\"Resize south-east\"\r\n          onKeyDown={(e) => handleKeyResize(e, \"se\")}\r\n        />\r\n      )}\r\n      {/* Bottom edge handle for easy vertical stretching */}\r\n      {!fullScreen && (\r\n        <div\r\n          className=\"resizer-edge resizer-s\"\r\n          onMouseDown={(e) => beginResize(e, \"s\")}\r\n          role=\"button\"\r\n          tabIndex={0}\r\n          aria-label=\"Resize south\"\r\n          onKeyDown={(e) => handleKeyResize(e, \"s\")}\r\n        />\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n","import React, { useEffect, useState } from 'react';\r\n\r\nexport default function InstallAppButton() {\r\n  const [deferredPrompt, setDeferredPrompt] = useState<any | null>(null);\r\n\r\n  useEffect(() => {\r\n    try {\r\n      const handler = (e: any) => {\r\n        e.preventDefault();\r\n        setDeferredPrompt(e);\r\n      };\r\n      window.addEventListener('beforeinstallprompt', handler as EventListener);\r\n      return () => window.removeEventListener('beforeinstallprompt', handler as EventListener);\r\n    } catch (e) {\r\n      // ignore when running in SSR or test environment\r\n    }\r\n  }, []);\r\n\r\n  async function handleInstall() {\r\n    if (!deferredPrompt) {\r\n      // No PWA install available; instruct user to use native Add to Home Screen\r\n      alert('Open this site in your browser and use \"Add to Home Screen\" from the share menu (iOS) or use the browser install prompt (Android/Chrome).');\r\n      return;\r\n    }\r\n    try {\r\n      deferredPrompt.prompt();\r\n      const choice = await deferredPrompt.userChoice;\r\n      if (choice && choice.outcome === 'accepted') {\r\n        setDeferredPrompt(null);\r\n      }\r\n    } catch (e) {\r\n      console.warn('install failed', e);\r\n    }\r\n  }\r\n\r\n  // Hide the button when not available\r\n  if (!deferredPrompt) return null;\r\n  return (\r\n    <button className=\"rounded bg-violet-600 text-white px-2 py-1\" onClick={() => handleInstall()}>\r\n      Install App\r\n    </button>\r\n  );\r\n}\r\n","import React, { useState } from \"react\";\r\nimport ResizableModal from \"./ui/ResizableModal\";\r\nimport InstallAppButton from \"./InstallAppButton\";\r\n\r\nexport default function Footer() {\r\n  const [show, setShow] = useState(false);\r\n  const year = new Date().getFullYear();\r\n  return (\r\n    <>\r\n      <div className=\"w-full text-center text-xs text-gray-500 py-2 select-none\">\r\n         {year} Nine Dart Nation {\" \"}\r\n        <button className=\"underline\" onClick={() => setShow(true)}>\r\n          Legal Notice\r\n        </button>\r\n        {/* Small install CTA shown only when browser supplies the 'beforeinstallprompt' event */}\r\n        <span className=\"ml-3 inline-block align-middle\">\r\n          <InstallAppButton />\r\n        </span>\r\n      </div>\r\n      {show ? (\r\n        <ResizableModal\r\n          storageKey=\"ndn:modal:legal\"\r\n          className=\"w-[640px]\"\r\n          defaultWidth={640}\r\n          defaultHeight={420}\r\n          minWidth={420}\r\n          minHeight={220}\r\n          initialFitHeight\r\n        >\r\n          <div className=\"p-4 space-y-3\">\r\n            <div className=\"text-lg font-semibold\">\r\n              Privacy & Copyright Notice\r\n            </div>\r\n            <div className=\"text-sm\"> IMPORTANT LEGAL NOTICE</div>\r\n            <div className=\"text-sm\">\r\n              Copyright Protection: All code, assets, and intellectual property\r\n              in Nine Dart Nation are protected by copyright law. Unauthorized\r\n              copying, modification, or distribution of this software is\r\n              strictly prohibited.\r\n            </div>\r\n            <div className=\"text-sm\">\r\n              Legal Consequences: Any attempt to edit, reverse-engineer, or\r\n              redistribute this code will result in immediate legal action,\r\n              including but not limited to copyright infringement lawsuits and\r\n              potential criminal charges.\r\n            </div>\r\n            <div className=\"text-sm\">\r\n              Privacy: Your personal data and gameplay information are\r\n              protected. Any unauthorized access or data collection violates\r\n              privacy laws and will be prosecuted to the full extent of the law.\r\n            </div>\r\n            <div className=\"flex items-center gap-2 mt-3\">\r\n              <button className=\"btn\" onClick={() => setShow(false)}>\r\n                Close\r\n              </button>\r\n            </div>\r\n          </div>\r\n        </ResizableModal>\r\n      ) : null}\r\n    </>\r\n  );\r\n}\r\n","import React, { useEffect, useRef, useState, Suspense } from \"react\";\r\nimport { Sidebar, TabKey } from \"./components/Sidebar\";\r\nconst Home = React.lazy(() => import(\"./components/Home\"));\r\nimport ScrollFade from \"./components/ScrollFade\";\r\nimport Calibrator from \"./components/Calibrator\";\r\nconst OfflinePlay = React.lazy(() => import(\"./components/OfflinePlay\"));\r\nconst Friends = React.lazy(() => import(\"./components/Friends\"));\r\nimport Toaster from \"./components/Toaster\";\r\nimport AdminDashboard from \"./components/AdminDashboard\";\r\nimport SettingsPanel from \"./components/SettingsPanel\";\r\nimport Auth from \"./components/Auth\";\r\nimport { ThemeProvider } from \"./components/ThemeContext\";\r\nimport { Bell } from \"lucide-react\";\r\nimport { useWS } from \"./components/WSProvider\";\r\nimport StatusDot from \"./components/ui/StatusDot\";\r\nimport { getRollingAvg, getAllTimeAvg } from \"./store/profileStats\";\r\nimport { useUserSettings } from \"./store/userSettings\";\r\nimport { useCalibration } from \"./store/calibration\";\r\nimport \"./styles/premium.css\";\r\nconst OnlinePlay = React.lazy(() => import(\"./components/OnlinePlay.clean\"));\r\nconst StatsPanel = React.lazy(() => import(\"./components/StatsPanel\"));\r\nconst Tournaments = React.lazy(() => import(\"./components/Tournaments\"));\r\nconst AdminAccess = React.lazy(() => import(\"./components/AdminAccess\"));\r\n// AdminAccess already imported above\r\nimport Drawer from \"./components/ui/Drawer\";\r\nconst OpsDashboard = React.lazy(() => import(\"./components/OpsDashboard\"));\r\nimport HelpAssistant from \"./components/HelpAssistant\";\r\nimport GlobalCameraLogger from \"./components/GlobalCameraLogger\";\r\nimport GlobalPhoneVideoSink from \"./components/GlobalPhoneVideoSink\";\r\nimport CameraStatusBadge from \"./components/CameraStatusBadge\";\r\nimport InstallPicker from \"./components/InstallPicker\";\r\nimport AddToHomeButton from \"./components/AddToHomeButton\";\r\nimport Footer from \"./components/Footer\";\r\n\r\nexport default function App() {\r\n  const appRef = useRef<HTMLDivElement | null>(null);\r\n  const [avatar, setAvatar] = useState<string>(\"\");\r\n  const [isFullscreen, setIsFullscreen] = useState(false);\r\n  const ws = (() => {\r\n    try {\r\n      return useWS();\r\n    } catch {\r\n      return null;\r\n    }\r\n  })();\r\n  const [tab, setTab] = useState<TabKey>(\"score\");\r\n  const [isMobile, setIsMobile] = useState<boolean>(false);\r\n  const [navOpen, setNavOpen] = useState<boolean>(false);\r\n  const [user, setUser] = useState<any>(null);\r\n  // Use this helper to set user without losing previously fetched subscription data\r\n  // This avoids toggles/flicker in the UI during partial user refreshes\r\n  function setUserWithMerge(next: any) {\r\n    if (!next) {\r\n      setUser(next);\r\n      return;\r\n    }\r\n    setUser((prev: any) => {\r\n      const merged = { ...prev, ...next };\r\n      if (prev?.subscription && !next?.subscription) merged.subscription = prev.subscription;\r\n      if (next?.subscription) merged.subscription = next.subscription;\r\n      // Keep fullAccess aligned with subscription unless explicitly provided\r\n      merged.fullAccess = !!(merged.subscription?.fullAccess || next?.fullAccess || merged.fullAccess);\r\n      return merged;\r\n    });\r\n  }\r\n  const MINIMAL_UI =\r\n    ((import.meta as any).env?.VITE_MINIMAL_AFTER_LOGIN || \"\").toString() ===\r\n    \"1\";\r\n  const [minimalUI, setMinimalUI] = useState<boolean>(false);\r\n  const [allTimeAvg, setAllTimeAvg] = useState<number>(0);\r\n  const { avgMode } = useUserSettings();\r\n  const { H: calibH, locked: calibLocked, errorPx } = useCalibration();\r\n\r\n  // Restore user from token on mount\r\n  useEffect(() => {\r\n    if (user && MINIMAL_UI) {\r\n      setMinimalUI(true);\r\n      const timer = setTimeout(() => setMinimalUI(false), 1500); // Delay heavy component mount\r\n      return () => clearTimeout(timer);\r\n    }\r\n    const token = localStorage.getItem(\"authToken\");\r\n    if (token) {\r\n      // Validate token with server\r\n      const API_URL = (import.meta as any).env?.VITE_API_URL || \"\";\r\n      fetch(`${API_URL}/api/auth/me`, {\r\n        headers: { Authorization: `Bearer ${token}` },\r\n      })\r\n        .then((res) => res.json())\r\n        .then((data) => {\r\n          if (data?.user) {\r\n            setUserWithMerge(data.user);\r\n            try {\r\n              const cached = localStorage.getItem(`ndn:subscription:${data.user.email}`);\r\n              if (cached) setUserWithMerge({ ...data.user, subscription: JSON.parse(cached) });\r\n            } catch (e) {}\r\n            fetchSubscription(data.user);\r\n          } else {\r\n            // Token invalid, remove it\r\n            localStorage.removeItem(\"authToken\");\r\n          }\r\n        })\r\n        .catch(() => {\r\n          // Network error, keep token for offline retry\r\n        });\r\n    }\r\n  }, [MINIMAL_UI, user]);\r\n\r\n  useEffect(() => {\r\n    const onLogout = () => {\r\n      try {\r\n        localStorage.removeItem(\"mockUser\");\r\n        localStorage.removeItem(\"authToken\");\r\n        if (user?.email) localStorage.removeItem(`ndn:subscription:${user.email}`);\r\n  } catch (e) {}\r\n      setUser(null);\r\n      setTab(\"score\");\r\n    };\r\n    window.addEventListener(\"ndn:logout\" as any, onLogout as any);\r\n    return () =>\r\n      window.removeEventListener(\"ndn:logout\" as any, onLogout as any);\r\n  }, []);\r\n  // Refresh all-time avg when user changes or stats update\r\n  useEffect(() => {\r\n    if (!user?.username) return;\r\n    const refresh = () =>\r\n      setAllTimeAvg(\r\n        avgMode === \"24h\"\r\n          ? getRollingAvg(user.username)\r\n          : getAllTimeAvg(user.username),\r\n      );\r\n    refresh();\r\n    const onUpdate = () => refresh();\r\n    window.addEventListener(\"ndn:stats-updated\", onUpdate as any);\r\n    return () =>\r\n      window.removeEventListener(\"ndn:stats-updated\", onUpdate as any);\r\n  }, [user?.username, avgMode]);\r\n\r\n  // Load avatar from localStorage when user changes\r\n  useEffect(() => {\r\n    if (!user?.username) {\r\n      setAvatar(\"\");\r\n      return;\r\n    }\r\n    const storedAvatar = localStorage.getItem(\r\n      `ndn:bio:profilePhoto:${user.username}`,\r\n    );\r\n    setAvatar(storedAvatar || \"\");\r\n  }, [user?.username]);\r\n\r\n  // Listen for avatar updates from SettingsPanel\r\n  useEffect(() => {\r\n    const handleStorageChange = (e: StorageEvent) => {\r\n      if (\r\n        e.key?.startsWith(\"ndn:bio:profilePhoto:\") &&\r\n        user?.username &&\r\n        e.key.endsWith(user.username)\r\n      ) {\r\n        setAvatar(e.newValue || \"\");\r\n      }\r\n    };\r\n    const handleAvatarUpdate = (e: any) => {\r\n      // Check if this update is for the current user\r\n      if (e.detail?.username === user?.username) {\r\n        setAvatar(e.detail?.avatar || \"\");\r\n      }\r\n      // Also check localStorage as backup for any avatar update\r\n      if (user?.username) {\r\n        const storedAvatar = localStorage.getItem(\r\n          `ndn:bio:profilePhoto:${user.username}`,\r\n        );\r\n        setAvatar(storedAvatar || \"\");\r\n      }\r\n    };\r\n    // Also check localStorage when window becomes visible (user switches tabs)\r\n    const handleVisibilityChange = () => {\r\n      if (!document.hidden && user?.username) {\r\n        const storedAvatar = localStorage.getItem(\r\n          `ndn:bio:profilePhoto:${user.username}`,\r\n        );\r\n        setAvatar(storedAvatar || \"\");\r\n      }\r\n    };\r\n\r\n    // Check localStorage every 2 seconds as a fallback\r\n    const checkAvatarInterval = setInterval(() => {\r\n      if (user?.username) {\r\n        const storedAvatar = localStorage.getItem(\r\n          `ndn:bio:profilePhoto:${user.username}`,\r\n        );\r\n        if (storedAvatar && storedAvatar !== avatar) {\r\n          setAvatar(storedAvatar);\r\n        }\r\n      }\r\n    }, 2000);\r\n\r\n    window.addEventListener(\"storage\", handleStorageChange);\r\n    window.addEventListener(\r\n      \"ndn:avatar-updated\" as any,\r\n      handleAvatarUpdate as any,\r\n    );\r\n    document.addEventListener(\"visibilitychange\", handleVisibilityChange);\r\n    return () => {\r\n      window.removeEventListener(\"storage\", handleStorageChange);\r\n      window.removeEventListener(\r\n        \"ndn:avatar-updated\" as any,\r\n        handleAvatarUpdate as any,\r\n      );\r\n      document.removeEventListener(\"visibilitychange\", handleVisibilityChange);\r\n      clearInterval(checkAvatarInterval);\r\n    };\r\n  }, [user?.username, avatar]);\r\n\r\n  // Handle payment success for username change\r\n  useEffect(() => {\r\n    const urlParams = new URLSearchParams(window.location.search);\r\n    const paid = urlParams.get(\"paid\");\r\n    const usernameChange = urlParams.get(\"username-change\");\r\n    if (\r\n      paid === \"1\" ||\r\n      paid === \"username-change\" ||\r\n      usernameChange === \"free\"\r\n    ) {\r\n      const pendingUsername = localStorage.getItem(\"pendingUsernameChange\");\r\n      if (pendingUsername && user?.email) {\r\n        // Call the change username API\r\n        const API_URL = (import.meta as any).env?.VITE_API_URL || \"\";\r\n        fetch(`${API_URL}/api/change-username`, {\r\n          method: \"POST\",\r\n          headers: { \"Content-Type\": \"application/json\" },\r\n          body: JSON.stringify({\r\n            email: user.email,\r\n            newUsername: pendingUsername,\r\n          }),\r\n        })\r\n          .then((res) => res.json())\r\n          .then((data) => {\r\n            if (data.ok) {\r\n              alert(\"Username changed successfully!\");\r\n              localStorage.removeItem(\"pendingUsernameChange\");\r\n              // Update user data and token\r\n              if (data.token) {\r\n                localStorage.setItem(\"authToken\", data.token);\r\n              }\r\n              if (data.user) {\r\n                setUserWithMerge(data.user);\r\n              }\r\n              // Clean up URL\r\n              window.history.replaceState(\r\n                {},\r\n                document.title,\r\n                window.location.pathname,\r\n              );\r\n            } else {\r\n              alert(\r\n                \"Failed to change username: \" + (data.error || \"Unknown error\"),\r\n              );\r\n            }\r\n          })\r\n          .catch(() => {\r\n            alert(\"Network error while changing username\");\r\n          });\r\n      }\r\n    }\r\n  }, [user?.email]);\r\n\r\n  // Keep full-screen state in sync when the user enters/exits full screen mode.\r\n  useEffect(() => {\r\n    const onFullscreenChange = () =>\r\n      setIsFullscreen(!!document.fullscreenElement);\r\n    document.addEventListener(\"fullscreenchange\", onFullscreenChange);\r\n    // initialize\r\n    setIsFullscreen(!!document.fullscreenElement);\r\n    return () =>\r\n      document.removeEventListener(\"fullscreenchange\", onFullscreenChange);\r\n  }, []);\r\n\r\n  // Handle payment success for premium subscription\r\n  useEffect(() => {\r\n    const urlParams = new URLSearchParams(window.location.search);\r\n    const subscription = urlParams.get(\"subscription\");\r\n    if (subscription === \"success\" && user?.email) {\r\n      // Refresh user data to get updated subscription status\r\n      const API_URL = (import.meta as any).env?.VITE_API_URL || \"\";\r\n      fetch(`${API_URL}/api/auth/me`, {\r\n        headers: {\r\n          Authorization: `Bearer ${localStorage.getItem(\"authToken\")}`,\r\n        },\r\n      })\r\n        .then((res) => res.json())\r\n        .then((data) => {\r\n          if (data?.user) {\r\n            setUserWithMerge(data.user);\r\n            alert(\"Premium subscription activated successfully!\");\r\n            // Clean up URL\r\n            window.history.replaceState(\r\n              {},\r\n              document.title,\r\n              window.location.pathname,\r\n            );\r\n          }\r\n        })\r\n        .catch(() => {\r\n          alert(\r\n            \"Subscription activated, but failed to refresh user data. Please refresh the page.\",\r\n          );\r\n        });\r\n    }\r\n  }, [user?.email]);\r\n\r\n  // Detect mobile/tablet layout via comprehensive device detection\r\n  useEffect(() => {\r\n    const update = () => {\r\n      const width = window.innerWidth;\r\n\r\n      // Comprehensive mobile/tablet detection\r\n      const mqMobile = window.matchMedia(\"(max-width: 768px)\").matches;\r\n      const mqTablet = window.matchMedia(\r\n        \"(max-width: 1024px) and (min-width: 769px)\",\r\n      ).matches;\r\n      const uaMobile =\r\n        /Mobi|Android|iPhone|iPad|iPod|Mobile|BlackBerry|IEMobile|Opera Mini|Windows Phone/i.test(\r\n          navigator.userAgent || \"\",\r\n        );\r\n      const uaTablet =\r\n        /iPad|Android(?=.*\\bMobile\\b)|Tablet|PlayBook|Silk/i.test(\r\n          navigator.userAgent || \"\",\r\n        );\r\n      const touchScreen =\r\n        \"ontouchstart\" in window || navigator.maxTouchPoints > 0;\r\n  const verySmallScreen = width < 769;\r\n\r\n      // Determine device type\r\n      const isTablet =\r\n        (mqTablet && touchScreen) ||\r\n        uaTablet ||\r\n        (width >= 769 && width <= 1024 && touchScreen);\r\n      const isMobile =\r\n        mqMobile || uaMobile || verySmallScreen || (width < 769 && touchScreen);\r\n      const isMobileDevice = isMobile || isTablet;\r\n\r\n      setIsMobile(isMobileDevice);\r\n    };\r\n    update();\r\n    window.addEventListener(\"resize\", update);\r\n    window.addEventListener(\"orientationchange\", update);\r\n\r\n    const mqMobile = window.matchMedia(\"(max-width: 768px)\");\r\n    const mqTablet = window.matchMedia(\r\n      \"(max-width: 1024px) and (min-width: 769px)\",\r\n    );\r\n\r\n    try {\r\n      mqMobile.addEventListener(\"change\", update);\r\n      mqTablet.addEventListener(\"change\", update);\r\n  } catch (e) {}\r\n\r\n    return () => {\r\n      window.removeEventListener(\"resize\", update);\r\n      window.removeEventListener(\"orientationchange\", update);\r\n      try {\r\n        mqMobile.removeEventListener(\"change\", update);\r\n        mqTablet.removeEventListener(\"change\", update);\r\n  } catch (e) {}\r\n    };\r\n  }, []);\r\n\r\n  // Global logout handler: return to sign-in screen and clear minimal local user context\r\n  useEffect(() => {\r\n    const onLogout = () => {\r\n      try {\r\n        // Clear any lightweight local flags (keep stats unless explicitly reset)\r\n        localStorage.removeItem(\"ndn:avatar\");\r\n        if (user?.email) localStorage.removeItem(`ndn:subscription:${user.email}`);\r\n  } catch (e) {}\r\n      setUser(null);\r\n      setTab(\"score\");\r\n    };\r\n    window.addEventListener(\"ndn:logout\" as any, onLogout as any);\r\n    return () =>\r\n      window.removeEventListener(\"ndn:logout\" as any, onLogout as any);\r\n  }, []);\r\n\r\n  // Apply username changes from Settings globally and propagate via WS presence\r\n  useEffect(() => {\r\n    const onName = (e: any) => {\r\n      try {\r\n        const next = String(e?.detail?.username || \"\").trim();\r\n        if (!next) return;\r\n        setUser((prev: any) => {\r\n          const u = prev ? { ...prev, username: next } : prev;\r\n          return u;\r\n        });\r\n        // Recompute name color on next effect pass based on new username/avatar\r\n        // Send presence update so friends/lobby reflect the new name\r\n        try {\r\n          const email = (user?.email || \"\").toLowerCase();\r\n          if (ws && next && email)\r\n            ws.send({ type: \"presence\", username: next, email });\r\n  } catch (e) {}\r\n  } catch (e) {}\r\n    };\r\n    window.addEventListener(\"ndn:username-changed\" as any, onName as any);\r\n    return () =>\r\n      window.removeEventListener(\"ndn:username-changed\" as any, onName as any);\r\n  }, [ws, user?.email]);\r\n\r\n  // Handle tab changes from Home component quick access pills\r\n  useEffect(() => {\r\n    const onTabChange = (e: any) => {\r\n      try {\r\n        const tab = String(e?.detail?.tab || \"\").trim();\r\n        if (\r\n          tab &&\r\n          [\r\n            \"score\",\r\n            \"offline\",\r\n            \"online\",\r\n            \"stats\",\r\n            \"settings\",\r\n            \"admin\",\r\n            \"tournaments\",\r\n            \"friends\",\r\n          ].includes(tab)\r\n        ) {\r\n          setTab(tab as TabKey);\r\n        }\r\n  } catch (e) {}\r\n    };\r\n    window.addEventListener(\"ndn:change-tab\" as any, onTabChange as any);\r\n    return () =>\r\n      window.removeEventListener(\"ndn:change-tab\" as any, onTabChange as any);\r\n  }, []);\r\n\r\n  async function fetchSubscription(u: any) {\r\n    try {\r\n      const q = u?.email ? `?email=${encodeURIComponent(u.email)}` : \"\";\r\n      const res = await fetch(\"/api/subscription\" + q);\r\n      if (!res.ok) return;\r\n      const data = await res.json();\r\n      // Keep the full user object but attach the subscription so other components\r\n      // can make decisions based on more detailed subscription metadata (expiresAt, source, status).\r\n      setUserWithMerge({ ...u, fullAccess: !!data?.fullAccess, subscription: data });\r\n      try {\r\n        if (u?.email) localStorage.setItem(`ndn:subscription:${u.email}`, JSON.stringify(data));\r\n      } catch {}\r\n  } catch (e) {}\r\n  }\r\n\r\n  // Header notification state: show an alert if subscription is expiring in <= 3 days, or expired\r\n  const [showSubscriptionsBell, setShowSubscriptionsBell] = useState(false);\r\n  const [notificationsOpen, setNotificationsOpen] = useState(false);\r\n  const [siteNotifications, setSiteNotifications] = useState<any[]>([]);\r\n\r\n  useEffect(() => {\r\n    if (!user?.subscription) {\r\n      setShowSubscriptionsBell(false);\r\n      return;\r\n    }\r\n    const sub = user.subscription as any;\r\n    const now = Date.now();\r\n    let expiresAt: number | null = null;\r\n    if (sub?.expiresAt) {\r\n      expiresAt = typeof sub.expiresAt === 'string' ? Date.parse(sub.expiresAt) : Number(sub.expiresAt);\r\n    }\r\n    // Consider this expiring soon when it's within 3 days (259200000 ms)\r\n    const THREE_DAYS_MS = 3 * 24 * 60 * 60 * 1000;\r\n    if (expiresAt && expiresAt > now && expiresAt - now <= THREE_DAYS_MS) {\r\n      setShowSubscriptionsBell(true);\r\n      return;\r\n    }\r\n    // If the subscription is expired and fullAccess is false, prompt to buy\r\n    if (expiresAt && expiresAt <= now && !user?.fullAccess) {\r\n      setShowSubscriptionsBell(true);\r\n      return;\r\n    }\r\n    // For stripe subscriptions, a 'status' === 'active' means no bell, else show if status !== 'active'\r\n    if (sub?.source === 'stripe' && sub?.status && sub.status !== 'active') {\r\n      setShowSubscriptionsBell(true);\r\n      return;\r\n    }\r\n    setShowSubscriptionsBell(false);\r\n  }, [user?.subscription, user?.fullAccess]);\r\n\r\n  // Fetch site notifications & keep in sync\r\n  useEffect(() => {\r\n    if (!user?.email) return;\r\n    let mounted = true;\r\n    async function fetchNotifs() {\r\n      try {\r\n        const token = localStorage.getItem('authToken');\r\n        const headers: any = { };\r\n        if (token) headers.Authorization = `Bearer ${token}`;\r\n        const res = await fetch(`/api/notifications?email=${encodeURIComponent(user.email)}`, { headers });\r\n        if (!res.ok) return;\r\n        const data = await res.json();\r\n        if (mounted) setSiteNotifications(data || []);\r\n      } catch (err) {\r\n        // noop\r\n      }\r\n    }\r\n    fetchNotifs();\r\n    const int = setInterval(fetchNotifs, 30000);\r\n    return () => { mounted = false; clearInterval(int); };\r\n  }, [user?.email]);\r\n\r\n  // If subscription is expiring soon or expired, write a persistent notification server-side\r\n  useEffect(() => {\r\n    if (!user?.subscription || !user?.email) return;\r\n    const sub = user.subscription as any;\r\n    const now = Date.now();\r\n    let expiresAt: number | null = null;\r\n    if (sub?.expiresAt) expiresAt = typeof sub.expiresAt === 'string' ? Date.parse(sub.expiresAt) : Number(sub.expiresAt);\r\n    const THREE_DAYS_MS = 3 * 24 * 60 * 60 * 1000;\r\n    async function addSubscriptionNotification(type: string, message: string) {\r\n      try {\r\n        const token = localStorage.getItem('authToken');\r\n        const headers: any = { 'Content-Type': 'application/json' };\r\n        if (token) headers.Authorization = `Bearer ${token}`;\r\n        await fetch('/api/notifications', {\r\n          method: 'POST',\r\n          headers,\r\n          body: JSON.stringify({ email: user.email, message, type }),\r\n        });\r\n  } catch (e) {}\r\n    }\r\n    if (expiresAt && expiresAt > now && expiresAt - now <= THREE_DAYS_MS) {\r\n      addSubscriptionNotification('sub_expiring', `Your premium subscription expires in ${Math.ceil((expiresAt - now) / (24*60*60*1000))} day(s)`);\r\n      return;\r\n    }\r\n    if (expiresAt && expiresAt <= now && !user?.fullAccess) {\r\n      addSubscriptionNotification('sub_expired', 'Your premium subscription has ended');\r\n      return;\r\n    }\r\n  }, [user?.email, user?.subscription, user?.fullAccess]);\r\n\r\n  if (!user) {\r\n    return (\r\n      <Auth\r\n        onAuth={(u: any) => {\r\n          try {\r\n            const cached = localStorage.getItem(`ndn:subscription:${u.email}`);\r\n            if (cached) setUserWithMerge({ ...u, subscription: JSON.parse(cached) });\r\n            else setUserWithMerge(u);\r\n          } catch {\r\n            setUserWithMerge(u);\r\n          }\r\n          fetchSubscription(u);\r\n        }}\r\n      />\r\n    );\r\n  }\r\n  const fallbackAvatar = `https://ui-avatars.com/api/?name=${encodeURIComponent(user.username || \"NDN\")}&background=8F43EE&color=fff&bold=true&rounded=true&size=64`;\r\n  return (\r\n    <ThemeProvider>\r\n      <div\r\n        ref={appRef}\r\n        className={`${user?.fullAccess ? \"premium-body\" : \"\"} h-screen overflow-hidden pt-1 pb-0 px-1 xs:pt-2 xs:pb-0 xs:px-2 sm:pt-3 sm:pb-0 sm:px-3 md:pt-4 md:pb-0 md:px-4`}\r\n      >\r\n        <Toaster />\r\n        <div className=\"max-w-[1400px] mx-auto grid grid-cols-1 lg:grid-cols-[auto,1fr] gap-2 xs:gap-3 sm:gap-4 h-full overflow-hidden\">\r\n          {/* Desktop sidebar; hidden on mobile/tablet */}\r\n          {!isMobile && (\r\n            <div className=\"relative hidden lg:block\" style={{ width: 240 }}>\r\n              <Sidebar\r\n                active={tab}\r\n                onChange={(k) => {\r\n                  setTab(k);\r\n                }}\r\n                user={user}\r\n              />\r\n            </div>\r\n          )}\r\n          {/* Wrap header + scroller in a column so header stays static and only content scrolls below it */}\r\n          <div className=\"flex flex-col h-full overflow-hidden\">\r\n            <div className=\"pt-1 xs:pt-2\">\r\n              <header\r\n                id=\"ndn-header\"\r\n                className={`header glass flex-col xs:flex-col sm:flex-row gap-2 xs:gap-2 sm:gap-3`}\r\n              >\r\n                {/* Left: Brand */}\r\n                <div className=\"flex items-center gap-2 order-1\">\r\n                  <h1>\r\n                    <button\r\n                      type=\"button\"\r\n                      className=\"text-lg xs:text-xl sm:text-xl md:text-2xl font-bold text-brand-700 whitespace-nowrap cursor-pointer select-none\"\r\n                      onClick={() => {\r\n                        setTab(\"score\");\r\n                      }}\r\n                      title={\"Go Home\"}\r\n                    >\r\n                      NINE-DART-NATION \r\n                    </button>\r\n                  </h1>\r\n                </div>\r\n                {/* Middle: Welcome band (full width on mobile) */}\r\n                <div className=\"order-3 xs:order-3 sm:order-2 w-full sm:w-auto flex-1 flex flex-col items-center justify-center text-center sm:text-left !text-black\">\r\n                  <span\r\n                    className=\"text-sm xs:text-base sm:text-base md:text-lg font-semibold flex items-center gap-2 max-w-full truncate !text-black\"\r\n                    style={{ color: \"#000000\", WebkitTextFillColor: \"#000000\" }}\r\n                  >\r\n                    <span className=\"hidden xs:inline !text-black\">\r\n                      Welcome\r\n                    </span>\r\n                    <img\r\n                      src={avatar || fallbackAvatar}\r\n                      alt=\"avatar\"\r\n                      className=\"w-5 h-5 xs:w-6 xs:h-6 sm:w-6 sm:h-6 md:w-7 md:h-7 rounded-full ring-2 ring-white/20\"\r\n                    />\r\n                    <span\r\n                      className=\"truncate !text-black\"\r\n                      style={{\r\n                        color: \"#000000\",\r\n                        WebkitTextFillColor: \"#000000\",\r\n                      }}\r\n                    >\r\n                      {user.username}\r\n                    </span>\r\n                  </span>\r\n                  <span\r\n                    className=\"hidden xs:inline text-xs xs:text-xs sm:text-xs md:text-sm !text-black\"\r\n                    style={{ color: \"#000000\", WebkitTextFillColor: \"#000000\" }}\r\n                  >\r\n                    All-time 3-dart avg:{\" \"}\r\n                    <span\r\n                      className=\"font-semibold !text-black\"\r\n                      style={{\r\n                        color: \"#000000\",\r\n                        WebkitTextFillColor: \"#000000\",\r\n                      }}\r\n                    >\r\n                      {allTimeAvg.toFixed(2)}\r\n                    </span>\r\n                  </span>\r\n                  {isMobile && (\r\n                    <button\r\n                      className=\"btn px-3 py-1 xs:px-3 xs:py-1 sm:px-3 sm:py-1 mt-1 text-sm xs:text-sm\"\r\n                      aria-label=\"Open navigation\"\r\n                      onClick={() => setNavOpen(true)}\r\n                    >\r\n                       Menu\r\n                    </button>\r\n                  )}\r\n                </div>\r\n                {/* Calibration Status - visible across all tabs */}\r\n                {calibLocked && calibH && (\r\n                  <button\r\n                    onClick={() => setTab(\"calibrate\")}\r\n                    className=\"order-4 sm:order-4 md:order-3 px-3 py-1 text-xs sm:text-sm rounded-full bg-emerald-500/20 hover:bg-emerald-500/30 text-emerald-100 border border-emerald-400/50 transition-colors\"\r\n                    title=\"Click to adjust calibration\"\r\n                  >\r\n                     Calibration Active{\" \"}\r\n                    {errorPx != null && ` ${errorPx.toFixed(1)}px`}\r\n                  </button>\r\n                )}\r\n                {/* Right: Status + Actions */}\r\n                <div className=\"order-2 md:order-3 ml-0 md:ml-auto flex items-center gap-2 flex-wrap\">\r\n                  <button\r\n                    className=\"px-3 py-1 text-sm rounded-full bg-white/5 hover:bg-white/10 border border-white/10\"\r\n                    onClick={() => {\r\n                      const el = appRef.current;\r\n                      if (!el) return;\r\n                      if (!document.fullscreenElement)\r\n                        el.requestFullscreen().catch(() => {});\r\n                      else document.exitFullscreen().catch(() => {});\r\n                    }}\r\n                    title={\r\n                      isFullscreen ? \"Exit Full Screen\" : \"Enter Full Screen\"\r\n                    }\r\n                  >\r\n                    {isFullscreen ? \"Exit Full Screen\" : \"Full Screen\"}\r\n                  </button>\r\n                  {tab === \"online\" && (\r\n                    <button\r\n                      className=\"text-[10px] md:text-xs px-3 py-1 rounded-full bg-indigo-500/25 text-indigo-100 border border-indigo-400/40 hover:bg-indigo-500/40\"\r\n                      title=\"Open a simulated online match\"\r\n                      onClick={() => {\r\n                        setTimeout(() => {\r\n                          try {\r\n                            window.dispatchEvent(\r\n                              new CustomEvent(\"ndn:online-match-demo\", {\r\n                                detail: { game: \"X01\", start: 501 },\r\n                              }),\r\n                            );\r\n                          } catch (e) {}\r\n                        }, 40);\r\n                      }}\r\n                    >\r\n                      ONLINE DEMO\r\n                    </button>\r\n                  )}\r\n                  {/* Camera status badge */}\r\n                  <CameraStatusBadge />\r\n                  \r\n                  {ws ? (\r\n                    <span className=\"ml-0 md:ml-2\">\r\n                      <StatusDot status={ws.status} />\r\n                    </span>\r\n                  ) : null}\r\n                  {/* Subscription expiration / warning bell - move after WS status */}\r\n                  {/* (Notifications are positioned after StatusDot to appear to the right of the connected badge) */}\r\n                  {(siteNotifications.length > 0 || showSubscriptionsBell) && (\r\n                    <>\r\n                      <div className=\"relative ml-2 flex items-center space-x-2\">\r\n                      <button\r\n                        className=\"px-2 py-1 text-sm rounded-full bg-white/5 hover:bg-white/10 border border-white/10 flex items-center gap-2\"\r\n                        onClick={() => setNotificationsOpen((s) => !s)}\r\n                        aria-label=\"View notifications\"\r\n                        title=\"Notifications\"\r\n                      >\r\n                        <Bell className=\"w-5 h-5 text-amber-400\" />\r\n                        {/* Unread count */}\r\n                        {siteNotifications.filter(n => !n.read).length > 0 && (\r\n                          <span className=\"inline-flex items-center justify-center w-5 h-5 text-xs font-bold text-white bg-rose-500 rounded-full\">{siteNotifications.filter(n => !n.read).length > 9 ? '9+' : siteNotifications.filter(n => !n.read).length}</span>\r\n                        )}\r\n                      </button>\r\n                      {notificationsOpen && (\r\n                        <div className=\"absolute right-0 mt-2 w-80 card p-3 z-50\">\r\n                          <div className=\"font-semibold mb-2\">Notifications</div>\r\n                          <div className=\"space-y-2\">\r\n                            {siteNotifications.length === 0 && (\r\n                              <div className=\"text-sm opacity-70\">No notifications</div>\r\n                            )}\r\n                            {siteNotifications.map((n) => (\r\n                              <div key={n.id} className={`p-2 rounded ${n.type?.startsWith('sub') ? 'bg-amber-900/10' : 'bg-black/10'}`}>\r\n                                <div className=\"text-sm mb-1\">{n.message}</div>\r\n                                <div className=\"text-xs opacity-60 flex items-center justify-between\">\r\n                                  <span>{new Date(n.createdAt).toLocaleString()}</span>\r\n                                  <div className=\"flex gap-2 items-center\">\r\n                                    {!n.read && (\r\n                                      <button\r\n                                        className=\"text-xs px-2 py-0.5 rounded bg-emerald-600 text-black\"\r\n                                          onClick={async () => {\r\n                                          try {\r\n                                            const btnToken = localStorage.getItem('authToken');\r\n                                            const headers: any = { 'Content-Type': 'application/json' };\r\n                                            if (btnToken) headers.Authorization = `Bearer ${btnToken}`;\r\n                                            await fetch(`/api/notifications/${encodeURIComponent(n.id)}?email=${encodeURIComponent(user.email)}`, { method: 'PATCH', headers, body: JSON.stringify({ read: true }) });\r\n                                            const btnRefetchToken = localStorage.getItem('authToken');\r\n                                            const refetchHeaders: any = {};\r\n                                            if (btnRefetchToken) refetchHeaders.Authorization = `Bearer ${btnRefetchToken}`;\r\n                                            const res = await fetch(`/api/notifications?email=${encodeURIComponent(user.email)}`, { headers: refetchHeaders });\r\n                                            if (res.ok) setSiteNotifications(await res.json());\r\n                                          } catch (e) {}\r\n                                        }}\r\n                                      >\r\n                                        Mark read\r\n                                      </button>\r\n                                    )}\r\n                                    <button\r\n                                      className=\"text-xs px-2 py-0.5 rounded bg-rose-600 text-white\"\r\n                                      onClick={async () => {\r\n                                        try {\r\n                                            const btnDeleteToken = localStorage.getItem('authToken');\r\n                                            const headers: any = {};\r\n                                            if (btnDeleteToken) headers.Authorization = `Bearer ${btnDeleteToken}`;\r\n                                            await fetch(`/api/notifications/${encodeURIComponent(n.id)}?email=${encodeURIComponent(user.email)}`, { method: 'DELETE', headers });\r\n                                          const token = localStorage.getItem('authToken');\r\n                                          const refetchHeaders: any = {};\r\n                                          if (token) refetchHeaders.Authorization = `Bearer ${token}`;\r\n                                          const res = await fetch(`/api/notifications?email=${encodeURIComponent(user.email)}`, { headers: refetchHeaders });\r\n                                          if (res.ok) setSiteNotifications(await res.json());\r\n                                        } catch (e) {}\r\n                                      }}\r\n                                    >\r\n                                      Clear\r\n                                    </button>\r\n                                  </div>\r\n                                </div>\r\n                              </div>\r\n                            ))}\r\n                          </div>\r\n                        </div>\r\n                      )}\r\n                      </div>\r\n                      {/* Add an install picker next to the notifications to allow users to install or download a native build */}\r\n                      <div className=\"hidden sm:flex items-center ml-2 space-x-2\">\r\n                        <AddToHomeButton />\r\n                        <InstallPicker />\r\n                      </div>\r\n                    </>\r\n                  )}\r\n                  {/* Protocol pill removed per request: keep green connected badge only */}\r\n                </div>\r\n              </header>\r\n            </div>\r\n            {/* Mobile drawer navigation */}\r\n            {isMobile && (\r\n              <MobileNav\r\n                open={navOpen}\r\n                onClose={() => setNavOpen(false)}\r\n                active={tab}\r\n                onChange={(k) => {\r\n                  setTab(k);\r\n                  setNavOpen(false);\r\n                }}\r\n                user={user}\r\n              />\r\n            )}\r\n            <main\r\n              id=\"ndn-main-scroll\"\r\n              className=\"space-y-4 flex-1 overflow-y-auto pr-1 flex flex-col\"\r\n            >\r\n              {tab === \"settings\" && (\r\n                <Suspense\r\n                  fallback={<div className=\"p-4\">Loading settings</div>}\r\n                >\r\n                  <ScrollFade className=\"flex-1 min-h-0\">\r\n                    <SettingsPanel user={user} />\r\n                  </ScrollFade>\r\n                </Suspense>\r\n              )}\r\n              {tab === \"score\" && (\r\n                <Suspense fallback={<div className=\"p-4\">Loading home</div>}>\r\n                  <ScrollFade className=\"flex-1 min-h-0\">\r\n                    <Home user={user} />\r\n                  </ScrollFade>\r\n                </Suspense>\r\n              )}\r\n              {tab === \"online\" && (\r\n                <Suspense fallback={<div className=\"p-4\">Loading online</div>}>\r\n                  <ScrollFade className=\"flex-1 min-h-0\">\r\n                    <OnlinePlay user={user} />\r\n                  </ScrollFade>\r\n                </Suspense>\r\n              )}\r\n              {tab === \"offline\" && (\r\n                <Suspense\r\n                  fallback={<div className=\"p-4\">Loading offline</div>}\r\n                >\r\n                  <ScrollFade className=\"flex-1 min-h-0\">\r\n                    <OfflinePlay user={user} />\r\n                  </ScrollFade>\r\n                </Suspense>\r\n              )}\r\n              {/* Always keep Calibrator mounted to preserve phone camera stream, but hide when not active */}\r\n              <div className={tab === \"calibrate\" ? \"\" : \"hidden\"}>\r\n                <ScrollFade>\r\n                  <Calibrator />\r\n                </ScrollFade>\r\n              </div>\r\n              {tab === \"friends\" && (\r\n                <Suspense\r\n                  fallback={<div className=\"p-4\">Loading friends</div>}\r\n                >\r\n                  <ScrollFade className=\"flex-1 min-h-0\">\r\n                    <Friends user={user} />\r\n                  </ScrollFade>\r\n                </Suspense>\r\n              )}\r\n              {tab === \"stats\" && (\r\n                <Suspense fallback={<div className=\"p-4\">Loading stats</div>}>\r\n                  <ScrollFade className=\"flex-1 min-h-0\">\r\n                    <StatsPanel user={user} />\r\n                  </ScrollFade>\r\n                </Suspense>\r\n              )}\r\n              {tab === \"tournaments\" && (\r\n                <Suspense\r\n                  fallback={<div className=\"p-4\">Loading tournaments</div>}\r\n                >\r\n                  <ScrollFade className=\"flex-1 min-h-0\">\r\n                    <Tournaments user={user} />\r\n                  </ScrollFade>\r\n                </Suspense>\r\n              )}\r\n              {tab === \"admin\" && (\r\n                <Suspense fallback={<div className=\"p-4\">Loading admin</div>}>\r\n                  <ScrollFade className=\"flex-1 min-h-0\">\r\n                    <div className=\"flex-1 min-h-0 space-y-6\">\r\n                      <AdminDashboard user={user} />\r\n                      <OpsDashboard user={user} />\r\n                    </div>\r\n                  </ScrollFade>\r\n                </Suspense>\r\n              )}\r\n              {tab === \"fullaccess\" && (\r\n                <Suspense\r\n                  fallback={<div className=\"p-4\">Loading admin access</div>}\r\n                >\r\n                  <ScrollFade className=\"flex-1 min-h-0\">\r\n                    <AdminAccess user={user} />\r\n                  </ScrollFade>\r\n                </Suspense>\r\n              )}\r\n            </main>\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Floating Help Assistant - Always visible */}\r\n      <HelpAssistant />\r\n      {/* App footer with legal notice */}\r\n      <Footer />\r\n      {/* Debug banner removed - not shown to users in production builds */}\r\n      {/* Global camera logger: logs stream lifecycle and video/pc events across site */}\r\n      {!minimalUI && <GlobalCameraLogger />}\r\n      {/* Global phone camera overlay - visibility controlled by store */}\r\n      {/* Keep a hidden global video element alive across navigation */}\r\n      {!minimalUI && <GlobalPhoneVideoSink />}\r\n    </ThemeProvider>\r\n  );\r\n}\r\n\r\n// Lightweight mobile drawer that reuses the same Sidebar\r\nfunction MobileNav({\r\n  open,\r\n  onClose,\r\n  active,\r\n  onChange,\r\n  user,\r\n}: {\r\n  open: boolean;\r\n  onClose: () => void;\r\n  active: TabKey;\r\n  onChange: (k: TabKey) => void;\r\n  user: any;\r\n}) {\r\n  return (\r\n    <Drawer\r\n      open={open}\r\n      onClose={onClose}\r\n      width={320}\r\n      side=\"left\"\r\n      title=\"Navigate\"\r\n    >\r\n      <div className=\"mt-2\">\r\n        <Sidebar\r\n          active={active}\r\n          onChange={onChange}\r\n          user={user}\r\n          className=\"flex relative static max-h-[80vh] w-full\"\r\n        />\r\n      </div>\r\n    </Drawer>\r\n  );\r\n}\r\n","import { useEffect, useState } from \"react\";\r\n\r\nfunction validatePassword(password: string) {\r\n  return (\r\n    password.length >= 10 &&\r\n    /\\d/.test(password) &&\r\n    /[^A-Za-z0-9]/.test(password)\r\n  );\r\n}\r\n\r\nexport default function ResetPassword() {\r\n  const [token, setToken] = useState(\"\");\r\n  const [password, setPassword] = useState(\"\");\r\n  const [confirm, setConfirm] = useState(\"\");\r\n  const [error, setError] = useState(\"\");\r\n  const [success, setSuccess] = useState(\"\");\r\n\r\n  useEffect(() => {\r\n    try {\r\n      const sp = new URLSearchParams(window.location.search);\r\n      const t = sp.get(\"token\") || \"\";\r\n      setToken(t);\r\n    } catch {}\r\n  }, []);\r\n\r\n  async function onSubmit(e: any) {\r\n    e.preventDefault();\r\n    setError(\"\");\r\n    setSuccess(\"\");\r\n    if (!token) {\r\n      setError(\"Missing or invalid reset token.\");\r\n      return;\r\n    }\r\n    if (!password || password !== confirm) {\r\n      setError(\"Passwords do not match.\");\r\n      return;\r\n    }\r\n    if (!validatePassword(password)) {\r\n      setError(\r\n        \"Password must be at least 10 chars and include a number and symbol.\",\r\n      );\r\n      return;\r\n    }\r\n    try {\r\n      const r = await fetch(\"/api/auth/confirm-reset\", {\r\n        method: \"POST\",\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n        body: JSON.stringify({ token, newPassword: password }),\r\n      });\r\n      const j = await r.json();\r\n      if (!j?.ok) throw new Error(j?.error || \"Reset failed\");\r\n      setSuccess(\"Password changed. You can now sign in.\");\r\n    } catch (e: any) {\r\n      setError(e?.message || \"Reset failed\");\r\n    }\r\n  }\r\n\r\n  return (\r\n    <div className=\"min-h-screen flex items-center justify-center relative overflow-hidden\">\r\n      <div className=\"background-animated\" />\r\n      <div className=\"relative z-10 w-full max-w-lg mx-auto p-4\">\r\n        <form className=\"card w-full space-y-4\" onSubmit={onSubmit}>\r\n          <div className=\"flex flex-col items-center justify-center gap-2 mb-2 text-center\">\r\n            <h1 className=\"logo text-center\">Reset your password</h1>\r\n          </div>\r\n          {!token && (\r\n            <div className=\"text-red-400\">\r\n              This reset link is missing a token. Please use the link from your\r\n              email.\r\n            </div>\r\n          )}\r\n          <input\r\n            className=\"input w-full\"\r\n            type=\"password\"\r\n            placeholder=\"New password\"\r\n            value={password}\r\n            onChange={(e) => setPassword(e.target.value)}\r\n            required\r\n          />\r\n          <input\r\n            className=\"input w-full\"\r\n            type=\"password\"\r\n            placeholder=\"Confirm password\"\r\n            value={confirm}\r\n            onChange={(e) => setConfirm(e.target.value)}\r\n            required\r\n          />\r\n          {error && (\r\n            <div className=\"text-red-400 font-semibold text-sm\">{error}</div>\r\n          )}\r\n          {success && (\r\n            <div className=\"text-emerald-400 font-semibold text-sm\">\r\n              {success}\r\n            </div>\r\n          )}\r\n          <button className=\"btn w-full\" type=\"submit\" disabled={!token}>\r\n            Change Password\r\n          </button>\r\n          <a className=\"underline text-sm text-center\" href=\"/\">\r\n            Back to sign in\r\n          </a>\r\n        </form>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n","import { Component, type ReactNode } from \"react\";\r\n\r\nexport default class ErrorBoundary extends Component<\r\n  {\r\n    children: ReactNode;\r\n  },\r\n  { hasError: boolean; message?: string }\r\n> {\r\n  constructor(props: any) {\r\n    super(props);\r\n    this.state = { hasError: false };\r\n  }\r\n  static getDerivedStateFromError(err: any) {\r\n    return { hasError: true, message: String(err?.message || err) };\r\n  }\r\n  componentDidCatch(error: any, info: any) {\r\n    console.error(\"[ErrorBoundary]\", error, info);\r\n  }\r\n  render() {\r\n    if (this.state.hasError) {\r\n      return (\r\n        <div className=\"min-h-screen flex items-center justify-center p-6\">\r\n          <div className=\"card max-w-lg w-full text-center\">\r\n            <h2 className=\"text-2xl font-bold mb-2\">Something went wrong</h2>\r\n            <p className=\"opacity-80 mb-4\">\r\n              Please refresh the page. If this persists, let us know.\r\n            </p>\r\n            {this.state.message && (\r\n              <pre className=\"text-xs bg-black/40 rounded p-2 overflow-auto text-left\">\r\n                {this.state.message}\r\n              </pre>\r\n            )}\r\n            <button\r\n              className=\"btn mt-4\"\r\n              onClick={() => window.location.reload()}\r\n            >\r\n              Reload\r\n            </button>\r\n          </div>\r\n        </div>\r\n      );\r\n    }\r\n    return this.props.children as any;\r\n  }\r\n}\r\n","import { StrictMode } from \"react\";\r\nimport ReactDOM from \"react-dom/client\";\r\nimport \"./index.css\";\r\nimport App from \"./App\";\r\nimport ResetPassword from \"./components/ResetPassword\";\r\nimport { WSProvider } from \"./components/WSProvider\";\r\nimport ErrorBoundary from \"./components/ErrorBoundary\";\r\nimport { installApiInterceptor } from \"./utils/api\";\r\n\r\n// In some hosting setups, third-party or legacy code may expect a global React.\r\n// This ensures `React` is available at runtime to prevent 'React is not defined' errors.\r\ntry {\r\n  (window as any).React = (window as any).React || {};\r\n} catch (e) {}\r\n\r\ninstallApiInterceptor();\r\n\r\nReactDOM.createRoot(document.getElementById(\"root\")!).render(\r\n  <StrictMode>\r\n    <ErrorBoundary>\r\n      <WSProvider>\r\n        <Root />\r\n      </WSProvider>\r\n    </ErrorBoundary>\r\n  </StrictMode>,\r\n);\r\n\r\nfunction Root() {\r\n  const path = window.location.pathname;\r\n  if (path === \"/reset\") return <ResetPassword />;\r\n  return <App />;\r\n}\r\n\r\n// Register service worker to enable PWA install & offline capability when available\r\nif (typeof navigator !== 'undefined' && 'serviceWorker' in navigator) {\r\n  try {\r\n    navigator.serviceWorker\r\n      .register('/sw.js')\r\n      .then((reg) => {\r\n        // eslint-disable-next-line no-console\r\n        console.debug('[ServiceWorker] Registered', reg);\r\n      })\r\n      .catch((err) => {\r\n        // eslint-disable-next-line no-console\r\n        console.warn('[ServiceWorker] Registration failed', err);\r\n      });\r\n  } catch (e) {\r\n    // ignore\r\n  }\r\n}\r\n"],"file":"index-CQ32xty6.js"}