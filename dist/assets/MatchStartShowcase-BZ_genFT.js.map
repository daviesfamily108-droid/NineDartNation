{"version":3,"file":"MatchStartShowcase-BZ_genFT.js","sources":["../../src/components/GameCalibrationStatus.tsx","../../src/components/ui/CalibrationPopup.tsx","../../src/utils/networkDevices.ts","../../src/components/CameraTile.tsx","../../src/components/ui/MatchStartShowcase.tsx"],"sourcesContent":["import React from \"react\";\nimport { AlertTriangle, CheckCircle, AlertCircle, Zap } from \"lucide-react\";\nimport { useCalibration } from \"../store/calibration\";\nimport {\n  getCalibrationConfidenceForGame,\n  isCalibrationSuitableForGame,\n  getCalibrationQualityText,\n  getRecalibrationRecommendation,\n  GAME_CALIBRATION_REQUIREMENTS,\n  getGlobalCalibrationConfidence,\n} from \"../utils/gameCalibrationRequirements\";\n\ninterface GameCalibrationStatusProps {\n  gameMode: string;\n  compact?: boolean; // Show minimal version\n  onRecalibrate?: () => void; // Optional callback for recalibrate button\n}\n\nexport default function GameCalibrationStatus({\n  gameMode,\n  compact = false,\n  onRecalibrate,\n}: GameCalibrationStatusProps) {\n  const { H, errorPx, confidence: storedConfidence } = useCalibration();\n\n  const gameConfidence = getCalibrationConfidenceForGame(gameMode, errorPx);\n  const suitable = isCalibrationSuitableForGame(gameMode, errorPx);\n  const { text } = getCalibrationQualityText(gameMode, errorPx);\n  const recommendation = getRecalibrationRecommendation(gameMode);\n  const requirement = GAME_CALIBRATION_REQUIREMENTS[gameMode];\n\n  const baseConfidence =\n    typeof storedConfidence === \"number\"\n      ? storedConfidence\n      : getGlobalCalibrationConfidence(errorPx);\n\n  const showConfidenceNote =\n    typeof baseConfidence === \"number\" &&\n    Math.abs(baseConfidence - gameConfidence) >= 0.5;\n\n  // Treat calibration as present if we have a homography.\n  // Some flows may not persist errorPx (or it may be 0/null) even though the\n  // board is calibrated enough to use for scoring.\n  const hasCalibration = !!H;\n\n  // Not calibrated\n  if (!hasCalibration) {\n    if (compact) {\n      return (\n        <div className=\"text-xs px-2 py-1 rounded bg-slate-600/40 text-slate-300 inline-flex items-center gap-1 border border-slate-500/30\">\n          <AlertTriangle className=\"w-3 h-3\" />\n          Not calibrated ‚ùå\n        </div>\n      );\n    }\n\n    return (\n      <div className=\"px-3 py-2 rounded bg-red-500/20 border border-red-600/30 flex items-center gap-2\">\n        <AlertTriangle className=\"w-4 h-4 text-red-400 flex-shrink-0\" />\n        <div className=\"flex-1\">\n          <div className=\"font-medium text-red-300\">\n            Calibration Required ‚ö†Ô∏è\n          </div>\n          <div className=\"text-xs opacity-80\">\n            Please calibrate before playing {gameMode}\n          </div>\n        </div>\n        {onRecalibrate && (\n          <button\n            className=\"btn px-2 py-1 text-xs bg-red-600 hover:bg-red-700\"\n            onClick={onRecalibrate}\n          >\n            Calibrate üìç\n          </button>\n        )}\n      </div>\n    );\n  }\n\n  // If we have calibration but no errorPx, show a neutral \"Calibrated\" indicator.\n  // We still want the UI to allow the match to start and autoscore to run.\n  if (hasCalibration && (errorPx == null || Number.isNaN(errorPx as any))) {\n    if (compact) {\n      return (\n        <div className=\"text-xs px-2 py-1 rounded inline-flex items-center gap-1 border bg-emerald-500/20 border-emerald-600/30 text-emerald-300\">\n          <CheckCircle className=\"w-3 h-3\" />\n          Calibrated ‚úÖ\n        </div>\n      );\n    }\n\n    return (\n      <div className=\"px-3 py-2 rounded border bg-emerald-500/20 border-emerald-600/30 space-y-1\">\n        <div className=\"flex items-center gap-2\">\n          <CheckCircle className=\"w-4 h-4 text-emerald-400 flex-shrink-0\" />\n          <div className=\"flex-1\">\n            <div className=\"font-medium text-emerald-300\">\n              Calibration for {gameMode}\n            </div>\n            <div className=\"text-xs opacity-80\">\n              Calibrated (quality pending) ‚è≥\n            </div>\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  // Determine colors based on suitability\n  const isPerfect = text.includes(\"Perfect\");\n  const bgColor = isPerfect\n    ? \"bg-indigo-500/20 border-indigo-600/30\"\n    : suitable\n      ? \"bg-emerald-500/20 border-emerald-600/30\"\n      : \"bg-amber-500/20 border-amber-600/30\";\n\n  const textColor = isPerfect\n    ? \"text-indigo-300\"\n    : suitable\n      ? \"text-emerald-300\"\n      : \"text-amber-300\";\n  const icon = isPerfect ? Zap : suitable ? CheckCircle : AlertTriangle;\n\n  if (compact) {\n    return (\n      <div\n        className={`text-xs px-2 py-1 rounded inline-flex items-center gap-1 border ${bgColor} ${textColor}`}\n      >\n        {React.createElement(icon, { className: \"w-3 h-3\" })}\n        <span className=\"flex flex-wrap gap-x-1\">\n          <span>{text}</span>\n          {typeof baseConfidence === \"number\" && (\n            <span>¬∑ Raw {baseConfidence.toFixed(1)}%</span>\n          )}\n          {showConfidenceNote && (\n            <span>{`¬∑ ${gameMode}: ${gameConfidence.toFixed(1)}%`}</span>\n          )}\n        </span>\n        {!suitable && recommendation && (\n          <span className=\"w-3 h-3 cursor-help\" title={recommendation}>\n            <AlertCircle className=\"w-3 h-3 inline\" />\n          </span>\n        )}\n      </div>\n    );\n  }\n\n  // Full version\n  return (\n    <div className={`px-3 py-2 rounded border ${bgColor} space-y-1`}>\n      <div className=\"flex items-center gap-2\">\n        {React.createElement(icon, {\n          className: `w-4 h-4 ${isPerfect ? \"text-indigo-400\" : suitable ? \"text-emerald-400\" : \"text-amber-400\"} flex-shrink-0`,\n        })}\n        <div className=\"flex-1\">\n          <div\n            className={`font-medium ${isPerfect ? \"text-indigo-300\" : suitable ? \"text-emerald-300\" : \"text-amber-300\"}`}\n          >\n            Calibration for {gameMode}\n          </div>\n          <div className=\"text-xs opacity-80 flex flex-wrap gap-x-2 gap-y-1\">\n            <span>\n              Error: {errorPx !== null ? `${errorPx.toFixed(2)}px` : \"Unknown\"}\n            </span>\n            <span>{text}</span>\n            {typeof baseConfidence === \"number\" && (\n              <span>Raw: {baseConfidence.toFixed(1)}%</span>\n            )}\n            {showConfidenceNote && (\n              <span>{`${gameMode}: ${gameConfidence.toFixed(1)}%`}</span>\n            )}\n          </div>\n        </div>\n      </div>\n\n      {/* Confidence bar */}\n      <div className=\"flex items-center gap-2\">\n        <div className=\"flex-1 h-1.5 rounded bg-black/30 overflow-hidden\">\n          <div\n            className={`h-full transition-all ${\n              isPerfect\n                ? \"bg-indigo-500\"\n                : suitable\n                  ? \"bg-emerald-500\"\n                  : \"bg-amber-500\"\n            }`}\n            style={{ width: `${Math.min(100, gameConfidence)}%` }}\n          />\n        </div>\n        <span className=\"text-xs font-mono\">{gameConfidence.toFixed(1)}%</span>\n      </div>\n\n      {/* Requirements */}\n      {requirement && (\n        <div className=\"text-xs opacity-75\">\n          <div>\n            Tolerance: ¬±{requirement.tolerancePx}px | Min:{\" \"}\n            {requirement.minConfidence}%\n          </div>\n        </div>\n      )}\n\n      {/* Warning and recommendation */}\n      <div className=\"space-y-1\">\n        {!suitable && (\n          <div className=\"text-xs px-2 py-1 rounded bg-amber-900/30 text-amber-200 border border-amber-600/20 flex items-center gap-1\">\n            <AlertTriangle className=\"w-3 h-3 flex-shrink-0\" />\n            Calibration quality is below minimum for {gameMode}\n          </div>\n        )}\n\n        {recommendation && (\n          <div className=\"text-xs px-2 py-1 rounded bg-blue-900/30 text-blue-200 border border-blue-600/20 flex items-center gap-1\">\n            <Zap className=\"w-3 h-3 flex-shrink-0\" />\n            {recommendation}\n          </div>\n        )}\n      </div>\n\n      {!suitable && onRecalibrate && (\n        <button\n          className=\"w-full btn px-2 py-1 text-sm mt-2 bg-amber-600 hover:bg-amber-700\"\n          onClick={onRecalibrate}\n        >\n          Recalibrate for {gameMode}\n        </button>\n      )}\n    </div>\n  );\n}\n","import React from \"react\";\nimport type { Player } from \"../../store/match\";\n\nexport default function CalibrationPopup({\n  players,\n  playerCalibrations,\n  calibrationSkipped,\n  onSkip,\n  onOpenCalibrator,\n  onClose,\n}: {\n  players: Player[];\n  playerCalibrations: { [k: string]: any };\n  calibrationSkipped: Record<string, boolean>;\n  onSkip: (id: string) => void;\n  onOpenCalibrator: (id: string) => void;\n  onClose: () => void;\n}) {\n  const skippedPlayers = players.filter((p) => calibrationSkipped[p.id]);\n  const remainingPlayers = players.filter((p) => !calibrationSkipped[p.id]);\n  const canStartMatch = remainingPlayers.length === 0;\n\n  return (\n    <div className=\"fixed inset-0 z-60 overflow-y-auto bg-black/90 backdrop-blur-sm py-8 px-4\">\n      <div className=\"bg-slate-800 border border-slate-600 rounded-2xl p-6 max-w-2xl w-full mx-auto shadow-2xl\">\n        <h3 className=\"text-xl font-bold mb-4 text-center\">\n          Calibration Check üéØ\n        </h3>\n        <p className=\"text-sm opacity-70 mb-6 text-center\">\n          Check your dartboard calibration before the match starts üéØ. Both\n          players must skip or confirm to begin üéØ.\n        </p>\n        {skippedPlayers.length > 0 && remainingPlayers.length > 0 && (\n          <div className=\"mb-4 p-3 bg-blue-900/50 border border-blue-600 rounded-lg\">\n            <p className=\"text-sm text-blue-200\">\n              {skippedPlayers.map((p) => p.name).join(\", \")}{\" \"}\n              {skippedPlayers.length === 1 ? \"has\" : \"have\"} chosen to skip üéØ.{\" \"}\n              {remainingPlayers.map((p) => p.name).join(\", \")}, would you like\n              to skip as well üéØ?\n            </p>\n          </div>\n        )}\n        <div className=\"space-y-4\">\n          {players.map((player) => (\n            <div\n              key={player.id}\n              className=\"flex items-center justify-between p-4 bg-slate-700/50 rounded-lg\"\n            >\n              <div className=\"flex items-center gap-3\">\n                <div className=\"w-10 h-10 rounded-full bg-gradient-to-br from-emerald-400 to-blue-500 flex items-center justify-center text-lg font-bold text-white\">\n                  {player.name\n                    .split(\" \")\n                    .map((n) => n[0])\n                    .join(\"\")\n                    .toUpperCase()\n                    .slice(0, 2)}\n                </div>\n                <div>\n                  <div className=\"font-medium\">{player.name}</div>\n                  <div className=\"text-xs text-slate-400\">\n                    {playerCalibrations[player.name]\n                      ? \"Calibrated ‚úÖ\"\n                      : \"Needs calibration\"}\n                  </div>\n                </div>\n              </div>\n              <div className=\"flex gap-2\">\n                <button\n                  className=\"btn btn-sm btn-ghost\"\n                  onClick={() => onOpenCalibrator(player.id)}\n                >\n                  Bull Up üéØ\n                </button>\n                <button\n                  className=\"btn btn-sm btn-primary\"\n                  onClick={() => onSkip(player.id)}\n                  disabled={!!calibrationSkipped[player.id]}\n                >\n                  {calibrationSkipped[player.id] ? \"Skipped ‚úì\" : \"Skip üéØ\"}\n                </button>\n              </div>\n            </div>\n          ))}\n        </div>\n        <div className=\"mt-6 flex justify-center gap-4\">\n          <button\n            className={`btn ${canStartMatch ? \"btn-primary\" : \"btn-ghost opacity-50 cursor-not-allowed\"}`}\n            disabled={!canStartMatch}\n            onClick={onClose}\n          >\n            Start Match üéØ\n          </button>\n        </div>\n      </div>\n    </div>\n  );\n}\n","/**\n * Network device discovery utilities for wifi scoring devices\n */\n\n// Web Serial API types\ndeclare global {\n  interface Navigator {\n    serial: Serial;\n  }\n  interface Serial extends EventTarget {\n    getPorts(): Promise<SerialPort[]>;\n    requestPort(options?: SerialOptions): Promise<SerialPort>;\n  }\n  interface SerialPort {\n    open(options: SerialOptions): Promise<void>;\n    close(): Promise<void>;\n    readable: ReadableStream<Uint8Array> | null;\n    writable: WritableStream<Uint8Array> | null;\n  }\n  interface SerialOptions {\n    baudRate?: number;\n    dataBits?: number;\n    stopBits?: number;\n    parity?: \"none\" | \"even\" | \"odd\";\n    bufferSize?: number;\n    flowControl?: \"none\" | \"hardware\";\n  }\n}\n\nexport interface NetworkDevice {\n  id: string;\n  name: string;\n  ip: string;\n  port: number;\n  type: \"omni\" | \"vert\" | \"generic\";\n  capabilities: string[];\n  status: \"online\" | \"offline\" | \"connecting\";\n  connectionType: \"wifi\" | \"usb\";\n}\n\n/**\n * USB device interface for serial-connected scoring devices\n */\nexport interface USBDevice {\n  id: string;\n  name: string;\n  type: \"omni\" | \"vert\" | \"generic\";\n  capabilities: string[];\n  status: \"online\" | \"offline\" | \"connecting\";\n  port: SerialPort | null;\n}\n\n/**\n * Discover wifi scoring devices on the local network\n */\nexport async function discoverNetworkDevices(): Promise<NetworkDevice[]> {\n  const devices: NetworkDevice[] = [];\n\n  try {\n    // Get local network info\n    const localIPs = await getLocalIPs();\n\n    for (const localIP of localIPs) {\n      // Scan common ports for dart scoring devices\n      const scanResults = await scanNetwork(\n        localIP,\n        [80, 8080, 8787, 8788, 3000, 5000],\n      );\n\n      for (const result of scanResults) {\n        const device = await probeDevice(result.ip, result.port);\n        if (device) {\n          devices.push(device);\n        }\n      }\n    }\n  } catch (error) {\n    console.error(\"Network discovery failed:\", error);\n  }\n\n  return devices;\n}\n\n/**\n * Get local IP addresses\n */\nasync function getLocalIPs(): Promise<string[]> {\n  const ips: string[] = [];\n\n  try {\n    // Try to get local IPs via WebRTC\n    const pc = new RTCPeerConnection({ iceServers: [] });\n    pc.createDataChannel(\"\");\n\n    const offer = await pc.createOffer();\n    await pc.setLocalDescription(offer);\n\n    return new Promise((resolve) => {\n      const timeout = setTimeout(() => {\n        pc.close();\n        resolve(ips);\n      }, 5000);\n\n      pc.onicecandidate = (event) => {\n        if (event.candidate) {\n          const candidate = event.candidate.candidate;\n          const ipMatch = candidate.match(/(\\d+\\.\\d+\\.\\d+\\.\\d+)/);\n          if (ipMatch && ipMatch[1] && !ips.includes(ipMatch[1])) {\n            const ip = ipMatch[1];\n            // Only include private IPs\n            if (isPrivateIP(ip)) {\n              ips.push(ip);\n            }\n          }\n        } else {\n          clearTimeout(timeout);\n          pc.close();\n          resolve(ips);\n        }\n      };\n    });\n  } catch (error) {\n    console.error(\"Failed to get local IPs:\", error);\n    return [\"192.168.1.0\"]; // fallback\n  }\n}\n\n/**\n * Check if IP is in private range\n */\nfunction isPrivateIP(ip: string): boolean {\n  const parts = ip.split(\".\").map(Number);\n  return (\n    parts[0] === 10 ||\n    (parts[0] === 172 && parts[1] >= 16 && parts[1] <= 31) ||\n    (parts[0] === 192 && parts[1] === 168)\n  );\n}\n\n/**\n * Scan network for open ports\n */\nasync function scanNetwork(\n  localIP: string,\n  ports: number[],\n): Promise<{ ip: string; port: number }[]> {\n  const results: { ip: string; port: number }[] = [];\n  const baseIP = localIP.split(\".\").slice(0, 3).join(\".\");\n\n  // Scan a reasonable range (e.g., .1 to .254)\n  const promises = [];\n  for (let i = 1; i <= 254; i++) {\n    const ip = `${baseIP}.${i}`;\n    for (const port of ports) {\n      promises.push(checkPort(ip, port));\n    }\n  }\n\n  const portResults = await Promise.allSettled(promises);\n\n  portResults.forEach((result, index) => {\n    if (result.status === \"fulfilled\" && result.value) {\n      const portIndex = index % ports.length;\n      const ipIndex = Math.floor(index / ports.length);\n      const ip = `${baseIP}.${ipIndex + 1}`;\n      results.push({ ip, port: ports[portIndex] });\n    }\n  });\n\n  return results;\n}\n\n/**\n * Check if a specific port is open on an IP\n */\nasync function checkPort(ip: string, port: number): Promise<boolean> {\n  try {\n    const response = await fetch(`http://${ip}:${port}/`, {\n      method: \"HEAD\",\n      mode: \"no-cors\",\n      signal: AbortSignal.timeout(2000),\n    });\n    return true;\n  } catch {\n    return false;\n  }\n}\n\n/**\n * Probe a device to identify its type and capabilities\n */\nasync function probeDevice(\n  ip: string,\n  port: number,\n): Promise<NetworkDevice | null> {\n  try {\n    // Try common endpoints for dart scoring devices\n    const endpoints = [\"/\", \"/api/info\", \"/api/status\", \"/camera\", \"/stream\"];\n\n    for (const endpoint of endpoints) {\n      try {\n        const response = await fetch(`http://${ip}:${port}${endpoint}`, {\n          method: \"GET\",\n          signal: AbortSignal.timeout(3000),\n        });\n\n        if (response.ok) {\n          const contentType = response.headers.get(\"content-type\") || \"\";\n          const text = await response.text();\n\n          // Check for OMNI device\n          if (\n            text.includes(\"OMNI\") ||\n            text.includes(\"omni\") ||\n            endpoint.includes(\"omni\")\n          ) {\n            return {\n              id: `omni-${ip}-${port}`,\n              name: `OMNI Camera (${ip})`,\n              ip,\n              port,\n              type: \"omni\",\n              capabilities: [\"video\", \"calibration\"],\n              status: \"online\",\n              connectionType: \"wifi\",\n            };\n          }\n\n          // Check for VERT device\n          if (\n            text.includes(\"VERT\") ||\n            text.includes(\"vert\") ||\n            endpoint.includes(\"vert\")\n          ) {\n            return {\n              id: `vert-${ip}-${port}`,\n              name: `VERT Camera (${ip})`,\n              ip,\n              port,\n              type: \"vert\",\n              capabilities: [\"video\", \"calibration\"],\n              status: \"online\",\n              connectionType: \"wifi\",\n            };\n          }\n\n          // Check for generic video streaming device\n          if (\n            contentType.includes(\"video\") ||\n            text.includes(\"stream\") ||\n            endpoint === \"/stream\"\n          ) {\n            return {\n              id: `generic-${ip}-${port}`,\n              name: `Network Camera (${ip})`,\n              ip,\n              port,\n              type: \"generic\",\n              capabilities: [\"video\"],\n              status: \"online\",\n              connectionType: \"wifi\",\n            };\n          }\n        }\n      } catch {\n        // Continue to next endpoint\n      }\n    }\n  } catch (error) {\n    console.error(`Failed to probe device ${ip}:${port}:`, error);\n  }\n\n  return null;\n}\n\n/**\n * Discover USB scoring devices connected via serial\n */\nexport async function discoverUSBDevices(): Promise<USBDevice[]> {\n  const devices: USBDevice[] = [];\n\n  try {\n    // Check if Web Serial API is supported\n    if (!(\"serial\" in navigator)) {\n      console.warn(\"Web Serial API not supported in this browser\");\n      return devices;\n    }\n\n    // Get already paired ports\n    const ports = await navigator.serial.getPorts();\n\n    for (const port of ports) {\n      const device = await probeUSBDevice(port);\n      if (device) {\n        devices.push(device);\n      }\n    }\n\n    // Also try to request a new port (this will show user selection dialog)\n    // Note: This is optional and will be handled separately in the UI\n  } catch (error) {\n    console.error(\"USB device discovery failed:\", error);\n  }\n\n  return devices;\n}\n\n/**\n * Request user to select a USB device\n */\nexport async function requestUSBDevice(): Promise<USBDevice | null> {\n  try {\n    if (!(\"serial\" in navigator)) {\n      alert(\n        \"Web Serial API not supported in this browser. Please use a compatible browser like Chrome or Edge.\",\n      );\n      return null;\n    }\n\n    const port = await navigator.serial.requestPort();\n    return await probeUSBDevice(port);\n  } catch (error) {\n    if ((error as any).name !== \"NotFoundError\") {\n      console.error(\"USB device request failed:\", error);\n    }\n    return null;\n  }\n}\n\n/**\n * Probe a USB serial port to identify the device type\n */\nasync function probeUSBDevice(port: SerialPort): Promise<USBDevice | null> {\n  try {\n    // Open the port with common settings for dart scoring devices\n    await port.open({\n      baudRate: 9600,\n      dataBits: 8,\n      stopBits: 1,\n      parity: \"none\",\n    });\n\n    // Try to read some data to identify the device\n    const reader = port.readable?.getReader();\n    if (reader) {\n      try {\n        // Set a timeout for reading\n        const timeout = setTimeout(() => reader.cancel(), 2000);\n\n        const { value, done } = await reader.read();\n        clearTimeout(timeout);\n\n        if (!done && value) {\n          const text = new TextDecoder().decode(value);\n\n          // Check for OMNI device\n          if (text.includes(\"OMNI\") || text.includes(\"omni\")) {\n            reader.releaseLock();\n            return {\n              id: `usb-omni-${Date.now()}`,\n              name: \"OMNI Camera (USB)\",\n              type: \"omni\",\n              capabilities: [\"video\", \"calibration\"],\n              status: \"online\",\n              port,\n            };\n          }\n\n          // Check for VERT device\n          if (text.includes(\"VERT\") || text.includes(\"vert\")) {\n            reader.releaseLock();\n            return {\n              id: `usb-vert-${Date.now()}`,\n              name: \"VERT Camera (USB)\",\n              type: \"vert\",\n              capabilities: [\"video\", \"calibration\"],\n              status: \"online\",\n              port,\n            };\n          }\n        }\n      } catch {\n        // Continue\n      } finally {\n        try {\n          reader.releaseLock();\n        } catch {}\n      }\n    }\n\n    // If we can't identify, assume it's a generic device\n    return {\n      id: `usb-generic-${Date.now()}`,\n      name: \"USB Scoring Device\",\n      type: \"generic\",\n      capabilities: [\"video\"],\n      status: \"online\",\n      port,\n    };\n  } catch (error) {\n    console.error(\"Failed to probe USB device:\", error);\n    return null;\n  }\n}\n\n/**\n * Connect to a network device and get video stream\n */\nexport async function connectToNetworkDevice(\n  device: NetworkDevice,\n): Promise<MediaStream | null> {\n  try {\n    // For now, assume devices provide an MJPEG or HLS stream\n    // This would need to be adapted based on the actual device API\n    const streamUrl = `http://${device.ip}:${device.port}/stream`;\n\n    // Create a video element to capture the stream\n    const video = document.createElement(\"video\");\n    video.src = streamUrl;\n    video.crossOrigin = \"anonymous\";\n\n    return new Promise((resolve, reject) => {\n      video.onloadeddata = () => {\n        const canvas = document.createElement(\"canvas\");\n        const ctx = canvas.getContext(\"2d\")!;\n        canvas.width = video.videoWidth;\n        canvas.height = video.videoHeight;\n\n        // Create a MediaStream from the video\n        const stream = canvas.captureStream(30); // 30 FPS\n\n        const drawFrame = () => {\n          if (video.readyState >= 2) {\n            ctx.drawImage(video, 0, 0);\n          }\n          requestAnimationFrame(drawFrame);\n        };\n        drawFrame();\n\n        resolve(stream);\n      };\n\n      video.onerror = () => reject(new Error(\"Failed to load video stream\"));\n      video.load();\n    });\n  } catch (error) {\n    console.error(\"Failed to connect to network device:\", error);\n    return null;\n  }\n}\n\n/**\n * Connect to a USB device and get video stream\n */\nexport async function connectToUSBDevice(\n  device: USBDevice,\n): Promise<MediaStream | null> {\n  try {\n    if (!device.port) {\n      throw new Error(\"No serial port available\");\n    }\n\n    // For USB devices, we assume they provide video through a companion app or driver\n    // This is a placeholder - actual implementation would depend on the device protocol\n    console.log(\"USB device connection not fully implemented yet\");\n    return null;\n  } catch (error) {\n    console.error(\"Failed to connect to USB device:\", error);\n    return null;\n  }\n}\n","/* eslint-disable jsx-a11y/media-has-caption */\nimport {\n  useCallback,\n  useEffect,\n  useMemo,\n  useRef,\n  useState,\n  type CSSProperties,\n} from \"react\";\nimport { dlog } from \"../utils/logger\";\nimport { useUserSettings } from \"../store/userSettings\";\nimport {\n  useCameraSession,\n  type CameraStreamMode,\n} from \"../store/cameraSession\";\nimport {\n  discoverNetworkDevices,\n  connectToNetworkDevice,\n  type NetworkDevice,\n  discoverUSBDevices,\n  requestUSBDevice,\n  connectToUSBDevice,\n  type USBDevice,\n} from \"../utils/networkDevices\";\nimport { apiFetch } from \"../utils/api\";\nimport { getPreferredWsUrl } from \"../utils/ws\";\n\ntype CameraTileProps = {\n  label?: string;\n  autoStart?: boolean;\n  /** Force the tile to kick off streaming even if global camera toggle is off (useful for pre-match preview). */\n  forceAutoStart?: boolean;\n  scale?: number;\n  className?: string;\n  aspect?: \"inherit\" | \"wide\" | \"square\" | \"portrait\" | \"classic\" | \"free\";\n  style?: CSSProperties;\n  fill?: boolean;\n  // Offline mode props\n  user?: any;\n  playerScore?: number;\n  aiScore?: number;\n  x01Score?: number;\n  inMatch?: boolean;\n  showWinPopup?: boolean;\n  pendingLegWinner?: \"player\" | \"ai\" | null;\n  playerDartsThrown?: number;\n  aiDartsThrown?: number;\n  totalPlayerDarts?: number;\n  totalAiDarts?: number;\n  totalPlayerPoints?: number;\n  totalAiPoints?: number;\n  player180s?: number;\n  player140s?: number;\n  player100s?: number;\n  ai180s?: number;\n  ai140s?: number;\n  ai100s?: number;\n  playerHighestCheckout?: number;\n  aiHighestCheckout?: number;\n  onClose?: () => void;\n  onOpen?: () => void;\n  layout?: \"classic\" | \"modern\";\n  /** Override the global fit mode for this tile only. */\n  tileFitModeOverride?: \"fit\" | \"fill\";\n};\n\nexport default function CameraTile({\n  label,\n  autoStart,\n  forceAutoStart = false,\n  scale: scaleOverrideProp,\n  className,\n  aspect = \"inherit\",\n  style,\n  fill = false,\n  tileFitModeOverride: tileFitModeOverrideProp,\n}: CameraTileProps) {\n  const videoRef = useRef<HTMLVideoElement>(null);\n  const cameraSession = useCameraSession();\n  const [streaming, setStreaming] = useState(false);\n  const [ws, setWs] = useState<WebSocket | null>(null);\n  const [pairCode, setPairCode] = useState<string | null>(null);\n  const [pc, setPc] = useState<RTCPeerConnection | null>(null);\n  const lastRegisteredModeRef = useRef<CameraStreamMode | null>(null);\n\n  // Always register the current <video> element with the global camera session.\n  // This is especially important for the pre-game overlay where we want the\n  // already-running calibrated stream to appear immediately.\n  useEffect(() => {\n    try {\n      // consumer-only: do NOT set cameraSession video ref\n    } catch {}\n    return () => {\n      try {\n        // consumer-only: do NOT clear cameraSession video ref\n      } catch {}\n    };\n  }, [cameraSession]);\n  const registerStream = useCallback(\n    (stream: MediaStream | null, modeOverride: CameraStreamMode = \"local\") => {\n      try {\n        if (stream) {\n          cameraSession.setMediaStream(stream);\n          if (videoRef.current) {\n            // consumer-only: do NOT set cameraSession video ref\n          }\n          cameraSession.setMode(modeOverride);\n          cameraSession.setStreaming(true);\n          lastRegisteredModeRef.current = modeOverride;\n        } else if (\n          lastRegisteredModeRef.current &&\n          lastRegisteredModeRef.current !== \"phone\"\n        ) {\n          cameraSession.setStreaming(false);\n          cameraSession.setMediaStream(null);\n          lastRegisteredModeRef.current = null;\n        }\n      } catch (err) {\n        console.warn(\n          \"[CameraTile] Failed to register stream with camera session:\",\n          err,\n        );\n      }\n    },\n    [cameraSession],\n  );\n\n  const attachExistingStream = useCallback(async () => {\n    try {\n      const existingStream = cameraSession.getMediaStream();\n      if (!existingStream) {\n        console.log(\"[CameraTile] attachExistingStream: No existing stream found\");\n        return false;\n      }\n      if (!videoRef.current) {\n        console.log(\"[CameraTile] attachExistingStream: No video ref\");\n        return false;\n      }\n      if (videoRef.current.srcObject !== existingStream) {\n        console.log(\"[CameraTile] Attaching existing stream to video element\", existingStream.id);\n        videoRef.current.srcObject = existingStream;\n      }\n      videoRef.current.muted = true;\n      (videoRef.current as any).playsInline = true;\n      try {\n        await videoRef.current.play();\n        console.log(\"[CameraTile] Video playing\");\n      } catch (e) {\n        console.warn(\"[CameraTile] Play failed:\", e);\n      }\n      setStreaming(true);\n      return true;\n    } catch (err) {\n      console.warn(\"[CameraTile] Failed to reuse global camera stream\", err);\n      return false;\n    }\n  }, [cameraSession]);\n\n  // Initialize mode: prioritize phone camera if preferred, otherwise use localStorage\n  const preferredCameraLabel = useUserSettings((s) => s.preferredCameraLabel);\n  const [mode, setMode] = useState<\"local\" | \"phone\" | \"wifi\">(() => {\n    // If phone camera is selected, start in phone mode\n    if (preferredCameraLabel === \"Phone Camera\") {\n      dlog(\n        \"[CAMERATILE] Initializing mode to phone (from preferred camera selection)\",\n      );\n      return \"phone\";\n    }\n    // Otherwise use saved mode or default to local\n    const saved = localStorage.getItem(\"ndn:camera:mode\") as any;\n    dlog(\n      \"[CAMERATILE] Initializing mode to\",\n      saved || \"local\",\n      \"(from localStorage)\",\n    );\n    return saved || \"local\";\n  });\n\n  const [, setExpiresAt] = useState<number | null>(null);\n  const [, setPaired] = useState<boolean>(false);\n  const [lanHost, setLanHost] = useState<string | null>(null);\n  const [httpsInfo, setHttpsInfo] = useState<{\n    https: boolean;\n    port: number;\n  } | null>(null);\n  const [showTips, setShowTips] = useState<boolean>(true);\n  const [wifiDevices, setWifiDevices] = useState<NetworkDevice[]>([]);\n  const [discoveringWifi, setDiscoveringWifi] = useState<boolean>(false);\n  const [usbDevices, setUsbDevices] = useState<USBDevice[]>([]);\n  const [discoveringUsb, setDiscoveringUsb] = useState<boolean>(false);\n  const autoscoreProvider = useUserSettings((s) => s.autoscoreProvider);\n  const cameraEnabledSetting = useUserSettings((s) => s.cameraEnabled);\n  const setPreferredCameraLocked = useUserSettings(\n    (s) => s.setPreferredCameraLocked,\n  );\n  const preferredCameraLocked = useUserSettings((s) => s.preferredCameraLocked);\n  const setPreferredCamera = useUserSettings((s) => s.setPreferredCamera);\n  const preferredCameraId = useUserSettings((s) => s.preferredCameraId);\n\n  // If manual mode is active, we usually show the fallback.\n  // BUT if forceAutoStart is true (e.g. pre-game preview), we should show the camera anyway.\n  if (autoscoreProvider === \"manual\" && !forceAutoStart) {\n    const fallbackBase = fill\n      ? \"rounded-2xl overflow-hidden bg-black w-full flex flex-col\"\n      : \"rounded-2xl overflow-hidden bg-black w-full mx-auto\";\n    const fallbackClass = [fallbackBase, className]\n      .filter(Boolean)\n      .join(\" \")\n      .trim();\n    const fallbackStyle: CSSProperties = { ...(style || {}) };\n    if (\n      !fill &&\n      fallbackStyle.aspectRatio === undefined &&\n      fallbackStyle.height === undefined &&\n      fallbackStyle.minHeight === undefined\n    ) {\n      fallbackStyle.aspectRatio = \"4 / 3\";\n    }\n    return (\n      <div className={fallbackClass} style={fallbackStyle}>\n        <div className=\"flex-1 w-full h-full flex items-center justify-center bg-slate-900 text-slate-200 text-xs p-4 text-center\">\n          Manual scoring mode active ‚Äî camera feeds are disabled.\n        </div>\n      </div>\n    );\n  }\n  useEffect(() => {\n    const h = window.location.hostname;\n    if (h === \"localhost\" || h === \"127.0.0.1\") {\n      apiFetch(`/api/hosts`)\n        .then((r) => r.json())\n        .then((j) => {\n          const ip = Array.isArray(j?.hosts) && j.hosts.find((x: string) => x);\n          if (ip) setLanHost(ip);\n        })\n        .catch(() => {});\n    }\n    // Detect HTTPS support for the phone link\n    apiFetch(`/api/https-info`)\n      .then((r) => r.json())\n      .then((j) => {\n        if (j && typeof j.https === \"boolean\")\n          setHttpsInfo({ https: !!j.https, port: Number(j.port) || 8788 });\n      })\n      .catch(() => {});\n  }, []);\n  const mobileUrl = useMemo(() => {\n    const code = pairCode || \"____\";\n    // If a hosted WS URL is configured (e.g., Render), derive the server origin from it\n    const envUrl = (import.meta as any).env?.VITE_WS_URL as string | undefined;\n    if (envUrl && envUrl.length > 0) {\n      try {\n        // Convert ws(s)://host[/ws] -> http(s)://host (strip trailing /ws)\n        const u = new URL(envUrl);\n        const isSecure = u.protocol === \"wss:\";\n        const origin = `${isSecure ? \"https\" : \"http\"}://${u.host}${u.pathname.endsWith(\"/ws\") ? \"\" : u.pathname}`;\n        const base = origin.replace(/\\/?ws$/i, \"\");\n        return `${base}/mobile-cam.html?code=${code}`;\n      } catch (e) {}\n    }\n    // Fallback to local development: prefer LAN host if detected\n    const host = lanHost || window.location.hostname;\n    const useHttps = !!httpsInfo?.https;\n    const port = useHttps ? httpsInfo?.port || 8788 : 8787;\n    const proto = useHttps ? \"https\" : \"http\";\n    return `${proto}://${host}:${port}/mobile-cam.html?code=${code}`;\n  }, [pairCode, lanHost, httpsInfo]);\n  useEffect(() => {\n    dlog(\"[CAMERATILE] Mode changed to:\", mode, \"- persisting to localStorage\");\n    localStorage.setItem(\"ndn:camera:mode\", mode);\n  }, [mode]);\n\n  useEffect(() => {\n    if (!cameraSession.isStreaming) return;\n    attachExistingStream();\n  }, [cameraSession.isStreaming, attachExistingStream]);\n\n  const [manualModeSetAt, setManualModeSetAt] = useState<number | null>(null);\n\n  // start/stop are implemented later (deduplicated); keep single definition below.\n\n  // Sync phone camera selection from Calibrator into CameraTile mode state\n  // When user locks in phone camera in Calibrator, it updates preferredCameraLabel\n  // This effect ensures CameraTile's UI reflects that selection\n  useEffect(() => {\n    const ignore = useUserSettings.getState().ignorePreferredCameraSync;\n    dlog(\n      \"[CAMERATILE] Checking camera selection sync: preferredCameraLabel=\",\n      preferredCameraLabel,\n      \"mode=\",\n      mode,\n      \"ignoreSync=\",\n      ignore,\n      \"manualModeSetAt=\",\n      manualModeSetAt,\n    );\n    if (ignore) return;\n    // If user manually changed mode recently, avoid auto-syncing preferred camera\n    if (manualModeSetAt && Date.now() - manualModeSetAt < 30_000) return;\n    if (preferredCameraLabel === \"Phone Camera\" && mode !== \"phone\") {\n      dlog(\"[CAMERATILE] Syncing mode to phone from Calibrator selection\");\n      setMode(\"phone\");\n    }\n  }, [preferredCameraLabel, mode, manualModeSetAt]);\n\n  // Intentionally disabled automatic regeneration of phone pairing codes.\n  // Codes will only be created when the user explicitly requests it (button click).\n  // This prevents a code expiring and the UI silently generating a new one while pairing.\n\n  // If the user selected Phone Camera, bind the global stream into this tile\n  useEffect(() => {\n    const apply = async () => {\n      try {\n        const allowPhoneAttach =\n          (preferredCameraLabel === \"Phone Camera\" &&\n            (!manualModeSetAt || Date.now() - manualModeSetAt >= 30_000)) ||\n          mode === \"phone\";\n        if (!allowPhoneAttach) return;\n        const s = cameraSession.getMediaStream();\n        const v = videoRef.current;\n        if (!v || !s) return;\n        if (v.srcObject !== s) {\n          v.srcObject = s;\n        }\n        v.muted = true;\n        (v as any).playsInline = true;\n        try {\n          await v.play();\n        } catch {}\n        setStreaming(true);\n        // Once attached and playing, no need to keep polling.\n        return true;\n      } catch {}\n      return false;\n    };\n    // Try immediately and poll briefly to catch late-arriving stream\n    let cleared = false;\n    let t: any = null;\n    const maybeClear = (ok?: boolean) => {\n      if (!!ok && t && !cleared) {\n        cleared = true;\n        try {\n          clearInterval(t);\n        } catch {}\n      }\n    };\n    Promise.resolve(apply()).then(maybeClear).catch(() => {});\n    t = setInterval(() => {\n      Promise.resolve(apply()).then(maybeClear).catch(() => {});\n    }, 800);\n    return () => {\n      try {\n        if (t) clearInterval(t);\n      } catch {}\n    };\n  }, [preferredCameraLabel, mode, cameraSession, cameraSession.isStreaming]);\n\n  const start = useCallback(async () => {\n    console.log(\"[CameraTile] start() invoked with mode=\", mode);\n    if (await attachExistingStream()) {\n      console.log(\"[CameraTile] Reused calibrated global stream\");\n      return;\n    }\n    if (mode === \"wifi\") {\n      return startWifiConnection();\n    }\n    console.log(\"[CameraTile] Attempting to attach global stream for phone mode...\");\n\n    // If phone camera is selected and paired, don't try to start local camera\n    if (preferredCameraLabel === \"Phone Camera\" || mode === \"phone\") {\n      const s = cameraSession.getMediaStream();\n      if (s && videoRef.current) {\n        try {\n          videoRef.current.srcObject = s;\n          await videoRef.current.play();\n          setStreaming(true);\n          return;\n        } catch {}\n      }\n      // If no global stream yet, for phone mode we should attempt pairing\n      if (mode === \"phone\") {\n        try {\n          await startPhonePairing();\n          return;\n        } catch {}\n      }\n    }\n\n    // NOTE: CameraTile is preview/UI only.\n    // Local capture is owned by CameraView and stored in the global cameraSession.\n    // Starting a second getUserMedia stream here can cause devices (especially\n    // virtual cameras) to flicker/white-screen as tracks are rapidly opened/closed.\n    // So: just attempt to reuse whatever the global session has.\n    try {\n      const s = cameraSession.getMediaStream?.();\n      if (s && videoRef.current) {\n        videoRef.current.srcObject = s;\n        await videoRef.current.play();\n        setStreaming(true);\n        return;\n      }\n    } catch {}\n  }, [\n    mode,\n    preferredCameraLabel,\n    cameraSession,\n    registerStream,\n    startPhonePairing,\n    startWifiConnection,\n    attachExistingStream,\n  ]);\n\n  // Failsafe: whenever the tile is mounted (e.g., pre-game overlay), ensure we\n  // attach any already-running global stream to this video element. If none is\n  // present and forceAutoStart is set, kick off start(). This helps the\n  // bull-up/prestart preview reliably show the live feed.\n  useEffect(() => {\n    const v = videoRef.current;\n    if (!v) {\n      console.log(\"[CameraTile] Failsafe: No video ref\");\n      return;\n    }\n    const s = cameraSession.getMediaStream?.();\n    if (s) {\n      try {\n        if (v.srcObject !== s) {\n          console.log(\"[CameraTile] Failsafe: Attaching stream\", s.id);\n          v.srcObject = s;\n        }\n        v.muted = true;\n        (v as any).playsInline = true;\n        Promise.resolve(v.play()).then(() => console.log(\"[CameraTile] Failsafe: Playing\")).catch((e) => console.warn(\"[CameraTile] Failsafe play error\", e));\n        setStreaming(true);\n        return;\n      } catch {}\n    } else {\n      console.log(\"[CameraTile] Failsafe: No stream in session\");\n    }\n    if (forceAutoStart || autoStart) {\n      console.log(\"[CameraTile] Failsafe: Triggering start()\");\n      start().catch(() => {});\n    }\n  }, [cameraSession, forceAutoStart, autoStart, start, cameraSession.isStreaming]);\n  const stop = useCallback(() => {\n    // Detach preview only. Do NOT stop tracks here, as the global cameraSession\n    // stream may be shared by CameraView and other UI surfaces.\n    if (videoRef.current && videoRef.current.srcObject) {\n      try {\n        videoRef.current.srcObject = null;\n      } catch {}\n      setStreaming(false);\n      // Only clear the tile's registration if it was the owner; we don't own\n      // the global stream in this component.\n      try {\n        registerStream(null);\n      } catch {}\n    }\n  }, [registerStream]);\n\n  // Auto-start/stop the tile when requested.\n  useEffect(() => {\n    // Allow pre-match/bull-up overlays to force a preview even when the user has\n    // camera toggled off or autoscore provider is non-built-in.\n    if (!forceAutoStart) {\n      if (!cameraEnabledSetting) return;\n      if (\n        autoscoreProvider &&\n        autoscoreProvider !== \"built-in\" &&\n        autoscoreProvider !== \"external-ws\"\n      )\n        return;\n    }\n\n    // If autoStart is undefined, we don't do anything unless forceAutoStart is true\n    if (autoStart === undefined && !forceAutoStart) return;\n\n    if (autoStart || forceAutoStart) {\n      let cancelled = false;\n      const desiredLabel = preferredCameraLabel || \"default\";\n      const timer = window.setTimeout(() => {\n        if (cancelled || streaming) return;\n        start().catch((err) =>\n          console.warn(\n            `[CameraTile] Auto-start failed for ${desiredLabel}:`,\n            err,\n          ),\n        );\n      }, 200);\n      return () => {\n        cancelled = true;\n        window.clearTimeout(timer);\n      };\n    }\n\n    stop();\n  }, [\n    autoStart,\n    forceAutoStart,\n    streaming,\n    cameraEnabledSetting,\n    autoscoreProvider,\n    preferredCameraLabel,\n    start,\n    stop,\n  ]);\n\n  async function startWifiConnection() {\n    setDiscoveringWifi(true);\n    try {\n      const devices = await discoverNetworkDevices();\n      setWifiDevices(devices);\n      if (devices.length === 0) {\n        alert(\n          \"No wifi scoring devices found on your network. Make sure devices are powered on and connected to the same network.\",\n        );\n      }\n    } catch (error) {\n      console.error(\"Wifi device discovery failed:\", error);\n      alert(\n        \"Failed to discover wifi devices. Please check your network connection.\",\n      );\n    } finally {\n      setDiscoveringWifi(false);\n    }\n  }\n\n  async function connectToWifiDevice(device: NetworkDevice) {\n    try {\n      setWifiDevices((devices) =>\n        devices.map((d) =>\n          d.id === device.id ? { ...d, status: \"connecting\" as const } : d,\n        ),\n      );\n\n      const stream = await connectToNetworkDevice(device);\n      if (stream && videoRef.current) {\n        videoRef.current.srcObject = stream;\n        await videoRef.current.play();\n        setStreaming(true);\n        registerStream(stream, \"wifi\");\n        setWifiDevices((devices) =>\n          devices.map((d) =>\n            d.id === device.id ? { ...d, status: \"online\" as const } : d,\n          ),\n        );\n      } else {\n        throw new Error(\"Failed to get video stream\");\n      }\n    } catch (error) {\n      console.error(\"Failed to connect to wifi device:\", error);\n      alert(\n        `Failed to connect to ${device.name}. Please check the device and try again.`,\n      );\n      setWifiDevices((devices) =>\n        devices.map((d) =>\n          d.id === device.id ? { ...d, status: \"offline\" as const } : d,\n        ),\n      );\n    }\n  }\n\n  async function startUsbConnection() {\n    setDiscoveringUsb(true);\n    try {\n      // First try to get already paired devices\n      const devices = await discoverUSBDevices();\n      setUsbDevices(devices);\n\n      // Then request user to select a new device\n      const newDevice = await requestUSBDevice();\n      if (newDevice) {\n        setUsbDevices((prev) => [...prev, newDevice]);\n      }\n\n      if (devices.length === 0 && !newDevice) {\n        alert(\n          \"No USB scoring devices found. Please connect a device and try again.\",\n        );\n      }\n    } catch (error) {\n      console.error(\"USB device discovery failed:\", error);\n      alert(\"Failed to discover USB devices. Please check device connections.\");\n    } finally {\n      setDiscoveringUsb(false);\n    }\n  }\n\n  async function connectToUsbDevice(device: USBDevice) {\n    try {\n      setUsbDevices((devices) =>\n        devices.map((d) =>\n          d.id === device.id ? { ...d, status: \"connecting\" as const } : d,\n        ),\n      );\n      const stream = await connectToUSBDevice(device);\n      if (stream && videoRef.current) {\n        videoRef.current.srcObject = stream;\n        await videoRef.current.play();\n        setStreaming(true);\n        setMode(\"wifi\"); // Using wifi mode for USB devices too\n        registerStream(stream, \"wifi\");\n        setUsbDevices((devices) =>\n          devices.map((d) =>\n            d.id === device.id ? { ...d, status: \"online\" as const } : d,\n          ),\n        );\n      } else {\n        throw new Error(\"Failed to get video stream\");\n      }\n    } catch (error) {\n      console.error(\"Failed to connect to USB device:\", error);\n      alert(\n        `Failed to connect to ${device.name}. Please check the device and try again.`,\n      );\n      setUsbDevices((devices) =>\n        devices.map((d) =>\n          d.id === device.id ? { ...d, status: \"offline\" as const } : d,\n        ),\n      );\n    }\n  }\n\n  // Listen for global event to start local camera from other UI components\n  const handleModeSelect = useCallback(\n    (newMode: \"local\" | \"phone\" | \"wifi\" | \"usb\") => {\n      try {\n        setMode(newMode === \"usb\" ? \"wifi\" : newMode);\n        setManualModeSetAt(Date.now());\n        // Persist the user's selection and lock it to avoid auto-switching\n        try {\n          if (newMode === \"local\") {\n            try {\n              setPreferredCamera(preferredCameraId, \"Local\", true);\n            } catch {}\n            try {\n              setPreferredCameraLocked(true);\n            } catch {}\n          } else if (newMode === \"phone\") {\n            try {\n              setPreferredCamera(undefined, \"Phone Camera\", true);\n            } catch {}\n            try {\n              setPreferredCameraLocked(true);\n            } catch {}\n          } else if (newMode === \"wifi\" || newMode === \"usb\") {\n            try {\n              setPreferredCamera(undefined, \"WiFi/USB\", true);\n            } catch {}\n            try {\n              setPreferredCameraLocked(true);\n            } catch {}\n          }\n        } catch {}\n        if (newMode === \"local\") {\n          start().catch(() => {});\n        } else if (newMode === \"phone\") {\n          startPhonePairing();\n        } else if (newMode === \"wifi\") {\n          startWifiConnection();\n        } else if (newMode === \"usb\") {\n          startUsbConnection();\n        }\n      } catch (err) {\n        console.warn(\"[CameraTile] handleModeSelect failed\", err);\n      }\n    },\n    [\n      start,\n      startPhonePairing,\n      startWifiConnection,\n      startUsbConnection,\n      setPreferredCamera,\n      setPreferredCameraLocked,\n      preferredCameraId,\n    ],\n  );\n\n  useEffect(() => {\n    const onStart = (ev: any) => {\n      try {\n        const modeFromEvent = ev && ev.detail && ev.detail.mode;\n        if (\n          modeFromEvent &&\n          [\"local\", \"phone\", \"wifi\", \"usb\"].includes(modeFromEvent)\n        ) {\n          // Respect explicit mode requests and treat as manual selection\n          handleModeSelect(modeFromEvent);\n          // Ensure start is invoked after selection is applied\n          start().catch(() => {});\n        } else {\n          // No explicit mode provided ‚Äî just try to start current mode\n          start().catch(() => {});\n        }\n      } catch {}\n    };\n    window.addEventListener(\"ndn:start-camera\" as any, onStart as any);\n    return () => {\n      window.removeEventListener(\"ndn:start-camera\" as any, onStart as any);\n    };\n  }, [start, handleModeSelect]);\n\n  // Phone pairing via WebRTC\n  function ensureWS() {\n    if (ws && ws.readyState === WebSocket.OPEN) return ws;\n    const url = getPreferredWsUrl();\n    const socket = new WebSocket(url);\n    setWs(socket);\n    return socket;\n  }\n  async function startPhonePairing() {\n    setMode(\"phone\");\n    setPaired(false);\n    const socket = ensureWS();\n    if (socket.readyState === WebSocket.OPEN) {\n      socket.send(JSON.stringify({ type: \"cam-create\" }));\n    } else {\n      socket.onopen = () => socket.send(JSON.stringify({ type: \"cam-create\" }));\n    }\n    socket.onmessage = async (ev) => {\n      const data = JSON.parse(ev.data);\n      if (data.type === \"cam-code\") {\n        setPairCode(data.code);\n        if (data.expiresAt) setExpiresAt(data.expiresAt);\n      } else if (data.type === \"cam-peer-joined\") {\n        setPaired(true);\n        // Create offer to the phone\n        const peer = new RTCPeerConnection({\n          iceServers: [{ urls: \"stun:stun.l.google.com:19302\" }],\n        });\n        setPc(peer);\n        peer.onicecandidate = (e) => {\n          if (e.candidate && pairCode)\n            socket.send(\n              JSON.stringify({\n                type: \"cam-ice\",\n                code: pairCode,\n                payload: e.candidate,\n              }),\n            );\n        };\n        peer.ontrack = (ev) => {\n          if (videoRef.current) {\n            const inbound = ev.streams?.[0];\n            if (inbound) {\n              videoRef.current.srcObject = inbound;\n              videoRef.current.play().catch(() => {});\n              setStreaming(true);\n            }\n          }\n        };\n        const offer = await peer.createOffer({\n          offerToReceiveAudio: false,\n          offerToReceiveVideo: true,\n        });\n        await peer.setLocalDescription(offer);\n        if (pairCode)\n          socket.send(\n            JSON.stringify({\n              type: \"cam-offer\",\n              code: pairCode,\n              payload: offer,\n            }),\n          );\n      } else if (data.type === \"cam-answer\") {\n        if (pc)\n          await pc.setRemoteDescription(\n            new RTCSessionDescription(data.payload),\n          );\n      } else if (data.type === \"cam-ice\") {\n        if (pc)\n          try {\n            await pc.addIceCandidate(data.payload);\n          } catch {}\n      }\n    };\n  }\n  function regenerateCode() {\n    setPairCode(null);\n    setExpiresAt(null);\n    setPaired(false);\n    if (ws && ws.readyState === WebSocket.OPEN) {\n      ws.send(JSON.stringify({ type: \"cam-create\" }));\n    } else {\n      startPhonePairing();\n    }\n    try {\n      setPreferredCameraLocked(true);\n    } catch {}\n  }\n\n  function stopAll() {\n    stop();\n    setPairCode(null);\n    setPaired(false);\n    setExpiresAt(null);\n    if (pc) {\n      try {\n        pc.close();\n      } catch {}\n      setPc(null);\n    }\n  }\n  return (\n    <CameraFrame\n      label={label}\n      autoStart={autoStart}\n      start={start}\n      stopAll={stopAll}\n      startPhonePairing={startPhonePairing}\n      startWifiConnection={startWifiConnection}\n      startUsbConnection={startUsbConnection}\n      connectToWifiDevice={connectToWifiDevice}\n      connectToUsbDevice={connectToUsbDevice}\n      videoRef={videoRef}\n      streaming={streaming}\n      mode={mode}\n      setMode={setMode}\n      pairCode={pairCode}\n      mobileUrl={mobileUrl}\n      regenerateCode={regenerateCode}\n      httpsInfo={httpsInfo}\n      showTips={showTips}\n      setShowTips={setShowTips}\n      wifiDevices={wifiDevices}\n      usbDevices={usbDevices}\n      discoveringWifi={discoveringWifi}\n      discoveringUsb={discoveringUsb}\n      scaleOverride={scaleOverrideProp}\n      tileFitModeOverride={tileFitModeOverrideProp}\n      className={className}\n      aspect={aspect}\n      style={style}\n      fill={fill}\n      onModeSelect={handleModeSelect}\n      preferredCameraLocked={preferredCameraLocked}\n    />\n  );\n}\n\nfunction CameraFrame(props: any) {\n  const cameraSession = useCameraSession();\n  const { cameraScale, cameraAspect: storedAspect } = useUserSettings();\n  const {\n    label,\n    start,\n    stopAll,\n    startPhonePairing,\n    startWifiConnection,\n    startUsbConnection,\n    connectToWifiDevice,\n    connectToUsbDevice,\n    videoRef,\n    streaming,\n    mode,\n    setMode,\n    onModeSelect,\n    pairCode,\n    mobileUrl,\n    regenerateCode,\n    httpsInfo,\n    showTips,\n    setShowTips,\n    wifiDevices,\n    usbDevices,\n    discoveringWifi,\n    discoveringUsb,\n    scaleOverride,\n    tileFitModeOverride,\n    className,\n    aspect,\n    style,\n    fill,\n    preferredCameraLocked,\n  } = props;\n\n  const modeDisplayName: Record<string, string> = {\n    local: \"Local\",\n    phone: \"PhoneCam\",\n    wifi: \"Wi-Fi/USB\",\n  };\n\n  const reconnectOptions = useMemo(() => {\n    return [\n      {\n        id: \"local\",\n        title: \"Local camera\",\n        description: \"Use the desktop webcam or capture card.\",\n        action: () => {\n          if (onModeSelect) onModeSelect(\"local\");\n        },\n      },\n      {\n        id: \"phone\",\n        title: \"PhoneCam\",\n        description: \"Stream from your phone via the mobile link.\",\n        action: () => {\n          if (onModeSelect) onModeSelect(\"phone\");\n        },\n      },\n      {\n        id: \"wifi\",\n        title: \"Wi-Fi/USB\",\n        description: \"Connect to scoring devices on your local network.\",\n        action: () => {\n          if (onModeSelect) onModeSelect(\"wifi\");\n        },\n      },\n      {\n        id: \"usb\",\n        title: \"USB\",\n        description: \"Connect a USB capture device (treated like WiFi mode).\",\n        action: () => {\n          if (onModeSelect) onModeSelect(\"usb\");\n        },\n      },\n    ];\n  }, [\n    setMode,\n    start,\n    startPhonePairing,\n    startWifiConnection,\n    startUsbConnection,\n  ]);\n\n  const [copyFeedback, setCopyFeedback] = useState<\"link\" | \"code\" | null>(\n    null,\n  );\n  const copyTimeoutRef = useRef<number | null>(null);\n\n  useEffect(() => {\n    return () => {\n      if (copyTimeoutRef.current) window.clearTimeout(copyTimeoutRef.current);\n    };\n  }, []);\n\n  // Respect stored aspect unless we're explicitly in full-bleed fill mode,\n  // in which case drop the aspect box so the video can truly cover the area.\n  const { cameraFitMode: globalFitMode } = useUserSettings();\n  const effectiveFitMode: \"fit\" | \"fill\" =\n    tileFitModeOverride || (fill ? \"fill\" : globalFitMode || \"fill\");\n  // In fill mode we guarantee no black bars: never allow downscaling below 1.0\n  const scale = (() => {\n    const raw = Number(scaleOverride ?? cameraScale ?? 1);\n    const clamped = Math.max(0.5, Math.min(2.0, raw));\n    return effectiveFitMode === \"fill\" ? Math.max(1, clamped) : clamped;\n  })();\n  const aspectChoice: \"wide\" | \"square\" | \"portrait\" | \"classic\" | \"free\" =\n    fill && effectiveFitMode === \"fill\"\n      ? \"free\"\n      : aspect && aspect !== \"inherit\"\n        ? aspect\n        : (storedAspect as any) || \"wide\";\n\n  const shouldMaintainAspect = aspectChoice !== \"free\";\n  const aspectClass = shouldMaintainAspect\n    ? aspectChoice === \"square\"\n      ? \"aspect-square\"\n      : aspectChoice === \"portrait\"\n        ? \"aspect-[3/4]\"\n        : aspectChoice === \"classic\"\n          ? \"aspect-[4/3]\"\n          : \"aspect-video\"\n    : \"\";\n\n  const containerBase = fill\n    ? \"rounded-3xl overflow-hidden bg-transparent w-full flex flex-col shadow-2xl border border-slate-700/30\"\n    : \"rounded-3xl overflow-hidden bg-transparent w-full mx-auto flex flex-col shadow-2xl border border-slate-700/30\";\n  const containerClass = [containerBase, className]\n    .filter(Boolean)\n    .join(\" \")\n    .trim();\n  const containerStyle: CSSProperties = { ...(style || {}) };\n\n  const viewportClass = fill\n    ? \"relative flex-1 min-h-0 bg-black\"\n    : \"relative w-full bg-black\";\n\n  const commonVideoProps = {\n    style: { transform: `scale(${scale})`, transformOrigin: \"center\" as const },\n  };\n\n  const usbActive =\n    mode === \"wifi\" && usbDevices.some((d: USBDevice) => d.status === \"online\");\n\n  const videoElement = (() => {\n    // Apply Fit/Fill preference (fill prop hard-overrides to full-bleed)\n    const isFit = effectiveFitMode === \"fit\";\n    const baseVideoClass = isFit\n      ? // Fit: preserve entire frame (may letterbox)\n        \"absolute inset-0 w-full h-full object-contain object-center bg-transparent\"\n      : // Fill: guarantee full coverage with object-cover so there are no black bars\n        \"absolute inset-0 w-full h-full object-cover object-center bg-transparent\";\n    if (fill) {\n      if (shouldMaintainAspect) {\n        return (\n          <div className=\"absolute inset-0 flex items-center justify-center\">\n            <div\n              className={`relative w-full max-w-full max-h-full ${aspectClass}`}\n            >\n              <video\n                ref={videoRef}\n                className={baseVideoClass}\n                {...commonVideoProps}\n                autoPlay\n                playsInline\n                muted\n              />\n            </div>\n          </div>\n        );\n      }\n      return (\n        <video\n          ref={videoRef}\n          className={baseVideoClass}\n          {...commonVideoProps}\n          autoPlay\n          playsInline\n          muted\n        />\n      );\n    }\n    if (shouldMaintainAspect) {\n      return (\n        <div className={`relative w-full ${aspectClass}`}>\n          <video\n            ref={videoRef}\n            className={baseVideoClass}\n            {...commonVideoProps}\n            autoPlay\n            playsInline\n            muted\n          />\n        </div>\n      );\n    }\n    return (\n      <div className=\"relative w-full\">\n        <video\n          ref={videoRef}\n          className={baseVideoClass}\n          {...commonVideoProps}\n          autoPlay\n          playsInline\n          muted\n        />\n      </div>\n    );\n  })();\n\n  async function copyValue(\n    value: string | null | undefined,\n    type: \"link\" | \"code\",\n  ) {\n    if (!value) return;\n    try {\n      if (navigator.clipboard && navigator.clipboard.writeText) {\n        await navigator.clipboard.writeText(value);\n      } else {\n        const textarea = document.createElement(\"textarea\");\n        textarea.value = value;\n        textarea.style.position = \"fixed\";\n        textarea.style.opacity = \"0\";\n        document.body.appendChild(textarea);\n        textarea.focus();\n        textarea.select();\n        document.execCommand(\"copy\");\n        document.body.removeChild(textarea);\n      }\n      setCopyFeedback(type);\n      if (copyTimeoutRef.current) window.clearTimeout(copyTimeoutRef.current);\n      copyTimeoutRef.current = window.setTimeout(\n        () => setCopyFeedback(null),\n        1500,\n      );\n    } catch (err) {\n      console.warn(\"Copy to clipboard failed:\", err);\n      setCopyFeedback(null);\n    }\n  }\n\n  return (\n    <div className={containerClass} style={containerStyle}>\n      <div className={viewportClass}>\n        {videoElement}\n        {cameraSession.isStreaming && mode === \"phone\" && (\n          <div className=\"absolute top-4 left-4 z-10 flex items-center gap-2 px-3 py-1.5 rounded-full bg-black/70 backdrop-blur border border-rose-500/60 text-xs text-rose-200 font-semibold shadow-lg\">\n            <span className=\"inline-block w-2.5 h-2.5 rounded-full bg-rose-500 animate-pulse\" />\n            <span>REC</span>\n          </div>\n        )}\n      </div>\n      <div className=\"px-3 py-2 flex items-center justify-between bg-gradient-to-r from-slate-900 to-slate-800 text-white text-[11px] gap-2 border-t border-slate-700/50\">\n        <span className=\"truncate font-medium\">\n          {label ||\n            (streaming\n              ? mode === \"phone\"\n                ? \"PHONE LIVE\"\n                : mode === \"wifi\"\n                  ? \"WIFI LIVE\"\n                  : \"LIVE\"\n              : \"Camera\")}\n          {preferredCameraLocked && (\n            <span className=\"ml-2 text-xs opacity-80\">üîí</span>\n          )}\n        </span>\n        <div className=\"flex items-center gap-2\">\n          {!streaming && (\n            <>\n              <button\n                className={`px-2 py-1 rounded-md text-xs font-semibold transition-all ${mode === \"local\" ? \"bg-emerald-500 text-white\" : \"bg-slate-700 text-slate-200 hover:bg-slate-600\"}`}\n                onClick={() => onModeSelect(\"local\")}\n              >\n                Local\n              </button>\n              <button\n                className={`px-2 py-1 rounded-md text-xs font-semibold transition-all ${mode === \"phone\" ? \"bg-emerald-500 text-white\" : \"bg-slate-700 text-slate-200 hover:bg-slate-600\"}`}\n                onClick={() => onModeSelect(\"phone\")}\n              >\n                Phone\n              </button>\n              <button\n                className={`px-2 py-1 rounded-md text-xs font-semibold transition-all ${mode === \"wifi\" ? \"bg-emerald-500 text-white\" : \"bg-slate-700 text-slate-200 hover:bg-slate-600\"}`}\n                onClick={() => onModeSelect(\"wifi\")}\n              >\n                WiFi\n              </button>\n              <button\n                className={`px-2 py-1 rounded-md text-xs font-semibold transition-all ${mode === \"wifi\" ? \"bg-emerald-500 text-white\" : \"bg-slate-700 text-slate-200 hover:bg-slate-600\"}`}\n                onClick={() => onModeSelect(\"usb\")}\n              >\n                USB\n              </button>\n            </>\n          )}\n          {streaming ? (\n            <button\n              className=\"px-2 py-1 rounded-md text-xs font-semibold bg-rose-500 text-white hover:bg-rose-600 transition-all\"\n              onClick={stopAll}\n            >\n              Stop\n            </button>\n          ) : null}\n        </div>\n      </div>\n      {mode === \"phone\" && pairCode && !streaming && (\n        <div className=\"p-2 text-white text-[10px] bg-black/50\">\n          <div className=\"text-xs opacity-80\">Launch on your mobile:</div>\n          <button\n            type=\"button\"\n            className=\"mt-1 w-full text-left px-2 py-1 rounded bg-white/5 border border-white/10 hover:bg-white/10 transition flex items-center gap-2\"\n            onClick={() => copyValue(mobileUrl, \"link\")}\n            title=\"Copy mobile camera link\"\n          >\n            <span className=\"flex-1 min-w-0 font-mono break-all\">\n              {mobileUrl}\n            </span>\n            <span className=\"text-[9px] uppercase tracking-wide whitespace-nowrap text-emerald-200\">\n              {copyFeedback === \"link\" ? \"Copied!\" : \"Copy\"}\n            </span>\n          </button>\n          <div className=\"mt-1 flex items-center gap-2\">\n            <a\n              href={mobileUrl}\n              target=\"_blank\"\n              rel=\"noreferrer\"\n              className=\"px-2 py-1 rounded border border-indigo-500/30 text-indigo-100 hover:bg-indigo-500/20 transition\"\n            >\n              Open link\n            </a>\n            <button\n              type=\"button\"\n              className=\"flex-1 text-left px-2 py-1 rounded bg-white/5 border border-white/10 hover:bg-white/10 transition flex items-center justify-between gap-2\"\n              onClick={() => copyValue(pairCode, \"code\")}\n              title=\"Copy pairing code\"\n            >\n              <span className=\"font-mono tracking-[0.3em] text-sm\">\n                {pairCode}\n              </span>\n              <span className=\"text-[9px] uppercase tracking-wide whitespace-nowrap text-emerald-200\">\n                {copyFeedback === \"code\" ? \"Copied!\" : \"Copy\"}\n              </span>\n            </button>\n          </div>\n          <div className=\"mt-1 flex items-center gap-2\">\n            <button\n              className=\"px-1 py-0.5 rounded bg-slate-700\"\n              onClick={regenerateCode}\n            >\n              Regenerate\n            </button>\n          </div>\n          {showTips && (\n            <div className=\"mt-2 p-2 rounded bg-slate-900/60 border border-slate-700/50 text-slate-200\">\n              <div className=\"font-semibold mb-1\">Troubleshooting</div>\n              <ul className=\"list-disc pl-4 space-y-1\">\n                <li>Phone and desktop must be on the same Wi-Fi network.</li>\n                <li>\n                  Allow the server through your firewall (ports 8787 and{\" \"}\n                  {httpsInfo?.https ? httpsInfo.port : 8788}).\n                </li>\n                <li>\n                  On iPhone, use HTTPS links (QR will prefer https when\n                  enabled).\n                </li>\n              </ul>\n              <div className=\"mt-2 text-right\">\n                <button\n                  className=\"btn btn--ghost px-2 py-1 text-xs\"\n                  onClick={() => setShowTips(false)}\n                >\n                  Hide tips\n                </button>\n              </div>\n            </div>\n          )}\n        </div>\n      )}\n      {mode === \"wifi\" && !streaming && (\n        <div className=\"p-2 text-white text-[10px] bg-black/50\">\n          <div className=\"font-semibold mb-2\">Scoring Devices</div>\n\n          {/* WiFi Devices */}\n          <div className=\"mb-3\">\n            <div className=\"font-medium mb-1\">WiFi Devices</div>\n            {discoveringWifi ? (\n              <div className=\"flex items-center gap-2\">\n                <div className=\"animate-spin rounded-full h-3 w-3 border-b-2 border-white\"></div>\n                <span>Scanning network...</span>\n              </div>\n            ) : wifiDevices.length > 0 ? (\n              <div className=\"space-y-1\">\n                {wifiDevices.map((device: NetworkDevice) => (\n                  <div\n                    key={device.id}\n                    className=\"flex items-center justify-between p-1 rounded bg-slate-900/60\"\n                  >\n                    <div className=\"flex-1 min-w-0\">\n                      <div className=\"font-medium truncate\">{device.name}</div>\n                      <div className=\"opacity-70 text-[9px]\">\n                        {device.ip}:{device.port}\n                      </div>\n                    </div>\n                    <button\n                      className={`px-1 py-0.5 rounded text-[9px] ${\n                        device.status === \"connecting\"\n                          ? \"bg-yellow-600\"\n                          : device.status === \"online\"\n                            ? \"bg-green-600\"\n                            : \"bg-blue-600\"\n                      }`}\n                      onClick={() => connectToWifiDevice(device)}\n                      disabled={device.status === \"connecting\"}\n                    >\n                      {device.status === \"connecting\" ? \"...\" : \"Connect\"}\n                    </button>\n                  </div>\n                ))}\n                <div className=\"text-center mt-2\">\n                  <button\n                    className=\"px-1 py-0.5 rounded bg-slate-700 text-[9px]\"\n                    onClick={startWifiConnection}\n                  >\n                    Rescan WiFi\n                  </button>\n                </div>\n              </div>\n            ) : (\n              <div className=\"text-center\">\n                <div className=\"mb-1 opacity-70\">No WiFi devices found</div>\n                <button\n                  className=\"px-1 py-0.5 rounded bg-slate-700 text-[9px]\"\n                  onClick={startWifiConnection}\n                >\n                  Scan WiFi\n                </button>\n              </div>\n            )}\n          </div>\n\n          {/* USB Devices */}\n          <div>\n            <div className=\"font-medium mb-1\">USB Devices</div>\n            {discoveringUsb ? (\n              <div className=\"flex items-center gap-2\">\n                <div className=\"animate-spin rounded-full h-3 w-3 border-b-2 border-white\"></div>\n                <span>Scanning USB...</span>\n              </div>\n            ) : usbDevices.length > 0 ? (\n              <div className=\"space-y-1\">\n                {usbDevices.map((device: USBDevice) => (\n                  <div\n                    key={device.id}\n                    className=\"flex items-center justify-between p-1 rounded bg-slate-900/60\"\n                  >\n                    <div className=\"flex-1 min-w-0\">\n                      <div className=\"font-medium truncate\">{device.name}</div>\n                      <div className=\"opacity-70 text-[9px]\">\n                        {device.type.toUpperCase()}\n                      </div>\n                    </div>\n                    <button\n                      className={`px-1 py-0.5 rounded text-[9px] ${\n                        device.status === \"connecting\"\n                          ? \"bg-yellow-600\"\n                          : device.status === \"online\"\n                            ? \"bg-green-600\"\n                            : \"bg-blue-600\"\n                      }`}\n                      onClick={() => connectToUsbDevice(device)}\n                      disabled={device.status === \"connecting\"}\n                    >\n                      {device.status === \"connecting\" ? \"...\" : \"Connect üîå\"}\n                    </button>\n                  </div>\n                ))}\n                <div className=\"text-center mt-2\">\n                  <button\n                    className=\"px-1 py-0.5 rounded bg-slate-700 text-[9px]\"\n                    onClick={startUsbConnection}\n                  >\n                    Rescan USB üîç\n                  </button>\n                </div>\n              </div>\n            ) : (\n              <div className=\"text-center\">\n                <div className=\"mb-1 opacity-70\">No USB devices found ‚ùå</div>\n                <button\n                  className=\"px-1 py-0.5 rounded bg-slate-700 text-[9px]\"\n                  onClick={startUsbConnection}\n                >\n                  Scan USB üîç\n                </button>\n              </div>\n            )}\n          </div>\n        </div>\n      )}\n      {!streaming && (\n        <div className=\"mt-3 p-3 rounded-2xl bg-white border border-slate-200 shadow-sm text-slate-900\">\n          <div className=\"flex items-center justify-between mb-2\">\n            <div>\n              <div className=\"text-[10px] uppercase tracking-wide text-slate-500\">\n                Camera modes ‚öôÔ∏è\n              </div>\n              <div className=\"text-sm font-semibold text-slate-900\">\n                Reconnect camera üîÑ\n              </div>\n            </div>\n            <span className=\"text-xs text-slate-500\">\n              Current: {modeDisplayName[mode] || \"Local\"}\n            </span>\n          </div>\n          <p className=\"text-xs text-slate-500 mb-2\">\n            Tap a mode to restart the feed or switch inputs.\n          </p>\n          <div className=\"grid grid-cols-2 gap-2\">\n            {reconnectOptions.map((option) => {\n              const isActive =\n                option.id === \"usb\" ? usbActive : option.id === mode;\n              return (\n                <button\n                  key={option.id}\n                  type=\"button\"\n                  onClick={option.action}\n                  className={`text-left p-3 rounded-2xl border ${isActive ? \"border-emerald-500 bg-emerald-50 shadow\" : \"border-slate-200 bg-white/80 hover:bg-slate-50\"} transition`}\n                >\n                  <div className=\"text-xs font-semibold uppercase tracking-wide text-slate-500\">\n                    {option.title}\n                  </div>\n                  <div className=\"text-[11px] text-slate-600 mt-1\">\n                    {option.description}\n                  </div>\n                  {isActive && (\n                    <div className=\"text-[10px] text-emerald-500 mt-2\">\n                      Active ‚úÖ\n                    </div>\n                  )}\n                </button>\n              );\n            })}\n          </div>\n        </div>\n      )}\n    </div>\n  );\n}\n","import { useEffect, useMemo, useState, useRef, useLayoutEffect, useCallback } from \"react\";\nimport { createPortal } from \"react-dom\";\nimport {\n  getAllTimeAvg,\n  getAllTimeFirstNineAvg,\n  getAllTimeBestCheckout,\n  getAllTimeBestLeg,\n  getAllTime,\n  getAllTime180s,\n} from \"../../store/profileStats\";\nimport type { Player } from \"../../store/match\";\nimport { useCalibration } from \"../../store/calibration\";\nimport { useCameraSession } from \"../../store/cameraSession\";\nimport { useUserSettings } from \"../../store/userSettings\";\n\nimport { memo } from \"react\";\n\nconst StatBlock = memo(function StatBlock({\n  label,\n  value,\n  className = \"\",\n  scale = 1,\n}: {\n  label: string;\n  value: string | number;\n  className?: string;\n  scale?: number;\n}) {\n  return (\n    <div className={`flex flex-col items-center gap-0 ${className}`}>\n      <div className=\"text-[8px] opacity-70 uppercase font-bold tracking-tighter leading-none\">\n        {label}\n      </div>\n      <div\n        className=\"text-sm sm:text-base font-black transform transition-transform duration-200 ease-out leading-none\"\n        style={{ transform: `scale(${scale})` }}\n      >\n        {value}\n      </div>\n    </div>\n  );\n});\n\nconst PlayerCalibrationPreview = memo(function PlayerCalibrationPreview({\n  player,\n  user,\n  playerCalibrations,\n}: {\n  player: Player;\n  user?: any;\n  playerCalibrations: { [playerName: string]: any };\n}) {\n  const canvasRef = useRef<HTMLCanvasElement>(null);\n  const calib = playerCalibrations[player.name];\n  // For the local user, read from the calibration store so the UI updates\n  // immediately after calibrating (and during hydration), even if the\n  // playerCalibrations map hasn't been fetched/updated yet.\n  const localHasH = useCalibration((s) => !!s.H);\n  const isLocalPlayer = !!(\n    (user?.username &&\n      player?.name &&\n      player.name.toLowerCase() === user.username.toLowerCase()) ||\n    player?.name === \"You\"\n  );\n  const isCalibrated = isLocalPlayer ? localHasH : !!calib;\n\n  useEffect(() => {\n    const canvas = canvasRef.current;\n    if (!canvas) return;\n    const ctx = canvas.getContext(\"2d\");\n    if (!ctx) return;\n\n    const centerX = canvas.width / 2;\n    const centerY = canvas.height / 2;\n    const radius = Math.min(centerX, centerY) - 2;\n\n    // Clear canvas\n    ctx.clearRect(0, 0, canvas.width, canvas.height);\n\n    try {\n      // Draw a simple dartboard circle\n      // Outer circle\n      if (typeof ctx.stroke === \"function\") {\n        ctx.strokeStyle = \"#fff\";\n        ctx.lineWidth = 1;\n        ctx.beginPath();\n        ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);\n        ctx.stroke();\n      }\n\n      // Bullseye\n      if (typeof ctx.fill === \"function\") {\n        ctx.fillStyle = \"#f00\";\n        ctx.beginPath();\n        ctx.arc(centerX, centerY, 4, 0, 2 * Math.PI);\n        ctx.fill();\n      }\n    } catch (e) {\n      // Canvas not supported by test environment; ignore and do nothing\n    }\n\n    // If calibrated, draw calibration points\n    if (isCalibrated) {\n      try {\n        if (typeof ctx.fill === \"function\") ctx.fillStyle = \"#0f0\";\n\n        // Draw some sample points (simplified)\n        const points: Array<[number, number]> = [\n          [centerX - radius * 0.5, centerY],\n          [centerX + radius * 0.5, centerY],\n          [centerX, centerY - radius * 0.5],\n          [centerX, centerY + radius * 0.5],\n        ];\n\n        points.forEach(([x, y]) => {\n          try {\n            if (typeof ctx.beginPath === \"function\") ctx.beginPath();\n            if (typeof ctx.arc === \"function\") ctx.arc(x, y, 2, 0, 2 * Math.PI);\n            if (typeof ctx.fill === \"function\") ctx.fill();\n          } catch {}\n        });\n      } catch (e) {\n        // ignore\n      }\n    }\n  }, [isCalibrated]);\n\n  return (\n    <div className=\"flex items-center gap-2 mt-1 bg-white/5 p-1.5 rounded-lg border border-white/10\">\n      <canvas\n        ref={canvasRef}\n        width={40}\n        height={40}\n        className=\"border border-white/20 rounded-md bg-black/60 shadow-inner\"\n      />\n      <span\n        className={`text-xs font-black tracking-tight ${isCalibrated ? \"text-emerald-400\" : \"text-rose-400/70\"}`}\n      >\n        {isCalibrated ? \"Calibrated ‚úÖ\" : \"Not Calibrated ‚ùå\"}\n      </span>\n    </div>\n  );\n});\n\nconst RecentForm = memo(function RecentForm({\n  player,\n  limit = 3,\n}: {\n  player: Player;\n  limit?: number;\n}) {\n  // Compute recent visit scores from player's legs, flatten last visits\n  const visits: { score: number; darts: number }[] = [];\n  try {\n    const legs = (player.legs || []) as any[];\n    for (let i = legs.length - 1; i >= 0 && visits.length < limit; i--) {\n      const leg = legs[i];\n      const legVisits = (leg.visits || []) as any[];\n      for (let j = legVisits.length - 1; j >= 0 && visits.length < limit; j--) {\n        const v = legVisits[j];\n        visits.push({\n          score: Number(v?.score || 0),\n          darts: Number(v?.darts || 3),\n        });\n      }\n    }\n  } catch (e) {}\n  if (!visits.length)\n    return <div className=\"text-[10px] opacity-60\">No visits üìâ</div>;\n  return (\n    <div className=\"flex gap-1 items-center\">\n      {visits.map((v, idx) => (\n        <div\n          key={idx}\n          className={`text-[10px] px-1.5 py-0.5 rounded-md font-black shadow-sm ${v.score >= 100 ? \"bg-emerald-600/70 text-emerald-300 ring-1 ring-emerald-500/50\" : v.score >= 60 ? \"bg-amber-500/60 text-amber-300 ring-1 ring-amber-500/50\" : \"bg-white/20 text-gray-200 ring-1 ring-white/20\"}`}\n        >\n          {v.score}\n        </div>\n      ))}\n    </div>\n  );\n});\n\nimport FocusLock from \"react-focus-lock\";\nimport CalibrationPopup from \"./CalibrationPopup\";\nimport CameraTile from \"../CameraTile\";\nconst ProgressRing = memo(function ProgressRing({\n  secondsLeft,\n  totalSeconds,\n  size = 60,\n  stroke = 6,\n  color = \"emerald\",\n}: {\n  secondsLeft: number;\n  totalSeconds: number;\n  size?: number;\n  stroke?: number;\n  color?: \"emerald\" | \"amber\";\n}) {\n  const radius = (size - stroke) / 2;\n  const circumference = 2 * Math.PI * radius;\n  const percent = Math.max(\n    0,\n    Math.min(1, totalSeconds > 0 ? secondsLeft / totalSeconds : 0),\n  );\n  const dash = circumference * (1 - percent);\n  const colorHex = color === \"emerald\" ? \"#34d399\" : \"#f59e0b\";\n  return (\n    <svg width={size} height={size} viewBox={`0 0 ${size} ${size}`} aria-hidden>\n      <defs>\n        <filter id=\"softShadow\" x=\"-50%\" y=\"-50%\" width=\"200%\" height=\"200%\">\n          <feDropShadow\n            dx=\"0\"\n            dy=\"1\"\n            stdDeviation=\"3\"\n            floodColor=\"#000\"\n            floodOpacity=\"0.45\"\n          />\n        </filter>\n      </defs>\n      <circle\n        cx={size / 2}\n        cy={size / 2}\n        r={radius}\n        fill=\"transparent\"\n        stroke=\"rgba(255,255,255,0.06)\"\n        strokeWidth={stroke}\n      />\n      <circle\n        cx={size / 2}\n        cy={size / 2}\n        r={radius}\n        fill=\"transparent\"\n        stroke={colorHex}\n        strokeWidth={stroke}\n        strokeLinecap=\"round\"\n        strokeDasharray={circumference}\n        strokeDashoffset={dash}\n        transform={`rotate(-90 ${size / 2} ${size / 2})`}\n        style={{ filter: \"drop-shadow(0 1px 2px rgba(0,0,0,0.4))\" }}\n      />\n      <text\n        x=\"50%\"\n        y=\"50%\"\n        fill=\"white\"\n        fontSize={size * 0.28}\n        fontWeight={900}\n        dominantBaseline=\"middle\"\n        textAnchor=\"middle\"\n      >\n        {secondsLeft > 0 ? secondsLeft : \"GO\"}\n      </text>\n    </svg>\n  );\n});\nexport default function MatchStartShowcase({\n  open = true,\n  players,\n  user,\n  onDone,\n  onRequestClose,\n  initialSeconds = 15,\n  showCalibrationDefault = false,\n  disableEscClose = false,\n}: {\n  open?: boolean;\n  players: Player[];\n  user?: any;\n  onDone?: () => void;\n  onRequestClose?: () => void;\n  initialSeconds?: number;\n  showCalibrationDefault?: boolean;\n  disableEscClose?: boolean;\n}) {\n  // Debug logs removed\n  const [seconds, setSeconds] = useState(initialSeconds || 15);\n  // Overlay visibility is controlled by parent; the component should be controlled using `open` and `onRequestClose`.\n  const visible = !!open;\n  const cameraSession = useCameraSession();\n  const setCameraEnabled = useUserSettings.getState().setCameraEnabled;\n  // Subscribe only to the specific fields we need. Avoid returning a new object\n  // from the selector on every store update, which can cause extra re-renders.\n  const hasHomography = useCalibration((s) => !!s.H);\n  const calibrationLocked = useCalibration((s) => !!s.locked);\n  const calibrationConfidence = useCalibration((s) => s.confidence);\n  const localCalibration = useMemo(\n    () => ({\n      hasHomography,\n      locked: calibrationLocked,\n      confidence: calibrationConfidence,\n    }),\n    [hasHomography, calibrationLocked, calibrationConfidence],\n  );\n  const calibratedCameraLinked =\n    cameraSession.isStreaming && localCalibration.hasHomography;\n  const [showCalibration, setShowCalibration] = useState(false);\n  const [calibrationSkipped, setCalibrationSkipped] = useState<{\n    [playerId: string]: boolean;\n  }>(() => {\n    const map: { [k: string]: boolean } = {};\n    if (!showCalibrationDefault) {\n      for (const p of players) map[p.id] = true;\n    }\n    return map;\n  });\n  const [playerCalibrations, setPlayerCalibrations] = useState<{\n    [playerName: string]: any;\n  }>({});\n  const hostRef = useRef<HTMLDivElement | null>(null);\n  const startNowRef = useRef<HTMLButtonElement | null>(null);\n  const closeRef = useRef<HTMLButtonElement | null>(null);\n  const prevActiveElement = useRef<HTMLElement | null>(null);\n  // mountedRef ensures keyboard events that fire during render/mount don't prematurely close the overlay\n  const mountedRef = useRef(false);\n\n  useEffect(() => {\n    // mark mounted after first paint to ensure early key events don't trigger a close mid-render\n    mountedRef.current = true;\n    return () => {\n      mountedRef.current = false;\n    };\n  }, []);\n\n  // If players list widens after mount, ensure new players inherit the skip state\n  useEffect(() => {\n    if (!showCalibrationDefault) {\n      setCalibrationSkipped((prev) => {\n        const next = { ...prev };\n        for (const p of players) if (!next[p.id]) next[p.id] = true;\n        return next;\n      });\n    }\n  }, [players, showCalibrationDefault]);\n\n  const allPlayersSkipped = players.every((p) => calibrationSkipped[p.id]);\n\n  // visibility is controlled by parent via `open` prop\n\n  useEffect(() => {\n    if (!visible) return;\n    // Ensure the calibrated camera is enabled and streamed into the pre-match preview.\n    try {\n      setCameraEnabled(true);\n    } catch {}\n    try {\n      if (cameraSession.getMediaStream() && !cameraSession.isStreaming) {\n        cameraSession.setStreaming(true);\n      }\n      cameraSession.setShowOverlay?.(true);\n    } catch {}\n    // useEffect(visible) entered\n    // Ensure initial focus is on the Start Now button for convenience\n    try {\n      setTimeout(() => {\n        try {\n          startNowRef.current?.focus();\n        } catch {}\n      }, 0);\n    } catch {}\n    // remember previous active element so we can restore on close\n    try {\n      prevActiveElement.current = document.activeElement as HTMLElement;\n    } catch {}\n    // Hide app content from screen readers while overlay is open\n    const appRoot = document.getElementById(\"root\");\n    try {\n      if (appRoot) appRoot.setAttribute(\"aria-hidden\", \"true\");\n    } catch {}\n    // Countdown interval:\n    // - create only when needed\n    // - stop at 0 to avoid going negative (which causes useless re-renders)\n    const t = allPlayersSkipped\n      ? setInterval(() =>\n          setSeconds((s) => {\n            if (s <= 0) return 0;\n            return s - 1;\n          }),\n        1000)\n      : null;\n    const onKey = (e: KeyboardEvent) => {\n      if (!mountedRef.current) return;\n      if (!disableEscClose && (e.key === \"Escape\" || e.key === \"Esc\")) {\n        e.preventDefault();\n        // Ensure parent handlers are invoked asynchronously so we don't unmount during render\n        try {\n          setTimeout(() => {\n            try {\n              onRequestClose?.();\n            } catch {}\n          }, 0);\n        } catch {}\n        try {\n          prevActiveElement.current?.focus();\n        } catch {}\n      }\n    };\n    document.addEventListener(\"keydown\", onKey);\n    // Cleanup and restore aria-hidden\n    return () => {\n      // useEffect(visible) cleanup\n      try {\n        if (appRoot) {\n          appRoot.removeAttribute(\"aria-hidden\");\n        }\n      } catch {}\n      if (t) clearInterval(t);\n      document.removeEventListener(\"keydown\", onKey);\n    };\n  }, [visible, disableEscClose, onRequestClose, allPlayersSkipped]);\n\n  useEffect(() => {\n    if (!visible) return;\n    // Show calibration popup immediately when countdown starts\n    if (\n      showCalibrationDefault &&\n      seconds === (initialSeconds || 15) &&\n      !showCalibration\n    ) {\n      setShowCalibration(true);\n      // Fetch calibrations for all players\n      const fetchCalibrations = async () => {\n        const calibs: { [playerName: string]: any } = {};\n        for (const player of players) {\n          if (user?.username && player.name === user.username) {\n            // Local user: use store\n            const { H, imageSize, overlaySize, locked } =\n              useCalibration.getState();\n            // Treat local calibration as valid when we have a homography.\n            // `locked` is a workflow/UI flag and shouldn't cause the pre-match UI to say \"Not Calibrated\".\n            if (H) calibs[player.name] = { H, imageSize, overlaySize, locked };\n          } else {\n            // Remote user: fetch from server\n            try {\n              const res = await fetch(\n                `/api/users/${encodeURIComponent(player.name)}/calibration`,\n              );\n              if (res.ok) {\n                const data = await res.json();\n                if (data.calibration) calibs[player.name] = data.calibration;\n              }\n            } catch (err) {\n              console.warn(\"Failed to fetch calibration for\", player.name, err);\n            }\n          }\n        }\n        setPlayerCalibrations(calibs);\n      };\n      fetchCalibrations();\n    }\n    // Only start countdown when all players have skipped calibration\n    if (allPlayersSkipped) {\n      if (seconds <= 0) {\n        // countdown reached 0, scheduling close\n        // Done; small delay to let the \"Game On\" message show\n        setTimeout(() => {\n          // Do not set local visible state here when controlled; delegate close to parent via onRequestClose/onDone\n          // calling onDone/onRequestClose\n          try {\n            onDone?.();\n          } catch {}\n          try {\n            setTimeout(() => {\n              try {\n                onRequestClose?.();\n              } catch {}\n            }, 0);\n          } catch {}\n          // Return focus to previous element\n          try {\n            prevActiveElement.current?.focus();\n          } catch {}\n        }, 1000);\n      }\n    }\n  }, [\n    seconds,\n    onDone,\n    visible,\n    showCalibration,\n    allPlayersSkipped,\n    players,\n    user,\n  ]);\n\n  const stats = useMemo(\n    () =>\n      players.map((p) => {\n        try {\n          const avg3 = getAllTimeAvg(p.name);\n          const best9 = getAllTimeFirstNineAvg(p.name);\n          const bestCheckout = getAllTimeBestCheckout(p.name);\n          const bestLeg = getAllTimeBestLeg(p.name);\n          const all = getAllTime(p.name);\n          const lifetimeScored = all.scored || 0;\n          const lifetimeDarts = all.darts || 0;\n          const career180s = getAllTime180s(p.name);\n          // Count match 180s for the provided player\n          let match180s = 0;\n          try {\n            for (const L of p.legs || []) {\n              for (const v of L.visits || []) {\n                if (Number(v.score || 0) === 180) match180s += 1;\n              }\n            }\n          } catch {}\n          const one80s = `${match180s}/${career180s}`;\n          return {\n            id: p.id,\n            name: p.name,\n            avg3: avg3.toFixed(1),\n            best9: best9.toFixed(1),\n            bestCheckout,\n            bestLeg,\n            one80s,\n            lifetimeScored,\n            lifetimeDarts,\n          };\n        } catch (err) {\n          // Swallow errors computing stats to avoid breaking render in tests\n          return {\n            id: p.id,\n            name: p.name,\n            avg3: \"‚Äî\",\n            best9: \"‚Äî\",\n            bestCheckout: \"‚Äî\",\n            bestLeg: \"‚Äî\",\n            one80s: \"‚Äî\",\n            lifetimeScored: 0,\n            lifetimeDarts: 0,\n          };\n        }\n      }),\n    [players],\n  );\n  // Create and manage a portal container so overlays appended to body are cleaned up and avoid duplicates in tests\n  const portalElRef = useRef<HTMLDivElement | null>(\n    typeof document !== \"undefined\" ? document.createElement(\"div\") : null,\n  );\n  useLayoutEffect(() => {\n    if (!portalElRef.current) return;\n    const el = portalElRef.current;\n    el.className = \"ndn-match-start-portal\";\n    try {\n      const old = Array.from(\n        document.querySelectorAll(\".ndn-match-start-portal\"),\n      );\n      old.forEach((o) => {\n        try {\n          o.parentNode?.removeChild(o);\n        } catch {}\n      });\n    } catch {}\n    document.body.appendChild(el);\n    return () => {\n      try {\n        if (el && el.parentNode) el.parentNode.removeChild(el);\n      } catch {}\n    };\n  }, []);\n\n  // These hooks must run even when the overlay is not visible to avoid hook-order\n  // mismatches if `open` toggles quickly during tests.\n  const getScaleFor = useCallback((s: number) => {\n    if (s <= 0) return 1.8;\n    if (s === 1) return 1.6;\n    if (s === 2) return 1.4;\n    if (s === 3) return 1.2;\n    return 1;\n  }, []);\n\n  const calibrationConfidencePercent = useMemo(() => {\n    const confidence = localCalibration.confidence as\n      | number\n      | null\n      | { percentage?: number };\n    if (typeof confidence === \"number\") return confidence;\n    if (\n      confidence &&\n      typeof confidence === \"object\" &&\n      typeof confidence.percentage === \"number\"\n    ) {\n      return confidence.percentage;\n    }\n    return null;\n  }, [localCalibration.confidence]);\n\n  const calibrationStatusText = calibratedCameraLinked\n    ? `Calibrated camera linked${typeof calibrationConfidencePercent === \"number\" ? ` ‚Ä¢ ${calibrationConfidencePercent.toFixed(0)}% confidence` : \"\"}`\n    : \"Calibrate to link this camera feed\";\n\n  if (!visible) return null;\n\n  // Render the extracted CalibrationPopup component, passing required handlers\n\n  // calibrationStatusText defined above\n\n  const overlay = (\n    <div className=\"fixed inset-0 z-50 overflow-y-auto bg-black/90 backdrop-blur-sm\">\n      <div className=\"min-h-full flex items-center justify-center p-4 sm:p-6 lg:p-8\">\n        <div\n          role=\"dialog\"\n          aria-modal=\"true\"\n          aria-labelledby=\"match-start-heading\"\n          tabIndex={-1}\n          className=\"w-full max-w-4xl\"\n        >\n          <FocusLock returnFocus={true}>\n            <div ref={hostRef} className=\"relative\">\n            {/* Decorative background glow */}\n            <div className=\"absolute -inset-4 bg-gradient-to-r from-indigo-500/20 via-purple-500/20 to-emerald-500/20 rounded-[3rem] blur-3xl -z-10 opacity-50 animate-pulse\" />\n\n            <div className=\"bg-[#13111C] border border-white/10 rounded-3xl p-4 md:p-6 w-full shadow-2xl ring-1 ring-white/5 relative overflow-hidden\">\n              {/* Background pattern */}\n              <div className=\"absolute inset-0 bg-[url('https://grainy-gradients.vercel.app/noise.svg')] opacity-20 pointer-events-none mix-blend-overlay\"></div>\n\n              <div className=\"relative z-10 flex flex-col md:flex-row items-center justify-between gap-3 mb-4 border-b border-white/5 pb-3\">\n                <div>\n                  <div className=\"text-[9px] font-bold text-indigo-400 uppercase tracking-widest mb-0.5\">\n                    Get Ready üöÄ\n                  </div>\n                  <div\n                    id=\"match-start-heading\"\n                    className=\"text-2xl md:text-4xl font-black text-transparent bg-clip-text bg-gradient-to-r from-white via-white to-white/10 tracking-tighter\"\n                  >\n                    Match Starting Soon üéØ\n                  </div>\n                </div>\n\n                <div className=\"flex items-center gap-3\">\n                  <div className=\"flex items-center gap-2\">\n                    <div className=\"relative\">\n                      <div className=\"absolute inset-0 bg-emerald-500/70 blur-[4rem] rounded-full animate-pulse\"></div>\n                      <div className=\"relative\">\n                        <ProgressRing\n                          secondsLeft={seconds}\n                          totalSeconds={initialSeconds || 15}\n                          size={60}\n                          stroke={6}\n                          color={seconds > 5 ? \"emerald\" : \"amber\"}\n                        />\n                        <div className=\"absolute inset-0 flex items-center justify-center\">\n                          <span className=\"text-xl font-black text-white tabular-nums\">\n                            {seconds}\n                          </span>\n                        </div>\n                      </div>\n                    </div>\n                  </div>\n\n                  <div className=\"flex flex-col gap-1.5 sm:flex-row\">\n                    <button\n                      ref={startNowRef}\n                      className=\"px-4 py-1.5 rounded-lg bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-bold shadow-lg shadow-indigo-500/25 hover:shadow-indigo-500/40 hover:scale-105 transition-all duration-200 active:scale-95 text-xs\"\n                      onClick={() => {\n                        try {\n                          onDone?.();\n                        } catch {}\n                        try {\n                          try {\n                            document\n                              .getElementById(\"root\")\n                              ?.removeAttribute(\"aria-hidden\");\n                          } catch {}\n                          setTimeout(() => {\n                            try {\n                              onRequestClose?.();\n                            } catch {}\n                          }, 0);\n                        } catch {}\n                      }}\n                      aria-label=\"Start match now\"\n                    >\n                      Start Now ‚ñ∂Ô∏è\n                    </button>\n                    <button\n                      ref={closeRef}\n                      className=\"px-3 py-1.5 rounded-lg bg-white/5 text-white/70 font-semibold hover:bg-white/10 hover:text-white transition-colors text-xs\"\n                      aria-label=\"Close match start showcase\"\n                      onClick={() => {\n                        try {\n                          onRequestClose?.();\n                        } catch {}\n                      }}\n                    >\n                      Close ‚úñÔ∏è\n                    </button>\n                  </div>\n                </div>\n              </div>\n\n              <div className=\"relative grid grid-cols-1 md:grid-cols-2 gap-3 md:gap-5 mb-4\">\n                {/* VS Badge for Desktop */}\n                <div className=\"hidden md:flex absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 z-20 w-16 h-16 bg-[#13111C] rounded-full items-center justify-center border-2 border-white/10 shadow-[0_0_30px_rgba(0,0,0,0.8)]\">\n                  <span className=\"text-xl font-black text-white/20 italic tracking-tighter\">\n                    VS ‚öîÔ∏è\n                  </span>\n                </div>\n\n                {stats.map((st, idx) => (\n                  <div\n                    key={st.id}\n                    className={`group relative p-3 md:p-4 rounded-3xl border border-white/5 flex flex-col items-center shadow-xl transition-all duration-300 hover:border-white/10 hover:bg-white/[0.02] max-h-[80vh] overflow-hidden ${idx === 0 ? \"bg-gradient-to-br from-indigo-500/5 to-transparent\" : \"bg-gradient-to-bl from-emerald-500/5 to-transparent\"}`}\n                  >\n                    <div className=\"flex items-center gap-3 mb-2 w-full\">\n                      <div\n                        className={`w-12 h-12 shrink-0 rounded-xl rotate-3 group-hover:rotate-6 transition-transform duration-300 flex items-center justify-center text-xl font-black text-white shadow-lg ring-2 ring-white/10 ${idx === 0 ? \"bg-gradient-to-br from-indigo-500 to-purple-600 shadow-indigo-500/50\" : \"bg-gradient-to-br from-emerald-500 to-teal-600 shadow-emerald-500/50\"}`}\n                      >\n                        {st.name\n                          .split(\" \")\n                          .map((n) => n[0])\n                          .join(\"\")\n                          .toUpperCase()\n                          .slice(0, 2)}\n                      </div>\n                      <div className=\"flex flex-col min-w-0\">\n                        <div className=\"text-2xl font-black text-white tracking-tighter truncate\">\n                          {st.name}\n                        </div>\n                        <div className=\"text-[10px] font-black tracking-tight text-white/60\">\n                          {st.one80s}\n                        </div>\n                        <div className=\"flex items-center gap-2\">\n                          {user && user.username === st.name && (\n                            <div className=\"text-[0.5rem] font-bold uppercase tracking-wider bg-white/10 text-white/60 px-1.5 py-0.5 rounded-md\">\n                              You ‚≠ê\n                            </div>\n                          )}\n                          <PlayerCalibrationPreview\n                            player={players.find((p) => p.id === st.id) as any}\n                            user={user}\n                            playerCalibrations={playerCalibrations}\n                          />\n                        </div>\n                      </div>\n                    </div>\n\n                    <div className=\"grid grid-cols-4 gap-1 w-full bg-black/50 rounded-xl p-2 border border-white/10 shadow-2xl\">\n                      <StatBlock\n                        label=\"Avg üìä\"\n                        value={st.avg3}\n                        scale={getScaleFor(seconds) * 0.7}\n                        className=\"p-0.5\"\n                      />\n                      <StatBlock\n                        label=\"F9 üìà\"\n                        value={st.best9}\n                        scale={getScaleFor(seconds) * 0.7}\n                        className=\"p-0.5\"\n                      />\n                      <StatBlock\n                        label=\"CO üèÜ\"\n                        value={st.bestCheckout || \"‚Äî\"}\n                        scale={getScaleFor(seconds) * 0.7}\n                        className=\"p-0.5\"\n                      />\n                      <StatBlock\n                        label=\"Leg ‚ö°\"\n                        value={st.bestLeg || \"‚Äî\"}\n                        scale={getScaleFor(seconds) * 0.7}\n                        className=\"p-0.5\"\n                      />\n                    </div>\n\n                    <div className=\"grid grid-cols-2 gap-2 w-full mt-2 text-[0.6rem]\">\n                      <div className=\"flex items-center justify-between px-2 py-1 rounded-lg bg-white/5 border border-white/5\">\n                        <span className=\"tracking-widest uppercase text-white/40\">\n                          Lifetime pts\n                        </span>\n                        <span className=\"text-white/90 font-semibold\">\n                          {st.lifetimeScored.toLocaleString()}\n                        </span>\n                      </div>\n                      <div className=\"flex items-center justify-between px-2 py-1 rounded-lg bg-white/5 border border-white/5\">\n                        <span className=\"tracking-widest uppercase text-white/40\">\n                          Lifetime darts\n                        </span>\n                        <span className=\"text-white/90 font-semibold\">\n                          {st.lifetimeDarts.toLocaleString()}\n                        </span>\n                      </div>\n                    </div>\n\n                    <div className=\"mt-2 flex items-center justify-between w-full px-1\">\n                      <div className=\"flex items-center gap-2 text-sm text-white/40 font-black\">\n                        <span>180s üî•:</span>\n                        <span className=\"text-white/90\">{st.one80s} ‚ú®</span>\n                      </div>\n                      <RecentForm\n                        player={players.find((p) => p.id === st.id) as Player}\n                        limit={3}\n                      />\n                    </div>\n\n                    {/* Pre-match live camera preview (uses the global camera session) */}\n                    {idx === 0 && (\n                      <div className=\"w-full mt-2\">\n                        <div className=\"rounded-lg overflow-hidden border border-white/10 bg-black/30 relative\">\n                          <div\n                            className={`absolute top-3 left-3 px-3 py-1 rounded-full text-[0.6rem] font-bold tracking-wide uppercase shadow-lg ${calibratedCameraLinked ? \"bg-emerald-500/90 text-emerald-50\" : \"bg-rose-500/80 text-white\"}`}\n                          >\n                            {calibrationStatusText}\n                          </div>\n                          {/* Show the full board (no crop) */}\n                          <div className=\"w-full h-[240px] sm:h-[300px] md:h-[360px] flex flex-col\">\n                            <CameraTile\n                              autoStart\n                              forceAutoStart\n                              fill\n                              aspect=\"free\"\n                              tileFitModeOverride=\"fit\"\n                              scale={1}\n                            />\n                          </div>\n                        </div>\n                      </div>\n                    )}\n                  </div>\n                ))}\n              </div>\n\n              <div className=\"text-center pt-6 border-t border-white/50\">\n                {seconds <= 1 ? (\n                  <div className=\"text-6xl font-black text-transparent bg-clip-text bg-gradient-to-r from-emerald-400 via-cyan-400 to-blue-400 animate-bounce tracking-tighter py-4\">\n                    GAME ON! üöÄ\n                  </div>\n                ) : (\n                  <div className=\"text-lg font-black text-white/80 uppercase tracking-[1em]\">\n                    {players.map((p) => p.name).join(\" vs \")} ‚öîÔ∏è\n                  </div>\n                )}\n              </div>\n            </div>\n          </div>\n        </FocusLock>\n      </div>\n    </div>\n  </div>\n  );\n  return createPortal(\n    <>\n      {showCalibration && (\n        <CalibrationPopup\n          players={players}\n          playerCalibrations={playerCalibrations}\n          calibrationSkipped={calibrationSkipped}\n          onSkip={(id: string) =>\n            setCalibrationSkipped((prev) => ({ ...prev, [id]: true }))\n          }\n          onOpenCalibrator={(id: string) => {\n            setCalibrationSkipped((prev) => ({ ...prev, [id]: false }));\n            try {\n              window.dispatchEvent(\n                new CustomEvent(\"ndn:change-tab\", {\n                  detail: { tab: \"calibrate\" },\n                }),\n              );\n            } catch {}\n            // Tell parent to close the overlay so the user can calibrate\n            try {\n              setTimeout(() => {\n                try {\n                  onRequestClose?.();\n                } catch {}\n              }, 0);\n            } catch {}\n          }}\n          onClose={() => {\n            setShowCalibration(false);\n          }}\n        />\n      )}\n      {overlay}\n    </>,\n    portalElRef.current as HTMLDivElement,\n  );\n}\n"],"names":["GameCalibrationStatus","gameMode","compact","onRecalibrate","H","errorPx","storedConfidence","useCalibration","gameConfidence","getCalibrationConfidenceForGame","suitable","isCalibrationSuitableForGame","text","getCalibrationQualityText","recommendation","getRecalibrationRecommendation","requirement","GAME_CALIBRATION_REQUIREMENTS","baseConfidence","getGlobalCalibrationConfidence","showConfidenceNote","hasCalibration","jsxs","jsx","AlertTriangle","CheckCircle","isPerfect","bgColor","textColor","icon","Zap","React","AlertCircle","CalibrationPopup","players","playerCalibrations","calibrationSkipped","onSkip","onOpenCalibrator","onClose","skippedPlayers","p","remainingPlayers","canStartMatch","player","n","discoverNetworkDevices","devices","localIPs","getLocalIPs","localIP","scanResults","scanNetwork","result","device","probeDevice","error","ips","pc","offer","resolve","timeout","event","ipMatch","ip","isPrivateIP","parts","ports","results","baseIP","promises","i","port","checkPort","index","portIndex","ipIndex","response","endpoints","endpoint","contentType","discoverUSBDevices","probeUSBDevice","requestUSBDevice","reader","value","done","connectToNetworkDevice","streamUrl","video","reject","canvas","ctx","stream","drawFrame","connectToUSBDevice","CameraTile","label","autoStart","forceAutoStart","scaleOverrideProp","className","aspect","style","fill","tileFitModeOverrideProp","videoRef","useRef","cameraSession","useCameraSession","streaming","setStreaming","useState","ws","setWs","pairCode","setPairCode","setPc","lastRegisteredModeRef","useEffect","registerStream","useCallback","modeOverride","err","attachExistingStream","existingStream","e","preferredCameraLabel","useUserSettings","s","mode","setMode","setExpiresAt","setPaired","lanHost","setLanHost","httpsInfo","setHttpsInfo","showTips","setShowTips","wifiDevices","setWifiDevices","discoveringWifi","setDiscoveringWifi","usbDevices","setUsbDevices","discoveringUsb","setDiscoveringUsb","autoscoreProvider","cameraEnabledSetting","setPreferredCameraLocked","preferredCameraLocked","setPreferredCamera","preferredCameraId","fallbackClass","fallbackStyle","h","apiFetch","r","j","x","mobileUrl","useMemo","code","envUrl","u","host","useHttps","manualModeSetAt","setManualModeSetAt","apply","v","cleared","t","maybeClear","ok","start","startWifiConnection","startPhonePairing","stop","cancelled","desiredLabel","timer","connectToWifiDevice","d","startUsbConnection","newDevice","prev","connectToUsbDevice","handleModeSelect","newMode","onStart","ev","modeFromEvent","ensureWS","url","getPreferredWsUrl","socket","data","peer","inbound","regenerateCode","stopAll","CameraFrame","props","cameraScale","storedAspect","onModeSelect","scaleOverride","tileFitModeOverride","modeDisplayName","reconnectOptions","copyFeedback","setCopyFeedback","copyTimeoutRef","globalFitMode","effectiveFitMode","scale","raw","clamped","aspectChoice","shouldMaintainAspect","aspectClass","containerClass","containerStyle","viewportClass","commonVideoProps","usbActive","videoElement","baseVideoClass","copyValue","type","textarea","Fragment","option","isActive","StatBlock","memo","PlayerCalibrationPreview","user","canvasRef","calib","localHasH","isCalibrated","centerX","centerY","radius","y","RecentForm","limit","visits","legs","legVisits","idx","ProgressRing","secondsLeft","totalSeconds","size","stroke","color","circumference","percent","dash","colorHex","MatchStartShowcase","open","onDone","onRequestClose","initialSeconds","showCalibrationDefault","disableEscClose","seconds","setSeconds","visible","setCameraEnabled","hasHomography","calibrationLocked","calibrationConfidence","localCalibration","calibratedCameraLinked","showCalibration","setShowCalibration","setCalibrationSkipped","map","setPlayerCalibrations","hostRef","startNowRef","closeRef","prevActiveElement","mountedRef","next","allPlayersSkipped","appRoot","onKey","calibs","imageSize","overlaySize","locked","res","stats","avg3","getAllTimeAvg","best9","getAllTimeFirstNineAvg","bestCheckout","getAllTimeBestCheckout","bestLeg","getAllTimeBestLeg","all","getAllTime","lifetimeScored","lifetimeDarts","career180s","getAllTime180s","match180s","L","one80s","portalElRef","useLayoutEffect","el","o","getScaleFor","calibrationConfidencePercent","confidence","calibrationStatusText","overlay","FocusLock","st","createPortal","id"],"mappings":"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"}