{"version":3,"file":"CameraView-B8kAgv_j.js","sources":["../../src/utils/autoscore.ts","../../src/utils/dartDetector.ts","../../src/utils/scoring.ts","../../src/components/ui/ResizablePanel.tsx","../../src/store/heatmap.ts","../../src/store/matchControl.ts","../../src/components/CameraView.tsx"],"sourcesContent":["import type { Homography, Point } from './vision'\r\nimport { imageToBoard, scoreAtBoardPoint } from './vision'\r\n\r\nexport function scoreFromImagePoint(H_boardToImage: Homography, pImg: Point) {\r\n\tconst pBoard = imageToBoard(H_boardToImage, pImg)\r\n\treturn scoreAtBoardPoint(pBoard)\r\n}\r\n","// High-accuracy dart detector for built-in autoscore\r\n// Strategy:\r\n// - Maintain a grayscale background model (running average) when no darts are present\r\n// - For each frame, compute abs-diff mask vs background and apply a 3x3 morphological closing to reduce noise\r\n// - Restrict detection to a circular ROI around board center (from calibration) to ignore background\r\n// - Find the largest foreground blob; compute PCA on blob pixels to estimate shaft orientation\r\n// - Estimate the tip as the extreme along the principal axis in the outward radial direction from board center\r\n// - Stabilize across consecutive frames (2+) before emitting a detection; debounce between darts\r\n\r\nexport type Point = { x: number; y: number }\r\n\r\nexport type DartDetection = {\r\n  tip: Point\r\n  axis?: { x1: number; y1: number; x2: number; y2: number }\r\n  area: number\r\n  bbox: { x: number; y: number; w: number; h: number }\r\n  confidence: number // 0..1 heuristic\r\n}\r\n\r\nexport class DartDetector {\r\n  private width = 0\r\n  private height = 0\r\n  private bg: Float32Array | null = null // grayscale background\r\n  private lastAcceptTs = 0\r\n  private cooldownMs = 600\r\n  private roiRadius = 0 // pixels; 0 means disabled\r\n  private roiCx = 0\r\n  private roiCy = 0\r\n  private initialized = false\r\n\r\n  // Tuning\r\n  private thresh = 28 // intensity threshold for foreground\r\n  private minArea = 90 // min connected pixels to consider a dart\r\n  private maxArea = 6000 // guard against massive motion\r\n  // temporal stabilization\r\n  private prevTip: Point | null = null\r\n  private prevArea: number = 0\r\n  private stableCount = 0\r\n  private requireStableN = 1\r\n\r\n  constructor() {}\r\n\r\n  setROI(cx: number, cy: number, radius: number) {\r\n    this.roiCx = cx; this.roiCy = cy; this.roiRadius = Math.max(0, radius|0)\r\n  }\r\n\r\n  reset(width: number, height: number) {\r\n    this.width = width\r\n    this.height = height\r\n    this.bg = new Float32Array(width * height)\r\n    this.initialized = false\r\n  }\r\n\r\n  // Seed or update background model with the provided frame\r\n  // If not initialized, copy; else running average with small alpha\r\n  updateBackground(frame: ImageData, alpha = 0.05) {\r\n    const { width: w, height: h, data } = frame\r\n    if (!this.bg || w !== this.width || h !== this.height) {\r\n      this.reset(w, h)\r\n    }\r\n    const bg = this.bg!\r\n    const n = w * h\r\n    for (let i = 0, p = 0; i < n; i++, p += 4) {\r\n      const r = data[p], g = data[p+1], b = data[p+2]\r\n      const gray = 0.299*r + 0.587*g + 0.114*b\r\n      if (!this.initialized) bg[i] = gray\r\n      else bg[i] = (1 - alpha) * bg[i] + alpha * gray\r\n    }\r\n    this.initialized = true\r\n  }\r\n\r\n  private inRoi(x: number, y: number): boolean {\r\n    if (this.roiRadius <= 0) return true\r\n    const dx = x - this.roiCx\r\n    const dy = y - this.roiCy\r\n    return (dx*dx + dy*dy) <= this.roiRadius * this.roiRadius\r\n  }\r\n\r\n  // Returns a detection if a new dart-like blob is found; null otherwise\r\n  detect(frame: ImageData): DartDetection | null {\r\n    const now = Date.now()\r\n    const recent = (now - this.lastAcceptTs) < this.cooldownMs\r\n    const { width: w, height: h, data } = frame\r\n    if (!this.bg || w !== this.width || h !== this.height) this.reset(w, h)\r\n    const bg = this.bg!\r\n    if (!this.initialized) {\r\n      this.updateBackground(frame, 1.0)\r\n      return null\r\n    }\r\n\r\n    // Build diff buffer and compute dynamic threshold excluding specular highlights\r\n    const n = w * h\r\n    const mask = new Uint8Array(n)\r\n    const diff = new Float32Array(n)\r\n    let sum = 0, sum2 = 0, cnt = 0\r\n    const isHighlight = new Uint8Array(n)\r\n    for (let i = 0, p = 0; i < n; i++, p += 4) {\r\n      const r = data[p], g = data[p+1], b = data[p+2]\r\n      const maxc = Math.max(r, g, b)\r\n      const minc = Math.min(r, g, b)\r\n      const gray = 0.299*r + 0.587*g + 0.114*b\r\n      const d = Math.abs(gray - bg[i])\r\n      diff[i] = d\r\n      const y = Math.floor(i / w)\r\n      const x = i - y * w\r\n      // specular highlight heuristic: very bright with low chroma\r\n      const satApprox = maxc === 0 ? 0 : (maxc - minc) / maxc\r\n      const isHi = (maxc >= 250) && (satApprox <= 0.12)\r\n      if (isHi) isHighlight[i] = 1\r\n      if (this.inRoi(x, y) && !isHi) { sum += d; sum2 += d*d; cnt++ }\r\n    }\r\n    const mu = cnt ? (sum / cnt) : 0\r\n    const var_ = cnt ? Math.max(0, (sum2 / cnt) - mu*mu) : 0\r\n    const sigma = Math.sqrt(var_)\r\n    const dynamicThresh = Math.max(this.thresh, mu + 1.2 * sigma)\r\n    // Rebuild mask using dynamic threshold and ignoring highlights\r\n    for (let i = 0; i < n; i++) {\r\n      if (isHighlight[i]) { mask[i] = 0; continue }\r\n      if (diff[i] > dynamicThresh) {\r\n        const y = Math.floor(i / w)\r\n        const x = i - y * w\r\n        mask[i] = this.inRoi(x, y) ? 1 : 0\r\n      }\r\n    }\r\n\r\n    // Morphological closing (dilate then erode) to consolidate thin shapes\r\n    this._dilate(mask, w, h)\r\n    this._erode(mask, w, h)\r\n\r\n    // Connected components (single pass using queue BFS); track largest blob\r\n    const visited = new Uint8Array(n)\r\n    let bestArea = 0\r\n    let bestIdxs: number[] | null = null\r\n    for (let i = 0; i < n; i++) {\r\n      if (mask[i] === 0 || visited[i]) continue\r\n      const idxs: number[] = []\r\n      let area = 0\r\n      let qh = 0\r\n      const q: number[] = [i]\r\n      visited[i] = 1\r\n      while (qh < q.length) {\r\n        const cur = q[qh++]\r\n        idxs.push(cur)\r\n        area++\r\n        const y = (cur / w) | 0\r\n        const x = cur - y * w\r\n        // 4-neighborhood\r\n        const nbs = [cur - 1, cur + 1, cur - w, cur + w]\r\n        for (const nb of nbs) {\r\n          if (nb < 0 || nb >= n) continue\r\n          if (visited[nb]) continue\r\n          // bounds checks for left/right\r\n          if ((nb === cur - 1 || nb === cur + 1) && ((nb / w | 0) !== y)) continue\r\n          if (mask[nb]) { visited[nb] = 1; q.push(nb) }\r\n        }\r\n      }\r\n      if (area > bestArea) { bestArea = area; bestIdxs = idxs }\r\n    }\r\n\r\n    if (!bestIdxs || bestArea < this.minArea || bestArea > this.maxArea) {\r\n      // Slowly update background when no valid detection to adapt lighting\r\n      if (!recent) this.updateBackground(frame, 0.02)\r\n      return null\r\n    }\r\n\r\n    // Compute PCA (covariance) on blob pixels to estimate shaft orientation\r\n    let minX = w, minY = h, maxX = 0, maxY = 0\r\n    let meanX = 0, meanY = 0\r\n    for (const idx of bestIdxs) {\r\n      const y = (idx / w) | 0\r\n      const x = idx - y * w\r\n      meanX += x; meanY += y\r\n      if (x < minX) minX = x\r\n      if (x > maxX) maxX = x\r\n      if (y < minY) minY = y\r\n      if (y > maxY) maxY = y\r\n    }\r\n    meanX /= bestArea; meanY /= bestArea\r\n    let cxx = 0, cyy = 0, cxy = 0\r\n    for (const idx of bestIdxs) {\r\n      const y = (idx / w) | 0\r\n      const x = idx - y * w\r\n      const dx = x - meanX\r\n      const dy = y - meanY\r\n      cxx += dx * dx; cyy += dy * dy; cxy += dx * dy\r\n    }\r\n    cxx /= bestArea; cyy /= bestArea; cxy /= bestArea\r\n    // Principal axis (eigenvector of covariance with largest eigenvalue)\r\n    // For 2x2 symmetric matrix [[cxx,cxy],[cxy,cyy]], eigenvector for largest eigenvalue lambda satisfies (cxx-l)x + cxy y = 0\r\n    const trace = cxx + cyy\r\n    const det = cxx * cyy - cxy * cxy\r\n    const tmp = Math.sqrt(Math.max(0, trace*trace/4 - det))\r\n    const l1 = trace/2 + tmp // largest eigenvalue\r\n    // eigenvector v = (cxy, l1 - cxx) or (l1 - cyy, cxy); choose longer\r\n    let vx = cxy, vy = l1 - cxx\r\n    if (Math.hypot(vx, vy) < 1e-6) { vx = l1 - cyy; vy = cxy }\r\n    const vlen = Math.hypot(vx, vy) || 1\r\n    vx /= vlen; vy /= vlen\r\n\r\n    // Determine which direction along the axis points outward from board center\r\n    const dxc = meanX - this.roiCx\r\n    const dyc = meanY - this.roiCy\r\n    const outward = (dxc * vx + dyc * vy) > 0 ? 1 : -1\r\n    vx *= outward; vy *= outward\r\n\r\n    // Enforce radial alignment: reject if principal axis deviates too much from radial direction\r\n    const rlen = Math.hypot(dxc, dyc) || 1\r\n    const rx = dxc / rlen, ry = dyc / rlen\r\n    const cosAng = Math.max(-1, Math.min(1, vx * rx + vy * ry))\r\n    const angDeg = Math.acos(cosAng) * 180 / Math.PI\r\n    if (angDeg > 55) {\r\n      // likely glare or non-radial artifact\r\n      if (!recent) this.updateBackground(frame, 0.02)\r\n      return null\r\n    }\r\n\r\n    // Project all blob points onto axis and pick extreme (max t) as tip candidate\r\n    let maxT = -Infinity\r\n    let tipX = meanX, tipY = meanY\r\n    for (const idx of bestIdxs) {\r\n      const y = (idx / w) | 0\r\n      const x = idx - y * w\r\n      const t = (x - meanX) * vx + (y - meanY) * vy\r\n      if (t > maxT) { maxT = t; tipX = x; tipY = y }\r\n    }\r\n\r\n    // Distance to center for confidence heuristic\r\n    const dxr = tipX - this.roiCx\r\n    const dyr = tipY - this.roiCy\r\n    const minR2 = dxr*dxr + dyr*dyr\r\n\r\n    // Confidence heuristic based on compactness and radial extent\r\n    const bboxW = Math.max(1, maxX - minX + 1)\r\n    const bboxH = Math.max(1, maxY - minY + 1)\r\n    const bboxArea = bboxW * bboxH\r\n    const fill = bestArea / bboxArea // 0..1 (thin dart should be small fill)\r\n    const radial = Math.sqrt(minR2) / Math.max(1, this.roiRadius)\r\n    let confidence = 0.5\r\n    // Prefer thin elongated shapes with small fill and inside ROI\r\n    if (fill < 0.45) confidence += 0.2\r\n    if (fill < 0.25) confidence += 0.15\r\n    if (radial < 1.1) confidence += 0.1\r\n    // Orientation confidence: larger principal eigenvalue vs minor\r\n    const l2 = trace - l1\r\n    const elong = (l1 > 0) ? (1 - (l2 / l1)) : 0\r\n    if (elong > 0.3) confidence += 0.1\r\n    confidence = Math.max(0, Math.min(1, confidence))\r\n\r\n    // Update background outside the blob to keep stability\r\n    // Optionally, we can inpaint the blob into background upon acceptance by caller\r\n\r\n    // Temporal stabilization: require 2+ consistent frames for the same dart\r\n    const stable = this._isStable({ x: tipX + 0.5, y: tipY + 0.5 }, bestArea)\r\n    if (!stable) return null\r\n    // Debounce\r\n    if (recent) return null\r\n\r\n    return {\r\n      tip: { x: tipX + 0.5, y: tipY + 0.5 },\r\n      axis: { x1: meanX - vx*20, y1: meanY - vy*20, x2: meanX + vx*20, y2: meanY + vy*20 },\r\n      area: bestArea,\r\n      bbox: { x: minX, y: minY, w: bboxW, h: bboxH },\r\n      confidence,\r\n    }\r\n  }\r\n\r\n  // Incorporate the accepted detection into background so it won't trigger again\r\n  accept(frame: ImageData, det: DartDetection) {\r\n    this.lastAcceptTs = Date.now()\r\n    // reset temporal stabilization for next dart\r\n    this.prevTip = null\r\n    this.prevArea = 0\r\n    this.stableCount = 0\r\n    if (!this.bg) return\r\n    const { width: w } = frame\r\n    const bg = this.bg\r\n    const { x, y, w: bw, h: bh } = det.bbox\r\n    const alpha = 0.5\r\n    for (let yy = y; yy < y + bh; yy++) {\r\n      for (let xx = x; xx < x + bw; xx++) {\r\n        const i = yy * w + xx\r\n        const p = i * 4\r\n        const r = frame.data[p], g = frame.data[p+1], b = frame.data[p+2]\r\n        const gray = 0.299*r + 0.587*g + 0.114*b\r\n        bg[i] = (1 - alpha) * bg[i] + alpha * gray\r\n      }\r\n    }\r\n  }\r\n\r\n  // --- helpers ---\r\n  private _isStable(tip: Point, area: number): boolean {\r\n    const close = (a: Point, b: Point) => Math.hypot(a.x - b.x, a.y - b.y) <= 6\r\n    if (!this.prevTip) {\r\n      this.prevTip = { ...tip }\r\n      this.prevArea = area\r\n      this.stableCount = 1\r\n      return false\r\n    }\r\n    if (close(this.prevTip, tip) && Math.abs(area - this.prevArea) / Math.max(1, area) < 0.3) {\r\n      this.prevTip = { ...tip }\r\n      this.prevArea = area\r\n      this.stableCount++\r\n    } else {\r\n      this.prevTip = { ...tip }\r\n      this.prevArea = area\r\n      this.stableCount = 1\r\n      return false\r\n    }\r\n    return this.stableCount >= this.requireStableN\r\n  }\r\n\r\n  private _dilate(mask: Uint8Array, w: number, h: number) {\r\n    const out = new Uint8Array(mask.length)\r\n    for (let y = 0; y < h; y++) {\r\n      for (let x = 0; x < w; x++) {\r\n        let on = 0\r\n        for (let j = -1; j <= 1; j++) {\r\n          for (let i = -1; i <= 1; i++) {\r\n            const yy = y + j, xx = x + i\r\n            if (yy < 0 || yy >= h || xx < 0 || xx >= w) continue\r\n            if (mask[yy*w + xx]) { on = 1; break }\r\n          }\r\n          if (on) break\r\n        }\r\n        out[y*w + x] = on\r\n      }\r\n    }\r\n    mask.set(out)\r\n  }\r\n\r\n  private _erode(mask: Uint8Array, w: number, h: number) {\r\n    const out = new Uint8Array(mask.length)\r\n    for (let y = 0; y < h; y++) {\r\n      for (let x = 0; x < w; x++) {\r\n        let on = 1\r\n        for (let j = -1; j <= 1; j++) {\r\n          for (let i = -1; i <= 1; i++) {\r\n            const yy = y + j, xx = x + i\r\n            if (yy < 0 || yy >= h || xx < 0 || xx >= w) continue\r\n            if (!mask[yy*w + xx]) { on = 0; break }\r\n          }\r\n          if (!on) break\r\n        }\r\n        out[y*w + x] = on\r\n      }\r\n    }\r\n    mask.set(out)\r\n  }\r\n}\r\n","// Generic autoscore provider helpers: parse vendor-agnostic payloads and subscribe via WebSocket\r\n\r\nexport type Ring = 'MISS'|'SINGLE'|'DOUBLE'|'TRIPLE'|'BULL'|'INNER_BULL'\r\nexport type ParsedDart = { value: number; ring: Ring; sector?: number|null; mult?: 0|1|2|3 }\r\n\r\n// Try to parse a variety of vendor payload shapes\r\nexport function parseExternalDart(data: any): ParsedDart | null {\r\n  try {\r\n    if (!data || typeof data !== 'object') return null\r\n    // 1) { type:'dart', value: <0-60>, ring: 'SINGLE'|'DOUBLE'|... }\r\n    if ((data.type === 'dart' || data.kind === 'dart' || data.event === 'dart') && typeof data.value === 'number') {\r\n      const ring = normalizeRing(data.ring)\r\n      return finalizeFromValue(data.value, ring)\r\n    }\r\n    // 2) { value, ring }\r\n    if (typeof data.value === 'number' && data.ring) {\r\n      const ring = normalizeRing(data.ring)\r\n      return finalizeFromValue(data.value, ring)\r\n    }\r\n    // 3) { score: 'T20'|'D16'|'S5'|'25'|'50' }\r\n    if (typeof data.score === 'string') {\r\n      const s = data.score.trim().toUpperCase()\r\n      if (s === '50' || s === 'DBULL' || s === 'INNER_BULL') return { value: 50, ring: 'INNER_BULL', sector: null, mult: 0 }\r\n      if (s === '25' || s === 'BULL' || s === 'OBULL') return { value: 25, ring: 'BULL', sector: null, mult: 0 }\r\n      const m = s.match(/^(S|D|T)(\\d{1,2})$/)\r\n      if (m) {\r\n        const mult = m[1] === 'S' ? 1 : m[1] === 'D' ? 2 : 3\r\n        const sec = parseInt(m[2],10)\r\n        if (sec >=1 && sec <= 20) return { value: sec*mult, ring: mult===1?'SINGLE':mult===2?'DOUBLE':'TRIPLE', sector: sec, mult: mult as 1|2|3 }\r\n      }\r\n    }\r\n    // 4) { sector: 1..20, mult: 1|2|3 }\r\n    if (typeof data.sector === 'number' && typeof data.mult === 'number') {\r\n      const sec = Math.max(1, Math.min(20, Math.floor(data.sector)))\r\n      const mul = data.mult===1?1:data.mult===2?2:3\r\n      return { value: sec*mul, ring: mul===1?'SINGLE':mul===2?'DOUBLE':'TRIPLE', sector: sec, mult: mul as 1|2|3 }\r\n    }\r\n    // 5) { bull: 'outer'|'inner'|true }\r\n    if (data.bull) {\r\n      const inner = String(data.bull).toLowerCase() === 'inner' || data.bull === true\r\n      return { value: inner?50:25, ring: inner?'INNER_BULL':'BULL', sector: null, mult: 0 }\r\n    }\r\n  } catch {}\r\n  return null\r\n}\r\n\r\nfunction normalizeRing(r: any): Ring {\r\n  const s = String(r||'').toUpperCase()\r\n  if (s.startsWith('TR')) return 'TRIPLE'\r\n  if (s.startsWith('DO')) return 'DOUBLE'\r\n  if (s.startsWith('SI')) return 'SINGLE'\r\n  if (s === 'INNER_BULL' || s === 'DBULL' || s === '50' || s === 'IBULL') return 'INNER_BULL'\r\n  if (s === 'BULL' || s === '25' || s === 'OBULL' || s === 'OUTER_BULL') return 'BULL'\r\n  if (s === 'MISS' || s === '0') return 'MISS'\r\n  return 'SINGLE'\r\n}\r\n\r\nfunction finalizeFromValue(value: number, ring: Ring): ParsedDart | null {\r\n  const v = Math.max(0, Math.min(60, Math.round(Number(value)||0)))\r\n  if (ring === 'INNER_BULL') return { value: 50, ring }\r\n  if (ring === 'BULL') return { value: 25, ring }\r\n  // Best-effort: preserve base if consistent with ring\r\n  return { value: v, ring }\r\n}\r\n\r\nexport type ExternalSub = { close: () => void }\r\n\r\nexport function subscribeExternalWS(url: string, onDart: (d: ParsedDart) => void): ExternalSub {\r\n  let socket: WebSocket | null = null\r\n  let alive = true\r\n  // Lightweight duplicate suppression: ignore exact repeat within a short window\r\n  let lastSig: string | null = null\r\n  let lastSigAt = 0\r\n  const DEDUP_WINDOW_MS = 400\r\n  // Optional ID-based dedup if provider sends unique ids\r\n  const seenIds: string[] = []\r\n  const seenSet = new Set<string>()\r\n\r\n  function considerForward(payload: any, parsed: ParsedDart) {\r\n    // If payload has a stable id, drop if seen\r\n    const pid = typeof payload?.id === 'string' || typeof payload?.id === 'number' ? String(payload.id) : null\r\n    if (pid) {\r\n      if (seenSet.has(pid)) return\r\n      seenSet.add(pid)\r\n      seenIds.push(pid)\r\n      if (seenIds.length > 200) {\r\n        const old = seenIds.shift()\r\n        if (old) seenSet.delete(old)\r\n      }\r\n    }\r\n    // Time-based dedup by signature (safe; darts cannot occur within <400ms)\r\n    const sig = `${parsed.value}|${parsed.ring}|${parsed.sector ?? ''}|${parsed.mult ?? ''}`\r\n    const now = Date.now()\r\n    if (sig === lastSig && now - lastSigAt < DEDUP_WINDOW_MS) return\r\n    lastSig = sig\r\n    lastSigAt = now\r\n    onDart(parsed)\r\n  }\r\n\r\n  function connect() {\r\n    if (!alive) return\r\n    try {\r\n      socket = new WebSocket(url)\r\n      socket.onmessage = (ev) => {\r\n        try {\r\n          const payload = JSON.parse(ev.data)\r\n          const parsed = parseExternalDart(payload)\r\n          if (parsed) considerForward(payload, parsed)\r\n        } catch {}\r\n      }\r\n      socket.onclose = () => { socket = null; setTimeout(connect, 1500) }\r\n      socket.onerror = () => { /* ignore; will reconnect on close */ }\r\n    } catch {\r\n      setTimeout(connect, 2000)\r\n    }\r\n  }\r\n  connect()\r\n  return { close: () => { alive = false; try { socket?.close() } catch {} } }\r\n}\r\n","import React, { useEffect, useRef, useState, type ReactNode, type CSSProperties } from 'react'\r\n\r\ntype Props = {\r\n  storageKey: string\r\n  children: ReactNode\r\n  className?: string\r\n  defaultWidth?: number\r\n  defaultHeight?: number\r\n  minWidth?: number\r\n  minHeight?: number\r\n  maxWidth?: number\r\n  maxHeight?: number\r\n  autoFill?: boolean\r\n}\r\n\r\ntype Size = { width?: number; height?: number }\r\n\r\nexport default function ResizablePanel({\r\n  storageKey,\r\n  children,\r\n  className,\r\n  defaultWidth = 640,\r\n  defaultHeight = 360,\r\n  minWidth = 320,\r\n  minHeight = 200,\r\n  maxWidth = 1600,\r\n  maxHeight = 1200,\r\n  autoFill = false,\r\n}: Props) {\r\n  const [size, setSize] = useState<Size>(() => {\r\n    try { const raw = localStorage.getItem(storageKey); if (raw) return JSON.parse(raw) } catch {}\r\n    // If autoFill is requested, don't persist a fixed height â€” let CSS stretch the panel\r\n    return autoFill ? { width: defaultWidth } : { width: defaultWidth, height: defaultHeight }\r\n  })\r\n  const startRef = useRef<{ x: number; y: number; w: number; h: number; dir: string } | null>(null)\r\n  const containerRef = useRef<HTMLDivElement | null>(null)\r\n\r\n  useEffect(() => {\r\n    function onReset() {\r\n      try { localStorage.removeItem(storageKey) } catch {}\r\n      setSize({ width: defaultWidth, height: defaultHeight })\r\n    }\r\n    window.addEventListener('ndn:layout-reset' as any, onReset)\r\n    window.addEventListener('ndn:camera-reset' as any, onReset)\r\n    return () => {\r\n      window.removeEventListener('ndn:layout-reset' as any, onReset)\r\n      window.removeEventListener('ndn:camera-reset' as any, onReset)\r\n    }\r\n  }, [storageKey, defaultWidth, defaultHeight])\r\n\r\n  useEffect(() => { try { localStorage.setItem(storageKey, JSON.stringify(size)) } catch {} }, [size, storageKey])\r\n\r\n  function clamp(n: number, min: number, max: number) { return Math.max(min, Math.min(max, n)) }\r\n  function beginResize(e: React.MouseEvent, dir: string) {\r\n    e.preventDefault(); const el = containerRef.current; if (!el) return\r\n    const rect = el.getBoundingClientRect()\r\n    startRef.current = { x: e.clientX, y: e.clientY, w: rect.width, h: rect.height, dir }\r\n    window.addEventListener('mousemove', onMove)\r\n    window.addEventListener('mouseup', endResize)\r\n  }\r\n  function onMove(e: globalThis.MouseEvent) {\r\n    const s = startRef.current; if (!s) return\r\n    const dx = e.clientX - s.x; const dy = e.clientY - s.y\r\n    let w = s.w; let h = s.h\r\n    if (s.dir.includes('e')) w = clamp(s.w + dx, minWidth, maxWidth)\r\n    // If autoFill is enabled, ignore vertical resizing (panel should fill parent)\r\n    if (!autoFill && s.dir.includes('s')) h = clamp(s.h + dy, minHeight, maxHeight)\r\n    if (s.dir.includes('w')) w = clamp(s.w - dx, minWidth, maxWidth)\r\n    if (!autoFill && s.dir.includes('n')) h = clamp(s.h - dy, minHeight, maxHeight)\r\n    setSize({ width: Math.round(w), height: Math.round(h) })\r\n  }\r\n  function endResize() { window.removeEventListener('mousemove', onMove); window.removeEventListener('mouseup', endResize); startRef.current = null }\r\n\r\n  const style: CSSProperties = {\r\n    width: autoFill ? '100%' : (size.width ? `${size.width}px` : undefined),\r\n    height: autoFill ? '100%' : (size.height ? `${size.height}px` : undefined),\r\n    maxWidth: '100%',\r\n    // Allow the panel to fill the parent when autoFill is enabled. Otherwise keep a sensible cap.\r\n    maxHeight: autoFill ? '100%' : '80vh',\r\n    position: 'relative',\r\n    // Make it participate in flex layouts when filling\r\n    ...(autoFill ? { display: 'flex', flexDirection: 'column', flex: '1 1 auto' } : {}),\r\n  }\r\n\r\n  return (\r\n    <div ref={containerRef} className={`${className || ''}`} style={style}>\r\n      {children}\r\n      <div className=\"resizer resizer-nw\" onMouseDown={(e)=>beginResize(e,'nw')} />\r\n      <div className=\"resizer resizer-ne\" onMouseDown={(e)=>beginResize(e,'ne')} />\r\n      <div className=\"resizer resizer-sw\" onMouseDown={(e)=>beginResize(e,'sw')} />\r\n      <div className=\"resizer resizer-se\" onMouseDown={(e)=>beginResize(e,'se')} />\r\n    </div>\r\n  )\r\n}\r\n","import { create } from 'zustand'\r\n\r\nexport type HeatSample = {\r\n  playerId: string | null\r\n  sector: number | null\r\n  mult: 0 | 1 | 2 | 3\r\n  ring: 'MISS'|'SINGLE'|'DOUBLE'|'TRIPLE'|'BULL'|'INNER_BULL'\r\n  ts: number\r\n}\r\n\r\ntype HeatState = {\r\n  samples: HeatSample[]\r\n  addSample: (s: HeatSample) => void\r\n  clear: () => void\r\n  export: () => HeatSample[]\r\n}\r\n\r\nexport const useHeatmapStore = create<HeatState>((set, get) => ({\r\n  samples: [],\r\n  addSample: (s) => set(state => ({ samples: [...state.samples, s] })),\r\n  clear: () => set({ samples: [] }),\r\n  export: () => get().samples.slice(),\r\n}))\r\n\r\nexport default useHeatmapStore\r\n","import { create } from 'zustand'\r\n\r\ntype MatchControlState = {\r\n  paused: boolean\r\n  pauseEndsAt: number | null\r\n  setPaused: (v: boolean, endsAt?: number | null) => void\r\n}\r\n\r\nexport const useMatchControl = create<MatchControlState>((set) => ({\r\n  paused: false,\r\n  pauseEndsAt: null,\r\n  setPaused: (v, endsAt = null) => set({ paused: v, pauseEndsAt: endsAt ?? null }),\r\n}))\r\n","import { useCallback, useEffect, useRef, useState } from 'react'\r\nimport { useUserSettings } from '../store/userSettings'\r\nimport { useCalibration } from '../store/calibration'\r\nimport { useMatch } from '../store/match'\r\nimport { BoardRadii, drawPolyline, sampleRing, scaleHomography, type Point, applyHomography, drawCross, refinePointSobel } from '../utils/vision'\r\nimport { scoreFromImagePoint } from '../utils/autoscore'\r\nimport { DartDetector } from '../utils/dartDetector'\r\nimport { addSample } from '../store/profileStats'\r\nimport { subscribeExternalWS } from '../utils/scoring'\r\nimport ResizablePanel from './ui/ResizablePanel'\r\nimport ResizableModal from './ui/ResizableModal'\r\nimport FocusLock from 'react-focus-lock'\r\nimport useHeatmapStore from '../store/heatmap'\r\nimport { usePendingVisit } from '../store/pendingVisit'\r\nimport { useCameraSession } from '../store/cameraSession'\r\nimport { useMatchControl } from '../store/matchControl'\r\nimport { useAudit } from '../store/audit'\r\n\r\n// Shared ring type across autoscore/manual flows\r\ntype Ring = 'MISS'|'SINGLE'|'DOUBLE'|'TRIPLE'|'BULL'|'INNER_BULL'\r\n\r\nconst AUTO_COMMIT_MIN_FRAMES = 1\r\nconst AUTO_COMMIT_HOLD_MS = 120\r\nconst AUTO_COMMIT_COOLDOWN_MS = 400\r\nconst AUTO_STREAM_IGNORE_MS = 450\r\nconst DETECTION_ARM_DELAY_MS = 5000\r\nconst AUTO_COMMIT_CONFIDENCE = 0.85\r\nconst BOARD_CLEAR_GRACE_MS = 6500\r\nconst DISABLE_CAMERA_OVERLAY = true\r\n\r\ntype AutoCandidate = {\r\n  value: number\r\n  ring: Ring\r\n  label: string\r\n  sector: number | null\r\n  mult: 0|1|2|3\r\n  firstTs: number\r\n  frames: number\r\n}\r\n\r\ntype DetectionLogEntry = {\r\n  ts: number\r\n  label: string\r\n  value: number\r\n  ring: Ring\r\n  confidence: number\r\n  ready: boolean\r\n  accepted: boolean\r\n  warmup: boolean\r\n}\r\n\r\nexport default function CameraView({\r\n  onVisitCommitted,\r\n  showToolbar = true,\r\n  onAutoDart,\r\n  immediateAutoCommit = false,\r\n  hideInlinePanels = false,\r\n  scoringMode = 'x01',\r\n  onGenericDart,\r\n  onGenericReplace,\r\n  x01DoubleInOverride,\r\n  onAddVisit,\r\n  onEndLeg,\r\n}: {\r\n  onVisitCommitted?: (score: number, darts: number, finished: boolean) => void\r\n  showToolbar?: boolean\r\n  onAutoDart?: (value: number, ring: 'MISS'|'SINGLE'|'DOUBLE'|'TRIPLE'|'BULL'|'INNER_BULL', info?: { sector: number | null; mult: 0|1|2|3 }) => void\r\n  immediateAutoCommit?: boolean\r\n  hideInlinePanels?: boolean\r\n  scoringMode?: 'x01' | 'custom'\r\n  onGenericDart?: (value: number, ring: Ring, meta: { label: string }) => void\r\n  onGenericReplace?: (value: number, ring: Ring, meta: { label: string }) => void\r\n  x01DoubleInOverride?: boolean\r\n  onAddVisit?: (score: number, darts: number, meta?: any) => void\r\n  onEndLeg?: (score?: number) => void\r\n}) {\r\n  const videoRef = useRef<HTMLVideoElement>(null)\r\n  const { preferredCameraId, preferredCameraLabel, setPreferredCamera, autoscoreProvider, autoscoreWsUrl, cameraAspect, cameraFitMode, autoCommitMode = 'wait-for-clear', cameraEnabled, setCameraEnabled, preferredCameraLocked, hideCameraOverlay, setHideCameraOverlay } = useUserSettings()\r\n  const manualOnly = autoscoreProvider === 'manual'\r\n  const [availableCameras, setAvailableCameras] = useState<MediaDeviceInfo[]>([])\r\n  const canvasRef = useRef<HTMLCanvasElement>(null)\r\n  const overlayRef = useRef<HTMLCanvasElement>(null)\r\n  const [streaming, setStreaming] = useState(false)\r\n  const cameraSession = useCameraSession()\r\n  const isPhoneCamera = preferredCameraLabel === 'Phone Camera'\r\n  const sessionStream = cameraSession.getMediaStream?.() || null\r\n  const sessionStreaming = cameraSession.isStreaming\r\n  const phoneFeedActive = isPhoneCamera && cameraSession.mode === 'phone' && sessionStreaming && !!sessionStream\r\n  const effectiveStreaming = streaming || sessionStreaming\r\n  const [cameraStarting, setCameraStarting] = useState(false)\r\n  const [snapshotUrl, setSnapshotUrl] = useState<string | null>(null)\r\n  const { H, imageSize, reset: resetCalibration, _hydrated } = useCalibration()\r\n  useEffect(() => {\r\n    if (preferredCameraLocked && !hideCameraOverlay) {\r\n      setHideCameraOverlay(true)\r\n    }\r\n  }, [preferredCameraLocked, hideCameraOverlay, setHideCameraOverlay])\r\n  const [lastAutoScore, setLastAutoScore] = useState<string>('')\r\n  const [manualScore, setManualScore] = useState<string>('')\r\n  const [lastAutoValue, setLastAutoValue] = useState<number>(0)\r\n  const [lastAutoRing, setLastAutoRing] = useState<Ring>('MISS')\r\n  const [pendingDarts, setPendingDarts] = useState<number>(0)\r\n  const [pendingScore, setPendingScore] = useState<number>(0)\r\n  const [pendingEntries, setPendingEntries] = useState<{ label: string; value: number; ring: Ring }[]>([])\r\n  const [pendingPreOpenDarts, setPendingPreOpenDarts] = useState<number>(0)\r\n  const [pendingDartsAtDouble, setPendingDartsAtDouble] = useState<number>(0)\r\n  const [awaitingClear, setAwaitingClear] = useState(false)\r\n  const pendingCommitRef = useRef<{ score: number; darts: number; finished: boolean } | null>(null)\r\n  const pendingCommitTimerRef = useRef<number | null>(null)\r\n  const shouldDeferCommit = !immediateAutoCommit && autoCommitMode !== 'immediate'\r\n  const [indicatorVersion, setIndicatorVersion] = useState(0)\r\n  const [indicatorEntryVersions, setIndicatorEntryVersions] = useState<number[]>([])\r\n  const autoCandidateRef = useRef<AutoCandidate | null>(null)\r\n  const detectionLogRef = useRef<DetectionLogEntry[]>([])\r\n  const lastAutoCommitRef = useRef<number>(0)\r\n  const streamingStartMsRef = useRef<number>(0)\r\n  const detectionArmedRef = useRef<boolean>(false)\r\n  const detectionArmTimerRef = useRef<number | null>(null)\r\n  const frameCountRef = useRef<number>(0)\r\n  const [detectionLog, setDetectionLog] = useState<DetectionLogEntry[]>([])\r\n  const [showDetectionLog, setShowDetectionLog] = useState(false)\r\n  const clearPendingCommitTimer = useCallback(() => {\r\n    if (pendingCommitTimerRef.current) {\r\n      clearTimeout(pendingCommitTimerRef.current)\r\n      pendingCommitTimerRef.current = null\r\n    }\r\n  }, [])\r\n\r\n  const captureDetectionLog = useCallback((entry: DetectionLogEntry) => {\r\n    const next = [...detectionLogRef.current.slice(-8), entry]\r\n    detectionLogRef.current = next\r\n    setDetectionLog(next)\r\n    try {\r\n      (window as any).ndnCameraDiagnostics = next\r\n    } catch {}\r\n  }, [])\r\n  const finalizePendingCommit = useCallback((_trigger: 'event' | 'timeout' | 'teardown') => {\r\n    const pending = pendingCommitRef.current\r\n    if (!pending) return\r\n    pendingCommitRef.current = null\r\n    clearPendingCommitTimer()\r\n    setAwaitingClear(false)\r\n    if (onVisitCommitted) {\r\n      try { onVisitCommitted(pending.score, pending.darts, pending.finished) } catch {}\r\n    }\r\n  }, [onVisitCommitted, clearPendingCommitTimer])\r\n  const enqueueVisitCommit = useCallback((payload: { score: number; darts: number; finished: boolean }) => {\r\n    if (!onVisitCommitted) return\r\n    if (!shouldDeferCommit) {\r\n      try { onVisitCommitted(payload.score, payload.darts, payload.finished) } catch {}\r\n      return\r\n    }\r\n    pendingCommitRef.current = payload\r\n    setAwaitingClear(true)\r\n    clearPendingCommitTimer()\r\n    pendingCommitTimerRef.current = window.setTimeout(() => finalizePendingCommit('timeout'), BOARD_CLEAR_GRACE_MS)\r\n  }, [onVisitCommitted, shouldDeferCommit, clearPendingCommitTimer, finalizePendingCommit])\r\n  const clearPendingManual = useCallback((reason: 'indicator' | 'toolbar') => {\r\n    setPendingDarts(0)\r\n    setPendingScore(0)\r\n    setPendingEntries([])\r\n    setPendingPreOpenDarts(0)\r\n    setPendingDartsAtDouble(0)\r\n    setHadRecentAuto(false)\r\n    try {\r\n      window.dispatchEvent(new CustomEvent('ndn:clear-visit-request', { detail: { source: 'camera-view', reason, ts: Date.now() } }))\r\n    } catch {}\r\n  }, [])\r\n  useEffect(() => {\r\n    if (!shouldDeferCommit) return\r\n    const handler = () => finalizePendingCommit('event')\r\n    window.addEventListener('ndn:darts-cleared', handler as EventListener)\r\n    return () => window.removeEventListener('ndn:darts-cleared', handler as EventListener)\r\n  }, [shouldDeferCommit, finalizePendingCommit])\r\n  useEffect(() => {\r\n    if (!shouldDeferCommit) finalizePendingCommit('timeout')\r\n  }, [shouldDeferCommit, finalizePendingCommit])\r\n  useEffect(() => () => finalizePendingCommit('teardown'), [finalizePendingCommit])\r\n  const handleIndicatorReset = useCallback(() => {\r\n    clearPendingManual('indicator')\r\n    setIndicatorVersion(v => v + 1)\r\n  }, [clearPendingManual])\r\n  const handleToolbarClear = useCallback(() => {\r\n    if (pendingDarts === 0 && pendingScore === 0) return\r\n    clearPendingManual('toolbar')\r\n    setIndicatorVersion(v => v + 1)\r\n  }, [clearPendingManual, pendingDarts, pendingScore])\r\n  const requestDeviceManager = useCallback(() => {\r\n    if (manualOnly) return\r\n    try {\r\n      window.dispatchEvent(new CustomEvent('ndn:open-camera-manager', { detail: { source: 'camera-view', ts: Date.now() } }))\r\n    } catch (err) {\r\n      console.warn('[CameraView] Failed to request camera manager:', err)\r\n    }\r\n  }, [manualOnly])\r\n  // X01 Double-In handling: per-player opened state in this session\r\n  const x01DoubleInSetting = useUserSettings(s => s.x01DoubleIn)\r\n  const x01DoubleIn = (typeof x01DoubleInOverride === 'boolean') ? !!x01DoubleInOverride : !!x01DoubleInSetting\r\n  const [openedById, setOpenedById] = useState<Record<string, boolean>>({})\r\n  const matchState = useMatch(s => s)\r\n  const currentPlayerId = matchState.players[matchState.currentPlayerIdx]?.id\r\n  const isOpened = !!(currentPlayerId && openedById[currentPlayerId])\r\n  const setOpened = (v: boolean) => { if (!currentPlayerId) return; setOpenedById(m => ({ ...m, [currentPlayerId]: v })) }\r\n  const inProgress = (matchState as any)?.inProgress\r\n  // Broadcast pending visit to global store so Scoreboard can visualize dots\r\n  const setVisit = usePendingVisit(s => s.setVisit)\r\n  const resetPendingVisit = usePendingVisit(s => s.reset)\r\n  useEffect(() => {\r\n    try { setVisit(pendingEntries as any, pendingDarts, pendingScore) } catch {}\r\n  }, [pendingEntries, pendingDarts, pendingScore, setVisit])\r\n  useEffect(() => () => { try { resetPendingVisit() } catch {} }, [resetPendingVisit])\r\n  const addVisit = useMatch(s => s.addVisit)\r\n  const endLeg = useMatch(s => s.endLeg)\r\n  // Prefer provided adapters (matchActions wrappers) when available\r\n  const callAddVisit = (score: number, darts: number, meta?: any) => { try { if (onAddVisit) onAddVisit(score, darts, meta); else addVisit(score, darts, meta) } catch { /* noop */ } }\r\n  const callEndLeg = (score?: number) => { try { if (onEndLeg) onEndLeg(score); else endLeg(score) } catch { /* noop */ } }\r\n  const addHeatSample = useHeatmapStore(s => s.addSample)\r\n  // Quick entry dropdown selections\r\n  const [quickSelAuto, setQuickSelAuto] = useState('')\r\n  const [quickSelManual, setQuickSelManual] = useState('')\r\n  const [nonRegCount, setNonRegCount] = useState(0)\r\n  const [showRecalModal, setShowRecalModal] = useState(false)\r\n  const [hadRecentAuto, setHadRecentAuto] = useState(false)\r\n  const [pulseManualPill, setPulseManualPill] = useState(false)\r\n  const pulseTimeoutRef = useRef<number | null>(null)\r\n  const [activeTab, setActiveTab] = useState<'auto'|'manual'>('auto')\r\n  const [showManualModal, setShowManualModal] = useState(false)\r\n  const [showAutoModal, setShowAutoModal] = useState(false)\r\n  const [showScoringModal, setShowScoringModal] = useState(false)\r\n  const manualPreviewRef = useRef<HTMLCanvasElement | null>(null)\r\n  // Dart timer\r\n  const dartTimerEnabled = useUserSettings(s => s.dartTimerEnabled)\r\n  const dartTimerSeconds = useUserSettings(s => s.dartTimerSeconds) || 10\r\n  const [dartTimeLeft, setDartTimeLeft] = useState<number | null>(null)\r\n  const timerRef = useRef<number | null>(null)\r\n  const paused = useMatchControl(s => s.paused)\r\n  // Built-in CV detector\r\n  const detectorRef = useRef<DartDetector | null>(null)\r\n  const rafRef = useRef<number | null>(null)\r\n  const [detectorSeedVersion, setDetectorSeedVersion] = useState(0)\r\n  const handlePhoneReconnect = useCallback(() => {\r\n    try {\r\n      window.dispatchEvent(new CustomEvent('ndn:phone-camera-reconnect', { detail: { source: 'camera-view', ts: Date.now() } }))\r\n    } catch (err) {\r\n      console.warn('[CameraView] Phone camera reconnect dispatch failed:', err)\r\n    }\r\n  }, [])\r\n  // Open Autoscore modal from parent via global event\r\n  useEffect(() => {\r\n    const onOpen = () => { if (!manualOnly) setShowAutoModal(true) }\r\n    window.addEventListener('ndn:open-autoscore' as any, onOpen)\r\n    return () => window.removeEventListener('ndn:open-autoscore' as any, onOpen)\r\n  }, [manualOnly])\r\n\r\n  // cleanup pulse timer on unmount\r\n  useEffect(() => {\r\n    return () => {\r\n      try { if (pulseTimeoutRef.current) clearTimeout(pulseTimeoutRef.current) } catch {}\r\n    }\r\n  }, [])\r\n\r\n  // Open Scoring (Camera + Pending Visit) modal from parent via global event\r\n  useEffect(() => {\r\n    const onOpen = () => setShowScoringModal(true)\r\n    window.addEventListener('ndn:open-scoring' as any, onOpen)\r\n    return () => window.removeEventListener('ndn:open-scoring' as any, onOpen)\r\n  }, [])\r\n\r\n  useEffect(() => {\r\n    const onDartsCleared = () => {\r\n      setIndicatorVersion(v => v + 1)\r\n      setPendingDarts(0)\r\n      setPendingScore(0)\r\n      setPendingEntries([])\r\n      setPendingPreOpenDarts(0)\r\n      setPendingDartsAtDouble(0)\r\n      setHadRecentAuto(false)\r\n    }\r\n    window.addEventListener('ndn:darts-cleared', onDartsCleared as EventListener)\r\n    return () => window.removeEventListener('ndn:darts-cleared', onDartsCleared as EventListener)\r\n  }, [])\r\n\r\n  useEffect(() => {\r\n    setIndicatorEntryVersions(prev => {\r\n      if (pendingEntries.length > prev.length) {\r\n        const diff = pendingEntries.length - prev.length\r\n        return [...prev, ...Array(diff).fill(indicatorVersion)]\r\n      }\r\n      if (pendingEntries.length < prev.length) {\r\n        return prev.slice(0, pendingEntries.length)\r\n      }\r\n      return prev\r\n    })\r\n  }, [pendingEntries, indicatorVersion])\r\n\r\n  useEffect(() => {\r\n    if (detectionArmTimerRef.current) {\r\n      clearTimeout(detectionArmTimerRef.current)\r\n      detectionArmTimerRef.current = null\r\n    }\r\n    if (manualOnly) {\r\n      detectionArmedRef.current = false\r\n      streamingStartMsRef.current = 0\r\n      autoCandidateRef.current = null\r\n      return\r\n    }\r\n    if (effectiveStreaming) {\r\n      streamingStartMsRef.current = performance.now()\r\n      autoCandidateRef.current = null\r\n      detectionArmedRef.current = false\r\n      frameCountRef.current = 0\r\n      detectionArmTimerRef.current = window.setTimeout(() => {\r\n        detectionArmedRef.current = true\r\n        detectionArmTimerRef.current = null\r\n      }, DETECTION_ARM_DELAY_MS)\r\n    } else {\r\n      streamingStartMsRef.current = 0\r\n      autoCandidateRef.current = null\r\n      detectionArmedRef.current = false\r\n      frameCountRef.current = 0\r\n    }\r\n    return () => {\r\n      if (detectionArmTimerRef.current) {\r\n        clearTimeout(detectionArmTimerRef.current)\r\n        detectionArmTimerRef.current = null\r\n      }\r\n      detectionArmedRef.current = false\r\n      frameCountRef.current = 0\r\n    }\r\n  }, [effectiveStreaming, manualOnly])\r\n\r\n  // Enumerate devices on mount and when devices change so USB webcams appear quickly\r\n  useEffect(() => {\r\n    let mounted = true\r\n    async function refresh() {\r\n      try {\r\n        if (!navigator?.mediaDevices?.enumerateDevices) return\r\n        const list = await navigator.mediaDevices.enumerateDevices()\r\n        if (!mounted) return\r\n        setAvailableCameras(list.filter(d => d.kind === 'videoinput'))\r\n      } catch (err) {\r\n        console.warn('[CAMERA] enumerateDevices failed:', err)\r\n      }\r\n    }\r\n    refresh()\r\n    try {\r\n      navigator.mediaDevices.addEventListener('devicechange', refresh)\r\n    } catch {\r\n      try { (navigator.mediaDevices as any).ondevicechange = refresh } catch {}\r\n    }\r\n    return () => {\r\n      mounted = false\r\n      try { navigator.mediaDevices.removeEventListener('devicechange', refresh) } catch {}\r\n    }\r\n  }, [])\r\n\r\n  // Allow parent to open/close the manual modal via global events\r\n  useEffect(() => {\r\n    const onOpen = () => { setActiveTab('manual'); setShowManualModal(true) }\r\n    const onClose = () => { setActiveTab('auto'); setShowManualModal(false) }\r\n    window.addEventListener('ndn:open-manual' as any, onOpen)\r\n    window.addEventListener('ndn:close-manual' as any, onClose)\r\n    return () => {\r\n      window.removeEventListener('ndn:open-manual' as any, onOpen)\r\n      window.removeEventListener('ndn:close-manual' as any, onClose)\r\n    }\r\n  }, [])\r\n\r\n  useEffect(() => {\r\n    if (manualOnly) {\r\n      setActiveTab('manual')\r\n      setShowAutoModal(false)\r\n    }\r\n  }, [manualOnly])\r\n\r\n  // Reset open state at the start of a leg (no darts thrown yet), keep across visits within leg\r\n  useEffect(() => {\r\n    try {\r\n      const p = matchState.players[matchState.currentPlayerIdx]\r\n      const leg = p?.legs?.[p.legs.length - 1]\r\n      if (!p) return\r\n      if (!leg || leg.dartsThrown === 0) {\r\n        setOpenedById(m => ({ ...m, [p.id]: false }))\r\n      }\r\n    } catch {}\r\n  }, [matchState.currentPlayerIdx, matchState.players?.[matchState.currentPlayerIdx]?.legs?.length])\r\n\r\n  // Manage per-dart timer lifecycle\r\n  useEffect(() => {\r\n    const shouldRun = !!dartTimerEnabled && inProgress && !paused && pendingDarts < 3\r\n    // Clear any existing interval\r\n    if (timerRef.current) {\r\n      clearInterval(timerRef.current as any)\r\n      timerRef.current = null\r\n    }\r\n    if (!shouldRun) { setDartTimeLeft(null); return }\r\n    // Reset timer each time dependencies change (new dart, player change, setting change)\r\n    setDartTimeLeft(dartTimerSeconds)\r\n    timerRef.current = window.setInterval(() => {\r\n      setDartTimeLeft(prev => {\r\n        const next = (prev ?? dartTimerSeconds) - 1\r\n        if (next <= 0) {\r\n          // Time expired: record a MISS and reset will occur via pendingEntries change\r\n          try { addDart(0, 'MISS 0', 'MISS') } catch {}\r\n          // Stop interval until effect re-initializes on state change\r\n          if (timerRef.current) { clearInterval(timerRef.current as any); timerRef.current = null }\r\n          return 0\r\n        }\r\n        return next\r\n      })\r\n    }, 1000) as any\r\n    return () => { if (timerRef.current) { clearInterval(timerRef.current as any); timerRef.current = null } }\r\n  // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  }, [dartTimerEnabled, dartTimerSeconds, pendingDarts, matchState.currentPlayerIdx, (matchState as any)?.inProgress, paused])\r\n\r\n  // Drive a lightweight live preview inside the manual modal from the main video element\r\n  useEffect(() => {\r\n    if (!showManualModal) return\r\n    const id = setInterval(() => {\r\n      try {\r\n        const v = videoRef.current\r\n        const c = manualPreviewRef.current\r\n        if (!v || !c) return\r\n        const vw = v.videoWidth || 0\r\n        const vh = v.videoHeight || 0\r\n        if (!vw || !vh) return\r\n        const cw = c.clientWidth || 640\r\n        const ch = c.clientHeight || 360\r\n        // Set backing size to match display for crisp rendering\r\n        if (c.width !== cw) c.width = cw\r\n        if (c.height !== ch) c.height = ch\r\n        const ctx = c.getContext('2d')\r\n        if (!ctx) return\r\n        ctx.imageSmoothingEnabled = true\r\n        // Letterbox fit\r\n        const scale = Math.min(cw / vw, ch / vh)\r\n        const dw = Math.round(vw * scale)\r\n        const dh = Math.round(vh * scale)\r\n        const dx = Math.floor((cw - dw) / 2)\r\n        const dy = Math.floor((ch - dh) / 2)\r\n        ctx.fillStyle = '#000'\r\n        ctx.fillRect(0, 0, cw, ch)\r\n        ctx.drawImage(v, dx, dy, dw, dh)\r\n      } catch (e) {\r\n        // Silently ignore preview update errors\r\n        console.warn('Manual preview update error:', e)\r\n      }\r\n    }, 120)\r\n    return () => clearInterval(id)\r\n  }, [showManualModal])\r\n\r\n  useEffect(() => {\r\n    return () => stopCamera()\r\n  }, [])\r\n\r\n  const canFallbackToLocal = isPhoneCamera && !phoneFeedActive\r\n\r\n  async function startCamera() {\r\n    if (cameraStarting || streaming) return\r\n    \r\n    // Only skip local startup when the phone feed is actively streaming\r\n    if (isPhoneCamera && phoneFeedActive) {\r\n      console.log('[CAMERA] Phone camera stream active - leaving local camera idle')\r\n      setCameraStarting(false)\r\n      return\r\n    }\r\n    \r\n    setCameraStarting(true)\r\n    console.log('[CAMERA] Starting camera...')\r\n    try {\r\n      // If a preferred camera is set, request it; otherwise default to back camera on mobile\r\n      const constraints: MediaStreamConstraints = preferredCameraId \r\n        ? { video: { deviceId: { exact: preferredCameraId } }, audio: false } \r\n        : { video: { facingMode: 'environment' }, audio: false } // Prefer back camera on mobile\r\n      console.log('[CAMERA] Using constraints:', constraints)\r\n      let stream: MediaStream\r\n      try {\r\n        stream = await navigator.mediaDevices.getUserMedia(constraints)\r\n        console.log('[CAMERA] Got stream:', !!stream)\r\n      } catch (err: any) {\r\n        console.warn('[CAMERA] First attempt failed:', err)\r\n        // Fallback if specific device isn't available or facingMode not supported\r\n        const name = (err && (err.name || err.code)) || ''\r\n        if (preferredCameraId && (name === 'OverconstrainedError' || name === 'NotFoundError')) {\r\n          console.log('[CAMERA] Trying fallback without deviceId')\r\n          stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false })\r\n        } else if (!preferredCameraId && (name === 'OverconstrainedError' || name === 'NotFoundError' || name === 'NotSupportedError')) {\r\n          console.log('[CAMERA] Trying fallback for facingMode not supported')\r\n          // Fallback for devices that don't support facingMode\r\n          stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false })\r\n        } else {\r\n          throw err\r\n        }\r\n      }\r\n      if (videoRef.current) {\r\n        console.log('[CAMERA] Setting stream to video element')\r\n        videoRef.current.srcObject = stream\r\n        console.log('[CAMERA] Stream tracks:', stream.getTracks().length, 'video tracks:', stream.getVideoTracks().length)\r\n        // Add event listeners for debugging\r\n        videoRef.current.addEventListener('loadeddata', () => console.log('[CAMERA] Video loadeddata'))\r\n        videoRef.current.addEventListener('canplay', () => console.log('[CAMERA] Video canplay'))\r\n        videoRef.current.addEventListener('play', () => console.log('[CAMERA] Video started playing'))\r\n        videoRef.current.addEventListener('error', (e) => console.error('[CAMERA] Video error:', e))\r\n        try {\r\n          videoRef.current.play()\r\n          console.log('[CAMERA] Play called successfully')\r\n        } catch (playErr) {\r\n          console.error('[CAMERA] Video play failed:', playErr)\r\n          // Try again after a short delay\r\n          setTimeout(() => {\r\n            try {\r\n              videoRef.current?.play()\r\n              console.log('[CAMERA] Retry play called')\r\n            } catch (retryErr) {\r\n              console.error('[CAMERA] Retry play failed:', retryErr)\r\n            }\r\n          }, 100)\r\n        }\r\n        try {\r\n          cameraSession.setVideoElementRef?.(videoRef.current)\r\n          cameraSession.setMediaStream?.(stream)\r\n          cameraSession.setMode?.('local')\r\n          cameraSession.setStreaming?.(true)\r\n        } catch (err) {\r\n          console.warn('[CAMERA] Failed to sync camera session with local stream:', err)\r\n        }\r\n      } else {\r\n        console.error('[CAMERA] Video element not found')\r\n      }\r\n      setStreaming(true)\r\n      // Capture device list for inline picker - no automatic preference updates\r\n      try {\r\n        const list = await navigator.mediaDevices.enumerateDevices()\r\n        setAvailableCameras(list.filter(d=>d.kind==='videoinput'))\r\n        console.log('[CAMERA] Found cameras:', list.filter(d=>d.kind==='videoinput').length)\r\n      } catch (enumErr) {\r\n        console.warn('[CAMERA] Failed to enumerate devices:', enumErr)\r\n      }\r\n    } catch (e) {\r\n      console.error('[CAMERA] Camera start failed:', e)\r\n      alert('Camera permission denied or not available.')\r\n    } finally {\r\n      setCameraStarting(false)\r\n    }\r\n  }\r\n\r\n  function stopCamera() {\r\n    if (videoRef.current && videoRef.current.srcObject) {\r\n      const tracks = (videoRef.current.srcObject as MediaStream).getTracks()\r\n      tracks.forEach(t => t.stop())\r\n      videoRef.current.srcObject = null\r\n      setStreaming(false)\r\n      setCameraStarting(false)\r\n    }\r\n  }\r\n\r\n  useEffect(() => {\r\n    const videoEl = videoRef.current\r\n    if (!videoEl) return\r\n    const sessionStream = cameraSession.getMediaStream?.() || null\r\n    const sessionVideo = cameraSession.getVideoElementRef?.() || null\r\n    const fallbackStream = (sessionVideo?.srcObject as MediaStream | null) || null\r\n    const activeStream = sessionStream || fallbackStream\r\n    if (!activeStream) return\r\n    if (videoEl.srcObject !== activeStream) {\r\n      videoEl.srcObject = activeStream\r\n    }\r\n    videoEl.muted = true\r\n    ;(videoEl as any).playsInline = true\r\n    try { videoEl.play?.() } catch {}\r\n    if (!streaming) setStreaming(true)\r\n  }, [cameraSession.mode, cameraSession.isStreaming, streaming, cameraSession])\r\n\r\n  function capture() {\r\n    try {\r\n      if (!canvasRef.current) return\r\n      const primary = videoRef.current\r\n      const sessionVideo = cameraSession.getVideoElementRef?.() || null\r\n      const source = (primary && primary.videoWidth > 0 && primary.videoHeight > 0) ? primary : sessionVideo || primary\r\n      if (!source) return\r\n      const video = source\r\n      const canvas = canvasRef.current\r\n      canvas.width = video.videoWidth\r\n      canvas.height = video.videoHeight\r\n      const ctx = canvas.getContext('2d')\r\n      if (!ctx) return\r\n      ctx.drawImage(video, 0, 0, canvas.width, canvas.height)\r\n      const url = canvas.toDataURL('image/png')\r\n      setSnapshotUrl(url)\r\n    } catch (e) {\r\n      console.warn('Capture error:', e)\r\n    }\r\n  }\r\n\r\n  // Inline light-weight device switcher (optional)\r\n  function CameraSelector() {\r\n    if (!availableCameras.length) return null\r\n    return (\r\n      <div className=\"absolute top-2 right-2 z-20 flex items-center gap-2 bg-black/40 rounded px-2 py-1 text-xs\">\r\n        <span>Cam:</span>\r\n        <select\r\n          className=\"bg-black/20 rounded px-1 py-0.5\"\r\n          value={preferredCameraId || ''}\r\n          onChange={async (e)=>{\r\n            if (cameraStarting) return\r\n            const id = e.target.value || undefined\r\n            const label = availableCameras.find(d=>d.deviceId===id)?.label\r\n            // This is a user-initiated change so force the preference even when locked\r\n            setPreferredCamera(id, label||'', true)\r\n            // Stop current camera and wait for cleanup\r\n            stopCamera()\r\n            // Small delay to ensure camera device is fully released\r\n            await new Promise(resolve => setTimeout(resolve, 150))\r\n            try {\r\n              await startCamera()\r\n            } catch (err) {\r\n              console.warn('Failed to start camera after device switch:', err)\r\n              // Try one more time after a longer delay\r\n              setTimeout(async () => {\r\n                try {\r\n                  await startCamera()\r\n                } catch (retryErr) {\r\n                  console.error('Camera switch failed after retry:', retryErr)\r\n                  alert('Failed to switch camera. Please try again or refresh the page.')\r\n                }\r\n              }, 500)\r\n            }\r\n          }}\r\n        >\r\n          <option value=\"\">Auto</option>\r\n          {availableCameras.map(d => (\r\n            <option key={d.deviceId} value={d.deviceId}>{d.label || (d.deviceId ? `Camera (${d.deviceId.slice(0,6)})` : 'Camera')}</option>\r\n          ))}\r\n        </select>\r\n        <button\r\n          className=\"btn btn--ghost btn-sm ml-2\"\r\n          onClick={async () => {\r\n            try {\r\n              // quick user-triggered rescan\r\n              const list = await navigator.mediaDevices.enumerateDevices()\r\n              setAvailableCameras(list.filter(d=>d.kind==='videoinput'))\r\n            } catch (err) {\r\n              console.warn('Rescan failed:', err)\r\n              alert('Failed to rescan devices. Ensure camera permissions are granted.')\r\n            }\r\n          }}\r\n          title=\"Rescan connected cameras\"\r\n        >\r\n          Rescan\r\n        </button>\r\n      </div>\r\n    )\r\n  }\r\n\r\n  function drawOverlay() {\r\n    if (DISABLE_CAMERA_OVERLAY) {\r\n      if (overlayRef.current) {\r\n        const ctx = overlayRef.current.getContext('2d')\r\n        if (ctx) ctx.clearRect(0, 0, overlayRef.current.width, overlayRef.current.height)\r\n      }\r\n      return\r\n    }\r\n    try {\r\n      // Only render overlays when calibration data exists and the phone stream isn't providing the image\r\n      if (!overlayRef.current || !videoRef.current || !H || !imageSize) {\r\n        if (overlayRef.current) {\r\n          const ctx = overlayRef.current.getContext('2d')\r\n          ctx?.clearRect(0, 0, overlayRef.current.width, overlayRef.current.height)\r\n        }\r\n        return\r\n      }\r\n      if (isPhoneCamera) return\r\n      const o = overlayRef.current\r\n      const v = videoRef.current\r\n      const w = v.clientWidth\r\n      const h = v.clientHeight\r\n      o.width = w; o.height = h\r\n  const ctx = o.getContext('2d')\r\n  if (!ctx) return\r\n  ctx.clearRect(0,0,w,h)\r\n  if (preferredCameraLocked || hideCameraOverlay) return\r\n\r\n      // scale homography from calibration image size to current rendered size\r\n      const sx = w / imageSize.w\r\n      const sy = h / imageSize.h\r\n      const Hs = scaleHomography(H, sx, sy)\r\n      const rings = [BoardRadii.bullInner, BoardRadii.bullOuter, BoardRadii.trebleInner, BoardRadii.trebleOuter, BoardRadii.doubleInner, BoardRadii.doubleOuter]\r\n      for (const r of rings) {\r\n        const poly = sampleRing(Hs, r, 720)\r\n        drawPolyline(ctx, poly, r === BoardRadii.doubleOuter ? '#22d3ee' : '#a78bfa', r === BoardRadii.doubleOuter ? 3 : 2)\r\n      }\r\n    } catch (e) {\r\n      // Silently ignore drawing errors to prevent re-render loops\r\n      console.warn('Overlay drawing error:', e)\r\n    }\r\n  }\r\n\r\n  useEffect(() => {\r\n    if (manualOnly || DISABLE_CAMERA_OVERLAY) return\r\n    const id = setInterval(drawOverlay, 250)\r\n    return () => clearInterval(id)\r\n  // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  }, [H, imageSize, effectiveStreaming, manualOnly, isPhoneCamera, preferredCameraLocked, hideCameraOverlay])\r\n\r\n  // Built-in autoscore loop (offline/local CV)\r\n  useEffect(() => {\r\n    if (manualOnly) return\r\n    if (autoscoreProvider !== 'built-in') return\r\n    // Choose source: local video element, or paired phone camera element\r\n    const cameraSession = useCameraSession.getState()\r\n    const isPhone = (useUserSettings.getState().preferredCameraLabel === 'Phone Camera')\r\n    const sourceVideo: HTMLVideoElement | null = isPhone ? (cameraSession.getVideoElementRef?.() || null) : (videoRef.current)\r\n    if (!sourceVideo) return\r\n    if (!H || !imageSize) return\r\n\r\n    let canceled = false\r\n    const v = sourceVideo\r\n    const proc = canvasRef.current\r\n    if (!proc) return\r\n\r\n    // Initialize or reset detector\r\n    if (!detectorRef.current) detectorRef.current = new DartDetector()\r\n\r\n    const tick = () => {\r\n      if (canceled) return\r\n      try {\r\n        const vw = v.videoWidth || 0\r\n        const vh = v.videoHeight || 0\r\n        if (!vw || !vh) { rafRef.current = requestAnimationFrame(tick); return }\r\n        if (proc.width !== vw) proc.width = vw\r\n        if (proc.height !== vh) proc.height = vh\r\n  const ctx = proc.getContext('2d', { willReadFrequently: true })\r\n        if (!ctx) { rafRef.current = requestAnimationFrame(tick); return }\r\n        ctx.drawImage(v, 0, 0, vw, vh)\r\n        const frame = ctx.getImageData(0, 0, vw, vh)\r\n\r\n        frameCountRef.current++\r\n\r\n        // Seed ROI from calibration homography (board center + double radius along X)\r\n        const cImg = applyHomography(H, { x: 0, y: 0 })\r\n        const rImg = applyHomography(H, { x: BoardRadii.doubleOuter, y: 0 })\r\n        // Scale calibration image coordinates to current video size\r\n        const sx = vw / imageSize.w\r\n        const sy = vh / imageSize.h\r\n        const cx = cImg.x * sx\r\n        const cy = cImg.y * sy\r\n        const rx = rImg.x * sx\r\n        const ry = rImg.y * sy\r\n        const roiR = Math.hypot(rx - cx, ry - cy) * 1.08\r\n\r\n        const detector = detectorRef.current!\r\n        if (detectorSeedVersion >= 0) {\r\n          detector.setROI(cx, cy, Math.max(24, Math.min(Math.max(vw, vh), roiR)))\r\n        }\r\n\r\n        // Try to detect a new dart when not paused and visit has room\r\n  if (!paused && pendingDarts < 3 && detectionArmedRef.current && frameCountRef.current > 150) {\r\n          const det = detector.detect(frame)\r\n          const nowPerf = performance.now()\r\n          if (autoCandidateRef.current && nowPerf - autoCandidateRef.current.firstTs > 900) {\r\n            autoCandidateRef.current = null\r\n          }\r\n          if (det && det.confidence >= AUTO_COMMIT_CONFIDENCE) {\r\n            const warmupActive = streamingStartMsRef.current > 0 && (nowPerf - streamingStartMsRef.current) < AUTO_STREAM_IGNORE_MS\r\n            // Refine tip on gradients\r\n            const tipRefined = refinePointSobel(proc, det.tip, 6)\r\n            // Map to calibration image space before scoring\r\n            const pCal = { x: tipRefined.x / sx, y: tipRefined.y / sy }\r\n            const score = scoreFromImagePoint(H, pCal)\r\n            const ring = score.ring as Ring\r\n            const value = score.base\r\n            const label = `${ring} ${value > 0 ? value : ''}`.trim()\r\n            const sector = (score.sector ?? null) as number | null\r\n            const mult = (Math.max(0, Number(score.mult) || 0) as 0|1|2|3)\r\n            let shouldAccept = false\r\n\r\n            setLastAutoScore(label)\r\n            setLastAutoValue(value)\r\n            setLastAutoRing(ring)\r\n\r\n            const applyAutoHit = (candidate: AutoCandidate) => {\r\n              if (candidate.value > 0) {\r\n                setHadRecentAuto(true)\r\n                setPulseManualPill(true)\r\n                try { if (pulseTimeoutRef.current) clearTimeout(pulseTimeoutRef.current) } catch {}\r\n                pulseTimeoutRef.current = window.setTimeout(() => { setPulseManualPill(false); pulseTimeoutRef.current = null }, 1500)\r\n                try { addDart(candidate.value, candidate.label, candidate.ring) } catch {}\r\n              } else {\r\n                setHadRecentAuto(false)\r\n              }\r\n              try { if (onAutoDart) onAutoDart(candidate.value, candidate.ring, { sector: candidate.sector, mult: candidate.mult }) } catch {}\r\n            }\r\n\r\n            if (!warmupActive) {\r\n              if (ring === 'MISS' || value <= 0) {\r\n                autoCandidateRef.current = null\r\n                setHadRecentAuto(false)\r\n                try { if (onAutoDart) onAutoDart(value, ring, { sector, mult }) } catch {}\r\n                shouldAccept = true\r\n              } else {\r\n                const existing = autoCandidateRef.current\r\n                if (!existing || existing.value !== value || existing.ring !== ring) {\r\n                  autoCandidateRef.current = { value, ring, label, sector, mult, firstTs: nowPerf, frames: 1 }\r\n                } else {\r\n                  autoCandidateRef.current = { ...existing, label, frames: existing.frames + 1 }\r\n                }\r\n                const current = autoCandidateRef.current!\r\n                const holdMs = nowPerf - current.firstTs\r\n                const ready = current.frames >= AUTO_COMMIT_MIN_FRAMES || holdMs >= AUTO_COMMIT_HOLD_MS\r\n                const cooled = (nowPerf - lastAutoCommitRef.current) >= AUTO_COMMIT_COOLDOWN_MS\r\n                if (ready && cooled) {\r\n                  applyAutoHit(current)\r\n                  autoCandidateRef.current = null\r\n                  lastAutoCommitRef.current = nowPerf\r\n                  shouldAccept = true\r\n                }\r\n              }\r\n            } else {\r\n              autoCandidateRef.current = null\r\n              shouldAccept = true\r\n            }\r\n\r\n            captureDetectionLog({\r\n              ts: nowPerf,\r\n              label,\r\n              value,\r\n              ring,\r\n              confidence: det.confidence,\r\n              ready: shouldAccept,\r\n              accepted: shouldAccept && value > 0 && ring !== 'MISS',\r\n              warmup: warmupActive,\r\n            })\r\n\r\n            // Draw debug tip and shaft axis on overlay (scaled to overlay canvas)\r\n            try {\r\n              const drawOverlayHint = value > 0 && ring !== 'MISS'\r\n              if (drawOverlayHint) {\r\n                const o = overlayRef.current\r\n                if (o) {\r\n                  const octx = o.getContext('2d')\r\n                  if (octx) {\r\n                    // Maintain overlay size and clear a small area\r\n                    const ox = (tipRefined.x / vw) * o.width\r\n                    const oy = (tipRefined.y / vh) * o.height\r\n                    octx.save()\r\n                    octx.beginPath()\r\n                    octx.strokeStyle = '#f59e0b'\r\n                    octx.lineWidth = 2\r\n                    octx.arc(ox, oy, 6, 0, Math.PI * 2)\r\n                    octx.stroke()\r\n                    // axis line if available\r\n                    if ((det as any).axis) {\r\n                      const ax = (det as any).axis\r\n                      const ax1 = (ax.x1 / vw) * o.width\r\n                      const ay1 = (ax.y1 / vh) * o.height\r\n                      const ax2 = (ax.x2 / vw) * o.width\r\n                      const ay2 = (ax.y2 / vh) * o.height\r\n                      octx.beginPath()\r\n                      octx.moveTo(ax1, ay1)\r\n                      octx.lineTo(ax2, ay2)\r\n                      octx.stroke()\r\n                    }\r\n                    // bbox\r\n                    if ((det as any).bbox) {\r\n                      const bx = ((det as any).bbox.x / vw) * o.width\r\n                      const by = ((det as any).bbox.y / vh) * o.height\r\n                      const bw = ((det as any).bbox.w / vw) * o.width\r\n                      const bh = ((det as any).bbox.h / vh) * o.height\r\n                      octx.strokeStyle = '#22d3ee'\r\n                      octx.strokeRect(bx, by, bw, bh)\r\n                    }\r\n                    octx.restore()\r\n                  }\r\n                }\r\n              }\r\n            } catch {}\r\n\r\n            if (shouldAccept) {\r\n              detector.accept(frame, det)\r\n            }\r\n          } else {\r\n            if (autoCandidateRef.current && (nowPerf - autoCandidateRef.current.firstTs) > 800) {\r\n              autoCandidateRef.current = null\r\n            }\r\n          }\r\n        }\r\n      } catch (e) {\r\n        // Soft-fail; continue next frame\r\n        // console.warn('Autoscore tick error:', e)\r\n      }\r\n      rafRef.current = requestAnimationFrame(tick)\r\n    }\r\n\r\n    rafRef.current = requestAnimationFrame(tick)\r\n    return () => {\r\n      canceled = true\r\n      if (rafRef.current) cancelAnimationFrame(rafRef.current)\r\n      rafRef.current = null\r\n    }\r\n  // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  }, [manualOnly, autoscoreProvider, effectiveStreaming, H, imageSize, paused, pendingDarts, detectorSeedVersion, captureDetectionLog])\r\n\r\n  const handleUseLocalCamera = useCallback(async () => {\r\n    try {\r\n      if (isPhoneCamera) {\r\n        const fallback = availableCameras.find(c => c.kind === 'videoinput')\r\n        if (fallback) {\r\n          setPreferredCamera(fallback.deviceId, fallback.label || '', true)\r\n        } else {\r\n          setPreferredCamera(undefined, '', true)\r\n        }\r\n      }\r\n      await startCamera()\r\n    } catch (err) {\r\n      console.warn('[CameraView] Local camera fallback failed:', err)\r\n    }\r\n  }, [availableCameras, isPhoneCamera, setPreferredCamera])\r\n\r\n  // Update calibration audit status whenever homography or image size changes\r\n  useEffect(() => {\r\n    try {\r\n      useAudit.getState().setCalibrationStatus({ hasHomography: !!H, imageSize })\r\n    } catch {}\r\n  }, [H, imageSize])\r\n\r\n  // External autoscore subscription\r\n  useEffect(() => {\r\n    if (autoscoreProvider !== 'external-ws' || !autoscoreWsUrl) return\r\n    const sub = subscribeExternalWS(autoscoreWsUrl, (d) => {\r\n      if (!detectionArmedRef.current || performance.now() - streamingStartMsRef.current < 5000) return\r\n      // Prefer parent hook if provided; otherwise add to visit directly\r\n      if (onAutoDart) {\r\n        try { onAutoDart(d.value, d.ring as any, { sector: d.sector ?? null, mult: (d.mult as any) ?? 0 }) } catch {}\r\n        try { addHeatSample({ playerId: matchState.players[matchState.currentPlayerIdx]?.id ?? null, sector: d.sector ?? null, mult: (d.mult as any) ?? 0, ring: d.ring as any, ts: Date.now() }) } catch {}\r\n      } else {\r\n        const label = d.ring === 'INNER_BULL' ? 'INNER_BULL 50' : d.ring === 'BULL' ? 'BULL 25' : `${d.ring[0]}${(d.value/(d.mult||1))||d.value} ${d.value}`\r\n        addDart(d.value, label, d.ring as any)\r\n        try { addHeatSample({ playerId: matchState.players[matchState.currentPlayerIdx]?.id ?? null, sector: d.sector ?? null, mult: (d.mult as any) ?? 0, ring: d.ring as any, ts: Date.now() }) } catch {}\r\n      }\r\n    })\r\n    return () => sub.close()\r\n  }, [autoscoreProvider, autoscoreWsUrl])\r\n\r\n  function onOverlayClick(e: React.MouseEvent<HTMLCanvasElement>) {\r\n    if (!overlayRef.current || !H || !imageSize) return\r\n    const rect = overlayRef.current.getBoundingClientRect()\r\n    const x = e.clientX - rect.left\r\n    const y = e.clientY - rect.top\r\n    // Map to calibration coordinate space by reversing the display scaling\r\n    const sx = overlayRef.current.width / imageSize.w\r\n    const sy = overlayRef.current.height / imageSize.h\r\n    const pCal: Point = { x: x / sx, y: y / sy }\r\n  const score = scoreFromImagePoint(H, pCal)\r\n  const s = `${score.ring} ${score.base > 0 ? score.base : ''}`.trim()\r\n    setLastAutoScore(s)\r\n  setLastAutoValue(score.base)\r\n  setLastAutoRing(score.ring as Ring)\r\n    setHadRecentAuto(true)\r\n    // Optional immediate commit hook (e.g., Double Practice)\r\n    try {\r\n      if (immediateAutoCommit && onAutoDart) {\r\n        onAutoDart(score.base, score.ring as Ring, { sector: score.sector, mult: score.mult })\r\n        try { addHeatSample({ playerId: matchState.players[matchState.currentPlayerIdx]?.id ?? null, sector: score.sector ?? null, mult: score.mult ?? 0, ring: score.ring as any, ts: Date.now() }) } catch {}\r\n        setHadRecentAuto(false)\r\n      }\r\n    } catch {}\r\n  }\r\n\r\n  function parseManual(input: string): { label: string; value: number; ring: Ring } | null {\r\n    const t = input.trim().toUpperCase()\r\n    if (!t) return null\r\n    const bull = t === 'BULL' || t === '50' || t === 'DBULL' || t === 'IBULL'\r\n    const outerBull = t === '25' || t === 'OBULL'\r\n    if (bull) return { label: 'INNER_BULL 50', value: 50, ring: 'INNER_BULL' }\r\n    if (outerBull) return { label: 'BULL 25', value: 25, ring: 'BULL' }\r\n    const m = t.match(/^(S|D|T)?\\s*(\\d{1,2})$/)\r\n    if (!m) return null\r\n    const mult = (m[1] || 'S') as 'S'|'D'|'T'\r\n    const num = parseInt(m[2], 10)\r\n    if (num < 1 || num > 20) return null\r\n    const multVal = mult === 'S' ? 1 : mult === 'D' ? 2 : 3\r\n    const ring: Ring = mult === 'S' ? 'SINGLE' : mult === 'D' ? 'DOUBLE' : 'TRIPLE'\r\n    return { label: `${mult}${num} ${num*multVal}`, value: num * multVal, ring }\r\n  }\r\n\r\n  function getCurrentRemaining(): number {\r\n    const s = matchState\r\n    if (!s.players.length) return s.startingScore\r\n    const p = s.players[s.currentPlayerIdx]\r\n    const leg = p.legs[p.legs.length-1]\r\n    if (!leg) return s.startingScore\r\n    return leg.totalScoreRemaining\r\n  }\r\n\r\n  function addDart(value: number, label: string, ring: Ring) {\r\n    if (shouldDeferCommit && awaitingClear) {\r\n      if (!pulseManualPill) {\r\n        setPulseManualPill(true)\r\n        try { if (pulseTimeoutRef.current) clearTimeout(pulseTimeoutRef.current) } catch {}\r\n        pulseTimeoutRef.current = window.setTimeout(() => { setPulseManualPill(false); pulseTimeoutRef.current = null }, 1200)\r\n      }\r\n      return\r\n    }\r\n    // In generic mode, delegate to parent without X01 bust/finish rules\r\n    if (scoringMode === 'custom') {\r\n      if (onGenericDart) try { onGenericDart(value, ring, { label }) } catch {}\r\n      // Maintain a lightweight pending list for UI only\r\n      if (pendingDarts >= 3) {\r\n        // Rotate to next visit locally so we don't drop darts visually\r\n        setPendingDarts(1)\r\n        setPendingScore(value)\r\n        setPendingEntries([{ label, value, ring }])\r\n        return\r\n      }\r\n      const newDarts = pendingDarts + 1\r\n      setPendingDarts(newDarts)\r\n      setPendingScore(s => s + value)\r\n      setPendingEntries(e => [...e, { label, value, ring }])\r\n      return\r\n    }\r\n\r\n    // If a new dart arrives while 3 are pending, auto-commit previous visit and start a new one\r\n    if (pendingDarts >= 3) {\r\n      const previousScore = pendingScore\r\n      const previousDarts = pendingDarts\r\n      // Commit previous full visit\r\n  callAddVisit(previousScore, previousDarts, { preOpenDarts: pendingPreOpenDarts || 0, doubleWindowDarts: pendingDartsAtDouble || 0, finishedByDouble: false, visitTotal: previousScore })\r\n      try {\r\n        const name = matchState.players[matchState.currentPlayerIdx]?.name\r\n        if (name) addSample(name, previousDarts, previousScore)\r\n      } catch {}\r\n      // Start next visit with this dart\r\n      const willCount = !x01DoubleIn || isOpened || ring === 'DOUBLE' || ring === 'INNER_BULL'\r\n      const applied = willCount ? value : 0\r\n      setPendingDarts(1)\r\n      setPendingScore(applied)\r\n      setPendingEntries([{ label, value: applied, ring }])\r\n      setPendingPreOpenDarts(willCount ? 0 : 1)\r\n      setPendingDartsAtDouble(0)\r\n      if (x01DoubleIn && !isOpened && (ring === 'DOUBLE' || ring === 'INNER_BULL')) {\r\n        setOpened(true)\r\n      }\r\n      enqueueVisitCommit({ score: previousScore, darts: previousDarts, finished: false })\r\n      return\r\n    }\r\n    const newDarts = pendingDarts + 1\r\n    // Apply X01 Double-In rule before scoring if enabled and not opened yet\r\n    const countsForScore = !x01DoubleIn || isOpened || ring === 'DOUBLE' || ring === 'INNER_BULL'\r\n    const appliedValue = countsForScore ? value : 0\r\n    if (x01DoubleIn && !isOpened && (ring === 'DOUBLE' || ring === 'INNER_BULL')) {\r\n      setOpened(true)\r\n    }\r\n    const newScore = pendingScore + appliedValue\r\n    const remaining = getCurrentRemaining()\r\n    const after = remaining - newScore\r\n\r\n    // Bust conditions (double-out): negative or 1, or 0 without double/inner bull\r\n    const isFinish = after === 0 && (ring === 'DOUBLE' || ring === 'INNER_BULL')\r\n    const isBust = after < 0 || after === 1 || (after === 0 && !isFinish)\r\n\r\n    if (isBust) {\r\n      // Commit bust visit: 0 score, darts thrown so far including this one\r\n      const preOpenThis = (x01DoubleIn && !isOpened && !(ring === 'DOUBLE' || ring === 'INNER_BULL')) ? 1 : 0\r\n      const preOpenTotal = (pendingPreOpenDarts || 0) + preOpenThis\r\n      // Count attempts in double-out window\r\n  const postAfter = after\r\n  const postBefore = after + appliedValue\r\n  const attemptsThisDart = ((postBefore > 50 && postAfter <= 50) || (postBefore <= 50)) ? 1 : 0\r\n      const attemptsTotal = (pendingDartsAtDouble || 0) + attemptsThisDart\r\n  callAddVisit(0, newDarts, { preOpenDarts: preOpenTotal, doubleWindowDarts: attemptsTotal, finishedByDouble: false, visitTotal: 0 })\r\n      setPendingDarts(0); setPendingScore(0); setPendingEntries([]); setPendingPreOpenDarts(0)\r\n      setPendingDartsAtDouble(0)\r\n      enqueueVisitCommit({ score: 0, darts: newDarts, finished: false })\r\n      return\r\n    }\r\n\r\n  // Normal add (value may be zero if not opened yet)\r\n    setPendingDarts(newDarts)\r\n    setPendingScore(newScore)\r\n    setPendingEntries(e => [...e, { label, value: appliedValue, ring }])\r\n    if (x01DoubleIn && !isOpened && !(ring === 'DOUBLE' || ring === 'INNER_BULL')) {\r\n      setPendingPreOpenDarts(n => (n||0) + 1)\r\n    }\r\n    // Track double-out attempts within this visit\r\n    {\r\n      const postAfter = after\r\n      const postBefore = after + appliedValue\r\n      const countThisDart = (postBefore > 50 && postAfter <= 50) || (postBefore <= 50)\r\n      if (countThisDart) setPendingDartsAtDouble(c => (c||0) + 1)\r\n    }\r\n\r\n    if (isFinish) {\r\n      // Commit visit with current total and end leg\r\n  callAddVisit(newScore, newDarts, { preOpenDarts: pendingPreOpenDarts || 0, doubleWindowDarts: pendingDartsAtDouble || 0, finishedByDouble: true, visitTotal: newScore })\r\n  callEndLeg(newScore)\r\n      setPendingDarts(0); setPendingScore(0); setPendingEntries([]); setPendingPreOpenDarts(0); setPendingDartsAtDouble(0)\r\n      enqueueVisitCommit({ score: newScore, darts: newDarts, finished: true })\r\n      return\r\n    }\r\n\r\n    if (newDarts >= 3) {\r\n  callAddVisit(newScore, newDarts, { preOpenDarts: pendingPreOpenDarts || 0, doubleWindowDarts: pendingDartsAtDouble || 0, finishedByDouble: false, visitTotal: newScore })\r\n      setPendingDarts(0); setPendingScore(0); setPendingEntries([]); setPendingPreOpenDarts(0); setPendingDartsAtDouble(0)\r\n      enqueueVisitCommit({ score: newScore, darts: newDarts, finished: false })\r\n    }\r\n  }\r\n\r\n  function onAddAutoDart() {\r\n    if (shouldDeferCommit && awaitingClear) return\r\n    if (lastAutoScore) {\r\n      if (onAutoDart) {\r\n        try { onAutoDart(lastAutoValue, lastAutoRing, undefined) } catch {}\r\n      } else {\r\n        addDart(lastAutoValue, lastAutoScore, lastAutoRing)\r\n      }\r\n      setNonRegCount(0)\r\n      setHadRecentAuto(false)\r\n    }\r\n  }\r\n\r\n  function onApplyManual() {\r\n    if (shouldDeferCommit && awaitingClear) return\r\n    const parsed = parseManual(manualScore)\r\n    if (!parsed) { alert('Enter like T20, D16, 5, 25, 50'); return }\r\n    // If autoscore didn't register recently, count toward recalibration\r\n    if (!hadRecentAuto || !lastAutoScore || lastAutoRing === 'MISS' || lastAutoValue === 0) {\r\n      const c = nonRegCount + 1\r\n      setNonRegCount(c)\r\n  if (c >= 5) setShowRecalModal(true)\r\n    } else {\r\n      setNonRegCount(0)\r\n    }\r\n    addDart(parsed.value, parsed.label, parsed.ring)\r\n    setManualScore('')\r\n    setHadRecentAuto(false)\r\n  }\r\n\r\n  // Replace the last pending dart with a manually typed correction\r\n  function onReplaceManual() {\r\n    if (shouldDeferCommit && awaitingClear) return\r\n    const parsed = parseManual(manualScore)\r\n    if (!parsed) { alert('Enter like T20, D16, 5, 25, 50'); return }\r\n    if (pendingDarts === 0 || pendingEntries.length === 0) {\r\n      onApplyManual()\r\n      return\r\n    }\r\n    if (scoringMode === 'custom') {\r\n      // Let parent handle replacement semantics\r\n      if (!hadRecentAuto || !lastAutoScore || lastAutoRing === 'MISS' || lastAutoValue === 0) {\r\n        const c = nonRegCount + 1\r\n        setNonRegCount(c)\r\n  if (c >= 5) setShowRecalModal(true)\r\n      } else setNonRegCount(0)\r\n\r\n      // Update local pending UI\r\n      setPendingEntries((e)=>[...e.slice(0,-1), { label: parsed.label, value: parsed.value, ring: parsed.ring }])\r\n      if (onGenericReplace) try { onGenericReplace(parsed.value, parsed.ring, { label: parsed.label }) } catch {}\r\n      setManualScore('')\r\n      setHadRecentAuto(false)\r\n      return\r\n    }\r\n    if (!hadRecentAuto || !lastAutoScore || lastAutoRing === 'MISS' || lastAutoValue === 0) {\r\n      const c = nonRegCount + 1\r\n      setNonRegCount(c)\r\n  if (c >= 5) setShowRecalModal(true)\r\n    } else setNonRegCount(0)\r\n\r\n    const last = pendingEntries[pendingEntries.length-1]\r\n    const prevDarts = pendingDarts - 1\r\n    const prevScore = pendingScore - (last?.value || 0)\r\n    const remaining = getCurrentRemaining()\r\n    const newScore = prevScore + parsed.value\r\n    const newDarts = prevDarts + 1\r\n    const after = remaining - newScore\r\n    const isFinish = after === 0 && (parsed.ring === 'DOUBLE' || parsed.ring === 'INNER_BULL')\r\n    const isBust = after < 0 || after === 1 || (after === 0 && !isFinish)\r\n\r\n    if (isBust) {\r\n  callAddVisit(0, newDarts)\r\n      try {\r\n        const name = matchState.players[matchState.currentPlayerIdx]?.name\r\n        if (name) addSample(name, newDarts, 0)\r\n      } catch {}\r\n      setPendingDarts(0); setPendingScore(0); setPendingEntries([])\r\n      enqueueVisitCommit({ score: 0, darts: newDarts, finished: false })\r\n      setManualScore('')\r\n      setHadRecentAuto(false)\r\n      return\r\n    }\r\n\r\n    setPendingDarts(newDarts)\r\n    setPendingScore(newScore)\r\n    setPendingEntries((e)=>[...e.slice(0,-1), { label: parsed.label, value: parsed.value, ring: parsed.ring }])\r\n\r\n    if (isFinish) {\r\n  callAddVisit(newScore, newDarts)\r\n  callEndLeg(newScore)\r\n      try {\r\n        const name = matchState.players[matchState.currentPlayerIdx]?.name\r\n        if (name) addSample(name, newDarts, newScore)\r\n      } catch {}\r\n      setPendingDarts(0); setPendingScore(0); setPendingEntries([])\r\n      enqueueVisitCommit({ score: newScore, darts: newDarts, finished: true })\r\n      setManualScore('')\r\n      setHadRecentAuto(false)\r\n      return\r\n    }\r\n\r\n    if (newDarts >= 3) {\r\n  callAddVisit(newScore, newDarts)\r\n      try {\r\n        const name = matchState.players[matchState.currentPlayerIdx]?.name\r\n        if (name) addSample(name, newDarts, newScore)\r\n      } catch {}\r\n      setPendingDarts(0); setPendingScore(0); setPendingEntries([])\r\n      enqueueVisitCommit({ score: newScore, darts: newDarts, finished: false })\r\n    }\r\n    setManualScore('')\r\n    setHadRecentAuto(false)\r\n  }\r\n\r\n  function onRecalibrateNow() {\r\n    setShowRecalModal(false)\r\n    setNonRegCount(0)\r\n    // Ask App to switch to calibrate tab\r\n    try { window.dispatchEvent(new CustomEvent('ndn:request-calibrate')) } catch {}\r\n  }\r\n\r\n  function onResetCalibration() {\r\n    resetCalibration()\r\n    setShowRecalModal(false)\r\n    setNonRegCount(0)\r\n  }\r\n\r\n  // Keyboard shortcut: press 'm' to open Manual Correction (if not typing in an input)\r\n  useEffect(() => {\r\n    function onKey(e: KeyboardEvent) {\r\n      try {\r\n        const active = document.activeElement as HTMLElement | null\r\n        const tag = active?.tagName?.toLowerCase()\r\n        if (e.key === 'm' && tag !== 'input' && tag !== 'textarea') {\r\n          setActiveTab('manual')\r\n          setShowManualModal(true)\r\n        }\r\n      } catch {}\r\n    }\r\n    window.addEventListener('keydown', onKey)\r\n    return () => window.removeEventListener('keydown', onKey)\r\n  }, [])\r\n\r\n  // Centralized quick-entry handler for S/D/T 1-20 buttons\r\n  function onQuickEntry(num: number, mult: 'S'|'D'|'T') {\r\n    if (pendingDarts >= 3 || (shouldDeferCommit && awaitingClear)) return\r\n    const val = num * (mult==='S'?1:mult==='D'?2:3)\r\n    const ring: Ring = mult==='S' ? 'SINGLE' : mult==='D' ? 'DOUBLE' : 'TRIPLE'\r\n    // If autoscore didn't register recently, count toward recalibration\r\n    if (!hadRecentAuto || !lastAutoScore || lastAutoRing === 'MISS' || lastAutoValue === 0) {\r\n      const c = nonRegCount + 1\r\n      setNonRegCount(c)\r\n  if (c >= 5) setShowRecalModal(true)\r\n    } else {\r\n      setNonRegCount(0)\r\n    }\r\n    addDart(val, `${mult}${num} ${val}`, ring)\r\n    setHadRecentAuto(false)\r\n  }\r\n\r\n  function onUndoDart() {\r\n    if (pendingDarts === 0) return\r\n    const last = pendingEntries[pendingEntries.length-1]\r\n    setPendingDarts(d => d - 1)\r\n    setPendingScore(s => s - (last?.value || 0))\r\n    setPendingEntries(e => e.slice(0, -1))\r\n  }\r\n\r\n  function onCommitVisit() {\r\n    if (pendingDarts === 0 || (shouldDeferCommit && awaitingClear)) return\r\n    if (scoringMode === 'custom') {\r\n      // For custom mode, simply clear local pending (parent maintains its own scoring)\r\n      setPendingDarts(0); setPendingScore(0); setPendingEntries([])\r\n      return\r\n    }\r\n    const visitScore = pendingScore\r\n    const visitDarts = pendingDarts\r\n  callAddVisit(visitScore, visitDarts)\r\n    try {\r\n      const name = matchState.players[matchState.currentPlayerIdx]?.name\r\n      if (name) addSample(name, visitDarts, visitScore)\r\n    } catch {}\r\n    setPendingDarts(0); setPendingScore(0); setPendingEntries([])\r\n    enqueueVisitCommit({ score: visitScore, darts: visitDarts, finished: false })\r\n  }\r\n\r\n  return (\r\n    <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-4\">\r\n      {/* Pills (optional; can be hidden and controlled by parent) */}\r\n      {showToolbar && (\r\n        <div className=\"lg:col-span-2\">\r\n          <div className=\"flex items-center gap-2 mb-2\">\r\n            {!manualOnly && (\r\n              <button\r\n                className={`btn px-3 py-1 text-sm ${activeTab==='auto' ? 'tab--active' : ''}`}\r\n                onClick={()=>{ setActiveTab('auto'); setShowManualModal(false); setShowAutoModal(true) }}\r\n              >Autoscore</button>\r\n            )}\r\n            <button\r\n              className={`btn px-3 py-1 text-sm ${activeTab==='manual' ? 'tab--active' : ''}`}\r\n              onClick={()=>{ setActiveTab('manual'); setShowManualModal(true) }}\r\n              title=\"Open Manual Correction\"\r\n            >Manual Correction</button>\r\n            {manualOnly && (\r\n              <span className=\"text-xs opacity-70\">Manual scoring mode active</span>\r\n            )}\r\n          </div>\r\n        </div>\r\n      )}\r\n      {!hideInlinePanels && !manualOnly ? (\r\n        <div className=\"card relative camera-fullwidth-card lg:col-span-2\">\r\n          <h2 className=\"text-xl font-semibold mb-3\">Camera</h2>\r\n          <ResizablePanel storageKey=\"ndn:camera:size\" className=\"relative rounded-2xl overflow-hidden bg-black\" defaultWidth={480} defaultHeight={360} minWidth={360} minHeight={270} maxWidth={800} maxHeight={600} autoFill>\r\n            <CameraSelector />\r\n            {(() => {\r\n              const aspect = cameraAspect || (useUserSettings.getState().cameraAspect || 'wide')\r\n              const fit = (cameraFitMode || (useUserSettings.getState().cameraFitMode || 'fit')) === 'fit'\r\n              const videoClass = (aspect === 'square')\r\n                ? 'absolute left-0 top-1/2 -translate-y-1/2 min-w-full min-h-full object-cover object-left bg-black'\r\n                : (fit\r\n                  ? 'absolute inset-0 w-full h-full object-contain object-center bg-black'\r\n                  : 'absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 min-w-full min-h-full w-auto h-auto object-cover object-center bg-black')\r\n              const containerClass = aspect === 'square'\r\n                ? 'relative w-full mx-auto aspect-square bg-black'\r\n                : 'relative w-full aspect-[4/3] bg-black'\r\n              const renderVideoSurface = () => (\r\n                <div className={containerClass}>\r\n                  <video ref={videoRef} className={videoClass} playsInline webkit-playsinline=\"true\" muted autoPlay />\r\n                  <canvas ref={overlayRef} className=\"absolute inset-0 w-full h-full\" onClick={onOverlayClick} />\r\n                  <div\r\n                    className=\"absolute top-2 left-1/2 -translate-x-1/2 z-20 flex items-center gap-3 cursor-pointer select-none\"\r\n                    onDoubleClick={handleIndicatorReset}\r\n                    aria-label={`Visit status: ${pendingEntries[0] ? (pendingEntries[0].value>0?'hit':'miss') : 'pending'}, ${pendingEntries[1] ? (pendingEntries[1].value>0?'hit':'miss') : 'pending'}, ${pendingEntries[2] ? (pendingEntries[2].value>0?'hit':'miss') : 'pending'}`}\r\n                  >\r\n                    {[0,1,2].map(i => {\r\n                      const e = pendingEntries[i] as any\r\n                      const entrySeq = indicatorEntryVersions[i]\r\n                      const isPending = !e\r\n                      const isActive = !!e && entrySeq === indicatorVersion\r\n                      const hasPositiveValue = typeof e?.value === 'number' ? e.value > 0 : false\r\n                      const hasHitRing = (e?.ring && e.ring !== 'MISS') ?? false\r\n                      const isHit = isActive && (hasPositiveValue || hasHitRing)\r\n                      const color = !isActive ? 'bg-gray-500/70' : (isHit ? 'bg-emerald-400' : 'bg-rose-500')\r\n                      const activeState = isActive && !isPending\r\n                      return <span key={i} className={`visit-dot ${activeState ? 'active' : 'inactive'} ${color}`} />\r\n                    })}\r\n                    {dartTimerEnabled && dartTimeLeft !== null && (\r\n                      <span className=\"px-2 py-0.5 rounded bg-black/60 text-white text-xs font-semibold\">\r\n                        {Math.max(0, dartTimeLeft)}s\r\n                      </span>\r\n                    )}\r\n                  </div>\r\n                  {shouldDeferCommit && awaitingClear ? (\r\n                    <div className=\"absolute bottom-3 left-1/2 -translate-x-1/2 z-20 bg-black/70 text-amber-200 text-xs font-semibold px-3 py-1 rounded-full shadow\">\r\n                      Remove darts to continue\r\n                    </div>\r\n                  ) : null}\r\n                </div>\r\n              )\r\n              if (isPhoneCamera) {\r\n                if (!phoneFeedActive) {\r\n                  return (\r\n                    <div className=\"w-full h-full flex flex-col items-center justify-center bg-gradient-to-br from-blue-900/50 to-purple-900/50\">\r\n                      <div className=\"text-center space-y-3 max-w-xs mx-auto\">\r\n                        <div className=\"text-4xl\">ðŸ“±</div>\r\n                        <div className=\"text-lg font-semibold text-blue-100\">Phone camera selected</div>\r\n                        <p className=\"text-sm text-slate-300\">Start streaming from the Calibrator tab or reconnect below.</p>\r\n                        <div className=\"flex items-center justify-center gap-2 flex-wrap\">\r\n                          <button className=\"btn bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 text-sm\" onClick={handlePhoneReconnect}>Reconnect Phone</button>\r\n                          <button className=\"btn bg-slate-700 hover:bg-slate-800 text-white px-3 py-1 text-sm\" onClick={()=>{ try { cameraSession.setShowOverlay?.(true) } catch {} }}>Show Overlay</button>\r\n                          <button className=\"btn bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-1 text-sm\" onClick={handleUseLocalCamera} disabled={!availableCameras.length}>Use Local Camera</button>\r\n                        </div>\r\n                      </div>\r\n                    </div>\r\n                  )\r\n                }\r\n                return renderVideoSurface()\r\n              }\r\n              return renderVideoSurface()\r\n            })()}\r\n          </ResizablePanel>\r\n\r\n          <div className=\"mt-3 flex items-center justify-between gap-2\">\r\n            <button\r\n              className=\"btn btn--ghost px-3 py-1 text-xs font-semibold\"\r\n              onClick={() => setShowDetectionLog(prev => !prev)}\r\n            >\r\n              {showDetectionLog ? 'Hide' : 'Show'} detection log\r\n            </button>\r\n            <span className=\"text-xs text-slate-400\">Recent detections: {detectionLog.length}</span>\r\n          </div>\r\n          {showDetectionLog && (\r\n            <div className=\"mt-2 rounded-2xl border border-white/15 bg-slate-900/80 p-3 text-xs text-white font-mono max-h-36 overflow-y-auto space-y-1\">\r\n              {detectionLog.length === 0 ? (\r\n                <div className=\"text-center text-slate-400\">No autoscore detections yet.</div>\r\n              ) : (\r\n                detectionLog.slice().reverse().map(entry => (\r\n                  <div key={entry.ts} className=\"flex items-center justify-between gap-3\">\r\n                    <span className=\"truncate flex-1\" title={`Value ${entry.value} ${entry.ring}`}>\r\n                      {entry.label.padEnd(6, ' ')}\r\n                    </span>\r\n                    <span className=\"text-slate-400\">{entry.confidence.toFixed(2)}</span>\r\n                    <span className={`px-2 rounded-full text-[10px] font-semibold ${entry.accepted ? 'bg-emerald-500/80' : entry.ready ? 'bg-amber-500/80' : 'bg-rose-500/80'}`}>\r\n                      {entry.accepted ? 'accepted' : entry.ready ? 'queued' : 'ignored'}\r\n                    </span>\r\n                  </div>\r\n                ))\r\n              )}\r\n            </div>\r\n          )}\r\n\r\n          {/* Small Manual pill in top-right of camera card so users in any game mode can open Manual Correction */}\r\n          {inProgress ? (\r\n            <div className=\"absolute top-3 right-3 z-30\">\r\n              {/**\r\n               * Autoscore state styles:\r\n               * - success: recent auto detected a valid non-miss score -> green\r\n               * - ambiguous: recent auto detected but result is miss/zero/empty -> amber\r\n               * - idle: default white/neutral\r\n               */}\r\n              {\r\n                (() => {\r\n                  let stateClass = 'bg-white/90 text-slate-800'\r\n                  let title = 'Manual Correction (M)'\r\n                  if (hadRecentAuto) {\r\n                    const ok = !!lastAutoScore && lastAutoRing !== 'MISS' && lastAutoValue > 0\r\n                    if (ok) {\r\n                      stateClass = 'bg-emerald-600 text-white'\r\n                      title = `Manual Correction (M) â€” Autoscore: ${lastAutoScore} (confirmed)`\r\n                    } else {\r\n                      stateClass = 'bg-amber-400 text-black'\r\n                      title = `Manual Correction (M) â€” Autoscore ambiguous: ${lastAutoScore || 'â€”'}`\r\n                    }\r\n                  }\r\n                  // Larger, clearer pill text and padding\r\n                  const baseClasses = 'px-4 py-2 rounded-full text-base font-semibold shadow-sm hover:opacity-90'\r\n                  const okNow = hadRecentAuto && !!lastAutoScore && lastAutoRing !== 'MISS' && lastAutoValue > 0\r\n                  const pulseClass = pulseManualPill && okNow ? 'ring-4 ring-emerald-400/60 animate-ping' : (hadRecentAuto && !okNow ? 'animate-pulse' : '')\r\n                  return (\r\n                    <button\r\n                      className={`${baseClasses} ${stateClass} ${pulseClass}`}\r\n                      onClick={() => { setActiveTab('manual'); setShowManualModal(true) }}\r\n                      title={title}\r\n                    >\r\n                      Manual\r\n                    </button>\r\n                  )\r\n                })()\r\n              }\r\n            </div>\r\n          ) : null}\r\n          <div className=\"flex flex-wrap items-center gap-2 mt-3\">\r\n            {isPhoneCamera ? (\r\n              <>\r\n                <div className={`text-sm px-3 py-2 rounded border flex-1 min-w-[200px] ${phoneFeedActive ? 'bg-emerald-500/10 border-emerald-400/40 text-emerald-100' : 'bg-amber-500/10 border-amber-400/40 text-amber-100'}`}>\r\n                  {phoneFeedActive ? 'ðŸ“± Phone camera stream active' : 'ðŸ“± Waiting for phone camera stream'}\r\n                </div>\r\n                <button className=\"btn bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 text-sm\" onClick={handlePhoneReconnect}>Reconnect Phone</button>\r\n                <button className=\"btn bg-slate-700 hover:bg-slate-800 text-white px-3 py-1 text-sm\" onClick={()=>{ try { cameraSession.setShowOverlay?.(!cameraSession.showOverlay) } catch {} }}>\r\n                  {cameraSession.showOverlay ? 'Hide Overlay' : 'Show Overlay'}\r\n                </button>\r\n                <button className=\"btn bg-rose-600 hover:bg-rose-700 text-white px-3 py-1 text-sm\" disabled={!phoneFeedActive} onClick={()=>{ try { cameraSession.clearSession?.() } catch {} }}>Stop Phone Feed</button>\r\n                {canFallbackToLocal && (\r\n                  <button className=\"btn bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-1 text-sm\" onClick={handleUseLocalCamera} disabled={!availableCameras.length}>Use Local Camera</button>\r\n                )}\r\n              </>\r\n            ) : (\r\n              <>\r\n                {!streaming ? (\r\n                  <button className=\"btn\" onClick={startCamera} disabled={cameraStarting}>\r\n                    {cameraStarting ? 'Connecting Camera...' : 'Connect Camera'}\r\n                  </button>\r\n                ) : (\r\n                  <button className=\"btn bg-rose-600 hover:bg-rose-700\" onClick={stopCamera}>Stop Camera</button>\r\n                )}\r\n              </>\r\n            )}\r\n            {!manualOnly && (\r\n              <button\r\n                className=\"btn bg-slate-700 hover:bg-slate-800\"\r\n                onClick={requestDeviceManager}\r\n                title=\"Open phone, WiFi, and USB camera options\"\r\n              >\r\n                Camera Devices\r\n              </button>\r\n            )}\r\n            <button\r\n              className=\"btn btn--ghost px-3 py-1 text-sm\"\r\n              onClick={() => setHideCameraOverlay(!hideCameraOverlay)}\r\n              title=\"Toggle the board guide overlay\"\r\n            >\r\n              {hideCameraOverlay ? 'Show board guides' : 'Hide board guides'}\r\n            </button>\r\n            <button\r\n              className={`btn ${cameraEnabled ? 'bg-rose-600 hover:bg-rose-700 text-white' : 'bg-emerald-600 hover:bg-emerald-700 text-white'}`}\r\n              onClick={() => setCameraEnabled(!cameraEnabled)}\r\n              title=\"Toggle whether the camera is used for scoring\"\r\n            >\r\n              {cameraEnabled ? 'Disable camera mode' : 'Enable camera mode'}\r\n            </button>\r\n            <button className=\"btn\" onClick={capture} disabled={!effectiveStreaming}>Capture Still</button>\r\n            <button className=\"btn bg-slate-700 hover:bg-slate-800\" disabled={!effectiveStreaming} onClick={()=>{\r\n              detectorRef.current = null\r\n              setDetectorSeedVersion(v=>v+1)\r\n            }}>Reset Autoscore Background</button>\r\n            <button className=\"btn bg-slate-700 hover:bg-slate-800\" onClick={()=>{ try{ window.dispatchEvent(new Event('ndn:camera-reset' as any)) }catch{} }}>Reset Camera Size</button>\r\n          </div>\r\n        </div>\r\n      ) : null}\r\n\r\n      {/* Floating Manual Correction button (always available for quick manual typing during games) */}\r\n      {inProgress ? (\r\n        <div className=\"fixed bottom-6 right-6 z-50\">\r\n          <button\r\n            className=\"btn btn--primary rounded-full w-12 h-12 flex items-center justify-center shadow-lg\"\r\n            title=\"Open Manual Correction (M)\"\r\n            onClick={() => { setActiveTab('manual'); setShowManualModal(true) }}\r\n          >\r\n            âœï¸\r\n          </button>\r\n        </div>\r\n      ) : null}\r\n      {!hideInlinePanels && manualOnly && (\r\n        <div className=\"card\">\r\n          <h2 className=\"text-xl font-semibold mb-3\">Manual Scoring</h2>\r\n          <p className=\"text-sm opacity-80 mb-3\">Camera-based autoscore is disabled. Use the manual visit input or open the Manual Correction panel to record darts.</p>\r\n          <div className=\"flex flex-wrap items-center gap-2\">\r\n            <button className=\"btn\" onClick={()=>{ setShowManualModal(true); setActiveTab('manual') }}>Open Manual Correction</button>\r\n            <button className=\"btn btn--ghost\" onClick={()=>{ try { window.dispatchEvent(new Event('ndn:open-scoring' as any)) } catch {} }}>Manage Pending Visit</button>\r\n          </div>\r\n        </div>\r\n      )}\r\n      {/* Snapshot panel removed to reduce unused space */}\r\n      <canvas ref={canvasRef} className=\"hidden\"></canvas>\r\n      {/* Autoscore moved into a pill-triggered modal to reduce on-screen clutter */}\r\n      {/* Modal: Autoscore */}\r\n  {showAutoModal && !manualOnly && (\r\n        <div className=\"fixed inset-0 bg-black/60 z-[100]\" role=\"dialog\" aria-modal=\"true\">\r\n          <div className=\"absolute inset-0 flex items-center justify-center p-4\">\r\n            <ResizableModal\r\n              storageKey=\"ndn:autoscore:size\"\r\n              className=\"w-full max-w-3xl\"\r\n              defaultWidth={720}\r\n              defaultHeight={520}\r\n              minWidth={420}\r\n              minHeight={320}\r\n              maxWidth={1400}\r\n              maxHeight={900}\r\n              initialFitHeight\r\n            >\r\n              <div className=\"flex items-center justify-between mb-3\">\r\n                <h2 className=\"text-xl font-semibold\">Autoscore</h2>\r\n                <div className=\"flex items-center gap-2\">\r\n                  <button className=\"btn btn--ghost\" onClick={()=>setShowAutoModal(false)}>Close</button>\r\n                </div>\r\n              </div>\r\n              <div className=\"text-sm opacity-80 mb-3\">Click the camera overlay to autoscore. Use Manual Correction if the last auto is off.</div>\r\n              <div className=\"flex items-center gap-2 mb-3 flex-wrap\">\r\n                <span className=\"font-semibold\">Last auto:</span>\r\n                <span>{lastAutoScore || 'â€”'}</span>\r\n                <button className=\"btn\" onClick={onAddAutoDart} disabled={pendingDarts>=3}>Add Auto Dart</button>\r\n                {nonRegCount>0 && <span className=\"text-sm opacity-80\">No-registers: {nonRegCount}/3</span>}\r\n              </div>\r\n              <div className=\"mt-2\">\r\n                <div className=\"text-sm font-semibold mb-2\">Quick entry</div>\r\n                {/* Bulls */}\r\n                <div className=\"flex flex-wrap gap-2 mb-3\">\r\n                  <button className=\"btn\" disabled={pendingDarts>=3} onClick={()=>{\r\n                    if (!hadRecentAuto || !lastAutoScore || lastAutoRing === 'MISS' || lastAutoValue === 0) {\r\n                      const c = nonRegCount + 1\r\n                      setNonRegCount(c)\r\n                      if (c >= 5) setShowRecalModal(true)\r\n                    } else setNonRegCount(0)\r\n                    addDart(25, 'BULL 25', 'BULL'); setHadRecentAuto(false)\r\n                  }}>25</button>\r\n                  <button className=\"btn\" disabled={pendingDarts>=3} onClick={()=>{\r\n                    if (!hadRecentAuto || !lastAutoScore || lastAutoRing === 'MISS' || lastAutoValue === 0) {\r\n                      const c = nonRegCount + 1\r\n                      setNonRegCount(c)\r\n                      if (c >= 5) setShowRecalModal(true)\r\n                    } else setNonRegCount(0)\r\n                    addDart(50, 'INNER_BULL 50', 'INNER_BULL'); setHadRecentAuto(false)\r\n                  }}>50</button>\r\n                </div>\r\n                {/* Grouped dropdown: Doubles, Singles, Trebles */}\r\n                <div className=\"flex items-center gap-2 mb-3\">\r\n                  <input\r\n                    className=\"input w-full max-w-sm\"\r\n                    list=\"autoscore-quick-list\"\r\n                    placeholder=\"Type or select (e.g., D16, T20, S5)\"\r\n                    value={quickSelAuto}\r\n                    onChange={e=>setQuickSelAuto(e.target.value.toUpperCase())}\r\n                    onKeyDown={e=>{ if(e.key==='Enter'){ const m = quickSelAuto.match(/^(S|D|T)(\\d{1,2})$/); if(m){ onQuickEntry(parseInt(m[2],10), m[1] as any); } }} }\r\n                  />\r\n                  <datalist id=\"autoscore-quick-list\">\r\n                    {(['D','S','T'] as const).map(mult => (\r\n                      Array.from({length:20}, (_,i)=>i+1).map(num => (\r\n                        <option key={`${mult}${num}`} value={`${mult}${num}`} />\r\n                      ))\r\n                    ))}\r\n                  </datalist>\r\n                  <button\r\n                    className=\"btn\"\r\n                    disabled={!quickSelAuto || pendingDarts>=3}\r\n                    onClick={()=>{\r\n                      const m = quickSelAuto.match(/^(S|D|T)(\\d{1,2})$/)\r\n                      if (!m) return\r\n                      const mult = m[1] as 'S'|'D'|'T'\r\n                      const num = parseInt(m[2], 10)\r\n                      onQuickEntry(num, mult)\r\n                    }}\r\n                  >Add</button>\r\n                </div>\r\n              </div>\r\n            </ResizableModal>\r\n          </div>\r\n        </div>\r\n      )}\r\n      {showManualModal && (\r\n        <div className=\"fixed inset-0 bg-black/60 z-[100]\" role=\"dialog\" aria-modal=\"true\">\r\n          <div className=\"absolute inset-0 flex flex-col\">\r\n            <FocusLock returnFocus>\r\n            <div className=\"p-3 md:p-4 flex items-center justify-between\">\r\n              <h3 className=\"text-xl md:text-2xl font-semibold\">Manual Correction</h3>\r\n              <div className=\"flex items-center gap-2\">\r\n                <button className=\"btn bg-slate-700 hover:bg-slate-800\" onClick={()=>{ setShowManualModal(false); }}>Close</button>\r\n              </div>\r\n            </div>\r\n            <div className=\"flex-1 p-3 md:p-4\">\r\n              <div className=\"h-full grid grid-cols-1 lg:grid-cols-2 gap-4\">\r\n                {/* Live preview */}\r\n                <div className=\"card relative flex flex-col\">\r\n                  <div className=\"text-sm font-semibold mb-2\">Live Preview</div>\r\n                  <div className=\"relative flex-1 rounded-2xl overflow-hidden bg-black\">\r\n                    <canvas ref={manualPreviewRef} className=\"absolute inset-0 w-full h-full\" />\r\n                  </div>\r\n                </div>\r\n                {/* Manual controls */}\r\n                <div className=\"card flex flex-col\">\r\n                  <div className=\"text-sm opacity-80 mb-2\">Type a correction or replace the last dart. The preview updates live.</div>\r\n                  <div className=\"flex items-center gap-2 mb-2\">\r\n                    <span className=\"font-semibold\">Last auto:</span>\r\n                    <span>{lastAutoScore || 'â€”'}</span>\r\n                    <button className=\"btn\" onClick={onAddAutoDart} disabled={pendingDarts>=3}>Add Auto Dart</button>\r\n                  </div>\r\n                  <div className=\"flex items-center gap-2 mb-2\">\r\n                    <input\r\n                      className=\"input flex-[1.2]\"\r\n                      placeholder=\"Manual (T20, D16, 5, 25, 50)\"\r\n                      value={manualScore}\r\n                      onChange={e => setManualScore(e.target.value)}\r\n                      onKeyDown={e => {\r\n                        if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); onApplyManual() }\r\n                        if (e.key === 'Enter' && e.shiftKey) { e.preventDefault(); onReplaceManual() }\r\n                      }}\r\n                    />\r\n                    <button className=\"btn btn--ghost\" onClick={onReplaceManual} disabled={pendingDarts===0}>Replace Last</button>\r\n                    <button className=\"btn\" onClick={onApplyManual} disabled={pendingDarts>=3}>Add</button>\r\n                  </div>\r\n                  <div className=\"text-xs opacity-70 mb-4\">Press Enter to Add Â· Shift+Enter to Replace Last</div>\r\n                  {/* Numeric keypad for quick manual numeric entry */}\r\n                  <div className=\"mb-4\">\r\n                    <div className=\"text-sm font-semibold mb-2\">Number pad</div>\r\n                    <div className=\"grid grid-cols-3 gap-2 max-w-sm\">\r\n                      {['7','8','9','4','5','6','1','2','3','0'].map((d) => (\r\n                        <button key={d} className=\"btn text-lg\" onClick={()=>{\r\n                          // Append digit to manualScore (keep T/D/T prefixes if present)\r\n                          setManualScore(ms => {\r\n                            // If existing starts with letter (S/D/T), append after it\r\n                            if (/^[SDT]/i.test(ms)) return ms + d\r\n                            return (ms || '') + d\r\n                          })\r\n                        }}>{d}</button>\r\n                      ))}\r\n                      <button className=\"btn bg-rose-600 hover:bg-rose-700 text-white\" onClick={() => setManualScore('')}>Clear</button>\r\n                      <button className=\"btn bg-slate-600 hover:bg-slate-700 text-white\" onClick={() => setManualScore(ms => (ms||'').slice(0,-1))}>âŒ«</button>\r\n                      <button className=\"btn bg-emerald-600 hover:bg-emerald-700 text-white\" onClick={() => onApplyManual()} disabled={pendingDarts>=3}>Enter</button>\r\n                    </div>\r\n                    <div className=\"text-xs opacity-70 mt-2\">Tap numbers then press Enter to submit. Use D/T prefixes for doubles/trebles (e.g., D16).</div>\r\n                  </div>\r\n                  <div className=\"mt-auto\">\r\n                    <div className=\"text-sm font-semibold mb-2\">Quick entry</div>\r\n                    {/* Bulls */}\r\n                    <div className=\"flex flex-wrap gap-2 mb-3\">\r\n                      <button className=\"btn\" disabled={pendingDarts>=3} onClick={()=>{\r\n                        if (!hadRecentAuto || !lastAutoScore || lastAutoRing === 'MISS' || lastAutoValue === 0) {\r\n                          const c = nonRegCount + 1\r\n                          setNonRegCount(c)\r\n                          if (c >= 5) setShowRecalModal(true)\r\n                        } else setNonRegCount(0)\r\n                        addDart(25, 'BULL 25', 'BULL'); setHadRecentAuto(false)\r\n                      }}>25</button>\r\n                      <button className=\"btn\" disabled={pendingDarts>=3} onClick={()=>{\r\n                        if (!hadRecentAuto || !lastAutoScore || lastAutoRing === 'MISS' || lastAutoValue === 0) {\r\n                          const c = nonRegCount + 1\r\n                          setNonRegCount(c)\r\n                          if (c >= 5) setShowRecalModal(true)\r\n                        } else setNonRegCount(0)\r\n                        addDart(50, 'INNER_BULL 50', 'INNER_BULL'); setHadRecentAuto(false)\r\n                      }}>50</button>\r\n                    </div>\r\n                    {/* Grouped dropdown: Doubles, Singles, Trebles */}\r\n                    <div className=\"flex items-center gap-2 mb-3\">\r\n                      <input\r\n                        className=\"input w-full max-w-sm\"\r\n                        list=\"manual-quick-list\"\r\n                        placeholder=\"Type or select (e.g., D16, T20, S5)\"\r\n                        value={quickSelManual}\r\n                        onChange={e=>setQuickSelManual(e.target.value.toUpperCase())}\r\n                        onKeyDown={e=>{ if(e.key==='Enter'){ const m = quickSelManual.match(/^(S|D|T)(\\d{1,2})$/); if(m){ onQuickEntry(parseInt(m[2],10), m[1] as any); } }} }\r\n                      />\r\n                      <datalist id=\"manual-quick-list\">\r\n                        {(['D','S','T'] as const).map(mult => (\r\n                          Array.from({length:20}, (_,i)=>i+1).map(num => (\r\n                            <option key={`${mult}${num}`} value={`${mult}${num}`} />\r\n                          ))\r\n                        ))}\r\n                      </datalist>\r\n                      <button\r\n                        className=\"btn\"\r\n                        disabled={!quickSelManual || pendingDarts>=3}\r\n                        onClick={()=>{\r\n                          const m = quickSelManual.match(/^(S|D|T)(\\d{1,2})$/)\r\n                          if (!m) return\r\n                          const mult = m[1] as 'S'|'D'|'T'\r\n                          const num = parseInt(m[2], 10)\r\n                          onQuickEntry(num, mult)\r\n                        }}\r\n                      >Add</button>\r\n                    </div>\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            </div>\r\n            </FocusLock>\r\n          </div>\r\n        </div>\r\n      )}\r\n      {showScoringModal && (\r\n        <div className=\"fixed inset-0 bg-black/60 z-[100] flex items-center justify-center\">\r\n          <FocusLock returnFocus>\r\n            <div className=\"card w-full max-w-4xl relative text-left bg-[#2d2250] text-white p-6 rounded-xl shadow-xl\" role=\"dialog\" aria-modal=\"true\">\r\n              <button className=\"absolute top-2 right-2 btn px-2 py-1 bg-purple-500 text-white font-bold\" onClick={()=>setShowScoringModal(false)} aria-label=\"Close scoring dialog\">Close</button>\r\n              <h2 className=\"text-xl font-bold mb-4 flex items-center gap-2 text-white\">Scoring</h2>\r\n              <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\r\n                {/* Camera section */}\r\n                <div className=\"bg-black/30 rounded-2xl p-4\">\r\n                  <h2 className=\"text-lg font-semibold mb-3\">Camera</h2>\r\n                  <ResizablePanel storageKey=\"ndn:camera:size:modal\" className=\"relative rounded-2xl overflow-hidden bg-black\" defaultWidth={480} defaultHeight={360} minWidth={360} minHeight={270} maxWidth={800} maxHeight={600}>\r\n                    <CameraSelector />\r\n                    {(() => {\r\n                      const fit = (useUserSettings.getState().cameraFitMode || 'fit') === 'fit'\r\n                      const videoClass = fit\r\n                        ? 'absolute inset-0 w-full h-full object-contain object-center bg-black'\r\n                        : 'absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 min-w-full min-h-full w-auto h-auto object-cover object-center bg-black'\r\n                      const renderVideoSurface = () => (\r\n                        <div className=\"relative w-full aspect-[4/3] bg-black\">\r\n                          <video ref={videoRef} className={videoClass} playsInline webkit-playsinline=\"true\" muted autoPlay />\r\n                          <canvas ref={overlayRef} className=\"absolute inset-0 w-full h-full\" onClick={onOverlayClick} />\r\n                          <div className=\"absolute top-2 left-1/2 -translate-x-1/2 z-20 flex items-center gap-3\"\r\n                            aria-label={`Visit status: ${pendingEntries[0] ? (pendingEntries[0].value>0?'hit':'miss') : 'pending'}, ${pendingEntries[1] ? (pendingEntries[1].value>0?'hit':'miss') : 'pending'}, ${pendingEntries[2] ? (pendingEntries[2].value>0?'hit':'miss') : 'pending'}`}\r\n                          >\r\n                            {[0,1,2].map(i => {\r\n                              const e = pendingEntries[i] as any\r\n                              const isPending = !e\r\n                              const isHit = !!e && (typeof e.value === 'number' ? e.value > 0 : true)\r\n                              const color = isPending ? 'bg-gray-500/70' : (isHit ? 'bg-emerald-400' : 'bg-rose-500')\r\n                              return <span key={i} className={`w-3 h-3 rounded-full shadow ${color}`} />\r\n                            })}\r\n                            {dartTimerEnabled && dartTimeLeft !== null && (\r\n                              <span className=\"px-2 py-0.5 rounded bg-black/60 text-white text-xs font-semibold\">\r\n                                {Math.max(0, dartTimeLeft)}s\r\n                              </span>\r\n                            )}\r\n                          </div>\r\n                          {shouldDeferCommit && awaitingClear ? (\r\n                            <div className=\"absolute bottom-3 left-1/2 -translate-x-1/2 z-20 bg-black/70 text-amber-200 text-xs font-semibold px-3 py-1 rounded-full shadow\">\r\n                              Remove darts to continue\r\n                            </div>\r\n                          ) : null}\r\n                        </div>\r\n                      )\r\n                      if (isPhoneCamera) {\r\n                        if (!phoneFeedActive) {\r\n                          return (\r\n                            <div className=\"w-full h-full flex flex-col items-center justify-center bg-gradient-to-br from-blue-900/50 to-purple-900/50\">\r\n                              <div className=\"text-center space-y-3 max-w-xs mx-auto\">\r\n                                <div className=\"text-4xl\">ðŸ“±</div>\r\n                                <div className=\"text-lg font-semibold text-blue-100\">Phone camera selected</div>\r\n                                <p className=\"text-sm text-slate-300\">Start streaming from the Calibrator tab or reconnect below.</p>\r\n                                <div className=\"flex items-center justify-center gap-2 flex-wrap\">\r\n                                  <button className=\"btn bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 text-sm\" onClick={handlePhoneReconnect}>Reconnect Phone</button>\r\n                                  <button className=\"btn bg-slate-700 hover:bg-slate-800 text-white px-3 py-1 text-sm\" onClick={()=>{ try { cameraSession.setShowOverlay?.(true) } catch {} }}>Show Overlay</button>\r\n                                  <button className=\"btn bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-1 text-sm\" onClick={handleUseLocalCamera} disabled={!availableCameras.length}>Use Local Camera</button>\r\n                                </div>\r\n                              </div>\r\n                            </div>\r\n                          )\r\n                        }\r\n                        return renderVideoSurface()\r\n                      }\r\n                      return renderVideoSurface()\r\n                    })()}\r\n                  </ResizablePanel>\r\n                  <div className=\"flex flex-wrap items-center gap-2 mt-3\">\r\n                    {isPhoneCamera ? (\r\n                      <>\r\n                        <div className={`text-sm px-3 py-2 rounded border flex-1 min-w-[200px] ${phoneFeedActive ? 'bg-emerald-500/10 border-emerald-400/40 text-emerald-100' : 'bg-amber-500/10 border-amber-400/40 text-amber-100'}`}>\r\n                          {phoneFeedActive ? 'ðŸ“± Phone camera stream active' : 'ðŸ“± Waiting for phone camera stream'}\r\n                        </div>\r\n                        <button className=\"btn bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 text-sm\" onClick={handlePhoneReconnect}>Reconnect Phone</button>\r\n                        <button className=\"btn bg-slate-700 hover:bg-slate-800 text-white px-3 py-1 text-sm\" onClick={()=>{ try { cameraSession.setShowOverlay?.(!cameraSession.showOverlay) } catch {} }}>\r\n                          {cameraSession.showOverlay ? 'Hide Overlay' : 'Show Overlay'}\r\n                        </button>\r\n                        <button className=\"btn bg-rose-600 hover:bg-rose-700 text-white px-3 py-1 text-sm\" disabled={!phoneFeedActive} onClick={()=>{ try { cameraSession.clearSession?.() } catch {} }}>Stop Phone Feed</button>\r\n                        {canFallbackToLocal && (\r\n                          <button className=\"btn bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-1 text-sm\" onClick={handleUseLocalCamera} disabled={!availableCameras.length}>Use Local Camera</button>\r\n                        )}\r\n                      </>\r\n                    ) : (\r\n                      <>\r\n                        {!streaming ? (\r\n                          <button className=\"btn bg-gradient-to-r from-purple-500 to-purple-700 text-white font-bold\" onClick={startCamera}>Connect Camera</button>\r\n                        ) : (\r\n                          <button className=\"btn bg-gradient-to-r from-rose-600 to-rose-700 text-white font-bold\" onClick={stopCamera}>Stop Camera</button>\r\n                        )}\r\n                      </>\r\n                    )}\r\n                    <button className=\"btn bg-gradient-to-r from-indigo-500 to-indigo-700 text-white font-bold\" onClick={capture} disabled={!effectiveStreaming}>Capture Still</button>\r\n                    <button className=\"btn bg-gradient-to-r from-slate-600 to-slate-800 text-white font-bold\" disabled={!effectiveStreaming} onClick={()=>{ detectorRef.current = null; setDetectorSeedVersion(v=>v+1) }}>Reset Autoscore Background</button>\r\n                    <button className=\"btn bg-gradient-to-r from-slate-500 to-slate-700 text-white font-bold\" onClick={()=>{ try{ window.dispatchEvent(new Event('ndn:camera-reset' as any)) }catch{} }}>Reset Camera Size</button>\r\n                  </div>\r\n                </div>\r\n                {/* Pending Visit section */}\r\n                <div className=\"bg-black/30 rounded-2xl p-4\">\r\n                  <h2 className=\"text-lg font-semibold mb-3\">Pending Visit</h2>\r\n                  <div className=\"text-sm opacity-80 mb-2\">Up to 3 darts per visit.</div>\r\n                  <div className=\"flex items-center gap-2 mb-2\">\r\n                    {[0,1,2].map(i => {\r\n                      const e = pendingEntries[i] as any\r\n                      const isPending = !e\r\n                      const isHit = !!e && (typeof e.value === 'number' ? e.value > 0 : true)\r\n                      const color = isPending ? 'bg-gray-500/70' : (isHit ? 'bg-emerald-400' : 'bg-rose-500')\r\n                      return <span key={i} className={`w-2.5 h-2.5 rounded-full shadow ${color}`} />\r\n                    })}\r\n                    {dartTimerEnabled && dartTimeLeft !== null && (\r\n                      <span className=\"ml-2 px-2 py-0.5 rounded bg-black/40 text-white text-xs font-semibold\">{Math.max(0, dartTimeLeft)}s</span>\r\n                    )}\r\n                  </div>\r\n                  <ul className=\"text-sm mb-2 list-disc pl-5\">\r\n                    {pendingEntries.length === 0 ? <li className=\"opacity-60\">No darts yet</li> : pendingEntries.map((e,i) => <li key={i}>{e.label}</li>)}\r\n                  </ul>\r\n                  <div className=\"flex items-center gap-4 mb-2\">\r\n                    <div className=\"font-semibold\">Darts: {pendingDarts}/3</div>\r\n                    <div className=\"font-semibold\">Total: {pendingScore}</div>\r\n                  </div>\r\n                  <div className=\"flex gap-2\">\r\n                    <button className=\"btn bg-gradient-to-r from-purple-500 to-purple-700 text-white font-bold\" onClick={onUndoDart} disabled={pendingDarts===0}>Undo Dart</button>\r\n                    <button className=\"btn bg-gradient-to-r from-emerald-500 to-emerald-700 text-white font-bold\" onClick={onCommitVisit} disabled={pendingDarts===0}>Commit Visit</button>\r\n                    <button className=\"btn bg-gradient-to-r from-slate-500 to-slate-700 text-white font-bold\" onClick={handleToolbarClear} disabled={pendingDarts===0}>Clear</button>\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            </div>\r\n          </FocusLock>\r\n        </div>\r\n      )}\r\n      {showRecalModal && (\r\n        <div className=\"fixed inset-0 bg-black/60 z-50 flex items-center justify-center\">\r\n          <div className=\"card max-w-md w-full relative text-left bg-[#2d2250] text-white p-6 rounded-xl shadow-xl\">\r\n            <button className=\"absolute top-2 right-2 btn px-2 py-1 bg-purple-500 text-white font-bold\" onClick={()=>{setShowRecalModal(false); setNonRegCount(0)}}>Close</button>\r\n            <h3 className=\"text-xl font-bold mb-2 flex items-center gap-2 text-white\">Recalibration Recommended</h3>\r\n            <div className=\"mb-4 text-lg font-semibold text-indigo-200\">We detected 3 incorrect autoscores in a row. You can recalibrate now or reset calibration and try again.</div>\r\n            <div className=\"flex gap-2\">\r\n              <button className=\"btn bg-gradient-to-r from-purple-500 to-purple-700 text-white font-bold\" onClick={onRecalibrateNow}>Go to Calibrate</button>\r\n              <button className=\"btn bg-gradient-to-r from-slate-500 to-slate-700 text-white font-bold\" onClick={onResetCalibration}>Reset Calibration</button>\r\n              <button className=\"btn bg-gradient-to-r from-slate-500 to-slate-700 text-white font-bold\" onClick={()=>{setShowRecalModal(false); setNonRegCount(0)}}>Dismiss</button>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      )}\r\n  {/* Duplicate Pending Visit panel removed to avoid showing the same controls twice when inline panels are visible. */}\r\n    </div>\r\n  )\r\n}\r\n"],"names":["scoreFromImagePoint","H_boardToImage","pImg","pBoard","imageToBoard","scoreAtBoardPoint","DartDetector","cx","cy","radius","width","height","frame","alpha","w","h","data","bg","n","i","p","r","g","b","gray","x","y","dx","dy","recent","mask","diff","sum","sum2","cnt","isHighlight","maxc","minc","d","satApprox","isHi","mu","var_","sigma","dynamicThresh","visited","bestArea","bestIdxs","idxs","area","qh","q","cur","nbs","nb","minX","minY","maxX","maxY","meanX","meanY","idx","cxx","cyy","cxy","trace","det","tmp","l1","vx","vy","vlen","dxc","dyc","outward","rlen","rx","ry","cosAng","maxT","tipX","tipY","t","dxr","dyr","minR2","bboxW","bboxH","bboxArea","fill","radial","confidence","l2","bw","bh","yy","xx","tip","close","a","out","on","j","parseExternalDart","ring","normalizeRing","finalizeFromValue","s","m","mult","sec","mul","inner","value","v","subscribeExternalWS","url","onDart","socket","alive","lastSig","lastSigAt","DEDUP_WINDOW_MS","seenIds","seenSet","considerForward","payload","parsed","pid","old","sig","now","connect","ev","ResizablePanel","storageKey","children","className","defaultWidth","defaultHeight","minWidth","minHeight","maxWidth","maxHeight","autoFill","size","setSize","useState","raw","startRef","useRef","containerRef","useEffect","onReset","clamp","min","max","beginResize","e","dir","el","rect","onMove","endResize","style","jsxs","jsx","useHeatmapStore","create","set","get","state","useMatchControl","endsAt","AUTO_COMMIT_MIN_FRAMES","AUTO_COMMIT_HOLD_MS","AUTO_COMMIT_COOLDOWN_MS","AUTO_STREAM_IGNORE_MS","DETECTION_ARM_DELAY_MS","AUTO_COMMIT_CONFIDENCE","BOARD_CLEAR_GRACE_MS","CameraView","onVisitCommitted","showToolbar","onAutoDart","immediateAutoCommit","hideInlinePanels","scoringMode","onGenericDart","onGenericReplace","x01DoubleInOverride","onAddVisit","onEndLeg","videoRef","preferredCameraId","preferredCameraLabel","setPreferredCamera","autoscoreProvider","autoscoreWsUrl","cameraAspect","cameraFitMode","autoCommitMode","cameraEnabled","setCameraEnabled","preferredCameraLocked","hideCameraOverlay","setHideCameraOverlay","useUserSettings","manualOnly","availableCameras","setAvailableCameras","canvasRef","overlayRef","streaming","setStreaming","cameraSession","useCameraSession","isPhoneCamera","sessionStream","sessionStreaming","phoneFeedActive","effectiveStreaming","cameraStarting","setCameraStarting","snapshotUrl","setSnapshotUrl","H","imageSize","resetCalibration","_hydrated","useCalibration","lastAutoScore","setLastAutoScore","manualScore","setManualScore","lastAutoValue","setLastAutoValue","lastAutoRing","setLastAutoRing","pendingDarts","setPendingDarts","pendingScore","setPendingScore","pendingEntries","setPendingEntries","pendingPreOpenDarts","setPendingPreOpenDarts","pendingDartsAtDouble","setPendingDartsAtDouble","awaitingClear","setAwaitingClear","pendingCommitRef","pendingCommitTimerRef","shouldDeferCommit","indicatorVersion","setIndicatorVersion","indicatorEntryVersions","setIndicatorEntryVersions","autoCandidateRef","detectionLogRef","lastAutoCommitRef","streamingStartMsRef","detectionArmedRef","detectionArmTimerRef","frameCountRef","detectionLog","setDetectionLog","showDetectionLog","setShowDetectionLog","clearPendingCommitTimer","useCallback","captureDetectionLog","entry","next","finalizePendingCommit","_trigger","pending","enqueueVisitCommit","clearPendingManual","reason","setHadRecentAuto","handler","handleIndicatorReset","handleToolbarClear","requestDeviceManager","err","x01DoubleInSetting","x01DoubleIn","openedById","setOpenedById","matchState","useMatch","currentPlayerId","isOpened","setOpened","inProgress","setVisit","usePendingVisit","resetPendingVisit","addVisit","endLeg","callAddVisit","score","darts","meta","callEndLeg","addHeatSample","quickSelAuto","setQuickSelAuto","quickSelManual","setQuickSelManual","nonRegCount","setNonRegCount","showRecalModal","setShowRecalModal","hadRecentAuto","pulseManualPill","setPulseManualPill","pulseTimeoutRef","activeTab","setActiveTab","showManualModal","setShowManualModal","showAutoModal","setShowAutoModal","showScoringModal","setShowScoringModal","manualPreviewRef","dartTimerEnabled","dartTimerSeconds","dartTimeLeft","setDartTimeLeft","timerRef","paused","detectorRef","rafRef","detectorSeedVersion","setDetectorSeedVersion","handlePhoneReconnect","onOpen","onDartsCleared","prev","mounted","refresh","list","onClose","leg","shouldRun","addDart","id","c","vw","vh","cw","ch","ctx","scale","dw","dh","stopCamera","canFallbackToLocal","startCamera","constraints","stream","name","playErr","retryErr","enumErr","videoEl","fallbackStream","activeStream","capture","primary","sessionVideo","source","video","canvas","CameraSelector","label","resolve","sourceVideo","canceled","proc","tick","cImg","applyHomography","rImg","BoardRadii","sx","sy","roiR","detector","nowPerf","warmupActive","tipRefined","refinePointSobel","pCal","sector","shouldAccept","applyAutoHit","candidate","existing","current","holdMs","ready","cooled","o","octx","ox","oy","ax","ax1","ay1","ax2","ay2","bx","by","handleUseLocalCamera","fallback","useAudit","sub","onOverlayClick","parseManual","input","bull","outerBull","num","multVal","getCurrentRemaining","newDarts","previousScore","previousDarts","addSample","willCount","applied","appliedValue","newScore","after","isFinish","preOpenTotal","postAfter","postBefore","attemptsThisDart","attemptsTotal","onAddAutoDart","onApplyManual","onReplaceManual","last","prevDarts","prevScore","remaining","onRecalibrateNow","onResetCalibration","onKey","tag","onQuickEntry","val","onUndoDart","onCommitVisit","visitScore","visitDarts","aspect","fit","videoClass","containerClass","renderVideoSurface","entrySeq","isPending","isActive","hasPositiveValue","hasHitRing","color","activeState","stateClass","title","baseClasses","okNow","pulseClass","Fragment","ResizableModal","_","FocusLock","ms","isHit"],"mappings":"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"}