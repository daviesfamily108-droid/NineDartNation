{"version":3,"file":"Scoreboard-CEXbTh_A.js","sources":["../../src/components/Scoreboard.tsx"],"sourcesContent":["import { useMatch } from \"../store/match\";\nimport { formatAvg } from \"../utils/stats\";\n// Icons not used directly in Scoreboard; MatchControls has its own icons\nimport MatchControls from \"./MatchControls\";\nimport { usePendingVisit } from \"../store/pendingVisit\";\nimport type { UnifiedMatchActions } from \"../logic/matchActions\";\nimport ResizableModal from \"./ui/ResizableModal\";\n\nexport default function Scoreboard({\n  matchActions,\n}: { matchActions?: UnifiedMatchActions } = {}) {\n  const {\n    players,\n    currentPlayerIdx,\n    addVisit,\n    undoVisit,\n    endLeg,\n    nextPlayer,\n    endGame,\n    inProgress,\n    startingScore,\n    bestLegThisMatch,\n  } = useMatch();\n  const pendingEntries = usePendingVisit((s) => s.entries);\n\n  // Prefer authoritative per-dart entries from the most recent committed visit\n  // (already stored in match state) when available. Fallback to the pendingVisit\n  // store for the in-progress turn.\n  const getLastCommittedEntriesForPlayer = (playerIdx: number) => {\n    try {\n      const p = players[playerIdx];\n      const leg = p?.legs?.[p.legs.length - 1];\n      const lastVisit = leg?.visits?.[leg.visits.length - 1] as any;\n      const entries = lastVisit?.entries;\n      return Array.isArray(entries) ? (entries as any[]) : null;\n    } catch {\n      return null;\n    }\n  };\n\n  function handleEndGame() {\n    try {\n      const summary = {\n        ts: Date.now(),\n        players: players.map((p) => {\n          const totals = p.legs.reduce(\n            (acc, L) => {\n              acc.points += L.totalScoreStart - L.totalScoreRemaining;\n              const legDarts = (L.visits || []).reduce(\n                (a, v) => a + (v.darts || 0),\n                0,\n              );\n              acc.darts += legDarts;\n              return acc;\n            },\n            { points: 0, darts: 0 },\n          );\n          const dartsThrown = totals.darts;\n          const avg = dartsThrown > 0 ? (totals.points / dartsThrown) * 3 : 0;\n          return {\n            id: p.id,\n            name: p.name,\n            legsWon: p.legsWon,\n            dartsThrown,\n            avg: Math.round(avg * 100) / 100,\n          };\n        }),\n        winner: players.reduce(\n          (best, p) => (p.legsWon > (best?.legsWon || 0) ? p : best),\n          players[0],\n        )?.name,\n      };\n      try {\n        localStorage.setItem(\"ndn_last_match\", JSON.stringify(summary));\n      } catch {}\n    } catch (err) {}\n    // Stats persistence is now handled inside match.endGame (store-level)\n    (matchActions?.endGame ?? endGame)();\n  }\n\n  return (\n    <ResizableModal\n      storageKey=\"ndn:modal:scoreboard\"\n      className=\"ndn-modal w-full h-full relative\"\n      defaultWidth={1100}\n      defaultHeight={720}\n      minWidth={720}\n      minHeight={480}\n      maxWidth={1600}\n      maxHeight={1200}\n      initialFitHeight\n    >\n      <div className=\"flex-1 min-h-0 overflow-y-auto p-3\">\n        <div className=\"ndn-hscroll\">\n          <div className=\"grid grid-cols-1 xl:grid-cols-3 gap-3\">\n            <div className=\"col-span-2 card\">\n              <h2 className=\"text-lg font-semibold mb-3\">Score Input</h2>\n              {inProgress ? (\n                <MatchControls\n                  inProgress={inProgress}\n                  startingScore={startingScore}\n                  pendingEntries={pendingEntries}\n                  onAddVisit={(score, darts) => {\n                    // Compute remaining before we update store, to decide auto-advance\n                    const p = players[currentPlayerIdx];\n                    const leg = p.legs[p.legs.length - 1];\n                    const prevRemaining = leg\n                      ? leg.totalScoreRemaining\n                      : startingScore;\n                    const numericScore = typeof score === \"number\" ? score : 0;\n                    let newRemaining = prevRemaining - numericScore;\n                    if (!Number.isFinite(newRemaining) || newRemaining < 0)\n                      newRemaining = 0;\n                    // Call provided matchActions.addVisit if available, otherwise the store's addVisit\n                    // Call provided matchActions.addVisit if available, otherwise the store's addVisit\n                    if (matchActions?.addVisit) {\n                      matchActions.addVisit(score, darts);\n                    } else {\n                      addVisit(score, darts);\n                    }\n                    if (newRemaining === 0) {\n                      if (matchActions?.endLeg) {\n                        matchActions.endLeg(score);\n                      } else {\n                        endLeg(score);\n                      }\n                    } else {\n                      (matchActions?.nextPlayer ?? nextPlayer)();\n                    }\n                  }}\n                  onUndo={() => (matchActions?.undoVisit ?? undoVisit)()}\n                  onEndLeg={(score) => {\n                    (matchActions?.endLeg ?? endLeg)(score ?? 0);\n                  }}\n                  onNextPlayer={() =>\n                    (matchActions?.nextPlayer ?? nextPlayer)()\n                  }\n                  onEndGame={handleEndGame}\n                  quickButtons={[180, 140, 100, 60]}\n                />\n              ) : (\n                <p className=\"text-slate-600\">No game in progress.</p>\n              )}\n\n              <div className=\"mt-4 grid grid-cols-1 md:grid-cols-2 gap-3\">\n                {players.map((p, idx) => {\n                  const currentLeg = p.legs[p.legs.length - 1];\n                  const remaining = currentLeg\n                    ? currentLeg.totalScoreRemaining\n                    : startingScore;\n                  // TV-style 3-dart avg across the entire match (all legs): sum(points)/sum(darts)*3\n                  const totals = p.legs.reduce(\n                    (acc, L) => {\n                      acc.points += L.totalScoreStart - L.totalScoreRemaining;\n                      const legDarts = (L.visits || []).reduce(\n                        (a, v) => a + (v.darts || 0),\n                        0,\n                      );\n                      acc.darts += legDarts;\n                      return acc;\n                    },\n                    { points: 0, darts: 0 },\n                  );\n                  const dartsThrown = totals.darts;\n                  const avg =\n                    dartsThrown > 0 ? (totals.points / dartsThrown) * 3 : 0;\n\n                  return (\n                    <div\n                      key={p.id}\n                      className={`card glass transition-shadow transition-all duration-150 ease-out ${idx === currentPlayerIdx ? \"ring-2 ring-brand-400\" : \"\"}`}\n                    >\n                      <div className=\"flex items-center justify-between\">\n                        <h3 className=\"text-base font-semibold\">{p.name}</h3>\n                        <span className=\"badge w-32 justify-center\">\n                          Legs Won: {p.legsWon}\n                        </span>\n                      </div>\n                      <div className=\"mt-2 grid grid-cols-3 gap-2 text-center\">\n                        <div className=\"p-2 rounded-xl bg-white/10 border border-white/10 metric-tile\">\n                          <div className=\"text-xs text-slate-500\">\n                            Remaining\n                          </div>\n                          <div\n                            className={`flex items-center justify-center gap-2 mt-1 h-3 w-full`}\n                            aria-hidden\n                          >\n                            {[0, 1, 2].map((i) => {\n                              // Only active/current player's pendingEntries matter; other players get translucent placeholders\n                              const committed =\n                                getLastCommittedEntriesForPlayer(idx);\n                              const e =\n                                idx === currentPlayerIdx\n                                  ? ((pendingEntries[i] as any) ?? null)\n                                  : ((committed?.[i] as any) ?? null);\n                              // IMPORTANT:\n                              // A MISS is a real dart and should still render as a recorded entry.\n                              // Previously, we treated value===0 as \"not a hit\" and rendered it as pending,\n                              // which made it look like dart 3 never arrived (\"zero mapping\").\n                              const isPending = e == null;\n                              const isHit =\n                                e != null &&\n                                (typeof e.ring === \"string\"\n                                  ? e.ring !== \"MISS\"\n                                  : typeof e.value === \"number\"\n                                    ? e.value > 0\n                                    : true);\n                              const color = isPending\n                                ? \"bg-gray-400/60\"\n                                : isHit\n                                  ? \"bg-emerald-400\"\n                                  : \"bg-rose-500\";\n                              const active =\n                                idx === currentPlayerIdx && !isPending;\n                              const classes = `visit-dot ${active ? \"active\" : \"inactive\"} ${color}`;\n                              return <span key={i} className={classes} />;\n                            })}\n                          </div>\n                          <div className=\"text-2xl font-bold\">{remaining}</div>\n                          <div className=\"h-1 w-full bg-white/10 rounded-full mt-2 overflow-hidden\">\n                            <div\n                              className=\"h-full bg-emerald-400/70 transition-all duration-200 ease-out\"\n                              style={{\n                                width: `${Math.max(0, Math.min(100, (1 - remaining / startingScore) * 100))}%`,\n                              }}\n                            />\n                          </div>\n                        </div>\n                        <div className=\"p-2 rounded-xl bg-white/10 border border-white/10 metric-tile\">\n                          <div className=\"text-xs text-slate-500\">Darts</div>\n                          <div className=\"text-xl font-bold\">{dartsThrown}</div>\n                        </div>\n                        <div className=\"p-3 rounded-xl bg-white/10 border border-white/10 metric-tile flex flex-col justify-center\">\n                          <div className=\"text-xs text-slate-500\">\n                            3-Dart Avg (Live)\n                          </div>\n                          <div className=\"text-xl font-bold\">\n                            {formatAvg(p.currentThreeDartAvg ?? 0)}\n                          </div>\n                        </div>\n                        <div className=\"p-3 rounded-xl bg-white/10 border border-white/10 metric-tile flex flex-col justify-center\">\n                          <div className=\"text-xs text-slate-500\">\n                            3-Dart Avg (Match)\n                          </div>\n                          <div className=\"text-xl font-bold\">\n                            {formatAvg(avg)}\n                          </div>\n                        </div>\n                      </div>\n                    </div>\n                  );\n                })}\n              </div>\n\n              {bestLegThisMatch && (\n                <div className=\"mt-4 p-3 rounded-xl bg-emerald-50 border border-emerald-200\">\n                  <strong>Best Leg (this match):</strong> Player{\" \"}\n                  {\n                    players.find((p) => p.id === bestLegThisMatch.playerId)\n                      ?.name\n                  }{\" \"}\n                  in {bestLegThisMatch.darts} darts\n                </div>\n              )}\n            </div>\n          </div>\n        </div>\n      </div>\n    </ResizableModal>\n  );\n}\n"],"names":["Scoreboard","matchActions","players","currentPlayerIdx","addVisit","undoVisit","endLeg","nextPlayer","endGame","inProgress","startingScore","bestLegThisMatch","useMatch","pendingEntries","usePendingVisit","s","getLastCommittedEntriesForPlayer","playerIdx","p","leg","entries","handleEndGame","summary","totals","acc","L","legDarts","a","v","dartsThrown","avg","best","jsx","ResizableModal","jsxs","MatchControls","score","darts","newRemaining","idx","currentLeg","remaining","i","committed","e","isPending","isHit","classes","formatAvg"],"mappings":"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"}