import{A as sn,C as nn,j as t,x as ks,u as Ye,f as Ns,b as rn,D as ft,R as an,F as Cs,E as ye,H as js,B as ln,I as cn}from"./index-Dj7mIiiu.js";import{r}from"./ui-Vpbk6UnN.js";import{u as Xt,a as on}from"./match-BLqxJLcc.js";import{u as Ss}from"./pendingVisit-BrAUqCO5.js";function Es(u,a){const i=sn(u,a);return nn(i)}class un{width=0;height=0;bg=null;lastAcceptTs=0;cooldownMs=600;roiRadius=0;roiCx=0;roiCy=0;initialized=!1;thresh=28;minArea=90;maxArea=6e3;prevTip=null;prevArea=0;stableCount=0;requireStableN=3;constructor(){}setROI(a,i,x){this.roiCx=a,this.roiCy=i,this.roiRadius=Math.max(0,x|0)}reset(a,i){this.width=a,this.height=i,this.bg=new Float32Array(a*i),this.initialized=!1}updateBackground(a,i=.05){const{width:x,height:c,data:g}=a;(!this.bg||x!==this.width||c!==this.height)&&this.reset(x,c);const L=this.bg,U=x*c;for(let w=0,v=0;w<U;w++,v+=4){const S=g[v],m=g[v+1],M=g[v+2],I=.299*S+.587*m+.114*M;this.initialized?L[w]=(1-i)*L[w]+i*I:L[w]=I}this.initialized=!0}inRoi(a,i){if(this.roiRadius<=0)return!0;const x=a-this.roiCx,c=i-this.roiCy;return x*x+c*c<=this.roiRadius*this.roiRadius}detect(a){const x=Date.now()-this.lastAcceptTs<this.cooldownMs,{width:c,height:g,data:L}=a;(!this.bg||c!==this.width||g!==this.height)&&this.reset(c,g);const U=this.bg;if(!this.initialized)return this.updateBackground(a,1),null;const w=c*g,v=new Uint8Array(w),S=new Float32Array(w);let m=0,M=0,I=0;const Q=new Uint8Array(w);for(let b=0,E=0;b<w;b++,E+=4){const R=L[E],O=L[E+1],le=L[E+2],J=Math.max(R,O,le),Ve=Math.min(R,O,le),Y=.299*R+.587*O+.114*le,G=Math.abs(Y-U[b]);S[b]=G;const Ze=Math.floor(b/c),Ut=b-Ze*c,Ot=J===0?0:(J-Ve)/J,H=J>=250&&Ot<=.12;H&&(Q[b]=1),this.inRoi(Ut,Ze)&&!H&&(m+=G,M+=G*G,I++)}const V=I?m/I:0,oe=I?Math.max(0,M/I-V*V):0,Oe=Math.sqrt(oe),it=Math.max(this.thresh,V+1.2*Oe);for(let b=0;b<w;b++){if(Q[b]){v[b]=0;continue}if(S[b]>it){const E=Math.floor(b/c),R=b-E*c;v[b]=this.inRoi(R,E)?1:0}}this._dilate(v,c,g),this._erode(v,c,g);const C=new Uint8Array(w);let y=0,te=null;for(let b=0;b<w;b++){if(v[b]===0||C[b])continue;const E=[];let R=0,O=0;const le=[b];for(C[b]=1;O<le.length;){const J=le[O++];E.push(J),R++;const Ve=J/c|0,Y=[J-1,J+1,J-c,J+c];for(const G of Y)G<0||G>=w||C[G]||(G===J-1||G===J+1)&&(G/c|0)!==Ve||v[G]&&(C[G]=1,le.push(G))}R>y&&(y=R,te=E)}if(!te||y<this.minArea||y>this.maxArea)return x||this.updateBackground(a,.02),null;let ae=c,ie=g,Ne=0,B=0,W=0,he=0;for(const b of te){const E=b/c|0,R=b-E*c;W+=R,he+=E,R<ae&&(ae=R),R>Ne&&(Ne=R),E<ie&&(ie=E),E>B&&(B=E)}W/=y,he/=y;let Le=0,ue=0,de=0;for(const b of te){const E=b/c|0,O=b-E*c-W,le=E-he;Le+=O*O,ue+=le*le,de+=O*le}Le/=y,ue/=y,de/=y;const Be=Le+ue,A=Le*ue-de*de,xe=Math.sqrt(Math.max(0,Be*Be/4-A)),Ge=Be/2+xe;let me=de,P=Ge-Le;Math.hypot(me,P)<1e-6&&(me=Ge-ue,P=de);const Ce=Math.hypot(me,P)||1;me/=Ce,P/=Ce;const Pe=W-this.roiCx,_e=he-this.roiCy,At=Pe*me+_e*P>0?1:-1;me*=At,P*=At;const ht=Math.hypot(Pe,_e)||1,be=Pe/ht,ge=_e/ht,Tt=Math.max(-1,Math.min(1,me*be+P*ge));if(Math.acos(Tt)*180/Math.PI>55)return x||this.updateBackground(a,.02),null;let z=-1/0,Xe=W,$e=he;for(const b of te){const E=b/c|0,R=b-E*c,O=(R-W)*me+(E-he)*P;O>z&&(z=O,Xe=R,$e=E)}const pe=Xe-this.roiCx,se=$e-this.roiCy,xt=pe*pe+se*se,ne=Math.max(1,Ne-ae+1),lt=Math.max(1,B-ie+1),p=ne*lt,F=y/p,je=Math.sqrt(xt)/Math.max(1,this.roiRadius);let T=.5;F<.45&&(T+=.2),F<.25&&(T+=.15),je<1.1&&(T+=.1);const j=Be-Ge;return(Ge>0?1-j/Ge:0)>.3&&(T+=.1),T=Math.max(0,Math.min(1,T)),!this._isStable({x:Xe+.5,y:$e+.5},y)||x?null:{tip:{x:Xe+.5,y:$e+.5},axis:{x1:W-me*20,y1:he-P*20,x2:W+me*20,y2:he+P*20},area:y,bbox:{x:ae,y:ie,w:ne,h:lt},confidence:T}}accept(a,i){if(this.lastAcceptTs=Date.now(),this.prevTip=null,this.prevArea=0,this.stableCount=0,!this.bg)return;const{width:x}=a,c=this.bg,{x:g,y:L,w:U,h:w}=i.bbox,v=.5;for(let S=L;S<L+w;S++)for(let m=g;m<g+U;m++){const M=S*x+m,I=M*4,Q=a.data[I],V=a.data[I+1],oe=a.data[I+2],Oe=.299*Q+.587*V+.114*oe;c[M]=(1-v)*c[M]+v*Oe}}_isStable(a,i){const x=(c,g)=>Math.hypot(c.x-g.x,c.y-g.y)<=6;if(!this.prevTip)return this.prevTip={...a},this.prevArea=i,this.stableCount=1,!1;if(x(this.prevTip,a)&&Math.abs(i-this.prevArea)/Math.max(1,i)<.3)this.prevTip={...a},this.prevArea=i,this.stableCount++;else return this.prevTip={...a},this.prevArea=i,this.stableCount=1,!1;return this.stableCount>=this.requireStableN}_dilate(a,i,x){const c=new Uint8Array(a.length);for(let g=0;g<x;g++)for(let L=0;L<i;L++){let U=0;for(let w=-1;w<=1;w++){for(let v=-1;v<=1;v++){const S=g+w,m=L+v;if(!(S<0||S>=x||m<0||m>=i)&&a[S*i+m]){U=1;break}}if(U)break}c[g*i+L]=U}a.set(c)}_erode(a,i,x){const c=new Uint8Array(a.length);for(let g=0;g<x;g++)for(let L=0;L<i;L++){let U=1;for(let w=-1;w<=1;w++){for(let v=-1;v<=1;v++){const S=g+w,m=L+v;if(!(S<0||S>=x||m<0||m>=i)&&!a[S*i+m]){U=0;break}}if(!U)break}c[g*i+L]=U}a.set(c)}}function dn(u){try{if(!u||typeof u!="object")return null;if((u.type==="dart"||u.kind==="dart"||u.event==="dart")&&typeof u.value=="number"){const a=Ls(u.ring);return Ms(u.value,a)}if(typeof u.value=="number"&&u.ring){const a=Ls(u.ring);return Ms(u.value,a)}if(typeof u.score=="string"){const a=u.score.trim().toUpperCase();if(a==="50"||a==="DBULL"||a==="INNER_BULL")return{value:50,ring:"INNER_BULL",sector:null,mult:0};if(a==="25"||a==="BULL"||a==="OBULL")return{value:25,ring:"BULL",sector:null,mult:0};const i=a.match(/^(S|D|T)(\d{1,2})$/);if(i){const x=i[1]==="S"?1:i[1]==="D"?2:3,c=parseInt(i[2],10);if(c>=1&&c<=20)return{value:c*x,ring:x===1?"SINGLE":x===2?"DOUBLE":"TRIPLE",sector:c,mult:x}}}if(typeof u.sector=="number"&&typeof u.mult=="number"){const a=Math.max(1,Math.min(20,Math.floor(u.sector))),i=u.mult===1?1:u.mult===2?2:3;return{value:a*i,ring:i===1?"SINGLE":i===2?"DOUBLE":"TRIPLE",sector:a,mult:i}}if(u.bull){const a=String(u.bull).toLowerCase()==="inner"||u.bull===!0;return{value:a?50:25,ring:a?"INNER_BULL":"BULL",sector:null,mult:0}}}catch{}return null}function Ls(u){const a=String(u||"").toUpperCase();return a.startsWith("TR")?"TRIPLE":a.startsWith("DO")?"DOUBLE":a.startsWith("SI")?"SINGLE":a==="INNER_BULL"||a==="DBULL"||a==="50"||a==="IBULL"?"INNER_BULL":a==="BULL"||a==="25"||a==="OBULL"||a==="OUTER_BULL"?"BULL":a==="MISS"||a==="0"?"MISS":"SINGLE"}function Ms(u,a){const i=Math.max(0,Math.min(60,Math.round(Number(u)||0)));return a==="INNER_BULL"?{value:50,ring:a}:a==="BULL"?{value:25,ring:a}:{value:i,ring:a}}function mn(u,a){let i=null,x=!0,c=null,g=0;const L=400,U=[],w=new Set;function v(m,M){const I=typeof m?.id=="string"||typeof m?.id=="number"?String(m.id):null;if(I){if(w.has(I))return;if(w.add(I),U.push(I),U.length>200){const oe=U.shift();oe&&w.delete(oe)}}const Q=`${M.value}|${M.ring}|${M.sector??""}|${M.mult??""}`,V=Date.now();Q===c&&V-g<L||(c=Q,g=V,a(M))}function S(){if(x)try{i=new WebSocket(u),i.onmessage=m=>{try{const M=JSON.parse(m.data),I=dn(M);I&&v(M,I)}catch{}},i.onclose=()=>{i=null,setTimeout(S,1500)},i.onerror=()=>{}}catch{setTimeout(S,2e3)}}return S(),{close:()=>{x=!1;try{i?.close()}catch{}}}}function Rs({storageKey:u,children:a,className:i,defaultWidth:x=640,defaultHeight:c=360,minWidth:g=320,minHeight:L=200,maxWidth:U=1600,maxHeight:w=1200,autoFill:v=!1}){const[S,m]=r.useState(()=>{try{const C=localStorage.getItem(u);if(C)return JSON.parse(C)}catch{}return v?{width:x}:{width:x,height:c}}),M=r.useRef(null),I=r.useRef(null);r.useEffect(()=>{function C(){try{localStorage.removeItem(u)}catch{}m({width:x,height:c})}return window.addEventListener("ndn:layout-reset",C),window.addEventListener("ndn:camera-reset",C),()=>{window.removeEventListener("ndn:layout-reset",C),window.removeEventListener("ndn:camera-reset",C)}},[u,x,c]),r.useEffect(()=>{try{localStorage.setItem(u,JSON.stringify(S))}catch{}},[S,u]);function Q(C,y,te){return Math.max(y,Math.min(te,C))}function V(C,y){C.preventDefault();const te=I.current;if(!te)return;const ae=te.getBoundingClientRect();M.current={x:C.clientX,y:C.clientY,w:ae.width,h:ae.height,dir:y},window.addEventListener("mousemove",oe),window.addEventListener("mouseup",Oe)}function oe(C){const y=M.current;if(!y)return;const te=C.clientX-y.x,ae=C.clientY-y.y;let ie=y.w,Ne=y.h;y.dir.includes("e")&&(ie=Q(y.w+te,g,U)),!v&&y.dir.includes("s")&&(Ne=Q(y.h+ae,L,w)),y.dir.includes("w")&&(ie=Q(y.w-te,g,U)),!v&&y.dir.includes("n")&&(Ne=Q(y.h-ae,L,w)),m({width:Math.round(ie),height:Math.round(Ne)})}function Oe(){window.removeEventListener("mousemove",oe),window.removeEventListener("mouseup",Oe),M.current=null}const it={width:v?"100%":S.width?`${S.width}px`:void 0,height:v?"100%":S.height?`${S.height}px`:void 0,maxWidth:"100%",maxHeight:v?"100%":"80vh",position:"relative",...v?{display:"flex",flexDirection:"column",flex:"1 1 auto"}:{}};return t.jsxs("div",{ref:I,className:`${i||""}`,style:it,children:[a,t.jsx("div",{className:"resizer resizer-nw",onMouseDown:C=>V(C,"nw")}),t.jsx("div",{className:"resizer resizer-ne",onMouseDown:C=>V(C,"ne")}),t.jsx("div",{className:"resizer resizer-sw",onMouseDown:C=>V(C,"sw")}),t.jsx("div",{className:"resizer resizer-se",onMouseDown:C=>V(C,"se")})]})}const fn=ks((u,a)=>({samples:[],addSample:i=>u(x=>({samples:[...x.samples,i]})),clear:()=>u({samples:[]}),export:()=>a().samples.slice()})),hn=ks(u=>({paused:!1,pauseEndsAt:null,setPaused:(a,i=null)=>u({paused:a,pauseEndsAt:i??null})})),xn=1,bn=120,gn=400,pn=450,vn=5e3,wn=.85,yn=6500;function Nn({onVisitCommitted:u,showToolbar:a=!0,onAutoDart:i,immediateAutoCommit:x=!1,hideInlinePanels:c=!1,scoringMode:g="x01",onGenericDart:L,onGenericReplace:U,x01DoubleInOverride:w,onAddVisit:v,onEndLeg:S}){const m=r.useRef(null),{preferredCameraId:M,preferredCameraLabel:I,setPreferredCamera:Q,autoscoreProvider:V,autoscoreWsUrl:oe,cameraAspect:Oe,cameraFitMode:it,autoCommitMode:C="wait-for-clear",cameraEnabled:y,setCameraEnabled:te,preferredCameraLocked:ae,hideCameraOverlay:ie,setHideCameraOverlay:Ne}=Ye(),B=V==="manual",[W,he]=r.useState([]),Le=r.useRef(null),ue=r.useRef(null),[de,Be]=r.useState(!1),A=Ns(),xe=I==="Phone Camera",Ge=A.getMediaStream?.()||null,me=A.isStreaming,P=xe&&A.mode==="phone"&&me&&!!Ge,Ce=de||me,[Pe,_e]=r.useState(!1),[At,ht]=r.useState(null),{H:be,imageSize:ge,reset:Tt,_hydrated:Ds}=rn();r.useEffect(()=>{ae&&!ie&&Ne(!0)},[ae,ie,Ne]);const[z,Xe]=r.useState(""),[$e,pe]=r.useState(""),[se,xt]=r.useState(0),[ne,lt]=r.useState("MISS"),[p,F]=r.useState(0),[je,T]=r.useState(0),[j,q]=r.useState([]),[ct,b]=r.useState(0),[E,R]=r.useState(0),[O,le]=r.useState(!1),J=r.useRef(null),Ve=r.useRef(null),Y=!x&&C!=="immediate",[G,Ze]=r.useState(0),[Ut,Ot]=r.useState([]),H=r.useRef(null),Kt=r.useRef([]),Qt=r.useRef(0),et=r.useRef(0),Ke=r.useRef(!1),ze=r.useRef(null),ot=r.useRef(0),[Bt,Is]=r.useState([]),[Jt,As]=r.useState(!1),bt=r.useCallback(()=>{Ve.current&&(clearTimeout(Ve.current),Ve.current=null)},[]),Zt=r.useCallback(e=>{const s=[...Kt.current.slice(-8),e];Kt.current=s,Is(s);try{window.ndnCameraDiagnostics=s}catch{}},[]),Fe=r.useCallback(e=>{const s=J.current;if(s&&(J.current=null,bt(),le(!1),u))try{u(s.score,s.darts,s.finished)}catch{}},[u,bt]),He=r.useCallback(e=>{if(u){if(!Y){try{u(e.score,e.darts,e.finished)}catch{}return}J.current=e,le(!0),bt(),Ve.current=window.setTimeout(()=>Fe("timeout"),yn)}},[u,Y,bt,Fe]),gt=r.useCallback(e=>{F(0),T(0),q([]),b(0),R(0),X(!1);try{window.dispatchEvent(new CustomEvent("ndn:clear-visit-request",{detail:{source:"camera-view",reason:e,ts:Date.now()}}))}catch{}},[]);r.useEffect(()=>{if(!Y)return;const e=()=>Fe("event");return window.addEventListener("ndn:darts-cleared",e),()=>window.removeEventListener("ndn:darts-cleared",e)},[Y,Fe]),r.useEffect(()=>{Y||Fe("timeout")},[Y,Fe]),r.useEffect(()=>()=>Fe("teardown"),[Fe]);const Ts=r.useCallback(()=>{gt("indicator"),Ze(e=>e+1)},[gt]),Us=r.useCallback(()=>{p===0&&je===0||(gt("toolbar"),Ze(e=>e+1))},[gt,p,je]),Os=r.useCallback(()=>{if(!B)try{window.dispatchEvent(new CustomEvent("ndn:open-camera-manager",{detail:{source:"camera-view",ts:Date.now()}}))}catch(e){console.warn("[CameraView] Failed to request camera manager:",e)}},[B]),Bs=Ye(e=>e.x01DoubleIn),tt=typeof w=="boolean"?!!w:!!Bs,[Ps,es]=r.useState({}),k=Xt(e=>e),pt=k.players[k.currentPlayerIdx]?.id,st=!!(pt&&Ps[pt]),ts=e=>{pt&&es(s=>({...s,[pt]:e}))},Pt=k?.inProgress,ss=Ss(e=>e.setVisit),ns=Ss(e=>e.reset);r.useEffect(()=>{try{ss(j,p,je)}catch{}},[j,p,je,ss]),r.useEffect(()=>()=>{try{ns()}catch{}},[ns]);const _s=Xt(e=>e.addVisit),$s=Xt(e=>e.endLeg),We=(e,s,n)=>{try{v?v(e,s,n):_s(e,s,n)}catch{}},rs=e=>{try{S?S(e):$s(typeof e=="number"?e:0)}catch{}},_t=fn(e=>e.addSample),[vt,Vs]=r.useState(""),[wt,zs]=r.useState(""),[Me,_]=r.useState(0),[Fs,ve]=r.useState(!1),[Se,X]=r.useState(!1),[as,yt]=r.useState(!1),Re=r.useRef(null),[is,Ae]=r.useState("auto"),[$t,Te]=r.useState(!1),[Hs,Nt]=r.useState(!1),[Ws,ls]=r.useState(!1),cs=r.useRef(null),ut=Ye(e=>e.dartTimerEnabled),Vt=Ye(e=>e.dartTimerSeconds)||10,[nt,zt]=r.useState(null),ke=r.useRef(null),Ct=hn(e=>e.paused),dt=r.useRef(null),Qe=r.useRef(null),[os,us]=r.useState(0),jt=r.useCallback(()=>{try{window.dispatchEvent(new CustomEvent("ndn:phone-camera-reconnect",{detail:{source:"camera-view",ts:Date.now()}}))}catch(e){console.warn("[CameraView] Phone camera reconnect dispatch failed:",e)}},[]);r.useEffect(()=>{const e=()=>{B||Nt(!0)};return window.addEventListener("ndn:open-autoscore",e),()=>window.removeEventListener("ndn:open-autoscore",e)},[B]),r.useEffect(()=>()=>{try{Re.current&&clearTimeout(Re.current)}catch{}},[]),r.useEffect(()=>{const e=()=>ls(!0);return window.addEventListener("ndn:open-scoring",e),()=>window.removeEventListener("ndn:open-scoring",e)},[]),r.useEffect(()=>{const e=()=>{Ze(s=>s+1),F(0),T(0),q([]),b(0),R(0),X(!1)};return window.addEventListener("ndn:darts-cleared",e),()=>window.removeEventListener("ndn:darts-cleared",e)},[]),r.useEffect(()=>{Ot(e=>{if(j.length>e.length){const s=j.length-e.length;return[...e,...Array(s).fill(G)]}return j.length<e.length?e.slice(0,j.length):e})},[j,G]),r.useEffect(()=>{if(ze.current&&(clearTimeout(ze.current),ze.current=null),B){Ke.current=!1,et.current=0,H.current=null;return}return Ce?(et.current=performance.now(),H.current=null,Ke.current=!1,ot.current=0,ze.current=window.setTimeout(()=>{Ke.current=!0,ze.current=null},vn)):(et.current=0,H.current=null,Ke.current=!1,ot.current=0),()=>{ze.current&&(clearTimeout(ze.current),ze.current=null),Ke.current=!1,ot.current=0}},[Ce,B]),r.useEffect(()=>{let e=!0;async function s(){try{if(!navigator?.mediaDevices?.enumerateDevices)return;const n=await navigator.mediaDevices.enumerateDevices();if(!e)return;he(n.filter(l=>l.kind==="videoinput"))}catch(n){console.warn("[CAMERA] enumerateDevices failed:",n)}}s();try{navigator.mediaDevices.addEventListener("devicechange",s)}catch{try{navigator.mediaDevices.ondevicechange=s}catch{}}return()=>{e=!1;try{navigator.mediaDevices.removeEventListener("devicechange",s)}catch{}}},[]),r.useEffect(()=>{const e=()=>{Ae("manual"),Te(!0)},s=()=>{Ae("auto"),Te(!1)};return window.addEventListener("ndn:open-manual",e),window.addEventListener("ndn:close-manual",s),()=>{window.removeEventListener("ndn:open-manual",e),window.removeEventListener("ndn:close-manual",s)}},[]),r.useEffect(()=>{B&&(Ae("manual"),Nt(!1))},[B]),r.useEffect(()=>{try{const e=k.players[k.currentPlayerIdx],s=e?.legs?.[e.legs.length-1];if(!e)return;(!s||s.dartsThrown===0)&&es(n=>({...n,[e.id]:!1}))}catch{}},[k.currentPlayerIdx,k.players?.[k.currentPlayerIdx]?.legs?.length]),r.useEffect(()=>{const e=!!ut&&Pt&&!Ct&&p<3;if(ke.current&&(clearInterval(ke.current),ke.current=null),!e){zt(null);return}return zt(Vt),ke.current=window.setInterval(()=>{zt(s=>{const n=(s??Vt)-1;if(n<=0){try{De(0,"MISS 0","MISS")}catch{}return ke.current&&(clearInterval(ke.current),ke.current=null),0}return n})},1e3),()=>{ke.current&&(clearInterval(ke.current),ke.current=null)}},[ut,Vt,p,k.currentPlayerIdx,k?.inProgress,Ct]),r.useEffect(()=>{if(!$t)return;const e=setInterval(()=>{try{const s=m.current,n=cs.current;if(!s||!n)return;const l=s.videoWidth||0,h=s.videoHeight||0;if(!l||!h)return;const d=n.clientWidth||640,o=n.clientHeight||360;n.width!==d&&(n.width=d),n.height!==o&&(n.height=o);const f=n.getContext("2d");if(!f)return;f.imageSmoothingEnabled=!0;const N=Math.min(d/l,o/h),ce=Math.round(l*N),D=Math.round(h*N),$=Math.floor((d-ce)/2),K=Math.floor((o-D)/2);f.fillStyle="#000",f.fillRect(0,0,d,o),f.drawImage(s,$,K,ce,D)}catch(s){console.warn("Manual preview update error:",s)}},120);return()=>clearInterval(e)},[$t]),r.useEffect(()=>()=>St(),[]);const ds=xe&&!P;async function mt(){if(!(Pe||de)){if(xe&&P){_e(!1);return}_e(!0);try{const e=M?{video:{deviceId:{exact:M}},audio:!1}:{video:{facingMode:"environment"},audio:!1};ye("[CAMERA] Using constraints:",e);let s;try{s=await navigator.mediaDevices.getUserMedia(e),ye("[CAMERA] Got stream:",!!s)}catch(n){console.warn("[CAMERA] First attempt failed:",n);const l=n&&(n.name||n.code)||"";if(M&&(l==="OverconstrainedError"||l==="NotFoundError"))ye("[CAMERA] Trying fallback without deviceId"),s=await navigator.mediaDevices.getUserMedia({video:!0,audio:!1});else if(!M&&(l==="OverconstrainedError"||l==="NotFoundError"||l==="NotSupportedError"))ye("[CAMERA] Trying fallback for facingMode not supported"),s=await navigator.mediaDevices.getUserMedia({video:!0,audio:!1});else throw n}if(m.current){ye("[CAMERA] Setting stream to video element"),m.current.srcObject=s,ye("[CAMERA] Stream tracks:",s.getTracks().length,"video tracks:",s.getVideoTracks().length),m.current.addEventListener("loadeddata",()=>ye("[CAMERA] Video loadeddata")),m.current.addEventListener("canplay",()=>ye("[CAMERA] Video canplay")),m.current.addEventListener("play",()=>ye("[CAMERA] Video started playing")),m.current.addEventListener("error",n=>console.error("[CAMERA] Video error:",n));try{m.current.play(),ye("[CAMERA] Play called successfully")}catch(n){console.error("[CAMERA] Video play failed:",n),setTimeout(()=>{try{m.current?.play(),ye("[CAMERA] Retry play called")}catch(l){console.error("[CAMERA] Retry play failed:",l)}},100)}try{A.setVideoElementRef?.(m.current),A.setMediaStream?.(s),A.setMode?.("local"),A.setStreaming?.(!0)}catch(n){console.warn("[CAMERA] Failed to sync camera session with local stream:",n)}}else console.error("[CAMERA] Video element not found");Be(!0);try{const n=await navigator.mediaDevices.enumerateDevices();he(n.filter(l=>l.kind==="videoinput")),ye("[CAMERA] Found cameras:",n.filter(l=>l.kind==="videoinput").length)}catch(n){console.warn("[CAMERA] Failed to enumerate devices:",n)}}catch(e){console.error("[CAMERA] Camera start failed:",e),alert("Camera permission denied or not available.")}finally{_e(!1)}}}function St(){m.current&&m.current.srcObject&&(m.current.srcObject.getTracks().forEach(s=>s.stop()),m.current.srcObject=null,Be(!1),_e(!1))}r.useEffect(()=>{const e=m.current;if(!e)return;const s=A.getMediaStream?.()||null,l=(A.getVideoElementRef?.()||null)?.srcObject||null,h=s||l;if(h){e.srcObject!==h&&(e.srcObject=h),e.muted=!0,e.playsInline=!0;try{e.play?.()}catch{}de||Be(!0)}},[A.mode,A.isStreaming,de,A]);function ms(){try{if(!Le.current)return;const e=m.current,s=A.getVideoElementRef?.()||null,n=e&&e.videoWidth>0&&e.videoHeight>0?e:s||e;if(!n)return;const l=n,h=Le.current;h.width=l.videoWidth,h.height=l.videoHeight;const d=h.getContext("2d");if(!d)return;d.drawImage(l,0,0,h.width,h.height);const o=h.toDataURL("image/png");ht(o)}catch(e){console.warn("Capture error:",e)}}function fs(){return W.length?t.jsxs("div",{className:"absolute top-2 right-2 z-20 flex items-center gap-2 bg-black/40 rounded px-2 py-1 text-xs",children:[t.jsx("span",{children:"Cam:"}),t.jsxs("select",{className:"bg-black/20 rounded px-1 py-0.5",value:M||"",onChange:async e=>{if(Pe)return;const s=e.target.value||void 0,n=W.find(l=>l.deviceId===s)?.label;Q(s,n||"",!0),St(),await new Promise(l=>setTimeout(l,150));try{await mt()}catch(l){console.warn("Failed to start camera after device switch:",l),setTimeout(async()=>{try{await mt()}catch(h){console.error("Camera switch failed after retry:",h),alert("Failed to switch camera. Please try again or refresh the page.")}},500)}},children:[t.jsx("option",{value:"",children:"Auto"}),W.map(e=>t.jsx("option",{value:e.deviceId,children:e.label||(e.deviceId?`Camera (${e.deviceId.slice(0,6)})`:"Camera")},e.deviceId))]}),t.jsx("button",{className:"btn btn--ghost btn-sm ml-2",onClick:async()=>{try{const e=await navigator.mediaDevices.enumerateDevices();he(e.filter(s=>s.kind==="videoinput"))}catch(e){console.warn("Rescan failed:",e),alert("Failed to rescan devices. Ensure camera permissions are granted.")}},title:"Rescan connected cameras",children:"Rescan"})]}):null}r.useEffect(()=>{},[be,ge,Ce,B,xe,ae,ie]),r.useEffect(()=>{if(B||V!=="built-in")return;const e=Ns.getState(),n=Ye.getState().preferredCameraLabel==="Phone Camera"?e.getVideoElementRef?.()||null:m.current;if(!n||!be||!ge)return;let l=!1;const h=n,d=Le.current;if(!d)return;dt.current||(dt.current=new un);const o=()=>{if(!l){try{const f=h.videoWidth||0,N=h.videoHeight||0;if(!f||!N){Qe.current=requestAnimationFrame(o);return}d.width!==f&&(d.width=f),d.height!==N&&(d.height=N);const ce=d.getContext("2d",{willReadFrequently:!0});if(!ce){Qe.current=requestAnimationFrame(o);return}ce.drawImage(h,0,0,f,N);const D=ce.getImageData(0,0,f,N);ot.current++;const $=js(be,{x:0,y:0}),K=js(be,{x:ln.doubleOuter,y:0}),Ee=f/ge.w,fe=N/ge.h,Je=$.x*Ee,Rt=$.y*fe,Ks=K.x*Ee,Qs=K.y*fe,Js=Math.hypot(Ks-Je,Qs-Rt)*1.08,Ft=dt.current;if(os>=0&&Ft.setROI(Je,Rt,Math.max(24,Math.min(Math.max(f,N),Js))),!Ct&&p<3&&Ke.current&&ot.current>150){const we=Ft.detect(D),qe=performance.now();if(H.current&&qe-H.current.firstTs>900&&(H.current=null),we&&we.confidence>=wn){const vs=et.current>0&&qe-et.current<pn,kt=cn(d,we.tip,6),Zs={x:kt.x/Ee,y:kt.y/fe},Dt=Es(be,Zs),Ue=Dt.ring,Ie=Dt.base,It=`${Ue} ${Ie>0?Ie:""}`.trim(),ws=Dt.sector??null,ys=Math.max(0,Number(Dt.mult)||0);let rt=!1;Xe(It),xt(Ie),lt(Ue);const en=re=>{if(re.value>0){X(!0),yt(!0);try{Re.current&&clearTimeout(Re.current)}catch{}Re.current=window.setTimeout(()=>{yt(!1),Re.current=null},1500);try{De(re.value,re.label,re.ring)}catch{}}else X(!1);try{i&&i(re.value,re.ring,{sector:re.sector,mult:re.mult})}catch{}};if(vs)H.current=null,rt=!0;else if(Ue==="MISS"||Ie<=0){H.current=null,X(!1);try{i&&i(Ie,Ue,{sector:ws,mult:ys})}catch{}rt=!0}else{const re=H.current;!re||re.value!==Ie||re.ring!==Ue?H.current={value:Ie,ring:Ue,label:It,sector:ws,mult:ys,firstTs:qe,frames:1}:H.current={...re,label:It,frames:re.frames+1};const Z=H.current,ee=qe-Z.firstTs,Ht=Z.frames>=xn||ee>=bn,Wt=qe-Qt.current>=gn;Ht&&Wt&&(en(Z),H.current=null,Qt.current=qe,rt=!0)}Zt({ts:qe,label:It,value:Ie,ring:Ue,confidence:we.confidence,ready:rt,accepted:rt&&Ie>0&&Ue!=="MISS",warmup:vs});try{if(Ie>0&&Ue!=="MISS"){const Z=ue.current;if(Z){const ee=Z.getContext("2d");if(ee){const Ht=kt.x/f*Z.width,Wt=kt.y/N*Z.height;if(ee.save(),ee.beginPath(),ee.strokeStyle="#f59e0b",ee.lineWidth=2,ee.arc(Ht,Wt,6,0,Math.PI*2),ee.stroke(),we.axis){const at=we.axis,qt=at.x1/f*Z.width,Yt=at.y1/N*Z.height,Gt=at.x2/f*Z.width,tn=at.y2/N*Z.height;ee.beginPath(),ee.moveTo(qt,Yt),ee.lineTo(Gt,tn),ee.stroke()}if(we.bbox){const at=we.bbox.x/f*Z.width,qt=we.bbox.y/N*Z.height,Yt=we.bbox.w/f*Z.width,Gt=we.bbox.h/N*Z.height;ee.strokeStyle="#22d3ee",ee.strokeRect(at,qt,Yt,Gt)}ee.restore()}}}}catch{}rt&&Ft.accept(D,we)}else H.current&&qe-H.current.firstTs>800&&(H.current=null)}}catch{}Qe.current=requestAnimationFrame(o)}};return Qe.current=requestAnimationFrame(o),()=>{l=!0,Qe.current&&cancelAnimationFrame(Qe.current),Qe.current=null}},[B,V,Ce,be,ge,Ct,p,os,Zt]);const Et=r.useCallback(async()=>{try{if(xe){const e=W.find(s=>s.kind==="videoinput");e?Q(e.deviceId,e.label||"",!0):Q(void 0,"",!0)}await mt()}catch(e){console.warn("[CameraView] Local camera fallback failed:",e)}},[W,xe,Q]);r.useEffect(()=>{try{on.getState().setCalibrationStatus({hasHomography:!!be,imageSize:ge})}catch{}},[be,ge]),r.useEffect(()=>{if(V!=="external-ws"||!oe)return;const e=mn(oe,s=>{if(!(!Ke.current||performance.now()-et.current<5e3))if(i){try{i(s.value,s.ring,{sector:s.sector??null,mult:s.mult??0})}catch{}try{_t({playerId:k.players[k.currentPlayerIdx]?.id??null,sector:s.sector??null,mult:s.mult??0,ring:s.ring,ts:Date.now()})}catch{}}else{const n=s.ring==="INNER_BULL"?"INNER_BULL 50":s.ring==="BULL"?"BULL 25":`${s.ring[0]}${s.value/(s.mult||1)||s.value} ${s.value}`;De(s.value,n,s.ring);try{_t({playerId:k.players[k.currentPlayerIdx]?.id??null,sector:s.sector??null,mult:s.mult??0,ring:s.ring,ts:Date.now()})}catch{}}});return()=>e.close()},[V,oe]);function hs(e){if(!ue.current||!be||!ge)return;const s=ue.current.getBoundingClientRect(),n=e.clientX-s.left,l=e.clientY-s.top,h=ue.current.width/ge.w,d=ue.current.height/ge.h,o={x:n/h,y:l/d},f=Es(be,o),N=`${f.ring} ${f.base>0?f.base:""}`.trim();Xe(N),xt(f.base),lt(f.ring),X(!0);try{if(x&&i){i(f.base,f.ring,{sector:f.sector,mult:f.mult});try{_t({playerId:k.players[k.currentPlayerIdx]?.id??null,sector:f.sector??null,mult:f.mult??0,ring:f.ring,ts:Date.now()})}catch{}X(!1)}}catch{}}function xs(e){const s=e.trim().toUpperCase();if(!s)return null;const n=s==="BULL"||s==="50"||s==="DBULL"||s==="IBULL",l=s==="25"||s==="OBULL";if(n)return{label:"INNER_BULL 50",value:50,ring:"INNER_BULL"};if(l)return{label:"BULL 25",value:25,ring:"BULL"};const h=s.match(/^(S|D|T)?\s*(\d{1,2})$/);if(!h)return null;const d=h[1]||"S",o=parseInt(h[2],10);if(o<1||o>20)return null;const f=d==="S"?1:d==="D"?2:3,N=d==="S"?"SINGLE":d==="D"?"DOUBLE":"TRIPLE";return{label:`${d}${o} ${o*f}`,value:o*f,ring:N}}function bs(){const e=k;if(!e.players.length)return e.startingScore;const s=e.players[e.currentPlayerIdx],n=s.legs[s.legs.length-1];return n?n.totalScoreRemaining:e.startingScore}function De(e,s,n){if(Y&&O){if(!as){yt(!0);try{Re.current&&clearTimeout(Re.current)}catch{}Re.current=window.setTimeout(()=>{yt(!1),Re.current=null},1200)}return}if(g==="custom"){if(L)try{L(e,n,{label:s})}catch{}if(p>=3){F(1),T(e),q([{label:s,value:e,ring:n}]);return}const $=p+1;F($),T(K=>K+e),q(K=>[...K,{label:s,value:e,ring:n}]);return}if(p>=3){const $=je,K=p;We($,K,{preOpenDarts:ct||0,doubleWindowDarts:E||0,finishedByDouble:!1,visitTotal:$});try{const Je=k.players[k.currentPlayerIdx]?.name;Je&&ft(Je,K,$)}catch{}const Ee=!tt||st||n==="DOUBLE"||n==="INNER_BULL",fe=Ee?e:0;F(1),T(fe),q([{label:s,value:fe,ring:n}]),b(Ee?0:1),R(0),tt&&!st&&(n==="DOUBLE"||n==="INNER_BULL")&&ts(!0),He({score:$,darts:K,finished:!1});return}const l=p+1,d=!tt||st||n==="DOUBLE"||n==="INNER_BULL"?e:0;tt&&!st&&(n==="DOUBLE"||n==="INNER_BULL")&&ts(!0);const o=je+d,N=bs()-o,ce=N===0&&(n==="DOUBLE"||n==="INNER_BULL");if(N<0||N===1||N===0&&!ce){const K=(ct||0)+(tt&&!st&&!(n==="DOUBLE"||n==="INNER_BULL")?1:0),Ee=N,fe=N+d,Je=fe>50&&Ee<=50||fe<=50?1:0,Rt=(E||0)+Je;We(0,l,{preOpenDarts:K,doubleWindowDarts:Rt,finishedByDouble:!1,visitTotal:0}),F(0),T(0),q([]),b(0),R(0),He({score:0,darts:l,finished:!1});return}F(l),T(o),q($=>[...$,{label:s,value:d,ring:n}]),tt&&!st&&!(n==="DOUBLE"||n==="INNER_BULL")&&b($=>($||0)+1);{const $=N,K=N+d;(K>50&&$<=50||K<=50)&&R(fe=>(fe||0)+1)}if(ce){We(o,l,{preOpenDarts:ct||0,doubleWindowDarts:E||0,finishedByDouble:!0,visitTotal:o}),rs(o),F(0),T(0),q([]),b(0),R(0),He({score:o,darts:l,finished:!0});return}l>=3&&(We(o,l,{preOpenDarts:ct||0,doubleWindowDarts:E||0,finishedByDouble:!1,visitTotal:o}),F(0),T(0),q([]),b(0),R(0),He({score:o,darts:l,finished:!1}))}function gs(){if(!(Y&&O)&&z){if(i)try{i(se,ne,void 0)}catch{}else De(se,z,ne);_(0),X(!1)}}function Lt(){if(Y&&O)return;const e=xs($e);if(!e){alert("Enter like T20, D16, 5, 25, 50");return}if(!Se||!z||ne==="MISS"||se===0){const s=Me+1;_(s),s>=5&&ve(!0)}else _(0);De(e.value,e.label,e.ring),pe(""),X(!1)}function ps(){if(Y&&O)return;const e=xs($e);if(!e){alert("Enter like T20, D16, 5, 25, 50");return}if(p===0||j.length===0){Lt();return}if(g==="custom"){if(!Se||!z||ne==="MISS"||se===0){const D=Me+1;_(D),D>=5&&ve(!0)}else _(0);if(q(D=>[...D.slice(0,-1),{label:e.label,value:e.value,ring:e.ring}]),U)try{U(e.value,e.ring,{label:e.label})}catch{}pe(""),X(!1);return}if(!Se||!z||ne==="MISS"||se===0){const D=Me+1;_(D),D>=5&&ve(!0)}else _(0);const s=j[j.length-1],n=p-1,l=je-(s?.value||0),h=bs(),d=l+e.value,o=n+1,f=h-d,N=f===0&&(e.ring==="DOUBLE"||e.ring==="INNER_BULL");if(f<0||f===1||f===0&&!N){We(0,o);try{const D=k.players[k.currentPlayerIdx]?.name;D&&ft(D,o,0)}catch{}F(0),T(0),q([]),He({score:0,darts:o,finished:!1}),pe(""),X(!1);return}if(F(o),T(d),q(D=>[...D.slice(0,-1),{label:e.label,value:e.value,ring:e.ring}]),N){We(d,o),rs(d);try{const D=k.players[k.currentPlayerIdx]?.name;D&&ft(D,o,d)}catch{}F(0),T(0),q([]),He({score:d,darts:o,finished:!0}),pe(""),X(!1);return}if(o>=3){We(d,o);try{const D=k.players[k.currentPlayerIdx]?.name;D&&ft(D,o,d)}catch{}F(0),T(0),q([]),He({score:d,darts:o,finished:!1})}pe(""),X(!1)}function qs(){ve(!1),_(0);try{window.dispatchEvent(new CustomEvent("ndn:request-calibrate"))}catch{}}function Ys(){Tt(),ve(!1),_(0)}r.useEffect(()=>{function e(s){try{const l=document.activeElement?.tagName?.toLowerCase();s.key==="m"&&l!=="input"&&l!=="textarea"&&(Ae("manual"),Te(!0))}catch{}}return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[]);function Mt(e,s){if(p>=3||Y&&O)return;const n=e*(s==="S"?1:s==="D"?2:3),l=s==="S"?"SINGLE":s==="D"?"DOUBLE":"TRIPLE";if(!Se||!z||ne==="MISS"||se===0){const h=Me+1;_(h),h>=5&&ve(!0)}else _(0);De(n,`${s}${e} ${n}`,l),X(!1)}function Gs(){if(p===0)return;const e=j[j.length-1];F(s=>s-1),T(s=>s-(e?.value||0)),q(s=>s.slice(0,-1))}function Xs(){if(p===0||Y&&O)return;if(g==="custom"){F(0),T(0),q([]);return}const e=je,s=p;We(e,s);try{const n=k.players[k.currentPlayerIdx]?.name;n&&ft(n,s,e)}catch{}F(0),T(0),q([]),He({score:e,darts:s,finished:!1})}return t.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-4",children:[a&&t.jsx("div",{className:"lg:col-span-2",children:t.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[!B&&t.jsx("button",{className:`btn px-3 py-1 text-sm ${is==="auto"?"tab--active":""}`,onClick:()=>{Ae("auto"),Te(!1),Nt(!0)},children:"Autoscore"}),t.jsx("button",{className:`btn px-3 py-1 text-sm ${is==="manual"?"tab--active":""}`,onClick:()=>{Ae("manual"),Te(!0)},title:"Open Manual Correction",children:"Manual Correction"}),B&&t.jsx("span",{className:"text-xs opacity-70",children:"Manual scoring mode active"})]})}),!c&&!B?t.jsxs("div",{className:"card relative camera-fullwidth-card lg:col-span-2",children:[t.jsx("h2",{className:"text-xl font-semibold mb-3",children:"Camera"}),t.jsxs(Rs,{storageKey:"ndn:camera:size",className:"relative rounded-2xl overflow-hidden bg-black",defaultWidth:480,defaultHeight:360,minWidth:360,minHeight:270,maxWidth:800,maxHeight:600,autoFill:!0,children:[t.jsx(fs,{}),(()=>{const e=Oe||Ye.getState().cameraAspect||"wide",s=(it||Ye.getState().cameraFitMode||"fit")==="fit",n=e==="square"?"absolute left-0 top-1/2 -translate-y-1/2 min-w-full min-h-full object-cover object-left bg-black":s?"absolute inset-0 w-full h-full object-contain object-center bg-black":"absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 min-w-full min-h-full w-auto h-auto object-cover object-center bg-black",l=e==="square"?"relative w-full mx-auto aspect-square bg-black":"relative w-full aspect-[4/3] bg-black",h=()=>t.jsxs("div",{className:l,children:[t.jsx("video",{ref:m,className:n,playsInline:!0,"webkit-playsinline":"true",muted:!0,autoPlay:!0}),t.jsx("canvas",{ref:ue,className:"absolute inset-0 w-full h-full",onClick:hs}),t.jsxs("div",{className:"absolute top-2 left-1/2 -translate-x-1/2 z-20 flex items-center gap-3 cursor-pointer select-none",onDoubleClick:Ts,"aria-label":`Visit status: ${j[0]?j[0].value>0?"hit":"miss":"pending"}, ${j[1]?j[1].value>0?"hit":"miss":"pending"}, ${j[2]?j[2].value>0?"hit":"miss":"pending"}`,children:[[0,1,2].map(d=>{const o=j[d],f=Ut[d],N=!o,ce=!!o&&f===G,D=typeof o?.value=="number"?o.value>0:!1,$=(o?.ring&&o.ring!=="MISS")??!1,Ee=ce?ce&&(D||$)?"bg-emerald-400":"bg-rose-500":"bg-gray-500/70",fe=ce&&!N;return t.jsx("span",{className:`visit-dot ${fe?"active":"inactive"} ${Ee}`},d)}),ut&&nt!==null&&t.jsxs("span",{className:"px-2 py-0.5 rounded bg-black/60 text-white text-xs font-semibold",children:[Math.max(0,nt),"s"]})]}),Y&&O?t.jsx("div",{className:"absolute bottom-3 left-1/2 -translate-x-1/2 z-20 bg-black/70 text-amber-200 text-xs font-semibold px-3 py-1 rounded-full shadow",children:"Remove darts to continue"}):null]});return xe?P?h():t.jsx("div",{className:"w-full h-full flex flex-col items-center justify-center bg-gradient-to-br from-blue-900/50 to-purple-900/50",children:t.jsxs("div",{className:"text-center space-y-3 max-w-xs mx-auto",children:[t.jsx("div",{className:"text-4xl",children:"ðŸ“±"}),t.jsx("div",{className:"text-lg font-semibold text-blue-100",children:"Phone camera selected"}),t.jsx("p",{className:"text-sm text-slate-300",children:"Start streaming from the Calibrator tab or reconnect below."}),t.jsxs("div",{className:"flex items-center justify-center gap-2 flex-wrap",children:[t.jsx("button",{className:"btn bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 text-sm",onClick:jt,children:"Reconnect Phone"}),t.jsx("button",{className:"btn bg-slate-700 hover:bg-slate-800 text-white px-3 py-1 text-sm",onClick:()=>{try{A.setShowOverlay?.(!0)}catch{}},children:"Show Overlay"}),t.jsx("button",{className:"btn bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-1 text-sm",onClick:Et,disabled:!W.length,children:"Use Local Camera"})]})]})}):h()})()]}),t.jsxs("div",{className:"mt-3 flex items-center justify-between gap-2",children:[t.jsxs("button",{className:"btn btn--ghost px-3 py-1 text-xs font-semibold",onClick:()=>As(e=>!e),children:[Jt?"Hide":"Show"," detection log"]}),t.jsxs("span",{className:"text-xs text-slate-400",children:["Recent detections: ",Bt.length]})]}),Jt&&t.jsx("div",{className:"mt-2 rounded-2xl border border-white/15 bg-slate-900/80 p-3 text-xs text-white font-mono max-h-36 overflow-y-auto space-y-1",children:Bt.length===0?t.jsx("div",{className:"text-center text-slate-400",children:"No autoscore detections yet."}):Bt.slice().reverse().map(e=>t.jsxs("div",{className:"flex items-center justify-between gap-3",children:[t.jsx("span",{className:"truncate flex-1",title:`Value ${e.value} ${e.ring}`,children:e.label.padEnd(6," ")}),t.jsx("span",{className:"text-slate-400",children:e.confidence.toFixed(2)}),t.jsx("span",{className:`px-2 rounded-full text-[10px] font-semibold ${e.accepted?"bg-emerald-500/80":e.ready?"bg-amber-500/80":"bg-rose-500/80"}`,children:e.accepted?"accepted":e.ready?"queued":"ignored"})]},e.ts))}),Pt?t.jsx("div",{className:"absolute top-3 right-3 z-30",children:(()=>{let e="bg-white/90 text-slate-800",s="Manual Correction (M)";Se&&(!!z&&ne!=="MISS"&&se>0?(e="bg-emerald-600 text-white",s=`Manual Correction (M) â€” Autoscore: ${z} (confirmed)`):(e="bg-amber-400 text-black",s=`Manual Correction (M) â€” Autoscore ambiguous: ${z||"â€”"}`));const n="px-4 py-2 rounded-full text-base font-semibold shadow-sm hover:opacity-90",l=Se&&!!z&&ne!=="MISS"&&se>0,h=as&&l?"ring-4 ring-emerald-400/60 animate-ping":Se&&!l?"animate-pulse":"";return t.jsx("button",{className:`${n} ${e} ${h}`,onClick:()=>{Ae("manual"),Te(!0)},title:s,children:"Manual"})})()}):null,t.jsxs("div",{className:"flex flex-wrap items-center gap-2 mt-3",children:[xe?t.jsxs(t.Fragment,{children:[t.jsx("div",{className:`text-sm px-3 py-2 rounded border flex-1 min-w-[200px] ${P?"bg-emerald-500/10 border-emerald-400/40 text-emerald-100":"bg-amber-500/10 border-amber-400/40 text-amber-100"}`,children:P?"ðŸ“± Phone camera stream active":"ðŸ“± Waiting for phone camera stream"}),t.jsx("button",{className:"btn bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 text-sm",onClick:jt,children:"Reconnect Phone"}),t.jsx("button",{className:"btn bg-slate-700 hover:bg-slate-800 text-white px-3 py-1 text-sm",onClick:()=>{try{A.setShowOverlay?.(!A.showOverlay)}catch{}},children:A.showOverlay?"Hide Overlay":"Show Overlay"}),t.jsx("button",{className:"btn bg-rose-600 hover:bg-rose-700 text-white px-3 py-1 text-sm",disabled:!P,onClick:()=>{try{A.clearSession?.()}catch{}},children:"Stop Phone Feed"}),ds&&t.jsx("button",{className:"btn bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-1 text-sm",onClick:Et,disabled:!W.length,children:"Use Local Camera"})]}):t.jsx(t.Fragment,{children:de?t.jsx("button",{className:"btn bg-rose-600 hover:bg-rose-700",onClick:St,children:"Stop Camera"}):t.jsx("button",{className:"btn",onClick:mt,disabled:Pe,children:Pe?"Connecting Camera...":"Connect Camera"})}),!B&&t.jsx("button",{className:"btn bg-slate-700 hover:bg-slate-800",onClick:Os,title:"Open phone, WiFi, and USB camera options",children:"Camera Devices"}),t.jsx("button",{className:"btn btn--ghost px-3 py-1 text-sm",onClick:()=>Ne(!ie),title:"Toggle the board guide overlay",children:ie?"Show board guides":"Hide board guides"}),t.jsx("button",{className:`btn ${y?"bg-rose-600 hover:bg-rose-700 text-white":"bg-emerald-600 hover:bg-emerald-700 text-white"}`,onClick:()=>te(!y),title:"Toggle whether the camera is used for scoring",children:y?"Disable camera mode":"Enable camera mode"}),t.jsx("button",{className:"btn",onClick:ms,disabled:!Ce,children:"Capture Still"}),t.jsx("button",{className:"btn bg-slate-700 hover:bg-slate-800",disabled:!Ce,onClick:()=>{dt.current=null,us(e=>e+1)},children:"Reset Autoscore Background"}),t.jsx("button",{className:"btn bg-slate-700 hover:bg-slate-800",onClick:()=>{try{window.dispatchEvent(new Event("ndn:camera-reset"))}catch{}},children:"Reset Camera Size"})]})]}):null,Pt?t.jsx("div",{className:"fixed bottom-6 right-6 z-50",children:t.jsx("button",{className:"btn btn--primary rounded-full w-12 h-12 flex items-center justify-center shadow-lg",title:"Open Manual Correction (M)",onClick:()=>{Ae("manual"),Te(!0)},children:"âœï¸"})}):null,!c&&B&&t.jsxs("div",{className:"card",children:[t.jsx("h2",{className:"text-xl font-semibold mb-3",children:"Manual Scoring"}),t.jsx("p",{className:"text-sm opacity-80 mb-3",children:"Camera-based autoscore is disabled. Use the manual visit input or open the Manual Correction panel to record darts."}),t.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[t.jsx("button",{className:"btn",onClick:()=>{Te(!0),Ae("manual")},children:"Open Manual Correction"}),t.jsx("button",{className:"btn btn--ghost",onClick:()=>{try{window.dispatchEvent(new Event("ndn:open-scoring"))}catch{}},children:"Manage Pending Visit"})]})]}),t.jsx("canvas",{ref:Le,className:"hidden"}),Hs&&!B&&t.jsx("div",{className:"fixed inset-0 bg-black/60 z-[100]",role:"dialog","aria-modal":"true",children:t.jsx("div",{className:"absolute inset-0 flex items-center justify-center p-4",children:t.jsxs(an,{storageKey:"ndn:autoscore:size",className:"w-full max-w-3xl",defaultWidth:720,defaultHeight:520,minWidth:420,minHeight:320,maxWidth:1400,maxHeight:900,initialFitHeight:!0,children:[t.jsxs("div",{className:"flex items-center justify-between mb-3",children:[t.jsx("h2",{className:"text-xl font-semibold",children:"Autoscore"}),t.jsx("div",{className:"flex items-center gap-2",children:t.jsx("button",{className:"btn btn--ghost",onClick:()=>Nt(!1),children:"Close"})})]}),t.jsx("div",{className:"text-sm opacity-80 mb-3",children:"Click the camera overlay to autoscore. Use Manual Correction if the last auto is off."}),t.jsxs("div",{className:"flex items-center gap-2 mb-3 flex-wrap",children:[t.jsx("span",{className:"font-semibold",children:"Last auto:"}),t.jsx("span",{children:z||"â€”"}),t.jsx("button",{className:"btn",onClick:gs,disabled:p>=3,children:"Add Auto Dart"}),Me>0&&t.jsxs("span",{className:"text-sm opacity-80",children:["No-registers: ",Me,"/3"]})]}),t.jsxs("div",{className:"mt-2",children:[t.jsx("div",{className:"text-sm font-semibold mb-2",children:"Quick entry"}),t.jsxs("div",{className:"flex flex-wrap gap-2 mb-3",children:[t.jsx("button",{className:"btn",disabled:p>=3,onClick:()=>{if(!Se||!z||ne==="MISS"||se===0){const e=Me+1;_(e),e>=5&&ve(!0)}else _(0);De(25,"BULL 25","BULL"),X(!1)},children:"25"}),t.jsx("button",{className:"btn",disabled:p>=3,onClick:()=>{if(!Se||!z||ne==="MISS"||se===0){const e=Me+1;_(e),e>=5&&ve(!0)}else _(0);De(50,"INNER_BULL 50","INNER_BULL"),X(!1)},children:"50"})]}),t.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[t.jsx("input",{className:"input w-full max-w-sm",list:"autoscore-quick-list",placeholder:"Type or select (e.g., D16, T20, S5)",value:vt,onChange:e=>Vs(e.target.value.toUpperCase()),onKeyDown:e=>{if(e.key==="Enter"){const s=vt.match(/^(S|D|T)(\d{1,2})$/);s&&Mt(parseInt(s[2],10),s[1])}}}),t.jsx("datalist",{id:"autoscore-quick-list",children:["D","S","T"].map(e=>Array.from({length:20},(s,n)=>n+1).map(s=>t.jsx("option",{value:`${e}${s}`},`${e}${s}`)))}),t.jsx("button",{className:"btn",disabled:!vt||p>=3,onClick:()=>{const e=vt.match(/^(S|D|T)(\d{1,2})$/);if(!e)return;const s=e[1],n=parseInt(e[2],10);Mt(n,s)},children:"Add"})]})]})]})})}),$t&&t.jsx("div",{className:"fixed inset-0 bg-black/60 z-[100]",role:"dialog","aria-modal":"true",children:t.jsx("div",{className:"absolute inset-0 flex flex-col",children:t.jsxs(Cs,{returnFocus:!0,children:[t.jsxs("div",{className:"p-3 md:p-4 flex items-center justify-between",children:[t.jsx("h3",{className:"text-xl md:text-2xl font-semibold",children:"Manual Correction"}),t.jsx("div",{className:"flex items-center gap-2",children:t.jsx("button",{className:"btn bg-slate-700 hover:bg-slate-800",onClick:()=>{Te(!1)},children:"Close"})})]}),t.jsx("div",{className:"flex-1 p-3 md:p-4",children:t.jsxs("div",{className:"h-full grid grid-cols-1 lg:grid-cols-2 gap-4",children:[t.jsxs("div",{className:"card relative flex flex-col",children:[t.jsx("div",{className:"text-sm font-semibold mb-2",children:"Live Preview"}),t.jsx("div",{className:"relative flex-1 rounded-2xl overflow-hidden bg-black",children:t.jsx("canvas",{ref:cs,className:"absolute inset-0 w-full h-full"})})]}),t.jsxs("div",{className:"card flex flex-col",children:[t.jsx("div",{className:"text-sm opacity-80 mb-2",children:"Type a correction or replace the last dart. The preview updates live."}),t.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[t.jsx("span",{className:"font-semibold",children:"Last auto:"}),t.jsx("span",{children:z||"â€”"}),t.jsx("button",{className:"btn",onClick:gs,disabled:p>=3,children:"Add Auto Dart"})]}),t.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[t.jsx("input",{className:"input flex-[1.2]",placeholder:"Manual (T20, D16, 5, 25, 50)",value:$e,onChange:e=>pe(e.target.value),onKeyDown:e=>{e.key==="Enter"&&!e.shiftKey&&(e.preventDefault(),Lt()),e.key==="Enter"&&e.shiftKey&&(e.preventDefault(),ps())}}),t.jsx("button",{className:"btn btn--ghost",onClick:ps,disabled:p===0,children:"Replace Last"}),t.jsx("button",{className:"btn",onClick:Lt,disabled:p>=3,children:"Add"})]}),t.jsx("div",{className:"text-xs opacity-70 mb-4",children:"Press Enter to Add Â· Shift+Enter to Replace Last"}),t.jsxs("div",{className:"mb-4",children:[t.jsx("div",{className:"text-sm font-semibold mb-2",children:"Number pad"}),t.jsxs("div",{className:"grid grid-cols-3 gap-2 max-w-sm",children:[["7","8","9","4","5","6","1","2","3","0"].map(e=>t.jsx("button",{className:"btn text-lg",onClick:()=>{pe(s=>/^[SDT]/i.test(s)?s+e:(s||"")+e)},children:e},e)),t.jsx("button",{className:"btn bg-rose-600 hover:bg-rose-700 text-white",onClick:()=>pe(""),children:"Clear"}),t.jsx("button",{className:"btn bg-slate-600 hover:bg-slate-700 text-white",onClick:()=>pe(e=>(e||"").slice(0,-1)),children:"âŒ«"}),t.jsx("button",{className:"btn bg-emerald-600 hover:bg-emerald-700 text-white",onClick:()=>Lt(),disabled:p>=3,children:"Enter"})]}),t.jsx("div",{className:"text-xs opacity-70 mt-2",children:"Tap numbers then press Enter to submit. Use D/T prefixes for doubles/trebles (e.g., D16)."})]}),t.jsxs("div",{className:"mt-auto",children:[t.jsx("div",{className:"text-sm font-semibold mb-2",children:"Quick entry"}),t.jsxs("div",{className:"flex flex-wrap gap-2 mb-3",children:[t.jsx("button",{className:"btn",disabled:p>=3,onClick:()=>{if(!Se||!z||ne==="MISS"||se===0){const e=Me+1;_(e),e>=5&&ve(!0)}else _(0);De(25,"BULL 25","BULL"),X(!1)},children:"25"}),t.jsx("button",{className:"btn",disabled:p>=3,onClick:()=>{if(!Se||!z||ne==="MISS"||se===0){const e=Me+1;_(e),e>=5&&ve(!0)}else _(0);De(50,"INNER_BULL 50","INNER_BULL"),X(!1)},children:"50"})]}),t.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[t.jsx("input",{className:"input w-full max-w-sm",list:"manual-quick-list",placeholder:"Type or select (e.g., D16, T20, S5)",value:wt,onChange:e=>zs(e.target.value.toUpperCase()),onKeyDown:e=>{if(e.key==="Enter"){const s=wt.match(/^(S|D|T)(\d{1,2})$/);s&&Mt(parseInt(s[2],10),s[1])}}}),t.jsx("datalist",{id:"manual-quick-list",children:["D","S","T"].map(e=>Array.from({length:20},(s,n)=>n+1).map(s=>t.jsx("option",{value:`${e}${s}`},`${e}${s}`)))}),t.jsx("button",{className:"btn",disabled:!wt||p>=3,onClick:()=>{const e=wt.match(/^(S|D|T)(\d{1,2})$/);if(!e)return;const s=e[1],n=parseInt(e[2],10);Mt(n,s)},children:"Add"})]})]})]})]})})]})})}),Ws&&t.jsx("div",{className:"fixed inset-0 bg-black/60 z-[100] flex items-center justify-center",children:t.jsx(Cs,{returnFocus:!0,children:t.jsxs("div",{className:"card w-full max-w-4xl relative text-left bg-[#2d2250] text-white p-6 rounded-xl shadow-xl",role:"dialog","aria-modal":"true",children:[t.jsx("button",{className:"absolute top-2 right-2 btn px-2 py-1 bg-purple-500 text-white font-bold",onClick:()=>ls(!1),"aria-label":"Close scoring dialog",children:"Close"}),t.jsx("h2",{className:"text-xl font-bold mb-4 flex items-center gap-2 text-white",children:"Scoring"}),t.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[t.jsxs("div",{className:"bg-black/30 rounded-2xl p-4",children:[t.jsx("h2",{className:"text-lg font-semibold mb-3",children:"Camera"}),t.jsxs(Rs,{storageKey:"ndn:camera:size:modal",className:"relative rounded-2xl overflow-hidden bg-black",defaultWidth:480,defaultHeight:360,minWidth:360,minHeight:270,maxWidth:800,maxHeight:600,children:[t.jsx(fs,{}),(()=>{const s=(Ye.getState().cameraFitMode||"fit")==="fit"?"absolute inset-0 w-full h-full object-contain object-center bg-black":"absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 min-w-full min-h-full w-auto h-auto object-cover object-center bg-black",n=()=>t.jsxs("div",{className:"relative w-full aspect-[4/3] bg-black",children:[t.jsx("video",{ref:m,className:s,playsInline:!0,"webkit-playsinline":"true",muted:!0,autoPlay:!0}),t.jsx("canvas",{ref:ue,className:"absolute inset-0 w-full h-full",onClick:hs}),t.jsxs("div",{className:"absolute top-2 left-1/2 -translate-x-1/2 z-20 flex items-center gap-3","aria-label":`Visit status: ${j[0]?j[0].value>0?"hit":"miss":"pending"}, ${j[1]?j[1].value>0?"hit":"miss":"pending"}, ${j[2]?j[2].value>0?"hit":"miss":"pending"}`,children:[[0,1,2].map(l=>{const h=j[l],d=!h,o=!!h&&(typeof h.value=="number"?h.value>0:!0),f=d?"bg-gray-500/70":o?"bg-emerald-400":"bg-rose-500";return t.jsx("span",{className:`w-3 h-3 rounded-full shadow ${f}`},l)}),ut&&nt!==null&&t.jsxs("span",{className:"px-2 py-0.5 rounded bg-black/60 text-white text-xs font-semibold",children:[Math.max(0,nt),"s"]})]}),Y&&O?t.jsx("div",{className:"absolute bottom-3 left-1/2 -translate-x-1/2 z-20 bg-black/70 text-amber-200 text-xs font-semibold px-3 py-1 rounded-full shadow",children:"Remove darts to continue"}):null]});return xe?P?n():t.jsx("div",{className:"w-full h-full flex flex-col items-center justify-center bg-gradient-to-br from-blue-900/50 to-purple-900/50",children:t.jsxs("div",{className:"text-center space-y-3 max-w-xs mx-auto",children:[t.jsx("div",{className:"text-4xl",children:"ðŸ“±"}),t.jsx("div",{className:"text-lg font-semibold text-blue-100",children:"Phone camera selected"}),t.jsx("p",{className:"text-sm text-slate-300",children:"Start streaming from the Calibrator tab or reconnect below."}),t.jsxs("div",{className:"flex items-center justify-center gap-2 flex-wrap",children:[t.jsx("button",{className:"btn bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 text-sm",onClick:jt,children:"Reconnect Phone"}),t.jsx("button",{className:"btn bg-slate-700 hover:bg-slate-800 text-white px-3 py-1 text-sm",onClick:()=>{try{A.setShowOverlay?.(!0)}catch{}},children:"Show Overlay"}),t.jsx("button",{className:"btn bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-1 text-sm",onClick:Et,disabled:!W.length,children:"Use Local Camera"})]})]})}):n()})()]}),t.jsxs("div",{className:"flex flex-wrap items-center gap-2 mt-3",children:[xe?t.jsxs(t.Fragment,{children:[t.jsx("div",{className:`text-sm px-3 py-2 rounded border flex-1 min-w-[200px] ${P?"bg-emerald-500/10 border-emerald-400/40 text-emerald-100":"bg-amber-500/10 border-amber-400/40 text-amber-100"}`,children:P?"ðŸ“± Phone camera stream active":"ðŸ“± Waiting for phone camera stream"}),t.jsx("button",{className:"btn bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 text-sm",onClick:jt,children:"Reconnect Phone"}),t.jsx("button",{className:"btn bg-slate-700 hover:bg-slate-800 text-white px-3 py-1 text-sm",onClick:()=>{try{A.setShowOverlay?.(!A.showOverlay)}catch{}},children:A.showOverlay?"Hide Overlay":"Show Overlay"}),t.jsx("button",{className:"btn bg-rose-600 hover:bg-rose-700 text-white px-3 py-1 text-sm",disabled:!P,onClick:()=>{try{A.clearSession?.()}catch{}},children:"Stop Phone Feed"}),ds&&t.jsx("button",{className:"btn bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-1 text-sm",onClick:Et,disabled:!W.length,children:"Use Local Camera"})]}):t.jsx(t.Fragment,{children:de?t.jsx("button",{className:"btn bg-gradient-to-r from-rose-600 to-rose-700 text-white font-bold",onClick:St,children:"Stop Camera"}):t.jsx("button",{className:"btn bg-gradient-to-r from-purple-500 to-purple-700 text-white font-bold",onClick:mt,children:"Connect Camera"})}),t.jsx("button",{className:"btn bg-gradient-to-r from-indigo-500 to-indigo-700 text-white font-bold",onClick:ms,disabled:!Ce,children:"Capture Still"}),t.jsx("button",{className:"btn bg-gradient-to-r from-slate-600 to-slate-800 text-white font-bold",disabled:!Ce,onClick:()=>{dt.current=null,us(e=>e+1)},children:"Reset Autoscore Background"}),t.jsx("button",{className:"btn bg-gradient-to-r from-slate-500 to-slate-700 text-white font-bold",onClick:()=>{try{window.dispatchEvent(new Event("ndn:camera-reset"))}catch{}},children:"Reset Camera Size"})]})]}),t.jsxs("div",{className:"bg-black/30 rounded-2xl p-4",children:[t.jsx("h2",{className:"text-lg font-semibold mb-3",children:"Pending Visit"}),t.jsx("div",{className:"text-sm opacity-80 mb-2",children:"Up to 3 darts per visit."}),t.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[[0,1,2].map(e=>{const s=j[e],n=!s,l=!!s&&(typeof s.value=="number"?s.value>0:!0),h=n?"bg-gray-500/70":l?"bg-emerald-400":"bg-rose-500";return t.jsx("span",{className:`w-2.5 h-2.5 rounded-full shadow ${h}`},e)}),ut&&nt!==null&&t.jsxs("span",{className:"ml-2 px-2 py-0.5 rounded bg-black/40 text-white text-xs font-semibold",children:[Math.max(0,nt),"s"]})]}),t.jsx("ul",{className:"text-sm mb-2 list-disc pl-5",children:j.length===0?t.jsx("li",{className:"opacity-60",children:"No darts yet"}):j.map((e,s)=>t.jsx("li",{children:e.label},s))}),t.jsxs("div",{className:"flex items-center gap-4 mb-2",children:[t.jsxs("div",{className:"font-semibold",children:["Darts: ",p,"/3"]}),t.jsxs("div",{className:"font-semibold",children:["Total: ",je]})]}),t.jsxs("div",{className:"flex gap-2",children:[t.jsx("button",{className:"btn bg-gradient-to-r from-purple-500 to-purple-700 text-white font-bold",onClick:Gs,disabled:p===0,children:"Undo Dart"}),t.jsx("button",{className:"btn bg-gradient-to-r from-emerald-500 to-emerald-700 text-white font-bold",onClick:Xs,disabled:p===0,children:"Commit Visit"}),t.jsx("button",{className:"btn bg-gradient-to-r from-slate-500 to-slate-700 text-white font-bold",onClick:Us,disabled:p===0,children:"Clear"})]})]})]})]})})}),Fs&&t.jsx("div",{className:"fixed inset-0 bg-black/60 z-50 flex items-center justify-center",children:t.jsxs("div",{className:"card max-w-md w-full relative text-left bg-[#2d2250] text-white p-6 rounded-xl shadow-xl",children:[t.jsx("button",{className:"absolute top-2 right-2 btn px-2 py-1 bg-purple-500 text-white font-bold",onClick:()=>{ve(!1),_(0)},children:"Close"}),t.jsx("h3",{className:"text-xl font-bold mb-2 flex items-center gap-2 text-white",children:"Recalibration Recommended"}),t.jsx("div",{className:"mb-4 text-lg font-semibold text-indigo-200",children:"We detected 3 incorrect autoscores in a row. You can recalibrate now or reset calibration and try again."}),t.jsxs("div",{className:"flex gap-2",children:[t.jsx("button",{className:"btn bg-gradient-to-r from-purple-500 to-purple-700 text-white font-bold",onClick:qs,children:"Go to Calibrate"}),t.jsx("button",{className:"btn bg-gradient-to-r from-slate-500 to-slate-700 text-white font-bold",onClick:Ys,children:"Reset Calibration"}),t.jsx("button",{className:"btn bg-gradient-to-r from-slate-500 to-slate-700 text-white font-bold",onClick:()=>{ve(!1),_(0)},children:"Dismiss"})]})]})})]})}const Ln=Object.freeze(Object.defineProperty({__proto__:null,default:Nn},Symbol.toStringTag,{value:"Module"}));export{Nn as C,Rs as R,Ln as a,fn as u};
//# sourceMappingURL=CameraView-DUD7umIa.js.map
