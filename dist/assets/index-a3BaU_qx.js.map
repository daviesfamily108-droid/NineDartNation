{"version":3,"mappings":";;;;;;;;;6CASa,IAAIA,EAAEC,GAAA,EAAiBC,EAAE,OAAO,IAAI,eAAe,EAAEC,EAAE,OAAO,IAAI,gBAAgB,EAAEC,EAAE,OAAO,UAAU,eAAeC,EAAEL,EAAE,mDAAmD,kBAAkBM,EAAE,CAAC,IAAI,GAAG,IAAI,GAAG,OAAO,GAAG,SAAS,EAAE,EAClP,SAASC,EAAEC,EAAEC,EAAEC,EAAE,CAAC,IAAIC,EAAEC,EAAE,GAAGC,EAAE,KAAKC,EAAE,KAAcJ,IAAT,SAAaG,EAAE,GAAGH,GAAYD,EAAE,MAAX,SAAiBI,EAAE,GAAGJ,EAAE,KAAcA,EAAE,MAAX,SAAiBK,EAAEL,EAAE,KAAK,IAAIE,KAAKF,EAAEL,EAAE,KAAKK,EAAEE,CAAC,GAAG,CAACL,EAAE,eAAeK,CAAC,IAAIC,EAAED,CAAC,EAAEF,EAAEE,CAAC,GAAG,GAAGH,GAAGA,EAAE,aAAa,IAAIG,KAAKF,EAAED,EAAE,aAAaC,EAAWG,EAAED,CAAC,IAAZ,SAAgBC,EAAED,CAAC,EAAEF,EAAEE,CAAC,GAAG,MAAM,CAAC,SAAST,EAAE,KAAKM,EAAE,IAAIK,EAAE,IAAIC,EAAE,MAAMF,EAAE,OAAOP,EAAE,OAAO,CAAC,CAAC,OAAAU,YAAiBZ,EAAEY,GAAA,IAAYR,EAAEQ,GAAA,KAAaR,2CCPxWS,GAAA,QAAiBf,GAAA,qECDnB,IAAIG,EAAIH,GAAA,EAEN,OAAAgB,GAAA,WAAqBb,EAAE,WACvBa,GAAA,YAAsBb,EAAE,mnCCL1B,SAASc,GAA8BC,EAAGN,EAAG,CAC3C,GAAYM,GAAR,KAAW,MAAO,GACtB,IAAIC,EAAI,GACR,QAASf,KAAKc,EAAG,GAAI,GAAG,eAAe,KAAKA,EAAGd,CAAC,EAAG,CACjD,GAAWQ,EAAE,QAAQR,CAAC,IAAlB,GAAqB,SACzBe,EAAEf,CAAC,EAAIc,EAAEd,CAAC,CACZ,CACA,OAAOe,CACT,CCRA,SAASC,IAAW,CAClB,OAAOA,GAAW,OAAO,OAAS,OAAO,OAAO,KAAI,EAAK,SAAUhB,EAAG,CACpE,QAASQ,EAAI,EAAGA,EAAI,UAAU,OAAQA,IAAK,CACzC,IAAIO,EAAI,UAAUP,CAAC,EACnB,QAAS,KAAKO,GAAI,IAAI,eAAe,KAAKA,EAAG,CAAC,IAAMf,EAAE,CAAC,EAAIe,EAAE,CAAC,EAChE,CACA,OAAOf,CACT,EAAGgB,GAAS,MAAM,KAAM,SAAS,CACnC,CCLO,IAAIC,GAAc,kBAIdC,GAAiB,2BAIjBC,GAAc,qBAKdC,GAAa,wBAKbC,GAAqB,oBCRzB,SAASC,GAAUC,EAAKC,EAAO,CAClC,OAAI,OAAOD,GAAQ,WACfA,EAAIC,CAAK,EAEJD,IACLA,EAAI,QAAUC,GAEXD,CACX,CCNO,SAASE,GAAeC,EAAcC,EAAU,CACnD,IAAIJ,EAAMK,WAAS,UAAY,CAAE,MAAQ,CAErC,MAAOF,EAEP,SAAUC,EAEV,OAAQ,CACJ,IAAI,SAAU,CACV,OAAOJ,EAAI,KACf,EACA,IAAI,QAAQC,EAAO,CACf,IAAIK,EAAON,EAAI,MACXM,IAASL,IACTD,EAAI,MAAQC,EACZD,EAAI,SAASC,EAAOK,CAAI,EAEhC,CACZ,CACA,CAAQ,CAAC,EAAE,CAAC,EAER,OAAAN,EAAI,SAAWI,EACRJ,EAAI,MACf,CCnCA,IAAIO,GAA4B,OAAO,OAAW,IAAcC,kBAAwBC,YACpFC,GAAgB,IAAI,QAejB,SAASC,GAAaC,EAAMC,EAAc,CAC7C,IAAIC,EAAcZ,GAA+B,KAAM,SAAUa,EAAU,CACvE,OAAOH,EAAK,QAAQ,SAAUZ,EAAK,CAAE,OAAOD,GAAUC,EAAKe,CAAQ,CAAG,CAAC,CAC3E,CAAC,EAED,OAAAR,GAA0B,UAAY,CAClC,IAAIS,EAAWN,GAAc,IAAII,CAAW,EAC5C,GAAIE,EAAU,CACV,IAAIC,EAAa,IAAI,IAAID,CAAQ,EAC7BE,EAAa,IAAI,IAAIN,CAAI,EACzBO,EAAYL,EAAY,QAC5BG,EAAW,QAAQ,SAAUjB,EAAK,CACzBkB,EAAW,IAAIlB,CAAG,GACnBD,GAAUC,EAAK,IAAI,CAE3B,CAAC,EACDkB,EAAW,QAAQ,SAAUlB,EAAK,CACzBiB,EAAW,IAAIjB,CAAG,GACnBD,GAAUC,EAAKmB,CAAS,CAEhC,CAAC,CACL,CACAT,GAAc,IAAII,EAAaF,CAAI,CACvC,EAAG,CAACA,CAAI,CAAC,EACFE,CACX,CC1CO,IAAIM,GAAc,CACvB,MAAO,MACP,OAAQ,MACR,QAAS,EACT,SAAU,SACV,SAAU,QACV,IAAK,MACL,KAAM,KACR,ECqBWC,GAAW,UAAW,CAC/B,OAAAA,GAAW,OAAO,QAAU,SAAkB7B,EAAG,CAC7C,QAAS,EAAG8B,EAAI,EAAG7C,EAAI,UAAU,OAAQ6C,EAAI7C,EAAG6C,IAAK,CACjD,EAAI,UAAUA,CAAC,EACf,QAAS5C,KAAK,EAAO,OAAO,UAAU,eAAe,KAAK,EAAGA,CAAC,IAAGc,EAAEd,CAAC,EAAI,EAAEA,CAAC,EAC/E,CACA,OAAOc,CACX,EACO6B,GAAS,MAAM,KAAM,SAAS,CACvC,ECvCA,SAASE,GAAK1C,EAAG,CACb,OAAOA,CACX,CACA,SAAS2C,GAAkBC,EAAUC,EAAY,CACzCA,IAAe,SAAUA,EAAaH,IAC1C,IAAII,EAAS,GACTC,EAAW,GACXC,EAAS,CACT,KAAM,UAAY,CACd,GAAID,EACA,MAAM,IAAI,MAAM,kGAAkG,EAEtH,OAAID,EAAO,OACAA,EAAOA,EAAO,OAAS,CAAC,EAE5BF,CACX,EACA,UAAW,SAAUK,EAAM,CACvB,IAAIC,EAAOL,EAAWI,EAAMF,CAAQ,EACpC,OAAAD,EAAO,KAAKI,CAAI,EACT,UAAY,CACfJ,EAASA,EAAO,OAAO,SAAUK,EAAG,CAAE,OAAOA,IAAMD,CAAM,CAAC,CAC9D,CACJ,EACA,iBAAkB,SAAUE,EAAI,CAE5B,IADAL,EAAW,GACJD,EAAO,QAAQ,CAClB,IAAIO,EAAMP,EACVA,EAAS,GACTO,EAAI,QAAQD,CAAE,CAClB,CACAN,EAAS,CACL,KAAM,SAAUK,EAAG,CAAE,OAAOC,EAAGD,CAAC,CAAG,EACnC,OAAQ,UAAY,CAAE,OAAOL,CAAQ,CACrD,CACQ,EACA,aAAc,SAAUM,EAAI,CACxBL,EAAW,GACX,IAAIO,EAAe,GACnB,GAAIR,EAAO,OAAQ,CACf,IAAIO,EAAMP,EACVA,EAAS,GACTO,EAAI,QAAQD,CAAE,EACdE,EAAeR,CACnB,CACA,IAAIS,EAAe,UAAY,CAC3B,IAAIF,EAAMC,EACVA,EAAe,GACfD,EAAI,QAAQD,CAAE,CAClB,EACII,EAAQ,UAAY,CAAE,OAAO,QAAQ,QAAO,EAAG,KAAKD,CAAY,CAAG,EACvEC,EAAK,EACLV,EAAS,CACL,KAAM,SAAUK,EAAG,CACfG,EAAa,KAAKH,CAAC,EACnBK,EAAK,CACT,EACA,OAAQ,SAAUC,EAAQ,CACtB,OAAAH,EAAeA,EAAa,OAAOG,CAAM,EAClCX,CACX,CAChB,CACQ,CACR,EACI,OAAOE,CACX,CACO,SAASU,GAAad,EAAUC,EAAY,CAC/C,OAAIA,IAAe,SAAUA,EAAaH,IACnCC,GAAkBC,EAAUC,CAAU,CACjD,CAEO,SAASc,GAAoBC,EAAS,CACrCA,IAAY,SAAUA,EAAU,IACpC,IAAIZ,EAASL,GAAkB,IAAI,EACnC,OAAAK,EAAO,QAAUR,GAAS,CAAE,MAAO,GAAM,IAAK,EAAK,EAAIoB,CAAO,EACvDZ,CACX,CC5EO,IAAIa,GAAcH,GAAa,GAAI,SAAUI,EAAM,CACxD,IAAIC,EAASD,EAAK,OAChBE,EAAgBF,EAAK,cACvB,MAAO,CACL,OAAQC,EACR,cAAeC,CACnB,CACA,CAAC,EACUC,GAAaP,GAAY,EACzBQ,GAAeR,GAAY,EAC3BS,GAAgBR,GAAoB,CAC7C,MAAO,GACP,IAAK,OAAO,SAAa,GAC3B,CAAC,ECbUS,GAA0BC,gBAAc,MAAS,ECOxDC,GAAa,GACbC,GAAyBC,aAAW,SAAqBC,EAAOC,EAAW,CAC7E,IAAIC,EACAC,EAAYpD,aACdqD,EAAeD,EAAU,CAAC,EAC1BE,EAAcF,EAAU,CAAC,EACvBG,EAAWC,SAAA,EACXC,EAAWD,SAAO,EAAK,EACvBE,EAAyBF,SAAO,IAAI,EACpCG,EAAa3D,WAAS,EAAE,EAC1B4D,EAASD,EAAW,CAAC,EACnBE,EAAWZ,EAAM,SACnBa,EAAkBb,EAAM,SACxBc,EAAWD,IAAoB,OAAS,GAAQA,EAChDE,EAAuBf,EAAM,cAC7BgB,EAAgBD,IAAyB,OAAS,GAAQA,EAC1DE,EAAwBjB,EAAM,gBAC9BkB,EAAkBD,IAA0B,OAAS,GAAQA,EAC7DE,EAAoBnB,EAAM,WAC1BoB,EAAaD,IAAsB,OAAS,GAAOA,EACnDE,EAAmBrB,EAAM,UACzBsB,EAAYD,IAAqB,OAAS,GAAOA,EAC5BrB,EAAM,uBAC3BuB,EAAQvB,EAAM,MACdwB,EAAYxB,EAAM,UAClByB,EAAYzB,EAAM,UAClB0B,EAAqB1B,EAAM,mBAC3B2B,EAAgB3B,EAAM,OACtB4B,EAASD,IAAkB,OAAS9B,GAAa8B,EACjDE,EAAY7B,EAAM,GAClB8B,EAAYD,IAAc,OAAS,MAAQA,EAC3CE,EAAmB/B,EAAM,UACzBgC,GAAiBD,IAAqB,OAAS,GAAKA,EACpDE,GAAUjC,EAAM,QAChBkC,GAAqBlC,EAAM,YAC3BmC,GAAoBD,KAAuB,OAAS,GAAQA,GAC5DE,GAAepC,EAAM,aACrBqC,GAAuBrC,EAAM,aAC7BsC,EAAyBtC,EAAM,eAC7BuC,EAAaxF,WAAS,EAAE,EAC1ByF,GAAKD,EAAW,CAAC,EACfE,GAAeC,cAAY,SAAUrD,GAAM,CAC7C,IAAIsD,EAAsBtD,GAAK,oBAC/B,GAAI,CAACoB,EAAuB,QAAS,CACnC,IAAImC,EACAC,GAAiBD,EAAY,WAAa,KAAO,OAASA,EAAU,cACxEnC,EAAuB,QAAUoC,EAC7BA,IAAkB,SAAS,OAC7BpC,EAAuB,QAAUkC,EAAoBE,CAAa,EAEtE,CACIvC,EAAS,SAAW+B,IACtBA,GAAqB/B,EAAS,OAAO,EAEvCE,EAAS,QAAU,GACnBG,EAAA,CACF,EAAG,CAAC0B,EAAoB,CAAC,EACrBS,GAAiBJ,cAAY,UAAY,CAC3ClC,EAAS,QAAU,GACf8B,GACFA,EAAuBhC,EAAS,OAAO,EAEzCK,EAAA,CACF,EAAG,CAAC2B,CAAsB,CAAC,EACvBS,GAAcL,cAAY,SAAUM,GAAY,CAClD,IAAIC,EAAexC,EAAuB,QAC1C,GAAIwC,EAAc,CAChB,IAAIC,GAAiB,OAAOD,GAAiB,WAAaA,IAAiBA,IAAiB,SAAS,KACjGE,EAAmB,OAAOhB,IAAsB,WAAaA,GAAkBe,CAAa,EAAIf,GACpG,GAAIgB,EAAkB,CACpB,IAAIC,GAAqB,OAAOD,GAAqB,SAAWA,EAAmB,OACnF1C,EAAuB,QAAU,KAC7BuC,GACF,QAAQ,UAAU,KAAK,UAAY,CACjC,OAAOE,EAAc,MAAME,EAAkB,CAC/C,CAAC,EAEDF,EAAc,MAAME,EAAkB,CAE1C,CACF,CACF,EAAG,CAACjB,EAAiB,CAAC,EAClBkB,GAAUX,cAAY,SAAUY,GAAO,CACrC9C,EAAS,SACXpB,GAAY,UAAUkE,EAAK,CAE/B,EAAG,EAAE,EACDC,GAAS/D,GAAW,UACpBgE,EAAiBd,cAAY,SAAUe,GAAa,CAClDnD,EAAS,UAAYmD,KACvBnD,EAAS,QAAUmD,GACnBpD,EAAYoD,EAAW,EAE3B,EAAG,EAAE,EAWDC,EAAYvH,IAAU+D,EAAY,GAAIA,EAAU7D,EAAc,EAAIyE,GAAY,WAAYZ,EAAU9D,EAAW,EAAImF,EAAOrB,GAAY8B,EAAc,EACpJ2B,GAAmB3C,IAAkB,GACrC4C,GAAmBD,IAAoB3C,IAAkB,OACzD6C,GAAYxG,GAAa,CAAC4C,EAAWuD,CAAc,CAAC,EACpDM,GAAkBC,UAAQ,UAAY,CACxC,MAAO,CACL,SAAAzD,EACA,OAAAsB,EACA,QAAS,CAACd,EACV,OAAQN,EAAS,QAErB,EAAG,CAACM,EAAUN,EAAS,QAASoB,EAAQxB,CAAY,CAAC,EACrD,OAAoB4D,GAAM,cAAcC,WAAU,KAAMN,IAAoB,CAE5EK,GAAM,cAAc,MAAO,CACzB,IAAK,cACL,mBAAoB,GACpB,SAAUlD,EAAW,GAAK,EAC1B,MAAOhD,EAAA,CACR,EAAG4D,EAAkCsC,GAAM,cAAc,MAAO,CAC/D,IAAK,gBACL,mBAAoB,GACpB,SAAUlD,EAAW,GAAK,EAC1B,MAAOhD,EAAA,CACR,EAAI,MAAO,CAACgD,GAAyBkD,GAAM,cAAc/B,GAAS,CACjE,GAAAO,GACA,QAAS9C,GACT,SAAUU,EACV,SAAAU,EACA,gBAAAI,EACA,WAAAE,EACA,UAAAE,EACA,UAAAG,EACA,OAAAG,EACA,aAAAa,GACA,eAAAK,GACA,YAAAC,GACA,aAAAX,GACA,cAAApB,CAAA,CACD,EAAgBgD,GAAM,cAAclC,EAAW3F,GAAS,CACvD,IAAK0H,EAAA,EACJH,EAAW,CACZ,UAAAlC,EACA,OAAA+B,GACA,QAAAF,EAAA,CACD,EAAgBW,GAAM,cAAcrE,GAAW,SAAU,CACxD,MAAOmE,EAAA,EACNlD,CAAQ,CAAC,EAAGgD,IAAiCI,GAAM,cAAc,MAAO,CACzE,mBAAoB,GACpB,SAAUlD,EAAW,GAAK,EAC1B,MAAOhD,EAAA,CACR,CAAC,CACJ,CAAC,EACDgC,GAAU,UAoBN,GCzLJ,SAASoE,GAAgB,EAAGvI,EAAG,CAC7B,OAAOuI,GAAkB,OAAO,eAAiB,OAAO,eAAe,KAAI,EAAK,SAAUhI,EAAGP,EAAG,CAC9F,OAAOO,EAAE,UAAYP,EAAGO,CAC1B,EAAGgI,GAAgB,EAAGvI,CAAC,CACzB,CCHA,SAASwI,GAAe,EAAGC,EAAG,CAC5B,EAAE,UAAY,OAAO,OAAOA,EAAE,SAAS,EAAG,EAAE,UAAU,YAAc,EAAGC,GAAe,EAAGD,CAAC,CAC5F,CCHA,SAASE,GAAQF,EAAG,CAClB,0BAEA,OAAOE,GAAwB,OAAO,QAArB,YAA2C,OAAO,OAAO,UAA1B,SAAqC,SAAUF,EAAG,CAChG,OAAO,OAAOA,CAChB,EAAI,SAAUA,EAAG,CACf,OAAOA,GAAmB,OAAO,QAArB,YAA+BA,EAAE,cAAgB,QAAUA,IAAM,OAAO,UAAY,SAAW,OAAOA,CACpH,EAAGE,GAAQF,CAAC,CACd,CCPA,SAASG,GAAY,EAAGtI,EAAG,CACzB,GAAgBqI,GAAQ,CAAC,GAArB,UAA0B,CAAC,EAAG,OAAO,EACzC,IAAI3I,EAAI,EAAE,OAAO,WAAW,EAC5B,GAAeA,IAAX,OAAc,CAChB,IAAIqC,EAAIrC,EAAE,KAAK,EAAGM,CAAc,EAChC,GAAgBqI,GAAQtG,CAAC,GAArB,SAAwB,OAAOA,EACnC,MAAM,IAAI,UAAU,8CAA8C,CACpE,CACA,OAAqB/B,IAAb,SAAiB,OAAS,QAAQ,CAAC,CAC7C,CCRA,SAASuI,GAAc,EAAG,CACxB,IAAIxG,EAAIuG,GAAY,EAAG,QAAQ,EAC/B,OAAmBD,GAAQtG,CAAC,GAArB,SAAyBA,EAAIA,EAAI,EAC1C,CCJA,SAASyG,GAAgB9I,EAAGM,EAAGC,EAAG,CAChC,OAAQD,EAAIuI,GAAcvI,CAAC,KAAMN,EAAI,OAAO,eAAeA,EAAGM,EAAG,CAC/D,MAAOC,EACP,WAAY,GACZ,aAAc,GACd,SAAU,EACd,CAAG,EAAIP,EAAEM,CAAC,EAAIC,EAAGP,CACjB,CCJA,SAAS+I,GAAeC,EAAoBC,EAA2B,CAWrE,SAASC,EAAeC,EAAkB,CACxC,OAAOA,EAAiB,aAAeA,EAAiB,MAAQ,WAClE,CAEA,OAAO,SAAcA,EAAkB,CAOrC,IAAIC,EAAmB,GACnBC,EAEJ,SAASC,GAAa,CACpBD,EAAQL,EAAmBI,EAAiB,IAAI,SAAUG,EAAU,CAClE,OAAOA,EAAS,KAClB,CAAC,CAAC,EACFN,EAA0BI,CAAK,CACjC,CAEA,IAAIG,YAAoCC,EAAgB,CACtDjB,GAAegB,EAAYC,CAAc,EAEzC,SAASD,GAAa,CACpB,OAAOC,EAAe,MAAM,KAAM,SAAS,GAAK,IAClD,CAGAD,EAAW,KAAO,UAAgB,CAChC,OAAOH,CACT,EAEA,IAAIK,EAASF,EAAW,UAExB,OAAAE,EAAO,kBAAoB,UAA6B,CACtDN,EAAiB,KAAK,IAAI,EAC1BE,EAAA,CACF,EAEAI,EAAO,mBAAqB,UAA8B,CACxDJ,EAAA,CACF,EAEAI,EAAO,qBAAuB,UAAgC,CAC5D,IAAIC,EAAQP,EAAiB,QAAQ,IAAI,EACzCA,EAAiB,OAAOO,EAAO,CAAC,EAChCL,EAAA,CACF,EAEAI,EAAO,OAAS,UAAkB,CAChC,OAAoBrB,GAAM,cAAcc,EAAkB,KAAK,KAAK,CACtE,EAEOK,CACT,GAAEI,eAAa,EAEf,OAAAd,GAAgBU,EAAY,cAAe,cAAgBN,EAAeC,CAAgB,EAAI,GAAG,EAE1FK,CACT,CACF,CCzEO,IAAIK,GAAU,SAAUjK,EAAG,CAE9B,QADIkK,EAAM,MAAMlK,EAAE,MAAM,EACfyC,EAAI,EAAGA,EAAIzC,EAAE,OAAQ,EAAEyC,EAC5ByH,EAAIzH,CAAC,EAAIzC,EAAEyC,CAAC,EAEhB,OAAOyH,CACX,EACWC,GAAU,SAAUnK,EAAG,CAAE,OAAQ,MAAM,QAAQA,CAAC,EAAIA,EAAI,CAACA,CAAC,CAAI,EAC9DoK,GAAW,SAAUpK,EAAG,CAAE,OAAQ,MAAM,QAAQA,CAAC,EAAIA,EAAE,CAAC,EAAIA,CAAI,ECVvEqK,GAAkB,SAAUC,EAAM,CAGlC,GAAIA,EAAK,WAAa,KAAK,aACvB,MAAO,GAEX,IAAIC,EAAgB,OAAO,iBAAiBD,EAAM,IAAI,EACtD,MAAI,CAACC,GAAiB,CAACA,EAAc,iBAC1B,GAEHA,EAAc,iBAAiB,SAAS,IAAM,QAAUA,EAAc,iBAAiB,YAAY,IAAM,QACrH,EACIC,GAAgB,SAAUF,EAAM,CAEhC,OAAOA,EAAK,YAAcA,EAAK,WAAW,WAAa,KAAK,uBAEpDA,EAAK,WAAW,KAClBA,EAAK,UACf,EACIG,GAAY,SAAUH,EAAM,CAE5B,OAAOA,IAAS,UAAaA,GAAQA,EAAK,WAAa,KAAK,aAChE,EACII,GAAU,SAAUJ,EAAM,CAAE,OAAOA,EAAK,aAAa,OAAO,CAAG,EAI/DK,GAAoB,SAAUL,EAAMM,EAAa,CACjD,MAAO,CAACN,GAAQG,GAAUH,CAAI,GAAM,CAACD,GAAgBC,CAAI,GAAK,CAACI,GAAQJ,CAAI,GAAKM,EAAYJ,GAAcF,CAAI,CAAC,CACnH,EACWO,GAAkB,SAAUC,EAAiBR,EAAM,CAC1D,IAAIS,EAASD,EAAgB,IAAIR,CAAI,EACrC,GAAIS,IAAW,OACX,OAAOA,EAEX,IAAIC,EAASL,GAAkBL,EAAMO,GAAgB,KAAK,OAAWC,CAAe,CAAC,EACrF,OAAAA,EAAgB,IAAIR,EAAMU,CAAM,EACzBA,CACX,EACIC,GAA6B,SAAUX,EAAMM,EAAa,CAC1D,OAAON,GAAQ,CAACG,GAAUH,CAAI,EAAKY,GAAmBZ,CAAI,EAAIM,EAAYJ,GAAcF,CAAI,CAAC,EAAI,GAAS,EAC9G,EACWa,GAA2B,SAAUC,EAAOd,EAAM,CACzD,IAAIS,EAASK,EAAM,IAAId,CAAI,EAC3B,GAAIS,IAAW,OACX,OAAOA,EAEX,IAAIC,EAASC,GAA2BX,EAAMa,GAAyB,KAAK,OAAWC,CAAK,CAAC,EAC7F,OAAAA,EAAM,IAAId,EAAMU,CAAM,EACfA,CACX,EACWK,GAAa,SAAUf,EAAM,CAEpC,OAAOA,EAAK,OAChB,EACWgB,GAAsB,SAAUhB,EAAM,CAAE,OAAOA,EAAK,UAAY,QAAU,EAC1EiB,GAAqB,SAAUjB,EAAM,CAAE,OAAOA,EAAK,UAAY,OAAS,EACxEkB,GAAiB,SAAUlB,EAAM,CACxC,OAAOiB,GAAmBjB,CAAI,GAAKA,EAAK,OAAS,OACrD,EACWmB,GAAiB,SAAUnB,EAAM,CACxC,MAAO,GAAGiB,GAAmBjB,CAAI,GAAKgB,GAAoBhB,CAAI,KAAOA,EAAK,OAAS,UAAYA,EAAK,UACxG,EACWY,GAAqB,SAAUZ,EAAM,CAC5C,IAAIoB,EAAYpB,EAAK,aAAarJ,EAAkB,EACpD,MAAO,CAAC,CAAC,GAAM,OAAQ,EAAE,EAAE,SAASyK,CAAS,CACjD,EACWC,GAAU,SAAUrB,EAAM,CAAE,IAAIsB,EAAI,MAAO,GAAQtB,IAAU,GAAAsB,EAAKP,GAAWf,CAAI,KAAO,MAAQsB,IAAO,SAAkBA,EAAG,YAAc,EAC1IC,GAAc,SAAUvB,EAAM,CAAE,MAAO,CAACqB,GAAQrB,CAAI,CAAG,EACvDwB,GAAY,SAAU3I,EAAG,CAAE,MAAO,EAAQA,CAAI,ECrE9C4I,GAAU,SAAU/L,EAAGE,EAAG,CACjC,IAAI8L,EAAO,KAAK,IAAI,EAAGhM,EAAE,QAAQ,EAC7BiM,EAAO,KAAK,IAAI,EAAG/L,EAAE,QAAQ,EAC7BgM,EAAUF,EAAOC,EACjBE,EAAYnM,EAAE,MAAQE,EAAE,MAC5B,GAAIgM,EAAS,CACT,GAAI,CAACF,EACD,MAAO,GAEX,GAAI,CAACC,EACD,MAAO,EAEf,CACA,OAAOC,GAAWC,CACtB,EACIC,GAAc,SAAU9B,EAAM,CAC9B,OAAIA,EAAK,SAAW,GAIZ,CAACA,EAAK,aAAa,UAAU,EACtB,EAGRA,EAAK,QAChB,EACW+B,GAAkB,SAAUC,EAAOC,EAAgBC,EAAY,CACtE,OAAOvC,GAAQqC,CAAK,EACf,IAAI,SAAUhC,EAAMP,EAAO,CAC5B,IAAI0C,EAAWL,GAAY9B,CAAI,EAC/B,MAAO,CACH,KAAMA,EACN,MAAOP,EACP,SAAUyC,GAAcC,IAAa,IAAOnC,EAAK,SAAW,IAAI,WAAa,EAAI,GAAMmC,CACnG,CACI,CAAC,EACI,OAAO,SAAUxJ,EAAM,CAAE,MAAO,CAACsJ,GAAkBtJ,EAAK,UAAY,CAAG,CAAC,EACxE,KAAK8I,EAAO,CACrB,ECpCWW,GAAY,CACnB,iBACA,iBACA,mBACA,gBAGA,UACA,aACA,UACA,SACA,SACA,QACA,kBACA,kBACA,aACA,oBACA,aACJ,EClBIC,GAAiBD,GAAU,KAAK,GAAG,EACnCE,GAAsB,GAAG,OAAOD,GAAgB,sBAAsB,EACtEE,GAA6B,SAAUC,EAAQC,EAAY,CAC3D,OAAO9C,IAAS6C,EAAO,YAAcA,GAAQ,QAAQ,EAAE,OAAO,SAAUE,EAAKC,EAAO,CAChF,OAAOD,EAAI,OAAOC,EAAM,QAAQF,EAAaH,GAAsBD,EAAc,EAAI,CAACM,CAAK,EAAI,GAAIJ,GAA2BI,CAAK,CAAC,CACxI,EAAG,EAAE,CACT,EACIC,GAA0B,SAAUJ,EAAQC,EAAY,CACxD,IAAInB,EAEJ,OAAIkB,aAAkB,oBAAuB,GAAAlB,EAAKkB,EAAO,mBAAqB,MAAQlB,IAAO,SAAkBA,EAAG,MACvGuB,GAAc,CAACL,EAAO,gBAAgB,IAAI,EAAGC,CAAU,EAE3D,CAACD,CAAM,CAClB,EACWK,GAAgB,SAAUC,EAASL,EAAY,CACtD,OAAOK,EAAQ,OAAO,SAAUJ,EAAKF,EAAQ,CACzC,IAAIlB,EACAyB,EAAyBR,GAA2BC,EAAQC,CAAU,EACtEO,GAAwB1B,EAAK,IAAI,OAAO,MAAMA,EAAIyB,EAAuB,IAAI,SAAU/C,EAAM,CAAE,OAAO4C,GAAwB5C,EAAMyC,CAAU,CAAG,CAAC,CAAC,EACvJ,OAAOC,EAAI,OAEXM,EAEAR,EAAO,WACD7C,GAAQ6C,EAAO,WAAW,iBAAiBH,EAAc,CAAC,EAAE,OAAO,SAAUrC,EAAM,CAAE,OAAOA,IAASwC,CAAQ,CAAC,EAC9G,EAAE,CACZ,EAAG,EAAE,CACT,EAKWS,GAA0B,SAAUT,EAAQ,CACnD,IAAIU,EAAcV,EAAO,iBAAiB,IAAI,OAAO9L,GAAY,GAAG,CAAC,EACrE,OAAOiJ,GAAQuD,CAAW,EACrB,IAAI,SAAUlD,EAAM,CAAE,OAAO6C,GAAc,CAAC7C,CAAI,CAAC,CAAG,CAAC,EACrD,OAAO,SAAU0C,EAAKV,EAAO,CAAE,OAAOU,EAAI,OAAOV,CAAK,CAAG,EAAG,EAAE,CACvE,EChCWmB,GAAkB,SAAUnB,EAAOxB,EAAiB,CAC3D,OAAOb,GAAQqC,CAAK,EACf,OAAO,SAAUhC,EAAM,CAAE,OAAOO,GAAgBC,EAAiBR,CAAI,CAAG,CAAC,EACzE,OAAO,SAAUA,EAAM,CAAE,OAAOmB,GAAenB,CAAI,CAAG,CAAC,CAChE,EACWoD,GAAsB,SAAUpB,EAAOlB,EAAO,CACrD,OAAIA,IAAU,SAAUA,EAAQ,IAAI,KAC7BnB,GAAQqC,CAAK,EAAE,OAAO,SAAUhC,EAAM,CAAE,OAAOa,GAAyBC,EAAOd,CAAI,CAAG,CAAC,CAClG,EAUWqD,GAAmB,SAAUC,EAAU9C,EAAiBiC,EAAY,CAC3E,OAAOV,GAAgBoB,GAAgBN,GAAcS,EAAUb,CAAU,EAAGjC,CAAe,EAAG,GAAMiC,CAAU,CAClH,EAYWc,GAAoB,SAAUD,EAAU9C,EAAiB,CAChE,OAAOuB,GAAgBoB,GAAgBN,GAAcS,CAAQ,EAAG9C,CAAe,EAAG,EAAK,CAC3F,EAMWgD,GAAuB,SAAUC,EAASjD,EAAiB,CAClE,OAAO2C,GAAgBF,GAAwBQ,CAAO,EAAGjD,CAAe,CAC5E,EAIWkD,GAAW,SAAUC,EAAOC,EAAS,CAC5C,OAAID,EAAM,WACCD,GAASC,EAAM,WAAYC,CAAO,EAGrC,OAAO,eAAeD,CAAK,EAAE,WAAa,QAC1C,OAAO,eAAeA,CAAK,EAAE,SAAS,KAAKA,EAAOC,CAAO,EAClD,GAEJjE,GAAQgE,EAAM,QAAQ,EAAE,KAAK,SAAUhB,EAAO,CACjD,IAAIrB,EACJ,GAAIqB,aAAiB,kBAAmB,CACpC,IAAIkB,GAAcvC,EAAKqB,EAAM,mBAAqB,MAAQrB,IAAO,OAAS,OAASA,EAAG,KACtF,OAAIuC,EACOH,GAASG,EAAYD,CAAO,EAEhC,EACX,CACA,OAAOF,GAASf,EAAOiB,CAAO,CAClC,CAAC,CAET,ECnEIE,GAAe,SAAU9B,EAAO,CAGhC,QAFI+B,EAAY,IAAI,IAChB3O,EAAI4M,EAAM,OACL7J,EAAI,EAAGA,EAAI/C,EAAG+C,GAAK,EACxB,QAAS6L,EAAI7L,EAAI,EAAG6L,EAAI5O,EAAG4O,GAAK,EAAG,CAC/B,IAAIC,EAAWjC,EAAM7J,CAAC,EAAE,wBAAwB6J,EAAMgC,CAAC,CAAC,GAEnDC,EAAW,KAAK,gCAAkC,GACnDF,EAAU,IAAIC,CAAC,GAEdC,EAAW,KAAK,4BAA8B,GAC/CF,EAAU,IAAI5L,CAAC,CAGvB,CAEJ,OAAO6J,EAAM,OAAO,SAAUkC,EAAGzE,EAAO,CAAE,MAAO,CAACsE,EAAU,IAAItE,CAAK,CAAG,CAAC,CAC7E,EAMI0E,GAAe,SAAUnE,EAAM,CAC/B,OAAOA,EAAK,WAAamE,GAAanE,EAAK,UAAU,EAAIA,CAC7D,EAMWoE,GAAsB,SAAUpE,EAAM,CAC7C,IAAIgC,EAAQnC,GAAQG,CAAI,EACxB,OAAOgC,EAAM,OAAO,OAAO,EAAE,OAAO,SAAUU,EAAK2B,EAAa,CAC5D,IAAI3I,EAAQ2I,EAAY,aAAa9N,EAAW,EAChD,OAAAmM,EAAI,KAAK,MAAMA,EAAMhH,EACfoI,GAAanE,GAAQwE,GAAaE,CAAW,EAAE,iBAAiB,IAAI,OAAO9N,GAAa,IAAK,EAAE,OAAOmF,EAAO,UAAW,EAAE,OAAOlF,GAAgB,eAAiB,CAAC,CAAC,CAAC,EACrK,CAAC6N,CAAW,CAAC,EACZ3B,CACX,EAAG,EAAE,CACT,ECjDW4B,GAAY,SAAUxL,EAAI,CACjC,GAAI,CACA,OAAOA,EAAE,CACb,MACU,CACN,MACJ,CACJ,ECCWyL,GAAmB,SAAUC,EAAY,CAEhD,GADIA,IAAe,SAAUA,EAAa,UACtC,GAACA,GAAc,CAACA,EAAW,eAG/B,KAAIxH,EAAgBwH,EAAW,cAC/B,OAAQxH,EAAc,WAChBuH,GAAiBvH,EAAc,UAAU,EACzCA,aAAyB,mBAAqBsH,GAAU,UAAY,CAAE,OAAOtH,EAAc,cAAc,QAAU,CAAC,EAChHuH,GAAiBvH,EAAc,cAAc,QAAQ,EACrDA,EACd,ECfIyH,GAAe,SAAUC,EAAO1H,EAAe,CAAE,OAAO0H,IAAU1H,CAAe,EACjF2H,GAAoB,SAAUlB,EAASzG,EAAe,CACtD,MAAO,EAAQ2C,GAAQ8D,EAAQ,iBAAiB,QAAQ,CAAC,EAAE,KAAK,SAAUzD,EAAM,CAAE,OAAOyE,GAAazE,EAAMhD,CAAa,CAAG,CAAC,CACjI,EAKW4H,GAAc,SAAUnB,EAASzG,EAAe,CAGvD,OADIA,IAAkB,SAAUA,EAAgBuH,GAAiBzE,GAAS2D,CAAO,EAAE,aAAa,GAC5F,CAACzG,GAAkBA,EAAc,SAAWA,EAAc,QAAQ,WAC3D,GAEJoH,GAAoBX,CAAO,EAAE,KAAK,SAAUzD,EAAM,CACrD,OAAO0D,GAAS1D,EAAMhD,CAAa,GAAK2H,GAAkB3E,EAAMhD,CAAa,CACjF,CAAC,CACL,ECTW6H,GAAgB,SAAUL,EAAY,CACzCA,IAAe,SAAUA,EAAa,UAC1C,IAAIxH,EAAgBuH,GAAiBC,CAAU,EAC/C,OAAKxH,EAIE2C,GAAQ6E,EAAW,iBAAiB,IAAI,OAAO/N,GAAa,GAAG,CAAC,CAAC,EAAE,KAAK,SAAUuJ,EAAM,CAAE,OAAO0D,GAAS1D,EAAMhD,CAAa,CAAG,CAAC,EAH7H,EAIf,ECnBI8H,GAAoB,SAAU9E,EAAMgC,EAAO,CAC3C,OAAOA,EACF,OAAOd,EAAc,EACrB,OAAO,SAAU6D,EAAI,CAAE,OAAOA,EAAG,OAAS/E,EAAK,IAAM,CAAC,EACtD,OAAO,SAAU+E,EAAI,CAAE,OAAOA,EAAG,OAAS,CAAC,EAAE,CAAC,GAAK/E,CAC5D,EACWgF,GAAc,SAAUhF,EAAMgC,EAAO,CAC5C,OAAId,GAAelB,CAAI,GAAKA,EAAK,KACtB8E,GAAkB9E,EAAMgC,CAAK,EAEjChC,CACX,EAKWiF,GAAe,SAAUjD,EAAO,CAEvC,IAAIkD,EAAY,IAAI,IACpB,OAAAlD,EAAM,QAAQ,SAAUhC,EAAM,CAAE,OAAOkF,EAAU,IAAIF,GAAYhF,EAAMgC,CAAK,CAAC,CAAG,CAAC,EAE1EA,EAAM,OAAO,SAAUhC,EAAM,CAAE,OAAOkF,EAAU,IAAIlF,CAAI,CAAG,CAAC,CACvE,ECtBWmF,GAAiB,SAAUnD,EAAO,CACzC,OAAIA,EAAM,CAAC,GAAKA,EAAM,OAAS,EACpBgD,GAAYhD,EAAM,CAAC,EAAGA,CAAK,EAE/BA,EAAM,CAAC,CAClB,EACWoD,GAAgB,SAAUpD,EAAOhC,EAAM,CAC9C,OAAOgC,EAAM,QAAQgD,GAAYhF,EAAMgC,CAAK,CAAC,CACjD,ECNWqD,GAAY,YAUZC,GAAW,SAAUC,EAAYC,EAAgBC,EAAYzI,EAAe0I,EAAU,CAC7F,IAAIC,EAAMJ,EAAW,OACjBK,EAAaL,EAAW,CAAC,EACzBM,EAAYN,EAAWI,EAAM,CAAC,EAC9BG,EAAYzE,GAAQrE,CAAa,EAErC,GAAI,EAAAA,GAAiBuI,EAAW,QAAQvI,CAAa,GAAK,GAG1D,KAAI+I,EAAc/I,IAAkB,OAAYyI,EAAW,QAAQzI,CAAa,EAAI,GAChFgJ,EAAYN,EAAWD,EAAW,QAAQC,CAAQ,EAAIK,EACtDE,EAAiBP,EAAWH,EAAW,QAAQG,CAAQ,EAAI,GAE/D,GAAIK,IAAgB,GAEhB,OAAIE,IAAmB,GACZA,EAEJZ,GAGX,GAAIY,IAAmB,GACnB,OAAOZ,GAEX,IAAIxD,EAAYkE,EAAcC,EAC1BE,EAAiBT,EAAW,QAAQG,CAAU,EAC9CO,EAAgBV,EAAW,QAAQI,CAAS,EAC5CO,EAAiBnB,GAAaQ,CAAU,EACxCY,EAAwBrJ,IAAkB,OAAYoJ,EAAe,QAAQpJ,CAAa,EAAI,GAC9FsJ,EAAyBZ,EAAWU,EAAe,QAAQV,CAAQ,EAAIW,EACvEE,EAAgBH,EAAe,OAAO,SAAUpG,EAAM,CAAE,OAAOA,EAAK,UAAY,CAAG,CAAC,EACpFwG,EAAuBxJ,IAAkB,OAAYuJ,EAAc,QAAQvJ,CAAa,EAAI,GAC5FyJ,EAAwBf,EAAWa,EAAc,QAAQb,CAAQ,EAAIc,EACrEE,EAAiBF,GAAwB,GAAKC,GAAyB,EAEnEA,EAAwBD,EAExBF,EAAyBD,EAMjC,GAJI,CAACxE,GAAaoE,GAAkB,GAIhCT,EAAe,SAAW,EAI1B,OAAOS,EAEX,IAAIU,EAAkBvB,GAAcG,EAAYC,EAAe,CAAC,CAAC,EAC7DoB,EAAiBxB,GAAcG,EAAYC,EAAeA,EAAe,OAAS,CAAC,CAAC,EAExF,GAAIO,GAAeG,GAAkBJ,GAAa,KAAK,IAAIjE,CAAS,EAAI,EACpE,OAAO+E,EAGX,GAAIb,GAAeI,GAAiBL,GAAa,KAAK,IAAIjE,CAAS,EAAI,EACnE,OAAO8E,EAGX,GAAI9E,GAAa,KAAK,IAAI6E,CAAc,EAAI,EACxC,OAAOT,EAGX,GAAIF,GAAeG,EACf,OAAOU,EAGX,GAAIb,EAAcI,EACd,OAAOQ,EAGX,GAAI9E,EACA,OAAI,KAAK,IAAIA,CAAS,EAAI,EACfoE,GAEHN,EAAMM,EAAiBpE,GAAa8D,EAIpD,EC1FIkB,GAAkB,SAAUC,EAAgB,CAC5C,OAAO,SAAU9G,EAAM,CACnB,IAAIsB,EACAyF,GAAazF,EAAKP,GAAWf,CAAI,KAAO,MAAQsB,IAAO,OAAS,OAASA,EAAG,UAChF,OAEAtB,EAAK,WAEA+G,IAAc,QAAaA,IAAc,SAE1CD,EAAe,QAAQ9G,CAAI,GAAK,CACxC,CACJ,EACWgH,GAAgB,SAAUC,EAAcC,EAAcC,EAAQ,CACrE,IAAInF,EAAQiF,EAAa,IAAI,SAAU3F,EAAI,CACvC,IAAItB,EAAOsB,EAAG,KACd,OAAOtB,CACX,CAAC,EACGoH,EAAgBhE,GAAoBpB,EAAM,OAAO6E,GAAgBM,CAAM,CAAC,CAAC,EAC7E,OAAIC,GAAiBA,EAAc,OACxBjC,GAAeiC,CAAa,EAEhCjC,GAAe/B,GAAoB8D,CAAY,CAAC,CAC3D,ECvBIG,GAAa,SAAUrH,EAAM8C,EAAS,CACtC,OAAIA,IAAY,SAAUA,EAAU,IACpCA,EAAQ,KAAK9C,CAAI,EACbA,EAAK,YACLqH,GAAWrH,EAAK,WAAW,MAAQA,EAAK,WAAY8C,CAAO,EAExDA,CACX,EAOWwE,GAAkB,SAAUC,EAAOC,EAAO,CAIjD,QAHIC,EAAWJ,GAAWE,CAAK,EAC3BG,EAAWL,GAAWG,CAAK,EAEtBrP,EAAI,EAAGA,EAAIsP,EAAS,OAAQtP,GAAK,EAAG,CACzC,IAAIwP,EAAgBF,EAAStP,CAAC,EAC9B,GAAIuP,EAAS,QAAQC,CAAa,GAAK,EACnC,OAAOA,CAEf,CACA,MAAO,EACX,EACWC,GAAqB,SAAUC,EAAmBC,EAAWC,EAAc,CAClF,IAAIC,EAAiBnI,GAAQgI,CAAiB,EAC1CI,EAAcpI,GAAQiI,CAAS,EAC/B9K,EAAgBgL,EAAe,CAAC,EAChCE,EAAY,GAChB,OAAAD,EAAY,OAAO,OAAO,EAAE,QAAQ,SAAUE,EAAO,CACjDD,EAAYZ,GAAgBY,GAAaC,EAAOA,CAAK,GAAKD,EAC1DH,EAAa,OAAO,OAAO,EAAE,QAAQ,SAAUK,EAAU,CACrD,IAAIC,EAASf,GAAgBtK,EAAeoL,CAAQ,EAChDC,IACI,CAACH,GAAaxE,GAAS2E,EAAQH,CAAS,EACxCA,EAAYG,EAGZH,EAAYZ,GAAgBe,EAAQH,CAAS,EAGzD,CAAC,CACL,CAAC,EAEMA,CACX,EAMWI,GAA0B,SAAUC,EAAS/H,EAAiB,CACrE,OAAO+H,EAAQ,OAAO,SAAU7F,EAAK1C,EAAM,CAAE,OAAO0C,EAAI,OAAOc,GAAqBxD,EAAMQ,CAAe,CAAC,CAAG,EAAG,EAAE,CACtH,EClDIgI,GAAe,SAAUC,EAAUC,EAAU,CAC7C,IAAIC,EAAQ,IAAI,IAEhB,OAAAD,EAAS,QAAQ,SAAUE,EAAQ,CAAE,OAAOD,EAAM,IAAIC,EAAO,KAAMA,CAAM,CAAG,CAAC,EAEtEH,EAAS,IAAI,SAAUzI,EAAM,CAAE,OAAO2I,EAAM,IAAI3I,CAAI,CAAG,CAAC,EAAE,OAAOwB,EAAS,CACrF,EAWWqH,GAAc,SAAUpF,EAASiC,EAAU,CAClD,IAAI1I,EAAgBuH,GAAiB1E,GAAQ4D,CAAO,EAAE,OAAS,EAAI,SAAW3D,GAAS2D,CAAO,EAAE,aAAa,EACzG8E,EAAUnE,GAAoBX,CAAO,EAAE,OAAOlC,EAAW,EACzDuH,EAAelB,GAAmB5K,GAAiByG,EAASA,EAAS8E,CAAO,EAC5E/H,EAAkB,IAAI,IACtBuI,EAAexF,GAAkBgF,EAAS/H,CAAe,EACzDwI,EAAgBD,EAAa,OAAO,SAAUzH,EAAI,CAClD,IAAItB,EAAOsB,EAAG,KACd,OAAOC,GAAYvB,CAAI,CAC3B,CAAC,EACD,GAAKgJ,EAAc,CAAC,EAGpB,KAAIvD,EAAalC,GAAkB,CAACuF,CAAY,EAAGtI,CAAe,EAAE,IAAI,SAAUc,EAAI,CAClF,IAAItB,EAAOsB,EAAG,KACd,OAAOtB,CACX,CAAC,EACGiJ,EAAuBT,GAAa/C,EAAYuD,CAAa,EAE7DE,EAAkBD,EAAqB,IAAI,SAAU3H,EAAI,CACzD,IAAItB,EAAOsB,EAAG,KACd,OAAOtB,CACX,CAAC,EACGmJ,EAAgBF,EAAqB,OAAO,SAAU3H,EAAI,CAC1D,IAAIa,EAAWb,EAAG,SAClB,OAAOa,GAAY,CACvB,CAAC,EAAE,IAAI,SAAUb,EAAI,CACjB,IAAItB,EAAOsB,EAAG,KACd,OAAOtB,CACX,CAAC,EACGoJ,EAAQ9D,GAAS4D,EAAiBC,EAAe1D,EAAYzI,EAAe0I,CAAQ,EACxF,GAAI0D,IAAU/D,GAAW,CACrB,IAAIgE,EAEJrC,GAAc+B,EAAcI,EAAeb,GAAwBC,EAAS/H,CAAe,CAAC,GACxFwG,GAAc+B,EAAcG,EAAiBZ,GAAwBC,EAAS/H,CAAe,CAAC,EAClG,GAAI6I,EACA,MAAO,CAAE,KAAMA,CAAS,EAGxB,QAAQ,KAAK,qDAAqD,EAClE,MAER,CACA,OAAID,IAAU,OACHA,EAEJH,EAAqBG,CAAK,EACrC,EC9DWE,GAAuB,SAAU7F,EAAS,CACjD,IAAI8E,EAAUnE,GAAoBX,CAAO,EAAE,OAAOlC,EAAW,EACzDuH,EAAelB,GAAmBnE,EAASA,EAAS8E,CAAO,EAC3D9C,EAAa1D,GAAgBc,GAAc,CAACiG,CAAY,EAAG,EAAI,EAAG,GAAM,EAAI,EAC5EE,EAAgBnG,GAAc0F,EAAS,EAAK,EAChD,OAAO9C,EAAW,IAAI,SAAUnE,EAAI,CAChC,IAAItB,EAAOsB,EAAG,KAAM7B,EAAQ6B,EAAG,MAC/B,MAAQ,CACJ,KAAMtB,EACN,MAAOP,EACP,SAAUuJ,EAAc,QAAQhJ,CAAI,GAAK,EACzC,MAAOqB,GAAQrB,CAAI,CAC/B,CACI,CAAC,CACL,ECzBWuJ,GAAU,SAAU9P,EAAQ8C,EAAc,CAC5C9C,IAID,UAAWA,GACXA,EAAO,MAAM8C,CAAY,EAEzB,kBAAmB9C,GAAUA,EAAO,eACpCA,EAAO,cAAc,MAAK,EAElC,ECTI+P,GAAa,EACbC,GAAe,GAaRC,GAAkB,SAAUjG,EAASiC,EAAUpM,EAAS,CAC3DA,IAAY,SAAUA,EAAU,IACpC,IAAIqQ,EAAYd,GAAYpF,EAASiC,CAAQ,EAE7C,GAAI,CAAA+D,IAGAE,EAAW,CAEX,GAAIH,GAAa,EAAG,CAEhB,QAAQ,MAAM,mJACmD,EACjEC,GAAe,GACf,WAAW,UAAY,CACnBA,GAAe,EACnB,EAAG,CAAC,EACJ,MACJ,CACAD,KACAD,GAAQI,EAAU,KAAMrQ,EAAQ,YAAY,EAC5CkQ,IACJ,CACJ,ECtCA,SAASI,GAAQ9S,EAAO,CACpB,GAAI,CAACA,EACD,OAAO,KAGX,GAAI,OAAO,QAAY,IACnB,OAAO,UAAY,CAAE,OAAOA,GAAS,IAAM,EAE/C,IAAI+S,EAAI/S,EAAQ,IAAI,QAAQA,CAAK,EAAI,KACrC,OAAO,UAAY,CAAE,OAA8C+S,GAAE,SAAY,IAAM,CAC3F,CACO,IAAIC,GAAwB,SAAUlG,EAAS,CAClD,GAAI,CAACA,EACD,OAAO,KAIX,QAFImG,EAAQ,GACRC,EAAiBpG,EACdoG,GAAkBA,IAAmB,SAAS,MACjDD,EAAM,KAAK,CACP,QAASH,GAAQI,CAAc,EAC/B,OAAQJ,GAAQI,EAAe,aAAa,EAC5C,KAAMJ,GAAQI,EAAe,sBAAsB,EACnD,MAAOJ,GAAQI,EAAe,kBAAkB,CAC5D,CAAS,EACDA,EAAiBA,EAAe,cAEpC,MAAO,CACH,QAASJ,GAAQhG,CAAO,EACxB,MAAOmG,EACP,cAAenG,EAAQ,aAC/B,CACA,EACIqG,GAAiB,SAAUC,EAAU,CACrC,IAAI5I,EAAI6I,EAAIC,EAAIC,EAAIC,EACpB,GAAKJ,EAKL,QAFIH,EAAQG,EAAS,MAAOK,EAAgBL,EAAS,cACjD1J,EAAkB,IAAI,IACjBgK,EAAK,EAAGC,EAAUV,EAAOS,EAAKC,EAAQ,OAAQD,IAAM,CACzD,IAAIE,EAAOD,EAAQD,CAAE,EACjBG,GAAYrJ,EAAKoJ,EAAK,UAAY,MAAQpJ,IAAO,OAAS,OAASA,EAAG,KAAKoJ,CAAI,EAEnF,GAAIC,GAAYJ,EAAc,SAASI,CAAQ,EAAG,CAe9C,QAdIC,GAAQT,EAAKO,EAAK,QAAU,MAAQP,IAAO,OAAS,OAASA,EAAG,KAAKO,CAAI,EACzEG,EAAeH,EAAK,QAAO,EAC3BI,EAAUH,EAAS,SAASE,CAAY,EAAIA,EAAe,OAC3DE,GAASX,EAAKM,EAAK,SAAW,MAAQN,IAAO,OAAS,OAASA,EAAG,KAAKM,CAAI,EAC3EM,EAAa3H,GAAiB,CAACsH,CAAQ,EAAGnK,CAAe,EACzDyK,GAEHX,GAAMD,EAAKS,GAEgCF,GAAK,sBAAwB,MAAQP,IAAO,OAASA,EAEjGU,KAAW,MAAQT,IAAO,OAASA,EAEnCM,EACOK,GAAK,CACR,QAASC,EAAK,EAAGC,EAAeH,EAAYE,EAAKC,EAAa,OAAQD,IAAM,CACxE,IAAIvB,EAAYwB,EAAaD,CAAE,EAC/B,GAA8CD,GAAI,SAAStB,EAAU,IAAI,EACrE,OAAOA,EAAU,IAEzB,CACAsB,EAAMA,EAAI,kBACd,CACA,GAAID,EAAW,OAEX,OAAOA,EAAW,CAAC,EAAE,IAE7B,CACJ,CAGJ,EAQWlO,GAAsB,SAAUsO,EAAe,CACtD,IAAIlB,EAAWJ,GAAsBsB,CAAa,EAClD,OAAO,UAAY,CACf,OAAOnB,GAAeC,CAAQ,CAClC,CACJ,EC/EWmB,GAAuB,SAAUzH,EAASD,EAAO2H,EAAc,CACtE,GAAI,CAAC1H,GAAW,CAACD,EACb,eAAQ,MAAM,2BAA2B,EAClC,GAEX,IAAI5H,EAAS8D,GAAQ8D,CAAK,EAC1B,GAAI5H,EAAO,MAAM,SAAUwP,EAAO,CAAE,MAAO,CAAC7H,GAAS6H,EAAO3H,CAAO,CAAG,CAAC,EACnE,eAAQ,MAAM,8CAA8C,EACrD,GAEX,IAAIoH,EAAaM,EACXjI,GAAiBtH,EAAQ,IAAI,GAAK,EAClCwH,GAAkBxH,EAAQ,IAAI,GAAK,EACrC+O,EAAUE,EAAW,UAAU,SAAU1J,EAAI,CAC7C,IAAItB,EAAOsB,EAAG,KACd,OAAOtB,IAAS4D,CACpB,CAAC,EACD,GAAIkH,IAAY,GAIhB,MAAO,CACH,KAAME,EAAWF,EAAU,CAAC,EAC5B,KAAME,EAAWF,EAAU,CAAC,EAC5B,MAAOE,EAAW,CAAC,EACnB,KAAMA,EAAWA,EAAW,OAAS,CAAC,CAC9C,CACA,EACIQ,GAAc,SAAUzP,EAAQuP,EAAc,CAC9C,IAAIG,EAAMH,EACJjI,GAAiBxD,GAAQ9D,CAAM,EAAG,IAAI,GAAK,EAC3CwH,GAAkB1D,GAAQ9D,CAAM,EAAG,IAAI,GAAK,EAClD,MAAO,CACH,MAAO0P,EAAI,CAAC,EACZ,KAAMA,EAAIA,EAAI,OAAS,CAAC,CAChC,CACA,EACIC,GAAiB,SAAUpS,EAAS,CACpC,OAAO,OAAO,OAAO,CACjB,MAAO,SAAS,KAChB,MAAO,GACP,aAAc,EACtB,EAAOA,CAAO,CACd,EACIqS,GAAY,SAAUC,EAAatS,EAASR,EAAI,CAC5CQ,IAAY,SAAUA,EAAU,IACpC,IAAIuS,EAAaH,GAAepS,CAAO,EACnCwS,EAAWT,GAAqBO,EAAaC,EAAW,MAAOA,EAAW,YAAY,EAC1F,GAAKC,EAGL,KAAIrS,EAASX,EAAGgT,EAAUD,EAAW,KAAK,EACtCpS,GACA8P,GAAQ9P,EAAO,KAAMoS,EAAW,YAAY,EAEpD,EAMWE,GAAmB,SAAUH,EAAatS,EAAS,CACtDA,IAAY,SAAUA,EAAU,IACpCqS,GAAUC,EAAatS,EAAS,SAAUgI,EAAIpI,EAAO,CACjD,IAAI8S,EAAO1K,EAAG,KAAM2K,EAAQ3K,EAAG,MAC/B,OAAO0K,GAAS9S,GAAS+S,CAC7B,CAAC,CACL,EAMWC,GAAmB,SAAUN,EAAatS,EAAS,CACtDA,IAAY,SAAUA,EAAU,IACpCqS,GAAUC,EAAatS,EAAS,SAAUgI,EAAIpI,EAAO,CACjD,IAAIiT,EAAO7K,EAAG,KAAMnK,EAAOmK,EAAG,KAC9B,OAAO6K,GAASjT,GAAS/B,CAC7B,CAAC,CACL,EACIiV,GAAe,SAAUzI,EAAOrK,EAAS+S,EAAM,CAC/C,IAAI/K,EACAgL,EAAWd,GAAY7H,GAAQrC,EAAKhI,EAAQ,gBAAkB,MAAQgI,IAAO,OAASA,EAAK,EAAI,EAC/FtB,EAAOsM,EAASD,CAAI,EACpBrM,GACAuJ,GAAQvJ,EAAK,KAAM1G,EAAQ,YAAY,CAE/C,EAKWiT,GAAoB,SAAU5I,EAAOrK,EAAS,CACjDA,IAAY,SAAUA,EAAU,IACpC8S,GAAazI,EAAOrK,EAAS,OAAO,CACxC,EAKWkT,GAAmB,SAAU7I,EAAOrK,EAAS,CAChDA,IAAY,SAAUA,EAAU,IACpC8S,GAAazI,EAAOrK,EAAS,MAAM,CACvC,ECjHO,SAASmT,GAAYC,EAAQ,CAClC,WAAWA,EAAQ,CAAC,CACtB,CAMO,IAAIC,GAAa,SAAoB9V,EAAK,CAC/C,OAAOA,GAAO,YAAaA,EAAMA,EAAI,QAAUA,CACjD,ECJI+V,GAAc,UAAuB,CACvC,OAAO,UAAY,SAAS,gBAAkB,SAAS,IACzD,EACIC,GAAc,UAAuB,CACvC,OAAOD,GAAA,GAAiB/H,GAAA,CAC1B,EACIiI,GAAiB,KACjBC,GAAkB,KAClBC,GAAkB,UAA2B,CAC/C,OAAO,IACT,EACIC,GAAsB,KACtBC,GAAwB,GACxBC,GAAgB,GAChBC,GAAmB,UAA4B,CACjD,MAAO,EACT,EACIC,GAAmB,SAA0BrQ,EAAe,CAC9D,OAAQ8P,GAAe,WAAaM,IAAkBpQ,CAAa,CACrE,EACIsQ,GAAe,SAAsBC,EAAcC,EAAiB,CACtEP,GAAsB,CACpB,aAAAM,EACA,gBAAAC,CAAA,CAEJ,EACIC,GAAsB,SAA6B7J,EAAS,CAC9D,OAAOqJ,IAAuBA,GAAoB,kBAAoBrJ,CACxE,EACA,SAAS8J,GAAUC,EAAYC,EAAKC,EAAMC,EAAU,CAClD,IAAIC,EAAY,KACZ5V,EAAIwV,EACR,EAAG,CACD,IAAI/U,EAAOkV,EAAS3V,CAAC,EACrB,GAAIS,EAAK,MACHA,EAAK,KAAK,QAAQ,iBACpBmV,EAAYnV,WAELA,EAAK,SAAU,CACxB,GAAIT,IAAMwV,EACR,OAEFI,EAAY,IACd,KACE,MAEJ,QAAU5V,GAAK0V,KAAUD,GACrBG,IACFA,EAAU,KAAK,SAAW,EAE9B,CACA,IAAIC,GAAkB,SAAyBC,EAAkB,CAC/D,OAAIA,EACK,EAAQf,GAEVA,KAA0B,WACnC,EACIgB,GAAc,SAASA,EAAYC,EAAOpJ,EAAIuH,EAAU,CAC1D,OAAOvH,IAAOA,EAAG,OAASoJ,IAAU,CAACpJ,EAAG,eAAiBuH,EAAS,SAASvH,EAAG,aAAa,IAAMA,EAAG,YAAcmJ,EAAYC,EAAOpJ,EAAG,WAAYuH,CAAQ,EAC9J,EACI8B,GAAa,SAAoBpR,EAAeqR,EAAa,CAC/D,OAAOA,EAAY,KAAK,SAAUC,EAAM,CACtC,OAAOJ,GAAYlR,EAAesR,EAAMA,CAAI,CAC9C,CAAC,CACH,EACIC,GAAoB,SAA2BvM,EAAO,CACxD,OAAOuB,GAAkBvB,EAAO,IAAI,GAAK,CAC3C,EACIwM,GAAiB,SAAwBxO,EAAM,CACjD,MAAO,CAACuO,GAAkB,CAACvO,EAAK,UAAU,CAAC,EAAE,KAAK,SAAU+E,EAAI,CAC9D,OAAOA,EAAG,OAAS/E,CACrB,CAAC,CACH,EACIyO,GAAe,UAAwB,CACzC,IAAI/N,EAAS,GACb,GAAIoM,GAAgB,CAClB,IAAI4B,EAAkB5B,GACpBrS,EAAWiU,EAAgB,SAC3BrT,EAAkBqT,EAAgB,gBAClCjT,EAAYiT,EAAgB,UAC5B3S,EAAS2S,EAAgB,OACzBnT,EAAamT,EAAgB,WAC7BnS,EAAemS,EAAgB,aAC/BvT,EAAgBuT,EAAgB,cAC9BC,EAAclU,GAAYwS,IAAuBA,GAAoB,gBACzE,GAAIL,GAAA,GAAiBG,IAAmBA,KAAoB,SAAS,OAC/D,CAAC,SAAS,KAAK,SAASA,EAAe,GAAKyB,GAAezB,EAAe,GAAG,CAC/E,IAAI6B,EAAY5B,GAAA,EACZ4B,GACFA,EAAU,OAEd,CAEF,IAAI5R,EAAgB,UAAY,SAAS,cACzC,GAAI2R,EAAa,CACf,IAAIN,EAAc,CAACM,CAAW,EAAE,OAAO5S,EAAO,IAAI4Q,EAAU,EAAE,OAAO,OAAO,CAAC,EACzEkC,EAA0B,UAAmC,CAC/D,GAAI,CAACb,GAAgBzS,CAAU,GAAK,CAACJ,GAAiB,CAAC4R,IAAmBI,GACxE,MAAO,GAET,IAAInL,EAAQuM,GAAkBF,CAAW,EACrCrI,EAAYhE,EAAM,UAAU,SAAUxI,EAAM,CAC9C,IAAIwG,EAAOxG,EAAK,KAChB,OAAOwG,IAAS+M,EAClB,CAAC,EACD,OAAO/G,IAAc,GAAKA,IAAchE,EAAM,OAAS,CACzD,EAuBA,IAtBI,CAAChF,GAAiBqQ,GAAiBrQ,CAAa,KAC9C3B,GAAmBwT,KAA6B,CAAChC,MAAiB,CAACE,IAAmBtR,KACpFkT,GAAe,EAAE/J,GAAYyJ,CAAW,GAAKrR,GAAiBoR,GAAWpR,EAAeqR,CAAW,GAAKZ,GAAoBzQ,CAA0B,KACpJ,UAAY,CAAC+P,IAAmB/P,GAAiB,CAACvB,GAChDuB,EAAc,MAChBA,EAAc,OAEhB,SAAS,KAAK,UAEd0D,EAASgJ,GAAgB2E,EAAatB,GAAiB,CACrD,aAAAxQ,CAAA,CACD,EACD0Q,GAAsB,KAG1BF,GAAkB,UAAY,SAAS,cACnCA,KAAoB,SAAS,OAC/BC,GAAkBlQ,GAAoBiQ,EAAe,GAEvDG,GAAwB,IAGxB,UAAYlQ,IAAkB,SAAS,eAAiB,SAAS,cAAc,yBAAyB,EAAG,CAC7G,IAAI8R,EAAmB,UAAY,SAAS,cACxChB,EAAWxE,GAAqB+E,CAAW,EAC3CU,EAAejB,EAAS,IAAI,SAAUkB,EAAO,CAC/C,IAAIhP,EAAOgP,EAAM,KACjB,OAAOhP,CACT,CAAC,EAAE,QAAQ8O,CAAgB,EACvBC,EAAe,KACjBjB,EAAS,OAAO,SAAUmB,EAAO,CAC/B,IAAIC,EAAQD,EAAM,MAChBjP,EAAOiP,EAAM,KACf,OAAOC,GAASlP,EAAK,QAAQ,cAC/B,CAAC,EAAE,QAAQ,SAAUmP,EAAO,CAC1B,IAAInP,EAAOmP,EAAM,KACjB,OAAOnP,EAAK,gBAAgB,UAAU,CACxC,CAAC,EACD0N,GAAUqB,EAAcjB,EAAS,OAAQ,EAAIA,CAAQ,EACrDJ,GAAUqB,EAAc,GAAI,GAAIjB,CAAQ,EAE5C,CACF,CACF,CACA,OAAOpN,CACT,EACI0O,GAAS,SAAgB3R,EAAO,CAC9BgR,GAAA,GAAkBhR,IACpBA,EAAM,kBACNA,EAAM,iBAEV,EACIC,GAAS,UAAkB,CAC7B,OAAO+O,GAAYgC,EAAY,CACjC,EACIjR,GAAU,SAAiBC,EAAO,CACpC,IAAI4R,EAAS5R,EAAM,OACf4G,EAAc5G,EAAM,cACnB4G,EAAY,SAASgL,CAAM,GAC9B/B,GAAajJ,EAAagL,CAAM,CAEpC,EACIC,GAAe,UAAwB,CACzC,OAAO,IACT,EAWIC,GAAgB,UAAyB,CAC3CpC,GAAgB,EAClB,EACIqC,GAAe,UAAwB,CACzCrC,GAAgB,GAChBD,GAAwB,OACxBT,GAAY,UAAY,CACtBS,GAAwB,WAC1B,CAAC,CACH,EACIuC,GAAgB,UAAyB,CAC3C,SAAS,iBAAiB,UAAWL,EAAM,EAC3C,SAAS,iBAAiB,WAAY1R,EAAM,EAC5C,OAAO,iBAAiB,QAAS6R,EAAa,EAC9C,OAAO,iBAAiB,OAAQC,EAAY,CAC9C,EACIE,GAAgB,UAAyB,CAC3C,SAAS,oBAAoB,UAAWN,EAAM,EAC9C,SAAS,oBAAoB,WAAY1R,EAAM,EAC/C,OAAO,oBAAoB,QAAS6R,EAAa,EACjD,OAAO,oBAAoB,OAAQC,EAAY,CACjD,EACA,SAAS1Q,GAAmB6Q,EAAW,CACrC,OAAOA,EAAU,OAAO,SAAUC,EAAO,CACvC,IAAI3U,EAAW2U,EAAM,SACrB,MAAO,CAAC3U,CACV,CAAC,CACH,CACA,IAAI4U,GAAe,CACjB,gBAAAnG,GACA,YAAA9E,GACA,iBAAAmH,GACA,iBAAAG,GACA,kBAAAK,GACA,iBAAAC,GACA,oBAAA1P,EACF,EACA,SAASiC,GAA0B+Q,EAAO,CACxC,IAAIC,EAAOD,EAAM,MAAM,EAAE,EAAE,CAAC,EACxBC,GAAQ,CAACjD,IACX2C,GAAA,EAEF,IAAIO,EAAWlD,GACXmD,EAAWD,GAAYD,GAAQA,EAAK,KAAOC,EAAS,GACxDlD,GAAiBiD,EACbC,GAAY,CAACC,IACfD,EAAS,iBACJF,EAAM,OAAO,SAAUI,EAAO,CACjC,IAAIvT,EAAKuT,EAAM,GACf,OAAOvT,IAAOqT,EAAS,EACzB,CAAC,EAAE,QACDA,EAAS,YAAY,CAACD,CAAI,GAG1BA,GACFhD,GAAkB,MACd,CAACkD,GAAYD,EAAS,WAAaD,EAAK,WAC1CA,EAAK,aAAaF,EAAY,EAEhCpB,GAAiB,EACjBhC,GAAYgC,EAAY,IAExBiB,GAAA,EACA3C,GAAkB,KAEtB,CACAxT,GAAY,iBAAiBiE,EAAO,EACpC7D,GAAW,aAAa+D,EAAM,EAC9B9D,GAAa,aAAa,SAAUd,EAAI,CACtC,OAAOA,EAAG+W,EAAY,CACxB,CAAC,EACD,MAAAM,GAAetR,GAAeC,GAAoBC,EAAyB,EAAEuQ,EAAY,EC9PzF,IAAIc,GAAoClW,aAAW,SAAgCC,EAAOtD,EAAK,CAC7F,OAAoBsH,GAAM,cAAckS,GAAa/Z,GAAS,CAC5D,QAAS6Z,GACT,IAAAtZ,CAAA,EACCsD,CAAK,CAAC,CACX,CAAC,EACGX,GAAO6W,GAAY,WAAa,GACxB7W,GAAK,QACHrD,GAA8BqD,GAAM,CAAC,SAAS,CAAC,EAC7D4W,GAAqB,UAAgE,eCXrF,MAAME,GAAOC,GAAiB,oBAAoBA,CAAI,GAOtD,SAASC,GAAU3a,EAAI,IAAI,KAAgB,CAEzC,MAAM4a,EAAO,IAAI,KAAK,KAAK,IAAI5a,EAAE,cAAeA,EAAE,WAAYA,EAAE,SAAS,CAAC,EAEpE6a,EAASD,EAAK,aAAe,EACnCA,EAAK,WAAWA,EAAK,aAAe,EAAIC,CAAM,EAC9C,MAAMC,EAAY,IAAI,KAAK,KAAK,IAAIF,EAAK,iBAAkB,EAAG,CAAC,CAAC,EAC1DG,EAAS,KAAK,OAChBH,EAAK,UAAYE,EAAU,WAAa,MAAW,GAAK,GAEtDE,EAAO,OAAOD,CAAM,EAAE,SAAS,EAAG,GAAG,EAC3C,MAAO,GAAGH,EAAK,gBAAgB,IAAII,CAAI,EACzC,CAEO,SAASC,GAAeP,EAAqB,CAClD,GAAI,CACF,MAAMQ,EAAM,aAAa,QAAQT,GAAIC,CAAI,CAAC,EAC1C,GAAI,CAACQ,EAAK,MAAO,CAAE,KAAMP,GAAA,EAAa,KAAM,GAC5C,MAAMQ,EAAI,KAAK,MAAMD,CAAG,EAClBE,EAAcT,GAAA,EACpB,MAAI,CAACQ,EAAE,MAAQA,EAAE,OAASC,EACjB,CAAE,KAAMA,EAAa,KAAM,GAC7B,CAAE,KAAM,OAAOD,EAAE,IAAI,EAAG,KAAM,OAAOA,EAAE,IAAI,GAAK,EACzD,MAAQ,CACN,MAAO,CAAE,KAAMR,KAAa,KAAM,EACpC,CACF,CAoBO,SAASU,GAAiBX,EAAcY,EAAM,EAAW,CAC9D,MAAMH,EAAIF,GAAeP,CAAI,EAC7B,OAAO,KAAK,IAAI,EAAGY,GAAOH,EAAE,MAAQ,EAAE,CACxC,wICzDMI,GAAS,iBAIf,SAASC,IAAkB,CACzB,GAAI,CACF,MAAMN,EAAM,aAAa,QAAQK,EAAM,EACvC,OAAOL,EAAM,KAAK,MAAMA,CAAG,EAAI,EACjC,MAAQ,CACN,MAAO,EACT,CACF,CACA,SAASO,GAASC,EAAeC,EAAY,CAC3C,GAAI,CACF,MAAM/b,EAAI4b,GAAA,EACV5b,GAAG8b,GAAS,IAAI,aAAa,EAAI,CAAE,EAAAC,EAAG,GAAI,KAAK,KAAI,EACnD,aAAa,QAAQJ,GAAQ,KAAK,UAAU3b,CAAC,CAAC,CAChD,MAAQ,CAAC,CACX,CAEA,eAAsBgc,GAAaF,EAAyC,CAC1E,MAAMzb,EAAI,OAAOyb,GAAS,EAAE,EAAE,cAC9B,GAAI,CAACzb,EAAG,MAAO,GAEf,GAAI,CACF,MAAM4b,EAAQ,OACXC,IAA0B,kBAAoB,IAC/C,cACF,GAAID,GAAS5b,IAAM4b,EAAO,MAAO,EACnC,MAAQ,CAAC,CAET,GAAI5b,IAAM,4BAA6B,MAAO,GAC9C,GAAI,CACF,MAAM8b,EAAQ,aAAa,QAAQ,gBAAgB,EACnD,GAAIA,IAAU,KAAOA,IAAU,OAAQ,MAAO,EAChD,MAAQ,CAAC,CAGT,MAAMC,EADIR,GAAA,EACIvb,CAAC,EACf,GAAI+b,GAAO,KAAK,MAAQA,EAAI,GAAK,IAAS,IAAM,MAAO,CAAC,CAACA,EAAI,EAC7D,GAAI,CAGF,MAAML,EAAI,CAAC,EADE,MADD,MAAM,MAAM,2BAA2B,mBAAmB1b,CAAC,CAAC,EAAE,GACnD,OAAO,MAAM,KAAO,GAAG,IAC5B,QAClB,OAAAwb,GAASxb,EAAG0b,CAAC,EACNA,CACT,MAAQ,CACN,MAAO,CAAC,CAACK,GAAK,CAChB,CACF,CAEO,SAASC,GAAWP,EAAuB,CAChD,MAAMzb,EAAI,OAAOyb,GAAS,EAAE,EAAE,cACxB,CAACQ,EAASC,CAAU,EAAI9a,WAAS,EAAK,EAC5C+a,mBAAU,IAAM,CACd,IAAIC,EAAK,GACT,GAAI,CAACpc,EAAG,CACNkc,EAAW,EAAK,EAChB,MACF,CAEA,GAAI,CACF,MAAMN,EAAQ,OACXC,IAA0B,kBAAoB,IAC/C,cACIC,GAAS,IAAe,CAC5B,GAAI,CACF,MAAMJ,EAAI,aAAa,QAAQ,gBAAgB,EAC/C,OAAOA,IAAM,KAAOA,IAAM,MAC5B,MAAQ,CACN,MAAO,EACT,CACF,KACA,GAAIE,GAAS5b,IAAM4b,EAAO,CACxBM,EAAW,EAAI,EACf,MACF,CACA,GAAIJ,EAAO,CACTI,EAAW,EAAI,EACf,MACF,CACF,MAAQ,CAAC,CACT,GAAIlc,IAAM,4BAA6B,CACrCkc,EAAW,EAAI,EACf,MACF,CACA,OAAAP,GAAa3b,CAAC,EAAE,KAAM0b,GAAM,CACtBU,GAAIF,EAAW,CAAC,CAACR,CAAC,CACxB,CAAC,EACM,IAAM,CACXU,EAAK,EACP,CACF,EAAG,CAACpc,CAAC,CAAC,EACCic,CACT,aC/FaI,GAAiB,EAGxBC,GAA6B,CACjC,IAAK,EACL,IAAK,KACL,IAAK,KACL,IAAK,KACL,IAAK,KACL,IAAK,IACP,EAEO,SAASC,GACdC,EACAC,EAAYJ,GACZ,CACA,MAAMK,GAAOF,GAAY,OAAO,cAC1BG,EAAOL,GAAGI,CAAG,GAAK,EAClBE,EAAMH,EAAYE,EACxB,GAAI,CACF,OAAO,IAAI,KAAK,aAAa,OAAW,CACtC,MAAO,WACP,SAAUD,CAAA,CACX,EAAE,OAAOE,CAAG,CACf,MAAQ,CAEN,MAAO,GAAGF,CAAG,IAAIE,EAAI,QAAQ,CAAC,CAAC,EACjC,CACF,CAEO,SAASC,IAA0B,CACxC,GAAI,CAEF,MAAMC,EAAQ,IAAI,KAAK,eAAe,kBAEhCvd,EAAI,OAAOud,EAAM,MAAM,EAAE,cAC/B,OAAIvd,EAAE,SAAS,KAAK,EAAU,MAE5BA,EAAE,SAAS,KAAK,GAChBA,EAAE,SAAS,KAAK,GAChBA,EAAE,SAAS,KAAK,GAChBA,EAAE,SAAS,KAAK,GAChBA,EAAE,SAAS,KAAK,GAChBA,EAAE,SAAS,KAAK,EAET,MACLA,EAAE,SAAS,KAAK,EAAU,MAC1BA,EAAE,SAAS,KAAK,EAAU,MAC1BA,EAAE,SAAS,KAAK,EAAU,MAC1BA,EAAE,SAAS,KAAK,EAAU,MACvB,KACT,MAAQ,CACN,MAAO,KACT,CACF,CAGO,MAAMwd,GACVlB,IAAyB,yBAC1B,oCC1DF,IAAImB,GAA+B,KACnC,MAAMC,GACFpB,IAA0B,0BAC5B,GACIqB,IACJD,GAAkB,QAAU,yCAC5B,QAAQ,MAAO,EAAE,EACbE,GAAc,IAAI,IAAI,CAAC,YAAa,WAAW,CAAC,EAEtD,SAASC,IAAyB,CAChC,GAAIJ,GAAe,OAAOA,GAC1B,MAAMK,EACH,wBACA,OACH,GAAIA,EAAQ,CACV,MAAMC,EAAaD,EAAO,QAAQ,MAAO,EAAE,EAC3C,OACE,OAAO,OAAW,KAClB,+CAA+C,KAAKC,CAAU,GAC9D,CAACH,GAAY,IAAI,OAAO,SAAS,QAAQ,GAEzCH,GAAgBE,GACTF,KAETA,GAAgBM,EACTN,GACT,CACA,GAAI,OAAO,OAAW,IAAa,CACjC,KAAM,CAAE,SAAAO,EAAU,KAAAC,EAAM,SAAAC,CAAA,EAAa,OAAO,SACtCC,EAAa,GAAGH,CAAQ,KAAKC,CAAI,GACvC,OACEC,EAAS,SAAS,cAAc,GAChCA,IAAa,aACbA,IAAa,YAEbT,GAAgBU,EAAW,QAAQ,MAAO,EAAE,EAE5CV,GAAgBE,GAEXF,EACT,CAEA,OAAAA,GAAgBE,GACTF,EACT,CAEA,SAASW,GAAcC,EAAuB,CAC5C,GAAI,gBAAgB,KAAKA,CAAI,EAAG,OAAOA,EACvC,MAAMC,EAAOT,GAAA,EACPU,EAAYF,EAAK,WAAW,GAAG,EAAIA,EAAO,IAAIA,CAAI,GACxD,MAAO,GAAGC,CAAI,GAAGC,CAAS,EAC5B,CAEO,SAASC,GAAcH,EAAuB,CACnD,OAAOD,GAAcC,CAAI,CAC3B,CAEO,SAASI,IAAwB,CACtC,OAAOZ,GAAA,CACT,CAEO,SAASa,GAASL,EAAeM,EAAoB,CAC1D,MAAMC,EAAMJ,GAAcH,CAAI,EAO9B,GAAI,CACF,MAAMQ,EAAS,OACf,GAAIA,EAAO,iBAAkB,CAC3B,MAAMC,EAAa,OAAOD,EAAO,kBAAkB,GAAK,EACxD,GAAIC,GAAc,KAAK,MAAQA,EAAa,IAE1CD,EAAO,iBAAmB,GAC1BA,EAAO,mBAAqB,MAE5B,QAAO,QAAQ,QAAQ,CACrB,GAAI,GACJ,OAAQ,IACR,KAAM,UAAa,GAAC,CACd,CAEZ,CACF,MAAY,CAAC,CAKb,OAAO,MAAMD,EAAKD,CAAI,EACnB,MAAOI,GAAQ,CACd,GAAI,CACD,OAAe,iBAAmB,GAClC,OAAe,mBAAqB,KAAK,KAC5C,MAAY,CAAC,CACb,MAAO,CAAE,GAAI,GAAO,OAAQ,IAAK,KAAM,UAAa,GAAC,CACvD,CAAC,EACA,KAAMC,GAAQ,CACb,GAAI,CAGF,MAAMf,EAAO,IAAI,IAAI,OAAOW,CAAG,CAAC,EAAE,SAEhCI,GACCA,EAAY,SAAW,KACxBf,IAAS,OAAO,SAAS,WAExB,OAAe,iBAAmB,GAClC,OAAe,mBAAqB,KAAK,MAE9C,MAAY,CAAC,CACb,OAAOe,CACT,CAAC,CACL,CAEO,SAASC,IAAwB,CACtC,GAAI,OAAO,OAAW,KAAe,OAAO,OAAO,OAAU,WAC3D,OACF,MAAMC,EAAY,OAClB,GAAIA,EAAU,gBAAiB,OAC/B,MAAMC,EAAgB,OAAO,MAAM,KAAK,MAAM,EAC9C,OAAO,MAAQ,CAACC,EAA0BT,IAAuB,CAC/D,GAAI,CACF,GAAI,OAAOS,GAAU,SACnB,OAAIA,EAAM,WAAW,GAAG,EACfD,EAAcX,GAAcY,CAAK,EAAGT,CAAI,EAE1CQ,EAAcC,EAAOT,CAAI,EAElC,GAAIS,aAAiB,QAAS,CAC5B,MAAMC,EAASD,EAAM,IAAI,WAAW,GAAG,EACnCZ,GAAcY,EAAM,GAAG,EACvBA,EAAM,IACV,GAAIC,IAAWD,EAAM,IACnB,OAAOD,EAAcC,EAAOT,CAAI,EAElC,MAAMW,EAAS,IAAI,QAAQD,EAAQD,CAAK,EACxC,OAAOD,EAAcG,EAAQX,CAAI,CACnC,CACA,GAAIS,aAAiB,IAAK,CACxB,MAAMG,EAAOH,EAAM,KAAK,WAAW,GAAG,EAClCZ,GAAcY,EAAM,IAAI,EACxBA,EAAM,KACV,OAAOD,EAAcI,EAAMZ,CAAI,CACjC,CACF,OAASI,EAAK,CACZ,QAAQ,KACN,2DACAA,CAAA,CAEJ,CACA,OAAOI,EAAcC,EAAcT,CAAI,CACzC,EACAO,EAAU,gBAAkB,EAC9B,CCzHO,SAASM,GAAQtE,EAA4B,CAClD,MAAMuE,EAA4B,CAChC,CAAE,IAAK,QAAS,MAAO,UAAW,KAAMC,EAAA,EACxC,CAAE,IAAK,SAAU,MAAO,iBAAkB,KAAMC,EAAA,EAChD,CAAE,IAAK,UAAW,MAAO,aAAc,KAAMC,EAAA,EAC7C,CAAE,IAAK,cAAe,MAAO,kBAAmB,KAAMA,EAAA,EACtD,CAAE,IAAK,UAAW,MAAO,aAAc,KAAMD,EAAA,EAC7C,CAAE,IAAK,QAAS,MAAO,WAAY,KAAMC,EAAA,EACzC,CAAE,IAAK,YAAa,MAAO,uBAAwB,KAAMC,EAAA,EACzD,CAAE,IAAK,WAAY,MAAO,cAAe,KAAMC,EAAA,CAAS,EAO1D,SAASC,EAAqBpE,EAAQ,CACpC,GAAI,CAACA,EAAG,MAAO,GACf,MAAMqE,EAAMrE,EAAE,aACd,GAAI,CAACqE,EAAK,MAAO,CAAC,CAACrE,EAAE,WACrB,GAAIqE,EAAI,WAAY,CAClB,GAAIA,EAAI,UAAW,CACjB,MAAMC,EACJ,OAAOD,EAAI,WAAc,SACrB,KAAK,MAAMA,EAAI,SAAS,EACxB,OAAOA,EAAI,SAAS,EAC1B,GAAI,CAAC,MAAMC,CAAG,EAAG,OAAOA,EAAM,KAAK,KACrC,CACA,OAAID,EAAI,OAAeA,EAAI,SAAW,SAC/B,EACT,CACA,MAAO,EACT,CAEA,OAAKD,EAAqB7E,CAAI,GAC5BuE,EAAS,KAAK,CACZ,IAAK,aACL,MAAO,gBACP,KAAMS,EAAA,CACP,EAEIT,CACT,CAEA,SAASU,GAAmBjF,EAAW,CACrC,IAAIkF,EAAclF,EAClB,GAAI,CAACA,GAAM,cAAgBA,GAAM,MAC/B,GAAI,CACF,MAAMmF,EAAU,cAAsB,QACtC,GAAI,OAAOA,GAAW,WAAY,CAChC,MAAMjV,EAASiV,EAAO,KACpB,aACA,oBAAoBnF,EAAK,KAAK,IAEhC,GAAI9P,EAAQ,CACV,MAAMkV,EAAO,KAAK,MAAMlV,CAAM,EAC9BgV,EAAc,CACZ,GAAGlF,EACH,aAAcoF,EACd,WAAYA,EAAK,YAAcpF,EAAK,WAExC,CACF,CACF,MAAQ,CAAC,CAEX,OAAOkF,CACT,CAEO,SAASG,GAAarF,EAAWwB,EAAmC,CACzE,MAAM8D,EAAwB,CAAC,GAAGhB,GAAQtE,CAAI,CAAC,EAC/C,GAAIwB,GAAW,CAAC8D,EAAK,KAAMxf,GAAMA,EAAE,MAAQ,OAAO,EAAG,CACnD,MAAMyf,EAAW,CACf,IAAK,QACL,MAAO,YACP,KAAMX,EAAA,EAEFY,EAAYF,EAAK,UAAWxf,GAAMA,EAAE,MAAQ,UAAU,EACxD0f,GAAa,EACfF,EAAK,OAAOE,EAAW,EAAGD,CAAQ,EAElCD,EAAK,KAAKC,CAAyB,CAEvC,CACA,OAAOD,CACT,CAEO,SAASG,GAAQ,CACtB,OAAAC,EACA,SAAAC,EACA,KAAA3F,EACA,UAAA5U,CACF,EAKG,CAED,MAAMwa,EAAahY,GAAM,OAAoB,IAAI,EAC3CiY,EAASjY,GAAM,OAAO,EAAK,EAC3BkY,EAASlY,GAAM,OAAO,CAAC,EACvBmY,EAAYnY,GAAM,OAAO,CAAC,EAE1BoY,EAAezgB,GAAwB,CAC3CsgB,EAAO,QAAU,GACbD,EAAW,UACbE,EAAO,QAAUvgB,EAAE,MAAQqgB,EAAW,QAAQ,UAC9CG,EAAU,QAAUH,EAAW,QAAQ,UACvCA,EAAW,QAAQ,MAAM,OAAS,WAEtC,EACMK,EAAe,IAAM,CACzBJ,EAAO,QAAU,GACbD,EAAW,UAASA,EAAW,QAAQ,MAAM,OAAS,OAC5D,EACMM,EAAY,IAAM,CACtBL,EAAO,QAAU,GACbD,EAAW,UAASA,EAAW,QAAQ,MAAM,OAAS,OAC5D,EACMO,EAAe5gB,GAAwB,CAC3C,GAAI,CAACsgB,EAAO,SAAW,CAACD,EAAW,QAAS,OAC5CrgB,EAAE,iBAEF,MAAM6gB,GADI7gB,EAAE,MAAQqgB,EAAW,QAAQ,UACrBE,EAAO,SAAW,EACpCF,EAAW,QAAQ,UAAYG,EAAU,QAAUK,CACrD,EAKMlB,EAAcD,GAAmBjF,CAAI,EACrCwB,EAAUD,GAAWvB,GAAM,KAAK,EAChCsF,EAAOD,GAAaH,EAAa1D,CAAO,EACxC,CAAC6E,EAAaC,CAAc,EAAI3f,WAAS,EAAK,EAC9C,CAAC4f,EAAgBC,CAAiB,EAAI7f,WAAS,EAAK,EACpD8f,EACJzG,GAAM,UAAY,CAACA,GAAM,WACrBW,GAAiBX,EAAK,QAAQ,EAC9B,IAGA,CAAC0G,EAAeC,CAAgB,EAAIhgB,WAAS,CACjD,eAAgB,EAChB,SAAU,EACV,YAAa,EACd,EAGD+a,YAAU,IAAM,CACd,GAAI,CAAC1B,GAAM,MAAO,OAGlB,IAAI4G,EAAU,GACd,MAAMC,EAAW,CAAE,MAAO,GAC1B,IAAIC,EAA+B,KAEnC,MAAMC,EAAqB,SAAY,CACrC,GAAI,CAIF,GAHI,CAACH,GACU,OACJ,kBACPE,GAAiB,KAAK,MAAQA,EAAe,OAEjD,KAAM,CAACE,GAAaC,EAAW,EAAI,MAAM,QAAQ,IAAI,CACnDzD,GACE,+BAA+B,mBAAmBxD,EAAK,KAAK,CAAC,IAE/DwD,GACE,+BAA+B,mBAAmBxD,EAAK,KAAK,CAAC,GAC/D,CACD,EAEKkH,GACJF,IAAgBA,GAAoB,GAChC,MAAMA,GAAY,OAClB,CAAE,SAAU,EAAC,EAObG,IALJF,IAAgBA,GAAoB,GAChC,MAAMA,GAAY,OAClB,CAAE,SAAU,EAAC,GAIR,UAAU,OAAQniB,IAAW,CAACA,GAAE,IAAI,EAAE,QAAU,EAE3D6hB,EAAiB,CACf,eAAgBO,GAAS,UAAU,QAAU,EAC7C,SAAUC,GACV,YAAa,EACd,EAGDN,EAAS,MAAQ,EACjBC,EAAgB,IAClB,OAASjD,EAAK,CACZ,QAAQ,MAAM,iCAAkCA,CAAG,EACnDgD,EAAS,OAAS,EACdA,EAAS,OAAS,IACpBC,EAAgB,KAAK,MAAQ,IAAS,IACtC,QAAQ,KACN,wEAGN,CACF,EAEAC,EAAA,EACA,MAAMK,EAAW,YAAYL,EAAoB,GAAK,EACtD,MAAO,IAAM,CACXH,EAAU,GACV,cAAcQ,CAAQ,CACxB,CACF,EAAG,CAACpH,GAAM,KAAK,CAAC,EAEhB0B,YAAU,IAAM,CACd,GAAI,CAAC2E,EAAa,OAClB,MAAMgB,EAAS9hB,GAAqB,EAC9BA,EAAE,MAAQ,UAAYA,EAAE,MAAQ,YAAwB,EAAK,CACnE,EACA,gBAAS,iBAAiB,UAAW8hB,CAAK,EACnC,IAAM,SAAS,oBAAoB,UAAWA,CAAK,CAC5D,EAAG,CAAChB,CAAW,CAAC,EAGhB,MAAMiB,EAAWhC,EAAK,OAAQxf,GAC5B,CAAC,QAAS,SAAU,UAAW,aAAa,EAAE,SAASA,EAAE,GAAG,GAExDyhB,EAAajC,EAAK,OAAQxf,GAAM,CAAC,SAAS,EAAE,SAASA,EAAE,GAAG,CAAC,EAC3D0hB,EAAalC,EAAK,OAAQxf,GAC9B,CAAC,QAAS,YAAa,WAAY,QAAS,YAAY,EAAE,SAASA,EAAE,GAAG,GAGpE2hB,EAAa3hB,GAAqB,CACtC,KAAM,CAAE,IAAA4hB,EAAK,MAAAC,EAAO,KAAMC,GAAS9hB,EAC7BsE,EAAWsb,IAAWgC,EAG5B,IAAIG,EAAa,EACjB,OAAIH,IAAQ,YAAWG,EAAanB,EAAc,gBAC9CgB,IAAQ,UACVG,EAAanB,EAAc,SAAWA,EAAc,aAGpDoB,OAAC,UAEC,UAAW,iEAAiE1d,EAAW,cAAgB,eAAe,IAAIsd,IAAQ,aAAe,eAAiB,EAAE,GACpK,QAAS,IAAM/B,EAAS+B,CAAa,EACrC,MAAOC,EAEP,UAAAG,OAAC,OAAI,UAAU,0BACb,UAAAC,MAACH,EAAA,CACC,UAAW,WAAWxd,EAAW,aAAe,gBAAgB,KAElE2d,MAAC,QACC,UAAW,6BAA6B3d,EAAW,aAAe,gBAAgB,GAEjF,SAAAud,CAAA,EACH,EACF,EAEAG,OAAC,OAAI,UAAU,0BACZ,UAAAJ,IAAQ,UAAY,CAAC1H,GAAM,YAAcyG,GAAY,GACpDsB,MAACC,GAAA,CAAK,UAAU,wBAAwB,EAGzCH,EAAa,GACZE,MAAC,QAAK,UAAU,mCACb,SAAAF,EAAa,EAAI,KAAOA,CAAA,CAC3B,GAEJ,IA1BKH,CAAA,CA6BX,EAEA,OACEI,OAAC,SACC,IAAKlC,EACL,YAAAI,EACA,aAAAC,EACA,UAAAC,EACA,YAAAC,EACA,UAAW,GAAGnG,GAAM,WAAa,kBAAoB,EAAE,kBACrD5U,EAAY,GAAK,MACnB,oBAAoBA,GAAa,gBAAgB,qDAC/CA,EAAY,GAAK,6BACnB,GAGA,UAAA2c,MAAC,OAAI,UAAU,YACb,SAAAD,OAAC,MAAG,UAAU,sHAAsH,4BAEjI,OAAG,EAAE,UAER,EACF,EAEAA,OAAC,OAAI,UAAU,sBACb,UAAAC,MAAC,MAAG,UAAU,sEAAsE,gBAEpF,EACCT,EAAS,IAAIG,CAAS,GACzB,EAEAK,OAAC,OAAI,UAAU,sBACb,UAAAC,MAAC,MAAG,UAAU,sEAAsE,kBAEpF,EACCR,EAAW,IAAIE,CAAS,GAC3B,EAEAK,OAAC,OAAI,UAAU,sBACb,UAAAC,MAAC,MAAG,UAAU,sEAAsE,kBAEpF,EACCP,EAAW,IAAK1hB,GAAM,CACrB,MAAMmiB,EAAWR,EAAU3hB,CAAC,EAC5B,OAAIA,EAAE,MAAQ,WAEVgiB,OAACla,GAAM,SAAN,CACE,UAAAqa,EAEDH,OAAC,UACC,UAAU,sLACV,QAAS,IAAMxB,EAAe,EAAI,EAClC,MAAM,sBAEN,UAAAyB,MAACG,GAAA,CAAc,UAAU,UAAU,EACnCH,MAAC,QAAK,UAAU,iCAAiC,2BAEjD,KAGFD,OAAC,UACC,UAAU,sLACV,QAAS,IAAMtB,EAAkB,EAAI,EACrC,MAAM,iBAEN,UAAAuB,MAACG,GAAA,CAAc,UAAU,UAAU,EACnCH,MAAC,QAAK,UAAU,iCAAiC,yBAEjD,IACF,GAvBmBjiB,EAAE,GAwBvB,EAGGmiB,CACT,CAAC,GACH,EAGC5B,GACC8B,gBACEL,OAAC,OAAI,UAAU,yBACb,UAAAC,MAAC,UACC,UAAU,+BACV,QAAS,IAAMzB,EAAe,EAAK,EACnC,aAAc,IAAMA,EAAe,EAAK,EACxC,aAAW,+BAEZ,OAAI,UAAU,wDACb,SAAAyB,MAACre,GAAA,CAAU,YAAW,GACpB,SAAAoe,OAAC,OACC,KAAK,SACL,aAAW,OACX,UAAU,yDAEV,UAAAC,MAAC,UACC,UAAU,yCACV,aAAW,QACX,QAAS,IAAMzB,EAAe,EAAK,EACpC,eAGDwB,OAAC,MAAG,UAAU,gEACZ,UAAAC,MAACG,GAAA,CAAc,UAAU,UAAU,EAAE,2BACvC,EACAH,MAAC,OAAI,UAAU,6BAA6B,gGAG5C,EACAA,MAAC,KACC,KAAMzF,GACN,OAAO,SACP,IAAI,+BACJ,UAAU,uDACX,4BAED,IAEJ,EACF,GACF,EACA,SAAS,MAGZiE,GACC4B,gBACEL,OAAC,OAAI,UAAU,yBACb,UAAAC,MAAC,UACC,UAAU,+BACV,QAAS,IAAMvB,EAAkB,EAAK,EACtC,aAAc,IAAMA,EAAkB,EAAK,EAC3C,aAAW,sCAEZ,OAAI,UAAU,wDACb,SAAAuB,MAACre,GAAA,CAAU,YAAW,GACpB,SAAAoe,OAAC,OACC,KAAK,SACL,aAAW,OACX,UAAU,yDAEV,UAAAC,MAAC,UACC,UAAU,yCACV,aAAW,QACX,QAAS,IAAMvB,EAAkB,EAAK,EACvC,eAGDsB,OAAC,MAAG,UAAU,gEACZ,UAAAC,MAACG,GAAA,CAAc,UAAU,UAAU,EAAE,sBACvC,EACAH,MAAC,OAAI,UAAU,6BAA6B,wDAE5C,EACAA,MAAC,KACC,KAAK,gCACL,OAAO,SACP,IAAI,+BACJ,UAAU,uDACX,4BAED,IAEJ,EACF,GACF,EACA,SAAS,KACX,GAGR,CChdA,SAAwBK,GAAW,CACjC,SAAA5d,EACA,UAAAY,EACA,MAAAid,CACF,EAAoB,CAClB,MAAM/hB,EAAM6D,SAA8B,IAAI,EACxC,CAACme,EAAYC,CAAa,EAAI5hB,WAAS,CAAC,EAG9C+a,mBAAU,IAAM,CACd,IAAI8G,EAAM,EACNC,EAAiB,EAErB,MAAMC,EAAa,IAAM,CACvB,MAAMC,EAAS,SAAS,eAAe,YAAY,EACnD,GAAI,CAACA,EAAQ,CACPF,IAAmB,IACrBA,EAAiB,EACjBF,EAAc,CAAC,GAEjB,MACF,CACA,MAAMK,EAAW,SAAS,eAAe,iBAAiB,EACpD7C,EAAY6C,EAAWA,EAAS,UAAY,OAAO,SAAW,EAC9DC,EAAUF,EAAO,wBAAwB,OACzCG,EAAgB/C,EAAY,EAAI8C,EAAU,EAG5C,KAAK,IAAIC,EAAgBL,CAAc,EAAI,IAC7CA,EAAiBK,EACjBP,EAAcO,CAAa,EAE/B,EAEAJ,EAAA,EAEA,MAAMK,EAAmB,IAAM,CACzBP,wBAA0BA,CAAG,EACjCA,EAAM,sBAAsBE,CAAU,CACxC,EAEME,EAAW,SAAS,eAAe,iBAAiB,EAC1D,OAAAA,GAAU,iBAAiB,SAAUG,EAAkB,CAAE,QAAS,GAAM,EACxE,OAAO,iBAAiB,SAAUA,EAAkB,CAAE,QAAS,GAAM,EACrE,OAAO,iBAAiB,SAAUA,EAAkB,CAAE,QAAS,GAAM,EAE9D,IAAM,CACXH,GAAU,oBAAoB,SAAUG,CAAgB,EACxD,OAAO,oBAAoB,SAAUA,CAAgB,EACrD,OAAO,oBAAoB,SAAUA,CAAgB,EACjDP,wBAA0BA,CAAG,CACnC,CACF,EAAG,EAAE,EAGHV,OAAC,OACC,IAAAxhB,EACA,UAAA8E,EACA,MAAO,CACL,GAAGid,EACH,SAAU,WACV,WAAY,YACZ,UAAW,iBAGZ,UAAAC,EAAa,GACZP,MAAC,OACC,MAAO,CACL,SAAU,WACV,KAAM,EACN,MAAO,EACP,IAAK,EACL,OAAQO,EACR,cAAe,OACf,OAAQ,GACR,WACE,iEACF,WAAY,SACZ,UAAW,gBACb,GAGH9d,CAAA,GAGP,CCjGO,SAASwe,MAAQC,EAAa,CAErC,CACO,SAASC,MAASD,EAAa,CAEtC,CCcO,MAAME,EAAa,CAChB,MAAQ,EACR,OAAS,EACT,GAA0B,KAC1B,aAAe,EACf,WAAa,IACb,UAAY,EACZ,MAAQ,EACR,MAAQ,EACR,YAAc,GAGd,OAAS,GACT,QAAU,GACV,QAAU,IACV,UAAY,GAEZ,QAAwB,KACxB,SAAmB,EACnB,YAAc,EACd,eAAiB,EAGjB,cAMG,KAEX,YAAYC,EAMT,CACGA,GAAK,SAAW,SAAW,KAAK,OAASA,EAAI,QAC7CA,GAAK,UAAY,SAAW,KAAK,QAAUA,EAAI,SAC/CA,GAAK,UAAY,SAAW,KAAK,QAAUA,EAAI,SAC/CA,GAAK,iBAAmB,SAC1B,KAAK,eAAiBA,EAAI,gBACxBA,GAAK,YAAc,SAAW,KAAK,UAAYA,EAAI,UACzD,CAMA,sBACEC,EAMAC,EACA,CACA,MAAMC,EAAK,KAAK,IAAI,EAAG,OAAOD,CAAU,GAAK,CAAC,EAC9C,GAAIC,GAAM,EAAG,CACX,KAAK,cAAgB,KACrB,MACF,CACA,KAAK,cAAgB,CACnB,GAAGF,EACH,QAAS,KAAK,MAAQE,CAAA,CAE1B,CAEQ,kBAAmB,CACzB,MAAMC,EAAM,KAAK,MACXxb,EAAI,KAAK,cACf,MAAI,CAACA,GAAKwb,GAAOxb,EAAE,SAEbA,GAAKwb,GAAOxb,EAAE,eAAc,cAAgB,MACzC,CACL,OAAQ,KAAK,OACb,QAAS,KAAK,QACd,QAAS,KAAK,QACd,eAAgB,KAAK,eACrB,UAAW,KAAK,UAChB,QAAS,KAGN,CACL,OAAQA,EAAE,QAAU,KAAK,OACzB,QAASA,EAAE,SAAW,KAAK,QAC3B,QAAS,KAAK,QACd,eAAgBA,EAAE,gBAAkB,KAAK,eACzC,UAAWA,EAAE,WAAa,KAAK,UAC/B,QAAS,GAEb,CAEA,OAAOyb,EAAYC,EAAYC,EAAgB,CAC7C,KAAK,MAAQF,EACb,KAAK,MAAQC,EACb,KAAK,UAAY,KAAK,IAAI,EAAGC,EAAS,CAAC,CACzC,CAEA,MAAMC,EAAeC,EAAgB,CACnC,KAAK,MAAQD,EACb,KAAK,OAASC,EACd,KAAK,GAAK,IAAI,aAAaD,EAAQC,CAAM,EACzC,KAAK,YAAc,EACrB,CAIA,iBAAiB1V,EAAkB2V,EAAQ,IAAM,CAC/C,KAAM,CAAE,MAAOxQ,EAAG,OAAQ9T,EAAG,KAAA4C,GAAS+L,GAClC,CAAC,KAAK,IAAMmF,IAAM,KAAK,OAAS9T,IAAM,KAAK,SAC7C,KAAK,MAAM8T,EAAG9T,CAAC,EAEjB,MAAMukB,EAAK,KAAK,GACVhlB,EAAIuU,EAAI9T,EACd,QAASoC,EAAI,EAAG5C,EAAI,EAAG4C,EAAI7C,EAAG6C,IAAK5C,GAAK,EAAG,CACzC,MAAMa,EAAIuC,EAAKpD,CAAC,EACdI,EAAIgD,EAAKpD,EAAI,CAAC,EACdK,EAAI+C,EAAKpD,EAAI,CAAC,EACVglB,EAAO,KAAQnkB,EAAI,KAAQT,EAAI,KAAQC,EACxC,KAAK,YACL0kB,EAAGniB,CAAC,GAAK,EAAIkiB,GAASC,EAAGniB,CAAC,EAAIkiB,EAAQE,EADpBD,EAAGniB,CAAC,EAAIoiB,CAEjC,CACA,KAAK,YAAc,EACrB,CAEQ,MAAM1hB,EAAW2hB,EAAoB,CAC3C,GAAI,KAAK,WAAa,EAAG,MAAO,GAChC,MAAMC,EAAK5hB,EAAI,KAAK,MACd6hB,EAAKF,EAAI,KAAK,MACpB,OAAOC,EAAKA,EAAKC,EAAKA,GAAM,KAAK,UAAY,KAAK,SACpD,CAGA,OAAOhW,EAAwC,CAE7C,MAAMiW,EADM,KAAK,MACI,KAAK,aAAe,KAAK,WACxCC,EAAS,KAAK,mBACd,CAAE,MAAO/Q,EAAG,OAAQ9T,EAAG,KAAA4C,GAAS+L,GAClC,CAAC,KAAK,IAAMmF,IAAM,KAAK,OAAS9T,IAAM,KAAK,SAAQ,KAAK,MAAM8T,EAAG9T,CAAC,EACtE,MAAMukB,EAAK,KAAK,GAChB,GAAI,CAAC,KAAK,YACR,YAAK,iBAAiB5V,EAAO,CAAG,EAEzB,KAIT,MAAMpP,EAAIuU,EAAI9T,EACR8kB,EAAO,IAAI,WAAWvlB,CAAC,EACvBwlB,EAAO,IAAI,aAAaxlB,CAAC,EAC/B,IAAIylB,EAAM,EACRC,EAAO,EACPrV,EAAM,EACR,MAAMsV,EAAc,IAAI,WAAW3lB,CAAC,EACpC,QAAS6C,GAAI,EAAG5C,GAAI,EAAG4C,GAAI7C,EAAG6C,KAAK5C,IAAK,EAAG,CACzC,MAAMa,GAAIuC,EAAKpD,EAAC,EACdI,GAAIgD,EAAKpD,GAAI,CAAC,EACdK,GAAI+C,EAAKpD,GAAI,CAAC,EACV2lB,GAAO,KAAK,IAAI9kB,GAAGT,GAAGC,EAAC,EACvBulB,GAAO,KAAK,IAAI/kB,GAAGT,GAAGC,EAAC,EACvB2kB,GAAO,KAAQnkB,GAAI,KAAQT,GAAI,KAAQC,GACvCC,GAAI,KAAK,IAAI0kB,GAAOD,EAAGniB,EAAC,CAAC,EAC/B2iB,EAAK3iB,EAAC,EAAItC,GACV,MAAM2kB,EAAI,KAAK,MAAMriB,GAAI0R,CAAC,EACpBhR,EAAIV,GAAIqiB,EAAI3Q,EAEZuR,GAAYF,KAAS,EAAI,GAAKA,GAAOC,IAAQD,GAC7CG,GAAOH,IAAQ,KAAOE,IAAa,IACrCC,KAAMJ,EAAY9iB,EAAC,EAAI,GACvB,KAAK,MAAMU,EAAG2hB,CAAC,GAAK,CAACa,KACvBN,GAAOllB,GACPmlB,GAAQnlB,GAAIA,GACZ8P,IAEJ,CACA,MAAM2V,EAAK3V,EAAMoV,EAAMpV,EAAM,EACvB4V,EAAO5V,EAAM,KAAK,IAAI,EAAGqV,EAAOrV,EAAM2V,EAAKA,CAAE,EAAI,EACjDE,EAAQ,KAAK,KAAKD,CAAI,EACtBE,EAAgB,KAAK,IAAIb,EAAO,OAAQU,EAAK,IAAME,CAAK,EAE9D,QAASrjB,GAAI,EAAGA,GAAI7C,EAAG6C,KAAK,CAC1B,GAAI8iB,EAAY9iB,EAAC,EAAG,CAClB0iB,EAAK1iB,EAAC,EAAI,EACV,QACF,CACA,GAAI2iB,EAAK3iB,EAAC,EAAIsjB,EAAe,CAC3B,MAAMjB,GAAI,KAAK,MAAMriB,GAAI0R,CAAC,EACpBhR,GAAIV,GAAIqiB,GAAI3Q,EAClBgR,EAAK1iB,EAAC,EAAI,KAAK,MAAMU,GAAG2hB,EAAC,EAAI,EAAI,CACnC,CACF,CAGA,KAAK,QAAQK,EAAMhR,EAAG9T,CAAC,EACvB,KAAK,OAAO8kB,EAAMhR,EAAG9T,CAAC,EAGtB,MAAM2lB,EAAU,IAAI,WAAWpmB,CAAC,EAChC,IAAIqmB,EAAW,EACXC,EAA4B,KAChC,QAASzjB,GAAI,EAAGA,GAAI7C,EAAG6C,KAAK,CAC1B,GAAI0iB,EAAK1iB,EAAC,IAAM,GAAKujB,EAAQvjB,EAAC,EAAG,SACjC,MAAM0jB,GAAiB,GACvB,IAAIvN,GAAO,EACPwN,GAAK,EACT,MAAMtmB,GAAc,CAAC2C,EAAC,EAEtB,IADAujB,EAAQvjB,EAAC,EAAI,EACN2jB,GAAKtmB,GAAE,QAAQ,CACpB,MAAMgd,GAAMhd,GAAEsmB,IAAI,EAClBD,GAAK,KAAKrJ,EAAG,EACblE,KACA,MAAMkM,GAAKhI,GAAM3I,EAAK,EAGhBkS,GAAM,CAACvJ,GAAM,EAAGA,GAAM,EAAGA,GAAM3I,EAAG2I,GAAM3I,CAAC,EAC/C,UAAWmS,MAAMD,GACXC,GAAK,GAAKA,IAAM1mB,GAChBomB,EAAQM,EAAE,IAETA,KAAOxJ,GAAM,GAAKwJ,KAAOxJ,GAAM,KAAQwJ,GAAKnS,EAAK,KAAO2Q,IAEzDK,EAAKmB,EAAE,IACTN,EAAQM,EAAE,EAAI,EACdxmB,GAAE,KAAKwmB,EAAE,EAGf,CACI1N,GAAOqN,IACTA,EAAWrN,GACXsN,EAAWC,GAEf,CAEA,GAAI,CAACD,GAAYD,EAAWf,EAAO,SAAWe,EAAWf,EAAO,QAE9D,OAAKD,GAAQ,KAAK,iBAAiBjW,EAAO,GAAI,EAE1C,KAAK,SAAW,KAClB6U,GAAK,4BAA6B,CAChC,SAAAoC,EACA,QAASf,EAAO,QAChB,QAASA,EAAO,QAChB,QAAS,CAAC,CAACgB,EACX,QAAShB,EAAO,QACjB,EAEI,KAIT,IAAIqB,EAAOpS,EACTqS,EAAOnmB,EACPomB,EAAO,EACPC,EAAO,EACLC,EAAQ,EACVC,EAAQ,EACV,UAAWC,MAAOX,EAAU,CAC1B,MAAMpB,GAAK+B,GAAM1S,EAAK,EAChBhR,GAAI0jB,GAAM/B,GAAI3Q,EACpBwS,GAASxjB,GACTyjB,GAAS9B,GACL3hB,GAAIojB,IAAMA,EAAOpjB,IACjBA,GAAIsjB,IAAMA,EAAOtjB,IACjB2hB,GAAI0B,IAAMA,EAAO1B,IACjBA,GAAI4B,IAAMA,EAAO5B,GACvB,CACA6B,GAASV,EACTW,GAASX,EACT,IAAIa,EAAM,EACRC,EAAM,EACNC,EAAM,EACR,UAAWH,MAAOX,EAAU,CAC1B,MAAMpB,GAAK+B,GAAM1S,EAAK,EAEhB4Q,GADI8B,GAAM/B,GAAI3Q,EACLwS,EACT3B,GAAKF,GAAI8B,EACfE,GAAO/B,GAAKA,GACZgC,GAAO/B,GAAKA,GACZgC,GAAOjC,GAAKC,EACd,CACA8B,GAAOb,EACPc,GAAOd,EACPe,GAAOf,EAGP,MAAMgB,GAAQH,EAAMC,EACdG,GAAMJ,EAAMC,EAAMC,EAAMA,EACxBG,GAAM,KAAK,KAAK,KAAK,IAAI,EAAIF,GAAQA,GAAS,EAAIC,EAAG,CAAC,EACtDE,GAAKH,GAAQ,EAAIE,GAEvB,IAAIE,GAAKL,EACPM,GAAKF,GAAKN,EACR,KAAK,MAAMO,GAAIC,EAAE,EAAI,OACvBD,GAAKD,GAAKL,EACVO,GAAKN,GAEP,MAAMO,EAAO,KAAK,MAAMF,GAAIC,EAAE,GAAK,EACnCD,IAAME,EACND,IAAMC,EAMN,MAAMC,EAAMb,EAAQ,KAAK,MACnBc,GAAMb,EAAQ,KAAK,MAInBc,GAAO,KAAK,MAAMF,EAAKC,EAAG,EAC1BE,GAAe,KAAK,IAAI,EAAG,KAAK,UAAY,GAAI,EACtD,GAAID,IAAQC,GAAc,CACxB,MAAMC,GAAKJ,EAAME,GACXG,GAAKJ,GAAMC,GACXI,GAAS,KAAK,IAAI,GAAI,KAAK,IAAI,EAAG,KAAK,IAAIT,GAAKO,GAAKN,GAAKO,EAAE,CAAC,CAAC,EAC9DE,GAAU,KAAK,KAAKD,EAAM,EAAI,IAAO,KAAK,GAChD,GAAIC,GAAS7C,EAAO,UAElB,OAAKD,GAAQ,KAAK,iBAAiBjW,EAAO,GAAI,EAC9C6U,GAAK,yCAA0C,CAC7C,OAAAkE,GACA,WAAY7C,EAAO,UACnB,QAASA,EAAO,QACjB,EACM,IAEX,CAGA,IAAI8C,GAAO,KACPC,GAAO,IACPC,GAASvB,EACXwB,EAASvB,EACPwB,EAASzB,EACX0B,GAASzB,EACX,UAAWC,MAAOX,EAAU,CAC1B,MAAMpB,GAAK+B,GAAM1S,EAAK,EAChBhR,GAAI0jB,GAAM/B,GAAI3Q,EACdxT,IAAKwC,GAAIwjB,GAASU,IAAMvC,GAAI8B,GAASU,GACvC3mB,GAAIqnB,KACNA,GAAOrnB,GACPunB,GAAS/kB,GACTglB,EAASrD,IAEPnkB,GAAIsnB,KACNA,GAAOtnB,GACPynB,EAASjlB,GACTklB,GAASvD,GAEb,CAKA,MAAMwD,GAAS,CAACnlB,GAAW2hB,KAAc,CACvC,MAAMC,GAAK5hB,GAAI,KAAK,MACd6hB,GAAKF,GAAI,KAAK,MACpB,OAAOC,GAAKA,GAAKC,GAAKA,EACxB,EACMuD,GAAUD,GAAOJ,GAAQC,CAAM,EAC/BK,GAAUF,GAAOF,EAAQC,EAAM,EACrC,IAAII,GACAC,EACAF,IAAWD,IACbE,GAAOL,EACPM,EAAOL,GAEHL,GAAOC,KAAS,IACLQ,GAAO9B,GAASU,IAAMqB,EAAO9B,GAASU,GACzC,IACRD,GAAK,CAACA,GACNC,GAAK,CAACA,MAIVmB,GAAOP,GACPQ,EAAOP,GACMM,GAAO9B,GAASU,IAAMqB,EAAO9B,GAASU,GACzC,IACRD,GAAK,CAACA,GACNC,GAAK,CAACA,KAKV,MAAMqB,EAAMF,GAAO,KAAK,MAClBG,EAAMF,EAAO,KAAK,MAClBG,GAAQF,EAAMA,EAAMC,EAAMA,EAG1BE,GAAQ,KAAK,IAAI,EAAGrC,EAAOF,EAAO,CAAC,EACnCwC,GAAQ,KAAK,IAAI,EAAGrC,EAAOF,EAAO,CAAC,EACnCwC,GAAWF,GAAQC,GACnBE,GAAOhD,EAAW+C,GAClBE,GAAS,KAAK,KAAKL,EAAK,EAAI,KAAK,IAAI,EAAG,KAAK,SAAS,EAC5D,IAAIM,GAAa,GAEbF,GAAO,MAAME,IAAc,IAC3BF,GAAO,MAAME,IAAc,KAC3BD,GAAS,MAAKC,IAAc,IAEhC,MAAMC,GAAKnC,GAAQG,GAcnB,OAbcA,GAAK,EAAI,EAAIgC,GAAKhC,GAAK,GACzB,KAAK+B,IAAc,IAC/BA,GAAa,KAAK,IAAI,EAAG,KAAK,IAAI,EAAGA,EAAU,CAAC,EAMjC,KAAK,UAClB,CAAE,EAAGV,GAAO,GAAK,EAAGC,EAAO,IAC3BzC,EACAf,EAAO,gBAWLD,EAEK,KAUF,CACL,IAAK,CAAE,EAAGwD,GAAO,GAAK,EAAGC,EAAO,IAChC,KAAM,CACJ,GAAI/B,EAAQU,GAAK,GACjB,GAAIT,EAAQU,GAAK,GACjB,GAAIX,EAAQU,GAAK,GACjB,GAAIT,EAAQU,GAAK,IAEnB,KAAMrB,EACN,KAAM,CAAE,EAAGM,EAAM,EAAGC,EAAM,EAAGsC,GAAO,EAAGC,EAAA,EACvC,WAAAI,EAAA,GA9BAtF,GAAK,oCAAqC,CACxC,YAAa,KAAK,YAClB,WAAYqB,EAAO,eACnB,QAASA,EAAO,QACjB,EACM,KA2BX,CAGA,OAAOlW,EAAkBkY,EAAoB,CAM3C,GALA,KAAK,aAAe,KAAK,MAEzB,KAAK,QAAU,KACf,KAAK,SAAW,EAChB,KAAK,YAAc,EACf,CAAC,KAAK,GAAI,OACd,KAAM,CAAE,MAAO/S,CAAA,EAAMnF,EACf4V,EAAK,KAAK,GACV,CAAE,EAAAzhB,EAAG,EAAA2hB,EAAG,EAAGuE,EAAI,EAAGC,GAAOpC,EAAI,KAC7BvC,EAAQ,GACd,QAAS4E,EAAKzE,EAAGyE,EAAKzE,EAAIwE,EAAIC,IAC5B,QAASC,EAAKrmB,EAAGqmB,EAAKrmB,EAAIkmB,EAAIG,IAAM,CAClC,MAAM/mB,EAAI8mB,EAAKpV,EAAIqV,EACb3pB,EAAI4C,EAAI,EACR/B,EAAIsO,EAAM,KAAKnP,CAAC,EACpBI,EAAI+O,EAAM,KAAKnP,EAAI,CAAC,EACpBK,EAAI8O,EAAM,KAAKnP,EAAI,CAAC,EAChBglB,EAAO,KAAQnkB,EAAI,KAAQT,EAAI,KAAQC,EAC7C0kB,EAAGniB,CAAC,GAAK,EAAIkiB,GAASC,EAAGniB,CAAC,EAAIkiB,EAAQE,CACxC,CAEJ,CAGQ,UAAU4E,EAAY7Q,EAAc8Q,EAA4B,CACtE,MAAMC,EAAQ,CAAC3pB,EAAUE,IAAa,KAAK,MAAMF,EAAE,EAAIE,EAAE,EAAGF,EAAE,EAAIE,EAAE,CAAC,GAAK,EAC1E,GAAI,CAAC,KAAK,QACR,YAAK,QAAU,CAAE,GAAGupB,CAAA,EACpB,KAAK,SAAW7Q,EAChB,KAAK,YAAc,EACZ,GAET,GACE+Q,EAAM,KAAK,QAASF,CAAG,GACvB,KAAK,IAAI7Q,EAAO,KAAK,QAAQ,EAAI,KAAK,IAAI,EAAGA,CAAI,EAAI,GAErD,KAAK,QAAU,CAAE,GAAG6Q,CAAA,EACpB,KAAK,SAAW7Q,EAChB,KAAK,kBAEL,aAAK,QAAU,CAAE,GAAG6Q,CAAA,EACpB,KAAK,SAAW7Q,EAChB,KAAK,YAAc,EACZ,GAET,MAAMhZ,EAAI,KAAK,IAAI,EAAG8pB,GAAY,KAAK,cAAc,EACrD,OAAO,KAAK,aAAe9pB,CAC7B,CAEQ,QAAQulB,EAAkBhR,EAAW9T,EAAW,CACtD,MAAMupB,EAAM,IAAI,WAAWzE,EAAK,MAAM,EACtC,QAASL,EAAI,EAAGA,EAAIzkB,EAAGykB,IACrB,QAAS3hB,EAAI,EAAGA,EAAIgR,EAAGhR,IAAK,CAC1B,IAAIqZ,EAAK,EACT,QAASlO,EAAI,GAAIA,GAAK,EAAGA,IAAK,CAC5B,QAAS7L,EAAI,GAAIA,GAAK,EAAGA,IAAK,CAC5B,MAAM8mB,EAAKzE,EAAIxW,EACbkb,EAAKrmB,EAAIV,EACX,GAAI,EAAA8mB,EAAK,GAAKA,GAAMlpB,GAAKmpB,EAAK,GAAKA,GAAMrV,IACrCgR,EAAKoE,EAAKpV,EAAIqV,CAAE,EAAG,CACrBhN,EAAK,EACL,KACF,CACF,CACA,GAAIA,EAAI,KACV,CACAoN,EAAI9E,EAAI3Q,EAAIhR,CAAC,EAAIqZ,CACnB,CAEF2I,EAAK,IAAIyE,CAAG,CACd,CAEQ,OAAOzE,EAAkBhR,EAAW9T,EAAW,CACrD,MAAMupB,EAAM,IAAI,WAAWzE,EAAK,MAAM,EACtC,QAASL,EAAI,EAAGA,EAAIzkB,EAAGykB,IACrB,QAAS3hB,EAAI,EAAGA,EAAIgR,EAAGhR,IAAK,CAC1B,IAAIqZ,EAAK,EACT,QAASlO,EAAI,GAAIA,GAAK,EAAGA,IAAK,CAC5B,QAAS7L,EAAI,GAAIA,GAAK,EAAGA,IAAK,CAC5B,MAAM8mB,EAAKzE,EAAIxW,EACbkb,EAAKrmB,EAAIV,EACX,GAAI,EAAA8mB,EAAK,GAAKA,GAAMlpB,GAAKmpB,EAAK,GAAKA,GAAMrV,IACrC,CAACgR,EAAKoE,EAAKpV,EAAIqV,CAAE,EAAG,CACtBhN,EAAK,EACL,KACF,CACF,CACA,GAAI,CAACA,EAAI,KACX,CACAoN,EAAI9E,EAAI3Q,EAAIhR,CAAC,EAAIqZ,CACnB,CAEF2I,EAAK,IAAIyE,CAAG,CACd,CACF,aCzjBMC,GAAmBC,GAAgB,CACvC,IAAIrgB,EACJ,MAAMsgB,MAAgC,IAChCC,EAAW,CAACC,EAASC,IAAY,CACrC,MAAMC,EAAY,OAAOF,GAAY,WAAaA,EAAQxgB,CAAK,EAAIwgB,EACnE,GAAI,CAAC,OAAO,GAAGE,EAAW1gB,CAAK,EAAG,CAChC,MAAM2gB,EAAgB3gB,EACtBA,EAASygB,IAA4B,OAAOC,GAAc,UAAYA,IAAc,MAAQA,EAAY,OAAO,OAAO,GAAI1gB,EAAO0gB,CAAS,EAC1IJ,EAAU,QAASM,GAAaA,EAAS5gB,EAAO2gB,CAAa,CAAC,CAChE,CACF,EACME,EAAW,IAAM7gB,EAcjB8gB,EAAM,CAAE,SAAAP,EAAU,SAAAM,EAAU,gBAbV,IAAME,EAaqB,UAZhCH,IACjBN,EAAU,IAAIM,CAAQ,EACf,IAAMN,EAAU,OAAOM,CAAQ,GAUsB,QAR9C,IAAM,EACfpO,GAAkB,aAAuB,UAAY,cACxD,QAAQ,KACN,0MAGJ8N,EAAU,OACZ,CAC8D,EACxDS,EAAe/gB,EAAQqgB,EAAYE,EAAUM,EAAUC,CAAG,EAChE,OAAOA,CACT,EACME,GAAeX,GAAgBA,EAAcD,GAAgBC,CAAW,EAAID;;;;;;;;6CClBlF,IAAIphB,EAAQjJ,GAAA,EACZ,SAASkrB,EAAGvnB,EAAG2hB,EAAG,CAChB,OAAQ3hB,IAAM2hB,IAAY3hB,IAAN,GAAW,EAAIA,IAAM,EAAI2hB,IAAQ3hB,IAAMA,GAAK2hB,IAAMA,CACxE,CACA,IAAI6F,EAA0B,OAAO,OAAO,IAA7B,WAAkC,OAAO,GAAKD,EAC3DlpB,EAAWiH,EAAM,SACjB8T,EAAY9T,EAAM,UAClBmiB,EAAkBniB,EAAM,gBACxBoiB,EAAgBpiB,EAAM,cACxB,SAASqiB,EAAuBC,EAAWC,EAAa,CACtD,IAAI5pB,EAAQ4pB,EAAW,EACrBpmB,EAAYpD,EAAS,CAAE,KAAM,CAAE,MAAOJ,EAAO,YAAa4pB,CAAW,EAAI,EACzEC,EAAOrmB,EAAU,CAAC,EAAE,KACpBsmB,EAActmB,EAAU,CAAC,EAC3B,OAAAgmB,EACE,UAAY,CACVK,EAAK,MAAQ7pB,EACb6pB,EAAK,YAAcD,EACnBG,EAAuBF,CAAI,GAAKC,EAAY,CAAE,KAAMD,CAAI,CAAE,CAChE,EACI,CAACF,EAAW3pB,EAAO4pB,CAAW,GAEhCzO,EACE,UAAY,CACV,OAAA4O,EAAuBF,CAAI,GAAKC,EAAY,CAAE,KAAMD,CAAI,CAAE,EACnDF,EAAU,UAAY,CAC3BI,EAAuBF,CAAI,GAAKC,EAAY,CAAE,KAAMD,CAAI,CAAE,CAClE,CAAO,CACP,EACI,CAACF,CAAS,GAEZF,EAAczpB,CAAK,EACZA,CACT,CACA,SAAS+pB,EAAuBF,EAAM,CACpC,IAAIG,EAAoBH,EAAK,YAC7BA,EAAOA,EAAK,MACZ,GAAI,CACF,IAAII,EAAYD,EAAiB,EACjC,MAAO,CAACT,EAASM,EAAMI,CAAS,CACpC,MAAkB,CACd,MAAO,EACX,CACA,CACA,SAASC,EAAuBP,EAAWC,EAAa,CACtD,OAAOA,EAAW,CACpB,CACA,IAAIO,EACc,OAAO,OAAvB,KACgB,OAAO,OAAO,SAA9B,KACgB,OAAO,OAAO,SAAS,cAAvC,IACID,EACAR,EACN,OAAAU,GAAA,qBACa/iB,EAAM,uBAAjB,OAAwCA,EAAM,qBAAuB8iB,2CC9DrEE,GAAA,QAAiBjsB,GAAA;;;;;;;;6CCQnB,IAAIiJ,EAAQjJ,GAAA,EACV+rB,EAAOG,GAAA,EACT,SAAShB,EAAGvnB,EAAG2hB,EAAG,CAChB,OAAQ3hB,IAAM2hB,IAAY3hB,IAAN,GAAW,EAAIA,IAAM,EAAI2hB,IAAQ3hB,IAAMA,GAAK2hB,IAAMA,CACxE,CACA,IAAI6F,EAA0B,OAAO,OAAO,IAA7B,WAAkC,OAAO,GAAKD,EAC3DiB,EAAuBJ,EAAK,qBAC5BvmB,EAASyD,EAAM,OACf8T,EAAY9T,EAAM,UAClBD,EAAUC,EAAM,QAChBoiB,EAAgBpiB,EAAM,cACxB,OAAAmjB,GAAA,iCAA2C,SACzCb,EACAC,EACAa,EACAC,EACAC,EACA,CACA,IAAIC,EAAUhnB,EAAO,IAAI,EACzB,GAAagnB,EAAQ,UAAjB,KAA0B,CAC5B,IAAIf,EAAO,CAAE,SAAU,GAAI,MAAO,IAAI,EACtCe,EAAQ,QAAUf,CACtB,MAASA,EAAOe,EAAQ,QACtBA,EAAUxjB,EACR,UAAY,CACV,SAASyjB,EAAiBC,EAAc,CACtC,GAAI,CAACC,EAAS,CAIZ,GAHAA,EAAU,GACVC,EAAmBF,EACnBA,EAAeJ,EAASI,CAAY,EACrBH,IAAX,QAAsBd,EAAK,SAAU,CACvC,IAAIoB,EAAmBpB,EAAK,MAC5B,GAAIc,EAAQM,EAAkBH,CAAY,EACxC,OAAQI,EAAoBD,CAC1C,CACU,OAAQC,EAAoBJ,CACtC,CAEQ,GADAG,EAAmBC,EACf3B,EAASyB,EAAkBF,CAAY,EAAG,OAAOG,EACrD,IAAIE,EAAgBT,EAASI,CAAY,EACzC,OAAeH,IAAX,QAAsBA,EAAQM,EAAkBE,CAAa,GACvDH,EAAmBF,EAAeG,IAC5CD,EAAmBF,EACXI,EAAoBC,EACpC,CACM,IAAIJ,EAAU,GACZC,EACAE,EACAE,EACaX,IAAX,OAA+B,KAAOA,EAC1C,MAAO,CACL,UAAY,CACV,OAAOI,EAAiBjB,GAAa,CAC/C,EACiBwB,IAAT,KACI,OACA,UAAY,CACV,OAAOP,EAAiBO,GAAwB,CAC9D,EAEA,EACI,CAACxB,EAAaa,EAAmBC,EAAUC,CAAO,GAEpD,IAAI3qB,EAAQuqB,EAAqBZ,EAAWiB,EAAQ,CAAC,EAAGA,EAAQ,CAAC,CAAC,EAClE,OAAAzP,EACE,UAAY,CACV0O,EAAK,SAAW,GAChBA,EAAK,MAAQ7pB,CACnB,EACI,CAACA,CAAK,GAERypB,EAAczpB,CAAK,EACZA,CACT,2CCjFEqrB,GAAA,QAAiBjtB,GAAA,gDCEb,CAAE,cAAAqrB,IAAkB6B,GACpB,CAAE,iCAAAC,IAAqCC,GAC7C,IAAIC,GAAyB,GAC7B,MAAMC,GAAYC,GAAQA,EAC1B,SAASC,GAASzC,EAAKuB,EAAWgB,GAAUG,EAAY,EACjDhR,GAAkB,aAAuB,UAAY,cAAgBgR,GAAc,CAACJ,KACvF,QAAQ,KACN,0NAEFA,GAAyB,IAE3B,MAAMK,EAAQP,GACZpC,EAAI,UACJA,EAAI,SACJA,EAAI,gBAAkBA,EAAI,gBAC1BuB,EACAmB,CAAA,EAEF,OAAApC,GAAcqC,CAAK,EACZA,CACT,CACA,MAAMC,GAAcrD,GAAgB,EAC7B7N,GAAkB,aAAuB,UAAY,cAAgB,OAAO6N,GAAgB,YAC/F,QAAQ,KACN,mIAGJ,MAAMS,EAAM,OAAOT,GAAgB,WAAaW,GAAYX,CAAW,EAAIA,EACrEsD,EAAgB,CAACtB,EAAUmB,IAAeD,GAASzC,EAAKuB,EAAUmB,CAAU,EAClF,cAAO,OAAOG,EAAe7C,CAAG,EACzB6C,CACT,EACMC,GAAUvD,GAAgBA,EAAcqD,GAAWrD,CAAW,EAAIqD,GCkB3DG,GAAiBD,KAA4BtX,IAAS,CAEjE,OAAQ,GACR,SAAU,KACV,YAAa,KACb,aAAc,KACd,cAAe,KACf,SAAU,KACV,UAAW,KACX,UAAW,GAEX,EAAG,KACH,UAAW,KACX,YAAa,KACb,MAAO,KACP,kBAAmB,KACnB,aAAc,KACd,QAAS,KACT,WAAY,KACZ,QAAS,KAET,eAAiBkU,GAAYlU,EAAIkU,CAAc,EAE/C,eAAgB,CAACsD,EAAOC,EAAQC,EAASC,IACvC3X,EAAI,CACF,OAAQ,GACR,SAAU,KAAK,MACf,YAAawX,EACb,aAAcC,EACd,cAAeC,EACf,SAAAC,EACA,UAAW,KAAK,KAAI,CACrB,EAEH,iBAAkB,IAChB3X,EAAI,CACF,OAAQ,GACR,SAAU,KACV,YAAa,KACb,aAAc,KACd,cAAe,KAChB,EAEH,MAAO,IACLA,EAAI,CACF,OAAQ,GACR,SAAU,KACV,YAAa,KACb,aAAc,KACd,cAAe,KACf,SAAU,KACV,UAAW,KACZ,CACL,EAAE,QC2IF,SAAS4X,GAAkBC,EAAYhqB,EAAS,CAC9C,IAAIiqB,EACJ,GAAI,CACFA,EAAUD,EAAA,CACZ,MAAa,CACX,MACF,CAsBA,MArBuB,CACrB,QAAUE,GAAS,CACjB,IAAIliB,EACJ,MAAMmiB,EAASC,GACTA,IAAS,KACJ,KAEF,KAAK,MAAMA,EAAwB,MAAwB,EAE9DC,GAAOriB,EAAKiiB,EAAQ,QAAQC,CAAI,IAAM,KAAOliB,EAAK,KACxD,OAAIqiB,aAAe,QACVA,EAAI,KAAKF,CAAK,EAEhBA,EAAME,CAAG,CAClB,EACA,QAAS,CAACH,EAAM5rB,IAAa2rB,EAAQ,QACnCC,EACA,KAAK,UAAU5rB,EAA4B,MAAyB,GAEtE,WAAa4rB,GAASD,EAAQ,WAAWC,CAAI,EAGjD,CACA,MAAMI,GAAcC,GAAQpP,GAAU,CACpC,GAAI,CACF,MAAM/T,EAASmjB,EAAGpP,CAAK,EACvB,OAAI/T,aAAkB,QACbA,EAEF,CACL,KAAKojB,EAAa,CAChB,OAAOF,GAAWE,CAAW,EAAEpjB,CAAM,CACvC,EACA,MAAMqjB,EAAa,CACjB,OAAO,IACT,EAEJ,OAASjuB,EAAG,CACV,MAAO,CACL,KAAKkuB,EAAc,CACjB,OAAO,IACT,EACA,MAAMC,EAAY,CAChB,OAAOL,GAAWK,CAAU,EAAEnuB,CAAC,CACjC,EAEJ,CACF,EACMouB,GAAU,CAACC,EAAQC,IAAgB,CAAC3Y,EAAK4Y,EAAKpE,IAAQ,CAC1D,IAAI3mB,EAAU,CACZ,WAAY,IAAM,aAClB,UAAW,KAAK,UAChB,YAAa,KAAK,MAClB,WAAa6F,GAAUA,EACvB,QAAS,EACT,MAAO,CAACmlB,EAAgBC,KAAkB,CACxC,GAAGA,EACH,GAAGD,CAAA,GAEL,GAAGF,CAAA,EAEDI,EAAc,GAClB,MAAMC,MAAyC,IACzCC,MAA+C,IACrD,IAAInB,EACJ,GAAI,CACFA,EAAUjqB,EAAQ,YACpB,MAAa,CACb,CACA,GAAI,CAACiqB,EACH,OAAOY,EACL,IAAI3K,IAAS,CACX,QAAQ,KACN,uDAAuDlgB,EAAQ,IAAI,kDAErEmS,EAAI,GAAG+N,CAAI,CACb,EACA6K,EACApE,CAAA,EAGJ,MAAM0E,EAAoBf,GAAWtqB,EAAQ,SAAS,EAChDsrB,EAAU,IAAM,CACpB,MAAMzlB,EAAQ7F,EAAQ,WAAW,CAAE,GAAG+qB,EAAA,EAAO,EAC7C,IAAIQ,EACJ,MAAMC,EAAWH,EAAkB,CAAE,MAAAxlB,EAAO,QAAS7F,EAAQ,QAAS,EAAE,KACrEyrB,GAAoBxB,EAAQ,QAAQjqB,EAAQ,KAAMyrB,CAAe,GAClE,MAAOjvB,GAAM,CACb+uB,EAAc/uB,CAChB,CAAC,EACD,GAAI+uB,EACF,MAAMA,EAER,OAAOC,CACT,EACME,EAAgB/E,EAAI,SAC1BA,EAAI,SAAW,CAAC9gB,EAAOygB,IAAY,CACjCoF,EAAc7lB,EAAOygB,CAAO,EACvBgF,EAAA,CACP,EACA,MAAMK,EAAed,EACnB,IAAI3K,IAAS,CACX/N,EAAI,GAAG+N,CAAI,EACNoL,EAAA,CACP,EACAP,EACApE,CAAA,EAEF,IAAIiF,EACJ,MAAMC,EAAU,IAAM,CACpB,IAAI7jB,EACJ,GAAI,CAACiiB,EAAS,OACdiB,EAAc,GACdC,EAAmB,QAAS3rB,GAAOA,EAAGurB,EAAA,CAAK,CAAC,EAC5C,MAAMe,IAA4B9jB,EAAKhI,EAAQ,qBAAuB,KAAO,OAASgI,EAAG,KAAKhI,EAAS+qB,EAAA,CAAK,IAAM,OAClH,OAAOT,GAAWL,EAAQ,QAAQ,KAAKA,CAAO,CAAC,EAAEjqB,EAAQ,IAAI,EAAE,KAAM+rB,GAAiB,CACpF,GAAIA,EACF,OAAO/rB,EAAQ,YAAY+rB,CAAY,CAE3C,CAAC,EAAE,KAAMC,GAA6B,CACpC,GAAIA,EACF,GAAI,OAAOA,EAAyB,SAAY,UAAYA,EAAyB,UAAYhsB,EAAQ,QAAS,CAChH,GAAIA,EAAQ,QACV,OAAOA,EAAQ,QACbgsB,EAAyB,MACzBA,EAAyB,SAG7B,QAAQ,MACN,wFAEJ,KACE,QAAOA,EAAyB,KAGtC,CAAC,EAAE,KAAMC,GAAkB,CACzB,IAAIC,EACJ,OAAAN,EAAmB5rB,EAAQ,MACzBisB,GACCC,EAAMnB,MAAU,KAAOmB,EAAMP,CAAA,EAEhCxZ,EAAIyZ,EAAkB,EAAI,EACnBN,EAAA,CACT,CAAC,EAAE,KAAK,IAAM,CAC+BQ,IAAwBF,EAAkB,MAAM,EAC3FV,EAAc,GACdE,EAAyB,QAAS5rB,GAAOA,EAAGosB,CAAgB,CAAC,CAC/D,CAAC,EAAE,MAAOpvB,GAAM,CAC6BsvB,IAAwB,OAAQtvB,CAAC,CAC9E,CAAC,CACH,EACA,OAAAmqB,EAAI,QAAU,CACZ,WAAapU,GAAe,CAC1BvS,EAAU,CACR,GAAGA,EACH,GAAGuS,CAAA,EAEDA,EAAW,aACb0X,EAAU1X,EAAW,aAEzB,EACA,aAAc,IAAM,CACS0X,GAAQ,WAAWjqB,EAAQ,IAAI,CAC5D,EACA,WAAY,IAAMA,EAClB,UAAW,IAAM6rB,EAAA,EACjB,YAAa,IAAMX,EACnB,UAAY1rB,IACV2rB,EAAmB,IAAI3rB,CAAE,EAClB,IAAM,CACX2rB,EAAmB,OAAO3rB,CAAE,CAC9B,GAEF,kBAAoBA,IAClB4rB,EAAyB,IAAI5rB,CAAE,EACxB,IAAM,CACX4rB,EAAyB,OAAO5rB,CAAE,CACpC,EACF,EAEFqsB,EAAA,EACOD,GAAoBD,CAC7B,EACMQ,GAAU,CAACtB,EAAQC,IAAgB,CAAC3Y,EAAK4Y,EAAKpE,IAAQ,CAC1D,IAAI3mB,EAAU,CACZ,QAAS+pB,GAAkB,IAAM,YAAY,EAC7C,WAAalkB,GAAUA,EACvB,QAAS,EACT,MAAO,CAACmlB,EAAgBC,KAAkB,CACxC,GAAGA,EACH,GAAGD,CAAA,GAEL,GAAGF,CAAA,EAEDI,EAAc,GAClB,MAAMC,MAAyC,IACzCC,MAA+C,IACrD,IAAInB,EAAUjqB,EAAQ,QACtB,GAAI,CAACiqB,EACH,OAAOY,EACL,IAAI3K,IAAS,CACX,QAAQ,KACN,uDAAuDlgB,EAAQ,IAAI,kDAErEmS,EAAI,GAAG+N,CAAI,CACb,EACA6K,EACApE,CAAA,EAGJ,MAAM2E,EAAU,IAAM,CACpB,MAAMzlB,EAAQ7F,EAAQ,WAAW,CAAE,GAAG+qB,EAAA,EAAO,EAC7C,OAAOd,EAAQ,QAAQjqB,EAAQ,KAAM,CACnC,MAAA6F,EACA,QAAS7F,EAAQ,QAClB,CACH,EACM0rB,EAAgB/E,EAAI,SAC1BA,EAAI,SAAW,CAAC9gB,EAAOygB,IAAY,CACjCoF,EAAc7lB,EAAOygB,CAAO,EACvBgF,EAAA,CACP,EACA,MAAMK,EAAed,EACnB,IAAI3K,IAAS,CACX/N,EAAI,GAAG+N,CAAI,EACNoL,EAAA,CACP,EACAP,EACApE,CAAA,EAEFA,EAAI,gBAAkB,IAAMgF,EAC5B,IAAIC,EACJ,MAAMC,EAAU,IAAM,CACpB,IAAI7jB,EAAI6I,EACR,GAAI,CAACoZ,EAAS,OACdiB,EAAc,GACdC,EAAmB,QAAS3rB,GAAO,CACjC,IAAI0sB,EACJ,OAAO1sB,GAAI0sB,EAAMnB,EAAA,IAAU,KAAOmB,EAAMP,CAAY,CACtD,CAAC,EACD,MAAMG,IAA4Bjb,EAAK7Q,EAAQ,qBAAuB,KAAO,OAAS6Q,EAAG,KAAK7Q,GAAUgI,EAAK+iB,EAAA,IAAU,KAAO/iB,EAAK2jB,CAAY,IAAM,OACrJ,OAAOrB,GAAWL,EAAQ,QAAQ,KAAKA,CAAO,CAAC,EAAEjqB,EAAQ,IAAI,EAAE,KAAMgsB,GAA6B,CAChG,GAAIA,EACF,GAAI,OAAOA,EAAyB,SAAY,UAAYA,EAAyB,UAAYhsB,EAAQ,QAAS,CAChH,GAAIA,EAAQ,QACV,MAAO,CACL,GACAA,EAAQ,QACNgsB,EAAyB,MACzBA,EAAyB,QAC3B,EAGJ,QAAQ,MACN,wFAEJ,KACE,OAAO,CAAC,GAAOA,EAAyB,KAAK,EAGjD,MAAO,CAAC,GAAO,MAAM,CACvB,CAAC,EAAE,KAAMI,GAAoB,CAC3B,IAAIF,EACJ,KAAM,CAACG,EAAUJ,CAAa,EAAIG,EAMlC,GALAR,EAAmB5rB,EAAQ,MACzBisB,GACCC,EAAMnB,MAAU,KAAOmB,EAAMP,CAAA,EAEhCxZ,EAAIyZ,EAAkB,EAAI,EACtBS,EACF,OAAOf,EAAA,CAEX,CAAC,EAAE,KAAK,IAAM,CAC+BQ,IAAwBF,EAAkB,MAAM,EAC3FA,EAAmBb,EAAA,EACnBG,EAAc,GACdE,EAAyB,QAAS5rB,GAAOA,EAAGosB,CAAgB,CAAC,CAC/D,CAAC,EAAE,MAAOpvB,GAAM,CAC6BsvB,IAAwB,OAAQtvB,CAAC,CAC9E,CAAC,CACH,EACA,OAAAmqB,EAAI,QAAU,CACZ,WAAapU,GAAe,CAC1BvS,EAAU,CACR,GAAGA,EACH,GAAGuS,CAAA,EAEDA,EAAW,UACb0X,EAAU1X,EAAW,QAEzB,EACA,aAAc,IAAM,CACS0X,GAAQ,WAAWjqB,EAAQ,IAAI,CAC5D,EACA,WAAY,IAAMA,EAClB,UAAW,IAAM6rB,EAAA,EACjB,YAAa,IAAMX,EACnB,UAAY1rB,IACV2rB,EAAmB,IAAI3rB,CAAE,EAClB,IAAM,CACX2rB,EAAmB,OAAO3rB,CAAE,CAC9B,GAEF,kBAAoBA,IAClB4rB,EAAyB,IAAI5rB,CAAE,EACxB,IAAM,CACX4rB,EAAyB,OAAO5rB,CAAE,CACpC,EACF,EAEGQ,EAAQ,eACX6rB,EAAA,EAEKD,GAAoBD,CAC7B,EACMW,GAAc,CAACzB,EAAQC,IACvB,eAAgBA,GAAe,cAAeA,GAAe,gBAAiBA,IAC3EzS,GAAkB,aAAuB,UAAY,cACxD,QAAQ,KACN,kHAGGuS,GAAQC,EAAQC,CAAW,GAE7BqB,GAAQtB,EAAQC,CAAW,EAE9ByB,GAAUD,GCvjBhB,IAAIE,GAAiD,KACjDC,GAA2C,KAC3CC,GAAwC,KACxCC,GAAgC,KAIhCC,GAAiB,EAEjBC,GAA2C,KAC3CC,GAAsC,KAC1C,MAAMC,GAAwB,IA6CjBC,GAAmBvD,GAAA,EAC9B8C,GACGpa,IAAS,CACR,YAAa,GACb,KAAM,QACN,YAAa,KACb,UAAW,KACX,SAAU,GACV,UAAW,KACX,YAAa,GACb,WAAY,GAEZ,aAAe8a,GAAc,CAE3B9a,EAAI,CAAE,YAAa8a,EAAW,EAE1BA,GAAW9a,EAAI,CAAE,WAAY,GAAO,CAC1C,EACA,YAAc+a,GAAa,CAEzB/a,EAAI,CAAE,WAAY+a,EAAU,CAC9B,EACA,QAAUC,GAAS,CAEjBhb,EAAI,CAAE,KAAAgb,EAAM,CACd,EACA,eAAiBC,GAASjb,EAAI,CAAE,YAAaib,EAAM,EACnD,aAAeC,GAASlb,EAAI,CAAE,UAAWkb,EAAM,EAC/C,UAAYC,GAAWnb,EAAI,CAAE,SAAUmb,EAAQ,EAC/C,aAAe3S,GAAQxI,EAAI,CAAE,UAAWwI,EAAK,EAC7C,eAAiBzC,GAAM/F,EAAI,CAAE,YAAa,CAAC,CAAC+F,EAAG,EAG/C,eAAiBqV,GAAW,CAEtB,CAACA,GAAUX,GAAiB,IAChCH,GAAuBc,EACzB,EACA,eAAgB,IAAM,CAEpB,GAAId,GAAsB,OAAOA,GAGjC,GAAI,CAEF,MAAM,EADID,IACI,WAAoC,KAClD,GAAI,EAAG,OAAO,CAChB,MAAQ,CAAC,CACT,OAAO,IACT,EAEA,SAAWgB,GAAO,CAChBd,GAAcc,CAChB,EACA,SAAU,IAAMd,GAEhB,SAAWe,GAAO,CAChBd,GAAcc,CAChB,EACA,SAAU,IAAMd,GAGhB,mBAAoB,IACNH,GAMd,mBAAqBjvB,GAAQ,CAC3B,GAAI,CAGF,GAAIA,IAAQ,KAAM,CACZuvB,KACF,aAAaA,EAAoB,EACjCA,GAAuB,KACvBD,GAAkB,MAEpB5M,GAAK,6DAA6D,EAClEuM,GAAwB,KACxB,MACF,CAGA,GAAI,CAACA,GAAuB,CAC1BvM,GACE,yEACA,CACE,QAAS1iB,EAAI,QACb,UAAW,CAAC,CAACA,EAAI,UACnB,EAEFivB,GAAwBjvB,EACxB,MACF,CAGA,GAAIivB,KAA0BjvB,EAAK,OAM/BuvB,KACF,aAAaA,EAAoB,EACjCA,GAAuB,MAEzBD,GAAkBtvB,EAClBuvB,GAAuB,OAAO,WAAW,IAAM,CAC7C,GAAI,CACF7M,GACE,qEACA,CACE,QAAS4M,IAAiB,QAC1B,UAAW,CAAC,CAACA,IAAiB,UAChC,EAEFL,GAAwBK,EAC1B,OAASrwB,EAAG,CACVyjB,GAAK,qDAAsDzjB,CAAC,CAC9D,SACEqwB,GAAkB,KAClBC,GAAuB,IACzB,CACF,EAAGC,EAA4B,CACjC,MAAY,CAEZ,CACF,EAEA,iBAAmBW,GAAqB,CACtCd,IAAkB,CACpB,EACA,iBAAmBc,GAAqB,CACtCd,GAAiB,KAAK,IAAI,EAAGA,GAAiB,CAAC,CACjD,EAEA,aAAc,IAAM,CAGdA,KAAmB,IACrBJ,GAAwB,KACxBC,GAAuB,MAEzBC,GAAc,KACdC,GAAc,KACdxa,EAAI,CACF,YAAa,GACb,YAAa,KACb,UAAW,KACX,SAAU,GACV,UAAW,KAEZ,CACH,IAEF,CACE,KAAM,qBACN,QAAS4X,GAAkB,IAAM,YAAY,EAE7C,WAAalkB,IAAW,CACtB,YAAaA,EAAM,YACnB,KAAMA,EAAM,KACZ,YAAaA,EAAM,YACnB,UAAWA,EAAM,UACjB,SAAUA,EAAM,SAChB,UAAWA,EAAM,UACjB,YAAaA,EAAM,aACrB,CACF,CAEJ,EC1Na8nB,GAAa,CACxB,UAAW,KACX,UAAW,KACX,YAAa,GACb,YAAa,IACb,YAAa,IACb,YAAa,GACf,EAEaC,GAAwBD,GAExBE,GAAc,CACzB,GAAI,EAAG,GAAI,EAAG,GAAI,EAAG,GAAI,GAAI,EAAG,GAAI,EAAG,GAAI,EAAG,GAAI,EAAG,GAAI,GAAI,EAAG,GAAI,CACtE,EAGO,SAASC,GAAQ1xB,EAAeE,EAA2B,CAChE,MAAMQ,EAAI,IAAI,MAAM,CAAC,EAAE,KAAK,CAAC,EAC7B,QAAS+B,EAAI,EAAGA,EAAI,EAAGA,IACrB,QAAS6L,EAAI,EAAGA,EAAI,EAAGA,IACrB,QAAS7O,EAAI,EAAGA,EAAI,EAAGA,IACrBiB,EAAE+B,EAAI,EAAI6L,CAAC,GAAKtO,EAAEyC,EAAI,EAAIhD,CAAC,EAAIS,EAAET,EAAI,EAAI6O,CAAC,EAIhD,OAAO5N,CACT,CAEO,SAASixB,GAAgBC,EAAe/xB,EAAiB,CAC9D,MAAMsD,EAAItD,EAAE,EACVilB,EAAIjlB,EAAE,EACFsU,EAAIyd,EAAE,CAAC,EAAIzuB,EAAIyuB,EAAE,CAAC,EAAI9M,EAAI8M,EAAE,CAAC,EAC7BC,GAAMD,EAAE,CAAC,EAAIzuB,EAAIyuB,EAAE,CAAC,EAAI9M,EAAI8M,EAAE,CAAC,GAAKzd,EACpC2d,GAAMF,EAAE,CAAC,EAAIzuB,EAAIyuB,EAAE,CAAC,EAAI9M,EAAI8M,EAAE,CAAC,GAAKzd,EAC1C,MAAO,CAAE,EAAG0d,EAAI,EAAGC,CAAA,CACrB,CAIO,SAASC,GACdH,EACAI,EACAC,EACY,CACZ,MAAO,CACLD,EAAKJ,EAAE,CAAC,EACRI,EAAKJ,EAAE,CAAC,EACRI,EAAKJ,EAAE,CAAC,EACRK,EAAKL,EAAE,CAAC,EACRK,EAAKL,EAAE,CAAC,EACRK,EAAKL,EAAE,CAAC,EACRA,EAAE,CAAC,EACHA,EAAE,CAAC,EACHA,EAAE,CAAC,EAEP,CAIO,SAASM,GACdN,EACAO,EACY,CACZ,MAAMC,EAAM,KAAK,IAAID,CAAY,EAC3BE,EAAM,KAAK,IAAIF,CAAY,EAE3BG,EAAgB,CAACF,EAAK,CAACC,EAAK,EAAGA,EAAKD,EAAK,EAAG,EAAG,EAAG,CAAC,EAIzD,OAAOV,GAAQE,EAAGU,CAAC,CACrB,CAIO,SAASC,GACdX,EACAY,EACAC,EACY,CAEZ,OAAOf,GADe,CAAC,EAAG,EAAGc,EAAI,EAAG,EAAGC,EAAI,EAAG,EAAG,CAAC,EAChCb,CAAC,CACrB,CAEO,SAASc,GAAiBd,EAA2B,CAE1D,MAAMjyB,EAAIiyB,EACJ5xB,EAAIL,EAAE,CAAC,EACXO,EAAIP,EAAE,CAAC,EACPI,EAAIJ,EAAE,CAAC,EACPQ,EAAIR,EAAE,CAAC,EACPS,EAAIT,EAAE,CAAC,EACPJ,EAAII,EAAE,CAAC,EACPM,EAAIN,EAAE,CAAC,EACPU,EAAIV,EAAE,CAAC,EACP8C,EAAI9C,EAAE,CAAC,EACHgzB,EAAIvyB,EAAIqC,EAAIlD,EAAIc,EAChBuyB,EAAI7yB,EAAIM,EAAIH,EAAIuC,EAChBowB,EAAI3yB,EAAIX,EAAIQ,EAAIK,EAChB0yB,EAAIvzB,EAAIU,EAAIE,EAAIsC,EAChBswB,EAAI/yB,EAAIyC,EAAI1C,EAAIE,EAChB+yB,EAAIjzB,EAAII,EAAIH,EAAIT,EAChB0zB,EAAI9yB,EAAIE,EAAID,EAAIH,EAChBizB,EAAKhzB,EAAID,EAAID,EAAIK,EACjB8yB,EAAInzB,EAAII,EAAIF,EAAIC,EAChB+mB,EAAMlnB,EAAI2yB,EAAIzyB,EAAI4yB,EAAI/yB,EAAIkzB,EAChC,GAAI,KAAK,IAAI/L,CAAG,EAAI,MAAO,MAAM,IAAI,MAAM,qBAAqB,EAYhE,MAXY,CACVyL,EAAIzL,EACJ0L,EAAI1L,EACJ2L,EAAI3L,EACJ4L,EAAI5L,EACJ6L,EAAI7L,EACJ8L,EAAI9L,EACJ+L,EAAI/L,EACJgM,EAAKhM,EACLiM,EAAIjM,CAAA,CAGR,CAKO,SAASkM,GAAqBC,EAAcC,EAA0B,CAC3E,GAAID,EAAI,OAAS,GAAKC,EAAI,OAAS,EACjC,MAAM,IAAI,MAAM,iCAAiC,EACnD,GAAID,EAAI,SAAWC,EAAI,OACrB,MAAM,IAAI,MAAM,wCAAwC,EAE1D,MAAMX,EAAgB,GAChBC,EAAc,GACpB,QAASnzB,EAAI,EAAGA,EAAI4zB,EAAI,OAAQ5zB,IAAK,CACnC,KAAM,CAAE,EAAG8zB,EAAG,EAAGC,CAAA,EAAMH,EAAI5zB,CAAC,EACtB,CAAE,EAAA0D,EAAM,EAAA2hB,GAASwO,EAAI7zB,CAAC,EAK5BkzB,EAAE,KAAK,CAACY,EAAGC,EAAG,EAAG,EAAG,EAAG,EAAG,CAACrwB,EAAIowB,EAAG,CAACpwB,EAAIqwB,CAAC,CAAC,EACzCZ,EAAE,KAAKzvB,CAAC,EACRwvB,EAAE,KAAK,CAAC,EAAG,EAAG,EAAGY,EAAGC,EAAG,EAAG,CAAC1O,EAAIyO,EAAG,CAACzO,EAAI0O,CAAC,CAAC,EACzCZ,EAAE,KAAK9N,CAAC,CACV,CACA,MAAMzkB,EAAIozB,GAAkBd,EAAGC,CAAC,EAEhC,MADsB,CAACvyB,EAAE,CAAC,EAAGA,EAAE,CAAC,EAAGA,EAAE,CAAC,EAAGA,EAAE,CAAC,EAAGA,EAAE,CAAC,EAAGA,EAAE,CAAC,EAAGA,EAAE,CAAC,EAAGA,EAAE,CAAC,EAAG,CAAC,CAE1E,CAGA,SAASozB,GAAkBd,EAAezyB,EAAuB,CAE/D,MAAMP,EAAIgzB,EAAE,OACV/yB,EAAI+yB,EAAE,CAAC,EAAE,OACLe,EAAkB,MAAM,KAAK,CAAE,OAAQ9zB,CAAA,EAAK,IAAM,IAAI,MAAMA,CAAC,EAAE,KAAK,CAAC,CAAC,EACtE+zB,EAAgB,IAAI,MAAM/zB,CAAC,EAAE,KAAK,CAAC,EACzC,QAASc,EAAI,EAAGA,EAAIf,EAAGe,IACrB,QAAS+B,EAAI,EAAGA,EAAI7C,EAAG6C,IAAK,CAC1BkxB,EAAIlxB,CAAC,GAAKkwB,EAAEjyB,CAAC,EAAE+B,CAAC,EAAIvC,EAAEQ,CAAC,EACvB,QAAS4N,EAAI,EAAGA,EAAI1O,EAAG0O,IACrBolB,EAAIjxB,CAAC,EAAE6L,CAAC,GAAKqkB,EAAEjyB,CAAC,EAAE+B,CAAC,EAAIkwB,EAAEjyB,CAAC,EAAE4N,CAAC,CAEjC,CAEF,OAAOslB,GAAcF,EAAKC,CAAG,CAC/B,CAEA,SAASC,GAAcC,EAAe/X,EAAuB,CAC3D,MAAMlc,EAAIkc,EAAE,OAEN6W,EAAIkB,EAAE,IAAI,CAACC,EAAKrxB,IAAMqxB,EAAI,OAAO,CAAChY,EAAErZ,CAAC,CAAC,CAAC,CAAC,EAC9C,QAASA,EAAI,EAAGA,EAAI7C,EAAG6C,IAAK,CAE1B,IAAIsxB,EAAStxB,EACb,QAAS/B,EAAI+B,EAAI,EAAG/B,EAAId,EAAGc,IACrB,KAAK,IAAIiyB,EAAEjyB,CAAC,EAAE+B,CAAC,CAAC,EAAI,KAAK,IAAIkwB,EAAEoB,CAAM,EAAEtxB,CAAC,CAAC,IAAGsxB,EAASrzB,GAE3D,GAAI,KAAK,IAAIiyB,EAAEoB,CAAM,EAAEtxB,CAAC,CAAC,EAAI,MAAO,MAAM,IAAI,MAAM,iBAAiB,EACrE,GAAIsxB,IAAWtxB,EAAG,CAChB,MAAM0kB,EAAMwL,EAAElwB,CAAC,EACfkwB,EAAElwB,CAAC,EAAIkwB,EAAEoB,CAAM,EACfpB,EAAEoB,CAAM,EAAI5M,CACd,CAEA,QAASzmB,EAAI+B,EAAI,EAAG/B,EAAId,EAAGc,IAAK,CAC9B,MAAM,EAAIiyB,EAAEjyB,CAAC,EAAE+B,CAAC,EAAIkwB,EAAElwB,CAAC,EAAEA,CAAC,EAC1B,QAAS1C,EAAI0C,EAAG1C,GAAKH,EAAGG,IAAK4yB,EAAEjyB,CAAC,EAAEX,CAAC,GAAK,EAAI4yB,EAAElwB,CAAC,EAAE1C,CAAC,CACpD,CACF,CAEA,MAAMoD,EAAI,IAAI,MAAMvD,CAAC,EAAE,KAAK,CAAC,EAC7B,QAAS6C,EAAI7C,EAAI,EAAG6C,GAAK,EAAGA,IAAK,CAC/B,IAAIuxB,EAAIrB,EAAElwB,CAAC,EAAE7C,CAAC,EACd,QAASG,EAAI0C,EAAI,EAAG1C,EAAIH,EAAGG,IAAKi0B,GAAKrB,EAAElwB,CAAC,EAAE1C,CAAC,EAAIoD,EAAEpD,CAAC,EAClDoD,EAAEV,CAAC,EAAIuxB,EAAIrB,EAAElwB,CAAC,EAAEA,CAAC,CACnB,CACA,OAAOU,CACT,CAKO,SAAS8wB,GACdlD,EAA2B,SAClB,CAIT,MAAMvM,GAEC+M,GAAW,YAAcA,GAAW,aAAe,EAGpD2C,EADgB,CAAC,GAAI,EAAG,EAAG,EAAE,EACH,IAAKC,GAAW,CAE9C,MAAMC,EADM3C,GAAY,QAAQ0C,CAAM,EACjB1C,GAAY,OAAU,KAAK,GAAK,EAAI,KAAK,GAAK,EAC7DtuB,EAAIqhB,EAAS,KAAK,IAAI4P,CAAK,EAC3BtP,EAAIN,EAAS,KAAK,IAAI4P,CAAK,EACjC,MAAO,CACL,EAAG,KAAK,IAAIjxB,CAAC,EAAI,KAAO,EAAIA,EAC5B,EAAG,KAAK,IAAI2hB,CAAC,EAAI,KAAO,EAAIA,CAAA,CAEhC,CAAC,EAED,OAAAoP,EAAU,KAAK,CAAE,EAAG,EAAG,EAAG,EAAG,EACtBA,CACT,CAGO,SAASG,GACdzC,EACApN,EACA8P,EAAQ,IACC,CACT,MAAMC,EAAe,GACrB,QAAS90B,EAAI,EAAGA,EAAI60B,EAAO70B,IAAK,CAC9B,MAAM+0B,EAAS/0B,EAAI60B,EAAS,KAAK,GAAK,EAChCz0B,EAAI8xB,GAAgBC,EAAG,CAC3B,EAAGpN,EAAS,KAAK,IAAIgQ,CAAK,EAC1B,EAAGhQ,EAAS,KAAK,IAAIgQ,CAAK,EAC3B,EACDD,EAAI,KAAK10B,CAAC,CACZ,CACA,OAAO00B,CACT,CAKO,SAASE,GACd7C,EACAb,EAA2B,QACnB,CAER,MAAM2D,EAAY/C,GAAgBC,EAAG,CAAE,EAAG,EAAG,EAAG,EAAG,EAK7C+C,EAAW,CAAE,EAAG,EAAG,EAAG,EAH1B5D,IAAS,QACLQ,GAAW,aACVA,GAAW,YAAcA,GAAW,aAAe,EAC7B,EACvBqD,EAASjD,GAAgBC,EAAG+C,CAAQ,EACpCtN,EAAKuN,EAAO,EAAIF,EAAU,EAC1BpN,EAAKsN,EAAO,EAAIF,EAAU,EAEhC,IAAIG,EAAU,KAAK,MAAMvN,EAAID,CAAE,EAAI,IAAO,KAAK,GAC/CwN,GAAUA,EAAS,KAAO,IAG1B,IAAIC,EAAQD,EADO,IAGnB,OAAAC,GAAUA,EAAQ,KAAO,IAAO,KAEjB,KAAK,MAAMA,EAAQ,EAAE,EAElB,GAAM,IAAM,EAChC,CAEO,SAASC,GAASnD,EAAeyB,EAAcC,EAAsB,CAC1E,IAAI0B,EAAK,EACT,QAASvyB,EAAI,EAAGA,EAAI4wB,EAAI,OAAQ5wB,IAAK,CACnC,MAAM5C,EAAI8xB,GAAgBC,EAAGyB,EAAI5wB,CAAC,CAAC,EAC7BsiB,EAAKllB,EAAE,EAAIyzB,EAAI7wB,CAAC,EAAE,EAClBuiB,EAAKnlB,EAAE,EAAIyzB,EAAI7wB,CAAC,EAAE,EACxBuyB,GAAMjQ,EAAKA,EAAKC,EAAKA,CACvB,CACA,OAAO,KAAK,KAAKgQ,EAAK3B,EAAI,MAAM,CAClC,CAUO,SAAS4B,GACd5B,EACAC,EACA4B,EAAsB,GACgD,CACtE,MAAMt1B,EAAIyzB,EAAI,OACd,GAAIzzB,EAAI,GAAK0zB,EAAI,OAAS,EACxB,MAAM,IAAI,MAAM,iCAAiC,EACnD,MAAM6B,EAAYD,EAAK,aAAe,EAChCE,EAAUF,EAAK,SAAW,IAC1BG,EAAaH,EAAK,YAAc,EAChCI,EAAMJ,EAAK,KAAO,KAAK,OAE7B,IAAIK,EAA2B,KAC3BC,EAAyB,IAAI,MAAM51B,CAAC,EAAE,KAAK,EAAK,EAChD61B,EAAY,EACZC,EAAY,IAEhB,QAASC,EAAO,EAAGA,EAAOP,EAASO,IAAQ,CAEzC,MAAMxP,MAAW,IACjB,KAAOA,EAAK,KAAO,GACjBA,EAAK,IAAI,KAAK,MAAMmP,EAAA,EAAQ11B,CAAC,CAAC,EAEhC,MAAMg2B,EAAS,MAAM,KAAKzP,CAAI,EACxB0P,EAAgB,GAChBC,EAAgB,GACtB,UAAWrzB,KAAKmzB,EACdC,EAAK,KAAKxC,EAAI5wB,CAAC,CAAC,EAChBqzB,EAAK,KAAKxC,EAAI7wB,CAAC,CAAC,EAElB,IAAIszB,EACJ,GAAI,CACFA,EAAO3C,GAAqByC,EAAMC,CAAI,CACxC,MAAY,CACV,QACF,CAGA,MAAME,EAAU,IAAI,MAAMp2B,CAAC,EAAE,KAAK,EAAK,EACvC,IAAIq2B,EAAQ,EACZ,QAASxzB,EAAI,EAAGA,EAAI7C,EAAG6C,IAAK,CAC1B,MAAM5C,EAAI8xB,GAAgBoE,EAAM1C,EAAI5wB,CAAC,CAAC,EAChCsiB,EAAKllB,EAAE,EAAIyzB,EAAI7wB,CAAC,EAAE,EAClBuiB,EAAKnlB,EAAE,EAAIyzB,EAAI7wB,CAAC,EAAE,EACX,KAAK,MAAMsiB,EAAIC,CAAE,GAClBmQ,IACVa,EAAQvzB,CAAC,EAAI,GACbwzB,IAEJ,CAEA,GAAIA,EAAQZ,EAAY,SAGxB,MAAMa,EAAe,GACfC,EAAe,GACrB,QAAS1zB,EAAI,EAAGA,EAAI7C,EAAG6C,IACjBuzB,EAAQvzB,CAAC,IACXyzB,EAAI,KAAK7C,EAAI5wB,CAAC,CAAC,EACf0zB,EAAI,KAAK7C,EAAI7wB,CAAC,CAAC,GAGnB,IAAI2zB,EACJ,GAAI,CACFA,EAAWhD,GAAqB8C,EAAKC,CAAG,CAC1C,MAAY,CACV,QACF,CACA,MAAMzX,EAAMqW,GAASqB,EAAUF,EAAKC,CAAG,GAGnCF,EAAQR,GAAcQ,IAAUR,GAAa/W,EAAMgX,KACrDD,EAAYQ,EACZP,EAAYhX,EACZ6W,EAAQa,EACRZ,EAAcQ,EAAQ,QAE1B,CAEA,GAAI,CAACT,GAASE,EAAYJ,EACxB,MAAO,CAAE,EAAG,KAAM,QAAS,IAAI,MAAMz1B,CAAC,EAAE,KAAK,EAAK,EAAG,QAAS,MAGhE,MAAMy2B,EAAgB,GAChBC,EAAgB,GACtB,QAAS7zB,EAAI,EAAGA,EAAI7C,EAAG6C,IACjB+yB,EAAY/yB,CAAC,IACf4zB,EAAK,KAAKhD,EAAI5wB,CAAC,CAAC,EAChB6zB,EAAK,KAAKhD,EAAI7wB,CAAC,CAAC,GAGpB,MAAM8zB,EAAaF,EAAK,OAAS,EAAItB,GAASQ,EAAOc,EAAMC,CAAI,EAAI,KACnE,MAAO,CAAE,EAAGf,EAAO,QAASC,EAAa,QAASe,CAAA,CACpD,CAIO,SAASC,GACdC,EACAC,EACc,CACd,GAAI,CACF,MAAMC,EAAMjE,GAAiB+D,CAAc,EACrCzrB,EAAS2mB,GAAgBgF,EAAmBD,CAAI,EAEtD,MAAI,CAAC,SAAS1rB,EAAO,CAAC,GAAK,CAAC,SAASA,EAAO,CAAC,EACpC,KAEFA,CACT,MAAY,CACV,OAAO,IACT,CACF,CAGO,SAAS4rB,GAAkB/2B,EAKhC,CACA,MAAMa,EAAI,KAAK,MAAMb,EAAE,EAAGA,EAAE,CAAC,EAG7B,IAAIg3B,EAFQ,KAAK,MAAMh3B,EAAE,EAAGA,EAAE,CAAC,EAEd,IAAO,KAAK,GAC7Bg3B,GAAOA,EAAM,IAAM,IAAM,IAKzB,MAAM9sB,EAAQ,KAAK,OAAQ8sB,EAAM,GAAK,IAAO,EAAE,EACzC1C,EAAS1C,GAAY1nB,CAAK,EAG1B,CACJ,UAAA+sB,EACA,UAAAC,EACA,YAAAC,EACA,YAAAC,EACA,YAAAC,EACA,YAAAC,CAAA,EACE5F,GAGE6F,EAAM,IAMZ,OAAI12B,EAAIy2B,EAHS,EAIR,CAAE,KAAM,EAAG,KAAM,OAAQ,OAAQ,KAAM,KAAM,GAGlDz2B,GAAKw2B,EAAcE,EACd,CAAE,KAAMjD,EAAS,EAAG,KAAM,SAAU,OAAAA,EAAQ,KAAM,GAGvDzzB,EAAIu2B,EAAcG,EACb,CAAE,KAAMjD,EAAQ,KAAM,SAAU,OAAAA,EAAQ,KAAM,GAGnDzzB,GAAKs2B,EAAcI,EACd,CAAE,KAAMjD,EAAS,EAAG,KAAM,SAAU,OAAAA,EAAQ,KAAM,GAGvDzzB,EAAIq2B,EAAYK,EACX,CAAE,KAAMjD,EAAQ,KAAM,SAAU,OAAAA,EAAQ,KAAM,GAGnDzzB,EAAIo2B,EAAY,GACX,CAAE,KAAM,GAAI,KAAM,OAAQ,OAAQ,GAAI,KAAM,GAE9C,CAAE,KAAM,GAAI,KAAM,aAAc,OAAQ,GAAI,KAAM,EAC3D,CAGO,SAASO,GACdx3B,EACA20B,EACA8C,EAAuB,EACvBC,EAA4B,EAM5B,CACA,MAAM72B,EAAI,KAAK,MAAMb,EAAE,EAAGA,EAAE,CAAC,EAK7B,IAAIg3B,GAHF,KAAK,MAAMh3B,EAAE,EAAGA,EAAE,CAAC,GAClB,OAAO,SAAS20B,CAAK,EAAIA,EAAQ,IACjC,OAAO,SAAS+C,CAAiB,EAAIA,EAAoB,IAC3C,IAAO,KAAK,GAC7BV,GAAOA,EAAM,IAAM,IAAM,IAEzB,MAAMW,IADQ,KAAK,OAAQX,EAAM,GAAK,IAAO,EAAE,GAEjC,OAAO,SAASS,CAAY,EAAIA,EAAe,IAAM,GAAM,IACvE,GACInD,EAAS1C,GAAY+F,CAAc,EAGnC,CACJ,UAAAV,EACA,UAAAC,EACA,YAAAC,EACA,YAAAC,EACA,YAAAC,EACA,YAAAC,CAAA,EACE5F,GAGE6F,EAAM,IAEZ,OAAI12B,EAAIy2B,EAAcC,EACb,CAAE,KAAM,EAAG,KAAM,OAAQ,OAAQ,KAAM,KAAM,GAElD12B,GAAKw2B,EAAcE,EACd,CAAE,KAAMjD,EAAS,EAAG,KAAM,SAAU,OAAAA,EAAQ,KAAM,GAEvDzzB,EAAIu2B,EAAcG,EACb,CAAE,KAAMjD,EAAQ,KAAM,SAAU,OAAAA,EAAQ,KAAM,GAEnDzzB,GAAKs2B,EAAcI,EACd,CAAE,KAAMjD,EAAS,EAAG,KAAM,SAAU,OAAAA,EAAQ,KAAM,GAEvDzzB,EAAIq2B,EAAYK,EACX,CAAE,KAAMjD,EAAQ,KAAM,SAAU,OAAAA,EAAQ,KAAM,GAEnDzzB,EAAIo2B,EAAY,GACX,CAAE,KAAM,GAAI,KAAM,OAAQ,OAAQ,GAAI,KAAM,GAE9C,CAAE,KAAM,GAAI,KAAM,aAAc,OAAQ,GAAI,KAAM,EAC3D,CAUO,SAASW,GACdC,EACAnD,EACAoD,EAAQ,UACRlT,EAAQ,EACR,CACA,GAAK8P,EAAI,OACT,CAAAmD,EAAI,OACJA,EAAI,YAAcC,EAClBD,EAAI,UAAYjT,EAChBiT,EAAI,YACJA,EAAI,OAAOnD,EAAI,CAAC,EAAE,EAAGA,EAAI,CAAC,EAAE,CAAC,EAC7B,QAAS9xB,EAAI,EAAGA,EAAI8xB,EAAI,OAAQ9xB,IAAKi1B,EAAI,OAAOnD,EAAI9xB,CAAC,EAAE,EAAG8xB,EAAI9xB,CAAC,EAAE,CAAC,EAClEi1B,EAAI,YACJA,EAAI,SACJA,EAAI,UACN,CAEO,SAASE,GACdF,EACA73B,EACA83B,EAAQ,UACR,CACAD,EAAI,OACJA,EAAI,YAAcC,EAClBD,EAAI,UAAY,EAChBA,EAAI,YACJA,EAAI,OAAO73B,EAAE,EAAI,EAAGA,EAAE,CAAC,EACvB63B,EAAI,OAAO73B,EAAE,EAAI,EAAGA,EAAE,CAAC,EACvB63B,EAAI,OAAO73B,EAAE,EAAGA,EAAE,EAAI,CAAC,EACvB63B,EAAI,OAAO73B,EAAE,EAAGA,EAAE,EAAI,CAAC,EACvB63B,EAAI,SACJA,EAAI,SACN,CAGA,SAASG,GAAM/b,EAAWgc,EAAYC,EAAY,CAChD,OAAO,KAAK,IAAID,EAAI,KAAK,IAAIC,EAAIjc,CAAC,CAAC,CACrC,CAEA,SAASkc,GAAYC,EAAgB90B,EAAW2hB,EAAmB,CACjE,KAAM,CAAE,MAAAL,EAAO,KAAAxhB,CAAA,EAASg1B,EAElBC,EAAK,CACT,CAAC,GAAI,EAAG,CAAC,EACT,CAAC,GAAI,EAAG,CAAC,EACT,CAAC,GAAI,EAAG,CAAC,GAELC,EAAK,CACT,CAAC,GAAI,GAAI,EAAE,EACX,CAAC,EAAG,EAAG,CAAC,EACR,CAAC,EAAG,EAAG,CAAC,GAEV,IAAInG,EAAK,EACPC,EAAK,EACP,QAAS3jB,EAAI,GAAIA,GAAK,EAAGA,IACvB,QAAS7L,EAAI,GAAIA,GAAK,EAAGA,IAAK,CAC5B,MAAM21B,EAAKP,GAAM10B,EAAIV,EAAG,EAAGgiB,EAAQ,CAAC,EAE9BoC,GADKgR,GAAM/S,EAAIxW,EAAG,EAAG2pB,EAAI,OAAS,CAAC,EACvBxT,EAAQ2T,GAAM,EAC1B13B,EAAIuC,EAAK4jB,CAAG,EAChB5mB,EAAIgD,EAAK4jB,EAAM,CAAC,EAChB3mB,EAAI+C,EAAK4jB,EAAM,CAAC,EACZhC,EAAO,KAAQnkB,EAAI,KAAQT,EAAI,KAAQC,EAC7C8xB,GAAMnN,EAAOqT,EAAG5pB,EAAI,CAAC,EAAE7L,EAAI,CAAC,EAC5BwvB,GAAMpN,EAAOsT,EAAG7pB,EAAI,CAAC,EAAE7L,EAAI,CAAC,CAC9B,CAEF,OAAO,KAAK,MAAMuvB,EAAIC,CAAE,CAC1B,CAEO,SAASoG,GACdC,EACAz4B,EACA2kB,EAAS,EACF,CAEP,MAAMyT,EADMK,EAAO,WAAW,IAAI,EAClB,aAAa,EAAG,EAAGA,EAAO,MAAOA,EAAO,MAAM,EACxDhU,EAAKuT,GAAM,KAAK,MAAMh4B,EAAE,CAAC,EAAG,EAAGy4B,EAAO,MAAQ,CAAC,EAC/C/T,EAAKsT,GAAM,KAAK,MAAMh4B,EAAE,CAAC,EAAG,EAAGy4B,EAAO,OAAS,CAAC,EACtD,IAAIC,EAAO,CAAE,EAAGjU,EAAI,EAAGC,EAAI,IAAK,IAChC,QAASO,EAAIP,EAAKC,EAAQM,GAAKP,EAAKC,EAAQM,IAC1C,QAAS3hB,EAAImhB,EAAKE,EAAQrhB,GAAKmhB,EAAKE,EAAQrhB,IAAK,CAC/C,GAAIA,GAAK,GAAK2hB,GAAK,GAAK3hB,GAAKm1B,EAAO,MAAQ,GAAKxT,GAAKwT,EAAO,OAAS,EACpE,SACF,MAAME,EAAMR,GAAYC,EAAK90B,EAAG2hB,CAAC,EAC7B0T,EAAMD,EAAK,QAAY,CAAE,EAAAp1B,EAAG,EAAA2hB,EAAG,IAAA0T,CAAA,EACrC,CAEF,MAAO,CAAE,EAAGD,EAAK,EAAG,EAAGA,EAAK,EAC9B,CC1nBO,SAASE,GAAiBxxB,EAAwB,CACvD,MAAMyxB,EAAmB,MAAM,KAAK,CAAE,OAAQ,GAAK,IACjD,MAAM,KAAK,CAAE,OAAQ,GAAK,IAAM,CAAC,GAG7BC,EAAiB,GACvB,QAASl2B,EAAI,EAAGA,GAAK,EAAGA,IACtBk2B,EAAK,KAAM1xB,GAAMxE,EAAK,CAAC,EAGzB,QAAS,EAAI,EAAG,EAAI,EAAG,IAAK,CAC1B,MAAMm2B,EAAS,EAAI,EACbC,EAAOF,EAAK,EAAI,CAAC,GAAK,EACtBG,EAAOH,EAAK,EAAI,EAAI,CAAC,GAAK,EAChCD,EAAKE,CAAM,EAAE,CAAC,EAAIC,EAClBH,EAAKE,CAAM,EAAE,CAAC,EAAIE,CACpB,CACA,OAAOJ,CACT,CCpBO,SAASK,GACdC,EACe,CACf,GAAIA,GAAW,MAAQ,OAAO,MAAMA,CAAc,GAAKA,EAAU,EAC/D,OAAO,KAGT,IAAIC,EACAD,GAAW,IAAMC,EAAa,MAAQ,IAAOD,GAAW,EACnDA,GAAW,EAAKC,EAAa,IAAM,EAAMD,GAAW,EACpDA,GAAW,EAAKC,EAAa,IAAM,EAAMD,GAAW,EACpDA,GAAW,EAAKC,EAAa,IAAM,EAAMD,GAAW,OAC3C,KAAK,IAAI,EAAG,IAAMA,EAAU,GAAK,CAAC,EAEpD,MAAME,EAAU,KAAK,IAAI,EAAG,KAAK,IAAI,IAAKD,CAAU,CAAC,EACrD,OAAO,OAAOC,EAAQ,QAAQ,CAAC,CAAC,CAClC,CAEO,MAAMC,GAGT,CAEF,IAAK,CACH,YAAa,GACb,gBAAiB,CAAC,SAAU,SAAU,SAAU,OAAQ,YAAY,EACpE,cAAe,CAAC,MAAO,KAAM,WAAY,MAAO,WAAW,EAC3D,cAAe,IAEjB,kBAAmB,CACjB,YAAa,GACb,gBAAiB,CAAC,SAAU,MAAM,EAClC,cAAe,CAAC,MAAO,KAAM,KAAM,KAAK,EACxC,cAAe,IAIjB,kBAAmB,CACjB,YAAa,EACb,gBAAiB,CAAC,QAAQ,EAC1B,cAAe,CAAC,MAAO,KAAM,IAAI,EACjC,cAAe,IAEjB,eAAgB,CACd,YAAa,EACb,gBAAiB,CAAC,QAAQ,EAC1B,cAAe,CAAC,MAAO,MAAO,IAAI,EAClC,cAAe,IAEjB,eAAgB,CACd,YAAa,EACb,gBAAiB,CAAC,QAAQ,EAC1B,cAAe,CAAC,MAAO,KAAM,IAAI,EACjC,cAAe,IAIjB,QAAS,CACP,YAAa,GACb,gBAAiB,CAAC,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,MAAM,EAC5D,cAAe,CAAC,KAAM,KAAM,MAAM,EAClC,cAAe,IAEjB,mBAAoB,CAClB,YAAa,GACb,gBAAiB,CAAC,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,MAAM,EAC5D,cAAe,CAAC,KAAM,KAAM,MAAM,EAClC,cAAe,IAIjB,mBAAoB,CAClB,YAAa,GACb,gBAAiB,CACf,IACA,IACA,IACA,IACA,IACA,IACA,IACA,IACA,IACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,MAEF,cAAe,CAAC,IAAK,KAAM,IAAK,IAAI,EACpC,cAAe,IAEjB,SAAU,CACR,YAAa,GACb,gBAAiB,CACf,IACA,IACA,IACA,IACA,IACA,IACA,IACA,SACA,SACA,UAEF,cAAe,CAAC,IAAK,IAAK,KAAM,KAAM,IAAI,EAC1C,cAAe,IAIjB,aAAc,CACZ,YAAa,GACb,gBAAiB,CAAC,SAAU,SAAU,MAAM,EAC5C,cAAe,CAAC,MAAO,OAAQ,KAAK,EACpC,cAAe,IAEjB,YAAa,CACX,YAAa,GACb,gBAAiB,CAAC,QAAQ,EAC1B,cAAe,CAAC,IAAK,IAAK,GAAG,EAC7B,cAAe,IAEjB,WAAY,CACV,YAAa,GACb,gBAAiB,CAAC,SAAU,SAAU,QAAQ,EAC9C,cAAe,CAAC,KAAM,SAAU,QAAQ,EACxC,cAAe,IAIjB,WAAY,CACV,YAAa,GACb,gBAAiB,CAAC,SAAU,QAAQ,EACpC,cAAe,CAAC,MAAO,KAAM,QAAQ,EACrC,cAAe,IAEjB,WAAY,CACV,YAAa,GACb,gBAAiB,CAAC,SAAU,SAAU,MAAM,EAC5C,cAAe,CAAC,aAAc,WAAY,MAAM,EAChD,cAAe,IAEjB,OAAQ,CACN,YAAa,GACb,gBAAiB,CAAC,aAAa,EAC/B,cAAe,CAAC,gBAAgB,EAChC,cAAe,IAIjB,SAAU,CACR,YAAa,GACb,gBAAiB,CAAC,MAAO,SAAU,SAAU,QAAQ,EACrD,cAAe,CAAC,IAAK,IAAK,QAAQ,EAClC,cAAe,IAEjB,KAAM,CACJ,YAAa,GACb,gBAAiB,CAAC,OAAQ,QAAQ,EAClC,cAAe,CAAC,KAAM,KAAK,EAC3B,cAAe,IAEjB,cAAe,CACb,YAAa,GACb,gBAAiB,CAAC,MAAO,QAAQ,EACjC,cAAe,CAAC,SAAU,SAAS,EACnC,cAAe,IAIjB,WAAY,CACV,YAAa,GACb,gBAAiB,CAAC,SAAU,QAAQ,EACpC,cAAe,CAAC,OAAQ,MAAM,EAC9B,cAAe,IAEjB,KAAM,CACJ,YAAa,GACb,gBAAiB,CAAC,cAAe,YAAY,EAC7C,cAAe,CAAC,gBAAiB,YAAY,EAC7C,cAAe,IAEjB,MAAO,CACL,YAAa,GACb,gBAAiB,CAAC,cAAe,YAAY,EAC7C,cAAe,CAAC,IAAK,KAAM,KAAM,IAAI,EACrC,cAAe,IAEjB,OAAQ,CACN,YAAa,GACb,gBAAiB,CAAC,cAAe,YAAY,EAC7C,cAAe,CAAC,IAAK,IAAI,EACzB,cAAe,GAEnB,EAMO,SAASC,GACdC,EACAL,EACQ,CAER,GAAIA,GAAW,MAAQ,OAAO,MAAMA,CAAc,GAAKA,EAAU,EAAG,MAAO,GAG3E,MAAMM,EADMH,GAA8BE,CAAQ,GAC3B,aAAe,GAUtC,GAAIL,GAAW,IAAM,MAAO,OAAQ,IAAOA,GAAW,EACtD,GAAIA,GAAW,EAAK,MAAO,KAAM,EAAMA,GAAW,EAClD,GAAIA,GAAW,EAAK,MAAO,KAAM,EAAMA,GAAW,EAClD,GAAIA,GAAW,EAAK,MAAO,KAAM,EAAMA,GAAW,KAElD,GAAIA,GAAWM,EAAW,CAExB,MAAMC,EAAQD,EAAY,EAC1B,OAAIC,GAAS,EAAU,GAChB,IAAOD,EAAYN,GAAWO,EAAS,CAChD,KAAO,CAGL,MAAMC,EAAWF,EAAY,EAC7B,OAAIN,GAAWQ,EAAiB,EACzB,IAAM,GAAKR,EAAUM,IAAcE,EAAWF,GACvD,CACF,CAuBO,SAASG,GACdJ,EACAL,EAIA,CAEA,GAAIA,GAAW,MAAQ,OAAO,MAAMA,CAAc,GAAKA,EAAU,EAC/D,MAAO,CAAE,QAAS,OAAQ,KAAM,wBAGlC,MAAM7P,EAAaiQ,GAAgCC,EAAUL,CAAO,EAEpE,OAAI7P,GAAc,KACT,CACL,QAAS,UACT,KAAM,YAAYA,EAAW,QAAQ,CAAC,CAAC,MAEhCA,GAAc,GAChB,CACL,QAAS,YACT,KAAM,cAAc,KAAK,MAAMA,CAAU,CAAC,MAEnCA,GAAc,GAChB,CAAE,QAAS,OAAQ,KAAM,SAAS,KAAK,MAAMA,CAAU,CAAC,MACtDA,GAAc,GAChB,CAAE,QAAS,OAAQ,KAAM,SAAS,KAAK,MAAMA,CAAU,CAAC,MAExD,CAAE,QAAS,OAAQ,KAAM,SAAS,KAAK,MAAMA,CAAU,CAAC,KAEnE,CCjKA,MAAMvO,GAAM,oBAEZ,SAAS8e,IAmDP,CACA,GAAI,CACF,MAAMre,EAAM,aAAa,QAAQT,EAAG,EACpC,GAAI,CAACS,EACH,MAAO,CACL,eAAgB,MAChB,cAAe,GACf,YAAa,GACb,aAAc,EACd,kBAAmB,GACnB,QAAS,WACT,iBAAkB,GAClB,oBAAqB,GACrB,YAAa,CACX,KAAM,MACN,SAAU,IACV,QAAS,EACT,QAAS,QAEX,cAAe,GACf,cAAe,GACf,cAAe,GACf,YAAa,EACb,aAAc,OACd,cAAe,MACf,kBAAmB,GACnB,iBAAkB,GAClB,iBAAkB,GAClB,oBAAqB,GACrB,iBAAkB,GAClB,kBAAmB,OACnB,qBAAsB,OACtB,2BAA4B,GAC5B,kCAAmC,GACnC,cAAe,GACf,kBAAmB,GACnB,cAAe,SACf,kBAAmB,GACnB,kBAAmB,WACnB,eAAgB,GAChB,eAAgB,YAChB,sBAAuB,GACvB,6BAA8B,IAC9B,yBAA0B,GAC1B,wBAAyB,GACzB,gCAAiC,EACjC,kBAAmB,GACnB,kBAAmB,GACnB,wBAAyB,GACzB,SAAU,SACV,QAAS,SACT,UAAW,UACX,UAAW,SACX,UAAW,SACX,iBAAkB,GAClB,iBAAkB,GAClB,YAAa,IAEjB,MAAM/M,EAAI,KAAK,MAAM+M,CAAG,EAExB,GADgB,OAAQ/M,GAAW,WAAa,CAAC,EACnC,EAAG,CAEf,MAAM2hB,EAAW,CACf,GAAG3hB,EACH,eAAgB,YAChB,sBAAuB,GACvB,kBAAmB,GACnB,6BAA8B,IAC9B,UAAW,GAEb,GAAI,CACF,aAAa,QAAQsM,GAAK,KAAK,UAAUqV,CAAQ,CAAC,CACpD,MAAQ,CAAC,CACX,CACA,MAAO,CACL,eAAgB3hB,EAAE,gBAAkB,MACpC,cACE,OAAOA,EAAE,eAAkB,UAAYA,EAAE,cAAgB,GAC3D,YAAaA,EAAE,aAAe,GAC9B,aACE,OAAOA,EAAE,cAAiB,SACtB,KAAK,IAAI,EAAG,KAAK,IAAI,EAAGA,EAAE,YAAY,CAAC,EACvC,EACN,kBAAmB,CAAC,CAACA,EAAE,kBACvB,QAASA,EAAE,UAAY,MAAQ,MAAQ,WACvC,iBAAkB,CAAC,CAACA,EAAE,iBACtB,oBACE,OAAOA,EAAE,qBAAwB,UAC7BA,EAAE,oBACF,GACN,YACEA,EAAE,aAAe,OAAOA,EAAE,aAAgB,SACtC,CACE,KAAMA,EAAE,YAAY,MAAQ,MAC5B,SAAU,OAAOA,EAAE,YAAY,QAAQ,GAAK,IAC5C,QAAS,OAAOA,EAAE,YAAY,OAAO,GAAK,EAC1C,QAASA,EAAE,YAAY,SAAW,QAEpC,CAAE,KAAM,MAAO,SAAU,IAAK,QAAS,EAAG,QAAS,QACzD,cAAe,CAAC,CAACA,EAAE,cACnB,cAAe,CAAC,CAACA,EAAE,cACnB,cACE,OAAOA,EAAE,eAAkB,UAAYA,EAAE,cAAgB,GAC3D,YACE,OAAOA,EAAE,aAAgB,UAAY,SAASA,EAAE,WAAW,EACvD,KAAK,IAAI,GAAK,KAAK,IAAI,KAAMA,EAAE,WAAW,CAAC,EAC3C,EACN,aAAcA,EAAE,eAAiB,SAAW,SAAW,OACvD,cACEA,EAAE,gBAAkB,OAASA,EAAE,gBAAkB,OAC7CA,EAAE,cACF,MACN,qBACE,OAAOA,EAAE,sBAAyB,UAC9BA,EAAE,qBACF,GACN,mBAAoB,IAAM,CACxB,IAAI0O,EAAM1O,EAAE,kBACZ,OACE0O,IAAQ,eACRA,IAAQ,UACRA,IAAQ,YACRA,IAAQ,gBAERA,EAAM,YAEDA,CACT,KACA,eACE,OAAO1O,EAAE,gBAAmB,SAAWA,EAAE,eAAiB,GAC5D,eACEA,EAAE,iBAAmB,YAAc,YAAc,iBACnD,sBACE,OAAOA,EAAE,uBAA0B,UAC/BA,EAAE,sBACF,GACN,6BACE,OAAOA,EAAE,8BAAiC,UAC1C,SAASA,EAAE,4BAA4B,EACnC,KAAK,IAAI,GAAK,KAAK,IAAI,IAAMA,EAAE,4BAA4B,CAAC,EAC5D,IACN,yBACE,OAAOA,EAAE,0BAA6B,UACtC,SAASA,EAAE,wBAAwB,EAC/B,KAAK,IAAI,EAAG,KAAK,IAAI,IAAK,KAAK,MAAMA,EAAE,wBAAwB,CAAC,CAAC,EACjE,GACN,wBACE,OAAOA,EAAE,yBAA4B,UACrC,SAASA,EAAE,uBAAuB,EAC9B,KAAK,IAAI,EAAG,KAAK,IAAI,GAAI,KAAK,MAAMA,EAAE,uBAAuB,CAAC,CAAC,EAC/D,GACN,gCACE,OAAOA,EAAE,iCAAoC,UAC7C,SAASA,EAAE,+BAA+B,EACtC,KAAK,IACH,EACA,KAAK,IAAI,GAAI,KAAK,MAAMA,EAAE,+BAA+B,CAAC,GAE5D,EACN,kBACE,OAAOA,EAAE,mBAAsB,UAAYA,EAAE,kBAAoB,GACnE,kBACE,OAAOA,EAAE,mBAAsB,UAAYA,EAAE,kBAAoB,GACnE,wBAAyB,CAAC,CAACA,EAAE,wBAC7B,iBACE,OAAOA,EAAE,kBAAqB,UAAYA,EAAE,iBAAmB,GACjE,kBACE,OAAOA,EAAE,mBAAsB,SAC3BA,EAAE,kBACF,OACN,2BACE,OAAOA,EAAE,4BAA+B,UACpCA,EAAE,2BACF,GACN,kCACE,OAAOA,EAAE,mCAAsC,UAC3CA,EAAE,kCACF,GACN,qBACE,OAAOA,EAAE,sBAAyB,SAC9BA,EAAE,qBACF,OACN,sBACE,OAAOA,EAAE,uBAA0B,UAC/BA,EAAE,sBACF,GACN,cACE,OAAOA,EAAE,eAAkB,UAAYA,EAAE,cAAgB,GAC3D,kBACE,OAAOA,EAAE,mBAAsB,UAAYA,EAAE,kBAAoB,GACnE,cAAeA,EAAE,gBAAkB,UAAY,UAAY,SAC3D,kBACE,OAAOA,EAAE,mBAAsB,UAAYA,EAAE,kBAAoB,GACnE,SACEA,EAAE,WAAa,SAAWA,EAAE,WAAa,QACrCA,EAAE,SACF,SACN,QACEA,EAAE,UAAY,SAAWA,EAAE,UAAY,QAAUA,EAAE,QAAU,SAC/D,UAAWA,EAAE,YAAc,UAAY,UAAY,UACnD,UAAW,OAAOA,EAAE,WAAc,SAAWA,EAAE,UAAY,SAC3D,UAAW,OAAOA,EAAE,WAAc,SAAWA,EAAE,UAAY,SAC3D,iBACE,OAAOA,EAAE,kBAAqB,UAAYA,EAAE,iBAAmB,GACjE,iBACE,OAAOA,EAAE,kBAAqB,UAAY,SAASA,EAAE,gBAAgB,EACjE,KAAK,IAAI,EAAG,KAAK,IAAI,GAAIA,EAAE,gBAAgB,CAAC,EAC5C,GACN,YAAa,OAAOA,EAAE,aAAgB,UAAYA,EAAE,YAAc,GAClE,kBACE,OAAOA,EAAE,mBAAsB,UAAYA,EAAE,kBAAoB,GACnE,iBACE,OAAOA,EAAE,kBAAqB,UAAYA,EAAE,iBAAmB,GAErE,MAAQ,CACN,MAAO,CACL,eAAgB,MAChB,cAAe,GACf,YAAa,GACb,aAAc,EACd,kBAAmB,GACnB,QAAS,WACT,iBAAkB,GAClB,oBAAqB,GACrB,YAAa,CAAE,KAAM,MAAO,SAAU,IAAK,QAAS,EAAG,QAAS,QAChE,cAAe,GACf,cAAe,GACf,cAAe,GACf,YAAa,EACb,aAAc,OACd,cAAe,MACf,iBAAkB,GAClB,qBAAsB,GACtB,kBAAmB,OACnB,qBAAsB,OACtB,sBAAuB,GACvB,2BAA4B,GAC5B,kCAAmC,GACnC,cAAe,GACf,kBAAmB,GACnB,cAAe,SACf,kBAAmB,GACnB,kBAAmB,WACnB,eAAgB,GAChB,eAAgB,YAChB,sBAAuB,GACvB,6BAA8B,IAC9B,kBAAmB,GACnB,kBAAmB,GACnB,SAAU,SACV,QAAS,SACT,UAAW,UACX,UAAW,SACX,UAAW,SACX,iBAAkB,GAClB,iBAAkB,GAClB,YAAa,GAEjB,CACF,CAEA,SAASqrB,GAAK1P,EAAiC,CAC7C,GAAI,CACF,MAAMxT,EAAOijB,GAAA,EACb,aAAa,QAAQ9e,GAAK,KAAK,UAAU,CAAE,GAAGnE,EAAM,GAAGwT,CAAA,CAAS,CAAC,CACnE,MAAQ,CAAC,CACX,CAEO,MAAM2P,GAAkBvM,GAAsB,CAACtX,EAAK4Y,KAAS,CAClE,GAAG+K,GAAA,EACH,kBAAoBv5B,GAAM,CACxBw5B,GAAK,CAAE,eAAgBx5B,EAAG,EAC1B4V,EAAI,CAAE,eAAgB5V,EAAG,CAC3B,EACA,iBAAmB2b,GAAM,CACvB6d,GAAK,CAAE,cAAe7d,EAAG,EACzB/F,EAAI,CAAE,cAAe+F,EAAG,CAC1B,EACA,eAAiBgS,GAAS,CACxB6L,GAAK,CAAE,YAAa7L,EAAM,EAC1B/X,EAAI,CAAE,YAAa+X,EAAM,CAC3B,EACA,WAAaiD,GAAS,CACpB4I,GAAK,CAAE,QAAS5I,EAAM,EACtBhb,EAAI,CAAE,QAASgb,EAAM,CACvB,EACA,gBAAkBjV,GAAM,CACtB,MAAM+d,EAAM,KAAK,IAAI,EAAG,KAAK,IAAI,EAAG/d,CAAC,CAAC,EACtC6d,GAAK,CAAE,aAAcE,EAAK,EAC1B9jB,EAAI,CAAE,aAAc8jB,EAAK,CAC3B,EACA,qBAAuB/d,GAAM,CAC3B6d,GAAK,CAAE,kBAAmB7d,EAAG,EAC7B/F,EAAI,CAAE,kBAAmB+F,EAAG,CAC9B,EACA,oBAAsBA,GAAM,CAC1B6d,GAAK,CAAE,iBAAkB7d,EAAG,EAC5B/F,EAAI,CAAE,iBAAkB+F,EAAG,CAC7B,EACA,uBAAyBA,GAAM,CAC7B6d,GAAK,CAAE,oBAAqB7d,EAAG,EAC/B/F,EAAI,CAAE,oBAAqB+F,EAAG,CAChC,EACA,eAAiBmI,GAAQ,CAEvB,MAAM3N,EAAO,CAAE,GADFojB,KAAO,YACI,GAAGzV,CAAA,EAC3B0V,GAAK,CAAE,YAAarjB,EAAM,EAC1BP,EAAI,CAAE,YAAaO,EAAM,CAC3B,EACA,iBAAmBwF,GAAM,CACvB6d,GAAK,CAAE,cAAe7d,EAAG,EACzB/F,EAAI,CAAE,cAAe+F,EAAG,CAC1B,EACA,iBAAmBA,GAAM,CACvB6d,GAAK,CAAE,cAAe7d,EAAG,EACzB/F,EAAI,CAAE,cAAe+F,EAAG,CAC1B,EACA,iBAAmBA,GAAM,CACvB6d,GAAK,CAAE,cAAe7d,EAAG,EACzB/F,EAAI,CAAE,cAAe+F,EAAG,CAC1B,EAEA,0BAA2B,GAC3B,6BAA+BA,GAAe,CAC5C6d,GAAK,EAAS,EACd5jB,EAAI,CAAE,0BAA2B+F,EAAG,CACtC,EACA,eAAiBlc,GAAM,CACrB,MAAMo0B,EAAI,KAAK,IAAI,GAAK,KAAK,IAAI,EAAKp0B,CAAC,CAAC,EACxC+5B,GAAK,CAAE,YAAa3F,EAAG,EACvBje,EAAI,CAAE,YAAaie,EAAG,CACxB,EACA,gBAAkBh0B,GAAM,CACtB,MAAM8b,EAAI9b,IAAM,SAAW,SAAW,OACtC25B,GAAK,CAAE,aAAc7d,EAAG,EACxB/F,EAAI,CAAE,aAAc+F,EAAG,CACzB,EACA,iBAAmBnc,GAAM,CACvB,MAAMmc,EAAInc,IAAM,MAAQ,MAAQ,OAChCg6B,GAAK,CAAE,cAAe7d,EAAG,EACzB/F,EAAI,CAAE,cAAe+F,EAAG,CAC1B,EACA,qBAAuBjc,GAAM,CAE3B,MAAMyW,EAAOzW,EAEb85B,GAAK,CAAE,kBAAmBrjB,EAAM,EAChCP,EAAI,CAAE,kBAAmBO,EAAM,CACjC,EACA,kBAAoBgF,GAAM,CACxBqe,GAAK,CAAE,eAAgBre,EAAG,EAC1BvF,EAAI,CAAE,eAAgBuF,EAAG,CAC3B,EACA,kBAAoByV,GAAS,CAC3B,MAAMjV,EAAIiV,IAAS,YAAc,YAAc,iBAC/C4I,GAAK,CAAE,eAAgB7d,EAAG,EAC1B/F,EAAI,CAAE,eAAgB+F,EAAG,CAC3B,EACA,yBAA2BA,GAAM,CAC/B,MAAMxF,EAAO,CAAC,CAACwF,EACf6d,GAAK,CAAE,sBAAuBrjB,EAAM,EACpCP,EAAI,CAAE,sBAAuBO,EAAM,CACrC,EACA,gCAAkC1W,GAAM,CACtC,MAAM0W,EACJ,OAAO1W,GAAM,UAAY,SAASA,CAAC,EAC/B,KAAK,IAAI,GAAK,KAAK,IAAI,IAAMA,CAAC,CAAC,EAC/B,IACN+5B,GAAK,CAAE,6BAA8BrjB,EAAM,EAC3CP,EAAI,CAAE,6BAA8BO,EAAM,CAC5C,EACA,4BAA8B1W,GAAM,CAClC,MAAM0W,EACJ,OAAO1W,GAAM,UAAY,SAASA,CAAC,EAC/B,KAAK,IAAI,EAAG,KAAK,IAAI,IAAK,KAAK,MAAMA,CAAC,CAAC,CAAC,EACxC,GACN+5B,GAAK,CAAE,yBAA0BrjB,EAAa,EAC9CP,EAAI,CAAE,yBAA0BO,EAAM,CACxC,EACA,2BAA6B1W,GAAM,CACjC,MAAM0W,EACJ,OAAO1W,GAAM,UAAY,SAASA,CAAC,EAC/B,KAAK,IAAI,EAAG,KAAK,IAAI,GAAI,KAAK,MAAMA,CAAC,CAAC,CAAC,EACvC,GACN+5B,GAAK,CAAE,wBAAyBrjB,EAAa,EAC7CP,EAAI,CAAE,wBAAyBO,EAAM,CACvC,EACA,mCAAqC1W,GAAM,CACzC,MAAM0W,EACJ,OAAO1W,GAAM,UAAY,SAASA,CAAC,EAC/B,KAAK,IAAI,EAAG,KAAK,IAAI,GAAI,KAAK,MAAMA,CAAC,CAAC,CAAC,EACvC,EACN+5B,GAAK,CAAE,gCAAiCrjB,EAAa,EACrDP,EAAI,CAAE,gCAAiCO,EAAM,CAC/C,EACA,qBAAuBwF,GAAM,CAC3B,MAAMxF,EAAO,CAAC,CAACwF,EACf6d,GAAK,CAAE,kBAAmBrjB,EAAa,EACvCP,EAAI,CAAE,kBAAmBO,EAAM,CACjC,EACA,qBAAuBwF,GAAM,CAC3B,MAAMxF,EAAO,CAAC,CAACwF,EACf6d,GAAK,CAAE,kBAAmBrjB,EAAa,EACvCP,EAAI,CAAE,kBAAmBO,EAAM,CACjC,EACA,2BAA6BwF,GAAM,CACjC6d,GAAK,CAAE,wBAAyB7d,EAAU,EAC1C/F,EAAI,CAAE,wBAAyB+F,EAAG,CACpC,EACA,oBAAsBA,GAAM,CAC1B6d,GAAK,CAAE,iBAAkB7d,EAAG,EAC5B/F,EAAI,CAAE,iBAAkB+F,EAAG,CAC7B,EACA,wBAA0BA,GAAM,CAC9B6d,GAAK,CAAE,qBAAsB7d,EAAU,EACvC/F,EAAI,CAAE,qBAAsB+F,EAAU,CACxC,EACA,8BAAgCA,GAAM,CACpC6d,GAAK,CAAE,2BAA4B7d,EAAU,EAC7C/F,EAAI,CAAE,2BAA4B+F,EAAG,CACvC,EACA,qCAAuCA,GAAM,CAC3C6d,GAAK,CAAE,kCAAmC7d,EAAU,EACpD/F,EAAI,CAAE,kCAAmC,CAAC,CAAC+F,EAAG,CAChD,EACA,mBAAoB,CAAC7U,EAAIub,EAAOtG,EAAQ,KAAU,CAChD,GAAI,CAGF,GAFcyS,EAAA,EAEJ,uBAAyB,CAACzS,EAAO,CAEzC,QAAQ,IACN,2EAEF,MACF,CACF,MAAQ,CAAC,CAET,GAAI,CACF,MAAMzF,EAAOkY,EAAA,EACb,GACElY,EAAK,oBAAsBxP,GAC3BwP,EAAK,uBAAyB+L,EAG9B,MAEJ,MAAQ,CAAC,CAETmX,GAAK,CAAE,kBAAmB1yB,EAAI,qBAAsBub,EAAO,EAC3DzM,EAAI,CAAE,kBAAmB9O,EAAI,qBAAsBub,EAAO,CAC5D,EACA,yBAA2B1G,GAAM,CAG/B,GAAI,CAEF,GADc6S,EAAA,EACJ,2BAA6B7S,IAAM,GAAM,CAIjD,QAAQ,MACN,sEAEF,MACF,CACF,MAAQ,CAAC,CACT6d,GAAK,CAAE,sBAAuB7d,EAAG,EACjC/F,EAAI,CAAE,sBAAuB+F,EAAG,CAClC,EACA,iBAAmBA,GAAM,CACvB6d,GAAK,CAAE,cAAe7d,EAAG,EACzB/F,EAAI,CAAE,cAAe+F,EAAG,CAC1B,EACA,qBAAuBA,GAAM,CAC3B6d,GAAK,CAAE,kBAAmB7d,EAAG,EAC7B/F,EAAI,CAAE,kBAAmB+F,EAAG,CAC9B,EACA,oBAAsBA,GAAM,CAC1B6d,GAAK,CAAE,iBAAkB7d,EAAU,EACnC/F,EAAI,CAAE,iBAAkB,CAAC,CAAC+F,EAAU,CACtC,EACA,qBAAuBA,GAAe,CACpC,MAAMxF,EAAO,CAAC,CAACwF,EACf6d,GAAK,CAAE,kBAAmBrjB,EAAa,EACvCP,EAAI,CAAE,kBAAmBO,EAAa,CACxC,EACA,oBAAsBwF,GAAe,CACnC,MAAMxF,EAAO,CAAC,CAACwF,EACf6d,GAAK,CAAE,iBAAkBrjB,EAAa,EACtCP,EAAI,CAAE,iBAAkBO,EAAa,CACvC,EACA,uBAAyB1W,GAAc,CACrC,MAAMo0B,EAAI,KAAK,IAAI,EAAG,KAAK,IAAI,GAAI,KAAK,MAAMp0B,CAAC,CAAC,CAAC,EACjD+5B,GAAK,CAAE,oBAAqB3F,EAAU,EACtCje,EAAI,CAAE,oBAAqBie,EAAU,CACvC,EACA,iBAAmBjD,GAAS,CAC1B4I,GAAK,CAAE,cAAe5I,EAAM,EAC5Bhb,EAAI,CAAE,cAAegb,EAAM,CAC7B,EACA,qBAAuBjV,GAAM,CAC3B6d,GAAK,CAAE,kBAAmB7d,EAAG,EAC7B/F,EAAI,CAAE,kBAAmB+F,EAAG,CAC9B,EACA,YAAcge,GAAS,CACrBH,GAAK,CAAE,SAAUG,EAAM,EACvB/jB,EAAI,CAAE,SAAU+jB,EAAM,CACxB,EACA,WAAaA,GAAS,CACpBH,GAAK,CAAE,QAASG,EAAM,EACtB/jB,EAAI,CAAE,QAAS+jB,EAAM,CACvB,EACA,aAAen5B,GAAM,CACnB,MAAMmb,EAAInb,IAAM,UAAY,UAAY,UACxCg5B,GAAK,CAAE,UAAW7d,EAAG,EACrB/F,EAAI,CAAE,UAAW+F,EAAG,CACtB,EACA,aAAegS,GAAS,CACtB,MAAMhS,EAAIgS,GAAM,QAAU,SAC1B6L,GAAK,CAAE,UAAW7d,EAAG,EACrB/F,EAAI,CAAE,UAAW+F,EAAG,CACtB,EACA,aAAegS,GAAS,CACtB,MAAMhS,EAAIgS,GAAM,QAAU,SAC1B6L,GAAK,CAAE,UAAW7d,EAAG,EACrB/F,EAAI,CAAE,UAAW+F,EAAG,CACtB,EACA,oBAAsBA,GAAM,CAC1B6d,GAAK,CAAE,iBAAkB7d,EAAG,EAC5B/F,EAAI,CAAE,iBAAkB+F,EAAG,CAC7B,EACA,oBAAsBlc,GAAM,CAC1B,MAAMo0B,EAAI,KAAK,IAAI,EAAG,KAAK,IAAI,GAAI,KAAK,MAAMp0B,CAAC,CAAC,CAAC,EACjD+5B,GAAK,CAAE,iBAAkB3F,EAAG,EAC5Bje,EAAI,CAAE,iBAAkBie,EAAG,CAC7B,EACA,eAAiBlY,GAAM,CACrB6d,GAAK,CAAE,YAAa7d,EAAG,EACvB/F,EAAI,CAAE,YAAa+F,EAAG,CACxB,CACF,EAAE,EC9sBIie,GAAiBl6B,GACrB,CAAC,CAACA,GAAK,OAAO,SAASA,EAAE,CAAC,GAAK,OAAO,SAASA,EAAE,CAAC,EAC9Cm6B,GACJpI,GAEA,MAAM,QAAQA,CAAC,GAAKA,EAAE,SAAW,GAAKA,EAAE,MAAM,OAAO,QAAQ,EA2B/D,SAASqI,GACP3B,EACA4B,EASO,CACP,MAAMxC,EAAMY,EAAO,WAAW,KAAM,CAAE,mBAAoB,GAAM,EAChE,GAAI,CAACZ,EAAK,OAAO,KAEjB,MAAMvjB,EAAImkB,EAAO,MACXj4B,EAAIi4B,EAAO,OAIX6B,EAAO,IACP5M,EAAQ4M,EAAOhmB,EACfimB,EAAO,KAAK,MAAM/5B,EAAIktB,CAAK,EAG3B8M,EADa,IAAI,gBAAgBF,EAAMC,CAAI,EACtB,WAAW,KAAM,CAAE,mBAAoB,GAAM,EACxE,GAAI,CAACC,EAAS,OAAO,KAErBA,EAAQ,UAAU/B,EAAQ,EAAG,EAAG6B,EAAMC,CAAI,EAE1C,MAAMn3B,EADYo3B,EAAQ,aAAa,EAAG,EAAGF,EAAMC,CAAI,EAChC,KAGjBE,EAAc,IAAI,aAAaH,EAAOC,CAAI,EAC1CG,EAAe,EAGrB,QAASzV,EAAI,EAAGA,EAAIsV,EAAO,EAAGtV,IAC5B,QAAS3hB,EAAI,EAAGA,EAAIg3B,EAAO,EAAGh3B,IAAK,CACjC,MAAMV,IAAKqiB,EAAIqV,EAAOh3B,GAAK,EAGrBq3B,GAAK/3B,GAAI,EACTg4B,GAAKh4B,GAAI,EACTi4B,GAAKj4B,GAAI03B,EAAO,EAChBQ,GAAKl4B,GAAI03B,EAAO,EAGhBS,GACJ33B,EAAKu3B,EAAE,EAAI,KAAQv3B,EAAKu3B,GAAK,CAAC,EAAI,KAAQv3B,EAAKu3B,GAAK,CAAC,EAAI,KACrDK,EACJ53B,EAAKw3B,EAAE,EAAI,KAAQx3B,EAAKw3B,GAAK,CAAC,EAAI,KAAQx3B,EAAKw3B,GAAK,CAAC,EAAI,KACrDK,EACJ73B,EAAKy3B,EAAE,EAAI,KAAQz3B,EAAKy3B,GAAK,CAAC,EAAI,KAAQz3B,EAAKy3B,GAAK,CAAC,EAAI,KACrDK,GACJ93B,EAAK03B,EAAE,EAAI,KAAQ13B,EAAK03B,GAAK,CAAC,EAAI,KAAQ13B,EAAK03B,GAAK,CAAC,EAAI,KAErD5V,GAAK8V,EAAOD,GACZ5V,GAAK+V,GAAOD,EACZtC,GAAM,KAAK,KAAKzT,GAAKA,GAAKC,GAAKA,EAAE,EAEvC,GAAIwT,GAAM+B,EAAc,CAEtB,MAAMS,GAAKjW,GAAKyT,GACVyC,EAAKjW,GAAKwT,GAKV0C,EAAOf,EAAO,IACdgB,EAAOhB,EAAO,GAGpB,QAASz5B,GAAIw6B,EAAMx6B,GAAIy6B,EAAMz6B,IAAK,EAAG,CAEnC,MAAM06B,GAAM,KAAK,MAAMj4B,EAAI63B,GAAKt6B,EAAC,EAC3B26B,GAAM,KAAK,MAAMvW,EAAImW,EAAKv6B,EAAC,EAC7B06B,IAAO,GAAKA,GAAMjB,GAAQkB,IAAO,GAAKA,GAAMjB,GAC9CE,EAAYe,GAAMlB,EAAOiB,EAAG,IAI9B,MAAME,GAAM,KAAK,MAAMn4B,EAAI63B,GAAKt6B,EAAC,EAC3B66B,GAAM,KAAK,MAAMzW,EAAImW,EAAKv6B,EAAC,EAC7B46B,IAAO,GAAKA,GAAMnB,GAAQoB,IAAO,GAAKA,GAAMnB,GAC9CE,EAAYiB,GAAMpB,EAAOmB,EAAG,GAEhC,CACF,CACF,CAKF,MAAME,EAAc,IAAI,aAAarB,EAAOC,CAAI,EAC1CqB,EAAQ,EACd,QAAS3W,EAAI2W,EAAO3W,EAAIsV,EAAOqB,EAAO3W,IACpC,QAAS3hB,EAAIs4B,EAAOt4B,EAAIg3B,EAAOsB,EAAOt4B,IAAK,CACzC,IAAIkiB,GAAM,EACV,QAASL,GAAK,CAACyW,EAAOzW,IAAMyW,EAAOzW,KACjC,QAASD,GAAK,CAAC0W,EAAO1W,IAAM0W,EAAO1W,KACjCM,IAAOiV,GAAaxV,EAAIE,IAAMmV,GAAQh3B,EAAI4hB,GAAG,EAGjDyW,EAAY1W,EAAIqV,EAAOh3B,CAAC,EAAIkiB,EAC9B,CAGF,IAAIqW,EAAW,EACXC,EAAQxB,EAAO,EACfyB,EAAQxB,EAAO,EAGnB,MAAMyB,EAAS,EACf,QAAS/W,EAAI+W,EAAQ/W,EAAIsV,EAAOyB,EAAQ/W,IACtC,QAAS3hB,EAAI04B,EAAQ14B,EAAIg3B,EAAO0B,EAAQ14B,IAAK,CAC3C,MAAM24B,GAAQN,EAAY1W,EAAIqV,EAAOh3B,CAAC,EAClC24B,GAAQJ,IACVA,EAAWI,GACXH,EAAQx4B,EACRy4B,EAAQ9W,EAEZ,CAIF,IAAIiX,EAAUJ,EAAQpO,EAClByO,EAAUJ,EAAQrO,EAGpB2M,GACA,OAAO,SAASA,EAAW,CAAC,GAC5B,OAAO,SAASA,EAAW,CAAC,IAG5B6B,EAAU,GAAM7B,EAAW,EAAI,GAAM6B,EACrCC,EAAU,GAAM9B,EAAW,EAAI,GAAM8B,GAGvC,QAAQ,IACN,sCAAsC,KAAK,MAAMD,CAAO,CAAC,KAAK,KAAK,MAAMC,CAAO,CAAC,WAAWN,CAAQ,IAOtG,MAAMO,EAAQ,IACRC,EAAYD,EAAQ9nB,EACpBgoB,EAAQ,KAAK,MAAM97B,EAAI67B,CAAS,EAGhCE,EADa,IAAI,gBAAgBH,EAAOE,CAAK,EACxB,WAAW,IAAI,EAC1C,GAAI,CAACC,EAAS,OAAO,KAErBA,EAAQ,UAAU9D,EAAQ,EAAG,EAAG2D,EAAOE,CAAK,EAC5C,MAAME,EAAWD,EAAQ,aAAa,EAAG,EAAGH,EAAOE,CAAK,EAAE,KAMpDG,EAAS,IAAI,aAAaL,EAAQE,CAAK,EACvCI,EAAS,IAAI,aAAaN,EAAQE,CAAK,EAE7C,QAASrX,EAAI,EAAGA,EAAIqX,EAAQ,EAAGrX,IAC7B,QAAS3hB,EAAI,EAAGA,EAAI84B,EAAQ,EAAG94B,IAAK,CAClC,MAAMV,IAAKqiB,EAAImX,EAAQ94B,GAAK,EAI1Bk5B,EAAS55B,EAAC,EAAI,KAAQ45B,EAAS55B,GAAI,CAAC,EAAI,KAAQ45B,EAAS55B,GAAI,CAAC,EAAI,KAGpE,MAAM+3B,GAAK/3B,GAAI,EACTg4B,GAAKh4B,GAAI,EACTi4B,GAAKj4B,GAAIw5B,EAAQ,EACjBtB,GAAKl4B,GAAIw5B,EAAQ,EAEjBrB,GACJyB,EAAS7B,EAAE,EAAI,KACf6B,EAAS7B,GAAK,CAAC,EAAI,KACnB6B,EAAS7B,GAAK,CAAC,EAAI,KACfK,EACJwB,EAAS5B,EAAE,EAAI,KACf4B,EAAS5B,GAAK,CAAC,EAAI,KACnB4B,EAAS5B,GAAK,CAAC,EAAI,KACfK,EACJuB,EAAS3B,EAAE,EAAI,KACf2B,EAAS3B,GAAK,CAAC,EAAI,KACnB2B,EAAS3B,GAAK,CAAC,EAAI,KACfK,GACJsB,EAAS1B,EAAE,EAAI,KACf0B,EAAS1B,GAAK,CAAC,EAAI,KACnB0B,EAAS1B,GAAK,CAAC,EAAI,KAGf5V,GAAK8V,EAAOD,GACZ5V,GAAK+V,GAAOD,EAElBwB,EAAOxX,EAAImX,EAAQ94B,CAAC,EAAI4hB,GACxBwX,EAAOzX,EAAImX,EAAQ94B,CAAC,EAAI6hB,EAC1B,CAMF,MAAMwX,EAAW9E,EAAI,aAAa,EAAG,EAAGvjB,EAAG9T,CAAC,EAAE,KAExCo8B,EAAM,CAACt5B,EAAW2hB,IAAc,CACpC,MAAM4X,GAAK,KAAK,IAAI,EAAG,KAAK,IAAIvoB,EAAI,EAAG,KAAK,MAAMhR,CAAC,CAAC,CAAC,EAE/C0jB,IADK,KAAK,IAAI,EAAG,KAAK,IAAIxmB,EAAI,EAAG,KAAK,MAAMykB,CAAC,CAAC,CAAC,EACnC3Q,EAAIuoB,IAAM,EAC5B,MACE,MAAQF,EAAS3V,EAAG,EACpB,KAAQ2V,EAAS3V,GAAM,CAAC,EACxB,KAAQ2V,EAAS3V,GAAM,CAAC,CAE5B,EAIM8V,GAAa,GACbC,GAA2C,GAEjD,QAAS58B,EAAI,EAAGA,EAAI28B,GAAY38B,IAAK,CACnC,MAAMo0B,EAASp0B,EAAI28B,GAAc,KAAK,GAAK,EACrCvK,GAAM,KAAK,IAAIgC,CAAK,EACpB/B,GAAM,KAAK,IAAI+B,CAAK,EAGpByI,GAA2C,GAEjD,QAASn8B,GAAI,GAAIA,GAAI,KAAK,IAAIyT,EAAG9T,CAAC,EAAI,EAAGK,IAAK,EAAG,CAE/C,MAAMo8B,GAASf,GAAWr7B,GAAI,GAAK0xB,GAC7B2K,EAASf,GAAWt7B,GAAI,GAAK2xB,GAC7B2K,EAASjB,GAAWr7B,GAAI,GAAK0xB,GAC7B6K,GAASjB,GAAWt7B,GAAI,GAAK2xB,GAE7B6K,GAAWT,EAAIK,GAAQC,CAAM,EAC7BI,GAAWV,EAAIO,EAAQC,EAAM,EAG7BG,GAAO,KAAK,IAAID,GAAWD,EAAQ,EAGrCE,GAAO,GAAK18B,GAAI,IAElBm8B,GAAU,KAAK,CAAE,EAAAn8B,GAAG,KAAA08B,EAAA,CAAM,CAE9B,CAGA,MAAMC,GAAkB,GACxB,QAAS56B,GAAI,EAAGA,GAAIo6B,GAAU,OAAQp6B,KAAK,CACzC,MAAMgU,GAAOhU,GAAI,EAAIo6B,GAAUp6B,GAAI,CAAC,EAAE,KAAO,EACvC66B,EAAOT,GAAUp6B,EAAC,EAAE,KACpB6T,EAAO7T,GAAIo6B,GAAU,OAAS,EAAIA,GAAUp6B,GAAI,CAAC,EAAE,KAAO,EAG5D66B,EAAO7mB,IAAQ6mB,EAAOhnB,GAAQgnB,EAAO,GAEvCD,GAAM,KAAKR,GAAUp6B,EAAC,EAAE,CAAC,CAE7B,CAKI46B,GAAM,OAAS,GACjBA,GAAM,QAAS38B,IAAM,CAEnB,MAAM68B,GAAU,OAAO,KAAKX,EAAW,EACpC,IAAKn9B,IAAO,CACX,IAAK,SAASA,CAAC,EACf,OACEm9B,GAAY,SAASn9B,CAAC,CAAC,EACrB,KAAK,MAAMm9B,GAAY,SAASn9B,CAAC,CAAC,EAAE,OAAS,CAAC,CAChD,GACF,EACD,OAAQgT,GAAU,KAAK,IAAIA,EAAM,OAAS/R,EAAC,EAAI,EAAE,EACjD,KAAK,CAACV,EAAGE,KAAM,KAAK,IAAIF,EAAE,OAASU,EAAC,EAAI,KAAK,IAAIR,GAAE,OAASQ,EAAC,CAAC,EAAE,CAAC,EAE9D88B,EAAYD,GACdA,GAAQ,IACR,KAAK,IAAI,GAAI,GAAG,OAAO,KAAKX,EAAW,EAAE,IAAKn9B,GAAM,SAASA,CAAC,CAAC,CAAC,EAChE,EACCm9B,GAAYY,CAAS,IAAGZ,GAAYY,CAAS,EAAI,IACtDZ,GAAYY,CAAS,EAAE,KAAK98B,EAAC,CAC/B,CAAC,CAEL,CAGA,MAAM+8B,GAAY,OAAO,KAAKb,EAAW,EACtC,IAAKra,GAAQ,CACZ,MAAMmb,EAAQd,GAAY,SAASra,CAAG,CAAC,EAAE,KAAK,CAACviB,GAAGE,KAAMF,GAAIE,EAAC,EACvDy9B,GAASD,EAAM,KAAK,MAAMA,EAAM,OAAS,CAAC,CAAC,EACjD,MAAO,CAAE,KAAM,SAASnb,CAAG,EAAG,OAAQob,GAAQ,QAASD,EAAM,OAC/D,CAAC,EACA,KAAK,CAAC19B,EAAGE,IAAMF,EAAE,OAASE,EAAE,MAAM,EAErC,QAAQ,IAAI,4CAA6Cu9B,EAAS,EAKlE,MAAMG,GAAgB,CAAC,GAAGH,EAAS,EACnC,GAAIG,GAAc,QAAU,EAAG,CAC7B,MAAMn8B,EAAOm8B,GAAcA,GAAc,OAAS,CAAC,EAAE,OAC/CC,EAAaD,GAAcA,GAAc,OAAS,CAAC,EAAE,OACrDE,GAAQr8B,EAAOo8B,GAIhBC,GAAQ,MAAQF,GAAc,QAAU,GAAME,GAAQ,OACzD,QAAQ,IACN,8EAA8Er8B,EAAK,QACjF,EACD,aAAaq8B,GAAM,QAAQ,CAAC,CAAC,OAAOD,EAAW,QAAQ,CAAC,CAAC,OAE5DD,GAAc,MAElB,CAGA,MAAMG,GACJH,GAAc,OAAS,EACnBA,GAAcA,GAAc,OAAS,CAAC,EAAE,OACxC,KAAK,IAAIzpB,EAAG9T,CAAC,EAAI,GAOvB,IAAI29B,GAAsB,GAAKJ,GAAc,OAAS,EACtD,OAAIA,GAAc,QAAU,EAC1BI,GAAsB,GACbJ,GAAc,SAAW,EAClCI,GAAsB,GACbJ,GAAc,SAAW,IAClCI,GAAsB,IAGjB,CACL,GAAIjC,EACJ,GAAIC,EACJ,EAAG+B,GACH,WAAYC,GACZ,UAAWJ,GAAc,OACzB,aACEA,GAAc,OAAS,EACnBA,GAAcA,GAAc,OAAS,CAAC,EAAE,OACxC,EACN,cAAeA,GAAc,IAAKl9B,GAAMA,EAAE,MAAM,EAEpD,CAMA,SAASu9B,GACP3F,EACAhU,EACAC,EACAC,EACe,CACf,MAAMkT,EAAMY,EAAO,WAAW,IAAI,EAClC,GAAI,CAACZ,EAAK,OAAO,KACjB,MAAMvjB,EAAImkB,EAAO,MACXj4B,EAAIi4B,EAAO,OACX4F,EAAc,IACdC,EAAe3Z,EACf4Z,EAAwB,IAAI,MAAMF,CAAW,EAAE,KAAK,CAAC,EAErDG,EAAS,KAAK,IAAI,EAAG,KAAK,MAAMF,EAAe,CAAC,CAAC,EACjDG,EAAS,KAAK,MAAMH,EAAe,CAAC,EACpCI,EAAY7G,EAAI,aAAa,EAAG,EAAGvjB,EAAG9T,CAAC,EAAE,KACzCo8B,EAAM,CAACt5B,EAAW2hB,IAAc,CACpC,MAAM4X,EAAK,KAAK,MAAMv5B,CAAC,EACjBq7B,EAAK,KAAK,MAAM1Z,CAAC,EACvB,GAAI4X,EAAK,GAAKA,GAAMvoB,GAAKqqB,EAAK,GAAKA,GAAMn+B,EAAG,MAAO,KACnD,MAAMwmB,GAAO2X,EAAKrqB,EAAIuoB,GAAM,EAC5B,OACE6B,EAAU1X,CAAG,EAAI,KACjB0X,EAAU1X,EAAM,CAAC,EAAI,KACrB0X,EAAU1X,EAAM,CAAC,EAAI,IAEzB,EACA,QAASpkB,EAAI,EAAGA,EAAIy7B,EAAaz7B,IAAK,CACpC,MAAMzC,EAAKyC,EAAIy7B,EAAe,KAAK,GAAK,EAExC,IAAIO,EAAU,EACVhoB,EAAOgmB,EAAInY,EAAK+Z,EAAS,KAAK,IAAIr+B,CAAC,EAAGukB,EAAK8Z,EAAS,KAAK,IAAIr+B,CAAC,CAAC,EACnE,QAASU,EAAI29B,EAAS,EAAG39B,GAAK49B,EAAQ59B,IAAK,CACzC,MAAMoc,EAAM2f,EAAInY,EAAK5jB,EAAI,KAAK,IAAIV,CAAC,EAAGukB,EAAK7jB,EAAI,KAAK,IAAIV,CAAC,CAAC,EACpDC,EAAI,KAAK,IAAI6c,EAAMrG,CAAI,EACzBxW,EAAIw+B,IAASA,EAAUx+B,GAC3BwW,EAAOqG,CACT,CACAshB,EAAY37B,CAAC,EAAIg8B,CACnB,CAEA,MAAMpB,EAAkB,GACxB,QAAS56B,EAAI,EAAGA,EAAIy7B,EAAaz7B,IAAK,CACpC,MAAMgU,EAAO2nB,GAAa37B,EAAI,EAAIy7B,GAAeA,CAAW,EACtDphB,EAAMshB,EAAY37B,CAAC,EACnB6T,EAAO8nB,GAAa37B,EAAI,GAAKy7B,CAAW,EAC1CphB,EAAMrG,GAAQqG,EAAMxG,GAAQwG,EAAM,IAAIugB,EAAM,KAAK56B,CAAC,CACxD,CACA,GAAI46B,EAAM,OAAS,GAAI,CAErB,MAAMqB,EAAWN,EAAY,IAAI,CAACtiB,EAAG+K,IAAQ,CAC3C,IAAImN,EAAI,EACJv0B,EAAI,EACR,QAASU,EAAI,GAAIA,GAAK,EAAGA,IACvB6zB,GAAKoK,GAAavX,EAAM1mB,EAAI+9B,GAAeA,CAAW,EACtDz+B,IAEF,OAAOu0B,EAAIv0B,CACb,CAAC,EACD,QAASgD,EAAI,EAAGA,EAAIy7B,EAAaz7B,IAAK,CACpC,MAAMgU,EAAOioB,GAAUj8B,EAAI,EAAIy7B,GAAeA,CAAW,EACnDphB,EAAM4hB,EAASj8B,CAAC,EAChB6T,EAAOooB,GAAUj8B,EAAI,GAAKy7B,CAAW,EACvCphB,EAAMrG,GAAQqG,EAAMxG,GAAQwG,EAAM,GAAGugB,EAAM,KAAK56B,CAAC,CACvD,CACF,CACA,GAAI46B,EAAM,SAAW,EAAG,MAAO,GAE/B,MAAMsB,EAAatB,EAAM,IAAKx9B,GAAOA,EAAIq+B,EAAe,KAAK,GAAK,CAAC,EAEnES,EAAW,KAAK,CAAC3+B,EAAGE,IAAMF,EAAIE,CAAC,EAC/B,MAAM0+B,EAA0B,GAChC,QAASn8B,EAAI,EAAGA,EAAIk8B,EAAW,OAAQl8B,IAAK,CAC1C,MAAMo8B,EAAKF,EAAWl8B,CAAC,EAGjB2iB,GAFKuZ,GAAYl8B,EAAI,GAAKk8B,EAAW,MAAM,EAE9BE,EAAK,KAAK,GAAK,IAAM,KAAK,GAAK,GAClDD,EAAc,MAAMC,EAAKzZ,EAAO,IAAM,KAAK,GAAK,EAAE,CACpD,CAEA,MAAM0Z,EAAc,GACdC,EAAkB,IAAI,MAAMD,CAAW,EAC1C,KAAK,CAAC,EACN,IAAI,CAACtwB,EAAG/L,IAAM,CAAC,KAAK,GAAK,EAAIA,GAAM,KAAK,GAAK,EAAKq8B,EAAY,EAGjE,IAAIE,EAAU,EACVC,EAAU,IACd,QAASC,EAAQ,EAAGA,EAAQN,EAAc,OAAQM,IAAS,CAEzD,IAAIxgB,EAAM,EACV,QAASjf,EAAI,EAAGA,EAAI,KAAK,IAAIq/B,EAAaF,EAAc,MAAM,EAAGn/B,IAAK,CACpE,MAAM0/B,EAAgBP,GAAen/B,EAAIy/B,GAASN,EAAc,MAAM,EAChEQ,EAAiBL,EAAgBt/B,CAAC,EAClCU,EAAI,KAAK,KACXg/B,EAAgBC,EAAiB,KAAK,KAAO,KAAK,GAAK,GAAM,KAAK,IAEtE1gB,GAAOve,EAAIA,CACb,CACIue,EAAMugB,IACRA,EAAUvgB,EACVsgB,GACGJ,EAAcM,CAAK,EAAIH,EAAgB,CAAC,EAAI,KAAK,GAAK,IACtD,KAAK,GAAK,GAEjB,CAGA,OADgBC,EAAU,KAAK,KAAO,KAAK,GAAK,GAAM,KAAK,EAE7D,CAIA,SAASK,GACP/G,EACA1G,EACY,CACZ,MAAM8F,EAAMY,EAAO,WAAW,IAAI,EAClC,GAAI,CAACZ,EAAK,OAAO9F,EACjB,MAAMzd,EAAImkB,EAAO,MACfj4B,EAAIi4B,EAAO,OAEPr1B,EADKy0B,EAAI,aAAa,EAAG,EAAGvjB,EAAG9T,CAAC,EACtB,KAGVo8B,EAAM,CAACt5B,EAAW2hB,IAAc,CACpC,MAAM4X,EAAK,KAAK,IAAI,EAAG,KAAK,IAAIvoB,EAAI,EAAG,KAAK,MAAMhR,CAAC,CAAC,CAAC,EAE/C0jB,GADK,KAAK,IAAI,EAAG,KAAK,IAAIxmB,EAAI,EAAG,KAAK,MAAMykB,CAAC,CAAC,CAAC,EACnC3Q,EAAIuoB,GAAM,EAC5B,MAAO,MAAQz5B,EAAK4jB,CAAG,EAAI,KAAQ5jB,EAAK4jB,EAAM,CAAC,EAAI,KAAQ5jB,EAAK4jB,EAAM,CAAC,CACzE,EACMuW,EAAO,CAACj6B,EAAW2hB,IAAc,CACrC,MAAMoT,EAAKuE,EAAIt5B,EAAI,EAAG2hB,CAAC,EAAI2X,EAAIt5B,EAAI,EAAG2hB,CAAC,EACjCqT,EAAKsE,EAAIt5B,EAAG2hB,EAAI,CAAC,EAAI2X,EAAIt5B,EAAG2hB,EAAI,CAAC,EACvC,MAAO,CAAE,GAAAoT,EAAI,GAAAC,CAAA,CACf,EAGMmH,EAAO3N,GAAgBC,EAAG,CAAE,EAAG,EAAG,EAAG,EAAG,EAGxC2N,EAAaC,GAAsB,CACvC,MAAMC,EAAQ,CAAClO,GAAW,YAAaA,GAAW,WAAW,EAC7D,IAAImO,EAAQ,EACZ,UAAWh/B,KAAK++B,EAAO,CACrB,MAAMlL,EAAMF,GAAWmL,EAAO9+B,EAAG,GAAG,EACpC,QAAS+B,EAAI,EAAGA,EAAI8xB,EAAI,OAAQ9xB,IAAK,CACnC,MAAM5C,EAAI00B,EAAI9xB,CAAC,EACTxC,EAAIm9B,EAAKv9B,EAAE,EAAGA,EAAE,CAAC,EAEjBgyB,EAAKhyB,EAAE,EAAIy/B,EAAK,EAChBxN,EAAKjyB,EAAE,EAAIy/B,EAAK,EAChBK,EAAO,KAAK,MAAM9N,EAAIC,CAAE,GAAK,EAC7BkJ,EAAKnJ,EAAK8N,EACd1E,EAAKnJ,EAAK6N,EACZD,GAAS,KAAK,IAAIz/B,EAAE,GAAK+6B,EAAK/6B,EAAE,GAAKg7B,CAAE,CACzC,CACF,CACA,OAAOyE,EAAQ,IAAM,CACvB,EAEA,IAAInK,EAAQ3D,EACRgO,EAAYL,EAAU3N,CAAC,EAG3B,MAAMiO,EAAShJ,GAAiBA,EAAM,KAAK,GAAM,IAC3CiJ,EAAW,CAAC,GAAI,GAAI,GAAI,IAAM,EAAG,GAAK,EAAG,EAAG,CAAC,EAC7CC,EAAU,CAAC,GAAI,GAAI,GAAI,EAAG,EAAG,EAAG,CAAC,EACjCC,EAAa,CAAC,IAAM,IAAM,EAAK,KAAM,IAAI,EAE/C,UAAWC,KAAOH,EAAU,CAC1B,MAAMI,EAAKhO,GAAiBN,EAAGiO,EAAMI,CAAG,CAAC,EACzC,UAAWzN,KAAMuN,EACf,UAAWtN,KAAMsN,EAAS,CACxB,MAAMI,EAAK5N,GAAoB2N,EAAI1N,EAAIC,CAAE,EACzC,UAAWuB,KAAKgM,EAAY,CAC1B,MAAMI,EAAKrO,GAAgBoO,EAAInM,EAAGA,CAAC,EAC7BqM,EAAKd,EAAUa,CAAE,EACnBC,EAAKT,IACPA,EAAYS,EACZ9K,EAAQ6K,EAEZ,CACF,CAEJ,CACA,OAAO7K,CACT,CAMO,SAAS+K,GACdhI,EACApD,EACsB,CACtB,GAAI,CACF,MAAM/gB,EAAImkB,EAAO,MACXj4B,EAAIi4B,EAAO,OACXiI,EAAUpsB,EAAI,EACdqsB,EAAUngC,EAAI,EAGpB,IAAIogC,EAAiDnI,EAErD,GAAIpD,GAAM,YACR,GAAI,CAWF,MAAMwL,GAVa,CAACvsB,EAAW9T,IAAc,CAC3C,GAAI,CACF,OAAO,IAAI,gBAAgB8T,EAAG9T,CAAC,CACjC,MAAQ,CACN,MAAMN,EAAI,SAAS,cAAc,QAAQ,EACzC,OAAAA,EAAE,MAAQoU,EACVpU,EAAE,OAASM,EACJN,CACT,CACF,GACsBoU,EAAG9T,CAAC,EACpBsgC,EAAOD,EAAG,WAAW,IAAI,EAC/B,GAAI,CAACC,EAAM,MAAM,IAAI,MAAM,0BAA0B,EACpDA,EAAkC,UAAUrI,EAAQ,EAAG,EAAGnkB,EAAG9T,CAAC,EAC/D,MAAM4G,EAAM05B,EAAkC,aAAa,EAAG,EAAGxsB,EAAG9T,CAAC,EAC/D4C,EAAOgE,EAAG,KAEV25B,EAAU,CAAClgC,EAAWT,EAAWC,IAAc,CACnD,MAAM2gC,EAAKngC,EAAI,IACbogC,EAAK7gC,EAAI,IACT8gC,GAAK7gC,EAAI,IACL8gC,GAAM,KAAK,IAAIH,EAAIC,EAAIC,EAAE,EAC7BE,GAAM,KAAK,IAAIJ,EAAIC,EAAIC,EAAE,EACrB5gC,GAAI6gC,GAAMC,GAChB,IAAI5gC,GAAI,EACJF,KAAM,IACJ6gC,KAAQH,EAAIxgC,IAAMygC,EAAKC,IAAM5gC,GAAK,EAC7B6gC,KAAQF,EAAIzgC,IAAK0gC,GAAKF,GAAM1gC,GAAI,EACpCE,IAAKwgC,EAAKC,GAAM3gC,GAAI,EACzBE,IAAK,GACDA,GAAI,IAAGA,IAAK,MAElB,MAAM2zB,GAAIgN,KAAQ,EAAI,EAAI7gC,GAAI6gC,GAE9B,MAAO,CAAE,EAAA3gC,GAAG,EAAA2zB,GAAG,EADLgN,EACK,CACjB,EACA,QAASv+B,EAAI,EAAGA,EAAIQ,EAAK,OAAQR,GAAK,EAAG,CACvC,MAAM/B,EAAIuC,EAAKR,CAAC,EACdxC,EAAIgD,EAAKR,EAAI,CAAC,EACdvC,EAAI+C,EAAKR,EAAI,CAAC,EACV,CAAE,EAAGy+B,EAAI,EAAAlN,GAAG,EAAAlY,IAAM8kB,EAAQlgC,EAAGT,EAAGC,CAAC,EAEjCihC,GACJnN,GAAI,KACJlY,GAAI,KACHolB,EAAK,IAAMA,EAAK,KAAQA,EAAK,KAAOA,GAAM,KACvCE,GAAUpN,GAAI,KAAQlY,GAAI,IAAOolB,GAAM,IAAMA,GAAM,IACnDC,IAASC,IAIbn+B,EAAKR,CAAC,EAAI,KAAK,IAAI,IAAK/B,EAAI,GAAG,EAC/BuC,EAAKR,EAAI,CAAC,EAAI,KAAK,IAAI,IAAKxC,EAAI,GAAG,EACnCgD,EAAKR,EAAI,CAAC,EAAI,KAAK,IAAI,IAAKvC,EAAI,GAAG,GALnC+C,EAAKR,CAAC,EAAIQ,EAAKR,EAAI,CAAC,EAAIQ,EAAKR,EAAI,CAAC,EAAI,CAO1C,CACCk+B,EAAkC,aAAa15B,EAAI,EAAG,CAAC,EACxDw5B,EAAYC,CACd,MAAY,CAEVD,EAAYnI,CACd,CAIF,MAAM+I,EAAYpH,GAAmBwG,EAAkBvL,GAAM,UAAU,EAEvE,GAAI,CAACmM,EACH,MAAO,CACL,QAAS,GACT,GAAId,EACJ,GAAIC,EACJ,UAAW,EACX,UAAW,EACX,YAAa,EACb,YAAa,EACb,YAAa,EACb,YAAa,EACb,WAAY,EACZ,WAAY,KACZ,QAAS,KACT,kBAAmB,GACnB,QACE,2GAMN,MAAMc,GAAY,IAAM,CACtB,MAAM7B,EAAQ4B,EAAU,eAAiB,GACzC,GAAI5B,EAAM,QAAU,EAElB,MAAO,CACL,GAAI4B,EAAU,GACd,GAAIA,EAAU,GACd,UAAW5B,EAAM,CAAC,EAClB,UAAWA,EAAM,CAAC,EAClB,YAAaA,EAAM,CAAC,EACpB,YAAaA,EAAM,CAAC,EACpB,YAAaA,EAAM,CAAC,EACpB,YAAaA,EAAM,CAAC,GAEjB,CAEL,MAAMlS,EAAQ8T,EAAU,EAAI9P,GAAW,YACvC,MAAO,CACL,GAAI8P,EAAU,GACd,GAAIA,EAAU,GACd,UAAW9P,GAAW,UAAYhE,EAClC,UAAWgE,GAAW,UAAYhE,EAClC,YAAagE,GAAW,YAAchE,EACtC,YAAagE,GAAW,YAAchE,EACtC,YAAagE,GAAW,YAAchE,EACtC,YAAa8T,EAAU,EAE3B,CACF,KAIM7M,EACJyJ,GACE3F,EACAgJ,EAAS,GACTA,EAAS,GACTA,EAAS,cACN,EAIDC,EAAetN,GAAoB,OAAO,EAC1CuN,EAA6BD,EAAa,IAAK1hC,GAAM,CACzD,GAAIA,EAAE,IAAM,GAAKA,EAAE,IAAM,EAAG,MAAO,CAAE,EAAGyhC,EAAS,GAAI,EAAGA,EAAS,IAGjE,MAAMlP,EAAM,KAAK,IAAIoC,CAAK,EACpBnC,EAAM,KAAK,IAAImC,CAAK,EAGpBjH,EAAQ+T,EAAS,YAAc/P,GAAW,YAC1CkQ,EAAK5hC,EAAE,EAAI0tB,EACXmU,EAAK7hC,EAAE,EAAI0tB,EAGjB,MAAO,CACL,EAAG+T,EAAS,IAAMG,EAAKrP,EAAMsP,EAAKrP,GAClC,EAAGiP,EAAS,IAAMG,EAAKpP,EAAMqP,EAAKtP,EAAA,CAEtC,CAAC,EAED,IAAIuP,EAAgC,KAChC3I,EAAyB,KACzB7P,EAAakY,EAAU,WACvBO,EAAc,EAElB,GAAI,CAEF,IAAIC,EAAY,GAChB,GAAI,CAEFA,EAAY,CAAC,CADHjI,GAAgB,cACT,oBACnB,MAAY,CAAC,CAEb,GAAIiI,EAAW,CACb,MAAMC,EAAS7M,GAAiBsM,EAAcC,EAAmB,CAC/D,YAAa,EACb,QAAS,IACV,EACGM,EAAO,GACTH,EAAaG,EAAO,EACpB9I,EAAU8I,EAAO,QAEjBF,EADoBE,EAAO,QAAQ,OAAO,OAAO,EAAE,OACvBN,EAAkB,OAC9CrY,EAAa,KAAK,IAChBA,EACA,KAAK,MAAMA,EAAa,GAAMyY,EAAc,EAAE,KAGhDD,EAAavO,GAAqBmO,EAAcC,CAAiB,EACjExI,EAAUjE,GAAS4M,EAAYJ,EAAcC,CAAiB,EAElE,MACEG,EAAavO,GAAqBmO,EAAcC,CAAiB,EACjExI,EAAUjE,GAAS4M,EAAYJ,EAAcC,CAAiB,EAYhE,GARIG,IACFA,EAAatC,GAAwB/G,EAAQqJ,CAAU,EACvD3I,EAAUjE,GAAS4M,EAAYJ,EAAcC,CAAiB,GAM5DG,EAAY,CACd,MAAMjN,EAAY/C,GAAgBgQ,EAAY,CAAE,EAAG,EAAG,EAAG,EAAG,EACtD5c,EAAKuc,EAAS,GAAK5M,EAAU,EAC7B1P,EAAKsc,EAAS,GAAK5M,EAAU,EAC/B,KAAK,MAAM3P,EAAIC,CAAE,EAAI,MACvB2c,EAAapP,GAAoBoP,EAAY5c,EAAIC,CAAE,EACnDgU,EAAUjE,GAAS4M,EAAYJ,EAAcC,CAAiB,EAElE,CAMA,MAAMO,EAAShJ,GADD,OAAOC,GAAY,SAAWA,EAAU,IACH,EAC/C,OAAO+I,GAAW,SACpB5Y,EAAa4Y,EAGb5Y,EAAa,KAAK,IAAIyY,EAAc,IAAKP,EAAU,UAAU,CAEjE,MAAc,CAEZlY,EAAa,KAAK,IAAI,GAAIkY,EAAU,UAAU,CAChD,CAEA,MAAMW,EAAcR,EAAkB,MAAMzH,EAAa,EACnDkI,EAAkBjI,GAAmB2H,CAAU,EAE/CO,EAAU,CAAC,CAACD,GAAmBD,GAAe7Y,EAAa,GAC3DgZ,EAAed,EAAU,WAAa,EAEtCr2B,EAAS,CACb,QAAAk3B,EACA,GAAIZ,EAAS,GACb,GAAIA,EAAS,GACb,UAAWA,EAAS,UACpB,UAAWA,EAAS,UACpB,YAAaA,EAAS,YACtB,YAAaA,EAAS,YACtB,YAAaA,EAAS,YACtB,YAAaA,EAAS,YACtB,WAAY,KAAK,MAAMnY,CAAU,EACjC,WAAY8Y,EAAkBN,EAAa,KAC3C,QAASM,EAAkBjJ,EAAU,KACrC,kBAAmBgJ,EAAcR,EAAoB,GACrD,MAAO,OAAOhN,GAAU,SAAWA,EAAQ,OAC3C,QACE,CAACwN,GAAe,CAACC,EACb,wGAAwGE,CAAY,OAAO,KAAK,MAAMd,EAAU,CAAC,CAAC,IAClJlY,EAAa,GACX,iCAAiCgZ,CAAY,OAAO,KAAK,MAAMd,EAAU,CAAC,CAAC,IAC3E,wDAAwDc,CAAY,OAAO,KAAK,MAAMd,EAAU,CAAC,CAAC,KAG5G,eAAQ,IACN,8BACA,CACE,QAASr2B,EAAO,QAChB,WAAYA,EAAO,WACnB,gBAAAi3B,EACA,YAAAD,EACA,GAAI,KAAK,MAAMh3B,EAAO,EAAE,EACxB,GAAI,KAAK,MAAMA,EAAO,EAAE,EACxB,YAAa,KAAK,MAAMA,EAAO,WAAW,EAC1C,MAAOm3B,EACP,QAASn3B,EAAO,QAAUA,EAAO,QAAQ,QAAQ,CAAC,EAAI,KACtD,kBAAmBw2B,EAAkB,IAAK3hC,IAAO,CAC/C,EAAG,KAAK,MAAMA,EAAE,CAAC,EACjB,EAAG,KAAK,MAAMA,EAAE,CAAC,GACjB,GAEJmL,EAAO,SAGFA,CACT,OAAS0T,EAAK,CACZ,MAAO,CACL,QAAS,GACT,GAAI4Z,EAAO,MAAQ,EACnB,GAAIA,EAAO,OAAS,EACpB,UAAW,EACX,UAAW,EACX,YAAa,EACb,YAAa,EACb,YAAa,EACb,YAAa,EACb,WAAY,EACZ,WAAY,KACZ,QAAS,KACT,kBAAmB,GACnB,QAAS5Z,aAAe,MAAQA,EAAI,QAAU,yBAElD,CACF,CCr2BA,eAAsB0jB,IAAmD,CACvE,MAAMC,EAA2B,GAEjC,GAAI,CAEF,MAAMC,EAAW,MAAMC,GAAA,EAEvB,UAAWC,KAAWF,EAAU,CAE9B,MAAMG,EAAc,MAAMC,GACxBF,EACA,CAAC,GAAI,KAAM,KAAM,KAAM,IAAM,GAAI,GAGnC,UAAWx3B,KAAUy3B,EAAa,CAChC,MAAME,EAAS,MAAMC,GAAY53B,EAAO,GAAIA,EAAO,IAAI,EACnD23B,GACFN,EAAQ,KAAKM,CAAM,CAEvB,CACF,CACF,OAASE,EAAO,CACd,QAAQ,MAAM,4BAA6BA,CAAK,CAClD,CAEA,OAAOR,CACT,CAKA,eAAeE,IAAiC,CAC9C,MAAMO,EAAgB,GAEtB,GAAI,CAEF,MAAM1R,EAAK,IAAI,kBAAkB,CAAE,WAAY,GAAI,EACnDA,EAAG,kBAAkB,EAAE,EAEvB,MAAM2R,EAAQ,MAAM3R,EAAG,cACvB,aAAMA,EAAG,oBAAoB2R,CAAK,EAE3B,IAAI,QAASC,GAAY,CAC9B,MAAMC,EAAU,WAAW,IAAM,CAC/B7R,EAAG,QACH4R,EAAQF,CAAG,CACb,EAAG,GAAI,EAEP1R,EAAG,eAAkBrpB,GAAU,CAC7B,GAAIA,EAAM,UAAW,CAEnB,MAAMm7B,EADYn7B,EAAM,UAAU,UACR,MAAM,sBAAsB,EACtD,GAAIm7B,GAAWA,EAAQ,CAAC,GAAK,CAACJ,EAAI,SAASI,EAAQ,CAAC,CAAC,EAAG,CACtD,MAAMC,EAAKD,EAAQ,CAAC,EAEhBE,GAAYD,CAAE,GAChBL,EAAI,KAAKK,CAAE,CAEf,CACF,MACE,aAAaF,CAAO,EACpB7R,EAAG,QACH4R,EAAQF,CAAG,CAEf,CACF,CAAC,CACH,OAASD,EAAO,CACd,eAAQ,MAAM,2BAA4BA,CAAK,EACxC,CAAC,aAAa,CACvB,CACF,CAKA,SAASO,GAAYD,EAAqB,CACxC,MAAMjmB,EAAQimB,EAAG,MAAM,GAAG,EAAE,IAAI,MAAM,EACtC,OACEjmB,EAAM,CAAC,IAAM,IACZA,EAAM,CAAC,IAAM,KAAOA,EAAM,CAAC,GAAK,IAAMA,EAAM,CAAC,GAAK,IAClDA,EAAM,CAAC,IAAM,KAAOA,EAAM,CAAC,IAAM,GAEtC,CAKA,eAAewlB,GACbF,EACAa,EACyC,CACzC,MAAMC,EAA0C,GAC1CC,EAASf,EAAQ,MAAM,GAAG,EAAE,MAAM,EAAG,CAAC,EAAE,KAAK,GAAG,EAGhDgB,EAAW,GACjB,QAAS/gC,EAAI,EAAGA,GAAK,IAAKA,IAAK,CAC7B,MAAM0gC,EAAK,GAAGI,CAAM,IAAI9gC,CAAC,GACzB,UAAWghC,KAAQJ,EACjBG,EAAS,KAAKE,GAAUP,EAAIM,CAAI,CAAC,CAErC,CAIA,OAFoB,MAAM,QAAQ,WAAWD,CAAQ,GAEzC,QAAQ,CAACx4B,EAAQjB,IAAU,CACrC,GAAIiB,EAAO,SAAW,aAAeA,EAAO,MAAO,CACjD,MAAM24B,EAAY55B,EAAQs5B,EAAM,OAC1BO,EAAU,KAAK,MAAM75B,EAAQs5B,EAAM,MAAM,EACzCF,EAAK,GAAGI,CAAM,IAAIK,EAAU,CAAC,GACnCN,EAAQ,KAAK,CAAE,GAAAH,EAAI,KAAME,EAAMM,CAAS,EAAG,CAC7C,CACF,CAAC,EAEML,CACT,CAKA,eAAeI,GAAUP,EAAYM,EAAgC,CACnE,GAAI,CACF,aAAM,MAAM,UAAUN,CAAE,IAAIM,CAAI,IAAK,CACnC,OAAQ,OACR,KAAM,UACN,OAAQ,YAAY,QAAQ,GAAI,EACjC,EACM,EACT,MAAQ,CACN,MAAO,EACT,CACF,CAKA,eAAeb,GACbO,EACAM,EAC+B,CAC/B,GAAI,CAEF,MAAMI,EAAY,CAAC,IAAK,YAAa,cAAe,UAAW,SAAS,EAExE,UAAWC,KAAYD,EACrB,GAAI,CACF,MAAME,EAAW,MAAM,MAAM,UAAUZ,CAAE,IAAIM,CAAI,GAAGK,CAAQ,GAAI,CAC9D,OAAQ,MACR,OAAQ,YAAY,QAAQ,GAAI,EACjC,EAED,GAAIC,EAAS,GAAI,CACf,MAAMC,EAAcD,EAAS,QAAQ,IAAI,cAAc,GAAK,GACtDE,EAAO,MAAMF,EAAS,OAG5B,GACEE,EAAK,SAAS,MAAM,GACpBA,EAAK,SAAS,MAAM,GACpBH,EAAS,SAAS,MAAM,EAExB,MAAO,CACL,GAAI,QAAQX,CAAE,IAAIM,CAAI,GACtB,KAAM,gBAAgBN,CAAE,IACxB,GAAAA,EACA,KAAAM,EACA,KAAM,OACN,aAAc,CAAC,QAAS,aAAa,EACrC,OAAQ,SACR,eAAgB,QAKpB,GACEQ,EAAK,SAAS,MAAM,GACpBA,EAAK,SAAS,MAAM,GACpBH,EAAS,SAAS,MAAM,EAExB,MAAO,CACL,GAAI,QAAQX,CAAE,IAAIM,CAAI,GACtB,KAAM,gBAAgBN,CAAE,IACxB,GAAAA,EACA,KAAAM,EACA,KAAM,OACN,aAAc,CAAC,QAAS,aAAa,EACrC,OAAQ,SACR,eAAgB,QAKpB,GACEO,EAAY,SAAS,OAAO,GAC5BC,EAAK,SAAS,QAAQ,GACtBH,IAAa,UAEb,MAAO,CACL,GAAI,WAAWX,CAAE,IAAIM,CAAI,GACzB,KAAM,mBAAmBN,CAAE,IAC3B,GAAAA,EACA,KAAAM,EACA,KAAM,UACN,aAAc,CAAC,OAAO,EACtB,OAAQ,SACR,eAAgB,OAGtB,CACF,MAAQ,CAER,CAEJ,OAASZ,EAAO,CACd,QAAQ,MAAM,0BAA0BM,CAAE,IAAIM,CAAI,IAAKZ,CAAK,CAC9D,CAEA,OAAO,IACT,CAuIA,eAAsBqB,GACpBvB,EAC6B,CAC7B,GAAI,CAGF,MAAMwB,EAAY,UAAUxB,EAAO,EAAE,IAAIA,EAAO,IAAI,UAG9CyB,EAAQ,SAAS,cAAc,OAAO,EAC5C,OAAAA,EAAM,IAAMD,EACZC,EAAM,YAAc,YAEb,IAAI,QAAQ,CAACpB,EAASqB,IAAW,CACtCD,EAAM,aAAe,IAAM,CACzB,MAAM9L,EAAS,SAAS,cAAc,QAAQ,EACxCZ,EAAMY,EAAO,WAAW,IAAI,EAClCA,EAAO,MAAQ8L,EAAM,WACrB9L,EAAO,OAAS8L,EAAM,YAGtB,MAAMjT,EAASmH,EAAO,cAAc,EAAE,EAEhCgM,EAAY,IAAM,CAClBF,EAAM,YAAc,GACtB1M,EAAI,UAAU0M,EAAO,EAAG,CAAC,EAE3B,sBAAsBE,CAAS,CACjC,EACAA,EAAA,EAEAtB,EAAQ7R,CAAM,CAChB,EAEAiT,EAAM,QAAU,IAAMC,EAAO,IAAI,MAAM,6BAA6B,CAAC,EACrED,EAAM,MACR,CAAC,CACH,OAASvB,EAAO,CACd,eAAQ,MAAM,uCAAwCA,CAAK,EACpD,IACT,CACF,CCpZO,MAAM0B,GAAWlX,GAAoBtX,IAAS,CACnD,OAAQ,GACR,OAAQ,CAAE,OAAQ,EAAG,MAAO,EAAG,OAAQ,EAAG,SAAU,EAAG,MAAO,EAAG,OAAQ,EAAC,EAC1E,YAAa,CACX,cAAe,GACf,UAAW,KACX,YAAa,QAEf,YAAa,CAACgb,EAAMyT,EAAOC,EAAYC,IACrC3uB,EAAKtM,GAAU,CAEb,MAAMvG,EAAmB,CACvB,GAFS,KAAK,MAGd,KAAA6tB,EACA,MAAAyT,EACA,WAAAC,EACA,aAAcC,GAAM,aACpB,aAAcA,GAAM,aACpB,cAAeA,GAAM,cACrB,KAAMA,GAAM,KACZ,OAAQA,GAAM,OACd,aAAcA,GAAM,cAEhBzf,EAAS,CAAC,GAAGxb,EAAM,OAAQvG,CAAI,EAAE,MAAM,GAAG,EAC1CyhC,EAAS,CAAE,GAAGl7B,EAAM,QAC1Bk7B,EAAO,QAAU,EACjBA,EAAO,OAASH,EAChBG,EAAO,QAAUF,EACbvhC,EAAK,SAAQyhC,EAAO,UAAY,GAChCzhC,EAAK,OAAMyhC,EAAO,OAAS,GAC/B,MAAMC,EAAKD,EAAO,OAAO5T,CAAI,GAAK,CAAE,OAAQ,EAAG,MAAO,EAAG,OAAQ,GACjE6T,EAAG,QAAU,EACbA,EAAG,OAASJ,EACZI,EAAG,QAAUH,EACbE,EAAO,OAAO5T,CAAI,EAAI6T,EAEtB,GAAI,CACF,MAAMC,EAAM3hC,EAAK,OAAS,SAAWA,EAAK,KAAO,OAAS,QACpD4hC,EAAO,CACX,KAAA/T,EACA,MAAAyT,EACA,WAAAC,EACA,aAAcvhC,EAAK,cAAgB,EACnC,aAAcA,EAAK,aACnB,cAAeA,EAAK,cACpB,aAAcA,EAAK,cAErB6gB,GAAM,UAAU8gB,CAAG,IAAKC,CAAI,CAC9B,MAAQ,CAAC,CAET,GAAI,CACF,aAAa,QAAQ,mBAAoB,KAAK,UAAU7f,CAAM,CAAC,CACjE,MAAQ,CAAC,CACT,MAAO,CAAE,GAAGxb,EAAO,OAAAwb,EAAQ,OAAA0f,CAAA,CAC7B,CAAC,EACH,qBAAuB5kC,GACrBgW,EAAKtM,GAAU,CACb,MAAMs7B,EAA4B,CAChC,cAAehlC,EAAE,eAAiB0J,EAAM,YAAY,cACpD,UACE1J,EAAE,YAAc,OAAY0J,EAAM,YAAY,UAAY1J,EAAE,UAC9D,YAAa,KAAK,KAAI,EAExB,GAAI,CACFgkB,GAAM,sBAAuBghB,CAAO,CACtC,MAAQ,CAAC,CACT,MAAO,CAAE,GAAGt7B,EAAO,YAAas7B,CAAA,CAClC,CAAC,EACH,MAAO,IACLhvB,EAAI,CACF,OAAQ,GACR,OAAQ,CACN,OAAQ,EACR,MAAO,EACP,OAAQ,EACR,SAAU,EACV,MAAO,EACP,OAAQ,EAAC,EAEX,YAAa,CACX,cAAe,GACf,UAAW,KACX,YAAa,OACf,CACD,CACL,EAAE,EAGF,GAAI,CAEE,OAAO,OAAW,MACnB,OAAe,cAAgB,CAC9B,IAAK,IAAMwuB,GAAS,WACpB,UAAWA,GAAS,UACpB,MAAO,IAAMA,GAAS,WAAW,OAAM,EAE7C,MAAQ,CAAC,CAGT,GAAI,CACF,GAAI,OAAO,OAAW,IAAa,CACjC,MAAMlpB,EAAM,aAAa,QAAQ,kBAAkB,EACnD,GAAIA,EAAK,CACP,MAAM2pB,EAAM,KAAK,MAAM3pB,CAAG,EACtB,MAAM,QAAQ2pB,CAAG,GAAKA,EAAI,QAC5BT,GAAS,SAAU,IAAO,CAAE,GAAG,EAAG,OAAQS,EAAI,MAAM,GAAG,GAAI,CAE/D,CACF,CACF,MAAQ,CAAC,CCpJT,MAAMC,GAAc,iBACdC,GAAU,iBAET,SAASC,GAAiBC,EAAU,CACzC,GAAI,CASF,MAAMC,EACJ,OAAO,OAAW,KAAgB,OAAe,iBAC5C,OAAe,iBAChB,KACN,IAAIC,EAAW,GAKf,GAHID,GAAS,OAAOA,GAAU,aAC5BC,EAAW,IAETA,EAAU,CAEZ,MAAMC,EAAOF,EACb,GAAI,CACF,MAAMG,EAAK,IAAID,EAAKL,EAAO,EAC3B,GAAI,CACFM,EAAG,YAAYJ,CAAG,CACpB,SACE,GAAI,CACFI,EAAG,OACL,MAAQ,CAAC,CACX,CACA,MACF,MAAY,CAEZ,CACF,CAEF,MAAQ,CACN,GAAI,CAGF,aAAa,QACX,GAAGP,EAAW,WACd,KAAK,UAAU,CAAE,IAAAG,EAAK,GAAI,KAAK,MAAO,GAGxC,GAAI,CAGF,MAAMK,EAAK,IAAI,aAAa,UAAW,CACrC,IAAK,GAAGR,EAAW,WACnB,SAAU,aAAa,QAAQ,GAAGA,EAAW,UAAU,EACxD,EACD,OAAO,cAAcQ,CAAE,CACzB,MAAQ,CACN,GAAI,CACF,OAAO,cAAc,IAAI,MAAM,SAAS,CAAC,CAC3C,MAAQ,CAAC,CACX,CAEA,GAAI,CACF,OAAO,cACL,IAAI,YAAY,iBAAkB,CAAE,OAAQ,CAAE,IAAAL,CAAA,EAAO,EAEzD,MAAQ,CAAC,CACX,MAAQ,CAAC,CACX,CACF,CAEO,SAASM,GAAmBC,EAA+B,CAChE,IAAIH,EAA8B,KAClC,GAAI,CACF,MAAMH,EACJ,OAAO,OAAW,KAAgB,OAAe,iBAC5C,OAAe,iBAChB,KACN,IAAIC,EAAW,GAIf,GAHID,GAAS,OAAOA,GAAU,aAC5BC,EAAW,IAETA,EACF,GAAI,CACF,MAAMC,EAAOF,EACbG,EAAK,IAAID,EAAKL,EAAO,CACvB,MAAY,CACV,MAAM,IAAI,MAAM,OAAO,CACzB,KAEA,OAAM,IAAI,MAAM,OAAO,EAErBM,IACFA,EAAG,UAAaI,GAAY,CAC1B,GAAI,CACFD,EAAUC,EAAG,IAAI,CACnB,MAAQ,CAAC,CACX,EAEJ,MAAQ,CACN,MAAMC,EAAY,IAAM,CACtB,GAAI,CACF,MAAMxqB,EAAM,aAAa,QAAQ,GAAG4pB,EAAW,UAAU,EACzD,GAAI,CAAC5pB,EAAK,OACV,MAAMyqB,EAAS,KAAK,MAAMzqB,CAAG,EAC7BsqB,EAAUG,EAAO,GAAG,CACtB,MAAQ,CAAC,CACX,EACMC,EAAYH,GAAY,CAC5B,GAAI,CACF,GAAI,CAACA,GAAI,OAAQ,OACjBD,EAAUC,EAAG,OAAO,GAAG,CACzB,MAAQ,CAAC,CACX,EACA,cAAO,iBAAiB,UAAWC,CAAS,EAC5C,OAAO,iBAAiB,iBAAkBE,CAAyB,EAC5D,IAAM,CACX,OAAO,oBAAoB,UAAWF,CAAS,EAC/C,OAAO,oBAAoB,iBAAkBE,CAAyB,CACxE,CACF,CACA,MAAO,IAAM,CACX,GAAI,CACEP,KAAO,OACb,MAAQ,CAAC,CACX,CACF,CClFA,SAASQ,GAAiBC,EAAkB,CAG1C,MAAMC,GAAgBD,EAAI,QAAU,IAAI,OACtC,CAACj5B,EAAK8O,IAAM9O,GAAO8O,EAAE,cAAgB,GACrC,GAEIqqB,EAAc,KAAK,IAAI,EAAGF,EAAI,YAAcC,CAAY,EAC9D,OAAIC,IAAgB,EAAU,GACfF,EAAI,gBAAkBA,EAAI,qBACxBE,EAAe,CAClC,CAEA,SAASC,GAAiBH,EAAU,CAElC,MAAMI,EAAML,GAAiBC,CAAG,EAC1BK,EAAcL,EAAI,SACxB,MAAO,CACL,IAAAI,EACA,YAAAC,EACA,MAAOL,EAAI,YACX,SAAUA,EAAI,eAAiB,EAEnC,CAEA,SAASM,GAA2BC,EAAgB,CAClD,GAAIA,EAAO,KAAK,SAAW,EAAG,OAC9B,MAAMC,EAAiB,GACvB,IAAIC,EACAC,EAAeH,EAAO,cAAgB,EAE1C,UAAWP,KAAOO,EAAO,KAAM,CAC7B,GAAI,CAACP,EAAI,SAAU,SACnB,MAAMW,EAAKR,GAAiBH,CAAG,EAC/BQ,EAAK,KAAKG,EAAG,GAAG,GAGd,CAACF,GACDE,EAAG,MAAQF,EAAS,OACnBE,EAAG,QAAUF,EAAS,QAAUT,EAAI,SAAW,GAAKS,EAAS,aAE9DA,EAAW,CAAE,MAAOE,EAAG,MAAO,UAAWX,EAAI,SAAW,KAAK,KAAI,GAE/DW,EAAG,SAAWD,IAAcA,EAAeC,EAAG,SACpD,CAEIH,EAAK,SACPD,EAAO,iBAAmB,KAAK,IAAI,GAAGC,CAAI,EAC1CD,EAAO,kBAAoB,KAAK,IAAI,GAAGC,CAAI,GAEzCC,MAAiB,aAAeA,GACpCF,EAAO,aAAeG,CACxB,CAwBO,MAAME,GAAWxZ,GAA8BtX,IAAS,CAC7D,OAAQ,GACR,QAAS,GACT,iBAAkB,EAClB,cAAe,IACf,WAAY,GAEZ,SAAU,CAAC+wB,EAAaC,EAAeC,EAAS,KAC9CjxB,EAAI,IAAM,CACR,MAAMkxB,EAAUH,EAAY,IAC1B,CAAChZ,EAAMrrB,KACJ,CACC,GAAI,GAAGA,CAAC,GACR,KAAAqrB,EACA,QAAS,EACT,KAAM,EAAC,EACT,EAEJ,eAAQ,MAAM,sBAAuBgZ,EAAaC,EAAeC,CAAM,EAChE,CACL,QAAAC,EACA,iBAAkB,EAClB,cAAAF,EACA,WAAY,GACZ,OAAAC,EACA,iBAAkB,OAEtB,CAAC,EAEH,SAAU,CAACtH,EAAO8E,EAAOE,IACvB3uB,EAAKtM,GAAU,CAQb,GAPA,QAAQ,MAAM,sBAAuB,CACnC,MAAAi2B,EACA,MAAA8E,EACA,WAAY/6B,EAAM,WAClB,iBAAkBA,EAAM,iBACxB,QAASA,EAAM,QAAQ,OACxB,EACG,CAACA,EAAM,WAAY,OAAOA,EAC9B,MAAMy9B,EAAYz9B,EAAM,iBAClB09B,EAAY19B,EAAM,QAAQy9B,CAAS,EAEnCE,EAASD,EAAU,KAAKA,EAAU,KAAK,OAAS,CAAC,EACvD,IAAIlB,EACAoB,EACA,CAACD,GAAUA,EAAO,UACpBnB,EAAM,CACJ,OAAQ,GACR,gBAAiBx8B,EAAM,cACvB,oBAAqBA,EAAM,cAC3B,YAAa,EACb,SAAU,GACV,cAAe,KACf,UAAW,KAAK,KAAI,EAEtB49B,EAAU,CAAC,GAAGF,EAAU,KAAMlB,CAAG,IAEjCA,EAAM,CAAE,GAAGmB,EAAQ,OAAQ,CAAC,GAAGA,EAAO,MAAM,GAC5CC,EAAU,CAAC,GAAGF,EAAU,KAAK,MAAM,EAAG,EAAE,EAAGlB,CAAG,GAEhD,MAAMqB,EAASrB,EAAI,oBAIbxB,EAAa,OAAOC,GAAM,YAAchF,CAAK,EAC7C6H,EAAU,KAAK,IAAI,EAAGD,EAAS7C,CAAU,EAC/CwB,EAAI,OAAO,KAAK,CACd,MAAAzB,EACA,MAAA9E,EACA,aAAcgF,GAAM,aACpB,kBAAmBA,GAAM,kBACzB,iBAAkBA,GAAM,iBACxB,WAAAD,EACA,QAAS,MAAM,QAAQC,GAAM,OAAO,EAChCA,EAAM,QAAQ,IAAKtkC,IAAO,CACxB,MAAO,OAAQA,EAAU,OAAS,EAAE,EACpC,MAAO,OAAQA,EAAU,OAAS,CAAC,EACnC,KAAM,OAAQA,EAAU,MAAQ,EAAE,GAClC,EACF,OACL,EACD6lC,EAAI,aAAezB,EACnByB,EAAI,oBAAsBsB,EAE1B,MAAM1nC,EAAY,CAAE,GAAGsnC,EAAW,KAAME,CAAA,EAExC,GAAI,CACF,MAAMG,EAAO9H,IAAU,GAAK8E,EAAQ,GAAK+C,IAAYD,EAC/CG,EAASF,IAAY,EACrBG,EAAkB,GAElBxB,GAAgBD,EAAI,QAAU,IAAI,OACtC,CAACj5B,EAAK8O,IAAM9O,GAAO8O,EAAE,cAAgB,GACrC,GAEIqqB,EAAc,KAAK,IAAI,EAAGF,EAAI,YAAcC,CAAY,EAC9D,GAAIC,EAAc,IAAMA,EAAc,IAAM,GAAKsB,GAAS,CACxD,MAAMpB,EAAML,GAAiBC,CAAG,EAC5B,KAAK,KAAKpmC,EAAE,qBAAuB,GAAKwmC,CAAG,EAAI,OACjDxmC,EAAE,oBAAsBwmC,GAE1BqB,EAAW,aAAerB,CAC5B,CAEA9B,GAAS,WAAW,YAAY,YAAaC,EAAOC,EAAY,CAC9D,aAAcC,GAAM,cAAgB,EACpC,aAAc4C,EACd,cAAeC,EACf,GAAGG,EACH,KAAAF,EACA,OAAAC,CAAA,CACD,CACH,MAAQ,CAAC,CACT,GAAI,CAEFtC,GAAiB,CACf,KAAM,QACN,MAAOV,EACP,MAAAD,EACA,UAAW/6B,EAAM,iBACjB,GAAI,KAAK,KAAI,CACd,CACH,MAAQ,CAAC,CAET,MAAMk+B,EAAal+B,EAAM,QAAQ,IAAI,CAACm+B,EAAInlC,IACxCA,IAAMykC,EAAYrnC,EAAI+nC,CAAA,EAExB,MAAO,CAAE,GAAGn+B,EAAO,QAASk+B,CAAA,CAC9B,CAAC,EAEH,UAAW,IACT5xB,EAAKtM,GAAU,CACb,MAAMy9B,EAAYz9B,EAAM,iBAClB09B,EAAY19B,EAAM,QAAQy9B,CAAS,EACnCE,EAASD,EAAU,KAAKA,EAAU,KAAK,OAAS,CAAC,EACvD,GAAI,CAACC,GAAUA,EAAO,UAAYA,EAAO,OAAO,SAAW,EACzD,OAAO39B,EACT,MAAMo+B,EAAYT,EAAO,OAAO,MAAM,EAAG,EAAE,EACrC3lC,EAAO2lC,EAAO,OAAOA,EAAO,OAAO,OAAS,CAAC,EAC7CU,EAAiB,OAAQrmC,EAAa,YAAcA,EAAK,KAAK,EAC9DsmC,EAAc,CAClB,GAAGX,EACH,OAAQS,EACR,YAAaT,EAAO,YAAc3lC,EAAK,MACvC,oBAAqB2lC,EAAO,oBAAsBU,CAAA,EAE9CE,EAAU,CAAC,GAAGb,EAAU,KAAK,MAAM,EAAG,EAAE,EAAGY,CAAM,EACjDE,EAAoB,CAAE,GAAGd,EAAW,KAAMa,CAAA,EAC1CL,EAAal+B,EAAM,QAAQ,IAAI,CAACm+B,EAAInlC,IACxCA,IAAMykC,EAAYe,EAAYL,CAAA,EAEhC,MAAO,CAAE,GAAGn+B,EAAO,QAASk+B,CAAA,CAC9B,CAAC,EAEH,OAASO,GACPnyB,EAAKtM,GAAU,CACb,MAAMy9B,EAAYz9B,EAAM,iBAClB09B,EAAY19B,EAAM,QAAQy9B,CAAS,EACnCE,EAASD,EAAU,KAAKA,EAAU,KAAK,OAAS,CAAC,EACvD,GAAI,CAACC,GAAUA,EAAO,SAAU,OAAO39B,EACvC,MAAM0+B,EAAU,KAAK,MACfJ,EAAc,CAClB,GAAGX,EACH,SAAU,GACV,cAAAc,EACA,QAAAC,CAAA,EAEIH,EAAU,CAAC,GAAGb,EAAU,KAAK,MAAM,EAAG,EAAE,EAAGY,CAAM,EACvD,IAAIK,EAAajB,EAAU,QACvBkB,EAAa5+B,EAAM,iBACnBs+B,EAAO,sBAAwB,IACjCK,GAAc,GAEV,CAACC,GAAcN,EAAO,YAAcM,EAAW,SACjDA,EAAa,CACX,SAAUlB,EAAU,GACpB,MAAOY,EAAO,YACd,UAAWI,CAAA,IAIjB,MAAMF,EAAoB,CACxB,GAAGd,EACH,KAAMa,EACN,QAASI,CAAA,EAELT,EAAal+B,EAAM,QAAQ,IAAI,CAACm+B,EAAInlC,IACxCA,IAAMykC,EAAYe,EAAYL,CAAA,EAEhC,GAAI,CACFzC,GAAiB,CACf,KAAM,SACN,cAAA+C,EACA,UAAWz+B,EAAM,iBACjB,GAAI,KAAK,KAAI,CACd,CACH,MAAQ,CAAC,CACT,MAAO,CAAE,GAAGA,EAAO,QAASk+B,EAAY,iBAAkBU,CAAA,CAC5D,CAAC,EAEH,WAAY,IACVtyB,EAAKtM,GAAU,CACb,MAAM6M,GAAQ7M,EAAM,iBAAmB,GAAKA,EAAM,QAAQ,OAC1D,GAAI,CACF07B,GAAiB,CACf,KAAM,aACN,iBAAkB7uB,EAClB,GAAI,KAAK,KAAI,CACd,CACH,MAAQ,CAAC,CACT,MAAO,CAAE,GAAG7M,EAAO,iBAAkB6M,CAAA,CACvC,CAAC,EAEH,QAAS,IACPP,EAAKtM,GAAU,CACb,GAAI,CAACA,EAAM,WAAY,OAAOA,EAG9B,MAAMk+B,EAAal+B,EAAM,QAAQ,IAAK5J,GAAM,CAC1C,MAAMklC,EAAU,CAAE,GAAGllC,EAAG,oBAAqB,GAC7C,OAAA0mC,GAA2BxB,CAAO,EAC3BA,CACT,CAAC,EACD,GAAI,QAIF,2BAAAuD,EAAA,EAAuB,QAAE,KAAM3oC,GAAM,CACnC,GAAI,CACFA,EAAE,kBAAkBgoC,EAAY,CAAE,aAAc,GAAM,CACxD,MAAQ,CAAC,CACX,CAAC,CACH,MAAQ,CAAC,CACT,GAAI,CACFxC,GAAiB,CAAE,KAAM,UAAW,GAAI,KAAK,MAAO,CACtD,MAAQ,CAAC,CACT,MAAO,CAAE,GAAG17B,EAAO,QAASk+B,EAAY,WAAY,GACtD,CAAC,EAEH,YAAcY,GAAaxyB,EAAI,KAAO,CAAE,GAAGwyB,GAAW,EACtD,wBAAyB,CAACC,EAAanC,IACrCtwB,EAAKtM,GAAU,CACb,MAAM09B,EAAY19B,EAAM,QAAQ++B,CAAW,EAC3C,GAAI,CAACrB,EAAW,OAAO19B,EACvB,GAAI,KAAK,KAAK09B,EAAU,qBAAuB,GAAKd,CAAG,EAAI,KAAQ,CACjE,MAAM4B,EAAoB,CAAE,GAAGd,EAAW,oBAAqBd,CAAA,EACzDsB,EAAal+B,EAAM,QAAQ,IAAI,CAACm+B,EAAInlC,IACxCA,IAAM+lC,EAAcP,EAAYL,CAAA,EAElC,MAAO,CAAE,GAAGn+B,EAAO,QAASk+B,CAAA,CAC9B,CACA,OAAOl+B,CACT,CAAC,CACL,EAAE,QC5XI4T,GACFpB,IAA0B,yBAC5B,GAEIwsB,GAAoB,yCACpBC,GAAqBC,GACzBtrB,GAAkB,QAAUorB,EAC9B,EAEMlrB,GAAc,IAAI,IAAI,CAAC,YAAa,WAAW,CAAC,EAChDqrB,GAAmB,KACnBC,GAAe,IAErB,SAASF,GAAepqB,EAAqB,CAC3C,MAAMuqB,EAAUvqB,EAAI,OACpB,OAAKuqB,EACD,SAAS,KAAKA,CAAO,EAAUA,EAC5B,GAAGA,EAAQ,QAAQ,MAAO,EAAE,CAAC,MAFf,EAGvB,CAEA,SAASC,GAAYxqB,EAAwC,CAC3D,GAAI,CAACA,EAAK,OAAO,KACjB,GAAI,CACF,OAAO,IAAI,IAAIA,CAAG,EAAE,SAAS,aAC/B,MAAQ,CACN,OAAO,IACT,CACF,CAEA,SAASyqB,GAAYprB,EAAiC,CACpD,MAAO,CAAC,CAACA,GAAQL,GAAY,IAAIK,CAAI,CACvC,CAEA,IAAIqrB,GAA6B,KAEjC,SAASC,IAAgC,CACvC,GAAID,GAAa,OAAOA,GACxB,MAAMxrB,EACH,sBACA,OACH,GAAIA,EAAQ,CACV,MAAMC,EAAairB,GAAelrB,CAAM,EACxC,GAAI,OAAO,OAAW,IAAa,CACjC,MAAM0rB,EAAUJ,GAAYrrB,CAAU,EAChC0rB,EAAW,OAAO,SAAS,SACjC,GAAIJ,GAAYG,CAAO,GAAK,CAACH,GAAYI,CAAQ,EAC/C,OAAAH,GAAcP,GACPO,EAEX,CACA,OAAAA,GAAcvrB,EACPurB,EACT,CACA,GAAI,OAAO,OAAW,IAAa,CACjC,MAAMI,EAAQ,OAAO,SAAS,WAAa,SAAW,MAAQ,KACxDzrB,EAAO,OAAO,SAAS,SACvBE,EAAa,GAAGurB,CAAK,MAAM,OAAO,SAAS,IAAI,MACrD,OAAIL,GAAYprB,CAAI,EAClBqrB,GAAc,GAAGI,CAAK,MAAMzrB,CAAI,IAAIgrB,EAAgB,MAC3ChrB,EAAK,SAAS,cAAc,EACrCqrB,GAAcnrB,GACLF,EAAK,SAAS,aAAa,EACpCqrB,GAAcP,IAITO,EACT,CACA,OAAAA,GAAcP,GACPO,EACT,CAEO,SAASK,IAA4B,CAC1C,OAAOJ,GAAA,CACT,CAEO,SAASK,IAA4B,CAC1C,GAAI,OAAO,OAAW,IAAa,MAAO,CAACD,IAAmB,EAC9D,MAAMD,EAAQ,OAAO,SAAS,WAAa,SAAW,MAAQ,KACxDzrB,EAAO,OAAO,SAAS,SACvB4rB,EAAW,OAAO,SAAS,KAC3BC,EAAYH,GAAA,EACZI,MAAiB,IAAY,CACjCD,EACA,GAAGJ,CAAK,MAAMG,CAAQ,MACtB,GAAGH,CAAK,MAAMzrB,CAAI,MAClB,GAAGyrB,CAAK,MAAMzrB,CAAI,IAAIgrB,EAAgB,MACtC,GAAGS,CAAK,MAAMzrB,CAAI,IAAIirB,EAAY,MAClCH,EAAA,CACD,EACD,OAAO,MAAM,KAAKgB,CAAU,EAAE,OAAO,OAAO,CAC9C,CCpEO,MAAMC,GAAYtlC,gBAAoC,IAAI,EAE1D,SAASulC,GAAW,CAAE,SAAAvkC,GAAqC,CAChE,KAAM,CAACwkC,EAAWC,CAAY,EAAItoC,WAAS,EAAK,EAC1C,CAACuoC,EAAQC,CAAS,EAAIxoC,WAAmB,YAAY,EACrDyoC,EAAQjlC,SAAyB,IAAI,EACrCklC,EAAellC,SAAO,IAAI,GAAgC,EAC1DmlC,EAAqBnlC,SAAO,EAAI,EAChColC,EAAcplC,SAAO,CAAC,EACtBqlC,EAAWrlC,SAA6C,IAAI,EAC5DslC,EAAetlC,SAA8C,IAAI,EAEjEulC,EAAevlC,SAAwB,IAAI,EAC3CwlC,EAAiBxlC,SAAO,CAAC,EAGzBylC,EAAkB,KAClBF,EAAa,UACjBA,EAAa,QAAUhB,GAAA,GAChBgB,EAAa,SAGhBG,EAAiB,IAAM,CAC3B,MAAMC,EAAMF,EAAA,EACZ,OAAAD,EAAe,SAAWA,EAAe,QAAU,GAAKG,EAAI,OACrDA,EAAIH,EAAe,OAAO,CACnC,EAEMI,EAAkB,IAAM,CAC5B,MAAMD,EAAMF,EAAA,EACZ,OAAOE,EAAIH,EAAe,OAAO,GAAKG,EAAI,CAAC,CAC7C,EAEME,EAAU1jC,cAAY,IAAM,CAChC,GACE8iC,EAAM,UACLA,EAAM,QAAQ,aAAe,UAAU,MACtCA,EAAM,QAAQ,aAAe,UAAU,YAEzC,OACFD,EAAU,YAAY,EAEtB,MAAMzrB,EAAM,GADCqsB,EAAA,CACM,GAEbvZ,EAAK,IAAI,UAAU9S,CAAG,EAC5B0rB,EAAM,QAAU5Y,EAChBA,EAAG,OAAS,IAAM,CAChByY,EAAa,EAAI,EACjBE,EAAU,WAAW,EACrBI,EAAY,QAAU,EAElBE,EAAa,SAAS,cAAcA,EAAa,OAAO,EAC5DA,EAAa,QAAU,YAAY,IAAM,CACvC,GAAI,CACFL,EAAM,SAAS,aAAe,UAAU,MACtCA,EAAM,SAAS,KACb,KAAK,UAAU,CAAE,KAAM,OAAQ,EAAG,KAAK,KAAI,CAAG,EAEpD,MAAQ,CAAC,CACX,EAAG,GAAK,CAEV,EACA5Y,EAAG,UAAauU,GAAO,CACrB,GAAI,CACF,MAAM3iC,EAAO,KAAK,MAAM2iC,EAAG,IAAI,EAC/BsE,EAAa,QAAQ,QAAS/b,GAAO,CACnC,GAAI,CACFA,EAAGlrB,CAAI,CACT,MAAQ,CAAC,CACX,CAAC,CACH,MAAQ,CAAC,CACX,EACAouB,EAAG,QAAU,IAAM,CAEnB,EACAA,EAAG,QAAU,IAAM,CAOjB,GANAyY,EAAa,EAAK,EAClBE,EAAU,cAAc,EACpBM,EAAa,UACf,cAAcA,EAAa,OAAO,EAClCA,EAAa,QAAU,MAErB,CAACH,EAAmB,QAAS,OACjC,MAAMW,GAAWV,EAAY,SAAW,GAAK,EAC7CA,EAAY,QAAUU,EAElBA,EAAU,IAAM,GAAGJ,EAAA,EAQvB,MAAMzsB,EAAO,IAAO,KAAK,IAAI,EAAG6sB,EAAU,CAAC,EACrCC,EAAS,KAAK,MAAM,KAAK,SAAW,GAAI,EAC9C,IAAIC,EAAQ,KAAK,IAAI,IAAO/sB,EAAO8sB,CAAM,EAErCD,IAAY,IAAGE,EAAQ,GACvBX,EAAS,SAAS,aAAaA,EAAS,OAAO,EAC/CW,IAAU,EACZH,EAAA,EAEAR,EAAS,QAAU,WAAWQ,EAASG,CAAK,CAEhD,CACF,EAAG,EAAE,EAECC,EAAY9jC,cAAY,IAAM,CAClC,GAAI,CAEFgjC,EAAmB,QAAU,GACzBE,EAAS,UACX,aAAaA,EAAS,OAAO,EAC7BA,EAAS,QAAU,MAEjBC,EAAa,UACf,cAAcA,EAAa,OAAO,EAClCA,EAAa,QAAU,MAEzB,GAAI,CACFL,EAAM,SAAS,OACjB,MAAQ,CAAC,CACTA,EAAM,QAAU,IAClB,MAAQ,CAAC,CAETG,EAAY,QAAU,EACtBD,EAAmB,QAAU,GAC7BH,EAAU,YAAY,EACtBF,EAAa,EAAK,EAElBe,EAAA,CACF,EAAG,CAACA,CAAO,CAAC,EAEZtuB,YAAU,IAAM,CACd4tB,EAAmB,QAAU,GAC7BU,EAAA,EACA,MAAMK,EAAe,IAAM,CACzBf,EAAmB,QAAU,GAC7B,GAAI,CACFF,EAAM,SAAS,OACjB,MAAQ,CAAC,CACX,EACA,OAAO,iBAAiB,eAAgBiB,CAAY,EACpD,MAAMC,EAAQ,IAAM,CACd,SAAS,kBAAoB,YAE1BtB,GAAWgB,EAAA,EAEpB,EACA,gBAAS,iBAAiB,mBAAoBM,CAAK,EACnD,OAAO,iBAAiB,SAAUN,CAAO,EAClC,IAAM,CACXV,EAAmB,QAAU,GACzBE,EAAS,SAAS,aAAaA,EAAS,OAAO,EAC/CC,EAAa,SAAS,cAAcA,EAAa,OAAO,EAC5D,GAAI,CACFL,EAAM,SAAS,OACjB,MAAQ,CAAC,CACT,SAAS,oBAAoB,mBAAoBkB,CAAK,EACtD,OAAO,oBAAoB,SAAUN,CAAO,EAC5C,OAAO,oBAAoB,eAAgBK,CAAY,CACzD,CACF,EAAG,CAACL,CAAO,CAAC,EAEZ,MAAMO,EAAOjkC,cAAai+B,GAAmB,CAC3C,GAAI,CACE6E,EAAM,SAAWA,EAAM,QAAQ,aAAe,UAAU,MAC1DA,EAAM,QAAQ,KAAK,OAAO7E,GAAQ,SAAWA,EAAM,KAAK,UAAUA,CAAG,CAAC,CAE1E,MAAQ,CAAC,CACX,EAAG,EAAE,EAECiG,EAAclkC,cAAagnB,IAC/B+b,EAAa,QAAQ,IAAI/b,CAAE,EACpB,IAAM,CACX+b,EAAa,QAAQ,OAAO/b,CAAE,CAChC,GACC,EAAE,EAEC/sB,EAAQoH,UACZ,KAAO,CAAE,UAAAqhC,EAAW,OAAAE,EAAQ,KAAAqB,EAAM,YAAAC,EAAa,UAAAJ,CAAA,GAC/C,CAACpB,EAAWE,EAAQqB,EAAMC,EAAaJ,CAAS,GAElD,OAAOroB,MAAC+mB,GAAU,SAAV,CAAmB,MAAAvoC,EAAe,SAAAiE,CAAA,CAAS,CACrD,CAEO,SAASimC,IAAQ,CACtB,MAAM5T,EAAM6T,aAAW5B,EAAS,EAChC,GAAI,CAACjS,EAAK,MAAM,IAAI,MAAM,sCAAsC,EAChE,OAAOA,CACT,CCjJA,MAAM8T,GAA4C,CAAC,CACjD,aAAAC,EACA,UAAA5a,EACA,oBAAA6a,EACA,WAAAC,EACA,oBAAAC,EACA,kBAAAC,EACA,mBAAAC,EACA,SAAAC,EACA,kBAAAC,EACA,gBAAAC,CACF,IAAM,CACJ,KAAM,CACJ,kBAAAC,EACA,qBAAAC,EACA,mBAAAC,EACA,cAAAC,EACA,iBAAAC,EACA,sBAAAC,EACA,yBAAAC,CAAA,EACE5S,GAAA,EAEE,CAAClb,EAAK+tB,CAAM,EAAIjrC,WAAiB,EAAE,EACnC,CAACkrC,EAAcC,CAAe,EAAInrC,WAAS,EAAK,EAChDorC,EAAc5nC,SAA8B,IAAI,EAEhD6nC,EAAuB1lC,cAAY,SAAY,CACnDslC,EAAO,EAAE,EACT,GAAI,CACF,MAAMf,EAAA,CACR,OAAStrC,EAAG,CACV,QAAQ,KAAK,gCAAiCA,CAAC,EAC/CqsC,EACE,mEAEJ,CACF,EAAG,CAACf,CAAmB,CAAC,EAExBnvB,YAAU,IAAM,CAETswB,EAAA,CACP,EAAG,CAACA,CAAoB,CAAC,EAEzBtwB,YAAU,IAAM,CACd,GAAI,CAACmwB,EAAc,OACnB,SAASI,EAAmB/kC,EAAmB,CAE3C6kC,EAAY,SACZ,CAACA,EAAY,QAAQ,SAAS7kC,EAAM,MAAc,IAElD,QAAQ,MACN,mFACA,KAAK,KAAI,EAEX4kC,EAAgB,EAAK,EAEzB,CACA,gBAAS,iBAAiB,YAAaG,CAAkB,EAClD,IAAM,SAAS,oBAAoB,YAAaA,CAAkB,CAC3E,EAAG,CAACJ,CAAY,CAAC,EAEjB,MAAMK,EAAiBtB,EAAa,KACjCtrC,GAAMA,EAAE,WAAa+rC,CAAA,EAElBc,EAAgBD,EAClB,GAAGA,EAAe,OAAS,QAAQ,GACnCb,EACE,uBACA,yBACAe,EAA6B,GACjCf,GAAqB,CAACa,GAGlBG,EAAqB/lC,cACzB,CAACgmC,EAA8B3qB,EAAQ,KAAO,CAC5C,GAAI,CACF4pB,EAAmBe,EAAU3qB,EAAO,EAAI,CAC1C,OAAS9D,EAAK,CACZ,QAAQ,KAAK,2CAA4CA,CAAG,CAC9D,CACAiuB,EAAgB,EAAK,CACvB,EACA,CAACP,CAAkB,GAGfgB,EAAoBjmC,cAAY,IAAM,CAC1C+lC,EAAmB,OAAW,cAAc,EAC5CtB,EAAA,CACF,EAAG,CAACsB,EAAoBtB,CAAmB,CAAC,EAEtCyB,EAAmBlmC,cAAY,IAAM,CACzCqlC,EAAyB,CAACD,CAAqB,CACjD,EAAG,CAACA,EAAuBC,CAAwB,CAAC,EAEpD,OACE7pB,OAAC,OACC,IAAKiqB,EACL,UAAU,kEACV,cAAY,qBAEZ,gBAAC,OAAI,UAAU,qBAAqB,gCAAoB,EACvDluB,SAAQ,OAAI,UAAU,6BAA8B,SAAAA,EAAI,EACxD+sB,EAAa,SAAW,GAAK,CAAC/sB,GAC7BkE,MAAC,OAAI,UAAU,8BAA8B,+DAE7C,EAEDqqB,GACCtqB,OAAC,OAAI,UAAU,8BAA8B,oDAE3CC,MAAC,UACC,UAAU,iBACV,QAAS,IAAMsqB,EAAmB,OAAW,EAAE,EAC/C,SAAUrc,EACX,+BAED,EACF,EAEFlO,OAAC,OAAI,UAAU,+BACZ,UAAA4pB,EACC3pB,MAAC,OAAI,UAAU,2BAA2B,sCAE1C,QAEC,OAAI,UAAU,yBAAyB,qCAExC,EAEFA,MAAC,UACC,cAAY,kBACZ,UAAU,0CACV,QAASyqB,EAER,WAAwB,SAAW,QACtC,EACF,EACA1qB,OAAC,OAAI,UAAU,+BACb,UAAAC,MAAC,SACC,KAAK,WACL,GAAG,2BACH,QAASypB,EACT,SAAWjsC,GAAMksC,EAAiBlsC,EAAE,OAAO,OAAO,EAClD,UAAU,UACV,SAAUywB,CAAA,SAEX,SAAM,QAAQ,2BAA2B,UAAU,UAAU,qCAE9D,GACF,EACAlO,OAAC,OAAI,UAAU,8CACb,UAAAA,OAAC,OAAI,UAAU,sBACb,UAAAA,OAAC,UACC,UAAU,2DACV,cAAY,uBACZ,QAAS,IAAMgqB,EAAgB,EAAI,EACnC,cAAgBvsC,GAAMA,EAAE,kBACxB,YAAcA,GAAMA,EAAE,kBAEtB,UAAAwiB,MAAC,QAAM,SAAAoqB,EAAc,EACrBpqB,MAAC,QACC,UAAW,wBACT8pB,EAAe,aAAe,EAChC,GACD,cAED,IAEDA,SACE,OAAI,UAAU,oGACb,SAAA/pB,OAAC,OAAI,UAAU,2BACb,UAAAC,MAAC,UACC,cAAY,qBACZ,UAAU,wDACV,QAAS,IAAMsqB,EAAmB,OAAW,EAAE,EAC/C,cAAgB9sC,GAAMA,EAAE,kBACxB,YAAcA,GAAMA,EAAE,kBACvB,oCAGAqrC,EAAa,IAAK9I,GACjB/f,MAAC,UAEC,UAAU,wDACV,QAAS,IACPsqB,EAAmBvK,EAAO,SAAUA,EAAO,OAAS,EAAE,EAExD,cAAgBviC,GAAMA,EAAE,kBACxB,YAAcA,GAAMA,EAAE,kBAErB,WAAO,OAAS,UARZuiC,EAAO,SAUf,EACD/f,MAAC,UACC,UAAU,wDACV,QAASwqB,EACT,cAAgBhtC,GAAMA,EAAE,kBACxB,YAAcA,GAAMA,EAAE,kBACvB,oCAED,EACF,EACF,GAEJ,EACCqrC,EAAa,SAAW,GACvB9oB,OAAC,OAAI,UAAU,iDACb,UAAAC,MAAC,UACC,UAAU,wBACV,QAAS,SAAY,CACnB,GAAI,CACF,MAAM+oB,EAAA,EACN,MAAMD,EAAA,CACR,OAAShtB,EAAK,CACZ,QAAQ,KACN,kDACAA,GAEF+tB,EACE,iEAEJ,CACF,EACD,iCAGD7pB,MAAC,UACC,UAAU,wBACV,QAAS,IAAM,KAAKiqB,EAAA,EACrB,mBAED,EACF,EAEFlqB,OAAC,OAAI,UAAU,wBACb,UAAAC,MAAC,UACC,UAAU,gBACV,QAAS,IAAM,CACR+oB,EAAWO,GAAqB,MAAS,CAChD,EACA,SAAUrb,EACX,kBAGDlO,OAAC,OAAI,UAAU,8DACb,UAAAC,MAAC,QAAK,cAAY,yBACf,WACG,aAAaipB,CAAiB,GAC9B,sBACN,GACEA,GAAqB,MAAQC,IAC7BlpB,MAAC,UACC,UAAU,wBACV,QAAS,IAAMmpB,EAAA,EACf,cAAe,IAAMA,EAAA,EACrB,SAAUC,GAAqB,KAChC,6BAIHppB,MAAC,QACC,UAAW,yCACTqpB,EAAkB,iBAAmB,aACvC,WAED,QAAK,UAAU,UACb,SAAAA,EAAkB,mBAAqB,uBAC1C,GACF,GACF,GACF,EACCE,GACCxpB,OAAC,OAAI,UAAU,0BAA0B,uBAC5BwpB,CAAA,EACb,QAED,OAAI,UAAU,0BAA0B,yDAEzC,IAGN,EAEMmB,GAA2B,CAAC,MAAO,KAAM,KAAM,MAAO,MAAM,EAC5DC,GAAuBD,GAAyB,OAwBhDE,GAMD,CACH,CACE,IAAK,EACL,MAAO,mBACP,OAAQ,GACR,KAAM,SACN,YAAa,KAEf,CACE,IAAK,EACL,MAAO,oBACP,OAAQ,EACR,KAAM,SACN,YAAa,KAEf,CACE,IAAK,EACL,MAAO,qBACP,OAAQ,EACR,KAAM,SACN,YAAa,KAEf,CACE,IAAK,EACL,MAAO,oBACP,OAAQ,GACR,KAAM,SACN,YAAa,KAEf,CACE,IAAK,EACL,MAAO,cACP,OAAQ,GACR,KAAM,aACN,YAAa,IAEjB,EAeA,SAASjb,GACPX,EACAY,EACAC,EACY,CAGZ,OAAOf,GAAQE,EADO,CAAC,EAAG,EAAGY,EAAI,EAAG,EAAGC,EAAI,EAAG,EAAG,CAAC,CAC/B,CACrB,CAIA,SAAwBgb,IAAa,CACnC,MAAMC,EAAW1oC,SAAyB,IAAI,EACxC2oC,EAAY3oC,SAA0B,IAAI,EAC1C4oC,EAAa5oC,SAA0B,IAAI,EAC5BA,SAAyB,IAAI,EAElD,KAAM,CAAC6oC,EAAYC,CAAa,EAAItsC,WAElC,SAAS,EACL,CAACiqC,EAAcsC,CAAe,EAAIvsC,WAEtC,EAAE,EACE,CAACwsC,EAAkBC,CAAmB,EAAIzsC,WAAwB,IAAI,EACtE,CAACqvB,EAAWqd,CAAY,EAAI1sC,WAAS,EAAK,EAC1C,CAAC2sC,EAAkBC,CAAmB,EAAI5sC,WAAS,EAAK,EAExD,CAACuvB,EAAMsd,CAAO,EAAI7sC,WACtB,IAAO,aAAa,QAAQ,cAAc,GAAiB,SAEvD,CAAC8sC,EAAWC,CAAY,EAAI/sC,WAAkB,EAAE,EAChD,CAACgtC,EAAaC,CAAc,EAAIjtC,WAAS,EAAK,EAC9C,CAACktC,EAAOC,CAAQ,EAAIntC,WAAgB,MAAM,EAC1CotC,EAA0BznC,cAAY,IAAM,CAChDknC,EAAQ,OAAO,EACfM,EAAS,QAAQ,EACjBT,EAAa,EAAK,EAClBO,EAAe,EAAK,EAEpB,GAAI,CACF7U,GACG,WACA,mBAAmB,OAAW,eAAgB,EAAI,CACvD,OAASx5B,EAAG,CACV,QAAQ,KACN,+DACAA,CAAA,CAEJ,CACF,EAAG,CAACiuC,EAASM,EAAUT,EAAcO,CAAc,CAAC,EAE9C,CAACI,EAAWC,CAAY,EAAIttC,WAChC,MAKIutC,EAAOnV,GAAiB5F,GAAMA,EAAE,WAAW,GAAK,EAChDgb,EAAUpV,GAAiB5F,GAAMA,EAAE,cAAc,EACjD,CAACib,EAAuBC,CAAwB,EAAI1tC,WACxD,IAAM,CACJ,GAAI,OAAO,OAAW,IAAa,MAAO,GAC1C,GAAI,CACF,OAAO,OAAO,aAAa,QAAQ,sBAAsB,IAAM,GACjE,MAAQ,CACN,MAAO,EACT,CACF,GAEI,CAAC2tC,EAAgBC,CAAiB,EAAI5tC,WAAkB,IACxD,OAAO,UAAc,IAAoB,GACtC,iCAAiC,KAAK,UAAU,SAAS,CACjE,EACK,CACJ,EAAAowB,EACA,eAAAyd,EACA,MAAAC,GACA,QAAAtW,GACA,OAAAuW,GACA,YAAAC,GACA,UAAAC,GACA,QAAAC,GACA,MAAAlb,EACA,aAAA8C,CAAA,EACEhK,GAAA,EACEqiB,GAAe,EAKfC,GAAgBhf,GAAA,EAChB,CACJ,iBAAAif,GACA,oBAAAC,GACA,kBAAA5D,GACA,cAAAG,GACA,iBAAAC,EACA,sBAAAC,EACA,yBAAAC,GACA,mBAAAJ,GACA,2BAAA2D,GACA,wBAAAC,GACA,2BAAAC,EAAA,EACErW,GAAA,EAEEsW,EAAa,GAEb,CAAC5O,EAAU6O,CAAW,EAAI3uC,WAS7B,IAAI,EAED,CAAC4uC,GAAYC,EAAa,EAAI7uC,WAAkB,EAAK,EACrD,CAAC2nB,GAAYmnB,EAAa,EAAI9uC,WAAiB,CAAC,EAChD,CAAC+uC,GAAiBC,EAAkB,EAAIhvC,WAAkB,EAAK,EAC/D,CAACivC,GAAkBC,EAAmB,EAAIlvC,WAAwB,IAAI,EACtE,CAACmvC,GAAiBC,EAAkB,EAAIpvC,WAAkB,EAAI,EAC9D,CAACqvC,GAAcC,EAAe,EAAItvC,WACtC,MAEI,CAACuvC,GAAiBC,EAAkB,EAAIxvC,WAAkB,EAAK,EAC/D,CAACsqC,GAAoBmF,EAAqB,EAAIzvC,WAAkB,EAAK,EACrE,CAAC0vC,GAAqBC,EAAsB,EAChD3vC,WAAkB,EAAK,EACnB,CAACwqC,GAAmBoF,CAAoB,EAAI5vC,WAChD,MAEI,CAACqqC,EAAmBwF,EAAoB,EAAI7vC,WAChD,MAGI,CAAC8vC,GAAUC,EAAW,EAAI/vC,WAAuB,IAAI,EACrD,CAACgwC,GAAkBC,EAAmB,EAAIjwC,WAAkB,EAAK,EACjEkwC,GAAkB1sC,SAA4B,IAAI,EAG9BmC,cACvB2tB,GAAkB,CACjB,MAAMxe,GAAQghB,GAAgB,GAAKxC,EACnCua,EAAe,CAAE,aAAc/4B,EAAM,CACvC,EACA,CAACghB,EAAc+X,CAAc,GAE/B,MAAMsC,GAAwB3sC,SAAgB,EAAK,EAC7C4sC,GAAiB5sC,SAAsB,IAAI,EAC3C6sC,GAAmB7sC,SAAe,CAAC,EACnC8sC,GAA0B,IAE1B,CAACC,GAAqBC,EAAsB,EAAIxwC,WAEpD,EAAE,EAEE,CAACywC,GAAaC,EAAc,EAAI1wC,WAGnC,CAAE,KAAM,KAAM,MAAO,EAAG,EAGrB,CAAC2wC,GAAcC,EAAe,EAAI5wC,WAAiB,CAAG,EACtD,CAAC6wC,GAAcC,EAAe,EAAI9wC,WAAiB,CAAC,EACpD,CAAC+wC,GAAcC,EAAe,EAAIhxC,WAAiB,CAAC,EAEpD,CAACixC,GAAqBC,EAAsB,EAChDlxC,WAAkB,EAAK,EACnB,CAACmxC,GAAmBC,EAAoB,EAAIpxC,WAAkB,EAAK,EACnE,CAACqxC,GAAmBC,EAAoB,EAAItxC,WAAiB,CAAG,EAChE,CAACuxC,GAAmBC,EAAoB,EAAIxxC,WAAiB,CAAG,EAChE,CAACyxC,GAAcC,EAAe,EAAI1xC,WAEtC,IAAI,EACN,SAAS2xC,IAAyB,CAChCL,GAAqB,IAAI,EACzBE,GAAqB,CAAG,EACxBZ,GAAgB,CAAG,EACnBE,GAAgB,CAAC,EACjBE,GAAgB,CAAC,EACjBI,GAAqB,EAAK,EAC1BM,GAAgB,IAAI,CACtB,CAS4B/rC,cAAY,CAACF,EAAY6yB,EAAO,MAAQ,CAClE,GAAI,OAAO,SAAa,IACtB,MAAM,IAAI,MAAM,oDAAoD,EACtE,MAAMsZ,EAAS3a,GAAiBxxB,CAAE,EAC5BqxB,EAAS,SAAS,cAAc,QAAQ,EAC9CA,EAAO,MAAQwB,EACfxB,EAAO,OAASwB,EAChB,MAAMpC,EAAMY,EAAO,WAAW,IAAI,EAClC,GAAI,CAACZ,EAAK,MAAO,GAEjBA,EAAI,UAAY,UAChBA,EAAI,SAAS,EAAG,EAAGoC,EAAMA,CAAI,EAE7B,MAAMuZ,GAAOD,EAAO,OACdE,GAAOF,EAAO,CAAC,GAAG,QAAUC,GAC5BE,GAAQzZ,EAAOwZ,GACfE,GAAQ1Z,EAAOuZ,GAErB,QAASvuB,GAAI,EAAGA,GAAIuuB,GAAMvuB,KACxB,QAAS3hB,GAAI,EAAGA,GAAImwC,GAAMnwC,KACdiwC,EAAOtuB,EAAC,EAAE3hB,EAAC,IAEnBu0B,EAAI,UAAY,UAChBA,EAAI,SACF,KAAK,MAAMv0B,GAAIowC,EAAK,EACpB,KAAK,MAAMzuB,GAAI0uB,EAAK,EACpB,KAAK,KAAKD,EAAK,EACf,KAAK,KAAKC,EAAK,IAMvB,OAAOlb,EAAO,UAAU,WAAW,CACrC,EAAG,EAAE,EAEL,KAAM,CAACmb,GAAUC,EAAW,EAAIlyC,WAAwB,IAAI,EACtDmyC,GAAc3uC,SAAsB,IAAI,EACxC,CAACqsB,GAAIuiB,EAAK,EAAIpyC,WAA2B,IAAI,EAC7CqyC,GAAQ7uC,SAAiC,IAAI,EAC7C8uC,GAA0B9uC,SAA0B,EAAE,EACtD,CAAC+uC,GAAWC,EAAY,EAAIxyC,WAAwB,IAAI,EACxD,CAAC6iB,GAAK4vB,EAAM,EAAIzyC,WAAiB,KAAK,KAAK,EAC3C,CAAC0vB,GAAQgjB,CAAS,EAAI1yC,WAAkB,EAAK,EAEnD,SAAS2yC,GAAenjB,EAAqB,CAC3C,GAAI,CACF0iB,GAAY1iB,CAAI,EAChB2iB,GAAY,QAAU3iB,CACxB,MAAY,CAAC,CACf,CACA,KAAM,CAACojB,GAASC,EAAU,EAAI7yC,WAAwB,IAAI,EACpD,CAAC8yC,GAAWC,EAAY,EAAI/yC,WAGxB,IAAI,EACR,CAACgzC,GAAUC,EAAW,EAAIjzC,WAAkB,EAAI,EAChD,CAACkzC,GAAaC,EAAc,EAAInzC,WAA0B,EAAE,EAC5D,CAACozC,GAAiBC,EAAkB,EAAIrzC,WAAkB,EAAK,EAC/D,CAACszC,GAAcC,EAAe,EAAIvzC,WACtC,MAEIwzC,GAAiBhwC,SAAsB,IAAI,EAGjDuX,YAAU,IAoND,IAAM,CAIXm1B,GAAgB,QAAU,IAC5B,EACC,CAACxB,EAAYa,GAAiBlgB,EAAWyQ,CAAQ,CAAC,EAErD/kB,YAAU,IAAM,CAEd,MAAMlc,EAAI,OAAO,SAAS,UACtBA,IAAM,aAAeA,IAAM,cAC7Bge,GAAS,YAAY,EAClB,KAAM3d,GAAMA,EAAE,MAAM,EACpB,KAAM4N,GAAM,CACX,MAAM60B,EAAK,MAAM,QAAQ70B,GAAG,KAAK,GAAKA,EAAE,MAAM,KAAMnL,GAAcA,CAAC,EAC/DggC,MAAeA,CAAE,CACvB,CAAC,EACA,MAAM,IAAM,CAAC,CAAC,EAGnB9kB,GAAS,iBAAiB,EACvB,KAAM3d,GAAMA,EAAE,MAAM,EACpB,KAAM4N,GAAM,CACPA,GAAK,OAAOA,EAAE,OAAU,WAC1BimC,GAAa,CAAE,MAAO,CAAC,CAACjmC,EAAE,MAAO,KAAM,OAAOA,EAAE,IAAI,GAAK,KAAM,CACnE,CAAC,EACA,MAAM,IAAM,CAAC,CAAC,CACnB,EAAG,EAAE,EAGL,MAAM2mC,GAAYzsC,UAAQ,IAAM,CAC9B,MAAMwoB,EAAOyiB,IAAY,OAEnBh2B,EAAU,sBAChB,GAAcA,EAAO,OAAS,EAC5B,GAAI,CACF,MAAMnC,GAAI,IAAI,IAAImC,CAAM,EAIxB,MAAO,GAFQ,GADEnC,GAAE,WAAa,OACH,QAAU,MAAM,MAAMA,GAAE,IAAI,GAAGA,GAAE,SAAS,SAAS,KAAK,EAAI,GAAKA,GAAE,QAAQ,GACpF,QAAQ,UAAW,EAAE,CAC3B,yBAAyB0V,CAAI,EAC7C,MAAY,CAAC,CAGf,MAAMpT,EAAOw2B,IAAW,OAAO,SAAS,SAClCc,EAAW,CAAC,CAACZ,IAAW,MACxB7Q,EAAOyR,EAAWZ,IAAW,MAAQ,KAAO,KAElD,MAAO,GADOY,EAAW,QAAU,MACpB,MAAMt3B,CAAI,IAAI6lB,CAAI,yBAAyBzS,CAAI,EAChE,EAAG,CAACyiB,GAAUW,GAASE,EAAS,CAAC,EAE3Ba,GAAoB3sC,UAAQ,IAAM,CACtC,GAAI,CAACysC,GAAW,OAAO,KACvB,GAAI,CACF,MAAM12B,EAAM,IAAI,IAAI02B,EAAS,EAC7B,OAAA12B,EAAI,aAAa,OAAO,MAAM,EACvBA,EAAI,WAAW,QAAQ,MAAO,EAAE,CACzC,MAAQ,CACN,OAAI,OAAO,OAAW,IAEb,GADQ,OAAO,SAAS,OAAO,QAAQ,MAAO,EAAE,CACvC,mBAEX,kBACT,CACF,EAAG,CAAC02B,EAAS,CAAC,EAEd14B,YAAU,IAAM,CACd,aAAa,QAAQ,eAAgBwU,CAAI,CAC3C,EAAG,CAACA,CAAI,CAAC,EAETxU,YAAU,IAAM,CACd,GAAI,SAAO,OAAW,KACtB,GAAI,CACE0yB,EACF,OAAO,aAAa,QAAQ,uBAAwB,GAAG,EAEvD,OAAO,aAAa,WAAW,sBAAsB,CAEzD,MAAY,CAAC,CACf,EAAG,CAACA,CAAqB,CAAC,EAE1B1yB,YAAU,IAAM,CACd,GAAiB,OAAO,OAAW,IAAa,OAChD,MAAM64B,EAAc,OAAO,WAAW,mBAAmB,EACnDC,EAAS,IAAM,CACnB,MAAMC,EACJ,OAAO,UAAc,KACrB,iCAAiC,KAAK,UAAU,SAAS,EACrDC,EACJ,OAAOH,EAAY,SAAY,UAAYA,EAAY,QAAU,GAC7DI,EAAS,OAAO,YAAc,IACpCpG,EAAkBkG,GAAYC,GAAUC,CAAM,CAChD,EACAH,EAAA,EACA,GAAI,CACE,OAAOD,EAAY,kBAAqB,WAC1CA,EAAY,iBAAiB,SAAUC,CAAM,EACtC,OAAOD,EAAY,aAAgB,YAC1CA,EAAY,YAAYC,CAAM,CAClC,MAAY,CAAC,CACb,cAAO,iBAAiB,SAAUA,CAAM,EACjC,IAAM,CACX,GAAI,CACE,OAAOD,EAAY,qBAAwB,WAC7CA,EAAY,oBAAoB,SAAUC,CAAM,EACzC,OAAOD,EAAY,gBAAmB,YAC7CA,EAAY,eAAeC,CAAM,CACrC,MAAY,CAAC,CACb,OAAO,oBAAoB,SAAUA,CAAM,CAC7C,CACF,EAAG,EAAE,EAGL94B,YAAU,IAAM,CAEd,GAAI,OAAO,UAAc,KAAe,CAAE,UAAkB,YAAa,CACvEuxB,EAAc,aAAa,EAC3B,MACF,CACA,IAAIrsB,EAAU,GACd,OAAC,SAAY,CACX,GAAI,CACF,MAAM5hB,EAAI,MAAO,UAAkB,YAAY,MAAM,CACnD,KAAM,SACP,EACD,GAAI,CAAC4hB,EAAS,OACdqsB,EAAcjuC,EAAE,OAAS,SAAS,EAClCA,EAAE,SAAW,IAAM,CACb4hB,GAASqsB,EAAcjuC,EAAE,KAAK,CACpC,CACF,MAAc,CAER4hB,KAAuB,SAAS,CACtC,CACF,KACO,IAAM,CACXA,EAAU,EACZ,CACF,EAAG,EAAE,EAEL,eAAeiqB,IAAsB,CACnC,GACE,SAAO,UAAc,KACrB,CAAC,UAAU,cACX,CAAC,UAAU,aAAa,kBAG1B,GAAI,CAEF,MAAM+J,GADO,MAAM,UAAU,aAAa,oBAEvC,OAAQt1C,GAAMA,EAAE,OAAS,YAAY,EACrC,IAAKA,IAAO,CACX,SAAWA,EAAU,SACrB,MAAOA,EAAE,OAAS,UAClB,EACJ4tC,EAAgB0H,CAAI,EAChBA,EAAK,QAAU,CAACzH,GAClBC,EAAoBwH,EAAK,CAAC,EAAE,QAAQ,CACxC,MAAc,CAEd,CACF,CAEAl5B,YAAU,MAGP,SAAY,CACX,GAAI,CACF,MAAMmvB,GAAA,CACR,MAAY,CAAC,CACb,GAAI,CACE,WAAW,cAAc,iBAC3B,UAAU,aAAa,iBACrB,eACAA,EAAA,EAGD,UAAU,aAAqB,eAAiBA,EAErD,MAAY,CAAC,CACf,KACO,IAAM,CACX,GAAI,CACE,WAAW,cAAc,qBAC3B,UAAU,aAAa,oBACrB,eACAA,EAAA,CAEN,MAAY,CAAC,CACf,GACC,EAAE,EAEL,eAAeC,GAAWwB,EAAmB,CAC3C,GACE,OAAO,UAAc,KACrB,CAAC,UAAU,cACX,CAAC,UAAU,aAAa,aACxB,CACA,MAAM,+CAA+C,EACrD,MACF,CACA,MAAMuI,EAAmB,CACvB,MAAOvI,EACH,CAAE,SAAU,CAAE,MAAOA,CAAA,CAAS,EAC9B,CAAE,WAAY,cAAc,EAElC,IAAIhc,EAA6B,KACjC,GAAI,CACFA,EAAS,MAAM,UAAU,aAAa,aAAaukB,CAAW,EAE9DvkB,EAAO,YAAY,QAASxwB,GAAMA,EAAE,MAAM,EAC1CmtC,EAAc,SAAS,EAEvB,GAAI,CACEX,GAAY,OAAOf,IAAuB,YAC5CA,GAAmBe,CAAQ,CAE/B,MAAQ,CAAC,CACT,MACE,yEAEJ,OAASzuB,EAAU,CACjB,QAAQ,MAAM,wCAAyCA,CAAG,EAExDA,IACCA,EAAI,OAAS,mBAAqBA,EAAI,OAAS,0BAEhDovB,EAAc,QAAQ,EACtB,MACE,iGAGFpvB,IACCA,EAAI,OAAS,iBAAmBA,EAAI,OAAS,wBAE9C,MACE,+FAGF,MAAM,iCAAmCA,GAAK,SAAWA,EAAI,CAEjE,SACMyS,KAAe,YAAY,QAASxwB,GAAMA,EAAE,MAAM,CACxD,CACF,CA8BA4b,YAAU,IAAM,CACd,GAAiB,CAACw3B,GAAW,OAC7B,MAAMpzC,EAAI,YAAY,IAAMszC,GAAO,KAAK,KAAK,EAAG,GAAI,EACpD,MAAO,IAAM,cAActzC,CAAC,CAC9B,EAAG,CAACozC,EAAS,CAAC,EACd,MAAM4B,GAAMntC,UACV,IAAOurC,GAAY,KAAK,IAAI,EAAG,KAAK,MAAMA,GAAY1vB,IAAO,GAAI,CAAC,EAAI,KACtE,CAAC0vB,GAAW1vB,EAAG,GAEjB9H,YAAU,IACD,IAAM,CACPy4B,GAAe,SAAS,OAAO,aAAaA,GAAe,OAAO,CACxE,EACC,EAAE,EAEL,MAAMY,GAAYzuC,cAChB,MAAO/F,EAAkCy0C,IAA0B,CACjE,GAAKz0C,EACL,GAAI,CACF,GAAI,UAAU,WAAa,UAAU,UAAU,UAC7C,MAAM,UAAU,UAAU,UAAUA,CAAK,MACpC,CACL,MAAM00C,EAAW,SAAS,cAAc,UAAU,EAClDA,EAAS,MAAQ10C,EACjB00C,EAAS,MAAM,SAAW,QAC1BA,EAAS,MAAM,QAAU,IACzB,SAAS,KAAK,YAAYA,CAAQ,EAClCA,EAAS,QACTA,EAAS,SACT,SAAS,YAAY,MAAM,EAC3B,GAAI,CACF,SAAS,KAAK,YAAYA,CAAQ,CACpC,MAAQ,CAER,CACF,CACAf,GAAgBc,CAAI,EAChBb,GAAe,SAAS,OAAO,aAAaA,GAAe,OAAO,EACtEA,GAAe,QAAU,OAAO,WAC9B,IAAMD,GAAgB,IAAI,EAC1B,KAEJ,OAASr2B,EAAK,CACZ,QAAQ,KAAK,mCAAoCA,CAAG,EACpDq2B,GAAgB,IAAI,CACtB,CACF,EACA,EAAC,EAQHx4B,YAAU,IACD,IAAM,CAIb,EACC,EAAE,EAGLA,YAAU,IAAM,CAEd,MAAMw5B,EAA0BhuC,GAAe,CAC7C,QAAQ,IACN,0EAGEgpB,IAAS,SAAWG,KACtB8kB,GAAW,EAAK,EAEhB,WAAW,IAAM,CACfC,GAAA,CACF,EAAG,GAAG,EAEV,EAEA,cAAO,iBACL,6BACAF,CAAA,EAEK,IAAM,CACX,OAAO,oBACL,6BACAA,CAAA,CAEJ,CACF,EAAG,CAAChlB,EAAMG,EAAM,CAAC,EAIjB3U,YAAU,IAAM,CACd,QAAQ,IAAI,4CAA6C,CACvD,UAAAsU,EACA,kBAAmB,CAAC,CAAC6c,EAAS,QAC/B,EACGA,EAAS,SACX,QAAQ,IACN,qEAEFkC,GAAc,mBAAmBlC,EAAS,OAAO,EAE7CA,EAAS,QAAQ,qBAAqB,cACxC,QAAQ,IACN,gEAEFkC,GAAc,eAAelC,EAAS,QAAQ,SAAS,IAGzD,QAAQ,KACN,uEAGN,EAAG,CAAC7c,CAAS,CAAC,EAGdtU,YAAU,KACR,QAAQ,IACN,kEAEF,QAAQ,IACN,kDACA,CAAC,CAACmxB,EAAS,SAEb,QAAQ,IACN,6CACAA,EAAS,SAAS,aAAa,MAG7BA,EAAS,SACX,QAAQ,IAAI,wDAAwD,EACpE,QAAQ,IAAI,qCAAsC,CAChD,QAASA,EAAS,QAAQ,QAC1B,UAAW,CAAC,CAACA,EAAS,QAAQ,UAC9B,WAAYA,EAAS,QAAQ,WAC7B,YAAaA,EAAS,QAAQ,YAC/B,EACDkC,GAAc,mBAAmBlC,EAAS,OAAO,EACjD,QAAQ,IAAI,wDAAwD,GAEpE,QAAQ,MACN,sEAIG,IAAM,CAEb,GACC,EAAE,EAEL,SAASwI,IAAW,CAElB,GACE7kB,KACCA,GAAG,aAAe,UAAU,MAC3BA,GAAG,aAAe,UAAU,YAE9B,eAAQ,IACN,mEACAA,GAAG,WACH,KAEKA,GAGT,MAAM5T,EAAU,sBACV04B,EACM14B,EAAO,OAAS,EACtBA,EAAO,SAAS,KAAK,EACnBA,EACAA,EAAO,QAAQ,MAAO,EAAE,EAAI,MAC9B,OAEAK,EAAa,GADL,OAAO,SAAS,WAAa,SAAW,MAAQ,IACnC,MAAM,OAAO,SAAS,IAAI,MAC/CF,EAAO,OAAO,SAAS,SAIvBW,GACJ43B,IAAkBv4B,EAAK,SAAS,cAAc,EAAIE,EAFnC,wCAGjB,QAAQ,IACN,2DACAS,EAAA,EAEF,MAAM63B,GAAoB,IAAI,UAAU73B,EAAG,EAG3C,OAAA63B,GAAO,QAAWvT,IAAU,CAC1B,QAAQ,MAAM,kDAAmDA,EAAK,EACtE,MACE,oGAEJ,EACAuT,GAAO,QAAWruC,IAAU,CAM1B,GALA,QAAQ,IACN,wCACAA,GAAM,KACNA,GAAM,QAEJ8rC,GAAM,QAAS,CACjB,GAAI,CACFA,GAAM,QAAQ,OAChB,MAAQ,CAAC,CACTA,GAAM,QAAU,IAClB,CACAM,GAAe,IAAI,EACnBH,GAAa,IAAI,EACjBE,EAAU,EAAK,EAEXnsC,GAAM,OAAS,MACjB,MAAM,2DAA2D,EAE7DgpB,IAAS,SAASsd,EAAQ,OAAO,EAEzC,EAGAuF,GAAMwC,EAAM,EACLA,EACT,CAEA,eAAeH,IAAoB,CAGjC5H,EAAQ,OAAO,EAIf2H,GAAW,EAAK,EAEhBK,GAAA,EACA,GAAI,CACF/J,EAAiB,EAAI,CACvB,MAAY,CAAC,CACb,MAAM8J,EAASF,GAAA,EAEXE,EAAO,aAAe,UAAU,MAClC,QAAQ,IAAI,wDAAwD,EACpEA,EAAO,KAAK,KAAK,UAAU,CAAE,KAAM,aAAc,CAAC,IAElD,QAAQ,IACN,0EAEFA,EAAO,iBACL,OACA,IAAM,CACJ,QAAQ,IACN,8DAEFA,EAAO,KAAK,KAAK,UAAU,CAAE,KAAM,aAAc,CAAC,CACpD,EACA,CAAE,KAAM,GAAK,GAGjBA,EAAO,UAAY,MAAOxQ,GAAO,CAC/B,MAAM3iC,EAAO,KAAK,MAAM2iC,EAAG,IAAI,EAC/B,GAAI3iC,EAAK,OAAS,WAChBkxC,GAAelxC,EAAK,IAAI,EACpBA,EAAK,WAAW+wC,GAAa/wC,EAAK,SAAS,UACtCA,EAAK,OAAS,kBAAmB,CAEtC,CAAC0wC,GAAY,SAAW1wC,EAAK,MAAMkxC,GAAelxC,EAAK,IAAI,EAC/DixC,EAAU,EAAI,EAEd,MAAMoC,EAAiB3C,GAAY,SAAW1wC,EAAK,MAAQ,KACvDqzC,OAA4B,QAAUA,GAC1C,GAAI,CACF,GAAI/G,IAAU+G,EAAgB,CAC5B,MAAMC,GAAU5I,EAAU,QACtB,CAAE,EAAGA,EAAU,QAAQ,MAAO,EAAGA,EAAU,QAAQ,QACnD,KACE6I,GAAU,CACd,EAAA5kB,EACA,UAAW2kB,GACX,QAASvd,IAAW,KACpB,UAAW,KAAK,KAAI,EAEtBod,EAAO,KACL,KAAK,UAAU,CACb,KAAM,kBACN,KAAME,EACN,QAAAE,EAAA,CACD,GAEH,QAAQ,IACN,gEACAF,CAAA,CAEJ,CACF,OAASl2C,GAAG,CACV,QAAQ,KACN,8DACAA,EAAA,CAEJ,CACA,MAAMq2C,EAAO,IAAI,kBAAkB,CACjC,WAAY,CAAC,CAAE,KAAM,+BAAgC,EACrD,qBAAsB,GACvB,EACD5C,GAAM,QAAU4C,EAGhBA,EAAK,wBAA0B,IAAM,CACnC,QAAQ,IAAI,2BAA4BA,EAAK,eAAe,EAE1DA,EAAK,kBAAoB,UACzBA,EAAK,kBAAoB,gBAEzB,QAAQ,MAAM,0BAA0B,EACxC,MAAM,mDAAmD,EACzDT,GAAW,EAAK,GACPS,EAAK,kBAAoB,aAClC,QAAQ,IAAI,+BAA+B,CAE/C,EAEAA,EAAK,eAAkBr2C,IAAM,CACvBA,GAAE,WAAak2C,GACjBF,EAAO,KACL,KAAK,UAAU,CACb,KAAM,UACN,KAAME,EACN,QAASl2C,GAAE,UACZ,EAGP,EAEAq2C,EAAK,QAAW7Q,IAAO,CAOrB,GANA,QAAQ,IACN,+CACAA,GAAG,SAAS,OACZ,uBACAA,GAAG,OAAO,MAER8H,EAAS,QAAS,CACpB,MAAMgJ,GAAU9Q,GAAG,UAAU,CAAC,EAC1B8Q,IACF,QAAQ,IACN,sDACAA,GAAQ,YAAY,OACpB,sBAGFjI,EAAe,EAAK,EAEpB,WAAW,IAAM,CACXf,EAAS,UACX,QAAQ,IACN,6DAGEA,EAAS,QAAQ,WAEjBA,EAAS,QAAQ,UACjB,YACa,QAAS/sC,IAAMA,GAAE,MAAM,EAExC+sC,EAAS,QAAQ,UAAYgJ,GAC7BhJ,EAAS,QAAQ,MAAQ,GACzBA,EAAS,QAAQ,YAAc,GAC/BA,EAAS,QACN,OACA,KAAK,IAAM,CACV,QAAQ,IACN,2DAGFQ,EAAa,EAAI,EACjBS,EAAS,SAAS,EAElBiB,GAAc,aAAa,EAAI,EAC/BA,GAAc,QAAQ,OAAO,EAC7BA,GAAc,eAAe8G,EAAO,EAEpC,GAAI,CACFtK,GAAmB,OAAW,eAAgB,EAAI,CACpD,MAAQ,CAAC,CACT,GAAI,CAACG,EACH,GAAI,CACFC,GAAyB,EAAI,CAC/B,MAAQ,CAAC,CAEX,GAAI,CACFF,EAAiB,EAAI,CACvB,MAAQ,CAAC,CAET8B,EAAoB,EAAK,CAC3B,CAAC,EACA,MAAO1vB,IAAQ,CACd,QAAQ,MACN,yCACAA,EAAA,EAGF0vB,EAAoB,EAAI,EACxB,QAAQ,KACN,sEAEJ,CAAC,EAEP,EAAG,GAAG,GAEN,QAAQ,MACN,4DAGN,MACE,QAAQ,MAAM,iDAAiD,CAEnE,EAEA,GAAI,CAGFqI,EAAK,eAAe,QAAS,CAAE,UAAW,WAAY,EACtD,MAAM1T,GAAQ,MAAM0T,EAAK,YAAY,CACnC,oBAAqB,GACrB,oBAAqB,GACtB,EACD,MAAMA,EAAK,oBAAoB1T,EAAK,EACpC,QAAQ,IACN,kDACAuT,CAAA,EAEEA,EACFF,EAAO,KACL,KAAK,UAAU,CACb,KAAM,YACN,KAAME,EACN,QAASvT,EAAA,CACV,GAGH,QAAQ,KACN,8DAEN,OAASrkB,GAAK,CACZ,QAAQ,MAAM,iCAAkCA,EAAG,EACnD,MAAM,0DAA0D,EAChEs3B,GAAW,EAAK,CAClB,CACF,SAAW/yC,EAAK,OAAS,aAAc,CACrC,QAAQ,IAAI,yCAAyC,EACrD,MAAMwzC,EAAO5C,GAAM,QACnB,GAAI4C,EACF,GAAI,CACF,MAAMA,EAAK,qBACT,IAAI,sBAAsBxzC,EAAK,OAAO,GAExC,QAAQ,IAAI,qDAAqD,EAGjE,MAAM0zC,EAAU7C,GAAwB,QACxC,QAAQ,IACN,kCAAkC6C,EAAQ,MAAM,2BAElD,UAAWC,MAAaD,EACtB,GAAI,CACF,MAAMF,EAAK,gBAAgBG,EAAS,EACpC,QAAQ,IAAI,gDAAgD,CAC9D,OAASl4B,GAAK,CACZ,QAAQ,MAAM,sCAAuCA,EAAG,CAC1D,CAEFo1B,GAAwB,QAAU,EACpC,OAASp1B,EAAK,CACZ,QAAQ,MAAM,oCAAqCA,CAAG,EACtD,MAAM,0CAA0C,EAChDs3B,GAAW,EAAK,CAClB,MAEA,QAAQ,KACN,wEAGN,SAAW/yC,EAAK,OAAS,UAAW,CAClC,QAAQ,IAAI,sCAAsC,EAClD,MAAMwzC,EAAO5C,GAAM,QACnB,GAAI4C,EAGF,GAAIA,EAAK,kBACP,GAAI,CACF,MAAMA,EAAK,gBAAgBxzC,EAAK,OAAO,EACvC,QAAQ,IAAI,yCAAyC,CACvD,OAASyb,EAAK,CACZ,QAAQ,MAAM,+BAAgCA,CAAG,CACnD,MAEA,QAAQ,IACN,6EAEFo1B,GAAwB,QAAQ,KAAK7wC,EAAK,OAAO,OAGnD,QAAQ,KACN,2EAGN,SAAWA,EAAK,OAAS,YACvB,QAAQ,MAAM,wBAAyBA,EAAK,IAAI,EAChD,MACEA,EAAK,OAAS,UACV,qCACA,iBAAiBA,EAAK,MAAQ,eAAe,IAEnD+yC,GAAW,EAAK,UACP/yC,EAAK,OAAS,kBAAmB,CAE1C,QAAQ,IACN,sDACAA,EAAK,SAEP,GAAI,CACF,GAAIA,EAAK,QAAS,CAEhB,IAAI4zC,EAAW,MAAM,QAAQ5zC,EAAK,QAAQ,CAAC,EACtCA,EAAK,QAAQ,EACd,KACJ,GACE,CAAC4zC,GACD,MAAM,QAAQ5zC,EAAK,QAAQ,iBAAiB,GAC5CA,EAAK,QAAQ,kBAAkB,QAAU,EAEzC,GAAI,CACF,MAAMs+B,EAAe,CACnB,CAAE,EAAG,EAAG,EAAG,CAAChQ,GAAW,aACvB,CAAE,EAAGA,GAAW,YAAa,EAAG,GAChC,CAAE,EAAG,EAAG,EAAGA,GAAW,aACtB,CAAE,EAAG,CAACA,GAAW,YAAa,EAAG,EAAE,EAErCslB,EAAWzjB,GACTmO,EACAt+B,EAAK,QAAQ,kBAAkB,MAAM,EAAG,CAAC,EAE7C,OAASyb,EAAK,CACZ,QAAQ,KACN,mFACAA,CAAA,CAEJ,CAEF,GAAIm4B,EAAU,CAGZ,MAAMrH,EAAc5B,GAAY,QAC5B,CAAE,EAAGA,EAAW,QAAQ,MAAO,EAAGA,EAAW,QAAQ,QACrDF,GAAU,QACR,CACE,EAAGA,EAAS,QAAQ,YACpB,EAAGA,EAAS,QAAQ,cAErBzqC,EAAK,QAAQ,WAAa,KACjCosC,EAAe,CACb,EAAGwH,EACH,UAAW5zC,EAAK,QAAQ,WAAa,KAAK,MAC1C,QAASA,EAAK,QAAQ,QACtB,UAAWA,EAAK,QAAQ,UACxB,YAAAusC,EACA,OAAQ,GACT,EACD,QAAQ,IAAI,kDAAkD,CAChE,CACF,CACF,OAASpvC,EAAG,CACV,QAAQ,MACN,2DACAA,CAAA,CAEJ,CACF,CACF,CACF,CAEA,eAAe02C,IAAsB,CACnCjC,GAAmB,EAAI,EACvB,GAAI,CACF,MAAMxS,EAAU,MAAMD,GAAA,EACtBuS,GAAetS,CAAO,EAClBA,EAAQ,SAAW,GACrB,MACE,qHAGN,OAASQ,EAAO,CACd,QAAQ,MAAM,gCAAiCA,CAAK,EACpD,MACE,yEAEJ,SACEgS,GAAmB,EAAK,CAC1B,CACAlG,EAAS,QAAQ,CACnB,CAEA,eAAeoI,GAAoBpU,EAAuB,CACxD,GAAI,CACFgS,GAAgBtS,GACdA,EAAQ,IAAKliC,GACXA,EAAE,KAAOwiC,EAAO,GAAK,CAAE,GAAGxiC,EAAG,OAAQ,cAA0BA,CAAA,CACjE,EAGF,MAAMgxB,EAAS,MAAM+S,GAAuBvB,CAAM,EAClD,GAAIxR,GAAUuc,EAAS,QAEjBA,EAAS,QAAQ,WAEjBA,EAAS,QAAQ,UACjB,YACa,QAAS/sC,GAAMA,EAAE,MAAM,EAExC+sC,EAAS,QAAQ,UAAYvc,EAC7B,MAAMuc,EAAS,QAAQ,OACvBQ,EAAa,EAAI,EACjBS,EAAS,SAAS,EAClBgG,GAAgBtS,GACdA,EAAQ,IAAKliC,GACXA,EAAE,KAAOwiC,EAAO,GAAK,CAAE,GAAGxiC,EAAG,OAAQ,UAAsBA,CAAA,CAC7D,MAGF,OAAM,IAAI,MAAM,4BAA4B,CAEhD,OAAS0iC,EAAO,CACd,QAAQ,MAAM,oCAAqCA,CAAK,EACxD,MACE,wBAAwBF,EAAO,IAAI,4CAErCgS,GAAgBtS,GACdA,EAAQ,IAAKliC,GACXA,EAAE,KAAOwiC,EAAO,GAAK,CAAE,GAAGxiC,EAAG,OAAQ,WAAuBA,CAAA,CAC9D,CAEJ,CACF,CAEA,eAAe62C,IAAc,CAC3B,GAAIjmB,IAAS,QAAS,OAAOklB,GAAA,EAC7B,GAAIllB,IAAS,OAAQ,OAAO+lB,GAAA,EAC5B,QAAQ,IACN,6CACA/lB,EACA,qBACAmb,EAAA,EAEF,GAAI,CACF,IAAI/a,EAA6B,KAGjC,GAAI+a,GACF,GAAI,CACF,QAAQ,IACN,+DACAA,EAAA,EAEF/a,EAAS,MAAM,UAAU,aAAa,aAAa,CACjD,MAAO,CAAE,SAAU,CAAE,MAAO+a,GAAkB,EAC9C,MAAO,GACR,EACD,QAAQ,IACN,uDACA/a,EAAO,YAAY,OACnB,SAEJ,OAASzS,EAAU,CACjB,QAAQ,KACN,kDACAA,GAAK,KACLA,GAAK,QAET,CAIF,GAAI,CAACyS,EACH,GAAI,CACF,QAAQ,IACN,gEAEFA,EAAS,MAAM,UAAU,aAAa,aAAa,CACjD,MAAO,GACP,MAAO,GACR,EACD,QAAQ,IACN,sDACAA,EAAO,YAAY,OACnB,SAEJ,OAASzS,EAAU,CACjB,cAAQ,MACN,8CACAA,GAAK,KACLA,GAAK,SAEDA,CACR,CAIF,GAAI,CAACyS,EACH,MAAM,IAAI,MAAM,oBAAoB,EAGtC,GAAI,CAACuc,EAAS,QACZ,MAAM,IAAI,MAAM,2BAA2B,EAG7C,QAAQ,IAAI,0DAA0D,EACtEA,EAAS,QAAQ,UAAYvc,EAE7B,QAAQ,IAAI,uCAAuC,EACnD,GAAI,CACF,MAAMuc,EAAS,QAAQ,OACvB,QAAQ,IAAI,sCAAsC,CACpD,OAASuJ,EAAc,CACrB,QAAQ,KACN,yDACAA,GAAS,SAEX,MAAM,IAAI,QAASv2C,GAAM,WAAWA,EAAG,GAAG,CAAC,EAC3C,MAAMgtC,EAAS,QAAQ,OACvB,QAAQ,IAAI,+CAA+C,CAC7D,CAEA,QAAQ,IAAI,iDAAiD,EAC7DQ,EAAa,EAAI,EACjBS,EAAS,SAAS,EAClB,QAAQ,IAAI,sCAAsC,CACpD,OAASvuC,EAAQ,CACf,QAAQ,MAAM,gCAAiCA,GAAG,SAAWA,CAAC,EAC9D,MAAM,kBAAkBA,GAAG,SAAW,eAAe,EAAE,EAEnDstC,EAAS,SAAS,YACnBA,EAAS,QAAQ,UACf,YACA,QAAS/sC,GAAMA,EAAE,MAAM,EAC1B+sC,EAAS,QAAQ,UAAY,KAEjC,CACF,CAEA,SAASsI,GAAWkB,EAAsB,GAAO,CAO/C,GANIxJ,EAAS,SAAWA,EAAS,QAAQ,YACvBA,EAAS,QAAQ,UAA0B,YACpD,QAAS/sC,GAAMA,EAAE,MAAM,EAC9B+sC,EAAS,QAAQ,UAAY,KAC7BQ,EAAa,EAAK,GAEhB2F,GAAM,QAAS,CACjB,GAAI,CACFA,GAAM,QAAQ,OAChB,MAAQ,CAAC,CACTA,GAAM,QAAU,IAClB,CACAC,GAAwB,QAAU,GAClCK,GAAe,IAAI,EACnBH,GAAa,IAAI,EACjBE,EAAU,EAAK,EACfpD,GAAgB,IAAI,EAEpBlB,GAAc,aAAa,EAAK,EAChCA,GAAc,eAAe,IAAI,EAG7BsH,IAAenmB,IAAS,SAAWA,IAAS,SAC9Csd,EAAQ,OAAO,CAEnB,CAEA,SAAS8I,IAAiB,CAEpB9lB,IAAMA,GAAG,aAAe,UAAU,KACpCA,GAAG,KAAK,KAAK,UAAU,CAAE,KAAM,aAAc,CAAC,EAE9C4kB,GAAA,EAIFI,GAAA,CACF,CAMA,SAASA,IAA0B,CACjC,GAAI,CACG9J,GACHC,GAAyB,EAAI,CAEjC,MAAQ,CAAC,CACX,CA8CA,SAAS4K,IAAe,CACtB,GAAI,CAAC1J,EAAS,SAAW,CAACC,EAAU,QAAS,OAC7C,MAAM7xB,EAAI4xB,EAAS,QACb3tC,EAAI4tC,EAAU,QAepB,GAdA5tC,EAAE,MAAQ+b,EAAE,WACZ/b,EAAE,OAAS+b,EAAE,YACD/b,EAAE,WAAW,IAAI,EACzB,UAAU+b,EAAG,EAAG,EAAG/b,EAAE,MAAOA,EAAE,MAAM,EACxC0uC,EAAe,EAAI,EACnBK,EAAa,CAAE,EAAG/uC,EAAE,MAAO,EAAGA,EAAE,OAAQ,EACxC4uC,EAAS,QAAQ,EAEjB,QAAQ,IAAI,6DAA6D,EACzEJ,EAAa,EAAE,EACf4B,EAAY,IAAI,EAChByC,GAAqB,EAAK,EAC1B9B,GAAgB,IAAI,EAEhBlD,EAAW,QAAS,CACtB,MAAM/kC,EAAI+kC,EAAW,QACrB/kC,EAAE,MAAQ9I,EAAE,MACZ8I,EAAE,OAAS9I,EAAE,OACb,MAAM4gC,EAAO93B,EAAE,WAAW,IAAI,EAC1B83B,KAAW,UAAU,EAAG,EAAG93B,EAAE,MAAOA,EAAE,MAAM,CAClD,CAEIunC,IACF,WAAW,IAAM,CACfiH,GAAA,CACF,EAAG,CAAC,CACR,CAEA,SAASC,GACPC,EAAgBjJ,EAChBkJ,EAAwB,KACxB,CACA,GAAI,CAAC7J,EAAU,SAAW,CAACC,EAAW,QAAS,OAC/C,MAAM3V,EAAM0V,EAAU,QAChB9kC,EAAI+kC,EAAW,QACrB/kC,EAAE,MAAQovB,EAAI,MACdpvB,EAAE,OAASovB,EAAI,OACf,MAAMP,EAAM7uB,EAAE,WAAW,IAAI,EAC7B6uB,EAAI,UAAU,EAAG,EAAG7uB,EAAE,MAAOA,EAAE,MAAM,EAGjC+kC,EAAW,UACbA,EAAW,QAAQ,QAAWxtC,IAAkBq3C,GAAer3C,EAAC,GAMlE,MAAMs3C,GACJF,IAAOD,EAAc,QAAUhK,GAAuB3b,EAAI,MAGtD+lB,GAAgBxF,GAChByF,GAAgBvF,GAChBwF,GAAgBtF,GACtB,IAAIuF,GAAaJ,GACbI,IAAcH,KAAkB,IAClCG,GAAa/lB,GAAgB+lB,GAAYH,GAAe,CAAC,GACvDG,KAAeF,KAAkB,GAAKC,KAAkB,KAC1DC,GAAavlB,GACXulB,GACAF,GACAC,EAAA,GAIJ,MAAME,GAAkBzW,EAAWA,EAAS,GAAK+Q,GAAe,EAC1D2F,GAAkB1W,EAAWA,EAAS,GAAKiR,GAAe,EAG1D0F,GAAe,EACfC,GAA6C,GAC/C5W,IAEF4W,GAAgB3mB,GAAW,SAAS,EAAI+P,EAAS,UAAY2W,GAC7DC,GAAgB3mB,GAAW,SAAS,EAAI+P,EAAS,UAAY2W,GAC7DC,GAAgB3mB,GAAW,WAAW,EACpC+P,EAAS,YAAc2W,GACzBC,GAAgB3mB,GAAW,WAAW,EACpC+P,EAAS,YAAc2W,GACzBC,GAAgB3mB,GAAW,WAAW,EACpC+P,EAAS,YAAc2W,GACzBC,GAAgB3mB,GAAW,WAAW,EACpC+P,EAAS,YAAc2W,IAI3B,MAAME,GAA2C,GAEjDA,GAAc5mB,GAAW,WAAW,EAAIshB,GACxCsF,GAAc5mB,GAAW,WAAW,EAAIwhB,GAGxC,SAASqF,IAA4B,CACnC,GAAI,CAAC9W,EAAU,MAAO,GACtB,IAAI+W,GAAQ,EACZ,GAAI,CAEF,MAAMC,GAAW,wBACXC,GAAa,wBACbC,GAAa,wBAEbC,GAAW,CACfpa,GACAC,GACAoa,GACAC,KACG,CACH,MAAMC,GAAQV,GAAgB7Z,EAAM,EAC9Bwa,GAAQX,GAAgB5Z,EAAM,EACpC,GAAI,CAACsa,IAAS,CAACC,GAAO,MAAO,GAC7BnhB,EAAI,OACJA,EAAI,YAAc,mBAClBA,EAAI,WAAa,EACjBA,EAAI,YACJ,MAAMohB,GAAWD,IAASV,GAAc7Z,EAAM,GAAK,GAC7Cya,GAAWH,IAAST,GAAc9Z,EAAM,GAAK,GAEnD,OAAA3G,EAAI,IAAIqgB,GAAiBC,GAAiBc,GAAU,EAAG,KAAK,GAAK,CAAC,EAClEphB,EAAI,IACFqgB,GACAC,GACAe,GACA,EACA,KAAK,GAAK,EACV,IAEFrhB,EAAI,YACJA,EAAI,UAAYghB,GAChBhhB,EAAI,OAMJA,EAAI,UACG,EACT,EAEA+gB,GAASlnB,GAAW,UAAWA,GAAW,UAAW+mB,EAAQ,EAC7DD,KACAI,GAASlnB,GAAW,YAAaA,GAAW,YAAagnB,EAAU,EACnEF,KACAI,GAASlnB,GAAW,YAAaA,GAAW,YAAainB,EAAU,EACnEH,KAGA,MAAMW,GAAgB,IAChBC,GAAW,CACf,CAAE,EAAG1nB,GAAW,UAAW,MAAO,WAClC,CAAE,EAAGA,GAAW,UAAW,MAAO,WAClC,CAAE,EAAGA,GAAW,YAAa,MAAO,WACpC,CAAE,EAAGA,GAAW,YAAa,MAAO,WACpC,CAAE,EAAGA,GAAW,YAAa,MAAO,WACpC,CAAE,EAAGA,GAAW,YAAa,MAAO,UAAU,EAEhD,UAAW2nB,MAASD,GAAU,CAC5B,MAAMz0B,GAAS0zB,GAAgBgB,GAAM,CAAC,EACtC,GAAI,CAAC10B,GAAQ,SACb,MAAM20B,GAAgB,GACtB,QAAS12C,GAAI,EAAGA,GAAIu2C,GAAev2C,KAAK,CACtC,MAAM2xB,GAAS3xB,GAAIu2C,GAAiB,KAAK,GAAK,EACxCI,GAAO50B,GAAS2tB,IAAgBgG,GAAce,GAAM,CAAC,GAAK,GAChEC,GAAK,KAAK,CACR,EAAGpB,GAAkBqB,GAAO,KAAK,IAAIhlB,EAAK,EAC1C,EAAG4jB,GAAkBoB,GAAO,KAAK,IAAIhlB,EAAK,EAC3C,CACH,CACAqD,GAAaC,EAAKyhB,GAAM,mBAAoB,CAAC,EAC7C1hB,GAAaC,EAAKyhB,GAAMD,GAAM,MAAO,GAAG,CAC1C,CACF,MAAc,CACZ,MAAO,EACT,CACA,MAAO,EACT,CAGA,SAASzB,GAAe4B,GAAiB,CACvC,GAAI,CAACpG,IAAgB,CAACrF,EAAW,SAAW,CAACtM,EAAU,OACvD,MAAMgY,GAAO1L,EAAW,QAAQ,wBAC1BzqC,IACHk2C,GAAI,QAAUC,GAAK,OAAS1L,EAAW,QAAQ,MAAQ0L,GAAK,OACzDx0B,IACHu0B,GAAI,QAAUC,GAAK,MAAQ1L,EAAW,QAAQ,OAAS0L,GAAK,QACzDv0B,GAAK5hB,GAAI40C,GACT/yB,GAAKF,GAAIkzB,GACTuB,GAAgB,KAAK,MAAMx0B,GAAIC,EAAE,EACvC,IAAIzC,GACA0wB,KAAiB,SAAU1wB,GAAMgP,GAAW,YACvC0hB,KAAiB,SAAU1wB,GAAMgP,GAAW,eAC1CA,GAAW,UACtB,MAAMioB,GAAgBtB,GAAgB31B,EAAG,EACzC,GAAI,CAACi3B,IAAiBA,IAAiB,EAAG,OAC1C,MAAMC,GAAYF,IAAiBC,GAAgBrH,IAC/Cc,KAAiB,UAAUH,GAAqB2G,EAAS,EACzDxG,KAAiB,UAAUD,GAAqByG,EAAS,EACzDxG,KAAiB,QAEnBb,GAAiB37B,IAASA,IAAQgjC,GAAYhjC,GAAK,EAErDy8B,GAAgB,IAAI,EACpB,QAAQ,IACN,+BACAD,GACA,WACAwG,GAAU,QAAQ,CAAC,EAEvB,CAMA,MAAMC,GAAQ5B,GAQd,GAPIN,GACF,QAAQ,IAAI,yCAA0C,CACpD,GAAIA,EAAG,MAAM,EAAG,CAAC,EACjB,mBAAoBD,EAAc,OAClC,WAAY,CAAE,EAAG1uC,EAAE,MAAO,EAAGA,EAAE,OAAO,CACvC,EAEC8pC,IAAqBrR,EAAU,CAEjC,MAAM+W,GAAQD,GAAA,EACd,QAAQ,IACN,2DACAC,EAAA,EAGF,GAAI,CACF,MAAMsB,GAAO/L,EAAW,SAAS,WAAW,IAAI,EAEhD,GADe,CAAC,CAAC+L,IAAQ/L,EAAW,SACtBtM,EAAU,CACtBqY,GAAM,OACNA,GAAM,KAAO,kBACbA,GAAM,UAAY,UAClBA,GAAM,YAAc,UACpBA,GAAM,UAAY,EAClB,MAAMC,GAASnoB,GACT8O,GAAUwX,GACVvX,GAAUwX,GACV6B,IAAUvY,EAAS,YAAcA,EAAS,aAAe,EAAI,GAC7DwY,GAAW,OAAOtlB,GAAU,SAAWA,EAAQ,EACrD,QAAS/xB,GAAI,EAAGA,GAAIm3C,GAAO,OAAQn3C,KAAK,CACtC,MAAMs3C,GACHt3C,GAAIm3C,GAAO,OAAU,KAAK,GAAK,EAAI,KAAK,GAAK,EAAIE,GAC9CE,GAAKzZ,GAAUsZ,GAAS,KAAK,IAAIE,EAAG,EACpCE,GAAKzZ,GAAUqZ,GAAS,KAAK,IAAIE,EAAG,EACpC9V,GAAO,OAAO2V,GAAOn3C,EAAC,CAAC,EACvBy3C,GAAKP,GAAM,YAAY1V,EAAI,EAAE,MACnC0V,GAAM,WAAW1V,GAAM+V,GAAKE,GAAK,EAAGD,GAAK,CAAC,EAC1CN,GAAM,SAAS1V,GAAM+V,GAAKE,GAAK,EAAGD,GAAK,CAAC,CAC1C,CACAN,GAAM,SACR,CACF,MAAQ,CAAC,CACT,MACF,CAEA,GAAIjC,GAAM,CAGR,MAAMyC,GAAQ,OAAOnhB,IAAY,SAAWA,GAAU,KAChDohB,GACJrI,IAAuBA,GAAoB,OAAS,EAChDsI,GAAUD,GACZrI,GAAoB,MAAOrxC,IAAMA,GAAE,KAAK,EACxC,KACE45C,GAAc,OAAOH,IAAU,SAAWA,IAAS,IAAM,KACzDI,GAAOF,KAAY,IAAQC,KAAgB,GAC3CE,GAAOJ,GACTrI,GAAoB,KAAMrxC,IAAM,CAACA,GAAE,KAAK,EACxC45C,KAAgB,GAEpB,QAAQ,IAAI,gDAAgD,EAS5D,IAAIG,GAAa,EAMjB,MAAMC,GAAe,CACnBC,GACAtc,GACAC,GACAoa,GACAC,KACG,CACH,GAAI,CAIF,MAAMiC,GAAgB1C,GAAgB7Z,EAAM,EACtCwc,GAAgB3C,GAAgB5Z,EAAM,EAC5C,GAAIgD,GAAYsZ,IAAiBC,GAC/B,OAAAnjB,EAAI,OAEJA,EAAI,YAAc,mBAClBA,EAAI,WAAa,EACjBA,EAAI,YAEAA,EAAI,SACNA,EAAI,QACFqgB,GACAC,GACA6C,GAAgB1I,GAChB0I,GACA,EACA,EACA,KAAK,GAAK,GAEZnjB,EAAI,QACFqgB,GACAC,GACA4C,GAAgBzI,GAChByI,GACA,EACA,EACA,KAAK,GAAK,EACV,MAGFljB,EAAI,IACFqgB,GACAC,GACA6C,GACA,EACA,KAAK,GAAK,GAEZnjB,EAAI,IACFqgB,GACAC,GACA4C,GACA,EACA,KAAK,GAAK,EACV,KAGJljB,EAAI,YACJA,EAAI,UAAYghB,GAChBhhB,EAAI,OACAihB,KACFjhB,EAAI,YAAcihB,GAClBjhB,EAAI,UAAY,EAChBA,EAAI,UAENA,EAAI,UACG,GAIT,MAAMmhB,GAAQxkB,GAAWsmB,GAAMrc,GAAQ,GAAK,EACtCsa,GAAQvkB,GAAWsmB,GAAMtc,GAAQ,GAAK,EAAE,UAC9C,GAAI,CAACwa,GAAM,QAAU,CAACD,GAAM,OAAQ,MAAO,GAC3ClhB,EAAI,OAEJA,EAAI,YAAc,mBAClBA,EAAI,WAAa,EACjBA,EAAI,YACJA,EAAI,OAAOmhB,GAAM,CAAC,EAAE,EAAGA,GAAM,CAAC,EAAE,CAAC,EACjC,QAASp2C,GAAI,EAAGA,GAAIo2C,GAAM,OAAQp2C,KAChCi1B,EAAI,OAAOmhB,GAAMp2C,EAAC,EAAE,EAAGo2C,GAAMp2C,EAAC,EAAE,CAAC,EACnC,QAASA,GAAI,EAAGA,GAAIm2C,GAAM,OAAQn2C,KAChCi1B,EAAI,OAAOkhB,GAAMn2C,EAAC,EAAE,EAAGm2C,GAAMn2C,EAAC,EAAE,CAAC,EACnC,OAAAi1B,EAAI,YACJA,EAAI,UAAYghB,GAChBhhB,EAAI,OACAihB,KACFjhB,EAAI,YAAcihB,GAClBjhB,EAAI,UAAY,EAChBA,EAAI,UAENA,EAAI,UACG,EACT,MAAY,CACV,MAAO,EACT,CACF,EAGA,GAAIgiB,GAAO,CAET,MAAMpB,GAAWiC,GACb,uBACAC,GACE,uBACA,wBACAjC,GAAagC,GACf,uBACAC,GACE,uBACA,wBACAhC,GAAa+B,GACf,uBACAC,GACE,uBACA,wBAGNE,GACEhB,GACAnoB,GAAW,UACXA,GAAW,UACX+mB,GACA,0BAEFmC,KAGA,MAAMK,GACJxZ,GAAU,aAAe9P,GAAsB,YAC3CupB,GACJzZ,GAAU,aAAe9P,GAAsB,YACjDkpB,GACEhB,GACAoB,GACAC,GACAxC,GACA,0BAEFkC,KAGA,MAAMO,GACJ1Z,GAAU,aAAe9P,GAAsB,YAC3CypB,GACJ3Z,GAAU,aAAe9P,GAAsB,YACjDkpB,GACEhB,GACAsB,GACAC,GACAzC,GACA,0BAEFiC,KAIA,GAAI,CAEF,MAAMxB,GAAW,CACf,CACE,EAAG1nB,GAAW,UACd,MAAOgpB,GAAO,UAAYC,GAAO,UAAY,UAC7C,IAAK,aAEP,CAAE,EAAGjpB,GAAW,UAAW,MAAO,UAAW,IAAK,aAClD,CACE,EAAGupB,GACH,MAAOP,GAAO,UAAYC,GAAO,UAAY,UAC7C,IAAK,eAEP,CAAE,EAAGO,GAAkB,MAAO,UAAW,IAAK,eAC9C,CACE,EAAGC,GACH,MAAOT,GAAO,UAAYC,GAAO,UAAY,UAC7C,IAAK,eAEP,CAAE,EAAGS,GAAkB,MAAO,UAAW,IAAK,cAAc,EAE9D,UAAW/B,MAASD,GAAU,CAC5B,MAAMiC,GAAiBhD,GAAgBgB,GAAM,CAAC,EAC9C,IAAIC,GACJ,GAAI7X,GAAY4Z,GAAgB,CAE9B/B,GAAO,GACP,QAAS12C,GAAI,EAAGA,GAAI,IAAeA,KAAK,CACtC,MAAM2xB,GAAS3xB,GAAI,IAAiB,KAAK,GAAK,EAC9C02C,GAAK,KAAK,CACR,EAAGpB,GAAkBmD,GAAiB,KAAK,IAAI9mB,EAAK,EACpD,EAAG4jB,GAAkBkD,GAAiB,KAAK,IAAI9mB,EAAK,EACrD,CACH,CACF,MACE+kB,GAAO9kB,GAAWqlB,GAAcR,GAAM,EAAG,GAAa,EAGxDzhB,GAAaC,EAAKyhB,GAAM,mBAAoB,CAAC,EAC7C1hB,GAAaC,EAAKyhB,GAAMD,GAAM,MAAO,GAAG,CAC1C,CACF,MAAc,CAEd,CACF,CACA,QAAQ,IAAI,qBAAsBuB,GAAY,sBAAsB,EAEpE,GAAI,CACF,MAAMd,GAAO/L,EAAW,SAAS,WAAW,IAAI,EAEhD,GADe,CAAC,CAAC+L,IAAQ/L,EAAW,QACxB,CAEV,MAAMtO,GAAO3N,GAAgB+nB,IAASlC,EAAK,CAAE,EAAG,EAAG,EAAG,EAAG,EACnD2D,IACH5pB,GAAW,YAAcA,GAAW,aAAe,EAAI,GACpDqoB,GAASnoB,GACfkoB,GAAM,OACNA,GAAM,KAAO,kBACbA,GAAM,UAAY,UAClBA,GAAM,YAAc,UACpBA,GAAM,UAAY,EAClB,MAAMG,GAAW,OAAOtlB,GAAU,SAAWA,EAAQ,EACrD,QAAS/xB,GAAI,EAAGA,GAAIm3C,GAAO,OAAQn3C,KAAK,CACtC,MAAMs3C,GACHt3C,GAAIm3C,GAAO,OAAU,KAAK,GAAK,EAAI,KAAK,GAAK,EAAIE,GAC9Cj6C,GAAI8xB,GAAgB+nB,IAASlC,EAAK,CACtC,GAAI2D,GAAU,IAAM,KAAK,IAAIpB,EAAG,EAChC,GAAIoB,GAAU,IAAM,KAAK,IAAIpB,EAAG,EACjC,EACK9V,GAAO,OAAO2V,GAAOn3C,EAAC,CAAC,EACvBy3C,GAAKP,GAAM,YAAY1V,EAAI,EAAE,MACnC0V,GAAM,WAAW1V,GAAMpkC,GAAE,EAAIq6C,GAAK,EAAGr6C,GAAE,EAAI,CAAC,EAC5C85C,GAAM,SAAS1V,GAAMpkC,GAAE,EAAIq6C,GAAK,EAAGr6C,GAAE,EAAI,CAAC,CAC5C,CACA85C,GAAM,SACR,CACF,MAAQ,CAAC,CAGT,GAAI1H,GAAY,MAAQ,KAAK,MAAQA,GAAY,MAAO,CACtD,MAAMmJ,GAASnJ,GAAY,OAAS,OAC9BrtB,GAAKw2B,GAAS,sBAAwB,sBACtCnX,GAAOmX,GAAS,mBAAqB,mBAC3C1jB,EAAI,OACJ,MAAM2jB,GAAM,GACNl4C,GAAI0F,EAAE,MAAQ,IAAMwyC,GACpBv2B,GAAIu2B,GACV3jB,EAAI,UAAY9S,GAChB8S,EAAI,YAAc,mBAClBA,EAAI,UAAY,EAChBA,EAAI,YACJA,EAAI,UAAUv0B,GAAG2hB,GAAG,IAAK,GAAI,CAAC,EAC9B4S,EAAI,OACJA,EAAI,SACJA,EAAI,UAAY,UAChBA,EAAI,KAAO,kCACXA,EAAI,aAAe,SACnBA,EAAI,SAASuM,GAAM9gC,GAAI,GAAI2hB,GAAI,EAAE,EACjC4S,EAAI,SACN,CACF,CAEA,GAAI4J,GAAYmR,GAAqB,CACnC,QAAQ,IAAI,kDAAmD,CAC7D,WAAY,KAAK,MAAMsF,EAAe,EACtC,WAAY,KAAK,MAAMC,EAAe,EACtC,YAAa,KAAK,MAAM1W,EAAS,WAAW,EAC5C,YAAa,KAAK,MAAMA,EAAS,WAAW,EAC5C,UAAW,KAAK,MAAMA,EAAS,SAAS,EACzC,EACD,MAAMga,GAAa,CAAC56C,GAAWi3B,GAAexjB,GAAI,IAAM,CACtD,GAAI,CAAC,OAAO,SAASzT,EAAC,GAAKA,IAAK,EAAG,OACnCg3B,EAAI,OACJA,EAAI,YAAcC,GAClBD,EAAI,UAAYvjB,GAChBujB,EAAI,YAAY,CAAC,EAAG,CAAC,CAAC,EACtBA,EAAI,YACJ,MAAM6jB,GAAWpJ,GACXvqB,GAAKlnB,GAAI66C,GACT1zB,GAAKnnB,GAAI66C,GACX7jB,EAAI,QACNA,EAAI,QACFqgB,GACAC,GACApwB,GACAC,GACA,EACA,EACA,KAAK,GAAK,GAET6P,EAAI,IAAIqgB,GAAiBC,GAAiBt3C,GAAG,EAAG,KAAK,GAAK,CAAC,EAChEg3B,EAAI,SACJA,EAAI,SACN,EAUA,GARA4jB,GAAWha,EAAS,YAAa,UAAW,CAAC,EAC7Cga,GAAWha,EAAS,YAAa,UAAW,CAAC,EAC7Cga,GAAWha,EAAS,YAAa,UAAW,CAAC,EAC7Cga,GAAWha,EAAS,YAAa,UAAW,CAAC,EAC7Cga,GAAWha,EAAS,UAAW,UAAW,CAAC,EAC3Cga,GAAWha,EAAS,UAAW,UAAW,CAAC,EAGvCoY,IAAS,CAAC/G,GAAmB,CAC/B,MAAM6I,GAAgB,CAACC,GAAa9jB,KAAkB,CACpD,MAAMwhB,GAAO9kB,GAAWqlB,GAAc+B,GAAK,GAAG,EAC9C,GAAKtC,GAAK,OACV,CAAAzhB,EAAI,OACJA,EAAI,YAAY,CAAC,EAAG,CAAC,CAAC,EACtBA,EAAI,YAAcC,GAClBD,EAAI,UAAY,EAChBA,EAAI,YACJA,EAAI,OAAOyhB,GAAK,CAAC,EAAE,EAAGA,GAAK,CAAC,EAAE,CAAC,EAC/B,QAAS12C,GAAI,EAAGA,GAAI02C,GAAK,OAAQ12C,KAC/Bi1B,EAAI,OAAOyhB,GAAK12C,EAAC,EAAE,EAAG02C,GAAK12C,EAAC,EAAE,CAAC,EACjCi1B,EAAI,YACJA,EAAI,SACJA,EAAI,UACN,EACA8jB,GAAcjqB,GAAW,YAAa,SAAS,EAC/CiqB,GAAcjqB,GAAW,YAAa,SAAS,CACjD,CACF,CAEI+P,IACF5J,EAAI,OACJA,EAAI,UAAY,mBAChBA,EAAI,SAAS,EAAG,EAAG,IAAK,EAAE,EAC1BA,EAAI,UAAY,OAChBA,EAAI,KAAO,6BACXA,EAAI,SACF,eAAe,KAAK,MAAM4J,EAAS,EAAE,CAAC,OAAO,KAAK,MAAMA,EAAS,EAAE,CAAC,GACpE,GACA,IAEF5J,EAAI,SACF,WAAW,KAAK,MAAM4J,EAAS,WAAW,CAAC,YAAY,KAAK,MAAMA,EAAS,WAAW,CAAC,GACvF,GACA,IAEF5J,EAAI,SACF,eAAeya,GAAa,QAAQ,CAAC,CAAC,OAAOE,EAAY,OAAOE,EAAY,GAC5E,GACA,IAEF7a,EAAI,WAMN,MAAMgkB,GAAeznB,GAAoB,OAAO,EAKhD,GAHEsjB,EAAc,QAAU,GACxBA,EAAc,OAASmE,GAAa,QACpClE,EACc,CACd9f,EAAI,OACJA,EAAI,YAAc,sBAClBA,EAAI,UAAY,EAChBA,EAAI,YAAY,CAAC,EAAG,CAAC,CAAC,EAEtB,QAASj1B,GAAI80C,EAAc,OAAQ90C,GAAIi5C,GAAa,OAAQj5C,KAC1D,GAAI,CAEF,MAAM5C,GAAI8xB,GAAgB+nB,IAASlC,EAAIkE,GAAaj5C,EAAC,CAAC,EACtDi1B,EAAI,YACJA,EAAI,IAAI73B,GAAE,EAAGA,GAAE,EAAG,GAAI,EAAG,KAAK,GAAK,CAAC,EACpC63B,EAAI,SACJA,EAAI,OACJA,EAAI,UAAY,yBAChBA,EAAI,KAAO,kBACXA,EAAI,SACF4V,GAAyB7qC,EAAC,GAAK,OAAOA,GAAI,CAAC,EAC3C5C,GAAE,EAAI,GACNA,GAAE,EAAI,IAER63B,EAAI,SACN,MAAQ,CAAC,CAEXA,EAAI,SACN,CAgCA,GA7BI6f,EAAc,OAAShK,KACzB7V,EAAI,OACJA,EAAI,UAAY,kBAChBA,EAAI,SAAS,GAAI,GAAI,IAAK,EAAE,EAC5BA,EAAI,UAAY,UAChBA,EAAI,KAAO,uBACXA,EAAI,SACF,YAAY4V,GAAyBiK,EAAc,MAAM,CAAC,GAC1D,GACA,IAEF7f,EAAI,WAIN6f,EAAc,QAAQ,CAAC13C,GAAG4C,KAAM,CAC9Bm1B,GAAUF,EAAK73B,GAAG,SAAS,EAC3B63B,EAAI,OACJA,EAAI,UAAY,UAChBA,EAAI,KAAO,kBACXA,EAAI,SACF4V,GAAyB7qC,EAAC,GAAK,OAAOA,GAAI,CAAC,EAC3C5C,GAAE,EAAI,EACNA,GAAE,EAAI,GAER63B,EAAI,SACN,CAAC,EAGGmY,IAAoB,CAACN,GAAQ,CAC/B7X,EAAI,OAEJA,EAAI,UAAY,wBAChB,MAAM2jB,GAAM,KAAK,MAAM,KAAK,IAAIxyC,EAAE,MAAOA,EAAE,MAAM,EAAI,GAAI,EACnDsL,GAAItL,EAAE,MAAQwyC,GAAM,EACpBh7C,GAAIwI,EAAE,OAASwyC,GAAM,EAC3B3jB,EAAI,SAAS2jB,GAAKA,GAAKlnC,GAAG9T,EAAC,EAE3Bq3B,EAAI,YAAc,sBAClBA,EAAI,UAAY,EAEhBA,EAAI,YACJA,EAAI,OAAO2jB,GAAKxyC,EAAE,OAAS,CAAC,EAC5B6uB,EAAI,OAAO7uB,EAAE,MAAQwyC,GAAKxyC,EAAE,OAAS,CAAC,EACtC6uB,EAAI,SAEJA,EAAI,YACJA,EAAI,OAAO7uB,EAAE,MAAQ,EAAGwyC,EAAG,EAC3B3jB,EAAI,OAAO7uB,EAAE,MAAQ,EAAGA,EAAE,OAASwyC,EAAG,EACtC3jB,EAAI,SAEJA,EAAI,YAAc,sBAClBA,EAAI,YAAY,CAAC,EAAG,CAAC,CAAC,EACtB,MAAMikB,GAAKN,GAAM,GACfO,GAAKP,GAAM,GACb3jB,EAAI,YACJA,EAAI,OAAOikB,GAAIC,GAAK,EAAE,EACtBlkB,EAAI,OAAOikB,GAAK,GAAIC,EAAE,EACtBlkB,EAAI,SACJA,EAAI,YACJA,EAAI,OAAO7uB,EAAE,MAAQ8yC,GAAIC,GAAK,EAAE,EAChClkB,EAAI,OAAO7uB,EAAE,MAAQ8yC,GAAK,GAAIC,EAAE,EAChClkB,EAAI,SACJA,EAAI,UAEJA,EAAI,OACJA,EAAI,MAAM,EAAIqX,EAAM,EAAIA,CAAI,EAC5BrX,EAAI,UAAY,yBAChBA,EAAI,KAAO,kBACXA,EAAI,SACF,6FACA2jB,GAAMtM,GACLsM,GAAM,IAAMtM,CAAA,EAEfrX,EAAI,SACN,CACF,CAEA,MAAMmkB,GAA6B7wC,GAAiC,CAClE,GAAI,CAACA,EAAQ,OACbwlC,GAAmB,EAAK,EACxBL,EAAY,IAAI,EAChByC,GAAqB,EAAK,EACtB5nC,EAAO,SAAS,KAAOA,EAAO,QAAQ,IAAI,OAAS,IACrDujC,EAAavjC,EAAO,QAAQ,GAAG,EAC/BssC,GAAYtsC,EAAO,QAAQ,IAAKA,EAAO,CAAC,GAI1C,IAAI8wC,EAAO9wC,EAAO,EACdmnC,KAAiB,IAAG2J,EAAO/pB,GAAgB+pB,EAAM3J,GAAc,CAAC,IAChEE,KAAiB,GAAKE,KAAiB,KACzCuJ,EAAOvpB,GAAoBupB,EAAMzJ,GAAcE,EAAY,GAC7DlD,EAAe,CACb,EAAGyM,EACH,UAAW,KAAK,MAChB,QAAS9wC,EAAO,QAChB,UAAWA,EAAO,UAClB,YAAaA,EAAO,YACpB,QAASA,EAAO,QAChB,OAAQA,EAAO,OAChB,EACD2jC,EAAS3jC,EAAO,OAAS,UAAU,EACnCslC,GAActlC,EAAO,YAAc,GAAG,EACtC0lC,GAAoB,0BAA0B,EAC9C,OAAQ,WAAmB,yBAC7B,EAgRA,SAAS3E,GAAS/uB,EAAc,CAC9B,GAAI,CACF,MAAMlB,EAAI,OAAOkB,GAAQ,SAAWA,EAAMgvB,GAC1C,QAAQ,MAAM,uCAAwC,CACpD,EAAAlwB,EACA,WAAY+qB,GAAS,WAAW,WACjC,EAED,MAAMkV,EAAYzuB,GAAuB,SACpCA,GAAuB,WACvB,OACC0uB,EACJ,CAAC,CAACD,GAAU,GACZ,CAAC,CAACA,GAAU,YACXA,EAAS,QACP,OAAOA,EAAS,SAAY,UAC3BA,EAAS,SAAWpM,IAC1B,GAAI7zB,GAAK,MAAQ+qB,GAAS,WAAW,YAAcmV,EAAa,CAE9D,MAAMC,EAAM,GAAGngC,CAAC,KACVuI,GAAM,YAAY,MACxB,GACE,CAACstB,GAAsB,SACvB,EACEsK,IAAQrK,GAAe,SACvBvtB,GAAMwtB,GAAiB,QAAUC,IAEnC,CACAF,GAAe,QAAUqK,EACzBpK,GAAiB,QAAUxtB,GAC3BstB,GAAsB,QAAU,GAChC,QAAQ,MAAM,iDAAkD71B,EAAG,CACjE,SAAAigC,EACA,YAAAC,CAAA,CACD,EACD,GAAI,CACFnV,GAAS,WAAW,SAAS/qB,EAAG,EAAG,CAAE,WAAYA,EAAG,CACtD,MAAY,CAAC,CACb,GAAI,CACF,OAAO,WACL,IAAM,CACJ61B,GAAsB,QAAU,EAClC,EACA,KAAK,IAAI,IAAKG,EAAuB,EAEzC,MAAY,CAAC,CACf,MACE,QAAQ,MACN,uDACA,CACE,EAAAh2B,EACA,YAAAkgC,EACA,IAAAC,CAAA,CACF,CAGN,MACE,QAAQ,MACN,yEACA,CACE,EAAAngC,EACA,WAAY+qB,GAAS,WAAW,WAChC,YAAAmV,EACA,SAAAD,CAAA,CACF,CAGN,MAAY,CAAC,CACf,CA+dA,eAAe1E,IAAkB,CAC/B,GAAI,CAEF,GADA,QAAQ,MAAM,6CAA6C,EACvD,CAAC1J,EAAU,QAAS,CACtB,MAAM,wCAAwC,EAC9C6C,GAAmB,EAAK,EACxB,MACF,CACA,MAAM0L,EAAwB,WAC3B,0BACH,GAAIA,EAAsB,CACxB,QAAQ,MACN,8DAEFL,GAA0BK,CAAoB,EAC9C,MACF,CACA1L,GAAmB,EAAI,EACvBE,GAAoB,uCAAuC,EAC3DI,GAAgB,IAAI,EAIpB,MAAMqL,EAAU7b,GACdqN,EAAU,QACV2D,GACI,CAAE,WAAYA,GAAU,YAAa,IACrC,CAAE,YAAa,GAAK,EAc1B,GAXA,QAAQ,IACN,4CACA,CACE,QAAS6K,EAAQ,QACjB,WAAYA,EAAQ,WACpB,cAAe,CAAC,CAACA,EAAQ,WACzB,UAAWA,EAAQ,kBAAkB,QAEvCA,EAAQ,SAGN,CAACA,EAAQ,SAAW,CAACA,EAAQ,YAAcA,EAAQ,WAAa,GAAI,CACtE,QAAQ,KAAK,kDAAmD,CAC9D,QAASA,EAAQ,QACjB,WAAYA,EAAQ,WACpB,cAAe,CAAC,CAACA,EAAQ,WAC1B,EACDzL,GACEyL,EAAQ,SACN,+DAEJ3L,GAAmB,EAAK,EACxB,MACF,CAGAL,EAAY,CACV,GAAIgM,EAAQ,GACZ,GAAIA,EAAQ,GACZ,UAAWA,EAAQ,UACnB,UAAWA,EAAQ,UACnB,YAAaA,EAAQ,YACrB,YAAaA,EAAQ,YACrB,YAAaA,EAAQ,YACrB,YAAaA,EAAQ,YACtB,EAEDvJ,GAAqB,EAAI,EACzBrE,EAAa4N,EAAQ,iBAAiB,EACtC7E,GAAY6E,EAAQ,kBAAmBA,EAAQ,UAAU,EAGzD,MAAM3M,EAAc5B,GAAY,QAC5B,CAAE,EAAGA,EAAW,QAAQ,MAAO,EAAGA,EAAW,QAAQ,QACrDF,GAAU,QACR,CACE,EAAGA,EAAS,QAAQ,YACpB,EAAGA,EAAS,QAAQ,cAEtB,CAAE,EAAGC,EAAU,QAAQ,MAAO,EAAGA,EAAU,QAAQ,QACnDyO,EAAkB1O,EAAS,QAC7B,CAAE,EAAGA,EAAS,QAAQ,WAAY,EAAGA,EAAS,QAAQ,aACtD,CAAE,EAAGC,EAAU,QAAQ,MAAO,EAAGA,EAAU,QAAQ,QAGjD0O,EAAa5nB,GACjB0nB,EAAQ,WACR,SAGF9M,EAAe,CACb,EAAG8M,EAAQ,WACX,UAAW,KAAK,MAChB,QAASA,EAAQ,SAAW,KAC5B,UAAWC,EACX,YAAA5M,EACA,QAAS,CACP,IAAKvb,GAAoB,OAAO,EAAE,MAAM,EAAG,CAAC,EAC5C,IAAKkoB,EAAQ,mBAEf,MAAO,OAAOA,EAAQ,OAAU,SAAWA,EAAQ,MAAQ,KAC3D,aAAcE,CAAA,CACf,EAGD,MAAMtK,GAAsBuK,GAC1BH,EAAQ,WACRA,EAAQ,mBAEVnK,GAAuBD,EAAmB,EAE1CpD,EAAS,QAAQ,EACjB2B,GAAcK,GAAkB,IAAM,KAAK,MAAMwL,EAAQ,UAAU,CAAC,EACpEzL,GACE,wEAEFF,GAAmB,EAAK,EAGxB,GAAI,CAEF,IAAI+L,GAAc,EAClB,QAAS95C,GAAI,EAAGA,GAAI,EAAMA,KAAK,CAC7B,MAAM0kB,GAAM,SAAS,cAAc,QAAQ,EAC3CA,GAAI,MAAQ,KAAK,IAAI,EAAG,KAAK,MAAMwmB,EAAU,QAAS,MAAQ,EAAG,CAAC,EAClExmB,GAAI,OAAS,KAAK,IAAI,EAAG,KAAK,MAAMwmB,EAAU,QAAS,OAAS,EAAG,CAAC,EACvDxmB,GAAI,WAAW,IAAI,EAC3B,UAAUwmB,EAAU,QAAU,EAAG,EAAGxmB,GAAI,MAAOA,GAAI,MAAM,EAC9D,MAAMq1B,GAAclL,GAChB,CACE,WAAY,CAAE,EAAGA,GAAS,EAAI,GAAK,EAAGA,GAAS,EAAI,IACnD,YAAa,IAEf,CAAE,YAAa,IACbmL,GAAKnc,GAAYnZ,GAAiCq1B,EAAW,EAC/DE,GAAmBP,EAAgBM,EAAS,GAAGF,IACrD,CACeA,IAAe,KAAK,KAAK,EAAO,GAAI,GAGjD,QAAQ,IAAI,yCAAyC,CAEzD,OAAS79B,GAAK,CACZ,QAAQ,KAAK,qDAAsDA,EAAG,CACxE,CACF,OAASA,EAAK,CACZ,QAAQ,MAAM,8CAA+CA,CAAG,EAChEgyB,GACE,yBAAyBhyB,aAAe,MAAQA,EAAI,QAAU,OAAOA,CAAG,CAAC,IAE3E8xB,GAAmB,EAAK,CAC1B,CACF,CAGA,SAAS8L,GACP1qB,EACA+qB,EACsB,CACtB,MAAMrZ,EAAgC,GAEtC,GAAI,CAAC1R,GAAK,CAAC+qB,GAAoBA,EAAiB,SAAW,EACzD,OAAOrZ,EAIT,UAAWsZ,KAAUpP,GAAsB,CACzC,GAAIoP,EAAO,KAAOD,EAAiB,OAAQ,SAE3C,MAAME,EAAWF,EAAiBC,EAAO,GAAG,EAC5C,IAAIE,GAA2B,KAE/B,GAAI,CACFA,GAAatmB,GAAa5E,EAAGirB,CAAQ,CACvC,OAASn+B,GAAK,CACZ,QAAQ,KACN,oEACAA,EAAA,CAEJ,CAEA,IAAIq+B,GAAkC,KAClCC,GAAU,KACVC,GAAU,KACVC,GAAQ,GAEZ,GAAIJ,GACF,GAAI,CAQF,GAPAC,GAAgB1lB,GACdylB,GACA,OAAOtoB,GAAU,SAAWA,EAAQ,EACpC8C,GAAgB,GAKhBylB,GAAc,OAASH,EAAO,MAC9BG,GAAc,SAAWH,EAAO,OAEhCM,GAAQ,GACRF,GAAU,MACL,CAEL,MAAMG,GACJ5rB,GACEqrB,EAAO,OAAS,SACZ,cACAA,EAAO,OAAS,aACd,YACAA,EAAO,OAAS,OACd,YACA,aACV,EACIQ,GAAe,KAAK,MAAMN,GAAW,EAAGA,GAAW,CAAC,EAC1DE,GAAU,KAAK,IAAII,GAAeD,EAAc,EAChDF,GAAU,KAAK,MACbJ,EAAS,GAAKvb,GAAU,IAAM,GAC9Bub,EAAS,GAAKvb,GAAU,IAAM,IAEhC4b,GAAQF,IAAWJ,EAAO,WAC5B,CACF,OAASl+B,GAAK,CACZ,QAAQ,KACN,sDACAA,EAAA,CAEJ,CAGF4kB,EAAQ,KAAK,CACX,MAAOsZ,EAAO,MACd,SAAU,CAAE,KAAMA,EAAO,KAAM,OAAQA,EAAO,QAC9C,SAAUG,GACV,QAAAC,GACA,QAAAC,GACA,MAAAC,GACA,KAAMA,GAAQ,OAAS,YAAYF,IAAS,QAAQ,CAAC,CAAC,KACvD,CACH,CAEA,OAAO1Z,CACT,CAGA,SAASoZ,GAAmB18C,EAAQE,EAAQk3B,EAAM,IAAM,CACtD,GAAI,CAACp3B,GAAK,CAACE,EAAG,MAAO,GACrB,MAAM6kB,EAAK,KAAK,KAAK/kB,EAAE,GAAKE,EAAE,KAAOF,EAAE,IAAM,EAAE,EACzCglB,EAAK,KAAK,KAAKhlB,EAAE,GAAKE,EAAE,KAAOF,EAAE,IAAM,EAAE,EACzCq9C,GAAK,KAAK,KAAKr9C,EAAE,YAAcE,EAAE,cAAgBF,EAAE,aAAe,EAAE,EAC1E,OAAO+kB,GAAMqS,GAAOpS,GAAMoS,GAAOimB,IAAMjmB,CACzC,CAEA,MAAMkmB,GAAYt4C,SAAsB,IAAI,EAsnB5C,GArnBAuX,YAAU,IAAM,CAKd,IAAIpI,EAAmB,KACvB,GAAI,CACFA,EAAI,IAAI,OACN,qEACA,CAAE,KAAM,SAAS,EAEnBmpC,GAAU,QAAUnpC,EACpB,QAAQ,IAAI,oDAAoD,CAClE,OAASuK,EAAK,CACZ,QAAQ,KACN,8FACAA,CAAA,EAEF4+B,GAAU,QAAU,IACtB,CACA,MAAO,IAAM,CACX,GAAI,CACFnpC,GAAG,WACL,MAAQ,CAAC,CACX,CACF,EAAG,EAAE,EAihBLoI,YAAU,IAAM,CACd+6B,GAAA,CAEF,EAAG,CAAC9I,EAAa5c,EAAGugB,GAAcE,GAAcE,EAAY,CAAC,EAG7Dh2B,YAAU,IAAM,CACd,GAAI,CAAC6zB,IAAc,CAACvf,EAAW,OAC/B,IAAIxN,EAAM,EACV,MAAMk6B,EAAO,IAAM,CACjB,GAAI,CACFnG,GAAA,CACF,MAAQ,CAAC,CACT/zB,EAAM,sBAAsBk6B,CAAI,CAClC,EACA,OAAAl6B,EAAM,sBAAsBk6B,CAAI,EACzB,IAAM,qBAAqBl6B,CAAG,CACvC,EAAG,CAAC+sB,GAAYvf,CAAS,CAAC,EAG1BtU,YAAU,IAAM,EACb,SAAY,CACX,GAAI,CACF,GAAI,CAACgzB,IAAU,CAACkE,GAAU,OAE1B,MAAM8C,EAAU5I,EAAU,QACtB,CAAE,EAAGA,EAAU,QAAQ,MAAO,EAAGA,EAAU,QAAQ,QACnD,KACE6P,EAAU,KAAK,UAAU,CAC7B,EAAA5rB,EACA,QAAS,KACT,UAAW2kB,EACX,QAASvd,IAAW,KACrB,EACD,GAAI,CACF,MAAM3a,GAAS,oBAAoBo1B,EAAQ,GAAI,CAC7C,OAAQ,OACR,QAAS,CAAE,eAAgB,oBAC3B,KAAM+J,CAAA,CACP,EACD,QAAQ,IACN,iDACA/J,EAAA,CAEJ,OAAS/0B,EAAK,CACZ,QAAQ,KAAK,+CAAgDA,CAAG,CAClE,CAEA,GAAI,CACF,MAAM++B,EAAQ,aAAa,QAAQ,WAAW,EAC1CA,IACF,MAAMp/B,GAAS,wBAAyB,CACtC,OAAQ,OACR,QAAS,CACP,eAAgB,mBAChB,cAAe,UAAUo/B,CAAK,IAEhC,KAAMD,CAAA,CACP,EACD,QAAQ,IACN,yDAGN,OAAS9+B,EAAK,CACZ,QAAQ,KAAK,kDAAmDA,CAAG,CACrE,CACF,MAAY,CAEZ,CACF,IAEF,EAAG,CAAC6wB,GAAQkE,EAAQ,CAAC,EAEKtE,GAAkB,CAACF,EAEtB,CACrB,MAAMyO,EACJvI,KACC,OAAO,OAAW,IACf,GAAG,OAAO,SAAS,OAAO,QAAQ,MAAO,EAAE,CAAC,mBAC5C,oBACN,OACExyB,OAAC,OAAI,UAAU,2FACb,UAAAA,OAAC,OAAI,UAAU,iGACb,UAAAA,OAAC,OAAI,UAAU,YACb,gBAAC,KAAE,UAAU,gEAAgE,uBAE7E,QACC,MAAG,UAAU,kDAAkD,+CAEhE,QACC,KAAE,UAAU,4BAA4B,0HAGzC,GACF,EACAA,OAAC,OAAI,UAAU,YACb,UAAAC,MAAC,KACC,KAAM86B,EACN,UAAU,gDACX,gCAGD96B,MAAC,UACC,KAAK,SACL,UAAU,yDACV,QAAS,IAAMgzB,GAAU8H,EAAe,MAAM,EAE7C,SAAA5I,KAAiB,OAAS,eAAiB,aAC9C,EACF,EACAnyB,OAAC,KAAE,UAAU,4BAA4B,8FAE7B,QAAK,UAAU,gBAAgB,6BAAiB,EAAQ,IAAI,uDAExE,GACF,EACAC,MAAC,UACC,KAAK,SACL,UAAU,wIACV,QAAS,IAAMssB,EAAyB,EAAI,EAC7C,2CAED,EACF,CAEJ,CAEA,OACEvsB,OAAC,OAAI,UAAU,YACZ,UAAAwsB,GAAkBF,SAChB,OAAI,UAAU,uFACb,SAAAtsB,OAAC,OAAI,UAAU,qEACb,gBAAC,KAAE,UAAU,kBAAkB,6GAG/B,EACAC,MAAC,UACC,KAAK,SACL,UAAU,mCACV,QAAS,IAAMssB,EAAyB,EAAK,EAC9C,oCAED,EACF,EACF,EAEFvsB,OAAC,OAAI,UAAU,qBACb,UAAAA,OAAC,UAAO,UAAU,mDAChB,UAAAA,OAAC,OAAI,UAAU,YACb,gBAAC,KAAE,UAAU,gEAAgE,4BAE7E,QACC,MAAG,UAAU,kDAAkD,6BAEhE,QACC,KAAE,UAAU,+BAA+B,0FAG5C,GACF,EACAA,OAAC,OAAI,UAAU,oDACb,UAAAA,OAAC,QAAK,UAAU,qGACd,gBAAC,QAAK,UAAU,aAAa,gBAAI,EACjCC,MAAC,QACE,SAAAmO,IAAS,QACN,iBACAA,IAAS,QACP,eACA,cACR,GACF,EACApO,OAAC,QACC,UAAW,gEAAgEkO,EAAY,2DAA6D,2CAA2C,GAE/L,UAAAjO,MAAC,QACC,UAAW,wBAAwBiO,EAAY,iBAAmB,cAAc,KAEjFA,EAAY,qBAAuB,iBAErC0e,GACC5sB,OAAC,OAAI,UAAU,mFACb,UAAAA,OAAC,OAAI,UAAU,0CACb,UAAAA,OAAC,OAAI,UAAU,0BACb,UAAAC,MAAC,OAAI,UAAU,4EACb,SAAAA,MAAC,QAAK,UAAU,UAAU,aAAC,EAC7B,SACC,OACC,gBAAC,MAAG,UAAU,iCAAiC,6BAE/C,QACC,KAAE,UAAU,qBAAqB,kIAIlC,GACF,GACF,EACAA,MAAC,UACC,UAAU,qDACV,QAAS,IAAMysB,EAAe,CAAE,OAAQ,GAAO,EAC/C,MAAM,oBACP,mBAED,EACF,EACCrW,IAAW,MACVrW,OAAC,OAAI,UAAU,qBAAqB,wBACtBqW,GAAQ,QAAQ,CAAC,EAAE,iBACjC,GAEJ,EACE,MACN,GACF,EAEArW,OAAC,OAAI,UAAU,4DACb,UAAAC,MAAC,WAAQ,UAAU,YACjB,SAAAD,OAAC,OAAI,UAAU,+DACb,UAAAA,OAAC,OAAI,UAAU,4DACb,UAAAA,OAAC,OAAI,UAAU,oCACb,gBAAC,QAAK,UAAU,qCAAqC,wBAErD,EACAA,OAAC,OAAI,UAAU,0BACb,UAAAC,MAAC,UACC,UAAW,iBAAiBmO,IAAS,QAAU,sCAAwC,iCAAiC,GACxH,cAAY,aACZ,QAAS,IAAM,CACbsd,EAAQ,OAAO,EAEb,OAAO,eAAmB,KAC1B,gBAEA,QAAQ,MACN,qCACA,KAAK,KAAI,EAEb2H,GAAW,EAAK,CAClB,EACA,MAAM,mBACP,mBAGDpzB,MAAC,UACC,UAAW,iBAAiBmO,IAAS,QAAU,sCAAwC,iCAAiC,GACxH,cAAY,aACZ,QAAS,IAAM,CACbsd,EAAQ,OAAO,EAEb,OAAO,eAAmB,KAC1B,gBAEA,QAAQ,MACN,qCACA,KAAK,KAAI,EAEb2H,GAAW,EAAK,CAClB,EACA,MAAM,+BACP,mBAGDpzB,MAAC,UACC,UAAW,iBAAiBmO,IAAS,OAAS,sCAAwC,iCAAiC,GACvH,cAAY,YACZ,QAAS,IAAM,CACbsd,EAAQ,MAAM,EAEZ,OAAO,eAAmB,KAC1B,gBAEA,QAAQ,MACN,oCACA,KAAK,KAAI,EAEb2H,GAAW,EAAK,EAChB,GAAI,CACFc,GAAA,CACF,OAAS12C,EAAG,CACV,QAAQ,MACN,iDACAA,CAAA,CAEJ,CACF,EACA,MAAM,wCACP,iBAED,EACF,GACF,EACAuiB,OAAC,OAAI,UAAU,oCACb,UAAAA,OAAC,OAAI,UAAU,0BACb,gBAAC,QAAK,UAAU,aAAa,gBAAI,EACjCC,MAAC,SACC,KAAK,QACL,IAAK,GACL,IAAK,IACL,KAAM,EACN,MAAO,KAAK,MAAOmsB,EAAa,GAAG,EACnC,SAAW3uC,GACT4uC,EACE,KAAK,IACH,GACA,KAAK,IAAI,EAAG,OAAO5uC,EAAE,OAAO,KAAK,EAAI,GAAG,EAC1C,CACF,GAGJuiB,OAAC,QAAK,UAAU,kBACb,eAAK,MAAOosB,EAAa,GAAG,EAAE,KACjC,GACF,EACAnsB,MAAC,UAAO,UAAU,gBAAgB,QAAS,IAAMosB,EAAQ,CAAC,EAAG,kBAE7D,GACF,GACF,EAEArsB,OAAC,OAAI,UAAU,gBACb,UAAAA,OAAC,UACC,UAAU,6GACV,QAAS,IAAM8uB,GAAoB,CAACD,EAAgB,EACpD,cAAY,0BAEZ,gBAAC,QAAK,UAAU,gBAAgB,qBAAS,EACxCzB,UACE,QAAK,UAAU,0BAA0B,+BAE1C,KAGHyB,IACC7uB,OAAC,OACC,UAAU,iFACV,cAAY,oBACZ,KAAK,SAEL,gBAAC,OAAI,UAAU,eAAe,yCAE9B,EACAA,OAAC,OAAI,UAAU,+BACb,UAAAC,MAAC,SACC,GAAG,iBACH,KAAK,WACL,QAASmuB,GACT,SAAW3wC,GAAM4wC,GAAmB5wC,EAAE,OAAO,OAAO,UAErD,SAAM,QAAQ,iBAAiB,UAAU,UAAU,8BAEpD,GACF,EACAwiB,MAAC,OAAI,UAAU,+BACb,SAAAA,MAAC,UACC,UAAU,wBACV,QAAS,IAAMuwB,GAAA,EAChB,sCAGH,EACAxwB,OAAC,OAAI,UAAU,+BACb,UAAAC,MAAC,SACC,GAAG,iBACH,KAAK,WACL,QAASkpB,GACT,SAAW1rC,GACT6wC,GAAsB7wC,EAAE,OAAO,OAAO,UAGzC,SAAM,QAAQ,iBAAiB,UAAU,UAAU,kCAEpD,GACF,EACAuiB,OAAC,OAAI,UAAU,+BACb,UAAAC,MAAC,SACC,GAAG,wBACH,KAAK,WACL,QAASotB,GACT,SAAW5vC,GACT6vC,GAA2B7vC,EAAE,OAAO,OAAO,EAE7C,SAAU,CAAC0rC,EAAA,GAEblpB,MAAC,SACC,QAAQ,wBACR,UAAU,UACX,sEAGD,EACF,EACAD,OAAC,OAAI,UAAU,+BACb,UAAAC,MAAC,SACC,GAAG,2BACH,KAAK,WACL,QAASsuB,GACT,SAAW9wC,GACT+wC,GAAuB/wC,EAAE,OAAO,OAAO,IAG3CwiB,MAAC,SACC,QAAQ,2BACR,UAAU,UACX,+CAED,EACF,EACAD,OAAC,OAAI,UAAU,+BACb,UAAAC,MAAC,SACC,GAAG,oBACH,KAAK,WACL,QAAS6vB,GACT,SAAWryC,GACTsyC,GAAuBtyC,EAAE,OAAO,OAAO,UAG1C,SAAM,QAAQ,oBAAoB,UAAU,UAAU,uCAEvD,GACF,EACAuiB,OAAC,OAAI,UAAU,+BACb,UAAAC,MAAC,SACC,GAAG,qBACH,KAAK,WACL,QAAS+vB,GACT,SAAWvyC,GAAMwyC,GAAqBxyC,EAAE,OAAO,OAAO,UAEvD,SAAM,QAAQ,qBAAqB,UAAU,UAAU,2DAExD,GACF,EACAuiB,OAAC,OAAI,UAAU,+BACb,UAAAC,MAAC,SACC,QAAQ,oBACR,UAAU,eACX,wBAGDA,MAAC,SACC,GAAG,oBACH,KAAK,QACL,IAAK,IACL,IAAK,IACL,KAAM,KACN,MAAOiwB,GACP,SAAWzyC,GACT0yC,GAAqB,WAAW1yC,EAAE,OAAO,KAAK,CAAC,IAGnDuiB,OAAC,QAAK,UAAU,eACZ,WAAAkwB,GAAoB,KAAK,QAAQ,CAAC,EAAE,KACxC,GACF,EACAlwB,OAAC,OAAI,UAAU,+BACb,UAAAC,MAAC,SACC,QAAQ,oBACR,UAAU,eACX,wBAGDA,MAAC,SACC,GAAG,oBACH,KAAK,QACL,IAAK,IACL,IAAK,IACL,KAAM,KACN,MAAOmwB,GACP,SAAW3yC,GACT4yC,GAAqB,WAAW5yC,EAAE,OAAO,KAAK,CAAC,IAGnDuiB,OAAC,QAAK,UAAU,eACZ,WAAAowB,GAAoB,KAAK,QAAQ,CAAC,EAAE,KACxC,GACF,EACApwB,OAAC,OAAI,UAAU,+BACb,UAAAA,OAAC,UACC,GAAG,mBACH,UAAU,QACV,MAAOswB,IAAgB,GACvB,SAAW7yC,GACT8yC,GACE9yC,EAAE,OAAO,MAASA,EAAE,OAAO,MAAgB,MAI/C,gBAAC,UAAO,MAAM,GAAG,4BAAgB,QAChC,UAAO,MAAM,SAAS,wBAAY,QAClC,UAAO,MAAM,SAAS,wBAAY,QAClC,UAAO,MAAM,OAAO,sBAAU,WAEhC,OAAI,UAAU,0BAA0B,+CAEzC,GACF,EACAuiB,OAAC,OAAI,UAAU,yCACb,UAAAC,MAAC,OAAI,UAAU,qBACZ,SAAAipB,GAAqB,sBACxB,QACC,OACC,SAAAjpB,MAAC,UACC,UAAU,iBACV,QAAS,IAAM,CACb,QAAQ,MACN,sDAEFmpB,GAAA,CACF,EACA,cAAe,IAAM,CACnB,QAAQ,MACN,4DAEFA,GAAA,CACF,EACD,oBAGH,GACF,IACF,EAEJ,EAEAppB,OAAC,OACC,UAAU,mFACV,MAAO,CACL,YAAaksB,EACT,GAAGA,EAAU,CAAC,MAAMA,EAAU,CAAC,GAC/B,UAGN,UAAAlsB,OAAC,OAAI,UAAU,8HACb,UAAAC,MAAC,QACC,UAAW,qCAAqCiO,EAAY,iBAAmB,aAAa,GAC5F,cAAY,eAEb,QAAM,SAAAA,EAAY,YAAc,eAAe,GAClD,EACAlO,OAAC,OACC,UAAU,mBACV,MAAO,CACL,UAAW,SAASosB,CAAS,IAC7B,gBAAiB,iBAGnB,UAAAnsB,MAAC,SACC,IAAK8qB,EACL,iBAAmB9H,GAAO,CACxB,GAAI,CACF,MAAM9pB,EAAI8pB,EAAG,cACT9pB,EAAE,YAAcA,EAAE,aACpBgzB,EAAa,CAAE,EAAGhzB,EAAE,WAAY,EAAGA,EAAE,YAAa,CACtD,MAAQ,CAAC,CACX,EACA,UAAW,+EAA+E0yB,EAAc,kBAAoB,kBAAkB,GAC9I,SAAQ,GACR,YAAW,GACX,MAAK,GACL,SAAU,KAEXL,GACCvrB,MAAC,OAAI,UAAU,mFACb,SAAAA,MAAC,UACC,UAAU,uEACV,QAAS,SAAY,CACnB,GAAI,CACF,MAAM8qB,EAAS,SAAS,OACxBU,EAAoB,EAAK,EACzBF,EAAa,EAAI,EACjBS,EAAS,SAAS,CACpB,OAASvuC,EAAG,CACV,QAAQ,KAAK,2BAA4BA,CAAC,EAC1C,MACE,gFAEJ,CACF,EACD,gCAGH,EAEFwiB,MAAC,UACC,IAAK+qB,EACL,UAAW,kEAAkEa,EAAc,mBAAqB,iBAAiB,IACnI,GACF,IAGF7rB,OAAC,OAAI,UAAU,yCACZ,UAAAkO,QACE,UAAO,UAAU,MAAM,QAAS,IAAMmlB,GAAW,EAAI,EAAG,sBAEzD,EAEApzB,MAAC,UAAO,UAAU,MAAM,QAASo0B,GAAa,mBAE9C,QAED,QAAK,UAAU,qBACb,SAAAnmB,EAAY,mBAAqB,uBACpC,GACF,GACF,EACF,EAEAlO,OAAC,SAAM,UAAU,YACf,UAAAC,MAAC4oB,GAAA,CACC,aAAAC,EACA,UAAA5a,EACA,oBAAA6a,GACA,WAAAC,GACA,oBAAqBiD,EACrB,kBAAA/C,EACA,mBAAAC,GACA,SAAAC,GACA,kBAAAC,GACA,gBAAiBnb,CAAA,GAGlBE,IAAS,SACRpO,OAAC,WAAQ,UAAU,uFACjB,gBAAC,OAAI,UAAU,gBAAgB,yBAAa,EAC5CA,OAAC,UACC,KAAK,SACL,UAAU,+HACV,QAAS,IAAMizB,GAAUX,GAAW,MAAM,EAC1C,MAAM,0BAEN,gBAAC,QAAK,UAAU,iDACb,SAAAA,GACH,QACC,QAAK,UAAU,yEACb,SAAAH,KAAiB,OAAS,UAAY,YACzC,KAEFlyB,MAAC,OAAI,UAAU,sCACb,SAAAA,MAAC,KACC,KAAMqyB,GACN,OAAO,SACP,IAAI,aACJ,UAAU,+EACX,kCAGH,EACAtyB,OAAC,OAAI,UAAU,aAAa,gBACtB,IACH0O,GACGA,GAAG,aAAe,EAChB,OACAA,GAAG,aAAe,EAChB,aACAA,GAAG,aAAe,EAChB,UACA,SACN,cAAe,IAAI,KACpBijB,IAAW,MAAQ,WAAa,aACrC,EACCb,IACC9wB,OAAC,UACC,KAAK,SACL,UAAU,+IACV,QAAS,IAAMizB,GAAUnC,GAAU,MAAM,EACzC,MAAM,oBAEN,gBAAC,QAAK,UAAU,qCACb,SAAAA,GACH,QACC,QAAK,UAAU,yEACb,SAAAqB,KAAiB,OAAS,UAAY,YACzC,KAGJnyB,OAAC,OAAI,UAAU,0BACZ,UAAAgzB,KAAQ,aAAS,QAAK,wBAAYA,GAAI,KAAC,EACxC/yB,MAAC,UACC,UAAU,wBACV,QAASu0B,GACV,uBAED,EACF,EACC3C,IACC7xB,OAAC,OAAI,UAAU,qFACb,gBAAC,OAAI,UAAU,gBAAgB,2BAAe,EAC9CA,OAAC,MAAG,UAAU,2BACZ,UAAAC,MAAC,MAAG,gEAEJ,SACC,MAAG,mEACqD,IACtD0xB,IAAW,MAAQA,GAAU,KAAO,KAAK,MAC5C,EACA1xB,MAAC,MAAG,2EAGJ,GACF,EACAA,MAAC,OAAI,UAAU,aACb,SAAAA,MAAC,UACC,UAAU,mCACV,QAAS,IAAM6xB,GAAY,EAAK,EACjC,uBAGH,GACF,GAEJ,GAIJ,GACF,EAEC1jB,IAAS,QAAU,CAACF,UAClB,WAAQ,UAAU,uFACjB,gBAAC,OAAI,UAAU,gBAAgB,gCAAoB,EAClD+jB,GACCjyB,OAAC,OAAI,UAAU,0BACb,UAAAC,MAAC,OAAI,UAAU,4DAA4D,EAC3EA,MAAC,QAAK,yCAA6B,GACrC,EACE8xB,GAAY,OAAS,EACvB/xB,OAAC,OAAI,UAAU,YACZ,UAAA+xB,GAAY,IAAK/R,GAChBhgB,OAAC,OAEC,UAAU,2FAEV,UAAAA,OAAC,OACC,UAAAC,MAAC,OAAI,UAAU,cAAe,SAAA+f,EAAO,KAAK,EAC1ChgB,OAAC,OAAI,UAAU,aACZ,UAAAggB,EAAO,GAAG,IAAEA,EAAO,KAAK,MAAIA,EAAO,KAAK,aAAY,EACvD,EACAhgB,OAAC,OAAI,UAAU,qBAAqB,2BACnBggB,EAAO,aAAa,KAAK,IAAI,GAC9C,GACF,EACA/f,MAAC,UACC,UAAW,yBAAyB+f,EAAO,SAAW,aAAe,gBAAkBA,EAAO,SAAW,SAAW,eAAiB,aAAa,GAClJ,QAAS,IAAMoU,GAAoBpU,CAAM,EACzC,SAAUA,EAAO,SAAW,aAE3B,SAAAA,EAAO,SAAW,aACf,cACA,WACN,GApBKA,EAAO,GAsBf,EACD/f,MAAC,OAAI,UAAU,cACb,SAAAA,MAAC,UACC,UAAU,wBACV,QAASk0B,GACV,4BAGH,GACF,EAEAn0B,OAAC,OAAI,UAAU,wBACb,UAAAC,MAAC,OAAI,0CAA8B,QAClC,OAAI,UAAU,aAAa,4EAG5B,EACAA,MAAC,UACC,UAAU,wBACV,QAASk0B,GACV,uBAED,EACF,GAEJ,GAEJ,GACF,CAEJ,CCjkKA,IAAI6G,GAAS,EAEN,MAAMC,GAAgBvwB,GAAoBtX,IAAS,CACxD,OAAQ,GACR,KAAM,CAAC8nC,EAAS3oB,IACdnf,EAAKie,GAAM,CACT,MAAM/sB,EAAK02C,KACLh9C,EAAW,CACf,GAAAsG,EACA,QAAA42C,EACA,KAAM3oB,GAAM,MAAQ,OACpB,QAASA,GAAM,SAAW,IAC1B,YAAaA,GAAM,YACnB,SAAUA,GAAM,UAGlB,OAAIv0B,EAAE,SAAWA,EAAE,QAAU,GAC3B,WAAW,IAAM,CACfoV,EAAK+G,IAAS,CAAE,OAAQA,EAAI,OAAO,OAAQ3Z,GAAMA,EAAE,KAAO8D,CAAE,GAAI,CAClE,EAAGtG,EAAE,OAAO,EAEP,CAAE,OAAQ,CAAC,GAAGqzB,EAAE,OAAQrzB,CAAC,EAClC,CAAC,EACH,OAASsG,GAAO8O,EAAK,IAAO,CAAE,OAAQ,EAAE,OAAO,OAAQpV,GAAMA,EAAE,KAAOsG,CAAE,GAAI,EAC5E,MAAO,IAAM8O,EAAI,CAAE,OAAQ,GAAI,CACjC,EAAE,EAEK,SAAS+nC,IAAW,CAEzB,OADaF,GAAe5pB,GAAMA,EAAE,IAAI,CAE1C,CCtDA,SAAwB+pB,IAAU,CAChC,MAAMC,EAASJ,GAAe,GAAM,EAAE,MAAM,EACtCK,EAASL,GAAe,GAAM,EAAE,MAAM,EAC5C,OAAKI,EAAO,OAEVr7B,OAAAja,WAAA,CAEG,UAAAs1C,EACE,OAAQr9C,GAAMA,EAAE,OAAS,SAAS,EAClC,IAAKA,GACJiiB,MAAC,OAEC,UAAU,gEAEV,SAAAA,MAAC,OACC,UAAW,kHAEX,SAAAA,MAAC,OAAI,UAAU,yCACb,SAAAA,MAAC,QAAK,UAAU,uBAAwB,SAAAjiB,EAAE,QAAQ,EACpD,GACF,EATKA,EAAE,GAWV,EAEFq9C,EAAO,OAAQr9C,GAAMA,EAAE,OAAS,SAAS,EAAE,OAAS,GACnDiiB,MAAC,OAAI,UAAU,oJACZ,SAAAo7B,EACE,OAAQr9C,GAAMA,EAAE,OAAS,SAAS,EAClC,IAAKA,GACJiiB,MAAC,OAEC,UAAW,2CACTjiB,EAAE,OAAS,QACP,+CACA,6CACN,GAEA,SAAAgiB,OAAC,OAAI,UAAU,0BACb,UAAAC,MAAC,QAAK,UAAU,SAAU,SAAAjiB,EAAE,QAAQ,EACnCA,EAAE,aACH,OAAQA,EAAU,UAAa,WAC7BiiB,MAAC,UACC,UAAU,8DACV,QAAS,IAAM,CACb,GAAI,CACDjiB,EAAU,YACb,MAAQ,CAAC,CACTs9C,EAAOt9C,EAAE,EAAE,CACb,EAEC,SAAAA,EAAE,cAEH,KACJiiB,MAAC,UACC,UAAU,mCACV,QAAS,IAAMq7B,EAAOt9C,EAAE,EAAE,EAC3B,oBAED,EACF,GA7BKA,EAAE,GA+BV,EACL,GAEJ,EA7DyB,IA+D7B,CChEA,SAAwBu9C,GAAS,CAC/B,KAAAj7C,EACA,OAAAyhB,EAAS,IACT,SAAAy5B,EAAW,GACX,IAAAC,EAAM,EACN,WAAAC,EAAa,EACf,EAMG,CACD,MAAMrd,EAAM,KAAK,IAAI,EAAG,GAAG/9B,EAAK,IAAK,GAAM,EAAE,KAAK,CAAC,EAC7Cq7C,EAAar7C,EAAK,QAAUk7C,EAAWC,GAC7C,OACEx7B,MAAC,OAAI,UAAU,yBACb,SAAAA,MAAC,OACC,UAAU,WACV,MAAO,CAAE,OAAA8B,EAAQ,MAAO,KAAK,IAAI,IAAK45B,CAAU,GAEhD,SAAA17B,MAAC,OAAI,UAAU,kCACZ,WAAK,IAAI,CAAC,EAAGngB,IAAM,CAClB,MAAMpC,EAAI,KAAK,MAAO,EAAE,MAAQ2gC,GAAQtc,EAAS,GAAG,EACpD,OACE/B,OAAC,OAEC,UAAU,yCACV,MAAO,CAAE,MAAOw7B,EAAU,YAAaC,CAAA,EAEvC,UAAAx7B,MAAC,OACC,UAAU,gFACV,MAAO,CAAE,OAAQviB,CAAA,EACjB,MAAO,GAAG,EAAE,KAAK,KAAK,EAAE,KAAK,KAE9Bg+C,GACCz7B,MAAC,OAAI,UAAU,6CACZ,WAAE,MACL,EAEFA,MAAC,OAAI,UAAU,sDACZ,WAAE,MACL,IAhBKngB,CAAA,CAmBX,CAAC,EACH,IAEJ,CAEJ,CClDA,SAAwB87C,GAAS,CAC/B,KAAAp+B,EACA,OAAAI,EACA,SAAAC,EACA,UAAAva,CACF,EAKG,CACD,cACG,OAAI,UAAW,YAAYA,GAAa,EAAE,GAEzC,UAAA2c,MAAC,OAAI,UAAU,qGAAqG,EACpHA,MAAC,OAAI,UAAU,kDACb,SAAAA,MAAC,OAAI,UAAU,oCACZ,SAAAzC,EAAK,IAAKxf,GAAM,CACf,MAAMsE,EAAWtE,EAAE,MAAQ4f,EAC3B,OACEqC,MAAC,UAEC,KAAK,SACL,cAAgBxiB,GAAM,CACnBA,EAAU,iBACb,EACA,YAAcA,GAAM,CAClBA,EAAE,iBACJ,EACA,aAAeA,GAAM,CAClBA,EAAU,mBACb,EACA,QAAS,IAAMogB,EAAS7f,EAAE,GAAG,EAC7B,UAAW;AAAA,oBAEPsE,EACI,kFACA,8CACN;AAAA,kBAEF,eAAcA,EAEb,SAAAtE,EAAE,MAAM,SAAS,IAAI,EAAIA,EAAE,MAAQ,GAAGA,EAAE,KAAK,OArBzCA,EAAE,IAwBb,CAAC,EACH,EACF,QACC,SAAO;AAAA;AAAA;AAAA;AAAA,QAIN,GACJ,CAEJ,CC9BA,MAAM69C,GAAU1wB,GAAiB,aAAaA,CAAI,GAC5C2wB,GAAgB3wB,GAAiB,gBAAgBA,CAAI,GACrD4wB,GAAe5wB,GAAiB,mBAAmBA,CAAI,GACvD6wB,GAAc7wB,GAAiB,kBAAkBA,CAAI,GAWrD8wB,OAAiB,IACjBC,OAAmB,IAEzB,SAASC,IAA8B,CACrC,GAAI,CACF,OAAO,aAAa,QAAQ,WAAW,CACzC,MAAQ,CACN,OAAO,IACT,CACF,CAEA,SAASC,GAAajxB,EAAyB,CAC7C,GAAI,CACF,MAAMzS,EAAM,aAAa,QAAQsjC,GAAW7wB,CAAI,CAAC,EACjD,GAAI,CAACzS,EAAK,MAAO,CAAE,UAAW,GAC9B,MAAMyqB,EAAS,KAAK,MAAMzqB,GAAO,IAAI,EACrC,MAAO,CAAE,UAAW,OAAOyqB,EAAO,SAAS,GAAK,EAClD,MAAQ,CACN,MAAO,CAAE,UAAW,EACtB,CACF,CAEA,SAASkZ,GAAalxB,EAAc4W,EAAiB,CACnD,GAAI,CACF,aAAa,QAAQia,GAAW7wB,CAAI,EAAG,KAAK,UAAU4W,CAAI,CAAC,CAC7D,MAAQ,CAAC,CACX,CAEA,SAASua,GAAkBnxB,EAAgC,CACzD,MAAO,CACL,UAAWixB,GAAajxB,CAAI,EAAE,WAAa,KAAK,MAChD,QAASoxB,GAAWpxB,CAAI,EACxB,OAAQqxB,GAAcrxB,CAAI,EAC1B,MAAOsxB,GAAiBtxB,CAAI,EAC5B,UAAWuxB,GAAA,CAAiB,CAEhC,CAEA,eAAeC,GAAkBxxB,EAAc,CAC7C,MAAM2vB,EAAQqB,GAAA,EACd,GAAI,GAACrB,GAAS,CAAC3vB,IACX,CAAA+wB,GAAa,IAAI/wB,CAAI,EACzB,CAAA+wB,GAAa,IAAI/wB,CAAI,EACrB,GAAI,CACF,MAAM0oB,EAAUyI,GAAkBnxB,CAAI,EAChCvP,EAAMJ,GAAc,iBAAiB,EAC3C,MAAM,MAAMI,EAAK,CACf,OAAQ,OACR,QAAS,CACP,eAAgB,mBAChB,cAAe,UAAUk/B,CAAK,IAEhC,KAAM,KAAK,UAAU,CAAE,MAAOjH,EAAS,EACxC,CACH,MAAQ,CAAC,CACTqI,GAAa,OAAO/wB,CAAI,EAC1B,CAEA,SAASyxB,GAAkBzxB,EAAc,CACvC,GAAI,CAACA,EAAM,OACX,MAAM0xB,EAAWZ,GAAW,IAAI9wB,CAAI,EAChC0xB,GAAU,OAAO,aAAaA,CAAQ,EAC1C,MAAMv4C,EAAK,OAAO,WAAW,IAAM,CACjC23C,GAAW,OAAO9wB,CAAI,EACtBwxB,GAAkBxxB,CAAI,CACxB,EAAG,IAAI,EACP8wB,GAAW,IAAI9wB,EAAM7mB,CAAE,CACzB,CAEA,eAAsBw4C,GAAoB3xB,EAAc,CACtD,MAAM2vB,EAAQqB,GAAA,EACd,GAAI,CAACrB,GAAS,CAAC3vB,EAAM,OAIrB,MAAM4xB,EAAc,EACpB,IAAI/gC,EAAuB,KAC3B,QAASmsB,EAAU,EAAGA,EAAU4U,EAAa5U,IAAW,CACtD,GAAI,CACF,MAAMvsB,EAAMJ,GAAc,iBAAiB,EAI3C,GAHAQ,EAAM,MAAM,MAAMJ,EAAK,CACrB,QAAS,CAAE,cAAe,UAAUk/B,CAAK,GAAG,CAC7C,EACG9+B,GAAK,GAAI,MACbA,EAAM,IACR,MAAQ,CACNA,EAAM,IACR,CAEImsB,EAAU4U,EAAc,GAC1B,MAAM,IAAI,QAASh/C,GAAM,WAAWA,EAAG,IAAO,KAAK,IAAI,EAAGoqC,CAAO,CAAC,CAAC,CAEvE,CAEA,GAAI,GAACnsB,GAAO,CAACA,EAAI,IACjB,GAAI,CAEF,MAAMghC,GADO,MAAMhhC,EAAI,OAAO,MAAM,KAAO,GAAG,IACzB,MAKrB,GAAI,CAACghC,GAAU,CAACA,EAAO,UAAW,CAChC,MAAMC,EAAQV,GAAWpxB,CAAI,EACzB8xB,IAAUA,EAAM,MAAQ,GAAKA,EAAM,OAAS,KAC9CZ,GAAalxB,EAAM,CAAE,UAAW,KAAK,MAAO,EAC5CwxB,GAAkBxxB,CAAI,GAExB,MACF,CAEA,MAAM+xB,EAAYd,GAAajxB,CAAI,EAC/B6xB,EAAO,WAAaE,EAAU,WAAa,IAC7CC,GAAWhyB,EAAM6xB,EAAO,SAAW,CAAE,MAAO,EAAG,OAAQ,GAAK,CAC1D,SAAU,GACX,EACDI,GAAUjyB,EAAM6xB,EAAO,QAAU,GAAI,CAAE,SAAU,GAAM,EACnDA,EAAO,OACTK,GAAiBlyB,EAAM6xB,EAAO,MAAO,CAAE,SAAU,GAAM,EACrDA,EAAO,WACTM,GAAiBN,EAAO,UAAW,CAAE,SAAU,GAAM,EACvDX,GAAalxB,EAAM,CAAE,UAAW6xB,EAAO,UAAW,GACzCE,EAAU,UAAYF,EAAO,WACtCJ,GAAkBzxB,CAAI,CAE1B,MAAQ,CAAC,CACX,CAEO,SAASoxB,GAAWpxB,EAA6B,CACtD,GAAI,CACF,MAAMzS,EAAM,aAAa,QAAQmjC,GAAO1wB,CAAI,CAAC,EAC7C,GAAI,CAACzS,EAAK,MAAO,CAAE,MAAO,EAAG,OAAQ,GACrC,MAAMyqB,EAAS,KAAK,MAAMzqB,CAAG,EAC7B,MAAO,CACL,MAAO,OAAOyqB,EAAO,KAAK,GAAK,EAC/B,OAAQ,OAAOA,EAAO,MAAM,GAAK,EACjC,QAAS,OAAOA,EAAO,OAAO,GAAK,EACnC,SAAU,OAAOA,EAAO,QAAQ,GAAK,EACrC,MAAO,OAAOA,EAAO,OAAU,SAAWA,EAAO,MAAQ,EACzD,OAAQ,OAAOA,EAAO,QAAW,SAAWA,EAAO,OAAS,EAC5D,aACE,OAAOA,EAAO,cAAiB,SAAWA,EAAO,aAAe,EAClE,aACE,OAAOA,EAAO,cAAiB,SAAWA,EAAO,aAAe,EAClE,cACE,OAAOA,EAAO,eAAkB,SAAWA,EAAO,cAAgB,EACpE,UAAW,OAAOA,EAAO,WAAc,SAAWA,EAAO,UAAY,EACrE,WAAY,OAAOA,EAAO,YAAe,SAAWA,EAAO,WAAa,EACxE,QAAS,OAAOA,EAAO,SAAY,SAAWA,EAAO,QAAU,EAEnE,MAAQ,CACN,MAAO,CAAE,MAAO,EAAG,OAAQ,EAC7B,CACF,CAEO,SAASga,GACdhyB,EACA6W,EACAzP,EACA,CACA,GAAI,CACF,aAAa,QAAQspB,GAAO1wB,CAAI,EAAG,KAAK,UAAU6W,CAAM,CAAC,EACzD,OAAO,cACL,IAAI,YAAY,oBAAqB,CAAE,OAAQ,CAAE,KAAA7W,EAAM,OAAA6W,EAAO,CAAG,GAGnE,GAAI,CACFQ,GAAiB,CAAE,KAAM,eAAgB,KAAArX,EAAM,OAAA6W,EAAQ,CACzD,MAAQ,CAAC,CACX,MAAQ,CAAC,CACJzP,GAAM,WACT8pB,GAAalxB,EAAM,CAAE,UAAW,KAAK,MAAO,EAC5CyxB,GAAkBzxB,CAAI,EAE1B,CAGO,SAASoyB,GAAcpyB,EAAc,CAC1C,GAAI,CACF,aAAa,WAAW0wB,GAAO1wB,CAAI,CAAC,EACpC,aAAa,WAAW2wB,GAAa3wB,CAAI,CAAC,EAC1C,aAAa,WAAW4wB,GAAY5wB,CAAI,CAAC,CAC3C,MAAQ,CAAC,CACT,GAAI,CACF,OAAO,cACL,IAAI,YAAY,oBAAqB,CAAE,OAAQ,CAAE,KAAAA,EAAM,QAAS,GAAK,CAAG,EAE5E,MAAQ,CAAC,CACX,CAEO,SAASqyB,GAAcryB,EAAsB,CAClD,KAAM,CAAE,MAAA0W,EAAO,OAAA4b,GAAWlB,GAAWpxB,CAAI,EACzC,OAAK0W,EACG4b,EAAS5b,EAAS,EADP,CAErB,CAEO,SAAS6b,GAAuBvyB,EAAsB,CAC3D,KAAM,CAAE,QAAAwyB,EAAU,EAAG,SAAAC,EAAW,GAAMrB,GAAWpxB,CAAI,EACrD,OAAKwyB,EACGC,EAAWD,EAAW,EADT,CAEvB,CAGO,SAASE,GAAoB1yB,EAGlC,CACA,KAAM,CAAE,MAAA2yB,EAAQ,EAAG,OAAAC,EAAS,GAAMxB,GAAWpxB,CAAI,EACjD,MAAO,CAAE,MAAA2yB,EAAO,OAAAC,CAAA,CAClB,CACO,SAASC,GAAkB7yB,EAAsB,CACtD,KAAM,CAAE,aAAA8yB,EAAe,GAAM1B,GAAWpxB,CAAI,EAC5C,OAAO8yB,GAAgB,CACzB,CACO,SAASC,GAAuB/yB,EAAsB,CAC3D,KAAM,CAAE,aAAA6Y,EAAe,GAAMuY,GAAWpxB,CAAI,EAC5C,OAAO6Y,GAAgB,CACzB,CAEO,SAASma,GAAehzB,EAAsB,CACnD,KAAM,CAAE,QAAAizB,EAAU,GAAM7B,GAAWpxB,CAAI,EACvC,OAAO,OAAOizB,GAAW,CAAC,CAC5B,CAGA,MAAMC,GAAe,sBAEd,SAAS3B,GAAiB4B,EAAuC,CACtE,IAAIC,EAAqB,GACzB,GAAI,CACF,MAAM7lC,EAAM,aAAa,QAAQ2lC,EAAY,EACzC3lC,IAAK6lC,EAAM,KAAK,MAAM7lC,CAAG,EAC/B,MAAQ,CAAC,CAET,GAAI,MAAM,QAAQ4lC,CAAW,EAC3B,UAAWxhD,KAAKwhD,EACTC,EAAIzhD,CAAC,IAAGyhD,EAAIzhD,CAAC,EAAI,CAAE,OAAQ,EAAG,IAAK,IAG5C,OAAOyhD,CACT,CAEO,SAASjB,GACdkB,EACAjsB,EACA,CACA,GAAI,CACF,aAAa,QAAQ8rB,GAAc,KAAK,UAAUG,CAAK,CAAC,EACxD,OAAO,cACL,IAAI,YAAY,oBAAqB,CAAE,OAAQ,CAAE,UAAW,GAAK,CAAG,EAExE,MAAQ,CAAC,CACT,GAAI,CAACjsB,GAAM,SAAU,CACnB,MAAMksB,EAAS,aAAa,QAAQ,iBAAiB,GAAK,GACtDA,IACFpC,GAAaoC,EAAQ,CAAE,UAAW,KAAK,MAAO,EAC9C7B,GAAkB6B,CAAM,EAE5B,CACF,CAEO,SAASC,GAAatwB,EAAcuwB,EAAc,CACvD,MAAMlsC,EAAUiqC,GAAA,EACV5sC,EAAQ2C,EAAQ2b,CAAI,GAAK,CAAE,OAAQ,EAAG,IAAK,GACjDte,EAAM,QAAU,EACZ6uC,MAAW,KAAO,GACtBlsC,EAAQ2b,CAAI,EAAIte,EAChBwtC,GAAiB7qC,CAAO,CAC1B,CAGA,SAASmsC,GAAUzzB,EAA2B,CAC5C,GAAI,CACF,MAAMzS,EAAM,aAAa,QAAQojC,GAAa3wB,CAAI,CAAC,EACnD,GAAI,CAACzS,EAAK,MAAO,GACjB,MAAM2pB,EAAM,KAAK,MAAM3pB,CAAG,EAC1B,OAAK,MAAM,QAAQ2pB,CAAG,EACfA,EACJ,IAAK5kC,IAAY,CAChB,EAAG,OAAOA,EAAE,CAAC,GAAK,EAClB,MAAO,OAAOA,EAAE,KAAK,GAAK,EAC1B,OAAQ,OAAOA,EAAE,MAAM,GAAK,EAC5B,QAAS,OAAOA,EAAE,OAAO,GAAK,EAC9B,SAAU,OAAOA,EAAE,QAAQ,GAAK,GAChC,EACD,OAAQA,GAAMA,EAAE,EAAI,CAAC,EATQ,EAUlC,MAAQ,CACN,MAAO,EACT,CACF,CAEA,SAAS2/C,GACPjyB,EACAjb,EACAqiB,EACA,CACA,GAAI,CACF,aAAa,QAAQupB,GAAa3wB,CAAI,EAAG,KAAK,UAAUjb,CAAO,CAAC,EAChE,OAAO,cACL,IAAI,YAAY,oBAAqB,CAAE,OAAQ,CAAE,KAAAib,CAAA,EAAQ,EAE7D,MAAQ,CAAC,CACJoH,GAAM,WACT8pB,GAAalxB,EAAM,CAAE,UAAW,KAAK,MAAO,EAC5CyxB,GAAkBzxB,CAAI,EAE1B,CAEO,SAASqxB,GAAcrxB,EAA2B,CACvD,OAAOyzB,GAAUzzB,CAAI,CACvB,CAEA,SAAS0zB,GAAS3uC,EAAsB4uC,EAA+B,CACrE,MAAMp9B,EAAM,KAAK,MACjB,OAAOxR,EAAQ,OAAQzS,GAAMikB,EAAMjkB,EAAE,GAAKqhD,CAAQ,CACpD,CAEO,SAASC,GACd5zB,EACA0W,EACA4b,EACAuB,EAAe,KAAK,MACpBrB,EACAC,EACA,CACA,GAAI/b,GAAS,EAAG,OAChB,MAAMod,EAAOL,GAAUzzB,CAAI,EACrBxX,EAAOkrC,GACX,CAAC,GAAGI,EAAM,CAAE,EAAGD,EAAM,MAAAnd,EAAO,OAAA4b,EAAQ,QAAAE,EAAS,SAAAC,EAAU,EACvD,IAAO,GAAK,GAAK,GAAK,IAExBR,GAAUjyB,EAAMxX,CAAI,CACtB,CAEO,SAASurC,GACd/zB,EACAg0B,EAAmB,IAAO,GAAK,GAAK,GAC5B,CACR,MAAMF,EAAOL,GAAUzzB,CAAI,EAC3B,GAAI,CAAC8zB,EAAK,OAAQ,MAAO,GACzB,MAAMv9B,EAAM,KAAK,MACjB,IAAImgB,EAAQ,EACV4b,EAAS,EACX,UAAWhgD,KAAKwhD,EACVv9B,EAAMjkB,EAAE,GAAK0hD,IACftd,GAASpkC,EAAE,MACXggD,GAAUhgD,EAAE,QAGhB,OAAIokC,GAAS,EAAU,EACf4b,EAAS5b,EAAS,CAC5B,CAEO,SAASud,GACdj0B,EACAg0B,EAAmB,IAAO,GAAK,GAAK,GAAK,GACjC,CACR,MAAMF,EAAOL,GAAUzzB,CAAI,EAC3B,GAAI,CAAC8zB,EAAK,OAAQ,MAAO,GACzB,MAAMv9B,EAAM,KAAK,MACjB,IAAImgB,EAAQ,EACV4b,EAAS,EACX,UAAWhgD,KAAKwhD,EACVv9B,EAAMjkB,EAAE,GAAK0hD,IACftd,GAASpkC,EAAE,SAAW,EACtBggD,GAAUhgD,EAAE,UAAY,GAG5B,OAAIokC,GAAS,EAAU,EACf4b,EAAS5b,EAAS,CAC5B,CAKA,SAAS4a,GAAiBtxB,EAAoC,CAC5D,GAAI,CACF,MAAMzS,EAAM,aAAa,QAAQqjC,GAAY5wB,CAAI,CAAC,EAClD,GAAI,CAACzS,EAAK,OAAO,KACjB,MAAM/M,EAAI,KAAK,MAAM+M,CAAG,EACxB,MAAO,CAAE,IAAK,OAAO/M,EAAE,GAAG,GAAK,EAAG,GAAI,OAAOA,EAAE,EAAE,GAAK,EACxD,MAAQ,CACN,OAAO,IACT,CACF,CAEA,SAAS0xC,GACPlyB,EACAk0B,EACA9sB,EACA,CACA,GAAI,CACF,aAAa,QAAQwpB,GAAY5wB,CAAI,EAAG,KAAK,UAAUk0B,CAAI,CAAC,EAC5D,OAAO,cACL,IAAI,YAAY,oBAAqB,CAAE,OAAQ,CAAE,KAAAl0B,CAAA,EAAQ,EAE7D,MAAQ,CAAC,CACJoH,GAAM,WACT8pB,GAAalxB,EAAM,CAAE,UAAW,KAAK,MAAO,EAC5CyxB,GAAkBzxB,CAAI,EAE1B,CAEO,SAASm0B,GAAoBn0B,EAAsB,CACxD,MAAMk0B,EAAO5C,GAAiBtxB,CAAI,EAC5BzJ,EAAM,KAAK,MACX69B,EAAM,IAAO,GAAK,GAAK,GAC7B,GAAIF,GAAQ39B,EAAM29B,EAAK,GAAKE,SAAYF,EAAK,IAE7C,MAAMG,EAAKN,GAAc/zB,EAAMo0B,CAAG,EAElC,OAAAlC,GAAiBlyB,EADW,CAAE,IAAKq0B,EAAI,GAAI99B,CAAA,CAChB,EACpB89B,CACT,CAGO,SAASC,GAAet0B,EAAsB,CAEnD,MAAM8zB,EAAOL,GAAUzzB,CAAI,EAC3B,GAAI,CAAC8zB,EAAK,OAAQ,MAAO,GACzB,MAAMv9B,EAAM,KAAK,MAEXg+B,EAAWT,EAAK,OAAQxhD,GAAMikB,EAAMjkB,EAAE,GAAK,MAAW,EACtDkiD,EAAYD,EAAS,OAAQjiD,GAAM,OAAOA,EAAE,SAAY,QAAQ,EAChEmiD,EAAMD,EAAU,OAASA,EAAYD,EAC3C,IAAI7d,EAAQ,EACV4b,EAAS,EACX,UAAWhgD,KAAKmiD,EACd/d,GAASpkC,EAAE,MACXggD,GAAUhgD,EAAE,OAEd,OAAIokC,GAAS,EAAU,EACf4b,EAAS5b,EAAS,CAC5B,CACO,SAASge,GAAuB10B,EAAsB,CAE3D,OAAOi0B,GAAuBj0B,EAAM,MAAW,CACjD,CAGO,SAAS20B,GACdxb,EACA/R,EACA,CACA,MAAMwtB,EAAextB,GAAM,eAAiB,GAG5C,IAAIytB,EAA+B,KACnC,GAAI,CACF,MAAMvB,EAAS,aAAa,QAAQ,iBAAiB,EACjDA,EAAQuB,EAAgBvB,EACnB,OAAQ,QAAgB,gBAAmB,WAClDuB,EAAiB,OAAe,eACpC,MAAQ,CAAC,CAET,UAAWtnC,KAAO4rB,EAAS,CAEzB,MAAMpnC,EAAY,CAAE,GAAGwb,CAAA,EACvB,GAAIsnC,EAAe,CACjB,MAAM/iD,GAAKC,EAAE,MAAQ,IAAI,QACrB,CAACD,GAAKA,EAAE,gBAAkB,WAAS,KAAO+iD,EAChD,CAEA,IAAIne,EAAQ,EACR4b,EAAS,EACTE,EAAU,EACVC,EAAW,EACXqC,EAAa,OAAO,kBACpBC,EAAW,EAEXC,EAAa,EACbC,EAAc,EACdC,EAAoB,EACpBC,EAAoB,EACpBC,EAAqB,EACrBC,EAAiB,EACjBC,EAAkB,EAClBC,EAAY,EAChB,UAAWpd,KAAOpmC,EAAE,KAAM,CACxB,GAAI,CAAComC,EAAI,SAAU,SACnBzB,GAASyB,EAAI,YACbma,GAAU,KAAK,IAAI,EAAGna,EAAI,gBAAkBA,EAAI,mBAAmB,EAEnE,KAAM,CAAE,EAAGqd,EAAY,EAAGC,CAAA,EAAgBC,GAAavd,CAAG,EAC1Dqa,GAAWgD,EACX/C,GAAYgD,EAEZ,MAAME,EAAW,KAAK,IAAI,EAAGxd,EAAI,WAAW,EACtCyd,EAAY,KAAK,IACrB,EACAzd,EAAI,gBAAkBA,EAAI,qBAEtB0d,EAASF,EAAW,EAAKC,EAAYD,EAAY,EAAI,EACrDG,EAAWN,EAAa,EAAKC,EAAcD,EAAc,EAAI,EAcnE,GAbIK,EAAS,IACXb,EAAa,KAAK,IAAIA,EAAYa,CAAM,EACxCZ,EACEA,IAAgB,EAAIY,EAAS,KAAK,IAAIZ,EAAaY,CAAM,GAEzDC,EAAW,IACbT,EAAiB,KAAK,IAAIA,EAAgBS,CAAQ,EAClDR,EACEA,IAAoB,EAChBQ,EACA,KAAK,IAAIR,EAAiBQ,CAAQ,GAEtB3d,EAAI,sBAAwB,EAC/B,EACX+c,IAAsB,GAAKS,EAAWT,KACxCA,EAAoBS,IAClBP,IAAuB,GAAKO,EAAWP,KACzCA,EAAqBO,GACvB,MAAMI,EACJ,OAAO5d,EAAI,eAAkB,SAAWA,EAAI,cAAgB,EAC1D4d,EAAKZ,IAAmBA,EAAoBY,EAClD,CAEA,MAAMC,EAAW,OAAO7d,EAAI,WAAa,CAAC,EACpC8d,EAAS,OAAO9d,EAAI,SAAW,CAAC,GAAK6d,GAAY,KAAK,MACxDA,EAAW,IAAGlB,EAAa,KAAK,IAAIA,EAAYkB,CAAQ,GACxDC,EAAS,IAAGlB,EAAW,KAAK,IAAIA,EAAUkB,CAAM,GAEpD,GAAI,CACF,UAAWjoC,KAAKmqB,EAAI,QAAU,GACxB,OAAOnqB,EAAE,OAAS,CAAC,IAAM,MAAKunC,GAAa,EAEnD,MAAQ,CAAC,CACX,CACA,GAAI7e,EAAQ,EAAG,CACb,MAAM/tB,EAAOyoC,GAAWr/C,EAAE,IAAI,EACxByW,EAAsB,CAC1B,MAAOG,EAAK,MAAQ+tB,EACpB,OAAQ/tB,EAAK,OAAS2pC,EACtB,SAAU3pC,EAAK,SAAW,GAAK6pC,EAC/B,UAAW7pC,EAAK,UAAY,GAAK8pC,EACjC,MAAO,KAAK,IAAI9pC,EAAK,OAAS,EAAGqsC,GAAc,CAAC,EAEhD,QAAS,IAAM,CACb,MAAMkB,EAAQvtC,EAAK,QAAU,EAC7B,OAAIutC,IAAU,EAAUjB,GAAe,EACnCA,IAAgB,EAAUiB,EACvB,KAAK,IAAIA,EAAOjB,CAAW,CACpC,KAEA,cAAe,IAAM,CACnB,MAAMiB,EAAQvtC,EAAK,cAAgB,EACnC,OAAIutC,IAAU,EAAUhB,GAAqB,EACzCA,IAAsB,EAAUgB,EAC7B,KAAK,IAAIA,EAAOhB,CAAiB,CAC1C,KACA,aAAc,KAAK,IAAIvsC,EAAK,cAAgB,EAAGwsC,GAAqB,CAAC,EACrE,eAAgB,IAAM,CACpB,MAAMe,EAAQvtC,EAAK,eAAiB,EACpC,OAAIutC,IAAU,EAAUd,GAAsB,EAC1CA,IAAuB,EAAUc,EAC9B,KAAK,IAAIA,EAAOd,CAAkB,CAC3C,KACA,UAAW,KAAK,IAAIzsC,EAAK,WAAa,EAAG0sC,GAAkB,CAAC,EAC5D,YAAa,IAAM,CACjB,MAAMa,EAAQvtC,EAAK,YAAc,EACjC,OAAIutC,IAAU,EAAUZ,GAAmB,EACvCA,IAAoB,EAAUY,EAC3B,KAAK,IAAIA,EAAOZ,CAAe,CACxC,KACA,SAAU3sC,EAAK,SAAW,IAAM4sC,GAAa,IAK/C,GAHAvD,GAAWjgD,EAAE,KAAMyW,CAAI,EAGnBosC,EAAc,CAChB,MAAMuB,EAAS1C,GAAU1hD,EAAE,IAAI,EACzBqkD,EAAQ,OAAO,SAAStB,CAAU,EAAIA,EAAa,KAAK,MACxD1qC,EAAM2qC,EAAW,EAAIA,EAAWqB,EAChC7I,EAAM,IACe4I,EAAO,KAC/B7jD,GAAMA,EAAE,GAAK8jD,EAAQ7I,GAAOj7C,EAAE,GAAK8X,EAAMmjC,CAAA,GAG1CqG,GAAU7hD,EAAE,KAAM2kC,EAAO4b,EAAQloC,EAAKooC,EAASC,CAAQ,CAE3D,CACF,CACF,CACF,CAGA,SAASiD,GAAavd,EAAoC,CACxD,IAAIke,EAAS,KAAK,IAAI,EAAGle,EAAI,WAAW,EACxC,GAAIke,GAAU,EAAG,MAAO,CAAE,EAAG,EAAG,EAAG,GACnC,IAAI,EAAI,EACR,UAAWroC,KAAKmqB,EAAI,OAAQ,CAC1B,GAAIke,GAAU,EAAG,MACjB,MAAMC,EAAO,KAAK,IAAID,EAAQroC,EAAE,KAAK,EAEjCsoC,IAAStoC,EAAE,MAAO,GAAKA,EAAE,SACnB,KAAK,MAAOA,EAAE,MAAQA,EAAE,MAASsoC,CAAI,EAC/CD,GAAUC,CACZ,CAEA,MAAO,CAAE,EADC,KAAK,IAAI,EAAGne,EAAI,WAAW,EACzB,EACd,qgBCnoBaoe,GAAY,CAAC,MAAO,iBAAiB,EAcrCC,GAAe,CAC1B,mBACA,UACA,WACA,WACA,WACA,SACA,WACA,WACA,aACA,YACA,eACA,eACA,kBACA,WACA,OACA,cACA,mBACA,OACA,QACA,QACF,EAIaC,GAAsB,CAAC,GAAGF,GAAW,GAAGC,EAAY,EAGpDE,GAA0C,CACrD,IAAK,CACH,aAAc,CAAC,IAAK,IAAK,GAAG,EAC5B,YAAa,CAAC,SAAU,SAAS,EACjC,iBAAkB,CAAE,OAAQ,CAAC,EAAG,EAAG,EAAG,CAAC,EAAG,QAAS,CAAC,EAAG,EAAG,EAAG,EAAG,EAAG,CAAC,EAAE,EAExE,kBAAmB,CACjB,aAAc,GACd,YAAa,CAAC,UAAU,EACxB,iBAAkB,CAAE,SAAU,CAAC,GAAI,GAAI,GAAG,EAAE,EAE9C,mBAAoB,CAClB,aAAc,GACd,YAAa,CAAC,SAAU,SAAS,EACjC,iBAAkB,CAAE,OAAQ,CAAC,EAAG,EAAG,CAAC,EAAG,QAAS,CAAC,EAAG,EAAG,EAAG,CAAC,EAAE,EAE/D,QAAS,CACP,aAAc,GACd,YAAa,CAAC,SAAU,UAAW,QAAQ,EAC3C,iBAAkB,CAChB,OAAQ,CAAC,EAAG,EAAG,CAAC,EAChB,QAAS,CAAC,EAAG,EAAG,EAAG,CAAC,EACpB,OAAQ,CAAC,EAAG,EAAG,CAAC,EAClB,EAEF,WAAY,CACV,aAAc,GACd,YAAa,CAAC,SAAU,SAAS,EACjC,iBAAkB,CAAE,OAAQ,CAAC,EAAG,EAAG,CAAC,EAAG,QAAS,CAAC,EAAG,EAAG,EAAG,CAAC,EAAE,EAE/D,SAAU,CACR,aAAc,GACd,YAAa,CAAC,SAAU,SAAS,EACjC,iBAAkB,CAAE,OAAQ,CAAC,EAAG,EAAG,CAAC,EAAG,QAAS,CAAC,EAAG,EAAG,EAAG,CAAC,EAAE,EAE/D,WAAY,CACV,aAAc,GACd,YAAa,CAAC,SAAU,SAAS,EACjC,iBAAkB,CAAE,OAAQ,CAAC,EAAG,EAAG,CAAC,EAAG,QAAS,CAAC,EAAG,EAAG,EAAG,CAAC,EAAE,EAE/D,OAAQ,CACN,aAAc,GACd,YAAa,CAAC,SAAU,SAAS,EACjC,iBAAkB,CAAE,OAAQ,CAAC,EAAG,EAAG,CAAC,EAAG,QAAS,CAAC,EAAG,EAAG,EAAG,CAAC,EAAE,EAE/D,WAAY,CACV,aAAc,GACd,YAAa,CAAC,SAAU,SAAS,EACjC,iBAAkB,CAAE,OAAQ,CAAC,EAAG,EAAG,CAAC,EAAG,QAAS,CAAC,EAAG,EAAG,EAAG,CAAC,EAAE,EAE/D,WAAY,CACV,aAAc,GACd,YAAa,CAAC,SAAU,SAAS,EACjC,iBAAkB,CAAE,OAAQ,CAAC,EAAG,EAAG,CAAC,EAAG,QAAS,CAAC,EAAG,EAAG,EAAG,CAAC,EAAE,EAE/D,aAAc,CACZ,aAAc,GACd,YAAa,CAAC,SAAU,SAAS,EACjC,iBAAkB,CAAE,OAAQ,CAAC,EAAG,EAAG,CAAC,EAAG,QAAS,CAAC,EAAG,EAAG,EAAG,CAAC,EAAE,EAE/D,YAAa,CACX,aAAc,GACd,YAAa,CAAC,SAAU,SAAS,EACjC,iBAAkB,CAAE,OAAQ,CAAC,EAAG,EAAG,CAAC,EAAG,QAAS,CAAC,EAAG,EAAG,EAAG,CAAC,EAAE,EAE/D,eAAgB,CACd,aAAc,GACd,YAAa,CAAC,SAAU,SAAS,EACjC,iBAAkB,CAAE,OAAQ,CAAC,EAAG,EAAG,CAAC,EAAG,QAAS,CAAC,EAAG,EAAG,EAAG,CAAC,EAAE,EAE/D,eAAgB,CACd,aAAc,GACd,YAAa,CAAC,SAAU,SAAS,EACjC,iBAAkB,CAAE,OAAQ,CAAC,EAAG,EAAG,CAAC,EAAG,QAAS,CAAC,EAAG,EAAG,EAAG,CAAC,EAAE,EAE/D,kBAAmB,CACjB,aAAc,GACd,YAAa,CAAC,UAAU,EACxB,iBAAkB,CAAE,SAAU,CAAC,GAAI,GAAI,GAAG,EAAE,EAE9C,SAAU,CACR,aAAc,GACd,YAAa,CAAC,SAAU,SAAS,EACjC,iBAAkB,CAAE,OAAQ,CAAC,EAAG,EAAG,CAAC,EAAG,QAAS,CAAC,EAAG,EAAG,EAAG,CAAC,EAAE,EAE/D,KAAM,CACJ,aAAc,GACd,YAAa,CAAC,QAAS,QAAQ,EAC/B,iBAAkB,CAAE,MAAO,CAAC,EAAG,EAAE,EAAG,OAAQ,CAAC,EAAG,EAAG,CAAC,EAAE,EAExD,cAAe,CACb,aAAc,GACd,YAAa,CAAC,SAAU,SAAS,EACjC,iBAAkB,CAAE,OAAQ,CAAC,EAAG,EAAG,CAAC,EAAG,QAAS,CAAC,EAAG,EAAG,EAAG,CAAC,EAAE,EAE/D,mBAAoB,CAClB,aAAc,GACd,YAAa,CAAC,SAAU,SAAS,EACjC,iBAAkB,CAAE,OAAQ,CAAC,EAAG,EAAG,CAAC,EAAG,QAAS,CAAC,EAAG,EAAG,EAAG,CAAC,EAAE,EAE/D,KAAM,CACJ,aAAc,GACd,YAAa,CAAC,SAAU,SAAS,EACjC,iBAAkB,CAAE,OAAQ,CAAC,EAAG,EAAG,CAAC,EAAG,QAAS,CAAC,EAAG,EAAG,EAAG,CAAC,EAAE,EAE/D,MAAO,CACL,aAAc,GACd,YAAa,CAAC,SAAU,SAAS,EACjC,iBAAkB,CAAE,OAAQ,CAAC,EAAG,EAAG,CAAC,EAAG,QAAS,CAAC,EAAG,EAAG,EAAG,CAAC,EAAE,EAE/D,OAAQ,CACN,aAAc,GACd,YAAa,CAAC,SAAU,SAAS,EACjC,iBAAkB,CAAE,OAAQ,CAAC,EAAG,EAAG,CAAC,EAAG,QAAS,CAAC,EAAG,EAAG,EAAG,CAAC,EAAE,CAEjE,EAEO,SAASC,GAAuBxkD,EAA8B,CACnE,OAAIA,IAAM,MAAc,CAAC,IAAK,IAAK,GAAG,EAC1BukD,GAAWvkD,CAAC,GACZ,cAAgB,EAC9B,CAEO,SAASykD,GAAsBzkD,EAAyC,CAC7E,GAAIA,IAAM,MAAO,MAAO,CAAC,MAAO,SAAU,SAAS,EACnD,MAAMgkB,EAAMugC,GAAWvkD,CAAC,EACxB,OAAKgkB,EACE,CAAC,MAAO,GAAGA,EAAI,WAAW,EADhB,CAAC,MAAO,SAAU,SAAS,CAE9C,CAEO,SAAS0gC,GACd1kD,EACA8wB,EACU,CACV,OAAI9wB,IAAM,OAAS8wB,IAAS,MAAc,GAC9ByzB,GAAWvkD,CAAC,GACZ,mBAAmB8wB,CAAI,GAAK,EAC1C,CAEO,SAAS6zB,GAAaC,EAAgC,CAC3D,GAAI,CAACA,EAAK,MAAO,GACjB,OAAQA,EAAA,CACN,IAAK,MACH,MAAO,YACT,IAAK,SACH,MAAO,UACT,IAAK,UACH,MAAO,WACT,IAAK,UACH,MAAO,UACT,IAAK,QACH,MAAO,QACT,IAAK,SACH,MAAO,SACT,IAAK,WACH,MAAO,WACT,IAAK,OACH,MAAO,OACT,QACE,OAAO,OAAOA,CAAG,EACd,QAAQ,QAAS,GAAG,EACpB,QAAQ,QAAU7wB,GAAMA,EAAE,aAAa,EAEhD,CC1MO,MAAM8wB,GAAY,CAEvB,KAAM,IACN,OAAQ,IACR,OAAQ,IACR,SAAU,IAGV,GAAI,IACJ,GAAI,IACJ,KAAM,IACN,KAAM,IAGN,KAAM,OACN,QAAS,IACT,OAAQ,MACR,OAAQ,IACR,QAAS,GACX,EAIO,SAASC,GAAIj3B,EAAsD,CACxE,OAAOg3B,GAAUh3B,CAAI,CACvB,CClBA,SAAwBk3B,IAAoB,CAC1C,MAAMC,EAASr0B,GAAA,EACTs0B,EAAgBD,EAAO,mBACvBE,EAAUF,EAAO,qBACjBG,EAAkB,CAAC,EAAEF,GAAiBC,GAAS,WAC/Ct0B,EAAYo0B,EAAO,aAAeG,EAClCC,EAAcx0B,EAAY,gBAAkB,iBAGlDtU,YAAU,IAAM,CAEhB,EAAG,CAACsU,CAAS,CAAC,EAEd,MAAMy0B,EAAU,IAAM,CACpB,GAAI,CACF,OAAO,cAAc,IAAI,YAAY,0BAA0B,CAAC,CAClE,MAAY,CAAC,CACf,EAEA,OACE3iC,OAAC,UACC,KAAK,SACL,QAAA2iC,EACA,UAAU,uJACV,MACEz0B,EACI,+CACA,yBAGN,UAAAjO,MAAC,QAAK,UAAU,2BAA4B,SAAAmiC,GAAI,QAAQ,EAAE,EAC1DniC,MAAC,QAAK,UAAU,8CACb,SAAAyiC,EACH,EACAziC,MAAC,QACC,UAAW,sCAAsCiO,EAAY,iBAAmB,aAAa,GAC7F,cAAW,IACb,GAGN,CCjDO,MAAM00B,GAAc,CACzB,YAAa,CACX,SAAU,CACR,cACA,YACA,SACA,QACA,WACA,MACA,SAEF,MAAO,wBACP,YAAa;;AAAA;AAAA;AAAA;AAAA;AAAA;;AAAA,4IASb,QAAS,CACP,CAAE,GAAI,MAAO,MAAO,eAAgB,MAAO,eAC3C,CAAE,GAAI,KAAM,MAAO,cAAe,MAAO,iBACzC,CAAE,GAAI,KAAM,MAAO,cAAe,MAAO,eACzC,CAAE,GAAI,MAAO,MAAO,eAAgB,MAAO,eAC3C,CAAE,GAAI,WAAY,MAAO,oBAAqB,MAAO,gBAAgB,CACvE,EAEF,QAAS,CACP,SAAU,CACR,QACA,SACA,WACA,iBACA,kBAEF,MAAO,eACP,YAAa;AAAA;AAAA;AAAA;AAAA;AAAA;;AAAA,oEASf,SAAU,CACR,SAAU,CACR,OACA,cACA,QACA,MACA,UACA,QACA,SAEF,MAAO,cACP,YAAa;;AAAA;;AAAA;;AAAA;;AAAA,sFAUf,QAAS,CACP,SAAU,CACR,UACA,eACA,WACA,UACA,OACA,QAEF,MAAO,mBACP,YAAa;AAAA;AAAA;AAAA;AAAA;AAAA;;AAAA,yDASf,WAAY,CACV,SAAU,CACR,aACA,aACA,MACA,UACA,YACA,QACA,WAEF,MAAO,oBACP,YAAa;AAAA;AAAA;AAAA;AAAA;AAAA;;AAAA,gFASf,OAAQ,CACN,SAAU,CACR,SACA,eACA,SACA,QACA,UACA,WAEF,MAAO,eACP,YAAa;AAAA;AAAA;AAAA;AAAA;AAAA;;AAAA,sDASf,WAAY,CACV,SAAU,CACR,aACA,UACA,UACA,QACA,SACA,YAEF,MAAO,cACP,YAAa;AAAA;AAAA;AAAA;AAAA;;AAAA,8GAQjB,EAUO,SAASC,GAAoBC,EAAqC,CACvE,MAAMC,EAASD,EAAS,cAGxB,SAAW,EAAGE,CAAK,IAAK,OAAO,QAAQJ,EAAW,EAChD,UAAWK,KAAWD,EAAM,SAC1B,GAAID,EAAO,SAASE,CAAO,EACzB,MAAO,CACL,KAAM,cACN,MAAOD,EAAM,MACb,QAASA,EAAM,YACf,QAAUA,EAAc,QACxB,SACE,8EAOV,MAAO,CACL,KAAM,aACN,MAAO,kBACP,QAAS;;AAAA,EAAyF,OAAO,OACvGJ,EAAA,EAEC,IAAK5kD,GAAM,KAAKA,EAAE,KAAK,EAAE,EACzB,KAAK;AAAA,CAAI,CAAC;;AAAA,0DACb,SAAU,yCAEd,CAEO,SAASklD,IAA+B,CAC7C,MAAMC,EAAO,IAAI,OAAO,WAExB,OAAIA,GAAQ,IAAMA,EAAO,EAChB,iCACEA,GAAQ,IAAMA,EAAO,GACvB,mCACEA,GAAQ,IAAMA,EAAO,GACvB,6BAEA,cAEX,CClMA,SAAwBC,GAAa,CACnC,QAAAC,EACA,KAAAnrC,EACA,QAAAorC,CACF,EAIG,CACD,MAAM50B,GAAM,IAAM,CAChB,GAAI,CACF,OAAOia,GAAA,CACT,MAAQ,CACN,OAAO,IACT,CACF,KACM,CAAC4a,EAAUC,CAAW,EAAI3kD,WAAgBwkD,GAAS,UAAY,EAAE,EACjE,CAACjnC,EAAOqnC,CAAQ,EAAI5kD,WAAS,EAAE,EAC/B,CAAC6kD,EAAaC,CAAc,EAAI9kD,WAAiC,EAAE,EACnE,CAAC+kD,EAAgBC,CAAiB,EAAIhlD,WAAS,EAAK,EACpD,CAACilD,EAAUC,CAAW,EAAIllD,WAAS,EAAE,EACrCmlD,EAAU3hD,SAA8B,IAAI,EAC5C4hD,EAAmB5hD,SAAsB,IAAI,EAC7C6hD,EAAY7hD,SAAiB,EAAE,EAErCuX,YAAU,IAAM,CACd,GAAI,CAAC8U,EAAI,OACT,MAAMy1B,EAAKz1B,EAAG,YAAapuB,GAAc,CACvC,GAAI,CAcF,GAZEA,GAAM,OAAS,gBACf,OAAOA,EAAK,SAAS,IAAM,OAAO+iD,EAAQ,EAAE,GAE5CG,EAAaxmD,GAAM,CAAC,GAAGA,EAAGsD,EAAK,OAAO,CAAC,EAGvCA,GAAM,OAAS,wBACfA,EAAK,SAAS,KAAO+iD,EAAQ,KAE7BG,EAAYljD,EAAK,QAAQ,UAAY,EAAE,EACvCujD,EAAkB,EAAAvjD,EAAK,QAAQ,SAAwB,GAGvDA,GAAM,OAAS,eACf,OAAOA,EAAK,SAAS,IAAM,OAAO+iD,EAAQ,EAAE,EAC5C,CACA,MAAMe,EACJ9jD,EAAK,UAAYA,EAAK,YAAcA,EAAK,MAAQ,QAAU,QAC7DqjD,EAAgB7vC,IAAU,CAAE,GAAGA,EAAM,CAACswC,CAAG,EAAG,KAAK,KAAI,EAAI,CAC3D,CACF,MAAQ,CAAC,CACX,CAAC,EACD,MAAO,IAAM,CACXD,EAAA,CACF,CACF,EAAG,CAACz1B,EAAI20B,GAAS,EAAE,CAAC,EAEpB,MAAMgB,EAAU,IAAM,CACpB,GAAI,CAACjoC,EAAM,OAAQ,OAGnB,MAAMkoC,EAAcloC,EACdy3B,EAAU,CACd,KAAM,eACN,UAAWwP,EAAQ,GACnB,QAASiB,CAAA,EAEX,GAAI,CACF51B,GAAI,KAAKmlB,CAAO,CAClB,MAAQ,CAAC,CAET,MAAM0Q,EAAS,CACb,UAAWrsC,GAAM,OAAS,KAC1B,SAAUA,GAAM,UAAY,KAC5B,QAASosC,EACT,GAAI,KAAK,MACT,MAAO,IAMT,GAJAd,EAAaxmD,GAAM,CAAC,GAAGA,EAAGunD,CAAM,CAAC,EACjCd,EAAS,EAAE,EAGP,CAACG,EAAgB,CACnB,MAAM5lD,EAAI,OAAO,WAAW,IAAM,CAChC,MAAMwmD,EAAa3B,GAAoByB,CAAW,EAClD,GAAIE,EAAY,CACd,MAAMC,EAAQ,CACZ,SAAU,eACV,QAAS,GAAGD,EAAW,KAAK;;AAAA,EAAOA,EAAW,OAAO,GACrD,GAAI,KAAK,MACT,MAAO,GACP,QAASA,EAAW,QACpB,SAAUA,EAAW,UAEvBhB,EAAaxmD,GAAM,CAAC,GAAGA,EAAGynD,CAAK,CAAC,CAClC,CACF,EAAG,GAAG,EACNP,EAAU,QAAQ,KAAKlmD,CAAC,CAC1B,CACF,EAEM0mD,EAA0BC,GAAuB,CACrD,GAAI,CAACA,EAAW,CACd,MAAMC,EAAa,CACjB,SAAU,MACV,QAAS,qCACT,GAAI,KAAK,MACT,MAAO,IAETpB,EAAaxmD,GAAM,CAAC,GAAGA,EAAG4nD,CAAU,CAAC,EAErC,MAAM5mD,EAAI,OAAO,WAAW,IAAM,CAChC,MAAMymD,EAAQ,CACZ,SAAU,eACV,QACE,kFACF,GAAI,KAAK,MACT,MAAO,IAETjB,EAAaxmD,GAAM,CAAC,GAAGA,EAAGynD,CAAK,CAAC,CAClC,EAAG,GAAG,EACNP,EAAU,QAAQ,KAAKlmD,CAAC,EACxB,MACF,CAGA,MAAM4mD,EAAa,CACjB,SAAU,MACV,QAAS,qCACT,GAAI,KAAK,MACT,MAAO,IAETpB,EAAaxmD,GAAM,CAAC,GAAGA,EAAG4nD,CAAU,CAAC,EAGrC,GAAI,CACFl2B,GAAI,KAAK,CAAE,KAAM,gBAAiB,UAAW20B,EAAQ,GAAI,CAC3D,MAAQ,CAAC,CAETU,EAAYb,IAAsB,EAElC,MAAMllD,EAAI,OAAO,WAAW,IAAM,CAChC,MAAM6mD,EAAU,CACd,SAAU,SACV,QAAS;;AAAA,0BAAgEf,CAAQ;;AAAA,8DACjF,GAAI,KAAK,MACT,MAAO,IAETN,EAAaxmD,GAAM,CAAC,GAAGA,EAAG6nD,CAAO,CAAC,CACpC,EAAG,GAAG,EACNX,EAAU,QAAQ,KAAKlmD,CAAC,CAC1B,EAGA4b,YAAU,IAAM,CACd,GAAKoqC,EAAQ,QACb,GAAI,CACFA,EAAQ,QAAQ,UAAYA,EAAQ,QAAQ,YAC9C,MAAQ,CAAC,CACX,EAAG,CAACT,CAAQ,CAAC,EAGb,MAAMuB,EAAatgD,cAAY,IAAM,CACnC,GAAI,CACFkqB,GAAI,KAAK,CACP,KAAM,cACN,UAAW20B,EAAQ,GACnB,SAAUnrC,GAAM,SAChB,UAAWA,GAAM,MACjB,MAAO,CAAC,CAACA,GAAM,QAChB,CACH,MAAQ,CAAC,CACL+rC,EAAiB,SACnB,aAAaA,EAAiB,OAAO,EAEvCA,EAAiB,QAAU,OAAO,WAAW,IAAM,CACjDN,EAAgB7vC,GAAS,CACvB,MAAMixC,EAAO,CAAE,GAAGjxC,CAAA,EAClB,cAAOixC,EAAK7sC,GAAM,UAAYA,GAAM,OAAS,IAAI,EAC1C6sC,CACT,CAAC,CACH,EAAG,GAAI,CACT,EAAG,CAACr2B,EAAI20B,EAAQ,GAAInrC,CAAI,CAAC,EAEzB0B,mBAAU,IACD,IAAM,CACPqqC,EAAiB,SAAS,aAAaA,EAAiB,OAAO,EACnE,UAAWjmD,KAAKkmD,EAAU,QAAS,aAAalmD,CAAC,EACjDkmD,EAAU,QAAU,EACtB,EACC,EAAE,EAGHlkC,OAAC,OAAI,UAAU,uDACb,UAAAC,MAAC,OAAI,UAAU,+BAA+B,QAASqjC,EAAS,EAChEtjC,OAAC,OAAI,UAAU,yGACb,UAAAA,OAAC,OAAI,UAAU,+EACb,UAAAA,OAAC,OAAI,UAAU,0BACb,UAAAA,OAAC,OAAI,UAAU,wCACb,UAAAC,MAAC+kC,GAAA,CAAI,UAAU,0BAA0B,EAAE,eAC9B3B,EAAQ,UAAY,aACnC,EACCO,GACC3jC,MAAC,QAAK,UAAU,2CAA2C,2BAE3D,GAEJ,EACAA,MAAC,UACC,aAAW,QACX,UAAU,gEACV,QAASqjC,EAET,SAAArjC,MAAC2Q,GAAA,CAAE,UAAU,UAAU,GACzB,EACF,EAEA5Q,OAAC,OACC,IAAKgkC,EACL,UAAU,mDAET,UAAAT,EAAS,IAAI,CAACvmD,EAAG8C,UACf,OACC,SAAAkgB,OAAC,OACC,UAAW,iCAAiChjB,EAAE,MAAQ,0EAA4E,6BAA6B,GAE/J,UAAAgjB,OAAC,OAAI,UAAU,yCACb,UAAAA,OAAC,OAAI,UAAU,2DACZ,UAAAhjB,EAAE,YACAgoD,GAAA,CAAI,UAAU,UAAU,EAEzB/kC,MAACglC,GAAA,CAAK,UAAU,UAAU,EAE3BjoD,EAAE,UACDA,EAAE,YACDA,EAAE,MAAQ,eAAiB,QAChC,EACAijB,MAAC,OAAI,UAAU,0BACZ,SAAAjjB,EAAE,GACC,IAAI,KAAKA,EAAE,EAAE,EAAE,mBAAmB,GAAI,CACpC,KAAM,UACN,OAAQ,UACT,EACD,GACN,GACF,EACAijB,MAAC,OAAI,UAAU,0CACZ,WAAE,QACL,EAGCjjB,EAAE,SAAWA,EAAE,QAAQ,OAAS,GAC/BgjB,OAAC,OAAI,UAAU,iBACb,UAAAC,MAAC,OAAI,UAAU,mCAAmC,4CAElD,EACAA,MAAC,OAAI,UAAU,wCACZ,WAAE,QAAQ,IAAK5L,GACd4L,MAAC,UAEC,UAAW,GAAG5L,EAAO,KAAK,wFAC1B,QAAS,IAAM,CACb,MAAM6wC,EAAY,CAChB,SAAU,MACV,QAAS,YAAY7wC,EAAO,KAAK,GACjC,GAAI,KAAK,MACT,MAAO,IAETmvC,EAAa1vC,GAAS,CAAC,GAAGA,EAAMoxC,CAAS,CAAC,EAC1C,GAAI,CACFx2B,GAAI,KAAK,CACP,KAAM,eACN,UAAW20B,EAAQ,GACnB,QAAS,iBAAiBhvC,EAAO,EAAE,GACpC,CACH,MAAQ,CAAC,CACX,EAEC,SAAAA,EAAO,OAnBHA,EAAO,GAqBf,EACH,GACF,EAIDrX,EAAE,UAAY,CAAC4mD,GACd5jC,OAAC,OAAI,UAAU,iBACb,UAAAC,MAAC,OAAI,UAAU,qBAAsB,SAAAjjB,EAAE,SAAS,EAChDgjB,OAAC,OAAI,UAAU,aACb,UAAAC,MAAC,UACC,UAAU,gHACV,QAAS,IAAMykC,EAAuB,EAAI,EAC3C,+BAGDzkC,MAAC,UACC,UAAU,4GACV,QAAS,IAAMykC,EAAuB,EAAK,EAC5C,wBAED,EACF,GACF,IAEJ,EAnFQ5kD,CAoFV,CACD,EAGA,OAAO,KAAK4jD,CAAW,EAAE,OAAS,GACjC1jC,OAAC,OAAI,UAAU,4DACb,UAAAA,OAAC,QAAM,iBAAO,KAAK0jC,CAAW,EAAE,KAAK,IAAI,EAAE,WAAO,EAClD1jC,OAAC,QAAK,UAAU,aACd,UAAAC,MAAC,QAAK,UAAU,mDAAmD,EACnEA,MAAC,QAAK,UAAU,6DAA6D,EAC7EA,MAAC,QAAK,UAAU,6DAA6D,GAC/E,GACF,KAIJD,OAAC,OAAI,UAAU,wDACb,UAAAC,MAAC,SACC,UAAU,uBACV,MAAO7D,EACP,SAAW3e,GAAM,CACfgmD,EAAShmD,EAAE,OAAO,KAAK,EACvBqnD,EAAA,CACF,EACA,UAAYrnD,GAAM,CACZA,EAAE,MAAQ,SAAW,CAACA,EAAE,WAC1BA,EAAE,iBACF4mD,EAAA,EAEJ,EACA,YAAY,2DAEdpkC,MAAC,UACC,aAAW,eACX,UAAU,+CACV,QAASokC,EAET,SAAApkC,MAACklC,GAAA,CAAK,UAAU,UAAU,GAC5B,EACF,GACF,GACF,CAEJ,CC9UA,MAAMC,GAAc,4BAEpB,SAAwBC,GAAe,CAAE,KAAAntC,GAAuB,CAC9D,MAAMwW,GAAM,IAAM,CAChB,GAAI,CACF,OAAOia,GAAA,CACT,MAAQ,CACN,OAAO,IACT,CACF,KACM,CAAC2c,EAAQC,CAAS,EAAI1mD,WAAmB,EAAE,EAC3C,CAACqa,EAAOssC,CAAQ,EAAI3mD,WAAS,EAAE,EAC/B,CAACuoC,CAAM,EAAIvoC,WAAc,IAAI,EAC7B,CAAC4mD,EAAcC,CAAe,EAAI7mD,WAAS,EAAE,EAC7C,CAAC8mD,EAASC,CAAU,EAAI/mD,WAAS,EAAK,EACtC,CAACgnD,EAAaC,CAAc,EAAIjnD,WAAgB,EAAE,EAClD,CAACknD,EAAYC,CAAa,EAAInnD,WAAS,EAAE,EACzC,CAAConD,EAAaC,CAAc,EAAIrnD,WAAgB,EAAE,EAClD,CAACsnD,EAAYC,CAAa,EAAIvnD,WAAc,CAChD,MAAO,sBACP,KAAM,MACN,KAAM,SACN,MAAO,EACP,YAAa,GACb,QAAS,IAAI,KAAK,KAAK,MAAQ,KAAc,GAAI,EAC9C,cACA,MAAM,EAAG,EAAE,EACd,eAAgB,GAChB,SAAU,GACV,UAAW,UACX,YAAa,EACb,WAAY,GACb,EACK,CAACwnD,EAAWC,CAAY,EAAIznD,WAAc,CAC9C,MAAO,GACP,SAAU,GACV,aAAc,GACd,QAAS,EAAC,CACX,EACK,CAAC0nD,EAASC,CAAU,EAAI3nD,WAI3B,CAAE,KAAM,GAAO,EACZ,CAAC4nD,EAAWC,CAAY,EAAI7nD,WAEhC,SAAS,EACL8nD,EAAUzuC,GAAM,OAAO,gBAAkBktC,GACzC,CAACwB,CAAO,EAAI/nD,WAAgB,EAAE,EAC9B,CAACgoD,CAAO,EAAIhoD,WAAgB,EAAE,EAC9B,CAACioD,EAAcC,CAAe,EAAIloD,WAAgB,EAAE,EACpD,CAACmoD,EAAYC,CAAa,EAAIpoD,WAElC,EAAE,EACE,CAACqoD,GAAiBC,EAAkB,EAAItoD,WAAqB,IAAI,EACjE,EAAGuoD,EAAO,EAAIvoD,WAAgB,EAAE,EAChC,CAACwoD,GAAcC,EAAe,EAAIzoD,WAAc,IAAI,EACpD,CAAC0oD,GAAmBC,CAAoB,EAAI3oD,WAAS,EAAK,EAC1D,CAAC4oD,EAAiBC,EAAkB,EAAI7oD,WAAS,IAAI,EACrD,EAAG8oD,EAAa,EAAI9oD,WAAS,EAAK,EAElC+oD,GAAuB,SAAY,CACvChC,EAAW,EAAI,EACf,GAAI,CACF,MAAMiC,EAAU,CACd,eAAgB,mBAChB,cAAe,UAAU,aAAa,QAAQ,WAAW,CAAC,KAEhD,MAAM,MAAM,mCAAoC,CAC1D,OAAQ,OACR,QAAAA,CAAA,CACD,GACO,GACNC,EAAM,kCAAmC,CAAE,KAAM,UAAW,EAE5DA,EAAM,mBAAoB,CAAE,KAAM,QAAS,CAE/C,MAAc,CACZA,EAAM,2BAA4B,CAAE,KAAM,QAAS,CACrD,SACElC,EAAW,EAAK,CAClB,CACF,EAGM,CAACmC,GAAWC,EAAY,EAAInpD,WAAS,CAAC,EAC5C+a,YAAU,IAAM,CACd,MAAMC,EAAK,IAAMmuC,GAAc7uC,GAAMA,EAAI,CAAC,EAC1C,cAAO,iBAAiB,oBAAqBU,CAAS,EAC/C,IAAM,OAAO,oBAAoB,oBAAqBA,CAAS,CACxE,EAAG,EAAE,EACL,MAAMouC,GAAUpiD,UACd,IAAM62C,GAAiBkF,EAA+B,EACtD,CAACmG,EAAS,GAING,EAAMv9B,GAAA,EACNm9B,EAAQ3M,GAAA,EAEdvhC,YAAU,IAAM,CACd,GAAI,CAAC2sC,EAAQ,KAAM,OACnB,SAAShnC,EAAM9hB,EAAkB,CAC3BA,EAAE,MAAQ,YAAqB,CAAE,KAAM,GAAO,CACpD,CACA,gBAAS,iBAAiB,UAAW8hB,CAAK,EACnC,IAAM,SAAS,oBAAoB,UAAWA,CAAK,CAC5D,EAAG,CAACgnC,EAAQ,IAAI,CAAC,EAGjB,MAAM4B,GAAetiD,UAAQ,IAAM,CACjC,MAAMwwB,EAAU6xB,EAAI,SAAW,KACzBE,EAAe,GACrB,UAAWC,MAAQzG,GAAU,CAC3B,MAAMp7B,GAAaiQ,GAAgC4xB,GAAMhyB,CAAO,EAC1DiyB,GAAcxxB,GAA0BuxB,GAAMhyB,CAAO,EAC3D+xB,EAAM,KAAK,CAAE,KAAAC,GAAM,WAAA7hC,GAAY,YAAA8hC,GAAa,CAC9C,CACA,OAAOF,CACT,EAAG,CAACF,EAAI,OAAO,CAAC,EAGVK,GAAgB1iD,UAAQ,IAAM,CAClC,MAAM2iD,EAAc,GACpB,GAAIP,IAAW,OAAOA,IAAY,SAChC,SAAW,CAACQ,EAASjK,EAAK,IAAK,OAAO,QAAQyJ,EAAc,EAAG,CAC7D,MAAM52B,GAAImtB,GACVgK,EAAK,KAAK,CACR,MAAOC,EACP,MAAOp3B,IAAG,QAAU,EACpB,IAAKA,IAAG,KAAO,EAChB,CACH,CAEF,OAAOm3B,CACT,EAAG,CAACP,EAAO,CAAC,EAGZ,eAAeS,IAAU,CACvB,GAAI,CACF,MAAMb,EAAU,CACd,cAAe,UAAU,aAAa,QAAQ,WAAW,CAAC,IAEtD,CAACc,EAAOC,GAAWC,EAAI,EAAI,MAAM,QAAQ,IAAI,CACjD,MAAM,2BAA4B,CAAE,QAAAhB,EAAS,EAC7C,MAAM,cAAe,CAAE,QAAAA,EAAS,EAChC,MAAM,mBAAoB,CAAE,QAAAA,CAAA,CAAS,EACtC,EACD,GAAIc,EAAM,GAAI,CACZ,MAAMnrD,GAAI,MAAMmrD,EAAM,OACtB5B,EAAgB,MAAM,QAAQvpD,EAAC,EAAIA,GAAIA,GAAE,UAAY,EAAE,CACzD,CACA,GAAIorD,GAAU,GAAI,CAChB,MAAMprD,GAAI,MAAMorD,GAAU,OAC1BrD,EAAU,MAAM,QAAQ/nD,EAAC,EAAIA,GAAIA,GAAE,QAAU,EAAE,CACjD,CACA,GAAIqrD,GAAK,GAAI,CACX,MAAMrrD,GAAI,MAAMqrD,GAAK,OACrB/C,EAAe,MAAM,QAAQtoD,EAAC,EAAIA,GAAIA,GAAE,aAAeA,EAAC,CAC1D,CACF,OAASC,EAAG,CACV,QAAQ,MAAM,iBAAkBA,CAAC,CACnC,CACF,CAEA,eAAeqrD,GAAO1nD,EAAgB,CACpC,GAAI,CACF,MAAM,MAAM,qBAAsB,CAChC,OAAQ,OACR,QAAS,CACP,eAAgB,mBAChB,cAAe,UAAU,aAAa,QAAQ,WAAW,CAAC,IAE5D,KAAM,KAAK,UAAU,CAAE,MAAOA,EAAQ,EACvC,EACD,MAAMsnD,GAAA,CACR,MAAQ,CAAC,CACX,CAEA,eAAeK,GAAa7vC,EAAe8vC,EAAc,CACvD,GAAK9vC,EACL,GAAI,CACF,MAAM,MAAM,2BAA4B,CACtC,OAAQ,OACR,QAAS,CACP,eAAgB,mBAChB,cAAe,UAAU,aAAa,QAAQ,WAAW,CAAC,IAE5D,KAAM,KAAK,UAAU,CAAE,MAAAA,EAAO,KAAA8vC,EAAM,EACrC,EACD,MAAMN,GAAA,CACR,MAAQ,CAAC,CACX,CAEA,eAAeO,EAAc/vC,EAAe,CAC1C,GAAI,CACF,MAAM,MAAM,4BAA6B,CACvC,OAAQ,OACR,QAAS,CACP,eAAgB,mBAChB,cAAe,UAAU,aAAa,QAAQ,WAAW,CAAC,IAE5D,KAAM,KAAK,UAAU,CAAE,MAAAA,EAAO,EAC/B,EACD,MAAMwvC,GAAA,CACR,MAAQ,CAAC,CACX,CAEA,eAAeQ,GAAmB,CAChC,GAAKzD,EAAa,OAClB,GAAI,CACF,MAAM,MAAM,sBAAuB,CACjC,OAAQ,OACR,QAAS,CACP,eAAgB,mBAChB,cAAe,UAAU,aAAa,QAAQ,WAAW,CAAC,IAE5D,KAAM,KAAK,UAAU,CAAE,QAASA,EAAc,EAC/C,EACDC,EAAgB,EAAE,EAClB,MAAMgD,GAAA,CACR,MAAQ,CAAC,CACX,CAEA,eAAeS,EAAkBx1C,EAAe,CAC9C,GAAI,CACF,MAAM,MAAM,yBAA0B,CACpC,OAAQ,OACR,QAAS,CACP,eAAgB,mBAChB,cAAe,UAAU,aAAa,QAAQ,WAAW,CAAC,IAE5D,KAAM,KAAK,UAAU,CAAE,YAAaA,EAAM,EAC3C,EACD,MAAM+0C,GAAA,CACR,MAAQ,CAAC,CACX,CAGA9uC,YAAU,IAAM,CACd,GAAI,CAAC8U,EAAI,OACT,MAAM06B,EAAQ16B,EAAG,YAAapuB,IAAc,CAC1C,GAAI,CACF,GAAIA,IAAM,OAAS,cAAe,CAChC,MAAM+oD,GAAM,OAAO/oD,GAAK,WAAa,EAAE,EACvC,GAAI,CAAC+oD,GAAK,OACVpC,EAAenzC,KAAU,CACvB,GAAGA,GACH,CAACu1C,EAAG,EAAG,CAAE,IAAK/oD,GAAK,UAAY,UAAW,GAAI,KAAK,KAAI,CAAE,EACzD,EACF,MACF,CACA,GAAIA,IAAM,OAAS,eAAgB,CACjC,MAAMgpD,GAAMhpD,GAAK,QACjB,GAAI,CAACgpD,IAAO,CAACA,GAAI,GAAI,OACrBvC,EAAiBjzC,IAAS,CACxB,MAAMy1C,IAAYz1C,IAAQ,IAAI,OAC3B/V,IAAW,OAAOA,GAAE,EAAE,IAAM,OAAOurD,GAAI,EAAE,GAE5C,MAAO,CAACA,GAAK,GAAGC,EAAQ,CAC1B,CAAC,EACD,MACF,CACIjpD,IAAM,OAAS,wBACjBooD,GAAA,CAEJ,MAAQ,CAAC,CACX,CAAC,EACKc,EAAK,YAAY,IAAM,CAC3B,MAAM9nC,GAAM,KAAK,MACjB,IAAI+nC,GAAU,GACd,MAAM1E,GAAO,CAAE,GAAGiC,CAAA,EAClB,UAAWlqD,MAAK,OAAO,KAAKioD,EAAI,EAC1BrjC,GAAMqjC,GAAKjoD,EAAC,EAAE,GAAK,OACrB,OAAOioD,GAAKjoD,EAAC,EACb2sD,GAAU,IAGVA,MAAuB1E,EAAI,CACjC,EAAG,IAAI,EACP,MAAO,IAAM,CACX,GAAI,CACFqE,EAAA,CACF,MAAQ,CAAC,CACT,cAAcI,CAAE,CAClB,CACF,EAAG,CAAC96B,CAAE,CAAC,EAEP,eAAeg7B,GAAUplD,EAAY,CACnC,GAAI,CACF,MAAMujD,EAAU,CACd,eAAgB,mBAChB,cAAe,UAAU,aAAa,QAAQ,WAAW,CAAC,KAEhD,MAAM,MAChB,4BAA4B,mBAAmBvjD,CAAE,CAAC,SAClD,CAAE,OAAQ,OAAQ,QAAAujD,EAAS,KAAM,KAAK,UAAU,EAAE,EAAE,GAE9C,IACN,MAAMa,GAAA,CAEV,MAAQ,CAAC,CACX,CAEA,eAAeiB,GAAYrlD,EAAY,CACrC,GAAI,CACF,MAAMujD,EAAU,CACd,eAAgB,mBAChB,cAAe,UAAU,aAAa,QAAQ,WAAW,CAAC,KAEhD,MAAM,MAChB,4BAA4B,mBAAmBvjD,CAAE,CAAC,WAClD,CAAE,OAAQ,OAAQ,QAAAujD,EAAS,KAAM,KAAK,UAAU,EAAE,EAAE,GAE9C,IACN,MAAMa,GAAA,CAEV,MAAQ,CAAC,CACX,CAEA,eAAekB,IAAQ,CAChB1wC,IACL,MAAM,MAAM,oBAAqB,CAC/B,OAAQ,OACR,QAAS,CACP,eAAgB,mBAChB,cAAe,UAAU,aAAa,QAAQ,WAAW,CAAC,IAE5D,KAAM,KAAK,UAAU,CAAE,MAAAA,EAAO,EAC/B,EACDssC,EAAS,EAAE,EACb,CAEA,eAAeqE,IAAc,CAC3B,GAAK9D,EAAW,OAChB,GAAI,CACF,MAAM+D,EAAa,CACjB,cAAe,UAAU,aAAa,QAAQ,WAAW,CAAC,IAEtD9tC,EAAM,MAAM,MAChB,6BAA6B,mBAAmB+pC,CAAU,CAAC,GAC3D,CAAE,QAAS+D,CAAA,CAAW,EAExB,GAAI9tC,EAAI,GAAI,CACV,MAAM1b,GAAO,MAAM0b,EAAI,OACvBkqC,EAAe,MAAM,QAAQ5lD,GAAK,KAAK,EAAIA,GAAK,MAAQ,EAAE,CAC5D,CACF,OAAS4/B,EAAO,CACd,QAAQ,MAAM,iBAAkBA,CAAK,CACvC,CACF,CAEA,eAAe6pB,GAAQ7wC,EAAe,CACpC,GAAI,CACF,MAAM,MAAM,uBAAwB,CAClC,OAAQ,OACR,QAAS,CACP,eAAgB,mBAChB,cAAe,UAAU,aAAa,QAAQ,WAAW,CAAC,IAE5D,KAAM,KAAK,UAAU,CAAE,MAAAA,EAAO,EAC/B,EACD,MAAM2wC,GAAA,CACR,OAAS3pB,EAAO,CACd,QAAQ,MAAM,cAAeA,CAAK,CACpC,CACF,CAEA,eAAe8pB,GAAU9wC,EAAe,CACtC,GAAI,CACF,MAAM,MAAM,yBAA0B,CACpC,OAAQ,OACR,QAAS,CACP,eAAgB,mBAChB,cAAe,UAAU,aAAa,QAAQ,WAAW,CAAC,IAE5D,KAAM,KAAK,UAAU,CAAE,MAAAA,EAAO,EAC/B,EACD,MAAM2wC,GAAA,CACR,OAAS3pB,EAAO,CACd,QAAQ,MAAM,gBAAiBA,CAAK,CACtC,CACF,CAIA,eAAe+pB,IAA2B,CACxCrE,EAAW,EAAI,EACf,GAAI,CACF,MAAMrE,EAAQ,IAAI,KAAK4E,EAAW,OAAO,EAAE,UACrCnqC,EAAM,MAAM,MAAM,0BAA2B,CACjD,OAAQ,OACR,QAAS,CAAE,eAAgB,oBAC3B,KAAM,KAAK,UAAU,CACnB,MAAOmqC,EAAW,MAClB,KAAMA,EAAW,KACjB,KAAMA,EAAW,KACjB,MAAO,OAAOA,EAAW,KAAK,EAC9B,YAAaA,EAAW,YACxB,QAAS5E,EACT,eAAgB,OAAO4E,EAAW,cAAc,EAChD,SAAU,OAAOA,EAAW,QAAQ,EACpC,mBAAoB,CAAC,CAACA,EAAW,mBACjC,aAAcjuC,GAAM,MACpB,YAAaA,GAAM,SACnB,eAAgBA,GAAM,MACtB,SAAU,GACV,UAAW,UACX,YAAa,OAAOiuC,EAAW,aAAe,CAAC,EAC/C,WAAYA,EAAW,WACxB,EACF,EAED,MAAMuC,GAAA,EACN,GAAI,CAEF,MAAMpoD,GAAO,MAAM0b,EAAI,OACnB1b,IAAQA,GAAK,YAAcA,GAAK,WAAW,IAC7C,OAAO,cACL,IAAI,YAAY,iBAAkB,CAChC,OAAQ,CAAE,IAAK,cAAc,CAC9B,EAGP,MAAQ,CAAC,CACX,SACEslD,EAAW,EAAK,CAClB,CACF,CAEA,eAAesE,GAAUC,EAAaC,EAAqB,CACzDxE,EAAW,EAAI,EACf,GAAI,CACF,MAAM,MAAM,gCAAiC,CAC3C,OAAQ,OACR,QAAS,CACP,eAAgB,mBAChB,cAAe,UAAU,aAAa,QAAQ,WAAW,CAAC,IAE5D,KAAM,KAAK,UAAU,CAAE,aAAcuE,EAAK,YAAAC,EAAa,EACxD,EACD,MAAM1B,GAAA,CACR,SACE9C,EAAW,EAAK,CAClB,CACF,CAEA,eAAeyE,GAAiBF,EAAa,CAC3CvE,EAAW,EAAI,EACf,GAAI,CACF,MAAM,MAAM,gCAAiC,CAC3C,OAAQ,OACR,QAAS,CACP,eAAgB,mBAChB,cAAe,UAAU,aAAa,QAAQ,WAAW,CAAC,IAE5D,KAAM,KAAK,UAAU,CAAE,aAAcuE,EAAK,EAC3C,EACD,MAAMzB,GAAA,CACR,SACE9C,EAAW,EAAK,CAClB,CACF,CAEA,eAAe0E,IAAe,CAC5B1E,EAAW,EAAI,EACf,GAAI,CACF,MAAM,MAAM,uCAAwC,CAClD,OAAQ,OACR,QAAS,CACP,eAAgB,mBAChB,cAAe,UAAU,aAAa,QAAQ,WAAW,CAAC,IAE5D,KAAM,KAAK,UAAU,EAAE,EACxB,EACD,MAAM8C,GAAA,CACR,SACE9C,EAAW,EAAK,CAClB,CACF,CAEA,eAAe2E,GAAYjmD,EAAY,CACrCshD,EAAW,EAAI,EACf,GAAI,CACF,MAAM,MAAM,4BAA6B,CACvC,OAAQ,OACR,QAAS,CACP,eAAgB,mBAChB,cAAe,UAAU,aAAa,QAAQ,WAAW,CAAC,IAE5D,KAAM,KAAK,UAAU,CAAE,QAASthD,EAAI,EACrC,EACD,MAAMokD,GAAA,CACR,SACE9C,EAAW,EAAK,CAClB,CACF,CAEA,eAAe4E,IAAY,CACzB,GAAI,CACF,MAAMV,EAAa,CACjB,cAAe,UAAU,aAAa,QAAQ,WAAW,CAAC,IAEtD9tC,EAAM,MAAM,MAAM,kBAAmB,CAAE,QAAS8tC,EAAY,EAClE,GAAI9tC,EAAI,GAAI,CACV,MAAM1b,GAAO,MAAM0b,EAAI,OACnB1b,IAAM,IAAI8mD,GAAQ9mD,GAAK,MAAQ,EAAE,CACvC,CACF,OAAS4/B,EAAO,CACd,QAAQ,MAAM,wBAAyBA,CAAK,CAC9C,CACF,CAEA,eAAeuqB,IAAoB,CACjC,GAAI,CACF,MAAMX,EAAa,CACjB,cAAe,UAAU,aAAa,QAAQ,WAAW,CAAC,IAEtD9tC,EAAM,MAAM,MAAM,2BAA4B,CAClD,QAAS8tC,CAAA,CACV,EACD,GAAI9tC,EAAI,GAAI,CACV,MAAM1b,GAAO,MAAM0b,EAAI,OACnB1b,IAAM,IAAMA,IAAM,SACpBgnD,GAAgB,CACd,SAAUhnD,GAAK,OAAO,UAAY,GAClC,UAAWA,GAAK,OAAO,WAAa,GACpC,MAAOA,GAAK,OAAO,OAAS,GAC5B,YAAaA,GAAK,OAAO,aAAe,GACxC,WAAYA,GAAK,OAAO,YAAc,GACtC,OAAQA,GAAK,OAAO,QAAU,EAC9B,OAAQA,GAAK,OAAO,QAAU,CAAE,SAAU,GAC1C,QAASA,GAAK,OAAO,SAAW,UACjC,EACDknD,EAAqBlnD,GAAK,QAAQ,YAAc,EAAK,EAEzD,CACF,OAAS4/B,EAAO,CACd,QAAQ,MAAM,iCAAkCA,CAAK,CACvD,CACF,CAEA,eAAewqB,GAAiBC,EAAiB,CAC/C/E,EAAW,EAAI,EACf,GAAI,CAaF,MAAMtlD,GAAO,MAZD,MAAM,MAAM,wBAAyB,CAC/C,OAAQ,OACR,QAAS,CACP,eAAgB,mBAChB,cAAe,UAAU,aAAa,QAAQ,WAAW,CAAC,IAE5D,KAAM,KAAK,UAAU,CACnB,QAASqqD,EACT,WAAY,EACZ,SAAUlD,CAAA,CACX,EACF,GACsB,OACvB,QAAQ,IAAI,uBAAwBnnD,EAAI,EACpCA,IAAM,IACR,MACE,cAAcqqD,EAAS,UAAY,UAAU,gCAAgClD,EAAgB,gBAAgB,gFAE/G,MAAMgD,GAAA,GAEN,MAAM,WAAWnqD,IAAM,OAASA,IAAM,SAAW,eAAe,EAAE,CAEtE,OAAS4/B,EAAO,CACd,QAAQ,MAAM,4BAA6BA,CAAK,EAChD,MACE,8BACGA,aAAiB,MAAQA,EAAM,QAAU,OAAOA,CAAK,GAE5D,SACE0lB,EAAW,EAAK,CAClB,CACF,CAEA,eAAegF,GAAsBC,EAAqB,CACxDnD,GAAmBmD,CAAW,CAEhC,CAIA,eAAeC,IAAgB,CAC7B,GAAI,CACF,MAAMhB,EAAa,CACjB,cAAe,UAAU,aAAa,QAAQ,WAAW,CAAC,IAEtD9tC,EAAM,MAAM,MAAM,wBAAyB,CAAE,QAAS8tC,EAAY,EACxE,GAAI9tC,EAAI,GAAI,CACV,MAAMxe,GAAI,MAAMwe,EAAI,OAChBxe,IAAG,IAAI8oD,EAAa9oD,GAAE,MAAQ6oD,CAAS,CAC7C,CACF,MAAQ,CAAC,CACX,CACAzsC,YAAU,IAAM,CACV+sC,GAASmE,GAAA,CACf,EAAG,CAACnE,CAAO,CAAC,EAEZ/sC,YAAU,IAAM,CACV+sC,IAAYF,IAAc,WAAaA,IAAc,iBACvD+D,GAAA,EACAC,GAAA,EAEJ,EAAG,CAAC9D,EAASF,CAAS,CAAC,EAEvB,eAAesE,GAAcC,EAAcnX,EAAc,CACvD,MAAM,MAAM,wBAAyB,CACnC,OAAQ,OACR,QAAS,CACP,eAAgB,mBAChB,cAAe,UAAU,aAAa,QAAQ,WAAW,CAAC,IAE5D,KAAM,KAAK,UAAU,CAAE,KAAAmX,EAAM,GAAGnX,EAAS,EAC1C,EACD,MAAMiX,GAAA,CACR,CAEA,eAAeG,GAAkBD,EAAcE,EAAwB,CACrE,GAAI,CACF,MAAMpB,GAAa,CACjB,cAAe,UAAU,aAAa,QAAQ,WAAW,CAAC,IAMtDqB,GAAO,MAJD,MAAM,MAChB,2BAA2B,mBAAmBH,CAAI,CAAC,GACnD,CAAE,QAASlB,EAAA,CAAW,GAED,OACvB,GAAIoB,EAAc,CAChB,MAAM15C,GAAI,OAAO,OACjB,GAAIA,GAAG,CACLA,GAAE,SAAS,OACXA,GAAE,SAAS,MAAM25C,EAAI,EACrB35C,GAAE,SAAS,QACX,MACF,CACF,CACAg1C,EAAW,CAAE,KAAM,GAAM,KAAAwE,EAAM,KAAAG,GAAM,CACvC,MAAQ,CACN3E,EAAW,CACT,KAAM,GACN,KAAAwE,EACA,KAAM,+GACP,CACH,CACF,CAEApxC,YAAU,IAAM,CACd,GAAI,CAAC2sC,EAAQ,KAAM,OACnB,SAAShnC,EAAM9hB,EAAkB,CAC3BA,EAAE,MAAQ,YAAqB,CAAE,KAAM,GAAO,CACpD,CACA,gBAAS,iBAAiB,UAAW8hB,CAAK,EACnC,IAAM,SAAS,oBAAoB,UAAWA,CAAK,CAC5D,EAAG,CAACgnC,EAAQ,IAAI,CAAC,EAEjB,SAAS6E,GAAY,CAAE,KAAAJ,EAAM,MAAAnrC,GAA0C,CAOrE,MAAMyB,GAAM+kC,IALV2E,IAAS,gBACL,eACAA,IAAS,UACP,UACAA,CACmB,GAAK,CAAE,MAAO,GAAI,MAAO,GAAI,YAAa,IAC/D,CAACK,GAAOC,EAAQ,EAAIzsD,WAASyiB,GAAI,OAAS,EAAE,EAC5C,CAACiqC,GAAOC,EAAQ,EAAI3sD,WAASyiB,GAAI,OAAS,EAAE,EAC5C,CAACmqC,GAAKC,EAAM,EAAI7sD,WAASyiB,GAAI,aAAe,EAAE,EACpD1H,mBAAU,IAAM,CACd0xC,GAAShqC,GAAI,OAAS,EAAE,EACxBkqC,GAASlqC,GAAI,OAAS,EAAE,EACxBoqC,GAAOpqC,GAAI,aAAe,EAAE,CAC9B,EAAG,CAACA,GAAI,MAAOA,GAAI,MAAOA,GAAI,WAAW,CAAC,EAGxCtB,OAAC,OAAI,UAAU,oCACb,UAAAC,MAAC,OAAI,UAAU,gBAAiB,SAAAJ,EAAM,EACtCI,MAAC,SACC,UAAU,eACV,YAAY,mBACZ,MAAOorC,GACP,SAAW5tD,IAAM6tD,GAAS7tD,GAAE,OAAO,KAAK,IAE1CwiB,MAAC,YACC,UAAU,eACV,KAAM,EACN,YAAY,wBACZ,MAAOsrC,GACP,SAAW9tD,IAAM+tD,GAAS/tD,GAAE,OAAO,KAAK,IAE1CwiB,MAAC,SACC,UAAU,eACV,YAAY,0BACZ,MAAOwrC,GACP,SAAWhuD,IAAMiuD,GAAOjuD,GAAE,OAAO,KAAK,IAExCuiB,OAAC,OAAI,UAAU,yBACb,UAAAC,MAAC,UACC,UAAU,MACV,KAAK,SACL,QAAS,IAAMgrC,GAAkBD,EAAM,EAAI,EAC5C,qBAGD/qC,MAAC,UACC,UAAU,MACV,KAAK,SACL,QAAS,IAAMgrC,GAAkBD,CAAI,EACtC,mBAGD/qC,MAAC,UACC,UAAU,MACV,QAAS,IACP8qC,GAAcC,EAAM,CAAE,MAAAK,GAAO,MAAAE,GAAO,YAAaE,GAAK,EAEzD,iBAED,EACF,GACF,CAEJ,CAEA,OAAK9E,EAYH3mC,OAAC,OAAI,UAAU,wCACb,UAAAA,OAAC,OAAI,UAAU,oEACb,UAAAA,OAAC,OACC,UAAAC,MAAC,MAAG,UAAU,kEAAkE,qBAEhF,EACAA,MAAC,KAAE,UAAU,4BAA4B,2CAEzC,GACF,EACAD,OAAC,OAAI,UAAU,mCAEb,UAAAC,MAACoiC,GAAA,EAAkB,EAClB3zB,GAAOA,EAAW,WACjBzO,MAAC,UACC,QAAS,IAAOyO,EAAW,YAC3B,UAAU,uGACV,MAAM,oDACP,wBAED,EAEJ,GACF,EAECo4B,EAAa,OAAS,GACrB9mC,OAAC,OAAI,UAAU,iEACb,UAAAA,OAAC,OAAI,UAAU,oCACb,UAAAA,OAAC,OAAI,UAAU,0BACb,UAAAC,MAAC,QAAK,UAAU,gBAAgB,iCAAqB,EACrDD,OAAC,QAAK,UAAU,qBACb,UAAA8mC,EAAa,OAAO,SACvB,GACF,EACA9mC,OAAC,OAAI,UAAU,0BACb,UAAAC,MAAC,UACC,UAAU,MACV,QAAS,IAAMknC,GAAmBL,EAAa,CAAC,CAAC,EAClD,yBAGD7mC,MAAC,UAAO,UAAU,gBAAgB,QAAS,IAAMyoC,GAAA,EAAW,mBAE5D,GACF,GACF,EACAzoC,MAAC,OAAI,UAAU,kCACZ,SAAA6mC,EAAa,MAAM,EAAG,CAAC,EAAE,IAAK6E,GAC7B3rC,OAAC,OAEC,UAAU,+DAEV,UAAAC,MAAC,OAAI,UAAU,cAAe,SAAA0rC,EAAG,UAAY,YAAY,EACzD1rC,MAAC,OAAI,UAAU,qBACZ,aAAI,KAAK0rC,EAAG,IAAM,CAAC,EAAE,oBAAmB,CAC3C,EACA1rC,MAAC,OAAI,UAAU,wBAAyB,WAAG,QAAQ,EACnDD,OAAC,OAAI,UAAU,kBACZ,UAAA2rC,EAAG,SAAW,OACb1rC,MAAC,UAAO,UAAU,MAAM,QAAS,IAAMypC,GAAUiC,EAAG,EAAE,EAAG,iBAEzD,EAEA3rC,OAAC,QAAK,UAAU,qBACb,UAAA2rC,EAAG,OAAO,OAAKA,EAAG,WAAa,KAClC,EAEF1rC,MAAC,UACC,UAAU,MACV,QAAS,IAAMknC,GAAmBwE,CAAE,EACrC,iBAED,EACF,IAxBKA,EAAG,GA0BX,EACH,GACF,EAEDhF,GACC1mC,MAAC27B,GAAA,CACC,KAAM,CACJ,CAAE,IAAK,UAAW,MAAO,WACzB,CAAE,IAAK,cAAe,MAAO,eAC7B,CAAE,IAAK,UAAW,MAAO,WACzB,CAAE,IAAK,WAAY,MAAO,YAC1B,CAAE,IAAK,WAAY,MAAO,YAAY,EAExC,OAAQ6K,EACR,SAAW7mC,GACT8mC,EACE9mC,CAAA,EAQJ,UAAU,SAEX,IACF6mC,IAAc,WACbzmC,OAAAja,WAAA,CACG,UAAA4gD,GACC3mC,OAAC,OAAI,UAAU,OACb,UAAAC,MAAC,MAAG,UAAU,6BAA6B,sBAAU,EACrDD,OAAC,OAAI,UAAU,8DACb,UAAAC,MAACs7B,GAAA,CACC,KAAMgN,GAAO,IAAK/qD,IAAO,CAAE,MAAO,GAAI,MAAOA,EAAE,OAAQ,IAEzDyiB,MAAC,OAAI,UAAU,kGACZ,YAAO,IAAI,CAACziB,EAAGsC,IACdkgB,OAAC,OAEC,UAAU,2FAEV,UAAAC,MAAC,QAAK,UAAU,gBAAiB,SAAAziB,EAAE,MAAM,EACzCwiB,OAAC,QAAK,UAAU,oBAAoB,oBAC1BxiB,EAAE,MAAM,UAAQA,EAAE,KAC5B,IANKsC,CAAA,CAQR,EACH,GACF,GACF,EAGD6mD,GACC3mC,OAAC,OAAI,UAAU,OACb,UAAAC,MAAC,MAAG,UAAU,6BAA6B,sCAE3C,EACAA,MAAC,OAAI,UAAU,0BAA0B,iHAGzC,EACAA,MAAC,OAAI,UAAU,2DACb,SAAAA,MAAC,OAAI,UAAU,kFACZ,SAAAkoC,GAAa,IAAK5nD,GAAS,CAC1B,MAAMqrD,EACJrrD,EAAK,YAAc,GACf,2DACAA,EAAK,YAAc,GACjB,qDACA,kDACR,OACEyf,OAAC,OAEC,UAAW,+BAA+B4rC,CAAU,GAEpD,UAAA3rC,MAAC,OAAI,UAAU,iCACZ,SAAA1f,EAAK,KACR,QACC,OAAI,UAAU,kCACZ,SAAAA,EAAK,YAAY,QACpB,EACAyf,OAAC,OAAI,UAAU,+BACZ,eAAK,MAAMzf,EAAK,UAAU,EAAE,KAC/B,IAXKA,EAAK,KAchB,CAAC,EACH,EACF,GACF,EAGFyf,OAAC,OAAI,UAAU,OACb,UAAAC,MAAC,MAAG,UAAU,0BAA0B,4BAAgB,EACxDA,MAAC,OAAI,UAAU,0BAA0B,6FAGzC,EACAD,OAAC,OAAI,UAAU,kBACb,UAAAC,MAAC,SACC,UAAU,eACV,YAAY,mBACZ,MAAO/G,EACP,SAAWzb,GAAM+nD,EAAS/nD,EAAE,OAAO,KAAK,IAE1CwiB,MAAC,UAAO,UAAU,MAAM,SAAU0lC,EAAS,QAASiE,GAAO,iBAE3D,EACA3pC,MAAC,UACC,UAAU,oCACV,SAAU0lC,EACV,QAAS,IAAMmD,GAAO5vC,CAAK,EAC5B,mBAED,EACF,EACA+G,MAAC,OAAI,UAAU,0BAA0B,2BAAe,QACvD,OAAI,UAAU,4BACZ,SAAAqlC,EAAO,IAAKuG,GACX5rC,MAAC,OAEC,UAAU,yEAET,SAAA4rC,CAAA,EAHIA,CAAA,CAKR,EACH,EAEA5rC,MAAC,MAAG,UAAU,4BAA4B,EAE1CA,MAAC,MAAG,UAAU,6BAA6B,kCAE3C,EACAA,MAAC,OAAI,UAAU,0BAA0B,kFAGzC,EACAD,OAAC,OAAI,UAAU,kBACb,UAAAC,MAAC,SACC,UAAU,eACV,YAAY,mBACZ,MAAO/G,EACP,SAAWzb,GAAM+nD,EAAS/nD,EAAE,OAAO,KAAK,IAE1CwiB,MAAC,UACC,UAAU,0CACV,SAAU0lC,GAAW,CAACzsC,EAAM,OAC5B,QAAS,IAAM6vC,GAAa7vC,EAAO,EAAE,EACtC,2BAGD+G,MAAC,UACC,UAAU,oCACV,SAAU0lC,EACV,QAAS,IAAMsD,EAAc/vC,CAAK,EACnC,2BAED,EACF,EACA+G,MAAC,OAAI,UAAU,qBAAqB,+EAGpC,GACF,EAEAD,OAAC,OAAI,UAAU,OACb,UAAAC,MAAC,MAAG,UAAU,uCAAuC,4BAErD,EACAA,MAAC,OAAI,UAAU,0BAA0B,kFAGzC,EACAD,OAAC,OAAI,UAAU,aACb,UAAAC,MAAC,SACC,UAAU,eACV,YAAY,0BACZ,MAAOwlC,EACP,SAAWhoD,GAAMioD,EAAgBjoD,EAAE,OAAO,KAAK,IAEjDwiB,MAAC,UACC,UAAU,MACV,SAAU0lC,GAAW,CAACF,EAAa,OACnC,QAASyD,EACV,iBAED,EACF,GACF,EAEAlpC,OAAC,OAAI,UAAU,OACb,UAAAC,MAAC,MAAG,UAAU,6BAA6B,uBAAW,EACtDA,MAAC,OAAI,UAAU,0BAA0B,8CAEzC,EACAD,OAAC,OAAI,UAAU,kBACb,UAAAC,MAAC,SACC,UAAU,eACV,YAAY,kBACZ,MAAO8lC,EACP,SAAWtoD,GAAMuoD,EAAcvoD,EAAE,OAAO,KAAK,IAE/CwiB,MAAC,UAAO,UAAU,MAAM,SAAU0lC,EAAS,QAASkE,GAAa,kBAEjE,GACF,EACC5D,EAAY,OAAS,GACpBjmC,OAAC,OAAI,UAAU,YACb,UAAAC,MAAC,OAAI,UAAU,0BAA0B,oBAAQ,EAChDgmC,EAAY,IAAKttC,GAChBsH,MAAC,OAEC,UAAU,oEAEV,gBAAC,OACC,UAAAA,MAAC,OAAI,UAAU,gBAAiB,SAAAtH,EAAE,MAAQ,UAAU,EACpDsH,MAAC,OAAI,UAAU,aAAc,WAAE,MAAM,EACrCD,OAAC,OAAI,UAAU,qBAAqB,oBAC1B,IAAI,KAAKrH,EAAE,SAAS,EAAE,oBAAmB,EACnD,GACF,GATKA,EAAE,MAWV,GACH,GAEJ,EAECguC,GACC3mC,OAAC,OAAI,UAAU,OACb,UAAAC,MAAC,MAAG,UAAU,6BAA6B,2BAAe,EAC1DA,MAAC,OAAI,UAAU,0BAA0B,qGAGzC,EACAD,OAAC,OAAI,UAAU,wCACb,UAAAC,MAACmrC,GAAA,CAAY,KAAK,QAAQ,MAAM,iBAAiB,EACjDnrC,MAACmrC,GAAA,CAAY,KAAK,WAAW,MAAM,0BAA0B,EAC7DnrC,MAACmrC,GAAA,CAAY,KAAK,gBAAgB,MAAM,oBAAoB,EAC5DnrC,MAACmrC,GAAA,CAAY,KAAK,UAAU,MAAM,0BAA0B,GAC9D,GACF,GAEJ,EAED3E,IAAc,eAAiBE,GAC9B3mC,OAAAja,WAAA,CACE,UAAAia,OAAC,OAAI,UAAU,OACb,UAAAC,MAAC,MAAG,UAAU,6BAA6B,2BAAe,EAC1DA,MAAC,OAAI,UAAU,0BAA0B,iDAEzC,EACAD,OAAC,OAAI,UAAU,kBACb,UAAAC,MAAC,SACC,UAAU,eACV,YAAY,mBACZ,MAAO8lC,EACP,SAAWtoD,GAAMuoD,EAAcvoD,EAAE,OAAO,KAAK,IAE/CwiB,MAAC,UAAO,UAAU,MAAM,SAAU0lC,EAAS,QAASkE,GAAa,kBAEjE,GACF,EACC5D,EAAY,OAAS,GACpBjmC,OAAC,OAAI,UAAU,YACb,UAAAC,MAAC,OAAI,UAAU,0BAA0B,oBAAQ,EAChDgmC,EAAY,IAAKttC,GAChBqH,OAAC,OAEC,UAAU,oEAEV,UAAAA,OAAC,OACC,UAAAC,MAAC,OAAI,UAAU,gBAAiB,SAAAtH,EAAE,MAAQ,UAAU,EACpDsH,MAAC,OAAI,UAAU,aAAc,WAAE,MAAM,EACrCD,OAAC,OAAI,UAAU,qBAAqB,oBAC1B,IAAI,KAAKrH,EAAE,SAAS,EAAE,oBAAmB,EACnD,GACF,EACAqH,OAAC,OAAI,UAAU,aACb,UAAAC,MAAC,UACC,UAAU,0CACV,QAAS,IAAM8pC,GAAQpxC,EAAE,KAAK,EAC/B,iBAGDsH,MAAC,UACC,UAAU,8CACV,QAAS,IAAM+pC,GAAUrxC,EAAE,KAAK,EACjC,kBAED,EACF,IAvBKA,EAAE,MAyBV,GACH,GAEJ,EAEAqH,OAAC,OAAI,UAAU,OACb,UAAAC,MAAC,MAAG,UAAU,6BAA6B,yBAAa,EACxDA,MAAC,OAAI,UAAU,0BAA0B,6DAEzC,EACConC,GACCrnC,OAAC,OAAI,UAAU,wCACb,UAAAA,OAAC,OAAI,UAAU,YACb,UAAAA,OAAC,OAAI,UAAU,oCACb,UAAAC,MAAC,QAAK,oBAAQ,EACdA,MAAC,QACC,UAAW,6BAA6BonC,GAAa,SAAW,iBAAmB,YAAY,GAE9F,SAAAA,GAAa,SAAW,QAAU,QACrC,EACF,EACArnC,OAAC,OAAI,UAAU,oCACb,UAAAC,MAAC,QAAK,qBAAS,EACfA,MAAC,QACC,UAAW,6BAA6BonC,GAAa,UAAY,iBAAmB,YAAY,GAE/F,SAAAA,GAAa,UAAY,QAAU,QACtC,EACF,EACArnC,OAAC,OAAI,UAAU,oCACb,UAAAC,MAAC,QAAK,iBAAK,EACXA,MAAC,QACC,UAAW,6BAA6BonC,GAAa,MAAQ,iBAAmB,cAAc,GAE7F,SAAAA,GAAa,MAAQ,UAAY,aACpC,EACF,EACArnC,OAAC,OAAI,UAAU,oCACb,UAAAC,MAAC,QAAK,4BAAgB,EACtBA,MAAC,QACC,UAAW,6BAA8BonC,GAAa,YAAiC,aAAnB,gBAA+B,GAElG,SAACA,GAAa,YAAyB,SAAX,QAAW,EAC1C,EACF,EACArnC,OAAC,OAAI,UAAU,oCACb,UAAAC,MAAC,QAAK,qCAAyB,EAC/BA,MAAC,QACC,UAAW,6BAA6BsnC,GAAoB,iBAAmB,cAAc,GAE5F,YAAoB,UAAY,YACnC,EACF,GACF,EACAvnC,OAAC,OAAI,UAAU,YACb,UAAAA,OAAC,OAAI,UAAU,UACb,UAAAC,MAAC,QAAK,UAAU,gBAAgB,mBAAO,EAAQ,IAC9C,KAAK,MAAMonC,GAAa,OAAS,IAAI,EAAE,IAAE,IACzC,KAAK,MAAOA,GAAa,OAAS,KAAQ,EAAE,EAAE,KACjD,EACArnC,OAAC,OAAI,UAAU,UACb,UAAAC,MAAC,QAAK,UAAU,gBAAgB,mBAAO,EAAQ,IAC9ConC,GAAa,OACV,KAAK,MAAMA,GAAa,OAAO,SAAW,KAAO,IAAI,EACrD,IAAI,WAEV,EACArnC,OAAC,OAAI,UAAU,UACb,UAAAC,MAAC,QAAK,UAAU,gBAAgB,oBAAQ,EAAQ,IAC/ConC,GAAa,SAChB,EACArnC,OAAC,OAAI,UAAU,uBACb,UAAAC,MAAC,UAAO,UAAU,MAAM,QAASwqC,GAAmB,mBAEpD,EACAzqC,OAAC,UACC,UAAW,OAAOunC,GAAoB,kCAAoC,qCAAqC,GAC/G,SAAU5B,EACV,QAAS,IAAM+E,GAAiB,CAACnD,EAAiB,EAEjD,UAAAA,GAAoB,UAAY,SAAS,gBAC5C,EACF,GACF,GACF,EAEAvnC,OAAC,OAAI,UAAU,mBACb,UAAAC,MAAC,OAAI,UAAU,0BAA0B,oCAEzC,QACC,UAAO,UAAU,MAAM,QAASwqC,GAAmB,8BAEpD,GACF,EAGFzqC,OAAC,OAAI,UAAU,qCACb,UAAAC,MAAC,MAAG,UAAU,qBAAqB,+BAAmB,EACtDD,OAAC,OAAI,UAAU,YACb,UAAAA,OAAC,OACC,UAAAA,OAAC,OAAI,UAAU,yCACb,UAAAC,MAAC,SAAM,UAAU,gBAAgB,gCAEjC,EACAD,OAAC,OAAI,UAAU,aACb,UAAAC,MAAC,UACC,UAAU,MACV,QAAS,IAAM0nC,GAAc,EAAK,EACnC,mBAGD1nC,MAAC,UACC,UAAU,MACV,QAAS2nC,GACT,SAAU,CAACjB,GAAWhB,EACvB,4BAED,EACF,GACF,EACA1lC,MAAC,SACC,KAAK,QACL,IAAI,OACJ,IAAI,QACJ,KAAK,MACL,MAAOwnC,EACP,SAAWhqD,GACTmtD,GAAsB,OAAOntD,EAAE,OAAO,KAAK,CAAC,EAE9C,SAAUkoD,EACV,UAAU,mHACV,MAAO,CACL,WAAY4B,GACR,kDAAmDE,EAAkB,MAAS,MAAiB,GAAG,eAAgBA,EAAkB,MAAS,MAAiB,GAAG,mBACjK,UACN,GAEFznC,OAAC,OAAI,UAAU,+CACb,UAAAC,MAAC,QAAK,gBAAI,EACVA,MAAC,QAAK,eAAG,GACX,GACF,EACAA,MAAC,OAAI,UAAU,uBACb,SAAAD,OAAC,UACC,UAAW,OAAOunC,GAAoB,kCAAoC,qCAAqC,GAC/G,SAAU5B,EACV,QAAS,IAAM+E,GAAiB,CAACnD,EAAiB,EAEjD,UAAAA,GAAoB,UAAY,SAAS,gBAC5C,CACF,GACF,EACAvnC,OAAC,OAAI,UAAU,iDAAiD,mEACP,IACtDynC,EAAgB,iBAAiB,gKAIpC,GACF,GACF,EAEAznC,OAAC,OAAI,UAAU,OACb,UAAAC,MAAC,MAAG,UAAU,6BAA6B,wBAAY,EACvDD,OAAC,MAAG,UAAU,YACX,UAAA6mC,EAAQ,IAAK9oD,GACZkiB,MAAC,MAAc,UAAU,kCACvB,SAAAD,OAAC,OAAI,UAAU,oCACb,UAAAA,OAAC,OACC,UAAAC,MAAC,OAAI,UAAU,oBAAqB,SAAAliB,EAAE,GAAG,SACxC,OACC,UAAAkiB,MAAC,QAAK,UAAU,gBAAiB,SAAAliB,EAAE,SAAS,EAAO,KAAG,IACtDkiB,MAAC,QAAK,UAAU,gBAAiB,WAAE,SAAS,EAAO,KAAG,IACrD,IAAI,KAAKliB,EAAE,EAAE,EAAE,gBAAe,EACjC,EACAiiB,OAAC,OAAI,UAAU,aAAa,qBAASjiB,EAAE,QAAO,EAC7CA,EAAE,WACDiiB,OAAC,OAAI,UAAU,qBAAqB,yBACrBjiB,EAAE,WACjB,GAEJ,EACAiiB,OAAC,OAAI,UAAU,aACb,UAAAC,MAAC,QACC,UAAW,+BAA+BliB,EAAE,SAAW,OAAS,eAAiB,gBAAgB,GAEhG,SAAAA,EAAE,SAEJA,EAAE,SAAW,QACZiiB,OAAAja,WAAA,CACE,UAAAka,MAAC,UACC,UAAU,0CACV,SAAU0lC,EACV,QAAS,SAAY,CACnB,MAAM,MAAM,6BAA8B,CACxC,OAAQ,OACR,QAAS,CACP,eAAgB,mBAChB,cAAe,UAAU,aAAa,QAAQ,WAAW,CAAC,IAE5D,KAAM,KAAK,UAAU,CACnB,GAAI5nD,EAAE,GACN,OAAQ,WACT,EACF,EACD,MAAM2qD,GAAA,CACR,EACD,qBAGDzoC,MAAC,UACC,UAAU,oCACV,SAAU0lC,EACV,QAAS,SAAY,CACnB,MAAMmG,EACJ,OACE,yDACG,GACP,MAAM,MAAM,6BAA8B,CACxC,OAAQ,OACR,QAAS,CACP,eAAgB,mBAChB,cAAe,UAAU,aAAa,QAAQ,WAAW,CAAC,IAE5D,KAAM,KAAK,UAAU,CACnB,GAAI/tD,EAAE,GACN,OAAQ,WACR,MAAA+tD,CAAA,CACD,EACF,EACD,MAAMpD,GAAA,CACR,EACD,mBAED,EACF,GAEJ,GACF,GAxEO3qD,EAAE,EAyEX,CACD,EACA8oD,EAAQ,SAAW,SACjB,MAAG,UAAU,aAAa,uBAAW,GAE1C,GACF,EAEA7mC,OAAC,OAAI,UAAU,OACb,UAAAC,MAAC,MAAG,UAAU,6BAA6B,wBAAY,EACvDD,OAAC,MAAG,UAAU,YACV,WAAAonB,GAAQ,SAAW,IAAI,IAAKpqC,GAC5BgjB,OAAC,MAEC,UAAU,oEAEV,UAAAA,OAAC,OAAI,UAAU,0BACb,UAAAC,MAAC,QAAK,UAAU,oBAAqB,SAAAjjB,EAAE,GAAG,EAC1CijB,MAAC,QAAK,UAAU,aAAc,WAAE,YAAY,EAC5CD,OAAC,QAAK,UAAU,aACb,UAAAhjB,EAAE,KAAK,MAAIilD,GAAajlD,EAAE,IAAI,EAAE,IAAEA,EAAE,MAAO,IAC3CA,EAAE,OAAS,MAAQ,IAAIA,EAAE,aAAa,GAAK,IAC9C,GACF,EACAijB,MAAC,UACC,UAAU,oCACV,SAAU0lC,EACV,QAAS,IAAM4E,GAAYvtD,EAAE,EAAE,EAChC,mBAED,GAjBKA,EAAE,GAmBV,GACC,CAACoqC,GAAQ,SAAWA,EAAO,QAAQ,SAAW,IAC9CnnB,MAAC,MAAG,UAAU,qBAAqB,4BAAgB,GAEvD,GACF,EAEAD,OAAC,OAAI,UAAU,OACb,UAAAC,MAAC,MAAG,UAAU,6BAA6B,gCAAoB,EAC/DA,MAAC,OAAI,UAAU,uCAAuC,oGAGtD,EACAD,OAAC,OAAI,UAAU,wCACb,UAAAA,OAAC,OACC,UAAAC,MAAC,OAAI,UAAU,kCAAkC,+BAEjD,EACAD,OAAC,MAAG,UAAU,YACX,UAAA6lC,EAAY,IAAK7nD,GAChBgiB,OAAC,MAEC,UAAU,6DAEV,UAAAA,OAAC,OAAI,UAAU,oCACb,UAAAC,MAAC,OAAI,UAAU,gBAAiB,SAAAjiB,EAAE,MAAM,EACxCiiB,MAAC,OAAI,UAAU,aAAc,WAAE,OAAO,GACxC,EACAD,OAAC,OAAI,UAAU,aACZ,UAAAhiB,EAAE,KAAK,MAAIikD,GAAajkD,EAAE,IAAI,EAAE,IAAEA,EAAE,OACvC,EACAiiB,MAAC,OAAI,UAAU,OACb,SAAAA,MAAC,UACC,UAAU,0CACV,SAAU0lC,EACV,QAAS,IAAM0E,GAAiBrsD,EAAE,EAAE,EACrC,8BAED,CACF,IAlBKA,EAAE,GAoBV,EACA6nD,EAAY,SAAW,SACrB,MAAG,UAAU,aAAa,2BAAe,GAE9C,GACF,SACC,OACC,UAAA5lC,MAAC,OAAI,UAAU,kCAAkC,8BAEjD,QACC,OAAI,UAAU,YACb,SAAAD,OAAC,OAAI,UAAU,qDACb,UAAAC,MAAC,OAAI,UAAU,kCAAkC,4BAEjD,EACAA,MAAC,OAAI,UAAU,0BAA0B,6GAGzC,EACAD,OAAC,OAAI,UAAU,0BACb,UAAAC,MAAC,QACC,UAAW,6BAA6BmnB,GAAQ,YAAc,aAAe,cAAc,GAE1F,SAAAA,GAAQ,YACL,qBACA,qBAENnnB,MAAC,UACC,UAAW,OAAOmnB,GAAQ,YAAc,kCAAoC,6BAA6B,GACzG,SAAUue,EACV,QAAS,IAAMwD,EAAkB,CAAC/hB,GAAQ,WAAW,EAEpD,SAAAA,GAAQ,YAAc,UAAY,UACrC,EACF,GACF,EACF,GACF,GACF,GACF,EACC8f,IACCjnC,MAACmjC,GAAA,CACC,QAAS8D,GACT,KAAM,CACJ,MAAOhvC,GAAM,MACb,SAAUA,GAAM,SAChB,QAAS,IAEX,QAAS,IAAMivC,GAAmB,IAAI,GACxC,EAEJ,EAEDV,IAAc,WAAaE,GAC1B3mC,OAAAja,WAAA,CACE,UAAAia,OAAC,OAAI,UAAU,OACb,UAAAC,MAAC,MAAG,UAAU,6BAA6B,uCAE3C,EACAA,MAAC,OAAI,UAAU,0BAA0B,6EAEzC,EACAD,OAAC,OAAI,UAAU,kBACb,UAAAC,MAAC,SACC,UAAU,eACV,YAAY,mBACZ,MAAO/G,EACP,SAAWzb,GAAM+nD,EAAS/nD,EAAE,OAAO,KAAK,IAE1CwiB,MAAC,UACC,UAAU,MACV,SAAU0lC,GAAW,CAACzsC,EAAM,OAC5B,QAAS,IAAM6vC,GAAa7vC,EAAO,EAAE,EACtC,mBAGD+G,MAAC,UACC,UAAU,oCACV,SAAU0lC,EACV,QAAS,IAAMsD,EAAc/vC,CAAK,EACnC,mBAED,EACF,EACA+G,MAAC,OAAI,UAAU,0BAA0B,gEAEzC,GACF,EAEAD,OAAC,OAAI,UAAU,OACb,UAAAC,MAAC,MAAG,UAAU,6BAA6B,2BAAe,EAC1DA,MAAC,OAAI,UAAU,0BAA0B,2DAEzC,EACAD,OAAC,OAAI,UAAU,YACZ,UAAA4mC,EAAQ,IAAKp1C,GACZwO,OAAC,OAEC,UAAU,oEAEV,UAAAA,OAAC,OACC,UAAAC,MAAC,OAAI,UAAU,gBAAiB,SAAAzO,EAAE,MAAQ,UAAU,EACpDyO,MAAC,OAAI,UAAU,aAAc,WAAE,MAAM,EACrCD,OAAC,OAAI,UAAU,qBAAqB,qBACzB,IAAI,KAAKxO,EAAE,SAAS,EAAE,oBAAmB,EACpD,GACF,QACC,OAAI,UAAU,aACZ,SAACA,EAAE,QAKFyO,MAAC,QAAK,UAAU,yCAAyC,2BAEzD,EANAA,MAAC,QAAK,UAAU,2CAA2C,0BAE3D,CAIA,CAEJ,IApBKzO,EAAE,MAsBV,EACAo1C,EAAQ,SAAW,SACjB,OAAI,UAAU,aAAa,+BAAmB,GAEnD,GACF,GACF,EAEDH,IAAc,YAAcE,GAC3B3mC,OAAAja,WAAA,CACE,UAAAia,OAAC,OAAI,UAAU,OACb,UAAAC,MAAC,MAAG,UAAU,6BAA6B,sCAE3C,EACAA,MAAC,OAAI,UAAU,0BAA0B,mFAGzC,EACAD,OAAC,OAAI,UAAU,YACb,UAAAC,MAAC,SACC,UAAU,eACV,YAAY,mBACZ,MAAOkmC,EAAW,MAClB,SAAW1oD,GACT2oD,EAAexpD,IAAY,CAAE,GAAGA,EAAG,MAAOa,EAAE,OAAO,OAAQ,IAG/DuiB,OAAC,OAAI,UAAU,yBACb,UAAAC,MAAC,UACC,UAAU,QACV,MAAOkmC,EAAW,KAClB,SAAW1oD,GACT2oD,EAAexpD,IAAY,CAAE,GAAGA,EAAG,KAAMa,EAAE,OAAO,OAAQ,EAG3D,UACC,MACA,mBACA,UACA,WACA,WACA,YACA,IAAKH,GACL2iB,MAAC,UAAe,MAAO3iB,EACpB,SAAAA,CAAA,EADUA,CAEb,CACD,IAEH2iB,MAAC,UACC,UAAU,QACV,MAAOkmC,EAAW,KAClB,SAAW1oD,GACT2oD,EAAexpD,IAAY,CAAE,GAAGA,EAAG,KAAMa,EAAE,OAAO,OAAQ,EAG3D,SAAAskD,GAAsBoE,EAAW,IAAI,EAAE,IAAKjE,SAC1C,UAAyB,MAAO,OAAOA,CAAG,EACxC,YAAa,OAAOA,CAAG,CAAC,GADd,OAAOA,CAAG,CAEvB,CACD,KAED,IAAM,CACN,MAAM6J,EAAO/J,GACXmE,EAAW,KACXA,EAAW,MAEb,OAAI4F,GAAQA,EAAK,OAAS,EAEtB9rC,MAAC,UACC,UAAU,QACV,MAAO,OAAOkmC,EAAW,KAAK,EAC9B,SAAW1oD,GACT2oD,EAAexpD,KAAY,CACzB,GAAGA,GACH,MAAO,OAAOa,EAAE,OAAO,KAAK,GAC5B,EAGH,SAAAsuD,EAAK,IAAK5yC,GACT8G,MAAC,UAAe,MAAO,OAAO9G,CAAC,EAC5B,SAAAA,CAAA,EADUA,CAEb,CACD,IAKL8G,MAAC,SACC,UAAU,QACV,KAAK,SACL,IAAK,EACL,MAAOkmC,EAAW,MAClB,SAAW1oD,GACT2oD,EAAexpD,KAAY,CACzB,GAAGA,GACH,MAAO,OAAOa,EAAE,OAAO,KAAK,GAC5B,GAIV,IAAG,EACL,EACAwiB,MAAC,YACC,UAAU,eACV,KAAM,EACN,YAAY,cACZ,MAAOkmC,EAAW,YAClB,SAAW1oD,GACT2oD,EAAexpD,IAAY,CACzB,GAAGA,EACH,YAAaa,EAAE,OAAO,OACtB,IAGNuiB,OAAC,OAAI,UAAU,yBACb,UAAAC,MAAC,SACC,UAAU,QACV,KAAK,iBACL,MAAOkmC,EAAW,QAClB,SAAW1oD,GACT2oD,EAAexpD,IAAY,CACzB,GAAGA,EACH,QAASa,EAAE,OAAO,OAClB,IAGNwiB,MAAC,SACC,UAAU,QACV,KAAK,SACL,IAAK,EACL,YAAY,kBACZ,MAAOkmC,EAAW,eAClB,SAAW1oD,GACT2oD,EAAexpD,IAAY,CACzB,GAAGA,EACH,eAAgB,OAAOa,EAAE,OAAO,KAAK,GACrC,GAEN,EACF,EACAwiB,MAAC,SACC,UAAU,eACV,KAAK,SACL,IAAK,EACL,IAAK,GACL,YAAY,WACZ,MAAOkmC,EAAW,SAClB,SAAW1oD,GACT2oD,EAAexpD,IAAY,CACzB,GAAGA,EACH,SAAU,OAAOa,EAAE,OAAO,KAAK,GAC/B,IAGNuiB,OAAC,OAAI,UAAU,sCACb,UAAAC,MAAC,UAAO,UAAU,QAAQ,MAAM,UAAU,SAAQ,GAChD,SAAAA,MAAC,UAAO,MAAM,UAAU,mBAAO,EACjC,EACAD,OAAC,UACC,UAAU,QACV,MAAOmmC,EAAW,YAClB,SAAW1oD,GACT2oD,EAAexpD,IAAY,CACzB,GAAGA,EACH,UAAW,UACX,YAAa,OAAOa,EAAE,OAAO,KAAK,GAClC,EAGJ,UAAAwiB,MAAC,UAAO,MAAO,EAAG,mBAAO,EACzBA,MAAC,UAAO,MAAO,EAAG,oBAAQ,IAC5B,EACF,EACAA,MAAC,SACC,UAAU,eACV,YAAY,yBACZ,MAAOkmC,EAAW,WAClB,SAAW1oD,GACT2oD,EAAexpD,IAAY,CACzB,GAAGA,EACH,WAAYa,EAAE,OAAO,OACrB,IAGNwiB,MAAC,OAAI,UAAU,mBACb,SAAAA,MAAC,UACC,UAAU,0CACV,SAAU0lC,EACV,QAASsE,GACV,8BAED,CACF,GACF,GACF,EAEAjqC,OAAC,OAAI,UAAU,OACb,UAAAC,MAAC,MAAG,UAAU,6BAA6B,sCAE3C,EACAA,MAAC,OAAI,UAAU,0BAA0B,qFAGzC,EACAD,OAAC,OAAI,UAAU,YACZ,UAAA6lC,EACE,OACE7nD,GACCA,EAAE,SAAW,aACbA,EAAE,aACFA,EAAE,YAAc,WAEnB,IAAKA,GAAW,CACf,MAAMguD,EAASpF,EAAQ,KACpBp1C,IAAWA,GAAE,QAAUxT,EAAE,aAEtBiuD,GAAYD,GAAU,CAACA,EAAO,QACpC,OACEhsC,OAAC,OAAe,UAAU,kCACxB,UAAAA,OAAC,OAAI,UAAU,yCACb,UAAAC,MAAC,OAAI,UAAU,gBAAiB,SAAAjiB,EAAE,MAAM,EACxCiiB,MAAC,OAAI,UAAU,qBACZ,aAAI,KAAKjiB,EAAE,OAAO,EAAE,oBAAmB,CAC1C,GACF,EACAgiB,OAAC,OAAI,UAAU,oCACb,UAAAA,OAAC,OACC,UAAAC,MAAC,OAAI,UAAU,cAAe,SAAAjiB,EAAE,YAAY,EAC5CgiB,OAAC,OAAI,UAAU,qBAAqB,oBAC1BhiB,EAAE,YAAY,SACrBA,EAAE,YAAc,EAAI,IAAM,GAAG,YAChC,GACF,EACAiiB,MAAC,OAAI,UAAU,0BACZ,SAAAgsC,SACE,QAAK,UAAU,2CAA2C,4BAE3D,EAEAhsC,MAAC,UACC,UAAU,kDACV,SAAU0lC,EACV,QAAS,IACPoD,GAAa/qD,EAAE,YAAaA,EAAE,YAAc,EAAE,EAEjD,yBAED,CAEJ,GACF,IAhCQA,EAAE,EAiCZ,CAEJ,CAAC,EACF6nD,EAAY,OACV7nD,GACCA,EAAE,SAAW,aACbA,EAAE,aACFA,EAAE,YAAc,WAClB,SAAW,SACV,OAAI,UAAU,sCAAsC,6CAErD,GAEJ,GACF,EAEAgiB,OAAC,OAAI,UAAU,OACb,UAAAC,MAAC,MAAG,UAAU,6BAA6B,8BAAkB,EAC7DA,MAAC,OAAI,UAAU,0BAA0B,6EAEzC,EACAD,OAAC,MAAG,UAAU,YACX,UAAA6lC,EAAY,IAAK7nD,GAChBgiB,OAAC,MAAc,UAAU,kCACvB,UAAAA,OAAC,OAAI,UAAU,yCACb,UAAAA,OAAC,OACC,UAAAC,MAAC,OAAI,UAAU,gBAAiB,SAAAjiB,EAAE,MAAM,EACxCgiB,OAAC,OAAI,UAAU,aACZ,UAAAhiB,EAAE,KAAK,MAAIikD,GAAajkD,EAAE,IAAI,EAAE,IAAEA,EAAE,OACvC,GACF,EACAiiB,MAAC,OACC,UAAW,2CACTjiB,EAAE,SAAW,YACT,cACAA,EAAE,SAAW,UACX,eACAA,EAAE,SAAW,YACX,gBACA,aACV,GAEC,SAAAA,EAAE,QACL,EACF,EACAgiB,OAAC,OAAI,UAAU,0BAA0B,oBAC/B,IAAI,KAAKhiB,EAAE,OAAO,EAAE,iBAAiB,eAAa,IACzDA,EAAE,UACL,EACCA,EAAE,OACDgiB,OAAC,OAAI,UAAU,eAAe,oBACpBhiB,EAAE,aAAe,EAAE,UACzBA,EAAE,aAAe,GAAK,EAAI,IAAM,GAAG,YACvC,EAEFgiB,OAAC,OAAI,UAAU,4BACb,UAAAC,MAAC,UACC,UAAU,cACV,SAAU0lC,GAAW3nD,EAAE,SAAW,YAClC,QAAS,IACPksD,GAAUlsD,EAAE,GAAI,OAAO,eAAe,GAAK,EAAE,EAEhD,wBAGDiiB,MAAC,UACC,UAAU,cACV,SAAU0lC,EACV,QAAS,IAAM2E,GAAA,EAChB,mBAED,EACF,IAjDOtsD,EAAE,EAkDX,CACD,EACA6nD,EAAY,SAAW,SACrB,MAAG,UAAU,aAAa,2BAAe,GAE9C,GACF,GACF,EAEDY,IAAc,YAAcE,qBAEzB,SAAA3mC,OAAC,OAAI,UAAU,OACb,UAAAC,MAAC,MAAG,UAAU,6BAA6B,6BAAiB,EAC5DA,MAAC,OAAI,UAAU,0BAA0B,4GAGzC,EACC6mC,EAAa,SAAW,EACvB7mC,MAAC,OAAI,UAAU,qBAAqB,6BAAiB,EAErDA,MAAC,OAAI,UAAU,YACZ,SAAA6mC,EAAa,IAAK6E,GACjB3rC,OAAC,OAEC,UAAU,mFAEV,UAAAA,OAAC,OACC,UAAAC,MAAC,OAAI,UAAU,cACZ,SAAA0rC,EAAG,UAAY,YAClB,EACA1rC,MAAC,OAAI,UAAU,qBACZ,aAAI,KAAK0rC,EAAG,IAAM,CAAC,EAAE,gBAAe,CACvC,EACA1rC,MAAC,OAAI,UAAU,eAAgB,WAAG,QAAQ,EAC1CD,OAAC,OAAI,UAAU,OACb,UAAAC,MAAC,QACC,UAAW,uCAAuC0rC,EAAG,SAAW,OAAS,qCAAuCA,EAAG,SAAW,UAAY,iCAAmC,gCAAgC,GAE5M,WAAG,QAAU,YAEfA,EAAG,WACF3rC,OAAC,QAAK,UAAU,qBAAqB,gBAC/B2rC,EAAG,WACT,GAEJ,EACC3E,EAAW2E,EAAG,EAAE,GACf3rC,OAAC,OAAI,UAAU,8BACZ,UAAAgnC,EAAW2E,EAAG,EAAE,EAAE,IAAI,cACzB,GAEJ,EACA3rC,OAAC,OAAI,UAAU,0BACZ,UAAA2rC,EAAG,SAAW,QACb1rC,MAAC,UACC,UAAU,MACV,QAAS,IAAMypC,GAAUiC,EAAG,EAAE,EAC/B,mBAIFA,EAAG,SAAW,YACb1rC,MAAC,UACC,UAAU,gBACV,QAAS,IAAM0pC,GAAYgC,EAAG,EAAE,EACjC,qBAIH1rC,MAAC,UACC,UAAU,MACV,QAAS,IAAMknC,GAAmBwE,CAAE,EACrC,iBAED,EACF,IApDKA,EAAG,GAsDX,EACH,GAEJ,EACF,EAGDpF,EAAQ,MACPvmC,OAAC,OACC,UAAU,yBACV,QAAS,IAAMwmC,EAAW,CAAE,KAAM,GAAO,EAEzC,UAAAvmC,MAAC,OAAI,UAAU,gDAAgD,EAC/DA,MAAC,OAAI,UAAU,4FACb,SAAAD,OAAC,OACC,UAAU,mFACV,QAAUviB,GAAMA,EAAE,kBAElB,UAAAuiB,OAAC,OAAI,UAAU,4EACb,UAAAA,OAAC,OAAI,UAAU,gBAAgB,sBAAUumC,EAAQ,MAAK,EACtDtmC,MAAC,UACC,UAAU,MACV,QAAS,IAAMumC,EAAW,CAAE,KAAM,GAAO,EAC1C,kBAED,EACF,EACAvmC,MAAC,OAAI,UAAU,kBACb,SAAAA,MAAC,UACC,MAAM,gBACN,MAAO,CACL,MAAO,OACP,OAAQ,OACR,OAAQ,IACR,WAAY,eAEd,OAAQsmC,EAAQ,MAAQ,KAE5B,EACAtmC,MAAC,OAAI,UAAU,6DAA6D,2DAE5E,IACF,CACF,IACF,EAEJ,EAxuCED,OAAC,OAAI,UAAU,gBACb,UAAAC,MAAC,MAAG,UAAU,4CAA4C,qBAAS,EACnEA,MAAC,OAAI,UAAU,qBAAqB,uDAEpC,GACF,CAquCN,CC37DA,MAAMisC,GAAexqD,gBAAwC,IAAI,EAE3D4gC,GAAc,YACd6pB,GAAiB,gBAEvB,SAASC,GAAoBh0C,EAAO,IAAI,KAAmB,CACzD,MAAMpb,EAAIob,EAAK,WACT5a,EAAI4a,EAAK,UAEf,OAAIpb,IAAM,GAAMA,IAAM,IAAMQ,GAAK,EAAW,YAExCR,IAAM,IAAMA,IAAM,GAAMA,IAAM,GAAKQ,GAAK,GAAY,YAEpDR,IAAM,GAAKA,IAAM,EAAU,SAE3BA,GAAK,GAAKA,GAAK,EAAU,SACtB,SACT,CAEO,SAASqvD,GAAc,CAAE,SAAA3pD,GAA2C,CACzE,KAAM,CAAC4pD,EAAMC,CAAO,EAAI1tD,WAAkB,IAAM,CAC9C,GAAI,CACF,MAAM6Z,EAAM,aAAa,QAAQ,GAAG4pB,EAAW,OAAO,EACtD,OAAO5pB,EAAM,KAAK,MAAMA,CAAG,EAAI,EACjC,MAAQ,CACN,MAAO,EACT,CACF,CAAC,EAEK,CAAC8zC,EAAOC,CAAa,EAAI5tD,WAAoB,IAAM,CACvD,GAAI,CACF,MAAM6Z,EAAM,aAAa,QAAQ4pB,EAAW,EAC5C,GAAI5pB,EAAK,OAAOA,CAClB,MAAQ,CAER,CACA,OAAO0zC,GAAA,CACT,CAAC,EAEK,CAACM,EAAWC,CAAiB,EAAI9tD,WAAoB,IAAM,CAC/D,GAAI,CACF,MAAM6Z,EAAM,aAAa,QAAQyzC,EAAc,EAC/C,GAAIzzC,IAAQ,QAAUA,IAAQ,SAAWA,IAAQ,SAAU,OAAOA,CACpE,MAAQ,CAER,CACA,MAAO,QACT,CAAC,EAEDkB,YAAU,IAAM,CACd,GAAI,CACF,aAAa,QAAQuyC,GAAgBO,CAAS,CAChD,MAAQ,CAAC,CACX,EAAG,CAACA,CAAS,CAAC,EAEd9yC,YAAU,IAAM,CACd,MAAMgzC,EAAa5vD,GAAoC,CACrD,GAAI,CACF,SAAS,gBAAgB,aAAa,kBAAmBA,CAAC,CAC5D,MAAQ,CAAC,CACX,EAEA,GAAI0vD,IAAc,OAAQ,CACxBE,EAAU,MAAM,EAChB,MACF,CACA,GAAIF,IAAc,QAAS,CACzBE,EAAU,OAAO,EACjB,MACF,CAGA,MAAMC,EACJ,OAAO,OAAW,IACd,OAAO,aAAa,8BAA8B,EAClD,KACAC,EAAO,IAAMF,EAAUC,GAAI,QAAU,OAAS,OAAO,EAC3DC,EAAA,EACA,GAAI,CACFD,GAAI,mBAAmB,SAAUC,CAAI,CACvC,MAAQ,CAAC,CACT,MAAO,IAAM,CACX,GAAI,CACFD,GAAI,sBAAsB,SAAUC,CAAI,CAC1C,MAAQ,CAAC,CACX,CACF,EAAG,CAACJ,CAAS,CAAC,EAEd9yC,YAAU,IAAM,CACd,GAAI,CACF,aAAa,QAAQ,GAAG0oB,EAAW,QAAS,KAAK,UAAUgqB,CAAI,CAAC,CAClE,MAAQ,CAAC,CACX,EAAG,CAACA,CAAI,CAAC,EAET1yC,YAAU,IAAM,CACd,MAAMmzC,EAAUT,EAAOF,GAAA,EAAwBI,EAE/C,GAAI,CACEO,IAAY,UACd,SAAS,gBAAgB,gBAAgB,YAAY,EAClD,SAAS,gBAAgB,aAAa,aAAcA,CAAO,CAClE,MAAQ,CAAC,CACX,EAAG,CAACP,EAAOF,CAAI,CAAC,EAEhB,MAAMU,EAAYhvD,GAAiB,CACjC,GAAI,CACF,aAAa,QAAQskC,GAAatkC,CAAC,CACrC,MAAQ,CAAC,CACTyuD,EAAczuD,CAAC,CACjB,EAEMivD,EAAgBjwD,GAAiB,CACrC,GAAI,CACF,aAAa,QAAQmvD,GAAgBnvD,CAAC,CACxC,MAAQ,CAAC,CACT2vD,EAAkB3vD,CAAC,CACrB,EAEMyB,EAAQoH,UACZ,KAAO,CAAE,MAAA2mD,EAAO,SAAAQ,EAAU,KAAAV,EAAM,QAAAC,EAAS,UAAAG,EAAW,aAAAO,IACpD,CAACT,EAAOF,EAAMI,CAAS,GAGzB,OACEzsC,MAACisC,GAAa,SAAb,CAAsB,MAAAztD,EAAe,SAAAiE,CAAA,CAAS,CAEnD,CAEO,SAASwqD,IAAW,CACzB,MAAMn4B,EAAM6T,aAAWsjB,EAAY,EACnC,GAAI,CAACn3B,EAAK,MAAM,IAAI,MAAM,4CAA4C,EACtE,OAAOA,CACT,CC3JA,MAAMo4B,GAA0B,CAC9B,UACA,YACA,SACA,SACA,WACF,EAGMC,GAGF,CACF,QAAS,CACP,KAAM,KACN,MAAO,UACP,SAAU,8BACV,KAAM,kBAER,UAAW,CACT,KAAM,KACN,MAAO,YACP,SAAU,4BACV,KAAM,gBAER,OAAQ,CACN,KAAM,KACN,MAAO,SACP,SAAU,8BACV,KAAM,iBAER,UAAW,CACT,KAAM,KACN,MAAO,YACP,SAAU,gCACV,KAAM,mBAER,OAAQ,CACN,KAAM,KACN,MAAO,SACP,SAAU,6BACV,KAAM,kBAEV,EAEA,SAAwBC,IAAc,CACpC,KAAM,CAAE,MAAAb,EAAO,SAAAQ,EAAU,KAAAV,EAAM,QAAAC,EAAS,UAAAG,EAAW,aAAAO,CAAA,EACjDC,GAAA,EAEF,OACEltC,OAAC,OACC,UAAU,yBACV,KAAK,QACL,aAAW,iBAGX,UAAAA,OAAC,OAAI,UAAU,YACb,UAAAC,MAAC,OAAI,UAAU,sBAAsB,sBAAU,EAC/CA,MAAC,OAAI,UAAU,uBACZ,UACC,CAAE,IAAK,SAAmB,MAAO,UACjC,CAAE,IAAK,OAAiB,MAAO,QAC/B,CAAE,IAAK,QAAkB,MAAO,QAAQ,EACxC,IAAKjjB,GACLijB,MAAC,UAEC,KAAK,SACL,eAAcysC,IAAc1vD,EAAE,IAC9B,QAAS,IAAMiwD,EAAajwD,EAAE,GAAG,EACjC,UAAW,oCACT0vD,IAAc1vD,EAAE,IACZ,wCACA,YACN,GAEC,SAAAA,EAAE,OAVEA,EAAE,IAYV,EACH,GACF,EAGAgjB,OAAC,SAAM,UAAU,qDACf,UAAAC,MAAC,OACC,QAAS,IAAMssC,EAAQ,CAACD,CAAI,EAC5B,UAAW,oDACTA,EAAO,6CAA+C,aACxD,GAEA,SAAArsC,MAAC,QACC,UAAW,uFACTqsC,EAAO,gBAAkB,EAC3B,IACF,GAEFrsC,MAAC,QAAK,UAAU,sBAAsB,kCAAsB,GAC9D,QAGC,OAAI,UAAU,uBACZ,SAAAktC,GAAW,IAAKnvD,GAAM,CACrB,MAAM+jC,EAAOqrB,GAAWpvD,CAAC,EACnBsvD,EAAWd,IAAUxuD,EAC3B,OACEgiB,OAAC,UAEC,QAAS,IAAMgtC,EAAShvD,CAAC,EACzB,SAAUsuD,EACV,eAAcgB,EACd,MAAO,OAAOvrB,EAAK,KAAK,SACxB,UAAW;AAAA;AAAA;AAAA,kBAGPuqB,EAAO,gCAAkC,iCAAiC;AAAA,kBAC1EgB,EAAW,oBAAoBvrB,EAAK,QAAQ,sBAAsBA,EAAK,IAAI,sCAAwC,6CAA6C;AAAA,gBAGpK,UAAA9hB,MAAC,QAAK,UAAU,UAAW,SAAA8hB,EAAK,KAAK,SACpC,QAAM,UAAAA,EAAK,MAAM,OAAG,EACpBurB,GACCrtC,MAAC,QAAK,UAAU,mDAAmD,IAfhEjiB,CAAA,CAmBX,CAAC,EACH,IAGN,CC/GA,SAAwBuvD,GAAc,CAAE,KAAAr1C,GAAwB,CAG9D,KAAM,CACJ,eAAAs1C,EACA,cAAAC,EACA,YAAAC,EACA,aAAAC,EACA,kBAAAC,EACA,QAAAC,EACA,iBAAAC,EACA,oBAAAC,EACA,cAAAC,EACA,cAAAC,EACA,cAAAC,EACA,YAAAC,EACA,aAAAC,EACA,cAAAC,EACA,kBAAAC,EACA,eAAAC,EACA,eAAAC,EACA,sBAAAC,EACA,6BAAAC,EACA,yBAAAC,EACA,wBAAAC,EACA,gCAAAC,EACA,kBAAAC,EACA,kBAAAC,EACA,kBAAAC,EACA,iBAAAC,EACA,iBAAkBC,EAClB,kBAAmBC,EACnB,qBAAsBC,EACtB,cAAA1lB,EACA,cAAA2lB,EACA,SAAUC,GACV,QAASC,GACT,kBAAAC,GACA,iBAAAC,GACA,eAAAC,GACA,gBAAAC,GACA,qBAAAC,EACA,WAAAC,EACA,oBAAAC,GACA,uBAAAC,GACA,iBAAAC,GACA,iBAAAC,GACA,iBAAAC,GACA,eAAAC,GACA,gBAAAC,EACA,iBAAAC,EACA,qBAAAC,GACA,kBAAAC,GACA,kBAAAC,GACA,yBAAAC,GACA,gCAAAC,GACA,4BAAAC,EACA,2BAAAC,EACA,mCAAAC,EACA,qBAAAC,GACA,qBAAAC,GACA,qBAAAC,GACA,oBAAAC,GACA,iBAAAC,GACA,oBAAAC,GACA,oBAAAC,GACA,uBAAAC,GACA,oBAAqBC,GACrB,2BAAAlkB,GACA,8BAAAmkB,GACA,kCAAAC,GACA,qCAAAC,GACA,mBAAoBC,GACpB,iBAAA/nB,GACA,iBAAAgoB,GACA,YAAaC,GACb,WAAYC,GACZ,iBAAAC,GACA,iBAAAC,EACA,oBAAAC,EACA,oBAAAC,GACA,YAAAC,GACA,eAAAC,EAAA,EACEl7B,GAAA,EAGE,CAACm7B,GAAcC,EAAe,EAAIxzD,WAAS,CAC/C,CACE,IAAK,WACL,MAAO,YACP,SAAU,GACV,KAAM,KACN,KAAM,yBAER,CACE,IAAK,eACL,MAAO,mBACP,SAAU,GACV,KAAM,KACN,KAAM,mBAER,CACE,IAAK,gBACL,MAAO,oBACP,SAAU,GACV,KAAM,KACN,KAAM,qBAER,CACE,IAAK,UACL,MAAO,WACP,SAAU,GACV,KAAM,IACN,KAAM,qCAER,CACE,IAAK,WACL,MAAO,WACP,SAAU,GACV,KAAM,KACN,KAAM,gCACR,CACD,EAED+a,YAAU,IAAM,CACd,MAAM04C,EAAQp6C,GAAM,UAAY,GAC3Bo6C,GACLD,GAAiBv+C,IACfA,GAAK,IAAKzW,KAAO,CACf,GAAGA,GACH,SAAU,CAAC,CAAC,aAAa,QAAQ,eAAeA,GAAE,GAAG,IAAIi1D,CAAK,EAAE,GAChE,EAEN,EAAG,CAACp6C,GAAM,QAAQ,CAAC,EAGnB0B,YAAU,IAAM,CACd,SAAS24C,GAAgB,CACvB,GAAI,CACFC,GAAgB,MAAM,CACxB,MAAQ,CAAC,CACX,CACA,cAAO,iBAAiB,4BAA6BD,CAAoB,EAClE,IACL,OAAO,oBACL,4BACAA,CAAA,CAEN,EAAG,EAAE,EAGL,KAAM,CAACE,GAAWC,EAAY,EAAI7zD,WAAS,EAAK,EAC1C,CAAC8zD,GAAWC,EAAY,EAAI/zD,WAAS,EAAE,EACvC,CAACg0D,GAASC,EAAU,EAAIj0D,WAAS,EAAE,EACnC,CAACk0D,GAAUC,EAAW,EAAIn0D,WAAS,EAAE,EACrC,CAACo0D,GAAKC,EAAM,EAAIr0D,WAAS,EAAE,EAC3B,CAACs0D,GAAcC,EAAe,EAAIv0D,WAAS,EAAE,EAC7C,CAACw0D,GAAgBC,EAAiB,EAAIz0D,WAAS,EAAI,EACnD,CAAC00D,GAAcC,EAAe,EAAI30D,WAAc,IAAI,EAGpD,CAAC40D,GAAcC,EAAe,EAAI70D,WAOtC,CACA,CACE,KAAM,qEACN,OAAQ,GACV,CACD,EACK,CAAC80D,GAAWC,EAAY,EAAI/0D,WAAS,EAAE,EAE7C+a,YAAU,IAAM,CACd,MAAM04C,EAAQp6C,GAAM,UAAY,GAChC,GAAKo6C,EACL,GAAI,CACFM,GAAa,aAAa,QAAQ,qBAAqBN,CAAK,EAAE,GAAK,EAAE,EACrEQ,GAAW,aAAa,QAAQ,mBAAmBR,CAAK,EAAE,GAAK,EAAE,EACjEU,GAAY,aAAa,QAAQ,oBAAoBV,CAAK,EAAE,GAAK,EAAE,EACnEY,GAAO,aAAa,QAAQ,eAAeZ,CAAK,EAAE,GAAK,EAAE,EACzDc,GACE,aAAa,QAAQ,wBAAwBd,CAAK,EAAE,GAAK,IAE3DgB,GACE,aAAa,QAAQ,+BAA+BhB,CAAK,EAAE,IACzD,QAEN,MAAQ,CAAC,CACX,EAAG,CAACp6C,GAAM,QAAQ,CAAC,EAEnB0B,YAAU,IAAM,CACT1B,GAAM,OACXwD,GAAS,2BAA2B,mBAAmBxD,EAAK,KAAK,CAAC,EAAE,EACjE,KAAMna,GAAMA,EAAE,MAAM,EACpB,KAAKy1D,EAAe,EACpB,MAAM,IAAM,CAAC,CAAC,CACnB,EAAG,CAACt7C,GAAM,KAAK,CAAC,EAEhB,MAAM27C,GAAU,IAAM,CACpB,MAAMvB,EAAQp6C,GAAM,UAAY,GAChC,GAAKo6C,EACL,GAAI,CACF,aAAa,QAAQ,qBAAqBA,CAAK,GAAIK,EAAS,EAC5D,aAAa,QAAQ,mBAAmBL,CAAK,GAAIO,EAAO,EACxD,aAAa,QAAQ,oBAAoBP,CAAK,GAAIS,EAAQ,EAC1D,aAAa,QAAQ,eAAeT,CAAK,GAAIW,EAAG,EAChD,aAAa,QAAQ,wBAAwBX,CAAK,GAAIa,EAAY,EAElE,GAAI,CACF,OAAO,cACL,IAAI,YAAY,qBAAsB,CACpC,OAAQ,CAAE,SAAUb,EAAO,OAAQa,EAAA,CAAa,CACjD,EAEL,MAAQ,CAAC,CACT,aAAa,QACX,+BAA+Bb,CAAK,GACpCe,GAAe,UAAS,EAE1BX,GAAa,EAAK,CACpB,MAAQ,CAAC,CACX,EAGMoB,GAAM,CACV,cACE,mHACF,OACE,kFACF,YACE,kFACF,QACE,wFACF,SAAU,4DACV,MACE,8FACF,QAAS,mDACT,MAAO,yCACP,SAAU,mDACV,QACE,qEAGEC,GAAiBC,GAAmB,CACxC,GAAI,CACF,OAAO,cACL,IAAI,YAAY,iBAAkB,CAAE,OAAQ,CAAE,IAAKA,EAAO,CAAG,EAEjE,OAAS9zB,GAAO,CACd,QAAQ,MAAM,qBAAsBA,EAAK,CAC3C,CACF,EAEM+zB,GACJ3P,GACmE,CACnE,MAAMpJ,GAAUoJ,EAAY,cAE5B,GAAIpJ,GAAQ,SAAS,UAAU,GAAKA,GAAQ,SAAS,aAAa,EAChE,MAAO,CACL,KAAM,8CACN,MAAO,CAAC,CAAE,KAAM,2BAA4B,IAAK,WAAY,GAGjE,GACEA,GAAQ,SAAS,SAAS,GAC1BA,GAAQ,SAAS,SAAS,GAC1BA,GAAQ,SAAS,cAAc,EAE/B,MAAO,CACL,KAAM,+CACN,MAAO,CAAC,CAAE,KAAM,oBAAqB,IAAK,SAAU,GAGxD,GACEA,GAAQ,SAAS,UAAU,GAC3BA,GAAQ,SAAS,QAAQ,GACzBA,GAAQ,SAAS,QAAQ,EAEzB,MAAO,CACL,KAAM,2CACN,MAAO,CAAC,CAAE,KAAM,mCAAoC,IAAK,WAAY,GAGzE,GACEA,GAAQ,SAAS,OAAO,GACxBA,GAAQ,SAAS,QAAQ,GACzBA,GAAQ,SAAS,OAAO,EAExB,MAAO,CACL,KAAM,oCACN,MAAO,CAAC,CAAE,KAAM,iCAAkC,IAAK,WAAY,GAGvE,GAAIA,GAAQ,SAAS,QAAQ,GAAKA,GAAQ,SAAS,eAAe,EAChE,MAAO,CACL,KAAM,gCACN,MAAO,CAAC,CAAE,KAAM,gBAAiB,IAAK,UAAW,GAGrD,GACEA,GAAQ,SAAS,MAAM,GACvBA,GAAQ,SAAS,OAAO,GACxBA,GAAQ,SAAS,aAAa,EAE9B,MAAO,CACL,KAAM,wCACN,MAAO,CAAC,CAAE,KAAM,cAAe,IAAK,QAAS,GAGjD,GACEA,GAAQ,SAAS,SAAS,GAC1BA,GAAQ,SAAS,UAAU,GAC3BA,GAAQ,SAAS,UAAU,EAE3B,MAAO,CACL,KAAM,6BACN,MAAO,CAAC,CAAE,KAAM,iBAAkB,IAAK,WAAY,GAGvD,GAAIA,GAAQ,SAAS,YAAY,GAAKA,GAAQ,SAAS,aAAa,EAClE,MAAO,CACL,KAAM,0CACN,MAAO,CAAC,CAAE,KAAM,oBAAqB,IAAK,cAAe,GAG7D,GACEA,GAAQ,SAAS,MAAM,GACvBA,GAAQ,SAAS,SAAS,GAC1BA,GAAQ,SAAS,KAAK,EAEtB,MAAO,CACL,KAAM,0FACN,MAAO,CAAC,CAAE,KAAM,oBAAqB,IAAK,WAAY,GAG1D,GACEA,GAAQ,SAAS,aAAa,GAC9BA,GAAQ,SAAS,MAAM,GACvBA,GAAQ,SAAS,OAAO,EAExB,MAAO,CACL,KAAM,mHACN,MAAO,CACL,CAAE,KAAM,cAAe,IAAK,UAC5B,CAAE,KAAM,eAAgB,IAAK,UAAU,CACzC,EAIJ,MAAMgZ,GAAW,OAAO,QAAQJ,EAAG,EAAE,KAAK,CAAC,CAAC9Q,EAAK,IAC/C9H,GAAQ,SAAS8H,GAAM,aAAa,GAEtC,OAAIkR,GACK,CACL,KAAMA,GAAS,CAAC,EAChB,MAAO,CAAC,CAAE,KAAM,WAAY,IAAK,WAAY,GAI1C,CACL,KAAM,2IAEV,EAEMC,GAAiB,IAAM,CAC3B,GAAI,CAACR,GAAU,OAAQ,OACvB,MAAMrP,EAAcqP,GAAU,cAC9BD,GAAiB5/C,IAAS,CAAC,GAAGA,GAAM,CAAE,KAAM6/C,GAAW,OAAQ,GAAM,CAAC,EACtEC,GAAa,EAAE,EAGf,MAAMxyB,GAAW6yB,GAAqB3P,CAAW,EAEjD,WAAW,IAAM,CACfoP,GAAiB5/C,IAAS,CAAC,GAAGA,GAAM,CAAE,KAAMstB,GAAU,OAAQ,GAAO,CAAC,CACxE,EAAG,GAAG,CACR,EAGM,CAACgzB,GAAaC,EAAc,EAAIx1D,WAAS,EAAE,EAC3C,CAACy1D,GAAkBC,EAAoB,EAAI11D,WAAS,EAAK,EACzD,CAAC21D,GAAeC,EAAgB,EAAI51D,WAAS,EAAE,EAG/C,CAAC61D,GAAiBC,EAAkB,EAAI91D,WAE5C,EAAE,EAEJ+a,YAAU,IAAM,CACd,MAAMg7C,EAAa,IAAM,CACvB,MAAMC,GAAS,gBAAgB,YAC/BF,GAAmBE,GAAO,OAAQ17C,IAAMA,GAAE,KAAK,WAAW,IAAI,CAAC,CAAC,CAClE,EACAy7C,EAAA,EACA,gBAAgB,gBAAkBA,CACpC,EAAG,EAAE,EAGL,KAAM,CAACE,GAAiBC,EAAiB,EAAIl2D,WAAS,EAAK,EAGrD,CAACm2D,GAAcxC,EAAe,EAAI3zD,WAEtC,IAAI,EAEAo2D,GAAa,CAAC,CAClB,MAAAp1C,EACA,KAAMC,GACN,KAAAo1C,GACA,MAAAlgC,EAAA,IAOAhV,OAAC,UACC,cAAgBviB,IAAM,CACnBA,GAAU,iBACb,EACA,YAAcA,IAAM,CAClBA,GAAE,iBACJ,EACA,aAAeA,IAAM,CAClBA,GAAU,mBACb,EACA,QAAS,IAAM+0D,GAAiB1+C,IAAUA,KAASohD,GAAO,KAAOA,EAAK,EACtE,KAAK,SACL,cAAa,eAAeA,EAAI,GAChC,UAAW,iMAAiMlgC,EAAK,sCAEjN,UAAA/U,MAACH,GAAA,CAAK,UAAU,UAAU,EAAE,IAAED,EAC9BI,MAACk1C,GAAA,CACC,UAAW,gCAAgCH,KAAiBE,GAAO,aAAe,EAAE,IACtF,IAIJ,OACEl1C,OAAC,OAAI,UAAU,qBACb,UAAAC,MAAC,OAAI,UAAU,6HACb,SAAAD,OAAC,OAAI,UAAU,yCACb,UAAAA,OAAC,OAAI,UAAU,UACb,gBAAC,OAAI,UAAU,qDAAqD,uBAEpE,QACC,MAAG,UAAU,0CAA0C,oBAExD,QACC,OAAI,UAAU,iCAAiC,0DAEhD,GACF,QACC,OAAI,UAAU,mEACb,SAAAC,MAACotC,KAAY,EACf,GACF,EACF,QAGC,OAAI,UAAU,oIACb,SAAArtC,OAAC,OAAI,UAAU,iEACb,UAAAC,MAACg1C,GAAA,CACC,MAAM,eACN,KAAMhQ,GACN,KAAK,OACL,MAAM,kCAERhlC,MAACg1C,GAAA,CACC,MAAM,kBACN,KAAMp4C,GACN,KAAK,cACL,MAAM,oCAERoD,MAACg1C,GAAA,CACC,MAAM,kBACN,KAAMn4C,GACN,KAAK,WACL,MAAM,iCACR,EACF,EACF,EAOwB,KAGvBk4C,KAAiB,QAChB/0C,MAAC,OACC,cAAY,oBACZ,UAAU,wFAEV,SAAAD,OAAC,OAAI,UAAU,wCAEb,UAAAC,MAAC,OAAI,UAAU,OACb,SAAAD,OAAC,OAAI,UAAU,wDACb,UAAAA,OAAC,OAAI,UAAU,0DACb,UAAAC,MAACglC,GAAA,CAAK,UAAU,UAAU,EAAE,eAC9B,EACAjlC,OAAC,OAAI,UAAU,YACb,UAAAA,OAAC,OAAI,UAAU,4BACb,UAAAC,MAAC,UACC,QAAS,IACP,OAAO,cAAc,IAAI,YAAY,YAAY,CAAC,EAEpD,UAAU,4FACX,uBAGDA,MAAC,UACC,QAAS,IAAM80C,GAAkB,EAAI,EACrC,UAAU,gGACX,yBAED,EACF,EACA/0C,OAAC,OAAI,UAAU,kCACb,UAAAA,OAAC,OAAI,UAAU,gCAAgC,kCAE3C,IAAM,CACN,MAAMsT,EAAQpb,GAAM,qBAAuB,EAC3C,OAAIob,EAAQ,EACH,GAAG,EAAIA,CAAK,0BACd,eACT,KAAK,KAEP,QACC,OAAI,UAAU,4BAA4B,iGAG3C,EACCpb,GAAM,qBAAuB,GAAK,CAACk8C,GAAY,OAC9Cn0C,MAAC,OAAI,UAAU,8BAA8B,kDAE7C,EACE,KACJA,MAAC,SACC,UAAU,oBACV,KAAK,OACL,YAAY,eACZ,MAAOm0C,GACP,SAAW32D,GAAM42D,GAAe52D,EAAE,OAAO,KAAK,EAC9C,SAAU62D,EAAA,GAEXE,UACE,OAAI,UAAU,4BACZ,SAAAA,GACH,EAEFv0C,MAAC,UACC,QAAS,SAAY,CAEnB,GADAw0C,GAAiB,EAAE,EACf,CAACL,GAAY,OAAQ,CACvBK,GAAiB,mBAAmB,EACpC,MACF,CACA,GAAIL,GAAY,OAAS,GAAKA,GAAY,OAAS,GAAI,CACrDK,GAAiB,kCAAkC,EACnD,MACF,EACqBv8C,GAAM,qBAAuB,GACpB,GAK5B,aAAa,QACX,wBACAk8C,GAAY,MAAK,EAEnB,OAAO,SAAS,KAAO,0BAPvB,OAAO,SAAS,KACd,gDAQN,EACA,SAAUE,IAAoB,CAACF,GAAY,OAC3C,UAAU,0HAET,SAAAE,GACG,iBAEgBp8C,GAAM,qBAAuB,GAC5B,EACX,4BACA,yBACH,EACT,EACF,GACF,GACF,EACF,EAGCq7C,UACE,OAAI,UAAU,OACb,SAAAvzC,OAAC,OAAI,UAAU,4DACb,UAAAA,OAAC,OAAI,UAAU,4DACb,UAAAC,MAACm1C,GAAA,CAAO,UAAU,UAAU,EAAE,cAChC,EACAp1C,OAAC,OAAI,UAAU,mCACb,UAAAA,OAAC,OAAI,oBACK,IACRC,MAAC,QACC,UACEszC,IAAc,SAAW,SACrB,iBACA,kBAGL,SAAAA,IAAc,SAAW,SACtB,aACA,cACN,EACF,EACCA,IAAc,SAAW,UACxBA,IAAc,wBACX,OAAI,0BACW,IACb,IAAI,KACHA,GAAa,iBACb,oBAAmB,EACvB,EAEHA,IAAc,SAAW,cACxBA,IAAc,SAAW,UACvBtzC,MAAC,UACC,QAAS,IACN,OAAO,SAAS,KACf,iDAEJ,UAAU,wGACX,kCAED,EAEN,GACF,EACF,QAID,OAAI,UAAU,OACb,SAAAD,OAAC,OAAI,UAAU,0DACb,UAAAA,OAAC,OAAI,UAAU,2DACb,UAAAC,MAACo1C,GAAA,CAAI,UAAU,UAAU,EAAE,sBAC7B,EACAp1C,MAAC,SACC,KAAK,OACL,OAAO,UACP,SAAWxiB,GAAM,CACf,MAAM63D,GAAO73D,EAAE,OAAO,QAAQ,CAAC,EAC/B,GAAI63D,GAAM,CACR,MAAMC,GAAS,IAAI,WACnBA,GAAO,OAAS,IACdnC,GAAgBmC,GAAO,MAAgB,EACzCA,GAAO,cAAcD,EAAI,CAC3B,CACF,EACA,UAAU,iCACZ,EACF,EACF,QAGC,OAAI,UAAU,OACb,SAAAt1C,OAAC,OAAI,UAAU,8DACb,UAAAA,OAAC,OAAI,UAAU,6DACb,UAAAC,MAACG,GAAA,CAAc,UAAU,UAAU,EAAE,uBACvC,QACC,OAAI,UAAU,YACb,SAAAJ,OAAC,OAAI,UAAU,0BACb,UAAAC,MAAC,SACC,KAAK,WACL,GAAG,gBACH,QAASiuC,EACT,SAAWzwD,GAAMyyD,GAAiBzyD,EAAE,OAAO,OAAO,EAClD,UAAU,YAEZwiB,MAAC,SACC,QAAQ,gBACR,UAAU,0BACX,iCAED,EACF,EACF,GACF,EACF,QAGC,OAAI,UAAU,OACb,SAAAD,OAAC,OAAI,UAAU,8DACb,UAAAA,OAAC,OAAI,UAAU,6DACb,UAAAC,MAACm1C,GAAA,CAAO,UAAU,UAAU,EAAE,uBAChC,EACAp1C,OAAC,OAAI,UAAU,YACb,UAAAA,OAAC,OAAI,UAAU,0BACb,UAAAC,MAAC,SACC,KAAK,WACL,GAAG,iBACH,QAASozC,GACT,SAAW51D,GAAM61D,GAAkB71D,EAAE,OAAO,OAAO,EACnD,UAAU,YAEZwiB,MAAC,SACC,QAAQ,iBACR,UAAU,0BACX,+BAED,EACF,EACAA,MAAC,UACC,QAAS,IAAM,CACb,MAAM3f,EAAO,CACX,aAAA8xD,GACA,IAAK,CAAE,UAAAO,GAAW,QAAAE,GAAS,SAAAE,GAAU,IAAAE,EAAA,CAAI,EAErCuC,GAAO,IAAI,KAAK,CAAC,KAAK,UAAUl1D,EAAM,KAAM,CAAC,CAAC,EAAG,CACrD,KAAM,mBACP,EACKsb,GAAM,IAAI,gBAAgB45C,EAAI,EAC9Bn4D,GAAI,SAAS,cAAc,GAAG,EACpCA,GAAE,KAAOue,GACTve,GAAE,SAAW,WAAW,IAAI,OAAO,cAAc,MAAM,GAAG,EAAE,CAAC,CAAC,QAC9DA,GAAE,QACF,IAAI,gBAAgBue,EAAG,CACzB,EACA,UAAU,+CACX,8BAED,EACF,GACF,EACF,QAGC,OAAI,UAAU,OACb,SAAAoE,OAAC,OAAI,UAAU,wDACb,UAAAA,OAAC,OAAI,UAAU,6CACb,UAAAC,MAACm1C,GAAA,CAAO,UAAU,uBAAuB,EAAE,4BAE7C,QACC,OAAI,UAAU,mCACb,SAAAp1C,OAAC,OAAI,UAAU,wDACb,gBAAC,KAAE,UAAU,kCAAkC,8BAE/C,EACAA,OAAC,KAAE,UAAU,eACX,UAAAC,MAAC,UAAO,sBAAU,EAAS,kDAE7B,EACAD,OAAC,KAAE,UAAU,UACX,UAAAC,MAAC,UAAO,oBAAQ,EAAS,qEAE3B,GACF,EACF,GACF,EACF,QAGC,OAAI,UAAU,OACb,SAAAD,OAAC,OAAI,UAAU,8DACb,UAAAA,OAAC,OAAI,UAAU,6DACb,UAAAC,MAACm1C,GAAA,CAAO,UAAU,UAAU,EAAE,kBAChC,EACAp1C,OAAC,OAAI,UAAU,YACb,gBAAC,KAAE,UAAU,0BAA0B,8DAEvC,EACAC,MAAC,UACC,QAAS,IACP,OAAO,cACL,IAAI,YAAY,oBAAoB,GAGxC,UAAU,uDACX,kCAED,EACF,GACF,EACF,QAGC,OAAI,UAAU,OACb,SAAAD,OAAC,OAAI,UAAU,0DACb,UAAAA,OAAC,OAAI,UAAU,2DACb,UAAAC,MAACG,GAAA,CAAc,UAAU,UAAU,EAAE,sBACvC,EACAJ,OAAC,OAAI,UAAU,YACb,UAAAC,MAAC,KACC,KAAK,oCACL,UAAU,8HACX,8BAGDA,MAAC,KACC,KAAK,kCACL,OAAO,SACP,IAAI,sBACJ,UAAU,8HACX,2BAGDA,MAAC,KACC,KAAK,iCACL,OAAO,SACP,IAAI,sBACJ,UAAU,8HACX,mBAED,EACF,GACF,EACF,QAGC,OAAI,UAAU,OACb,SAAAD,OAAC,OAAI,UAAU,wDACb,UAAAA,OAAC,OAAI,UAAU,0DACb,UAAAC,MAACm1C,GAAA,CAAO,UAAU,UAAU,EAAE,mBAChC,EACAp1C,OAAC,OAAI,UAAU,YACb,UAAAA,OAAC,OAAI,UAAU,6EACb,gBAAC,KAAE,UAAU,qBAAqB,sBAAU,EAC5CC,MAAC,KAAE,2HAGH,GACF,EACAA,MAAC,UACC,QAAS,IAAM,CACG,OAAO,QACrB;;AAAA,sEAGqB,OAAO,QAC1B,6EAGA,OAAO,cACL,IAAI,YAAY,oBAAoB,EAI5C,EACA,UAAU,mGACX,2CAED,EACF,GACF,EACF,GACF,UAKH,OAAI,UAAU,6EACb,SAAAA,MAAC,OAAI,UAAU,iEACb,SAAAA,MAACg1C,GAAA,CACC,MAAM,eACN,KAAMp4C,GACN,KAAK,cACL,MAAM,oDACR,CACF,EACF,EAGCm4C,KAAiB,eAChB/0C,MAAC,OACC,cAAY,2BACZ,UAAU,mEAEV,SAAAD,OAAC,OAAI,UAAU,wCAEb,UAAAC,MAAC,OAAI,UAAU,OACb,SAAAD,OAAC,OAAI,UAAU,0DACb,UAAAA,OAAC,OAAI,UAAU,6CACb,UAAAC,MAACpD,GAAA,CAAO,UAAU,wBAAwB,EAAE,oBAC9C,EACAmD,OAAC,OAAI,UAAU,YACb,UAAAA,OAAC,OAAI,UAAU,0BACb,UAAAC,MAAC,SACC,KAAK,WACL,GAAG,gBACH,QAASypB,EACT,SAAWjsC,GAAMksC,GAAiBlsC,EAAE,OAAO,OAAO,EAClD,UAAU,kBAEX,SAAM,QAAQ,gBAAgB,UAAU,UAAU,yBAEnD,GACF,EACCisC,GACC1pB,OAAAja,WAAA,CACE,UAAAia,OAAC,OAAI,UAAU,gCACb,gBAAC,OAAI,UAAU,6BAA6B,oBAE5C,EACAA,OAAC,OAAI,UAAU,2BACb,UAAAA,OAAC,OAAI,UAAU,0BACb,UAAAC,MAAC,SACC,KAAK,WACL,GAAG,oBACH,QAAS,CAAC,CAAC+uC,EACX,SAAWvxD,GACTuzD,GAAqBvzD,EAAE,OAAO,OAAO,EAEvC,UAAU,YAEZwiB,MAAC,SACC,QAAQ,oBACR,UAAU,UACX,4DAED,EACF,EACAD,OAAC,OAAI,UAAU,0BACb,UAAAC,MAAC,SACC,KAAK,WACL,GAAG,mBACH,QAAS,CAAC,CAACgvC,EACX,SAAWxxD,GACTwzD,GAAoBxzD,EAAE,OAAO,OAAO,EAEtC,UAAU,YAEZwiB,MAAC,SACC,QAAQ,mBACR,UAAU,UACX,4CAED,EACF,GACF,QACC,KAAE,UAAU,0BAA0B,0IAIvC,EAEAD,OAAC,OAAI,UAAU,0BACb,UAAAC,MAAC,SACC,KAAK,WACL,GAAG,oBACH,QAAS,CAAC,CAAC6uC,EACX,SAAWrxD,GACTqzD,GAAqBrzD,EAAE,OAAO,OAAO,EAEvC,UAAU,YAEZwiB,MAAC,SACC,QAAQ,oBACR,UAAU,UACX,wDAED,EACF,QACC,KAAE,UAAU,0BAA0B,kGAGvC,EAEAD,OAAC,OAAI,UAAU,+BACb,UAAAC,MAAC,SACC,KAAK,WACL,GAAG,oBACH,QAAS,CAAC,CAAC8uC,EACX,SAAWtxD,GACTszD,GAAqBtzD,EAAE,OAAO,OAAO,EAEvC,UAAU,YAEZwiB,MAAC,SACC,QAAQ,oBACR,UAAU,UACX,8CAED,EACF,QACC,KAAE,UAAU,0BAA0B,0FAGvC,GACF,SAEC,OACC,UAAAD,OAAC,SACC,QAAQ,cACR,UAAU,qBACX,oBACSmuC,GAAa,QAAQ,CAAC,KAEhCluC,MAAC,SACC,KAAK,QACL,GAAG,cACH,IAAI,MACJ,IAAI,IACJ,KAAK,MACL,MAAOkuC,GAAe,EACtB,SAAW1wD,GACT0yD,GAAe,WAAW1yD,EAAE,OAAO,KAAK,CAAC,EAE3C,UAAU,UACZ,EACF,EACAuiB,OAAC,OAAI,UAAU,OACb,UAAAA,OAAC,OAAI,UAAU,0BACb,UAAAC,MAAC,SACC,KAAK,WACL,GAAG,mBACH,QAAS,CAAC,CAACixC,GACX,SAAWzzD,GACT0zD,GAAoB1zD,EAAE,OAAO,OAAO,EAEtC,UAAU,kBAEX,SAAM,QAAQ,mBAAmB,UAAU,UAAU,wDAEtD,GACF,QACC,KAAE,UAAU,0BAA0B,2GAGvC,EAEAuiB,OAAC,OAAI,UAAU,OACb,gBAAC,SAAM,UAAU,qBAAqB,yBAEtC,EACAA,OAAC,UACC,MAAOoxC,GACP,SAAW3zD,GACT4zD,GAAuB,OAAO5zD,EAAE,OAAO,KAAK,CAAC,EAE/C,UAAU,eAEV,gBAAC,UAAO,MAAO,GAAI,6BAAiB,QACnC,UAAO,MAAO,GAAI,6BAAiB,QACnC,UAAO,MAAO,GAAI,2BAAe,QACjC,UAAO,MAAO,GAAI,yBAAa,WAEjC,KAAE,UAAU,0BAA0B,8EAGvC,GACF,GACF,SACC,OACC,UAAAwiB,MAAC,SACC,QAAQ,eACR,UAAU,qBACX,0BAGDD,OAAC,UACC,cAAgBviB,GAAM,CACnBA,EAAU,iBACb,EACA,YAAcA,GAAM,CAClBA,EAAE,iBACJ,EACA,aAAeA,GAAM,CAClBA,EAAU,mBACb,EACA,GAAG,eACH,MAAO2wD,GAAgB,OACvB,SAAW3wD,GACT2yD,EAAgB3yD,EAAE,OAAO,KAA0B,EAErD,UAAU,eAEV,gBAAC,UAAO,MAAM,OAAO,uBAAW,QAC/B,UAAO,MAAM,SAAS,wBAAY,IACrC,EACF,SACC,OACC,UAAAwiB,MAAC,SACC,QAAQ,gBACR,UAAU,qBACX,sBAGDD,OAAC,UACC,cAAgBviB,GAAM,CACnBA,EAAU,iBACb,EACA,YAAcA,GAAM,CAClBA,EAAE,iBACJ,EACA,aAAeA,GAAM,CAClBA,EAAU,mBACb,EACA,GAAG,gBACH,MAAO4wD,GAAiB,MACxB,SAAW5wD,GACT4yD,EAAiB5yD,EAAE,OAAO,KAAuB,EAEnD,UAAU,eAEV,gBAAC,UAAO,MAAM,OAAO,uBAAW,QAC/B,UAAO,MAAM,MAAM,2BAAe,IACrC,EACF,EACAwiB,MAAC,UACC,QAAS,IAAM,CAAC,EAChB,UAAU,+CACX,yCAGA,OACC,UAAAA,MAAC,SACC,QAAQ,oBACR,UAAU,qBACX,iCAGDD,OAAC,UACC,cAAgBviB,GAAM,CACnBA,EAAU,iBACb,EACA,YAAcA,GAAM,CAClBA,EAAE,iBACJ,EACA,aAAeA,GAAM,CAClBA,EAAU,mBACb,EACA,GAAG,oBACH,MAAO6wD,GAAqB,SAC5B,SAAW7wD,GACT6yD,GACE7yD,EAAE,OAAO,OAGb,UAAU,eAEV,gBAAC,UAAO,MAAM,SAAS,0BAAc,QACpC,UAAO,MAAM,cAAc,gCAE5B,IACF,EACF,EACC6wD,IAAsB,eACrBruC,MAAC,SACC,KAAK,OACL,YAAY,gBACZ,MAAOsuC,GAAkB,GACzB,SAAW9wD,GAAM8yD,GAAkB9yD,EAAE,OAAO,KAAK,EACjD,UAAU,yBAGb6wD,IAAsB,UACrBtuC,OAAC,OACC,UAAAC,MAAC,SACC,QAAQ,iBACR,UAAU,qBACX,0BAGDD,OAAC,UACC,cAAgBviB,GAAM,CACnBA,EAAU,iBACb,EACA,YAAcA,GAAM,CAClBA,EAAE,iBACJ,EACA,aAAeA,GAAM,CAClBA,EAAU,mBACb,EACA,GAAG,iBACH,MAAO+wD,GAAkB,iBACzB,SAAW/wD,GACT+yD,GACE/yD,EAAE,OAAO,OAKb,UAAU,eAEV,gBAAC,UAAO,MAAM,iBAAiB,wCAE/B,QACC,UAAO,MAAM,YAAY,kDAE1B,WAED,KAAE,UAAU,0BAA0B,6FAGvC,GACF,EAGD6wD,IAAsB,UACrBtuC,OAAC,OAAI,UAAU,gCACb,gBAAC,OAAI,UAAU,6BAA6B,8BAE5C,EAEAA,OAAC,OAAI,UAAU,0BACb,UAAAC,MAAC,SACC,KAAK,WACL,GAAG,wBACH,QAASwuC,GAAyB,GAClC,SAAWhxD,GACTgzD,GAAyBhzD,EAAE,OAAO,OAAO,EAE3C,UAAU,YAEZwiB,MAAC,SACC,QAAQ,wBACR,UAAU,UACX,oCAED,EACF,QACC,KAAE,UAAU,0BAA0B,+GAGvC,EAEAD,OAAC,OAAI,UAAU,OACb,UAAAA,OAAC,SACC,QAAQ,+BACR,UAAU,qBACX,kCACuB,KACpB0uC,GAAgC,KAAM,QACtC,EACF,IAEFzuC,MAAC,SACC,KAAK,QACL,GAAG,+BACH,IAAI,MACJ,IAAI,OACJ,KAAK,OACL,MAAOyuC,GAAgC,IACvC,SAAWjxD,GACTizD,GACE,WAAWjzD,EAAE,OAAO,KAAK,GAG7B,UAAU,iBAEX,KAAE,UAAU,0BAA0B,mFAGvC,GACF,EAEAuiB,OAAC,WAAQ,UAAU,OACjB,gBAAC,WAAQ,UAAU,gDAAgD,oCAEnE,EAEAA,OAAC,OAAI,UAAU,iBACb,UAAAA,OAAC,OACC,UAAAA,OAAC,SAAM,UAAU,qBAAqB,2BACrB,IACd2uC,GAA4B,IAC/B,EACA1uC,MAAC,SACC,KAAK,QACL,IAAI,IACJ,IAAI,MACJ,KAAK,IACL,MAAO0uC,GAA4B,GACnC,SAAWlxD,GACTkzD,EACE,SAASlzD,EAAE,OAAO,MAAO,EAAE,GAG/B,UAAU,iBAEX,KAAE,UAAU,0BAA0B,kEAGvC,GACF,SAEC,OACC,UAAAuiB,OAAC,SAAM,UAAU,qBAAqB,kCACd,IACrB4uC,GAA2B,IAC9B,EACA3uC,MAAC,SACC,KAAK,QACL,IAAI,IACJ,IAAI,KACJ,KAAK,IACL,MAAO2uC,GAA2B,GAClC,SAAWnxD,GACTmzD,EACE,SAASnzD,EAAE,OAAO,MAAO,EAAE,GAG/B,UAAU,iBAEX,KAAE,UAAU,0BAA0B,iDAEvC,GACF,SAEC,OACC,UAAAuiB,OAAC,SAAM,UAAU,qBAAqB,oCACZ,IACvB6uC,GAAmC,GACtC,EACA5uC,MAAC,SACC,KAAK,QACL,IAAI,IACJ,IAAI,IACJ,KAAK,IACL,MAAO4uC,GAAmC,EAC1C,SAAWpxD,GACTozD,EACE,SAASpzD,EAAE,OAAO,MAAO,EAAE,GAG/B,UAAU,iBAEX,KAAE,UAAU,0BAA0B,sDAEvC,GACF,GACF,GACF,GACF,GAEJ,GAEJ,GACF,EACF,QAGC,OAAI,UAAU,OACb,SAAAuiB,OAAC,OAAI,UAAU,8DACb,UAAAA,OAAC,OAAI,UAAU,6CACb,UAAAC,MAACw1C,GAAA,CAAQ,UAAU,0BAA0B,EAAE,kBACjD,EACAz1C,OAAC,OAAI,UAAU,YACb,UAAAA,OAAC,OAAI,UAAU,0BACb,UAAAC,MAAC,SACC,KAAK,WACL,GAAG,gBACH,QAASwtC,EACT,SAAWhwD,GAAMgyD,GAAiBhyD,EAAE,OAAO,OAAO,EAClD,UAAU,kBAEX,SAAM,QAAQ,gBAAgB,UAAU,UAAU,+BAEnD,GACF,EACCgwD,GACCztC,OAAAja,WAAA,CACE,UAAAia,OAAC,OACC,UAAAC,MAAC,SACC,QAAQ,cACR,UAAU,qBACX,mBAGDD,OAAC,UACC,cAAgBviB,GAAM,CACnBA,EAAU,iBACb,EACA,YAAcA,GAAM,CAClBA,EAAE,iBACJ,EACA,aAAeA,GAAM,CAClBA,EAAU,mBACb,EACA,GAAG,cACH,MAAOiwD,GAAe,GACtB,SAAWjwD,GAAMiyD,GAAejyD,EAAE,OAAO,KAAK,EAC9C,UAAU,uBAEV,gBAAC,UAAO,MAAM,GAAG,mBAAO,EACvBi3D,GAAgB,IAAI,CAACv7C,EAAGrZ,WACtB,UAAe,MAAOqZ,EAAE,SACtB,SAAAA,EAAE,MADQrZ,EAEb,CACD,IACH,EACF,SACC,OACC,UAAAkgB,OAAC,SACC,QAAQ,eACR,UAAU,qBACX,qBACU,KAAK,OAAO2tC,GAAgB,GAAK,GAAG,EAAE,OAEjD1tC,MAAC,SACC,KAAK,QACL,GAAG,eACH,IAAI,IACJ,IAAI,IACJ,KAAK,MACL,MAAO0tC,GAAgB,EACvB,SAAWlwD,GACTkyD,GAAgB,WAAWlyD,EAAE,OAAO,KAAK,CAAC,EAE5C,UAAU,UACZ,EACF,EACAuiB,OAAC,OAAI,UAAU,0BACb,UAAAC,MAAC,SACC,KAAK,WACL,GAAG,oBACH,QAAS2tC,EACT,SAAWnwD,GACTmyD,EAAqBnyD,EAAE,OAAO,OAAO,EAEvC,UAAU,kBAEX,SAAM,QAAQ,oBAAoB,UAAU,UAAU,sCAEvD,GACF,EACAwiB,MAAC,UACC,QAAS,IAAM,CACb,MAAMwiB,EAAM,IAAI,yBACd,2BAEF,GAAIirB,EAAa,CACf,MAAMv0C,GAAI,OAAO,gBACd,YACA,KAAM3Y,IAAMA,GAAE,WAAaktD,CAAW,EACrCv0C,OAAO,MAAQA,GACrB,CACAspB,EAAI,OAASkrB,GAAgB,EAC7B,OAAO,gBAAgB,MAAMlrB,CAAG,CAClC,EACA,UAAU,uDACX,0BAED,EACF,GAEJ,GACF,EACF,GACF,UAKH,OAAI,UAAU,6EACb,SAAAxiB,MAAC,OAAI,UAAU,iEACb,SAAAA,MAACg1C,GAAA,CACC,MAAM,WACN,KAAMn4C,GACN,KAAK,WACL,MAAM,gDACR,CACF,EACF,EAGCk4C,KAAiB,YAChBh1C,OAAC,OAAI,cAAY,wBAAwB,UAAU,YAEjD,UAAAC,MAAC,OAAI,UAAU,OACb,SAAAD,OAAC,OAAI,UAAU,8DACb,UAAAA,OAAC,OAAI,UAAU,yCACb,UAAAA,OAAC,OAAI,UAAU,wCACb,UAAAC,MAACglC,GAAA,CAAK,UAAU,yBAAyB,EAAE,mBAC7C,EACEwN,GAQAzyC,OAAC,UACC,QAAS6zC,GACT,UAAU,8HAEV,UAAA5zC,MAACy1C,GAAA,CAAK,UAAU,UAAU,EAAE,cAX9B11C,OAAC,UACC,QAAS,IAAM0yC,GAAa,EAAI,EAChC,UAAU,2HAEV,UAAAzyC,MAAC01C,GAAA,CAAM,UAAU,UAAU,EAAE,aAQ/B,EAEJ,EAEA11C,MAAC,OAAI,UAAU,YACZ,YACCD,OAAAja,WAAA,CACE,UAAAia,OAAC,OACC,gBAAC,SAAM,UAAU,qBAAqB,8BAEtC,EACAC,MAAC,SACC,KAAK,OACL,MAAO0yC,GACP,SAAWl1D,GAAMm1D,GAAan1D,EAAE,OAAO,KAAK,EAC5C,UAAU,gBACZ,EACF,SACC,OACC,gBAAC,SAAM,UAAU,qBAAqB,6BAEtC,EACAwiB,MAAC,SACC,KAAK,OACL,MAAO4yC,GACP,SAAWp1D,GAAMq1D,GAAWr1D,EAAE,OAAO,KAAK,EAC1C,UAAU,gBACZ,EACF,SACC,OACC,gBAAC,SAAM,UAAU,qBAAqB,6BAEtC,EACAwiB,MAAC,SACC,KAAK,OACL,MAAO8yC,GACP,SAAWt1D,GAAMu1D,GAAYv1D,EAAE,OAAO,KAAK,EAC3C,UAAU,gBACZ,EACF,SACC,OACC,gBAAC,SAAM,UAAU,qBAAqB,0BAEtC,EACAwiB,MAAC,YACC,MAAOgzC,GACP,SAAWx1D,GAAMy1D,GAAOz1D,EAAE,OAAO,KAAK,EACtC,KAAM,EACN,UAAU,gBACZ,EACF,GACF,EAEAuiB,OAAAja,WAAA,CACE,UAAAia,OAAC,OAAI,6BACc,IACjBA,OAAC,QAAK,UAAU,iBACb,UAAA2yC,IAAa,UAAU,OAC1B,GACF,SACC,OAAI,2BACY,IACf3yC,OAAC,QAAK,UAAU,iBACb,UAAA6yC,IAAW,UAAU,QACxB,GACF,SACC,OAAI,4BACa,IAChB7yC,OAAC,QAAK,UAAU,iBACb,UAAA+yC,IAAY,UAAU,OACzB,GACF,SACC,OAAI,iBACE,IACL/yC,OAAC,QAAK,UAAU,iBACb,UAAAizC,IAAO,aAAa,OACvB,GACF,GACF,EAEJ,GACF,EACF,QAGC,OAAI,UAAU,OACb,SAAAjzC,OAAC,OAAI,UAAU,4DACb,UAAAA,OAAC,OAAI,UAAU,6CACb,UAAAC,MAAC21C,GAAA,CAAS,UAAU,yBAAyB,EAAE,uBAEjD,EACA51C,OAAC,OAAI,UAAU,YACb,UAAAA,OAAC,OAAI,UAAU,0BACb,UAAAC,MAAC,SACC,KAAK,WACL,GAAG,mBACH,QAAS,CAAC,CAAC6xC,GACX,SAAWr0D,GAAMu0D,EAAoBv0D,EAAE,OAAO,OAAO,EACrD,UAAU,kBAEX,SAAM,QAAQ,mBAAmB,UAAU,UAAU,0CAEtD,GACF,EACCq0D,WACE,OACC,UAAA9xC,OAAC,SAAM,UAAU,iCAAiC,4BAChC,IACf+xC,EAAmB,KAAK,MAAMA,CAAgB,EAAI,EAAE,KACvD,EACA9xC,MAAC,SACC,KAAK,QACL,IAAI,IACJ,IAAI,KACJ,MAAO8xC,GAAoB,GAC3B,SAAWt0D,GACTw0D,GAAoB,SAASx0D,EAAE,OAAO,KAAK,CAAC,EAE9C,UAAU,iBAEX,OAAI,UAAU,0BAA0B,uGAGzC,GACF,SAED,OACC,UAAAwiB,MAAC,SACC,QAAQ,iBACR,UAAU,qBACX,oCAGDD,OAAC,UACC,cAAgBviB,GAAM,CACnBA,EAAU,iBACb,EACA,YAAcA,GAAM,CAClBA,EAAE,iBACJ,EACA,GAAG,iBACH,MAAO+vD,EACP,SAAW/vD,GAAM+xD,GAAkB/xD,EAAE,OAAO,KAAK,EACjD,UAAU,eAEV,gBAAC,UAAO,MAAM,MAAM,sBAAU,QAC7B,UAAO,MAAM,MAAM,qBAAS,QAC5B,UAAO,MAAM,MAAM,qBAAS,QAC5B,UAAO,MAAM,KAAK,oBAAQ,QAC1B,UAAO,MAAM,KAAK,oBAAQ,IAC7B,EACF,SACC,OACC,UAAAwiB,MAAC,SAAM,QAAQ,UAAU,UAAU,qBAAqB,gCAExD,EACAD,OAAC,UACC,GAAG,UACH,MAAO6tC,EACP,SAAWpwD,GACToyD,EAAWpyD,EAAE,OAAO,KAA2B,EAEjD,UAAU,eAEV,gBAAC,UAAO,MAAM,WAAW,4BAAgB,QACxC,UAAO,MAAM,MAAM,0BAAc,IACpC,EACF,EACAuiB,OAAC,OAAI,UAAU,0BACb,UAAAC,MAAC,SACC,KAAK,WACL,GAAG,cACH,QAAS,CAAC,CAACiyC,GACX,SAAWz0D,GAAM00D,GAAe10D,EAAE,OAAO,OAAO,EAChD,UAAU,kBAEX,SAAM,QAAQ,cAAc,UAAU,UAAU,qCAEjD,GACF,GACF,GACF,EACF,QAGC,OAAI,UAAU,OACb,SAAAuiB,OAAC,OAAI,UAAU,0DACb,UAAAA,OAAC,OAAI,UAAU,6CACb,UAAAC,MAACo1C,GAAA,CAAI,UAAU,wBAAwB,EAAE,2BAC3C,EACAr1C,OAAC,OAAI,UAAU,YACb,UAAAA,OAAC,OAAI,UAAU,0BACb,UAAAC,MAAC,SACC,KAAK,WACL,GAAG,mBACH,QAAS6tC,EACT,SAAWrwD,GAAMqyD,GAAoBryD,EAAE,OAAO,OAAO,EACrD,UAAU,kBAEX,SAAM,QAAQ,mBAAmB,UAAU,UAAU,uCAEtD,GACF,EACAuiB,OAAC,OAAI,UAAU,0BACb,UAAAC,MAAC,SACC,KAAK,WACL,GAAG,sBACH,QAAS8tC,EACT,SAAWtwD,GAAMsyD,GAAuBtyD,EAAE,OAAO,OAAO,EACxD,UAAU,kBAEX,SAAM,QAAQ,sBAAsB,UAAU,UAAU,kDAEzD,GACF,SACC,OACC,UAAAwiB,MAAC,SAAM,QAAQ,gBAAgB,UAAU,qBAAqB,0BAE9D,EACAD,OAAC,UACC,GAAG,gBACH,MAAOqvC,GAAiB,UACxB,SAAW5xD,GACTk0D,GAAiBl0D,EAAE,OAAO,KAA6B,EAEzD,UAAU,eAEV,gBAAC,UAAO,MAAM,UAAU,0BAAc,QACrC,UAAO,MAAM,SAAS,yBAAa,IACtC,EACF,EACAuiB,OAAC,OAAI,UAAU,0BACb,UAAAC,MAAC,SACC,KAAK,WACL,GAAG,gBACH,QAAS+tC,EACT,SAAWvwD,GAAMuyD,GAAiBvyD,EAAE,OAAO,OAAO,EAClD,UAAU,kBAEX,SAAM,QAAQ,gBAAgB,UAAU,UAAU,oCAEnD,GACF,EAEAuiB,OAAC,OAAI,UAAU,0BACb,UAAAC,MAAC,SACC,KAAK,WACL,GAAG,gBACH,QAASguC,EACT,SAAWxwD,GAAMwyD,GAAiBxyD,EAAE,OAAO,OAAO,EAClD,UAAU,kBAEX,SAAM,QAAQ,gBAAgB,UAAU,UAAU,0BAEnD,GACF,GACF,GACF,EACF,QAGC,OAAI,UAAU,OACb,SAAAuiB,OAAC,OAAI,UAAU,6DACb,UAAAA,OAAC,OAAI,UAAU,6CACb,UAAAC,MAACnD,GAAA,CAAS,UAAU,0BAA0B,EAAE,YAClD,EACAmD,MAAC,OACC,eAACotC,GAAA,EAAY,EACf,GACF,EACF,QAGC,OAAI,UAAU,OACb,SAAArtC,OAAC,OAAI,UAAU,0DACb,UAAAA,OAAC,OAAI,UAAU,6CACb,UAAAC,MAAC41C,GAAA,CAAW,UAAU,wBAAwB,EAAE,qBAElD,EACA71C,OAAC,OAAI,UAAU,YACb,gBAAC,KAAE,UAAU,qBAAqB,4CAElC,EACAC,MAAC,KACC,KAAK,oCACL,UAAU,mDACX,6BAED,EACF,GACF,EACF,QAGC,OAAI,UAAU,OACb,SAAAD,OAAC,OAAI,UAAU,0DACb,UAAAA,OAAC,OAAI,UAAU,6CACb,UAAAC,MAACG,GAAA,CAAc,UAAU,wBAAwB,EAAE,sBAErD,QACC,OAAI,UAAU,qCACZ,SAAAqzC,GAAa,IAAI,CAAChxB,EAAK3iC,KACtBmgB,MAAC,OAAY,UAAW,GAAGwiB,EAAI,OAAS,aAAe,EAAE,GACvD,SAAAxiB,MAAC,OACC,UAAW,sDAAsDwiB,EAAI,OAAS,2BAA6B,4BAA4B,GAEtI,gBAAOA,EAAI,MAAS,SACnBA,EAAI,KAEJziB,OAAAja,WAAA,CACE,gBAAC,OAAK,SAAA08B,EAAI,KAAK,KAAK,EACnBA,EAAI,KAAK,OACRxiB,MAAC,OAAI,UAAU,iBACZ,SAAAwiB,EAAI,KAAK,MAAM,IAAI,CAACqzB,GAAMnqD,KACzBsU,MAAC,UAEC,QAAS,IAAM8zC,GAAc+B,GAAK,GAAG,EACrC,UAAU,4FAET,SAAAA,GAAK,MAJDnqD,EAAA,CAMR,EACH,GAEJ,KAtBI7L,EAyBV,CACD,EACH,EAGAkgB,OAAC,OAAI,UAAU,kBACb,UAAAC,MAAC,SACC,KAAK,OACL,MAAO0zC,GACP,SAAWl2D,GAAMm2D,GAAan2D,EAAE,OAAO,KAAK,EAC5C,WAAaA,GAAMA,EAAE,MAAQ,SAAW02D,GAAA,EACxC,YAAY,qBACZ,UAAU,iBAEZl0C,MAAC,UACC,QAASk0C,GACT,UAAU,oCAEV,SAAAl0C,MAACklC,GAAA,CAAK,UAAU,UAAU,GAC5B,EACF,GACF,EACF,GACF,QAID,OAAI,UAAU,OACb,SAAAnlC,OAAC,OAAI,UAAU,8DACb,UAAAA,OAAC,OAAI,UAAU,6CACb,UAAAC,MAAC41C,GAAA,CAAW,UAAU,0BAA0B,EAAE,4BAEpD,QACC,OAAI,UAAU,wCACZ,SAAAzD,GAAa,IAAK/0D,GACjB2iB,OAAC,OAEC,UAAW,yBAAyB3iB,EAAE,SAAW,wCAA0C,4BAA4B,GACvH,MAAOA,EAAE,KAET,UAAA4iB,MAAC,OAAI,UAAU,UAAW,SAAA5iB,EAAE,KAAK,EACjC4iB,MAAC,OAAI,UAAU,6BAA8B,WAAE,MAAM,QACpD,OAAI,UAAU,yBACZ,SAAA5iB,EAAE,SAAW,aAAe,SAC/B,IARKA,EAAE,IAUV,EACH,GACF,EACF,GACF,CAEJ,CCv1DA,SAAwB04D,GAAK,CAAE,OAAAC,GAA2C,CACxE,KAAM,CAAC5nC,EAAMsd,CAAO,EAAI7sC,WAAwC,QAAQ,EAClE,CAACqa,EAAOssC,CAAQ,EAAI3mD,WAAS,EAAE,EAC/B,CAACo3D,EAAUC,CAAW,EAAIr3D,WAAS,EAAE,EACrC,CAACs3D,EAAUC,CAAW,EAAIv3D,WAAS,EAAE,EACrC,CAACw3D,EAAUC,CAAW,EAAIz3D,WAAS,EAAE,EACrC,CAACqhC,EAAOq2B,CAAQ,EAAI13D,WAAS,EAAE,EAC/B,CAAC23D,EAAcC,CAAe,EAAI53D,WAAS,EAAK,EAChD,CAAC8mD,EAASC,CAAU,EAAI/mD,WAAS,EAAK,EAEtC63D,EAAUj7C,GAAA,EAEVk7C,EAAmB,MACvBv6C,EACAT,EAAoB,GACpBi7C,EAAY,MACT,CACH,MAAMC,EAAa,IAAI,gBACjBC,EAAQ,OAAO,WAAW,IAAMD,EAAW,QAASD,CAAS,EACnE,GAAI,CACF,OAAO,MAAM,MAAMx6C,EAAO,CAAE,GAAGT,EAAM,OAAQk7C,EAAW,OAAQ,CAClE,SACE,OAAO,aAAaC,CAAK,CAC3B,CACF,EAEA,eAAeC,EAAat5D,EAAQ,CAClCA,EAAE,iBACF84D,EAAS,EAAE,EACX3Q,EAAW,EAAI,EAEf,GAAI,CACFoR,GAAA,IAAK,OAAO,oBAAQ,8BACpBA,GAAA,IAAK,OAAO,gCAAoB,gCAChCA,GAAA,IAAK,OAAO,2BAAe,kCAC3BA,GAAA,IAAK,OAAO,0BAAc,gCAC1BA,GAAA,IAAK,OAAO,0BAAc,8BAC5B,MAAY,CAAC,CACb,GAAI,CAACf,GAAY,CAACE,EAAU,CAC1BI,EAAS,iCAAiC,EAC1C3Q,EAAW,EAAK,EAChB,MACF,CACA,GAAI,CACF,QAAQ,KAAK,uBAAuB,EACpC,MAAM5pC,EAAM,MAAM26C,EAAiB,GAAGD,CAAO,kBAAmB,CAC9D,OAAQ,OACR,QAAS,CAAE,eAAgB,oBAC3B,KAAM,KAAK,UACTT,EAAS,SAAS,GAAG,EACjB,CAAE,MAAOA,EAAU,SAAAE,CAAA,EACnB,CAAE,SAAAF,EAAU,SAAAE,CAAA,CAAS,CAC3B,CACD,EACK71D,EAAO,MAAM0b,EAAI,OAAO,MAAM,KAAO,GAAG,EAC9C,QAAQ,QAAQ,uBAAuB,EACnCA,EAAI,SAAW,IACjBu6C,EACE,kEAEOv6C,EAAI,IAAM1b,GAAM,MAAQA,GAAM,OACvC,aAAa,QAAQ,YAAaA,EAAK,KAAK,EAC5C01D,EAAO11D,EAAK,IAAI,GAEhBi2D,EAASj2D,GAAM,OAAS,+BAA+B,CAE3D,OAASyb,EAAU,CACjB,QAAQ,MAAM,eAAgBA,CAAG,EACjC,QAAQ,IAAI,4BAA6B,GAAG26C,CAAO,iBAAiB,EAChE36C,GAAK,OAAS,aAChBw6C,EACE,6CAA6CG,CAAO,4DAGtDH,EACE,kBAAkBx6C,GAAK,SAAW,eAAe,aAAa26C,CAAO,gDAG3E,SACE9Q,EAAW,EAAK,CAClB,CACF,CAEA,eAAeqR,EAAax5D,EAAQ,CAIlC,GAHAA,EAAE,iBACF84D,EAAS,EAAE,EACX3Q,EAAW,EAAI,EACX,CAAC1sC,GAAS,CAAC+8C,GAAY,CAACE,EAAU,CACpCI,EAAS,yCAAyC,EAClD3Q,EAAW,EAAK,EAChB,MACF,CACA,GAAI,CACF,MAAM5pC,EAAM,MAAM26C,EAAiB,GAAGD,CAAO,mBAAoB,CAC/D,OAAQ,OACR,QAAS,CAAE,eAAgB,oBAC3B,KAAM,KAAK,UAAU,CAAE,MAAAx9C,EAAO,SAAA+8C,EAAU,SAAAE,EAAU,EACnD,EACK71D,EAAO,MAAM0b,EAAI,OAAO,MAAM,KAAO,GAAG,EAC1CA,EAAI,IAAM1b,GAAM,MAAQA,GAAM,OAChC,aAAa,QAAQ,YAAaA,EAAK,KAAK,EAC5C01D,EAAO11D,EAAK,IAAI,GAEhBi2D,EAASj2D,GAAM,OAAS,gBAAgB,CAE5C,OAASyb,EAAU,CACbA,GAAK,OAAS,aAChBw6C,EAAS,qCAAqC,EAE9CA,EAAS,gBAAgB,CAE7B,SACE3Q,EAAW,EAAK,CAClB,CACF,CAEA,eAAesR,EAAYz5D,EAAQ,CAIjC,GAHAA,EAAE,iBACF84D,EAAS,EAAE,EACX3Q,EAAW,EAAI,EACX,CAAC1sC,GAAS,CAACA,EAAM,SAAS,GAAG,EAAG,CAClCq9C,EAAS,2BAA2B,EACpC3Q,EAAW,EAAK,EAChB,MACF,CACA,GAAI,CAMF,MAAMj6C,EAAI,MALA,MAAMgrD,EAAiB,GAAGD,CAAO,uBAAwB,CACjE,OAAQ,OACR,QAAS,CAAE,eAAgB,oBAC3B,KAAM,KAAK,UAAU,CAAE,MAAAx9C,EAAO,EAC/B,GACiB,OAAO,MAAM,KAAO,GAAG,EACzC,GAAI,CAACvN,GAAG,GAAI,MAAM,IAAI,MAAMA,GAAG,OAAS,4BAA4B,EACpE4qD,EAAS,yCAAyC,CACpD,OAASx6C,EAAU,CACjBw6C,EAASx6C,GAAK,SAAW,4BAA4B,CACvD,SACE6pC,EAAW,EAAK,CAClB,CACF,CAEA,eAAeuR,EAAmB15D,EAAQ,CAIxC,GAHAA,EAAE,iBACF84D,EAAS,EAAE,EACX3Q,EAAW,EAAI,EACX,CAAC1sC,GAAS,CAACA,EAAM,SAAS,GAAG,EAAG,CAClCq9C,EAAS,2BAA2B,EACpC3Q,EAAW,EAAK,EAChB,MACF,CACA,GAAI,CAMF,MAAMj6C,EAAI,MALA,MAAMgrD,EAAiB,GAAGD,CAAO,0BAA2B,CACpE,OAAQ,OACR,QAAS,CAAE,eAAgB,oBAC3B,KAAM,KAAK,UAAU,CAAE,MAAAx9C,EAAO,EAC/B,GACiB,OAAO,MAAM,KAAO,GAAG,EACzC,GAAI,CAACvN,GAAG,GAAI,MAAM,IAAI,MAAMA,GAAG,OAAS,+BAA+B,EACvE4qD,EAAS,wCAAwC,CACnD,OAASx6C,EAAU,CACjBw6C,EAASx6C,GAAK,SAAW,+BAA+B,CAC1D,SACE6pC,EAAW,EAAK,CAClB,CACF,CAEA,OACE5lC,OAAC,OAAI,UAAU,0FAEb,UAAAA,OAAC,OAAI,UAAU,0EACb,UAAAC,MAAC,OAAI,UAAU,6FAA6F,EAC5GA,MAAC,OAAI,UAAU,iGAAiG,GAClH,EAEAD,OAAC,OAAI,UAAU,gCACb,UAAAA,OAAC,OAAI,UAAU,mBACb,UAAAC,MAAC,MAAG,UAAU,4HAA4H,+BAE1I,EACAA,MAAC,KAAE,UAAU,+DACV,SAAAmO,IAAS,SACN,aACAA,IAAS,SACP,mBACA,oBACR,GACF,EAEAnO,MAAC,OAAI,UAAU,8CACZ,UACC,CAAE,IAAK,SAAU,MAAO,WACxB,CAAE,IAAK,SAAU,MAAO,WACxB,CAAE,IAAK,QAAS,MAAO,QAAQ,EAC/B,IAAKm3C,GACLn3C,MAAC,UAEC,KAAK,SACL,QAAS,IAAMyrB,EAAQ0rB,EAAO,GAAkB,EAChD,UAAW,2EAA2EhpC,IAASgpC,EAAO,IAAM,2BAA6B,4CAA4C,GAEpL,SAAAA,EAAO,OALHA,EAAO,IAOf,EACH,EAEAn3C,MAAC,OAAI,UAAU,0FACb,SAAAD,OAAC,QACC,UAAU,YACV,SACEoO,IAAS,SACL2oC,EACA3oC,IAAS,SACP6oC,EACAC,EAGN,WAAA9oC,IAAS,UAAYA,IAAS,UAC9BnO,MAAC,SACC,UAAU,eACV,KAAK,QACL,YAAY,QACZ,MAAO/G,EACP,SAAWzb,GAAM+nD,EAAS/nD,EAAE,OAAO,KAAK,EACxC,aAAa,QACb,SAAQ,KAGX2wB,IAAS,SACRnO,MAAC,SACC,UAAU,eACV,KAAK,OACL,YAAY,oBACZ,MAAOg2C,EACP,SAAWx4D,GAAMy4D,EAAYz4D,EAAE,OAAO,KAAK,EAC3C,aAAa,WACb,SAAQ,KAGX2wB,IAAS,SACRpO,OAAC,OAAI,UAAU,WACb,UAAAC,MAAC,SACC,UAAU,qBACV,KAAMu2C,EAAe,OAAS,WAC9B,YAAY,WACZ,MAAOL,EACP,SAAW14D,GAAM24D,EAAY34D,EAAE,OAAO,KAAK,EAC3C,aAAa,mBACb,SAAQ,GACR,QAAS,IAAMg5D,EAAgB,EAAK,EACpC,OAAQ,IAAMA,EAAgB,EAAK,IAErCx2C,MAAC,UACC,KAAK,SACL,UAAU,4EACV,SAAU,GACV,YAAcxiB,GAAM,CAClBA,EAAE,iBACFg5D,EAAgB,EAAI,CACtB,EACA,UAAYh5D,GAAM,CAChBA,EAAE,iBACFg5D,EAAgB,EAAK,CACvB,EACA,aAAc,IAAMA,EAAgB,EAAK,EACzC,aAAeh5D,GAAM,CACnBA,EAAE,iBACFg5D,EAAgB,EAAI,CACtB,EACA,WAAah5D,GAAM,CACjBA,EAAE,iBACFg5D,EAAgB,EAAK,CACvB,EACA,aAAW,6BAEV,SAAAD,QACEa,GAAA,CAAO,UAAU,UAAU,EAE5Bp3C,MAACo1C,GAAA,CAAI,UAAU,UAAU,GAE7B,EACF,EAEDjnC,IAAS,UACRnO,MAAC,SACC,UAAU,eACV,KAAK,OACL,YAAY,+BACZ,MAAOo2C,EACP,SAAW54D,GAAM64D,EAAY74D,EAAE,OAAO,KAAK,EAC3C,aAAa,QAGhByiC,GACCjgB,MAAC,OAAI,UAAU,qCAAsC,SAAAigB,EAAM,EAE7DjgB,MAAC,UACC,KAAK,SACL,SAAU0lC,EACV,UAAU,gOAET,SAAAA,EACC3lC,OAAC,OAAI,UAAU,yCACb,UAAAC,MAAC,OAAI,UAAU,4EAA4E,EAAE,iBAE/F,EACEmO,IAAS,SACX,aACEA,IAAS,SACX,YAEA,uBAIHA,IAAS,UACRpO,OAAAja,WAAA,CACE,UAAAka,MAAC,UACC,KAAK,SACL,QAASk3C,EACT,UAAU,oFACX,qCAGDl3C,MAAC,UACC,KAAK,SACL,QAAS,IAAM,CACb,aAAa,QACbs2C,EAAS,6CAA6C,CACxD,EACA,UAAU,oFACX,oCAGDt2C,MAAC,UACC,KAAK,SACL,QAAS,SAAY,CACnBs2C,EAAS,EAAE,EACX3Q,EAAW,EAAI,EACf,GAAI,CACF,QAAQ,IACN,yBACA,GAAG8Q,CAAO,eAEZ,MAAM16C,EAAM,MAAM26C,EAChB,GAAGD,CAAO,cACV,CACE,OAAQ,OAEV,KAEE16C,EAAI,GACNu6C,EAAS,4BAA4BG,CAAO,EAAE,EAE9CH,EACE,mCAAmCv6C,EAAI,MAAM,OAAO06C,CAAO,GAGjE,OAAS36C,EAAU,CACjBw6C,EACE,4BAA4BG,CAAO,YAAY36C,GAAK,SAAW,SAAS,4CAE5E,SACE6pC,EAAW,EAAK,CAClB,CACF,EACA,UAAU,oFACX,sCAED,EACF,KAGN,QAEC,OAAI,UAAU,+BACb,SAAA5lC,OAAC,OAAI,UAAU,wDACb,UAAAC,MAAC,MAAG,UAAU,uCAAuC,4BAErD,EACAD,OAAC,MAAG,UAAU,YACZ,UAAAA,OAAC,MAAG,UAAU,yBACZ,UAAAC,MAACtD,GAAA,CAAM,UAAU,+BAA+B,SAC/C,OACC,UAAAsD,MAAC,OAAI,UAAU,gBAAgB,4BAAgB,EAC/CA,MAAC,OAAI,UAAU,4BAA4B,sDAE3C,GACF,GACF,EACAD,OAAC,MAAG,UAAU,yBACZ,UAAAC,MAACq3C,GAAA,CAAU,UAAU,+BAA+B,SACnD,OACC,UAAAr3C,MAAC,OAAI,UAAU,gBAAgB,sBAAU,EACzCA,MAAC,OAAI,UAAU,4BAA4B,uDAE3C,GACF,GACF,EACAD,OAAC,MAAG,UAAU,yBACZ,UAAAC,MAACrD,GAAA,CAAO,UAAU,+BAA+B,SAChD,OACC,UAAAqD,MAAC,OAAI,UAAU,gBAAgB,sBAAU,EACzCA,MAAC,OAAI,UAAU,4BAA4B,0GAG3C,GACF,GACF,EACAD,OAAC,MAAG,UAAU,yBACZ,UAAAC,MAACs3C,GAAA,CAAY,UAAU,+BAA+B,SACrD,OACC,UAAAt3C,MAAC,OAAI,UAAU,gBAAgB,yBAAa,EAC5CA,MAAC,OAAI,UAAU,4BAA4B,6DAE3C,GACF,GACF,EACAD,OAAC,MAAG,UAAU,yBACZ,UAAAC,MAACG,GAAA,CAAc,UAAU,+BAA+B,SACvD,OACC,UAAAH,MAAC,OAAI,UAAU,gBAAgB,wBAAY,EAC3CA,MAAC,OAAI,UAAU,4BAA4B,0DAE3C,GACF,GACF,GACF,GACF,EACF,GACF,GACF,CAEJ,CCxbO,MAAMosC,GAAgBmL,GCA7B,SAAwBC,IAAgB,CACtC,KAAM,CAACC,EAAQC,CAAS,EAAI94D,WAAS,EAAK,EACpC,CAAC0kD,EAAUC,CAAW,EAAI3kD,WAO9B,CACA,CACE,KAAM,qEACN,OAAQ,GACV,CACD,EACK,CAACud,EAAOqnC,CAAQ,EAAI5kD,WAAS,EAAE,EAC/B,CAAC+4D,EAAsBC,CAAuB,EAAIh5D,WAAS,EAAK,EAChE,CAACi5D,EAAkBC,CAAmB,EAAIl5D,WAAS,EAAE,EACrD,CAACm5D,EAAWC,CAAY,EAAIp5D,WAAqB,IAAI,EACrD6vB,GAAM,IAAM,CAChB,GAAI,CACF,OAAOia,GAAA,CACT,MAAQ,CACN,OAAO,IACT,CACF,KAEA/uB,YAAU,IAAM,CACd,GAAI,CAAC8U,EAAI,OACT,MAAM06B,EAAQ16B,EAAG,YAAapuB,GAAc,CAC1C,GAAI,CAEAA,GAAM,OAAS,gBACf03D,IACA,OAAO13D,EAAK,SAAS,EAAM,OAAO03D,EAAU,EAAE,GAM9C13D,GAAM,OAAS,wBACf03D,GACA13D,EAAK,SAAS,KAAO03D,EAAU,IAE/BC,EAAa33D,EAAK,OAAO,CAE7B,MAAQ,CAAC,CACX,CAAC,EACD,MAAO,IAAM8oD,EAAA,CACf,EAAG,CAAC16B,EAAIspC,CAAS,CAAC,EAElB,MAAMjE,EAAiBC,GAAmB,CACxC,GAAI,CACF,OAAO,cACL,IAAI,YAAY,iBAAkB,CAAE,OAAQ,CAAE,IAAKA,EAAO,CAAG,GAE/D2D,EAAU,EAAK,CACjB,OAASz3B,EAAO,CACd,QAAQ,MAAM,qBAAsBA,CAAK,CAC3C,CACF,EAEM+zB,EACJ3P,GACmE,CACnE,MAAMpJ,EAAUoJ,EAAY,cAE5B,OAAIpJ,EAAQ,SAAS,UAAU,GAAKA,EAAQ,SAAS,aAAa,EACzD,CACL,KAAM,8CACN,MAAO,CAAC,CAAE,KAAM,2BAA4B,IAAK,WAAY,GAI/DA,EAAQ,SAAS,SAAS,GAC1BA,EAAQ,SAAS,SAAS,GAC1BA,EAAQ,SAAS,cAAc,EAExB,CACL,KAAM,+CACN,MAAO,CAAC,CAAE,KAAM,oBAAqB,IAAK,SAAU,GAItDA,EAAQ,SAAS,UAAU,GAC3BA,EAAQ,SAAS,QAAQ,GACzBA,EAAQ,SAAS,QAAQ,EAElB,CACL,KAAM,2CACN,MAAO,CAAC,CAAE,KAAM,mCAAoC,IAAK,WAAY,GAIvEA,EAAQ,SAAS,OAAO,GACxBA,EAAQ,SAAS,QAAQ,GACzBA,EAAQ,SAAS,OAAO,EAEjB,CACL,KAAM,oCACN,MAAO,CAAC,CAAE,KAAM,iCAAkC,IAAK,WAAY,GAGnEA,EAAQ,SAAS,QAAQ,GAAKA,EAAQ,SAAS,eAAe,EACzD,CACL,KAAM,gCACN,MAAO,CAAC,CAAE,KAAM,gBAAiB,IAAK,UAAW,GAInDA,EAAQ,SAAS,MAAM,GACvBA,EAAQ,SAAS,OAAO,GACxBA,EAAQ,SAAS,aAAa,EAEvB,CACL,KAAM,wCACN,MAAO,CAAC,CAAE,KAAM,cAAe,IAAK,QAAS,GAI/CA,EAAQ,SAAS,SAAS,GAC1BA,EAAQ,SAAS,UAAU,GAC3BA,EAAQ,SAAS,UAAU,EAEpB,CACL,KAAM,6BACN,MAAO,CAAC,CAAE,KAAM,iBAAkB,IAAK,WAAY,GAGnDA,EAAQ,SAAS,YAAY,GAAKA,EAAQ,SAAS,aAAa,EAC3D,CACL,KAAM,0CACN,MAAO,CAAC,CAAE,KAAM,oBAAqB,IAAK,cAAe,GAI3DA,EAAQ,SAAS,OAAO,GACxBA,EAAQ,SAAS,SAAS,GAC1BA,EAAQ,SAAS,WAAW,EAErB,CACL,KAAM,gIACN,MAAO,CAAC,CAAE,KAAM,sBAAuB,IAAK,eAAgB,GAI9DA,EAAQ,SAAS,MAAM,GACvBA,EAAQ,SAAS,SAAS,GAC1BA,EAAQ,SAAS,OAAO,GACxBA,EAAQ,SAAS,gBAAgB,EAE1B,CACL,KAAM,0HACN,MAAO,CAAC,CAAE,KAAM,eAAgB,IAAK,UAAW,GAIlDA,EAAQ,SAAS,WAAW,GAC5BA,EAAQ,SAAS,UAAU,GAC3BA,EAAQ,SAAS,MAAM,EAEhB,CACL,KAAM,kJACN,MAAO,CAAC,CAAE,KAAM,kBAAmB,IAAK,aAAc,GAIxDA,EAAQ,SAAS,SAAS,GAC1BA,EAAQ,SAAS,WAAW,GAC5BA,EAAQ,SAAS,OAAO,EAEjB,CACL,KAAM,oIACN,MAAO,CAAC,CAAE,KAAM,oBAAqB,IAAK,SAAU,GAItDA,EAAQ,SAAS,MAAM,GACvBA,EAAQ,SAAS,SAAS,GAC1BA,EAAQ,SAAS,KAAK,EAEf,CACL,KAAM,yEACN,MAAO,CAAC,CAAE,KAAM,2BAA4B,IAAK,WAAY,GAI/DA,EAAQ,SAAS,aAAa,GAC9BA,EAAQ,SAAS,MAAM,GACvBA,EAAQ,SAAS,OAAO,EAEjB,CACL,KAAM,mHACN,MAAO,CACL,CAAE,KAAM,cAAe,IAAK,UAC5B,CAAE,KAAM,eAAgB,IAAK,UAAU,CACzC,EAIG,CACL,KAAM,0IAEV,EAEMgd,EAAa,IAAM,CACvB,GAAI,CAAC97C,EAAM,OAAQ,OACnB,MAAM+7C,EAAiB/7C,EAAM,OACvBkoC,EAAc6T,EAAe,cAKnC,GAJA3U,EAAa1vC,GAAS,CAAC,GAAGA,EAAM,CAAE,KAAMqkD,EAAgB,OAAQ,GAAM,CAAC,EACvE1U,EAAS,EAAE,EAGPmU,EACF,GAAItT,EAAY,WAAW,GAAG,EAAG,CAE/Bd,EAAa1vC,GAAS,CACpB,GAAGA,EACH,CACE,KAAM,wEACN,OAAQ,GACV,CACD,EACD+jD,EAAwB,EAAK,GAE5B,SAAY,CACX,GAAI,CAOF,MAAMlsD,EAAI,MALE,MAAM+P,GAAS,qBAAsB,CAC/C,OAAQ,OACR,QAAS,CAAE,eAAgB,oBAC3B,KAAM,KAAK,UAJG,CAAE,QAASo8C,GAAoBK,CAAA,CAIjB,EAC7B,GACmB,OAAO,MAAM,IAAM,IAAI,EAEvCxsD,GAAKA,EAAE,SACTssD,EAAatsD,EAAE,OAAO,EACtB63C,EAAa1vC,GAAS,CACpB,GAAGA,EACH,CACE,KAAM,wEACN,OAAQ,GACV,CACD,GAED0vC,EAAa1vC,GAAS,CACpB,GAAGA,EACH,CACE,KAAM,wEACN,OAAQ,GACV,CACD,CAEL,MAAc,CACZ0vC,EAAa1vC,GAAS,CACpB,GAAGA,EACH,CACE,KAAM,oDACN,OAAQ,GACV,CACD,CACH,CACF,KACA,MACF,KAAO,CACL0vC,EAAa1vC,GAAS,CACpB,GAAGA,EACH,CACE,KAAM,qEACN,OAAQ,GACV,CACD,EACD+jD,EAAwB,EAAK,EAC7B,MACF,CAIF,MAAMz2B,EAAW6yB,EAAqB3P,CAAW,EAGjD,GACE,OAAOljB,EAAS,MAAS,UACzBA,EAAS,KAAK,SAAS,yBAAyB,EAChD,CACA22B,EAAoBI,CAAc,EAClCN,EAAwB,EAAI,EAC5B,WAAW,IAAM,CACfrU,EAAa1vC,GAAS,CACpB,GAAGA,EACH,CACE,KAAM,CACJ,KAAM,yFACN,MAAO,EAAC,EAEV,OAAQ,GACV,CACD,CACH,EAAG,GAAG,EACN,MACF,CAEA,WAAW,IAAM,CACf0vC,EAAa1vC,GAAS,CAAC,GAAGA,EAAM,CAAE,KAAMstB,EAAU,OAAQ,GAAO,CAAC,CACpE,EAAG,GAAG,CACR,EAEA,OACEphB,OAAAja,WAAA,CAEE,UAAAka,MAAC,UACC,QAAS,IAAM03C,EAAU,EAAI,EAC7B,UAAU,oHACV,MAAM,iBAEN,SAAA13C,MAAC41C,GAAA,CAAW,UAAU,UAAU,IAIjC6B,GACC13C,OAAC,OAAI,UAAU,oDACb,UAAAC,MAAC,OACC,UAAU,+BACV,QAAS,IAAM03C,EAAU,EAAK,IAEhC33C,OAAC,OAAI,UAAU,gFAEb,UAAAA,OAAC,OAAI,UAAU,kEACb,UAAAA,OAAC,OAAI,UAAU,0BACb,UAAAC,MAACG,GAAA,CAAc,UAAU,wBAAwB,EACjDH,MAAC,QAAK,UAAU,gBAAgB,0BAAc,GAChD,EACAA,MAAC,UACC,QAAS,IAAM03C,EAAU,EAAK,EAC9B,UAAU,kCAEV,SAAA13C,MAAC2Q,GAAA,CAAE,UAAU,UAAU,GACzB,EACF,EAGA3Q,MAAC,OAAI,UAAU,uCACZ,WAAS,IAAI,CAACwiB,EAAK3iC,IAClBmgB,MAAC,OAEC,UAAW,QAAQwiB,EAAI,OAAS,cAAgB,eAAe,GAE/D,SAAAxiB,MAAC,OACC,UAAW,iCACTwiB,EAAI,OACA,yBACA,6BACN,GAEC,gBAAOA,EAAI,MAAS,SACnBA,EAAI,KAEJziB,OAAC,OAAI,UAAU,YACb,UAAAC,MAAC,OAAK,SAAAwiB,EAAI,KAAK,KAAK,EACnBA,EAAI,KAAK,OACRxiB,MAAC,OAAI,UAAU,YACZ,SAAAwiB,EAAI,KAAK,MAAM,IAAI,CAACqzB,EAAMsC,IACzBn4C,MAAC,UAEC,QAAS,IAAM8zC,EAAc+B,EAAK,GAAG,EACrC,UAAU,6EAET,SAAAA,EAAK,MAJDsC,CAAA,CAMR,EACH,GAEJ,GAEJ,EA9BKt4D,CAAA,CAgCR,EACH,QAGC,OAAI,UAAU,gCACb,SAAAkgB,OAAC,OAAI,UAAU,aACb,UAAAC,MAAC,SACC,KAAK,OACL,MAAO7D,EACP,SAAW3e,GAAMgmD,EAAShmD,EAAE,OAAO,KAAK,EACxC,WAAaA,GAAMA,EAAE,MAAQ,SAAWy6D,EAAA,EACxC,YAAY,qBACZ,UAAU,iBAEZj4C,MAAC,UACC,QAASi4C,EACT,UAAU,oCAEV,SAAAj4C,MAACklC,GAAA,CAAK,UAAU,UAAU,GAC5B,EACF,EACF,GACF,GACF,EAID6S,GACC/3C,MAACmjC,GAAA,CACC,QAAS4U,EACT,KAAM,CAAE,MAAO,KAAM,SAAU,KAAM,QAAS,IAC9C,QAAS,IAAMC,EAAa,IAAI,GAClC,EAEJ,CAEJ,CC3ZA,SAAwBI,IAAqB,CAC3C,MAAM/V,EAASr0B,GAAA,EACTqqC,EAAej2D,SAAY,EAAE,EAC7BklC,EAAellC,SAAY,EAAE,EAEnCuX,mBAAU,IAAM,CACd,SAAS2+C,EAAUC,EAAS,iBAAkB,CAC5C,GAAI,CACF,MAAM/2B,EAAQ6gB,EAAO,qBACfmW,EAAQnW,EAAO,iBACf7zB,EAAK6zB,EAAO,UAAYA,EAAO,WAC/B5zB,EAAK4zB,EAAO,UAAYA,EAAO,WACrCphC,GAAKs3C,EAAQ,CACX,YAAalW,EAAO,YACpB,KAAMA,EAAO,KACb,YAAaA,EAAO,YACpB,gBAAiB,CAAC,CAAC7gB,EACnB,MAAOA,EACH,CACE,WAAYA,EAAM,WAClB,YAAaA,EAAM,YACnB,UAAW,CAAC,CAACA,EAAM,WAErB,KACJ,YAAag3B,EACTA,EACG,YACA,IAAKz6D,IAAO,CAAE,KAAMA,EAAE,KAAM,QAASA,EAAE,QAAS,GAAIA,EAAE,IAAK,EAC9D,KACJ,QAASywB,EAAKA,EAAG,iBAAmBA,EAAG,mBAAqB,KAC5D,QAASC,EAAKA,EAAG,YAAc,UAAY,KAC5C,CACH,OAASjxB,EAAG,CACV,QAAQ,KAAK,kCAAmCA,CAAC,CACnD,CACF,CAGA86D,EAAU,qBAAqB,EAG/B,IAAIz5C,EAAU,GACd,MAAMQ,EAAW,YAAY,IAAM,CACjC,GAAKR,EACL,GAAI,CACF,MAAM2iB,EAAQ6gB,EAAO,qBACfmW,EAAQnW,EAAO,iBACf7zB,EAAK6zB,EAAO,UAAYA,EAAO,WAC/BoW,EAAW,CACf,YAAapW,EAAO,YACpB,KAAMA,EAAO,KACb,SAAU,CAAC,CAAC7gB,EACZ,OAAQA,EAAQA,EAAM,WAAa,EACnC,OAAQA,EAAQA,EAAM,YAAc,EACpC,OAAQg3B,EAAQA,EAAM,YAAY,OAAS,EAC3C,QAAShqC,EAAKA,EAAG,iBAAmBA,EAAG,mBAAqB,MAExD3a,EAAOwkD,EAAa,SAGxBI,EAAS,cAAgB5kD,EAAK,aAC9B4kD,EAAS,WAAa5kD,EAAK,UAC3B4kD,EAAS,SAAW5kD,EAAK,QACzB4kD,EAAS,SAAW5kD,EAAK,QACzB4kD,EAAS,SAAW5kD,EAAK,QACzB4kD,EAAS,UAAY5kD,EAAK,SAC1BwuC,EAAO,cAAgBxuC,EAAK,eAE5BwkD,EAAa,QAAUI,EACvBH,EAAU,uBAAuB,EAErC,OAAS96D,EAAG,CACV,QAAQ,KAAK,6BAA8BA,CAAC,CAC9C,CACF,EAAG,GAAG,EAGN,SAASk7D,EAAqBx/C,EAA4B,CACxD,GAAI,CACF,MAAMrF,EAAOyzB,EAAa,QAAQ,MAClC,GAAIzzB,GAAQA,EAAK,KAAOqF,EAAG,OAC3B,GAAIrF,GAAQA,EAAK,GAAI,CACnB,GAAI,CACFA,EAAK,GAAG,oBAAoB,iBAAkBA,EAAK,cAAc,CACnE,MAAQ,CAAC,CACT,GAAI,CACFA,EAAK,GAAG,oBAAoB,UAAWA,EAAK,OAAO,CACrD,MAAQ,CAAC,CACT,GAAI,CACFA,EAAK,GAAG,oBAAoB,QAASA,EAAK,KAAK,CACjD,MAAQ,CAAC,CACT,GAAI,CACFA,EAAK,GAAG,oBAAoB,QAASA,EAAK,KAAK,CACjD,MAAQ,CAAC,CACX,CAEA,GADAyzB,EAAa,QAAQ,MAAQ,KACzBpuB,EAAG,CACL,MAAMy/C,EAAiB,IACrB13C,GAAK,sCAAuC,CAC1C,WAAY/H,EAAE,WACd,YAAaA,EAAE,YAChB,EACG0/C,EAAU,IAAM,CACpB33C,GAAK,+BAAgC,CAAE,OAAQ/H,EAAE,OAAQ,CAC3D,EACM2/C,EAAQ,IAAM,CAClB53C,GAAK,4BAA4B,CACnC,EACM63C,EAAQ,IAAM,CAClB73C,GAAK,4BAA4B,CACnC,EACA/H,EAAE,iBAAiB,iBAAkBy/C,CAAc,EACnDz/C,EAAE,iBAAiB,UAAW0/C,CAAO,EACrC1/C,EAAE,iBAAiB,QAAS2/C,CAAK,EACjC3/C,EAAE,iBAAiB,QAAS4/C,CAAK,EACjCxxB,EAAa,QAAQ,MAAQ,CAC3B,GAAIpuB,EACJ,eAAAy/C,EACA,QAAAC,EACA,MAAAC,EACA,MAAAC,CAAA,CAEJ,CACF,OAASt7D,EAAG,CACV,QAAQ,KAAK,6CAA8CA,CAAC,CAC9D,CACF,CAGA,SAASu7D,EAASvqC,EAA8B,CAC9C,GAAI,CACF,MAAM3a,EAAOyzB,EAAa,QAAQ,GAClC,GAAIzzB,GAAQA,EAAK,KAAO2a,EAAI,OAC5B,GAAI3a,GAAQA,EAAK,GACf,GAAI,CACFA,EAAK,GAAG,oBACN,wBACAA,EAAK,WAET,MAAQ,CAAC,CAGX,GADAyzB,EAAa,QAAQ,GAAK,KACtB9Y,EAAI,CACN,MAAMwqC,EAAa,IACjB/3C,GAAK,iCAAkC,CACrC,gBAAiBuN,EAAG,gBACpB,SAAWA,EAAW,mBACvB,EACHA,EAAG,iBAAiB,wBAAyBwqC,CAAU,EACvD1xB,EAAa,QAAQ,GAAK,CAAE,GAAA9Y,EAAI,WAAAwqC,CAAA,CAClC,CACF,OAASx7D,EAAG,CACV,QAAQ,KAAK,iCAAkCA,CAAC,CAClD,CACF,CAGA,MAAMy7D,EAAiB,YAAY,IAAM,CACvC,GAAI,CACFP,EAAqBrW,EAAO,oBAAoB,EAChD0W,EAAS1W,EAAO,UAAYA,EAAO,UAAU,CAC/C,MAAY,CAAC,CACf,EAAG,GAAI,EAEP,MAAO,IAAM,CACXxjC,EAAU,GACV,cAAcQ,CAAQ,EACtB,cAAc45C,CAAc,EAE5B,GAAI,CACF,MAAM//C,EAAIouB,EAAa,QAAQ,MAC3BpuB,GAAKA,EAAE,KACTA,EAAE,GAAG,oBAAoB,iBAAkBA,EAAE,cAAc,EAC3DA,EAAE,GAAG,oBAAoB,UAAWA,EAAE,OAAO,EAEjD,MAAY,CAAC,CACb,GAAI,CACF,MAAMjc,EAAIqqC,EAAa,QAAQ,GAC3BrqC,GAAKA,EAAE,IACTA,EAAE,GAAG,oBAAoB,wBAAyBA,EAAE,UAAU,CAClE,MAAY,CAAC,CACf,CACF,EAAG,CAAColD,CAAM,CAAC,EAEJ,IACT,CCxLA,SAAwB6W,IAAuB,CAC7C,MAAM7W,EAASr0B,GAAA,EACTmrC,EAAO/2D,SAAgC,IAAI,EAC3Cg3D,EAAgBh3D,SAA2B,IAAI,EAC/Ci3D,EAAcj3D,SAAe,CAAC,EAC9Bk3D,EAAkBl3D,SAAe,CAAC,EAClCm3D,EAAqBn3D,SAAe,CAAC,EACrCo3D,EAAap3D,SAAe,CAAC,EAKnCuX,mBAAU,IAAM,CACVw/C,EAAK,SACP9W,EAAO,mBAAmB8W,EAAK,OAAO,CAE1C,EAAG,CAAC9W,CAAM,CAAC,EAGX1oC,YAAU,IAAM,CACd,IAAIkF,EAAU,GAEd,MAAM46C,EAAQ,SAAY,CACxB,GAAK56C,EACL,GAAI,CACF,MAAMuS,EAAIixB,EAAO,iBACXqX,EAAMP,EAAK,QACjB,GAAI,CAACO,GAAO,CAACtoC,EAAG,QACZgoC,EAAc,UAAYhoC,GAAKsoC,EAAI,YAActoC,KACnDsoC,EAAI,UAAYtoC,EAChBgoC,EAAc,QAAUhoC,GAE1BsoC,EAAI,MAAQ,GACXA,EAAY,YAAc,GAC3B,GAAI,CACF,MAAMA,EAAI,MACZ,MAAQ,CAAC,CACX,MAAQ,CAAC,CACX,EAGAD,EAAA,EACA,MAAM17D,EAAI,YAAY07D,EAAO,GAAG,EAChC,MAAO,IAAM,CACX56C,EAAU,GACV,cAAc9gB,CAAC,CACjB,CACF,EAAG,CAACskD,CAAM,CAAC,EAGX1oC,YAAU,IAAM,CAoDd,MAAMtV,EAAK,YAnDE,IAAM,CACjB,MAAM6U,EAAIigD,EAAK,QACT13C,EAAM,KAAK,MACjB,GAAI,CAACvI,GAAK,CAACmpC,EAAO,aAAeA,EAAO,OAAS,QAAS,CACxDiX,EAAgB,QAAU,EAC1B,MACF,CACA,GAAI,CAACpgD,EAAE,UAAW,CAChB,MAAMygD,EAAa,CAAC,IAAM,IAAM,GAAK,EAAE,KAAK,IAAIH,EAAW,QAAS,CAAC,CAAC,EACtE,GAAI/3C,EAAM83C,EAAmB,SAAWI,EAAY,CAClDJ,EAAmB,QAAU93C,EAC7B+3C,EAAW,QAAU,KAAK,IAAIA,EAAW,QAAU,EAAG,CAAC,EACvD,GAAI,CACF,OAAO,cACL,IAAI,YAAY,6BAA8B,CAC5C,OAAQ,CAAE,OAAQ,iBAAkB,GAAI/3C,CAAA,CAAI,CAC7C,GAEHvI,EAAE,OAAO,MAAM,IAAM,CAAC,CAAC,CACzB,MAAQ,CAAC,CACX,CACA,MACF,CACA,MAAM0gD,EAAM1gD,EAAuB,aAAe,EAClD,GAAK,OAAO,SAAS0gD,CAAE,EAOvB,GANIA,IAAOP,EAAY,QACrBC,EAAgB,SAAW,EAE3BA,EAAgB,QAAU,EAE5BD,EAAY,QAAUO,EAClBN,EAAgB,SAAW,EAAG,CAChC,MAAMK,EAAa,CAAC,IAAM,IAAM,GAAK,EAAE,KAAK,IAAIH,EAAW,QAAS,CAAC,CAAC,EACtE,GAAI/3C,EAAM83C,EAAmB,SAAWI,EAAY,CAClDJ,EAAmB,QAAU93C,EAC7B+3C,EAAW,QAAU,KAAK,IAAIA,EAAW,QAAU,EAAG,CAAC,EACvD,GAAI,CACF,OAAO,cACL,IAAI,YAAY,6BAA8B,CAC5C,OAAQ,CAAE,OAAQ,QAAS,GAAI/3C,CAAA,CAAI,CACpC,GAGHvI,EAAE,OAAO,MAAM,IAAM,CAAC,CAAC,CACzB,MAAQ,CAAC,CACX,CACF,MAAWogD,EAAgB,UAAY,IAErCE,EAAW,QAAU,EAEzB,EAC6B,GAAI,EACjC,MAAO,IAAM,cAAcn1D,CAAE,CAC/B,EAAG,CAACg+C,CAAM,CAAC,EAITriC,MAAC,SACC,IAAKm5C,EACL,MAAO,CACL,SAAU,QACV,MAAO,EACP,OAAQ,EACR,KAAM,MACN,IAAK,MACL,QAAS,GAEX,MAAK,GACL,YAAW,GACX,cAAW,IAGjB,CCpHO,SAASU,GAAuBC,EAA8B,CACnE,MAAMC,EAAU/rC,GAAiB,WAC3BgsC,EAAWhjC,GAAgB,WAC3BvV,EAAM,KAAK,MAGfu4C,EAAS,uBAAyB,gBAClCD,EAAQ,OAAS,QAGjB,OAAO,cACL,IAAI,YAAY,6BAA8B,CAC5C,OAAQ,CAAE,OAAAD,EAAQ,GAAIr4C,CAAA,CAAI,CAC3B,GAGH,OAAO,cAAc,IAAI,MAAM,kBAAyB,CAAC,CAE7D,CCjCO,MAAMw4C,GAA4B,sBAOlC,SAASC,GAAyBC,EAAgC,CACvE,OAAO,cAAc,IAAI,YAAYF,GAA2B,CAAE,OAAAE,CAAA,CAAQ,CAAC,CAC7E,CCgBA,SAAwBC,IAAuB,CAC7C,MAAM3wB,EAAgBzS,GAAiB5F,GAAM,CAAC,CAACA,EAAE,aAAa,EACxDmY,EAAuBvS,GAAiB5F,GAAMA,EAAE,oBAAoB,EACpEipC,EAAc5wB,EACdswB,EAAU/rC,GAAA,EAEVssC,EAAmBl4D,SAAe,EAAE,EACpCm4D,EAAgBn4D,SAAe,CAAC,EAChCo4D,EAAoBp4D,SAAe,CAAC,EACpCq4D,EAAiBr4D,SAAe,CAAC,EACjCs4D,EAAgBt4D,SAAgB,EAAK,EACrCu4D,EAAgBv4D,SAAoC,IAAI,EAE9DuX,mBAAU,IAAM,CACd,GAAI,CAAC0gD,EAAa,OAElB,MAAMlyB,EAAU3mB,GAAe,CAE7B,MAAM,EAAIA,EAAK,IACT0Q,GAAS,KAAK,SAAW,EAAI,GAAK,EACxC,OAAO,KAAK,IAAI,IAAK,KAAK,MAAM1Q,EAAK0Q,CAAK,CAAC,CAC7C,EAEM0oC,EAAgBd,GAAiC,CACrD,MAAMr4C,EAAM,KAAK,MAEXpG,EAAO,CAAC,KAAM,IAAM,IAAO,KAAO,GAAK,EAC3C,KAAK,IAAIo/C,EAAe,QAAS,CAAC,CACpC,EACMI,EAAY1yB,EAAO9sB,CAAI,EAC7B,GAAI,EAAAoG,EAAM+4C,EAAkB,QAAUK,IAClC,CAAAH,EAAc,QAElB,CAAAA,EAAc,QAAU,GACxBF,EAAkB,QAAU/4C,EAC5Bk5C,EAAc,QAAUb,EACxBW,EAAe,QAAU,KAAK,IAAIA,EAAe,QAAU,EAAG,CAAC,EAE/D,GAAI,CACFZ,GAAuBC,CAAM,EAC7BI,GAAyB,CAAE,OAAAJ,EAAQ,GAAIr4C,CAAA,CAAK,CAC9C,MAAQ,CAER,CAGA,OAAO,WAAW,IAAM,CACtBi5C,EAAc,QAAU,EAC1B,EAAG,IAAI,EACT,EAEM/f,EAAO,IAAM,CACjB,GAAI,CAEF,MAAMpsB,EAASwrC,EAAQ,oBAAsB,KAE7C,GAAI,EADc,CAAC,CAACA,EAAQ,aAAe,CAAC,CAACxrC,GAC7B,CACdgsC,EAAc,QAAU,EACxBD,EAAiB,QAAU,GAC3BG,EAAe,QAAU,EACzBC,EAAc,QAAU,GACxBC,EAAc,QAAU,KACxB,MACF,CAEA,MAAMn5B,EAAQu4B,EAAQ,wBAA0B,KAChD,GAAI,CAACv4B,EAAO,CAEV+4B,EAAc,QAAU,EACxBD,EAAiB,QAAU,GAEvB/rC,KAAqB,mBAAmB,EAC5C,MACF,CAGA,GAAIA,GAAU,CAACiT,EAAM,UACnB,GAAI,CACFA,EAAM,UAAYjT,CACpB,MAAQ,CAAC,CAIX,GAAI,CACF,MAAMusC,EAAUvsC,GAAQ,oBACtB,GACF,GACEA,GACAusC,EAAO,OAAS,GAChBA,EAAO,MAAO/8D,GAAMA,EAAE,aAAe,SAAYA,EAAU,KAAK,EAChE,CACA68D,EAAa,sBAAsB,EACnC,MACF,CACF,MAAQ,CAAC,CAGT,GAAI,CACF,GAAKp5B,EAA2B,SAC7BA,EAAc,SAAS,QAAQ,IAAM,CAAC,CAAC,EAExC+4B,EAAc,SAAW,EACrBA,EAAc,SAAW,GAAG,CAC9BK,EAAa,iBAAiB,EAC9B,MACF,CAEJ,MAAQ,CAAC,CAET,MAAMhB,EAAK,OAAQp4B,EAA2B,aAAe,CAAC,EAW9D,GAVI,CAAC,OAAO,SAASo4B,CAAE,IAEnBU,EAAiB,UAAYV,EAC/BW,EAAc,SAAW,EAEzBA,EAAc,QAAU,EAE1BD,EAAiB,QAAUV,EAGvBW,EAAc,QAAU,GAAG,OAC/BK,EAAa,gBAAgB,CAC/B,MAAQ,CAER,CACF,EAEMryB,EAAQ,IAAM,CAClB,GAAI,CACF,GAAI,SAAS,kBAAoB,UAAW,CAE1C,MAAMrvB,EAAI6gD,EAAQ,wBAA0B,KAC5C,GAAI,CACD7gD,GAAW,SAAS,QAAQ,IAAM,CAAC,CAAC,CACvC,MAAQ,CAAC,EAEH6gD,EAAQ,aAAiBA,EAAQ,qBACrCa,EAAa,4BAA4B,CAE7C,CACF,MAAQ,CAAC,CACX,EAEMv2D,EAAK,OAAO,YAAYs2C,EAAM,GAAI,EACxC,gBAAS,iBAAiB,mBAAoBpS,CAAK,EAC5C,IAAM,CACX,OAAO,cAAclkC,CAAE,EACvB,SAAS,oBAAoB,mBAAoBkkC,CAAK,CACxD,CACF,EAAG,CAAC8xB,EAAa9wB,EAAsBwwB,CAAO,CAAC,EAExC,IACT,CCzKA,SAASgB,GAAaj9D,EAAW,CAC/B,OAAIA,EAAE,SAAS,aAAa,EAAU,mCAClCA,EAAE,SAAS,QAAQ,EAAU,6BAC7BA,EAAE,SAAS,UAAU,EAAU,yCAC/BA,EAAE,SAAS,YAAY,EAAU,mCAC9B,2BACT,CAEA,SAAwBk9D,IAA6B,CACnD,MAAMnT,EAAQ3M,GAAA,EACR+f,EAAiB74D,SAAe,CAAC,EAEvCuX,mBAAU,IAAM,CACd,MAAMuhD,EAAa19D,GAAa,CAE9B,MAAM28D,EADK38D,EACO,OAClB,GAAI,CAAC28D,GAAQ,GAAI,OAGjB,MAAM14C,EAAM,KAAK,MACbA,EAAMw5C,EAAe,QAAU,MACnCA,EAAe,QAAUx5C,EAEzBomC,EAAMkT,GAAaZ,EAAO,MAAM,EAAG,CACjC,KAAM,OACN,YAAa,YACb,SAAU,IAAM,CACd,GAAI,CACFN,GAAuB,YAAY,CACrC,MAAQ,CAAC,CACX,EACM,EACV,EAEA,cAAO,iBAAiBI,GAAkCiB,CAAgB,EACnE,IAAM,CACX,OAAO,oBACLjB,GACAiB,CAAA,CAEJ,CACF,EAAG,CAACrT,CAAK,CAAC,EAEH,IACT,aC7CA,SAAwBsT,IAAgB,CACtC,KAAM,CAACC,EAAMC,CAAO,EAAIz8D,WAAS,EAAK,EAChC08D,EAAajiD,IAAyB,qBAAuB,GAC7DkiD,EAAYliD,IAAyB,oBAAsB,GAC3DmiD,EAAep5D,SAA8B,IAAI,EAEvDuX,YAAU,IAAM,CACd,GAAI,CAACyhD,EAAM,OACX,MAAMK,EAAWj+D,GAAqB,CAChCA,EAAE,MAAQ,UAAU69D,EAAQ,EAAK,CACvC,EACMK,EAAiBv2D,GAAmC,CACxD,MAAMhE,EAASgE,EAAM,OAChBhE,IACDq6D,EAAa,SAAWA,EAAa,QAAQ,SAASr6D,CAAM,GAChEk6D,EAAQ,EAAK,EACf,EACA,gBAAS,iBAAiB,YAAaK,CAAa,EACpD,SAAS,iBAAiB,aAAcA,CAAa,EACrD,OAAO,iBAAiB,UAAWD,CAAO,EACnC,IAAM,CACX,SAAS,oBAAoB,YAAaC,CAAa,EACvD,SAAS,oBAAoB,aAAcA,CAAa,EACxD,OAAO,oBAAoB,UAAWD,CAAO,CAC/C,CACF,EAAG,CAACL,CAAI,CAAC,EAET,eAAeO,GAAa,CAC1B,GAAI,CAEF,GAAK,OAAe,iBAAkB,CACpC,MAAMvzD,EAAS,MAAO,OAAe,kBAIvC,MAAY,WAAmB,YAAc,mBAAoB,OAE/D,MACE,mFAGF,MACE,4HAGN,MAAY,CAEZ,CACF,CAEA,cACG,OAAI,UAAU,wBAAwB,IAAKozD,EAC1C,UAAAx7C,MAAC,UACC,UAAU,wHACV,QAAS,IAAMq7C,EAASniD,GAAM,CAACA,CAAC,EAChC,MAAM,0BACP,qBAGAkiD,GACCr7C,OAAC,OACC,KAAK,SACL,aAAW,OACX,UAAU,wIAEV,UAAAC,MAAC,UACC,UAAU,iJACV,QAAS,IAAMq7C,EAAQ,EAAK,EAC5B,aAAW,uBACZ,eAGDt7C,OAAC,OAAI,UAAU,OACb,gBAAC,OAAI,UAAU,wBAAwB,+BAAmB,QACzD,KAAE,UAAU,wBAAwB,wFAGrC,GACF,EACAA,OAAC,OAAI,UAAU,+BACb,UAAAC,MAAC,UAAO,UAAU,MAAM,QAAS,IAAM27C,EAAA,EAAc,yBAErD,EACCL,EACCt7C,MAAC,KACC,UAAU,MACV,OAAO,SACP,IAAI,aACJ,KAAMs7C,EACP,yCAIA,OAAI,UAAU,qBAAqB,6CAEpC,EAEDC,EACCv7C,MAAC,KACC,UAAU,MACV,OAAO,SACP,IAAI,aACJ,KAAMu7C,EACP,mCAIA,OAAI,UAAU,qBAAqB,yCAEpC,QAED,OAAI,UAAU,qBAAqB,oGAGpC,GACF,IACF,EAEJ,CAEJ,CC7HA,SAAwBK,IAAkB,CACxC,KAAM,CAACC,EAAWC,CAAY,EAAIl9D,WAAS,EAAK,EAC1C,CAACm9D,EAAkBC,CAAmB,EAAIp9D,WAAS,EAAK,EACxD48D,EAAep5D,SAA8B,IAAI,EAEvDuX,YAAU,IAAM,CACd,GAAI,CACD,OAAe,6BAA+B,GAC/C,MAAM8hD,EAAWj+D,GAAW,CAC1BA,EAAE,iBACD,OAAe,sBAAwBA,EACxCs+D,EAAa,EAAI,CACnB,EACA,cAAO,iBAAiB,sBAAuBL,CAAc,EAExD,OAAe,uBAAuBK,EAAa,EAAI,EACrD,IAAM,CACX,OAAO,oBAAoB,sBAAuBL,CAAc,EAChE,GAAI,CACD,OAAe,6BAA+B,EACjD,MAAQ,CAAC,CACX,CACF,MAAY,CAEZ,CACF,EAAG,EAAE,EAEL,eAAeQ,GAAc,CAC3B,GAAI,CACF,GAAK,OAAe,iBACP,MAAO,OAAe,oBACxBD,EAAoB,EAAI,UACvB,OAAe,sBAAuB,CAEhD,MAAM/+D,EAAK,OAAe,sBAC1BA,EAAE,SACF,MAAMi/D,EAAS,MAAMj/D,EAAE,WACnBi/D,GAAUA,EAAO,UAAY,WAC/BJ,EAAa,EAAK,IACO,EAAI,CACjC,MACEE,EAAoB,EAAI,CAE5B,MAAY,CACVA,EAAoB,EAAI,CAC1B,CACF,CAEAriD,mBAAU,IAAM,CACd,GAAI,CAACoiD,EAAkB,OACvB,MAAMI,EAAa3+D,GAAqB,CAClCA,EAAE,MAAQ,UAAUw+D,EAAoB,EAAK,CACnD,EACMN,EAAiBv2D,GAAmC,CACxD,MAAMhE,EAASgE,EAAM,OAChBhE,IACDq6D,EAAa,SAAWA,EAAa,QAAQ,SAASr6D,CAAM,GAChE66D,EAAoB,EAAK,EAC3B,EACA,gBAAS,iBAAiB,YAAaN,CAAa,EACpD,SAAS,iBAAiB,aAAcA,CAAa,EACrD,OAAO,iBAAiB,UAAWS,CAAS,EACrC,IAAM,CACX,SAAS,oBAAoB,YAAaT,CAAa,EACvD,SAAS,oBAAoB,aAAcA,CAAa,EACxD,OAAO,oBAAoB,UAAWS,CAAS,CACjD,CACF,EAAG,CAACJ,CAAgB,CAAC,EAGnBh8C,OAAC,OAAI,UAAU,wBAAwB,IAAKy7C,EAC1C,UAAAx7C,MAAC,UACC,QAASi8C,EACT,UAAU,qFACV,MAAM,qBACN,iBAAgBJ,EAAY,OAAS,QACtC,gCAGAE,GACCh8C,OAAC,OAAI,UAAU,wIACb,UAAAC,MAAC,UACC,UAAU,iJACV,QAAS,IAAMg8C,EAAoB,EAAK,EACxC,aAAW,iCACZ,eAGDh8C,MAAC,MAAG,UAAU,6BAA6B,wCAE3C,QACC,KAAE,UAAU,kCACV,SAAAo8C,GAAA,EACG,qEACA,oFACN,EACAp8C,MAAC,KAAE,UAAU,kCAAkC,0FAG/C,EACAD,OAAC,OAAI,UAAU,wCACb,UAAAC,MAAC,UACC,UAAU,mCACV,QAAS,IAAMg8C,EAAoB,EAAK,EACzC,mBAGDh8C,MAAC,UACC,UAAU,wBACV,QAAS,IAAMg8C,EAAoB,EAAK,EACzC,mBAED,EACF,GACF,GAEJ,CAEJ,CAEA,SAASI,IAAQ,CACf,GAAI,CACF,MAAO,oBAAoB,KAAK,UAAU,SAAS,CACrD,MAAY,CACV,MAAO,EACT,CACF,CCpGA,SAAwBC,GAAe,CACrC,WAAAC,EACA,SAAA75D,EACA,UAAAY,EACA,eAAAk5D,EACA,yBAAAC,EACA,aAAAC,EAAe,IACf,cAAAC,EACA,SAAAC,EAAW,IACX,UAAAC,EAAY,IACZ,SAAAC,EAAW,KACX,UAAAC,EAAY,IACZ,WAAAC,EAAa,GACb,iBAAAC,EAAmB,GACnB,QAAA3Z,CACF,EAAU,CACR,KAAM,CAACnsB,EAAM+lC,CAAO,EAAIr+D,WAAe,IAAM,CAC3C,GAAI,CAACm+D,EAAY,CACf,GAAI,CACF,MAAMtkD,EAAM,aAAa,QAAQ6jD,CAAU,EAC3C,GAAI7jD,EAAK,OAAO,KAAK,MAAMA,CAAG,CAChC,MAAQ,CAAC,CACT,MAAO,CAAE,MAAOgkD,EAAc,OAAQC,CAAA,CACxC,CACA,MAAO,EACT,CAAC,EACKQ,EAAW96D,SAMP,IAAI,EAEduX,YAAU,IAAM,CACd,GAAIojD,EAAY,OAChB,SAASI,GAAU,CACjB,GAAI,CACF,aAAa,WAAWb,CAAU,CACpC,MAAQ,CAAC,CAET,GAAIU,GAAoBxB,EAAa,SAAS,cAAe,CAC3D,MAAMtxD,EAASsxD,EAAa,QAAQ,cAC9B4B,EAAK,OAAO,iBAAiBlzD,CAAM,EACnCmzD,EAAS,WAAWD,EAAG,YAAc,GAAG,GAAK,EAC7CE,EAAY,WAAWF,EAAG,eAAiB,GAAG,GAAK,EACnDpnB,EAAQ,KAAK,IAAI,EAAG9rC,EAAO,aAAemzD,EAASC,CAAS,EAC5Dn8D,EAAS,KAAK,IAClBy7D,EACA,KAAK,IAAIE,EAAW,KAAK,MAAM9mB,CAAK,CAAC,GAEvCinB,EAAQ,CAAE,MAAOR,EAAc,OAAQt7D,EAAQ,EAC/C,MACF,CACA87D,EAAQ,CAAE,MAAOR,EAAc,OAAQC,EAAe,CACxD,CACA,cAAO,iBAAiB,mBAA2BS,CAAO,EACnD,IAAM,OAAO,oBAAoB,mBAA2BA,CAAO,CAC5E,EAAG,CAACb,EAAYG,EAAcC,EAAeK,CAAU,CAAC,EAExDpjD,YAAU,IAAM,CACd,GAAI,CAAAojD,EACJ,GAAI,CACF,aAAa,QAAQT,EAAY,KAAK,UAAUplC,CAAI,CAAC,CACvD,MAAQ,CAAC,CACX,EAAG,CAACA,EAAMolC,EAAYS,CAAU,CAAC,EAGjCpjD,YAAU,IAAM,CACd,GAAIojD,GAAc,CAACC,EAAkB,OACrC,MAAM9yD,EAASsxD,EAAa,SAAS,cACrC,GAAI,CAACtxD,EAAQ,OACb,MAAMkzD,EAAK,OAAO,iBAAiBlzD,CAAM,EACnCmzD,EAAS,WAAWD,EAAG,YAAc,GAAG,GAAK,EAC7CE,EAAY,WAAWF,EAAG,eAAiB,GAAG,GAAK,EACnDpnB,EAAQ,KAAK,IAAI,EAAG9rC,EAAO,aAAemzD,EAASC,CAAS,EAC5Dn8D,EAAS,KAAK,IAAIy7D,EAAW,KAAK,IAAIE,EAAW,KAAK,MAAM9mB,CAAK,CAAC,CAAC,EACzE,GAAI,CACF,MAAMunB,EAAQ,aAAa,QAAQjB,CAAU,EAC7C,GAAIiB,EAAO,CAET,MAAM9/D,GADY,KAAK,MAAM8/D,CAAK,GACb,QAAU,GAE3B,CAAC9/D,IAAKA,GAAI0D,IACZ87D,EAAS7rC,KAAO,CAAE,GAAGA,GAAG,OAAQjwB,GAAS,EAE3C,MACF,CACF,MAAQ,CAAC,CACT87D,EAAS7rC,IAAO,CAAE,GAAGA,EAAG,OAAQjwB,GAAS,CAC3C,EAAG,CAAC67D,EAAkBD,EAAYT,EAAYM,EAAWE,CAAS,CAAC,EAEnE,SAAS7nC,EAAMj4B,EAAWqhC,EAAaD,EAAa,CAClD,OAAO,KAAK,IAAIC,EAAK,KAAK,IAAID,EAAKphC,CAAC,CAAC,CACvC,CAEA,SAASwgE,EAAYhgE,EAAqBigE,EAAa,CACrDjgE,EAAE,iBACF,MAAMiP,EAAK+uD,EAAa,QACxB,GAAI,CAAC/uD,EAAI,OACT,MAAMiqC,EAAOjqC,EAAG,wBAChBywD,EAAS,QAAU,CACjB,EAAG1/D,EAAE,QACL,EAAGA,EAAE,QACL,EAAGk5C,EAAK,MACR,EAAGA,EAAK,OACR,IAAA+mB,CAAA,EAEF,OAAO,iBAAiB,YAAaC,CAAM,EAC3C,OAAO,iBAAiB,UAAWC,CAAS,CAC9C,CAEA,SAASC,EAAgBpgE,EAAwBigE,EAAa,CAE5D,MAAM5gE,EAAIW,EAAE,IACZ,GACE,CAAC,CACC,YACA,aACA,UACA,YACA,QACA,KACA,SAASX,CAAC,EAEZ,OACFW,EAAE,iBACF,MAAM00B,EAAQr1B,IAAM,aAAeA,IAAM,UAAY,IAAQ,GAC7DogE,EAAS7rC,GAAM,CACb,MAAMysC,EAAOzsC,EAAE,OAASqrC,EAClBqB,GAAO1sC,EAAE,QAAUsrC,GAAiBE,EAC1C,IAAIrrD,GAAIssD,EACJpgE,GAAIqgE,GACR,OAAIL,EAAI,SAAS,GAAG,OAAOxoC,EAAM4oC,EAAO3rC,EAAOyqC,EAAUE,CAAQ,GAC7DY,EAAI,SAAS,GAAG,OAAOxoC,EAAM4oC,EAAO3rC,EAAOyqC,EAAUE,CAAQ,GAC7DY,EAAI,SAAS,GAAG,OAAOxoC,EAAM6oC,GAAO5rC,EAAO0qC,EAAWE,CAAS,GAC/DW,EAAI,SAAS,GAAG,OAAOxoC,EAAM6oC,GAAO5rC,EAAO0qC,EAAWE,CAAS,GAC5D,CAAE,MAAO,KAAK,MAAMvrD,EAAC,EAAG,OAAQ,KAAK,MAAM9T,EAAC,EACrD,CAAC,CACH,CAEA,SAASigE,EAAOlgE,EAAe,CAC7B,MAAM4zB,EAAI8rC,EAAS,QACnB,GAAI,CAAC9rC,EAAG,OACR,MAAMjP,EAAK3kB,EAAE,QAAU4zB,EAAE,EACnBhP,EAAK5kB,EAAE,QAAU4zB,EAAE,EACnBqsC,EAAMrsC,EAAE,IACd,IAAI7f,EAAI6f,EAAE,EACN3zB,EAAI2zB,EAAE,EAEN2sC,GAAc,IAClB,MAAM7zD,GAASsxD,EAAa,SAAS,cACrC,GAAItxD,GAAQ,CACV,MAAMkzD,GAAK,OAAO,iBAAiBlzD,EAAM,EACnCmzD,GAAS,WAAWD,GAAG,YAAc,GAAG,GAAK,EAC7CE,GAAY,WAAWF,GAAG,eAAiB,GAAG,GAAK,EACzDW,GAAc,KAAK,IAAI,EAAG7zD,GAAO,aAAemzD,GAASC,EAAS,CACpE,CACA,MAAMU,GAAU,KAAK,IACnBlB,EACA,SAASiB,EAAW,EAAIA,GAAcjB,CAAA,EAGpCW,EAAI,SAAS,GAAG,IAAGlsD,EAAI0jB,EAAM7D,EAAE,EAAIjP,EAAIw6C,EAAUE,CAAQ,GACzDY,EAAI,SAAS,GAAG,IAAGhgE,EAAIw3B,EAAM7D,EAAE,EAAIhP,EAAIw6C,EAAWoB,EAAO,GACzDP,EAAI,SAAS,GAAG,IAAGlsD,EAAI0jB,EAAM7D,EAAE,EAAIjP,EAAIw6C,EAAUE,CAAQ,GACzDY,EAAI,SAAS,GAAG,IAAGhgE,EAAIw3B,EAAM7D,EAAE,EAAIhP,EAAIw6C,EAAWoB,EAAO,GAC7Df,EAAQ,CAAE,MAAO,KAAK,MAAM1rD,CAAC,EAAG,OAAQ,KAAK,MAAM9T,CAAC,EAAG,CACzD,CAEA,SAASkgE,GAAY,CACnB,OAAO,oBAAoB,YAAaD,CAAM,EAC9C,OAAO,oBAAoB,UAAWC,CAAS,EAC/CT,EAAS,QAAU,IACrB,CAEA,MAAM1B,EAAep5D,SAA8B,IAAI,EACvDuX,YAAU,IAAM,CACd,GAAI,CAAC0pC,EAAS,OACd,SAAS8Y,EAAU3+D,EAAkB,CAC/BA,EAAE,MAAQ,WACZA,EAAE,kBACF6lD,IAAA,EAEJ,CACA,cAAO,iBAAiB,UAAW8Y,EAAW,EAAI,EAC3C,IAAM,OAAO,oBAAoB,UAAWA,EAAW,EAAI,CACpE,EAAG,CAAC9Y,CAAO,CAAC,EACZ,MAAM/iC,EAAuBy8C,EACzB,CAAE,MAAO,OAAQ,OAAQ,OAAQ,SAAU,OAAQ,UAAW,QAC9D,CACE,MAAO7lC,EAAK,MAAQ,GAAGA,EAAK,KAAK,KAAO,OACxC,OAAQA,EAAK,OAAS,GAAGA,EAAK,MAAM,KAAO,OAC3C,SAAU,GAAG2lC,CAAQ,KAErB,UAAW,QAGXoB,EAAYlB,EACdP,GAA4B,+BAC5BD,GAAkB,gBACtB,OACEx8C,OAAC,OACC,IAAKy7C,EACL,UAAW,GAAGyC,CAAS,IAAI56D,GAAa,EAAE,GAC1C,MAAAid,EAEA,UAAAN,MAACre,GAAA,CAAU,YAAW,GAAC,UAAU,sCAE9B,SAAAc,EACH,EAEC,CAACs6D,GACA/8C,MAAC,OACC,UAAU,qBACV,YAAcxiB,GAAMggE,EAAYhgE,EAAG,IAAI,EACvC,KAAK,SACL,SAAU,EACV,aAAW,oBACX,UAAYA,GAAMogE,EAAgBpgE,EAAG,IAAI,IAG5C,CAACu/D,GACA/8C,MAAC,OACC,UAAU,qBACV,YAAcxiB,GAAMggE,EAAYhgE,EAAG,IAAI,EACvC,KAAK,SACL,SAAU,EACV,aAAW,oBACX,UAAYA,GAAMogE,EAAgBpgE,EAAG,IAAI,IAG5C,CAACu/D,GACA/8C,MAAC,OACC,UAAU,qBACV,YAAcxiB,GAAMggE,EAAYhgE,EAAG,IAAI,EACvC,KAAK,SACL,SAAU,EACV,aAAW,oBACX,UAAYA,GAAMogE,EAAgBpgE,EAAG,IAAI,IAG5C,CAACu/D,GACA/8C,MAAC,OACC,UAAU,qBACV,YAAcxiB,GAAMggE,EAAYhgE,EAAG,IAAI,EACvC,KAAK,SACL,SAAU,EACV,aAAW,oBACX,UAAYA,GAAMogE,EAAgBpgE,EAAG,IAAI,IAI5C,CAACu/D,GACA/8C,MAAC,OACC,UAAU,yBACV,YAAcxiB,GAAMggE,EAAYhgE,EAAG,GAAG,EACtC,KAAK,SACL,SAAU,EACV,aAAW,eACX,UAAYA,GAAMogE,EAAgBpgE,EAAG,GAAG,GAC1C,GAIR,CCnSA,SAAwB0gE,IAAmB,CACzC,KAAM,CAACC,EAAgBC,CAAiB,EAAIx/D,WAAqB,IAAI,EAErE+a,YAAU,IAAM,CACd,GAAI,CACF,MAAM8hD,EAAWj+D,GAAW,CAC1BA,EAAE,iBACF4gE,EAAkB5gE,CAAC,CACrB,EACA,cAAO,iBAAiB,sBAAuBi+D,CAAwB,EAChE,IACL,OAAO,oBACL,sBACAA,CAAA,CAEN,MAAY,CAEZ,CACF,EAAG,EAAE,EAEL,eAAe4C,GAAgB,CAC7B,GAAI,CAACF,EAAgB,CAEnB,MACE,6IAEF,MACF,CACA,GAAI,CACFA,EAAe,SACf,MAAMjC,EAAS,MAAMiC,EAAe,WAChCjC,GAAUA,EAAO,UAAY,YAC/BkC,EAAkB,IAAI,CAE1B,OAAS5gE,EAAG,CACV,QAAQ,KAAK,iBAAkBA,CAAC,CAClC,CACF,CAGA,OAAK2gE,EAEHn+C,MAAC,UACC,UAAU,6CACV,QAAS,IAAMq+C,EAAA,EAChB,yBALyB,IAS9B,CC/CA,SAAwBC,IAAS,CAC/B,KAAM,CAACC,EAAMC,CAAO,EAAI5/D,WAAS,EAAK,EAChC6/D,EAAO,IAAI,OAAO,cACxB,OACE1+C,OAAAja,WAAA,CACE,UAAAia,OAAC,OAAI,UAAU,4DAA4D,eACtE0+C,EAAK,sBAAoB,IAC5Bz+C,MAAC,UAAO,UAAU,YAAY,QAAS,IAAMw+C,EAAQ,EAAI,EAAG,wBAE5D,QAEC,QAAK,UAAU,iCACd,SAAAx+C,MAACk+C,KAAiB,EACpB,GACF,EACCK,EACCv+C,MAACq8C,GAAA,CACC,WAAW,kBACX,UAAU,YACV,aAAc,IACd,cAAe,IACf,SAAU,IACV,UAAW,IACX,iBAAgB,GAEhB,SAAAt8C,OAAC,OAAI,UAAU,gBACb,UAAAC,MAAC,OAAI,UAAU,wBAAwB,sCAEvC,EACAA,MAAC,OAAI,UAAU,UAAU,qCAAyB,EAClDA,MAAC,OAAI,UAAU,UAAU,8NAKzB,EACAA,MAAC,OAAI,UAAU,UAAU,oOAKzB,EACAA,MAAC,OAAI,UAAU,UAAU,sMAIzB,EACAA,MAAC,OAAI,UAAU,+BACb,eAAC,UAAO,UAAU,MAAM,QAAS,IAAMw+C,EAAQ,EAAK,EAAG,iBAEvD,EACF,GACF,IAEA,MACN,CAEJ,CCpDO,MAAME,GAAkBj0C,GAA2BtX,IAAS,CACjE,OAAQ,GACR,YAAa,KACb,eAAgB,KAChB,UAAW,CAAC+F,EAAGylD,EAAS,OACtBxrD,EAAI,CACF,OAAQ+F,EACR,YAAaylD,GAAU,KACvB,eAAgBzlD,EAAI,KAAK,MAAQ,KAClC,CACL,EAAE,ECfF,SAAwB0lD,IAAmB,CACzC,MAAMC,EAASH,GAAiBttC,GAAMA,EAAE,MAAM,EACxC0tC,EAAcJ,GAAiBttC,GAAMA,EAAE,WAAW,EAClD2tC,EAAYL,GAAiBttC,GAAMA,EAAE,SAAS,EAEpDzX,mBAAU,IAAM,CACd,GAAI,CAACklD,GAAU,CAACC,EAAa,OAC7B,MAAMr9C,EAAM,KAAK,MACjB,GAAIq9C,GAAer9C,EAAK,CACtBs9C,EAAU,GAAO,IAAI,EACrB,MACF,CACA,MAAMv9C,EAAKs9C,EAAcr9C,EACnB1jB,EAAI,WAAW,IAAMghE,EAAU,GAAO,IAAI,EAAGv9C,CAAE,EACrD,MAAO,IAAM,aAAazjB,CAAC,CAC7B,EAAG,CAAC8gE,EAAQC,EAAaC,CAAS,CAAC,EAE5B,IACT,CChBA,SAASC,GAAMx9C,EAAY,CACzB,OAAO,IAAI,QAAS1jB,GAAM,WAAWA,EAAG0jB,CAAE,CAAC,CAC7C,CAEA,eAAey9C,GAAgBz9B,EAAyBm1B,EAAmB,CACzE,MAAMrV,EAAQ,KAAK,MAGf9f,EAAM,YAAc,IAAMA,EAAM,YAAc,GAAK,GAEvD,MAAM,IAAI,QAAepB,GAAY,CACnC,IAAI8+B,EAAO,GACX,MAAMr6B,EAAS,IAAM,CACfq6B,IACJA,EAAO,GACPC,EAAA,EACA/+B,EAAA,EACF,EAEMg/B,EAAW,IAAMv6B,EAAA,EACjBw6B,EAAY,IAAMx6B,EAAA,EAElBgyB,EAAQ,OAAO,YAAY,IAAM,CACjC,KAAK,MAAQvV,EAAQqV,GAAW9xB,EAAA,EAChCrD,EAAM,YAAc,GAAGqD,EAAA,GACtBrD,EAAM,YAAc,GAAK,GAAGqD,EAAA,CACnC,EAAG,EAAE,EAECs6B,EAAU,IAAM,CACpB,GAAI,CACF39B,EAAM,oBAAoB,iBAAkB49B,CAAQ,EACpD59B,EAAM,oBAAoB,UAAW69B,CAAS,EAC9C,OAAO,cAAcxI,CAAK,CAC5B,MAAQ,CAAC,CACX,EAEA,GAAI,CACFr1B,EAAM,iBAAiB,iBAAkB49B,CAAQ,EACjD59B,EAAM,iBAAiB,UAAW69B,CAAS,CAC7C,MAAQ,CAER,CACF,CAAC,CACH,CAMA,eAAsBC,GAAiBhtC,EAaH,CAClC,KAAM,CACJ,MAAAkP,EACA,OAAAjT,EACA,OAAAgxC,EAAS,GACT,MAAAC,EAAQ,GACR,YAAAC,EAAc,GACd,YAAAC,EAAc,EACd,kBAAAC,EAAoB,KACpB,YAAAC,CAAA,EACEttC,EAEJ,GAAI,CAACkP,EAAO,MAAO,CAAE,SAAU,GAAO,OAAQ,GAAO,OAAQ,YAE7D,MAAMq+B,GAAmBtxC,GAAQ,oBAAsB,IAAI,OACxDxwB,GAAMA,EAAE,aAAe,QAE1B,GAAI,CAACwwB,GAAUsxC,EAAgB,SAAW,EACxC,MAAO,CACL,SAAU,GACV,OAAQ,GACR,OAAQ,kBAIZ,GAAI,CACEL,MAAa,MAAQ,IACrBC,IAAcj+B,EAAc,YAAc,GAChD,MAAQ,CAAC,CAET,IAAIs+B,EAAW,GACf,GAAIP,EACF,GAAI,CACE/9B,EAAM,YAAcjT,IACtBiT,EAAM,UAAYjT,GAEpBuxC,EAAW,EACb,MAAY,CACV,MAAO,CAAE,SAAU,GAAO,OAAQ,GAAO,OAAQ,gBACnD,CAKF,MAAMC,EAGDT,GAAyB,iBAAmB,IAAI,QACpDA,GAAyB,gBAAkBS,EAI5C,MAAMnjB,EAAWmjB,EAAe,IAAIv+B,CAAK,EACzC,GAAIob,EACF,GAAI,CAEF,OADU,MAAMA,CAElB,MAAQ,CAER,CAGF,MAAMojB,GAAkB,SAA6C,CACnE,QAASngE,EAAI,EAAGA,EAAI6/D,EAAa7/D,IAAK,CACpC,GAAI,CACF,MAAMo/D,GAAgBz9B,EAAOm+B,CAAiB,CAChD,MAAQ,CAAC,CAET,GAAI,CAEF,MAAM1iE,EAAIukC,EAAM,OAIhB,GAHIvkC,GAAK,OAAQA,EAAU,MAAS,YAAY,MAAMA,GAGjDukC,EAAM,YAAc,GAAK,IAAMA,EAAM,aAAe,GAAK,EAC5D,MAAO,CAAE,SAAAs+B,EAAU,OAAQ,IAI7B,GAAIt+B,EAAM,SAAW,GACnB,MAAO,CAAE,SAAAs+B,EAAU,OAAQ,GAE/B,OAAShkD,EAAU,CAIjB,GAAI,CACF8jD,IAAc9jD,CAAG,CACnB,MAAQ,CAAC,CACT,GAAIA,GAAOA,EAAI,OAAS,aAAc,CAEpC,MAAMkjD,GAAM,IAAMn/D,EAAI,GAAG,EACzB,QACF,CACF,CAEA,MAAMm/D,GAAM,IAAMn/D,EAAI,GAAG,CAC3B,CAEA,MAAO,CAAE,SAAAigE,EAAU,OAAQ,GAAO,OAAQ,yBAC5C,KAGAC,EAAe,IAAIv+B,EAAOw+B,CAAc,EACxC,GAAI,CAEF,OADY,MAAMA,CAEpB,SAEE,GAAI,CACFD,EAAe,OAAOv+B,CAAK,CAC7B,MAAQ,CAAC,CACX,CACF,CC7KO,SAASy+B,GACdpsC,EACAC,EACAlC,EACA8C,EACAC,EACA,CACA,MAAMurC,EAAStsC,GAAaC,EAAgBC,CAAI,EAChD,OAAKosC,EAID,OAAOtuC,GAAU,SACZ6C,GACLyrC,EACAtuC,EACA8C,GAAgB,EAChBC,GAAqB,GAGlBX,GAAkBksC,CAAM,EAVtB,CAAE,KAAM,EAAG,KAAM,OAAiB,OAAQ,KAAM,KAAM,EAWjE,CCTO,SAASC,GAAkB9/D,EAA8B,CAC9D,GAAI,CACF,GAAI,CAACA,GAAQ,OAAOA,GAAS,SAAU,OAAO,KAC9C,MAAM+/D,EAAW//D,EAAa,WACxBggE,EACJ,OAAOD,GAAY,UAAY,OAAO,SAASA,CAAO,EAClDA,EAAU,EACR,KAAK,IAAI,EAAG,KAAK,IAAI,EAAGA,EAAU,GAAG,CAAC,EACtC,KAAK,IAAI,EAAG,KAAK,IAAI,EAAGA,CAAO,CAAC,EAClC,OAEN,IACG//D,EAAK,OAAS,QAAUA,EAAK,OAAS,QAAUA,EAAK,QAAU,SAChE,OAAOA,EAAK,OAAU,SACtB,CACA,MAAMigE,EAAOC,GAAclgE,EAAK,IAAI,EAC9Bgb,EAAOmlD,GAAkBngE,EAAK,MAAOigE,CAAI,EAC/C,OAAOjlD,EAAO,CAAE,GAAGA,EAAM,WAAYglD,GAAS,IAChD,CAEA,GAAI,OAAOhgE,EAAK,OAAU,UAAYA,EAAK,KAAM,CAC/C,MAAMigE,EAAOC,GAAclgE,EAAK,IAAI,EAC9Bgb,EAAOmlD,GAAkBngE,EAAK,MAAOigE,CAAI,EAC/C,OAAOjlD,EAAO,CAAE,GAAGA,EAAM,WAAYglD,GAAS,IAChD,CAEA,GAAI,OAAOhgE,EAAK,OAAU,SAAU,CAClC,MAAM+wB,EAAI/wB,EAAK,MAAM,OAAO,cAC5B,GAAI+wB,IAAM,MAAQA,IAAM,SAAWA,IAAM,aACvC,MAAO,CACL,MAAO,GACP,KAAM,aACN,OAAQ,KACR,KAAM,EACN,WAAYivC,CAAA,EAEhB,GAAIjvC,IAAM,MAAQA,IAAM,QAAUA,IAAM,QACtC,MAAO,CACL,MAAO,GACP,KAAM,OACN,OAAQ,KACR,KAAM,EACN,WAAYivC,CAAA,EAEhB,MAAMtjE,EAAIq0B,EAAE,MAAM,oBAAoB,EACtC,GAAIr0B,EAAG,CACL,MAAM0jE,EAAO1jE,EAAE,CAAC,IAAM,IAAM,EAAIA,EAAE,CAAC,IAAM,IAAM,EAAI,EAC7C2jE,EAAM,SAAS3jE,EAAE,CAAC,EAAG,EAAE,EAC7B,GAAI2jE,GAAO,GAAKA,GAAO,GACrB,MAAO,CACL,MAAOA,EAAMD,EACb,KAAMA,IAAS,EAAI,SAAWA,IAAS,EAAI,SAAW,SACtD,OAAQC,EACR,KAAAD,EACA,WAAYJ,CAAA,CAElB,CACF,CAEA,GAAI,OAAOhgE,EAAK,QAAW,UAAY,OAAOA,EAAK,MAAS,SAAU,CACpE,MAAMqgE,EAAM,KAAK,IAAI,EAAG,KAAK,IAAI,GAAI,KAAK,MAAMrgE,EAAK,MAAM,CAAC,CAAC,EACvDsgE,EAAMtgE,EAAK,OAAS,EAAI,EAAIA,EAAK,OAAS,EAAI,EAAI,EACxD,MAAO,CACL,MAAOqgE,EAAMC,EACb,KAAMA,IAAQ,EAAI,SAAWA,IAAQ,EAAI,SAAW,SACpD,OAAQD,EACR,KAAMC,EACN,WAAYN,CAAA,CAEhB,CAEA,GAAIhgE,EAAK,KAAM,CACb,MAAM21C,EACJ,OAAO31C,EAAK,IAAI,EAAE,gBAAkB,SAAWA,EAAK,OAAS,GAC/D,MAAO,CACL,MAAO21C,EAAQ,GAAK,GACpB,KAAMA,EAAQ,aAAe,OAC7B,OAAQ,KACR,KAAM,EACN,WAAYqqB,CAAA,CAEhB,CACF,MAAQ,CAAC,CACT,OAAO,IACT,CAEA,SAASE,GAAcziE,EAAc,CACnC,MAAMszB,EAAI,OAAOtzB,GAAK,EAAE,EAAE,cAC1B,OAAIszB,EAAE,WAAW,IAAI,EAAU,SAC3BA,EAAE,WAAW,IAAI,EAAU,SAC3BA,EAAE,WAAW,IAAI,EAAU,SAC3BA,IAAM,cAAgBA,IAAM,SAAWA,IAAM,MAAQA,IAAM,QACtD,aACLA,IAAM,QAAUA,IAAM,MAAQA,IAAM,SAAWA,IAAM,aAChD,OACLA,IAAM,QAAUA,IAAM,IAAY,OAC/B,QACT,CAEA,SAASovC,GAAkBhiE,EAAe8hE,EAA+B,CACvE,MAAMpnD,EAAI,KAAK,IAAI,EAAG,KAAK,IAAI,GAAI,KAAK,MAAM,OAAO1a,CAAK,GAAK,CAAC,CAAC,CAAC,EAClE,OAAI8hE,IAAS,aAAqB,CAAE,MAAO,GAAI,KAAAA,CAAA,EAC3CA,IAAS,OAAe,CAAE,MAAO,GAAI,KAAAA,CAAA,EAElC,CAAE,MAAOpnD,EAAG,KAAAonD,CAAA,CACrB,CAIO,SAASM,GACdjlD,EACAklD,EACa,CACb,IAAIrtB,EAA2B,KAC3BstB,EAAQ,GAERC,EAAyB,KACzBC,EAAY,EAChB,MAAMC,EAAkB,IAElBC,EAAoB,GACpBC,MAAc,IAEpB,SAASC,EAAgBxtB,EAAc1Q,EAAoB,CAEzD,MAAMm+B,EACJ,OAAOztB,GAAS,IAAO,UAAY,OAAOA,GAAS,IAAO,SACtD,OAAOA,EAAQ,EAAE,EACjB,KACN,GAAIytB,EAAK,CACP,GAAIF,EAAQ,IAAIE,CAAG,EAAG,OAGtB,GAFAF,EAAQ,IAAIE,CAAG,EACfH,EAAQ,KAAKG,CAAG,EACZH,EAAQ,OAAS,IAAK,CACxB,MAAMI,EAAMJ,EAAQ,QAChBI,GAAKH,EAAQ,OAAOG,CAAG,CAC7B,CACF,CAEA,MAAMjoB,EAAM,GAAGnW,EAAO,KAAK,IAAIA,EAAO,IAAI,IAAIA,EAAO,QAAU,EAAE,IAAIA,EAAO,MAAQ,EAAE,GAChFzhB,EAAM,KAAK,MACb43B,IAAQ0nB,GAAWt/C,EAAMu/C,EAAYC,IACzCF,EAAU1nB,EACV2nB,EAAYv/C,EACZo/C,EAAO39B,CAAM,EACf,CAEA,SAAS+E,GAAU,CACjB,GAAK64B,EACL,GAAI,CACFttB,EAAS,IAAI,UAAU73B,CAAG,EAC1B63B,EAAO,UAAaxQ,GAAO,CACzB,GAAI,CACF,MAAM4Q,EAAU,KAAK,MAAM5Q,EAAG,IAAI,EAC5BE,EAASi9B,GAAkBvsB,CAAO,EACpC1Q,GAAQk+B,EAAgBxtB,EAAS1Q,CAAM,CAC7C,MAAQ,CAAC,CACX,EACAsQ,EAAO,QAAU,IAAM,CACrBA,EAAS,KACT,WAAWvL,EAAS,IAAI,CAC1B,EACAuL,EAAO,QAAU,IAAM,CAEvB,CACF,MAAQ,CACN,WAAWvL,EAAS,GAAI,CAC1B,CACF,CACA,OAAAA,EAAA,EACO,CACL,MAAO,IAAM,CACX64B,EAAQ,GACR,GAAI,CACFttB,GAAQ,OACV,MAAQ,CAAC,CACX,EAEJ,CC/KA,SAAwB+tB,GAAe,CACrC,WAAAjF,EACA,SAAA75D,EACA,UAAAY,EACA,aAAAo5D,EAAe,IACf,cAAAC,EAAgB,IAChB,SAAAC,EAAW,IACX,UAAAC,EAAY,IACZ,SAAAC,EAAW,KACX,UAAAC,EAAY,KACZ,SAAA0E,EAAW,EACb,EAAU,CACR,KAAM,CAACtqC,EAAM+lC,CAAO,EAAIr+D,WAAe,IAAM,CAC3C,GAAI,CACF,MAAM6Z,EAAM,aAAa,QAAQ6jD,CAAU,EAC3C,GAAI7jD,EAAK,OAAO,KAAK,MAAMA,CAAG,CAChC,MAAQ,CAAC,CAET,OAAO+oD,EACH,CAAE,MAAO/E,CAAA,EACT,CAAE,MAAOA,EAAc,OAAQC,CAAA,CACrC,CAAC,EACKQ,EAAW96D,SAMP,IAAI,EACRo5D,EAAep5D,SAA8B,IAAI,EAEvDuX,YAAU,IAAM,CACd,SAASwjD,GAAU,CACjB,GAAI,CACF,aAAa,WAAWb,CAAU,CACpC,MAAQ,CAAC,CACTW,EAAQ,CAAE,MAAOR,EAAc,OAAQC,EAAe,CACxD,CACA,cAAO,iBAAiB,mBAA2BS,CAAO,EAC1D,OAAO,iBAAiB,mBAA2BA,CAAO,EACnD,IAAM,CACX,OAAO,oBAAoB,mBAA2BA,CAAO,EAC7D,OAAO,oBAAoB,mBAA2BA,CAAO,CAC/D,CACF,EAAG,CAACb,EAAYG,EAAcC,CAAa,CAAC,EAE5C/iD,YAAU,IAAM,CACd,GAAI,CACF,aAAa,QAAQ2iD,EAAY,KAAK,UAAUplC,CAAI,CAAC,CACvD,MAAQ,CAAC,CACX,EAAG,CAACA,EAAMolC,CAAU,CAAC,EAErB,SAASrnC,EAAMj4B,EAAWqhC,EAAaD,EAAa,CAClD,OAAO,KAAK,IAAIC,EAAK,KAAK,IAAID,EAAKphC,CAAC,CAAC,CACvC,CACA,SAASwgE,EAAYhgE,EAAqBigE,EAAa,CACrDjgE,EAAE,iBACF,MAAMiP,EAAK+uD,EAAa,QACxB,GAAI,CAAC/uD,EAAI,OACT,MAAMiqC,EAAOjqC,EAAG,wBAChBywD,EAAS,QAAU,CACjB,EAAG1/D,EAAE,QACL,EAAGA,EAAE,QACL,EAAGk5C,EAAK,MACR,EAAGA,EAAK,OACR,IAAA+mB,CAAA,EAEF,OAAO,iBAAiB,YAAaC,CAAM,EAC3C,OAAO,iBAAiB,UAAWC,CAAS,CAC9C,CACA,SAASD,EAAOlgE,EAA0B,CACxC,MAAM4zB,EAAI8rC,EAAS,QACnB,GAAI,CAAC9rC,EAAG,OACR,MAAMjP,EAAK3kB,EAAE,QAAU4zB,EAAE,EACnBhP,EAAK5kB,EAAE,QAAU4zB,EAAE,EACzB,IAAI7f,EAAI6f,EAAE,EACN3zB,EAAI2zB,EAAE,EACNA,EAAE,IAAI,SAAS,GAAG,IAAG7f,EAAI0jB,EAAM7D,EAAE,EAAIjP,EAAIw6C,EAAUE,CAAQ,GAE3D,CAAC2E,GAAYpwC,EAAE,IAAI,SAAS,GAAG,IACjC3zB,EAAIw3B,EAAM7D,EAAE,EAAIhP,EAAIw6C,EAAWE,CAAS,GACtC1rC,EAAE,IAAI,SAAS,GAAG,IAAG7f,EAAI0jB,EAAM7D,EAAE,EAAIjP,EAAIw6C,EAAUE,CAAQ,GAC3D,CAAC2E,GAAYpwC,EAAE,IAAI,SAAS,GAAG,IACjC3zB,EAAIw3B,EAAM7D,EAAE,EAAIhP,EAAIw6C,EAAWE,CAAS,GAC1CG,EAAQ,CAAE,MAAO,KAAK,MAAM1rD,CAAC,EAAG,OAAQ,KAAK,MAAM9T,CAAC,EAAG,CACzD,CACA,SAASkgE,GAAY,CACnB,OAAO,oBAAoB,YAAaD,CAAM,EAC9C,OAAO,oBAAoB,UAAWC,CAAS,EAC/CT,EAAS,QAAU,IACrB,CAEA,SAASU,EAAgBpgE,EAAwBigE,EAAa,CAE5D,MAAM5gE,EAAIW,EAAE,IACZ,GACE,CAAC,CACC,YACA,aACA,UACA,YACA,QACA,KACA,SAASX,CAAC,EAEZ,OACFW,EAAE,iBACF,MAAM00B,EAAQr1B,IAAM,aAAeA,IAAM,UAAY,IAAQ,GAC7DogE,EAAS7rC,GAAM,CACb,MAAMysC,EAAOzsC,EAAE,OAASqrC,EAClBqB,EAAO1sC,EAAE,QAAUsrC,EACzB,IAAInrD,EAAIssD,EACJpgE,EAAIqgE,EACR,OAAIL,EAAI,SAAS,GAAG,MAAOxoC,EAAM4oC,EAAO3rC,EAAOyqC,EAAUE,CAAQ,GAC7DY,EAAI,SAAS,GAAG,MAAOxoC,EAAM4oC,EAAO3rC,EAAOyqC,EAAUE,CAAQ,GAC7D,CAAC2E,GAAY/D,EAAI,SAAS,GAAG,IAC/BhgE,EAAIw3B,EAAM6oC,EAAO5rC,EAAO0qC,EAAWE,CAAS,GAC1C,CAAC0E,GAAY/D,EAAI,SAAS,GAAG,IAC/BhgE,EAAIw3B,EAAM6oC,EAAO5rC,EAAO0qC,EAAWE,CAAS,GACvC,CAAE,MAAO,KAAK,MAAMvrD,CAAC,EAAG,OAAQ,KAAK,MAAM9T,CAAC,EACrD,CAAC,CACH,CAEA,MAAM6iB,EAAuB,CAC3B,MAAOkhD,EAAW,OAAStqC,EAAK,MAAQ,GAAGA,EAAK,KAAK,KAAO,OAC5D,OAAQsqC,EAAW,OAAStqC,EAAK,OAAS,GAAGA,EAAK,MAAM,KAAO,OAC/D,SAAU,OAEV,UAAWsqC,EAAW,OAAS,OAC/B,SAAU,WAEV,GAAIA,EACA,CAAE,QAAS,OAAQ,cAAe,SAAU,KAAM,YAClD,EAAC,EAGP,OACEzhD,OAAC,OAAI,IAAKy7C,EAAc,UAAW,GAAGn4D,GAAa,EAAE,GAAI,MAAAid,EACtD,UAAA7d,EACDud,MAAC,OACC,UAAU,qBACV,YAAcxiB,GAAMggE,EAAYhgE,EAAG,IAAI,EACvC,KAAK,SACL,SAAU,EACV,aAAW,oBACX,UAAYA,GAAMogE,EAAgBpgE,EAAG,IAAI,IAE3CwiB,MAAC,OACC,UAAU,qBACV,YAAcxiB,GAAMggE,EAAYhgE,EAAG,IAAI,EACvC,KAAK,SACL,SAAU,EACV,aAAW,oBACX,UAAYA,GAAMogE,EAAgBpgE,EAAG,IAAI,IAE3CwiB,MAAC,OACC,UAAU,qBACV,YAAcxiB,GAAMggE,EAAYhgE,EAAG,IAAI,EACvC,KAAK,SACL,SAAU,EACV,aAAW,oBACX,UAAYA,GAAMogE,EAAgBpgE,EAAG,IAAI,IAE3CwiB,MAAC,OACC,UAAU,qBACV,YAAcxiB,GAAMggE,EAAYhgE,EAAG,IAAI,EACvC,KAAK,SACL,SAAU,EACV,aAAW,oBACX,UAAYA,GAAMogE,EAAgBpgE,EAAG,IAAI,GAC3C,EACF,CAEJ,CC5KO,MAAMikE,GAAkBh3C,GAA2BtX,IAAS,CACjE,MAAO,EACP,MAAO,EACP,QAAS,GACT,SAAU,CAAClD,EAAS2xB,EAAO8/B,IAAUvuD,EAAI,CAAE,QAAAlD,EAAS,MAAA2xB,EAAO,MAAA8/B,EAAO,EAClE,MAAO,IAAMvuD,EAAI,CAAE,MAAO,EAAG,MAAO,EAAG,QAAS,EAAC,CAAG,CACtD,EAAE,EC3BF,SAAwBwuD,GAAe,CACrC,QAAAte,EACA,OAAAue,EACA,QAAAC,CACF,EAIG,CAED,OAAAh8D,GAAM,UAAU,IAAM,CACpB,MAAMyZ,EAAS9hB,GAAqB,CAC9BA,EAAE,MAAQ,UAAU6lD,EAAA,CAC1B,EACA,cAAO,iBAAiB,UAAW/jC,CAAK,EACjC,IAAM,OAAO,oBAAoB,UAAWA,CAAK,CAC1D,EAAG,CAAC+jC,CAAO,CAAC,EAEVtjC,OAAC,OAAI,UAAU,yBAAyB,KAAK,eAC3C,UAAAC,MAAC,UACC,UAAU,+BACV,QAASqjC,EACT,aAAW,wBAEZ,OAAI,UAAU,wDACb,SAAArjC,MAACre,GAAA,CAAU,YAAW,GACpB,SAAAoe,OAAC,OACC,UAAU,gDACV,KAAK,SACL,aAAW,OACX,kBAAgB,qBAEhB,UAAAA,OAAC,OAAI,UAAU,yCACb,UAAAC,MAAC,MAAG,GAAG,qBAAqB,UAAU,oBAAoB,4BAE1D,EACAA,MAAC,UACC,UAAU,gBACV,QAASqjC,EACT,aAAW,eACZ,cAED,EACF,EACAtjC,OAAC,OAAI,UAAU,OACb,UAAAC,MAAC,KAAE,UAAU,OAAO,8EAGpB,EACAA,MAAC,KAAE,UAAU,yBAAyB,oHAGtC,GACF,EAEAD,OAAC,OAAI,UAAU,4BACb,UAAAC,MAAC,UACC,UAAU,8CACV,QAAS,IAAM4hD,EAAA,EAChB,2BAGD7hD,OAAC,OAAI,UAAU,0BACb,UAAAC,MAAC,QAAK,UAAU,aAAa,kBAAM,EAClC,CAAC,EAAG,EAAG,EAAG,EAAG,CAAC,EAAE,IAAKjjB,GACpBgjB,OAAC,UAEC,UAAU,mCACV,QAAS,IAAM8hD,EAAQ9kE,CAAC,EAEvB,UAAAA,EAAE,SAJEA,CAAA,CAMR,GACH,GACF,EAEAijB,MAAC,OAAI,UAAU,aACb,SAAAA,MAAC,UAAO,UAAU,2BAA2B,QAASqjC,EAAS,qBAE/D,EACF,KAEJ,EACF,GACF,CAEJ,CCtFA,SAASye,GAAItgD,EAAY,CACvB,MAAM4P,EAAI,KAAK,IAAI,EAAG,KAAK,MAAM5P,EAAK,GAAI,CAAC,EACrCugD,EAAK,KAAK,MAAM3wC,EAAI,EAAE,EACzB,WACA,SAAS,EAAG,GAAG,EACZ4wC,GAAM5wC,EAAI,IAAI,WAAW,SAAS,EAAG,GAAG,EAC9C,MAAO,GAAG2wC,CAAE,IAAIC,CAAE,EACpB,CAEA,SAAwBC,GAAgB,CACtC,QAAAC,EAAU,EACZ,EAEG,CACD,MAAMpD,EAAcJ,GAAiBttC,GAAMA,EAAE,WAAW,EAClD+wC,EAAiBzD,GAAiBttC,GAAMA,EAAE,cAAc,EACxDytC,EAASH,GAAiBttC,GAAMA,EAAE,MAAM,EACxC,CAAC3P,EAAK4vB,CAAM,EAAIzyC,WAAS,KAAK,KAAK,EAQzC,GANA+a,YAAU,IAAM,CACd,GAAI,CAACklD,GAAU,CAACC,EAAa,OAC7B,MAAM/gE,EAAI,YAAY,IAAMszC,EAAO,KAAK,KAAK,EAAG,GAAG,EACnD,MAAO,IAAM,cAActzC,CAAC,CAC9B,EAAG,CAAC8gE,EAAQC,CAAW,CAAC,EAEpB,CAACD,GAAU,CAACC,EAAa,OAAO,KACpC,MAAMsD,EAAY,KAAK,IAAI,EAAGtD,EAAcr9C,CAAG,EAEzCigD,EAAQ,KAAK,IAAI,EAAG5C,GADVqD,GAAkB1gD,EACa,EACzC4gD,EAAM,KAAK,IAAI,EAAG,KAAK,IAAI,EAAG,EAAID,EAAYV,CAAK,CAAC,EAE1D,OACE3hD,OAAC,OACC,UAAU,OACV,KAAK,SACL,YAAU,SACV,cAAY,OACZ,aAAY,iBAAiB,KAAK,KAAKqiD,EAAY,GAAI,CAAC,qBAExD,UAAAriD,OAAC,OACC,UAAW,wEAAwEmiD,EAAU,GAAK,MAAM,GACzG,oBACSJ,GAAIM,CAAS,EAAE,SAExB,CAACF,GACAliD,MAAC,OACC,UAAU,oDACV,cAAW,GAEX,SAAAA,MAAC,OACC,UAAU,mBACV,MAAO,CAAE,MAAO,GAAG,KAAK,MAAMqiD,EAAM,GAAG,CAAC,IAAI,EAC9C,EACF,GAIR,CCvDA,MAAMhgC,GAAc,iBAEpB,SAASigC,IAAmB,CAC1B,GAAI,CACF,MAAMvlE,EAAIknC,GAAS,WACb9mC,EAAIuhE,GAAgB,WAEpBpkB,EAAQ,CACZ,OAAQv9C,EAAE,OACV,QAASA,EAAE,QACX,iBAAkBA,EAAE,iBACpB,cAAeA,EAAE,cACjB,WAAYA,EAAE,WACd,iBAAkBA,EAAE,iBAEpB,KAAOA,EAAU,MAAQ,KACzB,KAAOA,EAAU,MAAQ,KACzB,MAAQA,EAAU,OAAS,MAG7B,IAAIwlE,EAAU,GACd,GAAI,CACF,GAAI,OAAO,aAAiB,IAAa,CACvC,MAAMC,EAAM,aAAa,QAAQ,kBAAkB,EACnDD,EAAG,aAAeC,GAAO,IAC3B,CACF,MAAY,CACVD,EAAK,CAAE,aAAc,KACvB,CACA,MAAME,EAAU,CACd,OAAQtlE,EAAE,OACV,YAAaA,EAAE,aAAe,KAC9B,eAAiBA,EAAU,gBAAkB,MAE/C,MAAO,CAAE,MAAAm9C,EAAO,QAAAmoB,EAAS,GAAAF,EAAI,GAAI,KAAK,KAAI,CAC5C,MAAY,CACV,OAAO,IACT,CACF,CAEO,SAASG,IAAqB,CACnC,GAAI,CACF,MAAM77D,EAAQy7D,GAAA,EACd,GAAI,CAACz7D,EAAO,OACZ,aAAa,QAAQw7B,GAAa,KAAK,UAAUx7B,CAAK,CAAC,EAEvD,GAAI,CAIF07B,GAAiB,CAAE,KAAM,WAAY,MAAA17B,CAAA,CAAO,CAC9C,MAAQ,CAAC,CACX,MAAY,CAAC,CACf,CAEO,SAAS87D,IAA2D,CACzE,GAAI,CACF,MAAMlqD,EAAM,aAAa,QAAQ4pB,EAAW,EAC5C,GAAI,CAAC5pB,EAAK,OAAO,KACjB,MAAMyqB,EAAS,KAAK,MAAMzqB,CAAG,EAC7B,MAAO,CAAE,MAAOyqB,EAAO,MAAO,QAASA,EAAO,QAChD,MAAQ,CACN,OAAO,IACT,CACF,CCLA,MAAM0/B,GAAU,CACd,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,MACA,MACA,MACA,MACA,MACA,MACA,MACA,MACA,MACA,MACA,MACA,IACF,EAEA,SAASC,GAAK5gC,EAAqB,CACjC,OAAIA,IAAQ,KAAa,GACf,OAAOA,EAAI,MAAM,CAAC,CAAC,EAClB,CACb,CAEA,SAAS6gC,GAAiBC,EAAqB,CAC7C,OAAKH,GAAQ,SAASG,CAAG,EAClBF,GAAKE,CAAG,EADoB,EAErC,CAEO,SAASC,GACdZ,EACA7U,EAAyB,MACf,CACV,GAAI6U,EAAY,KAAOA,GAAa,QAAU,GAE9C,MAAMa,EAAsC,CAC1C,IAAK,CAAC,YAAY,EAClB,IAAK,CAAC,YAAY,EAClB,IAAK,CAAC,YAAY,EAClB,IAAK,CAAC,YAAY,EAClB,IAAK,CAAC,aAAa,EACnB,IAAK,CAAC,aAAa,EACnB,IAAK,CAAC,aAAa,EACnB,IAAK,CAAC,aAAa,EACnB,IAAK,CAAC,aAAa,EACnB,IAAK,CAAC,aAAa,EACnB,IAAK,CAAC,aAAa,EACnB,IAAK,CAAC,aAAa,EACnB,IAAK,CAAC,aAAa,EACnB,IAAK,CAAC,aAAa,EACnB,IAAK,CAAC,aAAa,EACnB,IAAK,CAAC,aAAa,EACnB,IAAK,CAAC,aAAa,EACnB,IAAK,CAAC,aAAa,EACnB,IAAK,CAAC,aAAa,EACnB,IAAK,CAAC,aAAa,EACnB,IAAK,CAAC,aAAa,EACnB,IAAK,CAAC,aAAa,EACnB,IAAK,CAAC,aAAa,EACnB,IAAK,CAAC,YAAY,EAClB,IAAK,CAAC,eAAgB,YAAY,EAClC,IAAK,CAAC,aAAc,YAAY,EAChC,IAAK,CAAC,aAAa,EACnB,IAAK,CAAC,aAAa,EACnB,IAAK,CAAC,YAAY,EAClB,IAAK,CAAC,YAAY,EAClB,IAAK,CAAC,aAAc,YAAY,EAChC,IAAK,CAAC,aAAc,aAAa,EACjC,IAAK,CAAC,YAAY,EAClB,IAAK,CAAC,SAAS,EACf,GAAI,CAAC,aAAc,aAAa,EAChC,GAAI,CAAC,SAAS,EACd,GAAI,CAAC,SAAS,EACd,GAAI,CAAC,SAAS,EACd,GAAI,CAAC,SAAS,EACd,GAAI,CAAC,SAAS,EACd,GAAI,CAAC,UAAW,SAAS,EACzB,GAAI,CAAC,SAAS,EACd,GAAI,CAAC,UAAW,SAAS,EACzB,GAAI,CAAC,WAAY,SAAS,EAC1B,GAAI,CAAC,SAAS,EACd,GAAI,CAAC,UAAW,SAAS,EACzB,GAAI,CAAC,SAAS,EACd,GAAI,CAAC,SAAU,SAAS,EACxB,GAAI,CAAC,UAAW,SAAS,EACzB,GAAI,CAAC,UAAW,QAAQ,EACxB,GAAI,CAAC,SAAU,UAAU,EACzB,GAAI,CAAC,SAAU,SAAS,EACxB,GAAI,CAAC,UAAW,SAAS,EACzB,GAAI,CAAC,SAAU,SAAS,EACxB,GAAI,CAAC,UAAW,SAAS,EACzB,GAAI,CAAC,SAAU,SAAS,EACxB,GAAI,CAAC,SAAU,SAAS,EACxB,GAAI,CAAC,SAAU,SAAS,EACxB,GAAI,CAAC,SAAU,SAAS,EACxB,GAAI,CAAC,SAAU,SAAS,EACxB,GAAI,CAAC,OAAQ,QAAQ,EACrB,GAAI,CAAC,SAAU,SAAS,EACxB,GAAI,CAAC,QAAQ,EACb,GAAI,CAAC,QAAQ,EACb,GAAI,CAAC,QAAQ,EACb,GAAI,CAAC,KAAK,EACV,GAAI,CAAC,KAAK,EACV,GAAI,CAAC,KAAK,EACV,GAAI,CAAC,KAAK,EACV,GAAI,CAAC,KAAK,EACV,GAAI,CAAC,KAAK,EACV,GAAI,CAAC,KAAK,EACV,GAAI,CAAC,KAAK,EACV,GAAI,CAAC,KAAK,EACV,GAAI,CAAC,KAAK,EACV,GAAI,CAAC,KAAK,EACV,GAAI,CAAC,IAAI,EACT,GAAI,CAAC,IAAI,EACT,GAAI,CAAC,IAAI,EACT,GAAI,CAAC,IAAI,EACT,GAAI,CAAC,IAAI,EACT,EAAG,CAAC,IAAI,EACR,EAAG,CAAC,IAAI,EACR,EAAG,CAAC,IAAI,EACR,EAAG,CAAC,IAAI,GAEV,GAAIA,EAAUb,CAAS,EAAG,OAAOa,EAAUb,CAAS,EAEpD,MAAMjhE,EAAS2hE,GAAiBvV,CAAc,EACxC2V,EAAmB,GAEzB,UAAWnlE,IAAK,CAAC,GAAI,GAAI,GAAI,GAAI,EAAE,EAGjC,GADaqkE,EAAYrkE,IACZoD,EAAQ,CACnB+hE,EAAO,KAAK,IAAInlE,EAAI,CAAC,IAAIwvD,CAAc,EAAE,EACzC,KACF,CAEF,GAAI,CAAC2V,EAAO,QACV,UAAW9xC,IAAK,CAAC,GAAI,GAAI,GAAI,GAAI,GAAI,EAAE,EAErC,GADagxC,EAAYhxC,IACZjwB,EAAQ,CACnB+hE,EAAO,KAAK,GAAG9xC,CAAC,IAAIm8B,CAAc,EAAE,EACpC,KACF,EAGJ,OAAO2V,CACT,CAEO,SAASC,GACdj4C,EACAsyB,EACA4kB,EACAgB,EACA9wC,EACA,CACA,GAAI,CACF,MAAM+wC,EAAQ,OAAO,gBACrB,GAAI,CAACA,EAAO,OACZ,MAAM7gC,EAAM,IAAI,yBAOV8gC,EALYp4C,GACd,WACD,QAAQ,kBAAmB,EAAE,EAC7B,QAAQ,OAAQ,GAAG,EACnB,QAC6BA,GAAQ,SAClCq4C,EAAanB,GAAa,KAAOA,EAAY,EAC7CoB,EAAchmB,IAAW,IAE/B,GAAI,EADmB,CAAClrB,GAAM,cAAgBixC,GAAcC,GACvC,OAGrB,GAAIA,EAAa,CACf,MAAMC,EAAU,CACd,GAAGH,CAAU,8BACb,2BAA2BA,CAAU,IACrC,GAAGA,CAAU,gCAEf9gC,EAAI,KAAOihC,EAAQ,KAAK,MAAM,KAAK,SAAWA,EAAQ,MAAM,CAAC,EAC7DjhC,EAAI,KAAO,IACXA,EAAI,MAAQ,GACd,SAAW4/B,IAAc,EAAG,CAC1B,MAAMsB,EAAa,CACjB,6BAA6BJ,CAAU,IACvC,GAAGA,CAAU,wBACb,4BAA4BA,CAAU,UAExC9gC,EAAI,KAAOkhC,EAAW,KAAK,MAAM,KAAK,SAAWA,EAAW,MAAM,CAAC,EACnElhC,EAAI,KAAO,GACXA,EAAI,MAAQ,IACd,SAAW+gC,EAELnB,GAAa,GACf5/B,EAAI,KAAO,GAAG8gC,CAAU,gBAAgBlB,CAAS,IACxCA,GAAa,IACtB5/B,EAAI,KAAO,GAAG8gC,CAAU,iBAAiBlB,CAAS,IAElD5/B,EAAI,KAAO,GAAG8gC,CAAU,WAAWlB,CAAS,IAE9C5/B,EAAI,KAAO,IACXA,EAAI,MAAQ,UACHgb,IAAW,EAAG,CACvB,MAAMmmB,EAAiB,CACrB,GAAGL,CAAU,gBACb,sBAAsBA,CAAU,IAChC,GAAGA,CAAU,8BAEf9gC,EAAI,KACFmhC,EAAe,KAAK,MAAM,KAAK,SAAWA,EAAe,MAAM,CAAC,EAClEnhC,EAAI,KAAO,IACXA,EAAI,MAAQ,GACd,SAAWgb,GAAU,IAAK,CAExB,MAAMomB,EAAa,CACjB,GAAGN,CAAU,KAAK9lB,CAAM,IACxB,iBAAiB8lB,CAAU,SAAS9lB,CAAM,IAC1C,GAAGA,CAAM,wBAAwB8lB,CAAU,KAE7C9gC,EAAI,KAAOohC,EAAW,KAAK,MAAM,KAAK,SAAWA,EAAW,MAAM,CAAC,EACnEphC,EAAI,KAAO,IACXA,EAAI,MAAQ,IACd,MAAWgb,GAAU,KACnBhb,EAAI,KAAO,GAAGtX,CAAI,KAAKsyB,CAAM,IAC7Bhb,EAAI,KAAO,IACXA,EAAI,MAAQ,IAEZA,EAAI,KAAO,GAAGtX,CAAI,OAAOsyB,CAAM,IAC/Bhb,EAAI,KAAO,IACXA,EAAI,MAAQ,KAId,MAAMqhC,EAAmB,IAAM,CAC7B,GAAIT,EAAW,CACb,MAAMxO,EAASyO,EAAM,YACfnqD,EAAI07C,EAAO,KAAM17C,GAAMA,EAAE,OAASkqD,CAAS,EACjD,GAAIlqD,EACFspB,EAAI,MAAQtpB,MACP,CAEL,MAAM4qD,EAAelP,EAAO,KAAM17C,GAAMA,EAAE,KAAK,WAAW,IAAI,CAAC,EAC3D4qD,MAAkB,MAAQA,EAChC,CACF,CACI,OAAOxxC,GAAM,QAAW,SAC1BkQ,EAAI,OAAS,KAAK,IAAI,EAAG,KAAK,IAAI,EAAGlQ,EAAK,MAAM,CAAC,IAC1C,OAAS,EAClB,GAAI,CACF+wC,EAAM,QACR,MAAQ,CAAC,CACTA,EAAM,MAAM7gC,CAAG,CACjB,EAGe6gC,EAAM,YACV,OAAS,EAClBQ,EAAA,GAGAR,EAAM,iBACJ,gBACA,IAAM,CACJQ,EAAA,CACF,EACA,CAAE,KAAM,GAAK,EAGf,WAAWA,EAAkB,GAAG,EAEpC,MAAQ,CAAC,CACX,CC5UO,MAAME,GAAe,CAE1B,kBAAmB,IACrB,EAcO,SAASC,GAA4BC,EAEjC,CACT,MAAMnmE,EAAImmE,EAAO,0BACjB,MAAI,CAAC,OAAO,SAASnmE,CAAC,GAAKA,GAAK,EAAU,EACnCimE,GAAa,kBAAoBjmE,CAC1C,CAEO,SAASomE,GAAmBD,EAUZ,CACrB,KAAM,CACJ,OAAA/D,EACA,WAAAiE,EAAa,CAAE,EAAG,EAAG,EAAG,GACxB,eAAAC,EACA,0BAAAC,EACA,0BAAAC,CAAA,EACEL,EAEE9hD,GAAM+9C,GAAQ,GAAK,IAAMiE,GAAY,GAAK,GAC1C/hD,GAAM89C,GAAQ,GAAK,IAAMiE,GAAY,GAAK,GAC1CI,EAAS,KAAK,KAAKpiD,EAAKA,EAAKC,EAAKA,CAAE,EACpC2/C,EAAK,KAAK,IACd,EACAwC,GAAU,OAAO,SAASH,CAAc,EAAIA,EAAiB,IAGzDI,EAGJD,GAAUF,EAA4B,KAElCI,EAGJF,GAAUD,EAA4B,KAExC,MAAO,CAAE,WAAYvC,EAAI,YAAAyC,EAAa,YAAAC,CAAA,CACxC,aCgBMC,GAA+D,EAE/DC,GAAsB,IAEtBz1B,GAAkE,IAClE01B,GAA8D,IAC9DC,GAA+D,KAK/DC,GAAgE,KAStE,MAAMC,GAA6D,GAG7DC,GAAkE,IAGlEC,GAAyB,GAMzBC,GAA8D,EAE9DC,GAAmE,EAInEC,GAA4D,IAG5DC,GAAyB,KAGzBC,GAAsB,GACtBC,GAAuB,KAGvBC,GAAyB,GAIzBC,GAAY,GAEZC,GACJ,OAAOrsD,IAAiB,0BAA4B,EAAE,EACnD,OACA,gBAAkB,IACjBssD,GAAmB,IAAIzkD,IAAoB,CAG7C,OAAOA,EAAK,CAAC,GAAM,WAClBA,EAAK,CAAC,EAAE,SAAS,oBAAoB,GACpCA,EAAK,CAAC,EAAE,SAAS,UAAU,GAC3BA,EAAK,CAAC,IAAM,+BAEd,QAAQ,IAAI,GAAGA,CAAI,EAEhBwkD,IACL,QAAQ,IAAI,GAAGxkD,CAAI,CACrB,EASA,SAAS0kD,GACPx5D,EACAkmB,EACA,CAGA,MAAMuzC,EAAO,KAAK,IAAI,EAAG,KAAK,IAAI,IAAKvzC,GAAM,IAAW,CAAC,EACnDwzC,EAAW,KAAK,IAAI,EAAG,KAAK,IAAI,EAAGxzC,GAAM,QAAgB,CAAC,EAE1D/0B,EAAI6O,EAAM,KAChB,QAASvM,EAAI,EAAGA,EAAItC,EAAE,OAAQsC,GAAK,EAAG,CACpC,MAAM/B,EAAIP,EAAEsC,CAAC,EACPxC,EAAIE,EAAEsC,EAAI,CAAC,EAEXvC,EAAIC,EAAEsC,EAAI,CAAC,EAGXqiB,EAAKpkB,EAAI,GAAKT,EAAI,IAAMC,EAAI,IAAO,EACzC,GAAI4kB,GAAK2jD,EAAM,SAGf,MAAME,EAAO7jD,EAAI2jD,EACX9nE,EAAIgoE,EAAO,KAAK,IAAI,EAAG,IAAMF,CAAI,EAIjCG,EAAK9jD,EAAI4jD,EAAWC,EAAOhoE,EAC3Bm9B,EAAQhZ,EAAI,EAAI8jD,EAAK9jD,EAAI,EAE/B3kB,EAAEsC,CAAC,EAAI,KAAK,IAAI,EAAG,KAAK,IAAI,IAAK,KAAK,MAAM/B,EAAIo9B,CAAK,CAAC,CAAC,EACvD39B,EAAEsC,EAAI,CAAC,EAAI,KAAK,IAAI,EAAG,KAAK,IAAI,IAAK,KAAK,MAAMxC,EAAI69B,CAAK,CAAC,CAAC,EAC3D39B,EAAEsC,EAAI,CAAC,EAAI,KAAK,IAAI,EAAG,KAAK,IAAI,IAAK,KAAK,MAAMvC,EAAI49B,CAAK,CAAC,CAAC,CAE7D,CACF,CAQA,SAAS+qC,GAAiBhC,EAMT,CACf,KAAM,CAAE,OAAAiC,EAAQ,OAAAC,EAAQ,OAAAC,EAAQ,OAAAC,EAAQ,QAAAx7C,GAAYo5C,EAC9C70C,EAAK82C,EAASE,EACd/2C,EAAK82C,EAASE,EAQdC,EAAKJ,EAASC,EACdI,EAAKH,EAASC,EACpB,IAAIG,EAAW,EACXC,EAAW,EAEf,GAAI57C,IAAY,QAGd,GAAIy7C,EAAKC,EAAI,CAEX,MAAMG,EAAaL,EAASC,EAC5BE,EAAW,KAAK,IAAI,GAAIE,EAAaN,GAAU,CAAC,CAClD,SAAWE,EAAKC,EAAI,CAElB,MAAMI,EAAaP,EAASE,EAC5BG,EAAW,KAAK,IAAI,GAAIE,EAAaN,GAAU,CAAC,CAClD,OAIAG,EAAW,EACXC,EAAW,EAGb,MAAO,CACL,cAAgBG,GAAoB,CAElC,MAAM3pE,EAAI,CAAE,EAAG2pE,EAAS,EAAIx3C,EAAI,EAAGw3C,EAAS,EAAIv3C,CAAA,EAEhD,MAAO,CAAE,EAAGpyB,EAAE,EAAIupE,EAAU,EAAGvpE,EAAE,EAAIwpE,CAAA,CACvC,EAEJ,CAgFA,MAAAI,GAAejlE,aAAW,SACxB,CACE,iBAAAklE,EACA,YAAAC,EAAc,GACd,WAAAC,EACA,oBAAAC,EAAsB,GACtB,iBAAAC,EAAmB,GACnB,YAAAC,EAAc,MACd,cAAAC,EACA,iBAAAC,EACA,oBAAAC,EACA,WAAAC,EACA,SAAAC,EACA,iBAAkBC,EAAoB,SACtC,eAAAC,EAAiB,GACjB,iBAAAC,EAAmB,GACnB,gBAAAC,EAAkB,EACpB,EAgDArpE,EACA,CACA,MAAMusC,EAAW1oC,SACf,MAGIknC,EAAoBtS,GAAiB5F,GAAMA,EAAE,iBAAiB,EAC9DmY,EAAuBvS,GAAiB5F,GAAMA,EAAE,oBAAoB,EACpEi9B,EAAoBr3B,GAAiB5F,GAAMA,EAAE,iBAAiB,EAC9Dk9B,EAAiBt3B,GAAiB5F,GAAMA,EAAE,cAAc,EACxD+8B,EAAen3B,GAAiB5F,GAAMA,EAAE,YAAY,EACpDg9B,EAAgBp3B,GAAiB5F,GAAMA,EAAE,aAAa,EACtD88B,EAAcl3B,GAAiB5F,GAAMA,EAAE,WAAW,EAClD6/B,EAAmBj6B,GAAiB5F,GAAMA,EAAE,gBAAgB,GAAK,GACjE+/B,EACJn6B,GAAiB5F,GAAMA,EAAE,mBAAmB,GAAK,GAC7Cm9B,EACJv3B,GAAiB5F,GAAMA,EAAE,cAAc,GAAK,iBACxCo9B,EACJx3B,GAAiB5F,GAAMA,EAAE,qBAAqB,GAAK,GAC/Cq9B,EACJz3B,GAAiB5F,GAAMA,EAAE,4BAA4B,GACrD6zC,GACIvW,EACJ13B,GAAiB5F,GAAMA,EAAE,wBAAwB,GAAK,GAClDu9B,EACJ33B,GAAiB5F,GAAMA,EAAE,uBAAuB,GAAK,GACjDw9B,GACJ53B,GAAiB5F,GAAMA,EAAE,+BAA+B,GAAK,EACzDy9B,GACJ73B,GAAiB5F,GAAMA,EAAE,iBAAiB,GAAK,GAC3C09B,GACJ93B,GAAiB5F,GAAMA,EAAE,iBAAiB,GAAK,GAC3CqY,GAAgBzS,GAAiB5F,GAAMA,EAAE,aAAa,EACtDuY,GAAwB3S,GAAiB5F,GAAMA,EAAE,qBAAqB,EACtEy2C,GAAoB7wC,GAAiB5F,GAAMA,EAAE,iBAAiB,EACzC4F,GAAiB5F,GAC1C,OAAOA,EAAE,mBAAsB,UAAYA,EAAE,kBAAoB,IAE1C4F,GAAiB5F,GACxC,OAAOA,EAAE,kBAAqB,UAAYA,EAAE,iBAAmB,IAEjE,MAAMo8B,EAAgBx2B,GAAiB5F,GAAMA,EAAE,aAAa,EACtDu8B,EAAoB32B,GAAiB5F,GAAMA,EAAE,iBAAiB,EAC9Dq8B,GAAcz2B,GAAiB5F,GAAMA,EAAE,WAAW,EAClDs8B,GAAe12B,GAAiB5F,GAAMA,EAAE,YAAY,EAGpDoY,GAAqBxS,GAAgB,WAAW,mBAChD0S,GAAmB1S,GAAgB,WAAW,iBAC9C8wC,GAAuB9wC,GAAgB,WAAW,qBAClDk5B,GAAiBl5B,GAAgB,WAAW,eAC5Cm5B,EAAkBn5B,GAAgB,WAAW,gBAC7Co5B,EAAmBp5B,GAAgB,WAAW,iBACjBA,GAChC5F,GAAMA,EAAE,4BAEX,MAAM22C,GAAmB,GACnBz6B,GACJ+gB,IAAsB,UAAYsZ,GAAoB,CAACI,GACnD,CAACC,GAAkBC,EAAmB,EAAIrpE,WAC9C,EAAC,EAEGmsC,GAAY3oC,SAA0B,IAAI,EAC1C8lE,EAAmB9lE,SAA0B,IAAI,EACjD4oC,EAAa5oC,SAA0B,IAAI,EAC3C,CAAC6rB,EAAWqd,EAAY,EAAI1sC,WAAS,EAAK,EAC1C,CAACupE,GAAYC,EAAa,EAAIxpE,WAAS,EAAK,EAC5C,CAACypE,GAAsBC,EAAuB,EAAI1pE,WAAS,EAAK,EAChE,CAAC2pE,GAAkBC,EAAmB,EAC1C5pE,WAAkC,IAAI,EAGlC,CAAC6pE,GAAmBC,EAAoB,EAAI9pE,WAEhD,IAAI,EACAouC,GAAgBhf,GAAA,EAChB26C,GAAiBpkE,cACpBkI,GAAgC,CAC9Bq+B,EAA6D,QAC5Dr+B,CAMJ,EACA,CAACugC,EAAa,GAEV47B,GAAgBr/B,IAAyB,eACzC+Y,GAAgBtV,GAAc,oBAAsB,KACpD67B,GAAmB77B,GAAc,YACjC87B,GACJF,IACA57B,GAAc,OAAS,SACvB67B,IACA,CAAC,CAACvmB,GACEymB,GACJ96C,GAAa46C,IAAoB,GAE7B,CAACG,GAAgBC,EAAiB,EAAIrqE,WAAS,EAAK,EACpDsqE,GAAgB9mE,SAAO,CAAC,EACxB+mE,EAAe/mE,SAAO,EAAI,EAEhCuX,YAAU,IACD,IAAM,CACXwvD,EAAa,QAAU,EACzB,EACC,EAAE,EAIL,KAAM,CAACC,EAAmBC,EAAoB,EAAIzqE,WAAS,IACrD,OAAO,SAAa,IAAoB,GACrC,CAAC,SAAS,MAClB,EAED+a,YAAU,IAAM,CACd,GAAI,OAAO,SAAa,IAAa,OACrC,MAAM4uB,EAAQ,IAAM8gC,GAAqB,CAAC,SAAS,MAAM,EACzD,gBAAS,iBAAiB,mBAAoB9gC,CAAK,EAC5C,IAAM,SAAS,oBAAoB,mBAAoBA,CAAK,CACrE,EAAG,EAAE,EAKL5uB,YAAU,IAAM,CAEd,MAAMT,EAAI4xB,EAAS,QACb1Z,EAAI4b,GAAc,oBAAsB,KAC9C,GAAI,GAAC9zB,GAAK,CAACkY,GACX,GAAI,CACGlY,EAAE,YACLA,EAAE,UAAYkY,GAGZ,OAAOlY,EAAE,MAAS,YACpB,QAAQ,QAAQA,EAAE,MAAM,EAAE,MAAM,IAAM,CAAC,CAAC,CAE5C,MAAY,CAAC,CACf,EAAG,CAAC8zB,GAAc,YAAaA,GAAc,KAAM1D,CAAiB,CAAC,EAGrE3vB,YAAU,IAAM,CAGd,GADI,CAAC8vB,IACDm/B,IAAiBE,GAAiB,OACtC,MAAMQ,EAAe,CAAC,CAAEt8B,GAAc,mBAEtC,GAAI,CAACs8B,GAAgB,CAACr7C,GAAa,CAAC+6C,GAClC,GAAI,CACG50B,GAAA,CACP,MAAY,CAAC,CAGf,GAAIpH,GAAc,aAAe,CAACs8B,GAAgB,CAACN,GAAgB,CACjE,GAAI,CACFh8B,GAAc,aAAa,EAAK,CAClC,MAAQ,CAAC,CACT,GAAI,CACGoH,GAAA,CACP,MAAY,CAAC,CACf,CACF,EAAG,CACD3K,GACAm/B,GACAE,GACA76C,EACA+6C,GACA1/B,CAAA,CACD,EAGD3vB,YAAU,IAAM,CACd,MAAMT,EAAI4xB,EAAS,QACnB,GAAI,CAAC5xB,EAAG,OACR,MAAMkmD,EAAW,IAAM,CACrB,GAAI,CACF,MAAMniE,EAAIic,EAAE,OACRjc,GAAK,OAAOA,EAAE,OAAU,YAAYA,EAAE,MAAM,IAAM,CAAC,CAAC,CAC1D,MAAY,CAAC,CACf,EACMssE,EAAY,IAAM,CAEtB,GAAI,CACErwD,EAAE,YAAcA,EAAE,gBAA2B,EAAI,CACvD,MAAQ,CAAC,CACX,EACMswD,EAAW,IAAM,CACrB,GAAI,CACEtwD,EAAE,YAAcA,EAAE,gBAA2B,EAAI,CACvD,MAAQ,CAAC,CACX,EACA,OAAAA,EAAE,iBAAiB,iBAAkBkmD,CAAQ,EAC7ClmD,EAAE,iBAAiB,UAAWqwD,CAAS,EAEvCrwD,EAAE,iBAAiB,SAAUswD,CAAe,EACrC,IAAM,CACXtwD,EAAE,oBAAoB,iBAAkBkmD,CAAQ,EAChDlmD,EAAE,oBAAoB,UAAWqwD,CAAS,EAC1CrwD,EAAE,oBAAoB,SAAUswD,CAAe,CACjD,CACF,EAAG,EAAE,EAEL,MAAMC,GAA0BllE,cAC7B+tB,GAAuD,CACtD,MAAMpZ,EAAI4xB,EAAS,QACb1Z,EAAK4b,GAAc,oBACvB,KACI08B,EAAct4C,EAAIA,EAAE,iBAAmB,GACvCu4C,EAAcv4C,EAAIA,EAAE,iBAAmB,GAC7C,MAAO,CACL,GAAI,KAAK,MACT,WAAY,CAAC,CAAClY,EACd,MAAO,CACL,aAAc,CAAC,CAAEA,GAAW,UAC5B,WACE,OAAQA,GAAW,YAAe,SAC7BA,EAAU,WACX,KACN,OACE,OAAQA,GAAW,QAAW,UAAaA,EAAU,OAAS,KAChE,MACE,OAAQA,GAAW,OAAU,UAAaA,EAAU,MAAQ,KAC9D,WAAYA,GAAG,YAAc,EAC7B,YAAaA,GAAG,aAAe,GAEjC,OAAQ,CACN,OAAQ,CAAC,CAACkY,EACV,YAAas4C,EAAY,OACzB,YAAaC,EAAY,OACzB,iBAAkBD,EAAY,IAAK3rE,KAAO,CACxC,QAASA,GAAE,QACX,MAAQA,GAAU,MAClB,WAAYA,GAAE,YACd,GAEJ,QAAS,CACP,KAAOivC,GAAsB,KAC7B,YAAcA,GAAsB,aAEtC,gBAAiB,CACf,GAAI1D,EACJ,MAAOC,EACP,OAAQI,EAAA,EAEV,MAAOrX,GAAM,OAAS,KAE1B,EACA,CACE0a,GACA1D,EACAC,EACAI,EAAA,CACF,EAKFhwB,YAAU,IAAM,CACd,GAAI,CAAC0uD,GAAsB,OAC3B,IAAIvH,EAAQ,GACZ,MAAMnmB,EAAO,IAAM,CACjB,GAAKmmB,EACL,GAAI,CACF0H,GAAoBiB,IAAyB,CAC/C,MAAQ,CAAC,CACX,EACA9uB,EAAA,EACA,MAAMt2C,EAAK,OAAO,YAAYs2C,EAAM,GAAG,EACvC,MAAO,IAAM,CACXmmB,EAAQ,GACR,OAAO,cAAcz8D,CAAE,CACzB,CACF,EAAG,CAACgkE,GAAsBoB,EAAuB,CAAC,EAKlD9vD,YAAU,IAAM,CACd,GAAI,CACD,OAAe,mBACb,OAAe,oBAAsB,GACvC,OAAe,mBAAmB,QAAU,IAAM,CACjD,GAAI,CACF,OAAO8vD,GAAwB,CAAE,MAAOhB,GAAmB,CAC7D,OAASjrE,EAAG,CACV,MAAO,CAAE,MAAO,OAAOA,CAAC,EAC1B,CACF,EACC,OAAe,mBAAmB,QAAU,IAC3CstC,EAAS,SAAW,KACrB,OAAe,mBAAmB,OAAS,IAC1CkC,GAAc,oBAAsB,IACxC,MAAY,CAAC,CACb,MAAO,IAAM,CACX,GAAI,CACG,OAAe,oBAClB,OAAQ,OAAe,mBAAmB,OAC9C,MAAQ,CAAC,CACX,CACF,EAAG,CAACy8B,GAAyBhB,GAAmBz7B,EAAa,CAAC,EAK9DhlB,kBAAgB,IAAM,CAEpB,GAAI,CAAC0/C,EAAgB,OAGrB,GAAI,CACF1wC,GAAgB,WAAW,iBAAiB,EAAI,CAClD,MAAQ,CAAC,CAGL,CADiB,CAAC,CAAEgW,GAAc,oBACjB,CAAC/e,GAAa,CAAC+6C,IAC7B50B,GAAA,CAET,EAAG,CAACszB,CAAc,CAAC,EAGnB/tD,YAAU,IAAM,CAGd,GADI,CAAC8vB,IAAiBi+B,GAClBkB,IAAiBE,GAAiB,OACtC,MAAMQ,EAAe,CAAC,CAAEt8B,GAAc,mBAEtC,GAAI,CAACs8B,GAAgB,CAACr7C,GAAa,CAAC+6C,GAClC,GAAI,CACG50B,GAAA,CACP,MAAY,CAAC,CAGf,GAAIpH,GAAc,aAAe,CAACs8B,GAAgB,CAACN,GAAgB,CACjE,GAAI,CACFh8B,GAAc,aAAa,EAAK,CAClC,MAAQ,CAAC,CACT,GAAI,CACGoH,GAAA,CACP,MAAY,CAAC,CACf,CACF,EAAG,CACD3K,GACAm/B,GACAE,GACA76C,EACA+6C,GACA1/B,EACAo+B,CAAA,CACD,EAID/tD,YAAU,IAAM,CACd,MAAM8hD,EAAWz4B,GAAY,CAC3B/hB,GAAK,2CAA4C+hB,EAAG,MAAM,EAC1D,GAAI,CACF0G,GAAiB,EAAI,CACvB,MAAQ,CAAC,CACL,CAACzb,GAAa,CAAC+6C,IACZ50B,GAAA,CAET,EACA,cAAO,iBAAiB,mBAA2BqnB,CAAO,EACnD,IAAM,OAAO,oBAAoB,mBAA2BA,CAAO,CAC5E,EAAG,CAACxtC,EAAW+6C,GAAgBt/B,EAAgB,CAAC,EAEhD,KAAM,CACJ,EAAA1a,GACA,UAAA6d,GACA,YAAAD,GACA,MAAAhb,GACA,kBAAA+C,GACA,aAAAD,GACA,UAAAk1C,GACA,OAAAj9B,GACA,QAAAvW,EAAA,EACE1L,GAAA,EAIEm/C,GAAwBznE,SAAe,MAAM,EAI7C0nE,GAAa7lC,GAAU7S,GAAMA,CAAC,EAC9B24C,GAAgB,CAAC,EAAED,IAAeA,GAAmB,QAErD/8B,GAAe,GACfi9B,GAA6B,GAG7BC,GAAa,OAAO7zC,IAAY,SAAWA,GAAU,KACrD8zC,GAAwB/zC,GAA+B8zC,EAAU,EACjEE,GACJ,CAAC,CAACn7C,IACF,CAAC,CAAC6d,KACDF,IACEs9B,IAAc,MACbA,IAAcl9B,IACdm9B,IAAyB,MACzBA,IAAyBF,IAOzBI,GAA4BL,GAC9BI,GAFmB,CAAC,CAACn7C,IAAK,CAAC,CAAC6d,GAIhClzB,YAAU,IAAM,CACVgwB,IAAyB,CAACk+B,IAC5BC,GAAqB,EAAI,CAE7B,EAAG,CAACn+B,GAAuBk+B,GAAmBC,EAAoB,CAAC,EACnE,KAAM,CAACuC,GAAeC,EAAgB,EAAI1rE,WAAiB,EAAE,EACvD,CAAC2rE,GAAaC,EAAc,EAAI5rE,WAAiB,EAAE,EACnD,CAAC6rE,GAAeC,EAAgB,EAAI9rE,WAAiB,CAAC,EACtD,CAAC+rE,GAAcC,EAAe,EAAIhsE,WAAe,MAAM,EAGvDisE,GAAoBzoE,SAGhB,IAAI,EAKR0oE,GAAe1oE,SAKlB,CACD,QAAS,GACT,WAAY,EACZ,mBAAoB,KACpB,eAAgB,KACjB,EASK2oE,GAAqB3oE,SAMxB,CAAE,IAAK,KAAM,QAAS,EAAG,OAAQ,EAAG,OAAQ,EAAG,QAAS,KAAM,EAC3D,CAAC4oE,GAAcC,EAAe,EAAIrsE,WAAiB,CAAC,EACpDssE,GAAkB9oE,SAAe,CAAC,EAClC,CAAC+oE,GAAcC,EAAe,EAAIxsE,WAAiB,CAAC,EACpD,CAACysE,GAAgBC,EAAiB,EAAI1sE,WAW1C,EAAE,EAEE,CAAC2sE,GAAeC,EAAgB,EAAI5sE,WAAS,EAAK,EAClD,CAAC6sE,GAAYC,EAAa,EAAI9sE,WAAS,EAAK,EAE5C+sE,EACJ5B,IACCsB,GAAyB,KACvB7tE,GAAMA,EAAE,MAAQA,EAAE,KAAK,SAAW,UAAY,CAACA,EAAE,KAAK,kBAErD,CAACouE,GAAqBC,EAAsB,EAAIjtE,WAAiB,CAAC,EAClE,CAACktE,GAAsBC,EAAuB,EAAIntE,WAAiB,CAAC,EACpE,CAACotE,GAAeC,EAAgB,EAAIrtE,WAAS,EAAK,EAClDstE,GAAmB9pE,SAUf,IAAI,EACR+pE,GAAwB/pE,SAAsB,IAAI,EAMlDgqE,GACJ,CAACnF,GAAuB1Y,IAAmB,YACvC,CAAC8d,GAAkBC,EAAmB,EAAI1tE,WAAS,CAAC,EACpD,CAAC2tE,GAAwBC,EAAyB,EAAI5tE,WAE1D,EAAE,EACE6tE,GAAmBrqE,SAA6B,IAAI,EACpDsqE,GAAkBtqE,SAA4B,EAAE,EAChDuqE,GAAoBvqE,SAAe,CAAC,EACpCwqE,GAAsBxqE,SAA0C,IAAI,EACpEyqE,GAAmBzqE,SAA0C,EAAE,EAC/D0qE,GAAiB1qE,SAAgB,EAAK,EACtC2qE,GAAqB3qE,SAAe,CAAC,EACrC4qE,GAAsB5qE,SAAe,CAAC,EACtC6qE,GAAoB7qE,SAAgB,EAAK,EACzC8qE,GAAuB9qE,SAAsB,IAAI,EACjD+qE,GAA2B/qE,SAAe,CAAC,EAC3CgrE,GAAwBhrE,SACU,OAAO,mBAEzCirE,GAAkBjrE,SAGrB,CAAE,QAAS,KAAM,aAAc,EAAG,EAC/BkrE,GAAoBlrE,SAAe,CAAC,EACpCmrE,GAA6BnrE,SAAe,CAAC,EAC7CorE,GAAgBprE,SAAe,CAAC,EAChCqrE,GAAUrrE,SAA4B,IAAI,EAC1C,CAACsrE,GAAcC,EAAe,EAAI/uE,WAA8B,EAAE,EAClE,CAACgvE,GAAeC,EAAgB,EAAIjvE,WACxC,MAEI,CAACkvE,GAAYC,EAAa,EAAInvE,WAK1B,IAAI,EACR,CAACovE,GAAiBC,CAAiB,EAAIrvE,WAE3C,MAAM,EACF,CAACsvE,EAAkBC,CAAkB,EAAIvvE,WAAwB,IAAI,EAIrE,CAACwvE,EAAwBC,CAAyB,EAAIzvE,WAAS,EAAK,EACpE0vE,GAAiBlsE,SA6BpB,CAAE,OAAQ,EAAG,EACV,EAAGmsE,EAAkB,EAAI3vE,WAAS,CAAC,EACnC4vE,GAAoBjqE,cACvBkqE,GAAuD,CACtD,GAAI,CACFH,GAAe,QAAU,CACvB,GAAGA,GAAe,QAClB,GAAGG,EACH,OAAQ,KAAK,KAAI,EAGfL,GAAwBG,GAAoBvxE,IAAOA,EAAI,GAAK,GAAM,EACtE,GAAI,CAGD,OAAe,wBAA0B,CACxC,GAAGsxE,GAAe,QAClB,QAAS,CAGP,cAAe,qBACf,QAAS,IAAI,OAAO,aAAY,CAClC,CAEJ,MAAQ,CAAC,CACX,MAAQ,CAAC,CACX,EACA,CAACF,CAAsB,GAMzBz0D,YAAU,IAAM,CACd,GAAI,CACF,MAAM+0D,EAAmB,CAAC,CAAC1/C,GACrB2/C,EAAkB,CAAC,EACvB9hC,IACA,OAAOA,GAAU,GAAM,UACvB,OAAOA,GAAU,GAAM,UACvBA,GAAU,EAAI,GACdA,GAAU,EAAI,GAEV+hC,EAAkBD,EACpB,GAAG,KAAK,MAAM9hC,GAAW,CAAC,CAAC,IAAI,KAAK,MAAMA,GAAW,CAAC,CAAC,GACvD,SACJ2hC,GAAkB,CAChB,cAAeE,EACf,aAAcC,EACd,aAAcC,CAAA,CACf,CACH,MAAQ,CAAC,CACX,EAAG,CAAC5/C,GAAG6d,GAAW2hC,EAAiB,CAAC,EAEpC70D,YAAU,IAAM,CACd,MAAM8hD,EAAWj+D,GAAqB,CACpC,GAAI,CAGF,GAFY,OAAOA,EAAE,KAAO,EAAE,EAAE,gBACpB,KACR,EAAEA,EAAE,WAAaA,EAAE,SAAWA,EAAE,UAAW,OAC/CA,EAAE,iBACF6wE,EAA2Bn1D,GAAM,CAACA,CAAC,CACrC,MAAQ,CAAC,CACX,EACA,cAAO,iBAAiB,UAAWuiD,CAAO,EACnC,IAAM,OAAO,oBAAoB,UAAWA,CAAO,CAC5D,EAAG,EAAE,EAIL,KAAM,CAACoT,GAAgBC,EAAiB,EAAIlwE,WAMzC,IAAI,EAID,CAACmwE,GAAeC,EAAgB,EAAIpwE,WAIhC,IAAI,EAGR,CAACqwE,GAAcC,EAAe,EAAItwE,WAEtC,EAAE,EAIE,CAACuwE,GAAaC,EAAc,EAAIxwE,WAI5B,IAAI,EAERywE,GAA2B9qE,cAC9BqvC,GAMK,CACJ,GAAI,CACF,GAAI,CAAC4a,EAAuB,MAAO,GACnC,GAAIqgB,GAAgB,MAAO,GAC3B,MAAMxO,EAAO,OAAOzsB,EAAQ,UAAU,EACtC,GAAI,CAAC,SAASysB,CAAI,EAAG,MAAO,GAC5B,MAAMiP,EAAqB,KAAK,IAC9B,GACA,KAAK,IACH,IACA,OAAO7gB,CAA4B,GAAKwW,EAAA,CAC1C,EAEF,OAAI5E,GAAQiP,EAA2B,IACvCR,GAAkB,CAChB,MAAOl7B,EAAQ,MACf,MAAOA,EAAQ,MACf,KAAMA,EAAQ,KACd,WAAYysB,EACZ,KAAMzsB,EAAQ,KACf,EACM,GACT,MAAQ,CACN,MAAO,EACT,CACF,EACA,CACE4a,EACAqgB,GACApgB,EACAqgB,EAAA,CACF,EAQIS,GAA0BntE,SAAO,EAAK,EAC5CuX,YAAU,IAAM,CAEd41D,GAAwB,QAAU,EACpC,EAAG,CAACpI,CAAW,CAAC,EAChB,MAAMqI,GAA0BjrE,cAAY,IAAM,CAC5C4nE,GAAsB,UACxB,aAAaA,GAAsB,OAAO,EAC1CA,GAAsB,QAAU,KAEpC,EAAG,EAAE,EAECsD,GAAmBlrE,cAAa/F,GAChC,OAAOA,GAAU,UAAY,OAAO,MAAMA,CAAK,EAAU,EACtD,KAAK,IAAI,KAAM,KAAK,IAAI,GAAK,KAAK,MAAMA,EAAQ,GAAG,EAAI,GAAG,CAAC,EACjE,EAAE,EAECkxE,GAAoBnrE,cACvB2tB,GAAkB,CACjB,GAAI,CAACg+B,GAAgB,OACrB,MAAMx8C,EAAO+7D,IAAkBvhB,GAAe,GAAKh8B,CAAK,EACxDg+B,GAAex8C,CAAI,CACrB,EACA,CAACw6C,EAAauhB,GAAkBvf,EAAc,GAG1Cyf,GAAiBprE,cAAY,IAAM,CACnC6rD,KAAmC,MAAM,EACzCD,KAAiC,MAAM,CAC7C,EAAG,CAACC,EAAkBD,CAAe,CAAC,EAEhCyf,GAAiBrrE,cAAY,IAAM,CACnC6rD,KAAmC,KAAK,EACxCD,KAAiC,MAAM,CAC7C,EAAG,CAACC,EAAkBD,CAAe,CAAC,EAItC0f,sBAAoBtxE,EAAK,KAAO,CAC9B,iBAAkB,IAAM,CACtB,GAAI,CACEkvE,GAAQ,SAASA,GAAQ,SAC/B,MAAY,CAAC,CACf,EAGA,eAgHM,OACN,mBAOM,OACN,YAAa,SAAY,CACvB,GAAI,CACF,OAAO,MAAMqC,GAAA,CACf,MAAY,CACV,MAAO,EACT,CACF,EACA,4BA4BM,QACN,EAEF,MAAMC,GAAsBxrE,cAAasL,GAA6B,CACpE,GAAI,CACF,MAAMlT,EAAI63C,GAAA,EACN73C,MAAS,MAAQA,EACvB,MAAY,CAAC,CACb,MAAM+W,EAAO,CAAC,GAAGg5D,GAAgB,QAAQ,MAAM,EAAE,EAAG78D,CAAK,EACzD68D,GAAgB,QAAUh5D,EAC1Bi6D,GAAgBj6D,CAAI,EACpB,GAAI,CACFm6D,GAAiBh+D,CAAK,CACxB,MAAY,CAAC,CACb,GAAI,CACD,OAAe,qBAAuB6D,CACzC,MAAY,CAAC,CACf,EAAG,EAAE,EAGCs8D,GAAWzrE,cAAY,IAAM,CACjC,GAAI,CACF,MAAM0rE,EACH,OAAe,cAAiB,OAAe,mBAClD,GAAI,CAACA,EAAK,OACV,MAAMn7C,EAAM,IAAIm7C,EACVhqE,EAAI6uB,EAAI,mBACRz3B,EAAIy3B,EAAI,aACd7uB,EAAE,KAAO,OACTA,EAAE,UAAU,MAAQ,IACpB5I,EAAE,KAAK,MAAQ,MACf4I,EAAE,QAAQ5I,CAAC,EACXA,EAAE,QAAQy3B,EAAI,WAAW,EACzB7uB,EAAE,QACF,WAAW,IAAM,CACf,GAAI,CACFA,EAAE,OACF6uB,EAAI,SACN,MAAY,CAAC,CACf,EAAG,GAAG,CACR,MAAY,CAAC,CACf,EAAG,EAAE,EAGCg7C,GAAcvrE,cAAY,SAAY,CAC1C,GAAI,CACF0pE,EAAkB,SAAS,EAC3BE,EAAmB,IAAI,EAEvBzB,GAAgB,QAAU,GAC1BiB,GAAgB,EAAE,EAElB,MAAMuC,EAAQ,EACd,QAASrwE,EAAI,EAAGA,EAAIqwE,EAAOrwE,IAAK,CAC9B,GAAI,CACE4tE,GAAQ,SAASA,GAAQ,SAC/B,MAAY,CAAC,CAGb,MAAM,IAAI,QAAS3vE,GAAM,WAAWA,EAAG,GAAG,CAAC,CAC7C,CACA,MAAMqyE,EAAOzD,GAAgB,QAAQ,QAC1ByD,EAAK,KACb3yE,GACCA,EAAE,UACDA,EAAE,OACDA,EAAE,aACCixD,GAAgCwW,GAAA,GAGvCgJ,EAAkB,MAAM,EACxBE,EAAmB,cAAc,IAEjCF,EAAkB,MAAM,EACxBE,EACEgC,EAAK,OACD,4CAA4CA,EAAKA,EAAK,OAAS,CAAC,EAAE,YAAc,GAAG,QAAQ,CAAC,CAAC,IAC7F,iBAGV,MAAY,CACVlC,EAAkB,MAAM,EACxBE,EAAmB,iBAAiB,CACtC,SAEE,WAAW,IAAMF,EAAkB,MAAM,EAAG,GAAI,CAClD,CACF,EAAG,CAACxf,CAA4B,CAAC,EAC3Bja,GAAejwC,cAAY,IAAqB,CACpD,GAAI,CACF,MAAM2U,EAAI4xB,EAAS,QACnB,GAAI,CAAC5xB,GAAK,CAACA,EAAE,YAAc,CAACA,EAAE,YAAa,OAAO,KAClD,MAAM3H,EAAI,IACJ9T,EAAI,KAAK,MAAOyb,EAAE,YAAcA,EAAE,WAAc3H,CAAC,GAAK,IACtDpU,EAAI,SAAS,cAAc,QAAQ,EACzCA,EAAE,MAAQoU,EACVpU,EAAE,OAASM,EACX,MAAMq3B,EAAM33B,EAAE,WAAW,IAAI,EAC7B,OAAK23B,GACLA,EAAI,UAAU5b,EAAG,EAAG,EAAG3H,EAAG9T,CAAC,EACpBN,EAAE,UAAU,aAAc,EAAG,GAFnB,IAGnB,MAAY,CACV,OAAO,IACT,CACF,EAAG,EAAE,EAECizE,GAAwB7rE,cAC3B8rE,GAA+C,CAC9C,MAAMt8B,EAAUm4B,GAAiB,QACjC,GAAKn4B,EACL,CAAAm4B,GAAiB,QAAU,KAC3BsD,GAAA,EACAvD,GAAiB,EAAK,EACtBiD,GAAgB,EAAE,EAKlB,GAAI,CACF,MAAMoB,EAAgBv8B,EAAQ,MAAc,QAGtCw8B,EACJD,IAAeA,EAAa,OAAS,CAAC,GAAG,MAAM,eACjDE,GAAkBD,CAAQ,CAC5B,MAAQ,CAAC,CAGT,GAAIzJ,EACF,GAAI,CACFA,EACE/yB,EAAQ,MACRA,EAAQ,MACRA,EAAQ,SACRA,EAAQ,MAEV,GAAI,CAEFxR,GAAiB,CACf,KAAM,QACN,MAAOwR,EAAQ,MACf,MAAOA,EAAQ,MACf,SAAUA,EAAQ,SAClB,KAAMA,EAAQ,KACd,UAAW+1B,GAAW,iBACtB,GAAI,KAAK,KAAI,CACd,EAED,GAAI,CACFpH,GAAA,CACF,MAAY,CAAC,CACb,GAAI,CACF,MAAM/lE,EAAI63C,GAAA,EACVu5B,GAAc,CACZ,GAAI,KAAK,MACT,MAAOh6B,EAAQ,MACf,MAAOA,EAAQ,MACf,MAAOp3C,CAAA,CACR,CACH,MAAY,CAAC,CACf,MAAY,CAAC,CACf,MAAY,CAAC,EAEjB,EACA,CAACmqE,EAAkB0I,EAAuB,GAEtCiB,GAAqBlsE,cACxBqvC,GAUK,CACJ,GAAKkzB,EACL,IAAI,CAACsF,GAAmB,CAEtB,GAAI,CACF,MAAMkE,EAAgB18B,EAAQ,MAAc,QAGtC28B,EACJD,IAAeA,EAAa,OAAS,CAAC,GAAG,MAAM,eACjDE,GAAkBD,CAAQ,CAC5B,MAAQ,CAAC,CACT,GAAI,CACFG,GAAc98B,EAAQ,KAAK,CAC7B,MAAQ,CAAC,CACT,GAAI,CACFkzB,EACElzB,EAAQ,MACRA,EAAQ,MACRA,EAAQ,SACRA,EAAQ,KAEZ,MAAY,CAAC,CACb,MACF,CACAs4B,GAAiB,QAAUt4B,EAC3Bq4B,GAAiB,EAAI,EACrBuD,GAAA,EACArD,GAAsB,QAAU,OAAO,WACrC,IAAMiE,GAAsB,SAAS,EACrC7K,EAAA,EAEJ,EACA,CACEuB,EACAsF,GACAoD,GACAY,GACAI,GACAE,EAAA,CACF,EAEIC,GAAqBpsE,cAAau1D,GAAoC,CAC1EmR,GAAgB,CAAC,EACjBC,GAAgB,QAAU,EAC1BE,GAAgB,CAAC,EACjBE,GAAkB,EAAE,EACpB4D,GAAgB,EAAE,EAClBrD,GAAuB,CAAC,EACxBE,GAAwB,CAAC,EACzB6E,GAAiB,EAAK,EACtB,GAAI,CACF,OAAO,cACL,IAAI,YAAY,0BAA2B,CACzC,OAAQ,CAAE,OAAQ,cAAe,OAAA9W,EAAQ,GAAI,KAAK,KAAI,CAAE,CACzD,EAEL,MAAY,CAAC,CACf,EAAG,EAAE,EACLngD,YAAU,IAAM,CACd,GAAI,CAACyyD,GAAmB,OACxB,MAAM3Q,EAAU,IAAM2U,GAAsB,OAAO,EACnD,cAAO,iBAAiB,oBAAqB3U,CAAwB,EAC9D,IACL,OAAO,oBAAoB,oBAAqBA,CAAwB,CAC5E,EAAG,CAAC2Q,GAAmBgE,EAAqB,CAAC,EAC7Cz2D,YAAU,IAAM,CACTyyD,IAAmBgE,GAAsB,SAAS,CACzD,EAAG,CAAChE,GAAmBgE,EAAqB,CAAC,EAC7Cz2D,YACE,IAAM,IAAMy2D,GAAsB,UAAU,EAC5C,CAACA,EAAqB,GAExB,MAAMS,GAAuBtsE,cAAY,IAAM,CAC7CosE,GAAmB,WAAW,EAC9BrE,GAAqBpzD,GAAMA,EAAI,CAAC,CAClC,EAAG,CAACy3D,EAAkB,CAAC,EACjBG,GAAqBvsE,cAAY,IAAM,CACvCymE,KAAiB,GAAKG,KAAiB,IAC3CwF,GAAmB,SAAS,EAC5BrE,GAAqBpzD,GAAMA,EAAI,CAAC,EAClC,EAAG,CAACy3D,GAAoB3F,GAAcG,EAAY,CAAC,EAC7C4F,GAAuBxsE,cAAY,IAAM,CAC7C,GAAI,CAAA+oC,GACJ,GAAI,CACF,OAAO,cACL,IAAI,YAAY,0BAA2B,CACzC,OAAQ,CAAE,OAAQ,cAAe,GAAI,KAAK,KAAI,CAAE,CACjD,EAEL,OAASxxB,EAAK,CACZ,QAAQ,KAAK,iDAAkDA,CAAG,CACpE,CACF,EAAG,CAACwxB,EAAU,CAAC,EAET0jC,GAAqBh6C,GAAiB5F,GAAMA,EAAE,WAAW,EACzD6gC,GACJ,OAAOqV,GAAwB,UAC3B,CAAC,CAACA,EACF,CAAC,CAAC0J,GACF,CAACC,GAAYC,EAAa,EAAItyE,WAAkC,EAAE,EAElEuyE,GAAkBrH,GAAW,QAAQA,GAAW,gBAAgB,GAAG,GACnEsH,GAAW,CAAC,EAAED,IAAmBF,GAAWE,EAAe,GAC3DE,GAAan4D,GAAe,CAC3Bi4D,IACLD,GAAen0E,IAAO,CAAE,GAAGA,EAAG,CAACo0E,EAAe,EAAGj4D,CAAA,EAAI,CACvD,EACMo4D,GAAcxH,IAAoB,WAElCyH,GAAW9P,GAAiBrwC,GAAMA,EAAE,QAAQ,EAC5CogD,GAAoB/P,GAAiBrwC,GAAMA,EAAE,KAAK,EACxDzX,YAAU,IAAM,CACd,GAAI,CACF43D,GAASlG,GAAuBL,GAAcG,EAAY,EAG1D,GAAI,CACF,MAAM3oC,EAAW,CACf,KAAM,eACN,QAAS6oC,GACT,MAAOL,GACP,MAAOG,GACP,UAAWrB,GAAW,iBACtB,GAAI,KAAK,KAAI,EAGf,GAAI,CACF,MAAM5wD,EAAI4xB,EAAS,QACnB,GAAI5xB,GAAKA,EAAE,YAAcA,EAAE,YAAa,CAEtC,MAAMzb,EAAI,KAAK,MAAOyb,EAAE,YAAcA,EAAE,WAAc,GAAC,GAAK,IACtD/b,EAAI,SAAS,cAAc,QAAQ,EACzCA,EAAE,MAAQ,IACVA,EAAE,OAASM,EACX,MAAMq3B,GAAM33B,EAAE,WAAW,IAAI,EAC7B,GAAI23B,GAAK,CACPA,GAAI,UAAU5b,EAAG,EAAG,EAAG,IAAGzb,CAAC,EAC3B,GAAI,CACF+kC,EAAI,MAAQrlC,EAAE,UAAU,aAAc,GAAI,CAC5C,MAAY,CAAC,CACf,CACF,CACF,MAAY,CAAC,CACbolC,GAAiBC,CAAG,CACtB,MAAY,CAAC,CACf,MAAY,CAAC,CACf,EAAG,CAAC6oC,GAAgBL,GAAcG,GAAcoG,EAAQ,CAAC,EACzD53D,YACE,IAAM,IAAM,CACV,GAAI,CACF63D,GAAA,CACF,MAAY,CAAC,CACf,EACA,CAACA,EAAiB,GAEpB,MAAMC,GAAWxtC,GAAU7S,GAAMA,EAAE,QAAQ,EACrCsgD,GAASztC,GAAU7S,GAAMA,EAAE,MAAM,EAGjCugD,GAA6BptE,cAAa0L,GAAmB,CACjE,GAAI,CACF,OAAK,MAAM,QAAQA,CAAO,EACnBA,EAAQ,MAAM,EAAG,CAAC,EAAE,IAAKzS,IAAO,CACrC,MAAO,OAAOA,GAAG,OAAS,EAAE,EAC5B,MAAO,OAAOA,GAAG,OAAS,CAAC,EAC3B,KAAM,OAAOA,GAAG,MAAQ,EAAE,GAC1B,EAL2B,MAM/B,MAAQ,CACN,MACF,CACF,EAAG,EAAE,EAECo0E,GAAe,CAAC90C,EAAe8E,EAAeE,IAAe,CACjE,GAAI,CACF7gB,GAAK,2BAA4B6b,EAAO8E,EAAOE,CAAI,EACnD,GAAI,CACFstC,GAAe,CAAE,MAAAtyC,EAAO,MAAA8E,EAAO,QAAS,KAAK,MAAQ,IAAM,CAC7D,MAAY,CAAC,CACT2lC,EAAYA,EAAWzqC,EAAO8E,EAAOE,CAAI,EACxC2vC,GAAS30C,EAAO8E,EAAOE,CAAI,EAChC,GAAI,CAEFS,GAAiB,CACf,KAAM,QACN,MAAAzF,EACA,MAAA8E,EACA,UAAWkoC,GAAW,iBACtB,GAAI,KAAK,KAAI,CACd,EACD,GAAI,CACFpH,GAAA,CACF,MAAY,CAAC,CACf,MAAY,CAAC,CACf,MAAQ,CAER,CACF,EACMmP,GAAc/0C,GAAmB,CACrC,GAAI,CACE0qC,IAAmB1qC,CAAK,EACvB40C,GAAO,OAAO50C,GAAU,SAAWA,EAAQ,CAAC,CACnD,MAAQ,CAER,CACF,EAEM,CAACg1C,GAAgBC,EAAiB,EAAInzE,WAAS,EAAE,EACjD,CAACozE,GAAaC,EAAc,EAAIrzE,WAAS,CAAC,EAC1C,EAAGszE,EAAiB,EAAItzE,WAAS,EAAK,EACtC,CAACuzE,GAAevB,EAAgB,EAAIhyE,WAAS,EAAK,EAClD,CAACwzE,GAAkBC,EAAkB,EAAIzzE,WAAS,EAAK,EACvD,CAAC4nD,GAAWC,EAAY,EAAI7nD,WAA4B,QAAQ,EAChE,CAAC0zE,GAAiBC,EAAkB,EAAI3zE,WAAS,EAAK,EACtD,EAAG4zE,EAAgB,EAAI5zE,WAAS,EAAK,EACrC,CAAC6zE,GAAkBC,EAAmB,EAAI9zE,WAAS,EAAK,EACxD+zE,GAAmBvwE,SAAiC,IAAI,EAExDyvD,GAAmB76B,GAAiB5F,GAAMA,EAAE,gBAAgB,EAC5D0gC,GAAmB96B,GAAiB5F,GAAMA,EAAE,gBAAgB,GAAK,GACjE,CAACwhD,GAAcC,EAAe,EAAIj0E,WAAwB,IAAI,EAC9D6oC,GAAWrlC,SAAsB,IAAI,EACrCy8D,GAASH,GAAiBttC,GAAMA,EAAE,MAAM,EAExC0hD,GAAc1wE,SAA4B,IAAI,EAC9C2wE,GAAS3wE,SAAsB,IAAI,EACnC4wE,GAAmB5wE,SAAe,CAAC,EACnC4sC,GAAiB5sC,SAAsB,IAAI,EAC3C6sC,GAAmB7sC,SAAe,CAAC,EACnC6wE,GAAmB7wE,SAAsB,IAAI,EAC7C8wE,GAAqB9wE,SAAe,CAAC,EACrC2sC,GAAwB3sC,SAAgB,EAAK,EAC7C+wE,GAAkB/wE,SAAsB,IAAI,EAC5C,CAACgxE,EAAmB,EAAIx0E,WAAS,CAAC,EAClCy0E,GAAuB9uE,cAAY,IAAM,CAC7C,GAAI,CACF,OAAO,cACL,IAAI,YAAY,6BAA8B,CAC5C,OAAQ,CAAE,OAAQ,cAAe,GAAI,KAAK,KAAI,CAAE,CACjD,EAEL,OAASuX,EAAK,CACZ,QAAQ,KAAK,uDAAwDA,CAAG,CAC1E,CACF,EAAG,EAAE,EAELnC,YAAU,IAAM,CAEd,MAAM25D,EAAS,IAAM,CACdhmC,IAAYklC,GAAiB,EAAI,CACxC,EACA,cAAO,iBAAiB,qBAA6Bc,CAAM,EACpD,IACL,OAAO,oBAAoB,qBAA6BA,CAAM,CAClE,EAAG,CAACvL,GAAkBz6B,EAAU,CAAC,EAGjC3zB,YAAU,IACD,IAAM,CACX,GAAI,CACEw5D,GAAgB,SAAS,aAAaA,GAAgB,OAAO,CACnE,MAAY,CAAC,CACf,EACC,EAAE,EAGLx5D,YAAU,IAAM,CACd,MAAM25D,EAAS,IAAMZ,GAAoB,EAAI,EAC7C,cAAO,iBAAiB,mBAA2BY,CAAM,EAClD,IAAM,OAAO,oBAAoB,mBAA2BA,CAAM,CAC3E,EAAG,EAAE,EAEL35D,YAAU,IAAM,CACd,MAAM45D,EAAiB,IAAM,CAC3BjH,GAAqBpzD,GAAMA,EAAI,CAAC,EAChC+xD,GAAgB,CAAC,EACjBC,GAAgB,QAAU,EAC1BE,GAAgB,CAAC,EACjBE,GAAkB,EAAE,EACpB4D,GAAgB,EAAE,EAClBrD,GAAuB,CAAC,EACxBE,GAAwB,CAAC,EACzB6E,GAAiB,EAAK,CACxB,EACA,cAAO,iBACL,oBACA2C,CAAA,EAEK,IACL,OAAO,oBACL,oBACAA,CAAA,CAEN,EAAG,EAAE,EAEL55D,YAAU,IAAM,CACd6yD,GAA2B34D,GAAS,CAClC,GAAIw3D,GAAe,OAASx3D,EAAK,OAAQ,CACvC,MAAM2O,EAAO6oD,GAAe,OAASx3D,EAAK,OAC1C,MAAO,CAAC,GAAGA,EAAM,GAAG,MAAM2O,CAAI,EAAE,KAAK6pD,EAAgB,CAAC,CACxD,CACA,OAAIhB,GAAe,OAASx3D,EAAK,OACxBA,EAAK,MAAM,EAAGw3D,GAAe,MAAM,EAErCx3D,CACT,CAAC,CACH,EAAG,CAACw3D,GAAgBgB,EAAgB,CAAC,EAErC1yD,YAAU,IAAM,CAKd,GAJIuzD,GAAqB,UACvB,aAAaA,GAAqB,OAAO,EACzCA,GAAqB,QAAU,MAE7B5/B,GAAY,CACd2/B,GAAkB,QAAU,GAC5BD,GAAoB,QAAU,EAC9BP,GAAiB,QAAU,KAC3B,MACF,CACA,OAAI1D,IACFiE,GAAoB,QAAU,YAAY,MAC1CP,GAAiB,QAAU,KAC3BQ,GAAkB,QAAU,GAC5BO,GAAc,QAAU,EACxBN,GAAqB,QAAU,OAAO,WAAW,IAAM,CACrDD,GAAkB,QAAU,GAC5BC,GAAqB,QAAU,IACjC,EAAGrI,EAAsB,IAEzBmI,GAAoB,QAAU,EAC9BP,GAAiB,QAAU,KAC3BQ,GAAkB,QAAU,GAC5BO,GAAc,QAAU,GAEnB,IAAM,CACPN,GAAqB,UACvB,aAAaA,GAAqB,OAAO,EACzCA,GAAqB,QAAU,MAEjCD,GAAkB,QAAU,GAC5BO,GAAc,QAAU,EACxBC,GAAQ,QAAU,IACpB,CACF,EAAG,CAAC1E,GAAoBz7B,EAAU,CAAC,EAGnC3zB,YAAU,IAAM,CACd,IAAIkF,EAAU,GACd,eAAe4pC,GAAU,CACvB,GAAI,CACF,GAAI,CAAC,WAAW,cAAc,iBAAkB,OAChD,MAAMzJ,EAAO,MAAM,UAAU,aAAa,mBAC1C,GAAI,CAACngC,EAAS,OACdopD,GAAoBjpB,EAAK,OAAQzhD,GAAMA,EAAE,OAAS,YAAY,CAAC,CACjE,OAASue,EAAK,CACZ,QAAQ,KAAK,oCAAqCA,CAAG,CACvD,CACF,CACA2sC,EAAA,EACA,GAAI,CACF,UAAU,aAAa,iBAAiB,eAAgBA,CAAO,CACjE,MAAQ,CACN,GAAI,CACD,UAAU,aAAqB,eAAiBA,CACnD,MAAY,CAAC,CACf,CACA,MAAO,IAAM,CACX5pC,EAAU,GACV,GAAI,CACF,UAAU,aAAa,oBAAoB,eAAgB4pC,CAAO,CACpE,MAAY,CAAC,CACf,CACF,EAAG,EAAE,EAGL9uC,YAAU,IAAM,CACd,MAAM25D,EAAS,IAAM,CACnB7sB,GAAa,QAAQ,EACrB8rB,GAAmB,EAAI,CACzB,EACMlvB,EAAU,IAAM,CACpBoD,GAAa,QAAQ,EACrB8rB,GAAmB,EAAK,CAC1B,EACA,cAAO,iBAAiB,kBAA0Be,CAAM,EACxD,OAAO,iBAAiB,mBAA2BjwB,CAAO,EACnD,IAAM,CACX,OAAO,oBAAoB,kBAA0BiwB,CAAM,EAC3D,OAAO,oBAAoB,mBAA2BjwB,CAAO,CAC/D,CACF,EAAG,EAAE,EAEL1pC,YAAU,IAAM,CACV2zB,KACFmZ,GAAa,QAAQ,EACrB+rB,GAAiB,EAAK,EAE1B,EAAG,CAACllC,EAAU,CAAC,EAGf3zB,YAAU,IAAM,CACd,GAAI,CACF,MAAM1c,EAAI6sE,GAAW,QAAQA,GAAW,gBAAgB,EAClDzmC,EAAMpmC,GAAG,OAAOA,EAAE,KAAK,OAAS,CAAC,EACvC,GAAI,CAACA,EAAG,QACJ,CAAComC,GAAOA,EAAI,cAAgB,IAC9B6tC,GAAen0E,IAAO,CAAE,GAAGA,EAAG,CAACE,EAAE,EAAE,EAAG,IAAQ,CAElD,MAAY,CAAC,CACf,EAAG,CACD6sE,GAAW,iBACXA,GAAW,UAAUA,GAAW,gBAAgB,GAAG,MAAM,OAC1D,EAGDnwD,YAAU,IAAM,CAUd,MAAM65D,EACJ,CAAC,CAAC3hB,IAAoByf,IAAc,CAACzS,IAAUmM,GAAe,EAMhE,GAJIvjC,GAAS,UACX,cAAcA,GAAS,OAAc,EACrCA,GAAS,QAAU,MAEjB,CAAC+rC,EAAW,CACdX,GAAgB,IAAI,EACpB,MACF,CAEA,OAAAA,GAAgB/gB,EAAgB,EAChCrqB,GAAS,QAAU,OAAO,YAAY,IAAM,CAC1CorC,GAAiBh/D,GAAS,CACxB,MAAMH,GAAQG,GAAQi+C,IAAoB,EAC1C,GAAIp+C,GAAQ,EAAG,CAIb,GAAI,CACF,MAAM+/D,EAAUvI,GAAgB,SAAW,EACrC9I,EAAY,KAAK,IAAI,EAAG,EAAIqR,CAAO,EACzC,QAAS5zE,GAAI,EAAGA,GAAIuiE,EAAWviE,KAC7B6zE,GAAQ,EAAG,SAAU,MAAM,CAE/B,MAAY,CAAC,CAEb,OAAIjsC,GAAS,UACX,cAAcA,GAAS,OAAc,EACrCA,GAAS,QAAU,MAEd,CACT,CACA,OAAO/zB,CACT,CAAC,CACH,EAAG,GAAI,EACA,IAAM,CACP+zB,GAAS,UACX,cAAcA,GAAS,OAAc,EACrCA,GAAS,QAAU,KAEvB,CAEF,EAAG,CACDoqB,GACAC,GACAkZ,GACAlB,GAAW,iBACVA,IAAoB,WACrBjL,EAAA,CACD,EAGDllD,YAAU,IAAM,CACd,GAAiB,CAAC24D,GAAiB,OACnC,MAAMjuE,EAAK,YAAY,IAAM,CAC3B,GAAI,CACF,MAAM6U,EAAI4xB,EAAS,QACb3tC,EAAIw1E,GAAiB,QAC3B,GAAI,CAACz5D,GAAK,CAAC/b,EAAG,OAId,MAAMw2E,EACJz6D,EAAE,YACuD,EACrD06D,EACJ16D,EAAE,aACuD,EAC3D,GAAI,CAACy6D,GAAM,CAACC,EAAI,OAChB,MAAMC,GAAK12E,EAAE,aAAe,IACtB22E,GAAK32E,EAAE,cAAgB,IACvB42E,GAAM,KAAK,IACf,EACA,KAAK,OAAQ,OAAO,kBAA+B,GAAK,GAAG,EAAI,KAG3DttD,GAAK,KAAK,MAAMotD,GAAKE,EAAG,EACxBrtD,GAAK,KAAK,MAAMotD,GAAKC,EAAG,EAC1B52E,EAAE,QAAUspB,KAAItpB,EAAE,MAAQspB,IAC1BtpB,EAAE,SAAWupB,KAAIvpB,EAAE,OAASupB,IAChC,MAAMoO,GAAM33B,EAAE,WAAW,IAAI,EAC7B,GAAI,CAAC23B,GAAK,OACVA,GAAI,sBAAwB,GAC5B,GAAI,CACFA,GAAI,aAAai/C,GAAK,EAAG,EAAGA,GAAK,EAAG,CAAC,CACvC,MAAQ,CAAC,CAET,MAAMppD,GAAQ,KAAK,IAAIkpD,GAAKF,EAAIG,GAAKF,CAAE,EACjCI,GAAK,KAAK,MAAML,EAAKhpD,EAAK,EAC1BspD,GAAK,KAAK,MAAML,EAAKjpD,EAAK,EAC1BxI,GAAK,KAAK,OAAO0xD,GAAKG,IAAM,CAAC,EAC7B5xD,GAAK,KAAK,OAAO0xD,GAAKG,IAAM,CAAC,EACnCn/C,GAAI,UAAY,OAChBA,GAAI,SAAS,EAAG,EAAG++C,GAAIC,EAAE,EACzBh/C,GAAI,UAAU5b,EAAGiJ,GAAIC,GAAI4xD,GAAIC,EAAE,CACjC,OAASz2E,EAAG,CAEV,QAAQ,KAAK,+BAAgCA,CAAC,CAChD,CACF,EAAG,GAAG,EACN,MAAO,IAAM,cAAc6G,CAAE,CAC/B,EAAG,CAACiuE,EAAe,CAAC,EAEpB34D,YAAU,IAKD,IAAM,CAEb,EACC,EAAE,EAEL,MAAMu6D,GAAqBtL,IAAiB,CAACE,GAE7C,eAAe10B,IAAc,CAC3B,MAAM+/B,EACHnnC,GAAc,qBACblC,EAAS,SAAS,WAAoC,MACpDspC,GAAmB,IAAM,CAC7B,GAAI,CACF,MAAMC,EAAiBF,EACvB,GAAI,CAACE,EAAW,MAAO,GACvB,MAAM9oD,EAAK8oD,EAAU,eACrB,OAAI,OAAO9oD,GAAO,WAAmB,GAC9B,CAAC,CAACA,EAAG,KAAK8oD,CAAS,GAAG,MAC/B,MAAQ,CACN,MAAO,EACT,CACF,KACA,GAAIrL,IAAmB/6C,GAAammD,EAAkB,OAGtD,GAAIxL,IAAiBE,KACCqL,GAAgB,oBAAsB,IAC1B,KAAMp2E,IAAMA,GAAE,aAAe,MAAM,EAClD,CAEfkrE,GAAkB,EAAK,EACvB,GAAI,CACFj8B,GAAc,cAAc,EAAK,CACnC,MAAQ,CAAC,CACT,MACF,CAOFi8B,GAAkB,EAAI,EACtB,GAAI,CACFj8B,GAAc,cAAc,EAAI,CAClC,MAAQ,CAAC,CAET,GAAI,CACF07B,GAAqB,IAAI,CAC3B,MAAQ,CAAC,CAIT,MAAM4L,EAAiB,MAAOC,GAAwC,CAWpE,GAVI,CAACA,GAEDA,EAAM,OAAS,SAQf,EAHF1lB,IACC,OAAO,OAAW,KACjB,OAAO,cAAc,QAAQ,gBAAgB,IAAM,KACzC,OACd,MAAM2lB,GAAaD,EAAc,qBAAuB,GAClDE,GAAY53E,IAAcA,MAAK23E,GAI/BE,GAAe,CAGnB,GAAID,GAAS,cAAc,EAAI,CAAE,aAAc,cAAiB,GAChE,GAAIA,GAAS,kBAAkB,EAC3B,CAAE,iBAAkB,cACpB,GACJ,GAAIA,GAAS,WAAW,EAAI,CAAE,UAAW,cAAiB,GAC1D,GAAIA,GAAS,WAAW,EAAI,CAAE,UAAWD,GAAK,WAAW,KAAQ,GACjE,GAAIC,GAAS,UAAU,EAAI,CAAE,SAAUD,GAAK,UAAU,KAAQ,GAE9D,GAAIC,GAAS,uBAAuB,EAChC,CAAE,sBAAuB,IACzB,EAAC,EAIP,GAAK,OAAO,KAAKC,EAAO,EAAE,OAE1B,GAAI,CACF,MAAOH,EAAc,iBAAiBG,EAAO,EAC7CzzD,GAAK,iDAAkDyzD,EAAO,CAChE,OAASl3E,GAAG,CACV,QAAQ,KAAK,uDAAwDA,EAAC,CACxE,CACF,EACA,GAAI,CAIF,MAAMm3E,EAAwC,CAC5C,MAAO,CAAE,MAAO,MAChB,OAAQ,CAAE,MAAO,MACjB,UAAW,CAAE,MAAO,GAAG,EAEnBC,EAA2C,CAC/C,MAAO,CAAE,MAAO,MAChB,OAAQ,CAAE,MAAO,MACjB,UAAW,CAAE,MAAO,GAAG,EAEnBC,GAA2C,CAC/C,MAAO,CAAE,MAAO,MAChB,OAAQ,CAAE,MAAO,MACjB,UAAW,CAAE,MAAO,GAAG,EAEnBC,GAA0C,CAC9C,MAAO,CAAE,MAAO,MAChB,OAAQ,CAAE,MAAO,KACjB,UAAW,CAAE,MAAO,GAAG,EAEnBC,GAAmCzrC,EACrC,CAAE,SAAU,CAAE,MAAOA,EAAkB,EACvC,CAAE,WAAY,eAEZ0rC,GAAe,MACnBC,GACAr1D,KACyB,CACzB,MAAMkzB,GAAsC,CAC1C,MAAO,CAAE,GAAGiiC,GAAW,GAAGE,EAAA,EAC1B,MAAO,IAET,OAAAh0D,GAAK,+BAA+BrB,EAAK,KAAMkzB,EAAW,EACnD,UAAU,aAAa,aAAaA,EAAW,CACxD,EAEA,IAAIvkB,GACJ,GAAI,CAIF,MAAM2mD,GAAsCjkB,EACxC,CACE,MAAO,CAAE,MAAO,MAChB,OAAQ,CAAE,MAAO,KACjB,UAAW,CAAE,MAAO,GAAG,EAEzB,CACE,MAAO,CAAE,MAAO,MAChB,OAAQ,CAAE,MAAO,MACjB,UAAW,CAAE,MAAO,GAAG,EAG7B,GAAI,CACF1iC,GAAS,MAAMymD,GAAaE,GAAc,qBAAqB,CACjE,OAASC,GAAiB,CACxBl0D,GACE,8DACAk0D,EAAA,EAEF5mD,GAAS,MAAMymD,GAAaH,GAAmB,gBAAgB,CACjE,CACA5zD,GAAK,uBAAwB,CAAC,CAACsN,EAAM,CACvC,OAASzS,GAAU,CACjB,QAAQ,KAAK,iCAAkCA,EAAG,EAElD,MAAMoP,GAAQpP,KAAQA,GAAI,MAAQA,GAAI,OAAU,GAChD,GACEwtB,IACCpe,KAAS,wBAA0BA,KAAS,iBAE7CjK,GAAK,2CAA2C,EAChDsN,GAAS,MAAM,UAAU,aAAa,aAAa,CACjD,MAAO,CAAE,GAAGqmD,CAAA,EACZ,MAAO,GACR,UAED,CAACtrC,IACApe,KAAS,wBACRA,KAAS,iBACTA,KAAS,qBAEXjK,GAAK,uDAAuD,EAE5DsN,GAAS,MAAM,UAAU,aAAa,aAAa,CACjD,MAAO,CAAE,GAAGqmD,CAAA,EACZ,MAAO,GACR,MAED,OAAM94D,EAEV,CACA,GAAIgvB,EAAS,QAAS,CACpB7pB,GAAK,0CAA0C,EAC/C6pB,EAAS,QAAQ,UAAYvc,GAK7B,GAAI,CACF,MAAMgmD,GAAShmD,IAAgB,qBAAqB,CAAC,EAChD+lD,EAAeC,EAAK,CAC3B,MAAQ,CAAC,CAMT,GAAI,CACFvnC,GAAc,iBAAiBze,EAAM,EACrCye,GAAc,UAAU,OAAO,EAG/BA,GAAc,eAAe,EAAI,EACjCA,GAAc,cAAc,EAAK,CACnC,OAASlxB,GAAK,CACZ,QAAQ,KACN,4DACAA,EAAA,CAEJ,CAGA,GAAI,CACFgvB,EAAS,QAAQ,iBAAiB,aAAc,IAC9C7pB,GAAK,2BAA2B,GAElC6pB,EAAS,QAAQ,iBAAiB,iBAAkB,IAAM,CACxD7pB,GAAK,sDAAsD,EAEvD6pB,EAAS,SAAS,YAAcA,EAAS,SAAS,aACpDs9B,GAAc,EAAI,CAEtB,CAAC,EACDt9B,EAAS,QAAQ,iBAAiB,UAAW,IAAM,CACjD7pB,GAAK,wBAAwB,EAEzB6pB,EAAS,SAAS,YAAcA,EAAS,SAAS,aACpDs9B,GAAc,EAAI,CAEtB,CAAC,EACDt9B,EAAS,QAAQ,iBAAiB,OAAQ,IACxC7pB,GAAK,gCAAgC,GAEvC6pB,EAAS,QAAQ,iBAAiB,QAAUttC,IAC1C,QAAQ,MAAM,wBAAyBA,EAAC,EAE5C,MAAQ,CAAC,CAKT,IAAI43E,GAAkB,KACtB,GAAI,CAMF,GALAA,GAAa,MAAM9V,GAAiB,CAClC,MAAOx0B,EAAS,QAChB,OAAAvc,GACA,YAAc/wB,IAAM,QAAQ,MAAM,8BAA+BA,EAAC,EACnE,EACG43E,GAAW,OAAQ,CACrBn0D,GAAK,6BAA6B,EAElC,GAAI,CACFioD,GAAc,QAAU,CAC1B,MAAQ,CAAC,CAET,GAAI,CACF,MAAM12D,GAAUw6B,GAAc,wBAC1B,CAACx6B,IAAWA,KAAYs4B,EAAS,UACnCkC,GAAc,qBAAqBlC,EAAS,OAAO,CAEvD,MAAY,CAEZ,CAKA,GAAI,EACkB,SAAY,CAE9B,QAASjrC,GAAI,EAAGA,GAAI,EAAoBA,KACtC,GAAI,CAEF,GACEirC,EAAS,SAAS,YAClBA,EAAS,SAAS,YAElB,OAAAs9B,GAAc,EAAI,EACX,GAETnnD,GACE,mEAAmEphB,GAAI,CAAC,IAG1E,GAAI,CACEirC,EAAS,UAASA,EAAS,QAAQ,UAAY,KACrD,MAAQ,CAAC,CACT,MAAM,IAAI,QAAShtC,IAAM,WAAWA,GAAG,IAAM+B,GAAI,EAAE,CAAC,EACpD,GAAI,CACEirC,EAAS,UAASA,EAAS,QAAQ,UAAYvc,GACrD,MAAQ,CAAC,CAET,GAAI,EACQ,MAAM+wC,GAAiB,CAC/B,MAAOx0B,EAAS,QAChB,OAAAvc,GACA,YAAc/wB,IACZ,QAAQ,MAAM,iCAAkCA,EAAC,EACpD,GACK,QAAQyjB,GAAK,kCAAkC,CACvD,OAASzjB,GAAG,CACVyjB,GAAK,4CAA6CzjB,EAAC,CACrD,CAEA,MAAM,IAAI,QAASM,IAAM,WAAWA,GAAG,IAAM+B,GAAI,EAAE,CAAC,CACtD,OAASrC,GAAG,CACVyjB,GAAK,+BAAgCzjB,EAAC,CACxC,CAEF,MAAO,EACT,GACK,EAAc,KAAM63E,IAAO,CACzBA,IAAIp0D,GAAK,0CAA0C,CAC1D,CAAC,CACH,MAAY,CAEZ,CACF,MACE,QAAQ,KACN,sDACAm0D,IAAY,OAGlB,OAASt5D,GAAK,CACZ,QAAQ,MAAM,oCAAqCA,EAAG,CACxD,CAGA,GAAI,CAEF,GAAI,CADW,CAAC,EAAEs5D,IAAcA,GAAW,QAC9B,CAEX,MAAME,GAAepM,GAAc,SAAW,EAC9C,GAAIoM,GAAe,GAAsBnM,EAAa,QAAS,CAC7DD,GAAc,QAAUoM,GAAe,EACvC,MAAMC,GAAU,IAAM,KAAK,IAAI,EAAGD,EAAY,EAC9Cr0D,GACE,2CACAioD,GAAc,QACd,KACAqM,GACA,MAEF,WAAW,SAAY,CACrB,GAAI,CACF,GAAI,CAACpM,EAAa,QAAS,OAE3B/1B,GAAA,EACA,MAAM,IAAI,QAASt1C,IAAM,WAAWA,GAAG,GAAG,CAAC,EAC3C,MAAMs2C,GAAA,CACR,OAAS52C,GAAG,CACVyjB,GAAK,iCAAkCzjB,EAAC,CAC1C,CACF,EAAG+3E,EAAO,CACZ,MACEt0D,GACE,iEAGN,CACF,MAAY,CAEZ,CAYA,GAVAA,GACE,0BACAsN,GAAO,YAAY,OACnB,gBACAA,GAAO,iBAAiB,QAMtBq6C,GACF,GAAI,CACF57B,GAAc,iBAAiBze,EAAM,EACjC6mD,IAAY,QACdpoC,GAAc,qBAAqBlC,EAAS,OAAO,CAEvD,MAAY,CAAC,CAEjB,MACE,QAAQ,MAAM,kCAAkC,EAElDQ,GAAa,EAAI,EACjB,GAAI,CACFo9B,GAAqB,IAAI,CAC3B,MAAQ,CAAC,CAET,GAAI,CACF,MAAM1pB,GAAO,MAAM,UAAU,aAAa,mBAC1CipB,GAAoBjpB,GAAK,OAAQzhD,IAAMA,GAAE,OAAS,YAAY,CAAC,EAC/D0jB,GACE,0BACA+9B,GAAK,OAAQzhD,IAAMA,GAAE,OAAS,YAAY,EAAE,OAEhD,OAASi4E,GAAS,CAChB,QAAQ,KAAK,wCAAyCA,EAAO,CAC/D,CACF,OAASh4E,EAAG,CACV,QAAQ,MAAM,gCAAiCA,CAAC,EAChD,MAAM0tB,EAAQ1tB,GAAW,MAASA,GAAW,MAAQ,GAEnDkrE,GADEx9C,IAAS,mBAAqBA,IAAS,gBACpB,oBACZA,IAAS,iBAAmBA,IAAS,uBACzB,YACZA,IAAS,oBACG,gBAEA,SANmB,EAQ1C+9C,GAAkB,EAAK,EACvB,GAAI,CACFj8B,GAAc,cAAc,EAAK,CACnC,MAAQ,CAAC,CACX,SACEi8B,GAAkB,EAAK,EACvB,GAAI,CACFj8B,GAAc,cAAc,EAAK,CACnC,MAAQ,CAAC,CACX,CACF,CAEA,SAASoG,IAAa,CACpB,GAAI,CACF,MAAMkP,EAAgBtV,GAAc,oBAAsB,KACtDsV,GACFA,EAAc,YAAY,QAASvkD,GAAMA,EAAE,MAAM,CAErD,MAAY,CAEZ,CACA,GAAI+sC,EAAS,QACX,GAAI,CACFA,EAAS,QAAQ,UAAY,IAC/B,MAAY,CAAC,CAEf,GAAI,CACFkC,GAAc,iBAAiB,IAAI,EACnCA,GAAc,eAAe,EAAK,EAClCA,GAAc,qBAAqB,IAAI,CACzC,MAAY,CAAC,CACb1B,GAAa,EAAK,EAClB29B,GAAkB,EAAK,CACzB,CAEAtvD,YAAU,IAAM,CACd,MAAM4oC,EAAUzX,EAAS,QACzB,GAAI,CAACyX,EAAS,OACd,MAAMD,EAAgBtV,GAAc,oBAAsB,KAIpDyoC,GADFzoC,GAAc,wBAA0B,OAE3B,WAAoC,KAC/C0oC,EAAepzB,GAAiBmzB,EACtC,GAAKC,EACL,CAAInzB,EAAQ,YAAcmzB,IACxBnzB,EAAQ,UAAYmzB,GAEtBnzB,EAAQ,MAAQ,GACfA,EAAgB,YAAc,GAE/B,GAAI,CACF,QAAQ,QAAQA,EAAQ,MAAM,EAAE,MAAM,IAAM,CAAC,CAAC,CAChD,MAAY,CAAC,CACRt0B,GAAWqd,GAAa,EAAI,EACnC,EAAG,CAAC0B,GAAc,KAAMA,GAAc,YAAa/e,EAAW+e,EAAa,CAAC,EAG5ErzB,YAAU,IAAM,CACd,GAAK0uD,GACL,GAAI,CACFG,GACEiB,GAAwB,CAAE,MAAOhB,EAAA,CAAmB,EAExD,MAAQ,CAAC,CACX,EAAG,CAACJ,GAAsBI,GAAmBgB,EAAuB,CAAC,EAIrE9vD,YAAU,IAAM,CACd,IAAIg8D,EAAuB,KACvB92D,EAAU,GACV+2D,EAAY,GACZC,EAAmB,EACnBC,EAA8B,KAC9BC,GAAW,EACf,MAAMC,GAAa,GACR9N,EAAiB,QAClBp9B,EAAS,QAenB,SAASmrC,IAAW,CACdN,GAAS,OACX,qBAAqBA,CAAK,EAC1BA,EAAQ,KAEZ,CACA,SAASO,IAAW,CAClB,GAAI,CACF,MAAMz0D,GACH,aAAe,YAAY,KAAO,YAAY,OAAU,KAAK,MAC1D00D,GAAQ,IAAOH,GACrB,GAAIv0D,GAAMs0D,GAAWI,GAAO,CAC1BR,EAAQ,sBAAsBO,EAAQ,EACtC,MACF,CACAH,GAAWt0D,EACb,MAAQ,CAAC,CACT,GAAI,CACF,MAAM20D,GAAKtrC,EAAS,QACdurC,GAAKnO,EAAiB,QAC5B,GAAI,CAACrpD,GAAW,CAACu3D,IAAM,CAACC,UAAWJ,GAAA,EACnC,MAAMtC,GAAKyC,GAAG,YAAc,EACtBxC,GAAKwC,GAAG,aAAe,EAC7B,GAAIzC,IAAM,GAAKC,IAAM,EAAG,CACtB+B,EAAQ,sBAAsBO,EAAQ,EACtC,MACF,CAEA,GAAI,CACF,GAAI,CAACN,EAAW,CACd,GAAI,CACFz0D,GAAM,+CAA+C,CACvD,MAAQ,CAAC,CACTy0D,EAAY,EACd,CACIS,GAAG,MAAM,aAAe,YAC1BA,GAAG,MAAM,WAAa,UAC1B,MAAQ,CAAC,CACT,MAAM3/B,GAAO2/B,GAAG,wBACVxC,GAAK,KAAK,IAAI,EAAG,KAAK,MAAMn9B,GAAK,KAAK,CAAC,EACvCo9B,GAAK,KAAK,IAAI,EAAG,KAAK,MAAMp9B,GAAK,MAAM,CAAC,GAC1C2/B,GAAG,QAAUxC,IAAMwC,GAAG,SAAWvC,MACnCuC,GAAG,MAAQxC,GACXwC,GAAG,OAASvC,IAEd,MAAMh/C,GAAMuhD,GAAG,WAAW,IAAI,EAC9B,GAAI,CAACvhD,GAAK,OAAOmhD,GAAA,EACjB,GAAI,CACFnhD,GAAI,UAAU,EAAG,EAAGuhD,GAAG,MAAOA,GAAG,MAAM,EACvCvhD,GAAI,UAAUshD,GAAI,EAAG,EAAGC,GAAG,MAAOA,GAAG,MAAM,CAC7C,MAAY,CAEZ,CACAV,EAAQ,sBAAsBO,EAAQ,CACxC,MAAY,CACVD,GAAA,CACF,CACF,CAEA,MAAMK,GAAgB,IAAM,CAC1B,MAAMF,GAAKtrC,EAAS,QACdurC,GAAKnO,EAAiB,QAC5B,GAAI,CAACkO,IAAM,CAACC,GAAI,OAChB,MAAME,GAAU,CAAC,EAAEH,GAAG,YAAcA,GAAG,aACjCI,GAAcJ,GAAG,aAAe,GAAKA,GAAG,WAAa,EAE3D,GAAI,CACF,GAAI,OAAO,OAAW,IAAa,CACjC,MAAMl5E,GAAI,OAAO,aAAa,QAAQ,yBAAyB,EAC/D,GAAIA,KAAM,KAAOA,KAAM,OAAQ,CAC7B,GAAI,CACF,QAAQ,KACN,sDAEJ,MAAQ,CAAC,CACT+4E,GAAA,EACAN,EAAQ,sBAAsBO,EAAQ,EACtC,MACF,CACF,CACF,MAAQ,CAAC,CACT,GAAIK,IAAWC,GACbP,GAAA,EACAN,EAAQ,sBAAsBO,EAAQ,MAGtC,IAAI,CACEhO,EAAiB,UACnBA,EAAiB,QAAQ,MAAM,WAAa,SAChD,MAAQ,CAAC,CAEb,GAGqB,IAAM,CACzB,GAAI,CACF,GAAI,OAAO,SAAa,IAAa,OACrC,MAAMuO,GAAU,SAAS,cAAc,QAAQ,EACzCC,GAAK,GACLC,GAAK,GACXF,GAAQ,MAAQC,GAChBD,GAAQ,OAASE,GACjB,MAAMC,GAAOH,GAAQ,WAAW,KAAM,CAAE,mBAAoB,GAAM,EAClE,GAAI,CAACG,GAAM,OACXd,EAAe,OAAO,YAAY,IAAM,CACtC,GAAI,CACF,MAAMM,GAAKtrC,EAAS,QACpB,GAAI,CAACsrC,IAAMA,GAAG,aAAe,GAAKA,GAAG,cAAgB,EAAG,CACtDP,EAAmB,EACnB,MACF,CACAe,GAAK,UAAU,EAAG,EAAGF,GAAIC,EAAE,EAC3BC,GAAK,UAAUR,GAAI,EAAG,EAAGM,GAAIC,EAAE,EAC/B,MAAMt2E,GAAOu2E,GAAK,aAAa,EAAG,EAAGF,GAAIC,EAAE,EAAE,KAC7C,IAAIl0D,GAAM,EACV,QAAS5iB,GAAI,EAAGA,GAAIQ,GAAK,OAAQR,IAAK,EACpC4iB,IACE,KAAQpiB,GAAKR,EAAC,EAAI,KAAQQ,GAAKR,GAAI,CAAC,EAAI,KAAQQ,GAAKR,GAAI,CAAC,EAK9D,GAHY4iB,IAAOi0D,GAAKC,GAAK,KACnB,IAAMd,GAAoB,EAC/BA,EAAmB,EACpBA,GAAoB,EAAG,CACzB,GAAI,CACF10D,GACE,oEAEJ,MAAQ,CAAC,CACT00D,EAAmB,EACnBI,GAAA,EACAN,EAAQ,sBAAsBO,EAAQ,CACxC,CACF,MAAY,CAEZ,CACF,EAAG,GAAG,CACR,MAAY,CAAC,CACf,GA8EA,EAEAI,GAAA,EACA,MAAMO,GAAO,YAAY,IAAMP,GAAA,EAAiB,GAAG,EACnD,MAAO,IAAM,CACXz3D,EAAU,GACVo3D,GAAA,EACA,cAAcY,EAAI,EAClB,GAAI,CACEf,iBAA4BA,CAAY,CAC9C,MAAQ,CAAC,CACX,CACF,EAAG,CAAChrC,EAAUo9B,CAAgB,CAAC,EAG/B,eAAe4O,IAA0B,CACvC,GAAI,CACF,GAAI,CAAC,WAAW,cAAc,iBAAkB,CAC9CpO,GAAqB,eAAe,EACpC,MACF,CACA,MAAM1pB,EAAO,MAAM,UAAU,aAAa,mBAC1CipB,GAAoBjpB,EAAK,OAAQzhD,GAAMA,EAAE,OAAS,YAAY,CAAC,CACjE,OAASue,EAAK,CACZ,QAAQ,KAAK,oCAAqCA,CAAG,CACvD,CACF,CAEA,SAASi7D,IAAiB,CACxB,KAAM,CAACC,EAAgBC,CAAiB,EAAIr4E,WAAS,EAAE,EACjDs4E,EAAiB,MAAO7yE,GAAuB,CACnD,GAAI2kE,GAAgB,OACpB,MAAMppD,EAAQooD,GAAiB,KAAMzqE,IAAMA,GAAE,WAAa8G,CAAE,GAAG,MAC/DmlC,GAAmBnlC,GAAM,OAAWub,GAAS,GAAI,EAAI,EACrDwzB,GAAA,EACA,MAAM,IAAI,QAASt1C,IAAM,WAAWA,GAAG,GAAG,CAAC,EAC3C,GAAI,CACF,MAAMs2C,GAAA,CACR,MAAY,CAAC,CACf,EAEA,OACEr0B,OAAC,OAAI,UAAU,+GACb,UAAAC,MAAC,QAAK,gBAAI,EACVD,OAAC,UACC,cAAgBviB,GAAM,CACnBA,EAAU,iBACb,EACA,YAAcA,GAAM,CAClBA,EAAE,iBACJ,EACA,aAAeA,GAAM,CAClBA,EAAU,mBACb,EACA,UAAU,kCACV,MAAO8rC,GAAqB,GAC5B,SAAU,MAAO9rC,GAAM,CACrB,GAAIwrE,GAAgB,OACpB,MAAM3kE,EAAK7G,EAAE,OAAO,OAAS,OACvBoiB,GAAQooD,GAAiB,KAC5BzqE,IAAMA,GAAE,WAAa8G,CAAA,GACrB,MAEHmlC,GAAmBnlC,EAAIub,IAAS,GAAI,EAAI,EAExCwzB,GAAA,EAEA,MAAM,IAAI,QAAShT,IAAY,WAAWA,GAAS,GAAG,CAAC,EACvD,GAAI,CACF,MAAMgU,GAAA,CACR,OAASt4B,GAAK,CACZ,QAAQ,KAAK,8CAA+CA,EAAG,EAE/D,WAAW,SAAY,CACrB,GAAI,CACF,MAAMs4B,GAAA,CACR,OAAS+iC,GAAU,CACjB,QAAQ,MAAM,oCAAqCA,EAAQ,EAC3D,MACE,iEAEJ,CACF,EAAG,GAAG,CACR,CACF,EAEA,gBAAC,UAAO,MAAM,GAAG,gBAAI,QACpB,UAAO,MAAM,SAAS,iCAAqB,EAC3CnP,GAAiB,IAAKzqE,GACrByiB,MAAC,UAAwB,MAAOziB,EAAE,SAC/B,SAAAA,EAAE,QACAA,EAAE,SAAW,WAAWA,EAAE,SAAS,MAAM,EAAG,CAAC,CAAC,IAAM,WAF5CA,EAAE,QAGf,CACD,KAEF+rC,IAAsB,UACrBvpB,OAAC,OAAI,UAAU,+BACb,UAAAC,MAAC,SACC,UAAU,qBACV,YAAY,YACZ,MAAOg3D,EACP,SAAWx5E,GAAMy5E,EAAkBz5E,EAAE,OAAO,KAAK,IAEnDwiB,MAAC,UACC,UAAU,wBACV,QAAS,IAAMk3D,EAAeF,GAAkB,MAAS,EAC1D,kBAED,EACF,EAEDhP,GAAiB,SAAW,GAC3BjoD,OAAC,OAAI,UAAU,0BACb,gBAAC,QAAK,UAAU,0BAA0B,4BAAgB,EAC1DC,MAAC,UACC,UAAU,6BACV,QAAS82D,GACT,MAAM,sBACP,oBAED,EACF,EAEDrO,KAAsB,qBACrBzoD,MAAC,OAAI,UAAU,6BAA6B,2GAG5C,EAEFA,MAAC,UACC,UAAU,6BACV,QAAS,SAAY,CACnB,GAAI,CACF,MAAM82D,GAAA,CACR,OAASh7D,EAAK,CACZ,QAAQ,KAAK,iBAAkBA,CAAG,CACpC,CACF,EACA,MAAM,2BACP,oBAGAusD,IACCtoD,OAAC,OAAI,UAAU,sEACb,UAAAA,OAAC,OAAI,UAAU,0CACb,gBAAC,OAAI,UAAU,gBAAgB,6BAAiB,QAC/C,OAAI,UAAU,sBACZ,SAAAwoD,IAAkB,GACf,IAAI,KAAKA,GAAiB,EAAE,EAAE,qBAC9B,GACN,GACF,EACAxoD,OAAC,OAAI,UAAU,wCACb,gBAAC,OAAI,UAAU,aAAa,qBAAS,EACrCA,OAAC,OAAI,UAAU,YACZ,UAAAwpB,GAAwB,SAAU,IAClCD,EAAoB,IAAIA,CAAiB,IAAM,IAClD,QAEC,OAAI,UAAU,aAAa,mBAAO,SAClC,OAAI,kBACG,OAAOi/B,IAAkB,SAAS,MAAQ,GAAG,EAAE,WACpD,OAAOA,IAAkB,SAAS,aAAe,GAAG,GACvD,QAEC,OAAI,UAAU,aAAa,oBAAQ,SACnC,OAAI,uBAEF,OAAOA,IAAkB,OAAO,cAAgB,EAAK,EAAE,OACvD,OAAOA,IAAkB,OAAO,YAAc,GAAG,EAAE,WACnD,OAAOA,IAAkB,OAAO,QAAU,GAAG,GAChD,QAEC,OAAI,UAAU,aAAa,sBAAU,SACrC,OACE,UAAAA,IAAkB,OAAO,YAAc,EAAE,IACzCA,IAAkB,OAAO,aAAe,GAC3C,QAEC,OAAI,UAAU,aAAa,kBAAM,SACjC,OAAI,eACAA,IAAkB,QAAQ,aAAe,EAAE,MAC7CA,IAAkB,QAAQ,aAAe,GAC5C,GACF,EAECA,IAAkB,QAAQ,kBAAkB,cAC1C,OAAI,UAAU,OACb,gBAAC,OAAI,UAAU,aAAa,6BAAiB,QAC5C,OAAI,UAAU,iBACZ,YAAiB,OAAO,iBAAiB,IAAI,CAACxqE,EAAGkmB,IAChDlE,OAAC,OAAc,UAAU,sBAAsB,cAC3CkE,EAAI,UAAQlmB,EAAE,WAAW,YAAU,OAAOA,EAAE,OAAO,EACpD,OAAOA,EAAE,OAAU,UAChB,UAAU,OAAOA,EAAE,KAAK,CAAC,GACzB,KAJIkmB,CAKV,CACD,EACH,GACF,EACE,KAEHskD,IAAkB,MACjBxoD,OAAC,OAAI,UAAU,8BAA8B,+BACxB,OAAOwoD,GAAiB,KAAK,GAClD,EACE,WAEH,OAAI,UAAU,2BAA2B,yNAK1C,GACF,GAEJ,CAEJ,CA8QA5uD,YAAU,IAAM,CAMhB,EAAG,CACDqV,GACA6d,GACAk8B,GACAz7B,GACAs7B,GACAj/B,GACAk+B,GACAuB,EACA2F,GACAI,EAAA,CACD,EAGDx1D,YAAU,IAAM,CAYd,GAXAgsD,GAAiB,6BAA8B,CAC7C,WAAAr4B,GACA,kBAAA+gB,EACA,WAAA8Z,GACA,KAAM,CAAC,CAACn5C,GACR,aAAc,CAAC,CAAC6d,GAChB,YAAa,CAAC,CAAC/B,EAAS,QACxB,WAAYA,EAAS,SAAS,WAC9B,YAAaA,EAAS,SAAS,YAChC,EAEG,CAACs+B,EAAmB,OACxB,GAAiB97B,GAAY,CAC3B,QAAQ,IACN,0DACE+gB,EACA,KAEJ,MACF,CAIA,GACEA,IAAsB,YACtBA,IAAsB,cACtB,CACAsX,GACE,4CACAtX,CAAA,EAEF,MACF,CAIA,MAAMrhB,EAAgBhf,GAAiB,WACjCopD,EAAiBpgD,GAAgB,WAAW,qBAC5CqgD,EAAUD,IAAmB,eAE7BE,EAAetqC,EAAc,wBAA0B,KACvDsV,EAAgBtV,EAAc,oBAAsB,KACpDuqC,GAAqB,CAAC,CAACvqC,EAAc,YAIrCwqC,GAAa1sC,EAAS,QAM5B,IAAI2sC,GALwB,CAAC,EAC3BH,GACAA,EAAa,WAAa,GAC1BA,EAAa,YAAc,GAEgBA,EAAeE,GAIxD,CAACC,IAAeH,IAAcG,GAAcH,GAIhD,GAAI,CAEAC,IACAj1B,GACAm1B,IACA,CAACA,GAAY,YAEbA,GAAY,UAAYn1B,EACpB,OAAOm1B,GAAY,MAAS,YAC9B,QAAQ,QAAQA,GAAY,MAAM,EAAE,MAAM,IAAM,CAAC,CAAC,EAGxD,MAAY,CAAC,CAYb,GAAI,CAACA,GAAa,CAChB9R,GAAiB,sCAAuC,CACtD,eAAAyR,EACA,QAAAC,EACA,gBAAAvO,GACA,iBAAkByO,GAClB,kBAAoBvqC,GAAuB,KAC3C,gBAAiB,CAAC,CAACsqC,EACnB,cAAe,CAAC,CAACxsC,EAAS,QAC3B,EACD,MACF,CACA,GAAI,CAAC2sC,GAAY,YAAc,CAACA,GAAY,YAAa,CAGvD,MAAMn2B,GAAQ,YAAY,MAC1B,IAAIo2B,GAAgB,GACpB,MAAMC,GAAQ,IAAM,CAClB,GAAID,GAAe,OACnB,MAAM/D,GAAK8D,IAAa,YAAc,EAChC7D,GAAK6D,IAAa,aAAe,EACvC,GAAI9D,IAAMC,GAAI,CAEZ,GAAI,CACFxL,GAAc,EAAI,CACpB,MAAY,CAAC,CACb,MACF,CACA,GAAI,YAAY,MAAQ9mB,GAAQ,IAAM,CACpCqkB,GACE,mEACA,CACE,GAAAgO,GACA,GAAAC,GACA,eAAAwD,EACA,aAAc,CAAC,CAAEK,IAAqB,UACtC,WAAaA,IAAqB,WACpC,EAEF,MACF,CACA,OAAO,WAAWE,GAAO,GAAG,CAC9B,EACA,cAAO,WAAWA,GAAO,EAAE,EACpB,IAAM,CACXD,GAAgB,EAClB,CACF,CAGA,GAAI,CAACvP,GACH,GAAI,CACFC,GAAc,EAAI,CACpB,MAAY,CAAC,CAEf,GAAI,CAACp5C,IAAK,CAAC6d,GAAW,CACpB,QAAQ,IACN,gEAEF,MACF,CAEA,QAAQ,IACN,uEACAwhB,CAAA,EAGF,IAAIupB,GAAW,GACf,MAAM1+D,GAAIu+D,GACJI,GAAS3+D,GAAE,YAAc,EACzB4+D,GAAS5+D,GAAE,aAAe,EAC1B6+D,GAAOhtC,GAAU,QACvB,GAAI,CAACgtC,GAAM,OAKX,MAAMC,GACHlF,GAAoB,WACnBA,GAAoB,SAAW,CAAE,EAAG,EAAG,EAAG,IAO9C,GALE,CAACA,GAAY,SACZ+E,GAAS,GACRC,GAAS,IACRE,GAAgB,IAAMH,IAAUG,GAAgB,IAAMF,IAElC,CAEvB,IAAIG,GAAUvpB,EACVwpB,GAASvpB,EACTwpB,GAAiBvpB,GACjBwpB,GAAY,GAEhB,MAAMv5C,GAAKg5C,GAASC,GAGhBD,GAAS,GAAKC,GAAS,GAAKj5C,GAAK,KAAO,MAC1Co5C,GAAU,KAAK,IAAIA,GAAS,EAAE,EAC9BC,GAAS,KAAK,IAAIA,GAAQ,EAAE,EAC5BC,GAAiB,KAAK,IAAIA,GAAgB,CAAC,GAMzCN,GAAS,GAAKC,GAAS,GAAKj5C,IAAM,KAAO,OAC3Cu5C,GAAY,GACZD,GAAiB,KAAK,IAAIA,GAAgB,CAAC,GAG7CrF,GAAY,QAAU,IAAI1xD,GAAa,CACrC,QAAA62D,GACA,OAAAC,GACA,eAAAC,GACA,UAAAC,EAAA,CACD,EACDJ,GAAgB,EAAIH,GACpBG,GAAgB,EAAIF,EACtB,CAGA,GAAI,CACF,MAAMz+B,GAAM,GAAG1M,GAAS,EAAI,CAAC,IAAIE,IAAW,GAAK,CAAC,IAAIA,IAAW,GAAK,CAAC,IACpE7d,KAAY,CAAC,IAAI,CAAC,GAAMA,IAAW,GAAK,GAC3C,GACA,GAAIqqB,KAAQwwB,GAAsB,QAAS,CACzCA,GAAsB,QAAUxwB,GAChC,MAAM/0B,GAAMwuD,GAAY,QACpBxuD,IAAO,OAAOA,GAAI,uBAA0B,aAE9CA,GAAI,sBACF,CACE,eAAgB,EAChB,UAAW,IAEb0gD,EAAA,EAEFW,GACE,oDACA,CACE,GAAIX,EAAA,CACN,EAGN,CACF,MAAQ,CAAC,CAET,MAAMrqB,GAAO,IAAM,CAEjB,GAAI,CACF,MAAMl5B,GAAM,YAAY,MAClBpC,GAAW,KAAQ8xC,GAAuB,IAChD,GAAI1vC,GAAMuxD,GAAiB,QAAU3zD,GAAU,CAC7C0zD,GAAO,QAAU,sBAAsBp4B,EAAI,EAC3C8yB,GAAQ,QAAU9yB,GAClB,MACF,CACAq4B,GAAiB,QAAUvxD,EAC7B,MAAY,CAAC,CACb,IAAI42D,GAAsB,GAS1B,GAAI,CAAAT,GACJ,IAAI,CACF,MAAMjE,GAAKz6D,GAAE,YAAc,EACrB06D,GAAK16D,GAAE,aAAe,EAC5B,GAAI,CAACy6D,IAAM,CAACC,GAAI,CACdb,GAAO,QAAU,sBAAsBp4B,EAAI,EAC3C,MACF,CACIo9B,GAAK,QAAUpE,KAAIoE,GAAK,MAAQpE,IAChCoE,GAAK,SAAWnE,KAAImE,GAAK,OAASnE,IACtC,MAAM9+C,GAAMijD,GAAK,WAAW,KAAM,CAAE,mBAAoB,GAAM,EAC9D,GAAI,CAACjjD,GAAK,CACRi+C,GAAO,QAAU,sBAAsBp4B,EAAI,EAC3C,MACF,CACA7lB,GAAI,UAAU5b,GAAG,EAAG,EAAGy6D,GAAIC,EAAE,EAC7B,MAAMxnE,GAAQ0oB,GAAI,aAAa,EAAG,EAAG6+C,GAAIC,EAAE,GAKzC/kB,IACC,OAAO,OAAW,KACjB,OAAO,cAAc,QAAQ,gBAAgB,IAAM,MAGrD+W,GAAuBx5D,GAAO,CAAE,KAAM,IAAK,SAAU,IAAM,EAG7DohE,GAAc,UAGd,MAAM9wC,GAAO3N,GAAgBC,GAAG,CAAE,EAAG,EAAG,EAAG,EAAG,EACxCspD,GAAOvpD,GAAgBC,GAAG,CAAE,EAAGL,GAAW,YAAa,EAAG,EAAG,EAI7D9D,GAAUujC,IAAkB,OAAS,OAAS,MAC9CmqB,GAAMtS,GAAiB,CAC3B,OAAQ0N,GACR,OAAQC,GACR,OAAQ/mC,GAAU,EAClB,OAAQA,GAAU,EAClB,QAAAhiB,EAAA,CACD,EAGKuE,GAAKukD,GAAK9mC,GAAU,EACpBxd,GAAKukD,GAAK/mC,GAAU,EACpBnrB,GAAKgb,GAAK,EAAItN,GACdzN,GAAK+a,GAAK,EAAIrN,GACdrK,GAAKszD,GAAK,EAAIlpD,GACdnK,GAAKqzD,GAAK,EAAIjpD,GACdmpD,GAAO,KAAK,MAAMxzD,GAAKtD,GAAIuD,GAAKtD,EAAE,EAAI,KAEtC82D,GAAW3F,GAAY,QACzBM,IAAuB,GACzBqF,GAAS,OACP/2D,GACAC,GACA,KAAK,IAAI,GAAI,KAAK,IAAI,KAAK,IAAIgyD,GAAIC,EAAE,EAAG4E,EAAI,CAAC,GAIjD,MAAME,IAAgBxN,GAAgB,SAAW,GAAK,EAEtD,CACE,MAAMyN,GAAa,CAAC9Z,GACd+Z,GAAcF,GACdG,GAAY5L,GAAkB,QAC9B6L,GAAYtL,GAAc,QAAUzI,GAC1C9jD,GAAK,mCAAoC,CACvC,WAAA03D,GACA,YAAAC,GACA,UAAAC,GACA,UAAAC,GACA,WAAYtL,GAAc,QAC1B,UAAWzI,GACX,gBAAiBmG,GAAgB,QAClC,CACH,CACA,GACE,CAACrM,IACD6Z,IACAzL,GAAkB,SAClBO,GAAc,QAAUzI,GACxB,CACIyI,GAAc,QAAU,MAAQ,GAClC,QAAQ,IAAI,sCAAuC,CACjD,OAAA3O,GACA,aAAA6Z,GACA,eAAgBzL,GAAkB,QAClC,OAAQO,GAAc,QACvB,EAEHvsD,GAAK,wCAAyC,CAC5C,OAAA49C,GACA,aAAAmM,GACA,eAAgBiC,GAAkB,QAClC,WAAYO,GAAc,QAC1B,qBAAAzI,EAAA,CACD,EACD,MAAMzgD,GAAMm0D,GAAS,OAAOrsE,EAAK,EACjC6U,GAAK,4BAA6BqD,EAAG,EACrC,MAAMy0D,GAAU,YAAY,MAC5B,GAAIjM,GAAe,SACjB,GAAKxoD,GAkBHyoD,GAAmB,QAAU,UAjBxBA,GAAmB,UACtBA,GAAmB,QAAUgM,IAE3BA,GAAUhM,GAAmB,SAAW,IAAM,CAChDD,GAAe,QAAU,GACzBC,GAAmB,QAAU,EAC7BH,GAAoB,QAAU,KAC9BC,GAAiB,QAAU,GAC3B,GAAI,CACF,OAAO,cACL,IAAI,YAAY,oBAAqB,CACnC,OAAQ,CAAE,OAAQ,cAAe,GAAI,KAAK,KAAI,CAAE,CACjD,EAEL,MAAQ,CAAC,CACX,EAKAvoD,IACFipD,GAA2B,SACxBA,GAA2B,SAAW,GAAK,EACzCD,GAAkB,UACrBA,GAAkB,QAAUyL,GAC5B5L,GAAyB,QAAU4L,GACnC3L,GAAsB,QAAU2L,KAGlCzL,GAAkB,QAAU,EAM9B,GAAI,CAEF,MAAM0L,GADUlO,GAAa,QAAQ,SACT,CAACxmD,GACvB20D,GAAUF,GAAUjO,GAAa,QAAQ,WAC/C,GAAIkO,IAAYC,GAAU,IAAMA,GAAU,IAAK,CAC7CnO,GAAa,QAAQ,QAAU,GAC/B2B,GAAiB,QAAU,KAC3BmE,GAAiB,EAAK,EAEtB,MAAMsI,GAASpO,GAAa,QAAQ,mBAC9BqO,GAAQrO,GAAa,QAAQ,eAGnC,GAAI,CACE9D,GACFA,EACE,EACA,OACA,CACE,OAAQ,KACR,KAAM,EACN,iBAAkB,GAClB,OAAQ,KACR,eACE,OAAOkS,IAAW,SAAWA,GAAS,OACxC,WAAYC,IAAS,OACrB,UAAW,GACb,CAEN,MAAY,CAAC,CAGb,GAAI,CACFpJ,GAAoB,CAClB,GAAIgJ,GACJ,MAAO,YACP,MAAO,EACP,KAAM,OACN,WAAY,EACZ,MAAO,GACP,SAAU,GACV,OAAQ,GACT,CACH,MAAQ,CAAC,CACX,CACF,MAAQ,CAAC,CAIT,GAAI,CACF,MAAMK,GACJ/L,GAAgB,QAAQ,cAAgBnI,GACpCmU,IAAgB9L,GAA2B,SAAW,GAAK,EAE7D,CADW,CAAC,CAACjpD,KACD80D,IAAaC,MAC3BlM,GAAyB,QAAU4L,GAI9BhP,KAAeqD,GAAsB,QAAU2L,IAExD,MAAY,CAAC,CAIRz0D,KACHipD,GAA2B,QAAU,EACrCF,GAAgB,QAAU,CACxB,QAAS,KACT,aAAc,IAKhBZ,GAAiB,SACjBsM,GAAUtM,GAAiB,QAAQ,QAAU,MAE7CA,GAAiB,QAAU,MAE7B,MAAM6C,GAAqB,KAAK,IAC9B,GACA,KAAK,IACH,IACA,OAAO7gB,CAA4B,GAAKwW,EAAA,CAC1C,EAKF,GACE3gD,IACAkqC,GACAlqC,GAAI,WAAa,GACjBA,GAAI,WAAagrD,GACjB,CAEA,GAAI,CAACT,GAAgB,CAGnB,MAAMyK,GAAa7jD,GAAiBsiD,GAAMzzD,GAAI,IAAK,CAAC,EAC9CuG,GAAUujC,IAAkB,OAAS,OAAS,MAQ9CmrB,GAPMtT,GAAiB,CAC3B,OAAQ0N,GACR,OAAQC,GACR,OAAQ/mC,GAAU,EAClB,OAAQA,GAAU,EAClB,QAAAhiB,GACD,EACgB,cAAc,CAC7B,EAAGyuD,GAAW,EACd,EAAGA,GAAW,EACf,EACKx8C,GAAQmjC,GACZjxC,GACAuqD,GACA3nD,IAAS,EACT8C,IAAgB,EAChBC,IAAqB,GAEvB,IAAIurC,GAAuB,KAC3B,GAAI,CAEFA,GAAStsC,GAAa5E,GAAUuqD,EAAI,CACtC,MAAY,CACVrZ,GAAS,IACX,CACA,MAAMI,GAAOxjC,GAAM,KACbt+B,GAAQs+B,GAAM,KACdvL,GAAUuL,GAAM,QAAU,KAC1B2jC,GAAO,KAAK,IAAI,EAAG,OAAO3jC,GAAM,IAAI,GAAK,CAAC,EAKhD,IAAIld,GAAQ,GACR0gD,KAAS,OACX1gD,GAAQ,OACC0gD,KAAS,OAClB1gD,GAAQ,KACC0gD,KAAS,aAClB1gD,GAAQ,UACC2R,IAAU,KAEnB3R,GAAQ,GADO6gD,KAAS,EAAI,IAAMA,KAAS,EAAI,IAAM,EACpC,GAAGlvC,EAAM,GAE1B3R,GAAQ,GAAG0gD,EAAI,IAAI9hE,GAAQ,EAAIA,GAAQ,EAAE,GAAG,OAG9C,MAAMg7E,GADiB,CAAC,CAACxqD,IAAK,CAAC,CAAC6d,IAEZu9B,GAEpB0E,GAAkB,CAChB,MAAAlvD,GACA,MAAAphB,GACA,KAAA8hE,GACA,WAAYh8C,GAAI,WAChB,KAAM,CACJ,iBAAkBk1D,GAClB,OAAAtZ,GACA,OAAQ,SAGR,aAAcoZ,EAAA,CAChB,CACD,EACDvJ,GAAoB,CAClB,GAAI,KAAK,MACT,MAAAnwD,GACA,MAAAphB,GACA,KAAA8hE,GACA,WAAYh8C,GAAI,WAChB,MAAO,GACP,SAAU,GACV,OAAQ,GACR,aAAc,mBACd,KAAAi1D,GACA,IAAKD,EAAA,CACN,CACH,CACA,MACF,CAEA,GAAIh1D,IAAOA,GAAI,YAAcgrD,GAAoB,CAC/CruD,GAAK,2BAA4BqD,GAAI,WAAYA,GAAI,GAAG,EAExDrD,GAAK,2BAA4BqD,GAAI,WAAYA,GAAI,GAAG,EACxD,MAAMm1D,GACJzM,GAAoB,QAAU,GAC9B+L,GAAU/L,GAAoB,QAAUpI,GACpC8U,GAAmB,GAEnBJ,GAAa7jD,GAAiBsiD,GAAMzzD,GAAI,IAAK,CAAC,EAIpD,IAAI1E,GAAQ,GACRphB,GAAQ,EACR8hE,GAAa,OACbqZ,GAAe,GAIfC,GAA8B,KAKlC,GAAI,CACF,MAAM/lE,GAAOw5D,GAAgB,QAAQ,QACrC,GAAI,CAACx5D,GACHw5D,GAAgB,QAAU,CACxB,QAAS,CAAE,GAAGiM,EAAA,EACd,aAAc,GAMhBnM,GAAyB,QAAU4L,GAC9BhP,KAAeqD,GAAsB,QAAU2L,QAC/C,CACL,MAAMc,GAAO,KAAK,MAChBP,GAAW,EAAIzlE,GAAK,EACpBylE,GAAW,EAAIzlE,GAAK,GAElBgmE,IAAQ1U,GACVkI,GAAgB,QAAU,CACxB,QAAS,CAAE,GAAGiM,EAAA,EACd,aAAcjM,GAAgB,QAAQ,aAAe,IAGvDA,GAAgB,QAAU,CACxB,QAAS,CAAE,GAAGiM,EAAA,EACd,aAAc,GAMZO,GAAO,KACT1M,GAAyB,QAAU4L,GAC9BhP,KAAeqD,GAAsB,QAAU2L,KAElDc,IAAQvU,KACVgI,GAAkB,QAAUyL,IAGlC,CACF,MAAY,CAAC,CAEb,MAAMe,GACJf,GAAU5L,GAAyB,SAAW/H,GAC1C2U,GACJ1M,GAAgB,QAAQ,cAAgBnI,GACpC8U,GACJ1M,GAAkB,QAAU,EACxByL,GAAUzL,GAAkB,QAC5B,OAAO,kBACP2M,GACJ9M,GAAyB,QAAU,EAC/B4L,GAAU5L,GAAyB,QACnC,OAAO,kBAGP+M,GAAuBnQ,GACzB,GACAgP,GAAU3L,GAAsB,SAChCtI,GACEqV,GAGA,KAAK,IAAIH,GAAgBC,EAAW,GAClC5U,IAA0B6U,GAO5BX,GAAOhB,GAAI,cAAc,CAC7B,EAAGe,GAAW,EACd,EAAGA,GAAW,EACf,EACKx8C,GAAQmjC,GACZjxC,GACAuqD,GACA3nD,IAAS,EACT8C,IAAgB,EAChBC,IAAqB,GAKvB,IAAIurC,GAAuB,KAC3B,GAAI,CAEFA,GAAStsC,GAAa5E,GAAUuqD,EAAI,CACtC,MAAY,CACVrZ,GAAS,IACX,CACAI,GAAOxjC,GAAM,KACbt+B,GAAQs+B,GAAM,KACd,MAAMvL,GAAUuL,GAAM,QAAU,KAC1B2jC,GAAO,KAAK,IAAI,EAAG,OAAO3jC,GAAM,IAAI,GAAK,CAAC,EAG5CwjC,KAAS,OACX1gD,GAAQ,OACC0gD,KAAS,OAClB1gD,GAAQ,KACC0gD,KAAS,aAClB1gD,GAAQ,UACC2R,IAAU,KAEnB3R,GAAQ,GADO6gD,KAAS,EAAI,IAAMA,KAAS,EAAI,IAAM,EACpC,GAAGlvC,EAAM,GAE1B3R,GAAQ,GAAG0gD,EAAI,IAAI9hE,GAAQ,EAAIA,GAAQ,EAAE,GAAG,OAE9C,MAAM47E,GAAgB,GAChBC,GAAgBD,GAAgB,EAAI,EACpCE,GAAiBF,GAAgB,EAAI,EASrCZ,GARiB,CAAC,CAACxqD,IAAK,CAAC,CAAC6d,GAS1B0tC,GACJjB,GAAW,GAAK,CAACe,IACjBf,GAAW,GAAK3F,GAAK0G,IACrBf,GAAW,GAAK,CAACe,IACjBf,GAAW,GAAK1F,GAAKyG,GACjBG,GAAc3tC,GAChB0sC,GAAK,GAAK,CAACe,IACXf,GAAK,GAAK1sC,GAAU,EAAIytC,IACxBf,GAAK,GAAK,CAACe,IACXf,GAAK,GAAK1sC,GAAU,EAAIytC,GACxB,GACEG,GACJna,KAAS,QAAUA,KAAS,aACxB/uC,KAAW,GACXA,IAAU,MAAQA,IAAU,GAAKA,IAAU,GACjD,IAAImpD,GAAW,GACXxa,KAKFwa,GAJe,KAAK,MAAMxa,GAAO,EAAGA,GAAO,CAAC,GAIvBvxC,GAAW,YADN,GAM5B,MAAMgsD,GAAU,CAACP,IAAkBla,IAAUwa,GACvCE,GAAW,CAACR,IAAiBK,GAC7BI,GAAcT,GAAgBX,GAAe,GAC7CqB,GAAwBV,GAAgBX,GAAe,GASvDsB,GAAUX,GAPd,CAACZ,IACD,CAACe,IACD,CAACC,IACD,CAACG,IACDra,KAAS,QACT,CAACsa,IACDC,GACyCva,KAAS,OAG9C0a,GAAoB,GAS1B,GAAIhU,IALE,CAAC+T,IACDjB,IACAC,IACAI,IACA,CAAC/N,IAEL,GAAI,CACF,MAAMhI,GAAiBJ,GAA4B,CACjD,0BAA2Br1C,GAAW,UACvC,EACKssD,GAAe/a,GACjBgE,GAAmB,CACjB,OAAAhE,GACA,WAAY,CAAE,EAAG,EAAG,EAAG,GACvB,eAAAkE,GACA,0BAA2Bz1C,GAAW,UACtC,0BAA2BA,GAAW,UACvC,EACD,KAKJ,GAAI,CACE,CAACosD,IAAWza,KAAS,SACvBwK,GAAa,QAAQ,QAAU,GAC/BA,GAAa,QAAQ,WAAaiO,GAClCjO,GAAa,QAAQ,mBACnB,OAAOmQ,IAAc,YAAe,SAChCA,GAAa,WACb,KACNnQ,GAAa,QAAQ,eAAiBwO,GAE1C,MAAQ,CAAC,CAET,MAAM4B,GAAO,GAAGp+C,GAAM,IAAI,IAAIA,GAAM,IAAI,IAAIA,GAAM,IAAI,GAChDq+C,GAAO,YAAY,MAGrBD,KAASjI,GAAiB,SAC1BkI,GAAOjI,GAAmB,QAAUhkC,IAGxB83B,EAAWlqC,GAAM,KAAMA,GAAM,KAAa,CACtD,OAAAvL,GACA,KAAAkvC,GACA,iBAAkB,EAAQ+Y,GAC1B,OAAAtZ,GAGA,WAAYoZ,GAGZ,eAAgB2B,IAAc,WAC/B,IACa,KACZhI,GAAiB,QAAUiI,GAC3BhI,GAAmB,QAAUiI,GAKnC,MAAY,CAAC,CAGfl6D,GAAK,gCAAiC,CACpC,MAAAziB,GACA,KAAA8hE,GACA,gBAAAkZ,GACA,WAAAe,GACA,YAAAC,GACA,QAAAO,EAAA,CACD,EAGD,GAAI,CACFvM,GAAkB,CAChB,QAAS8K,IAAc,KACvB,SAAUC,IAAQ,KAClB,WAAYrZ,IAAU,KACtB,eACEwM,GAAgB,QAAQA,GAAgB,QAAQ,OAAS,CAAC,GACtD,YAAc,KACpB,UAAW9sD,IAAS,KACpB,UAAWphB,IAAS,KACpB,SAAU8hE,IAAQ,KAClB,WAAa8J,GAERmQ,GAEEC,GAEC,CAACta,IAAU,CAACwa,GACV,YACApa,KAAS,QAAU,CAACma,GAClB,kBACAhB,GACE,SACA,KAPN,qBAFF,oBAFF,sBAcJ,eAAgBxM,GAAkB,QAClC,OAAQ,CAAC,CAACpO,GACV,aAAAmM,GACA,WAAYwC,GAAc,QAC1B,UAAWzI,GACX,aAAA0U,GACA,QAAAK,GACA,UAAAC,GACA,gBAAiB1M,GAAgB,QAAQ,aACzC,kBAAAjB,GACA,0BAAAhC,GAEA,qBAAA8P,EAAA,CACD,CACH,MAAQ,CAAC,CACT5P,GAAiB1qD,EAAK,EACtB8qD,GAAiBlsE,EAAK,EACtBosE,GAAgBtK,EAAI,EAIpB,GAAI,CACF,GACExR,IACAwR,KAAS,WACR9hE,KAAU,IAAMA,KAAU,IAAMA,KAAU,IAC3C,CACA,MAAM48E,GAAQ,CACZ,MAAA58E,GACA,MAAO,YAAY,MAAQ,KAE7BqsE,GAAkB,QAAUuQ,EAC9B,CACF,MAAQ,CAAC,CAET,MAAMC,GAAe,MAAOrnC,IAA6B,CACvD,GAAI84B,GAAe,QAAS,OAmC5B,GAlCA,QAAQ,IACN,oCACA94B,GAAU,MACVA,GAAU,KACV,mBACAk3B,GAAgB,SAElBjqD,GACE,2BACA+yB,GAAU,MACVA,GAAU,KACVA,GAAU,QAGZ/yB,GACE,2BACA+yB,GAAU,MACVA,GAAU,KACVA,GAAU,QAgBR,EAD0B,CAAC,CAAChlB,IAAK,CAAC,CAAC6d,IACX,CAC1B5rB,GACE,4DACA+yB,GAAU,MACVA,GAAU,MAEZ,GAAI,CACFw6B,GAAkB,CAChB,UAAWx6B,GAAU,OAAS,KAC9B,UAAWA,GAAU,OAAS,KAC9B,SAAUA,GAAU,MAAQ,KAC5B,eACEs6B,GAAe,QAAQ,gBACvB5B,GAAgB,QACdA,GAAgB,QAAQ,OAAS,CACnC,GAAG,YACH,KACF,WAAY,KACZ,WAAY,8BACb,CACH,MAAQ,CAAC,CACT,GAAI,CAEE1F,GACFA,EAAWhzB,GAAU,MAAOA,GAAU,KAAM,CAC1C,OAAQA,GAAU,OAClB,KAAMA,GAAU,KAChB,iBAAkB,GAClB,OAAQ,KACT,CACL,MAAY,CAAC,CACb,MACF,CAEA,GAAI,CAACo2B,GAEH,GAAI,CACFoE,GAAkB,CAChB,WAAY,0BACb,CACH,MAAQ,CAAC,CAGX,MAAM/sD,GAAM,YAAY,MAaxB,GAZIuyB,GAAU,SACQ64B,GAAiB,QAAQ,KAAMh9D,IACpC,KAAK,MAChBmkC,GAAU,QAAS,EAAInkC,GAAM,IAAI,EACjCmkC,GAAU,QAAS,EAAInkC,GAAM,IAAI,GAErB,EACf,GAKCk/B,GAAsB,QAAS,OACnCA,GAAsB,QAAU,GAEhC,GAAI,CACF,OAAO,WACL,IAAM,CACJA,GAAsB,QAAU,EAClC,EACA,KAAK,IAAI,IAAKG,EAAuB,EAEzC,MAAY,CAAC,CAKb,MAAMmK,GAAM,GAAGrF,GAAU,KAAK,IAAIA,GAAU,IAAI,IAAIA,GAAU,IAAI,GAOlE,GACE,EAAAvyB,GAAMwtB,GAAiB,QAAUC,IACjCmK,KAAQrK,GAAe,SAKzB,IAFAA,GAAe,QAAUqK,GACzBpK,GAAiB,QAAUxtB,GACvBuyB,GAAU,MAAQ,EAAG,CACvB48B,GAAiB,EAAI,EACrByB,GAAmB,EAAI,EACvB,GAAI,CACEc,GAAgB,SAClB,aAAaA,GAAgB,OAAO,CACxC,MAAY,CAEZ,CACAA,GAAgB,QAAU,OAAO,WAAW,IAAM,CAChDd,GAAmB,EAAK,EACxBc,GAAgB,QAAU,IAC5B,EAAG,IAAI,EACP,GAAI,CAKF,GAAI,CAiCFlyD,GACE,wDACA+yB,GAAU,MACVA,GAAU,MACVA,GAAU,MAEZ0/B,GAAQ1/B,GAAU,MAAOA,GAAU,MAAOA,GAAU,KAAM,CACxD,iBAAkB,GAClB,OAAAksB,GACA,OAAQ,SAGR,aAAcoZ,EAAA,CACf,CACH,MAAY,CAAC,CAIb,GAAI,CACF,MAAM4B,GAAO7hC,GACP8hC,GAAO,YAAY,MAEvBnU,GACA,EACEkU,KAASjI,GAAiB,SAC1BkI,GAAOjI,GAAmB,QACxBhkC,MAGJ83B,EAAWhzB,GAAU,MAAOA,GAAU,KAAM,CAC1C,OAAQA,GAAU,OAClB,KAAMA,GAAU,KAChB,iBAAkB,GAClB,OAAAksB,EAAA,CACD,EACD+S,GAAiB,QAAUiI,GAC3BhI,GAAmB,QAAUiI,GAEjC,MAAY,CAAC,CACf,MAAY,CAAC,CACf,MACEvK,GAAiB,EAAK,EAIxB,GAAI58B,GAAU,OAAS,EACrB,GAAI,CACEgzB,GACFA,EAAWhzB,GAAU,MAAOA,GAAU,KAAM,CAC1C,OAAQA,GAAU,OAClB,KAAMA,GAAU,KACjB,CACL,MAAY,CAAC,EAEjB,EAEA,GAAK8mC,GA4bE,CACLrO,GAAiB,QAAU,KAC3BkN,GAAe,GACfC,GAAe,SAEf,GAAI,CACF34D,GAAK,0BAA2B,CAC9B,MAAArB,GACA,MAAAphB,GACA,KAAA8hE,EAAA,CACD,CACH,MAAQ,CAAC,CACX,SAvcMya,GAAS,CACX,GAAI,CACF95D,GAAK,yBAA0B,CAC7B,MAAArB,GACA,MAAAphB,GACA,KAAA8hE,GACA,gBAAAkZ,GACA,WAAAe,GACA,YAAAC,GACA,QAASE,GACT,aAAAjB,EAAA,CACD,CACH,MAAQ,CAAC,CACTx4D,GACE,yDACAu4D,GACA,cACAe,GACA,eACAC,GACA,KAEF/N,GAAiB,QAAU,KAC3BmE,GAAiB,EAAK,EACtB+I,GAAe,GACfC,GAAgBJ,GAEXe,GAEEC,GAEEE,GAEC,QADA,YAFF,qBAFF,oBAFF,sBASJ,GAAI,CACE1T,GACFA,EAAWxoE,GAAO8hE,GAAM,CACtB,OAAA/uC,GACA,KAAAkvC,GACA,iBAAkB,GAClB,OAAQ,KACT,CACL,MAAY,CAAC,CACbsP,GAAoB,CAClB,GAAIgJ,GACJ,MAAAn5D,GACA,MAAAphB,GACA,KAAA8hE,GACA,KAAAiZ,GACA,IAAKD,GACL,WAAYh1D,GAAI,WAChB,MAAO,GACP,SAAU,GACV,OAAQm1D,GACR,aAAAG,EAAA,CACD,CACH,KAAO,CAWL,MAAM0B,GAAkB,CAACxO,GAAe,QAClCyO,GAAuBnB,GACzBkB,IACApB,IACAC,IACAJ,GACA,CAACgB,GACCS,GAAuB,CAACpB,IAAiBkB,GAE/C,GAAIhb,KAAS,QAAU9hE,IAAS,EAAG,CACjCiuE,GAAiB,QAAU,KAC3BmE,GAAiB,EAAK,EACtB,GAAI,CACE5J,GACFA,EAAWxoE,GAAO8hE,GAAM,CACtB,OAAA/uC,GACA,KAAAkvC,GACA,iBAAkB,EAAQ+Y,GAC1B,OAAQA,GAAkBtZ,GAAS,KACpC,CACL,MAAY,CAAC,CACbyZ,GAAe,EACjB,SAGO4B,GA2OE,CACL,MAAM3+B,GAAW6vB,GAAiB,QAO5BgP,GAAe,GACfC,GAAU9+B,IAAU,QACtB,KAAK,MACH08B,GAAW,EAAI18B,GAAS,QAAQ,EAChC08B,GAAW,EAAI18B,GAAS,QAAQ,GAElC,IACE++B,GAAe,CAAC,CAAC/+B,IAAY8+B,IAAWD,GAE9C,GAAI,CAAC7+B,GACH6vB,GAAiB,QAAU,CACzB,MAAAjuE,GACA,KAAA8hE,GACA,MAAA1gD,GACA,OAAA2R,GACA,KAAAkvC,GACA,QAASsY,GACT,OAAQ,EACR,QAAS,CAAE,GAAGO,EAAA,CAAW,UAElBqC,GAAc,CAIvB,MAAMC,GACJh/B,GAAS,OAAS,UAAY0jB,KAAS,SACnCA,GACA1jB,GAAS,KAGTi/B,GACJj/B,GAAS,MAAQ,EAAIA,GAAS,MAAQp+C,GAExCiuE,GAAiB,QAAU,CACzB,GAAG7vB,GACH,MAAOi/B,GACP,KAAMD,GACN,MAAAh8D,GACA,OAAA2R,GACA,KAAAkvC,GACA,OAAQ7jB,GAAS,OAAS,EAC1B,QAAS,CAAE,GAAG08B,EAAA,CAAW,CAE7B,MAEE7M,GAAiB,QAAU,CACzB,MAAAjuE,GACA,KAAA8hE,GACA,MAAA1gD,GACA,OAAA2R,GACA,KAAAkvC,GACA,QAASsY,GACT,OAAQ,EACR,QAAS,CAAE,GAAGO,EAAA,CAAW,EAG7B,MAAM9mE,GAAUi6D,GAAiB,QAC3BqP,GAAS/C,GAAUvmE,GAAQ,QAC3BupE,GACJvpE,GAAQ,QAAUkyD,IAClBoX,IAAUnX,GACNqX,GAAS5B,GACXrB,GAAUpM,GAAkB,SAC5Bz9B,GACA,GACJ,GAAI6sC,IAASC,GACX/6D,GAAK,yCAA0C,CAC7C,MAAAziB,GACA,KAAA8hE,GACA,OAAQ9tD,GAAQ,OAChB,QAAAumE,EAAA,CACD,EACDsC,GAAa7oE,EAAO,EACpB6lE,GAAsB,GACtB5L,GAAiB,QAAU,KAC3BE,GAAkB,QAAUoM,GAC5BY,GAAe,GACfC,GAAe,SACV,CAELA,GAAgBmC,GAEXC,GAEC,KADA,WAFF,iBAKJ,GAAI,CACF/6D,GAAK,4BAA6B,CAChC,OAAQ24D,GACR,MAAAp7E,GACA,KAAA8hE,GACA,OAAQ9tD,GAAQ,OAChB,OAAAspE,GACA,OAAAE,GACA,eAAA7B,GACA,eAAgB,OAAO,SAASH,EAAc,EAC1C,KAAK,MAAMA,EAAc,EACzB,KACJ,YAAa,OAAO,SAASC,EAAW,EACpC,KAAK,MAAMA,EAAW,EACtB,KACL,CACH,MAAQ,CAAC,CACX,CACF,KA3V2B,CACzB,MAAMgC,GACJ5O,GAAgB,QAAQ,aACpB6O,GAAgB,KAAK,IACzBxtB,EACA,KAAK,MAAMA,EAA2B,IAAI,GAEtCytB,GACJF,IAAmB/W,GACfkX,GAAe93D,GAAI,MAAQ43D,GACjCvC,GAAe,GACfC,GAAgBM,GAEXC,GAEEL,GAEEC,GAEC,YADA,eAFF,cAFF,kBAFF,kBASJ,GAAI,CACF94D,GAAK,wBAAyB,CAC5B,OAAQ24D,GACR,MAAAh6D,GACA,MAAAphB,GACA,KAAA8hE,GACA,QAAAwZ,GACA,UAAAC,GACA,gBAAAkC,GACA,eAAA9B,GACA,eAAgB,OAAO,SAASH,EAAc,EAC1C,KAAK,MAAMA,EAAc,EACzB,KACJ,YAAa,OAAO,SAASC,EAAW,EACpC,KAAK,MAAMA,EAAW,EACtB,KACL,CACH,MAAQ,CAAC,CAkGT,GAAI,CAEAuB,IACAtB,IACAC,IACA,CAACY,IACDvB,IACAl1D,GAAI,YAAc,KAClB83D,IACAD,KAkEApR,GAAmB,QAAU,CAC3B,IAAK,KACL,QAAS,EACT,OAAQ,EACR,OAAQ,EACR,QAAS,MAGf,MAAQ,CAAC,CAETgF,GAAoB,CAClB,GAAIgJ,GACJ,MAAAn5D,GACA,MAAAphB,GACA,KAAA8hE,GACA,KAAAiZ,GACA,IAAKD,GACL,WAAYh1D,GAAI,WAChB,MAAO,GACP,SAAU,GACV,OAAQm1D,GACR,aAAAG,GACA,MAAOO,EAAA,CACR,CACH,CAkHJ,CAeFpK,GAAoB,CAClB,GAAIgJ,GACJ,MAAAn5D,GACA,MAAAphB,GACA,KAAA8hE,GACA,KAAAiZ,GACA,IAAKD,GACL,WAAYh1D,GAAI,WAChB,MAAOq1D,GACP,SAAUA,IAAgBn7E,GAAQ,GAAK8hE,KAAS,OAChD,OAAQwa,GACR,aAAAlB,GACA,MAAOO,EAAA,CACR,EAgBD,GAAI,EACE3U,IAA0BqC,KAExB78B,EAAW,SACAA,EAAW,QAAQ,WAAW,IAAI,GACzC,UACJ,EACA,EACAA,EAAW,QAAQ,MACnBA,EAAW,QAAQ,OA8C3B,MAAY,CAAC,CAET2uC,IAAgB,CAACtB,IACnBI,GAAS,OAAOrsE,GAAOkY,EAAG,CAK9B,MAEImoD,GAAiB,SACjBsM,GAAUtM,GAAiB,QAAQ,QAAU,MAE7CA,GAAiB,QAAU,KAGjC,MAEMqG,GAAY,SACdA,GAAY,QAAQ,iBAAiB1mE,GAAO,GAAI,CAGtD,MAAY,CAGZ,CACA2mE,GAAO,QAAU,sBAAsBp4B,EAAI,EAE3C8yB,GAAQ,QAAU9yB,GACpB,EAEA,OAAAo4B,GAAO,QAAU,sBAAsBp4B,EAAI,EACpC,IAAM,CACXi9B,GAAW,GACP7E,GAAO,SAAS,qBAAqBA,GAAO,OAAO,EACvDA,GAAO,QAAU,IACnB,CAEF,EAAG,CACDzlC,GACA+gB,EACA0a,GACA/5C,GACA6d,GACAgyB,GACAmM,GACAoI,GACArD,GACA5H,GACAiB,EACAjY,CAAA,CACD,EAED,MAAMkrB,GAAuB93E,cAAY,SAAY,CACnD,GAAI,CACF,GAAIqkE,GAAe,CACjB,MAAM0T,EAAWtU,GAAiB,KAAM7qE,GAAMA,EAAE,OAAS,YAAY,EACjEm/E,EACF9yC,GAAmB8yC,EAAS,SAAUA,EAAS,OAAS,GAAI,EAAI,EAEhE9yC,GAAmB,OAAW,GAAI,EAAI,CAE1C,CACA,MAAM4K,GAAA,CACR,OAASt4B,EAAK,CACZ,QAAQ,KAAK,6CAA8CA,CAAG,CAChE,CACF,EAAG,CAACksD,GAAkBY,GAAep/B,EAAkB,CAAC,EAElD+yC,GAAoB,IAAM,CAC9B,GAAI,CAACrV,EAAkB,OAAO,KAC9B,MAAMt8C,EACJujC,GAAgBn3B,GAAgB,WAAW,cAAgB,OACvDuhD,GACHnqB,GAAiBp3B,GAAgB,WAAW,eAAiB,SAC9D,MACIwlD,EACJ5xD,IAAW,SACP,mGACA2tD,EACE,wFACA,uJACFkE,EAAavuB,GAAe,EAU5BwuB,EACJ7tB,IACC,OAAO,OAAW,MAChB,OAAO,cAAc,QAAQ,kBAAkB,IAAM,KACpD,OAAO,cAAc,QAAQ,gBAAgB,IAAM,KAEnD8tB,GAAa,CACjB,UAAW,SAASF,CAAU,IAC9B,gBAAiB,gBAGjB,OAAQC,EACJ,iDACA,iDACJ,eAAgB,eAKZE,GAAY,CAAC,EAFhB5vC,GAAc,qBACblC,EAAS,SAAS,WAAoC,QACxB,kBAAkB,OAC9C+xC,GAAqBjU,IAAiB,CAACE,GAE7C,OACE/oD,OAAC,OAAI,UAAU,sDACb,UAAAA,OAAC,OAAI,UAAU,kCACb,UAAAC,MAAC,SACC,IAAK2oD,GACL,UAAW6T,EACX,MAAOG,GACP,YAAW,GACX,MAAK,GACL,SAAQ,KAOV38D,MAAC,UACC,IAAKkoD,EACL,UAAU,iCACV,MAAO,CAAE,cAAe,OAAO,GAEjCloD,MAAC,UACC,IAAKgrB,EACL,UAAU,iCACV,QAAS6J,EAAA,GAEV,CAAC+nC,IACA58D,MAAC,OAAI,UAAU,iFACb,SAAAD,OAAC,OAAI,UAAU,YACb,UAAAC,MAAC,OAAI,UAAU,mCACZ,SAAA68D,GACG,6BACA,qBACN,EACA98D,OAAC,OAAI,UAAU,2DACb,UAAAC,MAAC,UACC,UAAU,wBACV,QAAS,IAAM,CACb,GAAI,CACF0pB,GAAiB,EAAI,CACvB,MAAQ,CAAC,CACJ0K,GAAA,CACP,EACD,0BAGDp0B,MAAC,UACC,UAAU,mCACV,QAASq8D,GACV,8BAGDr8D,MAAC,UACC,UAAU,mCACV,QAASqzD,GACV,4BAED,EACF,GACF,EACF,GAEJ,QACC,UAAO,IAAKtoC,GAAW,UAAU,SAAS,GAC7C,CAEJ,EAEM+xC,GAAUv4E,cAAY,IAAM,CAChC,GAAI,CACF,GAAI,OAAO,SAAa,IAAa,OACrC,MAAMg+C,EACJzX,EAAS,SAAWkC,GAAc,wBAA0B,KAC9D,GAAI,CAACuV,EAAS,CACZ,QAAQ,KAAK,sDAAsD,EACnE,MACF,CACA,MAAM1gC,EAAQ0gC,EAAQ,YAAcA,EAAQ,aAAe,EACrDzgC,EAASygC,EAAQ,aAAeA,EAAQ,cAAgB,EAC9D,GAAI,CAAC1gC,GAAS,CAACC,EAAQ,CACrB,QAAQ,KAAK,uDAAuD,EACpE,MACF,CACA,MAAMi7D,EAAgB,SAAS,cAAc,QAAQ,EACrDA,EAAc,MAAQl7D,EACtBk7D,EAAc,OAASj7D,EACvB,MAAMgT,EAAMioD,EAAc,WAAW,IAAI,EACzC,GAAI,CAACjoD,EAAK,CACR,QAAQ,KAAK,6CAA6C,EAC1D,MACF,CACAA,EAAI,UAAUytB,EAAS,EAAG,EAAG1gC,EAAOC,CAAM,EAC1Ci7D,EAAc,OAAQxnB,IAAS,CAC7B,GAAI,CAACA,GAAM,OACX,MAAM55C,GAAM,IAAI,gBAAgB45C,EAAI,EAC9BynB,OAAgB,OAAO,cAAc,QAAQ,QAAS,GAAG,EACzDhjC,GAAS,SAAS,cAAc,GAAG,EACzCA,GAAO,KAAOr+B,GACdq+B,GAAO,SAAW,eAAegjC,EAAS,OAC1C,SAAS,KAAK,YAAYhjC,EAAM,EAChCA,GAAO,QACP,SAAS,KAAK,YAAYA,EAAM,EAChC,OAAO,WAAW,IAAM,IAAI,gBAAgBr+B,EAAG,EAAG,GAAI,CACxD,EAAG,WAAW,CAChB,OAASG,EAAK,CACZ,QAAQ,KAAK,8BAA+BA,CAAG,CACjD,CACF,EAAG,CAACkxB,EAAa,CAAC,EAIlBrzB,YAAU,IAAM,CACd,GAAI,CAEF,GADIgwB,IACAL,EAAmB,OACvB,MAAM2zC,EAAMjV,GAAiB,KAAMzqE,GACjC,eAAe,KAAK,OAAOA,EAAE,OAAS,EAAE,CAAC,GAEvC0/E,GACFzzC,GAAmByzC,EAAI,SAAUA,EAAI,OAAS,GAAI,EAAI,CAE1D,MAAY,CAAC,CACf,EAAG,CACDjV,GACA1+B,EACAK,GACAH,EAAA,CACD,EAGD7vB,YAAU,IAAM,CACd,GAAI,CACFgoB,GACG,WACA,qBAAqB,CAAE,cAAe,CAAC,CAAC3S,GAAG,UAAA6d,GAAW,CAC3D,MAAY,CAAC,CACf,EAAG,CAAC7d,GAAG6d,EAAS,CAAC,EAGjBlzB,YAAU,IAAM,CACd,GAAI,CACF,GAAI,CAACqxB,EAAW,SAAW,CAAC6B,GAAW,OACvC,MAAMnX,EAASsV,EAAW,QACtB,OAAO6B,GAAU,GAAM,UAAY,OAAOA,GAAU,GAAM,WACxDnX,EAAO,QAAUmX,GAAU,GAAKnX,EAAO,SAAWmX,GAAU,KAC9DnX,EAAO,MAAQmX,GAAU,EACzBnX,EAAO,OAASmX,GAAU,EAGhC,MAAY,CAAC,CACf,EAAG,CAAC7B,EAAY6B,EAAS,CAAC,EAG1BlzB,YAAU,IAAM,CACd,GAAI00C,IAAsB,eAAiB,CAACC,EAAgB,OAC5D,MAAMvxC,EAAM6jD,GAAoBtS,EAAiB/wD,GAAM,CACrD,GACE,CAAC0vE,GAAkB,SACnB,YAAY,MAAQD,GAAoB,QAAU,IAElD,OAGF,MAAM1M,EAAO/iE,EAAE,KACTiB,EAAQ,OAAOjB,EAAE,KAAK,GAAK,EAC3Bg0B,EAAUh0B,EAAE,QAAU,KACtBkjE,GAAO,KAAK,IAAI,EAAG,OAAOljE,EAAE,IAAI,GAAK,CAAC,EAE5C,IAAIqiB,GAAQ,GAyBZ,GAxBI0gD,IAAS,OACX1gD,GAAQ,OACC0gD,IAAS,OAClB1gD,GAAQ,KACC0gD,IAAS,aAClB1gD,GAAQ,UACC2R,GAAU,KAEnB3R,GAAQ,GADO6gD,KAAS,EAAI,IAAMA,KAAS,EAAI,IAAM,EACpC,GAAGlvC,CAAM,GAE1B3R,GAAQ,GAAG0gD,CAAI,IAAI9hE,EAAQ,EAAIA,EAAQ,EAAE,GAAG,OAGjC,CAAA6wE,GAAyB,CACpC,MAAA7wE,EACA,MAAAohB,GACA,KAAA0gD,EACA,WAAa/iE,GAAW,WACxB,KAAM,CACJ,iBAAkB,GAClB,OAAQ,KACR,OAAQ,SACV,CACD,EAGD,GAAIypE,EACF,GAAI,CACFA,EAAWzpE,EAAE,MAAOA,EAAE,KAAa,CACjC,OAAQA,EAAE,QAAU,KACpB,KAAOA,EAAE,MAAgB,EAG1B,CACH,MAAY,CAAC,MAEbm2E,GAAQn2E,EAAE,MAAOqiB,GAAOriB,EAAE,KAAa,CACrC,iBAAkB,GAClB,OAAQ,KACR,OAAQ,SACT,CAEL,CAAC,EACD,MAAO,IAAMwf,EAAI,OACnB,EAAG,CAACsxC,EAAmBC,EAAgB+gB,EAAwB,CAAC,EAEhE,SAASx6B,GAAer3C,EAAwC,CAC9D,GAAI,CAACwtC,EAAW,SAAW,CAAChc,IAAK,CAAC6d,GAAW,OAC7C,MAAM6J,EAAO1L,EAAW,QAAQ,wBAC1BzqC,EAAI/C,EAAE,QAAUk5C,EAAK,KACrBx0B,EAAI1kB,EAAE,QAAUk5C,EAAK,IAErBtnB,EACJ4b,EAAW,QAAQ,OAAS6B,GAAU,EAClC7B,EAAW,QAAQ,MAAQ6B,GAAU,EACrC,EACAxd,GACJ2b,EAAW,QAAQ,QAAU6B,GAAU,EACnC7B,EAAW,QAAQ,OAAS6B,GAAU,EACtC,EACA0sC,GAAc,CAAE,EAAGh5E,EAAI6uB,EAAI,EAAGlN,EAAImN,EAAA,EAClCyN,GAAQmjC,GACZjxC,GACAuqD,GACA3nD,IAAS,EACT8C,IAAgB,EAChBC,IAAqB,GAEjBvD,GAAI,GAAG0L,GAAM,IAAI,IAAIA,GAAM,KAAO,EAAIA,GAAM,KAAO,EAAE,GAAG,OAC9DwtC,GAAiBl5C,EAAC,EAClBs5C,GAAiB5tC,GAAM,IAAI,EAC3B8tC,GAAgB9tC,GAAM,IAAY,EAClC8zC,GAAiB,EAAI,EAErB,GAAI,CACE3J,GAAuBD,IACzBA,EAAWlqC,GAAM,KAAMA,GAAM,KAAc,CACzC,OAAQA,GAAM,OACd,KAAMA,GAAM,KACb,EACD8zC,GAAiB,EAAK,EAE1B,MAAY,CAAC,CACf,CAEA,SAASsM,GACP/gE,EACqD,CACrD,MAAMpe,EAAIoe,EAAM,OAAO,cACvB,GAAI,CAACpe,EAAG,OAAO,KACf,MAAMo/E,EAAOp/E,IAAM,QAAUA,IAAM,MAAQA,IAAM,SAAWA,IAAM,QAC5Dq/E,EAAYr/E,IAAM,MAAQA,IAAM,QACtC,GAAIo/E,QAAa,CAAE,MAAO,gBAAiB,MAAO,GAAI,KAAM,cAC5D,GAAIC,QAAkB,CAAE,MAAO,UAAW,MAAO,GAAI,KAAM,QAC3D,MAAMrgF,EAAIgB,EAAE,MAAM,wBAAwB,EAC1C,GAAI,CAAChB,EAAG,OAAO,KACf,MAAM0jE,GAAQ1jE,EAAE,CAAC,GAAK,IAChBsgF,GAAM,SAAStgF,EAAE,CAAC,EAAG,EAAE,EAC7B,GAAIsgF,GAAM,GAAKA,GAAM,GAAI,OAAO,KAChC,MAAMC,GAAU7c,KAAS,IAAM,EAAIA,KAAS,IAAM,EAAI,EAChDH,GACJG,KAAS,IAAM,SAAWA,KAAS,IAAM,SAAW,SACtD,MAAO,CACL,MAAO,GAAGA,EAAI,GAAG4c,EAAG,IAAIA,GAAMC,EAAO,GACrC,MAAOD,GAAMC,GACb,KAAAhd,EAAA,CAEJ,CAEA,SAASid,IAA8B,CACrC,MAAMnsD,EAAI04C,GACV,GAAI,CAAC14C,EAAE,QAAQ,cAAeA,EAAE,cAChC,MAAMn0B,EAAIm0B,EAAE,QAAQA,EAAE,gBAAgB,EAChCiS,EAAMpmC,EAAE,KAAKA,EAAE,KAAK,OAAS,CAAC,EACpC,OAAKomC,EACEA,EAAI,oBADMjS,EAAE,aAErB,CAEA,SAASo/C,GAAkBgN,EAAyB,CAClD,GAAKhwB,GACD,SAAOgwB,GAAmB,UAAY,CAAC,OAAO,SAASA,CAAc,GAEzE,GAAI,CACF,MAAMna,EAAQ,OAAO,gBACrB,GAAI,CAACA,EAAO,OACZ,MAAM7gC,EAAM,IAAI,yBACVi7C,EAAU,KAAK,MAAMD,CAAc,EAIzC,GAHAh7C,EAAI,KAAO,GAAGi7C,CAAO,eACrBj7C,EAAI,KAAO,IACXA,EAAI,MAAQ,EACRirB,GAAa,CACf,MAAMv0C,EAAImqD,EAAM,YAAY,KAAMnqD,IAAMA,GAAE,OAASu0C,EAAW,EAC1Dv0C,MAAO,MAAQA,EACrB,CACAspB,EAAI,OACF,OAAOkrB,IAAiB,SACpB,KAAK,IAAI,EAAG,KAAK,IAAI,EAAGA,EAAY,CAAC,EACrC,EACN,GAAI,CACF2V,EAAM,QACR,MAAQ,CAAC,CACTA,EAAM,MAAM7gC,CAAG,CACjB,MAAQ,CAAC,CACX,CAEA,SAASkuC,GAAc7uC,EAAoB,CACzC,GAAK2rB,EACL,GAAI,CACF,MAAMtiC,EAAO4+C,GAAW,QAAQA,GAAW,gBAAgB,GAAG,KACxD1H,EAAYmb,GAAA,EAClBpa,GACEj4C,GAAQ,SACR2W,EACA,KAAK,IAAI,EAAGugC,CAAS,EACrB3U,GACA,CACE,OAAQC,GACR,aAAcC,CAAA,CAChB,CAEJ,MAAQ,CAAC,CACX,CAEA,SAAS+lB,GACPl1E,EACAohB,EACA0gD,EACAx+B,EACA,CAKA,GAAIsqC,IAAqBJ,GAIvB,GAAI,CACFoE,GAAsB,OAAO,CAC/B,MAAY,CAAC,CAEf,MAAMsN,EAA4B57C,GAAQ,CACxC,iBAAkB,GAClB,OAAQ,KACR,OAAQ,UAGV,GAAI47C,EAAU,SAAW,UAAY5Q,GAAe,QAClD,OAcF,GAAI3F,IAAgB,SAAU,CAG5B,GAAI,CAACuW,EAAU,sBAAuB,CACpC,GAAInO,GAAwB,QAE1B,OAEFA,GAAwB,QAAU,EACpC,CACA,GAAInI,EACF,GAAI,CACFA,EAAc5oE,EAAO8hE,EAAM,CAAE,MAAA1gD,CAAA,CAAO,CACtC,MAAY,CAAC,CAEf,IAAKsrD,GAAgB,SAAW,IAAM,EAAG,CAEvCD,GAAgB,CAAC,EACjBG,GAAgB5sE,CAAK,EACrB8sE,GAAkB,CAAC,CAAE,MAAA1rD,EAAO,MAAAphB,EAAO,KAAA8hE,EAAM,KAAMod,CAAA,CAAW,CAAC,EAC3D,GAAI,CACFjc,GACG,WACA,SACC,CAAC,CAAE,MAAA7hD,EAAO,MAAAphB,EAAO,KAAA8hE,EAAM,KAAMod,EAAW,EACxC,EACAl/E,CAAA,CAEN,MAAY,CAAC,CACb,GAAI,CACEk/E,EAAU,SAAW,UAAU1N,GAAA,CACrC,MAAY,CAAC,CACb,MACF,CACA,MAAM2N,GAAW3S,GAAe,EAChCC,GAAgB0S,EAAQ,EACxBzS,GAAgB,QAAUyS,GAC1BvS,GAAiBh6C,IAAMA,GAAI5yB,CAAK,EAChC8sE,GAAmB9tE,IAAM,CAAC,GAAGA,GAAG,CAAE,MAAAoiB,EAAO,MAAAphB,EAAO,KAAA8hE,EAAM,KAAMod,CAAA,CAAW,CAAC,EACxE,GAAI,CACF,MAAME,GAAc,CAClB,GAAIvS,GACJ,CAAE,MAAAzrD,EAAO,MAAAphB,EAAO,KAAA8hE,EAAM,KAAMod,CAAA,CAAU,EAElChc,GAAQkc,GAAY,OACxB,CAACn7D,GAAKo7D,KAAOp7D,IAAO,OAAOo7D,IAAI,KAAK,GAAK,GACzC,GAEFpc,GACG,WACA,SAASmc,GAAoBD,GAAUjc,EAAK,CACjD,MAAY,CAAC,CACb,MACF,CAGA,IAAKwJ,GAAgB,SAAW,IAAM,EAAG,CACvC,MAAM4S,GAAgB3S,GAChB4S,GAAgB/S,GAChBgT,GAAkBrM,GACtBtG,EAAA,EAGFuG,GAAakM,GAAeC,GAAe,CACzC,aAAcnS,IAAuB,EACrC,kBAAmBE,IAAwB,EAC3C,iBAAkB,GAClB,WAAYgS,GACZ,QAASE,EAAA,CACV,EACD,GAAI,CACF,MAAM9yD,GAAO4+C,GAAW,QAAQA,GAAW,gBAAgB,GAAG,KAC1D5+C,IAAM4zB,GAAU5zB,GAAM6yD,GAAeD,EAAa,CACxD,MAAY,CAAC,CAEb,MAAMG,GACJ,CAAChsB,IAAemf,IAAY9Q,IAAS,UAAYA,IAAS,aACtDxT,GAAUmxB,GAAYz/E,EAAQ,EACpCysE,GAAgB,CAAC,EACjBC,GAAgB,QAAU,EAC1BE,GAAgBte,EAAO,EACvBwe,GAAkB,CAAC,CAAE,MAAA1rD,EAAO,MAAOktC,GAAS,KAAAwT,EAAM,KAAMod,CAAA,CAAW,CAAC,EACpE,GAAI,CACFjc,GACG,WACA,SACC,CAAC,CAAE,MAAA7hD,EAAO,MAAOktC,GAAS,KAAAwT,EAAM,KAAMod,EAAW,EACjD,EACA5wB,EAAA,CAEN,MAAY,CAAC,CACb,GAAI,CACE4wB,EAAU,SAAW,UAAU1N,GAAA,CACrC,MAAY,CAAC,CACbnE,GAAuBoS,GAAY,EAAI,CAAC,EACxClS,GAAwB,CAAC,EAEvB9Z,IACA,CAACmf,KACA9Q,IAAS,UAAYA,IAAS,eAE/B+Q,GAAU,EAAI,EAEhBZ,GAAmB,CACjB,MAAOqN,GACP,MAAOC,GACP,SAAU,GACX,EACD,MACF,CACA,MAAMJ,IAAYzS,GAAgB,SAAW,GAAK,EAC9CwS,EAAU,SAAW,UAAYC,IAAY,IAC/C7Q,GAAe,QAAU,GACzBC,GAAmB,QAAU,GAE/B,QAAQ,IACN,+BAA+BvuE,CAAK,SAAS8hE,CAAI,eAAeqd,EAAQ,IAK1E,MAAMO,GADJ,CAACjsB,IAAemf,IAAY9Q,IAAS,UAAYA,IAAS,aACtB9hE,EAAQ,EAE5CyzD,IACA,CAACmf,KACA9Q,IAAS,UAAYA,IAAS,eAE/B+Q,GAAU,EAAI,EAEhB,MAAM8M,GAAWhT,GAAe+S,GAE1BE,GADYb,GAAA,EACQY,GAGpBE,GACJD,KAAU,IAAM9d,IAAS,UAAYA,IAAS,cAGhD,GAFe8d,GAAQ,GAAKA,KAAU,GAAMA,KAAU,GAAK,CAACC,GAEhD,CAEV,MAAMC,GAAc3M,GAA2B,CAC7C,GAAItG,GACJ,CAAE,MAAAzrD,EAAO,MAAOs+D,GAAc,KAAA5d,CAAA,CAAK,CACpC,EAOKie,IAAgB3S,IAAuB,IAL3C3Z,IACA,CAACmf,IACD,EAAE9Q,IAAS,UAAYA,IAAS,cAC5B,EACA,GAGAke,GAAYJ,GACZK,GAAaL,GAAQF,GACrBQ,GACHD,GAAa,IAAMD,IAAa,IAAOC,IAAc,GAAK,EAAI,EAC3DE,IAAiB7S,IAAwB,GAAK4S,GACpD9M,GAAa,EAAG+L,GAAU,CACxB,aAAcY,GACd,kBAAmBI,GACnB,iBAAkB,GAClB,WAAY,EACZ,QAASL,EAAA,CACV,EACGlS,IACFsE,GAAc,CAAC,EAEjBzF,GAAgB,CAAC,EACjBC,GAAgB,QAAU,EAC1BE,GAAgB,CAAC,EACjBE,GAAkB,EAAE,EACpB4D,GAAgB,EAAE,EAClBrD,GAAuB,CAAC,EACxBE,GAAwB,CAAC,EACzB0E,GAAmB,CAAE,MAAO,EAAG,MAAOkN,GAAU,SAAU,GAAO,EACjE,GAAI,CACFlc,GAAgB,WAAW,OAC7B,MAAY,CAAC,CACb,MACF,CAGAwJ,GAAgB0S,EAAQ,EACxBzS,GAAgB,QAAUyS,GAC1BvS,GAAgB+S,EAAQ,EACxB7S,GAAmB9tE,IAAM,CACvB,MAAMkW,GAAO,CACX,GAAGlW,GACH,CAAE,MAAAoiB,EAAO,MAAOs+D,GAAc,KAAA5d,EAAM,KAAMod,CAAA,CAAU,EAEtD,GAAI,CACF,MAAMhc,GAAQhuD,GAAK,OACjB,CAAC+O,GAAKo7D,KAAOp7D,IAAO,OAAOo7D,IAAI,KAAK,GAAK,GACzC,GAEFpc,GAAgB,WAAW,SAAS/tD,GAAaiqE,GAAUjc,EAAK,CAClE,MAAY,CAAC,CACb,OAAOhuD,EACT,CAAC,EAGD,GAAI,CACF,IAAIylE,GAAmCr3C,GAAc,cAAgB,KAChEq3C,KAAOA,GAAQ7K,GAAe,QAAQ,SAAW,MAClD6K,IAAS,OAAOA,GAAM,GAAM,UAAY,OAAOA,GAAM,GAAM,WACzDuE,EAAU,SAAW,WACvB7Q,GAAiB,QAAU,CACzB,GAAGA,GAAiB,QACpB,CAAE,IAAK,CAAE,GAAGsM,IAAS,GAAI,KAAK,KAAI,CAAE,EACpC,MAAM,EAAE,GAEZjK,GAAiBr7D,IAAS,CACxB,GAAGA,GACH,CAAE,EAAGslE,GAAO,EAAG,EAAGA,GAAO,EAAG,MAAAv5D,CAAA,CAAM,CACnC,EACDovD,GAAiB,CACf,EAAGmK,GAAM,EACT,EAAGA,GAAM,EACT,QAAS,KAAK,MAAQ,IACvB,EAEL,MAAY,CAAC,CAEb,GAAI,CACEuE,EAAU,SAAW,UAAU1N,GAAA,CACrC,MAAY,CAAC,CAGT5D,KAAsBiS,IAAYV,KAAa,IAEjDjN,GAAcyN,EAAQ,EAItBlsB,IACA,CAACmf,IACD,EAAE9Q,IAAS,UAAYA,IAAS,eAEhCuL,GAAwB7uE,KAAOA,IAAK,GAAK,CAAC,EAG5C,CACE,MAAMwhF,GAAYJ,GACZK,GAAaL,GAAQF,IAExBO,GAAa,IAAMD,IAAa,IAAOC,IAAc,KACrC1S,GAAyB5uE,KAAOA,IAAK,GAAK,CAAC,CAChE,CAEA,GAAIkhF,GAAU,CAEZ,MAAMO,GAAgBjN,GAA2B,CAC/C,GAAItG,GACJ,CAAE,MAAAzrD,EAAO,MAAOs+D,GAAc,KAAA5d,CAAA,CAAK,CACpC,EACKl0D,GAAQooC,GAAA,EACdo9B,GAAauM,GAAUR,GAAU,CAC/B,aAAc/R,IAAuB,EACrC,kBAAmBE,IAAwB,EAC3C,iBAAkB,GAClB,WAAYqS,GACZ,QAASS,EAAA,CACV,EACD/M,GAAWsM,EAAQ,EACnBlT,GAAgB,CAAC,EACjBC,GAAgB,QAAU,EAC1BE,GAAgB,CAAC,EACjBE,GAAkB,EAAE,EACpB4D,GAAgB,EAAE,EAClBrD,GAAuB,CAAC,EACxBE,GAAwB,CAAC,EACzB0E,GAAmB,CACjB,MAAO0N,GACP,MAAOR,GACP,SAAU,GACV,KAAM,CACJ,MAAA/9D,EACA,KAAA0gD,EACA,QAASse,GACT,MAAAxyE,EAAA,CACF,CACD,EACD,GAAI,CACFq1D,GAAgB,WAAW,OAC7B,MAAY,CAAC,CACb,MACF,CAEA,GAAIkc,IAAY,EAAG,CACjB,MAAMkB,GAAgBlN,GAA2B,CAC/C,GAAItG,GACJ,CAAE,MAAAzrD,EAAO,MAAOs+D,GAAc,KAAA5d,CAAA,CAAK,CACpC,EACDsR,GAAauM,GAAUR,GAAU,CAC/B,aAAc/R,IAAuB,EACrC,kBAAmBE,IAAwB,EAC3C,iBAAkB,GAClB,WAAYqS,GACZ,QAASU,EAAA,CACV,EACD,GAAI,CACEnB,EAAU,SAAW,UAAU1N,GAAA,CACrC,MAAY,CAAC,CACb/E,GAAgB,CAAC,EACjBC,GAAgB,QAAU,EAC1BE,GAAgB,CAAC,EACjBE,GAAkB,EAAE,EACpB4D,GAAgB,EAAE,EAClBrD,GAAuB,CAAC,EACxBE,GAAwB,CAAC,EACzB0E,GAAmB,CAAE,MAAO0N,GAAU,MAAOR,GAAU,SAAU,GAAO,EACxE,GAAI,CACFlc,GAAgB,WAAW,OAC7B,MAAY,CAAC,CACf,CAMF,CAEA,SAASqd,IAAgB,CACvB,GAAI,EAAA1S,IAAqBJ,KACrB3B,GAAe,CACjB,GAAIrD,EACF,GAAI,CACFA,EAAWyD,GAAeE,GAAc,MAAS,CACnD,MAAY,CAAC,MAEb+I,GAAQjJ,GAAeJ,GAAeM,EAAY,EAEpDsH,GAAe,CAAC,EAChBrB,GAAiB,EAAK,CACxB,CACF,CAEA,SAASmO,IAAgB,CACvB,GAAI3S,IAAqBJ,GAAe,OACxC,MAAM9oC,EAASg6C,GAAY3S,EAAW,EACtC,GAAI,CAACrnC,EAAQ,CACX,MAAM,gCAAgC,EACtC,MACF,CAEA,GACE,CAACivC,IACD,CAAC9H,IACDM,KAAiB,QACjBF,KAAkB,EAClB,CACA,MAAMttE,EAAI60E,GAAc,EACxBC,GAAe90E,CAAC,EACZA,GAAK,GAAG+0E,GAAkB,EAAI,CACpC,MACED,GAAe,CAAC,EAElByB,GAAQxwC,EAAO,MAAOA,EAAO,MAAOA,EAAO,IAAI,EAC/CsnC,GAAe,EAAE,EACjBoG,GAAiB,EAAK,CACxB,CAGA,SAASoO,IAAkB,CACzB,GAAI5S,IAAqBJ,GAAe,OACxC,MAAM9oC,EAASg6C,GAAY3S,EAAW,EACtC,GAAI,CAACrnC,EAAQ,CACX,MAAM,gCAAgC,EACtC,MACF,CACA,GAAI8nC,KAAiB,GAAKK,GAAe,SAAW,EAAG,CACrD0T,GAAA,EACA,MACF,CACA,GAAI5X,IAAgB,SAAU,CAE5B,GACE,CAACgL,IACD,CAAC9H,IACDM,KAAiB,QACjBF,KAAkB,EAClB,CACA,MAAMttE,GAAI60E,GAAc,EACxBC,GAAe90E,EAAC,EACZA,IAAK,GAAG+0E,GAAkB,EAAI,CACpC,SAAsB,CAAC,EAOvB,GAJA5G,GAAmB9tE,IAAM,CACvB,GAAGA,GAAE,MAAM,EAAG,EAAE,EAChB,CAAE,MAAO0lC,EAAO,MAAO,MAAOA,EAAO,MAAO,KAAMA,EAAO,KAAK,CAC/D,EACGmkC,EACF,GAAI,CACFA,EAAiBnkC,EAAO,MAAOA,EAAO,KAAM,CAAE,MAAOA,EAAO,MAAO,CACrE,MAAQ,CAAC,CACXsnC,GAAe,EAAE,EACjBoG,GAAiB,EAAK,EACtB,MACF,CACA,GACE,CAACuB,IACD,CAAC9H,IACDM,KAAiB,QACjBF,KAAkB,EAClB,CACA,MAAMttE,GAAI60E,GAAc,EACxBC,GAAe90E,EAAC,EACZA,IAAK,GAAG+0E,GAAkB,EAAI,CACpC,SAAsB,CAAC,EAEvB,MAAMrzE,EAAOwsE,GAAeA,GAAe,OAAS,CAAC,EAC/C4T,EAAYjU,GAAe,EAC3BkU,EAAY/T,IAAgBtsE,GAAM,OAAS,GAC3CujE,EAAYmb,GAAA,EACZY,GAAWe,EAAYh8C,EAAO,MAC9By6C,GAAWsB,EAAY,EACvBb,GAAQhc,EAAY+b,GACpBE,GACJD,KAAU,IAAMl7C,EAAO,OAAS,UAAYA,EAAO,OAAS,cAG9D,GAFek7C,GAAQ,GAAKA,KAAU,GAAMA,KAAU,GAAK,CAACC,GAEhD,CACVzM,GAAa,EAAG+L,EAAQ,EACxB,GAAI,CACF,MAAMzyD,GAAO4+C,GAAW,QAAQA,GAAW,gBAAgB,GAAG,KAC1D5+C,IAAM4zB,GAAU5zB,GAAMyyD,GAAU,CAAC,CACvC,MAAY,CAAC,CACTvR,IACFsE,GAAc,CAAC,EAEjBzF,GAAgB,CAAC,EACjBC,GAAgB,QAAU,EAC1BE,GAAgB,CAAC,EACjBE,GAAkB,EAAE,EACpB4D,GAAgB,EAAE,EAClBuB,GAAmB,CAAE,MAAO,EAAG,MAAOkN,GAAU,SAAU,GAAO,EACjEnT,GAAe,EAAE,EACjBoG,GAAiB,EAAK,EACtB,MACF,CAeA,GAbA3F,GAAgB0S,EAAQ,EACxBzS,GAAgB,QAAUyS,GAC1BvS,GAAgB+S,EAAQ,EACxB7S,GAAmB9tE,IAAM,CACvB,GAAGA,GAAE,MAAM,EAAG,EAAE,EAChB,CAAE,MAAO0lC,EAAO,MAAO,MAAOA,EAAO,MAAO,KAAMA,EAAO,KAAK,CAC/D,EAGGkpC,KAAsBiS,IAAYV,KAAa,IACjDjN,GAAcyN,EAAQ,EAGpBE,GAAU,CACZzM,GAAauM,GAAUR,EAAQ,EAC/B9L,GAAWsM,EAAQ,EACnB,GAAI,CACF,MAAMjzD,GAAO4+C,GAAW,QAAQA,GAAW,gBAAgB,GAAG,KAC1D5+C,IAAM4zB,GAAU5zB,GAAMyyD,GAAUQ,EAAQ,CAC9C,MAAY,CAAC,CACblT,GAAgB,CAAC,EACjBC,GAAgB,QAAU,EAC1BE,GAAgB,CAAC,EACjBE,GAAkB,EAAE,EACpB4D,GAAgB,EAAE,EAClBuB,GAAmB,CAAE,MAAO0N,GAAU,MAAOR,GAAU,SAAU,GAAM,EACvEnT,GAAe,EAAE,EACjBoG,GAAiB,EAAK,EACtB,MACF,CAEA,GAAI+M,IAAY,EAAG,CACjB/L,GAAauM,GAAUR,EAAQ,EAC/B,GAAI,CACF,MAAMzyD,GAAO4+C,GAAW,QAAQA,GAAW,gBAAgB,GAAG,KAC1D5+C,IAAM4zB,GAAU5zB,GAAMyyD,GAAUQ,EAAQ,CAC9C,MAAY,CAAC,CACblT,GAAgB,CAAC,EACjBC,GAAgB,QAAU,EAC1BE,GAAgB,CAAC,EACjBE,GAAkB,EAAE,EACpB4D,GAAgB,EAAE,EAClBuB,GAAmB,CAAE,MAAO0N,GAAU,MAAOR,GAAU,SAAU,GAAO,CAC1E,CACAnT,GAAe,EAAE,EACjBoG,GAAiB,EAAK,CACxB,CAGAj3D,YAAU,IAAM,CACd,SAAS2F,EAAM9hB,EAAkB,CAC/B,GAAI,CAEF,MAAMykC,EADS,SAAS,eACJ,SAAS,cACzBzkC,EAAE,MAAQ,KAAOykC,IAAQ,SAAWA,IAAQ,aAC9CwkB,GAAa,QAAQ,EACrB8rB,GAAmB,EAAI,EAE3B,MAAY,CAAC,CACf,CACA,cAAO,iBAAiB,UAAWjzD,CAAK,EACjC,IAAM,OAAO,oBAAoB,UAAWA,CAAK,CAC1D,EAAG,EAAE,EAGL,SAAS6/D,GAAa9B,EAAa5c,EAAuB,CACxD,GAAIuK,IAAgB,GAAMoB,IAAqBJ,GAAgB,OAC/D,MAAM5xD,EAAMijE,GAAO5c,IAAS,IAAM,EAAIA,IAAS,IAAM,EAAI,GACnDH,EACJG,IAAS,IAAM,SAAWA,IAAS,IAAM,SAAW,SAEtD,GACE,CAAC0R,IACD,CAAC9H,IACDM,KAAiB,QACjBF,KAAkB,EAClB,CACA,MAAMttE,EAAI60E,GAAc,EACxBC,GAAe90E,CAAC,EACZA,GAAK,GAAG+0E,GAAkB,EAAI,CACpC,MACED,GAAe,CAAC,EAElByB,GAAQt5D,EAAK,GAAGqmD,CAAI,GAAG4c,CAAG,IAAIjjE,CAAG,GAAIkmD,CAAI,EACzCsQ,GAAiB,EAAK,CACxB,CAEA,SAASwO,IAAa,CACpB,GAAIpU,KAAiB,EAAG,OACxB,MAAMnsE,EAAOwsE,GAAeA,GAAe,OAAS,CAAC,EACrDJ,GAAiB1tE,GAAMA,EAAI,CAAC,EAC5B2tE,GAAgB,QAAU,KAAK,IAAI,GAAIA,GAAgB,SAAW,GAAK,CAAC,EACxEE,GAAiBh6C,GAAMA,GAAKvyB,GAAM,OAAS,EAAE,EAC7CysE,GAAmB9tE,GAAMA,EAAE,MAAM,EAAG,EAAE,CAAC,CACzC,CAEA,SAAS6hF,IAAgB,CACvB,GAAIrU,KAAiB,GAAMoB,IAAqBJ,GAAgB,OAChE,GAAIL,EAAe,CACjB,GAAI,CACF,OAAO,MACL,mGAEJ,MAAQ,CAAC,CACT,MACF,CACA,GAAIxE,IAAgB,SAAU,CAE5B8D,GAAgB,CAAC,EACjBC,GAAgB,QAAU,EAC1BA,GAAgB,QAAU,EAC1BE,GAAgB,CAAC,EACjBE,GAAkB,EAAE,EACpB4D,GAAgB,EAAE,EAClB,MACF,CACA,MAAMoQ,EAAanU,GACboU,EAAavU,GACb6T,EAAgBlN,GAA2BtG,EAAuB,EACxEuG,GAAa0N,EAAYC,EAAY,CACnC,QAASV,EACT,WAAYS,CAAA,CACb,EACD,GAAI,CACF,MAAMp0D,EAAO4+C,GAAW,QAAQA,GAAW,gBAAgB,GAAG,KAC1D5+C,GAAM4zB,GAAU5zB,EAAMq0D,EAAYD,CAAU,CAClD,MAAY,CAAC,CACbrU,GAAgB,CAAC,EACjBC,GAAgB,QAAU,EAC1BE,GAAgB,CAAC,EACjBE,GAAkB,EAAE,EACpB4D,GAAgB,EAAE,EAClBuB,GAAmB,CACjB,MAAO6O,EACP,MAAOC,EACP,SAAU,GACX,CACH,CAEA,MAAMC,GACJz/D,OAAC,OAAI,UAAU,uDAEZ,UAAAgnD,GAAe,CAACa,GACf5nD,MAAC,OAAI,UAAU,gBACb,SAAAA,MAAC,OAAI,UAAU,+BACb,SAAAA,MAAC,UACC,UAAW,yBAAyBwmC,KAAc,SAAW,cAAgB,EAAE,GAC/E,QAAS,IAAM,CACbC,GAAa,QAAQ,EACrB8rB,GAAmB,EAAI,CACzB,EACA,MAAM,yBACP,8BAED,CACF,EACF,EAEArL,EAiZE,KAhZFlnD,MAAC,OAAI,UAAU,mEACb,SAAAD,OAAC,OAAI,UAAU,2DACb,gBAAC,MAAG,UAAU,6BAA6B,kBAAM,EACjDA,OAACwhD,GAAA,CACC,WAAW,kBACX,UAAU,uDACV,aAAc,IACd,cAAe,IACf,SAAU,IACV,UAAW,IACX,SAAU,IACV,UAAW,IACX,SAAQ,GAER,UAAAvhD,MAAC+2D,GAAA,EAAe,GACd,IAAM,CACN,MAAMnsD,EACJujC,GACAn3B,GAAgB,WAAW,cAC3B,OACIuhD,GACHnqB,GACCp3B,GAAgB,WAAW,eAC3B,SAAW,MACTwlD,EACJ5xD,IAAW,SACP,mGACA2tD,EACE,uEACA,uJACFkE,EAAavuB,GAAe,EAC5BwuB,EACJ,OAAO,OAAW,MACjB,OAAO,cAAc,QAAQ,kBAAkB,IAAM,KACpD,OAAO,cAAc,QAAQ,gBAAgB,IAAM,KACjDC,GAAa,CACjB,UAAW,SAASF,CAAU,IAC9B,gBAAiB,gBAEjB,OAAQC,EACJ,iDACA,iDACJ,eAAgB,eAEZ+C,GACJ70D,IAAW,SACP,iDACA,wCACA80D,GAAqB,IACzB3/D,OAAC,OAAI,UAAW,mBAAmB0/D,EAAc,GAC/C,UAAAz/D,MAAC,SACC,IAAK2oD,GACL,UAAW6T,EACX,MAAOG,GACP,YAAW,GACX,MAAK,GACL,SAAQ,KAEV38D,MAAC,UACC,IAAKgrB,EACL,UAAU,iCACV,QAAS6J,EAAA,GAEX90B,OAAC,OACC,UAAU,mGACV,cAAe8wD,GACf,aAAY,iBAAiBxF,GAAe,CAAC,EAAKA,GAAe,CAAC,EAAE,MAAQ,EAAI,MAAQ,OAAU,SAAS,KAAKA,GAAe,CAAC,EAAKA,GAAe,CAAC,EAAE,MAAQ,EAAI,MAAQ,OAAU,SAAS,KAAKA,GAAe,CAAC,EAAKA,GAAe,CAAC,EAAE,MAAQ,EAAI,MAAQ,OAAU,SAAS,GAEhR,WAAC,EAAG,EAAG,CAAC,EAAE,IAAKxrE,IAAM,CACpB,MAAMrC,GAAI6tE,GAAexrE,EAAC,EACpB8/E,GAAWpT,GAAuB1sE,EAAC,EACnC+/E,GAAY,CAACpiF,GACb6E,GAAW,CAAC,CAAC7E,IAAKmiF,KAAatT,GAC/BwT,GACJ,OAAOriF,IAAG,OAAU,SAAWA,GAAE,MAAQ,EAAI,GACzCsiF,IACHtiF,IAAG,MAAQA,GAAE,OAAS,SAAW,GAG9Bu3B,GAAS1yB,GADbA,KAAaw9E,IAAoBC,IAI7B,iBACA,cAHF,iBAIEC,GAAc19E,IAAY,CAACu9E,GACjC,OACE5/D,MAAC,QAEC,UAAW,aAAa+/D,GAAc,SAAW,UAAU,IAAIhrD,EAAK,IAD/Dl1B,EAAA,CAIX,CAAC,EACAgyD,IAAoB+gB,KAAiB,MACpC7yD,OAAC,QAAK,UAAU,mEACb,eAAK,IAAI,EAAG6yD,EAAY,EAAE,KAC7B,KAGHxG,IAAqBJ,GACpBhsD,MAAC,OAAI,UAAU,kIAAkI,oCAEjJ,EACE,MACN,EAEF,OAAI4oD,GACGE,GAyCE4W,GAAA,QAvCF,OAAI,UAAU,8GACb,SAAA3/D,OAAC,OAAI,UAAU,yCACb,gBAAC,OAAI,UAAU,yBAAyB,eAAG,QAC1C,OAAI,UAAU,sCAAsC,iCAErD,QACC,KAAE,UAAU,yBAAyB,8EAGtC,EACAA,OAAC,OAAI,UAAU,mDACb,UAAAC,MAAC,UACC,UAAU,iEACV,QAASqzD,GACV,6BAGDrzD,MAAC,UACC,UAAU,mEACV,QAAS,IAAM,CACb,GAAI,CACFgtB,GAAc,iBAAiB,EAAI,CACrC,MAAY,CAAC,CACf,EACD,0BAGDhtB,MAAC,UACC,UAAU,uEACV,QAASq8D,GACT,SAAU,CAACrU,GAAiB,OAC7B,6BAED,EACF,GACF,EACF,EAKC0X,GAAA,CACT,IAAG,IAGJ,CAAC9X,GACA7nD,OAAAja,WAAA,CACE,UAAAia,OAAC,OAAI,UAAU,iDACb,gBAAC,QAAK,UAAU,yCAAyC,eAEzD,EACAC,MAAC,UACC,UAAU,2BACV,QAAS,IAAM0vD,GAAkB,IAAK,EACtC,MAAM,uBACP,eAGD3vD,OAAC,QAAK,UAAU,4CACb,eAAK,OAAOmuC,GAAe,GAAK,GAAG,EAAE,KACxC,EACAluC,MAAC,UACC,UAAU,2BACV,QAAS,IAAM0vD,GAAkB,GAAI,EACrC,MAAM,uBACP,eAGD1vD,MAAC,UACC,UAAW,wCAAwCouC,IAAkB,OAAS,4BAA8B,EAAE,GAC9G,QAASuhB,GACT,MAAM,sBACP,kBAGD3vD,MAAC,UACC,UAAW,wCAAwCouC,IAAkB,OAAS,8BAAgC,EAAE,GAChH,QAASwhB,GACT,MAAM,yBACP,iBAED,EACF,QACC,OAAI,UAAU,8BAA8B,wDAE7C,GACF,EAID0B,SACE,OAAI,UAAU,UAAU,cAAY,OACnC,SAAAtxD,MAAC,UACC,cAAY,mBACZ,QAASq/D,GACT,SAAUrU,KAAiB,GAAKW,EACjC,mBAED,CACF,EACE,KACH,CAAC/D,GACA7nD,OAAC,OAAI,UAAU,8DACf,gBAAC,OAAI,UAAU,0DAA0D,2BAEzE,EACAA,OAAC,OAAI,UAAU,oCACZ,UAAA6oD,GACC7oD,OAAAja,WAAA,CACE,UAAAka,MAAC,OACC,UAAW,yDAAyD8oD,GAAkB,2DAA6D,oDAAoD,GAEtM,YACG,iCACA,wCAEN9oD,MAAC,UACC,UAAU,iEACV,QAASqzD,GACV,6BAGDrzD,MAAC,UACC,UAAU,mEACV,QAAS,IAAM,CACb,GAAI,CACFgtB,GAAc,iBACZ,CAACA,GAAc,YAEnB,MAAY,CAAC,CACf,EAEC,SAAAA,GAAc,YACX,eACA,iBAENhtB,MAAC,UACC,UAAU,iEACV,SAAU,CAAC8oD,GACX,QAAS,IAAM,CACb,GAAI,CACF97B,GAAc,gBAChB,MAAY,CAAC,CACf,EACD,6BAGAknC,IACCl0D,MAAC,UACC,UAAU,uEACV,QAASq8D,GACT,SAAU,CAACrU,GAAiB,OAC7B,6BAED,EAEJ,EAEAhoD,MAAAla,WAAA,CACG,SAACmoB,EAWAjO,MAAC,UACC,UAAU,oCACV,QAASozB,GACV,yBAbDpzB,MAAC,UACC,UAAU,MACV,QAASo0B,GACT,SAAU40B,GAET,YACG,uBACA,mBAUV,EAED,CAAC17B,IACAttB,MAAC,UACC,UAAU,sCACV,QAAS+wD,GACT,MAAM,2CACP,4BAIH/wD,MAAC,UACC,UAAU,mCACV,QAAS,IAAM8nD,GAAqB,CAACD,EAAiB,EACtD,MAAM,iCAEL,YACG,oBACA,sBAEN7nD,MAAC,UACC,UAAU,MACV,QAAS88D,GACT,SAAU,CAAC/T,GACZ,2BAGAe,IAAY,YACX/pD,OAAAja,WAAA,CACE,UAAAka,MAACiiD,GAAA,CAAgB,QAAO,GAAC,EACzBjiD,MAAC,UACC,UAAU,iEACV,QAAS,IAAMwrD,GAAiB,EAAI,EACrC,0BAGAD,IACCvrD,MAAC2hD,GAAA,CACC,QAAS,IAAM6J,GAAiB,EAAK,EACrC,OAAQ,IAAM,CACZ,GAAI,CAEF,OAAO,cACL,IAAI,YAAY,gBAAgB,GAGlC,GAAI,CACFjpC,GAAiB,CAAE,KAAM,OAAQ,CACnC,MAAQ,CAAC,CACX,MAAY,CAAC,CACbipC,GAAiB,EAAK,CACxB,EACA,QAAUwU,GAAY,CACpB,MAAMrhB,EAAS,KAAK,MAAQqhB,EAAU,GAAK,IAC3C,GAAI,CACFthB,GAAgB,WAAW,UAAU,GAAMC,CAAM,EACjD,GAAI,CACFp8B,GAAiB,CACf,KAAM,QACN,YAAao8B,EACb,eAAgB,KAAK,KAAI,CAC1B,CACH,MAAQ,CAAC,CACX,MAAY,CAAC,CACb6M,GAAiB,EAAK,CACxB,IAGJxrD,MAAC,UACC,UAAU,mCACV,QAAS,IAAM,CACb,GAAI,CACF0iD,GAAA,EACA,OAAO,KACL,GAAG,OAAO,SAAS,MAAM,GAAG,OAAO,SAAS,QAAQ,WACpD,SAEJ,MAAY,CAAC,CACf,EACD,sCAGD1iD,MAAC,UACC,UAAU,mCACV,QAAS,SAAY,CACnB,GAAI,CACE,SAAS,gBAAgB,kBAC3B,MAAM,SAAS,gBAAgB,oBACrB,SAAiB,KAAK,mBAChC,MAAO,SAAiB,KAAK,mBAEjC,MAAY,CAAC,CACf,EACD,6BAED,EACF,EAEFA,MAAC,UACC,UAAU,sCACV,QAAS,IAAM,CACb,GAAI,CACF,OAAO,cACL,IAAI,MAAM,kBAAyB,EAEvC,MAAY,CAAC,CACf,EACD,8BAED,EACF,GACA,GAEJ,EACF,EAIDsxD,GACCtxD,MAAC,OAAI,UAAU,8BACb,SAAAA,MAAC,UACC,UAAU,qFACV,MAAM,6BACN,QAAS,IAAM,CACbymC,GAAa,QAAQ,EACrB8rB,GAAmB,EAAI,CACzB,EACD,eAED,CACF,EACE,WAEH,UAAO,IAAKxnC,GAAW,UAAU,SAAS,EAG1C8jC,IACC7uD,MAAC,OACC,UAAU,sCACV,KAAK,SACL,aAAW,OAGX,eAAC,OAAI,UAAU,6DACb,SAAAD,OAAC,OAAI,UAAU,+BACb,UAAAA,OAAC,OAAI,UAAU,yCACb,gBAAC,MAAG,UAAU,wBAAwB,iCAAqB,EAC3DC,MAAC,UACC,UAAU,iBACV,QAAS,IAAM8uD,GAAkB,IAAI,EACtC,kBAED,EACF,QACC,OAAI,UAAU,0BAA0B,wDAEzC,EACA/uD,OAAC,OAAI,UAAU,2BACb,UAAAA,OAAC,OACC,gBAAC,QAAK,UAAU,gBAAgB,qBAAS,EAAQ,IAChD8uD,GAAe,OAClB,SACC,OACC,gBAAC,QAAK,UAAU,gBAAgB,uBAAW,EAAQ,IAClDA,GAAe,WAAW,QAAQ,CAAC,GACtC,GACF,EACA9uD,OAAC,OAAI,UAAU,uBACb,UAAAC,MAAC,UACC,UAAU,MACV,QAAS,IAAM,CACb,GAAI,CACF0zD,GACE7E,GAAe,MACfA,GAAe,MACfA,GAAe,KACfA,GAAe,KAEnB,MAAY,CAAC,CACbC,GAAkB,IAAI,CACxB,EACD,oBAGD9uD,MAAC,UACC,UAAU,iBACV,QAAS,IAAM8uD,GAAkB,IAAI,EACtC,oBAGD9uD,MAAC,UACC,UAAU,sCACV,QAAS,IAAM,CACb8uD,GAAkB,IAAI,EACtByD,GAAmB,EAAI,EACvB9rB,GAAa,QAAQ,CACvB,EACD,mCAED,EACF,GACF,EACF,IAIH6rB,IACCtyD,MAAC,OACC,UAAU,oCACV,KAAK,SACL,aAAW,OAEX,eAAC,OAAI,UAAU,iCACb,SAAAD,OAACpe,GAAA,CAAU,YAAW,GACpB,UAAAoe,OAAC,OAAI,UAAU,+CACb,gBAAC,MAAG,UAAU,oCAAoC,6BAElD,EACAC,MAAC,OAAI,UAAU,0BACb,SAAAA,MAAC,UACC,UAAU,sCACV,QAAS,IAAM,CACbuyD,GAAmB,EAAK,CAC1B,EACD,mBAGH,GACF,QACC,OAAI,UAAU,oBACb,SAAAxyD,OAAC,OAAI,UAAU,+CAEb,UAAAA,OAAC,OAAI,UAAU,8BACb,gBAAC,OAAI,UAAU,6BAA6B,wBAE5C,EACAC,MAAC,OAAI,UAAU,uDACb,SAAAA,MAAC,UACC,IAAK2yD,GACL,UAAU,mCAEd,GACF,EAEA5yD,OAAC,OAAI,UAAU,qBACb,gBAAC,OAAI,UAAU,0BAA0B,iFAGzC,EACAA,OAAC,OAAI,UAAU,+BACb,gBAAC,QAAK,UAAU,gBAAgB,sBAAU,QACzC,QAAM,SAAAsqD,IAAiB,IAAI,EAC5BrqD,MAAC,UACC,UAAU,MACV,QAAS8+D,GACT,SAAU9T,IAAgB,EAC3B,0BAED,EACF,EACAjrD,OAAC,OAAI,UAAU,+BACb,UAAAC,MAAC,SACC,UAAU,mBACV,YAAY,+BACZ,MAAOuqD,GACP,SAAW/sE,GAAMgtE,GAAehtE,EAAE,OAAO,KAAK,EAC9C,UAAYA,GAAM,CACZA,EAAE,MAAQ,SAAW,CAACA,EAAE,WAC1BA,EAAE,iBACFuhF,GAAA,GAEEvhF,EAAE,MAAQ,SAAWA,EAAE,WACzBA,EAAE,iBACFwhF,GAAA,EAEJ,IAEFh/D,MAAC,UACC,UAAU,iBACV,QAASg/D,GACT,SAAUhU,KAAiB,EAC5B,0BAGDhrD,MAAC,UACC,UAAU,MACV,QAAS++D,GACT,SAAU/T,IAAgB,EAC3B,gBAED,EACF,QACC,OAAI,UAAU,0BAA0B,4DAEzC,EAEAjrD,OAAC,OAAI,UAAU,OACb,gBAAC,OAAI,UAAU,6BAA6B,sBAE5C,EACAA,OAAC,OAAI,UAAU,kCACZ,WAAC,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,GAAG,EAAE,IACjDxiB,GACCyiB,MAAC,UAEC,UAAU,cACV,QAAS,IAAM,CAEbwqD,GAAgBhpD,GAEV,UAAU,KAAKA,CAAE,EAAUA,EAAKjkB,GAC5BikB,GAAM,IAAMjkB,CACrB,CACH,EAEC,SAAAA,CAAA,EAXIA,CAAA,CAYP,EAGJyiB,MAAC,UACC,UAAU,+CACV,QAAS,IAAMwqD,GAAe,EAAE,EACjC,mBAGDxqD,MAAC,UACC,UAAU,iDACV,QAAS,IACPwqD,GAAgBhpD,IAAQA,GAAM,IAAI,MAAM,EAAG,EAAE,CAAC,EAEjD,eAGDxB,MAAC,UACC,UAAU,qDACV,QAAS,IAAM++D,GAAA,EACf,SAAU/T,IAAgB,EAC3B,kBAED,EACF,QACC,OAAI,UAAU,0BAA0B,qGAGzC,GACF,EACAjrD,OAAC,OAAI,UAAU,UACb,gBAAC,OAAI,UAAU,6BAA6B,uBAE5C,EAEAA,OAAC,OAAI,UAAU,4BACb,UAAAC,MAAC,UACC,UAAU,MACV,SAAUgrD,IAAgB,EAC1B,QAAS,IAAM,CACb,GACE,CAACmH,IACD,CAAC9H,IACDM,KAAiB,QACjBF,KAAkB,EAClB,CACA,MAAMttE,EAAI60E,GAAc,EACxBC,GAAe90E,CAAC,EACZA,GAAK,GAAG+0E,GAAkB,EAAI,CACpC,SAAsB,CAAC,EACvBwB,GAAQ,GAAI,UAAW,MAAM,EAC7B9C,GAAiB,EAAK,CACxB,EACD,gBAGD5wD,MAAC,UACC,UAAU,MACV,SAAUgrD,IAAgB,EAC1B,QAAS,IAAM,CACb,GACE,CAACmH,IACD,CAAC9H,IACDM,KAAiB,QACjBF,KAAkB,EAClB,CACA,MAAMttE,EAAI60E,GAAc,EACxBC,GAAe90E,CAAC,EACZA,GAAK,GAAG+0E,GAAkB,EAAI,CACpC,SAAsB,CAAC,EACvBwB,GAAQ,GAAI,gBAAiB,YAAY,EACzC9C,GAAiB,EAAK,CACxB,EACD,eAED,EACF,EAEA7wD,OAAC,OAAI,UAAU,+BACb,UAAAC,MAAC,SACC,UAAU,wBACV,KAAK,oBACL,YAAY,sCACZ,MAAO8xD,GACP,SAAWt0E,GACTu0E,GAAkBv0E,EAAE,OAAO,MAAM,aAAa,EAEhD,UAAYA,GAAM,CAChB,GAAIA,EAAE,MAAQ,QAAS,CACrB,MAAMT,EACJ+0E,GAAe,MAAM,oBAAoB,EACvC/0E,GACFoiF,GAAa,SAASpiF,EAAE,CAAC,EAAG,EAAE,EAAGA,EAAE,CAAC,CAAQ,CAEhD,CACF,IAEFijB,MAAC,YAAS,GAAG,oBACT,UAAC,IAAK,IAAK,GAAG,EAAY,IAAKygD,GAC/B,MAAM,KAAK,CAAE,OAAQ,IAAM,CAAC70D,EAAG/L,IAAMA,EAAI,CAAC,EAAE,IACzCw9E,GACCr9D,MAAC,UAEC,MAAO,GAAGygD,CAAI,GAAG4c,CAAG,IADf,GAAG5c,CAAI,GAAG4c,CAAG,GAEpB,CAEJ,EAEJ,EACAr9D,MAAC,UACC,UAAU,MACV,SAAU,CAAC8xD,IAAkB9G,IAAgB,EAC7C,QAAS,IAAM,CACb,MAAMjuE,EACJ+0E,GAAe,MAAM,oBAAoB,EAC3C,GAAI,CAAC/0E,EAAG,OACR,MAAM0jE,EAAO1jE,EAAE,CAAC,EACVsgF,EAAM,SAAStgF,EAAE,CAAC,EAAG,EAAE,EAC7BoiF,GAAa9B,EAAK5c,CAAI,CACxB,EACD,gBAED,EACF,GACF,GACF,GACF,EACF,GACF,EACF,IAGHgS,UACE,OAAI,UAAU,qEACb,SAAAzyD,MAACre,GAAA,CAAU,YAAW,GACpB,SAAAoe,OAAC,OACC,UAAU,4FACV,KAAK,SACL,aAAW,OAEX,UAAAC,MAAC,UACC,UAAU,0EACV,QAAS,IAAM0yD,GAAoB,EAAK,EACxC,aAAW,uBACZ,yBAGA,MAAG,UAAU,4DAA4D,mBAE1E,EACA3yD,OAAC,OAAI,UAAU,wCAEb,UAAAA,OAAC,OAAI,UAAU,8BACb,gBAAC,MAAG,UAAU,6BAA6B,kBAAM,EACjDA,OAACwhD,GAAA,CACC,WAAW,wBACX,UAAU,gDACV,aAAc,IACd,cAAe,IACf,SAAU,IACV,UAAW,IACX,SAAU,IACV,UAAW,IAEX,UAAAvhD,MAAC+2D,GAAA,EAAe,GACd,IAAM,CAIN,MAAMyF,GAFHxlD,GAAgB,WAAW,eAAiB,SAC7C,MAEE,wFACA,uJACE0oD,EAAqB,IACzB3/D,OAAC,OAAI,UAAU,wCACb,UAAAC,MAAC,SACC,IAAK2oD,GACL,UAAW6T,EACX,MAAO,WACP,YAAW,GACX,MAAK,GACL,SAAQ,KAEVx8D,MAAC,UACC,IAAKgrB,EACL,UAAU,iCACV,QAAS6J,EAAA,GAEX90B,OAAC,OACC,UAAU,wEACV,aAAY,iBAAiBsrD,GAAe,CAAC,EAAKA,GAAe,CAAC,EAAE,MAAQ,EAAI,MAAQ,OAAU,SAAS,KAAKA,GAAe,CAAC,EAAKA,GAAe,CAAC,EAAE,MAAQ,EAAI,MAAQ,OAAU,SAAS,KAAKA,GAAe,CAAC,EAAKA,GAAe,CAAC,EAAE,MAAQ,EAAI,MAAQ,OAAU,SAAS,GAEhR,WAAC,EAAG,EAAG,CAAC,EAAE,IAAKxrE,GAAM,CACpB,MAAMrC,EAAI6tE,GAAexrE,CAAC,EACpB+/E,GAAY,CAACpiF,EACbyiF,GACJ,CAAC,CAACziF,IACD,OAAOA,EAAE,OAAU,SAChBA,EAAE,MAAQ,EACV,IACAu3B,GAAQ6qD,GACV,iBACAK,GACE,iBACA,cACN,OACEjgE,MAAC,QAEC,UAAW,+BAA+B+U,EAAK,IAD1Cl1B,CAAA,CAIX,CAAC,EACAgyD,IAAoB+gB,KAAiB,MACpC7yD,OAAC,QAAK,UAAU,mEACb,eAAK,IAAI,EAAG6yD,EAAY,EAAE,KAC7B,KAGHxG,IAAqBJ,GACpBhsD,MAAC,OAAI,UAAU,kIAAkI,oCAEjJ,EACE,MACN,EAEF,OAAI4oD,GACGE,GA2CE4W,EAAA,QAzCF,OAAI,UAAU,8GACb,SAAA3/D,OAAC,OAAI,UAAU,yCACb,gBAAC,OAAI,UAAU,yBAAyB,eAExC,QACC,OAAI,UAAU,sCAAsC,iCAErD,QACC,KAAE,UAAU,yBAAyB,uEAGtC,EACAA,OAAC,OAAI,UAAU,mDACb,UAAAC,MAAC,UACC,UAAU,iEACV,QAASqzD,GACV,6BAGDrzD,MAAC,UACC,UAAU,mEACV,QAAS,IAAM,CACb,GAAI,CACFgtB,GAAc,iBAAiB,EAAI,CACrC,MAAY,CAAC,CACf,EACD,0BAGDhtB,MAAC,UACC,UAAU,uEACV,QAASq8D,GACT,SAAU,CAACrU,GAAiB,OAC7B,6BAED,EACF,GACF,EACF,EAKC0X,EAAA,CACT,IAAG,IAEL3/D,OAAC,OAAI,UAAU,yCACZ,UAAA6oD,GACC7oD,OAAAja,WAAA,CACE,UAAAka,MAAC,OACC,UAAW,yDAAyD8oD,GAAkB,2DAA6D,oDAAoD,GAEtM,YACG,gCACA,uCAEN9oD,MAAC,UACC,UAAU,iEACV,QAASqzD,GACV,6BAGDrzD,MAAC,UACC,UAAU,mEACV,QAAS,IAAM,CACb,GAAI,CACFgtB,GAAc,iBACZ,CAACA,GAAc,YAEnB,MAAY,CAAC,CACf,EAEC,SAAAA,GAAc,YACX,eACA,iBAENhtB,MAAC,UACC,UAAU,iEACV,SAAU,CAAC8oD,GACX,QAAS,IAAM,CACb,GAAI,CACF97B,GAAc,gBAChB,MAAY,CAAC,CACf,EACD,6BAGAknC,IACCl0D,MAAC,UACC,UAAU,uEACV,QAASq8D,GACT,SAAU,CAACrU,GAAiB,OAC7B,6BAED,EAEJ,EAEAhoD,MAAAla,WAAA,CACG,SAACmoB,EAQAjO,MAAC,UACC,UAAU,sEACV,QAASozB,GACV,yBAVDpzB,MAAC,UACC,UAAU,0EACV,QAASo0B,GACV,4BAWL,EAEFp0B,MAAC,UACC,UAAU,0EACV,QAAS88D,GACT,SAAU,CAAC/T,GACZ,2BAGD/oD,MAAC,UACC,UAAU,wEACV,QAAS,IAAM,CACb,GAAI,CACF,OAAO,cACL,IAAI,MAAM,kBAAyB,EAEvC,MAAY,CAAC,CACf,EACD,8BAED,EACF,GACF,EAEAD,OAAC,OAAI,UAAU,8BACb,UAAAA,OAAC,OAAI,UAAU,+BACb,gBAAC,MAAG,UAAU,wBAAwB,yBAAa,EACnDA,OAAC,OAAI,UAAU,qDACb,UAAAC,MAAC,QACC,UAAW,yCAAyCmqD,GAAmB,iBAAmB,aAAa,WAExG,QACE,SAAAA,GACG,gBACA,mBACN,GACF,GACF,QACC,OAAI,UAAU,0BAA0B,oCAEzC,EACApqD,OAAC,OAAI,UAAU,+BACZ,WAAC,EAAG,EAAG,CAAC,EAAE,IAAKlgB,GAAM,CACpB,MAAMrC,EAAI6tE,GAAexrE,CAAC,EACpB+/E,EAAY,CAACpiF,EACbyiF,EACJ,CAAC,CAACziF,IACD,OAAOA,EAAE,OAAU,SAAWA,EAAE,MAAQ,EAAI,IACzCu3B,EAAQ6qD,EACV,iBACAK,EACE,iBACA,cACN,OACEjgE,MAAC,QAEC,UAAW,mCAAmC+U,CAAK,IAD9Cl1B,CAAA,CAIX,CAAC,EACAgyD,IAAoB+gB,KAAiB,MACpC7yD,OAAC,QAAK,UAAU,wEACb,eAAK,IAAI,EAAG6yD,EAAY,EAAE,KAC7B,GAEJ,EACA5yD,MAAC,MAAG,UAAU,8BACX,SAAAqrD,GAAe,SAAW,EACzBrrD,MAAC,MAAG,UAAU,aAAa,wBAAY,EAEvCqrD,GAAe,IAAI,CAAC7tE,EAAGqC,IAAMmgB,MAAC,MAAY,SAAAxiB,EAAE,OAANqC,CAAY,CAAK,EAE3D,EACAkgB,OAAC,OAAI,UAAU,+BACb,UAAAA,OAAC,OAAI,UAAU,gBAAgB,oBAAQirD,GAAa,MAAE,EACtDjrD,OAAC,OAAI,UAAU,gBAAgB,oBAAQorD,EAAA,EAAa,GACtD,EACAprD,OAAC,OAAI,UAAU,aACb,UAAAC,MAAC,UACC,UAAU,0EACV,QAASo/D,GACT,SAAUpU,KAAiB,EAC5B,uBAGDhrD,MAAC,UACC,UAAU,4EACV,QAASq/D,GACT,SAAUrU,KAAiB,GAAKW,EAChC,cAAY,mBACb,0BAGD3rD,MAAC,UACC,UAAU,wEACV,QAAS8wD,GACT,SAAU9F,KAAiB,EAC5B,kBAED,EACF,GACF,GACF,IACF,CACF,EACF,GAGJ,EAGI9I,GAAUqa,GAAA,EAChB,OAAOrV,GAAoBhF,GAAUA,GAAUsd,EACjD,CAAC,2GCn7ND,SAAwBU,GAAc,CACpC,KAAA5tE,EACA,MAAAG,EACA,UAAApP,EAAY,GACZ,OAAA88E,EAAS,EACX,EAKG,CACD,OACEpgE,OAAC,OACC,UAAW,GAAGogE,EAAS,eAAiB,EAAE,qKAAqK98E,CAAS,GAExN,UAAA2c,MAAC,OAAI,UAAU,0GAA0G,EACzHD,OAAC,OAAI,UAAU,oEACZ,UAAAzN,EAAK,OACR,EACA0N,MAAC,OAAI,UAAU,gDACZ,SAAAvN,CAAA,CACH,IAGN,CCqCA,SAAwB2tE,GAAe,CACrC,SAAA3pD,EACA,QAAA4N,EACA,WAAAg8C,EACA,UAAWC,CACb,EAAwB,CACtB,MAAI,CAACj8C,GAAWA,EAAQ,SAAW,EAAU,KAG3CrkB,MAAC,OAAI,UAAU,qCACZ,WAAQ,IAAI,CAAC4jB,EAAQ3f,IACpBlE,OAAC,OAEC,UAAW,gCACT6jB,EAAO,cACH,0CACA,qCACN,GAEA,UAAA5jB,MAAC,OACC,UAAW,sDACT4jB,EAAO,cAAgB,mBAAqB,gBAC9C,GAEC,SAAAA,EAAO,OAGV7jB,OAAC,OAAI,UAAU,0DAEZ,UAAA0W,IAAa,OACZ1W,OAAAja,WAAA,CACE,UAAAka,MAACugE,GAAA,CACC,MAAM,WACN,MAAO,KAAK38C,EAAO,SAAW,CAAC,GAC/B,UAAS,KAEX5jB,MAACugE,GAAA,CACC,MAAM,YACN,MAAO38C,EAAO,OAAS,EACvB,KAAI,GACJ,KAAI,KAEN5jB,MAACugE,GAAA,CACC,MAAM,aACN,MAAO38C,EAAO,WAAa,IAC3B,KAAI,KAELA,EAAO,MAAQ,QACd5jB,MAACugE,GAAA,CACC,MAAM,aACN,MAAO,OAAO38C,EAAO,KAAO,CAAC,EAAE,QAAQ,CAAC,EACxC,KAAI,GACJ,KAAI,KAGR5jB,MAACugE,GAAA,CACC,MAAM,aACN,MAAO,GAAG38C,EAAO,cAAgB,CAAC,IAClC,KAAI,KAEN5jB,MAACugE,IAAS,MAAM,WAAW,MAAO38C,EAAO,SAAW,IAAK,KAAI,GAAC,EAE7DA,EAAO,WAAa,QACnBA,EAAO,aAAe,QACpB5jB,MAAAla,WAAA,CACE,SAAAia,OAAC,OAAI,UAAU,qCACb,UAAAC,MAACugE,GAAA,CACC,MAAM,YACN,MAAO38C,EAAO,SAAS,QAAQ,CAAC,EAChC,KAAI,GACJ,KAAI,GACJ,UAAWA,EAAO,SAAW,IAE/B5jB,MAACwgE,GAAA,CACC,SAAU58C,EAAO,SACjB,WAAYA,EAAO,YACrB,EACF,EACF,GAEN,GAIAnN,IAAa,WAAaA,IAAa,qBACvC1W,OAAAja,WAAA,CACE,UAAAka,MAACugE,GAAA,CACC,MAAM,SACN,MAAOE,GAAoB78C,EAAO,MAAM,EACxC,KAAI,KAEN5jB,MAACugE,GAAA,CAAS,MAAM,SAAS,MAAO38C,EAAO,QAAU,EAAG,KAAI,GAAC,KAAI,GAAC,EAC9D5jB,MAACugE,GAAA,CACC,MAAM,SACN,MAAOG,GAAiB98C,CAAM,EAC9B,UAAWA,EAAO,eACpB,EACF,GAIAnN,IAAa,YAAcA,IAAa,aACxC1W,OAAAja,WAAA,CACE,UAAAka,MAACugE,GAAA,CACC,MAAO9pD,IAAa,WAAa,QAAU,QAC3C,MAAOmN,EAAO,OAAS,EACvB,KAAI,KAEN5jB,MAACugE,IAAS,MAAM,SAAS,MAAO38C,EAAO,QAAU,IAAK,KAAI,GAAC,EAC3D5jB,MAACugE,GAAA,CAAS,MAAM,QAAQ,MAAO38C,EAAO,OAAS,EAAG,KAAI,GAAC,KAAI,GAAC,GAC9D,EAIDnN,IAAa,UACZ1W,OAAAja,WAAA,CACE,UAAAka,MAACugE,GAAA,CACC,MAAM,WACN,MAAO38C,EAAO,QAAU,IACxB,KAAI,GACJ,KAAI,KAEN5jB,MAACugE,GAAA,CAAS,MAAM,QAAQ,MAAO38C,EAAO,OAAS,EAAG,KAAI,GAAC,KAAI,GAAC,EAC3DA,EAAO,YACN5jB,MAACugE,GAAA,CACC,MAAM,SACN,MAAM,aACN,UAAW,IACb,EAEJ,EAID9pD,IAAa,YACZ1W,OAAAja,WAAA,CACE,UAAAka,MAACugE,GAAA,CAAS,MAAM,QAAQ,MAAO38C,EAAO,OAAS,EAAG,KAAI,GAAC,EACvD5jB,MAACugE,IAAS,MAAM,SAAS,MAAO38C,EAAO,QAAU,OAAQ,KAAI,GAAC,EAC9D5jB,MAACugE,GAAA,CAAS,MAAM,QAAQ,MAAO38C,EAAO,OAAS,EAAG,KAAI,GAAC,KAAI,GAAC,GAC9D,GAIAnN,IAAa,mBACbA,IAAa,mBACbA,IAAa,qBACb1W,OAAAja,WAAA,CACE,UAAAka,MAACugE,GAAA,CACC,MAAM,SACN,MAAO38C,EAAO,QAAU,IACxB,KAAI,GACJ,KAAI,KAEN5jB,MAACugE,GAAA,CAAS,MAAM,OAAO,MAAO38C,EAAO,MAAQ,EAAG,KAAI,GAAC,KAAI,GAAC,EACzDA,EAAO,aACN5jB,MAACugE,GAAA,CACC,MAAM,WACN,MAAO,GAAG38C,EAAO,MAAQ,CAAC,MAAMA,EAAO,WAAW,GAClD,KAAI,IACN,EAEJ,GAIAnN,IAAa,YACbA,IAAa,cACbA,IAAa,cACb1W,OAAAja,WAAA,CACE,UAAAka,MAACugE,GAAA,CAAS,MAAM,QAAQ,MAAO38C,EAAO,OAAS,EAAG,KAAI,GAAC,EACvD5jB,MAACugE,GAAA,CAAS,MAAM,QAAQ,MAAO38C,EAAO,OAAS,EAAG,KAAI,GAAC,KAAI,GAAC,EAC3DnN,IAAa,cACZzW,MAACugE,GAAA,CAAS,MAAM,OAAO,MAAO38C,EAAO,WAAa,EAAG,KAAI,GAAC,GAE9D,GAIAnN,IAAa,gBAAkBA,IAAa,iBAC5C1W,OAAAja,WAAA,CACE,UAAAka,MAACugE,GAAA,CACC,MAAM,YACN,MAAO38C,EAAO,WAAa,EAC3B,KAAI,GACJ,KAAI,KAEN5jB,MAACugE,IAAS,MAAM,WAAW,MAAO38C,EAAO,UAAY,EAAG,KAAI,GAAC,EAC7D5jB,MAACugE,GAAA,CACC,MAAM,YACN,MAAO38C,EAAO,WAAa,EAC3B,KAAI,IACN,EACF,EAIDnN,IAAa,YACZ1W,OAAAja,WAAA,CACE,UAAAka,MAACugE,GAAA,CACC,MAAM,SACN,MAAO,IAAI38C,EAAO,QAAU,CAAC,GAC7B,KAAI,GACJ,KAAI,KAEN5jB,MAACugE,GAAA,CAAS,MAAM,QAAQ,MAAO38C,EAAO,OAAS,EAAG,KAAI,GAAC,KAAI,GAAC,GAC9D,EAIDnN,IAAa,YACZ1W,OAAAja,WAAA,CACE,UAAAka,MAACugE,GAAA,CAAS,MAAM,SAAS,MAAO38C,EAAO,QAAU,EAAG,KAAI,GAAC,EACzD5jB,MAACugE,GAAA,CAAS,MAAM,QAAQ,MAAO38C,EAAO,OAAS,EAAG,KAAI,GAAC,KAAI,GAAC,GAC9D,EAGDnN,IAAa,QACZ1W,OAAAja,WAAA,CACE,UAAAka,MAACugE,GAAA,CAAS,MAAM,OAAO,MAAO38C,EAAO,MAAQ,EAAG,KAAI,GAAC,EACrD5jB,MAACugE,GAAA,CACC,MAAM,UACN,MAAO38C,EAAO,SAAW,EACzB,KAAI,GACJ,KAAI,IACN,EACF,EAIDnN,IAAa,eACZ1W,OAAAja,WAAA,CACE,UAAAka,MAACugE,GAAA,CAAS,MAAM,OAAO,MAAO38C,EAAO,MAAQ,EAAG,KAAI,GAAC,EACpDA,EAAO,QACN5jB,MAACugE,GAAA,CAAS,MAAM,SAAS,MAAM,UAAU,UAAS,GAAC,GAEvD,EAIDF,IACE5pD,IAAa,OACZA,IAAa,WACbA,IAAa,qBACfxS,IAAQ,GACNjE,MAAC,OAAI,UAAU,qCACb,SAAAA,MAACugE,GAAA,CACC,MAAM,QACN,MAAOF,EACP,KAAI,GACJ,KAAI,GACJ,UAAS,IACX,CACF,GAEN,IAlPKp8D,CAAA,CAoPR,EACH,CAEJ,CAGA,SAASs8D,GAAS,CAChB,MAAA3gE,EACA,MAAAphB,EACA,KAAAmiF,EAAO,GACP,KAAAC,EAAO,GACP,UAAAC,EAAY,EACd,EAMG,CACD,OACE9gE,OAAC,OAAI,UAAU,uBACb,UAAAA,OAAC,QAAK,UAAU,aAAc,UAAAH,EAAM,QAAI,EACxCI,MAAC,QACC,UAAW,GAAG2gE,EAAO,YAAc,EAAE,IAAIC,EAAO,gBAAkB,EAAE,IAClEC,EAAY,mBAAqB,EACnC,GAEC,SAAAriF,CAAA,EACH,EACF,CAEJ,CAGA,SAASgiF,GAAiB,CACxB,SAAAM,EACA,WAAAC,CACF,EAGG,CACD,MAAMv+D,EAAOs+D,EAAWC,EAClBC,EAAax+D,EAAO,EACpBy+D,EAAY,KAAK,IAAIz+D,CAAI,EAAI,IAEnC,IAAI0+D,EAAW,GACXC,EAAY,iBAEhB,OAAIF,GACFC,EAAW,gBACXC,EAAY,kBACHH,GACTE,EAAW,IAAI1+D,EAAK,QAAQ,CAAC,CAAC,aAC9B2+D,EAAY,qBAEZD,EAAW,GAAG1+D,EAAK,QAAQ,CAAC,CAAC,aAC7B2+D,EAAY,mBAIZphE,OAAC,OAAI,UAAU,uBACb,UAAAC,MAAC,QAAK,UAAU,aAAa,0BAAc,QAC1C,QAAK,UAAW,2BAA2BmhE,CAAS,GAAK,SAAAD,CAAA,CAAS,GACrE,CAEJ,CAGA,SAAST,GAAoBW,EAAyC,CACpE,MAAI,CAACA,GAAU,OAAO,KAAKA,CAAM,EAAE,SAAW,EAAU,IAClC,OAAO,QAAQA,CAAM,EACxC,OAAO,CAAC,CAACx1E,EAAGynB,CAAK,IAAMA,IAAU,CAAC,EAClC,IAAI,CAAC,CAACgqD,CAAG,IAAOA,IAAQ,KAAO,IAAMA,CAAI,EACzC,KAAK,GAAG,GACa,GAC1B,CAEA,SAASqD,GAAiB98C,EAA6B,CACrD,GAAI,CAACA,EAAO,OAAQ,MAAO,cAC3B,MAAMy9C,EAAc,OAAO,OAAOz9C,EAAO,MAAM,EAAE,OAC9CzmC,GAAMA,IAAM,GACb,OACF,OAAIkkF,IAAgB,EAAU,cAC1BA,EAAc,EAAU,GAAGA,CAAW,QACnC,eACT,CCrYA,SAASC,MAAQpgE,EAAa,CAC5B,OAAOA,EAAK,OAAO,OAAO,EAAE,KAAK,GAAG,CACtC,CAgBA,SAAwBqgE,GAAW1/E,EAAwB,CACzD,KAAM,CACJ,MAAA+d,EACA,UAAA4hE,EACA,eAAA9Z,EAAiB,GACjB,MAAO+Z,EACP,UAAAp+E,EACA,OAAAunB,EAAS,UACT,MAAAtK,EACA,KAAA+F,EAAO,GACP,oBAAqBq7D,CAAA,EACnB7/E,EAEEipC,EAAW1oC,SAAyB,IAAI,EACxC4qC,EAAgBhf,GAAA,EAChB,CAACC,EAAWqd,CAAY,EAAI1sC,WAAS,EAAK,EAC1C,CAAC6vB,EAAIuiB,CAAK,EAAIpyC,WAA2B,IAAI,EAC7C,CAACiyC,EAAUC,CAAW,EAAIlyC,WAAwB,IAAI,EACtDmyC,EAAc3uC,SAAsB,IAAI,EACxC,CAACosB,EAAImzD,CAAK,EAAI/iF,WAAmC,IAAI,EACrDgjF,EAAwBx/E,SAAgC,IAAI,EAElEuX,YAAU,IAAM,CACdo3B,EAAY,QAAUF,CACxB,EAAG,CAACA,CAAQ,CAAC,EAEb,MAAMgxC,EAAiBt9E,cACrB,CAACgqB,EAA4BuzD,EAAiC,UAAY,CACxE,GAAI,CACEvzD,GACFye,EAAc,eAAeze,CAAM,EACnCye,EAAc,QAAQ80C,CAAY,EAClC90C,EAAc,aAAa,EAAI,EAC/B40C,EAAsB,QAAUE,GAEhCF,EAAsB,SACtBA,EAAsB,UAAY,UAElC50C,EAAc,aAAa,EAAK,EAChCA,EAAc,eAAe,IAAI,EACjC40C,EAAsB,QAAU,KAEpC,MAAc,CAAC,CACjB,EACA,CAAC50C,CAAa,GAGV+0C,EAAoBx9E,cAAY,SAAY,CAChD,GAAI,CACF,MAAM2U,EAAI4xB,EAAS,QACnB,GAAI,CAAC5xB,EAAG,MAAO,GACf,MAAMkY,EAAI4b,EAAc,oBAAsB,KACxCg1C,IAAc5wD,GAAG,oBAAsB,IAAI,OAC9CrzB,IAAwBA,GAAE,aAAe,QAE5C,GAAI,CAACqzB,GAAK4wD,GAAW,SAAW,EAAG,MAAO,GAE1C,MAAMjmE,GAAM,MAAMujD,GAAiB,CACjC,MAAOpmD,EACP,OAAQkY,EACR,YAAc5zB,IAAW,QAAQ,KAAK,4BAA6BA,EAAC,EACrE,EAED,GADA8tC,EAAa,CAAC,CAACvvB,GAAI,MAAM,EACrBA,GAAI,OACN,GAAI,CACF,MAAMvJ,GAAUw6B,EAAc,wBAC1B,CAACx6B,IAAWA,KAAY0G,IAC1B8zB,EAAc,qBAAqB9zB,CAAC,CAExC,MAAQ,CAAC,CAEX,MAAO,CAAC,CAAC6C,GAAI,MACf,MAAQ,CACN,MAAO,EACT,CACF,EAAG,CAACixB,CAAa,CAAC,EAEZzD,EAAuBvS,GAC1B5F,GAAWA,EAAE,sBAEV,CAACjD,EAAMsd,CAAO,EAAI7sC,WAAqC,IACvD2qC,IAAyB,eAAuB,QACtC,aAAa,QAAQ,iBAAiB,GACpC,OACjB,EAEK,CAACiI,EAASC,CAAU,EAAI7yC,WAAwB,IAAI,EACpD,CAAC8yC,EAAWC,CAAY,EAAI/yC,WAGxB,IAAI,EAEd+a,YAAU,IAAM,CACd,aAAa,QAAQ,kBAAmBwU,CAAI,CAC9C,EAAG,CAACA,CAAI,CAAC,EAETxU,YAAU,IAAM,CACd,MAAMlc,EAAI,OAAO,SAAS,UACtBA,IAAM,aAAeA,IAAM,cAC7Bge,GAAS,YAAY,EAClB,KAAM3d,GAAMA,EAAE,MAAM,EACpB,KAAM4N,GAAW,CAChB,MAAM60B,GAAK,MAAM,QAAQ70B,GAAG,KAAK,GAAKA,EAAE,MAAM,KAAMnL,IAAcA,EAAC,EAC/DggC,MAAeA,EAAE,CACvB,CAAC,EACA,MAAM,IAAM,CAAC,CAAC,EAEnB9kB,GAAS,iBAAiB,EACvB,KAAM3d,GAAMA,EAAE,MAAM,EACpB,KAAM4N,GAAW,CACZA,GAAK,OAAOA,EAAE,OAAU,WAC1BimC,EAAa,CAAE,MAAO,CAAC,CAACjmC,EAAE,MAAO,KAAM,OAAOA,EAAE,IAAI,GAAK,KAAM,CACnE,CAAC,EACA,MAAM,IAAM,CAAC,CAAC,CACnB,EAAG,EAAE,EAEL,MAAM2mC,EAAYzsC,UAAQ,IAAM,CAC9B,MAAMwoB,EAAOyiB,GAAY,OACnB71B,EAAOw2B,GAAW,OAAO,SAAS,SAClC/K,GAAQiL,GAAW,MAAQ,QAAU,OACrC7Q,GAAO6Q,GAAW,MAAQA,EAAU,KAAO,KACjD,MAAO,GAAGjL,EAAK,MAAMzrB,CAAI,IAAI6lB,EAAI,yBAAyBzS,CAAI,EAChE,EAAG,CAACyiB,EAAUW,EAASE,CAAS,CAAC,EAEjC,SAAS4B,IAAW,CAClB,GAAI7kB,GAAMA,EAAG,aAAe,UAAU,KAAM,OAAOA,EACnD,MAAM9S,EAAM+qB,GAAA,EACN8M,EAAS,IAAI,UAAU73B,CAAG,EAChC,OAAAq1B,EAAMwC,CAAM,EACLA,CACT,CAEA,MAAMH,GAAoB9uC,cAAY,IAAM,CAC1CknC,EAAQ,OAAO,EACf,MAAM+H,EAASF,GAAA,EACXE,EAAO,aAAe,UAAU,KAClCA,EAAO,KAAK,KAAK,UAAU,CAAE,KAAM,aAAc,CAAC,EAElDA,EAAO,OAAS,IAAMA,EAAO,KAAK,KAAK,UAAU,CAAE,KAAM,aAAc,CAAC,EAE1EA,EAAO,UAAY,MAAOxQ,GAAO,CAC/B,MAAM3iC,GAAO,KAAK,MAAM2iC,EAAG,IAAI,EAC/B,GAAI3iC,GAAK,OAAS,WAChBywC,EAAYzwC,GAAK,IAAI,EACrB0wC,EAAY,QAAU1wC,GAAK,aAClBA,GAAK,OAAS,kBAAmB,CAC1C,MAAMwzC,GAAO,IAAI,kBAAkB,CACjC,WAAY,CAAC,CAAE,KAAM,+BAAgC,EACtD,EACD8tC,EAAM9tC,EAAI,EACVA,GAAK,eAAkBr2C,IAAM,CACvBA,GAAE,WAAauzC,EAAY,SAC7ByC,EAAO,KACL,KAAK,UAAU,CACb,KAAM,UACN,KAAMzC,EAAY,QAClB,QAASvzC,GAAE,UACZ,EAEP,EACAq2C,GAAK,QAAW7Q,IAAO,CACjB8H,EAAS,SAAW9H,GAAG,UAAU,CAAC,IACpC8H,EAAS,QAAQ,UAAY9H,GAAG,QAAQ,CAAC,EACzC8H,EAAS,QAAQ,OAAO,MAAM,IAAM,CAAC,CAAC,EACtC+2C,EAAe7+C,GAAG,QAAQ,CAAC,EAAG,OAAO,EACrCsI,EAAa,EAAI,EAErB,EACA,MAAMnL,GAAQ,MAAM0T,GAAK,YAAY,CAAE,oBAAqB,GAAM,EAClE,MAAMA,GAAK,oBAAoB1T,EAAK,EAChC4Q,EAAY,SACdyC,EAAO,KACL,KAAK,UAAU,CACb,KAAM,YACN,KAAMzC,EAAY,QAClB,QAAS5Q,EAAA,CACV,EAEP,SAAW9/B,GAAK,OAAS,cAAgBmuB,EACvC,MAAMA,EAAG,qBAAqB,IAAI,sBAAsBnuB,GAAK,OAAO,CAAC,UAC5DA,GAAK,OAAS,WAAamuB,EACpC,GAAI,CACF,MAAMA,EAAG,gBAAgBnuB,GAAK,OAAO,CACvC,MAAQ,CAAC,CAEb,CACF,EAAG,CAACwhF,EAAgBrzD,EAAIC,CAAE,CAAC,EAErBwzD,GAAa19E,cAAY,SAAY,CAC9B,MAAMw9E,EAAA,GAEf,OAAO,cACL,IAAI,YAAY,mBAAoB,CAAE,OAAQ,CAAE,KAAM,QAAQ,CAAG,EAGvE,EAAG,CAACA,CAAiB,CAAC,EAEhBG,GAAmB39E,cACtB49E,GAAoB,CACnB12C,EAAQ02C,CAAc,EAClBA,IAAY,QAASF,GAAA,EAChBE,IAAY,SAAS9uC,GAAA,CAChC,EACA,CAAC4uC,GAAY5uC,EAAiB,GAGhC15B,YAAU,IAAM,EACV6nE,GAAa9Z,KACXv5C,IAAS,QAAS8zD,GAAA,EACb9zD,IAAS,SAASklB,GAAA,EAE/B,EAAG,CAACmuC,EAAW9Z,EAAgBv5C,EAAM8zD,GAAY5uC,EAAiB,CAAC,EAInE,MAAMw1B,GAAmB77B,EAAc,YACjCsV,GAAgBtV,EAAc,mBAEpCrzB,mBAAU,IAAM,CACd,GAAIkvD,IAAoBvmB,GAAe,CAKrC,GAAI,CACF,MAAMppC,EAAI4xB,EAAS,QACf5xB,GAAKA,EAAE,YAAcopC,KACvBppC,EAAE,UAAYopC,GACdppC,EAAE,OAAO,MAAM,IAAM,CAAC,CAAC,EAGvBoyB,EAAa,EAAI,EAErB,MAAQ,CAAC,CAGTy2C,EAAA,CACF,CACF,EAAG,CAAClZ,GAAkBvmB,GAAey/B,CAAiB,CAAC,EAGrD/hE,MAACoiE,GAAA,CACE,GAAGvgF,EACJ,SAAAipC,EACA,UAAA7c,EACA,KAAAE,EACA,SAAA0iB,EACA,UAAAwB,EACA,kBAAAgB,GACA,aAAc6uC,EAAA,EAGpB,CAEA,SAASE,GAAYvgF,EAAY,CAC/B,KAAM,CACJ,SAAAipC,EACA,UAAA7c,EACA,KAAAE,EACA,SAAA0iB,EACA,UAAAwB,EACA,kBAAAgB,EACA,MAAAzzB,EACA,KAAAyG,EACA,UAAAhjB,EACA,MAAAid,EACA,MAAO+hE,EACP,OAAAz3D,EAAS,UACT,oBAAA03D,CAAA,EACEzgF,EACE,CACJ,YAAAqsD,EACA,aAAcq0B,EACd,cAAeC,CAAA,EACbxrD,GAAA,EACEwkC,EAAep5D,SAAuB,IAAI,EAC1C8lE,EAAmB9lE,SAA0B,IAAI,EACjD,CAACqgF,EAAmBC,CAAoB,EAAI9jF,WAAS,EAAK,EAE1D+jF,EAAqBp+E,cAAY,IAAM,CAC3C,GAAI,CAACi3D,EAAa,QAAS,MAAO,GAClC,MAAM19D,EAAI09D,EAAa,QAAQ,wBAC/B,OACE19D,EAAE,MAAQ,GACVA,EAAE,OAAS,GACXA,EAAE,KAAO,OAAO,aAAe,MAC/BA,EAAE,OAAS,CAEf,EAAG,EAAE,EAEC8kF,EACJN,IAAwBj8D,EAAO,OAASm8D,GAAiB,QACrD73D,EAAQ,OAAO03D,GAAan0B,GAAe,CAAC,EAE5C20B,EACJx8D,GAAQu8D,IAAqB,OACzB,OACAh4D,GAAUA,IAAW,UACnBA,EACC23D,GAAwB,OAE3BO,EACJD,IAAiB,SACb,gBACAA,IAAiB,WACf,eACAA,IAAiB,UACf,eACAA,IAAiB,OACf,SACA,eAEZlpE,mBAAU,IAAM,CACd,IAAI8G,EAAM,EACNsiE,EAAU,GACVjN,EAAe,EAGnB,MAAMI,EAAW,IAAM,CACrB,GAAI,CAAC6M,EAAS,OACd,MAAM7pE,EAAI4xB,EAAS,QACb3tC,EAAI+qE,EAAiB,QACrB8a,GACJ9pE,IAAMupE,GAAsBvpE,EAAE,WAAa,GAAKA,EAAE,WAAa,GAEjE,GAAIA,GAAK/b,GAAK6lF,GAAa,CACzB,MAAMluD,GAAM33B,EAAE,WAAW,KAAM,CAAE,MAAO,GAAO,EAC3C23B,IAAO5b,EAAE,WAAa,IAKpB/b,EAAE,QAAU+b,EAAE,aAChB/b,EAAE,MAAQ+b,EAAE,WACZ/b,EAAE,OAAS+b,EAAE,aAEf4b,GAAI,UAAU5b,EAAG,EAAG,CAAC,EACrB/b,EAAE,MAAM,WAAa,UAEzB,MAAWA,IACTA,EAAE,MAAM,WAAa,UAEvBsjB,EAAM,sBAAsBy1D,CAAQ,CACtC,EACA,OAAAz1D,EAAM,sBAAsBy1D,CAAQ,EAEpCJ,EAAe,OAAO,YAAY,IAAM,CACtC,MAAM58D,EAAI4xB,EAAS,QACnB,GAAI5xB,GAAKA,EAAE,WAAa,GAAKypE,IAAsB,CACjD,MAAMjtD,EAAS,SAAS,cAAc,QAAQ,EAC9CA,EAAO,MAAQ,GACfA,EAAO,OAAS,GAChB,MAAMZ,GAAMY,EAAO,WAAW,KAAM,CAClC,MAAO,GACP,mBAAoB,GACrB,EACD,GAAIZ,GACF,GAAI,CACFA,GAAI,UAAU5b,EAAG,EAAG,EAAG,GAAI,EAAE,EAC7B,MAAM7Y,GAAOy0B,GAAI,aAAa,EAAG,EAAG,GAAI,EAAE,EAAE,KAC5C,IAAIrS,GAAM,EACV,QAAS5iB,GAAI,EAAGA,GAAIQ,GAAK,OAAQR,IAAK,EACpC4iB,IACE,KAAQpiB,GAAKR,EAAC,EAAI,KAAQQ,GAAKR,GAAI,CAAC,EAAI,KAAQQ,GAAKR,GAAI,CAAC,EAClD4iB,IAAO,IAAU,KACnB,IAAMigE,EAAqB,EAAI,IACf,EAAK,CACjC,MAAY,CAAC,CAEjB,CACF,EAAG,GAAI,EAEA,IAAM,CACXK,EAAU,GACV,qBAAqBtiE,CAAG,EACxB,OAAO,cAAcq1D,CAAY,CACnC,CACF,EAAG,CAAChrC,EAAU63C,EAAoBF,CAAiB,CAAC,EAGlD1iE,OAAC,OACC,IAAKy7C,EACL,UAAW8lB,GACT,iFACAj+E,EACAgjB,GAAQ,iBAEV,MAAA/F,EAEA,UAAAP,OAAC,OAAI,UAAWuhE,GAAK,kBAAmBwB,CAAW,EACjD,UAAA9iE,MAAC,SACC,IAAK8qB,EACL,SAAQ,GACR,YAAW,GACX,MAAK,GACL,UAAWw2C,GACT,gBACAsB,IAAqB,OAAS,eAAiB,iBAC/CH,EAAoB,qBAAuB,SAE7C,MAAO,CAAE,UAAW,SAAS93D,CAAK,IAAI,GAExC3K,MAAC,UACC,IAAKkoD,EACL,UAAWoZ,GACT,0CACAsB,IAAqB,OAAS,eAAiB,kBAEjD,MAAO,CAAE,WAAY,SAAU,UAAW,SAASj4D,CAAK,IAAI,EAC9D,EACF,EAEA5K,OAAC,OAAI,UAAU,gDACb,UAAAC,MAAC,OAAI,UAAU,qGACb,eAACpD,GAAA,CAAO,KAAM,GAAI,EACpB,EACAmD,OAAC,OAAI,UAAU,gBACb,UAAAC,MAAC,QAAK,UAAU,gEAAgE,qBAEhF,EACAA,MAAC,QAAK,UAAU,oCACb,YAASmO,CAAA,CACZ,GACF,GACF,EACCF,GACClO,OAAC,OAAI,UAAU,yHACb,UAAAC,MAAC,OAAI,UAAU,oDAAoD,EACnEA,MAAC,QAAK,UAAU,+DAA+D,gBAE/E,GACF,IAIR,CChcA,MAAMijE,GAAY,CAAC,CAAE,MAAArjE,EAAO,MAAAphB,KAC1BuhB,OAAC,OAAI,UAAU,mCACb,UAAAC,MAAC,OAAI,UAAU,0EACZ,SAAAJ,EACH,EACAI,MAAC,OAAI,UAAU,+CAAgD,SAAAxhB,CAAA,CAAM,GACvE,EAcF,SAAwB0kF,GAAmB,CACzC,KAAA9nB,EAAO,GACP,QAAA/2B,EACA,KAAApsB,EACA,eAAAkrE,EAAiB,GACjB,gBAAAC,EAAkB,GAClB,OAAAC,EACA,eAAAC,CACF,EAA4B,CAC1B,KAAM,CAACC,EAASC,CAAU,EAAI5kF,WAASukF,CAAc,EAC/C,CAACM,EAAQC,CAAS,EAAI9kF,WAAS,EAAK,EACpC+kF,EAAcvhF,SAClB,OAAO,SAAa,IAAc,SAAS,cAAc,KAAK,EAAI,MAE9DwhF,EAAexhF,SAAsB,IAAI,EACzCqnC,EAAgBzS,GAAiB5F,GAAMA,EAAE,aAAa,EACtDsY,EAAmB1S,GAAiB5F,GAAMA,EAAE,gBAAgB,EAC5D4b,EAAgBhf,GAAA,EAGtBrU,YAAU,IAAM,CACd,MAAMlN,EAAKk3E,EAAY,QACvB,GAAI,GAACl3E,GAAM,OAAO,SAAa,KAC/B,OAAAA,EAAG,UAAY,yBACf,SAAS,KAAK,YAAYA,CAAE,EACrB,IAAM,CACX,GAAI,CACFA,EAAG,YAAY,YAAYA,CAAE,CAC/B,MAAQ,CAAC,CACX,CACF,EAAG,EAAE,EAGLkN,YAAU,IAAM,CACTyhD,IACLooB,EAAWL,CAAc,EACzBO,EAAU,EAAK,EACXE,EAAa,UACf,OAAO,aAAaA,EAAa,OAAO,EACxCA,EAAa,QAAU,MAE3B,EAAG,CAACxoB,EAAM+nB,CAAc,CAAC,EAGzBxpE,YAAU,IAAM,CACd,GAAI,CAACyhD,EAAM,OACN3xB,GAAeC,IAAmB,EAAI,EAC3C,MAAMrlC,EAAK,OAAO,YAAY,IAAM,CAClCm/E,EAAYpyD,GACNA,GAAK,GACP,OAAO,cAAc/sB,CAAE,EACvBq/E,EAAU,EAAI,EACVE,EAAa,SAAS,OAAO,aAAaA,EAAa,OAAO,EAClEA,EAAa,QAAU,OAAO,WAAW,IAAM,CAC7C,GAAI,CACFP,IAAA,EACAC,IAAA,CACF,MAAQ,CAAC,CACX,EAAG,GAAI,EACA,GAEFlyD,EAAI,CACZ,CACH,EAAG,GAAI,EACP,MAAO,IAAM,CACX,OAAO,cAAc/sB,CAAE,CACzB,CACF,EAAG,CAAC+2D,EAAMioB,EAAQC,EAAgB55C,EAAkBD,CAAa,CAAC,EAElE9vB,YAAU,IACD,IAAM,CACPiqE,EAAa,SAAS,OAAO,aAAaA,EAAa,OAAO,CACpE,EACC,EAAE,EAELjqE,YAAU,IAAM,CACd,GAAI,CAACyhD,GAAQgoB,EAAiB,OAC9B,MAAMS,EAAarmF,GAAqB,CACtC,GAAIA,EAAE,MAAQ,SACd,GAAI,CACF8lF,IAAA,CACF,MAAQ,CAAC,CACX,EACA,cAAO,iBAAiB,UAAWO,CAAS,EACrC,IAAM,OAAO,oBAAoB,UAAWA,CAAS,CAC9D,EAAG,CAACzoB,EAAMgoB,EAAiBE,CAAc,CAAC,EAE1C3pE,YAAU,IAAM,CACd,GAAI,CAACyhD,GAAQ,OAAO,SAAa,IAAa,OAC9C,MAAM0oB,EAAO,SAAS,eAAe,MAAM,EAC3C,GAAI,CAACA,EAAM,OACX,MAAMjwE,EAAOiwE,EAAK,aAAa,aAAa,EAC5C,OAAAA,EAAK,aAAa,cAAe,MAAM,EAChC,IAAM,CACPjwE,GAAS,KACXiwE,EAAK,gBAAgB,aAAa,EAC/BA,EAAK,aAAa,cAAejwE,CAAI,CAC5C,CACF,EAAG,CAACunD,CAAI,CAAC,EAETzhD,YAAU,IAAM,CACd,GAAKyhD,EACL,IAAI,CACFpuB,GAAe,mBAAmB,sBAAsB,CAC1D,MAAQ,CAAC,CACT,MAAO,IAAM,CACX,GAAI,CACFA,GAAe,mBAAmB,sBAAsB,CAC1D,MAAQ,CAAC,CACX,EACF,EAAG,CAACouB,EAAMpuB,CAAa,CAAC,EAExB,MAAMuR,EAAQ34C,UACZ,IACEy+B,EAAQ,IAAKpnC,GAAM,CACjB,GAAI,CACF,MAAM8mF,EAAOxmC,GAActgD,EAAE,IAAI,EAAE,QAAQ,CAAC,EACtC+mF,EAAQvmC,GAAuBxgD,EAAE,IAAI,EAAE,QAAQ,CAAC,EAChD8mC,EAAeka,GAAuBhhD,EAAE,IAAI,EAC5CgnF,EAAUlmC,GAAkB9gD,EAAE,IAAI,EAClCinF,EAAM5nC,GAAWr/C,EAAE,IAAI,EACvBknF,EAAiBD,EAAI,QAAU,EAC/BE,EAAgBF,EAAI,OAAS,EAC7BG,EAAanmC,GAAejhD,EAAE,IAAI,EAClCwjD,GAAaxjD,EAAE,MAAQ,IAAI,OAAO,CAACwlB,EAAK4gB,IAAQ,CACpD,MAAMihD,GAAYjhD,EAAI,QAAU,IAAI,OACjCkhD,GAAU,OAAOA,EAAM,YAAcA,EAAM,KAAK,IAAM,KACvD,OACF,OAAO9hE,EAAM6hE,CACf,EAAG,CAAC,EACJ,MAAO,CACL,GAAIrnF,EAAE,GACN,KAAMA,EAAE,KACR,KAAA8mF,EACA,MAAAC,EACA,aAAAjgD,EACA,QAAAkgD,EACA,eAAAE,EACA,cAAAC,EACA,WAAAC,EACA,UAAA5jC,CAAA,CAEJ,MAAQ,CACN,MAAO,CACL,GAAIxjD,EAAE,GACN,KAAMA,EAAE,KACR,KAAM,GACN,MAAO,GACP,aAAc,GACd,QAAS,GACT,eAAgB,EAChB,cAAe,EACf,WAAY,EACZ,UAAW,EAEf,CACF,CAAC,EACH,CAAConC,CAAO,GAGV,GAAI,CAAC+2B,GAAQ,CAACuoB,EAAY,QAAS,OAAO,KAE1C,MAAMa,EACJxkE,MAAC,OACC,UAAU,kEACV,KAAK,SACL,aAAW,OACX,aAAW,uBAEX,SAAAA,MAAC,OAAI,UAAU,gEACb,eAAC,OAAI,UAAU,mBACb,SAAAA,MAACre,IAAU,YAAW,GACpB,SAAAoe,OAAC,OAAI,UAAU,8GACb,UAAAA,OAAC,OAAI,UAAU,2EACb,UAAAA,OAAC,OACC,UAAAC,MAAC,OAAI,UAAU,wEAAwE,+BAEvF,EACAA,MAAC,OAAI,UAAU,8DACZ,SAAAyjE,GAAUF,GAAW,EAClB,KACA,qBAAqBA,CAAO,IAClC,EACAvjE,MAAC,KAAE,UAAU,sCAAsC,6IAInD,GACF,EACAD,OAAC,OAAI,UAAU,aACb,UAAAC,MAAC,UACC,UAAU,sFACV,aAAW,6BACX,QAAS,IAAM,CACb,GAAI,CACFsjE,IAAA,CACF,MAAQ,CAAC,CACX,EACD,mBAGDtjE,MAAC,UACC,UAAU,wFACV,aAAW,kBACX,QAAS,IAAM,CACb,GAAI,CACFqjE,IAAA,EACAC,IAAA,CACF,MAAQ,CAAC,CACX,EACD,sBAED,EACF,GACF,EAEAvjE,OAAC,OAAI,UAAU,wCACb,UAAAC,MAAC,OAAI,UAAU,YACZ,SAAAu+B,EAAM,IAAKva,GACVjkB,OAAC,OAEC,UAAU,8DAEV,UAAAA,OAAC,OAAI,UAAU,yCACb,UAAAA,OAAC,OACC,UAAAA,OAAC,OAAI,UAAU,+CACZ,UAAAikB,EAAG,KACH/rB,GAAM,WAAa+rB,EAAG,KAAO,QAAU,IAC1C,EACAjkB,OAAC,OAAI,UAAU,yCAAyC,sCAC5BikB,EAAG,UAAU,IACtCA,EAAG,YACN,GACF,EACAjkB,OAAC,OAAI,UAAU,sCAAsC,mBAC5CikB,EAAG,UAAU,IAAEA,EAAG,YAC3B,GACF,EACAjkB,OAAC,OAAI,UAAU,yBACb,UAAAC,MAACijE,IAAU,MAAM,MAAM,MAAO,OAAOj/C,EAAG,IAAI,EAAG,EAC/ChkB,MAACijE,IAAU,MAAM,KAAK,MAAO,OAAOj/C,EAAG,KAAK,EAAG,EAC/ChkB,MAACijE,IAAU,MAAM,KAAK,MAAO,OAAOj/C,EAAG,YAAY,EAAG,EACtDhkB,MAACijE,IAAU,MAAM,MAAM,MAAO,OAAOj/C,EAAG,OAAO,EAAG,GACpD,EACAjkB,OAAC,OAAI,UAAU,wDACb,UAAAA,OAAC,OAAI,UAAU,0FACb,UAAAC,MAAC,QAAK,wBAAY,QACjB,QAAK,UAAU,gBACb,SAAAgkB,EAAG,eAAe,gBAAe,CACpC,GACF,EACAjkB,OAAC,OAAI,UAAU,0FACb,UAAAC,MAAC,QAAK,0BAAc,QACnB,QAAK,UAAU,gBACb,SAAAgkB,EAAG,cAAc,gBAAe,CACnC,GACF,GACF,IArCKA,EAAG,GAuCX,EACH,EAEAjkB,OAAC,OAAI,UAAU,2EACb,UAAAA,OAAC,OAAI,UAAU,4FACb,UAAAC,MAAC,OAAI,UAAU,gBAAgB,0BAAc,EAC7CA,MAAC,OAAI,UAAU,qCAAqC,+BAEpD,GACF,EACAA,MAAC,OAAI,UAAU,iCACb,SAAAA,MAACuhE,GAAA,CACC,UAAS,GACT,eAAc,GACd,KAAI,GACJ,OAAO,OACP,oBAAoB,MACpB,MAAO,IAEX,EACAvhE,MAAC,OAAI,UAAU,0DAA0D,uGAGzE,GACF,GACF,GACF,EACF,EACF,EACF,IAIJ,OAAOI,gBAAaokE,EAASb,EAAY,OAAO,CAClD,CC9UO,SAASc,GACdxsE,EACAqkE,EAAmB,SACX,CACR,GAAI,CACF,MAAMx1C,EAAa,CACjB7uB,GAAM,SACNA,GAAM,SAAS,SACfA,GAAM,SAAS,SACfA,GAAM,SACNA,GAAM,SAAS,YACfA,GAAM,YACNA,GAAM,MAER,UAAWQ,KAAOquB,EAAY,CAC5B,GAAI,OAAOruB,GAAQ,SAAU,SAC7B,MAAMytB,EAAUztB,EAAI,OACpB,GAAIytB,EAAS,OAAOA,CACtB,CACF,MAAQ,CAAC,CACT,OAAOo2C,CACT,CCVA,SAAwBoI,GAA2B,CACjD,kBAAAC,EACA,KAAAC,EACA,KAAAC,CACF,EAIG,CACD,MAAMt3B,EAAiBv2B,GAAiB5F,GAAMA,EAAE,cAAc,EAExD0zD,EAAQl/E,UAAQ,IACf,OAAO,SAAS++E,CAAiB,EACvB3hB,GAAiB2hB,EAAmBp3B,CAAc,EACnD,CAAC,GAAK,GAF4B,GAG/C,CAACo3B,EAAmBp3B,CAAc,CAAC,EAEtC,aACG,OAAI,UAAU,wEACb,SAAAxtC,OAAC,OAAI,UAAU,0EACb,UAAAA,OAAC,OAAI,UAAU,qCACb,UAAAC,MAAC,OAAI,UAAU,wDAAwD,oBAEvE,EACAA,MAAC,OAAI,UAAU,wCACZ,YAAS,IACZ,GACF,EAEAA,MAAC,OAAI,UAAU,YACZ,UAAC6kE,EAAMD,CAAI,EAAE,IAAK9mF,GACjBiiB,OAAC,OAEC,UAAU,yDAEV,UAAAC,MAAC,OAAI,UAAU,2DACZ,SAAAliB,EAAE,QACL,QACC,OAAI,UAAU,UACb,SAAAiiB,OAAC,OAAI,UAAU,0BACb,UAAAC,MAAC,OAAI,UAAU,wDACZ,SAAAliB,EAAE,KACL,QACC,OAAI,UAAU,4CACZ,SAAAA,EAAE,MAAQ,IACb,GACF,EACF,EACAkiB,MAAC,OAAI,UAAU,iEACZ,gBAAO,SAASliB,EAAE,SAAS,EAAIA,EAAE,UAAY,IAChD,IAlBKA,EAAE,KAoBV,EACH,GACF,EACF,CAEJ,CCnDA,SAAwBinF,IAAY,CAClC,MAAMzqC,EAAQrW,GAAA,EACdjN,GAAiB5F,GAAMA,EAAE,mBAAqB,EAAI,EAC3B6S,KAAW,YACdy6B,GAAiBttC,GAAMA,EAAE,SAAS,EACrCstC,GAAA,EACjB,KAAM,CAACsmB,EAAQC,CAAQ,EAAIrmF,WAAS,EAAK,EACnC,CAACsmF,EAAaC,CAAc,EAAIvmF,WAK5B,IAAI,EACR,CAACwmF,EAAaC,CAAc,EAAIzmF,WAAwB,IAAI,EAC5D0mF,EAAmBtuD,GACtB5F,GAAMA,EAAE,aAAa,UAAY,KAE9BnZ,EAAO+e,GAAiB5F,GAAMA,EAAE,IAAI,EACpCm0D,EACJttE,GAAM,UACNA,GAAM,MACNA,GAAM,aACNA,GAAM,OAAO,MAAM,GAAG,EAAE,CAAC,EACrButE,GAAsBlrC,EAAM,SAAW,IAAI,UAC9Cr9C,GAAWA,GAAG,MAAQA,EAAE,OAASsoF,CAAA,EAE9BE,EAAmBD,GAAsB,EAAIA,EAAqB,EAClEE,GAAeprC,EAAM,kBAAoB,KAAOmrC,EAEhDE,EAAcrrC,EAAM,UAAUmrC,CAAgB,EAE9CG,EADWD,GAAa,OAAOA,EAAY,KAAK,OAAS,CAAC,GAEpD,qBAAuBrrC,EAAM,eAAiBgrC,EACpDO,GAAWvrC,EAAM,SAAW,IAAI,UACpC,CAACwrC,EAAS7hE,IAAgBA,IAAQwhE,CAAA,EAE9BM,GAAczrC,EAAM,SAAW,IAAIurC,GAAW,EAAIA,EAAU,CAAC,EAE7DG,EADUD,GAAY,OAAOA,EAAW,KAAK,OAAS,CAAC,GAElD,qBAAuBzrC,EAAM,eAAiBgrC,EAEnDW,GAAmB3rC,EAAM,SAAW,IAAI,OAC5C,CAACwrC,EAAS7hE,IAAgBA,IAAQwhE,CAAA,EAE9Bj4B,EAAgBx2B,GAAiB5F,GAAMA,EAAE,aAAa,EACtDq8B,EAAcz2B,GAAiB5F,GAAMA,EAAE,WAAW,EAClDs8B,EAAe12B,GAAiB5F,GAAMA,EAAE,YAAY,EACpDu8B,EAAoB32B,GAAiB5F,GAAMA,EAAE,iBAAiB,EAC9D,CAAC80D,EAAkBC,CAAmB,EAAIvnF,WAAS,CAAC,EACpD,CAACwnF,EAAkBC,CAAmB,EAAIznF,WAAiB,CAAC,EAC5D,CAAC0nF,EAAiBC,CAAkB,EAAI3nF,WAAiB,EAAE,EAC3D,CAAC4nF,EAAWC,EAAY,EAAI7nF,WAAS,EAAE,EACvC,CAAC8nF,GAAYC,EAAa,EAAI/nF,WAAS,EAAE,EACzC,CAACgoF,GAAeC,EAAgB,EAAIjoF,WAAmB,EAAE,EACzD,CAACkoF,GAAmBC,CAAoB,EAAInoF,WAAkB,EAAI,EAClEooF,EAAwBnhF,GAAM,OAAO,EAAI,EACzC,CAACohF,GAAkBC,EAAmB,EAAItoF,WAAS,EAAK,EACxD,CAACuoF,GAAgBC,EAAiB,EAAIxoF,WAC1C,YAUF+a,YAAU,IAAM,CACTqtE,EAAsB,SAC3BD,EAAqB,EAAI,CAC3B,EAAG,EAAE,EAELptE,YAAU,IAAM,CAEd,GAAI,CACFqd,GAAgB,WAAW,iBAAiB,EAAI,CAClD,MAAQ,CAAC,CAGT,GAAI,CACF,MAAMyhC,EAAWkK,GAAA,EACjB,GAAIlK,GAAU,MACZ,GAAI,CACFx0B,GAAS,WAAW,YAAYw0B,EAAS,KAAK,CAChD,MAAQ,CAAC,KAIT,IAAI,CACFx0B,GAAS,WAAW,YAAY,CAC9B,GAAGA,GAAS,WACZ,cAAeqhD,CAAA,CACT,CACV,MAAQ,CAAC,CAEX,GAAI7sB,GAAU,QACZ,GAAI,CACFiG,GACG,WACA,UAAUjG,EAAS,QAAQ,OAAQA,EAAS,QAAQ,WAAW,CACpE,MAAQ,CAAC,CAEb,MAAQ,CAAC,CACTwsB,EAAS,EAAI,EAGb,MAAM97B,EAAQrmB,GAAoBN,GAAa,CAC7C,GAAI,CACF,GAAI,CAACA,EAAK,OACNA,EAAI,OAAS,YAAcA,EAAI,QAC7BA,EAAI,MAAM,OAAOyB,GAAS,WAAW,YAAYzB,EAAI,MAAM,KAAK,EAChEA,EAAI,MAAM,SACZk8B,GACG,WACA,UACCl8B,EAAI,MAAM,QAAQ,OAClBA,EAAI,MAAM,QAAQ,cAI1B,MAAM6kD,GAAoB,IAAM,CAC9B,GAAI,CACF,MAAMj2D,GAAIuxC,GAAA,EACV,GAAIvxC,IAAKA,GAAE,MACT,OAAA6S,GAAS,WAAW,YAAY7S,GAAE,KAAK,EACnCA,GAAE,SACJstC,GACG,WACA,UAAUttC,GAAE,QAAQ,OAAQA,GAAE,QAAQ,WAAW,EAC/C,EAEX,MAAQ,CAAC,CACT,MAAO,EACT,EACA,GAAIoR,EAAI,OAAS,QACf,GAAI,CACFk8B,GAAgB,WAAW,UAAU,GAAMl8B,EAAI,aAAe,IAAI,CACpE,MAAQ,CAAC,CAEX,GAAIA,EAAI,OAAS,UACf,GAAI,CACFk8B,GAAgB,WAAW,UAAU,GAAO,IAAI,CAClD,MAAQ,CAAC,CAEX,GAAIl8B,EAAI,OAAS,OACf,GAAI,CACF,OAAO,OACT,MAAQ,CAAC,CAGX,GAAIA,EAAI,OAAS,eACf,GAAI,CACF,MAAM8kD,GAAQ9kD,EAAI,WAAa8X,EAAM,iBAErC,GAAI,CACFmnB,GACG,WACA,SAASj/B,EAAI,SAAW,GAAIA,EAAI,OAAS,EAAGA,EAAI,OAAS,CAAC,CAC/D,MAAY,CAAC,CACTA,EAAI,OAAO6iD,EAAe7iD,EAAI,KAAK,CACzC,MAAY,CAAC,CAEf,GAAIA,EAAI,OAAS,QACf,GAAI,CAEF,MAAM6yC,GAAKgS,GAAA,EAEX,GAAI,CACE7kD,EAAI,MAAM,OAAO6iD,EAAe7iD,EAAI,KAAK,KAAK,EAC9CA,EAAI,UAAYA,EAAI,OACtB2iD,EAAe,CACb,MAAO3iD,EAAI,KAAK,OAAS+kD,MAAwB,OACjD,KAAM/kD,EAAI,KAAK,KACf,MAAOA,EAAI,KAAK,OAASA,EAAI,OAAS,KACtC,GAAI,KAAK,KAAI,CACd,EAED8X,EAAM,UAEV,MAAQ,CAAC,CAET,GAAI,CACFmnB,GAAgB,WAAW,OAC7B,MAAY,CAAC,CAOf,MAAY,CAAC,CAGf,GAAIj/B,EAAI,OAAS,aACf,GAAI,CAGF,GAAI,CADO6kD,GAAA,EAET,GAAI,CACF,MAAMntE,GAAM+pB,GAAS,WACf6lC,GAAa,CACjB,OAAQ5vD,GAAI,OACZ,QAASA,GAAI,QACb,iBACE,OAAOsoB,EAAI,kBAAqB,SAC5BA,EAAI,kBACHtoB,GAAI,iBAAmB,IAAMA,GAAI,SAAS,QAAU,GAC3D,cAAeA,GAAI,cACnB,WAAYA,GAAI,WAChB,iBAAkBA,GAAI,kBAExB+pB,GAAS,WAAW,YAAY6lC,EAAU,CAC5C,MAAY,CAAC,CAEjB,MAAY,CAAC,CAGf,GAAItnC,EAAI,OAAS,SACf,GAAI,CACF,MAAM6yC,GAAKgS,GAAA,CAKb,MAAY,CAAC,CAGf,GAAI7kD,EAAI,OAAS,UACf,GAAI,CAEF,GAAI,CADO6kD,GAAA,EAET,GAAI,CACF,MAAMntE,GAAM+pB,GAAS,WACf6lC,GAAa,CACjB,OAAQ5vD,GAAI,OACZ,QAASA,GAAI,QACb,iBAAkBA,GAAI,iBACtB,cAAeA,GAAI,cACnB,WAAY,GACZ,iBAAkBA,GAAI,kBAExB+pB,GAAS,WAAW,YAAY6lC,EAAU,CAC5C,MAAY,CAAC,CAEjB,MAAY,CAAC,CAEjB,MAAQ,CAAC,CACX,CAAC,EACD,MAAO,IAAM,CACX,GAAI,CACE,OAAO3gB,GAAU,YAAYA,EAAA,CACnC,MAAQ,CAAC,CACX,CACF,EAAG,EAAE,EAEL,MAAMq+B,GAAc,CAAC1qD,EAAe8E,EAAeE,KAAe,CAChE,MAAM7kC,GAAIq9C,EAAM,UAAUA,EAAM,gBAAgB,EAC1CjX,GAAMpmC,IAAG,OAAOA,GAAE,KAAK,OAAS,CAAC,EACjCwqF,GAAgBpkD,GAAMA,GAAI,oBAAsBiX,EAAM,cACtDotC,GAAe,OAAO5qD,GAAU,SAAWA,EAAQ,EACzD,IAAI6qD,EAAeF,GAAgBC,GAInC,IAHI,CAAC,OAAO,SAASC,CAAY,GAAKA,EAAe,KAAGA,EAAe,GAGnEn6B,EAAe,CACjB,MAAMo6B,EAAa3qF,IAAG,MAAQwnF,GAAqBxsE,EAAM,QAAQ,EACjE,GAAI,CACFkrD,GAASykB,EAAYF,GAAcC,EAAcl6B,EAAa,CAC5D,OAAQC,EACR,aAAcC,CAAA,CACf,CACH,MAAQ,CAAC,CACX,CAEArT,EAAM,SAASotC,GAAc9lD,EAAOE,IAAQ,CAAE,WAAY4lD,GAAc,EACpEC,IAAiB,EACnBrtC,EAAM,OAAOotC,EAAY,EAEzBptC,EAAM,YAEV,EA8CMitC,GAAqBhjF,cAAY,IAAM,CAC3C,GAAI,CACF,MAAMsjF,EAAyD,GAa/D,IAZCvtC,EAAM,SAAW,IAAI,QAASr9C,IAAW,EACvCA,GAAE,MAAQ,IAAI,QAASomC,IAAa,CACnC,GAAIA,IAAK,SAAU,CACjB,MAAMykD,IAAazkD,GAAI,QAAU,IAAI,MAAM,EAAE,EAAE,CAAC,EAChDwkD,EAAK,KAAK,CACR,GAAIxkD,GAAI,SAAW,KAAK,MACxB,MAAOykD,GACP,OAAQ7qF,EAAA,CACT,CACH,CACF,CAAC,CACH,CAAC,EACG,CAAC4qF,EAAK,OAAQ,OAAO,KACzB,MAAME,EAASF,EAAK,KAAK,CAACzqF,GAAGE,KAAMA,GAAE,GAAKF,GAAE,EAAE,EAAE,CAAC,EAC3CyS,IAASk4E,EAAO,OAAO,SAAW,IAAI,MAAM,EAAE,EAAE,CAAC,EACvD,GAAIl4E,IAAO,MAAO,OAAOA,GAAM,MAC/B,GAAIA,IAAO,OAAS,UAAY,OAAOA,IAAO,OAAU,SACtD,MAAO,UAAUA,GAAM,MAAQ,CAAC,GAClC,GAAI,OAAOk4E,EAAO,OAAO,YAAe,SACtC,MAAO,YAAYA,EAAO,MAAM,UAAU,EAC9C,MAAQ,CAAC,CACT,OAAO,IACT,EAAG,CAACztC,EAAM,OAAO,CAAC,EAGlB3gC,mBAAU,IAAM,CACd,GAAI2gC,EAAM,WAAY,CAEpB6qC,EAAe,IAAI,EACnB,MACF,CAEA,GAAI,CAACD,GAAa,MAAO,CACvB,MAAM8C,EAAUT,GAAA,EACZS,KAAyBn0E,IAAU,CAAE,GAAGA,EAAM,MAAOm0E,CAAA,EAAU,CACrE,CACF,EAAG,CAAC1tC,EAAM,WAAYitC,GAAoBrC,GAAa,KAAK,CAAC,EAG3DnlE,OAAC,OAAI,UAAU,2FACZ,UAAA+mE,IACC9mE,MAACkjE,GAAA,CACC,KAAM4D,GACN,QAAUxsC,EAAM,SAAW,GAC3B,OAAQ,IAAM,CACZ0sC,EAAsB,QAAU,GAChCD,EAAqB,EAAK,CAC5B,EACA,eAAgB,IAAM,CACpBC,EAAsB,QAAU,GAChCD,EAAqB,EAAK,CAC5B,EACA,uBAAwB,KAG5BhnE,OAAC,OAAI,UAAU,iDACb,UAAAC,MAAC,UACC,UAAU,2BACV,QAAS,IAAM,CACb,GAAI,CACF,GAAI,OAAO,QAAU,CAAE,OAAO,OAAe,OAC3C,GAAI,CACD,OAAO,OAAe,OACzB,MAAQ,CAAC,CAEX,OAAO,OACT,MAAQ,CAAC,CACX,EACA,aAAW,uCACZ,oBAGDA,MAAC,MAAG,UAAU,oCAAoC,oBAAQ,EACzDklE,GAAa,OACZnlE,OAAC,QAAK,UAAU,8GAA8G,6BAC3GmlE,EAAY,OAC/B,GAEJ,EACAnlE,OAAC,OACC,UAAU,iBACV,MAAO,CACL,cACE,+EAGJ,UAAAC,MAACkgE,GAAA,CACC,KACElgE,MAAC,OAAI,UAAU,0BACb,eAAC,QAAK,UAAU,cAAc,uBAAW,EAC3C,EAEF,YAAQiiD,GAAA,EAAgB,KAIvB3nB,GAAe,MAAQ,SAAW,OAAS,CAACorC,EAC7C3lE,OAAC,OAAI,UAAU,6FACb,UAAAC,MAAC,OAAI,UAAU,gDACb,SAAAA,MAACioE,IAAW,iBAAkB,GAAM,eAAgB,GAAM,EAC5D,EACAjoE,MAAC0kE,GAAA,CACC,kBAAmBkB,EACnB,KAAM,CACJ,KAAM,OACN,KAAMG,GAAY,MAAQ,OAC1B,QAASA,GAAY,SAAW,EAChC,UAAWC,CAAA,EAEb,KAAM,CACJ,KAAM,OACN,KAAML,GAAa,MAAQ,OAC3B,QAASA,GAAa,SAAW,EACjC,UAAWC,CAAA,CACb,EACF,EACF,QAEC,OAAI,UAAU,oIACb,SAAA7lE,OAAC,OAAI,UAAU,qCAEb,UAAAC,MAAC,OAAI,UAAU,8BACZ,SAAA0lE,EACC3lE,OAAAja,WAAA,CACE,UAAAia,OAAC,OAAI,UAAU,gGACb,UAAAA,OAAC,OAAI,UAAU,+DACb,UAAAC,MAAC,QAAK,uBAAW,EACjBA,MAAC,QAAK,UAAU,2BAA2B,qBAE3C,GACF,EACAD,OAAC,OAAI,UAAU,kEACb,UAAAC,MAACioE,GAAA,CACC,iBAAkB,GAClB,eAAgB,GAChB,WAAYT,GACZ,SAAW1qD,GAAU,CACnB,GAAI,CACFwd,EAAM,OAAOxd,GAAS,CAAC,CACzB,MAAQ,CAAC,CACX,EACA,iBAAkB,CAChBorD,EACAC,EACAC,GACAtmD,KACG,CACH,GAAI,CAACsmD,GAAU,OACf,MAAMh8E,GAAQ01B,IAAM,OAASsjD,GAAe,KAC5CD,EAAe,CACb,MACErjD,IAAM,OACNylD,GAAA,GACA,OACF,KAAMzlD,IAAM,KACZ,MAAA11B,GACA,GAAI,KAAK,KAAI,CACd,EACD,GAAI,CACFkuC,EAAM,SACR,MAAQ,CAAC,CACX,IAED4qC,GAAa,OAAS,CAAC5qC,EAAM,YAC5Bv6B,OAAC,OAAI,UAAU,iGACb,UAAAC,MAAC,OACC,IAAKklE,EAAY,MACjB,IAAI,sBACJ,UAAU,yCAEZnlE,OAAC,OAAI,UAAU,+HACb,UAAAC,MAAC,QAAK,UAAU,gBAAgB,6BAEhC,EACCklE,EAAY,OACXllE,MAAC,QAAK,UAAU,mBACb,WAAY,MACf,GAEJ,GACF,GAEJ,GACF,EAEAD,OAAC,OAAI,UAAU,gGACb,UAAAC,MAAC,OAAI,UAAU,yCACb,SAAAA,MAAC,MAAG,UAAU,0BAA0B,2BAExC,EACF,EACAA,MAACogE,GAAA,CACC,SAAY9lC,GAAe,MAAQ,MACnC,SAAUA,EAAM,SAAW,IAAI,IAC7B,CAACr9C,EAAQgnB,KAAiB,CACxB,KAAMhnB,EAAE,MAAQ,UAAUgnB,EAAM,CAAC,GACjC,cACEA,KAASq2B,EAAM,kBAAoB,GACrC,QAASr9C,EAAE,SAAW,EACtB,MACEA,EAAE,OAAOA,EAAE,KAAK,OAAS,CAAC,GACtB,qBACJq9C,EAAM,eACNgrC,EACF,UACEroF,EAAE,MAAQA,EAAE,KAAK,QACbA,EAAE,KAAKA,EAAE,KAAK,OAAS,CAAC,EAAE,OAAO,MAAM,EAAE,EAAE,CAAC,GACxC,OAAS,CACb,EACR,CACF,SAGD,OAAI,UAAU,kKACb,SAAA8iB,OAAC,OAAI,UAAU,kCACb,UAAAC,MAAC,SACC,KAAK,SACL,UAAU,UACV,UAAU,oLACV,MAAO,CACL,MAAO,QACP,OAAQ,OACR,SAAU,QAEZ,MAAOsmE,EACP,SAAW9oF,GAAM+oF,EAAmB/oF,EAAE,OAAO,KAAK,EAClD,UAAYA,GAAM,CAChB,GAAIA,EAAE,MAAQ,QAAS,CACrBA,EAAE,iBACF,MAAMs/B,EAAQ,SAASwpD,CAAe,GAAK,EAC3CkB,GAAY1qD,EAAO,EAAG,CAAE,WAAYA,EAAO,EAC3CypD,EAAmB,EAAE,CACvB,CACF,EACA,YAAY,qBACZ,SAAU,CAACjsC,EAAM,aAEnBt6B,MAAC,UACC,KAAK,SACL,UAAU,8DACV,QAAS,IAAM,CACb,MAAM8c,EAAQ,SAASwpD,CAAe,GAAK,EAC3CkB,GAAY1qD,EAAO,EAAG,CAAE,WAAYA,EAAO,EAC3CypD,EAAmB,EAAE,CACvB,EACA,SAAU,CAACjsC,EAAM,YAAc,CAACgsC,EACjC,yBAED,EACF,EACF,GACF,GACF,EAEAvmE,OAAAja,WAAA,CACE,UAAAia,OAAC,OAAI,UAAU,gGACb,UAAAA,OAAC,OAAI,UAAU,yCACb,UAAAC,MAAC,MAAG,UAAU,0BAA0B,oBAAQ,EAChDA,MAAC,QAAK,UAAU,yGAAyG,mBAEzH,GACF,EACAA,MAACogE,GAAA,CACC,SAAY9lC,GAAe,MAAQ,MACnC,SAAU2rC,EAAgB,OACtBA,EACA3rC,EAAM,SAAW,IACnB,IAAI,CAACr9C,EAAQgnB,KAAiB,CAC9B,KAAMhnB,EAAE,MAAQ,UAAUgnB,EAAM,CAAC,GACjC,cACEhnB,KAAOq9C,EAAM,SAAW,IAAIA,EAAM,gBAAgB,EACpD,QAASr9C,EAAE,SAAW,EACtB,MACEA,EAAE,OAAOA,EAAE,KAAK,OAAS,CAAC,GAAG,qBAC7Bq9C,EAAM,eACNgrC,EACF,UACEroF,EAAE,MAAQA,EAAE,KAAK,QACbA,EAAE,KAAKA,EAAE,KAAK,OAAS,CAAC,EAAE,OAAO,MAAM,EAAE,EAAE,CAAC,GACxC,OAAS,CACb,EACN,GACJ,EACF,EAEA8iB,OAAC,OAAI,UAAU,gGACb,UAAAA,OAAC,OAAI,UAAU,+DACb,UAAAC,MAAC,QAAK,2BAAe,EACrBA,MAAC,QAAK,UAAU,yBAAyB,qBAEzC,GACF,EACAD,OAAC,OAAI,UAAU,kEACb,UAAAC,MAACioE,GAAA,CACC,iBAAkB,GAClB,eAAgB,GAChB,WAAYT,GACZ,SAAW1qD,GAAU,CACnB,GAAI,CACFwd,EAAM,OAAOxd,GAAS,CAAC,CACzB,MAAQ,CAAC,CACX,EACA,iBAAkB,CAChBorD,EACAC,EACAC,GACAtmD,KACG,CACH,GAAI,CAACsmD,GAAU,OACf,MAAMh8E,GAAQ01B,IAAM,OAASsjD,GAAe,KAC5CD,EAAe,CACb,MACErjD,IAAM,OACNylD,GAAA,GACA,OACF,KAAMzlD,IAAM,KACZ,MAAA11B,GACA,GAAI,KAAK,KAAI,CACd,EACD,GAAI,CACFkuC,EAAM,SACR,MAAQ,CAAC,CACX,IAED4qC,GAAa,OAAS,CAAC5qC,EAAM,YAC5Bv6B,OAAC,OAAI,UAAU,iGACb,UAAAC,MAAC,OACC,IAAKklE,EAAY,MACjB,IAAI,sBACJ,UAAU,yCAEZnlE,OAAC,OAAI,UAAU,+HACb,UAAAC,MAAC,QAAK,UAAU,gBAAgB,6BAEhC,EACCklE,EAAY,OACXllE,MAAC,QAAK,UAAU,mBACb,WAAY,MACf,GAEJ,GACF,GAEJ,GACF,GACF,EAEJ,EAGAA,MAAC,OAAI,UAAU,oCACZ,WACCD,OAAAja,WAAA,CACE,UAAAia,OAAC,OAAI,UAAU,gGACb,UAAAA,OAAC,OAAI,UAAU,+DACb,UAAAC,MAAC,QAAK,uBAAW,EACjBA,MAAC,QAAK,UAAU,2BAA2B,qBAE3C,GACF,EACAD,OAAC,OAAI,UAAU,uEACb,UAAAC,MAACioE,GAAA,CACC,iBAAkB,GAClB,eAAgB,GAChB,WAAYT,GACZ,SAAW1qD,GAAU,CACnB,GAAI,CACFwd,EAAM,OAAOxd,GAAS,CAAC,CACzB,MAAQ,CAAC,CACX,EACA,iBAAkB,CAChBorD,EACAC,EACAC,GACAtmD,KACG,CACH,GAAI,CAACsmD,GAAU,OACf,MAAMh8E,GAAQ01B,IAAM,OAASsjD,GAAe,KAC5CD,EAAe,CACb,MACErjD,IAAM,OACNylD,GAAA,GACA,OACF,KAAMzlD,IAAM,KACZ,MAAA11B,GACA,GAAI,KAAK,KAAI,CACd,EACD,GAAI,CACFkuC,EAAM,SACR,MAAQ,CAAC,CACX,IAED4qC,GAAa,OAAS,CAAC5qC,EAAM,YAC5Bt6B,MAAC,OAAI,UAAU,iGACb,SAAAA,MAAC,OACC,IAAKklE,EAAY,MACjB,IAAI,sBACJ,UAAU,wCACZ,CACF,GAEJ,GACF,EAEAnlE,OAAC,OAAI,UAAU,gGACb,UAAAC,MAAC,OAAI,UAAU,yCACb,SAAAA,MAAC,MAAG,UAAU,0BAA0B,2BAExC,EACF,EACAA,MAACogE,GAAA,CACC,SAAY9lC,GAAe,MAAQ,MACnC,SAAUA,EAAM,SAAW,IAAI,IAC7B,CAACr9C,EAAQgnB,KAAiB,CACxB,KAAMhnB,EAAE,MAAQ,UAAUgnB,EAAM,CAAC,GACjC,cACEA,KAASq2B,EAAM,kBAAoB,GACrC,QAASr9C,EAAE,SAAW,EACtB,MACEA,EAAE,OAAOA,EAAE,KAAK,OAAS,CAAC,GACtB,qBACJq9C,EAAM,eACNgrC,EACF,UACEroF,EAAE,MAAQA,EAAE,KAAK,QACbA,EAAE,KAAKA,EAAE,KAAK,OAAS,CAAC,EAAE,OAAO,MAAM,EAAE,EAAE,CAAC,GACxC,OAAS,CACb,EACR,CACF,SAGD,OAAI,UAAU,kKACb,SAAA8iB,OAAC,OAAI,UAAU,kCACb,UAAAC,MAAC,SACC,KAAK,SACL,UAAU,oLACV,MAAO,CACL,MAAO,QACP,OAAQ,OACR,SAAU,QAEZ,MAAOsmE,EACP,SAAW9oF,GAAM+oF,EAAmB/oF,EAAE,OAAO,KAAK,EAClD,UAAYA,GAAM,CAChB,GAAIA,EAAE,MAAQ,QAAS,CACrBA,EAAE,iBACF,MAAMs/B,EAAQ,SAASwpD,CAAe,GAAK,EAC3CkB,GAAY1qD,EAAO,EAAG,CAAE,WAAYA,EAAO,EAC3CypD,EAAmB,EAAE,CACvB,CACF,EACA,YAAY,cACZ,SAAU,CAACjsC,EAAM,aAEnBt6B,MAAC,UACC,KAAK,SACL,UAAU,8DACV,QAAS,IAAM,CACb,MAAM8c,EAAQ,SAASwpD,CAAe,GAAK,EAC3CkB,GAAY1qD,EAAO,EAAG,CAAE,WAAYA,EAAO,EAC3CypD,EAAmB,EAAE,CACvB,EACA,SAAU,CAACjsC,EAAM,YAAc,CAACgsC,EACjC,yBAED,EACF,EACF,GACF,GACF,EAEAvmE,OAAAja,WAAA,CACE,UAAAia,OAAC,OAAI,UAAU,gGACb,UAAAA,OAAC,OAAI,UAAU,yCACb,UAAAC,MAAC,MAAG,UAAU,0BAA0B,oBAAQ,EAChDA,MAAC,QAAK,UAAU,yGAAyG,yBAEzH,GACF,EACAA,MAACogE,GAAA,CACC,SAAY9lC,GAAe,MAAQ,MACnC,SAAU2rC,EAAgB,OACtBA,EACA3rC,EAAM,SAAW,IACnB,IAAI,CAACr9C,EAAQgnB,KAAiB,CAC9B,KAAMhnB,EAAE,MAAQ,UAAUgnB,EAAM,CAAC,GACjC,cACEhnB,KAAOq9C,EAAM,SAAW,IAAIA,EAAM,gBAAgB,EACpD,QAASr9C,EAAE,SAAW,EACtB,MACEA,EAAE,OAAOA,EAAE,KAAK,OAAS,CAAC,GAAG,qBAC7Bq9C,EAAM,eACNgrC,EACF,UACEroF,EAAE,MAAQA,EAAE,KAAK,QACbA,EAAE,KAAKA,EAAE,KAAK,OAAS,CAAC,EAAE,OAAO,MAAM,EAAE,EAAE,CAAC,GACxC,OAAS,CACb,EACN,GACJ,EACF,EAEA8iB,OAAC,OAAI,UAAU,gGACb,UAAAA,OAAC,OAAI,UAAU,+DACb,UAAAC,MAAC,QAAK,2BAAe,EACrBA,MAAC,QAAK,UAAU,yBAAyB,qBAEzC,GACF,EACAD,OAAC,OAAI,UAAU,uEACb,UAAAC,MAACioE,GAAA,CACC,iBAAkB,GAClB,eAAgB,GAChB,WAAYT,GACZ,SAAW1qD,GAAU,CACnB,GAAI,CACFwd,EAAM,OAAOxd,GAAS,CAAC,CACzB,MAAQ,CAAC,CACX,EACA,iBAAkB,CAChBorD,EACAC,EACAC,GACAtmD,KACG,CACH,GAAI,CAACsmD,GAAU,OACf,MAAMh8E,GAAQ01B,IAAM,OAASsjD,GAAe,KAC5CD,EAAe,CACb,MACErjD,IAAM,OACNylD,GAAA,GACA,OACF,KAAMzlD,IAAM,KACZ,MAAA11B,GACA,GAAI,KAAK,KAAI,CACd,EACD,GAAI,CACFkuC,EAAM,SACR,MAAQ,CAAC,CACX,IAED4qC,GAAa,OAAS,CAAC5qC,EAAM,YAC5Bt6B,MAAC,OAAI,UAAU,iGACb,SAAAA,MAAC,OACC,IAAKklE,EAAY,MACjB,IAAI,sBACJ,UAAU,wCACZ,CACF,GAEJ,GACF,GACF,EAEJ,GACF,EACF,IAEJ,EACF,CAEJ,CC14BO,MAAMmD,GAA+B,yBAErC,SAASC,IAA4B,CAC1C,GAAI,CACF,OAAO,cAAc,IAAI,YAAYD,EAA4B,CAAC,CACpE,MAAQ,CAER,CACF,CCDA,SAAwBE,GAAgB,CAAE,UAAAllF,EAAW,MAAA+nD,GAAgB,CAEnE,IAAInkB,EAAY,GAChB,GAAI,CACFA,EAAYyB,KAAQ,SACtB,MAAQ,CACNzB,EAAY,EACd,CAEA,MAAMuhD,EAAYvhD,EAAY,YAAc,eAE5C,OACEjnB,MAAC,QACC,aAAY,sBAAsBwoE,CAAS,GAC3C,MAAOp9B,GAASo9B,EAChB,UAAW,CACT,0CACA,uBACAvhD,EAAY,iBAAmB,aAC/B,uBACA5jC,GAAa,IACb,KAAK,GAAG,GAGhB,aCzBMolF,GAAO5iF,GAAM,KAAK,IAAAkxD,GAAA,IAAM,OAAO,oBAAmB,6BAAC,EAOnDkxB,GAAapiF,GAAM,KAAK,IAAAkxD,GAAA,IAAM,2BAAA2xB,EAAA,EAAgC,OAAC,EAC/DC,GAAc9iF,GAAM,KAAK,IAAAkxD,GAAA,IAAM,OAAO,2BAA0B,iCAAC,EACjE6xB,GAAU/iF,GAAM,KAAK,IAAAkxD,GAAA,IAAM,OAAO,uBAAsB,4BAAC,EAkCzD8xB,GAAahjF,GAAM,KAAK,IAAAkxD,GAAA,IAAM,OAAO,gCAA+B,+BAAC,EACrE+xB,GAAajjF,GAAM,KAAK,IAAAkxD,GAAA,IAAM,OAAO,0BAAyB,8BAAC,EAC/DgyB,GAAcljF,GAAM,KAAK,IAAAkxD,GAAA,IAAM,OAAO,2BAA0B,gCAAC,EACjEiyB,GAAcnjF,GAAM,KAAK,IAAAkxD,GAAA,IAAM,OAAO,2BAA0B,4BAAC,EAGjEkyB,GAAepjF,GAAM,KAAK,IAAAkxD,GAAA,IAAM,OAAO,4BAA2B,4BAAC,EAezE,SAAwBmyB,IAAM,CAC5B,MAAMC,EAAS/mF,SAA8B,IAAI,EAC3C,CAACgnF,EAAQC,CAAS,EAAIzqF,WAAiB,EAAE,EACzC,CAAC0qF,EAAcC,CAAe,EAAI3qF,WAAS,EAAK,EAChD6vB,GAAM,IAAM,CAChB,GAAI,CACF,OAAOia,GAAA,CACT,MAAQ,CACN,OAAO,IACT,CACF,KACM,CAAC8gD,EAAKC,CAAM,EAAI7qF,WAAiB,OAAO,EACxC,CAAC8qF,EAAUC,CAAW,EAAI/qF,WAAkB,EAAK,EACjD,CAACgrF,EAASC,CAAU,EAAIjrF,WAAkB,EAAK,EAC/C,CAACqZ,EAAM6xE,CAAO,EAAIlrF,WAAc,IAAI,EAG1C,SAASmrF,EAAiBr2E,EAAW,CACnC,GAAI,CAACA,EAAM,CACTo2E,EAAQp2E,CAAI,EACZ,MACF,CACAo2E,EAASj2E,GAAc,CACrB,MAAMm2E,EAAS,CAAE,GAAGn2E,EAAM,GAAGH,CAAA,EAC7B,OAAIG,GAAM,cAAgB,CAACH,GAAM,eAC/Bs2E,EAAO,aAAen2E,EAAK,cACzBH,GAAM,eAAcs2E,EAAO,aAAet2E,EAAK,cAEnDs2E,EAAO,WAAa,CAAC,EACnBA,EAAO,cAAc,YACrBt2E,GAAM,YACNs2E,EAAO,YAEFA,CACT,CAAC,CACH,CACA,MAAMC,GACF5wE,IAAyB,0BAA4B,IAAI,aAC3D,IACI,CAAC6wE,EAAWC,CAAY,EAAIvrF,WAAkB,EAAK,EACnD,CAACmiF,EAAYqJ,CAAa,EAAIxrF,WAAiB,CAAC,EAChD,CAACyrF,EAAUC,CAAW,EAAI1rF,WAAiB,CAAC,EAC5C,CAAE,QAAAgvD,CAAA,EAAY52B,GAAA,EACGA,GAAiB5F,GAAMA,EAAE,aAAa,EAE7D,MAAMm5D,EADkBtmD,GAAU7S,GAAMA,EAAE,UAAU,GACfo4D,IAAQ,QAC/BtuC,GAAA,EACd,MAAMsvC,EAAkB,KAAK,IAAIH,CAAQ,GAAK,IAAOA,EAAW,EAC1D5zB,EAAUj7C,GAAA,EACV,CACJ,OAAQivE,EACR,EAAGpkB,EACH,QAAAjwC,EACA,eAAAqW,CAAA,EACE/hB,GAAA,EACEggE,EAAe1zD,GAAA,EAGrBrd,YAAU,IAAM,CACd,GAAI,CACF,MAAMgxE,EAAkBD,EAAa,sBACjCC,GAAmBF,IAAgBE,IACrCl+C,EAAe,CAAE,OAAQk+C,EAAiB,EAC1C,QAAQ,KACN,sDACAA,CAAA,EAGN,OAASntF,EAAG,CACV,QAAQ,KAAK,gDAAiDA,CAAC,CACjE,CACF,EAAG,CAACitF,EAAah+C,EAAgBi+C,EAAa,qBAAqB,CAAC,EAKpE/wE,YAAU,IAAM,CACd,MAAMixE,EAAe5nD,GAA8B,CACjD,GAAI,CAKF,QAAQ,KAAK,4CAA6CA,EAAG,MAAM,EACnEA,EAAG,kBACL,OAASlnB,EAAK,CACZ,eAAQ,MAAM,0CAA2CA,CAAG,EACrD,EACT,CACF,EACA,cAAO,iBAAiB,qBAAsB8uE,CAAkB,EACzD,IACL,OAAO,oBAAoB,qBAAsBA,CAAkB,CACvE,EAAG,EAAE,EAGLjxE,YAAU,IAAM,CACd,MAAMkhC,EAAQ,aAAa,QAAQ,WAAW,EACzCA,GAGL,MAAM,GAAG4b,CAAO,eAAgB,CAC9B,QAAS,CAAE,cAAe,UAAU5b,CAAK,GAAG,CAC7C,EACE,KAAM9+B,GAAQA,EAAI,MAAM,EACxB,KAAM1b,GAAS,CACd,GAAIA,GAAM,KAAM,CACd0pF,EAAiB1pF,EAAK,IAAI,EAC1B,GAAI,CACF,MAAM8H,EAAS,aAAa,QAC1B,oBAAoB9H,EAAK,KAAK,KAAK,IAEjC8H,GACF4hF,EAAiB,CACf,GAAG1pF,EAAK,KACR,aAAc,KAAK,MAAM8H,CAAM,EAChC,CACL,MAAY,CAAC,CACb0iF,GAAkBxqF,EAAK,IAAI,CAC7B,MAEE,aAAa,WAAW,WAAW,CAEvC,CAAC,EACA,MAAM,IAAM,CAEb,CAAC,CACL,EAAG,EAAE,EAGLsZ,YAAU,IAAM,CACd,GAAI1B,GAAQgyE,EAAY,CACtBE,EAAa,EAAI,EACjB,MAAMtzB,EAAQ,WAAW,IAAMszB,EAAa,EAAK,EAAG,IAAI,EACxD,MAAO,IAAM,aAAatzB,CAAK,CACjC,CACF,EAAG,CAACozB,EAAYhyE,CAAI,CAAC,EAGrB,GAAI,CAEF,GADkB,IAAI,gBAAgB,OAAO,SAAS,MAAM,EAC9C,IAAI,OAAO,IAAM,IAC7B,cACGm0C,GAAA,CACC,UAAApsC,MAAC4+C,GAAA,EAAiB,QACjBmmB,GAAA,EAAU,GACb,CAGN,MAAQ,CAAC,CAETprE,YAAU,IAAM,CACd,MAAMmxE,EAAW,IAAM,CACrB,GAAI,CACF,aAAa,WAAW,UAAU,EAClC,aAAa,WAAW,WAAW,EAC/B7yE,GAAM,OACR,aAAa,WAAW,oBAAoBA,EAAK,KAAK,EAAE,CAC5D,MAAY,CAAC,CACb6xE,EAAQ,IAAI,EACZL,EAAO,OAAO,CAChB,EACA,cAAO,iBAAiB,aAAqBqB,CAAe,EACrD,IACL,OAAO,oBAAoB,aAAqBA,CAAe,CACnE,EAAG,EAAE,EAELnxE,YAAU,IAAM,CACd,GAAI,CAAC1B,GAAM,SAAU,CACnBqyE,EAAY,CAAC,EACb,MACF,CACA,GAAI,CAGF,aAAa,QAAQ,kBAAmBryE,EAAK,QAAQ,EACpD,OAAe,eAAiBA,EAAK,QACxC,MAAQ,CAAC,CACT,GAAI,CACF4kC,GAAoB5kC,EAAK,QAAQ,CACnC,MAAQ,CAAC,CAGT,MAAM8yE,EAAa,WAAW,IAAM,CAClC,GAAI,CAAEluC,GAAoB5kC,EAAK,QAAQ,CAAG,MAAQ,CAAC,CACrD,EAAG,GAAI,EACDwwC,EAAU,IAAM,CACpB,MAAMuiC,GACJp9B,IAAY,MACRpO,GAAevnC,EAAK,QAAQ,EAC5BslC,GAActlC,EAAK,QAAQ,EACjCmyE,EAAcY,EAAO,EACrB,MAAMrrE,GAAM,0BAA0B1H,EAAK,QAAQ,GAC7CwJ,GAAM,KAAK,MACXwpE,GAAe,IAAI,OAAO,WAC1BC,GAAc,IAAI,OAAO,cAE/B,GAAI,CACF,MAAMzyE,GAAM,aAAa,QAAQkH,EAAG,EACpC,GAAI,CAAClH,GAAK,CACR,aAAa,QACXkH,GACA,KAAK,UAAU,CACb,MAAOqrE,GACP,GAAIvpE,GACJ,MAAOwpE,GACP,KAAMC,EAAA,CACP,GAEHZ,EAAY,CAAC,EACb,MACF,CACA,MAAMpnD,GAAS,KAAK,MAAMzqB,EAAG,EACvB0yE,GAAW,OAAOjoD,IAAQ,KAAK,GAAK,EACpCkoD,GAAgB,OAAOloD,IAAQ,KAAK,EAI1C,GAHqB,OAAOA,IAAQ,IAAI,IAGnBgoD,IAAeE,KAAkBH,GAEpD,aAAa,QACXtrE,GACA,KAAK,UAAU,CACb,MAAOqrE,GACP,GAAIvpE,GACJ,MAAOwpE,GACP,KAAMC,EAAA,CACP,GAEHZ,EAAY,CAAC,MACR,CAEL,MAAMp4D,GAAQ84D,GAAUG,GACxBb,EAAY,OAAO,SAASp4D,EAAK,EAAIA,GAAQ,CAAC,CAChD,CACF,MAAQ,CACNo4D,EAAY,CAAC,CACf,CACF,EACA7hC,EAAA,EACA,MAAM4iC,EAAW,IAAM5iC,EAAA,EACjBxlB,GAAazlC,IAAoB,CACrC,MAAMmiB,GAAMniB,GAAE,KAAO,GACrB,GAAI,CAACmiB,GAAK,OAEO,CACf,aAAa1H,EAAK,QAAQ,GAC1B,gBAAgBA,EAAK,QAAQ,GAC7B,mBAAmBA,EAAK,QAAQ,GAChC,0BAA0BA,EAAK,QAAQ,IAE5B,KAAMhb,IAAM0iB,GAAI,WAAW1iB,EAAC,CAAC,GAAGwrD,EAAA,CAC/C,EACA,cAAO,iBAAiB,oBAAqB4iC,CAAe,EAC5D,OAAO,iBAAiB,UAAWpoD,EAAS,EACrC,IAAM,CACX,aAAa8nD,CAAU,EACvB,OAAO,oBAAoB,oBAAqBM,CAAe,EAC/D,OAAO,oBAAoB,UAAWpoD,EAAS,CACjD,CACF,EAAG,CAAChrB,GAAM,SAAU21C,CAAO,CAAC,EAI5Bj0C,YAAU,IAAM,CACd,GAAI,CAAC1B,GAAM,SAAU,OACrB,MAAMqzE,EAAmB,IAAM,CACxB,SAAS,QACZzuC,GAAoB5kC,EAAK,QAAQ,EAAE,KAAK,IAAM,CAE5C,OAAO,cAAc,IAAI,YAAY,oBAAqB,CAAE,OAAQ,CAAE,KAAMA,EAAK,SAAS,CAAG,CAAC,CAChG,CAAC,EAAE,MAAM,IAAM,CAAC,CAAC,CAErB,EACMszE,EAAc,IAAM,CACxB1uC,GAAoB5kC,EAAK,QAAQ,EAAE,KAAK,IAAM,CAC5C,OAAO,cAAc,IAAI,YAAY,oBAAqB,CAAE,OAAQ,CAAE,KAAMA,EAAK,SAAS,CAAG,CAAC,CAChG,CAAC,EAAE,MAAM,IAAM,CAAC,CAAC,CACnB,EACA,gBAAS,iBAAiB,mBAAoBqzE,CAAgB,EAC9D,OAAO,iBAAiB,QAASC,CAAW,EACrC,IAAM,CACX,SAAS,oBAAoB,mBAAoBD,CAAgB,EACjE,OAAO,oBAAoB,QAASC,CAAW,CACjD,CACF,EAAG,CAACtzE,GAAM,QAAQ,CAAC,EAGnB0B,YAAU,IAAM,CACd,GAAI,CAAC1B,GAAM,SAAU,CACnBoxE,EAAU,EAAE,EACZ,MACF,CACA,MAAMmC,EAAe,aAAa,QAChC,wBAAwBvzE,EAAK,QAAQ,IAEvCoxE,EAAUmC,GAAgB,EAAE,CAC9B,EAAG,CAACvzE,GAAM,QAAQ,CAAC,EAGnB0B,YAAU,IAAM,CACd,MAAM8xE,EAAuBjuF,IAAoB,CAE7CA,GAAE,KAAK,WAAW,uBAAuB,GACzCya,GAAM,UACNza,GAAE,IAAI,SAASya,EAAK,QAAQ,GAE5BoxE,EAAU7rF,GAAE,UAAY,EAAE,CAE9B,EACMkuF,EAAsBluF,IAAW,CAMrC,GAJIA,GAAE,QAAQ,WAAaya,GAAM,UAC/BoxE,EAAU7rF,GAAE,QAAQ,QAAU,EAAE,EAG9Bya,GAAM,SAAU,CAClB,MAAMuzE,GAAe,aAAa,QAChC,wBAAwBvzE,EAAK,QAAQ,IAEvCoxE,EAAUmC,IAAgB,EAAE,CAC9B,CACF,EAEMG,EAAyB,IAAM,CACnC,GAAI,CAAC,SAAS,QAAU1zE,GAAM,SAAU,CACtC,MAAMuzE,GAAe,aAAa,QAChC,wBAAwBvzE,EAAK,QAAQ,IAEvCoxE,EAAUmC,IAAgB,EAAE,CAC9B,CACF,EAGMI,GAAsB,YAAY,IAAM,CAC5C,GAAI3zE,GAAM,SAAU,CAClB,MAAMuzE,GAAe,aAAa,QAChC,wBAAwBvzE,EAAK,QAAQ,IAEnCuzE,IAAgBA,KAAiBpC,GACnCC,EAAUmC,EAAY,CAE1B,CACF,EAAG,GAAK,EAER,cAAO,iBAAiB,UAAWC,CAAmB,EACtD,OAAO,iBACL,qBACAC,CAAA,EAEF,SAAS,iBAAiB,mBAAoBC,CAAsB,EAC7D,IAAM,CACX,OAAO,oBAAoB,UAAWF,CAAmB,EACzD,OAAO,oBACL,qBACAC,CAAA,EAEF,SAAS,oBAAoB,mBAAoBC,CAAsB,EACvE,cAAcC,EAAmB,CACnC,CACF,EAAG,CAAC3zE,GAAM,SAAUmxE,CAAM,CAAC,EAG3BzvE,YAAU,IAAM,CACd,MAAMkyE,EAAY,IAAI,gBAAgB,OAAO,SAAS,MAAM,EACtDC,EAAOD,EAAU,IAAI,MAAM,EAC3BE,EAAiBF,EAAU,IAAI,iBAAiB,EACtD,GACEC,IAAS,KACTA,IAAS,mBACTC,IAAmB,OACnB,CACA,MAAMC,GAAkB,aAAa,QAAQ,uBAAuB,EAChEA,IAAmB/zE,GAAM,OAE3B,MAAM,GAAGw+C,CAAO,uBAAwB,CACtC,OAAQ,OACR,QAAS,CAAE,eAAgB,oBAC3B,KAAM,KAAK,UAAU,CACnB,MAAOx+C,EAAK,MACZ,YAAa+zE,EAAA,CACd,EACF,EACE,KAAMjwE,IAAQA,GAAI,MAAM,EACxB,KAAM1b,IAAS,CACVA,GAAK,IACP,MAAM,gCAAgC,EACtC,aAAa,WAAW,uBAAuB,EAE3CA,GAAK,OACP,aAAa,QAAQ,YAAaA,GAAK,KAAK,EAE1CA,GAAK,MACP0pF,EAAiB1pF,GAAK,IAAI,EAG5B,OAAO,QAAQ,aACb,GACA,SAAS,MACT,OAAO,SAAS,WAGlB,MACE,+BAAiCA,GAAK,OAAS,iBAGrD,CAAC,EACA,MAAM,IAAM,CACX,MAAM,uCAAuC,CAC/C,CAAC,CAEP,CACF,EAAG,CAAC4X,GAAM,KAAK,CAAC,EAGhB0B,YAAU,IAAM,CACd,MAAMsyE,EAAqB,IACzB1C,EAAgB,CAAC,CAAC,SAAS,iBAAiB,EAC9C,gBAAS,iBAAiB,mBAAoB0C,CAAkB,EAEhE1C,EAAgB,CAAC,CAAC,SAAS,iBAAiB,EACrC,IACL,SAAS,oBAAoB,mBAAoB0C,CAAkB,CACvE,EAAG,EAAE,EAGLtyE,YAAU,IAAM,CACI,IAAI,gBAAgB,OAAO,SAAS,MAAM,EAC7B,IAAI,cAAc,IAC5B,WAAa1B,GAAM,OAEtC,MAAM,GAAGw+C,CAAO,eAAgB,CAC9B,QAAS,CACP,cAAe,UAAU,aAAa,QAAQ,WAAW,CAAC,GAC5D,CACD,EACE,KAAM16C,GAAQA,EAAI,MAAM,EACxB,KAAM1b,GAAS,CACVA,GAAM,OACR0pF,EAAiB1pF,EAAK,IAAI,EAC1B,MAAM,8CAA8C,EAEpD,OAAO,QAAQ,aACb,GACA,SAAS,MACT,OAAO,SAAS,UAGtB,CAAC,EACA,MAAM,IAAM,CACX,MACE,oFAEJ,CAAC,CAEP,EAAG,CAAC4X,GAAM,KAAK,CAAC,EAIhB0B,YAAU,IAAM,CACd,MAAMizC,EAAK,OAAO,WAAW,oBAAoB,EAC3CpqD,EAAS,IAAMmnF,EAAY/8B,EAAG,OAAO,EAC3CpqD,EAAA,EAEA,GAAI,CACFoqD,EAAG,iBAAiB,SAAUpqD,CAAM,CACtC,MAAQ,CAENoqD,EAAG,YAAYpqD,CAAM,CACvB,CAEA,cAAO,iBAAiB,SAAUA,CAAM,EACxC,OAAO,iBAAiB,oBAAqBA,CAAM,EAE5C,IAAM,CACX,OAAO,oBAAoB,SAAUA,CAAM,EAC3C,OAAO,oBAAoB,oBAAqBA,CAAM,EACtD,GAAI,CACFoqD,EAAG,oBAAoB,SAAUpqD,CAAM,CACzC,MAAQ,CACNoqD,EAAG,eAAepqD,CAAM,CAC1B,CACF,CACF,EAAG,EAAE,EAILmX,YAAU,IAAM,CACd,SAASuyE,GAAqB,CAC5B,MAAMz/E,EAAK,SAAS,eAAe,YAAY,EAC/C,GAAI,CAACA,EAAI,OACT,MAAMhP,EAAI,KAAK,KAAKgP,EAAG,wBAAwB,MAAM,EACrD,SAAS,gBAAgB,MAAM,YAAY,iBAAkB,GAAGhP,CAAC,IAAI,CACvE,CAEA,OAAAyuF,EAAA,EACA,OAAO,iBAAiB,SAAUA,CAAkB,EACpD,OAAO,iBAAiB,oBAAqBA,CAAkB,EAGxD,IAAM,CACX,OAAO,oBAAoB,SAAUA,CAAkB,EACvD,OAAO,oBAAoB,oBAAqBA,CAAkB,CACpE,CACF,EAAG,CAAC3B,CAAS,CAAC,EAGd5wE,YAAU,IAAM,CACd,GAAI,CAAC+vE,EAAU,OACf,MAAM7oE,EAAW,SAAS,eAAe,iBAAiB,EAC1D,GAAI,CAACA,EAAU,OACf,IAAIsrE,EAAUtrE,EAAS,UACvB,MAAMurE,EAAW,IAAM,CACrB,MAAMC,GAAaxrE,EAAS,UACxBwrE,GAAaF,EACf,SAAS,gBAAgB,UAAU,IAAI,mBAAmB,EACjDE,GAAaF,GACtB,SAAS,gBAAgB,UAAU,OAAO,mBAAmB,EAE/DA,EAAUE,EACZ,EACA,OAAAxrE,EAAS,iBAAiB,SAAUurE,EAAU,CAAE,QAAS,GAAM,EACxD,IAAM,CACXvrE,EAAS,oBAAoB,SAAUurE,CAAQ,EAC/C,SAAS,gBAAgB,UAAU,OAAO,mBAAmB,CAC/D,CACF,EAAG,CAAC1C,CAAQ,CAAC,EAEb/vE,YAAU,IAAM,CACd,GAAK+vE,EACL,OAAIE,EACF,SAAS,gBAAgB,UAAU,IAAI,eAAe,EAEtD,SAAS,gBAAgB,UAAU,OAAO,eAAe,EAEpD,IAAM,CACX,SAAS,gBAAgB,UAAU,OAAO,eAAe,CAC3D,CACF,EAAG,CAACF,EAAUE,CAAO,CAAC,EAGtBjwE,YAAU,IAAM,CACd,MAAMmxE,EAAW,IAAM,CACrB,GAAI,CAEF,aAAa,WAAW,YAAY,EAChC7yE,GAAM,OACR,aAAa,WAAW,oBAAoBA,EAAK,KAAK,EAAE,CAC5D,MAAY,CAAC,CACb6xE,EAAQ,IAAI,EACZL,EAAO,OAAO,CAChB,EACA,cAAO,iBAAiB,aAAqBqB,CAAe,EACrD,IACL,OAAO,oBAAoB,aAAqBA,CAAe,CACnE,EAAG,EAAE,EAGLnxE,YAAU,IAAM,CACd,MAAM2yE,EAAU9uF,GAAW,CACzB,GAAI,CACF,MAAMkW,EAAO,OAAOlW,GAAG,QAAQ,UAAY,EAAE,EAAE,OAC/C,GAAI,CAACkW,EAAM,OACXo2E,EAASj2E,IACGA,IAAO,CAAE,GAAGA,GAAM,SAAUH,EAEvC,EAGD,GAAI,CACF,MAAMuF,IAAShB,GAAM,OAAS,IAAI,cAC9BwW,GAAM/a,GAAQuF,IAChBwV,EAAG,KAAK,CAAE,KAAM,WAAY,SAAU/a,EAAM,MAAAuF,GAAO,CACvD,MAAY,CAAC,CACf,MAAY,CAAC,CACf,EACA,cAAO,iBAAiB,uBAA+BqzE,CAAa,EAC7D,IACL,OAAO,oBAAoB,uBAA+BA,CAAa,CAC3E,EAAG,CAAC79D,EAAIxW,GAAM,KAAK,CAAC,EAGpB0B,YAAU,IAAM,CACd,MAAM4yE,EAAe/uF,GAAW,CAC9B,GAAI,CACF,MAAMgsF,EAAM,OAAOhsF,GAAG,QAAQ,KAAO,EAAE,EAAE,OACzC,GACEgsF,GACA,CACE,QACA,UACA,SACA,QACA,WACA,QACA,cACA,WACA,SAASA,CAAG,EACd,CACAC,EAAOD,CAAa,EAKpB,GAAI,CACF,MAAMgD,GAAQ,SAAS,cACrB,qBAEF,GACEA,IACA,OAAO,OAAW,KAClB,OAAO,OAAO,kBAAqB,WACnC,CACA,MAAM91C,GAAO81C,GAAM,wBACbC,GAAS,KAAK,IAAI,EAAG,KAAK,MAAM/1C,GAAK,MAAQ,CAAC,CAAC,EACrD,SAAS,gBAAgB,MAAM,YAC7B,yBACA,GAAG+1C,EAAM,KAEb,CAeA,MAAMjxC,GAZoC,CACxC,MAAO,MACP,OAAQ,MACR,QAAS,MACT,YAAa,MACb,QAAS,MACT,MAAO,MACP,UAAW,MACX,SAAU,MACV,MAAO,MACP,WAAY,OAEQguC,CAAG,GAAK,MAC9B,SAAS,gBAAgB,MAAM,YAC7B,oBACAhuC,EAAA,CAEJ,MAAc,CAGd,CACF,CACF,MAAY,CAAC,CACf,EACA,cAAO,iBAAiB,iBAAyB+wC,CAAkB,EAC5D,IACL,OAAO,oBAAoB,iBAAyBA,CAAkB,CAC1E,EAAG,EAAE,EAEL,eAAe1B,GAAkBnyE,EAAQ,CACvC,GAAI,CACF,MAAMxb,EAAIwb,GAAG,MAAQ,UAAU,mBAAmBA,EAAE,KAAK,CAAC,GAAK,GACzDqD,EAAM,MAAM,MAAM,oBAAsB7e,CAAC,EAC/C,GAAI,CAAC6e,EAAI,GAAI,OACb,MAAM1b,GAAO,MAAM0b,EAAI,OAGvBguE,EAAiB,CACf,GAAGrxE,EACH,WAAY,CAAC,CAACrY,IAAM,WACpB,aAAcA,EAAA,CACf,EACD,GAAI,CACEqY,GAAG,OACL,aAAa,QACX,oBAAoBA,EAAE,KAAK,GAC3B,KAAK,UAAUrY,EAAI,EAEzB,MAAQ,CAAC,CACX,MAAY,CAAC,CACf,CAGA,KAAM,CAACqsF,GAAuBC,EAAwB,EAAI/tF,WAAS,EAAK,EAClE,CAACguF,GAAmBC,EAAoB,EAAIjuF,WAAS,EAAK,EAC1D,CAACkuF,GAAmBC,CAAoB,EAAInuF,WAAgB,EAAE,EAC9D,CAACouF,EAAoBC,EAAqB,EAAIruF,WAAS,CAAC,EACxD,CAACsuF,GAAoBC,EAAqB,EAAIvuF,WAAS,CAAC,EAExDwuF,GAAuB7oF,cAAY,SAAY,CACnD,GAAI,CAAC0T,GAAM,MAAO,MAAO,GACzB,GAAI,CACF,MAAM4iC,EAAQ,aAAa,QAAQ,WAAW,EACxC+M,EAAkC,GACpC/M,IAAO+M,EAAQ,cAAgB,UAAU/M,CAAK,IAClD,MAAM9+B,EAAM,MAAM,MAChB,4BAA4B,mBAAmB9D,EAAK,KAAK,CAAC,GAC1D,CAAE,QAAA2vC,CAAA,CAAQ,EAEZ,OAAK7rC,EAAI,GACD,MAAMA,EAAI,QAAW,GADT,EAEtB,MAAc,CACZ,MAAO,EACT,CACF,EAAG,CAAC9D,GAAM,KAAK,CAAC,EAEVo1E,GAAsB9oF,cAAY,SAAY,CAClD,GAAI,CAAC0T,GAAM,MAAO,CAChBg1E,GAAsB,CAAC,EACvBE,GAAsB,CAAC,EACvB,MACF,CACA,GAAI,CACF,KAAM,CAACluE,EAAaC,CAAW,EAAI,MAAM,QAAQ,IAAI,CACnDzD,GACE,+BAA+B,mBAAmBxD,EAAK,KAAK,CAAC,IAE/DwD,GACE,+BAA+B,mBAAmBxD,EAAK,KAAK,CAAC,GAC/D,CACD,EACKkH,EAAWF,EAAY,GACzB,MAAMA,EAAY,OAClB,CAAE,SAAU,EAAC,EACXqkC,GAAWpkC,EAAY,GACzB,MAAMA,EAAY,OAClB,CAAE,SAAU,EAAC,EACjB+tE,GAAsB9tE,EAAS,UAAU,QAAU,CAAC,EACpDguE,IACG7pC,GAAS,UAAY,IAAI,OAAQvmD,IAAW,CAACA,GAAE,IAAI,EAAE,OAE1D,OAAS+e,EAAK,CACZ,eAAQ,MAAM,0CAA2CA,CAAG,EACrD,EACT,CACA,MAAO,EACT,EAAG,CAAC7D,GAAM,KAAK,CAAC,EAIVq1E,GAAwBlrF,SAAe,CAAC,EACxCmrF,EAA6BnrF,SAAsB,IAAI,EA0L7D,GAxLAuX,YAAU,IAAM,CACd,GAAI,CAAC1B,GAAM,aAAc,CACvB00E,GAAyB,EAAK,EAC9B,MACF,CACA,MAAM5vE,EAAM9E,EAAK,aACXwJ,EAAM,KAAK,MACjB,IAAI0vB,EAA2B,KAC3Bp0B,GAAK,YACPo0B,EACE,OAAOp0B,EAAI,WAAc,SACrB,KAAK,MAAMA,EAAI,SAAS,EACxB,OAAOA,EAAI,SAAS,GAG5B,MAAMywE,GAAgB,KAAc,GAAK,IACzC,GAAIr8C,GAAaA,EAAY1vB,GAAO0vB,EAAY1vB,GAAO+rE,GAAe,CACpEb,GAAyB,EAAI,EAC7B,MACF,CAEA,GAAIx7C,GAAaA,GAAa1vB,GAAO,CAACxJ,GAAM,WAAY,CACtD00E,GAAyB,EAAI,EAC7B,MACF,CAEA,GAAI5vE,GAAK,SAAW,UAAYA,GAAK,QAAUA,EAAI,SAAW,SAAU,CACtE4vE,GAAyB,EAAI,EAC7B,MACF,CACAA,GAAyB,EAAK,CAChC,EAAG,CAAC10E,GAAM,aAAcA,GAAM,UAAU,CAAC,EAGzC0B,YAAU,IAAM,CACd,IAAIkF,EAAU,GACd,GAAI,CAAC5G,GAAM,MACT,OAAA80E,EAAqB,EAAE,EAChB,IAAM,CACXluE,EAAU,EACZ,EAEF,MAAMg4D,EAAO,SAAY,CACvB,MAAMx2E,GAAO,MAAM+sF,GAAA,EACdvuE,GACLkuE,EAAqB1sF,IAAQ,EAAE,CACjC,EACAw2E,EAAA,EACA,MAAM4W,EAAM,YAAY5W,EAAM,GAAK,EACnC,MAAO,IAAM,CACXh4D,EAAU,GACV,cAAc4uE,CAAG,CACnB,CACF,EAAG,CAACL,GAAsBn1E,GAAM,KAAK,CAAC,EAEtC0B,YAAU,IAAM,CAKd,GAAI,CAAC1B,GAAM,MAAO,OAClB,IAAI4G,EAAU,GAEd,MAAM6uE,EAAe,SAAY,CAC/B,GAAI,CAEF,GADI,CAAC7uE,GACD,OAAO,SAAa,KAAe,CAAC,SAAS,WAAY,OAE7D,MAAME,GAAgBwuE,EAA2B,QACjD,GAAIxuE,IAAiB,KAAK,MAAQA,GAAe,OAEtC,MAAMsuE,GAAA,GAEfC,GAAsB,QAAU,EAChCC,EAA2B,QAAU,OAErCD,GAAsB,SACnBA,GAAsB,SAAW,GAAK,EACrCA,GAAsB,SAAW,IAEnCC,EAA2B,QAAU,KAAK,MAAQ,IAAS,IAC3D,QAAQ,KACN,2EAIR,MAAQ,CAAC,CACX,EAGAG,EAAA,EAEA,MAAMxoF,EAAU,IAAM,CACpB,GAAI,CACFwoF,EAAA,CACF,MAAQ,CAAC,CACX,EAEA,OAAO,iBAAiB,QAASxoF,CAAO,EAGxC,MAAMma,GAAW,YAAY,IAAM,CACjC,GAAI,CACFquE,EAAA,CACF,MAAQ,CAAC,CACX,EAAG,GAAK,EAER,MAAO,IAAM,CACX7uE,EAAU,GACV,OAAO,oBAAoB,QAAS3Z,CAAO,EAC3C,cAAcma,EAAQ,CACxB,CACF,EAAG,CAACguE,GAAqBp1E,GAAM,KAAK,CAAC,EAErC0B,YAAU,IAAM,CACT1B,GAAM,QACTg1E,GAAsB,CAAC,EACvBE,GAAsB,CAAC,EAE3B,EAAG,CAACl1E,GAAM,KAAK,CAAC,EAGhB0B,YAAU,IAAM,CACd,GAAI,CAAC1B,GAAM,cAAgB,CAACA,GAAM,MAAO,OACzC,MAAM8E,EAAM9E,EAAK,aACXwJ,EAAM,KAAK,MACjB,IAAI0vB,EAA2B,KAC3Bp0B,GAAK,YACPo0B,EACE,OAAOp0B,EAAI,WAAc,SACrB,KAAK,MAAMA,EAAI,SAAS,EACxB,OAAOA,EAAI,SAAS,GAC5B,MAAMywE,GAAgB,KAAc,GAAK,IACzC,eAAeG,GAA4B16C,GAAcgI,GAAiB,CACxE,GAAI,CACF,MAAMJ,GAAQ,aAAa,QAAQ,WAAW,EACxC+M,GAAe,CAAE,eAAgB,oBACnC/M,KAAO+M,GAAQ,cAAgB,UAAU/M,EAAK,IAClD,MAAM,MAAM,qBAAsB,CAChC,OAAQ,OACR,QAAA+M,GACA,KAAM,KAAK,UAAU,CAAE,MAAO3vC,EAAK,MAAO,QAAAgjC,GAAS,KAAAhI,EAAA,CAAM,EAC1D,CACH,MAAY,CAAC,CACf,CACA,GAAI9B,GAAaA,EAAY1vB,GAAO0vB,EAAY1vB,GAAO+rE,GAAe,CACpEG,GACE,eACA,wCAAwC,KAAK,MAAMx8C,EAAY1vB,IAAQ,KAAU,GAAK,IAAK,CAAC,WAE9F,MACF,CACA,GAAI0vB,GAAaA,GAAa1vB,GAAO,CAACxJ,GAAM,WAAY,CACtD01E,GACE,cACA,uCAEF,MACF,CACF,EAAG,CAAC11E,GAAM,MAAOA,GAAM,aAAcA,GAAM,UAAU,CAAC,EAEtD0B,YAAU,IAAM,CACd,GAAI,CAACizE,GAAmB,OAExB,MAAMzwB,EAAah3D,GAAyB,CACtCA,EAAM,MAAQ,UAAU0nF,GAAqB,EAAK,CACxD,EACA,gBAAS,iBAAiB,UAAW1wB,CAAS,EACvC,IAAM,CACX,SAAS,oBAAoB,UAAWA,CAAS,CACnD,CACF,EAAG,CAACywB,EAAiB,CAAC,EAGtBjzE,YAAU,IAAM,CACd,MAAM25D,EAAS,IAAMuZ,GAAqB,EAAI,EAC9C,cAAO,iBAAiBxE,GAAqC/U,CAAa,EACnE,IACL,OAAO,oBACL+U,GACA/U,CAAA,CAEN,EAAG,EAAE,EAED,CAACr7D,EACH,OACE+H,MAAC81C,GAAA,CACC,OAASp9C,GAAW,CAClB,GAAI,CACF,MAAMvQ,EAAS,aAAa,QAAQ,oBAAoBuQ,EAAE,KAAK,EAAE,EAE/DqxE,EADE5hF,EACe,CAAE,GAAGuQ,EAAG,aAAc,KAAK,MAAMvQ,CAAM,GACpCuQ,CADuC,CAE/D,MAAQ,CACNqxE,EAAiBrxE,CAAC,CACpB,CACAmyE,GAAkBnyE,CAAC,CACrB,IAIN,MAAMk1E,EAAiB,oCAAoC,mBACzD31E,EAAK,UAAY,MAClB,8DACK41E,GAAoB7wF,GACxB,GAAGA,EAAE,MAAQ,EAAE,IAAIA,EAAE,SAAW,EAAE,GAAG,OACjC8wF,GAAmBhB,GAAkB,OAAQ9vF,GACjD,wBAAwB,KAAK6wF,GAAiB7wF,CAAC,CAAC,GAChD,OACI+wF,GAAgBjB,GAAkB,OAAQ9vF,GAC9C,oBAAoB,KAAK6wF,GAAiB7wF,CAAC,CAAC,GAC5C,OACIgxF,GAAoBlB,GAAkB,OAAQ9vF,GAClD,kBAAkB,KAAK6wF,GAAiB7wF,CAAC,CAAC,GAC1C,OACIixF,GAAyB,CAC7B,CACE,IAAK,cACL,MAAO,sBACP,YAAa,+BACb,MAAOH,GACP,KAAMnxE,EAAA,EAER,CACE,IAAK,WACL,MAAO,YACP,YAAa,6CACb,MAAOoxE,GACP,KAAMG,EAAA,EAER,CACE,IAAK,gBACL,MAAO,gBACP,YAAa,mCACb,MAAOF,GACP,KAAMG,EAAA,EAER,CACE,IAAK,kBACL,MAAO,kBACP,YAAa,qCACb,MAAOnB,EACP,KAAMtwE,EAAA,EAER,CACE,IAAK,WACL,MAAO,WACP,YAAa,4BACb,MAAOwwE,GACP,KAAM/sE,EAAA,CACR,EAEF,cACGisC,GAAA,CACC,UAAArsC,OAAC,OACC,IAAKopE,EACL,UAAW,GAAGlxE,GAAM,WAAa,eAAiB,EAAE,mHAEpD,UAAA+H,MAACm7B,GAAA,EAAQ,EACTp7B,OAAC,OAAI,UAAU,wGAEZ,WAAC2pE,GACA1pE,MAAC,OAAI,UAAU,gCACb,SAAAA,MAACtC,GAAA,CACC,UAAU,gBACV,OAAQ8rE,EACR,SAAW,GAAM,CACfC,EAAO,CAAC,CACV,EACA,KAAAxxE,CAAA,GAEJ,EAKF8H,OAAC,OAAI,UAAU,uCACb,UAAAA,OAAC,OAAI,UAAU,6BACb,UAAAA,OAAC,UACC,GAAG,aACH,cAAY,aACZ,UAAW,6FACTwqE,EAAY,YAAc,WAC5B,GACA,MAAO,CAAE,WAAY,aAEpB,UAAAb,GACC1pE,MAAC,UACC,UAAU,8NACV,QAAS,IAAM,CACbypE,EAAO,OAAO,EACdI,EAAW,EAAK,CAClB,EACA,aAAW,UACX,MAAM,UACP,oBAMH9pE,OAAC,OAAI,UAAU,sDACZ,WAAC2pE,GACA3pE,OAAC,OAAI,UAAU,oBACb,UAAAC,MAAC,OACC,IAAKopE,GAAUwE,EACf,IAAI,SACJ,UAAU,wFAEZ5tE,MAAC,OAAI,UAAU,8FAA8F,GAC/G,QAED,OAAI,UAAU,UACb,SAAAD,OAAC,OAAI,UAAU,8BACb,UAAAA,OAAC,OAAI,UAAU,0BACZ,UAAA2pE,GACC3pE,OAAC,OAAI,UAAU,gBACb,UAAAC,MAAC,OACC,IAAKopE,GAAUwE,EACf,IAAI,SACJ,UAAU,0EAEZ5tE,MAAC,OAAI,UAAU,8FAA8F,GAC/G,EAEFD,OAAC,QAAK,UAAU,sDAAsD,qBAC3D,IACTC,MAAC,QAAK,UAAU,uBACb,WAAK,SACR,GACF,GACF,EACAD,OAAC,OAAI,UAAU,yFACb,UAAAC,MAAC,QAAK,UAAU,sDACb,SAAA4tC,IAAY,MACT,oBACA,sBACN,QACC,QAAK,UAAU,4DACb,SAAAmzB,EAAW,QAAQ,CAAC,EACvB,EACCyJ,IAAoB,GACnBzqE,OAAC,QACC,UAAW,gEACTyqE,EAAkB,EACd,mBACA,eACN,GAEC,UAAAA,EAAkB,QAChB4D,GAAA,CAAa,UAAU,UAAU,EAElCpuE,MAACquE,GAAA,CAAe,UAAU,UAAU,EAErC7D,EAAkB,EAAI,IAAM,GAC5BA,EAAgB,QAAQ,CAAC,IAC5B,EAEJ,GACF,EACF,GACF,EAIC,CAACd,GACA1pE,MAAC,OAAI,UAAU,kCACb,SAAAA,MAAC,MAAG,UAAU,mBACZ,SAAAD,OAAC,UACC,KAAK,SACL,UAAU,qRACV,QAAS,IAAM,CACb0pE,EAAO,OAAO,CAChB,EACA,MAAO,UAEP,gBAAC,QAAK,UAAU,YAAY,kBAAM,QACjC,QAAK,UAAU,mBAAmB,+BAEnC,IACF,CACF,EACF,EAIF1pE,OAAC,OAAI,UAAU,8CACb,UAAAC,MAACuoE,GAAA,CAAgB,UAAU,OAAO,EAClCvoE,MAAC,OAAI,UAAU,sFACb,SAAAA,MAAC,UACC,UAAU,uIACV,QAAS,IAAM,CACb,MAAMvT,EAAK08E,EAAO,QACb18E,IACA,SAAS,kBAET,SAAS,iBAAiB,MAAM,IAAM,CAAC,CAAC,EAD3CA,EAAG,oBAAoB,MAAM,IAAM,CAAC,CAAC,EAEzC,EAEC,WAAe,OAAS,SAE7B,EAEC,CAAC89E,GACAxqE,OAAC,OAAI,UAAU,6CACb,UAAAC,MAAC47C,GAAA,EAAgB,QAChBT,GAAA,EAAc,GACjB,GAIJ,KAKDuuB,SAAa,OAAI,cAAW,GAAC,UAAU,uBAAuB,GACjE,EAECA,GACC1pE,MAACsuE,GAAA,CACC,KAAM1E,EACN,QAAS,IAAMC,EAAW,EAAK,EAC/B,OAAQL,EACR,SAAW,GAAM,CACfC,EAAO,CAAC,EACRI,EAAW,EAAK,CAClB,EACA,KAAA5xE,EACA,OAAQmxE,GAAUwE,CAAA,GAGtB7tE,OAAC,QACC,GAAG,kBACH,UAAU,sDACV,MAAO,CACL,WAAY,kBACZ,UAAW,gBACX,wBAAyB,SAG1B,UAAAypE,IAAQ,YACPxpE,MAACuuE,WAAA,CACC,eAAW,OAAI,UAAU,MAAM,+BAAmB,EAElD,eAACluE,GAAA,CAAW,UAAU,iBACpB,SAAAL,MAACstC,GAAA,CAAc,KAAAr1C,CAAA,CAAY,EAC7B,IAGHuxE,IAAQ,SACPxpE,MAACuuE,YAAS,SAAUvuE,MAAC,OAAI,UAAU,MAAM,2BAAe,EACtD,SAAAA,MAACK,IAAW,UAAU,iBACpB,eAACooE,GAAA,CAAK,KAAAxwE,EAAY,EACpB,EACF,EAEDuxE,IAAQ,UACPxpE,MAACuuE,WAAA,CACC,eAAW,OAAI,UAAU,MAAM,6BAAiB,EAEhD,eAACluE,GAAA,CAAW,UAAU,iBACpB,SAAAL,MAAC6oE,GAAA,CAAW,KAAA5wE,CAAA,CAAY,EAC1B,IAGHuxE,IAAQ,WACPxpE,MAACuuE,WAAA,CACC,eAAW,OAAI,UAAU,MAAM,8BAAkB,EAEjD,eAACluE,GAAA,CAAW,UAAU,iBACpB,SAAAL,MAAC2oE,GAAA,CAAY,KAAA1wE,CAAA,CAAY,EAC3B,IAIJ+H,MAAC,OAAI,UAAWwpE,IAAQ,YAAc,GAAK,SACzC,SAAAxpE,MAACK,GAAA,CACC,eAACwqB,GAAA,EAAW,EACd,EACF,EACC2+C,IAAQ,WACPxpE,MAACuuE,WAAA,CACC,eAAW,OAAI,UAAU,MAAM,8BAAkB,EAEjD,eAACluE,GAAA,CAAW,UAAU,iBACpB,SAAAL,MAAC4oE,GAAA,CAAQ,KAAA3wE,CAAA,CAAY,EACvB,IAGHuxE,IAAQ,SACPxpE,MAACuuE,WAAA,CACC,eAAW,OAAI,UAAU,MAAM,4BAAgB,EAE/C,eAACluE,GAAA,CAAW,UAAU,iBACpB,SAAAL,MAAC8oE,GAAA,CAAW,KAAA7wE,CAAA,CAAY,EAC1B,IAGHuxE,IAAQ,eACPxpE,MAACuuE,WAAA,CACC,eAAW,OAAI,UAAU,MAAM,kCAAsB,EAErD,eAACluE,GAAA,CAAW,UAAU,iBACpB,SAAAL,MAAC+oE,GAAA,CAAY,KAAA9wE,CAAA,CAAY,EAC3B,IAGHuxE,IAAQ,SACPxpE,MAACuuE,WAAA,CACC,eAAW,OAAI,UAAU,MAAM,4BAAgB,EAE/C,eAACluE,GAAA,CAAW,UAAU,iBACpB,SAAAN,OAAC,OAAI,UAAU,2BACb,UAAAC,MAAColC,IAAe,KAAAntC,EAAY,EAC5B+H,MAACipE,IAAa,KAAAhxE,CAAA,CAAY,GAC5B,EACF,IAGHuxE,IAAQ,cACPxpE,MAACuuE,WAAA,CACC,eAAW,OAAI,UAAU,MAAM,mCAAuB,EAEtD,eAACluE,GAAA,CAAW,UAAU,iBACpB,SAAAL,MAACgpE,GAAA,CAAY,KAAA/wE,CAAA,CAAY,EAC3B,GACF,IAGHyxE,GACC1pE,MAACwuE,GAAA,CACC,OAAQhF,EACR,SAAUC,EACV,OAAQ,IAAMI,EAAW,EAAI,GAC/B,EAEJ,GACF,WAIDryB,GAAA,EAAc,QAEd8G,GAAA,EAAO,EAGP,CAAC4rB,GAAalqE,MAACo4C,GAAA,EAAmB,EAElC,CAAC8xB,GAAalqE,MAACo6C,GAAA,EAAqB,EAEpC,CAAC8vB,GAAalqE,MAACg7C,GAAA,EAA2B,EAE1C4xB,IACC5sE,MAAC,OACC,UAAU,2FACV,QAAS,IAAM6sE,GAAqB,EAAK,EAEzC,SAAA9sE,OAAC,OACC,KAAK,SACL,aAAW,OACX,UAAU,0LACV,QAAUviB,GAAMA,EAAE,kBAGlB,UAAAwiB,MAAC,OAAI,UAAU,8HAA8H,EAE7IA,MAAC,OAAI,UAAU,kGAAkG,EACjHA,MAAC,OAAI,UAAU,qGAAqG,EAEpHA,MAAC,UACC,UAAU,uIACV,QAAS,IAAM6sE,GAAqB,EAAK,EACzC,aAAW,sBACZ,eAID9sE,OAAC,OAAI,UAAU,0EACb,UAAAC,MAAC,OAAI,UAAU,yIACb,eAACyuE,GAAA,CAAK,UAAU,UAAU,EAC5B,SACC,OACC,gBAAC,MAAG,UAAU,qHAAqH,yBAEnI,QACC,KAAE,UAAU,oCAAoC,kDAEjD,GACF,GACF,EAEA1uE,OAAC,OAAI,UAAU,gBAEZ,UAAA2sE,IACC3sE,OAAC,OAAI,UAAU,+KACb,UAAAC,MAAC,OAAI,UAAU,kFACb,eAACrD,GAAA,CAAO,UAAU,UAAU,EAC9B,EACAoD,OAAC,OAAI,UAAU,SACb,gBAAC,MAAG,UAAU,mCAAmC,sCAEjD,QACC,KAAE,UAAU,iDAAiD,qHAG9D,EACAC,MAAC,UACC,QAAS,IAAM,CACb6sE,GAAqB,EAAK,EAC1BpD,EAAO,UAAU,CACnB,EACA,UAAU,+LACX,gCAED,EACF,GACF,QAGD,OAAI,UAAU,8CACZ,SAAAwE,GAAuB,IAAK3tF,GAAS,CACpC,MAAMuf,EAAOvf,EAAK,KAClB,OACEyf,OAAC,OAEC,UAAU,iOACV,QAAS,IAAM,CACb8sE,GAAqB,EAAK,GAExBvsF,EAAK,MAAQ,mBACbA,EAAK,MAAQ,aAEbmpF,EAAO,SAAS,EACdnpF,EAAK,MAAQ,eAAempF,EAAO,aAAa,CAEtD,EAEA,UAAAzpE,MAAC,OAAI,UAAU,iLACb,eAACH,EAAA,CAAK,UAAU,UAAU,EAC5B,EACAE,OAAC,OAAI,UAAU,SACb,UAAAC,MAAC,MAAG,UAAU,qEACX,SAAA1f,EAAK,MACR,EACA0f,MAAC,KAAE,UAAU,oEACV,WAAK,YACR,GACF,EACC1f,EAAK,MAAQ,GACZ0f,MAAC,QAAK,UAAU,6GACb,WAAK,MACR,IA3BG1f,EAAK,IA+BhB,CAAC,EACH,EAEAyf,OAAC,OAAI,UAAU,yCACb,gBAAC,MAAG,UAAU,6DAA6D,2BAE3E,EACC+sE,GAAkB,OAAS,GAC1B/sE,OAAC,QAAK,UAAU,oEACb,UAAA+sE,GAAkB,OAAO,UAC5B,GAEJ,EAEA9sE,MAAC,OAAI,UAAU,YACZ,SAAA8sE,GAAkB,SAAW,EAC5B/sE,OAAC,OAAI,UAAU,qFACb,UAAAC,MAAC,OAAI,UAAU,gGACb,eAACyuE,GAAA,CAAK,UAAU,UAAU,EAC5B,QACC,KAAE,UAAU,4BAA4B,mCAEzC,QACC,KAAE,UAAU,6BAA6B,iCAE1C,GACF,EAEA3B,GAAkB,IAAK9vF,GACrB+iB,OAAC,OAEC,UAAW,qFAAqF/iB,EAAE,KAAO,kDAAoD,yEAAyE,GAErO,WAACA,EAAE,MACFgjB,MAAC,OAAI,UAAU,kFAAkF,EAEnGD,OAAC,OAAI,UAAU,uEACb,UAAAA,OAAC,OAAI,UAAU,0BACb,UAAAC,MAAC,QACC,UAAW,4FAA4FhjB,EAAE,KAAO,wCAA0C,+CAA+C,GAExM,WAAE,MAAQ,YAEbgjB,MAAC,QAAK,UAAU,oCACb,aAAI,KAAKhjB,EAAE,SAAS,EAAE,mBACrB,OACA,CACE,MAAO,QACP,IAAK,UACL,KAAM,UACN,OAAQ,UACV,EAEJ,GACF,EACC,CAACA,EAAE,YACD,QAAK,UAAU,yJAAyJ,eAEzK,GAEJ,EAEAgjB,MAAC,KAAE,UAAU,yDACV,WAAE,QACL,EAEChjB,EAAE,MACDgjB,MAAC,KACC,KAAMhjB,EAAE,KACR,OAAO,SACP,IAAI,aACJ,UAAU,qLACX,yBAKH+iB,OAAC,OAAI,UAAU,8HACZ,WAAC/iB,EAAE,MACFgjB,MAAC,UACC,QAAS,MAAOxiB,GAAM,CACpBA,EAAE,kBACF,GAAI,CACF,MAAMq9C,EAAQ,aAAa,QAAQ,WAAW,EAC9C,MAAM,MACJ,sBAAsB,mBAAmB79C,EAAE,EAAE,CAAC,UAAU,mBAAmBib,EAAK,KAAK,CAAC,GACtF,CACE,OAAQ,QACR,QAAS,CACP,eAAgB,mBAChB,cAAe,UAAU4iC,CAAK,IAEhC,KAAM,KAAK,UAAU,CAAE,KAAM,GAAM,EACrC,EAEF,MAAM1Y,GAAU,MAAMirD,GAAA,EAClBjrD,MAA8BA,EAAO,CAC3C,MAAc,CAAC,CACjB,EACA,UAAU,8FACX,0BAIHniB,MAAC,UACC,QAAS,MAAOxiB,GAAM,CAEpB,GADAA,EAAE,kBACE,EAAC,QAAQ,2BAA2B,EACxC,GAAI,CACF,MAAMq9C,EAAQ,aAAa,QAAQ,WAAW,EAC9C,MAAM,MACJ,sBAAsB,mBAAmB79C,EAAE,EAAE,CAAC,UAAU,mBAAmBib,EAAK,KAAK,CAAC,GACtF,CACE,OAAQ,SACR,QAAS,CAAE,cAAe,UAAU4iC,CAAK,GAAG,CAC9C,EAEF,MAAM1Y,GAAU,MAAMirD,GAAA,EAClBjrD,MAA8BA,EAAO,CAC3C,MAAc,CAAC,CACjB,EACA,UAAU,4GACX,mBAED,EACF,IA/FKnlC,EAAE,GAiGV,EAEL,GACF,IACF,GAKH,CAACktF,GAAalqE,MAACk5C,GAAA,EAAqB,EAOpCjhD,GAOC+H,MAAC,OACC,cAAW,GACX,MAAO,CACL,SAAU,QACV,MAAO,EACP,OAAQ,EACR,MAAO,MACP,OAAQ,MACR,SAAU,SACV,cAAe,OACf,QAAS,KAET,OAAQ,KACR,UAAW,iBAGb,SAAAA,MAACuuE,WAAA,CAAS,SAAU,KAClB,SAAAvuE,MAACioE,GAAA,CACC,YAAa,GACb,iBAAgB,GAChB,YAAY,SACZ,oBAAqB,GACrB,iBAAkB,KAEtB,GACF,EAEJ,CAEJ,CAEA,SAASuG,GAAgB,CACvB,OAAA7wE,EACA,SAAAC,EACA,OAAA8wE,CACF,EAIG,CACD,MAAMC,EAAW,CACf,CAAE,IAAK,QAAS,MAAO,OAAQ,KAAMh5B,EAAA,EACrC,CAAE,IAAK,SAAU,MAAO,SAAU,KAAMi5B,EAAA,EACxC,CAAE,IAAK,cAAe,MAAO,UAAW,KAAMjyE,EAAA,EAC9C,CAAE,IAAK,QAAS,MAAO,QAAS,KAAMkyE,EAAA,CAAU,EAGlD,aACG,OAAI,UAAU,iGACb,SAAA9uE,OAAC,OAAI,UAAU,8KACZ,UAAA4uE,EAAS,IAAKruF,GAAS,CACtB,MAAM+B,EAAWsb,IAAWrd,EAAK,IAC3Buf,EAAOvf,EAAK,KAClB,OACEyf,OAAC,UAEC,QAAS,IAAMnC,EAAStd,EAAK,GAAa,EAC1C,UAAW,6HACT+B,EACI,0DACA,oDACN,GAEA,UAAA2d,MAACH,EAAA,CACC,UAAW,6CACTxd,EAAW,6BAA+B,EAC5C,GACA,YAAaA,EAAW,IAAM,IAEhC2d,MAAC,QACC,UAAW,sEACT3d,EAAW,cAAgB,YAC7B,GAEC,SAAA/B,EAAK,QAEP+B,GACC2d,MAAC,QAAK,UAAU,8EAA8E,IAtB3F1f,EAAK,IA0BhB,CAAC,EACD0f,MAAC,OAAI,UAAU,4BAA4B,EAC3CD,OAAC,UACC,QAAS2uE,EACT,UAAW,mKAEX,UAAA1uE,MAAC8uE,GAAA,CAAK,UAAU,UAAU,QACzB,QAAK,UAAU,gDAAgD,gBAEhE,IACF,EACF,EACF,CAEJ,CAGA,SAASR,GAAU,CACjB,KAAAlzB,EACA,QAAA/X,EACA,OAAA1lC,EACA,SAAAC,EACA,KAAA3F,EACA,OAAAmxE,CACF,EAOG,CACD,MAAM3vE,EAAUD,GAAWvB,GAAM,KAAK,EAChCsF,EAAOD,GAAarF,EAAMwB,CAAO,EACjC,CAAC6E,EAAaC,CAAc,EAAI1Y,GAAM,SAAS,EAAK,EACpD,CAAC2Y,EAAgBC,CAAiB,EAAI5Y,GAAM,SAAS,EAAK,EAE1Dy2E,EAAW,oCAAoC,mBACnDrkE,GAAM,UAAY,MACnB,8DACK82E,EAAgB3F,GAAU9M,EAC1B0S,EAAY,CAAC,CAAC/2E,GAAM,WAE1B,OAAKmjD,EAGHr7C,OAAC,OAAI,UAAU,kHAEb,UAAAA,OAAC,OAAI,UAAU,gFACb,UAAAA,OAAC,OAAI,UAAU,0BACb,UAAAA,OAAC,OAAI,UAAU,WACb,UAAAC,MAAC,OACC,IAAK+uE,EACL,UAAW,8CACTC,EACI,iDACA,eACN,GACA,IAAK/2E,EAAK,WAEX+2E,SACE,OAAI,UAAU,gGACb,SAAAhvE,MAACrD,GAAA,CAAO,UAAU,UAAU,EAC9B,GAEJ,EACAoD,OAAC,OAAI,UAAU,gBACb,UAAAC,MAAC,QAAK,UAAU,8CACb,SAAA/H,EAAK,SACR,EACA+H,MAAC,QACC,UAAW,gDAAgDgvE,EAAY,kBAAoB,eAAe,GAEzG,WAAY,iBAAmB,gBAClC,EACF,GACF,EACAhvE,MAAC,UACC,QAASqjC,EACT,UAAU,8IAEV,SAAArjC,MAAC2Q,GAAA,CAAE,UAAU,UAAU,GACzB,EACF,EAGA5Q,OAAC,OACC,UAAU,6BACV,MAAO,CAAE,wBAAyB,SAElC,gBAAC,MAAG,UAAU,uEAAuE,gBAErF,QACC,OAAI,UAAU,8BACZ,SAAAxC,EAAK,IAAKisE,GAAQ,CACjB,MAAM3pE,EAAO2pE,EAAI,KACXnnF,EAAWsb,IAAW6rE,EAAI,IAChC,OACEzpE,OAAC,UAEC,QAAS,IAAM,CACbnC,EAAS4rE,EAAI,GAAa,EAC1BnmC,EAAA,CACF,EACA,UAAW,4GACThhD,EACI,4EACA,mGACN,GAEA,UAAA2d,MAAC,OACC,UAAW,kBAAkB3d,EAAW,cAAgB,qCAAqC,GAE7F,SAAA2d,MAACH,EAAA,CAAK,UAAU,UAAU,IAE5BG,MAAC,QAAK,UAAU,oBAAqB,WAAI,MAAM,IAhB1CwpE,EAAI,IAmBf,CAAC,EACH,QAEC,MAAG,UAAU,uEAAuE,qBAErF,EACAzpE,OAAC,OAAI,UAAU,kBACb,UAAAA,OAAC,UACC,QAAS,IAAMxB,EAAe,EAAI,EAClC,UAAU,gKAEV,UAAAyB,MAACG,GAAA,CAAc,UAAU,UAAU,EACnCJ,OAAC,OAAI,UAAU,4BACb,gBAAC,QAAK,UAAU,YAAY,2BAAe,QAC1C,QAAK,UAAU,qBAAqB,gCAAoB,GAC3D,KAGFA,OAAC,UACC,QAAS,IAAMtB,EAAkB,EAAI,EACrC,UAAU,gKAEV,UAAAuB,MAACG,GAAA,CAAc,UAAU,UAAU,EACnCJ,OAAC,OAAI,UAAU,4BACb,gBAAC,QAAK,UAAU,YAAY,yBAAa,QACxC,QAAK,UAAU,qBAAqB,8BAAkB,GACzD,IACF,EACF,KAIDzB,SACE,OAAI,UAAU,2HACb,SAAAyB,OAAC,OAAI,UAAU,iFACb,gBAAC,MAAG,UAAU,oCAAoC,gCAElD,QACC,KAAE,UAAU,8BAA8B,6DAE3C,EACAA,OAAC,OAAI,UAAU,yBACb,UAAAC,MAAC,UACC,QAAS,IAAMzB,EAAe,EAAK,EACnC,UAAU,iFACX,oBAGDyB,MAAC,KACC,KAAMzF,GACN,OAAO,SACP,IAAI,sBACJ,UAAU,gGACX,iBAED,EACF,GACF,EACF,EAGDiE,SACE,OAAI,UAAU,2HACb,SAAAuB,OAAC,OAAI,UAAU,iFACb,gBAAC,MAAG,UAAU,oCAAoC,yBAAa,QAC9D,KAAE,UAAU,8BAA8B,gDAE3C,EACAA,OAAC,OAAI,UAAU,yBACb,UAAAC,MAAC,UACC,QAAS,IAAMvB,EAAkB,EAAK,EACtC,UAAU,iFACX,oBAGDuB,MAAC,KACC,KAAK,oCACL,OAAO,SACP,IAAI,sBACJ,UAAU,gGACX,iBAED,EACF,GACF,EACF,GAEJ,EAlKgB,IAoKpB,CC52DA,SAASivE,GAAiB/4B,EAAkB,CAC1C,OACEA,EAAS,QAAU,IACnB,KAAK,KAAKA,CAAQ,GAClB,eAAe,KAAKA,CAAQ,CAEhC,CAEA,SAAwBg5B,IAAgB,CACtC,KAAM,CAACr0C,EAAOs0C,CAAQ,EAAIvwF,WAAS,EAAE,EAC/B,CAACs3D,EAAUC,CAAW,EAAIv3D,WAAS,EAAE,EACrC,CAACwwF,EAASC,CAAU,EAAIzwF,WAAS,EAAE,EACnC,CAACqhC,EAAOq2B,CAAQ,EAAI13D,WAAS,EAAE,EAC/B,CAAC0gC,EAASgwD,CAAU,EAAI1wF,WAAS,EAAE,EAEzC+a,YAAU,IAAM,CACd,GAAI,CAEF,MAAM5b,EADK,IAAI,gBAAgB,OAAO,SAAS,MAAM,EACxC,IAAI,OAAO,GAAK,GAC7BoxF,EAASpxF,CAAC,CACZ,MAAQ,CAAC,CACX,EAAG,EAAE,EAEL,eAAewxF,EAAS/xF,EAAQ,CAI9B,GAHAA,EAAE,iBACF84D,EAAS,EAAE,EACXg5B,EAAW,EAAE,EACT,CAACz0C,EAAO,CACVyb,EAAS,iCAAiC,EAC1C,MACF,CACA,GAAI,CAACJ,GAAYA,IAAak5B,EAAS,CACrC94B,EAAS,yBAAyB,EAClC,MACF,CACA,GAAI,CAAC24B,GAAiB/4B,CAAQ,EAAG,CAC/BI,EACE,uEAEF,MACF,CACA,GAAI,CAMF,MAAM5qD,EAAI,MALA,MAAM,MAAM,0BAA2B,CAC/C,OAAQ,OACR,QAAS,CAAE,eAAgB,oBAC3B,KAAM,KAAK,UAAU,CAAE,MAAAmvC,EAAO,YAAaqb,EAAU,EACtD,GACiB,OAClB,GAAI,CAACxqD,GAAG,GAAI,MAAM,IAAI,MAAMA,GAAG,OAAS,cAAc,EACtD4jF,EAAW,wCAAwC,CACrD,OAAS9xF,EAAQ,CACf84D,EAAS94D,GAAG,SAAW,cAAc,CACvC,CACF,CAEA,OACEuiB,OAAC,OAAI,UAAU,yEACb,UAAAC,MAAC,OAAI,UAAU,sBAAsB,EACrCA,MAAC,OAAI,UAAU,4CACb,gBAAC,QAAK,UAAU,wBAAwB,SAAAuvE,EACtC,UAAAvvE,MAAC,OAAI,UAAU,mEACb,SAAAA,MAAC,MAAG,UAAU,mBAAmB,+BAAmB,EACtD,EACC,CAAC66B,GACA76B,MAAC,OAAI,UAAU,eAAe,oFAG9B,EAEFA,MAAC,SACC,UAAU,eACV,KAAK,WACL,YAAY,eACZ,MAAOk2C,EACP,SAAW14D,GAAM24D,EAAY34D,EAAE,OAAO,KAAK,EAC3C,SAAQ,KAEVwiB,MAAC,SACC,UAAU,eACV,KAAK,WACL,YAAY,mBACZ,MAAOovE,EACP,SAAW5xF,GAAM6xF,EAAW7xF,EAAE,OAAO,KAAK,EAC1C,SAAQ,KAETyiC,GACCjgB,MAAC,OAAI,UAAU,qCAAsC,SAAAigB,EAAM,EAE5DX,GACCtf,MAAC,OAAI,UAAU,yCACZ,SAAAsf,EACH,EAEFtf,MAAC,UAAO,UAAU,aAAa,KAAK,SAAS,SAAU,CAAC66B,EAAO,2BAE/D,QACC,KAAE,UAAU,gCAAgC,KAAK,IAAI,2BAEtD,GACF,EACF,GACF,CAEJ,CCvGA,MAAqB20C,WAAsBC,WAKzC,CACA,YAAY5tF,EAAY,CACtB,MAAMA,CAAK,EACX,KAAK,MAAQ,CAAE,SAAU,GAC3B,CACA,OAAO,yBAAyBia,EAAU,CACxC,MAAO,CAAE,SAAU,GAAM,QAAS,OAAOA,GAAK,SAAWA,CAAG,EAC9D,CACA,kBAAkBmkB,EAAYiC,EAAW,CACvC,QAAQ,MAAM,kBAAmBjC,EAAOiC,CAAI,CAC9C,CACA,QAAS,CACP,OAAI,KAAK,MAAM,eAEV,OAAI,UAAU,oDACb,SAAAniB,OAAC,OAAI,UAAU,mCACb,UAAAC,MAAC,MAAG,UAAU,0BAA0B,gCAAoB,EAC5DA,MAAC,KAAE,UAAU,kBAAkB,mEAE/B,EACC,KAAK,MAAM,SACVA,MAAC,OAAI,UAAU,0DACZ,cAAK,MAAM,QACd,EAEFA,MAAC,UACC,UAAU,WACV,QAAS,IAAM,OAAO,SAAS,SAChC,mBAED,EACF,EACF,EAGG,KAAK,MAAM,QACpB,CACF,CCrCO,SAAS0vE,IAA0B,CACxC,GAAI,SAAO,OAAW,KACtB,GAAI,CACF,OAAO,sBAAwB,KAC/B,OAAO,iBAAiB,sBAAwBvqF,GAAU,EAErD,OAAe,8BACd,aAAa,QAAQ,0BAA0B,IAAM,OAGzDA,EAAM,iBACN,OAAO,sBAAwBA,EACjC,CAAC,EACD,OAAO,iBAAmB,SAAY,CACpC,GAAI,CACF,MAAMwqF,EAAc,OAAO,sBAC3B,GAAI,CAACA,EAAa,MAAO,GACzBA,EAAY,SACZ,MAAMzzB,EAAS,MAAMyzB,EAAY,WACjC,MAAO,CAAC,CAACzzB,GAAUA,EAAO,UAAY,UACxC,MAAQ,CACN,MAAO,EACT,CACF,CACF,MAAc,CAKd,CACF,aC5BO,SAAS0zB,IAAsB,CAKpC,GAAI,EADF,OAAQv2E,IAAyB,oBAAsB,EAAE,EAAE,SAAW,KAC1D,OAGd,MAAM9H,EAAI,OACV,GAAIA,EAAE,2BAA4B,OAClCA,EAAE,2BAA6B,GAE/B,MAAMs+E,EAAY,CAChB,MAAO,QAAQ,MAAM,KAAK,OAAO,EACjC,KAAM,QAAQ,KAAK,KAAK,OAAO,EAC/B,IAAK,QAAQ,IAAI,KAAK,OAAO,GAGzBC,EAAkB5uE,GAAgB,CACtC,MAAMshB,EAAMthB,EACT,IAAK9jB,GAAO,OAAOA,GAAM,SAAWA,EAAIA,GAAG,SAAW,EAAG,EACzD,KAAK,GAAG,EASX,MAHI,0DAAuD,KAAKolC,CAAG,GAE/D,qCAAqC,KAAKA,CAAG,GAC7C,gDAAgD,KAAKA,CAAG,EAI9D,EAGMutD,MAAoB,IACpBC,EAAU,IAEVC,EACH1kE,GACD,IAAIrK,IAAgB,CAClB,GAAI4uE,EAAe5uE,CAAI,EAAG,OAC1B,MAAMvB,EAAM,OAAOuB,EAAK,CAAC,GAAK,EAAE,EAC1BO,EAAM,KAAK,MACX5iB,EAAOkxF,EAAc,IAAIpwE,CAAG,GAAK,EACnC8B,EAAM5iB,EAAOmxF,IACjBD,EAAc,IAAIpwE,EAAK8B,CAAG,EAC1B8J,EAAG,GAAGrK,CAAI,EACZ,EAEF,QAAQ,MAAQ+uE,EAAKJ,EAAU,KAAK,EACpC,QAAQ,KAAOI,EAAKJ,EAAU,IAAI,EAKlC,OAAO,iBAAiB,qBAAuB7sD,GAAO,CACpD,MAAMR,EACHQ,EAAG,SAAWA,EAAG,OAAO,SAAW,OAAOA,EAAG,MAAM,IACpD,qBACIvhB,EAAM,KAAK,MACX5iB,EAAOkxF,EAAc,IAAIvtD,CAAG,GAAK,EACnC/gB,EAAM5iB,EAAOmxF,IACjBD,EAAc,IAAIvtD,EAAK/gB,CAAG,EAC1BouE,EAAU,KAAK,qCAAsC7sD,EAAG,MAAM,EAChE,CAAC,CACH,CC7DA,GAAI,CACD,OAAe,MAAS,OAAe,OAAS,EACnD,MAAY,CAAC,CAEbhnB,GAAA,EACA0zE,GAAA,EACAE,GAAA,EAMA,GAAI,CACF,IAAIM,EAAwB,KAE5B,MAAMC,EAA0BC,GAAiB,CAC/C,GAAI,CAMF,GALAF,EAAmBE,EAEnB,QAAQ,MAAM,uCAAwCA,CAAO,EAGzD,OAAO,UAAc,KAAe,UAAU,WAAW,UAC3D,GAAI,CACF,MAAM/uD,EACJ,OAAO+uD,GAAY,SACfA,EACA,KAAK,UAAUA,EAAS,KAAM,CAAC,EACrC,UAAU,UAAU,UAAU/uD,CAAI,EAAE,KAClC,IACE,QAAQ,KAAK,gDAAgD,EAC/D,IACE,QAAQ,KAAK,kDAAkD,EAErE,MAAQ,CAER,CAEJ,OAAS7jC,EAAG,CACV,GAAI,CACF,QAAQ,MAAM,sCAAuCA,CAAC,CACxD,MAAQ,CAAC,CACX,CACF,EAEA,OAAO,iBACL,QACCwlC,GAAY,CACX,GAAI,CACF,MAAMd,EAAO,CACX,QAASc,GAAI,SAAYA,GAAI,OAASA,EAAG,MAAM,SAAY,OAAOA,CAAE,EACpE,SAAUA,GAAI,UAAY,KAC1B,OAAQA,GAAI,QAAU,KACtB,MAAOA,GAAI,OAAS,KACpB,MAAOA,GAAI,OAAO,OAAUA,GAAI,OAAS,OAAOA,EAAG,KAAK,GAAM,KAC9D,KAAM,SAERmtD,EAAuBjuD,CAAI,CAC7B,OAAS1kC,EAAG,CACV,GAAI,CACF,QAAQ,MAAM,4CAA6CA,CAAC,CAC9D,MAAQ,CAAC,CACX,CACF,EACA,IAGF,OAAO,iBAAiB,qBAAuBwlC,GAAY,CACzD,GAAI,CACF,MAAM82B,EAAS92B,GAAI,OACbd,EAAO,CACX,QAAS43B,GAAQ,SAAW,OAAOA,CAAM,GAAK,qBAC9C,MAAOA,GAAQ,OAAS,KACxB,KAAM,sBAERq2B,EAAuBjuD,CAAI,CAC7B,OAAS1kC,EAAG,CACV,GAAI,CACF,QAAQ,MACN,yDACAA,CAAA,CAEJ,MAAQ,CAAC,CACX,CACF,CAAC,EAGA,OAAe,sBAAwB,CACtC,QAAS,SAAY,CACnB,GAAI,CACF,GAAI,CAAC0yF,EAAkB,OAAO,KAE9B,GACE,OAAO,UAAc,KACrB,UAAU,WAAW,UAErB,GAAI,CACF,MAAM,UAAU,UAAU,UACxB,KAAK,UAAUA,EAAkB,KAAM,CAAC,GAE1C,QAAQ,KAAK,qDAAqD,CACpE,MAAQ,CACN,QAAQ,KACN,8DAEJ,CAEF,OAAOA,CACT,OAAS1yF,EAAG,CACV,GAAI,CACF,QAAQ,MAAM,sCAAuCA,CAAC,CACxD,MAAQ,CAAC,CACT,OAAO,IACT,CACF,EACA,KAAM,IAAM0yF,CAAA,CAEhB,OAAS1yF,EAAG,CAEV,GAAI,CACF,QAAQ,KAAK,sCAAuCA,CAAC,CACvD,MAAQ,CAAC,CACX,CAEA6yF,GAAS,WAAW,SAAS,eAAe,MAAM,CAAE,EAAE,OACpDrwE,MAACswE,aAAA,CACC,SAAAtwE,MAACwvE,GAAA,CACC,SAAAxvE,MAACgnB,IACC,SAAAhnB,MAACuwE,GAAA,EAAK,EACR,EACF,EACF,CACF,EAEA,SAASA,IAAO,CAEd,OADa,OAAO,SAAS,WAChB,SAAiBvwE,MAACkvE,GAAA,EAAc,QACrChG,GAAA,EAAI,CACd,CAcA,MAAMsH,GACJ,IAAI,gBAAgB,OAAO,SAAS,MAAM,EAAE,IAAI,KAAK,IAAM,KAC1D,OAAO,aAAiB,KACvB,aAAa,QAAQ,gBAAgB,IAAM,IAE/C,GACEA,IACA,OAAO,UAAc,KACrB,kBAAmB,UAEnB,GAAI,CACF,UAAU,cACP,SAAS,QAAQ,EACjB,KAAMC,GAAQ,CACb,QAAQ,MAAM,6BAA8BA,CAAG,CACjD,CAAC,EACA,MAAO30E,GAAQ,CACd,QAAQ,KAAK,sCAAuCA,CAAG,CACzD,CAAC,CACL,MAAY,CAEZ,SACS,OAAO,UAAc,KAAe,kBAAmB,UAKhE,GAAI,CACF,UAAU,cAAc,mBAAmB,KAAM40E,GAAS,CACxD,GAAI,CAACA,GAAQA,EAAK,SAAW,EAAG,OAChC,GAAI,CACF,QAAQ,KACN,wBACAA,EAAK,OACL,sDAEJ,MAAQ,CAAC,CACT,IAAIC,EAAY,GAChBD,EAAK,QAAS5yF,GAAM,CAClB,GAAI,CACEA,EAAE,SAAQ6yF,EAAY,GAC5B,MAAQ,CAAC,CACT,GAAI,CACF7yF,EAAE,YACJ,OAASN,EAAG,CACV,GAAI,CACF,QAAQ,KAAK,qCAAsCA,CAAC,CACtD,MAAQ,CAAC,CACX,CACF,CAAC,EAID,GAAI,CACF,MAAMozF,EACJ,OAAO,aAAiB,KACxB,aAAa,QAAQ,qBAAqB,IAAM,IAClD,GAAID,GAAaC,EACf,GAAI,CACF,QAAQ,KACN,qFAGF,aAAa,WAAW,qBAAqB,EAE7C,OAAO,SAAS,QAClB,MAAY,CAEZ,CAEJ,MAAY,CAEZ,CACF,CAAC,CACH,MAAQ,CAER","names":["f","require$$0","k","l","m","n","p","q","c","a","g","b","d","e","h","reactJsxRuntime_production_min","jsxRuntimeModule","client","_objectWithoutPropertiesLoose","r","t","_extends","FOCUS_GROUP","FOCUS_DISABLED","FOCUS_ALLOW","FOCUS_AUTO","FOCUS_NO_AUTOFOCUS","assignRef","ref","value","useCallbackRef","initialValue","callback","useState","last","useIsomorphicLayoutEffect","React.useLayoutEffect","React.useEffect","currentValues","useMergeRefs","refs","defaultValue","callbackRef","newValue","oldValue","prevRefs_1","nextRefs_1","current_1","hiddenGuard","__assign","i","ItoI","innerCreateMedium","defaults","middleware","buffer","assigned","medium","data","item","x","cb","cbs","pendingQueue","executeQueue","cycle","filter","createMedium","createSidecarMedium","options","mediumFocus","_ref","target","currentTarget","mediumBlur","mediumEffect","mediumSidecar","focusScope","createContext","emptyArray","FocusLock","forwardRef","props","parentRef","_extends2","_useState","realObserved","setObserved","observed","useRef","isActive","originalFocusedElement","_useState2","update","children","_props$disabled","disabled","_props$noFocusGuards","noFocusGuards","_props$persistentFocu","persistentFocus","_props$crossFrame","crossFrame","_props$autoFocus","autoFocus","group","className","whiteList","hasPositiveIndices","_props$shards","shards","_props$as","Container","_props$lockProps","containerProps","SideCar","_props$returnFocus","shouldReturnFocus","focusOptions","onActivationCallback","onDeactivationCallback","_useState3","id","onActivation","useCallback","captureFocusRestore","_document","activeElement","onDeactivation","returnFocus","allowDefer","focusRestore","returnFocusTo","howToReturnFocus","returnFocusOptions","onFocus","event","onBlur","setObserveNode","newObserved","lockProps","hasLeadingGuards","hasTailingGuards","mergedRef","focusScopeValue","useMemo","React","Fragment","_setPrototypeOf","_inheritsLoose","o","setPrototypeOf","_typeof","toPrimitive","toPropertyKey","_defineProperty","withSideEffect","reducePropsToState","handleStateChangeOnClient","getDisplayName","WrappedComponent","mountedInstances","state","emitChange","instance","SideEffect","_PureComponent","_proto","index","PureComponent","toArray","ret","asArray","getFirst","isElementHidden","node","computedStyle","getParentNode","isTopNode","isInert","isVisibleUncached","checkParent","isVisibleCached","visibilityCache","cached","result","isAutoFocusAllowedUncached","isAutoFocusAllowed","isAutoFocusAllowedCached","cache","getDataset","isHTMLButtonElement","isHTMLInputElement","isRadioElement","notHiddenInput","attribute","isGuard","_a","isNotAGuard","isDefined","tabSort","aTab","bTab","tabDiff","indexDiff","getTabIndex","orderByTabIndex","nodes","filterNegative","keepGuards","tabIndex","tabbables","queryTabbables","queryGuardTabbables","getFocusablesWithShadowDom","parent","withGuards","acc","child","getFocusablesWithIFrame","getFocusables","parents","focusableWithShadowDom","focusableWithIframes","getParentAutofocusables","parentFocus","filterFocusable","filterAutoFocusable","getTabbableNodes","topNodes","getFocusableNodes","parentAutofocusables","topNode","contains","scope","element","iframeBody","filterNested","contained","j","position","_","getTopParent","getAllAffectedNodes","currentNode","safeProbe","getActiveElement","inDocument","focusInFrame","frame","focusInsideIframe","focusInside","focusIsHidden","findSelectedRadio","el","correctNode","correctNodes","resultSet","pickFirstFocus","pickFocusable","NEW_FOCUS","newFocus","innerNodes","innerTabbables","outerNodes","lastNode","cnt","firstFocus","lastFocus","isOnGuard","activeIndex","lastIndex","lastNodeInside","firstNodeIndex","lastNodeIndex","correctedNodes","currentFocusableIndex","previousFocusableIndex","tabbableNodes","currentTabbableIndex","previousTabbableIndex","focusIndexDiff","returnFirstNode","returnLastNode","findAutoFocused","autoFocusables","autofocus","pickAutofocus","nodesIndexes","orderedNodes","groups","autoFocusable","getParents","getCommonParent","nodeA","nodeB","parentsA","parentsB","currentParent","getTopCommonParent","baseActiveElement","leftEntry","rightEntries","activeElements","leftEntries","topCommon","entry","subEntry","common","allParentAutofocusables","entries","reorderNodes","srcNodes","dstNodes","remap","entity","focusSolver","commonParent","anyFocusable","innerElements","orderedInnerElements","innerFocusables","innerTabbable","newId","focusNode","expandFocusableNodes","focusOn","guardCount","lockDisabled","moveFocusInside","focusable","weakRef","w","recordElementLocation","stack","currentElement","restoreFocusTo","location","_b","_c","_d","_e","ownerDocument","_i","stack_1","line","parent_1","left","savedCurrent","current","right","focusables","aim","_f","focusables_1","targetElement","getRelativeFocusable","useTabbables","shard","getBoundary","set","defaultOptions","moveFocus","fromElement","newOptions","solution","focusNextElement","next","first","focusPrevElement","prev","pickBoundary","what","boundary","focusFirstElement","focusLastElement","deferAction","action","extractRef","focusOnBody","isFreeFocus","lastActiveTrap","lastActiveFocus","tryRestoreFocus","lastPortaledElement","focusWasOutsideWindow","windowFocused","defaultWhitelist","focusWhitelisted","recordPortal","observerNode","portaledElement","focusIsPortaledPair","autoGuard","startIndex","end","step","allNodes","lastGuard","focusWasOutside","crossFrameOption","checkInHost","check","withinHost","workingArea","area","getNodeFocusables","isNotFocusable","activateTrap","_lastActiveTrap","workingNode","newTarget","shouldForceRestoreFocus","newActiveElement","focusedIndex","_ref2","_ref3","guard","_ref4","onTrap","source","FocusWatcher","onWindowFocus","onWindowBlur","attachHandler","detachHandler","propsList","_ref6","focusLockAPI","traps","trap","lastTrap","sameTrap","_ref7","FocusTrap","FocusLockCombination","FocusLockUI","KEY","user","getWeekId","date","dayNum","yearStart","weekNo","week","getOnlineUsage","raw","u","currentWeek","getFreeRemaining","cap","LS_KEY","getCache","setCache","email","v","fetchIsAdmin","owner","__vite_import_meta_env__","force","hit","useIsAdmin","isAdmin","setIsAdmin","useEffect","on","BASE_PRICE_GBP","FX","formatPriceInCurrency","currency","gbpAmount","cur","rate","val","getUserCurrency","parts","DISCORD_INVITE_URL","cachedBaseUrl","fallbackRemoteEnv","REMOTE_API_FALLBACK","LOCAL_HOSTS","computeApiBase","envUrl","normalized","protocol","host","hostname","sameOrigin","normalizePath","path","base","cleanPath","resolveApiUrl","getApiBaseUrl","apiFetch","init","url","anyWin","disabledAt","err","res","installApiInterceptor","anyWindow","originalFetch","input","reqUrl","cloned","href","getTabs","baseTabs","LayoutDashboard","Users","Trophy","Camera","Settings","isSubscriptionActive","sub","exp","PoundSterling","resolveUserForTabs","userForTabs","rawGet","subs","buildTabList","tabs","adminTab","insertIdx","Sidebar","active","onChange","sidebarRef","isDown","startY","scrollTop","onMouseDown","onMouseLeave","onMouseUp","onMouseMove","walk","showDiscord","setShowDiscord","showNDNDiscord","setShowNDNDiscord","freeLeft","notifications","setNotifications","mounted","failures","disabledUntil","fetchNotifications","requestsRes","messagesRes","requests","unreadMessages","interval","onKey","playTabs","socialTabs","systemTabs","renderTab","key","label","Icon","badgeCount","jsxs","jsx","Lock","rendered","MessageCircle","createPortal","ScrollFade","style","maskHeight","setMaskHeight","raf","lastMaskHeight","updateMask","header","scroller","headerH","newMaskHeight","onScrollOrResize","dlog","args","dinfo","DartDetector","cfg","overrides","durationMs","ms","now","cx","cy","radius","width","height","alpha","bg","gray","y","dx","dy","recent","tuning","mask","diff","sum","sum2","isHighlight","maxc","minc","satApprox","isHi","mu","var_","sigma","dynamicThresh","visited","bestArea","bestIdxs","idxs","qh","nbs","nb","minX","minY","maxX","maxY","meanX","meanY","idx","cxx","cyy","cxy","trace","det","tmp","l1","vx","vy","vlen","dxc","dyc","rlen","minRForAngle","rx","ry","cosAng","angDeg","maxT","minT","maxPtX","maxPtY","minPtX","minPtY","distSq","distMax","distMin","tipX","tipY","dxr","dyr","minR2","bboxW","bboxH","bboxArea","fill","radial","confidence","l2","bw","bh","yy","xx","tip","requireN","close","out","createStoreImpl","createState","listeners","setState","partial","replace","nextState","previousState","listener","getState","api","initialState","createStore","is","objectIs","useLayoutEffect","useDebugValue","useSyncExternalStore$2","subscribe","getSnapshot","inst","forceUpdate","checkIfSnapshotChanged","latestGetSnapshot","nextValue","useSyncExternalStore$1","shim","useSyncExternalStoreShim_production","shimModule","require$$1","useSyncExternalStore","withSelector_production","getServerSnapshot","selector","isEqual","instRef","memoizedSelector","nextSnapshot","hasMemo","memoizedSnapshot","currentSelection","memoizedSelection","nextSelection","maybeGetServerSnapshot","withSelectorModule","ReactExports","useSyncExternalStoreWithSelector","useSyncExternalStoreExports","didWarnAboutEqualityFn","identity","arg","useStore","equalityFn","slice","createImpl","useBoundStore","create","useCalibration","scale","aspect","fitMode","cameraId","createJSONStorage","getStorage","storage","name","parse","str2","str","toThenable","fn","onFulfilled","_onRejected","_onFulfilled","onRejected","oldImpl","config","baseOptions","get","persistedState","currentState","hasHydrated","hydrationListeners","finishHydrationListeners","thenableSerialize","setItem","errorInSync","thenable","serializedValue","savedSetState","configResult","stateFromStorage","hydrate","postRehydrationCallback","storageValue","deserializedStorageValue","migratedState","_a2","newImpl","migrationResult","migrated","persistImpl","persist","videoElementRefHolder","mediaStreamRefHolder","pcRefHolder","wsRefHolder","keepAliveCount","pendingVideoRef","pendingVideoRefTimer","VIDEO_REF_DEBOUNCE_MS","useCameraSession","streaming","starting","mode","code","time","paired","stream","pc","ws","_reason","BoardRadii","CalibrationGuideRadii","SectorOrder","matMul3","applyHomography","H","nx","ny","scaleHomography","sx","sy","rotateHomography","angleRadians","cos","sin","R","translateHomography","tx","ty","invertHomography","A","B","C","D","E","F","G","Hh","I","computeHomographyDLT","src","dst","X","Y","solveLeastSquares","AtA","Atb","gaussianSolve","M","row","maxRow","s","canonicalRimTargets","rimPoints","sector","angle","sampleRing","steps","pts","theta","estimateSectorOffsetFromHomography","centerImg","d20Board","d20Img","degImg","delta","rmsError","e2","ransacHomography","opts","threshold","maxIter","minInliers","rng","bestH","bestInliers","bestCount","bestError","iter","chosen","ssub","dsub","Htry","inliers","count","sIn","dIn","Hrefined","sFin","dFin","finalError","imageToBoard","H_boardToImage","pImg","inv","scoreAtBoardPoint","deg","bullInner","bullOuter","trebleInner","trebleOuter","doubleInner","doubleOuter","tol","scoreAtBoardPointTheta","sectorOffset","rotationOffsetRad","correctedIndex","drawPolyline","ctx","color","drawCross","clamp","lo","hi","sobelAtGray","img","gx","gy","xi","refinePointSobel","canvas","best","mag","markerIdToMatrix","grid","bits","rowIdx","bitA","bitB","getGlobalCalibrationConfidence","errorPx","percentage","clamped","GAME_CALIBRATION_REQUIREMENTS","getCalibrationConfidenceForGame","gameMode","tolerance","range","maxError","getCalibrationQualityText","load","save","useUserSettings","vol","size","isFinitePoint","isFiniteHomography","findDartboardRings","centerHint","mapW","mapH","workCtx","accumulator","magThreshold","iL","iR","iU","iD","lumL","lumR","lumU","lumD","ux","uy","minR","maxR","v1x","v1y","v2x","v2y","smoothedAcc","blurR","maxVotes","peakX","peakY","border","votes","roughCx","roughCy","scanW","scanScale","scanH","scanCtx","scanData","scanDx","scanDy","fullData","lum","ix","angleCount","radiiByRing","gradients","xInner","yInner","xOuter","yOuter","lumInner","lumOuter","grad","peaks","curr","ringKey","tierIndex","ringRadii","radii","median","filteredRings","secondLast","ratio","doubleOuterRadius","detectionConfidence","computeBoardOrientation","sampleCount","sampleRadius","gradSamples","rInner","rOuter","imageData","iy","maxGrad","smoothed","peakAngles","sectorCenters","a1","sectorCount","canonicalAngles","bestRot","bestErr","shift","detectedAngle","canonicalAngle","refineHomographyByRings","cImg","ringScore","Htest","rings","score","nlen","bestScore","toRad","rotSteps","txSteps","scaleSteps","rot","Hr","Ht","Hs","sc","detectBoard","centerX","centerY","srcCanvas","oc","octx","rgb2hsv","rn","gn","bn","max","min","hh","isRed","isGreen","detection","detected","canonicalSrc","calibrationPoints","px","py","homography","inlierRatio","useRansac","ransac","global","pointsValid","homographyValid","success","detRingCount","discoverNetworkDevices","devices","localIPs","getLocalIPs","localIP","scanResults","scanNetwork","device","probeDevice","error","ips","offer","resolve","timeout","ipMatch","ip","isPrivateIP","ports","results","baseIP","promises","port","checkPort","portIndex","ipIndex","endpoints","endpoint","response","contentType","text","connectToNetworkDevice","streamUrl","video","reject","drawFrame","useAudit","darts","visitTotal","meta","totals","bm","tag","info","updated","arr","STORAGE_KEY","CHANNEL","broadcastMessage","msg","winBC","canUseBC","ctor","bc","se","subscribeMatchSync","onMessage","ev","onStorage","parsed","onCustom","calcThreeDartAvg","leg","totalPreOpen","dartsForAvg","finishedLegStats","avg","isCompleted","updatePlayerEndOfGameStats","player","avgs","bestNine","bestCheckout","st","useMatch","playerNames","startingScore","roomId","players","playerIdx","oldPlayer","oldLeg","legsArr","preRem","postRem","bust","finish","avgPayload","newPlayers","pl","newVisits","lastVisitTotal","newLeg","newLegs","newPlayer","checkoutScore","endTime","newLegsWon","newBestLeg","profileStats","newState","playerIndex","DEFAULT_REMOTE_WS","REMOTE_WS_FALLBACK","normalizeWsUrl","DEV_SERVICE_PORT","ALT_DEV_PORT","trimmed","extractHost","isLocalHost","cachedWsUrl","computePreferredWsUrl","envHost","pageHost","proto","getPreferredWsUrl","getWsCandidates","withPort","preferred","candidates","WSContext","WSProvider","connected","setConnected","status","setStatus","wsRef","listenersRef","shouldReconnectRef","attemptsRef","timerRef","heartbeatRef","endpointsRef","endpointIdxRef","ensureEndpoints","rotateEndpoint","eps","currentEndpoint","connect","attempt","jitter","delay","reconnect","beforeUnload","onVis","send","addListener","useWS","useContext","DevicePicker","videoDevices","refreshVideoDevices","testCamera","onSelectPhoneCamera","lastDetectedLabel","autoCommitTestMode","doCommit","lastDetectedValue","cameraConnected","preferredCameraId","preferredCameraLabel","setPreferredCamera","cameraEnabled","setCameraEnabled","preferredCameraLocked","setPreferredCameraLocked","setErr","dropdownOpen","setDropdownOpen","dropdownRef","handleRefreshDevices","handleClickOutside","selectedDevice","selectedLabel","preferredCameraUnavailable","handleSelectCamera","deviceId","handlePhoneCamera","handleLockToggle","CALIBRATION_POINT_LABELS","REQUIRED_POINT_COUNT","VERIFICATION_ANCHORS","Calibrator","videoRef","canvasRef","overlayRef","cameraPerm","setCameraPerm","setVideoDevices","selectedDeviceId","setSelectedDeviceId","setStreaming","videoPlayBlocked","setVideoPlayBlocked","setMode","dstPoints","setDstPoints","hasSnapshot","setHasSnapshot","phase","setPhase","handleSelectPhoneCamera","frameSize","setFrameSize","zoom","setZoom","mobileLandingOverride","setMobileLandingOverride","isMobileDevice","setIsMobileDevice","setCalibration","reset","locked","overlaySize","imageSize","anchors","ERROR_PX_MAX","cameraSession","calibrationGuide","setCalibrationGuide","preserveCalibrationOverlay","allowAutocommitInOnline","setAllowAutocommitInOnline","manualOnly","setDetected","liveDetect","setLiveDetect","setConfidence","autoCalibrating","setAutoCalibrating","detectionMessage","setDetectionMessage","forceConfidence","setForceConfidence","markerResult","setMarkerResult","showDartPreview","setShowDartPreview","setAutoCommitTestMode","autoCommitImmediate","setAutoCommitImmediate","setLastDetectedValue","setLastDetectedLabel","bullHint","setBullHint","toolsPopoverOpen","setToolsPopoverOpen","dartDetectorRef","inFlightAutoCommitRef","lastAutoSigRef","lastAutoSigAtRef","AUTO_COMMIT_COOLDOWN_MS","verificationResults","setVerificationResults","flashStatus","setFlashStatus","correctionSx","setCorrectionSx","correctionTx","setCorrectionTx","correctionTy","setCorrectionTy","showDetectedOverlay","setShowDetectedOverlay","forceDetectedOnly","setForceDetectedOnly","doubleOuterAdjust","setDoubleOuterAdjust","trebleOuterAdjust","setTrebleOuterAdjust","aligningRing","setAligningRing","resetVisualAdjustments","matrix","rows","cols","cellW","cellH","pairCode","setPairCode","pairCodeRef","setWs","pcRef","pendingIceCandidatesRef","expiresAt","setExpiresAt","setNow","setPaired","updatePairCode","lanHost","setLanHost","httpsInfo","setHttpsInfo","showTips","setShowTips","wifiDevices","setWifiDevices","discoveringWifi","setDiscoveringWifi","copyFeedback","setCopyFeedback","copyTimeoutRef","mobileUrl","useHttps","mobileLandingLink","coarseQuery","detect","uaMobile","coarse","narrow","vids","constraints","ttl","copyValue","type","textarea","handleReconnectRequest","stopCamera","startPhonePairing","ensureWS","normalizedEnv","socket","lockSelectionForPairing","codeForSession","imgSize","payload","peer","inbound","pending","candidate","Hpayload","startWifiConnection","connectToWifiDevice","startCamera","playErr","autoRevert","regenerateCode","captureFrame","autoDetectRings","drawOverlay","currentPoints","HH","onOverlayClick","Huse","CORRECTION_SX","CORRECTION_TX","CORRECTION_TY","Hcorrected","adjustedCenterX","adjustedCenterY","WIDEN_FACTOR","detectedRingMap","perRingAdjust","drawDetectedRings","drawn","bullFill","trebleFill","doubleFill","drawBand","fillStyle","strokeStyle","inner","outer","outerAdj","innerAdj","OUTLINE_STEPS","outlines","oline","poly","rAdj","evt","rect","clickedRadius","currentRadius","newAdjust","Hdraw","ctx2","labels","rLabel","thetaVal","ang","lx","ly","tw","errPx","hasVerification","allPass","passByError","pass","fail","drawnCount","drawRingBand","Hmat","detectedInner","detectedOuter","trebleInnerToUse","trebleOuterToUse","doubleInnerToUse","doubleOuterToUse","detectedRadius","rCenter","isPass","pad","drawCircle","radScale","sampleAndDraw","rMm","targetPoints","ax","ay","applyTestAutoDetectResult","Hcal","calState","curCalValid","sig","testAutoDetectResult","refined","actualImageSize","autoOffset","verifyCalibration","stableCount","hintScaledA","bd","isSimilarDetection","connectionPoints","anchor","imgPoint","boardPoint","detectedScore","deltaMm","deltaPx","match","expectedRadius","actualRadius","dr","workerRef","tick","bodyStr","token","linkForMobile","nextId","useToastStore","message","useToast","Toaster","toasts","remove","BarChart","barWidth","gap","showValues","totalWidth","TabPills","keyFor","keySeriesFor","keyDailyFor","keyMetaFor","syncTimers","syncInFlight","getAuthToken","getStatsMeta","setStatsMeta","buildStatsPayload","getAllTime","getStatSeries","getDailySnapshot","getGameModeStats","pushStatsToServer","scheduleStatsSync","existing","syncStatsFromServer","MAX_RETRIES","remote","local","localMeta","setAllTime","setSeries","setDailySnapshot","setGameModeStats","clearAllStats","getAllTimeAvg","scored","getAllTimeFirstNineAvg","fnDarts","fnScored","getAllTimeBestWorst","best3","worst3","getAllTimeBestLeg","bestLegDarts","getAllTimeBestCheckout","getAllTime180s","num180s","keyGameModes","allModeKeys","obj","stats","stored","bumpGameMode","won","getSeries","pruneOld","maxAgeMs","addSample","when","list","getRollingAvg","windowMs","getRollingFirstNineAvg","snap","getDailyAdjustedAvg","DAY","ra","getMonthlyAvg3","windowed","matchOnly","use","getMonthlyFirstNineAvg","addMatchToAllTime","recordSeries","canonicalUser","matchStart","matchEnd","matchBest3","matchWorst3","matchBestLegDarts","matchBestCheckout","matchWorstLegDarts","matchBestFNAvg","matchWorstFNAvg","match180s","legFnDarts","legFnScored","sumFirstNine","legDarts","legScored","legAvg","legFNAvg","co","legStart","legEnd","prior","series","start","remain","take","freeGames","premiumGames","allGames","gameConfig","getStartOptionsForGame","getModeOptionsForGame","getModeValueOptionsForGame","labelForMode","opt","UI_SYMBOL","sym","CameraStatusBadge","camera","sessionStream","videoEl","hasActiveStream","statusLabel","onClick","HELP_TOPICS","analyzeUserQuestion","question","lowerQ","topic","keyword","getEstimatedWaitTime","hour","HelpdeskChat","request","onClose","messages","setMessages","setInput","typingUsers","setTypingUsers","adminConnected","setAdminConnected","waitTime","setWaitTime","msgsRef","typingTimeoutRef","timersRef","un","who","sendMsg","userMessage","msgObj","aiResponse","aiMsg","requestAdminConnection","needsHelp","confirmMsg","waitMsg","sendTyping","copy","Zap","User","actionMsg","Send","OWNER_EMAIL","AdminDashboard","admins","setAdmins","setEmail","announcement","setAnnouncement","loading","setLoading","tournaments","setTournaments","userSearch","setUserSearch","userResults","setUserResults","createForm","setCreateForm","emailCopy","setEmailCopy","preview","setPreview","activeTab","setActiveTab","isOwner","winners","reports","helpRequests","setHelpRequests","helpTyping","setHelpTyping","selectedRequest","setSelectedRequest","setLogs","systemHealth","setSystemHealth","clusteringEnabled","setClusteringEnabled","clusterCapacity","setClusterCapacity","setShowCreate","broadcastTournaments","headers","toast","gmVersion","setGmVersion","gmStats","cal","calibQuality","items","game","qualityInfo","gmBars","bars","gameKey","refresh","hrRes","adminsRes","tRes","revoke","grantPremium","days","revokePremium","sendAnnouncement","toggleMaintenance","unsub","rid","req","filtered","iv","changed","claimHelp","resolveHelp","grant","searchUsers","authHeader","banUser","unbanUser","createOfficialTournament","setWinner","tid","winnerEmail","deleteTournament","reseedWeekly","deleteMatch","fetchLogs","fetchSystemHealth","toggleClustering","enable","updateClusterCapacity","newCapacity","loadEmailCopy","saveEmailCopy","kind","openInlinePreview","openInNewTab","html","EmailEditor","title","setTitle","intro","setIntro","btn","setBtn","hr","colorClass","admin","notes","vals","winner","hasAccess","ThemeContext","COLOR_MODE_KEY","detectSeasonalTheme","ThemeProvider","auto","setAuto","theme","setThemeState","colorMode","setColorModeState","applyAttr","mq","sync","applied","setTheme","setColorMode","useTheme","ALL_THEMES","THEME_META","ThemeToggle","selected","SettingsPanel","favoriteDouble","callerEnabled","callerVoice","callerVolume","speakCheckoutOnly","avgMode","autoStartOffline","rememberLastOffline","reducedMotion","compactHeader","allowSpectate","cameraScale","cameraAspect","cameraFitMode","autoscoreProvider","autoscoreWsUrl","autoCommitMode","confirmUncertainDarts","autoScoreConfidenceThreshold","autoscoreDetectorMinArea","autoscoreDetectorThresh","autoscoreDetectorRequireStableN","harshLightingMode","enhanceBigTrebles","cameraRecordDarts","cameraShowLabels","_calibrationGuide","_preferredCameraId","_preferredCameraLabel","offlineLayout","_textSize","_boxSize","setFavoriteDouble","setCallerEnabled","setCallerVoice","setCallerVolume","setSpeakCheckoutOnly","setAvgMode","setAutoStartOffline","setRememberLastOffline","setReducedMotion","setCompactHeader","setAllowSpectate","setCameraScale","setCameraAspect","setCameraFitMode","setAutoscoreProvider","setAutoscoreWsUrl","setAutoCommitMode","setConfirmUncertainDarts","setAutoScoreConfidenceThreshold","setAutoscoreDetectorMinArea","setAutoscoreDetectorThresh","setAutoscoreDetectorRequireStableN","setHarshLightingMode","setEnhanceBigTrebles","setCameraRecordDarts","setCameraShowLabels","cameraLowLatency","setCameraLowLatency","cameraProcessingFps","setCameraProcessingFps","_setCalibrationGuide","setPreserveCalibrationOverlay","preserveCalibrationOnCameraChange","setPreserveCalibrationOnCameraChange","_setPreferredCamera","setOfflineLayout","_setTextSize","_setBoxSize","dartTimerEnabled","dartTimerSeconds","setDartTimerEnabled","setDartTimerSeconds","x01DoubleIn","setX01DoubleIn","achievements","setAchievements","uname","onOpenProfile","setExpandedPill","isEditing","setIsEditing","favPlayer","setFavPlayer","favTeam","setFavTeam","favDarts","setFavDarts","bio","setBio","profilePhoto","setProfilePhoto","allowAnalytics","setAllowAnalytics","subscription","setSubscription","helpMessages","setHelpMessages","helpInput","setHelpInput","saveBio","faq","navigateToTab","tabKey","getResponseWithLinks","faqMatch","handleHelpSend","newUsername","setNewUsername","changingUsername","_setChangingUsername","usernameError","setUsernameError","availableVoices","setAvailableVoices","loadVoices","voices","_showHighlights","setShowHighlights","expandedPill","PillButton","pill","ChevronDown","Shield","Eye","file","reader","blob","Volume2","Save","Edit3","Gamepad2","HelpCircle","link","Auth","onAuth","username","setUsername","password","setPassword","reminder","setReminder","setError","showPassword","setShowPassword","API_URL","fetchWithTimeout","timeoutMs","controller","timer","handleSignIn","__vitePreload","handleSignUp","handleReset","handleSendUsername","option","EyeOff","BarChart3","ShieldCheck","SeasonalProvider","HelpAssistant","isOpen","setIsOpen","awaitingAdminConfirm","setAwaitingAdminConfirm","lastUserQuestion","setLastUserQuestion","myRequest","setMyRequest","handleSend","userMessageRaw","linkIndex","GlobalCameraLogger","lastStateRef","dumpState","prefix","media","snapshot","attachVideoListeners","loadedmetadata","playing","pause","ended","attachPc","connChange","attachInterval","GlobalPhoneVideoSink","vref","lastStreamRef","lastTimeRef","stallSecondsRef","lastReconnectAtRef","attemptRef","apply","vid","minBackoff","ct","dispatchCameraRecovery","reason","session","settings","NDN_CAMERA_RECOVERY_EVENT","dispatchCameraRecoveryUi","detail","GlobalCameraWatchdog","shouldWatch","lastVideoTimeRef","stallTicksRef","lastRecoveryAtRef","backoffStepRef","recoveringRef","lastReasonRef","maybeRecover","backoffMs","tracks","prettyReason","GlobalCameraRecoveryToasts","lastShownAtRef","onRecover","InstallPicker","open","setOpen","playStore","appStore","containerRef","handler","handlePointer","installPwa","AddToHomeButton","available","setAvailable","showInstructions","setShowInstructions","handleClick","choice","handleKey","isIos","ResizableModal","storageKey","frameClassName","frameFullScreenClassName","defaultWidth","defaultHeight","minWidth","minHeight","maxWidth","maxHeight","fullScreen","initialFitHeight","setSize","startRef","onReset","cs","padTop","padBottom","saved","beginResize","dir","onMove","endResize","handleKeyResize","curW","curH","parentInner","effMaxH","baseClass","InstallAppButton","deferredPrompt","setDeferredPrompt","handleInstall","Footer","show","setShow","year","useMatchControl","endsAt","AutoPauseManager","paused","pauseEndsAt","setPaused","sleep","waitForMetadata","done","cleanup","onLoaded","onCanPlay","ensureVideoPlays","attach","muted","playsInline","maxAttempts","metadataTimeoutMs","onPlayError","liveVideoTracks","attached","playAttemptMap","attemptPromise","scoreFromImagePoint","pBoard","parseExternalDart","rawConf","conf","ring","normalizeRing","finalizeFromValue","mult","sec","mul","subscribeExternalWS","onDart","alive","lastSig","lastSigAt","DEDUP_WINDOW_MS","seenIds","seenSet","considerForward","pid","old","ResizablePanel","autoFill","usePendingVisit","total","PauseQuitModal","onQuit","onPause","fmt","mm","ss","PauseTimerBadge","compact","pauseStartedAt","remaining","pct","getSnapshotState","ui","sel","control","writeMatchSnapshot","readMatchSnapshot","doubles","dVal","prefsDoubleScore","fav","suggestCheckouts","hardcoded","routes","sayScore","voiceName","synth","spokenName","isCheckout","isOneEighty","phrases","winPhrases","noScorePhrases","bigPhrases","setVoiceAndSpeak","englishVoice","DARTBOARD_MM","mmPerBoardUnitFromBullOuter","params","distanceFromBullMm","bullCenter","mmPerBoardUnit","bullInnerRadiusBoardUnits","bullOuterRadiusBoardUnits","dBoard","inInnerBull","inOuterBull","AUTO_COMMIT_MIN_FRAMES","AUTO_COMMIT_HOLD_MS","AUTO_STREAM_IGNORE_MS","DETECTION_ARM_DELAY_MS","OFFLINE_THROW_WINDOW_MS","DETECTION_MIN_FRAMES","POST_CALIBRATION_GRACE_MS","AUTO_COMMIT_CONFIDENCE","TIP_STABLE_MIN_FRAMES","TIP_STABLE_MAX_JITTER_PX","DETECTION_SETTLE_MS","MAX_DETECTION_STILL_MS","TIP_MOTION_RESET_PX","BOARD_CLEAR_GRACE_MS","DISABLE_CAMERA_OVERLAY","TEST_MODE","CAMERA_VERBOSE_LOGS","cameraVerboseLog","glareClampFrameInPlace","knee","strength","over","y2","makeFitTransform","videoW","videoH","calibW","calibH","vr","cr","cropXCal","cropYCal","targetWCal","targetHCal","pVideoPx","CameraView$1","onVisitCommitted","showToolbar","onAutoDart","immediateAutoCommit","hideInlinePanels","scoringMode","onGenericDart","onGenericReplace","x01DoubleInOverride","onAddVisit","onEndLeg","_cameraAutoCommit","forceAutoStart","disableDetection","minimalControls","hideCameraOverlay","setHideCameraOverlay","autoscoreEnabled","availableCameras","setAvailableCameras","previewCanvasRef","videoReady","setVideoReady","showVideoDiagnostics","setShowVideoDiagnostics","videoDiagnostics","setVideoDiagnostics","cameraAccessError","setCameraAccessError","handleVideoRef","isPhoneCamera","sessionStreaming","phoneFeedActive","effectiveStreaming","cameraStarting","setCameraStarting","retryCountRef","isMountedRef","isDocumentVisible","setIsDocumentVisible","hasAnyStream","onPlaying","onResize","collectVideoDiagnostics","videoTracks","audioTracks","_hydrated","lastCalibrationSigRef","matchState","isOnlineMatch","CALIBRATION_MIN_CONFIDENCE","errorPxVal","calibrationConfidence","calibrationValid","calibrationValidEffective","lastAutoScore","setLastAutoScore","manualScore","setManualScore","lastAutoValue","setLastAutoValue","lastAutoRing","setLastAutoRing","bigTrebleFlashRef","bounceoutRef","offlineFallbackRef","pendingDarts","setPendingDarts","pendingDartsRef","pendingScore","setPendingScore","pendingEntries","setPendingEntries","showQuitPause","setShowQuitPause","forwarding","setForwarding","commitBlocked","pendingPreOpenDarts","setPendingPreOpenDarts","pendingDartsAtDouble","setPendingDartsAtDouble","awaitingClear","setAwaitingClear","pendingCommitRef","pendingCommitTimerRef","shouldDeferCommit","indicatorVersion","setIndicatorVersion","indicatorEntryVersions","setIndicatorEntryVersions","autoCandidateRef","detectionLogRef","lastAutoCommitRef","lastCommittedTipRef","committedTipsRef","boardLockedRef","boardClearStartRef","streamingStartMsRef","detectionArmedRef","detectionArmTimerRef","lastMotionLikeEventAtRef","lastOfflineThrowAtRef","tipStabilityRef","detectionStartRef","detectionDurationFramesRef","frameCountRef","tickRef","detectionLog","setDetectionLog","lastDetection","setLastDetection","lastCommit","setLastCommit","_selfTestStatus","setSelfTestStatus","_selfTestMessage","setSelfTestMessage","showDiagnosticsOverlay","setShowDiagnosticsOverlay","diagnosticsRef","setDiagnosticsTick","updateDiagnostics","patch","hasHomographyNow","hasImageSizeNow","imageSizeStrNow","pendingConfirm","setPendingConfirm","registeredTip","setRegisteredTip","visitMarkers","setVisitMarkers","commitFlash","setCommitFlash","maybeHoldForConfirmation","effectiveThreshold","bullUpFirstDartTakenRef","clearPendingCommitTimer","clampCameraScale","adjustCameraScale","setFullPreview","setWidePreview","useImperativeHandle","runSelfTest","captureDetectionLog","playBell","Ctx","tries","logs","finalizePendingCommit","_trigger","maybeEntries","lastBull","sayBullDistanceMm","enqueueVisitCommit","sayVisitTotal","clearPendingManual","setHadRecentAuto","handleIndicatorReset","handleToolbarClear","requestDeviceManager","x01DoubleInSetting","openedById","setOpenedById","currentPlayerId","isOpened","setOpened","inProgress","setVisit","resetPendingVisit","addVisit","endLeg","snapshotPendingDartEntries","callAddVisit","callEndLeg","quickSelManual","setQuickSelManual","nonRegCount","setNonRegCount","setShowRecalModal","hadRecentAuto","_pulseManualPill","setPulseManualPill","showManualModal","setShowManualModal","setShowAutoModal","showScoringModal","setShowScoringModal","manualPreviewRef","dartTimeLeft","setDartTimeLeft","detectorRef","rafRef","lastProcessedRef","lastParentSigRef","lastParentSigAtRef","pulseTimeoutRef","detectorSeedVersion","handlePhoneReconnect","onOpen","onDartsCleared","shouldRun","already","addDart","vw","vh","cw","ch","dpr","dw","dh","canFallbackToLocal","existingStream","hasActiveTracks","anyStream","applyAntiGlare","track","caps","supports","desired","qualityHints4k","qualityHints1440p","qualityHints1080p","qualityHints720p","baseVideo","tryGetStream","hints","dynamicHints","errDynamic","playResult","ok","currentRetry","backoff","enumErr","fallbackStream","activeStream","rafId","activated","sampleBlankCount","sampleHandle","lastDraw","TARGET_FPS","stopLoop","drawLoop","minDt","vv","cc","startIfNeeded","hasDims","notPainting","sampler","SW","SH","sctx","poll","refreshCameraDeviceList","CameraSelector","manualDeviceId","setManualDeviceId","selectDeviceId","retryErr","preferredLabel","isPhone","sessionVideo","sessionIsStreaming","localVideo","sourceVideo","canceledLocal","retry","canceled","initVw","initVh","proc","detectorSizeRef","minArea","thresh","requireStableN","angMaxDeg","didApplyHitThisTick","rImg","fit","roiR","detector","visitHasRoom","condPaused","condPending","condArmed","condFrame","nowPerf","vanished","elapsed","distMm","tipPx","hadStable","hadSustained","tipRefined","pCal","calibrationGood","warmupActive","_skipLocalCommit","shouldAccept","rejectReason","dist","settled","tipStable","detectionAgeMs","motionAgeMs","inOfflineThrowWindow","detectionFresh","strictScoring","TIP_MARGIN_PX","PCAL_MARGIN_PX","tipInVideo","pCalInImage","validSector","_onBoard","boardOk","sectorOk","warmupBlock","effectiveWarmupActive","isGhost","_skipLocalCommit2","bullDistance","pSig","pNow","flash","applyAutoHit","boardClearReady","allowCommitCandidate","allowFallbackCommits","TIP_TRACK_PX","distTip","samePhysical","preferRing","preferValue","holdMs","ready","cooled","tipStableFrames","minCommitArea","commitStabilityOk","commitAreaOk","handleUseLocalCamera","fallback","compactCameraView","videoClass","videoScale","glareDimmingEnabled","videoStyle","hasTracks","showPhoneReconnect","capture","captureCanvas","timestamp","obs","parseManual","bull","outerBull","num","multVal","getCurrentRemaining","bullDistanceMm","rounded","entryMeta","newDarts","nextEntries","en","previousScore","previousDarts","previousEntries","willCount","appliedValue","newScore","after","isFinish","bustEntries","preOpenTotal","postAfter","postBefore","attemptsThisDart","attemptsTotal","finishEntries","commitEntries","onAddAutoDart","onApplyManual","onReplaceManual","prevDarts","prevScore","onQuickEntry","onUndoDart","onCommitVisit","visitScore","visitDarts","mainContent","containerClass","renderVideoSurface","entrySeq","isPending","hasPositiveValue","hasHitRing","activeState","minutes","isHit","GameHeaderBar","sticky","GameScoreboard","matchScore","_gameRules","ScoreRow","AvgDifferenceRow","formatCricketClosed","getCricketStatus","mono","bold","highlight","matchAvg","allTimeAvg","isPositive","isNeutral","diffText","diffColor","closed","closedCount","clsx","CameraTile","autoStart","scaleOverrideProp","tileFitModeOverrideProp","setPc","lastRegisteredModeRef","registerStream","modeOverride","attachFromSession","liveTracks","startLocal","handleModeSelect","newMode","CameraFrame","scaleProp","tileFitModeOverride","storedAspect","globalFitMode","forceFallbackMode","setForceFallbackMode","isContainerVisible","effectiveFitMode","aspectChoice","aspectClass","running","useFallback","StatBlock","MatchStartShowcase","initialSeconds","disableEscClose","onDone","onRequestClose","seconds","setSeconds","showGo","setShowGo","portalElRef","goTimeoutRef","onKeyDown","root","avg3","best9","bestLeg","all","lifetimeScored","lifetimeDarts","career180s","legCount","visit","overlay","getPreferredUserName","LetterboxScoreboardOverlay","checkoutRemaining","away","home","route","MatchPage","_ready","setReady","winningShot","setWinningShot","remoteFrame","setRemoteFrame","lastOfflineStart","localPlayerName","resolvedLocalIndex","localPlayerIndex","isUsersTurn","localPlayer","localRemaining","awayIdx","_p","awayPlayer","awayRemaining","opponentPlayers","playerVisitDarts","setPlayerVisitDarts","playerDartPoints","setPlayerDartPoints","visitTotalInput","setVisitTotalInput","manualBox","setManualBox","multiEntry","setMultiEntry","manualEntries","setManualEntries","showStartShowcase","setShowStartShowcase","showcaseLockedOpenRef","showMobileCamera","setShowMobileCamera","mobileViewMode","setMobileViewMode","tryImportSnapshot","_pIdx","deriveWinningLabel","commitVisit","prevRemaining","numericScore","newRemaining","playerName","legs","lastVisit","latest","derived","CameraView","_score","_darts","finished","NDN_OPEN_NOTIFICATIONS_EVENT","dispatchOpenNotifications","WSConnectionDot","baseTitle","Home","CameraView$2","OfflinePlay","Friends","OnlinePlay","StatsPanel","Tournaments","AdminAccess","OpsDashboard","App","appRef","avatar","setAvatar","isFullscreen","setIsFullscreen","tab","setTab","isMobile","setIsMobile","navOpen","setNavOpen","setUser","setUserWithMerge","merged","MINIMAL_UI","minimalUI","setMinimalUI","setAllTimeAvg","avgDelta","setAvgDelta","isCompact","normalizedDelta","calibLocked","userSettings","persistedLocked","onUnhandled","fetchSubscription","onLogout","retryTimer","nextAvg","currentMonth","currentYear","baseline","snapshotMonth","onUpdate","handleVisibility","handleFocus","storedAvatar","handleStorageChange","handleAvatarUpdate","handleVisibilityChange","checkAvatarInterval","urlParams","paid","usernameChange","pendingUsername","onFullscreenChange","updateHeaderHeight","lastTop","onScroll","currentTop","onName","onTabChange","brand","leftPx","showSubscriptionsBell","setShowSubscriptionsBell","notificationsOpen","setNotificationsOpen","siteNotifications","setSiteNotifications","friendRequestCount","setFriendRequestCount","unreadMessageCount","setUnreadMessageCount","refreshNotifications","refreshFriendCounts","friendPollFailuresRef","friendPollDisabledUntilRef","THREE_DAYS_MS","int","runIfFocused","addSubscriptionNotification","fallbackAvatar","notificationText","tournamentNotifs","checkinNotifs","matchInviteNotifs","notificationPanelItems","CalendarDays","Handshake","ArrowUpRight","ArrowDownRight","MobileNav","Suspense","MobileBottomNav","Bell","onMore","navItems","Globe","BarChart2","Menu","displayAvatar","isPremium","validatePassword","ResetPassword","setToken","confirm","setConfirm","setSuccess","onSubmit","ErrorBoundary","Component","setupInstallPromptHooks","promptEvent","installQuietConsole","originals","shouldSuppress","lastPrintedAt","RATE_MS","wrap","__ndn_last_error","__ndn_capture_and_clip","errInfo","ReactDOM","StrictMode","Root","enablePwaSw","reg","regs","anyActive","forceReload"],"ignoreList":[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,55,56,57,58,59,60,62],"sources":["../../node_modules/react/cjs/react-jsx-runtime.production.min.js","../../node_modules/react/jsx-runtime.js","../../node_modules/react-dom/client.js","../../node_modules/@babel/runtime/helpers/esm/objectWithoutPropertiesLoose.js","../../node_modules/@babel/runtime/helpers/esm/extends.js","../../node_modules/focus-lock/dist/es2015/constants.js","../../node_modules/use-callback-ref/dist/es2015/assignRef.js","../../node_modules/use-callback-ref/dist/es2015/useRef.js","../../node_modules/use-callback-ref/dist/es2015/useMergeRef.js","../../node_modules/react-focus-lock/dist/es2015/FocusGuard.js","../../node_modules/tslib/tslib.es6.mjs","../../node_modules/use-sidecar/dist/es2015/medium.js","../../node_modules/react-focus-lock/dist/es2015/medium.js","../../node_modules/react-focus-lock/dist/es2015/scope.js","../../node_modules/react-focus-lock/dist/es2015/Lock.js","../../node_modules/@babel/runtime/helpers/esm/setPrototypeOf.js","../../node_modules/@babel/runtime/helpers/esm/inheritsLoose.js","../../node_modules/@babel/runtime/helpers/esm/typeof.js","../../node_modules/@babel/runtime/helpers/esm/toPrimitive.js","../../node_modules/@babel/runtime/helpers/esm/toPropertyKey.js","../../node_modules/@babel/runtime/helpers/esm/defineProperty.js","../../node_modules/react-clientside-effect/lib/index.es.js","../../node_modules/focus-lock/dist/es2015/utils/array.js","../../node_modules/focus-lock/dist/es2015/utils/is.js","../../node_modules/focus-lock/dist/es2015/utils/tabOrder.js","../../node_modules/focus-lock/dist/es2015/utils/tabbables.js","../../node_modules/focus-lock/dist/es2015/utils/tabUtils.js","../../node_modules/focus-lock/dist/es2015/utils/DOMutils.js","../../node_modules/focus-lock/dist/es2015/utils/all-affected.js","../../node_modules/focus-lock/dist/es2015/utils/safe.js","../../node_modules/focus-lock/dist/es2015/utils/getActiveElement.js","../../node_modules/focus-lock/dist/es2015/focusInside.js","../../node_modules/focus-lock/dist/es2015/focusIsHidden.js","../../node_modules/focus-lock/dist/es2015/utils/correctFocus.js","../../node_modules/focus-lock/dist/es2015/utils/firstFocus.js","../../node_modules/focus-lock/dist/es2015/solver.js","../../node_modules/focus-lock/dist/es2015/utils/auto-focus.js","../../node_modules/focus-lock/dist/es2015/utils/parenting.js","../../node_modules/focus-lock/dist/es2015/focusSolver.js","../../node_modules/focus-lock/dist/es2015/focusables.js","../../node_modules/focus-lock/dist/es2015/commands.js","../../node_modules/focus-lock/dist/es2015/moveFocusInside.js","../../node_modules/focus-lock/dist/es2015/return-focus.js","../../node_modules/focus-lock/dist/es2015/sibling.js","../../node_modules/react-focus-lock/dist/es2015/util.js","../../node_modules/react-focus-lock/dist/es2015/Trap.js","../../node_modules/react-focus-lock/dist/es2015/Combination.js","../../src/utils/quota.ts","../../src/utils/admin.ts","../../src/utils/config.ts","../../src/utils/api.ts","../../src/components/Sidebar.tsx","../../src/components/ScrollFade.tsx","../../src/utils/logger.ts","../../src/utils/dartDetector.ts","../../node_modules/zustand/esm/vanilla.mjs","../../node_modules/use-sync-external-store/cjs/use-sync-external-store-shim.production.js","../../node_modules/use-sync-external-store/shim/index.js","../../node_modules/use-sync-external-store/cjs/use-sync-external-store-shim/with-selector.production.js","../../node_modules/use-sync-external-store/shim/with-selector.js","../../node_modules/zustand/esm/index.mjs","../../src/store/calibration.ts","../../node_modules/zustand/esm/middleware.mjs","../../src/store/cameraSession.ts","../../src/utils/vision.ts","../../src/utils/markerCalibration.ts","../../src/utils/gameCalibrationRequirements.ts","../../src/store/userSettings.ts","../../src/utils/boardDetection.ts","../../src/utils/networkDevices.ts","../../src/store/audit.ts","../../src/utils/broadcast.ts","../../src/store/match.ts","../../src/utils/ws.ts","../../src/components/WSProvider.tsx","../../src/components/Calibrator.tsx","../../src/store/toast.ts","../../src/components/Toaster.tsx","../../src/components/BarChart.tsx","../../src/components/ui/TabPills.tsx","../../src/store/profileStats.ts","../../src/utils/games.ts","../../src/ui/icons.ts","../../src/components/CameraStatusBadge.tsx","../../src/utils/helpDeskAI.ts","../../src/components/HelpdeskChat.tsx","../../src/components/AdminDashboard.tsx","../../src/contexts/ThemeProvider.tsx","../../src/components/ThemeToggle.tsx","../../src/components/SettingsPanel.tsx","../../src/components/Auth.tsx","../../src/components/ThemeContext.tsx","../../src/components/HelpAssistant.tsx","../../src/components/GlobalCameraLogger.tsx","../../src/components/GlobalPhoneVideoSink.tsx","../../src/utils/cameraRecovery.ts","../../src/utils/cameraRecoveryEvents.ts","../../src/components/GlobalCameraWatchdog.tsx","../../src/components/GlobalCameraRecoveryToasts.tsx","../../src/components/InstallPicker.tsx","../../src/components/AddToHomeButton.tsx","../../src/components/ui/ResizableModal.tsx","../../src/components/InstallAppButton.tsx","../../src/components/Footer.tsx","../../src/store/matchControl.ts","../../src/components/AutoPauseManager.tsx","../../src/utils/ensureVideoPlays.ts","../../src/utils/autoscore.ts","../../src/utils/scoring.ts","../../src/components/ui/ResizablePanel.tsx","../../src/store/pendingVisit.ts","../../src/components/ui/PauseQuitModal.tsx","../../src/components/ui/PauseTimerBadge.tsx","../../src/utils/matchSync.ts","../../src/utils/checkout.ts","../../src/utils/bullDistance.ts","../../src/components/CameraView.tsx","../../src/components/ui/GameHeaderBar.tsx","../../src/components/scoreboards/GameScoreboard.tsx","../../src/components/CameraTile.tsx","../../src/components/ui/MatchStartShowcase.tsx","../../src/utils/userName.ts","../../src/components/ui/LetterboxScoreboardOverlay.tsx","../../src/components/MatchPage.tsx","../../src/utils/events.ts","../../src/components/WSConnectionDot.tsx","../../src/App.tsx","../../src/components/ResetPassword.tsx","../../src/components/ErrorBoundary.tsx","../../src/utils/installPrompt.ts","../../src/utils/quietConsole.ts","../../src/main.tsx"],"sourcesContent":["/**\n * @license React\n * react-jsx-runtime.production.min.js\n *\n * Copyright (c) Facebook, Inc. and its affiliates.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n */\n'use strict';var f=require(\"react\"),k=Symbol.for(\"react.element\"),l=Symbol.for(\"react.fragment\"),m=Object.prototype.hasOwnProperty,n=f.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,p={key:!0,ref:!0,__self:!0,__source:!0};\nfunction q(c,a,g){var b,d={},e=null,h=null;void 0!==g&&(e=\"\"+g);void 0!==a.key&&(e=\"\"+a.key);void 0!==a.ref&&(h=a.ref);for(b in a)m.call(a,b)&&!p.hasOwnProperty(b)&&(d[b]=a[b]);if(c&&c.defaultProps)for(b in a=c.defaultProps,a)void 0===d[b]&&(d[b]=a[b]);return{$$typeof:k,type:c,key:e,ref:h,props:d,_owner:n.current}}exports.Fragment=l;exports.jsx=q;exports.jsxs=q;\n","'use strict';\n\nif (process.env.NODE_ENV === 'production') {\n  module.exports = require('./cjs/react-jsx-runtime.production.min.js');\n} else {\n  module.exports = require('./cjs/react-jsx-runtime.development.js');\n}\n","'use strict';\n\nvar m = require('react-dom');\nif (process.env.NODE_ENV === 'production') {\n  exports.createRoot = m.createRoot;\n  exports.hydrateRoot = m.hydrateRoot;\n} else {\n  var i = m.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED;\n  exports.createRoot = function(c, o) {\n    i.usingClientEntryPoint = true;\n    try {\n      return m.createRoot(c, o);\n    } finally {\n      i.usingClientEntryPoint = false;\n    }\n  };\n  exports.hydrateRoot = function(c, h, o) {\n    i.usingClientEntryPoint = true;\n    try {\n      return m.hydrateRoot(c, h, o);\n    } finally {\n      i.usingClientEntryPoint = false;\n    }\n  };\n}\n","function _objectWithoutPropertiesLoose(r, e) {\n  if (null == r) return {};\n  var t = {};\n  for (var n in r) if ({}.hasOwnProperty.call(r, n)) {\n    if (-1 !== e.indexOf(n)) continue;\n    t[n] = r[n];\n  }\n  return t;\n}\nexport { _objectWithoutPropertiesLoose as default };","function _extends() {\n  return _extends = Object.assign ? Object.assign.bind() : function (n) {\n    for (var e = 1; e < arguments.length; e++) {\n      var t = arguments[e];\n      for (var r in t) ({}).hasOwnProperty.call(t, r) && (n[r] = t[r]);\n    }\n    return n;\n  }, _extends.apply(null, arguments);\n}\nexport { _extends as default };","/**\n * defines a focus group\n */\nexport var FOCUS_GROUP = 'data-focus-lock';\n/**\n * disables element discovery inside a group marked by key\n */\nexport var FOCUS_DISABLED = 'data-focus-lock-disabled';\n/**\n * allows uncontrolled focus within the marked area, effectively disabling focus lock for it's content\n */\nexport var FOCUS_ALLOW = 'data-no-focus-lock';\n/**\n * instructs autofocus engine to pick default autofocus inside a given node\n * can be set on the element or container\n */\nexport var FOCUS_AUTO = 'data-autofocus-inside';\n/**\n * instructs autofocus to ignore elements within a given node\n * can be set on the element or container\n */\nexport var FOCUS_NO_AUTOFOCUS = 'data-no-autofocus';\n","/**\n * Assigns a value for a given ref, no matter of the ref format\n * @param {RefObject} ref - a callback function or ref object\n * @param value - a new value\n *\n * @see https://github.com/theKashey/use-callback-ref#assignref\n * @example\n * const refObject = useRef();\n * const refFn = (ref) => {....}\n *\n * assignRef(refObject, \"refValue\");\n * assignRef(refFn, \"refValue\");\n */\nexport function assignRef(ref, value) {\n    if (typeof ref === 'function') {\n        ref(value);\n    }\n    else if (ref) {\n        ref.current = value;\n    }\n    return ref;\n}\n","import { useState } from 'react';\n/**\n * creates a MutableRef with ref change callback\n * @param initialValue - initial ref value\n * @param {Function} callback - a callback to run when value changes\n *\n * @example\n * const ref = useCallbackRef(0, (newValue, oldValue) => console.log(oldValue, '->', newValue);\n * ref.current = 1;\n * // prints 0 -> 1\n *\n * @see https://reactjs.org/docs/hooks-reference.html#useref\n * @see https://github.com/theKashey/use-callback-ref#usecallbackref---to-replace-reactuseref\n * @returns {MutableRefObject}\n */\nexport function useCallbackRef(initialValue, callback) {\n    var ref = useState(function () { return ({\n        // value\n        value: initialValue,\n        // last callback\n        callback: callback,\n        // \"memoized\" public interface\n        facade: {\n            get current() {\n                return ref.value;\n            },\n            set current(value) {\n                var last = ref.value;\n                if (last !== value) {\n                    ref.value = value;\n                    ref.callback(value, last);\n                }\n            },\n        },\n    }); })[0];\n    // update callback\n    ref.callback = callback;\n    return ref.facade;\n}\n","import * as React from 'react';\nimport { assignRef } from './assignRef';\nimport { useCallbackRef } from './useRef';\nvar useIsomorphicLayoutEffect = typeof window !== 'undefined' ? React.useLayoutEffect : React.useEffect;\nvar currentValues = new WeakMap();\n/**\n * Merges two or more refs together providing a single interface to set their value\n * @param {RefObject|Ref} refs\n * @returns {MutableRefObject} - a new ref, which translates all changes to {refs}\n *\n * @see {@link mergeRefs} a version without buit-in memoization\n * @see https://github.com/theKashey/use-callback-ref#usemergerefs\n * @example\n * const Component = React.forwardRef((props, ref) => {\n *   const ownRef = useRef();\n *   const domRef = useMergeRefs([ref, ownRef]); //  merge together\n *   return <div ref={domRef}>...</div>\n * }\n */\nexport function useMergeRefs(refs, defaultValue) {\n    var callbackRef = useCallbackRef(defaultValue || null, function (newValue) {\n        return refs.forEach(function (ref) { return assignRef(ref, newValue); });\n    });\n    // handle refs changes - added or removed\n    useIsomorphicLayoutEffect(function () {\n        var oldValue = currentValues.get(callbackRef);\n        if (oldValue) {\n            var prevRefs_1 = new Set(oldValue);\n            var nextRefs_1 = new Set(refs);\n            var current_1 = callbackRef.current;\n            prevRefs_1.forEach(function (ref) {\n                if (!nextRefs_1.has(ref)) {\n                    assignRef(ref, null);\n                }\n            });\n            nextRefs_1.forEach(function (ref) {\n                if (!prevRefs_1.has(ref)) {\n                    assignRef(ref, current_1);\n                }\n            });\n        }\n        currentValues.set(callbackRef, refs);\n    }, [refs]);\n    return callbackRef;\n}\n","import React, { Fragment } from 'react';\nimport PropTypes from 'prop-types';\nexport var hiddenGuard = {\n  width: '1px',\n  height: '0px',\n  padding: 0,\n  overflow: 'hidden',\n  position: 'fixed',\n  top: '1px',\n  left: '1px'\n};\nvar InFocusGuard = function InFocusGuard(_ref) {\n  var _ref$children = _ref.children,\n    children = _ref$children === void 0 ? null : _ref$children;\n  return /*#__PURE__*/React.createElement(Fragment, null, /*#__PURE__*/React.createElement(\"div\", {\n    key: \"guard-first\",\n    \"data-focus-guard\": true,\n    \"data-focus-auto-guard\": true,\n    style: hiddenGuard\n  }), children, children && /*#__PURE__*/React.createElement(\"div\", {\n    key: \"guard-last\",\n    \"data-focus-guard\": true,\n    \"data-focus-auto-guard\": true,\n    style: hiddenGuard\n  }));\n};\nInFocusGuard.propTypes = process.env.NODE_ENV !== \"production\" ? {\n  children: PropTypes.node\n} : {};\nexport default InFocusGuard;","/******************************************************************************\nCopyright (c) Microsoft Corporation.\n\nPermission to use, copy, modify, and/or distribute this software for any\npurpose with or without fee is hereby granted.\n\nTHE SOFTWARE IS PROVIDED \"AS IS\" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH\nREGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY\nAND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,\nINDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM\nLOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR\nOTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR\nPERFORMANCE OF THIS SOFTWARE.\n***************************************************************************** */\n/* global Reflect, Promise, SuppressedError, Symbol, Iterator */\n\nvar extendStatics = function(d, b) {\n  extendStatics = Object.setPrototypeOf ||\n      ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||\n      function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };\n  return extendStatics(d, b);\n};\n\nexport function __extends(d, b) {\n  if (typeof b !== \"function\" && b !== null)\n      throw new TypeError(\"Class extends value \" + String(b) + \" is not a constructor or null\");\n  extendStatics(d, b);\n  function __() { this.constructor = d; }\n  d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\n}\n\nexport var __assign = function() {\n  __assign = Object.assign || function __assign(t) {\n      for (var s, i = 1, n = arguments.length; i < n; i++) {\n          s = arguments[i];\n          for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p)) t[p] = s[p];\n      }\n      return t;\n  }\n  return __assign.apply(this, arguments);\n}\n\nexport function __rest(s, e) {\n  var t = {};\n  for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p) && e.indexOf(p) < 0)\n      t[p] = s[p];\n  if (s != null && typeof Object.getOwnPropertySymbols === \"function\")\n      for (var i = 0, p = Object.getOwnPropertySymbols(s); i < p.length; i++) {\n          if (e.indexOf(p[i]) < 0 && Object.prototype.propertyIsEnumerable.call(s, p[i]))\n              t[p[i]] = s[p[i]];\n      }\n  return t;\n}\n\nexport function __decorate(decorators, target, key, desc) {\n  var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;\n  if (typeof Reflect === \"object\" && typeof Reflect.decorate === \"function\") r = Reflect.decorate(decorators, target, key, desc);\n  else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;\n  return c > 3 && r && Object.defineProperty(target, key, r), r;\n}\n\nexport function __param(paramIndex, decorator) {\n  return function (target, key) { decorator(target, key, paramIndex); }\n}\n\nexport function __esDecorate(ctor, descriptorIn, decorators, contextIn, initializers, extraInitializers) {\n  function accept(f) { if (f !== void 0 && typeof f !== \"function\") throw new TypeError(\"Function expected\"); return f; }\n  var kind = contextIn.kind, key = kind === \"getter\" ? \"get\" : kind === \"setter\" ? \"set\" : \"value\";\n  var target = !descriptorIn && ctor ? contextIn[\"static\"] ? ctor : ctor.prototype : null;\n  var descriptor = descriptorIn || (target ? Object.getOwnPropertyDescriptor(target, contextIn.name) : {});\n  var _, done = false;\n  for (var i = decorators.length - 1; i >= 0; i--) {\n      var context = {};\n      for (var p in contextIn) context[p] = p === \"access\" ? {} : contextIn[p];\n      for (var p in contextIn.access) context.access[p] = contextIn.access[p];\n      context.addInitializer = function (f) { if (done) throw new TypeError(\"Cannot add initializers after decoration has completed\"); extraInitializers.push(accept(f || null)); };\n      var result = (0, decorators[i])(kind === \"accessor\" ? { get: descriptor.get, set: descriptor.set } : descriptor[key], context);\n      if (kind === \"accessor\") {\n          if (result === void 0) continue;\n          if (result === null || typeof result !== \"object\") throw new TypeError(\"Object expected\");\n          if (_ = accept(result.get)) descriptor.get = _;\n          if (_ = accept(result.set)) descriptor.set = _;\n          if (_ = accept(result.init)) initializers.unshift(_);\n      }\n      else if (_ = accept(result)) {\n          if (kind === \"field\") initializers.unshift(_);\n          else descriptor[key] = _;\n      }\n  }\n  if (target) Object.defineProperty(target, contextIn.name, descriptor);\n  done = true;\n};\n\nexport function __runInitializers(thisArg, initializers, value) {\n  var useValue = arguments.length > 2;\n  for (var i = 0; i < initializers.length; i++) {\n      value = useValue ? initializers[i].call(thisArg, value) : initializers[i].call(thisArg);\n  }\n  return useValue ? value : void 0;\n};\n\nexport function __propKey(x) {\n  return typeof x === \"symbol\" ? x : \"\".concat(x);\n};\n\nexport function __setFunctionName(f, name, prefix) {\n  if (typeof name === \"symbol\") name = name.description ? \"[\".concat(name.description, \"]\") : \"\";\n  return Object.defineProperty(f, \"name\", { configurable: true, value: prefix ? \"\".concat(prefix, \" \", name) : name });\n};\n\nexport function __metadata(metadataKey, metadataValue) {\n  if (typeof Reflect === \"object\" && typeof Reflect.metadata === \"function\") return Reflect.metadata(metadataKey, metadataValue);\n}\n\nexport function __awaiter(thisArg, _arguments, P, generator) {\n  function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\n  return new (P || (P = Promise))(function (resolve, reject) {\n      function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n      function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\n      function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\n      step((generator = generator.apply(thisArg, _arguments || [])).next());\n  });\n}\n\nexport function __generator(thisArg, body) {\n  var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g = Object.create((typeof Iterator === \"function\" ? Iterator : Object).prototype);\n  return g.next = verb(0), g[\"throw\"] = verb(1), g[\"return\"] = verb(2), typeof Symbol === \"function\" && (g[Symbol.iterator] = function() { return this; }), g;\n  function verb(n) { return function (v) { return step([n, v]); }; }\n  function step(op) {\n      if (f) throw new TypeError(\"Generator is already executing.\");\n      while (g && (g = 0, op[0] && (_ = 0)), _) try {\n          if (f = 1, y && (t = op[0] & 2 ? y[\"return\"] : op[0] ? y[\"throw\"] || ((t = y[\"return\"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;\n          if (y = 0, t) op = [op[0] & 2, t.value];\n          switch (op[0]) {\n              case 0: case 1: t = op; break;\n              case 4: _.label++; return { value: op[1], done: false };\n              case 5: _.label++; y = op[1]; op = [0]; continue;\n              case 7: op = _.ops.pop(); _.trys.pop(); continue;\n              default:\n                  if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }\n                  if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }\n                  if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }\n                  if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }\n                  if (t[2]) _.ops.pop();\n                  _.trys.pop(); continue;\n          }\n          op = body.call(thisArg, _);\n      } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }\n      if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };\n  }\n}\n\nexport var __createBinding = Object.create ? (function(o, m, k, k2) {\n  if (k2 === undefined) k2 = k;\n  var desc = Object.getOwnPropertyDescriptor(m, k);\n  if (!desc || (\"get\" in desc ? !m.__esModule : desc.writable || desc.configurable)) {\n      desc = { enumerable: true, get: function() { return m[k]; } };\n  }\n  Object.defineProperty(o, k2, desc);\n}) : (function(o, m, k, k2) {\n  if (k2 === undefined) k2 = k;\n  o[k2] = m[k];\n});\n\nexport function __exportStar(m, o) {\n  for (var p in m) if (p !== \"default\" && !Object.prototype.hasOwnProperty.call(o, p)) __createBinding(o, m, p);\n}\n\nexport function __values(o) {\n  var s = typeof Symbol === \"function\" && Symbol.iterator, m = s && o[s], i = 0;\n  if (m) return m.call(o);\n  if (o && typeof o.length === \"number\") return {\n      next: function () {\n          if (o && i >= o.length) o = void 0;\n          return { value: o && o[i++], done: !o };\n      }\n  };\n  throw new TypeError(s ? \"Object is not iterable.\" : \"Symbol.iterator is not defined.\");\n}\n\nexport function __read(o, n) {\n  var m = typeof Symbol === \"function\" && o[Symbol.iterator];\n  if (!m) return o;\n  var i = m.call(o), r, ar = [], e;\n  try {\n      while ((n === void 0 || n-- > 0) && !(r = i.next()).done) ar.push(r.value);\n  }\n  catch (error) { e = { error: error }; }\n  finally {\n      try {\n          if (r && !r.done && (m = i[\"return\"])) m.call(i);\n      }\n      finally { if (e) throw e.error; }\n  }\n  return ar;\n}\n\n/** @deprecated */\nexport function __spread() {\n  for (var ar = [], i = 0; i < arguments.length; i++)\n      ar = ar.concat(__read(arguments[i]));\n  return ar;\n}\n\n/** @deprecated */\nexport function __spreadArrays() {\n  for (var s = 0, i = 0, il = arguments.length; i < il; i++) s += arguments[i].length;\n  for (var r = Array(s), k = 0, i = 0; i < il; i++)\n      for (var a = arguments[i], j = 0, jl = a.length; j < jl; j++, k++)\n          r[k] = a[j];\n  return r;\n}\n\nexport function __spreadArray(to, from, pack) {\n  if (pack || arguments.length === 2) for (var i = 0, l = from.length, ar; i < l; i++) {\n      if (ar || !(i in from)) {\n          if (!ar) ar = Array.prototype.slice.call(from, 0, i);\n          ar[i] = from[i];\n      }\n  }\n  return to.concat(ar || Array.prototype.slice.call(from));\n}\n\nexport function __await(v) {\n  return this instanceof __await ? (this.v = v, this) : new __await(v);\n}\n\nexport function __asyncGenerator(thisArg, _arguments, generator) {\n  if (!Symbol.asyncIterator) throw new TypeError(\"Symbol.asyncIterator is not defined.\");\n  var g = generator.apply(thisArg, _arguments || []), i, q = [];\n  return i = Object.create((typeof AsyncIterator === \"function\" ? AsyncIterator : Object).prototype), verb(\"next\"), verb(\"throw\"), verb(\"return\", awaitReturn), i[Symbol.asyncIterator] = function () { return this; }, i;\n  function awaitReturn(f) { return function (v) { return Promise.resolve(v).then(f, reject); }; }\n  function verb(n, f) { if (g[n]) { i[n] = function (v) { return new Promise(function (a, b) { q.push([n, v, a, b]) > 1 || resume(n, v); }); }; if (f) i[n] = f(i[n]); } }\n  function resume(n, v) { try { step(g[n](v)); } catch (e) { settle(q[0][3], e); } }\n  function step(r) { r.value instanceof __await ? Promise.resolve(r.value.v).then(fulfill, reject) : settle(q[0][2], r); }\n  function fulfill(value) { resume(\"next\", value); }\n  function reject(value) { resume(\"throw\", value); }\n  function settle(f, v) { if (f(v), q.shift(), q.length) resume(q[0][0], q[0][1]); }\n}\n\nexport function __asyncDelegator(o) {\n  var i, p;\n  return i = {}, verb(\"next\"), verb(\"throw\", function (e) { throw e; }), verb(\"return\"), i[Symbol.iterator] = function () { return this; }, i;\n  function verb(n, f) { i[n] = o[n] ? function (v) { return (p = !p) ? { value: __await(o[n](v)), done: false } : f ? f(v) : v; } : f; }\n}\n\nexport function __asyncValues(o) {\n  if (!Symbol.asyncIterator) throw new TypeError(\"Symbol.asyncIterator is not defined.\");\n  var m = o[Symbol.asyncIterator], i;\n  return m ? m.call(o) : (o = typeof __values === \"function\" ? __values(o) : o[Symbol.iterator](), i = {}, verb(\"next\"), verb(\"throw\"), verb(\"return\"), i[Symbol.asyncIterator] = function () { return this; }, i);\n  function verb(n) { i[n] = o[n] && function (v) { return new Promise(function (resolve, reject) { v = o[n](v), settle(resolve, reject, v.done, v.value); }); }; }\n  function settle(resolve, reject, d, v) { Promise.resolve(v).then(function(v) { resolve({ value: v, done: d }); }, reject); }\n}\n\nexport function __makeTemplateObject(cooked, raw) {\n  if (Object.defineProperty) { Object.defineProperty(cooked, \"raw\", { value: raw }); } else { cooked.raw = raw; }\n  return cooked;\n};\n\nvar __setModuleDefault = Object.create ? (function(o, v) {\n  Object.defineProperty(o, \"default\", { enumerable: true, value: v });\n}) : function(o, v) {\n  o[\"default\"] = v;\n};\n\nvar ownKeys = function(o) {\n  ownKeys = Object.getOwnPropertyNames || function (o) {\n    var ar = [];\n    for (var k in o) if (Object.prototype.hasOwnProperty.call(o, k)) ar[ar.length] = k;\n    return ar;\n  };\n  return ownKeys(o);\n};\n\nexport function __importStar(mod) {\n  if (mod && mod.__esModule) return mod;\n  var result = {};\n  if (mod != null) for (var k = ownKeys(mod), i = 0; i < k.length; i++) if (k[i] !== \"default\") __createBinding(result, mod, k[i]);\n  __setModuleDefault(result, mod);\n  return result;\n}\n\nexport function __importDefault(mod) {\n  return (mod && mod.__esModule) ? mod : { default: mod };\n}\n\nexport function __classPrivateFieldGet(receiver, state, kind, f) {\n  if (kind === \"a\" && !f) throw new TypeError(\"Private accessor was defined without a getter\");\n  if (typeof state === \"function\" ? receiver !== state || !f : !state.has(receiver)) throw new TypeError(\"Cannot read private member from an object whose class did not declare it\");\n  return kind === \"m\" ? f : kind === \"a\" ? f.call(receiver) : f ? f.value : state.get(receiver);\n}\n\nexport function __classPrivateFieldSet(receiver, state, value, kind, f) {\n  if (kind === \"m\") throw new TypeError(\"Private method is not writable\");\n  if (kind === \"a\" && !f) throw new TypeError(\"Private accessor was defined without a setter\");\n  if (typeof state === \"function\" ? receiver !== state || !f : !state.has(receiver)) throw new TypeError(\"Cannot write private member to an object whose class did not declare it\");\n  return (kind === \"a\" ? f.call(receiver, value) : f ? f.value = value : state.set(receiver, value)), value;\n}\n\nexport function __classPrivateFieldIn(state, receiver) {\n  if (receiver === null || (typeof receiver !== \"object\" && typeof receiver !== \"function\")) throw new TypeError(\"Cannot use 'in' operator on non-object\");\n  return typeof state === \"function\" ? receiver === state : state.has(receiver);\n}\n\nexport function __addDisposableResource(env, value, async) {\n  if (value !== null && value !== void 0) {\n    if (typeof value !== \"object\" && typeof value !== \"function\") throw new TypeError(\"Object expected.\");\n    var dispose, inner;\n    if (async) {\n      if (!Symbol.asyncDispose) throw new TypeError(\"Symbol.asyncDispose is not defined.\");\n      dispose = value[Symbol.asyncDispose];\n    }\n    if (dispose === void 0) {\n      if (!Symbol.dispose) throw new TypeError(\"Symbol.dispose is not defined.\");\n      dispose = value[Symbol.dispose];\n      if (async) inner = dispose;\n    }\n    if (typeof dispose !== \"function\") throw new TypeError(\"Object not disposable.\");\n    if (inner) dispose = function() { try { inner.call(this); } catch (e) { return Promise.reject(e); } };\n    env.stack.push({ value: value, dispose: dispose, async: async });\n  }\n  else if (async) {\n    env.stack.push({ async: true });\n  }\n  return value;\n}\n\nvar _SuppressedError = typeof SuppressedError === \"function\" ? SuppressedError : function (error, suppressed, message) {\n  var e = new Error(message);\n  return e.name = \"SuppressedError\", e.error = error, e.suppressed = suppressed, e;\n};\n\nexport function __disposeResources(env) {\n  function fail(e) {\n    env.error = env.hasError ? new _SuppressedError(e, env.error, \"An error was suppressed during disposal.\") : e;\n    env.hasError = true;\n  }\n  var r, s = 0;\n  function next() {\n    while (r = env.stack.pop()) {\n      try {\n        if (!r.async && s === 1) return s = 0, env.stack.push(r), Promise.resolve().then(next);\n        if (r.dispose) {\n          var result = r.dispose.call(r.value);\n          if (r.async) return s |= 2, Promise.resolve(result).then(next, function(e) { fail(e); return next(); });\n        }\n        else s |= 1;\n      }\n      catch (e) {\n        fail(e);\n      }\n    }\n    if (s === 1) return env.hasError ? Promise.reject(env.error) : Promise.resolve();\n    if (env.hasError) throw env.error;\n  }\n  return next();\n}\n\nexport function __rewriteRelativeImportExtension(path, preserveJsx) {\n  if (typeof path === \"string\" && /^\\.\\.?\\//.test(path)) {\n      return path.replace(/\\.(tsx)$|((?:\\.d)?)((?:\\.[^./]+?)?)\\.([cm]?)ts$/i, function (m, tsx, d, ext, cm) {\n          return tsx ? preserveJsx ? \".jsx\" : \".js\" : d && (!ext || !cm) ? m : (d + ext + \".\" + cm.toLowerCase() + \"js\");\n      });\n  }\n  return path;\n}\n\nexport default {\n  __extends,\n  __assign,\n  __rest,\n  __decorate,\n  __param,\n  __esDecorate,\n  __runInitializers,\n  __propKey,\n  __setFunctionName,\n  __metadata,\n  __awaiter,\n  __generator,\n  __createBinding,\n  __exportStar,\n  __values,\n  __read,\n  __spread,\n  __spreadArrays,\n  __spreadArray,\n  __await,\n  __asyncGenerator,\n  __asyncDelegator,\n  __asyncValues,\n  __makeTemplateObject,\n  __importStar,\n  __importDefault,\n  __classPrivateFieldGet,\n  __classPrivateFieldSet,\n  __classPrivateFieldIn,\n  __addDisposableResource,\n  __disposeResources,\n  __rewriteRelativeImportExtension,\n};\n","import { __assign } from \"tslib\";\nfunction ItoI(a) {\n    return a;\n}\nfunction innerCreateMedium(defaults, middleware) {\n    if (middleware === void 0) { middleware = ItoI; }\n    var buffer = [];\n    var assigned = false;\n    var medium = {\n        read: function () {\n            if (assigned) {\n                throw new Error('Sidecar: could not `read` from an `assigned` medium. `read` could be used only with `useMedium`.');\n            }\n            if (buffer.length) {\n                return buffer[buffer.length - 1];\n            }\n            return defaults;\n        },\n        useMedium: function (data) {\n            var item = middleware(data, assigned);\n            buffer.push(item);\n            return function () {\n                buffer = buffer.filter(function (x) { return x !== item; });\n            };\n        },\n        assignSyncMedium: function (cb) {\n            assigned = true;\n            while (buffer.length) {\n                var cbs = buffer;\n                buffer = [];\n                cbs.forEach(cb);\n            }\n            buffer = {\n                push: function (x) { return cb(x); },\n                filter: function () { return buffer; },\n            };\n        },\n        assignMedium: function (cb) {\n            assigned = true;\n            var pendingQueue = [];\n            if (buffer.length) {\n                var cbs = buffer;\n                buffer = [];\n                cbs.forEach(cb);\n                pendingQueue = buffer;\n            }\n            var executeQueue = function () {\n                var cbs = pendingQueue;\n                pendingQueue = [];\n                cbs.forEach(cb);\n            };\n            var cycle = function () { return Promise.resolve().then(executeQueue); };\n            cycle();\n            buffer = {\n                push: function (x) {\n                    pendingQueue.push(x);\n                    cycle();\n                },\n                filter: function (filter) {\n                    pendingQueue = pendingQueue.filter(filter);\n                    return buffer;\n                },\n            };\n        },\n    };\n    return medium;\n}\nexport function createMedium(defaults, middleware) {\n    if (middleware === void 0) { middleware = ItoI; }\n    return innerCreateMedium(defaults, middleware);\n}\n// eslint-disable-next-line @typescript-eslint/ban-types\nexport function createSidecarMedium(options) {\n    if (options === void 0) { options = {}; }\n    var medium = innerCreateMedium(null);\n    medium.options = __assign({ async: true, ssr: false }, options);\n    return medium;\n}\n","import { createMedium, createSidecarMedium } from 'use-sidecar';\nexport var mediumFocus = createMedium({}, function (_ref) {\n  var target = _ref.target,\n    currentTarget = _ref.currentTarget;\n  return {\n    target: target,\n    currentTarget: currentTarget\n  };\n});\nexport var mediumBlur = createMedium();\nexport var mediumEffect = createMedium();\nexport var mediumSidecar = createSidecarMedium({\n  async: true,\n  ssr: typeof document !== 'undefined'\n});","import { createContext } from 'react';\nexport var focusScope = /*#__PURE__*/createContext(undefined);","import _extends from \"@babel/runtime/helpers/esm/extends\";\nimport React, { forwardRef, useRef, useState, useCallback, useEffect, useMemo, Fragment } from 'react';\nimport { node, bool, string, any, arrayOf, oneOfType, object, func } from 'prop-types';\nimport { FOCUS_DISABLED, FOCUS_GROUP } from 'focus-lock/constants';\nimport { useMergeRefs } from 'use-callback-ref';\nimport { hiddenGuard } from './FocusGuard';\nimport { mediumFocus, mediumBlur, mediumSidecar } from './medium';\nimport { focusScope } from './scope';\nvar emptyArray = [];\nvar FocusLock = /*#__PURE__*/forwardRef(function FocusLockUI(props, parentRef) {\n  var _extends2;\n  var _useState = useState(),\n    realObserved = _useState[0],\n    setObserved = _useState[1];\n  var observed = useRef();\n  var isActive = useRef(false);\n  var originalFocusedElement = useRef(null);\n  var _useState2 = useState({}),\n    update = _useState2[1];\n  var children = props.children,\n    _props$disabled = props.disabled,\n    disabled = _props$disabled === void 0 ? false : _props$disabled,\n    _props$noFocusGuards = props.noFocusGuards,\n    noFocusGuards = _props$noFocusGuards === void 0 ? false : _props$noFocusGuards,\n    _props$persistentFocu = props.persistentFocus,\n    persistentFocus = _props$persistentFocu === void 0 ? false : _props$persistentFocu,\n    _props$crossFrame = props.crossFrame,\n    crossFrame = _props$crossFrame === void 0 ? true : _props$crossFrame,\n    _props$autoFocus = props.autoFocus,\n    autoFocus = _props$autoFocus === void 0 ? true : _props$autoFocus,\n    allowTextSelection = props.allowTextSelection,\n    group = props.group,\n    className = props.className,\n    whiteList = props.whiteList,\n    hasPositiveIndices = props.hasPositiveIndices,\n    _props$shards = props.shards,\n    shards = _props$shards === void 0 ? emptyArray : _props$shards,\n    _props$as = props.as,\n    Container = _props$as === void 0 ? 'div' : _props$as,\n    _props$lockProps = props.lockProps,\n    containerProps = _props$lockProps === void 0 ? {} : _props$lockProps,\n    SideCar = props.sideCar,\n    _props$returnFocus = props.returnFocus,\n    shouldReturnFocus = _props$returnFocus === void 0 ? false : _props$returnFocus,\n    focusOptions = props.focusOptions,\n    onActivationCallback = props.onActivation,\n    onDeactivationCallback = props.onDeactivation;\n  var _useState3 = useState({}),\n    id = _useState3[0];\n  var onActivation = useCallback(function (_ref) {\n    var captureFocusRestore = _ref.captureFocusRestore;\n    if (!originalFocusedElement.current) {\n      var _document;\n      var activeElement = (_document = document) == null ? void 0 : _document.activeElement;\n      originalFocusedElement.current = activeElement;\n      if (activeElement !== document.body) {\n        originalFocusedElement.current = captureFocusRestore(activeElement);\n      }\n    }\n    if (observed.current && onActivationCallback) {\n      onActivationCallback(observed.current);\n    }\n    isActive.current = true;\n    update();\n  }, [onActivationCallback]);\n  var onDeactivation = useCallback(function () {\n    isActive.current = false;\n    if (onDeactivationCallback) {\n      onDeactivationCallback(observed.current);\n    }\n    update();\n  }, [onDeactivationCallback]);\n  var returnFocus = useCallback(function (allowDefer) {\n    var focusRestore = originalFocusedElement.current;\n    if (focusRestore) {\n      var returnFocusTo = (typeof focusRestore === 'function' ? focusRestore() : focusRestore) || document.body;\n      var howToReturnFocus = typeof shouldReturnFocus === 'function' ? shouldReturnFocus(returnFocusTo) : shouldReturnFocus;\n      if (howToReturnFocus) {\n        var returnFocusOptions = typeof howToReturnFocus === 'object' ? howToReturnFocus : undefined;\n        originalFocusedElement.current = null;\n        if (allowDefer) {\n          Promise.resolve().then(function () {\n            return returnFocusTo.focus(returnFocusOptions);\n          });\n        } else {\n          returnFocusTo.focus(returnFocusOptions);\n        }\n      }\n    }\n  }, [shouldReturnFocus]);\n  var onFocus = useCallback(function (event) {\n    if (isActive.current) {\n      mediumFocus.useMedium(event);\n    }\n  }, []);\n  var onBlur = mediumBlur.useMedium;\n  var setObserveNode = useCallback(function (newObserved) {\n    if (observed.current !== newObserved) {\n      observed.current = newObserved;\n      setObserved(newObserved);\n    }\n  }, []);\n  if (process.env.NODE_ENV !== 'production') {\n    if (typeof allowTextSelection !== 'undefined') {\n      console.warn('React-Focus-Lock: allowTextSelection is deprecated and enabled by default');\n    }\n    useEffect(function () {\n      if (!observed.current && typeof Container !== 'string') {\n        console.error('FocusLock: could not obtain ref to internal node');\n      }\n    }, []);\n  }\n  var lockProps = _extends((_extends2 = {}, _extends2[FOCUS_DISABLED] = disabled && 'disabled', _extends2[FOCUS_GROUP] = group, _extends2), containerProps);\n  var hasLeadingGuards = noFocusGuards !== true;\n  var hasTailingGuards = hasLeadingGuards && noFocusGuards !== 'tail';\n  var mergedRef = useMergeRefs([parentRef, setObserveNode]);\n  var focusScopeValue = useMemo(function () {\n    return {\n      observed: observed,\n      shards: shards,\n      enabled: !disabled,\n      active: isActive.current\n    };\n  }, [disabled, isActive.current, shards, realObserved]);\n  return /*#__PURE__*/React.createElement(Fragment, null, hasLeadingGuards && [\n  /*#__PURE__*/\n  React.createElement(\"div\", {\n    key: \"guard-first\",\n    \"data-focus-guard\": true,\n    tabIndex: disabled ? -1 : 0,\n    style: hiddenGuard\n  }), hasPositiveIndices ? /*#__PURE__*/React.createElement(\"div\", {\n    key: \"guard-nearest\",\n    \"data-focus-guard\": true,\n    tabIndex: disabled ? -1 : 1,\n    style: hiddenGuard\n  }) : null], !disabled && /*#__PURE__*/React.createElement(SideCar, {\n    id: id,\n    sideCar: mediumSidecar,\n    observed: realObserved,\n    disabled: disabled,\n    persistentFocus: persistentFocus,\n    crossFrame: crossFrame,\n    autoFocus: autoFocus,\n    whiteList: whiteList,\n    shards: shards,\n    onActivation: onActivation,\n    onDeactivation: onDeactivation,\n    returnFocus: returnFocus,\n    focusOptions: focusOptions,\n    noFocusGuards: noFocusGuards\n  }), /*#__PURE__*/React.createElement(Container, _extends({\n    ref: mergedRef\n  }, lockProps, {\n    className: className,\n    onBlur: onBlur,\n    onFocus: onFocus\n  }), /*#__PURE__*/React.createElement(focusScope.Provider, {\n    value: focusScopeValue\n  }, children)), hasTailingGuards && /*#__PURE__*/React.createElement(\"div\", {\n    \"data-focus-guard\": true,\n    tabIndex: disabled ? -1 : 0,\n    style: hiddenGuard\n  }));\n});\nFocusLock.propTypes = process.env.NODE_ENV !== \"production\" ? {\n  children: node,\n  disabled: bool,\n  returnFocus: oneOfType([bool, object, func]),\n  focusOptions: object,\n  noFocusGuards: bool,\n  hasPositiveIndices: bool,\n  allowTextSelection: bool,\n  autoFocus: bool,\n  persistentFocus: bool,\n  crossFrame: bool,\n  group: string,\n  className: string,\n  whiteList: func,\n  shards: arrayOf(any),\n  as: oneOfType([string, func, object]),\n  lockProps: object,\n  onActivation: func,\n  onDeactivation: func,\n  sideCar: any.isRequired\n} : {};\nexport default FocusLock;","function _setPrototypeOf(t, e) {\n  return _setPrototypeOf = Object.setPrototypeOf ? Object.setPrototypeOf.bind() : function (t, e) {\n    return t.__proto__ = e, t;\n  }, _setPrototypeOf(t, e);\n}\nexport { _setPrototypeOf as default };","import setPrototypeOf from \"./setPrototypeOf.js\";\nfunction _inheritsLoose(t, o) {\n  t.prototype = Object.create(o.prototype), t.prototype.constructor = t, setPrototypeOf(t, o);\n}\nexport { _inheritsLoose as default };","function _typeof(o) {\n  \"@babel/helpers - typeof\";\n\n  return _typeof = \"function\" == typeof Symbol && \"symbol\" == typeof Symbol.iterator ? function (o) {\n    return typeof o;\n  } : function (o) {\n    return o && \"function\" == typeof Symbol && o.constructor === Symbol && o !== Symbol.prototype ? \"symbol\" : typeof o;\n  }, _typeof(o);\n}\nexport { _typeof as default };","import _typeof from \"./typeof.js\";\nfunction toPrimitive(t, r) {\n  if (\"object\" != _typeof(t) || !t) return t;\n  var e = t[Symbol.toPrimitive];\n  if (void 0 !== e) {\n    var i = e.call(t, r || \"default\");\n    if (\"object\" != _typeof(i)) return i;\n    throw new TypeError(\"@@toPrimitive must return a primitive value.\");\n  }\n  return (\"string\" === r ? String : Number)(t);\n}\nexport { toPrimitive as default };","import _typeof from \"./typeof.js\";\nimport toPrimitive from \"./toPrimitive.js\";\nfunction toPropertyKey(t) {\n  var i = toPrimitive(t, \"string\");\n  return \"symbol\" == _typeof(i) ? i : i + \"\";\n}\nexport { toPropertyKey as default };","import toPropertyKey from \"./toPropertyKey.js\";\nfunction _defineProperty(e, r, t) {\n  return (r = toPropertyKey(r)) in e ? Object.defineProperty(e, r, {\n    value: t,\n    enumerable: !0,\n    configurable: !0,\n    writable: !0\n  }) : e[r] = t, e;\n}\nexport { _defineProperty as default };","import _inheritsLoose from '@babel/runtime/helpers/esm/inheritsLoose';\nimport _defineProperty from '@babel/runtime/helpers/esm/defineProperty';\nimport React, { PureComponent } from 'react';\n\nfunction withSideEffect(reducePropsToState, handleStateChangeOnClient) {\n  if (process.env.NODE_ENV !== \"production\") {\n    if (typeof reducePropsToState !== 'function') {\n      throw new Error('Expected reducePropsToState to be a function.');\n    }\n\n    if (typeof handleStateChangeOnClient !== 'function') {\n      throw new Error('Expected handleStateChangeOnClient to be a function.');\n    }\n  }\n\n  function getDisplayName(WrappedComponent) {\n    return WrappedComponent.displayName || WrappedComponent.name || 'Component';\n  }\n\n  return function wrap(WrappedComponent) {\n    if (process.env.NODE_ENV !== \"production\") {\n      if (typeof WrappedComponent !== 'function') {\n        throw new Error('Expected WrappedComponent to be a React component.');\n      }\n    }\n\n    var mountedInstances = [];\n    var state;\n\n    function emitChange() {\n      state = reducePropsToState(mountedInstances.map(function (instance) {\n        return instance.props;\n      }));\n      handleStateChangeOnClient(state);\n    }\n\n    var SideEffect = /*#__PURE__*/function (_PureComponent) {\n      _inheritsLoose(SideEffect, _PureComponent);\n\n      function SideEffect() {\n        return _PureComponent.apply(this, arguments) || this;\n      }\n\n      // Try to use displayName of wrapped component\n      SideEffect.peek = function peek() {\n        return state;\n      };\n\n      var _proto = SideEffect.prototype;\n\n      _proto.componentDidMount = function componentDidMount() {\n        mountedInstances.push(this);\n        emitChange();\n      };\n\n      _proto.componentDidUpdate = function componentDidUpdate() {\n        emitChange();\n      };\n\n      _proto.componentWillUnmount = function componentWillUnmount() {\n        var index = mountedInstances.indexOf(this);\n        mountedInstances.splice(index, 1);\n        emitChange();\n      };\n\n      _proto.render = function render() {\n        return /*#__PURE__*/React.createElement(WrappedComponent, this.props);\n      };\n\n      return SideEffect;\n    }(PureComponent);\n\n    _defineProperty(SideEffect, \"displayName\", \"SideEffect(\" + getDisplayName(WrappedComponent) + \")\");\n\n    return SideEffect;\n  };\n}\n\nexport default withSideEffect;\n","/*\nIE11 support\n */\nexport var toArray = function (a) {\n    var ret = Array(a.length);\n    for (var i = 0; i < a.length; ++i) {\n        ret[i] = a[i];\n    }\n    return ret;\n};\nexport var asArray = function (a) { return (Array.isArray(a) ? a : [a]); };\nexport var getFirst = function (a) { return (Array.isArray(a) ? a[0] : a); };\n","import { FOCUS_NO_AUTOFOCUS } from '../constants';\nvar isElementHidden = function (node) {\n    // we can measure only \"elements\"\n    // consider others as \"visible\"\n    if (node.nodeType !== Node.ELEMENT_NODE) {\n        return false;\n    }\n    var computedStyle = window.getComputedStyle(node, null);\n    if (!computedStyle || !computedStyle.getPropertyValue) {\n        return false;\n    }\n    return (computedStyle.getPropertyValue('display') === 'none' || computedStyle.getPropertyValue('visibility') === 'hidden');\n};\nvar getParentNode = function (node) {\n    // DOCUMENT_FRAGMENT_NODE can also point on ShadowRoot. In this case .host will point on the next node\n    return node.parentNode && node.parentNode.nodeType === Node.DOCUMENT_FRAGMENT_NODE\n        ? // eslint-disable-next-line @typescript-eslint/no-explicit-any\n            node.parentNode.host\n        : node.parentNode;\n};\nvar isTopNode = function (node) {\n    // @ts-ignore\n    return node === document || (node && node.nodeType === Node.DOCUMENT_NODE);\n};\nvar isInert = function (node) { return node.hasAttribute('inert'); };\n/**\n * @see https://github.com/testing-library/jest-dom/blob/main/src/to-be-visible.js\n */\nvar isVisibleUncached = function (node, checkParent) {\n    return !node || isTopNode(node) || (!isElementHidden(node) && !isInert(node) && checkParent(getParentNode(node)));\n};\nexport var isVisibleCached = function (visibilityCache, node) {\n    var cached = visibilityCache.get(node);\n    if (cached !== undefined) {\n        return cached;\n    }\n    var result = isVisibleUncached(node, isVisibleCached.bind(undefined, visibilityCache));\n    visibilityCache.set(node, result);\n    return result;\n};\nvar isAutoFocusAllowedUncached = function (node, checkParent) {\n    return node && !isTopNode(node) ? (isAutoFocusAllowed(node) ? checkParent(getParentNode(node)) : false) : true;\n};\nexport var isAutoFocusAllowedCached = function (cache, node) {\n    var cached = cache.get(node);\n    if (cached !== undefined) {\n        return cached;\n    }\n    var result = isAutoFocusAllowedUncached(node, isAutoFocusAllowedCached.bind(undefined, cache));\n    cache.set(node, result);\n    return result;\n};\nexport var getDataset = function (node) {\n    // @ts-ignore\n    return node.dataset;\n};\nexport var isHTMLButtonElement = function (node) { return node.tagName === 'BUTTON'; };\nexport var isHTMLInputElement = function (node) { return node.tagName === 'INPUT'; };\nexport var isRadioElement = function (node) {\n    return isHTMLInputElement(node) && node.type === 'radio';\n};\nexport var notHiddenInput = function (node) {\n    return !((isHTMLInputElement(node) || isHTMLButtonElement(node)) && (node.type === 'hidden' || node.disabled));\n};\nexport var isAutoFocusAllowed = function (node) {\n    var attribute = node.getAttribute(FOCUS_NO_AUTOFOCUS);\n    return ![true, 'true', ''].includes(attribute);\n};\nexport var isGuard = function (node) { var _a; return Boolean(node && ((_a = getDataset(node)) === null || _a === void 0 ? void 0 : _a.focusGuard)); };\nexport var isNotAGuard = function (node) { return !isGuard(node); };\nexport var isDefined = function (x) { return Boolean(x); };\n","import { toArray } from './array';\nexport var tabSort = function (a, b) {\n    var aTab = Math.max(0, a.tabIndex);\n    var bTab = Math.max(0, b.tabIndex);\n    var tabDiff = aTab - bTab;\n    var indexDiff = a.index - b.index;\n    if (tabDiff) {\n        if (!aTab) {\n            return 1;\n        }\n        if (!bTab) {\n            return -1;\n        }\n    }\n    return tabDiff || indexDiff;\n};\nvar getTabIndex = function (node) {\n    if (node.tabIndex < 0) {\n        // all \"focusable\" elements are already preselected\n        // but some might have implicit negative tabIndex\n        // return 0 for <audio without tabIndex attribute - it is \"tabbable\"\n        if (!node.hasAttribute('tabindex')) {\n            return 0;\n        }\n    }\n    return node.tabIndex;\n};\nexport var orderByTabIndex = function (nodes, filterNegative, keepGuards) {\n    return toArray(nodes)\n        .map(function (node, index) {\n        var tabIndex = getTabIndex(node);\n        return {\n            node: node,\n            index: index,\n            tabIndex: keepGuards && tabIndex === -1 ? ((node.dataset || {}).focusGuard ? 0 : -1) : tabIndex,\n        };\n    })\n        .filter(function (data) { return !filterNegative || data.tabIndex >= 0; })\n        .sort(tabSort);\n};\n","/**\n * list of the object to be considered as focusable\n */\nexport var tabbables = [\n    'button:enabled',\n    'select:enabled',\n    'textarea:enabled',\n    'input:enabled',\n    // elements with explicit roles will also use explicit tabindex\n    // '[role=\"button\"]',\n    'a[href]',\n    'area[href]',\n    'summary',\n    'iframe',\n    'object',\n    'embed',\n    'audio[controls]',\n    'video[controls]',\n    '[tabindex]',\n    '[contenteditable]',\n    '[autofocus]',\n];\n","import { FOCUS_AUTO } from '../constants';\nimport { toArray } from './array';\nimport { tabbables } from './tabbables';\nvar queryTabbables = tabbables.join(',');\nvar queryGuardTabbables = \"\".concat(queryTabbables, \", [data-focus-guard]\");\nvar getFocusablesWithShadowDom = function (parent, withGuards) {\n    return toArray((parent.shadowRoot || parent).children).reduce(function (acc, child) {\n        return acc.concat(child.matches(withGuards ? queryGuardTabbables : queryTabbables) ? [child] : [], getFocusablesWithShadowDom(child));\n    }, []);\n};\nvar getFocusablesWithIFrame = function (parent, withGuards) {\n    var _a;\n    // contentDocument of iframe will be null if current origin cannot access it\n    if (parent instanceof HTMLIFrameElement && ((_a = parent.contentDocument) === null || _a === void 0 ? void 0 : _a.body)) {\n        return getFocusables([parent.contentDocument.body], withGuards);\n    }\n    return [parent];\n};\nexport var getFocusables = function (parents, withGuards) {\n    return parents.reduce(function (acc, parent) {\n        var _a;\n        var focusableWithShadowDom = getFocusablesWithShadowDom(parent, withGuards);\n        var focusableWithIframes = (_a = []).concat.apply(_a, focusableWithShadowDom.map(function (node) { return getFocusablesWithIFrame(node, withGuards); }));\n        return acc.concat(\n        // add all tabbables inside and within shadow DOMs in DOM order\n        focusableWithIframes, \n        // add if node is tabbable itself\n        parent.parentNode\n            ? toArray(parent.parentNode.querySelectorAll(queryTabbables)).filter(function (node) { return node === parent; })\n            : []);\n    }, []);\n};\n/**\n * return a list of focusable nodes within an area marked as \"auto-focusable\"\n * @param parent\n */\nexport var getParentAutofocusables = function (parent) {\n    var parentFocus = parent.querySelectorAll(\"[\".concat(FOCUS_AUTO, \"]\"));\n    return toArray(parentFocus)\n        .map(function (node) { return getFocusables([node]); })\n        .reduce(function (acc, nodes) { return acc.concat(nodes); }, []);\n};\n","import { toArray } from './array';\nimport { isAutoFocusAllowedCached, isVisibleCached, notHiddenInput } from './is';\nimport { orderByTabIndex } from './tabOrder';\nimport { getFocusables, getParentAutofocusables } from './tabUtils';\n/**\n * given list of focusable elements keeps the ones user can interact with\n * @param nodes\n * @param visibilityCache\n */\nexport var filterFocusable = function (nodes, visibilityCache) {\n    return toArray(nodes)\n        .filter(function (node) { return isVisibleCached(visibilityCache, node); })\n        .filter(function (node) { return notHiddenInput(node); });\n};\nexport var filterAutoFocusable = function (nodes, cache) {\n    if (cache === void 0) { cache = new Map(); }\n    return toArray(nodes).filter(function (node) { return isAutoFocusAllowedCached(cache, node); });\n};\n/**\n * !__WARNING__! Low level API.\n * @returns all tabbable nodes\n *\n * @see {@link getFocusableNodes} to get any focusable element\n *\n * @param topNodes - array of top level HTMLElements to search inside\n * @param visibilityCache - an cache to store intermediate measurements. Expected to be a fresh `new Map` on every call\n */\nexport var getTabbableNodes = function (topNodes, visibilityCache, withGuards) {\n    return orderByTabIndex(filterFocusable(getFocusables(topNodes, withGuards), visibilityCache), true, withGuards);\n};\n/**\n * !__WARNING__! Low level API.\n *\n * @returns anything \"focusable\", not only tabbable. The difference is in `tabIndex=-1`\n * (without guards, as long as they are not expected to be ever focused)\n *\n * @see {@link getTabbableNodes} to get only tabble nodes element\n *\n * @param topNodes - array of top level HTMLElements to search inside\n * @param visibilityCache - an cache to store intermediate measurements. Expected to be a fresh `new Map` on every call\n */\nexport var getFocusableNodes = function (topNodes, visibilityCache) {\n    return orderByTabIndex(filterFocusable(getFocusables(topNodes), visibilityCache), false);\n};\n/**\n * return list of nodes which are expected to be auto-focused\n * @param topNode\n * @param visibilityCache\n */\nexport var parentAutofocusables = function (topNode, visibilityCache) {\n    return filterFocusable(getParentAutofocusables(topNode), visibilityCache);\n};\n/*\n * Determines if element is contained in scope, including nested shadow DOMs\n */\nexport var contains = function (scope, element) {\n    if (scope.shadowRoot) {\n        return contains(scope.shadowRoot, element);\n    }\n    else {\n        if (Object.getPrototypeOf(scope).contains !== undefined &&\n            Object.getPrototypeOf(scope).contains.call(scope, element)) {\n            return true;\n        }\n        return toArray(scope.children).some(function (child) {\n            var _a;\n            if (child instanceof HTMLIFrameElement) {\n                var iframeBody = (_a = child.contentDocument) === null || _a === void 0 ? void 0 : _a.body;\n                if (iframeBody) {\n                    return contains(iframeBody, element);\n                }\n                return false;\n            }\n            return contains(child, element);\n        });\n    }\n};\n","import { FOCUS_DISABLED, FOCUS_GROUP } from '../constants';\nimport { asArray, toArray } from './array';\n/**\n * in case of multiple nodes nested inside each other\n * keeps only top ones\n * this is O(nlogn)\n * @param nodes\n * @returns {*}\n */\nvar filterNested = function (nodes) {\n    var contained = new Set();\n    var l = nodes.length;\n    for (var i = 0; i < l; i += 1) {\n        for (var j = i + 1; j < l; j += 1) {\n            var position = nodes[i].compareDocumentPosition(nodes[j]);\n            /* eslint-disable no-bitwise */\n            if ((position & Node.DOCUMENT_POSITION_CONTAINED_BY) > 0) {\n                contained.add(j);\n            }\n            if ((position & Node.DOCUMENT_POSITION_CONTAINS) > 0) {\n                contained.add(i);\n            }\n            /* eslint-enable */\n        }\n    }\n    return nodes.filter(function (_, index) { return !contained.has(index); });\n};\n/**\n * finds top most parent for a node\n * @param node\n * @returns {*}\n */\nvar getTopParent = function (node) {\n    return node.parentNode ? getTopParent(node.parentNode) : node;\n};\n/**\n * returns all \"focus containers\" inside a given node\n * @param node - node or nodes to look inside\n * @returns Element[]\n */\nexport var getAllAffectedNodes = function (node) {\n    var nodes = asArray(node);\n    return nodes.filter(Boolean).reduce(function (acc, currentNode) {\n        var group = currentNode.getAttribute(FOCUS_GROUP);\n        acc.push.apply(acc, (group\n            ? filterNested(toArray(getTopParent(currentNode).querySelectorAll(\"[\".concat(FOCUS_GROUP, \"=\\\"\").concat(group, \"\\\"]:not([\").concat(FOCUS_DISABLED, \"=\\\"disabled\\\"])\"))))\n            : [currentNode]));\n        return acc;\n    }, []);\n};\n","export var safeProbe = function (cb) {\n    try {\n        return cb();\n    }\n    catch (e) {\n        return undefined;\n    }\n};\n","/**\n * returns active element from document or from nested shadowdoms\n */\nimport { safeProbe } from './safe';\n/**\n * returns current active element. If the active element is a \"container\" itself(shadowRoot or iframe) returns active element inside it\n * @param [inDocument]\n */\nexport var getActiveElement = function (inDocument) {\n    if (inDocument === void 0) { inDocument = document; }\n    if (!inDocument || !inDocument.activeElement) {\n        return undefined;\n    }\n    var activeElement = inDocument.activeElement;\n    return (activeElement.shadowRoot\n        ? getActiveElement(activeElement.shadowRoot)\n        : activeElement instanceof HTMLIFrameElement && safeProbe(function () { return activeElement.contentWindow.document; })\n            ? getActiveElement(activeElement.contentWindow.document)\n            : activeElement);\n};\n","import { contains } from './utils/DOMutils';\nimport { getAllAffectedNodes } from './utils/all-affected';\nimport { getFirst, toArray } from './utils/array';\nimport { getActiveElement } from './utils/getActiveElement';\nvar focusInFrame = function (frame, activeElement) { return frame === activeElement; };\nvar focusInsideIframe = function (topNode, activeElement) {\n    return Boolean(toArray(topNode.querySelectorAll('iframe')).some(function (node) { return focusInFrame(node, activeElement); }));\n};\n/**\n * @returns {Boolean} true, if the current focus is inside given node or nodes.\n * Supports nodes hidden inside shadowDom\n */\nexport var focusInside = function (topNode, activeElement) {\n    // const activeElement = document && getActiveElement();\n    if (activeElement === void 0) { activeElement = getActiveElement(getFirst(topNode).ownerDocument); }\n    if (!activeElement || (activeElement.dataset && activeElement.dataset.focusGuard)) {\n        return false;\n    }\n    return getAllAffectedNodes(topNode).some(function (node) {\n        return contains(node, activeElement) || focusInsideIframe(node, activeElement);\n    });\n};\n","import { FOCUS_ALLOW } from './constants';\nimport { contains } from './utils/DOMutils';\nimport { toArray } from './utils/array';\nimport { getActiveElement } from './utils/getActiveElement';\n/**\n * checks if focus is hidden FROM the focus-lock\n * ie contained inside a node focus-lock shall ignore\n *\n * This is a utility function coupled with {@link FOCUS_ALLOW} constant\n *\n * @returns {boolean} focus is currently is in \"allow\" area\n */\nexport var focusIsHidden = function (inDocument) {\n    if (inDocument === void 0) { inDocument = document; }\n    var activeElement = getActiveElement(inDocument);\n    if (!activeElement) {\n        return false;\n    }\n    // this does not support setting FOCUS_ALLOW within shadow dom\n    return toArray(inDocument.querySelectorAll(\"[\".concat(FOCUS_ALLOW, \"]\"))).some(function (node) { return contains(node, activeElement); });\n};\n","import { isRadioElement } from './is';\nvar findSelectedRadio = function (node, nodes) {\n    return nodes\n        .filter(isRadioElement)\n        .filter(function (el) { return el.name === node.name; })\n        .filter(function (el) { return el.checked; })[0] || node;\n};\nexport var correctNode = function (node, nodes) {\n    if (isRadioElement(node) && node.name) {\n        return findSelectedRadio(node, nodes);\n    }\n    return node;\n};\n/**\n * giving a set of radio inputs keeps only selected (tabbable) ones\n * @param nodes\n */\nexport var correctNodes = function (nodes) {\n    // IE11 has no Set(array) constructor\n    var resultSet = new Set();\n    nodes.forEach(function (node) { return resultSet.add(correctNode(node, nodes)); });\n    // using filter to support IE11\n    return nodes.filter(function (node) { return resultSet.has(node); });\n};\n","import { correctNode } from './correctFocus';\nexport var pickFirstFocus = function (nodes) {\n    if (nodes[0] && nodes.length > 1) {\n        return correctNode(nodes[0], nodes);\n    }\n    return nodes[0];\n};\nexport var pickFocusable = function (nodes, node) {\n    return nodes.indexOf(correctNode(node, nodes));\n};\n","import { correctNodes } from './utils/correctFocus';\nimport { pickFocusable } from './utils/firstFocus';\nimport { isGuard } from './utils/is';\nexport var NEW_FOCUS = 'NEW_FOCUS';\n/**\n * Main solver for the \"find next focus\" question\n * @param innerNodes - used to control \"return focus\"\n * @param innerTabbables - used to control \"autofocus\"\n * @param outerNodes\n * @param activeElement\n * @param lastNode\n * @returns {number|string|undefined|*}\n */\nexport var newFocus = function (innerNodes, innerTabbables, outerNodes, activeElement, lastNode) {\n    var cnt = innerNodes.length;\n    var firstFocus = innerNodes[0];\n    var lastFocus = innerNodes[cnt - 1];\n    var isOnGuard = isGuard(activeElement);\n    // focus is inside\n    if (activeElement && innerNodes.indexOf(activeElement) >= 0) {\n        return undefined;\n    }\n    var activeIndex = activeElement !== undefined ? outerNodes.indexOf(activeElement) : -1;\n    var lastIndex = lastNode ? outerNodes.indexOf(lastNode) : activeIndex;\n    var lastNodeInside = lastNode ? innerNodes.indexOf(lastNode) : -1;\n    // no active focus (or focus is on the body)\n    if (activeIndex === -1) {\n        // known fallback\n        if (lastNodeInside !== -1) {\n            return lastNodeInside;\n        }\n        return NEW_FOCUS;\n    }\n    // new focus, nothing to calculate\n    if (lastNodeInside === -1) {\n        return NEW_FOCUS;\n    }\n    var indexDiff = activeIndex - lastIndex;\n    var firstNodeIndex = outerNodes.indexOf(firstFocus);\n    var lastNodeIndex = outerNodes.indexOf(lastFocus);\n    var correctedNodes = correctNodes(outerNodes);\n    var currentFocusableIndex = activeElement !== undefined ? correctedNodes.indexOf(activeElement) : -1;\n    var previousFocusableIndex = lastNode ? correctedNodes.indexOf(lastNode) : currentFocusableIndex;\n    var tabbableNodes = correctedNodes.filter(function (node) { return node.tabIndex >= 0; });\n    var currentTabbableIndex = activeElement !== undefined ? tabbableNodes.indexOf(activeElement) : -1;\n    var previousTabbableIndex = lastNode ? tabbableNodes.indexOf(lastNode) : currentTabbableIndex;\n    var focusIndexDiff = currentTabbableIndex >= 0 && previousTabbableIndex >= 0\n        ? // old/new are tabbables, measure distance in tabbable space\n            previousTabbableIndex - currentTabbableIndex\n        : // or else measure in focusable space\n            previousFocusableIndex - currentFocusableIndex;\n    // old focus\n    if (!indexDiff && lastNodeInside >= 0) {\n        return lastNodeInside;\n    }\n    // no tabbable elements, autofocus is not possible\n    if (innerTabbables.length === 0) {\n        // an edge case with no tabbable elements\n        // return the last focusable one\n        // with some probability this will prevent focus from cycling across the lock, but there is no tabbale elements to cycle to\n        return lastNodeInside;\n    }\n    var returnFirstNode = pickFocusable(innerNodes, innerTabbables[0]);\n    var returnLastNode = pickFocusable(innerNodes, innerTabbables[innerTabbables.length - 1]);\n    // first element\n    if (activeIndex <= firstNodeIndex && isOnGuard && Math.abs(indexDiff) > 1) {\n        return returnLastNode;\n    }\n    // last element\n    if (activeIndex >= lastNodeIndex && isOnGuard && Math.abs(indexDiff) > 1) {\n        return returnFirstNode;\n    }\n    // jump out, but not on the guard\n    if (indexDiff && Math.abs(focusIndexDiff) > 1) {\n        return lastNodeInside;\n    }\n    // focus above lock\n    if (activeIndex <= firstNodeIndex) {\n        return returnLastNode;\n    }\n    // focus below lock\n    if (activeIndex > lastNodeIndex) {\n        return returnFirstNode;\n    }\n    // index is inside tab order, but outside Lock\n    if (indexDiff) {\n        if (Math.abs(indexDiff) > 1) {\n            return lastNodeInside;\n        }\n        return (cnt + lastNodeInside + indexDiff) % cnt;\n    }\n    // do nothing\n    return undefined;\n};\n","import { filterAutoFocusable } from './DOMutils';\nimport { pickFirstFocus } from './firstFocus';\nimport { getDataset } from './is';\nvar findAutoFocused = function (autoFocusables) {\n    return function (node) {\n        var _a;\n        var autofocus = (_a = getDataset(node)) === null || _a === void 0 ? void 0 : _a.autofocus;\n        return (\n        // @ts-expect-error\n        node.autofocus ||\n            //\n            (autofocus !== undefined && autofocus !== 'false') ||\n            //\n            autoFocusables.indexOf(node) >= 0);\n    };\n};\nexport var pickAutofocus = function (nodesIndexes, orderedNodes, groups) {\n    var nodes = nodesIndexes.map(function (_a) {\n        var node = _a.node;\n        return node;\n    });\n    var autoFocusable = filterAutoFocusable(nodes.filter(findAutoFocused(groups)));\n    if (autoFocusable && autoFocusable.length) {\n        return pickFirstFocus(autoFocusable);\n    }\n    return pickFirstFocus(filterAutoFocusable(orderedNodes));\n};\n","import { parentAutofocusables } from './DOMutils';\nimport { contains } from './DOMutils';\nimport { asArray } from './array';\nvar getParents = function (node, parents) {\n    if (parents === void 0) { parents = []; }\n    parents.push(node);\n    if (node.parentNode) {\n        getParents(node.parentNode.host || node.parentNode, parents);\n    }\n    return parents;\n};\n/**\n * finds a parent for both nodeA and nodeB\n * @param nodeA\n * @param nodeB\n * @returns {boolean|*}\n */\nexport var getCommonParent = function (nodeA, nodeB) {\n    var parentsA = getParents(nodeA);\n    var parentsB = getParents(nodeB);\n    // tslint:disable-next-line:prefer-for-of\n    for (var i = 0; i < parentsA.length; i += 1) {\n        var currentParent = parentsA[i];\n        if (parentsB.indexOf(currentParent) >= 0) {\n            return currentParent;\n        }\n    }\n    return false;\n};\nexport var getTopCommonParent = function (baseActiveElement, leftEntry, rightEntries) {\n    var activeElements = asArray(baseActiveElement);\n    var leftEntries = asArray(leftEntry);\n    var activeElement = activeElements[0];\n    var topCommon = false;\n    leftEntries.filter(Boolean).forEach(function (entry) {\n        topCommon = getCommonParent(topCommon || entry, entry) || topCommon;\n        rightEntries.filter(Boolean).forEach(function (subEntry) {\n            var common = getCommonParent(activeElement, subEntry);\n            if (common) {\n                if (!topCommon || contains(common, topCommon)) {\n                    topCommon = common;\n                }\n                else {\n                    topCommon = getCommonParent(common, topCommon);\n                }\n            }\n        });\n    });\n    // TODO: add assert here?\n    return topCommon;\n};\n/**\n * return list of nodes which are expected to be autofocused inside a given top nodes\n * @param entries\n * @param visibilityCache\n */\nexport var allParentAutofocusables = function (entries, visibilityCache) {\n    return entries.reduce(function (acc, node) { return acc.concat(parentAutofocusables(node, visibilityCache)); }, []);\n};\n","import { NEW_FOCUS, newFocus } from './solver';\nimport { getFocusableNodes } from './utils/DOMutils';\nimport { getAllAffectedNodes } from './utils/all-affected';\nimport { asArray, getFirst } from './utils/array';\nimport { pickAutofocus } from './utils/auto-focus';\nimport { getActiveElement } from './utils/getActiveElement';\nimport { isDefined, isNotAGuard } from './utils/is';\nimport { allParentAutofocusables, getTopCommonParent } from './utils/parenting';\nvar reorderNodes = function (srcNodes, dstNodes) {\n    var remap = new Map();\n    // no Set(dstNodes) for IE11 :(\n    dstNodes.forEach(function (entity) { return remap.set(entity.node, entity); });\n    // remap to dstNodes\n    return srcNodes.map(function (node) { return remap.get(node); }).filter(isDefined);\n};\n/**\n * contains the main logic of the `focus-lock` package.\n *\n * ! you probably dont need this function !\n *\n * given top node(s) and the last active element returns the element to be focused next\n * @returns element which should be focused to move focus inside\n * @param topNode\n * @param lastNode\n */\nexport var focusSolver = function (topNode, lastNode) {\n    var activeElement = getActiveElement(asArray(topNode).length > 0 ? document : getFirst(topNode).ownerDocument);\n    var entries = getAllAffectedNodes(topNode).filter(isNotAGuard);\n    var commonParent = getTopCommonParent(activeElement || topNode, topNode, entries);\n    var visibilityCache = new Map();\n    var anyFocusable = getFocusableNodes(entries, visibilityCache);\n    var innerElements = anyFocusable.filter(function (_a) {\n        var node = _a.node;\n        return isNotAGuard(node);\n    });\n    if (!innerElements[0]) {\n        return undefined;\n    }\n    var outerNodes = getFocusableNodes([commonParent], visibilityCache).map(function (_a) {\n        var node = _a.node;\n        return node;\n    });\n    var orderedInnerElements = reorderNodes(outerNodes, innerElements);\n    // collect inner focusable and separately tabbables\n    var innerFocusables = orderedInnerElements.map(function (_a) {\n        var node = _a.node;\n        return node;\n    });\n    var innerTabbable = orderedInnerElements.filter(function (_a) {\n        var tabIndex = _a.tabIndex;\n        return tabIndex >= 0;\n    }).map(function (_a) {\n        var node = _a.node;\n        return node;\n    });\n    var newId = newFocus(innerFocusables, innerTabbable, outerNodes, activeElement, lastNode);\n    if (newId === NEW_FOCUS) {\n        var focusNode = \n        // first try only tabbable, and the fallback to all focusable, as long as at least one element should be picked for focus\n        pickAutofocus(anyFocusable, innerTabbable, allParentAutofocusables(entries, visibilityCache)) ||\n            pickAutofocus(anyFocusable, innerFocusables, allParentAutofocusables(entries, visibilityCache));\n        if (focusNode) {\n            return { node: focusNode };\n        }\n        else {\n            console.warn('focus-lock: cannot find any node to move focus into');\n            return undefined;\n        }\n    }\n    if (newId === undefined) {\n        return newId;\n    }\n    return orderedInnerElements[newId];\n};\n","import { getAllAffectedNodes } from './utils/all-affected';\nimport { isGuard, isNotAGuard } from './utils/is';\nimport { getTopCommonParent } from './utils/parenting';\nimport { orderByTabIndex } from './utils/tabOrder';\nimport { getFocusables } from './utils/tabUtils';\n/**\n * traverses all related nodes (including groups) returning a list of all nodes(outer and internal) with meta information\n * This is low-level API!\n * @returns list of focusable elements inside a given top(!) node.\n * @see {@link getFocusableNodes} providing a simpler API\n */\nexport var expandFocusableNodes = function (topNode) {\n    var entries = getAllAffectedNodes(topNode).filter(isNotAGuard);\n    var commonParent = getTopCommonParent(topNode, topNode, entries);\n    var outerNodes = orderByTabIndex(getFocusables([commonParent], true), true, true);\n    var innerElements = getFocusables(entries, false);\n    return outerNodes.map(function (_a) {\n        var node = _a.node, index = _a.index;\n        return ({\n            node: node,\n            index: index,\n            lockItem: innerElements.indexOf(node) >= 0,\n            guard: isGuard(node),\n        });\n    });\n};\n","export var focusOn = function (target, focusOptions) {\n    if (!target) {\n        // not clear how, but is possible https://github.com/theKashey/focus-lock/issues/53\n        return;\n    }\n    if ('focus' in target) {\n        target.focus(focusOptions);\n    }\n    if ('contentWindow' in target && target.contentWindow) {\n        target.contentWindow.focus();\n    }\n};\n","import { focusOn } from './commands';\nimport { focusSolver } from './focusSolver';\nvar guardCount = 0;\nvar lockDisabled = false;\n/**\n * The main functionality of the focus-lock package\n *\n * Contains focus at a given node.\n * The last focused element will help to determine which element(first or last) should be focused.\n * The found element will be focused.\n *\n * This is one time action (move), not a persistent focus-lock\n *\n * HTML markers (see {@link import('./constants').FOCUS_AUTO} constants) can control autofocus\n * @see {@link focusSolver} for the same functionality without autofocus\n */\nexport var moveFocusInside = function (topNode, lastNode, options) {\n    if (options === void 0) { options = {}; }\n    var focusable = focusSolver(topNode, lastNode);\n    // global local side effect to countain recursive lock activation and resolve focus-fighting\n    if (lockDisabled) {\n        return;\n    }\n    if (focusable) {\n        /** +FOCUS-FIGHTING prevention **/\n        if (guardCount > 2) {\n            // we have recursive entered back the lock activation\n            console.error('FocusLock: focus-fighting detected. Only one focus management system could be active. ' +\n                'See https://github.com/theKashey/focus-lock/#focus-fighting');\n            lockDisabled = true;\n            setTimeout(function () {\n                lockDisabled = false;\n            }, 1);\n            return;\n        }\n        guardCount++;\n        focusOn(focusable.node, options.focusOptions);\n        guardCount--;\n    }\n};\n","import { getTabbableNodes } from './utils/DOMutils';\nfunction weakRef(value) {\n    if (!value)\n        return null;\n    // #68 Safari 14.1 dont have it yet\n    // FIXME: remove in 2025\n    if (typeof WeakRef === 'undefined') {\n        return function () { return value || null; };\n    }\n    var w = value ? new WeakRef(value) : null;\n    return function () { return (w === null || w === void 0 ? void 0 : w.deref()) || null; };\n}\nexport var recordElementLocation = function (element) {\n    if (!element) {\n        return null;\n    }\n    var stack = [];\n    var currentElement = element;\n    while (currentElement && currentElement !== document.body) {\n        stack.push({\n            current: weakRef(currentElement),\n            parent: weakRef(currentElement.parentElement),\n            left: weakRef(currentElement.previousElementSibling),\n            right: weakRef(currentElement.nextElementSibling),\n        });\n        currentElement = currentElement.parentElement;\n    }\n    return {\n        element: weakRef(element),\n        stack: stack,\n        ownerDocument: element.ownerDocument,\n    };\n};\nvar restoreFocusTo = function (location) {\n    var _a, _b, _c, _d, _e;\n    if (!location) {\n        return undefined;\n    }\n    var stack = location.stack, ownerDocument = location.ownerDocument;\n    var visibilityCache = new Map();\n    for (var _i = 0, stack_1 = stack; _i < stack_1.length; _i++) {\n        var line = stack_1[_i];\n        var parent_1 = (_a = line.parent) === null || _a === void 0 ? void 0 : _a.call(line);\n        // is it still here?\n        if (parent_1 && ownerDocument.contains(parent_1)) {\n            var left = (_b = line.left) === null || _b === void 0 ? void 0 : _b.call(line);\n            var savedCurrent = line.current();\n            var current = parent_1.contains(savedCurrent) ? savedCurrent : undefined;\n            var right = (_c = line.right) === null || _c === void 0 ? void 0 : _c.call(line);\n            var focusables = getTabbableNodes([parent_1], visibilityCache);\n            var aim = \n            // that is element itself\n            (_e = (_d = current !== null && current !== void 0 ? current : \n            // or something in it's place\n            left === null || left === void 0 ? void 0 : left.nextElementSibling) !== null && _d !== void 0 ? _d : \n            // or somebody to the right, still close enough\n            right) !== null && _e !== void 0 ? _e : \n            // or somebody to the left, something?\n            left;\n            while (aim) {\n                for (var _f = 0, focusables_1 = focusables; _f < focusables_1.length; _f++) {\n                    var focusable = focusables_1[_f];\n                    if (aim === null || aim === void 0 ? void 0 : aim.contains(focusable.node)) {\n                        return focusable.node;\n                    }\n                }\n                aim = aim.nextElementSibling;\n            }\n            if (focusables.length) {\n                // if parent contains a focusable - move there\n                return focusables[0].node;\n            }\n        }\n    }\n    // nothing matched\n    return undefined;\n};\n/**\n * Captures the current focused element to restore focus as close as possible in the future\n * Handles situations where the focused element is removed from the DOM or no longer focusable\n * moving focus to the closest focusable element\n * @param targetElement - element where focus should be restored\n * @returns a function returning a new element to focus\n */\nexport var captureFocusRestore = function (targetElement) {\n    var location = recordElementLocation(targetElement);\n    return function () {\n        return restoreFocusTo(location);\n    };\n};\n","import { focusOn } from './commands';\nimport { getTabbableNodes, contains, getFocusableNodes } from './utils/DOMutils';\nimport { asArray } from './utils/array';\n/**\n * for a given `element` in a given `scope` returns focusable siblings\n * @param element - base element\n * @param scope - common parent. Can be document, but better to narrow it down for performance reasons\n * @returns {prev,next} - references to a focusable element before and after\n * @returns undefined - if operation is not applicable\n */\nexport var getRelativeFocusable = function (element, scope, useTabbables) {\n    if (!element || !scope) {\n        console.error('no element or scope given');\n        return {};\n    }\n    var shards = asArray(scope);\n    if (shards.every(function (shard) { return !contains(shard, element); })) {\n        console.error('Active element is not contained in the scope');\n        return {};\n    }\n    var focusables = useTabbables\n        ? getTabbableNodes(shards, new Map())\n        : getFocusableNodes(shards, new Map());\n    var current = focusables.findIndex(function (_a) {\n        var node = _a.node;\n        return node === element;\n    });\n    if (current === -1) {\n        // an edge case, when anchor element is not found\n        return undefined;\n    }\n    return {\n        prev: focusables[current - 1],\n        next: focusables[current + 1],\n        first: focusables[0],\n        last: focusables[focusables.length - 1],\n    };\n};\nvar getBoundary = function (shards, useTabbables) {\n    var set = useTabbables\n        ? getTabbableNodes(asArray(shards), new Map())\n        : getFocusableNodes(asArray(shards), new Map());\n    return {\n        first: set[0],\n        last: set[set.length - 1],\n    };\n};\nvar defaultOptions = function (options) {\n    return Object.assign({\n        scope: document.body,\n        cycle: true,\n        onlyTabbable: true,\n    }, options);\n};\nvar moveFocus = function (fromElement, options, cb) {\n    if (options === void 0) { options = {}; }\n    var newOptions = defaultOptions(options);\n    var solution = getRelativeFocusable(fromElement, newOptions.scope, newOptions.onlyTabbable);\n    if (!solution) {\n        return;\n    }\n    var target = cb(solution, newOptions.cycle);\n    if (target) {\n        focusOn(target.node, newOptions.focusOptions);\n    }\n};\n/**\n * focuses next element in the tab-order\n * @param fromElement - common parent to scope active element search or tab cycle order\n * @param {FocusNextOptions} [options] - focus options\n */\nexport var focusNextElement = function (fromElement, options) {\n    if (options === void 0) { options = {}; }\n    moveFocus(fromElement, options, function (_a, cycle) {\n        var next = _a.next, first = _a.first;\n        return next || (cycle && first);\n    });\n};\n/**\n * focuses prev element in the tab order\n * @param fromElement - common parent to scope active element search or tab cycle order\n * @param {FocusNextOptions} [options] - focus options\n */\nexport var focusPrevElement = function (fromElement, options) {\n    if (options === void 0) { options = {}; }\n    moveFocus(fromElement, options, function (_a, cycle) {\n        var prev = _a.prev, last = _a.last;\n        return prev || (cycle && last);\n    });\n};\nvar pickBoundary = function (scope, options, what) {\n    var _a;\n    var boundary = getBoundary(scope, (_a = options.onlyTabbable) !== null && _a !== void 0 ? _a : true);\n    var node = boundary[what];\n    if (node) {\n        focusOn(node.node, options.focusOptions);\n    }\n};\n/**\n * focuses first element in the tab-order\n * @param {FocusNextOptions} options - focus options\n */\nexport var focusFirstElement = function (scope, options) {\n    if (options === void 0) { options = {}; }\n    pickBoundary(scope, options, 'first');\n};\n/**\n * focuses last element in the tab order\n * @param {FocusNextOptions} options - focus options\n */\nexport var focusLastElement = function (scope, options) {\n    if (options === void 0) { options = {}; }\n    pickBoundary(scope, options, 'last');\n};\n","export function deferAction(action) {\n  setTimeout(action, 1);\n}\nexport var inlineProp = function inlineProp(name, value) {\n  var obj = {};\n  obj[name] = value;\n  return obj;\n};\nexport var extractRef = function extractRef(ref) {\n  return ref && 'current' in ref ? ref.current : ref;\n};","import React from 'react';\nimport PropTypes from 'prop-types';\nimport withSideEffect from 'react-clientside-effect';\nimport { moveFocusInside, focusInside, focusIsHidden, expandFocusableNodes, getFocusableNodes, focusNextElement, focusPrevElement, focusFirstElement, focusLastElement, captureFocusRestore } from 'focus-lock';\nimport { deferAction, extractRef } from './util';\nimport { mediumFocus, mediumBlur, mediumEffect } from './medium';\nvar focusOnBody = function focusOnBody() {\n  return document && document.activeElement === document.body;\n};\nvar isFreeFocus = function isFreeFocus() {\n  return focusOnBody() || focusIsHidden();\n};\nvar lastActiveTrap = null;\nvar lastActiveFocus = null;\nvar tryRestoreFocus = function tryRestoreFocus() {\n  return null;\n};\nvar lastPortaledElement = null;\nvar focusWasOutsideWindow = false;\nvar windowFocused = false;\nvar defaultWhitelist = function defaultWhitelist() {\n  return true;\n};\nvar focusWhitelisted = function focusWhitelisted(activeElement) {\n  return (lastActiveTrap.whiteList || defaultWhitelist)(activeElement);\n};\nvar recordPortal = function recordPortal(observerNode, portaledElement) {\n  lastPortaledElement = {\n    observerNode: observerNode,\n    portaledElement: portaledElement\n  };\n};\nvar focusIsPortaledPair = function focusIsPortaledPair(element) {\n  return lastPortaledElement && lastPortaledElement.portaledElement === element;\n};\nfunction autoGuard(startIndex, end, step, allNodes) {\n  var lastGuard = null;\n  var i = startIndex;\n  do {\n    var item = allNodes[i];\n    if (item.guard) {\n      if (item.node.dataset.focusAutoGuard) {\n        lastGuard = item;\n      }\n    } else if (item.lockItem) {\n      if (i !== startIndex) {\n        return;\n      }\n      lastGuard = null;\n    } else {\n      break;\n    }\n  } while ((i += step) !== end);\n  if (lastGuard) {\n    lastGuard.node.tabIndex = 0;\n  }\n}\nvar focusWasOutside = function focusWasOutside(crossFrameOption) {\n  if (crossFrameOption) {\n    return Boolean(focusWasOutsideWindow);\n  }\n  return focusWasOutsideWindow === 'meanwhile';\n};\nvar checkInHost = function checkInHost(check, el, boundary) {\n  return el && (el.host === check && (!el.activeElement || boundary.contains(el.activeElement)) || el.parentNode && checkInHost(check, el.parentNode, boundary));\n};\nvar withinHost = function withinHost(activeElement, workingArea) {\n  return workingArea.some(function (area) {\n    return checkInHost(activeElement, area, area);\n  });\n};\nvar getNodeFocusables = function getNodeFocusables(nodes) {\n  return getFocusableNodes(nodes, new Map());\n};\nvar isNotFocusable = function isNotFocusable(node) {\n  return !getNodeFocusables([node.parentNode]).some(function (el) {\n    return el.node === node;\n  });\n};\nvar activateTrap = function activateTrap() {\n  var result = false;\n  if (lastActiveTrap) {\n    var _lastActiveTrap = lastActiveTrap,\n      observed = _lastActiveTrap.observed,\n      persistentFocus = _lastActiveTrap.persistentFocus,\n      autoFocus = _lastActiveTrap.autoFocus,\n      shards = _lastActiveTrap.shards,\n      crossFrame = _lastActiveTrap.crossFrame,\n      focusOptions = _lastActiveTrap.focusOptions,\n      noFocusGuards = _lastActiveTrap.noFocusGuards;\n    var workingNode = observed || lastPortaledElement && lastPortaledElement.portaledElement;\n    if (focusOnBody() && lastActiveFocus && lastActiveFocus !== document.body) {\n      if (!document.body.contains(lastActiveFocus) || isNotFocusable(lastActiveFocus)) {\n        var newTarget = tryRestoreFocus();\n        if (newTarget) {\n          newTarget.focus();\n        }\n      }\n    }\n    var activeElement = document && document.activeElement;\n    if (workingNode) {\n      var workingArea = [workingNode].concat(shards.map(extractRef).filter(Boolean));\n      var shouldForceRestoreFocus = function shouldForceRestoreFocus() {\n        if (!focusWasOutside(crossFrame) || !noFocusGuards || !lastActiveFocus || windowFocused) {\n          return false;\n        }\n        var nodes = getNodeFocusables(workingArea);\n        var lastIndex = nodes.findIndex(function (_ref) {\n          var node = _ref.node;\n          return node === lastActiveFocus;\n        });\n        return lastIndex === 0 || lastIndex === nodes.length - 1;\n      };\n      if (!activeElement || focusWhitelisted(activeElement)) {\n        if (persistentFocus || shouldForceRestoreFocus() || !isFreeFocus() || !lastActiveFocus && autoFocus) {\n          if (workingNode && !(focusInside(workingArea) || activeElement && withinHost(activeElement, workingArea) || focusIsPortaledPair(activeElement, workingNode))) {\n            if (document && !lastActiveFocus && activeElement && !autoFocus) {\n              if (activeElement.blur) {\n                activeElement.blur();\n              }\n              document.body.focus();\n            } else {\n              result = moveFocusInside(workingArea, lastActiveFocus, {\n                focusOptions: focusOptions\n              });\n              lastPortaledElement = {};\n            }\n          }\n          lastActiveFocus = document && document.activeElement;\n          if (lastActiveFocus !== document.body) {\n            tryRestoreFocus = captureFocusRestore(lastActiveFocus);\n          }\n          focusWasOutsideWindow = false;\n        }\n      }\n      if (document && activeElement !== document.activeElement && document.querySelector('[data-focus-auto-guard]')) {\n        var newActiveElement = document && document.activeElement;\n        var allNodes = expandFocusableNodes(workingArea);\n        var focusedIndex = allNodes.map(function (_ref2) {\n          var node = _ref2.node;\n          return node;\n        }).indexOf(newActiveElement);\n        if (focusedIndex > -1) {\n          allNodes.filter(function (_ref3) {\n            var guard = _ref3.guard,\n              node = _ref3.node;\n            return guard && node.dataset.focusAutoGuard;\n          }).forEach(function (_ref4) {\n            var node = _ref4.node;\n            return node.removeAttribute('tabIndex');\n          });\n          autoGuard(focusedIndex, allNodes.length, +1, allNodes);\n          autoGuard(focusedIndex, -1, -1, allNodes);\n        }\n      }\n    }\n  }\n  return result;\n};\nvar onTrap = function onTrap(event) {\n  if (activateTrap() && event) {\n    event.stopPropagation();\n    event.preventDefault();\n  }\n};\nvar onBlur = function onBlur() {\n  return deferAction(activateTrap);\n};\nvar onFocus = function onFocus(event) {\n  var source = event.target;\n  var currentNode = event.currentTarget;\n  if (!currentNode.contains(source)) {\n    recordPortal(currentNode, source);\n  }\n};\nvar FocusWatcher = function FocusWatcher() {\n  return null;\n};\nvar FocusTrap = function FocusTrap(_ref5) {\n  var children = _ref5.children;\n  return /*#__PURE__*/React.createElement(\"div\", {\n    onBlur: onBlur,\n    onFocus: onFocus\n  }, children);\n};\nFocusTrap.propTypes = process.env.NODE_ENV !== \"production\" ? {\n  children: PropTypes.node.isRequired\n} : {};\nvar onWindowFocus = function onWindowFocus() {\n  windowFocused = true;\n};\nvar onWindowBlur = function onWindowBlur() {\n  windowFocused = false;\n  focusWasOutsideWindow = 'just';\n  deferAction(function () {\n    focusWasOutsideWindow = 'meanwhile';\n  });\n};\nvar attachHandler = function attachHandler() {\n  document.addEventListener('focusin', onTrap);\n  document.addEventListener('focusout', onBlur);\n  window.addEventListener('focus', onWindowFocus);\n  window.addEventListener('blur', onWindowBlur);\n};\nvar detachHandler = function detachHandler() {\n  document.removeEventListener('focusin', onTrap);\n  document.removeEventListener('focusout', onBlur);\n  window.removeEventListener('focus', onWindowFocus);\n  window.removeEventListener('blur', onWindowBlur);\n};\nfunction reducePropsToState(propsList) {\n  return propsList.filter(function (_ref6) {\n    var disabled = _ref6.disabled;\n    return !disabled;\n  });\n}\nvar focusLockAPI = {\n  moveFocusInside: moveFocusInside,\n  focusInside: focusInside,\n  focusNextElement: focusNextElement,\n  focusPrevElement: focusPrevElement,\n  focusFirstElement: focusFirstElement,\n  focusLastElement: focusLastElement,\n  captureFocusRestore: captureFocusRestore\n};\nfunction handleStateChangeOnClient(traps) {\n  var trap = traps.slice(-1)[0];\n  if (trap && !lastActiveTrap) {\n    attachHandler();\n  }\n  var lastTrap = lastActiveTrap;\n  var sameTrap = lastTrap && trap && trap.id === lastTrap.id;\n  lastActiveTrap = trap;\n  if (lastTrap && !sameTrap) {\n    lastTrap.onDeactivation();\n    if (!traps.filter(function (_ref7) {\n      var id = _ref7.id;\n      return id === lastTrap.id;\n    }).length) {\n      lastTrap.returnFocus(!trap);\n    }\n  }\n  if (trap) {\n    lastActiveFocus = null;\n    if (!sameTrap || lastTrap.observed !== trap.observed) {\n      trap.onActivation(focusLockAPI);\n    }\n    activateTrap(true);\n    deferAction(activateTrap);\n  } else {\n    detachHandler();\n    lastActiveFocus = null;\n  }\n}\nmediumFocus.assignSyncMedium(onFocus);\nmediumBlur.assignMedium(onBlur);\nmediumEffect.assignMedium(function (cb) {\n  return cb(focusLockAPI);\n});\nexport default withSideEffect(reducePropsToState, handleStateChangeOnClient)(FocusWatcher);","import _objectWithoutPropertiesLoose from \"@babel/runtime/helpers/esm/objectWithoutPropertiesLoose\";\nimport _extends from \"@babel/runtime/helpers/esm/extends\";\nimport React, { forwardRef } from 'react';\nimport FocusLockUI from './Lock';\nimport FocusTrap from './Trap';\nvar FocusLockCombination = /*#__PURE__*/forwardRef(function FocusLockUICombination(props, ref) {\n  return /*#__PURE__*/React.createElement(FocusLockUI, _extends({\n    sideCar: FocusTrap,\n    ref: ref\n  }, props));\n});\nvar _ref = FocusLockUI.propTypes || {},\n  sideCar = _ref.sideCar,\n  propTypes = _objectWithoutPropertiesLoose(_ref, [\"sideCar\"]);\nFocusLockCombination.propTypes = process.env.NODE_ENV !== \"production\" ? propTypes : {};\nexport default FocusLockCombination;","// Simple localStorage-based weekly quota for free online games\n// 3 free online games per week per user (by username). Premium users are exempt.\n\nconst KEY = (user: string) => `ndn_online_quota_${user}`;\n\ntype Usage = {\n  week: string; // e.g., YYYY-WW\n  used: number;\n};\n\nfunction getWeekId(d = new Date()): string {\n  // ISO week-numbering year and week\n  const date = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));\n  // Thursday in current week decides the year\n  const dayNum = date.getUTCDay() || 7;\n  date.setUTCDate(date.getUTCDate() + 4 - dayNum);\n  const yearStart = new Date(Date.UTC(date.getUTCFullYear(), 0, 1));\n  const weekNo = Math.ceil(\n    ((date.getTime() - yearStart.getTime()) / 86400000 + 1) / 7,\n  );\n  const week = String(weekNo).padStart(2, \"0\");\n  return `${date.getUTCFullYear()}-${week}`;\n}\n\nexport function getOnlineUsage(user: string): Usage {\n  try {\n    const raw = localStorage.getItem(KEY(user));\n    if (!raw) return { week: getWeekId(), used: 0 };\n    const u = JSON.parse(raw);\n    const currentWeek = getWeekId();\n    if (!u.week || u.week !== currentWeek)\n      return { week: currentWeek, used: 0 };\n    return { week: String(u.week), used: Number(u.used) || 0 };\n  } catch {\n    return { week: getWeekId(), used: 0 };\n  }\n}\n\nexport function setOnlineUsage(user: string, usage: Usage) {\n  try {\n    localStorage.setItem(KEY(user), JSON.stringify(usage));\n  } catch {}\n}\n\nexport function incOnlineUsage(user: string, _cap = 3): Usage {\n  const currentWeek = getWeekId();\n  const u = getOnlineUsage(user);\n  const next: Usage = {\n    week: currentWeek,\n    used: (u.week === currentWeek ? u.used : 0) + 1,\n  };\n  // clamp to cap, though we still store the number\n  setOnlineUsage(user, next);\n  return next;\n}\n\nexport function getFreeRemaining(user: string, cap = 3): number {\n  const u = getOnlineUsage(user);\n  return Math.max(0, cap - (u.used || 0));\n}\n","import { useEffect, useState } from \"react\";\n\nconst LS_KEY = \"ndn:isAdmin:v1\";\n\ntype Cache = { [email: string]: { v: boolean; ts: number } };\n\nfunction getCache(): Cache {\n  try {\n    const raw = localStorage.getItem(LS_KEY);\n    return raw ? JSON.parse(raw) : {};\n  } catch {\n    return {};\n  }\n}\nfunction setCache(email: string, v: boolean) {\n  try {\n    const c = getCache();\n    c[(email || \"\").toLowerCase()] = { v, ts: Date.now() };\n    localStorage.setItem(LS_KEY, JSON.stringify(c));\n  } catch {}\n}\n\nexport async function fetchIsAdmin(email?: string | null): Promise<boolean> {\n  const e = String(email || \"\").toLowerCase();\n  if (!e) return false;\n  // Immediate fallbacks: owner env or local override (dev)\n  try {\n    const owner = String(\n      (import.meta as any)?.env?.VITE_OWNER_EMAIL || \"\",\n    ).toLowerCase();\n    if (owner && e === owner) return true;\n  } catch {}\n  // Hard fallback to known owner (repo default) if nothing else is set\n  if (e === \"daviesfamily108@gmail.com\") return true;\n  try {\n    const force = localStorage.getItem(\"ndn:forceAdmin\");\n    if (force === \"1\" || force === \"true\") return true;\n  } catch {}\n  // try cache first (5 minutes)\n  const c = getCache();\n  const hit = c[e];\n  if (hit && Date.now() - hit.ts < 5 * 60 * 1000) return !!hit.v;\n  try {\n    const res = await fetch(`/api/admins/check?email=${encodeURIComponent(e)}`);\n    const data = await res.json().catch(() => ({}));\n    const v = !!data?.isAdmin;\n    setCache(e, v);\n    return v;\n  } catch {\n    return !!hit?.v;\n  }\n}\n\nexport function useIsAdmin(email?: string | null) {\n  const e = String(email || \"\").toLowerCase();\n  const [isAdmin, setIsAdmin] = useState(false);\n  useEffect(() => {\n    let on = true;\n    if (!e) {\n      setIsAdmin(false);\n      return;\n    }\n    // Instant fallbacks before API\n    try {\n      const owner = String(\n        (import.meta as any)?.env?.VITE_OWNER_EMAIL || \"\",\n      ).toLowerCase();\n      const force = ((): boolean => {\n        try {\n          const v = localStorage.getItem(\"ndn:forceAdmin\");\n          return v === \"1\" || v === \"true\";\n        } catch {\n          return false;\n        }\n      })();\n      if (owner && e === owner) {\n        setIsAdmin(true);\n        return;\n      }\n      if (force) {\n        setIsAdmin(true);\n        return;\n      }\n    } catch {}\n    if (e === \"daviesfamily108@gmail.com\") {\n      setIsAdmin(true);\n      return;\n    }\n    fetchIsAdmin(e).then((v) => {\n      if (on) setIsAdmin(!!v);\n    });\n    return () => {\n      on = false;\n    };\n  }, [e]);\n  return isAdmin;\n}\n","// Demo pricing: base is 5 GBP. Convert to user currency for display.\nexport const BASE_PRICE_GBP = 5;\n\n// Simple static FX rates for display (not for real billing). Updated rarely.\nconst FX: Record<string, number> = {\n  GBP: 1,\n  EUR: 1.16, //  per \n  USD: 1.26, // $ per \n  AUD: 1.92,\n  NZD: 2.08,\n  CAD: 1.73,\n};\n\nexport function formatPriceInCurrency(\n  currency: string,\n  gbpAmount = BASE_PRICE_GBP,\n) {\n  const cur = (currency || \"GBP\").toUpperCase();\n  const rate = FX[cur] ?? 1;\n  const val = gbpAmount * rate;\n  try {\n    return new Intl.NumberFormat(undefined, {\n      style: \"currency\",\n      currency: cur,\n    }).format(val);\n  } catch {\n    // Fallback\n    return `${cur} ${val.toFixed(2)}`;\n  }\n}\n\nexport function getUserCurrency(): string {\n  try {\n    // Heuristic: infer from locale\n    const parts = new Intl.NumberFormat().resolvedOptions();\n    // Example: en-GB -> GBP, en-US -> USD, en-AU -> AUD, etc. Not 100% accurate.\n    const m = String(parts.locale).toLowerCase();\n    if (m.includes(\"-gb\")) return \"GBP\";\n    if (\n      m.includes(\"-ie\") ||\n      m.includes(\"-de\") ||\n      m.includes(\"-fr\") ||\n      m.includes(\"-es\") ||\n      m.includes(\"-it\") ||\n      m.includes(\"-nl\")\n    )\n      return \"EUR\";\n    if (m.includes(\"-us\")) return \"USD\";\n    if (m.includes(\"-au\")) return \"AUD\";\n    if (m.includes(\"-nz\")) return \"NZD\";\n    if (m.includes(\"-ca\")) return \"CAD\";\n    return \"GBP\";\n  } catch {\n    return \"GBP\";\n  }\n}\n\n// Centralized Discord invite; override via VITE_DISCORD_INVITE_URL in Render/Netlify\nexport const DISCORD_INVITE_URL: string =\n  (import.meta as any).env?.VITE_DISCORD_INVITE_URL ||\n  \"https://discord.gg/nCfT4hJz\";\n","export type ApiPath = string;\n\nlet cachedBaseUrl: string | null = null;\nconst fallbackRemoteEnv =\n  ((import.meta as any)?.env?.VITE_REMOTE_API_FALLBACK as string | undefined) ||\n  \"\";\nconst REMOTE_API_FALLBACK = (\n  fallbackRemoteEnv.trim() || \"https://ninedartnation-1.onrender.com\"\n).replace(/\\/$/, \"\");\nconst LOCAL_HOSTS = new Set([\"localhost\", \"127.0.0.1\"]);\n\nfunction computeApiBase(): string {\n  if (cachedBaseUrl) return cachedBaseUrl;\n  const envUrl = (\n    (import.meta as any)?.env?.VITE_API_URL as string | undefined\n  )?.trim();\n  if (envUrl) {\n    const normalized = envUrl.replace(/\\/$/, \"\");\n    if (\n      typeof window !== \"undefined\" &&\n      /https?:\\/\\/(localhost|127\\.0\\.0\\.1)(:\\\\d+)?/i.test(normalized) &&\n      !LOCAL_HOSTS.has(window.location.hostname)\n    ) {\n      cachedBaseUrl = REMOTE_API_FALLBACK;\n      return cachedBaseUrl;\n    }\n    cachedBaseUrl = normalized;\n    return cachedBaseUrl;\n  }\n  if (typeof window !== \"undefined\") {\n    const { protocol, host, hostname } = window.location;\n    const sameOrigin = `${protocol}//${host}`;\n    if (\n      hostname.endsWith(\"onrender.com\") ||\n      hostname === \"localhost\" ||\n      hostname === \"127.0.0.1\"\n    ) {\n      cachedBaseUrl = sameOrigin.replace(/\\/$/, \"\");\n    } else {\n      cachedBaseUrl = REMOTE_API_FALLBACK;\n    }\n    return cachedBaseUrl;\n  }\n  // Fallback for build/test environments without window\n  cachedBaseUrl = REMOTE_API_FALLBACK;\n  return cachedBaseUrl;\n}\n\nfunction normalizePath(path: ApiPath): string {\n  if (/^https?:\\/\\//i.test(path)) return path;\n  const base = computeApiBase();\n  const cleanPath = path.startsWith(\"/\") ? path : `/${path}`;\n  return `${base}${cleanPath}`;\n}\n\nexport function resolveApiUrl(path: ApiPath): string {\n  return normalizePath(path);\n}\n\nexport function getApiBaseUrl(): string {\n  return computeApiBase();\n}\n\nexport function apiFetch(path: ApiPath, init?: RequestInit) {\n  const url = resolveApiUrl(path);\n\n  // If a previous probe determined the remote API is unreachable, short-circuit\n  // and return a fake Response-like object so callers don't trigger repeated\n  // network requests or unhandled promise rejections. The disable flag now\n  // expires after 60 seconds so the app can self-recover when the server comes\n  // back online (e.g., after a Render cold-start).\n  try {\n    const anyWin = window as any;\n    if (anyWin.__ndnApiDisabled) {\n      const disabledAt = Number(anyWin.__ndnApiDisabledAt) || 0;\n      if (disabledAt && Date.now() - disabledAt > 60_000) {\n        // Expired  allow requests again\n        anyWin.__ndnApiDisabled = false;\n        anyWin.__ndnApiDisabledAt = 0;\n      } else {\n        return Promise.resolve({\n          ok: false,\n          status: 503,\n          json: async () => ({}),\n        } as any);\n      }\n    }\n  } catch (_) {}\n\n  // Perform the fetch, but on network error or remote-host 404 mark the API\n  // disabled so subsequent calls are short-circuited and we avoid spamming the\n  // network / devtools with repeated failing requests.\n  return fetch(url, init)\n    .catch((err) => {\n      try {\n        (window as any).__ndnApiDisabled = true;\n        (window as any).__ndnApiDisabledAt = Date.now();\n      } catch (_) {}\n      return { ok: false, status: 503, json: async () => ({}) } as any;\n    })\n    .then((res) => {\n      try {\n        // If the request target is a remote host (not same origin) and returned\n        // a 404, consider the remote API unavailable and disable further calls.\n        const host = new URL(String(url)).hostname;\n        if (\n          res &&\n          (res as any).status === 404 &&\n          host !== window.location.hostname\n        ) {\n          (window as any).__ndnApiDisabled = true;\n          (window as any).__ndnApiDisabledAt = Date.now();\n        }\n      } catch (_) {}\n      return res;\n    });\n}\n\nexport function installApiInterceptor() {\n  if (typeof window === \"undefined\" || typeof window.fetch !== \"function\")\n    return;\n  const anyWindow = window as typeof window & { __ndnApiPatched?: boolean };\n  if (anyWindow.__ndnApiPatched) return;\n  const originalFetch = window.fetch.bind(window);\n  window.fetch = (input: RequestInfo | URL, init?: RequestInit) => {\n    try {\n      if (typeof input === \"string\") {\n        if (input.startsWith(\"/\")) {\n          return originalFetch(resolveApiUrl(input), init);\n        }\n        return originalFetch(input, init);\n      }\n      if (input instanceof Request) {\n        const reqUrl = input.url.startsWith(\"/\")\n          ? resolveApiUrl(input.url)\n          : input.url;\n        if (reqUrl === input.url) {\n          return originalFetch(input, init);\n        }\n        const cloned = new Request(reqUrl, input);\n        return originalFetch(cloned, init);\n      }\n      if (input instanceof URL) {\n        const href = input.href.startsWith(\"/\")\n          ? resolveApiUrl(input.href)\n          : input.href;\n        return originalFetch(href, init);\n      }\n    } catch (err) {\n      console.warn(\n        \"[API] Interceptor failed, falling back to original fetch\",\n        err,\n      );\n    }\n    return originalFetch(input as any, init);\n  };\n  anyWindow.__ndnApiPatched = true;\n}\n","import {\n  Camera,\n  LayoutDashboard,\n  Lock,\n  MessageCircle,\n  PoundSterling,\n  Settings,\n  Trophy,\n  Users,\n} from \"lucide-react\";\nimport FocusLock from \"react-focus-lock\";\nimport React, { useEffect, useState } from \"react\";\nimport { createPortal } from \"react-dom\";\nimport { getFreeRemaining } from \"../utils/quota\";\nimport { useIsAdmin } from \"../utils/admin\";\nimport { DISCORD_INVITE_URL } from \"../utils/config\";\nimport { apiFetch } from \"../utils/api\";\n\nexport type TabKey =\n  | \"score\"\n  | \"online\"\n  | \"offline\"\n  | \"friends\"\n  | \"stats\"\n  | \"calibrate\"\n  | \"settings\"\n  | \"admin\"\n  | \"tournaments\"\n  | \"fullaccess\";\n\ntype TabDefinition = {\n  key: TabKey;\n  label: string;\n  icon: typeof LayoutDashboard;\n};\n\nexport function getTabs(user: any): TabDefinition[] {\n  const baseTabs: TabDefinition[] = [\n    { key: \"score\", label: \"Home \", icon: LayoutDashboard },\n    { key: \"online\", label: \"Online Play \", icon: Users },\n    { key: \"offline\", label: \"Offline \", icon: Trophy },\n    { key: \"tournaments\", label: \"Tournaments \", icon: Trophy },\n    { key: \"friends\", label: \"Friends \", icon: Users },\n    { key: \"stats\", label: \"Stats \", icon: Trophy },\n    { key: \"calibrate\", label: \"Camera Connection \", icon: Camera },\n    { key: \"settings\", label: \"Settings \", icon: Settings },\n  ];\n  // Admin tab visibility handled in Sidebar via hook (client-side fetch)\n  // A premium user should not see the 'PREMIUM' tab. Check subscription details\n  // when present. If the user's subscription is active (includes tournament\n  // winners with a future expiresAt or a stripe subscription with active status),\n  // the tab is hidden. Otherwise, show it persistently until purchase.\n  function isSubscriptionActive(u: any) {\n    if (!u) return false;\n    const sub = u.subscription;\n    if (!sub) return !!u.fullAccess; // fallback\n    if (sub.fullAccess) {\n      if (sub.expiresAt) {\n        const exp =\n          typeof sub.expiresAt === \"string\"\n            ? Date.parse(sub.expiresAt)\n            : Number(sub.expiresAt);\n        if (!isNaN(exp)) return exp > Date.now();\n      }\n      if (sub.status) return sub.status === \"active\";\n      return true; // generic fullAccess true\n    }\n    return false;\n  }\n\n  if (!isSubscriptionActive(user)) {\n    baseTabs.push({\n      key: \"fullaccess\",\n      label: \"PREMIUM $ \",\n      icon: PoundSterling,\n    });\n  }\n  return baseTabs;\n}\n\nfunction resolveUserForTabs(user: any) {\n  let userForTabs = user;\n  if (!user?.subscription && user?.email) {\n    try {\n      const rawGet = (localStorage as any)?.getItem;\n      if (typeof rawGet === \"function\") {\n        const cached = rawGet.call(\n          localStorage,\n          `ndn:subscription:${user.email}`,\n        );\n        if (cached) {\n          const subs = JSON.parse(cached);\n          userForTabs = {\n            ...user,\n            subscription: subs,\n            fullAccess: subs.fullAccess || user.fullAccess,\n          };\n        }\n      }\n    } catch {}\n  }\n  return userForTabs;\n}\n\nexport function buildTabList(user: any, isAdmin: boolean): TabDefinition[] {\n  const tabs: TabDefinition[] = [...getTabs(user)];\n  if (isAdmin && !tabs.some((t) => t.key === \"admin\")) {\n    const adminTab = {\n      key: \"admin\",\n      label: \"Admin \",\n      icon: Settings,\n    } as const;\n    const insertIdx = tabs.findIndex((t) => t.key === \"settings\");\n    if (insertIdx >= 0) {\n      tabs.splice(insertIdx, 0, adminTab);\n    } else {\n      tabs.push(adminTab as TabDefinition);\n    }\n  }\n  return tabs;\n}\n\nexport function Sidebar({\n  active,\n  onChange,\n  user,\n  className,\n}: {\n  active: TabKey;\n  onChange: (key: TabKey) => void;\n  user: any;\n  className?: string;\n}) {\n  // Drag-to-scroll logic for PC/Mouse\n  const sidebarRef = React.useRef<HTMLElement>(null);\n  const isDown = React.useRef(false);\n  const startY = React.useRef(0);\n  const scrollTop = React.useRef(0);\n\n  const onMouseDown = (e: React.MouseEvent) => {\n    isDown.current = true;\n    if (sidebarRef.current) {\n      startY.current = e.pageY - sidebarRef.current.offsetTop;\n      scrollTop.current = sidebarRef.current.scrollTop;\n      sidebarRef.current.style.cursor = \"grabbing\";\n    }\n  };\n  const onMouseLeave = () => {\n    isDown.current = false;\n    if (sidebarRef.current) sidebarRef.current.style.cursor = \"grab\";\n  };\n  const onMouseUp = () => {\n    isDown.current = false;\n    if (sidebarRef.current) sidebarRef.current.style.cursor = \"grab\";\n  };\n  const onMouseMove = (e: React.MouseEvent) => {\n    if (!isDown.current || !sidebarRef.current) return;\n    e.preventDefault();\n    const y = e.pageY - sidebarRef.current.offsetTop;\n    const walk = (y - startY.current) * 2; // scroll speed\n    sidebarRef.current.scrollTop = scrollTop.current - walk;\n  };\n\n  // no-op debug retention removed\n  // When the server has not yet returned a subscription, prefer a cached\n  // localStorage subscription (if present) to avoid flicker in the UI.\n  const userForTabs = resolveUserForTabs(user);\n  const isAdmin = useIsAdmin(user?.email);\n  const tabs = buildTabList(userForTabs, isAdmin);\n  const [showDiscord, setShowDiscord] = useState(false);\n  const [showNDNDiscord, setShowNDNDiscord] = useState(false);\n  const freeLeft =\n    user?.username && !user?.fullAccess\n      ? getFreeRemaining(user.username)\n      : Infinity;\n\n  // Notification counts\n  const [notifications, setNotifications] = useState({\n    friendRequests: 0,\n    messages: 0,\n    tournaments: 0,\n  });\n\n  // Fetch notification counts\n  useEffect(() => {\n    if (!user?.email) return;\n    // Track failures and short-circuit polling if the remote API is known\n    // to be unavailable (helps avoid repeated 404s and network noise).\n    let mounted = true;\n    const failures = { count: 0 } as { count: number };\n    let disabledUntil: number | null = null;\n\n    const fetchNotifications = async () => {\n      try {\n        if (!mounted) return;\n        const anyWin = window as any;\n        if (anyWin.__ndnApiDisabled) return;\n        if (disabledUntil && Date.now() < disabledUntil) return;\n\n        const [requestsRes, messagesRes] = await Promise.all([\n          apiFetch(\n            `/api/friends/requests?email=${encodeURIComponent(user.email)}`,\n          ),\n          apiFetch(\n            `/api/friends/messages?email=${encodeURIComponent(user.email)}`,\n          ),\n        ]);\n\n        const requests =\n          requestsRes && (requestsRes as any).ok\n            ? await requestsRes.json()\n            : { requests: [] };\n        const messages =\n          messagesRes && (messagesRes as any).ok\n            ? await messagesRes.json()\n            : { messages: [] };\n\n        // Count unread messages\n        const unreadMessages =\n          messages.messages?.filter((m: any) => !m.read).length || 0;\n\n        setNotifications({\n          friendRequests: requests.requests?.length || 0,\n          messages: unreadMessages,\n          tournaments: 0,\n        });\n\n        // Success -> reset failures\n        failures.count = 0;\n        disabledUntil = null;\n      } catch (err) {\n        console.error(\"Failed to fetch notifications:\", err);\n        failures.count += 1;\n        if (failures.count >= 3) {\n          disabledUntil = Date.now() + 5 * 60 * 1000; // 5 minutes\n          console.warn(\n            \"Sidebar notifications polling paused for 5m due to repeated failures\",\n          );\n        }\n      }\n    };\n\n    fetchNotifications();\n    const interval = setInterval(fetchNotifications, 30000);\n    return () => {\n      mounted = false;\n      clearInterval(interval);\n    };\n  }, [user?.email]);\n\n  useEffect(() => {\n    if (!showDiscord) return;\n    const onKey = (e: KeyboardEvent) => {\n      if (e.key === \"Escape\" || e.key === \"Enter\") setShowDiscord(false);\n    };\n    document.addEventListener(\"keydown\", onKey);\n    return () => document.removeEventListener(\"keydown\", onKey);\n  }, [showDiscord]);\n\n  // Group tabs for professional layout\n  const playTabs = tabs.filter((t) =>\n    [\"score\", \"online\", \"offline\", \"tournaments\"].includes(t.key),\n  );\n  const socialTabs = tabs.filter((t) => [\"friends\"].includes(t.key));\n  const systemTabs = tabs.filter((t) =>\n    [\"stats\", \"calibrate\", \"settings\", \"admin\", \"fullaccess\"].includes(t.key),\n  );\n\n  const renderTab = (t: TabDefinition) => {\n    const { key, label, icon: Icon } = t;\n    const isActive = active === key;\n\n    // Calculate total notifications for this tab\n    let badgeCount = 0;\n    if (key === \"friends\") badgeCount = notifications.friendRequests;\n    if (key === \"score\")\n      badgeCount = notifications.messages + notifications.tournaments;\n\n    return (\n      <button\n        key={key}\n        className={`tab whitespace-nowrap flex items-center justify-between gap-3 ${isActive ? \"tab--active\" : \"tab--inactive\"} ${key === \"fullaccess\" ? \"tab--premium\" : \"\"}`}\n        onClick={() => onChange(key as TabKey)}\n        title={label}\n      >\n        <div className=\"flex items-center gap-3\">\n          <Icon\n            className={`w-5 h-5 ${isActive ? \"text-white\" : \"text-slate-400\"}`}\n          />\n          <span\n            className={`font-semibold text-[1rem] ${isActive ? \"text-white\" : \"text-slate-300\"}`}\n          >\n            {label}\n          </span>\n        </div>\n\n        <div className=\"flex items-center gap-2\">\n          {key === \"online\" && !user?.fullAccess && freeLeft <= 0 && (\n            <Lock className=\"w-3 h-3 text-rose-500\" />\n          )}\n\n          {badgeCount > 0 && (\n            <span className=\"notification-badge animate-pulse\">\n              {badgeCount > 9 ? \"9+\" : badgeCount}\n            </span>\n          )}\n        </div>\n      </button>\n    );\n  };\n\n  return (\n    <aside\n      ref={sidebarRef}\n      onMouseDown={onMouseDown}\n      onMouseLeave={onMouseLeave}\n      onMouseUp={onMouseUp}\n      onMouseMove={onMouseMove}\n      className={`${user?.fullAccess ? \"premium-sidebar\" : \"\"} sidebar glass ${\n        className ? \"\" : \"w-72\"\n      } p-5 rounded-2xl ${className ?? \"hidden sm:flex\"} flex-col gap-8 overflow-y-auto overflow-x-hidden ${\n        className ? \"\" : \"fixed top-4 bottom-4 left-4\"\n      }`}\n    >\n      {/* Logo / Brand Area */}\n      <div className=\"px-2 mb-2\">\n        <h1 className=\"text-2xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-purple-400 tracking-tight\">\n          NINE DART\n          <br />\n          NATION\n        </h1>\n      </div>\n\n      <div className=\"flex flex-col gap-2\">\n        <h3 className=\"text-xs font-bold text-slate-500 uppercase tracking-wider px-3 mb-2\">\n          Play\n        </h3>\n        {playTabs.map(renderTab)}\n      </div>\n\n      <div className=\"flex flex-col gap-2\">\n        <h3 className=\"text-xs font-bold text-slate-500 uppercase tracking-wider px-3 mb-2\">\n          Social\n        </h3>\n        {socialTabs.map(renderTab)}\n      </div>\n\n      <div className=\"flex flex-col gap-2\">\n        <h3 className=\"text-xs font-bold text-slate-500 uppercase tracking-wider px-3 mb-2\">\n          System\n        </h3>\n        {systemTabs.map((t) => {\n          const rendered = renderTab(t);\n          if (t.key === \"settings\") {\n            return (\n              <React.Fragment key={t.key}>\n                {rendered}\n                {/* Discord tab directly under Settings */}\n                <button\n                  className=\"tab tab--compact whitespace-nowrap flex items-center justify-start gap-3 bg-[#5865F2]/10 hover:bg-[#5865F2]/20 text-[#5865F2] transition-colors ml-4 border-l-2 border-[#5865F2]/30\"\n                  onClick={() => setShowDiscord(true)}\n                  title=\"BullseyeDartsLeague\"\n                >\n                  <MessageCircle className=\"w-4 h-4\" />\n                  <span className=\"truncate text-sm font-semibold\">\n                    Bullseye League\n                  </span>\n                </button>\n                {/* NineDartNation Discord tab */}\n                <button\n                  className=\"tab tab--compact whitespace-nowrap flex items-center justify-start gap-3 bg-[#5865F2]/10 hover:bg-[#5865F2]/20 text-[#5865F2] transition-colors ml-4 border-l-2 border-[#5865F2]/30\"\n                  onClick={() => setShowNDNDiscord(true)}\n                  title=\"NineDartNation\"\n                >\n                  <MessageCircle className=\"w-4 h-4\" />\n                  <span className=\"truncate text-sm font-semibold\">\n                    NDN Community\n                  </span>\n                </button>\n              </React.Fragment>\n            );\n          }\n          return rendered;\n        })}\n      </div>\n\n      {/* Discord about dialog via portal */}\n      {showDiscord &&\n        createPortal(\n          <div className=\"fixed inset-0 z-[1000]\">\n            <button\n              className=\"absolute inset-0 bg-black/50\"\n              onClick={() => setShowDiscord(false)}\n              onTouchStart={() => setShowDiscord(false)}\n              aria-label=\"Close Discord dialog\"\n            />\n            <div className=\"absolute inset-0 flex items-center justify-center p-4\">\n              <FocusLock returnFocus>\n                <div\n                  role=\"dialog\"\n                  aria-modal=\"true\"\n                  className=\"card max-w-md w-full relative text-left p-6 rounded-xl\"\n                >\n                  <button\n                    className=\"absolute -top-3 -right-3 btn px-3 py-1\"\n                    aria-label=\"Close\"\n                    onClick={() => setShowDiscord(false)}\n                  >\n                    \n                  </button>\n                  <h3 className=\"text-xl font-bold mb-2 flex items-center gap-2 text-[#8ea1e1]\">\n                    <MessageCircle className=\"w-6 h-6\" /> BullseyeDartsLeague \n                  </h3>\n                  <div className=\"mb-4 text-lg font-semibold\">\n                    Join this fantastic Online Darts League with divisions and\n                    other cool stuff included\n                  </div>\n                  <a\n                    href={DISCORD_INVITE_URL}\n                    target=\"_blank\"\n                    rel=\"noopener noreferrer nofollow\"\n                    className=\"btn bg-[#5865F2] text-white w-full font-bold text-lg\"\n                  >\n                    Join Discord \n                  </a>\n                </div>\n              </FocusLock>\n            </div>\n          </div>,\n          document.body,\n        )}\n      {/* NineDartNation Discord about dialog via portal */}\n      {showNDNDiscord &&\n        createPortal(\n          <div className=\"fixed inset-0 z-[1000]\">\n            <button\n              className=\"absolute inset-0 bg-black/50\"\n              onClick={() => setShowNDNDiscord(false)}\n              onTouchStart={() => setShowNDNDiscord(false)}\n              aria-label=\"Close NineDartNation dialog\"\n            />\n            <div className=\"absolute inset-0 flex items-center justify-center p-4\">\n              <FocusLock returnFocus>\n                <div\n                  role=\"dialog\"\n                  aria-modal=\"true\"\n                  className=\"card max-w-md w-full relative text-left p-6 rounded-xl\"\n                >\n                  <button\n                    className=\"absolute -top-3 -right-3 btn px-3 py-1\"\n                    aria-label=\"Close\"\n                    onClick={() => setShowNDNDiscord(false)}\n                  >\n                    \n                  </button>\n                  <h3 className=\"text-xl font-bold mb-2 flex items-center gap-2 text-[#8ea1e1]\">\n                    <MessageCircle className=\"w-6 h-6\" /> NineDartNation \n                  </h3>\n                  <div className=\"mb-4 text-lg font-semibold\">\n                    Join the NineDartNation  Discord community\n                  </div>\n                  <a\n                    href=\"https://discord.gg/Q33J5FTVve\"\n                    target=\"_blank\"\n                    rel=\"noopener noreferrer nofollow\"\n                    className=\"btn bg-[#5865F2] text-white w-full font-bold text-lg\"\n                  >\n                    Join Discord \n                  </a>\n                </div>\n              </FocusLock>\n            </div>\n          </div>,\n          document.body,\n        )}\n    </aside>\n  );\n}\n\nexport function MobileTabBar({\n  active,\n  onChange,\n  user,\n}: {\n  active: TabKey;\n  onChange: (key: TabKey) => void;\n  user: any;\n}) {\n  const isAdmin = useIsAdmin(user?.email);\n  const userForTabs = resolveUserForTabs(user);\n  const tabs = buildTabList(userForTabs, isAdmin);\n\n  // Helper to clean labels for mobile (remove emojis)\n  const cleanLabel = (l: string) =>\n    l.replace(/[\\u{1F300}-\\u{1F9FF}]|[\\u{2600}-\\u{26FF}]/gu, \"\").trim();\n\n  return (\n    <nav className=\"ndn-mobile-tabbar\" aria-label=\"Mobile navigation\">\n      {tabs.map(({ key, label, icon: Icon }) => (\n        <button\n          key={key}\n          type=\"button\"\n          title={label}\n          className={`tab mobile-tab-item ${active === key ? \"tab--active\" : \"tab--inactive\"}`}\n          onClick={() => onChange(key)}\n        >\n          <Icon className=\"w-5 h-5\" />\n          <span className=\"mobile-tab-label\">{cleanLabel(label)}</span>\n        </button>\n      ))}\n    </nav>\n  );\n}\n","import React, {\n  PropsWithChildren,\n  useEffect,\n  useRef,\n  useState,\n  type CSSProperties,\n} from \"react\";\n\ntype ScrollFadeProps = PropsWithChildren<{\n  className?: string;\n  style?: CSSProperties;\n}>;\n\nexport default function ScrollFade({\n  children,\n  className,\n  style,\n}: ScrollFadeProps) {\n  const ref = useRef<HTMLDivElement | null>(null);\n  const [maskHeight, setMaskHeight] = useState(0);\n\n  // Use CSS-based mask with GPU acceleration instead of DOM manipulation\n  useEffect(() => {\n    let raf = 0;\n    let lastMaskHeight = 0;\n\n    const updateMask = () => {\n      const header = document.getElementById(\"ndn-header\");\n      if (!header) {\n        if (lastMaskHeight !== 0) {\n          lastMaskHeight = 0;\n          setMaskHeight(0);\n        }\n        return;\n      }\n      const scroller = document.getElementById(\"ndn-main-scroll\");\n      const scrollTop = scroller ? scroller.scrollTop : window.scrollY || 0;\n      const headerH = header.getBoundingClientRect().height;\n      const newMaskHeight = scrollTop > 0 ? headerH : 0;\n\n      // Only update state if mask height changed significantly\n      if (Math.abs(newMaskHeight - lastMaskHeight) > 1) {\n        lastMaskHeight = newMaskHeight;\n        setMaskHeight(newMaskHeight);\n      }\n    };\n\n    updateMask();\n\n    const onScrollOrResize = () => {\n      if (raf) cancelAnimationFrame(raf);\n      raf = requestAnimationFrame(updateMask);\n    };\n\n    const scroller = document.getElementById(\"ndn-main-scroll\");\n    scroller?.addEventListener(\"scroll\", onScrollOrResize, { passive: true });\n    window.addEventListener(\"scroll\", onScrollOrResize, { passive: true });\n    window.addEventListener(\"resize\", onScrollOrResize, { passive: true });\n\n    return () => {\n      scroller?.removeEventListener(\"scroll\", onScrollOrResize);\n      window.removeEventListener(\"scroll\", onScrollOrResize);\n      window.removeEventListener(\"resize\", onScrollOrResize);\n      if (raf) cancelAnimationFrame(raf);\n    };\n  }, []);\n\n  return (\n    <div\n      ref={ref}\n      className={className}\n      style={{\n        ...style,\n        position: \"relative\",\n        willChange: \"transform\",\n        transform: \"translateZ(0)\", // Force GPU layer\n      }}\n    >\n      {maskHeight > 0 && (\n        <div\n          style={{\n            position: \"absolute\",\n            left: 0,\n            right: 0,\n            top: 0,\n            height: maskHeight,\n            pointerEvents: \"none\",\n            zIndex: 20,\n            background:\n              \"linear-gradient(to bottom, rgba(17,24,39,1), rgba(17,24,39,0))\",\n            willChange: \"height\",\n            transform: \"translateZ(0)\",\n          }}\n        />\n      )}\n      {children}\n    </div>\n  );\n}\n","export const isDev = ((import.meta as any).env?.DEV || false) as boolean;\nexport function dlog(...args: any[]) {\n  if (isDev) console.debug(...args);\n}\nexport function dinfo(...args: any[]) {\n  if (isDev) console.info(...args);\n}\nexport function dwarn(...args: any[]) {\n  if (isDev) console.warn(...args);\n}\nexport function derror(...args: any[]) {\n  if (isDev) console.error(...args);\n}\n","// High-accuracy dart detector for built-in autoscore\nimport { dlog } from \"./logger\";\n// Strategy:\n// - Maintain a grayscale background model (running average) when no darts are present\n// - For each frame, compute abs-diff mask vs background and apply a 3x3 morphological closing to reduce noise\n// - Restrict detection to a circular ROI around board center (from calibration) to ignore background\n// - Find the largest foreground blob; compute PCA on blob pixels to estimate shaft orientation\n// - Estimate the tip as the extreme along the principal axis in the outward radial direction from board center\n// - Stabilize across consecutive frames (2+) before emitting a detection; debounce between darts\n\nexport type Point = { x: number; y: number };\n\nexport type DartDetection = {\n  tip: Point;\n  axis?: { x1: number; y1: number; x2: number; y2: number };\n  area: number;\n  bbox: { x: number; y: number; w: number; h: number };\n  confidence: number; // 0..1 heuristic\n};\n\nexport class DartDetector {\n  private width = 0;\n  private height = 0;\n  private bg: Float32Array | null = null; // grayscale background\n  private lastAcceptTs = 0;\n  private cooldownMs = 600;\n  private roiRadius = 0; // pixels; 0 means disabled\n  private roiCx = 0;\n  private roiCy = 0;\n  private initialized = false;\n\n  // Tuning (defaults intentionally more permissive)\n  private thresh = 18; // intensity threshold for foreground (was 28)\n  private minArea = 60; // min connected pixels to consider a dart (was 90)\n  private maxArea = 6000; // guard against massive motion\n  private angMaxDeg = 70; // how far from radial to tolerate\n  // temporal stabilization\n  private prevTip: Point | null = null;\n  private prevArea: number = 0;\n  private stableCount = 0;\n  private requireStableN = 2;\n\n  // Optional temporary tuning overrides (used for short \"grace windows\")\n  private tempOverrides: {\n    untilTs: number;\n    requireStableN?: number;\n    angMaxDeg?: number;\n    thresh?: number;\n    minArea?: number;\n  } | null = null;\n\n  constructor(cfg?: {\n    thresh?: number;\n    minArea?: number;\n    maxArea?: number;\n    requireStableN?: number;\n    angMaxDeg?: number;\n  }) {\n    if (cfg?.thresh !== undefined) this.thresh = cfg.thresh;\n    if (cfg?.minArea !== undefined) this.minArea = cfg.minArea;\n    if (cfg?.maxArea !== undefined) this.maxArea = cfg.maxArea;\n    if (cfg?.requireStableN !== undefined)\n      this.requireStableN = cfg.requireStableN;\n    if (cfg?.angMaxDeg !== undefined) this.angMaxDeg = cfg.angMaxDeg;\n  }\n\n  /**\n   * Temporarily relax/tighten detector gates for a short period.\n   * Useful immediately after calibration when lighting/ROI can shift slightly.\n   */\n  setTemporaryOverrides(\n    overrides: {\n      requireStableN?: number;\n      angMaxDeg?: number;\n      thresh?: number;\n      minArea?: number;\n    },\n    durationMs: number,\n  ) {\n    const ms = Math.max(0, Number(durationMs) || 0);\n    if (ms <= 0) {\n      this.tempOverrides = null;\n      return;\n    }\n    this.tempOverrides = {\n      ...overrides,\n      untilTs: Date.now() + ms,\n    };\n  }\n\n  private _effectiveTuning() {\n    const now = Date.now();\n    const o = this.tempOverrides;\n    if (!o || now >= o.untilTs) {\n      // expire\n      if (o && now >= o.untilTs) this.tempOverrides = null;\n      return {\n        thresh: this.thresh,\n        minArea: this.minArea,\n        maxArea: this.maxArea,\n        requireStableN: this.requireStableN,\n        angMaxDeg: this.angMaxDeg,\n        inGrace: false,\n      };\n    }\n    return {\n      thresh: o.thresh ?? this.thresh,\n      minArea: o.minArea ?? this.minArea,\n      maxArea: this.maxArea,\n      requireStableN: o.requireStableN ?? this.requireStableN,\n      angMaxDeg: o.angMaxDeg ?? this.angMaxDeg,\n      inGrace: true,\n    };\n  }\n\n  setROI(cx: number, cy: number, radius: number) {\n    this.roiCx = cx;\n    this.roiCy = cy;\n    this.roiRadius = Math.max(0, radius | 0);\n  }\n\n  reset(width: number, height: number) {\n    this.width = width;\n    this.height = height;\n    this.bg = new Float32Array(width * height);\n    this.initialized = false;\n  }\n\n  // Seed or update background model with the provided frame\n  // If not initialized, copy; else running average with small alpha\n  updateBackground(frame: ImageData, alpha = 0.05) {\n    const { width: w, height: h, data } = frame;\n    if (!this.bg || w !== this.width || h !== this.height) {\n      this.reset(w, h);\n    }\n    const bg = this.bg!;\n    const n = w * h;\n    for (let i = 0, p = 0; i < n; i++, p += 4) {\n      const r = data[p],\n        g = data[p + 1],\n        b = data[p + 2];\n      const gray = 0.299 * r + 0.587 * g + 0.114 * b;\n      if (!this.initialized) bg[i] = gray;\n      else bg[i] = (1 - alpha) * bg[i] + alpha * gray;\n    }\n    this.initialized = true;\n  }\n\n  private inRoi(x: number, y: number): boolean {\n    if (this.roiRadius <= 0) return true;\n    const dx = x - this.roiCx;\n    const dy = y - this.roiCy;\n    return dx * dx + dy * dy <= this.roiRadius * this.roiRadius;\n  }\n\n  // Returns a detection if a new dart-like blob is found; null otherwise\n  detect(frame: ImageData): DartDetection | null {\n    const now = Date.now();\n    const recent = now - this.lastAcceptTs < this.cooldownMs;\n    const tuning = this._effectiveTuning();\n    const { width: w, height: h, data } = frame;\n    if (!this.bg || w !== this.width || h !== this.height) this.reset(w, h);\n    const bg = this.bg!;\n    if (!this.initialized) {\n      this.updateBackground(frame, 1.0);\n      dlog(\"[DETECTOR] Background not initialized yet\");\n      return null;\n    }\n\n    // Build diff buffer and compute dynamic threshold excluding specular highlights\n    const n = w * h;\n    const mask = new Uint8Array(n);\n    const diff = new Float32Array(n);\n    let sum = 0,\n      sum2 = 0,\n      cnt = 0;\n    const isHighlight = new Uint8Array(n);\n    for (let i = 0, p = 0; i < n; i++, p += 4) {\n      const r = data[p],\n        g = data[p + 1],\n        b = data[p + 2];\n      const maxc = Math.max(r, g, b);\n      const minc = Math.min(r, g, b);\n      const gray = 0.299 * r + 0.587 * g + 0.114 * b;\n      const d = Math.abs(gray - bg[i]);\n      diff[i] = d;\n      const y = Math.floor(i / w);\n      const x = i - y * w;\n      // specular highlight heuristic: very bright with low chroma\n      const satApprox = maxc === 0 ? 0 : (maxc - minc) / maxc;\n      const isHi = maxc >= 250 && satApprox <= 0.12;\n      if (isHi) isHighlight[i] = 1;\n      if (this.inRoi(x, y) && !isHi) {\n        sum += d;\n        sum2 += d * d;\n        cnt++;\n      }\n    }\n    const mu = cnt ? sum / cnt : 0;\n    const var_ = cnt ? Math.max(0, sum2 / cnt - mu * mu) : 0;\n    const sigma = Math.sqrt(var_);\n    const dynamicThresh = Math.max(tuning.thresh, mu + 1.2 * sigma);\n    // Rebuild mask using dynamic threshold and ignoring highlights\n    for (let i = 0; i < n; i++) {\n      if (isHighlight[i]) {\n        mask[i] = 0;\n        continue;\n      }\n      if (diff[i] > dynamicThresh) {\n        const y = Math.floor(i / w);\n        const x = i - y * w;\n        mask[i] = this.inRoi(x, y) ? 1 : 0;\n      }\n    }\n\n    // Morphological closing (dilate then erode) to consolidate thin shapes\n    this._dilate(mask, w, h);\n    this._erode(mask, w, h);\n\n    // Connected components (single pass using queue BFS); track largest blob\n    const visited = new Uint8Array(n);\n    let bestArea = 0;\n    let bestIdxs: number[] | null = null;\n    for (let i = 0; i < n; i++) {\n      if (mask[i] === 0 || visited[i]) continue;\n      const idxs: number[] = [];\n      let area = 0;\n      let qh = 0;\n      const q: number[] = [i];\n      visited[i] = 1;\n      while (qh < q.length) {\n        const cur = q[qh++];\n        idxs.push(cur);\n        area++;\n        const y = (cur / w) | 0;\n        const _x = cur - y * w;\n        // 4-neighborhood\n        const nbs = [cur - 1, cur + 1, cur - w, cur + w];\n        for (const nb of nbs) {\n          if (nb < 0 || nb >= n) continue;\n          if (visited[nb]) continue;\n          // bounds checks for left/right\n          if ((nb === cur - 1 || nb === cur + 1) && ((nb / w) | 0) !== y)\n            continue;\n          if (mask[nb]) {\n            visited[nb] = 1;\n            q.push(nb);\n          }\n        }\n      }\n      if (area > bestArea) {\n        bestArea = area;\n        bestIdxs = idxs;\n      }\n    }\n\n    if (!bestIdxs || bestArea < tuning.minArea || bestArea > tuning.maxArea) {\n      // Slowly update background when no valid detection to adapt lighting\n      if (!recent) this.updateBackground(frame, 0.02);\n      // Log occasionally to show why rejection happens\n      if (Math.random() < 0.02) {\n        dlog(\"[DETECTOR] No valid blob:\", {\n          bestArea,\n          minArea: tuning.minArea,\n          maxArea: tuning.maxArea,\n          hasBlob: !!bestIdxs,\n          inGrace: tuning.inGrace,\n        });\n      }\n      return null;\n    }\n\n    // Compute PCA (covariance) on blob pixels to estimate shaft orientation\n    let minX = w,\n      minY = h,\n      maxX = 0,\n      maxY = 0;\n    let meanX = 0,\n      meanY = 0;\n    for (const idx of bestIdxs) {\n      const y = (idx / w) | 0;\n      const x = idx - y * w;\n      meanX += x;\n      meanY += y;\n      if (x < minX) minX = x;\n      if (x > maxX) maxX = x;\n      if (y < minY) minY = y;\n      if (y > maxY) maxY = y;\n    }\n    meanX /= bestArea;\n    meanY /= bestArea;\n    let cxx = 0,\n      cyy = 0,\n      cxy = 0;\n    for (const idx of bestIdxs) {\n      const y = (idx / w) | 0;\n      const x = idx - y * w;\n      const dx = x - meanX;\n      const dy = y - meanY;\n      cxx += dx * dx;\n      cyy += dy * dy;\n      cxy += dx * dy;\n    }\n    cxx /= bestArea;\n    cyy /= bestArea;\n    cxy /= bestArea;\n    // Principal axis (eigenvector of covariance with largest eigenvalue)\n    // For 2x2 symmetric matrix [[cxx,cxy],[cxy,cyy]], eigenvector for largest eigenvalue lambda satisfies (cxx-l)x + cxy y = 0\n    const trace = cxx + cyy;\n    const det = cxx * cyy - cxy * cxy;\n    const tmp = Math.sqrt(Math.max(0, (trace * trace) / 4 - det));\n    const l1 = trace / 2 + tmp; // largest eigenvalue\n    // eigenvector v = (cxy, l1 - cxx) or (l1 - cyy, cxy); choose longer\n    let vx = cxy,\n      vy = l1 - cxx;\n    if (Math.hypot(vx, vy) < 1e-6) {\n      vx = l1 - cyy;\n      vy = cxy;\n    }\n    const vlen = Math.hypot(vx, vy) || 1;\n    vx /= vlen;\n    vy /= vlen;\n\n    // Enforce radial alignment: reject if principal axis deviates too much from radial direction.\n    // NOTE: The principal axis has 180 ambiguity (vx,vy) and (-vx,-vy) describe the same line.\n    // We therefore compare against BOTH directions by taking abs(dot) so we don't reject a valid\n    // dart just because the eigenvector points \"inward\".\n    const dxc = meanX - this.roiCx;\n    const dyc = meanY - this.roiCy;\n\n    // Near the ROI center, the radial direction is unstable and the angle check becomes noisy.\n    // Skip the angle gate in that zone.\n    const rlen = Math.hypot(dxc, dyc);\n    const minRForAngle = Math.max(8, this.roiRadius * 0.05);\n    if (rlen >= minRForAngle) {\n      const rx = dxc / rlen;\n      const ry = dyc / rlen;\n      const cosAng = Math.max(-1, Math.min(1, Math.abs(vx * rx + vy * ry)));\n      const angDeg = (Math.acos(cosAng) * 180) / Math.PI;\n      if (angDeg > tuning.angMaxDeg) {\n        // likely glare or non-radial artifact\n        if (!recent) this.updateBackground(frame, 0.02);\n        dlog(\"[DETECTOR] Rejected - angle too large:\", {\n          angDeg,\n          maxAllowed: tuning.angMaxDeg,\n          inGrace: tuning.inGrace,\n        });\n        return null;\n      }\n    }\n\n    // Project all blob points onto axis and pick extreme (max t) as tip candidate\n    let maxT = -Infinity;\n    let minT = Infinity;\n    let maxPtX = meanX,\n      maxPtY = meanY;\n    let minPtX = meanX,\n      minPtY = meanY;\n    for (const idx of bestIdxs) {\n      const y = (idx / w) | 0;\n      const x = idx - y * w;\n      const t = (x - meanX) * vx + (y - meanY) * vy;\n      if (t > maxT) {\n        maxT = t;\n        maxPtX = x;\n        maxPtY = y;\n      }\n      if (t < minT) {\n        minT = t;\n        minPtX = x;\n        minPtY = y;\n      }\n    }\n\n    // Choose the extreme closest to the board centre as the tip. This avoids\n    // accidentally locking onto dart flights when they dominate the detected\n    // blob, ensuring scoring uses the steel tip location only.\n    const distSq = (x: number, y: number) => {\n      const dx = x - this.roiCx;\n      const dy = y - this.roiCy;\n      return dx * dx + dy * dy;\n    };\n    const distMax = distSq(maxPtX, maxPtY);\n    const distMin = distSq(minPtX, minPtY);\n    let tipX: number;\n    let tipY: number;\n    if (distMin <= distMax) {\n      tipX = minPtX;\n      tipY = minPtY;\n      // Flip axis so positive direction still points away from the board\n      if (maxT - minT !== 0) {\n        const dot = (tipX - meanX) * vx + (tipY - meanY) * vy;\n        if (dot > 0) {\n          vx = -vx;\n          vy = -vy;\n        }\n      }\n    } else {\n      tipX = maxPtX;\n      tipY = maxPtY;\n      const dot = (tipX - meanX) * vx + (tipY - meanY) * vy;\n      if (dot > 0) {\n        vx = -vx;\n        vy = -vy;\n      }\n    }\n\n    // Distance to center for confidence heuristic\n    const dxr = tipX - this.roiCx;\n    const dyr = tipY - this.roiCy;\n    const minR2 = dxr * dxr + dyr * dyr;\n\n    // Confidence heuristic based on compactness and radial extent\n    const bboxW = Math.max(1, maxX - minX + 1);\n    const bboxH = Math.max(1, maxY - minY + 1);\n    const bboxArea = bboxW * bboxH;\n    const fill = bestArea / bboxArea; // 0..1 (thin dart should be small fill)\n    const radial = Math.sqrt(minR2) / Math.max(1, this.roiRadius);\n    let confidence = 0.5;\n    // Prefer thin elongated shapes with small fill and inside ROI\n    if (fill < 0.45) confidence += 0.2;\n    if (fill < 0.25) confidence += 0.15;\n    if (radial < 1.1) confidence += 0.1;\n    // Orientation confidence: larger principal eigenvalue vs minor\n    const l2 = trace - l1;\n    const elong = l1 > 0 ? 1 - l2 / l1 : 0;\n    if (elong > 0.3) confidence += 0.1;\n    confidence = Math.max(0, Math.min(1, confidence));\n\n    // Update background outside the blob to keep stability\n    // Optionally, we can inpaint the blob into background upon acceptance by caller\n\n    // Temporal stabilization: require 2+ consistent frames for the same dart\n    const stable = this._isStable(\n      { x: tipX + 0.5, y: tipY + 0.5 },\n      bestArea,\n      tuning.requireStableN,\n    );\n    if (!stable) {\n      dlog(\"[DETECTOR] Waiting for stability:\", {\n        stableCount: this.stableCount,\n        needFrames: tuning.requireStableN,\n        inGrace: tuning.inGrace,\n      });\n      return null;\n    }\n    // Debounce\n    if (recent) {\n      dlog(\"[DETECTOR] In cooldown period\");\n      return null;\n    }\n\n    dlog(\"[DETECTOR]  DART FOUND!\", {\n      tipX,\n      tipY,\n      area: bestArea,\n      confidence,\n    });\n\n    return {\n      tip: { x: tipX + 0.5, y: tipY + 0.5 },\n      axis: {\n        x1: meanX - vx * 20,\n        y1: meanY - vy * 20,\n        x2: meanX + vx * 20,\n        y2: meanY + vy * 20,\n      },\n      area: bestArea,\n      bbox: { x: minX, y: minY, w: bboxW, h: bboxH },\n      confidence,\n    };\n  }\n\n  // Incorporate the accepted detection into background so it won't trigger again\n  accept(frame: ImageData, det: DartDetection) {\n    this.lastAcceptTs = Date.now();\n    // reset temporal stabilization for next dart\n    this.prevTip = null;\n    this.prevArea = 0;\n    this.stableCount = 0;\n    if (!this.bg) return;\n    const { width: w } = frame;\n    const bg = this.bg;\n    const { x, y, w: bw, h: bh } = det.bbox;\n    const alpha = 0.5;\n    for (let yy = y; yy < y + bh; yy++) {\n      for (let xx = x; xx < x + bw; xx++) {\n        const i = yy * w + xx;\n        const p = i * 4;\n        const r = frame.data[p],\n          g = frame.data[p + 1],\n          b = frame.data[p + 2];\n        const gray = 0.299 * r + 0.587 * g + 0.114 * b;\n        bg[i] = (1 - alpha) * bg[i] + alpha * gray;\n      }\n    }\n  }\n\n  // --- helpers ---\n  private _isStable(tip: Point, area: number, requireN?: number): boolean {\n    const close = (a: Point, b: Point) => Math.hypot(a.x - b.x, a.y - b.y) <= 6;\n    if (!this.prevTip) {\n      this.prevTip = { ...tip };\n      this.prevArea = area;\n      this.stableCount = 1;\n      return false;\n    }\n    if (\n      close(this.prevTip, tip) &&\n      Math.abs(area - this.prevArea) / Math.max(1, area) < 0.3\n    ) {\n      this.prevTip = { ...tip };\n      this.prevArea = area;\n      this.stableCount++;\n    } else {\n      this.prevTip = { ...tip };\n      this.prevArea = area;\n      this.stableCount = 1;\n      return false;\n    }\n    const n = Math.max(1, requireN ?? this.requireStableN);\n    return this.stableCount >= n;\n  }\n\n  private _dilate(mask: Uint8Array, w: number, h: number) {\n    const out = new Uint8Array(mask.length);\n    for (let y = 0; y < h; y++) {\n      for (let x = 0; x < w; x++) {\n        let on = 0;\n        for (let j = -1; j <= 1; j++) {\n          for (let i = -1; i <= 1; i++) {\n            const yy = y + j,\n              xx = x + i;\n            if (yy < 0 || yy >= h || xx < 0 || xx >= w) continue;\n            if (mask[yy * w + xx]) {\n              on = 1;\n              break;\n            }\n          }\n          if (on) break;\n        }\n        out[y * w + x] = on;\n      }\n    }\n    mask.set(out);\n  }\n\n  private _erode(mask: Uint8Array, w: number, h: number) {\n    const out = new Uint8Array(mask.length);\n    for (let y = 0; y < h; y++) {\n      for (let x = 0; x < w; x++) {\n        let on = 1;\n        for (let j = -1; j <= 1; j++) {\n          for (let i = -1; i <= 1; i++) {\n            const yy = y + j,\n              xx = x + i;\n            if (yy < 0 || yy >= h || xx < 0 || xx >= w) continue;\n            if (!mask[yy * w + xx]) {\n              on = 0;\n              break;\n            }\n          }\n          if (!on) break;\n        }\n        out[y * w + x] = on;\n      }\n    }\n    mask.set(out);\n  }\n}\n","const createStoreImpl = (createState) => {\n  let state;\n  const listeners = /* @__PURE__ */ new Set();\n  const setState = (partial, replace) => {\n    const nextState = typeof partial === \"function\" ? partial(state) : partial;\n    if (!Object.is(nextState, state)) {\n      const previousState = state;\n      state = (replace != null ? replace : typeof nextState !== \"object\" || nextState === null) ? nextState : Object.assign({}, state, nextState);\n      listeners.forEach((listener) => listener(state, previousState));\n    }\n  };\n  const getState = () => state;\n  const getInitialState = () => initialState;\n  const subscribe = (listener) => {\n    listeners.add(listener);\n    return () => listeners.delete(listener);\n  };\n  const destroy = () => {\n    if ((import.meta.env ? import.meta.env.MODE : void 0) !== \"production\") {\n      console.warn(\n        \"[DEPRECATED] The `destroy` method will be unsupported in a future version. Instead use unsubscribe function returned by subscribe. Everything will be garbage-collected if store is garbage-collected.\"\n      );\n    }\n    listeners.clear();\n  };\n  const api = { setState, getState, getInitialState, subscribe, destroy };\n  const initialState = state = createState(setState, getState, api);\n  return api;\n};\nconst createStore = (createState) => createState ? createStoreImpl(createState) : createStoreImpl;\nvar vanilla = (createState) => {\n  if ((import.meta.env ? import.meta.env.MODE : void 0) !== \"production\") {\n    console.warn(\n      \"[DEPRECATED] Default export is deprecated. Instead use import { createStore } from 'zustand/vanilla'.\"\n    );\n  }\n  return createStore(createState);\n};\n\nexport { createStore, vanilla as default };\n","/**\n * @license React\n * use-sync-external-store-shim.production.js\n *\n * Copyright (c) Meta Platforms, Inc. and affiliates.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n */\n\n\"use strict\";\nvar React = require(\"react\");\nfunction is(x, y) {\n  return (x === y && (0 !== x || 1 / x === 1 / y)) || (x !== x && y !== y);\n}\nvar objectIs = \"function\" === typeof Object.is ? Object.is : is,\n  useState = React.useState,\n  useEffect = React.useEffect,\n  useLayoutEffect = React.useLayoutEffect,\n  useDebugValue = React.useDebugValue;\nfunction useSyncExternalStore$2(subscribe, getSnapshot) {\n  var value = getSnapshot(),\n    _useState = useState({ inst: { value: value, getSnapshot: getSnapshot } }),\n    inst = _useState[0].inst,\n    forceUpdate = _useState[1];\n  useLayoutEffect(\n    function () {\n      inst.value = value;\n      inst.getSnapshot = getSnapshot;\n      checkIfSnapshotChanged(inst) && forceUpdate({ inst: inst });\n    },\n    [subscribe, value, getSnapshot]\n  );\n  useEffect(\n    function () {\n      checkIfSnapshotChanged(inst) && forceUpdate({ inst: inst });\n      return subscribe(function () {\n        checkIfSnapshotChanged(inst) && forceUpdate({ inst: inst });\n      });\n    },\n    [subscribe]\n  );\n  useDebugValue(value);\n  return value;\n}\nfunction checkIfSnapshotChanged(inst) {\n  var latestGetSnapshot = inst.getSnapshot;\n  inst = inst.value;\n  try {\n    var nextValue = latestGetSnapshot();\n    return !objectIs(inst, nextValue);\n  } catch (error) {\n    return !0;\n  }\n}\nfunction useSyncExternalStore$1(subscribe, getSnapshot) {\n  return getSnapshot();\n}\nvar shim =\n  \"undefined\" === typeof window ||\n  \"undefined\" === typeof window.document ||\n  \"undefined\" === typeof window.document.createElement\n    ? useSyncExternalStore$1\n    : useSyncExternalStore$2;\nexports.useSyncExternalStore =\n  void 0 !== React.useSyncExternalStore ? React.useSyncExternalStore : shim;\n","'use strict';\n\nif (process.env.NODE_ENV === 'production') {\n  module.exports = require('../cjs/use-sync-external-store-shim.production.js');\n} else {\n  module.exports = require('../cjs/use-sync-external-store-shim.development.js');\n}\n","/**\n * @license React\n * use-sync-external-store-shim/with-selector.production.js\n *\n * Copyright (c) Meta Platforms, Inc. and affiliates.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n */\n\n\"use strict\";\nvar React = require(\"react\"),\n  shim = require(\"use-sync-external-store/shim\");\nfunction is(x, y) {\n  return (x === y && (0 !== x || 1 / x === 1 / y)) || (x !== x && y !== y);\n}\nvar objectIs = \"function\" === typeof Object.is ? Object.is : is,\n  useSyncExternalStore = shim.useSyncExternalStore,\n  useRef = React.useRef,\n  useEffect = React.useEffect,\n  useMemo = React.useMemo,\n  useDebugValue = React.useDebugValue;\nexports.useSyncExternalStoreWithSelector = function (\n  subscribe,\n  getSnapshot,\n  getServerSnapshot,\n  selector,\n  isEqual\n) {\n  var instRef = useRef(null);\n  if (null === instRef.current) {\n    var inst = { hasValue: !1, value: null };\n    instRef.current = inst;\n  } else inst = instRef.current;\n  instRef = useMemo(\n    function () {\n      function memoizedSelector(nextSnapshot) {\n        if (!hasMemo) {\n          hasMemo = !0;\n          memoizedSnapshot = nextSnapshot;\n          nextSnapshot = selector(nextSnapshot);\n          if (void 0 !== isEqual && inst.hasValue) {\n            var currentSelection = inst.value;\n            if (isEqual(currentSelection, nextSnapshot))\n              return (memoizedSelection = currentSelection);\n          }\n          return (memoizedSelection = nextSnapshot);\n        }\n        currentSelection = memoizedSelection;\n        if (objectIs(memoizedSnapshot, nextSnapshot)) return currentSelection;\n        var nextSelection = selector(nextSnapshot);\n        if (void 0 !== isEqual && isEqual(currentSelection, nextSelection))\n          return (memoizedSnapshot = nextSnapshot), currentSelection;\n        memoizedSnapshot = nextSnapshot;\n        return (memoizedSelection = nextSelection);\n      }\n      var hasMemo = !1,\n        memoizedSnapshot,\n        memoizedSelection,\n        maybeGetServerSnapshot =\n          void 0 === getServerSnapshot ? null : getServerSnapshot;\n      return [\n        function () {\n          return memoizedSelector(getSnapshot());\n        },\n        null === maybeGetServerSnapshot\n          ? void 0\n          : function () {\n              return memoizedSelector(maybeGetServerSnapshot());\n            }\n      ];\n    },\n    [getSnapshot, getServerSnapshot, selector, isEqual]\n  );\n  var value = useSyncExternalStore(subscribe, instRef[0], instRef[1]);\n  useEffect(\n    function () {\n      inst.hasValue = !0;\n      inst.value = value;\n    },\n    [value]\n  );\n  useDebugValue(value);\n  return value;\n};\n","'use strict';\n\nif (process.env.NODE_ENV === 'production') {\n  module.exports = require('../cjs/use-sync-external-store-shim/with-selector.production.js');\n} else {\n  module.exports = require('../cjs/use-sync-external-store-shim/with-selector.development.js');\n}\n","import { createStore } from 'zustand/vanilla';\nexport * from 'zustand/vanilla';\nimport ReactExports from 'react';\nimport useSyncExternalStoreExports from 'use-sync-external-store/shim/with-selector.js';\n\nconst { useDebugValue } = ReactExports;\nconst { useSyncExternalStoreWithSelector } = useSyncExternalStoreExports;\nlet didWarnAboutEqualityFn = false;\nconst identity = (arg) => arg;\nfunction useStore(api, selector = identity, equalityFn) {\n  if ((import.meta.env ? import.meta.env.MODE : void 0) !== \"production\" && equalityFn && !didWarnAboutEqualityFn) {\n    console.warn(\n      \"[DEPRECATED] Use `createWithEqualityFn` instead of `create` or use `useStoreWithEqualityFn` instead of `useStore`. They can be imported from 'zustand/traditional'. https://github.com/pmndrs/zustand/discussions/1937\"\n    );\n    didWarnAboutEqualityFn = true;\n  }\n  const slice = useSyncExternalStoreWithSelector(\n    api.subscribe,\n    api.getState,\n    api.getServerState || api.getInitialState,\n    selector,\n    equalityFn\n  );\n  useDebugValue(slice);\n  return slice;\n}\nconst createImpl = (createState) => {\n  if ((import.meta.env ? import.meta.env.MODE : void 0) !== \"production\" && typeof createState !== \"function\") {\n    console.warn(\n      \"[DEPRECATED] Passing a vanilla store will be unsupported in a future version. Instead use `import { useStore } from 'zustand'`.\"\n    );\n  }\n  const api = typeof createState === \"function\" ? createStore(createState) : createState;\n  const useBoundStore = (selector, equalityFn) => useStore(api, selector, equalityFn);\n  Object.assign(useBoundStore, api);\n  return useBoundStore;\n};\nconst create = (createState) => createState ? createImpl(createState) : createImpl;\nvar react = (createState) => {\n  if ((import.meta.env ? import.meta.env.MODE : void 0) !== \"production\") {\n    console.warn(\n      \"[DEPRECATED] Default export is deprecated. Instead use `import { create } from 'zustand'`.\"\n    );\n  }\n  return create(createState);\n};\n\nexport { create, react as default, useStore };\n","import { create } from \"zustand\";\nimport type { Homography } from \"../utils/vision\";\n\n/**\n * Simplified Calibration Store for Manual-Only Mode\n *\n * This store now only tracks camera view locking (alignment with dartboard).\n * No complex homography mapping or board-space calculations needed.\n *\n * Purpose: Allow users to align camera with dartboard and lock that view\n * for consistent alignment throughout offline/online/tournament play.\n */\n\ntype CameraViewLock = {\n  // Camera alignment/lock state\n  locked: boolean;\n  lockedAt: number | null;\n  // Locked camera view settings\n  lockedScale: number | null;\n  lockedAspect: \"wide\" | \"square\" | null;\n  lockedFitMode: \"fit\" | \"fill\" | null;\n  // Camera ID when locked (for camera switching awareness)\n  cameraId: string | null;\n};\n\ntype CalibrationState = CameraViewLock & {\n  // Simple calibration metadata\n  createdAt: number | null;\n  _hydrated: boolean;\n\n  // Legacy calibration fields (kept for type-compat with existing components).\n  // Manual-only mode keeps these as null by default.\n  H: Homography | null;\n  imageSize: { w: number; h: number } | null;\n  overlaySize: { w: number; h: number } | null;\n  theta: number | null;\n  rotationOffsetRad: number | null;\n  sectorOffset: number | null;\n  errorPx: number | null;\n  confidence: number | null;\n  anchors: { src: any[]; dst: any[] } | null;\n\n  // Legacy setter used across the app\n  setCalibration: (partial: Partial<CalibrationState>) => void;\n  // Actions\n  lockCameraView: (\n    scale: number,\n    aspect: \"wide\" | \"square\",\n    fitMode: \"fit\" | \"fill\",\n    cameraId: string | null,\n  ) => void;\n  unlockCameraView: () => void;\n  reset: () => void;\n};\n\nexport const useCalibration = create<CalibrationState>()((set) => ({\n  // Camera view lock state\n  locked: false,\n  lockedAt: null,\n  lockedScale: null,\n  lockedAspect: null,\n  lockedFitMode: null,\n  cameraId: null,\n  createdAt: null,\n  _hydrated: true,\n\n  H: null,\n  imageSize: null,\n  overlaySize: null,\n  theta: null,\n  rotationOffsetRad: null,\n  sectorOffset: null,\n  errorPx: null,\n  confidence: null,\n  anchors: null,\n\n  setCalibration: (partial) => set(partial as any),\n\n  lockCameraView: (scale, aspect, fitMode, cameraId) =>\n    set({\n      locked: true,\n      lockedAt: Date.now(),\n      lockedScale: scale,\n      lockedAspect: aspect,\n      lockedFitMode: fitMode,\n      cameraId: cameraId,\n      createdAt: Date.now(),\n    }),\n\n  unlockCameraView: () =>\n    set({\n      locked: false,\n      lockedAt: null,\n      lockedScale: null,\n      lockedAspect: null,\n      lockedFitMode: null,\n    }),\n\n  reset: () =>\n    set({\n      locked: false,\n      lockedAt: null,\n      lockedScale: null,\n      lockedAspect: null,\n      lockedFitMode: null,\n      cameraId: null,\n      createdAt: null,\n    }),\n}));\n","const reduxImpl = (reducer, initial) => (set, _get, api) => {\n  api.dispatch = (action) => {\n    set((state) => reducer(state, action), false, action);\n    return action;\n  };\n  api.dispatchFromDevtools = true;\n  return { dispatch: (...a) => api.dispatch(...a), ...initial };\n};\nconst redux = reduxImpl;\n\nconst trackedConnections = /* @__PURE__ */ new Map();\nconst getTrackedConnectionState = (name) => {\n  const api = trackedConnections.get(name);\n  if (!api) return {};\n  return Object.fromEntries(\n    Object.entries(api.stores).map(([key, api2]) => [key, api2.getState()])\n  );\n};\nconst extractConnectionInformation = (store, extensionConnector, options) => {\n  if (store === void 0) {\n    return {\n      type: \"untracked\",\n      connection: extensionConnector.connect(options)\n    };\n  }\n  const existingConnection = trackedConnections.get(options.name);\n  if (existingConnection) {\n    return { type: \"tracked\", store, ...existingConnection };\n  }\n  const newConnection = {\n    connection: extensionConnector.connect(options),\n    stores: {}\n  };\n  trackedConnections.set(options.name, newConnection);\n  return { type: \"tracked\", store, ...newConnection };\n};\nconst devtoolsImpl = (fn, devtoolsOptions = {}) => (set, get, api) => {\n  const { enabled, anonymousActionType, store, ...options } = devtoolsOptions;\n  let extensionConnector;\n  try {\n    extensionConnector = (enabled != null ? enabled : (import.meta.env ? import.meta.env.MODE : void 0) !== \"production\") && window.__REDUX_DEVTOOLS_EXTENSION__;\n  } catch (_e) {\n  }\n  if (!extensionConnector) {\n    if ((import.meta.env ? import.meta.env.MODE : void 0) !== \"production\" && enabled) {\n      console.warn(\n        \"[zustand devtools middleware] Please install/enable Redux devtools extension\"\n      );\n    }\n    return fn(set, get, api);\n  }\n  const { connection, ...connectionInformation } = extractConnectionInformation(store, extensionConnector, options);\n  let isRecording = true;\n  api.setState = (state, replace, nameOrAction) => {\n    const r = set(state, replace);\n    if (!isRecording) return r;\n    const action = nameOrAction === void 0 ? { type: anonymousActionType || \"anonymous\" } : typeof nameOrAction === \"string\" ? { type: nameOrAction } : nameOrAction;\n    if (store === void 0) {\n      connection == null ? void 0 : connection.send(action, get());\n      return r;\n    }\n    connection == null ? void 0 : connection.send(\n      {\n        ...action,\n        type: `${store}/${action.type}`\n      },\n      {\n        ...getTrackedConnectionState(options.name),\n        [store]: api.getState()\n      }\n    );\n    return r;\n  };\n  const setStateFromDevtools = (...a) => {\n    const originalIsRecording = isRecording;\n    isRecording = false;\n    set(...a);\n    isRecording = originalIsRecording;\n  };\n  const initialState = fn(api.setState, get, api);\n  if (connectionInformation.type === \"untracked\") {\n    connection == null ? void 0 : connection.init(initialState);\n  } else {\n    connectionInformation.stores[connectionInformation.store] = api;\n    connection == null ? void 0 : connection.init(\n      Object.fromEntries(\n        Object.entries(connectionInformation.stores).map(([key, store2]) => [\n          key,\n          key === connectionInformation.store ? initialState : store2.getState()\n        ])\n      )\n    );\n  }\n  if (api.dispatchFromDevtools && typeof api.dispatch === \"function\") {\n    let didWarnAboutReservedActionType = false;\n    const originalDispatch = api.dispatch;\n    api.dispatch = (...a) => {\n      if ((import.meta.env ? import.meta.env.MODE : void 0) !== \"production\" && a[0].type === \"__setState\" && !didWarnAboutReservedActionType) {\n        console.warn(\n          '[zustand devtools middleware] \"__setState\" action type is reserved to set state from the devtools. Avoid using it.'\n        );\n        didWarnAboutReservedActionType = true;\n      }\n      originalDispatch(...a);\n    };\n  }\n  connection.subscribe((message) => {\n    var _a;\n    switch (message.type) {\n      case \"ACTION\":\n        if (typeof message.payload !== \"string\") {\n          console.error(\n            \"[zustand devtools middleware] Unsupported action format\"\n          );\n          return;\n        }\n        return parseJsonThen(\n          message.payload,\n          (action) => {\n            if (action.type === \"__setState\") {\n              if (store === void 0) {\n                setStateFromDevtools(action.state);\n                return;\n              }\n              if (Object.keys(action.state).length !== 1) {\n                console.error(\n                  `\n                    [zustand devtools middleware] Unsupported __setState action format. \n                    When using 'store' option in devtools(), the 'state' should have only one key, which is a value of 'store' that was passed in devtools(),\n                    and value of this only key should be a state object. Example: { \"type\": \"__setState\", \"state\": { \"abc123Store\": { \"foo\": \"bar\" } } }\n                    `\n                );\n              }\n              const stateFromDevtools = action.state[store];\n              if (stateFromDevtools === void 0 || stateFromDevtools === null) {\n                return;\n              }\n              if (JSON.stringify(api.getState()) !== JSON.stringify(stateFromDevtools)) {\n                setStateFromDevtools(stateFromDevtools);\n              }\n              return;\n            }\n            if (!api.dispatchFromDevtools) return;\n            if (typeof api.dispatch !== \"function\") return;\n            api.dispatch(action);\n          }\n        );\n      case \"DISPATCH\":\n        switch (message.payload.type) {\n          case \"RESET\":\n            setStateFromDevtools(initialState);\n            if (store === void 0) {\n              return connection == null ? void 0 : connection.init(api.getState());\n            }\n            return connection == null ? void 0 : connection.init(getTrackedConnectionState(options.name));\n          case \"COMMIT\":\n            if (store === void 0) {\n              connection == null ? void 0 : connection.init(api.getState());\n              return;\n            }\n            return connection == null ? void 0 : connection.init(getTrackedConnectionState(options.name));\n          case \"ROLLBACK\":\n            return parseJsonThen(message.state, (state) => {\n              if (store === void 0) {\n                setStateFromDevtools(state);\n                connection == null ? void 0 : connection.init(api.getState());\n                return;\n              }\n              setStateFromDevtools(state[store]);\n              connection == null ? void 0 : connection.init(getTrackedConnectionState(options.name));\n            });\n          case \"JUMP_TO_STATE\":\n          case \"JUMP_TO_ACTION\":\n            return parseJsonThen(message.state, (state) => {\n              if (store === void 0) {\n                setStateFromDevtools(state);\n                return;\n              }\n              if (JSON.stringify(api.getState()) !== JSON.stringify(state[store])) {\n                setStateFromDevtools(state[store]);\n              }\n            });\n          case \"IMPORT_STATE\": {\n            const { nextLiftedState } = message.payload;\n            const lastComputedState = (_a = nextLiftedState.computedStates.slice(-1)[0]) == null ? void 0 : _a.state;\n            if (!lastComputedState) return;\n            if (store === void 0) {\n              setStateFromDevtools(lastComputedState);\n            } else {\n              setStateFromDevtools(lastComputedState[store]);\n            }\n            connection == null ? void 0 : connection.send(\n              null,\n              // FIXME no-any\n              nextLiftedState\n            );\n            return;\n          }\n          case \"PAUSE_RECORDING\":\n            return isRecording = !isRecording;\n        }\n        return;\n    }\n  });\n  return initialState;\n};\nconst devtools = devtoolsImpl;\nconst parseJsonThen = (stringified, f) => {\n  let parsed;\n  try {\n    parsed = JSON.parse(stringified);\n  } catch (e) {\n    console.error(\n      \"[zustand devtools middleware] Could not parse the received json\",\n      e\n    );\n  }\n  if (parsed !== void 0) f(parsed);\n};\n\nconst subscribeWithSelectorImpl = (fn) => (set, get, api) => {\n  const origSubscribe = api.subscribe;\n  api.subscribe = (selector, optListener, options) => {\n    let listener = selector;\n    if (optListener) {\n      const equalityFn = (options == null ? void 0 : options.equalityFn) || Object.is;\n      let currentSlice = selector(api.getState());\n      listener = (state) => {\n        const nextSlice = selector(state);\n        if (!equalityFn(currentSlice, nextSlice)) {\n          const previousSlice = currentSlice;\n          optListener(currentSlice = nextSlice, previousSlice);\n        }\n      };\n      if (options == null ? void 0 : options.fireImmediately) {\n        optListener(currentSlice, currentSlice);\n      }\n    }\n    return origSubscribe(listener);\n  };\n  const initialState = fn(set, get, api);\n  return initialState;\n};\nconst subscribeWithSelector = subscribeWithSelectorImpl;\n\nconst combine = (initialState, create) => (...a) => Object.assign({}, initialState, create(...a));\n\nfunction createJSONStorage(getStorage, options) {\n  let storage;\n  try {\n    storage = getStorage();\n  } catch (_e) {\n    return;\n  }\n  const persistStorage = {\n    getItem: (name) => {\n      var _a;\n      const parse = (str2) => {\n        if (str2 === null) {\n          return null;\n        }\n        return JSON.parse(str2, options == null ? void 0 : options.reviver);\n      };\n      const str = (_a = storage.getItem(name)) != null ? _a : null;\n      if (str instanceof Promise) {\n        return str.then(parse);\n      }\n      return parse(str);\n    },\n    setItem: (name, newValue) => storage.setItem(\n      name,\n      JSON.stringify(newValue, options == null ? void 0 : options.replacer)\n    ),\n    removeItem: (name) => storage.removeItem(name)\n  };\n  return persistStorage;\n}\nconst toThenable = (fn) => (input) => {\n  try {\n    const result = fn(input);\n    if (result instanceof Promise) {\n      return result;\n    }\n    return {\n      then(onFulfilled) {\n        return toThenable(onFulfilled)(result);\n      },\n      catch(_onRejected) {\n        return this;\n      }\n    };\n  } catch (e) {\n    return {\n      then(_onFulfilled) {\n        return this;\n      },\n      catch(onRejected) {\n        return toThenable(onRejected)(e);\n      }\n    };\n  }\n};\nconst oldImpl = (config, baseOptions) => (set, get, api) => {\n  let options = {\n    getStorage: () => localStorage,\n    serialize: JSON.stringify,\n    deserialize: JSON.parse,\n    partialize: (state) => state,\n    version: 0,\n    merge: (persistedState, currentState) => ({\n      ...currentState,\n      ...persistedState\n    }),\n    ...baseOptions\n  };\n  let hasHydrated = false;\n  const hydrationListeners = /* @__PURE__ */ new Set();\n  const finishHydrationListeners = /* @__PURE__ */ new Set();\n  let storage;\n  try {\n    storage = options.getStorage();\n  } catch (_e) {\n  }\n  if (!storage) {\n    return config(\n      (...args) => {\n        console.warn(\n          `[zustand persist middleware] Unable to update item '${options.name}', the given storage is currently unavailable.`\n        );\n        set(...args);\n      },\n      get,\n      api\n    );\n  }\n  const thenableSerialize = toThenable(options.serialize);\n  const setItem = () => {\n    const state = options.partialize({ ...get() });\n    let errorInSync;\n    const thenable = thenableSerialize({ state, version: options.version }).then(\n      (serializedValue) => storage.setItem(options.name, serializedValue)\n    ).catch((e) => {\n      errorInSync = e;\n    });\n    if (errorInSync) {\n      throw errorInSync;\n    }\n    return thenable;\n  };\n  const savedSetState = api.setState;\n  api.setState = (state, replace) => {\n    savedSetState(state, replace);\n    void setItem();\n  };\n  const configResult = config(\n    (...args) => {\n      set(...args);\n      void setItem();\n    },\n    get,\n    api\n  );\n  let stateFromStorage;\n  const hydrate = () => {\n    var _a;\n    if (!storage) return;\n    hasHydrated = false;\n    hydrationListeners.forEach((cb) => cb(get()));\n    const postRehydrationCallback = ((_a = options.onRehydrateStorage) == null ? void 0 : _a.call(options, get())) || void 0;\n    return toThenable(storage.getItem.bind(storage))(options.name).then((storageValue) => {\n      if (storageValue) {\n        return options.deserialize(storageValue);\n      }\n    }).then((deserializedStorageValue) => {\n      if (deserializedStorageValue) {\n        if (typeof deserializedStorageValue.version === \"number\" && deserializedStorageValue.version !== options.version) {\n          if (options.migrate) {\n            return options.migrate(\n              deserializedStorageValue.state,\n              deserializedStorageValue.version\n            );\n          }\n          console.error(\n            `State loaded from storage couldn't be migrated since no migrate function was provided`\n          );\n        } else {\n          return deserializedStorageValue.state;\n        }\n      }\n    }).then((migratedState) => {\n      var _a2;\n      stateFromStorage = options.merge(\n        migratedState,\n        (_a2 = get()) != null ? _a2 : configResult\n      );\n      set(stateFromStorage, true);\n      return setItem();\n    }).then(() => {\n      postRehydrationCallback == null ? void 0 : postRehydrationCallback(stateFromStorage, void 0);\n      hasHydrated = true;\n      finishHydrationListeners.forEach((cb) => cb(stateFromStorage));\n    }).catch((e) => {\n      postRehydrationCallback == null ? void 0 : postRehydrationCallback(void 0, e);\n    });\n  };\n  api.persist = {\n    setOptions: (newOptions) => {\n      options = {\n        ...options,\n        ...newOptions\n      };\n      if (newOptions.getStorage) {\n        storage = newOptions.getStorage();\n      }\n    },\n    clearStorage: () => {\n      storage == null ? void 0 : storage.removeItem(options.name);\n    },\n    getOptions: () => options,\n    rehydrate: () => hydrate(),\n    hasHydrated: () => hasHydrated,\n    onHydrate: (cb) => {\n      hydrationListeners.add(cb);\n      return () => {\n        hydrationListeners.delete(cb);\n      };\n    },\n    onFinishHydration: (cb) => {\n      finishHydrationListeners.add(cb);\n      return () => {\n        finishHydrationListeners.delete(cb);\n      };\n    }\n  };\n  hydrate();\n  return stateFromStorage || configResult;\n};\nconst newImpl = (config, baseOptions) => (set, get, api) => {\n  let options = {\n    storage: createJSONStorage(() => localStorage),\n    partialize: (state) => state,\n    version: 0,\n    merge: (persistedState, currentState) => ({\n      ...currentState,\n      ...persistedState\n    }),\n    ...baseOptions\n  };\n  let hasHydrated = false;\n  const hydrationListeners = /* @__PURE__ */ new Set();\n  const finishHydrationListeners = /* @__PURE__ */ new Set();\n  let storage = options.storage;\n  if (!storage) {\n    return config(\n      (...args) => {\n        console.warn(\n          `[zustand persist middleware] Unable to update item '${options.name}', the given storage is currently unavailable.`\n        );\n        set(...args);\n      },\n      get,\n      api\n    );\n  }\n  const setItem = () => {\n    const state = options.partialize({ ...get() });\n    return storage.setItem(options.name, {\n      state,\n      version: options.version\n    });\n  };\n  const savedSetState = api.setState;\n  api.setState = (state, replace) => {\n    savedSetState(state, replace);\n    void setItem();\n  };\n  const configResult = config(\n    (...args) => {\n      set(...args);\n      void setItem();\n    },\n    get,\n    api\n  );\n  api.getInitialState = () => configResult;\n  let stateFromStorage;\n  const hydrate = () => {\n    var _a, _b;\n    if (!storage) return;\n    hasHydrated = false;\n    hydrationListeners.forEach((cb) => {\n      var _a2;\n      return cb((_a2 = get()) != null ? _a2 : configResult);\n    });\n    const postRehydrationCallback = ((_b = options.onRehydrateStorage) == null ? void 0 : _b.call(options, (_a = get()) != null ? _a : configResult)) || void 0;\n    return toThenable(storage.getItem.bind(storage))(options.name).then((deserializedStorageValue) => {\n      if (deserializedStorageValue) {\n        if (typeof deserializedStorageValue.version === \"number\" && deserializedStorageValue.version !== options.version) {\n          if (options.migrate) {\n            return [\n              true,\n              options.migrate(\n                deserializedStorageValue.state,\n                deserializedStorageValue.version\n              )\n            ];\n          }\n          console.error(\n            `State loaded from storage couldn't be migrated since no migrate function was provided`\n          );\n        } else {\n          return [false, deserializedStorageValue.state];\n        }\n      }\n      return [false, void 0];\n    }).then((migrationResult) => {\n      var _a2;\n      const [migrated, migratedState] = migrationResult;\n      stateFromStorage = options.merge(\n        migratedState,\n        (_a2 = get()) != null ? _a2 : configResult\n      );\n      set(stateFromStorage, true);\n      if (migrated) {\n        return setItem();\n      }\n    }).then(() => {\n      postRehydrationCallback == null ? void 0 : postRehydrationCallback(stateFromStorage, void 0);\n      stateFromStorage = get();\n      hasHydrated = true;\n      finishHydrationListeners.forEach((cb) => cb(stateFromStorage));\n    }).catch((e) => {\n      postRehydrationCallback == null ? void 0 : postRehydrationCallback(void 0, e);\n    });\n  };\n  api.persist = {\n    setOptions: (newOptions) => {\n      options = {\n        ...options,\n        ...newOptions\n      };\n      if (newOptions.storage) {\n        storage = newOptions.storage;\n      }\n    },\n    clearStorage: () => {\n      storage == null ? void 0 : storage.removeItem(options.name);\n    },\n    getOptions: () => options,\n    rehydrate: () => hydrate(),\n    hasHydrated: () => hasHydrated,\n    onHydrate: (cb) => {\n      hydrationListeners.add(cb);\n      return () => {\n        hydrationListeners.delete(cb);\n      };\n    },\n    onFinishHydration: (cb) => {\n      finishHydrationListeners.add(cb);\n      return () => {\n        finishHydrationListeners.delete(cb);\n      };\n    }\n  };\n  if (!options.skipHydration) {\n    hydrate();\n  }\n  return stateFromStorage || configResult;\n};\nconst persistImpl = (config, baseOptions) => {\n  if (\"getStorage\" in baseOptions || \"serialize\" in baseOptions || \"deserialize\" in baseOptions) {\n    if ((import.meta.env ? import.meta.env.MODE : void 0) !== \"production\") {\n      console.warn(\n        \"[DEPRECATED] `getStorage`, `serialize` and `deserialize` options are deprecated. Use `storage` option instead.\"\n      );\n    }\n    return oldImpl(config, baseOptions);\n  }\n  return newImpl(config, baseOptions);\n};\nconst persist = persistImpl;\n\nexport { combine, createJSONStorage, devtools, persist, redux, subscribeWithSelector };\n","import { create } from \"zustand\";\nimport { dlog } from \"../utils/logger\";\nimport { persist, createJSONStorage } from \"zustand/middleware\";\n\nconst TEST_MODE =\n  process.env.NODE_ENV === \"test\" ||\n  (typeof import.meta !== \"undefined\" &&\n    (import.meta as any).env?.MODE === \"test\");\n\nexport type CameraStreamMode = \"local\" | \"phone\" | \"wifi\";\n\n// CRITICAL: All non-serializable objects kept OUTSIDE state to avoid React #185 error\n// These must NOT be in Zustand state, even though we set them there momentarily\nlet videoElementRefHolder: HTMLVideoElement | null = null;\nlet mediaStreamRefHolder: MediaStream | null = null;\nlet pcRefHolder: RTCPeerConnection | null = null;\nlet wsRefHolder: WebSocket | null = null;\n\n// Prevent UI transitions (like the pre-game overlay mounting/unmounting) from\n// accidentally tearing down the shared stream.\nlet keepAliveCount = 0;\n// Debounce/lock helpers to avoid rapid swaps of the global video element ref\nlet pendingVideoRef: HTMLVideoElement | null = null;\nlet pendingVideoRefTimer: number | null = null;\nconst VIDEO_REF_DEBOUNCE_MS = 200;\n\ntype CameraSessionState = {\n  // Stream state - persists across navigation (ONLY serializable data)\n  isStreaming: boolean;\n  mode: CameraStreamMode;\n  pairingCode: string | null;\n  expiresAt: number | null;\n  isPaired: boolean;\n  mobileUrl: string | null;\n  // UI: whether the floating phone overlay is visible\n  showOverlay: boolean;\n  // Whether camera is currently in a starting state\n  isStarting: boolean;\n\n  // Actions\n  setStreaming: (streaming: boolean) => void;\n  setStarting: (starting: boolean) => void;\n  setMode: (mode: CameraStreamMode) => void;\n  setPairingCode: (code: string | null) => void;\n  setExpiresAt: (time: number | null) => void;\n  setPaired: (paired: boolean) => void;\n  setMobileUrl: (url: string | null) => void;\n  setShowOverlay: (v: boolean) => void;\n\n  // Methods for managing non-serializable refs (not in state)\n  setMediaStream: (stream: MediaStream | null) => void;\n  getMediaStream: () => MediaStream | null;\n  setPcRef: (pc: RTCPeerConnection | null) => void;\n  getPcRef: () => RTCPeerConnection | null;\n  setWsRef: (ws: WebSocket | null) => void;\n  getWsRef: () => WebSocket | null;\n\n  // Get video element ref (not stored in state to avoid serialization)\n  getVideoElementRef: () => HTMLVideoElement | null;\n  setVideoElementRef: (ref: HTMLVideoElement | null) => void;\n\n  // Keep-alive helpers for UI surfaces that briefly mount/unmount\n  acquireKeepAlive: (reason?: string) => void;\n  releaseKeepAlive: (reason?: string) => void;\n\n  // Clear session when user stops camera\n  clearSession: () => void;\n};\n\nexport const useCameraSession = create<CameraSessionState>()(\n  persist(\n    (set) => ({\n      isStreaming: false,\n      mode: \"local\",\n      pairingCode: null,\n      expiresAt: null,\n      isPaired: false,\n      mobileUrl: null,\n      showOverlay: true,\n      isStarting: false,\n\n      setStreaming: (streaming) => {\n        dlog(\"[CAMERA_SESSION] setStreaming:\", streaming);\n        set({ isStreaming: streaming });\n        // If we finished streaming, we are definitely not starting anymore\n        if (streaming) set({ isStarting: false });\n      },\n      setStarting: (starting) => {\n        dlog(\"[CAMERA_SESSION] setStarting:\", starting);\n        set({ isStarting: starting });\n      },\n      setMode: (mode) => {\n        dlog(\"[CAMERA_SESSION] setMode:\", mode);\n        set({ mode });\n      },\n      setPairingCode: (code) => set({ pairingCode: code }),\n      setExpiresAt: (time) => set({ expiresAt: time }),\n      setPaired: (paired) => set({ isPaired: paired }),\n      setMobileUrl: (url) => set({ mobileUrl: url }),\n      setShowOverlay: (v) => set({ showOverlay: !!v }),\n\n      // Non-serializable refs stored outside state\n      setMediaStream: (stream) => {\n        // If the UI is holding a keep-alive, never clear the holder.\n        if (!stream && keepAliveCount > 0) return;\n        mediaStreamRefHolder = stream;\n      },\n      getMediaStream: () => {\n        // Primary: explicit holder\n        if (mediaStreamRefHolder) return mediaStreamRefHolder;\n        // Fallback: if some other component registered a global video element ref\n        // (e.g., the hidden GlobalPhoneVideoSink), use its srcObject.\n        try {\n          const v = videoElementRefHolder;\n          const s = (v?.srcObject as MediaStream | null) || null;\n          if (s) return s;\n        } catch {}\n        return null;\n      },\n\n      setPcRef: (pc) => {\n        pcRefHolder = pc;\n      },\n      getPcRef: () => pcRefHolder,\n\n      setWsRef: (ws) => {\n        wsRefHolder = ws;\n      },\n      getWsRef: () => wsRefHolder,\n\n      // Keep video element ref outside of state to avoid serialization issues\n      getVideoElementRef: () => {\n        const ref = videoElementRefHolder;\n        if (!ref && !TEST_MODE) {\n          dlog(\"[cameraSession]  getVideoElementRef called but ref is NULL\");\n        }\n        return ref;\n      },\n      setVideoElementRef: (ref) => {\n        try {\n          // Immediate clear requests should take effect synchronously so\n          // components unmounting don't lose their cleanup window.\n          if (ref === null) {\n            if (pendingVideoRefTimer) {\n              clearTimeout(pendingVideoRefTimer);\n              pendingVideoRefTimer = null;\n              pendingVideoRef = null;\n            }\n            dlog(\"[cameraSession]  setVideoElementRef called - clearing ref\");\n            videoElementRefHolder = null;\n            return;\n          }\n\n          // If there is no current holder, claim immediately.\n          if (!videoElementRefHolder) {\n            dlog(\n              \"[cameraSession]  setVideoElementRef called - storing HTMLVideoElement\",\n              {\n                tagName: ref.tagName,\n                hasStream: !!ref.srcObject,\n              },\n            );\n            videoElementRefHolder = ref;\n            return;\n          }\n\n          // If the same element is being set again, do nothing.\n          if (videoElementRefHolder === ref) return;\n\n          // Another surface currently holds the global ref. Defer the set by a\n          // small debounce window; if the holder is released soon after, the\n          // pending ref will be applied. This avoids rapid toggles that cause\n          // video.play() AbortError races.\n          if (pendingVideoRefTimer) {\n            clearTimeout(pendingVideoRefTimer);\n            pendingVideoRefTimer = null;\n          }\n          pendingVideoRef = ref;\n          pendingVideoRefTimer = window.setTimeout(() => {\n            try {\n              dlog(\n                \"[cameraSession] (deferred) setVideoElementRef applying pending ref\",\n                {\n                  tagName: pendingVideoRef?.tagName,\n                  hasStream: !!pendingVideoRef?.srcObject,\n                },\n              );\n              videoElementRefHolder = pendingVideoRef;\n            } catch (e) {\n              dlog(\"[cameraSession] Failed to apply pending video ref:\", e);\n            } finally {\n              pendingVideoRef = null;\n              pendingVideoRefTimer = null;\n            }\n          }, VIDEO_REF_DEBOUNCE_MS as any) as any;\n        } catch (e) {\n          dlog(\"[cameraSession] setVideoElementRef error:\", e);\n        }\n      },\n\n      acquireKeepAlive: (_reason?: string) => {\n        keepAliveCount += 1;\n      },\n      releaseKeepAlive: (_reason?: string) => {\n        keepAliveCount = Math.max(0, keepAliveCount - 1);\n      },\n\n      clearSession: () => {\n        // If a UI surface is currently asking us to keep the stream alive\n        // (e.g., pre-game overlay), don't clear shared refs.\n        if (keepAliveCount === 0) {\n          videoElementRefHolder = null;\n          mediaStreamRefHolder = null;\n        }\n        pcRefHolder = null;\n        wsRefHolder = null;\n        set({\n          isStreaming: false,\n          pairingCode: null,\n          expiresAt: null,\n          isPaired: false,\n          mobileUrl: null,\n          // Keep overlay state; do not forcibly hide on clear so user choice persists\n        });\n      },\n    }),\n    {\n      name: \"ndn-camera-session\",\n      storage: createJSONStorage(() => localStorage),\n      // ONLY persist serializable primitives\n      partialize: (state) => ({\n        isStreaming: state.isStreaming,\n        mode: state.mode,\n        pairingCode: state.pairingCode,\n        expiresAt: state.expiresAt,\n        isPaired: state.isPaired,\n        mobileUrl: state.mobileUrl,\n        showOverlay: state.showOverlay,\n      }),\n    },\n  ),\n);\n","// Vision and calibration utilities for dartboard mapping\n// Standard dartboard: 18 inches (457.2 mm) outer diameter\n// Board dimensions follow standard measurements (millimeters)\n// - Inner bull radius: 6.35 mm (12.7 mm diameter)\n// - Outer bull radius: 15.9 mm (31.8 mm diameter)\n// - Treble inner radius: 99 mm\n// - Treble outer radius: 107 mm\n// - Double inner radius: 162 mm\n// - Double outer radius: 170 mm (playing field outer edge = 340 mm diameter)\n\nexport type Point = { x: number; y: number };\nexport type Homography = [\n  number,\n  number,\n  number,\n  number,\n  number,\n  number,\n  number,\n  number,\n  number,\n]; // row-major 3x3\n\nexport const BoardRadii = {\n  bullInner: 6.35,\n  bullOuter: 15.9,\n  trebleInner: 99,\n  trebleOuter: 107,\n  doubleInner: 162,\n  doubleOuter: 170,\n};\n\nexport const CalibrationGuideRadii = BoardRadii;\n\nexport const SectorOrder = [\n  20, 1, 18, 4, 13, 6, 10, 15, 2, 17, 3, 19, 7, 16, 8, 11, 14, 9, 12, 5,\n];\n\n// Basic 3x3 matrix operations\nexport function matMul3(a: Homography, b: Homography): Homography {\n  const r = new Array(9).fill(0);\n  for (let i = 0; i < 3; i++) {\n    for (let j = 0; j < 3; j++) {\n      for (let k = 0; k < 3; k++) {\n        r[i * 3 + j] += a[i * 3 + k] * b[k * 3 + j];\n      }\n    }\n  }\n  return r as Homography;\n}\n\nexport function applyHomography(H: Homography, p: Point): Point {\n  const x = p.x,\n    y = p.y;\n  const w = H[6] * x + H[7] * y + H[8];\n  const nx = (H[0] * x + H[1] * y + H[2]) / w;\n  const ny = (H[3] * x + H[4] * y + H[5]) / w;\n  return { x: nx, y: ny };\n}\n\n// Scale a homography by sx, sy on the destination/image side: H' = S * H\n// Where S = diag([sx, sy, 1])\nexport function scaleHomography(\n  H: Homography,\n  sx: number,\n  sy: number,\n): Homography {\n  return [\n    sx * H[0],\n    sx * H[1],\n    sx * H[2],\n    sy * H[3],\n    sy * H[4],\n    sy * H[5],\n    H[6],\n    H[7],\n    H[8],\n  ] as Homography;\n}\n\n// Rotate a homography around the board center by angle (in radians, counter-clockwise)\n// Creates a rotation matrix R and applies it: H' = R * H\nexport function rotateHomography(\n  H: Homography,\n  angleRadians: number,\n): Homography {\n  const cos = Math.cos(angleRadians);\n  const sin = Math.sin(angleRadians);\n  // Rotation matrix R = [cos -sin 0; sin cos 0; 0 0 1]\n  const R: Homography = [cos, -sin, 0, sin, cos, 0, 0, 0, 1];\n  // We want to rotate the board coordinates before applying the homography\n  // so the correct composition is H' = H * R (rotate board, then map to image).\n  // Applying R on the left (R * H) would instead rotate the image space.\n  return matMul3(H, R);\n}\n\n// Translate a homography on the destination/image side by (tx, ty): H' = T * H\n// Where T = [1 0 tx; 0 1 ty; 0 0 1]\nexport function translateHomography(\n  H: Homography,\n  tx: number,\n  ty: number,\n): Homography {\n  const T: Homography = [1, 0, tx, 0, 1, ty, 0, 0, 1];\n  return matMul3(T, H);\n}\n\nexport function invertHomography(H: Homography): Homography {\n  // Inverse of 3x3 matrix\n  const m = H;\n  const a = m[0],\n    b = m[1],\n    c = m[2],\n    d = m[3],\n    e = m[4],\n    f = m[5],\n    g = m[6],\n    h = m[7],\n    i = m[8];\n  const A = e * i - f * h;\n  const B = c * h - b * i;\n  const C = b * f - c * e;\n  const D = f * g - d * i;\n  const E = a * i - c * g;\n  const F = c * d - a * f;\n  const G = d * h - e * g;\n  const Hh = b * g - a * h;\n  const I = a * e - b * d;\n  const det = a * A + b * D + c * G;\n  if (Math.abs(det) < 1e-12) throw new Error(\"Singular homography\");\n  const inv = [\n    A / det,\n    B / det,\n    C / det,\n    D / det,\n    E / det,\n    F / det,\n    G / det,\n    Hh / det,\n    I / det,\n  ] as Homography;\n  return inv;\n}\n\n// Compute homography H that maps src (board space) -> dst (image space)\n// Using N correspondences via DLT (solved by Gaussian elimination) with least-squares fit\n// Supports overdetermined systems (N > 4) for improved accuracy\nexport function computeHomographyDLT(src: Point[], dst: Point[]): Homography {\n  if (src.length < 4 || dst.length < 4)\n    throw new Error(\"Need at least 4 correspondences\");\n  if (src.length !== dst.length)\n    throw new Error(\"Correspondences must have equal length\");\n  // Build A * h = b where h = [h11 h12 h13 h21 h22 h23 h31 h32]^T and h33 = 1\n  const A: number[][] = [];\n  const B: number[] = [];\n  for (let k = 0; k < src.length; k++) {\n    const { x: X, y: Y } = src[k];\n    const { x: x, y: y } = dst[k];\n    // x = (h11 X + h12 Y + h13) / (h31 X + h32 Y + 1)\n    // y = (h21 X + h22 Y + h23) / (h31 X + h32 Y + 1)\n    // => x*(h31 X + h32 Y + 1) = h11 X + h12 Y + h13\n    // => y*(h31 X + h32 Y + 1) = h21 X + h22 Y + h23\n    A.push([X, Y, 1, 0, 0, 0, -x * X, -x * Y]);\n    B.push(x);\n    A.push([0, 0, 0, X, Y, 1, -y * X, -y * Y]);\n    B.push(y);\n  }\n  const h = solveLeastSquares(A, B); // length 8\n  const H: Homography = [h[0], h[1], h[2], h[3], h[4], h[5], h[6], h[7], 1];\n  return H;\n}\n\n// Solve A x = b in least squares sense using Gaussian elimination with partial pivoting\nfunction solveLeastSquares(A: number[][], b: number[]): number[] {\n  // Normal equations: (A^T A) x = A^T b\n  const m = A.length,\n    n = A[0].length;\n  const AtA: number[][] = Array.from({ length: n }, () => new Array(n).fill(0));\n  const Atb: number[] = new Array(n).fill(0);\n  for (let r = 0; r < m; r++) {\n    for (let i = 0; i < n; i++) {\n      Atb[i] += A[r][i] * b[r];\n      for (let j = 0; j < n; j++) {\n        AtA[i][j] += A[r][i] * A[r][j];\n      }\n    }\n  }\n  return gaussianSolve(AtA, Atb);\n}\n\nfunction gaussianSolve(M: number[][], v: number[]): number[] {\n  const n = v.length;\n  // Augment matrix\n  const A = M.map((row, i) => row.concat([v[i]]));\n  for (let i = 0; i < n; i++) {\n    // Pivot\n    let maxRow = i;\n    for (let r = i + 1; r < n; r++) {\n      if (Math.abs(A[r][i]) > Math.abs(A[maxRow][i])) maxRow = r;\n    }\n    if (Math.abs(A[maxRow][i]) < 1e-12) throw new Error(\"Singular matrix\");\n    if (maxRow !== i) {\n      const tmp = A[i];\n      A[i] = A[maxRow];\n      A[maxRow] = tmp;\n    }\n    // Eliminate\n    for (let r = i + 1; r < n; r++) {\n      const f = A[r][i] / A[i][i];\n      for (let c = i; c <= n; c++) A[r][c] -= f * A[i][c];\n    }\n  }\n  // Back substitution\n  const x = new Array(n).fill(0);\n  for (let i = n - 1; i >= 0; i--) {\n    let s = A[i][n];\n    for (let c = i + 1; c < n; c++) s -= A[i][c] * x[c];\n    x[i] = s / A[i][i];\n  }\n  return x;\n}\n\n// Canonical calibration targets in board space (mm)\n// We now anchor the homography with four evenly spaced double-ring sectors:\n// D20 (top), D6 (right), D3 (bottom), D11 (left), plus bullseye (center).\nexport function canonicalRimTargets(\n  mode: \"center\" | \"outer\" = \"center\",\n): Point[] {\n  // Target the CENTER of the double ring (166mm radius)\n  // This is more stable than the outer edge and ensures the point is\n  // clearly within the double segment, avoiding the outer light ring.\n  const radius =\n    mode === \"outer\"\n      ? (BoardRadii.doubleInner + BoardRadii.doubleOuter) / 2 // 166mm - center of double ring\n      : (BoardRadii.doubleInner + BoardRadii.doubleOuter) / 2;\n  const targetSectors = [20, 6, 3, 11] as const;\n  const rimPoints = targetSectors.map((sector) => {\n    const idx = SectorOrder.indexOf(sector);\n    const angle = (idx / SectorOrder.length) * Math.PI * 2 - Math.PI / 2;\n    const x = radius * Math.cos(angle);\n    const y = radius * Math.sin(angle);\n    return {\n      x: Math.abs(x) < 1e-9 ? 0 : x,\n      y: Math.abs(y) < 1e-9 ? 0 : y,\n    };\n  });\n  // Add bullseye (center) as 5th calibration point\n  rimPoints.push({ x: 0, y: 0 });\n  return rimPoints;\n}\n\n// Given a homography mapping board->image, produce polylines for overlay rings (in image px)\nexport function sampleRing(\n  H: Homography,\n  radius: number,\n  steps = 256,\n): Point[] {\n  const pts: Point[] = [];\n  for (let k = 0; k < steps; k++) {\n    const theta = (k / steps) * Math.PI * 2;\n    const p = applyHomography(H, {\n      x: radius * Math.cos(theta),\n      y: radius * Math.sin(theta),\n    });\n    pts.push(p);\n  }\n  return pts;\n}\n\n// Estimate sectorOffset from a calibrated homography so that sector 20 aligns to the image \"top\".\n// We measure the image-space angle from the mapped board center to the mapped D20 mid-point\n// and convert that angular discrepancy into an integer sector offset in steps of 18 degrees.\nexport function estimateSectorOffsetFromHomography(\n  H: Homography,\n  mode: \"center\" | \"outer\" = \"outer\",\n): number {\n  // Board-space center and D20 mid-point\n  const centerImg = applyHomography(H, { x: 0, y: 0 });\n  const radius =\n    mode === \"outer\"\n      ? BoardRadii.doubleOuter\n      : (BoardRadii.doubleInner + BoardRadii.doubleOuter) / 2;\n  const d20Board = { x: 0, y: -radius }; // -Y points to top (sector 20 center)\n  const d20Img = applyHomography(H, d20Board);\n  const vx = d20Img.x - centerImg.x;\n  const vy = d20Img.y - centerImg.y;\n  // Image-space angle: atan2(y, x) in degrees, normalized to [0, 360)\n  let degImg = (Math.atan2(vy, vx) * 180) / Math.PI;\n  degImg = (degImg + 360) % 360;\n  // Desired top direction is -Y, which is 270 degrees in image atan2 convention\n  const desiredTop = 270; // degrees\n  let delta = degImg - desiredTop; // positive if rotated clockwise relative to desired top\n  // Normalize delta to [-180, 180)\n  delta = ((delta + 180) % 360) - 180;\n  // Convert angular delta to nearest sector steps (18 degrees per sector)\n  const offset = Math.round(delta / 18);\n  // Ensure offset in [0, 19] for consistency\n  return ((offset % 20) + 20) % 20;\n}\n\nexport function rmsError(H: Homography, src: Point[], dst: Point[]): number {\n  let e2 = 0;\n  for (let i = 0; i < src.length; i++) {\n    const p = applyHomography(H, src[i]);\n    const dx = p.x - dst[i].x;\n    const dy = p.y - dst[i].y;\n    e2 += dx * dx + dy * dy;\n  }\n  return Math.sqrt(e2 / src.length);\n}\n\nexport interface RansacOptions {\n  thresholdPx?: number; // reprojection error threshold\n  maxIter?: number;\n  minInliers?: number;\n  rng?: () => number; // optional RNG for deterministic tests\n}\n\n// Robust homography estimation using RANSAC. Returns best H, inlier mask and inlier RMS error.\nexport function ransacHomography(\n  src: Point[],\n  dst: Point[],\n  opts: RansacOptions = {},\n): { H: Homography | null; inliers: boolean[]; errorPx: number | null } {\n  const n = src.length;\n  if (n < 4 || dst.length < 4)\n    throw new Error(\"Need at least 4 correspondences\");\n  const threshold = opts.thresholdPx ?? 8;\n  const maxIter = opts.maxIter ?? 500;\n  const minInliers = opts.minInliers ?? 4;\n  const rng = opts.rng ?? Math.random;\n\n  let bestH: Homography | null = null;\n  let bestInliers: boolean[] = new Array(n).fill(false);\n  let bestCount = 0;\n  let bestError = Infinity;\n\n  for (let iter = 0; iter < maxIter; iter++) {\n    // pick 4 unique indices\n    const idxs = new Set<number>();\n    while (idxs.size < 4) {\n      idxs.add(Math.floor(rng() * n));\n    }\n    const chosen = Array.from(idxs);\n    const ssub: Point[] = [];\n    const dsub: Point[] = [];\n    for (const i of chosen) {\n      ssub.push(src[i]);\n      dsub.push(dst[i]);\n    }\n    let Htry: Homography;\n    try {\n      Htry = computeHomographyDLT(ssub, dsub);\n    } catch (e) {\n      continue; // singular or invalid, skip\n    }\n\n    // Count inliers\n    const inliers = new Array(n).fill(false);\n    let count = 0;\n    for (let i = 0; i < n; i++) {\n      const p = applyHomography(Htry, src[i]);\n      const dx = p.x - dst[i].x;\n      const dy = p.y - dst[i].y;\n      const dist = Math.hypot(dx, dy);\n      if (dist <= threshold) {\n        inliers[i] = true;\n        count++;\n      }\n    }\n\n    if (count < minInliers) continue;\n\n    // Recompute H using all inliers for better fit\n    const sIn: Point[] = [];\n    const dIn: Point[] = [];\n    for (let i = 0; i < n; i++) {\n      if (inliers[i]) {\n        sIn.push(src[i]);\n        dIn.push(dst[i]);\n      }\n    }\n    let Hrefined: Homography;\n    try {\n      Hrefined = computeHomographyDLT(sIn, dIn);\n    } catch (e) {\n      continue;\n    }\n    const err = rmsError(Hrefined, sIn, dIn);\n\n    // Choose better by inlier count first, then lower error\n    if (count > bestCount || (count === bestCount && err < bestError)) {\n      bestCount = count;\n      bestError = err;\n      bestH = Hrefined;\n      bestInliers = inliers.slice();\n    }\n  }\n\n  if (!bestH || bestCount < minInliers)\n    return { H: null, inliers: new Array(n).fill(false), errorPx: null };\n\n  // Compute final error over inliers\n  const sFin: Point[] = [];\n  const dFin: Point[] = [];\n  for (let i = 0; i < n; i++) {\n    if (bestInliers[i]) {\n      sFin.push(src[i]);\n      dFin.push(dst[i]);\n    }\n  }\n  const finalError = sFin.length > 0 ? rmsError(bestH, sFin, dFin) : null;\n  return { H: bestH, inliers: bestInliers, errorPx: finalError };\n}\n\n// Map an image point to board coordinates using inverse homography (image->board)\n// Returns null if the homography cannot be inverted (singular matrix)\nexport function imageToBoard(\n  H_boardToImage: Homography,\n  pImg: Point,\n): Point | null {\n  try {\n    const inv = invertHomography(H_boardToImage);\n    const result = applyHomography(inv as Homography, pImg);\n    // Validate that the result is finite (not NaN or Infinity)\n    if (!isFinite(result.x) || !isFinite(result.y)) {\n      return null;\n    }\n    return result;\n  } catch (e) {\n    return null;\n  }\n}\n\n// Compute score for a board coordinate (mm)\nexport function scoreAtBoardPoint(p: Point): {\n  base: number;\n  ring: \"MISS\" | \"SINGLE\" | \"DOUBLE\" | \"TRIPLE\" | \"BULL\" | \"INNER_BULL\";\n  sector: number | null;\n  mult: 0 | 1 | 2 | 3;\n} {\n  const r = Math.hypot(p.x, p.y);\n  const ang = Math.atan2(p.y, p.x); // 0 rad at +X, increasing CCW\n  // Rotate so that sector 20 is at the top (negative Y). Top corresponds to -90 degrees (or 270)\n  let deg = (ang * 180) / Math.PI;\n  deg = (deg + 360 + 90) % 360; // shift so 0 deg is at top\n\n  // Shift by half a sector (9 degrees) to align boundaries.\n  // Sector 20 is centered at 0 deg, spanning -9 to +9.\n  // Adding 9 maps [-9, 9] to [0, 18], which floor divides to index 0.\n  const index = Math.floor(((deg + 9) % 360) / 18);\n  const sector = SectorOrder[index];\n\n  // Standard dartboard dimensions (mm)\n  const {\n    bullInner,\n    bullOuter,\n    trebleInner,\n    trebleOuter,\n    doubleInner,\n    doubleOuter,\n  } = BoardRadii;\n\n  // Apply minimal tolerance for wire-shots (0.75mm is approx half a wire width)\n  const tol = 0.75;\n  // Use a more generous tolerance for the board's outer edge to prevent\n  // calibration drift from rejecting valid double-drifts as MISS.\n  const outerTol = 6.0;\n\n  // Outside board edge\n  if (r > doubleOuter + outerTol)\n    return { base: 0, ring: \"MISS\", sector: null, mult: 0 };\n\n  // Double band\n  if (r >= doubleInner - tol)\n    return { base: sector * 2, ring: \"DOUBLE\", sector, mult: 2 };\n\n  // Single outer band\n  if (r > trebleOuter + tol)\n    return { base: sector, ring: \"SINGLE\", sector, mult: 1 };\n\n  // Treble band\n  if (r >= trebleInner - tol)\n    return { base: sector * 3, ring: \"TRIPLE\", sector, mult: 3 };\n\n  // Single inner band\n  if (r > bullOuter + tol)\n    return { base: sector, ring: \"SINGLE\", sector, mult: 1 };\n\n  // Bulls\n  if (r > bullInner + 0.5)\n    return { base: 25, ring: \"BULL\", sector: 25, mult: 1 };\n\n  return { base: 50, ring: \"INNER_BULL\", sector: 25, mult: 2 };\n}\n\n// Orientation-aware scoring: add theta (radians) to angle before sector mapping\nexport function scoreAtBoardPointTheta(\n  p: Point,\n  theta: number,\n  sectorOffset: number = 0,\n  rotationOffsetRad: number = 0,\n): {\n  base: number;\n  ring: \"MISS\" | \"SINGLE\" | \"DOUBLE\" | \"TRIPLE\" | \"BULL\" | \"INNER_BULL\";\n  sector: number | null;\n  mult: 0 | 1 | 2 | 3;\n} {\n  const r = Math.hypot(p.x, p.y);\n  const ang =\n    Math.atan2(p.y, p.x) +\n    (Number.isFinite(theta) ? theta : 0) +\n    (Number.isFinite(rotationOffsetRad) ? rotationOffsetRad : 0);\n  let deg = (ang * 180) / Math.PI;\n  deg = (deg + 360 + 90) % 360;\n  const index = Math.floor(((deg + 9) % 360) / 18);\n  const correctedIndex =\n    (((index + (Number.isFinite(sectorOffset) ? sectorOffset : 0)) % 20) + 20) %\n    20;\n  const sector = SectorOrder[correctedIndex];\n\n  // Standard dartboard dimensions (mm)\n  const {\n    bullInner,\n    bullOuter,\n    trebleInner,\n    trebleOuter,\n    doubleInner,\n    doubleOuter,\n  } = BoardRadii;\n\n  // Apply minimal tolerance for wire-shots\n  const tol = 0.75;\n\n  if (r > doubleOuter + tol)\n    return { base: 0, ring: \"MISS\", sector: null, mult: 0 };\n\n  if (r >= doubleInner - tol)\n    return { base: sector * 2, ring: \"DOUBLE\", sector, mult: 2 };\n\n  if (r > trebleOuter + tol)\n    return { base: sector, ring: \"SINGLE\", sector, mult: 1 };\n\n  if (r >= trebleInner - tol)\n    return { base: sector * 3, ring: \"TRIPLE\", sector, mult: 3 };\n\n  if (r > bullOuter + tol)\n    return { base: sector, ring: \"SINGLE\", sector, mult: 1 };\n\n  if (r > bullInner + 0.5)\n    return { base: 25, ring: \"BULL\", sector: 25, mult: 1 };\n\n  return { base: 50, ring: \"INNER_BULL\", sector: 25, mult: 2 };\n}\n\n// Check if a point is actually on the dartboard (within valid playing area)\nexport function isPointOnBoard(p: Point): boolean {\n  const r = Math.hypot(p.x, p.y);\n  // A point is on the board if it's within the double outer radius (the edge of the board)\n  // No margin - we want strict checking to ensure darts are actually on the board\n  return r <= BoardRadii.doubleOuter;\n}\n\nexport function drawPolyline(\n  ctx: CanvasRenderingContext2D,\n  pts: Point[],\n  color = \"#10b981\",\n  width = 2,\n) {\n  if (!pts.length) return;\n  ctx.save();\n  ctx.strokeStyle = color;\n  ctx.lineWidth = width;\n  ctx.beginPath();\n  ctx.moveTo(pts[0].x, pts[0].y);\n  for (let i = 1; i < pts.length; i++) ctx.lineTo(pts[i].x, pts[i].y);\n  ctx.closePath();\n  ctx.stroke();\n  ctx.restore();\n}\n\nexport function drawCross(\n  ctx: CanvasRenderingContext2D,\n  p: Point,\n  color = \"#f59e0b\",\n) {\n  ctx.save();\n  ctx.strokeStyle = color;\n  ctx.lineWidth = 2;\n  ctx.beginPath();\n  ctx.moveTo(p.x - 8, p.y);\n  ctx.lineTo(p.x + 8, p.y);\n  ctx.moveTo(p.x, p.y - 8);\n  ctx.lineTo(p.x, p.y + 8);\n  ctx.stroke();\n  ctx.restore();\n}\n\n// --- Point refinement using Sobel gradient ---\nfunction clamp(v: number, lo: number, hi: number) {\n  return Math.max(lo, Math.min(hi, v));\n}\n\nfunction sobelAtGray(img: ImageData, x: number, y: number): number {\n  const { width, data } = img;\n  // Sobel kernels\n  const gx = [\n    [-1, 0, 1],\n    [-2, 0, 2],\n    [-1, 0, 1],\n  ];\n  const gy = [\n    [-1, -2, -1],\n    [0, 0, 0],\n    [1, 2, 1],\n  ];\n  let sx = 0,\n    sy = 0;\n  for (let j = -1; j <= 1; j++) {\n    for (let i = -1; i <= 1; i++) {\n      const xi = clamp(x + i, 0, width - 1);\n      const yi = clamp(y + j, 0, img.height - 1);\n      const idx = (yi * width + xi) * 4;\n      const r = data[idx],\n        g = data[idx + 1],\n        b = data[idx + 2];\n      const gray = 0.299 * r + 0.587 * g + 0.114 * b;\n      sx += gray * gx[j + 1][i + 1];\n      sy += gray * gy[j + 1][i + 1];\n    }\n  }\n  return Math.hypot(sx, sy);\n}\n\nexport function refinePointSobel(\n  canvas: HTMLCanvasElement,\n  p: Point,\n  radius = 6,\n): Point {\n  const ctx = canvas.getContext(\"2d\")!;\n  const img = ctx.getImageData(0, 0, canvas.width, canvas.height);\n  const cx = clamp(Math.round(p.x), 1, canvas.width - 2);\n  const cy = clamp(Math.round(p.y), 1, canvas.height - 2);\n  let best = { x: cx, y: cy, mag: -1 };\n  for (let y = cy - radius; y <= cy + radius; y++) {\n    for (let x = cx - radius; x <= cx + radius; x++) {\n      if (x <= 0 || y <= 0 || x >= canvas.width - 1 || y >= canvas.height - 1)\n        continue;\n      const mag = sobelAtGray(img, x, y);\n      if (mag > best.mag) best = { x, y, mag };\n    }\n  }\n  return { x: best.x, y: best.y };\n}\n\nexport function refinePointsSobel(\n  canvas: HTMLCanvasElement,\n  pts: Point[],\n  radius = 6,\n): Point[] {\n  return pts.map((p) => refinePointSobel(canvas, p, radius));\n}\n\n// Detect board orientation (theta) from calibration homography\n// The board has 4 calibration points on the double ring at sectors 20, 6, 3, 11 (top, right, bottom, left)\n// If the camera is rotated, these sectors will appear at different angles than expected\n// Returns theta in radians that can be used to correct sector calculations\nexport function detectBoardOrientation(\n  H: Homography,\n  canonicalTargets: Point[],\n): number {\n  // Get the 4 double ring points (indices 0-3)\n  // In canonical orientation: index 0 = 20 (top), 1 = 6 (right), 2 = 3 (bottom), 3 = 11 (left)\n  const rimPoints = canonicalTargets.slice(0, 4);\n\n  // Map each board-space rim point to image space via homography\n  const imagePoints = rimPoints.map((p) => applyHomography(H, p));\n\n  // Compute the center of the points in image space\n  const centerX =\n    imagePoints.reduce((sum, p) => sum + p.x, 0) / imagePoints.length;\n  const centerY =\n    imagePoints.reduce((sum, p) => sum + p.y, 0) / imagePoints.length;\n\n  // Compute angles of each point relative to center in image space\n  // The first point (canonical 20, top) should be at angle -/2 (negative Y)\n  const expectedAngles = [-Math.PI / 2, 0, Math.PI / 2, Math.PI];\n  const actualAngles = imagePoints.map((p) =>\n    Math.atan2(p.y - centerY, p.x - centerX),\n  );\n\n  // Compute the rotation needed to align actual with expected\n  // Use the first point as reference (it's the most consistent)\n  let theta = expectedAngles[0] - actualAngles[0];\n\n  // Normalize theta to [-, ]\n  while (theta > Math.PI) theta -= 2 * Math.PI;\n  while (theta < -Math.PI) theta += 2 * Math.PI;\n\n  return theta;\n}\n\n// Convert theta (radians) to human-readable degrees for UI display\nexport function thetaToDegrees(theta: number | null): number {\n  if (theta === null) return 0;\n  return -(theta * 180) / Math.PI; // Negate because positive theta is CCW in math, but users think CW\n}\n","// Minimal marker calibration utilities retained for test compatibility\n// Provides tiny helpers to convert marker IDs to 7x7 bit-grid matrices\n// and simple canonical marker order + targets used by the calibrator tests.\n\nexport const MARKER_ORDER = [\"top\", \"right\", \"bottom\", \"left\", \"bull\"] as const;\n\n// Provide deterministic 10-bit IDs for the five targets. These are arbitrary\n// but stable values used only in tests and calibration placeholder logic.\nexport const MARKER_TARGETS: Record<string, number> &\n  Record<(typeof MARKER_ORDER)[number], number> = {\n  top: 0b0001100011, // 195\n  right: 0b0010011010, // 154\n  bottom: 0b0011110001, // 241\n  left: 0b0001010101, // 85\n  bull: 0b0000000000, // 0 - bull uses all zeros\n};\n\n// Convert the 10-bit id into a 7x7 grid where the outer border is zeros\n// and the central 5x5 encodes the id using columns 2 and 4 as data columns.\nexport function markerIdToMatrix(id: number): number[][] {\n  const grid: number[][] = Array.from({ length: 7 }, () =>\n    Array.from({ length: 7 }, () => 0),\n  );\n  // Extract 10 bits MSB -> LSB\n  const bits: number[] = [];\n  for (let i = 9; i >= 0; i--) {\n    bits.push((id >> i) & 1);\n  }\n  // Fill into rows 1..5 columns 2 and 4\n  for (let r = 0; r < 5; r++) {\n    const rowIdx = r + 1;\n    const bitA = bits[2 * r] ?? 0; // MSB first\n    const bitB = bits[2 * r + 1] ?? 0;\n    grid[rowIdx][2] = bitA;\n    grid[rowIdx][4] = bitB;\n  }\n  return grid;\n}\n\nexport default {};\n\nexport type MarkerDetection = {\n  success: boolean;\n  homography: any | null;\n  points: Array<{ x: number; y: number }>;\n  errorPx?: number | null;\n  markerSize?: number;\n  markersFound: Array<{ id: number; x: number; y: number }>;\n  missing: string[];\n  message: string;\n};\n\nexport function detectMarkersFromCanvas(_canvas: any): MarkerDetection {\n  return {\n    success: false,\n    homography: null,\n    points: [],\n    errorPx: null,\n    markersFound: [],\n    missing: [],\n    message: \"Marker detection not available\",\n  };\n}\n","/**\n * Game-Mode-Specific Calibration Requirements\n *\n * Each game mode has different accuracy requirements:\n * - X01: Needs all zones (singles, doubles, trebles, bulls)\n * - Cricket: Only needs 6 numbers + bullseye\n * - Treble Practice: Only needs treble ring (strictest)\n * - Checkout modes: Need double precision\n */\n\nexport type CalibrationRequirement = {\n  tolerancePx: number; // Maximum acceptable error in pixels\n  requiredTargets: string[]; // Key areas needed for this game\n  criticalZones: string[]; // Most important areas to focus on during calibration\n  minConfidence: number; // Minimum acceptable calibration confidence (0-100)\n};\n\nexport function getGlobalCalibrationConfidence(\n  errorPx: number | null,\n): number | null {\n  if (errorPx == null || Number.isNaN(errorPx as any) || errorPx < 0) {\n    return null;\n  }\n\n  let percentage: number;\n  if (errorPx <= 0.25) percentage = 99.5 + (0.25 - errorPx) * 2;\n  else if (errorPx <= 1.0) percentage = 98 + (1.0 - errorPx) * 2;\n  else if (errorPx <= 2.0) percentage = 95 + (2.0 - errorPx) * 3;\n  else if (errorPx <= 5.0) percentage = 90 + (5.0 - errorPx) * 1.66;\n  else percentage = Math.max(0, 90 - (errorPx - 5) * 5);\n\n  const clamped = Math.max(0, Math.min(100, percentage));\n  return Number(clamped.toFixed(1));\n}\n\nexport const GAME_CALIBRATION_REQUIREMENTS: Record<\n  string,\n  CalibrationRequirement\n> = {\n  // Free Games\n  X01: {\n    tolerancePx: 10,\n    requiredTargets: [\"SINGLE\", \"DOUBLE\", \"TREBLE\", \"BULL\", \"OUTER_BULL\"],\n    criticalZones: [\"D20\", \"D1\", \"BULLSEYE\", \"T20\", \"SINGLE_20\"],\n    minConfidence: 80,\n  },\n  \"Double Practice\": {\n    tolerancePx: 12,\n    requiredTargets: [\"DOUBLE\", \"BULL\"],\n    criticalZones: [\"D20\", \"D1\", \"D6\", \"D17\"],\n    minConfidence: 75,\n  },\n\n  // Premium - Accuracy Critical\n  \"Treble Practice\": {\n    tolerancePx: 8, // Strictest requirement\n    requiredTargets: [\"TREBLE\"],\n    criticalZones: [\"T20\", \"T1\", \"T5\"],\n    minConfidence: 85,\n  },\n  \"Checkout 170\": {\n    tolerancePx: 9,\n    requiredTargets: [\"DOUBLE\"],\n    criticalZones: [\"D25\", \"D20\", \"D8\"],\n    minConfidence: 82,\n  },\n  \"Checkout 121\": {\n    tolerancePx: 9,\n    requiredTargets: [\"DOUBLE\"],\n    criticalZones: [\"D20\", \"D5\", \"D1\"],\n    minConfidence: 82,\n  },\n\n  // Premium - Target Subset\n  Cricket: {\n    tolerancePx: 15,\n    requiredTargets: [\"20\", \"19\", \"18\", \"17\", \"16\", \"15\", \"BULL\"],\n    criticalZones: [\"20\", \"15\", \"BULL\"],\n    minConfidence: 70,\n  },\n  \"American Cricket\": {\n    tolerancePx: 15,\n    requiredTargets: [\"20\", \"19\", \"18\", \"17\", \"16\", \"15\", \"BULL\"],\n    criticalZones: [\"20\", \"15\", \"BULL\"],\n    minConfidence: 70,\n  },\n\n  // Premium - All Numbers\n  \"Around the Clock\": {\n    tolerancePx: 12,\n    requiredTargets: [\n      \"1\",\n      \"2\",\n      \"3\",\n      \"4\",\n      \"5\",\n      \"6\",\n      \"7\",\n      \"8\",\n      \"9\",\n      \"10\",\n      \"11\",\n      \"12\",\n      \"13\",\n      \"14\",\n      \"15\",\n      \"16\",\n      \"17\",\n      \"18\",\n      \"19\",\n      \"20\",\n    ],\n    criticalZones: [\"1\", \"20\", \"6\", \"15\"],\n    minConfidence: 78,\n  },\n  Shanghai: {\n    tolerancePx: 13,\n    requiredTargets: [\n      \"1\",\n      \"2\",\n      \"3\",\n      \"4\",\n      \"5\",\n      \"6\",\n      \"7\",\n      \"SINGLE\",\n      \"DOUBLE\",\n      \"TREBLE\",\n    ],\n    criticalZones: [\"1\", \"7\", \"S1\", \"D1\", \"T1\"],\n    minConfidence: 75,\n  },\n\n  // Premium - Practice/Training\n  \"High Score\": {\n    tolerancePx: 14,\n    requiredTargets: [\"TREBLE\", \"DOUBLE\", \"BULL\"],\n    criticalZones: [\"T20\", \"BULL\", \"D20\"],\n    minConfidence: 72,\n  },\n  \"Low Score\": {\n    tolerancePx: 11,\n    requiredTargets: [\"SINGLE\"],\n    criticalZones: [\"1\", \"2\", \"3\"],\n    minConfidence: 76,\n  },\n  \"Count-Up\": {\n    tolerancePx: 13,\n    requiredTargets: [\"SINGLE\", \"DOUBLE\", \"TREBLE\"],\n    criticalZones: [\"20\", \"DOUBLE\", \"TREBLE\"],\n    minConfidence: 74,\n  },\n\n  // Premium - Head-to-Head\n  \"Halve It\": {\n    tolerancePx: 12,\n    requiredTargets: [\"TREBLE\", \"SINGLE\"],\n    criticalZones: [\"T20\", \"T5\", \"SINGLE\"],\n    minConfidence: 73,\n  },\n  \"High-Low\": {\n    tolerancePx: 13,\n    requiredTargets: [\"SINGLE\", \"DOUBLE\", \"BULL\"],\n    criticalZones: [\"HIGH (>10)\", \"LOW (<5)\", \"BULL\"],\n    minConfidence: 72,\n  },\n  Killer: {\n    tolerancePx: 12,\n    requiredTargets: [\"ALL_NUMBERS\"],\n    criticalZones: [\"RANDOM_TARGETS\"],\n    minConfidence: 74,\n  },\n\n  // Premium - Skill Games\n  Baseball: {\n    tolerancePx: 14,\n    requiredTargets: [\"1-9\", \"SINGLE\", \"DOUBLE\", \"TREBLE\"],\n    criticalZones: [\"1\", \"9\", \"TRIPLE\"],\n    minConfidence: 71,\n  },\n  Golf: {\n    tolerancePx: 14,\n    requiredTargets: [\"1-18\", \"TREBLE\"],\n    criticalZones: [\"T1\", \"T18\"],\n    minConfidence: 71,\n  },\n  \"Tic Tac Toe\": {\n    tolerancePx: 16,\n    requiredTargets: [\"1-9\", \"SINGLE\"],\n    criticalZones: [\"CENTER\", \"CORNERS\"],\n    minConfidence: 68,\n  },\n\n  // Premium - Variation Games\n  \"Bob's 27\": {\n    tolerancePx: 13,\n    requiredTargets: [\"SINGLE\", \"DOUBLE\"],\n    criticalZones: [\"1-20\", \"BULL\"],\n    minConfidence: 73,\n  },\n  Scam: {\n    tolerancePx: 14,\n    requiredTargets: [\"ALL_NUMBERS\", \"OUTER_BULL\"],\n    criticalZones: [\"TARGET_NUMBER\", \"OUTER_BULL\"],\n    minConfidence: 70,\n  },\n  Fives: {\n    tolerancePx: 14,\n    requiredTargets: [\"ALL_NUMBERS\", \"OUTER_BULL\"],\n    criticalZones: [\"5\", \"10\", \"15\", \"20\"],\n    minConfidence: 70,\n  },\n  Sevens: {\n    tolerancePx: 14,\n    requiredTargets: [\"ALL_NUMBERS\", \"OUTER_BULL\"],\n    criticalZones: [\"7\", \"14\"],\n    minConfidence: 70,\n  },\n};\n\n/**\n * Evaluate calibration quality for a specific game mode\n * Returns confidence level 0-100\n */\nexport function getCalibrationConfidenceForGame(\n  gameMode: string,\n  errorPx: number | null,\n): number {\n  // Treat missing/unknown error as unknown confidence. IMPORTANT: don't treat 0 as falsy.\n  if (errorPx == null || Number.isNaN(errorPx as any) || errorPx < 0) return 0;\n\n  const req = GAME_CALIBRATION_REQUIREMENTS[gameMode];\n  const tolerance = req?.tolerancePx ?? 12; // Default tolerance if game unknown\n\n  // v2.6: High-precision confidence calculation\n  // 0.25px error = 99.5% (User's target)\n  // 1.0px error = 98%\n  // 2.0px error = 95%\n  // 5.0px error = 90%\n  // At tolerance = 85%\n  // Beyond tolerance = drops linearly to 0% at 3x tolerance\n\n  if (errorPx <= 0.25) return 99.5 + (0.25 - errorPx) * 2; // 99.5% to 100%\n  if (errorPx <= 1.0) return 98 + (1.0 - errorPx) * 2; // 98% to 99.5%\n  if (errorPx <= 2.0) return 95 + (2.0 - errorPx) * 3; // 95% to 98%\n  if (errorPx <= 5.0) return 90 + (5.0 - errorPx) * 1.66; // 90% to 95%\n\n  if (errorPx <= tolerance) {\n    // Linear from 90% down to 85% at tolerance\n    const range = tolerance - 5;\n    if (range <= 0) return 85;\n    return 85 + ((tolerance - errorPx) / range) * 5;\n  } else {\n    // Beyond tolerance: drop linearly to 0 at 3x tolerance\n    // This is much less punishing than the previous version\n    const maxError = tolerance * 3;\n    if (errorPx >= maxError) return 0;\n    return 85 * (1 - (errorPx - tolerance) / (maxError - tolerance));\n  }\n}\n\n/**\n * Check if calibration is suitable for a game\n */\nexport function isCalibrationSuitableForGame(\n  gameMode: string,\n  errorPx: number | null,\n): boolean {\n  // Treat missing/unknown error as not suitable. IMPORTANT: don't treat 0 as missing.\n  if (errorPx == null || Number.isNaN(errorPx as any) || errorPx < 0)\n    return false;\n\n  const req = GAME_CALIBRATION_REQUIREMENTS[gameMode];\n  if (!req) return true; // Unknown game, assume suitable\n\n  const confidence = getCalibrationConfidenceForGame(gameMode, errorPx);\n  return confidence >= req.minConfidence;\n}\n\n/**\n * Get a human-readable assessment of calibration quality\n */\nexport function getCalibrationQualityText(\n  gameMode: string,\n  errorPx: number | null,\n): {\n  quality: \"perfect\" | \"excellent\" | \"good\" | \"fair\" | \"poor\" | \"none\";\n  text: string;\n} {\n  // IMPORTANT: don't treat 0 as missing.\n  if (errorPx == null || Number.isNaN(errorPx as any) || errorPx < 0) {\n    return { quality: \"none\", text: \"Camera not connected\" };\n  }\n\n  const confidence = getCalibrationConfidenceForGame(gameMode, errorPx);\n\n  if (confidence >= 99.5) {\n    return {\n      quality: \"perfect\",\n      text: `Perfect (${confidence.toFixed(1)}%)`,\n    };\n  } else if (confidence >= 90) {\n    return {\n      quality: \"excellent\",\n      text: `Excellent (${Math.round(confidence)}%)`,\n    };\n  } else if (confidence >= 75) {\n    return { quality: \"good\", text: `Good (${Math.round(confidence)}%)` };\n  } else if (confidence >= 50) {\n    return { quality: \"fair\", text: `Fair (${Math.round(confidence)}%)` };\n  } else {\n    return { quality: \"poor\", text: `Poor (${Math.round(confidence)}%)` };\n  }\n}\n\nexport type CalibrationStatus = \"verified\" | \"unknown\" | \"none\";\n\n/**\n * Shared, UI-friendly calibration gate.\n *\n * Contract:\n * - verified: has a homography AND an imageSize AND (locked OR errorPx <= maxErrorPx)\n * - unknown: has a homography but is missing quality metrics (imageSize/errorPx)\n * - none: no homography\n */\nexport function getCalibrationStatus(params: {\n  H: any | null | undefined;\n  imageSize?: { w: number; h: number } | null;\n  locked?: boolean | null;\n  errorPx?: number | null;\n  maxErrorPx?: number;\n}): CalibrationStatus {\n  const { H, imageSize, locked, errorPx, maxErrorPx = 12 } = params;\n  if (!H) return \"none\";\n\n  const hasImageSize = !!(\n    imageSize &&\n    typeof imageSize.w === \"number\" &&\n    typeof imageSize.h === \"number\" &&\n    imageSize.w > 0 &&\n    imageSize.h > 0\n  );\n  const errorVal =\n    typeof errorPx === \"number\" && !Number.isNaN(errorPx) ? errorPx : null;\n\n  if (\n    hasImageSize &&\n    (locked || (errorVal != null && errorVal <= maxErrorPx))\n  ) {\n    return \"verified\";\n  }\n  return \"unknown\";\n}\n\n/**\n * Get personalized recalibration recommendation for a game\n */\nexport function getRecalibrationRecommendation(\n  gameMode: string,\n): string | null {\n  const req = GAME_CALIBRATION_REQUIREMENTS[gameMode];\n  if (!req || req.criticalZones.length === 0) return null;\n\n  const zones = req.criticalZones.join(\", \");\n  return `Recalibrate focusing on: ${zones}`;\n}\n\n/**\n * Get all games sorted by calibration difficulty (strictest first)\n */\nexport function getGamesByCalibrationDifficulty(): string[] {\n  return Object.entries(GAME_CALIBRATION_REQUIREMENTS)\n    .sort((a, b) => a[1].tolerancePx - b[1].tolerancePx)\n    .map(([name]) => name);\n}\n","import { create } from \"zustand\";\n// Import logger for side-effects (initialization/patching in some builds)\nimport \"../utils/logger\";\n\ntype LastOffline = {\n  mode: string;\n  x01Start: number;\n  firstTo: number;\n  aiLevel: string;\n};\n\ntype SettingsState = {\n  user?: {\n    username?: string;\n    name?: string;\n    displayName?: string;\n    email?: string;\n  } | null;\n  favoriteDouble: string;\n  callerEnabled: boolean;\n  callerVoice: string; // voice name\n  callerVolume: number; // 0..1\n  speakCheckoutOnly: boolean;\n  avgMode: \"all-time\" | \"24h\";\n  autoStartOffline: boolean;\n  rememberLastOffline: boolean;\n  lastOffline: LastOffline;\n  reducedMotion: boolean;\n  compactHeader: boolean;\n  allowSpectate: boolean;\n  // UI tuning\n  cameraScale: number; // 0.5 .. 2.0\n  cameraAspect?: \"wide\" | \"square\";\n  cameraFitMode?: \"fit\" | \"fill\";\n  // External autoscore provider\n  autoscoreProvider?: \"built-in\" | \"built-in-v2\" | \"external-ws\" | \"manual\";\n  autoscoreWsUrl?: string;\n  autoCommitMode?: \"wait-for-clear\" | \"immediate\";\n  // Autoscore quality gating\n  // If enabled, detections below the threshold must be confirmed by the user.\n  confirmUncertainDarts?: boolean;\n  // 0..1 confidence threshold used by built-in autoscore.\n  autoScoreConfidenceThreshold?: number;\n  // Built-in detector tuning (advanced)\n  // These primarily affect the DartDetector blob segmentation and stability gating.\n  autoscoreDetectorMinArea?: number;\n  autoscoreDetectorThresh?: number;\n  autoscoreDetectorRequireStableN?: number;\n  // Lighting / glare mitigation (optional)\n  harshLightingMode?: boolean;\n  // Visual aid: emphasize big trebles (T20/T19/T18)\n  enhanceBigTrebles?: boolean;\n  // Allow immediate autocommit when playing online/tournaments\n  allowAutocommitInOnline?: boolean;\n  calibrationGuide: boolean;\n  // Use RANSAC-based homography for auto-detection\n  calibrationUseRansac?: boolean;\n  // Preserve calibration overlay display size when calibration is locked\n  preserveCalibrationOverlay: boolean;\n  // When true, don't auto-override the calibration state when camera device changes or auto detection runs\n  preserveCalibrationOnCameraChange: boolean;\n  // Devices & preferences\n  preferredCameraId?: string;\n  preferredCameraLabel?: string;\n  preferredCameraLocked?: boolean;\n  // Camera control\n  cameraEnabled: boolean;\n  hideCameraOverlay: boolean;\n  // Show segment labels (e.g., 'T20') in UI/detection logs. Some users prefer numeric-only.\n  cameraShowLabels?: boolean;\n  // Reduce resolution + processing for lower-latency preview (good for slow devices)\n  cameraLowLatency?: boolean;\n  // Processing FPS used by the detection loop (frames/sec). Lower reduces CPU and latency.\n  cameraProcessingFps?: number;\n  // When true, allow the camera detector to add/record darts automatically.\n  // Some users prefer to use the camera for detection/counting only without\n  // committing darts to visits automatically.\n  cameraRecordDarts?: boolean;\n  ignorePreferredCameraSync: boolean;\n  // UI variants\n  offlineLayout?: \"classic\" | \"modern\";\n  // Match UI\n  hideInGameSidebar?: boolean;\n  // Text size\n  textSize: \"small\" | \"medium\" | \"large\";\n  // Box size\n  boxSize: \"small\" | \"medium\" | \"large\";\n  // Match configuration\n  matchType?: \"singles\" | \"doubles\";\n  teamAName?: string;\n  teamBName?: string;\n  setFavoriteDouble: (d: string) => void;\n  setCallerEnabled: (v: boolean) => void;\n  setCallerVoice: (name: string) => void;\n  setAvgMode: (mode: \"all-time\" | \"24h\") => void;\n  setCallerVolume: (v: number) => void;\n  setSpeakCheckoutOnly: (v: boolean) => void;\n  setAutoStartOffline: (v: boolean) => void;\n  setRememberLastOffline: (v: boolean) => void;\n  setLastOffline: (cfg: Partial<LastOffline>) => void;\n  setReducedMotion: (v: boolean) => void;\n  setCompactHeader: (v: boolean) => void;\n  setAllowSpectate: (v: boolean) => void;\n  setCameraScale: (n: number) => void;\n  setCameraAspect: (a: \"wide\" | \"square\") => void;\n  setCameraFitMode: (m: \"fit\" | \"fill\") => void;\n  setCalibrationGuide: (v: boolean) => void;\n  setCalibrationUseRansac: (v: boolean) => void;\n  setPreserveCalibrationOverlay: (v: boolean) => void;\n  setPreserveCalibrationOnCameraChange: (v: boolean) => void;\n  setPreferredCamera: (\n    id: string | undefined,\n    label?: string,\n    force?: boolean,\n  ) => void;\n  setPreferredCameraLocked: (v: boolean) => void;\n  setCameraEnabled: (v: boolean) => void;\n  setHideCameraOverlay: (v: boolean) => void;\n  setCameraShowLabels: (v: boolean) => void;\n  setCameraLowLatency: (v: boolean) => void;\n  setCameraProcessingFps: (n: number) => void;\n  setCameraRecordDarts: (v: boolean) => void;\n  setIgnorePreferredCameraSync: (v: boolean) => void;\n  setOfflineLayout: (mode: \"classic\" | \"modern\") => void;\n  setHideInGameSidebar: (v: boolean) => void;\n  setAutoscoreProvider: (\n    p: \"built-in\" | \"built-in-v2\" | \"external-ws\" | \"manual\",\n  ) => void;\n  setAutoscoreWsUrl: (u: string) => void;\n  setAutoCommitMode: (mode: \"wait-for-clear\" | \"immediate\") => void;\n  setConfirmUncertainDarts: (v: boolean) => void;\n  setAutoScoreConfidenceThreshold: (n: number) => void;\n  setAutoscoreDetectorMinArea: (n: number) => void;\n  setAutoscoreDetectorThresh: (n: number) => void;\n  setAutoscoreDetectorRequireStableN: (n: number) => void;\n  setHarshLightingMode: (v: boolean) => void;\n  setEnhanceBigTrebles: (v: boolean) => void;\n  setAllowAutocommitInOnline: (v: boolean) => void;\n  setTextSize: (size: \"small\" | \"medium\" | \"large\") => void;\n  setBoxSize: (size: \"small\" | \"medium\" | \"large\") => void;\n  setMatchType: (t: \"singles\" | \"doubles\") => void;\n  setTeamAName: (name: string) => void;\n  setTeamBName: (name: string) => void;\n  // Throw timer per dart\n  dartTimerEnabled?: boolean;\n  dartTimerSeconds?: number;\n  setDartTimerEnabled: (v: boolean) => void;\n  setDartTimerSeconds: (n: number) => void;\n  // X01 rules\n  x01DoubleIn?: boolean;\n  setX01DoubleIn: (v: boolean) => void;\n};\nconst KEY = \"ndn_user_settings\";\n\nfunction load(): Pick<\n  SettingsState,\n  | \"favoriteDouble\"\n  | \"callerEnabled\"\n  | \"callerVoice\"\n  | \"avgMode\"\n  | \"callerVolume\"\n  | \"speakCheckoutOnly\"\n  | \"autoStartOffline\"\n  | \"rememberLastOffline\"\n  | \"lastOffline\"\n  | \"reducedMotion\"\n  | \"compactHeader\"\n  | \"allowSpectate\"\n  | \"cameraScale\"\n  | \"cameraAspect\"\n  | \"cameraFitMode\"\n  | \"cameraRecordDarts\"\n  | \"cameraShowLabels\"\n  | \"cameraLowLatency\"\n  | \"cameraProcessingFps\"\n  | \"calibrationGuide\"\n  | \"calibrationUseRansac\"\n  | \"preserveCalibrationOverlay\"\n  | \"preserveCalibrationOnCameraChange\"\n  | \"preferredCameraId\"\n  | \"preferredCameraLabel\"\n  | \"preferredCameraLocked\"\n  | \"cameraEnabled\"\n  | \"hideCameraOverlay\"\n  | \"offlineLayout\"\n  | \"hideInGameSidebar\"\n  | \"autoscoreProvider\"\n  | \"autoscoreWsUrl\"\n  | \"autoCommitMode\"\n  | \"confirmUncertainDarts\"\n  | \"autoScoreConfidenceThreshold\"\n  | \"autoscoreDetectorMinArea\"\n  | \"autoscoreDetectorThresh\"\n  | \"autoscoreDetectorRequireStableN\"\n  | \"harshLightingMode\"\n  | \"enhanceBigTrebles\"\n  | \"allowAutocommitInOnline\"\n  | \"textSize\"\n  | \"boxSize\"\n  | \"matchType\"\n  | \"teamAName\"\n  | \"teamBName\"\n  | \"dartTimerEnabled\"\n  | \"dartTimerSeconds\"\n  | \"x01DoubleIn\"\n> {\n  try {\n    const raw = localStorage.getItem(KEY);\n    if (!raw)\n      return {\n        favoriteDouble: \"D16\",\n        callerEnabled: true,\n        callerVoice: \"\",\n        callerVolume: 1,\n        speakCheckoutOnly: false,\n        avgMode: \"all-time\",\n        autoStartOffline: false,\n        rememberLastOffline: true,\n        lastOffline: {\n          mode: \"X01\",\n          x01Start: 501,\n          firstTo: 1,\n          aiLevel: \"None\",\n        },\n        reducedMotion: false,\n        compactHeader: false,\n        allowSpectate: true,\n        cameraScale: 1.0,\n        cameraAspect: \"wide\",\n        cameraFitMode: \"fit\",\n        cameraRecordDarts: true,\n        cameraShowLabels: false,\n        cameraLowLatency: false,\n        cameraProcessingFps: 15,\n        calibrationGuide: true,\n        preferredCameraId: undefined,\n        preferredCameraLabel: undefined,\n        preserveCalibrationOverlay: true,\n        preserveCalibrationOnCameraChange: true,\n        cameraEnabled: true,\n        hideCameraOverlay: false,\n        offlineLayout: \"modern\",\n        hideInGameSidebar: true,\n        autoscoreProvider: \"built-in\",\n        autoscoreWsUrl: \"\",\n        autoCommitMode: \"immediate\",\n        confirmUncertainDarts: false,\n        autoScoreConfidenceThreshold: 0.82,\n        autoscoreDetectorMinArea: 30,\n        autoscoreDetectorThresh: 15,\n        autoscoreDetectorRequireStableN: 2,\n        harshLightingMode: false,\n        enhanceBigTrebles: false,\n        allowAutocommitInOnline: false,\n        textSize: \"medium\",\n        boxSize: \"medium\",\n        matchType: \"singles\",\n        teamAName: \"Team A\",\n        teamBName: \"Team B\",\n        dartTimerEnabled: false,\n        dartTimerSeconds: 10,\n        x01DoubleIn: false,\n      };\n    const j = JSON.parse(raw);\n    const version = Number((j as any)?.__version || 0);\n    if (version < 2) {\n      // Smooth autoscore migration: reduce manual steps for existing users.\n      const migrated = {\n        ...j,\n        autoCommitMode: \"immediate\",\n        confirmUncertainDarts: false,\n        cameraRecordDarts: true,\n        autoScoreConfidenceThreshold: 0.82,\n        __version: 2,\n      };\n      try {\n        localStorage.setItem(KEY, JSON.stringify(migrated));\n      } catch {}\n    }\n    return {\n      favoriteDouble: j.favoriteDouble || \"D16\",\n      callerEnabled:\n        typeof j.callerEnabled === \"boolean\" ? j.callerEnabled : true,\n      callerVoice: j.callerVoice || \"\",\n      callerVolume:\n        typeof j.callerVolume === \"number\"\n          ? Math.max(0, Math.min(1, j.callerVolume))\n          : 1,\n      speakCheckoutOnly: !!j.speakCheckoutOnly,\n      avgMode: j.avgMode === \"24h\" ? \"24h\" : \"all-time\",\n      autoStartOffline: !!j.autoStartOffline,\n      rememberLastOffline:\n        typeof j.rememberLastOffline === \"boolean\"\n          ? j.rememberLastOffline\n          : true,\n      lastOffline:\n        j.lastOffline && typeof j.lastOffline === \"object\"\n          ? {\n              mode: j.lastOffline.mode || \"X01\",\n              x01Start: Number(j.lastOffline.x01Start) || 501,\n              firstTo: Number(j.lastOffline.firstTo) || 1,\n              aiLevel: j.lastOffline.aiLevel || \"None\",\n            }\n          : { mode: \"X01\", x01Start: 501, firstTo: 1, aiLevel: \"None\" },\n      reducedMotion: !!j.reducedMotion,\n      compactHeader: !!j.compactHeader,\n      allowSpectate:\n        typeof j.allowSpectate === \"boolean\" ? j.allowSpectate : true,\n      cameraScale:\n        typeof j.cameraScale === \"number\" && isFinite(j.cameraScale)\n          ? Math.max(0.5, Math.min(1.25, j.cameraScale))\n          : 1.0,\n      cameraAspect: j.cameraAspect === \"square\" ? \"square\" : \"wide\",\n      cameraFitMode:\n        j.cameraFitMode === \"fit\" || j.cameraFitMode === \"fill\"\n          ? j.cameraFitMode\n          : \"fit\",\n      calibrationUseRansac:\n        typeof j.calibrationUseRansac === \"boolean\"\n          ? j.calibrationUseRansac\n          : true,\n      autoscoreProvider: (() => {\n        let val = j.autoscoreProvider;\n        if (\n          val !== \"external-ws\" &&\n          val !== \"manual\" &&\n          val !== \"built-in\" &&\n          val !== \"built-in-v2\"\n        ) {\n          val = \"built-in\";\n        }\n        return val;\n      })(),\n      autoscoreWsUrl:\n        typeof j.autoscoreWsUrl === \"string\" ? j.autoscoreWsUrl : \"\",\n      autoCommitMode:\n        j.autoCommitMode === \"immediate\" ? \"immediate\" : \"wait-for-clear\",\n      confirmUncertainDarts:\n        typeof j.confirmUncertainDarts === \"boolean\"\n          ? j.confirmUncertainDarts\n          : false,\n      autoScoreConfidenceThreshold:\n        typeof j.autoScoreConfidenceThreshold === \"number\" &&\n        isFinite(j.autoScoreConfidenceThreshold)\n          ? Math.max(0.5, Math.min(0.99, j.autoScoreConfidenceThreshold))\n          : 0.82,\n      autoscoreDetectorMinArea:\n        typeof j.autoscoreDetectorMinArea === \"number\" &&\n        isFinite(j.autoscoreDetectorMinArea)\n          ? Math.max(5, Math.min(500, Math.round(j.autoscoreDetectorMinArea)))\n          : 30,\n      autoscoreDetectorThresh:\n        typeof j.autoscoreDetectorThresh === \"number\" &&\n        isFinite(j.autoscoreDetectorThresh)\n          ? Math.max(5, Math.min(60, Math.round(j.autoscoreDetectorThresh)))\n          : 15,\n      autoscoreDetectorRequireStableN:\n        typeof j.autoscoreDetectorRequireStableN === \"number\" &&\n        isFinite(j.autoscoreDetectorRequireStableN)\n          ? Math.max(\n              1,\n              Math.min(10, Math.round(j.autoscoreDetectorRequireStableN)),\n            )\n          : 2,\n      harshLightingMode:\n        typeof j.harshLightingMode === \"boolean\" ? j.harshLightingMode : false,\n      enhanceBigTrebles:\n        typeof j.enhanceBigTrebles === \"boolean\" ? j.enhanceBigTrebles : false,\n      allowAutocommitInOnline: !!j.allowAutocommitInOnline,\n      calibrationGuide:\n        typeof j.calibrationGuide === \"boolean\" ? j.calibrationGuide : true,\n      preferredCameraId:\n        typeof j.preferredCameraId === \"string\"\n          ? j.preferredCameraId\n          : undefined,\n      preserveCalibrationOverlay:\n        typeof j.preserveCalibrationOverlay === \"boolean\"\n          ? j.preserveCalibrationOverlay\n          : true,\n      preserveCalibrationOnCameraChange:\n        typeof j.preserveCalibrationOnCameraChange === \"boolean\"\n          ? j.preserveCalibrationOnCameraChange\n          : true,\n      preferredCameraLabel:\n        typeof j.preferredCameraLabel === \"string\"\n          ? j.preferredCameraLabel\n          : undefined,\n      preferredCameraLocked:\n        typeof j.preferredCameraLocked === \"boolean\"\n          ? j.preferredCameraLocked\n          : false,\n      cameraEnabled:\n        typeof j.cameraEnabled === \"boolean\" ? j.cameraEnabled : true,\n      hideCameraOverlay:\n        typeof j.hideCameraOverlay === \"boolean\" ? j.hideCameraOverlay : false,\n      offlineLayout: j.offlineLayout === \"classic\" ? \"classic\" : \"modern\",\n      hideInGameSidebar:\n        typeof j.hideInGameSidebar === \"boolean\" ? j.hideInGameSidebar : true,\n      textSize:\n        j.textSize === \"small\" || j.textSize === \"large\"\n          ? j.textSize\n          : \"medium\",\n      boxSize:\n        j.boxSize === \"small\" || j.boxSize === \"large\" ? j.boxSize : \"medium\",\n      matchType: j.matchType === \"doubles\" ? \"doubles\" : \"singles\",\n      teamAName: typeof j.teamAName === \"string\" ? j.teamAName : \"Team A\",\n      teamBName: typeof j.teamBName === \"string\" ? j.teamBName : \"Team B\",\n      dartTimerEnabled:\n        typeof j.dartTimerEnabled === \"boolean\" ? j.dartTimerEnabled : false,\n      dartTimerSeconds:\n        typeof j.dartTimerSeconds === \"number\" && isFinite(j.dartTimerSeconds)\n          ? Math.max(3, Math.min(60, j.dartTimerSeconds))\n          : 10,\n      x01DoubleIn: typeof j.x01DoubleIn === \"boolean\" ? j.x01DoubleIn : false,\n      cameraRecordDarts:\n        typeof j.cameraRecordDarts === \"boolean\" ? j.cameraRecordDarts : true,\n      cameraShowLabels:\n        typeof j.cameraShowLabels === \"boolean\" ? j.cameraShowLabels : false,\n    };\n  } catch {\n    return {\n      favoriteDouble: \"D16\",\n      callerEnabled: true,\n      callerVoice: \"\",\n      callerVolume: 1,\n      speakCheckoutOnly: false,\n      avgMode: \"all-time\",\n      autoStartOffline: false,\n      rememberLastOffline: true,\n      lastOffline: { mode: \"X01\", x01Start: 501, firstTo: 1, aiLevel: \"None\" },\n      reducedMotion: false,\n      compactHeader: false,\n      allowSpectate: true,\n      cameraScale: 1.0,\n      cameraAspect: \"wide\",\n      cameraFitMode: \"fit\",\n      calibrationGuide: true,\n      calibrationUseRansac: true,\n      preferredCameraId: undefined,\n      preferredCameraLabel: undefined,\n      preferredCameraLocked: false,\n      preserveCalibrationOverlay: true,\n      preserveCalibrationOnCameraChange: true,\n      cameraEnabled: true,\n      hideCameraOverlay: false,\n      offlineLayout: \"modern\",\n      hideInGameSidebar: true,\n      autoscoreProvider: \"built-in\",\n      autoscoreWsUrl: \"\",\n      autoCommitMode: \"immediate\",\n      confirmUncertainDarts: false,\n      autoScoreConfidenceThreshold: 0.82,\n      harshLightingMode: false,\n      enhanceBigTrebles: false,\n      textSize: \"medium\",\n      boxSize: \"medium\",\n      matchType: \"singles\",\n      teamAName: \"Team A\",\n      teamBName: \"Team B\",\n      dartTimerEnabled: false,\n      dartTimerSeconds: 10,\n      x01DoubleIn: false,\n    };\n  }\n}\n\nfunction save(partial: Partial<SettingsState>) {\n  try {\n    const prev = load();\n    localStorage.setItem(KEY, JSON.stringify({ ...prev, ...partial }));\n  } catch {}\n}\n\nexport const useUserSettings = create<SettingsState>((set, get) => ({\n  ...load(),\n  setFavoriteDouble: (d) => {\n    save({ favoriteDouble: d });\n    set({ favoriteDouble: d });\n  },\n  setCallerEnabled: (v) => {\n    save({ callerEnabled: v });\n    set({ callerEnabled: v });\n  },\n  setCallerVoice: (name) => {\n    save({ callerVoice: name });\n    set({ callerVoice: name });\n  },\n  setAvgMode: (mode) => {\n    save({ avgMode: mode });\n    set({ avgMode: mode });\n  },\n  setCallerVolume: (v) => {\n    const vol = Math.max(0, Math.min(1, v));\n    save({ callerVolume: vol });\n    set({ callerVolume: vol });\n  },\n  setSpeakCheckoutOnly: (v) => {\n    save({ speakCheckoutOnly: v });\n    set({ speakCheckoutOnly: v });\n  },\n  setAutoStartOffline: (v) => {\n    save({ autoStartOffline: v });\n    set({ autoStartOffline: v });\n  },\n  setRememberLastOffline: (v) => {\n    save({ rememberLastOffline: v });\n    set({ rememberLastOffline: v });\n  },\n  setLastOffline: (cfg) => {\n    const prev = load().lastOffline;\n    const next = { ...prev, ...cfg };\n    save({ lastOffline: next });\n    set({ lastOffline: next });\n  },\n  setReducedMotion: (v) => {\n    save({ reducedMotion: v });\n    set({ reducedMotion: v });\n  },\n  setCompactHeader: (v) => {\n    save({ compactHeader: v });\n    set({ compactHeader: v });\n  },\n  setAllowSpectate: (v) => {\n    save({ allowSpectate: v });\n    set({ allowSpectate: v });\n  },\n  // Temporarily suppress external camera-mode syncing (used while user is interacting with device picker)\n  ignorePreferredCameraSync: false,\n  setIgnorePreferredCameraSync: (v: boolean) => {\n    save({} as any);\n    set({ ignorePreferredCameraSync: v });\n  },\n  setCameraScale: (n) => {\n    const s = Math.max(0.5, Math.min(2.0, n));\n    save({ cameraScale: s });\n    set({ cameraScale: s });\n  },\n  setCameraAspect: (a) => {\n    const v = a === \"square\" ? \"square\" : \"wide\";\n    save({ cameraAspect: v });\n    set({ cameraAspect: v });\n  },\n  setCameraFitMode: (m) => {\n    const v = m === \"fit\" ? \"fit\" : \"fill\";\n    save({ cameraFitMode: v });\n    set({ cameraFitMode: v });\n  },\n  setAutoscoreProvider: (p) => {\n    // Force set next to p\n    const next = p;\n    // Persist\n    save({ autoscoreProvider: next });\n    set({ autoscoreProvider: next });\n  },\n  setAutoscoreWsUrl: (u) => {\n    save({ autoscoreWsUrl: u });\n    set({ autoscoreWsUrl: u });\n  },\n  setAutoCommitMode: (mode) => {\n    const v = mode === \"immediate\" ? \"immediate\" : \"wait-for-clear\";\n    save({ autoCommitMode: v });\n    set({ autoCommitMode: v });\n  },\n  setConfirmUncertainDarts: (v) => {\n    const next = !!v;\n    save({ confirmUncertainDarts: next });\n    set({ confirmUncertainDarts: next });\n  },\n  setAutoScoreConfidenceThreshold: (n) => {\n    const next =\n      typeof n === \"number\" && isFinite(n)\n        ? Math.max(0.5, Math.min(0.99, n))\n        : 0.85;\n    save({ autoScoreConfidenceThreshold: next });\n    set({ autoScoreConfidenceThreshold: next });\n  },\n  setAutoscoreDetectorMinArea: (n) => {\n    const next =\n      typeof n === \"number\" && isFinite(n)\n        ? Math.max(5, Math.min(500, Math.round(n)))\n        : 30;\n    save({ autoscoreDetectorMinArea: next } as any);\n    set({ autoscoreDetectorMinArea: next });\n  },\n  setAutoscoreDetectorThresh: (n) => {\n    const next =\n      typeof n === \"number\" && isFinite(n)\n        ? Math.max(5, Math.min(60, Math.round(n)))\n        : 15;\n    save({ autoscoreDetectorThresh: next } as any);\n    set({ autoscoreDetectorThresh: next });\n  },\n  setAutoscoreDetectorRequireStableN: (n) => {\n    const next =\n      typeof n === \"number\" && isFinite(n)\n        ? Math.max(1, Math.min(10, Math.round(n)))\n        : 2;\n    save({ autoscoreDetectorRequireStableN: next } as any);\n    set({ autoscoreDetectorRequireStableN: next });\n  },\n  setHarshLightingMode: (v) => {\n    const next = !!v;\n    save({ harshLightingMode: next } as any);\n    set({ harshLightingMode: next });\n  },\n  setEnhanceBigTrebles: (v) => {\n    const next = !!v;\n    save({ enhanceBigTrebles: next } as any);\n    set({ enhanceBigTrebles: next });\n  },\n  setAllowAutocommitInOnline: (v) => {\n    save({ allowAutocommitInOnline: v } as any);\n    set({ allowAutocommitInOnline: v });\n  },\n  setCalibrationGuide: (v) => {\n    save({ calibrationGuide: v });\n    set({ calibrationGuide: v });\n  },\n  setCalibrationUseRansac: (v) => {\n    save({ calibrationUseRansac: v } as any);\n    set({ calibrationUseRansac: v } as any);\n  },\n  setPreserveCalibrationOverlay: (v) => {\n    save({ preserveCalibrationOverlay: v } as any);\n    set({ preserveCalibrationOverlay: v });\n  },\n  setPreserveCalibrationOnCameraChange: (v) => {\n    save({ preserveCalibrationOnCameraChange: v } as any);\n    set({ preserveCalibrationOnCameraChange: !!v });\n  },\n  setPreferredCamera: (id, label, force = false) => {\n    try {\n      const state = get();\n      // Intentionally no logs here to avoid noisy console output in user flows\n      if (state.preferredCameraLocked && !force) {\n        // Locked: ignore programmatic updates unless explicitly forced by user action\n        console.log(\n          \"[USERSETTINGS] Camera selection locked and force=false, ignoring update\",\n        );\n        return;\n      }\n    } catch {}\n    // Avoid redundant writes and accidental clears when values are unchanged.\n    try {\n      const prev = get();\n      if (\n        prev.preferredCameraId === id &&\n        prev.preferredCameraLabel === label\n      ) {\n        // Nothing changed; avoid writing to storage to reduce unexpected updates\n        return;\n      }\n    } catch {}\n    // No logging on successful save to keep runtime output quiet\n    save({ preferredCameraId: id, preferredCameraLabel: label });\n    set({ preferredCameraId: id, preferredCameraLabel: label });\n  },\n  setPreferredCameraLocked: (v) => {\n    // Respect a temporary user-interaction guard which prevents automatic\n    // re-locking while the user is actively interacting with the picker.\n    try {\n      const state = get();\n      if (state.ignorePreferredCameraSync && v === true) {\n        // Ignore attempts to auto-lock while the user has signalled they're\n        // interacting with the picker. This prevents the lock \"bouncing\"\n        // back on immediately after a user unlocks and selects a new camera.\n        console.debug(\n          \"[USERSETTINGS] Ignoring auto-lock due to ignorePreferredCameraSync\",\n        );\n        return;\n      }\n    } catch {}\n    save({ preferredCameraLocked: v });\n    set({ preferredCameraLocked: v });\n  },\n  setCameraEnabled: (v) => {\n    save({ cameraEnabled: v });\n    set({ cameraEnabled: v });\n  },\n  setHideCameraOverlay: (v) => {\n    save({ hideCameraOverlay: v });\n    set({ hideCameraOverlay: v });\n  },\n  setCameraShowLabels: (v) => {\n    save({ cameraShowLabels: v } as any);\n    set({ cameraShowLabels: !!v } as any);\n  },\n  setCameraRecordDarts: (v: boolean) => {\n    const next = !!v;\n    save({ cameraRecordDarts: next } as any);\n    set({ cameraRecordDarts: next } as any);\n  },\n  setCameraLowLatency: (v: boolean) => {\n    const next = !!v;\n    save({ cameraLowLatency: next } as any);\n    set({ cameraLowLatency: next } as any);\n  },\n  setCameraProcessingFps: (n: number) => {\n    const s = Math.max(5, Math.min(30, Math.round(n)));\n    save({ cameraProcessingFps: s } as any);\n    set({ cameraProcessingFps: s } as any);\n  },\n  setOfflineLayout: (mode) => {\n    save({ offlineLayout: mode });\n    set({ offlineLayout: mode });\n  },\n  setHideInGameSidebar: (v) => {\n    save({ hideInGameSidebar: v });\n    set({ hideInGameSidebar: v });\n  },\n  setTextSize: (size) => {\n    save({ textSize: size });\n    set({ textSize: size });\n  },\n  setBoxSize: (size) => {\n    save({ boxSize: size });\n    set({ boxSize: size });\n  },\n  setMatchType: (t) => {\n    const v = t === \"doubles\" ? \"doubles\" : \"singles\";\n    save({ matchType: v });\n    set({ matchType: v });\n  },\n  setTeamAName: (name) => {\n    const v = name?.trim() || \"Team A\";\n    save({ teamAName: v });\n    set({ teamAName: v });\n  },\n  setTeamBName: (name) => {\n    const v = name?.trim() || \"Team B\";\n    save({ teamBName: v });\n    set({ teamBName: v });\n  },\n  setDartTimerEnabled: (v) => {\n    save({ dartTimerEnabled: v });\n    set({ dartTimerEnabled: v });\n  },\n  setDartTimerSeconds: (n) => {\n    const s = Math.max(3, Math.min(60, Math.round(n)));\n    save({ dartTimerSeconds: s });\n    set({ dartTimerSeconds: s });\n  },\n  setX01DoubleIn: (v) => {\n    save({ x01DoubleIn: v });\n    set({ x01DoubleIn: v });\n  },\n}));\n","/**\n * Advanced Dartboard Auto-Calibration\n *\n * Detects dartboard features automatically without markers or manual clicking:\n * 1. Detects bull (inner & outer rings) using circle detection\n * 2. Detects treble and double rings using edge/circle detection\n * 3. Computes board center and orientation\n * 4. Generates calibration points from detected rings\n * 5. Computes homography without user interaction\n */\n\nimport {\n  BoardRadii,\n  canonicalRimTargets,\n  computeHomographyDLT,\n  applyHomography,\n  sampleRing,\n  translateHomography,\n  rotateHomography,\n  scaleHomography,\n  rmsError,\n  ransacHomography,\n  type Homography,\n  type Point,\n} from \"./vision\";\nimport { getGlobalCalibrationConfidence } from \"./gameCalibrationRequirements\";\nimport { useUserSettings } from \"../store/userSettings\";\n\nconst isFinitePoint = (p: Point | undefined): p is Point =>\n  !!p && Number.isFinite(p.x) && Number.isFinite(p.y);\nconst isFiniteHomography = (\n  H: Homography | null | undefined,\n): H is Homography =>\n  Array.isArray(H) && H.length === 9 && H.every(Number.isFinite);\n\nexport interface BoardDetectionResult {\n  success: boolean;\n  cx: number; // Board center X in image\n  cy: number; // Board center Y in image\n  bullInner: number; // Detected inner bull radius (pixels)\n  bullOuter: number; // Detected outer bull radius (pixels)\n  trebleInner: number; // Detected treble inner radius (pixels)\n  trebleOuter: number; // Detected treble outer radius (pixels)\n  doubleInner: number; // Detected double inner radius (pixels)\n  doubleOuter: number; // Detected double outer radius (pixels)\n  confidence: number; // 0-100, quality of detection\n  homography: Homography | null;\n  errorPx: number | null;\n  calibrationPoints: Point[];\n  theta?: number; // detected orientation in radians (0 = canonical top)\n  message?: string;\n}\n\n/**\n * Detect dartboard using radial edge detection\n * Simpler, more robust approach:\n * 1. Find the center using Hough voting\n * 2. Scan radially from center to find ring boundaries (black/white transitions)\n * 3. Identify double ring (outermost playable ring) by looking for the characteristic radius\n */\nfunction findDartboardRings(\n  canvas: HTMLCanvasElement,\n  centerHint?: { x: number; y: number },\n): {\n  cx: number;\n  cy: number;\n  r: number;\n  confidence: number;\n  ringCount?: number;\n  ringStrength?: number;\n  detectedRings?: number[];\n} | null {\n  const ctx = canvas.getContext(\"2d\", { willReadFrequently: true });\n  if (!ctx) return null;\n\n  const w = canvas.width;\n  const h = canvas.height;\n\n  // 1. Downsample for Center Detection (Gradient Voting)\n  // Use a slightly higher resolution than before for better accuracy\n  const mapW = 160;\n  const scale = mapW / w;\n  const mapH = Math.floor(h * scale);\n\n  const workCanvas = new OffscreenCanvas(mapW, mapH);\n  const workCtx = workCanvas.getContext(\"2d\", { willReadFrequently: true });\n  if (!workCtx) return null;\n\n  workCtx.drawImage(canvas, 0, 0, mapW, mapH);\n  const imageData = workCtx.getImageData(0, 0, mapW, mapH);\n  const data = imageData.data;\n\n  // 2. Compute Gradients & Accumulator\n  const accumulator = new Float32Array(mapW * mapH);\n  const magThreshold = 8; // Sweet spot sensitivity (v2.1 level - was working)\n\n  // Simple Central Difference Gradients\n  for (let y = 1; y < mapH - 1; y++) {\n    for (let x = 1; x < mapW - 1; x++) {\n      const i = (y * mapW + x) * 4;\n\n      // Neighbors\n      const iL = i - 4;\n      const iR = i + 4;\n      const iU = i - mapW * 4;\n      const iD = i + mapW * 4;\n\n      // Luminance\n      const lumL =\n        data[iL] * 0.299 + data[iL + 1] * 0.587 + data[iL + 2] * 0.114;\n      const lumR =\n        data[iR] * 0.299 + data[iR + 1] * 0.587 + data[iR + 2] * 0.114;\n      const lumU =\n        data[iU] * 0.299 + data[iU + 1] * 0.587 + data[iU + 2] * 0.114;\n      const lumD =\n        data[iD] * 0.299 + data[iD + 1] * 0.587 + data[iD + 2] * 0.114;\n\n      const dx = lumR - lumL;\n      const dy = lumD - lumU;\n      const mag = Math.sqrt(dx * dx + dy * dy);\n\n      if (mag > magThreshold) {\n        // Normalize direction\n        const ux = dx / mag;\n        const uy = dy / mag;\n\n        // Vote along the gradient line (perpendicular to edge)\n        // We vote in both directions because we don't know if it's inner or outer edge of a ring\n        // Expanded range: 3% to 60% of width to handle boards at different distances\n        const minR = mapW * 0.03;\n        const maxR = mapW * 0.6;\n\n        // Optimization: Step by 1 pixel\n        for (let r = minR; r < maxR; r += 1) {\n          // Direction 1 (+ gradient)\n          const v1x = Math.round(x + ux * r);\n          const v1y = Math.round(y + uy * r);\n          if (v1x >= 0 && v1x < mapW && v1y >= 0 && v1y < mapH) {\n            accumulator[v1y * mapW + v1x]++;\n          }\n\n          // Direction 2 (- gradient)\n          const v2x = Math.round(x - ux * r);\n          const v2y = Math.round(y - uy * r);\n          if (v2x >= 0 && v2x < mapW && v2y >= 0 && v2y < mapH) {\n            accumulator[v2y * mapW + v2x]++;\n          }\n        }\n      }\n    }\n  }\n\n  // 3. Find Peak in Accumulator\n  // Apply a small blur to the accumulator to smooth noise and aggregate votes\n  const smoothedAcc = new Float32Array(mapW * mapH);\n  const blurR = 2;\n  for (let y = blurR; y < mapH - blurR; y++) {\n    for (let x = blurR; x < mapW - blurR; x++) {\n      let sum = 0;\n      for (let dy = -blurR; dy <= blurR; dy++) {\n        for (let dx = -blurR; dx <= blurR; dx++) {\n          sum += accumulator[(y + dy) * mapW + (x + dx)];\n        }\n      }\n      smoothedAcc[y * mapW + x] = sum;\n    }\n  }\n\n  let maxVotes = 0;\n  let peakX = mapW / 2;\n  let peakY = mapH / 2;\n\n  // Ignore borders - but smaller border to detect boards at edges\n  const border = 5;\n  for (let y = border; y < mapH - border; y++) {\n    for (let x = border; x < mapW - border; x++) {\n      const votes = smoothedAcc[y * mapW + x];\n      if (votes > maxVotes) {\n        maxVotes = votes;\n        peakX = x;\n        peakY = y;\n      }\n    }\n  }\n\n  // Scale peak back to full size\n  let roughCx = peakX / scale;\n  let roughCy = peakY / scale;\n  // If a center hint is provided (e.g., a one-click bull), bias the rough center toward it\n  if (\n    centerHint &&\n    Number.isFinite(centerHint.x) &&\n    Number.isFinite(centerHint.y)\n  ) {\n    // Blend 70% hint, 30% voted peak to keep robustness while honoring user hint\n    roughCx = 0.7 * centerHint.x + 0.3 * roughCx;\n    roughCy = 0.7 * centerHint.y + 0.3 * roughCy;\n  }\n\n  console.log(\n    `[findDartboardRings] Voting Peak: (${Math.round(roughCx)}, ${Math.round(roughCy)}) Votes=${maxVotes}`,\n  );\n\n  // 5. Structural Lock (Double + Treble)\n  // We use a \"Radial Gradient\" search to ignore the spider/segment wires.\n  // Segment wires have gradients perpendicular to the radius (tangential).\n  // Rings have gradients parallel to the radius (radial).\n  const scanW = 400; // Increased resolution for better wire separation\n  const scanScale = scanW / w;\n  const scanH = Math.floor(h * scanScale);\n\n  const scanCanvas = new OffscreenCanvas(scanW, scanH);\n  const scanCtx = scanCanvas.getContext(\"2d\");\n  if (!scanCtx) return null;\n\n  scanCtx.drawImage(canvas, 0, 0, scanW, scanH);\n  const scanData = scanCtx.getImageData(0, 0, scanW, scanH).data;\n\n  // NOTE: roughCxScaled/roughCyScaled were used in an earlier debug path; keep\n  // them removed to avoid unused-vars warnings.\n\n  // Pre-compute gradients for scan image\n  const scanDx = new Float32Array(scanW * scanH);\n  const scanDy = new Float32Array(scanW * scanH);\n\n  for (let y = 1; y < scanH - 1; y++) {\n    for (let x = 1; x < scanW - 1; x++) {\n      const i = (y * scanW + x) * 4;\n\n      // Luminance\n      const _lum =\n        scanData[i] * 0.299 + scanData[i + 1] * 0.587 + scanData[i + 2] * 0.114;\n\n      // Neighbors\n      const iL = i - 4;\n      const iR = i + 4;\n      const iU = i - scanW * 4;\n      const iD = i + scanW * 4;\n\n      const lumL =\n        scanData[iL] * 0.299 +\n        scanData[iL + 1] * 0.587 +\n        scanData[iL + 2] * 0.114;\n      const lumR =\n        scanData[iR] * 0.299 +\n        scanData[iR + 1] * 0.587 +\n        scanData[iR + 2] * 0.114;\n      const lumU =\n        scanData[iU] * 0.299 +\n        scanData[iU + 1] * 0.587 +\n        scanData[iU + 2] * 0.114;\n      const lumD =\n        scanData[iD] * 0.299 +\n        scanData[iD + 1] * 0.587 +\n        scanData[iD + 2] * 0.114;\n\n      // Central Difference\n      const dx = lumR - lumL;\n      const dy = lumD - lumU;\n\n      scanDx[y * scanW + x] = dx;\n      scanDy[y * scanW + x] = dy;\n    }\n  }\n\n  // 4. Radial scan from center to find rings\n  // The double ring has a characteristic width (~8mm = ~8-12 pixels in typical images)\n  // and should be the outermost ring with strong radial gradients\n  const fullData = ctx.getImageData(0, 0, w, h).data;\n\n  const lum = (x: number, y: number) => {\n    const ix = Math.max(0, Math.min(w - 1, Math.round(x)));\n    const iy = Math.max(0, Math.min(h - 1, Math.round(y)));\n    const idx = (iy * w + ix) * 4;\n    return (\n      0.299 * fullData[idx] +\n      0.587 * fullData[idx + 1] +\n      0.114 * fullData[idx + 2]\n    );\n  };\n\n  // Scan radially at many angles to find ALL ring boundaries\n  // We need to detect: bullInner, bullOuter, trebleInner, trebleOuter, doubleInner, doubleOuter\n  const angleCount = 60;\n  const radiiByRing: { [key: number]: number[] } = {}; // Store radii at each angle\n\n  for (let a = 0; a < angleCount; a++) {\n    const angle = (a / angleCount) * Math.PI * 2;\n    const cos = Math.cos(angle);\n    const sin = Math.sin(angle);\n\n    // Scan from center outward and find ALL local maxima (all ring boundaries)\n    const gradients: { r: number; grad: number }[] = [];\n\n    for (let r = 30; r < Math.min(w, h) / 2; r += 1) {\n      // Probe point (kept implicit via inner/outer sampling below)\n      const xInner = roughCx + (r - 2) * cos;\n      const yInner = roughCy + (r - 2) * sin;\n      const xOuter = roughCx + (r + 2) * cos;\n      const yOuter = roughCy + (r + 2) * sin;\n\n      const lumInner = lum(xInner, yInner);\n      const lumOuter = lum(xOuter, yOuter);\n\n      // Radial gradient: larger = stronger boundary\n      const grad = Math.abs(lumOuter - lumInner);\n\n      // SWEET SPOT: balanced threshold (v2.1 level)\n      if (grad > 2 && r > 20) {\n        // Good balance - not too strict, not too lenient\n        gradients.push({ r, grad });\n      }\n    }\n\n    // Find local maxima in gradients (these are ring boundaries)\n    const peaks: number[] = [];\n    for (let i = 0; i < gradients.length; i++) {\n      const prev = i > 0 ? gradients[i - 1].grad : 0;\n      const curr = gradients[i].grad;\n      const next = i < gradients.length - 1 ? gradients[i + 1].grad : 0;\n\n      // SWEET SPOT: balanced peak detection\n      if (curr > prev && curr > next && curr > 2) {\n        // Good balance point\n        peaks.push(gradients[i].r);\n      }\n    }\n\n    // Store all peaks for this angle\n    // Instead of using index, group peaks that are close together\n    // (close peaks = same ring, different angles)\n    if (peaks.length > 0) {\n      peaks.forEach((r) => {\n        // Find the closest existing ring tier\n        const ringKey = Object.keys(radiiByRing)\n          .map((k) => ({\n            key: parseInt(k),\n            median:\n              radiiByRing[parseInt(k)][\n                Math.floor(radiiByRing[parseInt(k)].length / 2)\n              ],\n          }))\n          .filter((entry) => Math.abs(entry.median - r) < 15) // Within 15 pixels = same ring\n          .sort((a, b) => Math.abs(a.median - r) - Math.abs(b.median - r))[0];\n\n        const tierIndex = ringKey\n          ? ringKey.key\n          : Math.max(-1, ...Object.keys(radiiByRing).map((k) => parseInt(k))) +\n            1;\n        if (!radiiByRing[tierIndex]) radiiByRing[tierIndex] = [];\n        radiiByRing[tierIndex].push(r);\n      });\n    }\n  }\n\n  // Extract the median radius for each ring tier\n  const ringRadii = Object.keys(radiiByRing)\n    .map((key) => {\n      const radii = radiiByRing[parseInt(key)].sort((a, b) => a - b);\n      const median = radii[Math.floor(radii.length / 2)];\n      return { tier: parseInt(key), radius: median, samples: radii.length };\n    })\n    .sort((a, b) => a.radius - b.radius);\n\n  console.log(`[findDartboardRings] Detected ring tiers:`, ringRadii);\n\n  // v2.6: Robust ring selection to ignore light rings/surrounds\n  // The double ring (inner/outer) are very close together (162 vs 170, ratio 1.05)\n  // If the outermost ring is much further out than the one before it, it's likely a light ring.\n  const filteredRings = [...ringRadii];\n  if (filteredRings.length >= 2) {\n    const last = filteredRings[filteredRings.length - 1].radius;\n    const secondLast = filteredRings[filteredRings.length - 2].radius;\n    const ratio = last / secondLast;\n\n    // If ratio > 1.15 and we have enough rings to suggest the second-last is the double,\n    // or if the ratio is extremely large (> 1.3), ignore the outermost ring.\n    if ((ratio > 1.15 && filteredRings.length >= 5) || ratio > 1.3) {\n      console.log(\n        `[findDartboardRings] Ignoring outermost ring (likely light ring/surround): ${last.toFixed(\n          1,\n        )}px (ratio ${ratio.toFixed(2)} to ${secondLast.toFixed(1)}px)`,\n      );\n      filteredRings.pop();\n    }\n  }\n\n  // The outermost ring of the FILTERED set should be the double outer\n  const doubleOuterRadius =\n    filteredRings.length > 0\n      ? filteredRings[filteredRings.length - 1].radius\n      : Math.min(w, h) * 0.3;\n\n  // v2.4: Boost detection confidence based on ring completeness\n  // All 7 rings detected = near-perfect setup (98%)\n  // 6+ rings = excellent (96%)\n  // 5 rings = good (94%)\n  // fewer = lower confidence\n  let detectionConfidence = 50 + filteredRings.length * 6; // Base: 50-92% for 0-7 rings\n  if (filteredRings.length >= 7) {\n    detectionConfidence = 98; // All rings perfect\n  } else if (filteredRings.length === 6) {\n    detectionConfidence = 96;\n  } else if (filteredRings.length === 5) {\n    detectionConfidence = 94;\n  }\n\n  return {\n    cx: roughCx,\n    cy: roughCy,\n    r: doubleOuterRadius,\n    confidence: detectionConfidence,\n    ringCount: filteredRings.length,\n    ringStrength:\n      filteredRings.length > 0\n        ? filteredRings[filteredRings.length - 1].radius\n        : 0,\n    detectedRings: filteredRings.map((r) => r.radius),\n  };\n}\n\n/**\n * Compute board orientation by analyzing radial gradients at the treble ring.\n * Returns the rotation angle (radians) that maps canonical sector centers to image angles.\n */\nfunction computeBoardOrientation(\n  canvas: HTMLCanvasElement,\n  cx: number,\n  cy: number,\n  radius: number,\n): number | null {\n  const ctx = canvas.getContext(\"2d\");\n  if (!ctx) return null;\n  const w = canvas.width;\n  const h = canvas.height;\n  const sampleCount = 720; // high angular resolution\n  const sampleRadius = radius; // use the outer radius (double outer) or treble\n  const gradSamples: number[] = new Array(sampleCount).fill(0);\n  // compute luminance radial derivative across a small radial band\n  const rInner = Math.max(2, Math.round(sampleRadius - 8));\n  const rOuter = Math.round(sampleRadius + 8);\n  const imageData = ctx.getImageData(0, 0, w, h).data;\n  const lum = (x: number, y: number) => {\n    const ix = Math.round(x);\n    const iy = Math.round(y);\n    if (ix < 0 || ix >= w || iy < 0 || iy >= h) return 127;\n    const idx = (iy * w + ix) * 4;\n    return (\n      imageData[idx] * 0.299 +\n      imageData[idx + 1] * 0.587 +\n      imageData[idx + 2] * 0.114\n    );\n  };\n  for (let i = 0; i < sampleCount; i++) {\n    const a = (i / sampleCount) * Math.PI * 2;\n    // sample radial line and compute max gradient magnitude along it\n    let maxGrad = 0;\n    let prev = lum(cx + rInner * Math.cos(a), cy + rInner * Math.sin(a));\n    for (let r = rInner + 1; r <= rOuter; r++) {\n      const cur = lum(cx + r * Math.cos(a), cy + r * Math.sin(a));\n      const g = Math.abs(cur - prev);\n      if (g > maxGrad) maxGrad = g;\n      prev = cur;\n    }\n    gradSamples[i] = maxGrad;\n  }\n  // Find local maxima which correspond to boundaries; threshold somewhat high\n  const peaks: number[] = [];\n  for (let i = 0; i < sampleCount; i++) {\n    const prev = gradSamples[(i - 1 + sampleCount) % sampleCount];\n    const cur = gradSamples[i];\n    const next = gradSamples[(i + 1) % sampleCount];\n    if (cur > prev && cur > next && cur > 10) peaks.push(i);\n  }\n  if (peaks.length < 16) {\n    // fallback: smooth and find broad maxima\n    const smoothed = gradSamples.map((v, idx) => {\n      let s = 0;\n      let k = 0;\n      for (let d = -2; d <= 2; d++) {\n        s += gradSamples[(idx + d + sampleCount) % sampleCount];\n        k++;\n      }\n      return s / k;\n    });\n    for (let i = 0; i < sampleCount; i++) {\n      const prev = smoothed[(i - 1 + sampleCount) % sampleCount];\n      const cur = smoothed[i];\n      const next = smoothed[(i + 1) % sampleCount];\n      if (cur > prev && cur > next && cur > 8) peaks.push(i);\n    }\n  }\n  if (peaks.length === 0) return 0;\n  // Convert peak indices to angles\n  const peakAngles = peaks.map((p) => (p / sampleCount) * Math.PI * 2);\n  // We expect wires at roughly 20 positions; convert to sector centers (midpoint between successive peaks)\n  peakAngles.sort((a, b) => a - b);\n  const sectorCenters: number[] = [];\n  for (let i = 0; i < peakAngles.length; i++) {\n    const a1 = peakAngles[i];\n    const a2 = peakAngles[(i + 1) % peakAngles.length];\n    // handle wrap\n    const diff = (a2 - a1 + Math.PI * 2) % (Math.PI * 2);\n    sectorCenters.push((a1 + diff / 2) % (Math.PI * 2));\n  }\n  // Now we need to map these detected sector centers to canonical sector angles\n  const sectorCount = 20;\n  const canonicalAngles = new Array(sectorCount)\n    .fill(0)\n    .map((_, i) => -Math.PI / 2 + i * ((Math.PI * 2) / sectorCount));\n  // Find rotation offset that best aligns detected centers to canonical centers using circular shifting\n  // We'll attempt shifts so that sectorCenters[0] maps to canonicalAngles[s] and choose best fit\n  let bestRot = 0;\n  let bestErr = Infinity;\n  for (let shift = 0; shift < sectorCenters.length; shift++) {\n    // Build map for first N up to 20 sectors\n    let err = 0;\n    for (let k = 0; k < Math.min(sectorCount, sectorCenters.length); k++) {\n      const detectedAngle = sectorCenters[(k + shift) % sectorCenters.length];\n      const canonicalAngle = canonicalAngles[k];\n      const d = Math.abs(\n        ((detectedAngle - canonicalAngle + Math.PI) % (Math.PI * 2)) - Math.PI,\n      );\n      err += d * d;\n    }\n    if (err < bestErr) {\n      bestErr = err;\n      bestRot =\n        (sectorCenters[shift] - canonicalAngles[0] + Math.PI * 2) %\n        (Math.PI * 2);\n    }\n  }\n  // Convert bestRot to [-pi,pi]\n  const theta = ((bestRot + Math.PI) % (Math.PI * 2)) - Math.PI;\n  return theta;\n}\n\n// Refine an existing homography by making tiny adjustments (rotation, scale, translation)\n// to maximize radial gradient energy along the treble and double outer rings.\nfunction refineHomographyByRings(\n  canvas: HTMLCanvasElement,\n  H: Homography,\n): Homography {\n  const ctx = canvas.getContext(\"2d\");\n  if (!ctx) return H;\n  const w = canvas.width,\n    h = canvas.height;\n  const id = ctx.getImageData(0, 0, w, h);\n  const data = id.data;\n\n  // Helper: luminance and gradient at (x,y)\n  const lum = (x: number, y: number) => {\n    const ix = Math.max(0, Math.min(w - 1, Math.round(x)));\n    const iy = Math.max(0, Math.min(h - 1, Math.round(y)));\n    const idx = (iy * w + ix) * 4;\n    return 0.299 * data[idx] + 0.587 * data[idx + 1] + 0.114 * data[idx + 2];\n  };\n  const grad = (x: number, y: number) => {\n    const gx = lum(x + 1, y) - lum(x - 1, y);\n    const gy = lum(x, y + 1) - lum(x, y - 1);\n    return { gx, gy };\n  };\n\n  // Board center in image for computing radial normals\n  const cImg = applyHomography(H, { x: 0, y: 0 });\n\n  // Scoring function: sum of radial gradient magnitude along rings\n  const ringScore = (Htest: Homography) => {\n    const rings = [BoardRadii.trebleOuter, BoardRadii.doubleOuter];\n    let score = 0;\n    for (const r of rings) {\n      const pts = sampleRing(Htest, r, 180);\n      for (let i = 0; i < pts.length; i++) {\n        const p = pts[i];\n        const g = grad(p.x, p.y);\n        // radial direction from image center point (mapped board origin)\n        const nx = p.x - cImg.x;\n        const ny = p.y - cImg.y;\n        const nlen = Math.hypot(nx, ny) || 1;\n        const ux = nx / nlen,\n          uy = ny / nlen;\n        score += Math.abs(g.gx * ux + g.gy * uy);\n      }\n    }\n    return score / 180 / 2; // normalized average per ring\n  };\n\n  let bestH = H;\n  let bestScore = ringScore(H);\n\n  // Small local search: rotation (4), image translation (3px), isotropic image scale (2%)\n  const toRad = (deg: number) => (deg * Math.PI) / 180;\n  const rotSteps = [-4, -2, -1, -0.5, 0, 0.5, 1, 2, 4];\n  const txSteps = [-3, -2, -1, 0, 1, 2, 3];\n  const scaleSteps = [0.98, 0.99, 1.0, 1.01, 1.02];\n\n  for (const rot of rotSteps) {\n    const Hr = rotateHomography(H, toRad(rot));\n    for (const tx of txSteps) {\n      for (const ty of txSteps) {\n        const Ht = translateHomography(Hr, tx, ty);\n        for (const s of scaleSteps) {\n          const Hs = scaleHomography(Ht, s, s);\n          const sc = ringScore(Hs);\n          if (sc > bestScore) {\n            bestScore = sc;\n            bestH = Hs;\n          }\n        }\n      }\n    }\n  }\n  return bestH;\n}\n\n/**\n * Main board detection function\n * Uses direct ring detection approach\n */\nexport function detectBoard(\n  canvas: HTMLCanvasElement,\n  opts?: { centerHint?: Point; colorAssist?: boolean },\n): BoardDetectionResult {\n  try {\n    const w = canvas.width;\n    const h = canvas.height;\n    const centerX = w / 2;\n    const centerY = h / 2;\n\n    // Optional: pre-filter image to only keep red and green hues (helps isolate double/treble bands)\n    let srcCanvas: HTMLCanvasElement | OffscreenCanvas = canvas as any;\n    // Optional color assist pre-filter (helps isolate double/treble bands)\n    if (opts?.colorAssist) {\n      try {\n        const makeCanvas = (w: number, h: number) => {\n          try {\n            return new OffscreenCanvas(w, h);\n          } catch {\n            const c = document.createElement(\"canvas\");\n            c.width = w;\n            c.height = h;\n            return c;\n          }\n        };\n        const oc = makeCanvas(w, h);\n        const octx = oc.getContext(\"2d\") as CanvasRenderingContext2D | null;\n        if (!octx) throw new Error(\"Could not get 2D context\");\n        (octx as CanvasRenderingContext2D).drawImage(canvas, 0, 0, w, h);\n        const id = (octx as CanvasRenderingContext2D).getImageData(0, 0, w, h);\n        const data = id.data;\n        // RGB -> HSV helper (fast approximation)\n        const rgb2hsv = (r: number, g: number, b: number) => {\n          const rn = r / 255,\n            gn = g / 255,\n            bn = b / 255;\n          const max = Math.max(rn, gn, bn),\n            min = Math.min(rn, gn, bn);\n          const d = max - min;\n          let h = 0;\n          if (d !== 0) {\n            if (max === rn) h = ((gn - bn) / d) % 6;\n            else if (max === gn) h = (bn - rn) / d + 2;\n            else h = (rn - gn) / d + 4;\n            h *= 60;\n            if (h < 0) h += 360;\n          }\n          const s = max === 0 ? 0 : d / max;\n          const v = max;\n          return { h, s, v };\n        };\n        for (let i = 0; i < data.length; i += 4) {\n          const r = data[i],\n            g = data[i + 1],\n            b = data[i + 2];\n          const { h: hh, s, v } = rgb2hsv(r, g, b);\n          // Keep saturated reds and greens; zero out everything else\n          const isRed =\n            s > 0.25 &&\n            v > 0.2 &&\n            (hh < 20 || hh > 340 || (hh > 340 && hh <= 360));\n          const isGreen = s > 0.25 && v > 0.2 && hh >= 80 && hh <= 160;\n          if (!(isRed || isGreen)) {\n            data[i] = data[i + 1] = data[i + 2] = 0; // black\n          } else {\n            // boost\n            data[i] = Math.min(255, r * 1.2);\n            data[i + 1] = Math.min(255, g * 1.2);\n            data[i + 2] = Math.min(255, b * 1.2);\n          }\n        }\n        (octx as CanvasRenderingContext2D).putImageData(id, 0, 0);\n        srcCanvas = oc;\n      } catch (e) {\n        // fall back silently\n        srcCanvas = canvas as any;\n      }\n    }\n\n    // Find dartboard rings\n    const detection = findDartboardRings(srcCanvas as any, opts?.centerHint);\n\n    if (!detection) {\n      return {\n        success: false,\n        cx: centerX,\n        cy: centerY,\n        bullInner: 0,\n        bullOuter: 0,\n        trebleInner: 0,\n        trebleOuter: 0,\n        doubleInner: 0,\n        doubleOuter: 0,\n        confidence: 0,\n        homography: null,\n        errorPx: null,\n        calibrationPoints: [],\n        message:\n          \"No dartboard detected. Ensure board is clearly visible with good contrast between rings and background.\",\n      };\n    }\n\n    // Use DETECTED ring positions directly - these are the actual black rings on YOUR dartboard!\n    // If we detected all 6 rings, use them. Otherwise fall back to scaling.\n    const detected = (() => {\n      const rings = detection.detectedRings || [];\n      if (rings.length >= 6) {\n        // We detected all rings: use them directly\n        return {\n          cx: detection.cx,\n          cy: detection.cy,\n          bullInner: rings[0],\n          bullOuter: rings[1],\n          trebleInner: rings[2],\n          trebleOuter: rings[3],\n          doubleInner: rings[4],\n          doubleOuter: rings[5],\n        };\n      } else {\n        // Fallback: scale based on detected double outer\n        const scale = detection.r / BoardRadii.doubleOuter;\n        return {\n          cx: detection.cx,\n          cy: detection.cy,\n          bullInner: BoardRadii.bullInner * scale,\n          bullOuter: BoardRadii.bullOuter * scale,\n          trebleInner: BoardRadii.trebleInner * scale,\n          trebleOuter: BoardRadii.trebleOuter * scale,\n          doubleInner: BoardRadii.doubleInner * scale,\n          doubleOuter: detection.r,\n        };\n      }\n    })();\n\n    // NEW: Detect board orientation (theta) using the treble ring\n    // This is much more robust than looking for peaks in the double ring\n    const theta =\n      computeBoardOrientation(\n        canvas,\n        detected.cx,\n        detected.cy,\n        detected.doubleOuter,\n      ) || 0;\n\n    // Generate 5 calibration points from detected rings (TOP, RIGHT, BOTTOM, LEFT, BULL)\n    // We use the detected theta to rotate the canonical targets\n    const canonicalSrc = canonicalRimTargets(\"outer\");\n    const calibrationPoints: Point[] = canonicalSrc.map((p) => {\n      if (p.x === 0 && p.y === 0) return { x: detected.cx, y: detected.cy };\n\n      // Rotate canonical point by theta\n      const cos = Math.cos(theta);\n      const sin = Math.sin(theta);\n\n      // Canonical points are in mm, we need to scale them to pixels\n      const scale = detected.doubleOuter / BoardRadii.doubleOuter;\n      const px = p.x * scale;\n      const py = p.y * scale;\n\n      // Rotate and translate to detected center\n      return {\n        x: detected.cx + (px * cos - py * sin),\n        y: detected.cy + (px * sin + py * cos),\n      };\n    });\n\n    let homography: Homography | null = null;\n    let errorPx: number | null = null;\n    let confidence = detection.confidence;\n    let inlierRatio = 1.0;\n\n    try {\n      // Respect user setting for RANSAC usage (when available)\n      let useRansac = true;\n      try {\n        const s = useUserSettings.getState?.();\n        useRansac = !!s?.calibrationUseRansac;\n      } catch (e) {}\n\n      if (useRansac) {\n        const ransac = ransacHomography(canonicalSrc, calibrationPoints, {\n          thresholdPx: 8,\n          maxIter: 300,\n        });\n        if (ransac.H) {\n          homography = ransac.H;\n          errorPx = ransac.errorPx;\n          const inlierCount = ransac.inliers.filter(Boolean).length;\n          inlierRatio = inlierCount / calibrationPoints.length;\n          confidence = Math.max(\n            confidence,\n            Math.round(confidence * 0.6 + inlierRatio * 40),\n          );\n        } else {\n          homography = computeHomographyDLT(canonicalSrc, calibrationPoints);\n          errorPx = rmsError(homography, canonicalSrc, calibrationPoints);\n        }\n      } else {\n        homography = computeHomographyDLT(canonicalSrc, calibrationPoints);\n        errorPx = rmsError(homography, canonicalSrc, calibrationPoints);\n      }\n\n      // NEW: Refine homography by maximizing radial gradient energy along rings\n      if (homography) {\n        homography = refineHomographyByRings(canvas, homography);\n        errorPx = rmsError(homography, canonicalSrc, calibrationPoints);\n      }\n\n      // Re-center the homography so board center maps exactly to detected bull.\n      // This keeps bull scoring tight even when ring refinement introduces a\n      // tiny translation drift.\n      if (homography) {\n        const centerImg = applyHomography(homography, { x: 0, y: 0 });\n        const dx = detected.cx - centerImg.x;\n        const dy = detected.cy - centerImg.y;\n        if (Math.hypot(dx, dy) > 0.25) {\n          homography = translateHomography(homography, dx, dy);\n          errorPx = rmsError(homography, canonicalSrc, calibrationPoints);\n        }\n      }\n\n      // Truth-based confidence: keep all calibration confidence values on the same\n      // scale used throughout the app (errorPx -> 0-100 mapping).\n      // This avoids having multiple competing confidence formulas.\n      const errPx = typeof errorPx === \"number\" ? errorPx : null;\n      const global = getGlobalCalibrationConfidence(errPx);\n      if (typeof global === \"number\") {\n        confidence = global;\n      } else {\n        // If error is unavailable, fall back to detection quality and inlier ratio.\n        confidence = Math.max(inlierRatio * 100, detection.confidence);\n      }\n    } catch (err) {\n      // Even if error in computation, if we have points, still fairly confident\n      confidence = Math.max(65, detection.confidence);\n    }\n\n    const pointsValid = calibrationPoints.every(isFinitePoint);\n    const homographyValid = isFiniteHomography(homography);\n    // More lenient success criteria: if homography computed, consider it success\n    const success = !!homographyValid && pointsValid && confidence > 50;\n    const detRingCount = detection.ringCount ?? 0;\n\n    const result = {\n      success,\n      cx: detected.cx,\n      cy: detected.cy,\n      bullInner: detected.bullInner,\n      bullOuter: detected.bullOuter,\n      trebleInner: detected.trebleInner,\n      trebleOuter: detected.trebleOuter,\n      doubleInner: detected.doubleInner,\n      doubleOuter: detected.doubleOuter,\n      confidence: Math.round(confidence), // Use calculated confidence directly (already has 85% floor)\n      homography: homographyValid ? homography : null,\n      errorPx: homographyValid ? errorPx : null,\n      calibrationPoints: pointsValid ? calibrationPoints : [],\n      theta: typeof theta === \"number\" ? theta : undefined,\n      message:\n        !pointsValid || !homographyValid\n          ? ` Detection produced unstable calibration data. Adjust camera framing or calibrate manually. (rings: ${detRingCount}, r:${Math.round(detection.r)})`\n          : confidence > 85\n            ? ` Excellent detection (rings: ${detRingCount}, r:${Math.round(detection.r)})`\n            : ` Board detected - may need angle adjustment (rings: ${detRingCount}, r:${Math.round(detection.r)})`,\n    };\n\n    console.log(\n      \"[detectBoard] Final result:\",\n      {\n        success: result.success,\n        confidence: result.confidence,\n        homographyValid,\n        pointsValid,\n        cx: Math.round(result.cx),\n        cy: Math.round(result.cy),\n        doubleOuter: Math.round(result.doubleOuter),\n        rings: detRingCount,\n        errorPx: result.errorPx ? result.errorPx.toFixed(2) : null,\n        calibrationPoints: calibrationPoints.map((p) => ({\n          x: Math.round(p.x),\n          y: Math.round(p.y),\n        })),\n      },\n      result.message,\n    );\n\n    return result;\n  } catch (err) {\n    return {\n      success: false,\n      cx: canvas.width / 2,\n      cy: canvas.height / 2,\n      bullInner: 0,\n      bullOuter: 0,\n      trebleInner: 0,\n      trebleOuter: 0,\n      doubleInner: 0,\n      doubleOuter: 0,\n      confidence: 0,\n      homography: null,\n      errorPx: null,\n      calibrationPoints: [],\n      message: err instanceof Error ? err.message : \"Board detection failed\",\n    };\n  }\n}\n\n/**\n * Refine detection by looking for concentric rings\n * This helps match detected circles to specific board rings\n */\nexport function refineRingDetection(\n  detected: BoardDetectionResult,\n): BoardDetectionResult {\n  // v2.4: Don't reduce confidence based on ring ratios\n  // The v2.4 confidence calculation already accounts for detection quality\n  // Ratios being off just means different dartboard size/setup - not a quality issue\n  // The homography calculation handles the actual ring positions\n  return detected;\n}\n","/**\n * Network device discovery utilities for wifi scoring devices\n */\n\n// Web Serial API types\ndeclare global {\n  interface Navigator {\n    serial: Serial;\n  }\n  interface Serial extends EventTarget {\n    getPorts(): Promise<SerialPort[]>;\n    requestPort(options?: SerialOptions): Promise<SerialPort>;\n  }\n  interface SerialPort {\n    open(options: SerialOptions): Promise<void>;\n    close(): Promise<void>;\n    readable: ReadableStream<Uint8Array> | null;\n    writable: WritableStream<Uint8Array> | null;\n  }\n  interface SerialOptions {\n    baudRate?: number;\n    dataBits?: number;\n    stopBits?: number;\n    parity?: \"none\" | \"even\" | \"odd\";\n    bufferSize?: number;\n    flowControl?: \"none\" | \"hardware\";\n  }\n}\n\nexport interface NetworkDevice {\n  id: string;\n  name: string;\n  ip: string;\n  port: number;\n  type: \"omni\" | \"vert\" | \"generic\";\n  capabilities: string[];\n  status: \"online\" | \"offline\" | \"connecting\";\n  connectionType: \"wifi\" | \"usb\";\n}\n\n/**\n * USB device interface for serial-connected scoring devices\n */\nexport interface USBDevice {\n  id: string;\n  name: string;\n  type: \"omni\" | \"vert\" | \"generic\";\n  capabilities: string[];\n  status: \"online\" | \"offline\" | \"connecting\";\n  port: SerialPort | null;\n}\n\n/**\n * Discover wifi scoring devices on the local network\n */\nexport async function discoverNetworkDevices(): Promise<NetworkDevice[]> {\n  const devices: NetworkDevice[] = [];\n\n  try {\n    // Get local network info\n    const localIPs = await getLocalIPs();\n\n    for (const localIP of localIPs) {\n      // Scan common ports for dart scoring devices\n      const scanResults = await scanNetwork(\n        localIP,\n        [80, 8080, 8787, 8788, 3000, 5000],\n      );\n\n      for (const result of scanResults) {\n        const device = await probeDevice(result.ip, result.port);\n        if (device) {\n          devices.push(device);\n        }\n      }\n    }\n  } catch (error) {\n    console.error(\"Network discovery failed:\", error);\n  }\n\n  return devices;\n}\n\n/**\n * Get local IP addresses\n */\nasync function getLocalIPs(): Promise<string[]> {\n  const ips: string[] = [];\n\n  try {\n    // Try to get local IPs via WebRTC\n    const pc = new RTCPeerConnection({ iceServers: [] });\n    pc.createDataChannel(\"\");\n\n    const offer = await pc.createOffer();\n    await pc.setLocalDescription(offer);\n\n    return new Promise((resolve) => {\n      const timeout = setTimeout(() => {\n        pc.close();\n        resolve(ips);\n      }, 5000);\n\n      pc.onicecandidate = (event) => {\n        if (event.candidate) {\n          const candidate = event.candidate.candidate;\n          const ipMatch = candidate.match(/(\\d+\\.\\d+\\.\\d+\\.\\d+)/);\n          if (ipMatch && ipMatch[1] && !ips.includes(ipMatch[1])) {\n            const ip = ipMatch[1];\n            // Only include private IPs\n            if (isPrivateIP(ip)) {\n              ips.push(ip);\n            }\n          }\n        } else {\n          clearTimeout(timeout);\n          pc.close();\n          resolve(ips);\n        }\n      };\n    });\n  } catch (error) {\n    console.error(\"Failed to get local IPs:\", error);\n    return [\"192.168.1.0\"]; // fallback\n  }\n}\n\n/**\n * Check if IP is in private range\n */\nfunction isPrivateIP(ip: string): boolean {\n  const parts = ip.split(\".\").map(Number);\n  return (\n    parts[0] === 10 ||\n    (parts[0] === 172 && parts[1] >= 16 && parts[1] <= 31) ||\n    (parts[0] === 192 && parts[1] === 168)\n  );\n}\n\n/**\n * Scan network for open ports\n */\nasync function scanNetwork(\n  localIP: string,\n  ports: number[],\n): Promise<{ ip: string; port: number }[]> {\n  const results: { ip: string; port: number }[] = [];\n  const baseIP = localIP.split(\".\").slice(0, 3).join(\".\");\n\n  // Scan a reasonable range (e.g., .1 to .254)\n  const promises = [];\n  for (let i = 1; i <= 254; i++) {\n    const ip = `${baseIP}.${i}`;\n    for (const port of ports) {\n      promises.push(checkPort(ip, port));\n    }\n  }\n\n  const portResults = await Promise.allSettled(promises);\n\n  portResults.forEach((result, index) => {\n    if (result.status === \"fulfilled\" && result.value) {\n      const portIndex = index % ports.length;\n      const ipIndex = Math.floor(index / ports.length);\n      const ip = `${baseIP}.${ipIndex + 1}`;\n      results.push({ ip, port: ports[portIndex] });\n    }\n  });\n\n  return results;\n}\n\n/**\n * Check if a specific port is open on an IP\n */\nasync function checkPort(ip: string, port: number): Promise<boolean> {\n  try {\n    await fetch(`http://${ip}:${port}/`, {\n      method: \"HEAD\",\n      mode: \"no-cors\",\n      signal: AbortSignal.timeout(2000),\n    });\n    return true;\n  } catch {\n    return false;\n  }\n}\n\n/**\n * Probe a device to identify its type and capabilities\n */\nasync function probeDevice(\n  ip: string,\n  port: number,\n): Promise<NetworkDevice | null> {\n  try {\n    // Try common endpoints for dart scoring devices\n    const endpoints = [\"/\", \"/api/info\", \"/api/status\", \"/camera\", \"/stream\"];\n\n    for (const endpoint of endpoints) {\n      try {\n        const response = await fetch(`http://${ip}:${port}${endpoint}`, {\n          method: \"GET\",\n          signal: AbortSignal.timeout(3000),\n        });\n\n        if (response.ok) {\n          const contentType = response.headers.get(\"content-type\") || \"\";\n          const text = await response.text();\n\n          // Check for OMNI device\n          if (\n            text.includes(\"OMNI\") ||\n            text.includes(\"omni\") ||\n            endpoint.includes(\"omni\")\n          ) {\n            return {\n              id: `omni-${ip}-${port}`,\n              name: `OMNI Camera (${ip})`,\n              ip,\n              port,\n              type: \"omni\",\n              capabilities: [\"video\", \"calibration\"],\n              status: \"online\",\n              connectionType: \"wifi\",\n            };\n          }\n\n          // Check for VERT device\n          if (\n            text.includes(\"VERT\") ||\n            text.includes(\"vert\") ||\n            endpoint.includes(\"vert\")\n          ) {\n            return {\n              id: `vert-${ip}-${port}`,\n              name: `VERT Camera (${ip})`,\n              ip,\n              port,\n              type: \"vert\",\n              capabilities: [\"video\", \"calibration\"],\n              status: \"online\",\n              connectionType: \"wifi\",\n            };\n          }\n\n          // Check for generic video streaming device\n          if (\n            contentType.includes(\"video\") ||\n            text.includes(\"stream\") ||\n            endpoint === \"/stream\"\n          ) {\n            return {\n              id: `generic-${ip}-${port}`,\n              name: `Network Camera (${ip})`,\n              ip,\n              port,\n              type: \"generic\",\n              capabilities: [\"video\"],\n              status: \"online\",\n              connectionType: \"wifi\",\n            };\n          }\n        }\n      } catch {\n        // Continue to next endpoint\n      }\n    }\n  } catch (error) {\n    console.error(`Failed to probe device ${ip}:${port}:`, error);\n  }\n\n  return null;\n}\n\n/**\n * Discover USB scoring devices connected via serial\n */\nexport async function discoverUSBDevices(): Promise<USBDevice[]> {\n  const devices: USBDevice[] = [];\n\n  try {\n    // Check if Web Serial API is supported\n    if (!(\"serial\" in navigator)) {\n      console.warn(\"Web Serial API not supported in this browser\");\n      return devices;\n    }\n\n    // Get already paired ports\n    const ports = await navigator.serial.getPorts();\n\n    for (const port of ports) {\n      const device = await probeUSBDevice(port);\n      if (device) {\n        devices.push(device);\n      }\n    }\n\n    // Also try to request a new port (this will show user selection dialog)\n    // Note: This is optional and will be handled separately in the UI\n  } catch (error) {\n    console.error(\"USB device discovery failed:\", error);\n  }\n\n  return devices;\n}\n\n/**\n * Request user to select a USB device\n */\nexport async function requestUSBDevice(): Promise<USBDevice | null> {\n  try {\n    if (!(\"serial\" in navigator)) {\n      alert(\n        \"Web Serial API not supported in this browser. Please use a compatible browser like Chrome or Edge.\",\n      );\n      return null;\n    }\n\n    const port = await navigator.serial.requestPort();\n    return await probeUSBDevice(port);\n  } catch (error) {\n    if ((error as any).name !== \"NotFoundError\") {\n      console.error(\"USB device request failed:\", error);\n    }\n    return null;\n  }\n}\n\n/**\n * Probe a USB serial port to identify the device type\n */\nasync function probeUSBDevice(port: SerialPort): Promise<USBDevice | null> {\n  try {\n    // Open the port with common settings for dart scoring devices\n    await port.open({\n      baudRate: 9600,\n      dataBits: 8,\n      stopBits: 1,\n      parity: \"none\",\n    });\n\n    // Try to read some data to identify the device\n    const reader = port.readable?.getReader();\n    if (reader) {\n      try {\n        // Set a timeout for reading\n        const timeout = setTimeout(() => reader.cancel(), 2000);\n\n        const { value, done } = await reader.read();\n        clearTimeout(timeout);\n\n        if (!done && value) {\n          const text = new TextDecoder().decode(value);\n\n          // Check for OMNI device\n          if (text.includes(\"OMNI\") || text.includes(\"omni\")) {\n            reader.releaseLock();\n            return {\n              id: `usb-omni-${Date.now()}`,\n              name: \"OMNI Camera (USB)\",\n              type: \"omni\",\n              capabilities: [\"video\", \"calibration\"],\n              status: \"online\",\n              port,\n            };\n          }\n\n          // Check for VERT device\n          if (text.includes(\"VERT\") || text.includes(\"vert\")) {\n            reader.releaseLock();\n            return {\n              id: `usb-vert-${Date.now()}`,\n              name: \"VERT Camera (USB)\",\n              type: \"vert\",\n              capabilities: [\"video\", \"calibration\"],\n              status: \"online\",\n              port,\n            };\n          }\n        }\n      } catch {\n        // Continue\n      } finally {\n        try {\n          reader.releaseLock();\n        } catch {}\n      }\n    }\n\n    // If we can't identify, assume it's a generic device\n    return {\n      id: `usb-generic-${Date.now()}`,\n      name: \"USB Scoring Device\",\n      type: \"generic\",\n      capabilities: [\"video\"],\n      status: \"online\",\n      port,\n    };\n  } catch (error) {\n    console.error(\"Failed to probe USB device:\", error);\n    return null;\n  }\n}\n\n/**\n * Connect to a network device and get video stream\n */\nexport async function connectToNetworkDevice(\n  device: NetworkDevice,\n): Promise<MediaStream | null> {\n  try {\n    // For now, assume devices provide an MJPEG or HLS stream\n    // This would need to be adapted based on the actual device API\n    const streamUrl = `http://${device.ip}:${device.port}/stream`;\n\n    // Create a video element to capture the stream\n    const video = document.createElement(\"video\");\n    video.src = streamUrl;\n    video.crossOrigin = \"anonymous\";\n\n    return new Promise((resolve, reject) => {\n      video.onloadeddata = () => {\n        const canvas = document.createElement(\"canvas\");\n        const ctx = canvas.getContext(\"2d\")!;\n        canvas.width = video.videoWidth;\n        canvas.height = video.videoHeight;\n\n        // Create a MediaStream from the video\n        const stream = canvas.captureStream(30); // 30 FPS\n\n        const drawFrame = () => {\n          if (video.readyState >= 2) {\n            ctx.drawImage(video, 0, 0);\n          }\n          requestAnimationFrame(drawFrame);\n        };\n        drawFrame();\n\n        resolve(stream);\n      };\n\n      video.onerror = () => reject(new Error(\"Failed to load video stream\"));\n      video.load();\n    });\n  } catch (error) {\n    console.error(\"Failed to connect to network device:\", error);\n    return null;\n  }\n}\n\n/**\n * Connect to a USB device and get video stream\n */\nexport async function connectToUSBDevice(\n  device: USBDevice,\n): Promise<MediaStream | null> {\n  try {\n    if (!device.port) {\n      throw new Error(\"No serial port available\");\n    }\n\n    // For USB devices, we assume they provide video through a companion app or driver\n    // This is a placeholder - actual implementation would depend on the device protocol\n    console.log(\"USB device connection not fully implemented yet\");\n    return null;\n  } catch (error) {\n    console.error(\"Failed to connect to USB device:\", error);\n    return null;\n  }\n}\n","import { create } from \"zustand\";\nimport { dinfo } from \"../utils/logger\";\n\nexport type VisitAudit = {\n  ts: number;\n  mode: string;\n  darts: number;\n  visitTotal: number;\n  preOpenDarts?: number;\n  preRemaining?: number;\n  postRemaining?: number;\n  bust?: boolean;\n  finish?: boolean;\n  threeDartAvg?: number;\n};\n\ntype CalibrationAudit = {\n  hasHomography: boolean;\n  imageSize?: { w: number; h: number } | null;\n  lastUpdated?: number;\n};\n\ntype AuditState = {\n  // Rolling buffer of recent visits\n  recent: VisitAudit[];\n  // Aggregates\n  totals: {\n    visits: number;\n    darts: number;\n    points: number;\n    finishes: number;\n    busts: number;\n    byMode: Record<string, { visits: number; darts: number; points: number }>;\n  };\n  calibration: CalibrationAudit;\n  recordVisit: (\n    mode: string,\n    darts: number,\n    visitTotal: number,\n    meta?: Partial<VisitAudit>,\n  ) => void;\n  setCalibrationStatus: (c: Partial<CalibrationAudit>) => void;\n  reset: () => void;\n};\n\nexport const useAudit = create<AuditState>((set) => ({\n  recent: [],\n  totals: { visits: 0, darts: 0, points: 0, finishes: 0, busts: 0, byMode: {} },\n  calibration: {\n    hasHomography: false,\n    imageSize: null,\n    lastUpdated: undefined,\n  },\n  recordVisit: (mode, darts, visitTotal, meta) =>\n    set((state) => {\n      const ts = Date.now();\n      const item: VisitAudit = {\n        ts,\n        mode,\n        darts,\n        visitTotal,\n        preOpenDarts: meta?.preOpenDarts,\n        preRemaining: meta?.preRemaining,\n        postRemaining: meta?.postRemaining,\n        bust: meta?.bust,\n        finish: meta?.finish,\n        threeDartAvg: meta?.threeDartAvg,\n      };\n      const recent = [...state.recent, item].slice(-50);\n      const totals = { ...state.totals };\n      totals.visits += 1;\n      totals.darts += darts;\n      totals.points += visitTotal;\n      if (item.finish) totals.finishes += 1;\n      if (item.bust) totals.busts += 1;\n      const bm = totals.byMode[mode] || { visits: 0, darts: 0, points: 0 };\n      bm.visits += 1;\n      bm.darts += darts;\n      bm.points += visitTotal;\n      totals.byMode[mode] = bm;\n      // Console surface for quick verification without UI changes\n      try {\n        const tag = item.finish ? \"FINISH\" : item.bust ? \"BUST\" : \"VISIT\";\n        const info = {\n          mode,\n          darts,\n          visitTotal,\n          preOpenDarts: item.preOpenDarts ?? 0,\n          preRemaining: item.preRemaining,\n          postRemaining: item.postRemaining,\n          threeDartAvg: item.threeDartAvg,\n        } as any;\n        dinfo(`[Audit:${tag}]`, info);\n      } catch {}\n      // Persist recent visits to localStorage so Home can show recent across reloads\n      try {\n        localStorage.setItem(\"ndn_audit_recent\", JSON.stringify(recent));\n      } catch {}\n      return { ...state, recent, totals };\n    }),\n  setCalibrationStatus: (c) =>\n    set((state) => {\n      const updated: CalibrationAudit = {\n        hasHomography: c.hasHomography ?? state.calibration.hasHomography,\n        imageSize:\n          c.imageSize === undefined ? state.calibration.imageSize : c.imageSize,\n        lastUpdated: Date.now(),\n      };\n      try {\n        dinfo(\"[Audit:Calibration]\", updated);\n      } catch {}\n      return { ...state, calibration: updated };\n    }),\n  reset: () =>\n    set({\n      recent: [],\n      totals: {\n        visits: 0,\n        darts: 0,\n        points: 0,\n        finishes: 0,\n        busts: 0,\n        byMode: {},\n      },\n      calibration: {\n        hasHomography: false,\n        imageSize: null,\n        lastUpdated: undefined,\n      },\n    }),\n}));\n\n// Expose a tiny debug hook on window for manual checks when needed\ntry {\n  // @ts-ignore\n  if (typeof window !== \"undefined\")\n    (window as any).__NDN_AUDIT__ = {\n      get: () => useAudit.getState(),\n      subscribe: useAudit.subscribe,\n      reset: () => useAudit.getState().reset(),\n    };\n} catch {}\n\n// Initialize persisted recent visits if present\ntry {\n  if (typeof window !== \"undefined\") {\n    const raw = localStorage.getItem(\"ndn_audit_recent\");\n    if (raw) {\n      const arr = JSON.parse(raw);\n      if (Array.isArray(arr) && arr.length) {\n        useAudit.setState((s) => ({ ...s, recent: arr.slice(-50) }));\n      }\n    }\n  }\n} catch {}\n","// Small, dependency-free broadcast helpers for inter-window messaging.\n// NOTE: we avoid replacing or adding global handlers here; test setup\n// in `src/setupTests.ts` installs a mock BroadcastChannel for Vitest which\n// is preferable. The rest of this module prefers `window.BroadcastChannel`\n// where available and safely falls back to localStorage + custom window\n// events in environments where a BroadcastChannel is not appropriate.\nconst STORAGE_KEY = \"ndn:match-sync\";\nconst CHANNEL = \"ndn-match-sync\";\n\nexport function broadcastMessage(msg: any) {\n  try {\n    // Prefer browser BroadcastChannel when available. Some Node/JSDOM/Bundled\n    // environments implement BroadcastChannel but with incompatible internals\n    // so we only use the native window.BroadcastChannel implementation where\n    // possible. In Node, the built-in BroadcastChannel can be problematic (it\n    // will dispatch Node MessageEvent objects that are not DOM Events), so we\n    // avoid using global BroadcastChannel in Node unless a test/mock replaces it\n    // with a non-native implementation.\n\n    const winBC =\n      typeof window !== \"undefined\" && (window as any).BroadcastChannel\n        ? (window as any).BroadcastChannel\n        : null;\n    let canUseBC = false;\n    // Only use BroadcastChannel if it is implemented on the window (browser or jsdom).\n    if (winBC && typeof winBC === \"function\") {\n      canUseBC = true;\n    }\n    if (canUseBC) {\n      // Use the window constructor\n      const ctor = winBC;\n      try {\n        const bc = new ctor(CHANNEL);\n        try {\n          bc.postMessage(msg);\n        } finally {\n          try {\n            bc.close();\n          } catch {}\n        }\n        return;\n      } catch (e) {\n        // Fall through to localStorage fallback\n      }\n    }\n    // Fallback to localStorage event for cross-tab messaging\n  } catch {\n    try {\n      // fallback: write a one-off message into localStorage so other tabs\n      // listening to storage events can pick it up.\n      localStorage.setItem(\n        `${STORAGE_KEY}:lastmsg`,\n        JSON.stringify({ msg, ts: Date.now() }),\n      );\n      // Fire a storage event so listeners wake up (some browsers don't fire for same-tab writes)\n      try {\n        // Prefer StorageEvent when available\n        // Some test environments (jsdom) may not fully implement StorageEvent, so fall back.\n        const se = new StorageEvent(\"storage\", {\n          key: `${STORAGE_KEY}:lastmsg`,\n          newValue: localStorage.getItem(`${STORAGE_KEY}:lastmsg`),\n        });\n        window.dispatchEvent(se);\n      } catch {\n        try {\n          window.dispatchEvent(new Event(\"storage\"));\n        } catch {}\n      }\n      // Also dispatch a same-window custom event to reliably notify listeners in this tab (useful for tests)\n      try {\n        window.dispatchEvent(\n          new CustomEvent(\"ndn:match-sync\", { detail: { msg } }),\n        );\n      } catch {}\n    } catch {}\n  }\n}\n\nexport function subscribeMatchSync(onMessage: (msg: any) => void) {\n  let bc: BroadcastChannel | null = null;\n  try {\n    const winBC =\n      typeof window !== \"undefined\" && (window as any).BroadcastChannel\n        ? (window as any).BroadcastChannel\n        : null;\n    let canUseBC = false;\n    if (winBC && typeof winBC === \"function\") {\n      canUseBC = true;\n    }\n    if (canUseBC) {\n      try {\n        const ctor = winBC;\n        bc = new ctor(CHANNEL);\n      } catch (e) {\n        throw new Error(\"no-bc\");\n      }\n    } else {\n      throw new Error(\"no-bc\");\n    }\n    if (bc) {\n      bc.onmessage = (ev: any) => {\n        try {\n          onMessage(ev.data);\n        } catch {}\n      };\n    }\n  } catch {\n    const onStorage = () => {\n      try {\n        const raw = localStorage.getItem(`${STORAGE_KEY}:lastmsg`);\n        if (!raw) return;\n        const parsed = JSON.parse(raw);\n        onMessage(parsed.msg);\n      } catch {}\n    };\n    const onCustom = (ev: any) => {\n      try {\n        if (!ev?.detail) return;\n        onMessage(ev.detail.msg);\n      } catch {}\n    };\n    window.addEventListener(\"storage\", onStorage);\n    window.addEventListener(\"ndn:match-sync\", onCustom as EventListener);\n    return () => {\n      window.removeEventListener(\"storage\", onStorage);\n      window.removeEventListener(\"ndn:match-sync\", onCustom as EventListener);\n    };\n  }\n  return () => {\n    try {\n      if (bc) bc.close();\n    } catch {}\n  };\n}\n","import { create } from \"zustand\";\nimport { useAudit } from \"./audit\";\nimport { broadcastMessage } from \"../utils/broadcast\";\n// Use a dynamic import for profileStats to avoid circular import / TDZ during\n// module initialization. Calling addMatchToAllTime is only needed when a\n// match ends, so lazy-loading is safe and avoids import cycles.\n\nexport type ThrowVisit = {\n  darts: number;\n  score: number;\n  preOpenDarts?: number; // exclude from avg in Double-In\n  doubleWindowDarts?: number; // darts thrown while remaining <= 50 (double-out window) in this visit\n  finishedByDouble?: boolean; // visit ended the leg with a double or inner bull\n  visitTotal?: number; // convenience to detect 180s and summaries\n  // Optional per-dart breakdown (dart1..dart3 etc). This is useful for\n  // debugging/analytics and to avoid UI ambiguity where a MISS (0) could be\n  // mistaken as \"no dart recorded\".\n  entries?: { label: string; value: number; ring: string }[];\n};\nexport type Leg = {\n  visits: ThrowVisit[];\n  totalScoreStart: number; // e.g., 501\n  totalScoreRemaining: number;\n  dartsThrown: number;\n  finished: boolean;\n  checkoutScore: number | null; // score taken on final visit to finish leg\n  startTime: number;\n  endTime?: number;\n};\n\nexport type Player = {\n  id: string;\n  name: string;\n  legsWon: number;\n  legs: Leg[];\n  bestThreeDartAvg?: number;\n  worstThreeDartAvg?: number;\n  bestNineDart?: { darts: number; timestamp: number };\n  bestCheckout?: number;\n  currentThreeDartAvg?: number; // Live stat that updates after every 3 darts\n};\n\nexport type MatchState = {\n  roomId: string;\n  players: Player[];\n  currentPlayerIdx: number;\n  startingScore: number;\n  inProgress: boolean;\n  bestLegThisMatch?: { playerId: string; darts: number; timestamp: number };\n};\n\nfunction calcThreeDartAvg(leg: Leg): number {\n  // Exclude any 'preOpenDarts' from the divisor (these darts are thrown before\n  // scoring opens in double-in games and should not count toward the average).\n  const totalPreOpen = (leg.visits || []).reduce(\n    (acc, v) => acc + (v.preOpenDarts || 0),\n    0,\n  );\n  const dartsForAvg = Math.max(0, leg.dartsThrown - totalPreOpen);\n  if (dartsForAvg === 0) return 0;\n  const scored = leg.totalScoreStart - leg.totalScoreRemaining;\n  return (scored / dartsForAvg) * 3;\n}\n\nfunction finishedLegStats(leg: Leg) {\n  // compute 3-dart avg, was it a 9-dart (or lowest darts)?\n  const avg = calcThreeDartAvg(leg);\n  const isCompleted = leg.finished;\n  return {\n    avg,\n    isCompleted,\n    darts: leg.dartsThrown,\n    checkout: leg.checkoutScore ?? 0,\n  };\n}\n\nfunction updatePlayerEndOfGameStats(player: Player) {\n  if (player.legs.length === 0) return;\n  const avgs: number[] = [];\n  let bestNine: { darts: number; timestamp: number } | undefined;\n  let bestCheckout = player.bestCheckout ?? 0;\n\n  for (const leg of player.legs) {\n    if (!leg.finished) continue;\n    const st = finishedLegStats(leg);\n    avgs.push(st.avg);\n    // best \"9-dart leg\" meaning fewest darts; if tie pick earliest\n    if (\n      !bestNine ||\n      st.darts < bestNine.darts ||\n      (st.darts === bestNine.darts && (leg.endTime ?? 0) < bestNine.timestamp)\n    ) {\n      bestNine = { darts: st.darts, timestamp: leg.endTime ?? Date.now() };\n    }\n    if (st.checkout > bestCheckout) bestCheckout = st.checkout;\n  }\n\n  if (avgs.length) {\n    player.bestThreeDartAvg = Math.max(...avgs);\n    player.worstThreeDartAvg = Math.min(...avgs);\n  }\n  if (bestNine) player.bestNineDart = bestNine;\n  player.bestCheckout = bestCheckout;\n}\n\nexport type Actions = {\n  newMatch: (players: string[], startingScore: number, roomId?: string) => void;\n  addVisit: (\n    score: number,\n    darts: number,\n    meta?: {\n      preOpenDarts?: number;\n      doubleWindowDarts?: number;\n      finishedByDouble?: boolean;\n      visitTotal?: number;\n      // Optional per-dart breakdown for this visit.\n      entries?: { label: string; value: number; ring: string }[];\n    },\n  ) => void;\n  undoVisit: () => void;\n  endLeg: (checkoutScore: number) => void;\n  nextPlayer: () => void;\n  endGame: () => void;\n  importState: (state: MatchState) => void;\n  setPlayerCurrentAverage: (playerIndex: number, avg: number) => void;\n};\n\nexport const useMatch = create<MatchState & Actions>((set) => ({\n  roomId: \"\",\n  players: [],\n  currentPlayerIdx: 0,\n  startingScore: 501,\n  inProgress: false,\n\n  newMatch: (playerNames, startingScore, roomId = \"\") =>\n    set(() => {\n      const players = playerNames.map(\n        (name, i) =>\n          ({\n            id: `${i}`,\n            name,\n            legsWon: 0,\n            legs: [],\n          }) as Player,\n      );\n      console.debug(\"[useMatch] newMatch\", playerNames, startingScore, roomId);\n      return {\n        players,\n        currentPlayerIdx: 0,\n        startingScore,\n        inProgress: true,\n        roomId,\n        bestLegThisMatch: undefined,\n      };\n    }),\n\n  addVisit: (score, darts, meta) =>\n    set((state) => {\n      console.debug(\"[useMatch] addVisit\", {\n        score,\n        darts,\n        inProgress: state.inProgress,\n        currentPlayerIdx: state.currentPlayerIdx,\n        players: state.players.length,\n      });\n      if (!state.inProgress) return state;\n      const playerIdx = state.currentPlayerIdx;\n      const oldPlayer = state.players[playerIdx];\n      // ensure a current leg exists\n      const oldLeg = oldPlayer.legs[oldPlayer.legs.length - 1];\n      let leg: Leg;\n      let legsArr: Leg[];\n      if (!oldLeg || oldLeg.finished) {\n        leg = {\n          visits: [],\n          totalScoreStart: state.startingScore,\n          totalScoreRemaining: state.startingScore,\n          dartsThrown: 0,\n          finished: false,\n          checkoutScore: null,\n          startTime: Date.now(),\n        };\n        legsArr = [...oldPlayer.legs, leg];\n      } else {\n        leg = { ...oldLeg, visits: [...oldLeg.visits] };\n        legsArr = [...oldPlayer.legs.slice(0, -1), leg];\n      }\n      const preRem = leg.totalScoreRemaining;\n      // IMPORTANT: `score` is the value passed by callers and historically was sometimes\n      // \"the last dart's score\" while `meta.visitTotal` is the total for the whole visit.\n      // For X01 remaining math we must subtract the *visit total* (points scored this visit).\n      const visitTotal = Number(meta?.visitTotal ?? score);\n      const postRem = Math.max(0, preRem - visitTotal);\n      leg.visits.push({\n        darts,\n        score,\n        preOpenDarts: meta?.preOpenDarts,\n        doubleWindowDarts: meta?.doubleWindowDarts,\n        finishedByDouble: meta?.finishedByDouble,\n        visitTotal,\n        entries: Array.isArray(meta?.entries)\n          ? meta!.entries.map((e) => ({\n              label: String((e as any).label ?? \"\"),\n              value: Number((e as any).value ?? 0),\n              ring: String((e as any).ring ?? \"\"),\n            }))\n          : undefined,\n      });\n      leg.dartsThrown += darts;\n      leg.totalScoreRemaining = postRem;\n      // Create new player object with updated leg and currentThreeDartAvg\n      const p: Player = { ...oldPlayer, legs: legsArr };\n      // Audit record (best-effort; ignore failures)\n      try {\n        const bust = score === 0 && darts > 0 && postRem === preRem;\n        const finish = postRem === 0;\n        const avgPayload: any = {};\n        // Exclude pre-open darts from the divisor used for averages\n        const totalPreOpen = (leg.visits || []).reduce(\n          (acc, v) => acc + (v.preOpenDarts || 0),\n          0,\n        );\n        const dartsForAvg = Math.max(0, leg.dartsThrown - totalPreOpen);\n        if (dartsForAvg > 0 && (dartsForAvg % 3 === 0 || finish)) {\n          const avg = calcThreeDartAvg(leg);\n          if (Math.abs((p.currentThreeDartAvg ?? 0) - avg) > 0.0001) {\n            p.currentThreeDartAvg = avg;\n          }\n          avgPayload.threeDartAvg = avg;\n        }\n        // Audit should record the visit's total points, not a single dart score.\n        useAudit.getState().recordVisit(\"x01-match\", darts, visitTotal, {\n          preOpenDarts: meta?.preOpenDarts ?? 0,\n          preRemaining: preRem,\n          postRemaining: postRem,\n          ...avgPayload,\n          bust,\n          finish,\n        });\n      } catch {}\n      try {\n        // notify other windows a visit occurred\n        broadcastMessage({\n          type: \"visit\",\n          score: visitTotal,\n          darts,\n          playerIdx: state.currentPlayerIdx,\n          ts: Date.now(),\n        });\n      } catch {}\n      // Create new players array with the updated player to trigger re-render\n      const newPlayers = state.players.map((pl, i) =>\n        i === playerIdx ? p : pl,\n      );\n      return { ...state, players: newPlayers };\n    }),\n\n  undoVisit: () =>\n    set((state) => {\n      const playerIdx = state.currentPlayerIdx;\n      const oldPlayer = state.players[playerIdx];\n      const oldLeg = oldPlayer.legs[oldPlayer.legs.length - 1];\n      if (!oldLeg || oldLeg.finished || oldLeg.visits.length === 0)\n        return state;\n      const newVisits = oldLeg.visits.slice(0, -1);\n      const last = oldLeg.visits[oldLeg.visits.length - 1];\n      const lastVisitTotal = Number((last as any).visitTotal ?? last.score);\n      const newLeg: Leg = {\n        ...oldLeg,\n        visits: newVisits,\n        dartsThrown: oldLeg.dartsThrown - last.darts,\n        totalScoreRemaining: oldLeg.totalScoreRemaining + lastVisitTotal,\n      };\n      const newLegs = [...oldPlayer.legs.slice(0, -1), newLeg];\n      const newPlayer: Player = { ...oldPlayer, legs: newLegs };\n      const newPlayers = state.players.map((pl, i) =>\n        i === playerIdx ? newPlayer : pl,\n      );\n      return { ...state, players: newPlayers };\n    }),\n\n  endLeg: (checkoutScore) =>\n    set((state) => {\n      const playerIdx = state.currentPlayerIdx;\n      const oldPlayer = state.players[playerIdx];\n      const oldLeg = oldPlayer.legs[oldPlayer.legs.length - 1];\n      if (!oldLeg || oldLeg.finished) return state;\n      const endTime = Date.now();\n      const newLeg: Leg = {\n        ...oldLeg,\n        finished: true,\n        checkoutScore,\n        endTime,\n      };\n      const newLegs = [...oldPlayer.legs.slice(0, -1), newLeg];\n      let newLegsWon = oldPlayer.legsWon;\n      let newBestLeg = state.bestLegThisMatch;\n      if (newLeg.totalScoreRemaining === 0) {\n        newLegsWon += 1;\n        // Check if this leg is the new best for this match (fewest darts)\n        if (!newBestLeg || newLeg.dartsThrown < newBestLeg.darts) {\n          newBestLeg = {\n            playerId: oldPlayer.id,\n            darts: newLeg.dartsThrown,\n            timestamp: endTime,\n          };\n        }\n      }\n      const newPlayer: Player = {\n        ...oldPlayer,\n        legs: newLegs,\n        legsWon: newLegsWon,\n      };\n      const newPlayers = state.players.map((pl, i) =>\n        i === playerIdx ? newPlayer : pl,\n      );\n      try {\n        broadcastMessage({\n          type: \"endLeg\",\n          checkoutScore,\n          playerIdx: state.currentPlayerIdx,\n          ts: Date.now(),\n        });\n      } catch {}\n      return { ...state, players: newPlayers, bestLegThisMatch: newBestLeg };\n    }),\n\n  nextPlayer: () =>\n    set((state) => {\n      const next = (state.currentPlayerIdx + 1) % state.players.length;\n      try {\n        broadcastMessage({\n          type: \"nextPlayer\",\n          currentPlayerIdx: next,\n          ts: Date.now(),\n        });\n      } catch {}\n      return { ...state, currentPlayerIdx: next };\n    }),\n\n  endGame: () =>\n    set((state) => {\n      if (!state.inProgress) return state; // avoid double-count\n      // Only now compute best/worst 3-dart, best 9-dart, best checkout\n      // Create new player objects with updated stats\n      const newPlayers = state.players.map((p) => {\n        const updated = { ...p, currentThreeDartAvg: 0 };\n        updatePlayerEndOfGameStats(updated);\n        return updated;\n      });\n      try {\n        // Persist all-time stats and backfill rolling averages when no\n        // per-visit samples were recorded for this match.\n        // Use dynamic import to avoid circular import / TDZ issues at module init.\n        import(\"./profileStats\").then((m) => {\n          try {\n            m.addMatchToAllTime(newPlayers, { recordSeries: true });\n          } catch {}\n        });\n      } catch {}\n      try {\n        broadcastMessage({ type: \"endGame\", ts: Date.now() });\n      } catch {}\n      return { ...state, players: newPlayers, inProgress: false };\n    }),\n\n  importState: (newState) => set(() => ({ ...newState })),\n  setPlayerCurrentAverage: (playerIndex, avg) =>\n    set((state) => {\n      const oldPlayer = state.players[playerIndex];\n      if (!oldPlayer) return state;\n      if (Math.abs((oldPlayer.currentThreeDartAvg ?? 0) - avg) > 0.0001) {\n        const newPlayer: Player = { ...oldPlayer, currentThreeDartAvg: avg };\n        const newPlayers = state.players.map((pl, i) =>\n          i === playerIndex ? newPlayer : pl,\n        );\n        return { ...state, players: newPlayers };\n      }\n      return state;\n    }),\n}));\n","const fallbackRemoteEnv =\n  ((import.meta as any)?.env?.VITE_REMOTE_WS_FALLBACK as string | undefined) ||\n  \"\";\n\nconst DEFAULT_REMOTE_WS = \"wss://ninedartnation-1.onrender.com/ws\";\nconst REMOTE_WS_FALLBACK = normalizeWsUrl(\n  fallbackRemoteEnv.trim() || DEFAULT_REMOTE_WS,\n);\n\nconst LOCAL_HOSTS = new Set([\"localhost\", \"127.0.0.1\"]);\nconst DEV_SERVICE_PORT = 8787;\nconst ALT_DEV_PORT = 3000;\n\nfunction normalizeWsUrl(url: string): string {\n  const trimmed = url.trim();\n  if (!trimmed) return \"\";\n  if (/\\/ws$/i.test(trimmed)) return trimmed;\n  return `${trimmed.replace(/\\/$/, \"\")}/ws`;\n}\n\nfunction extractHost(url: string | undefined): string | null {\n  if (!url) return null;\n  try {\n    return new URL(url).hostname.toLowerCase();\n  } catch {\n    return null;\n  }\n}\n\nfunction isLocalHost(host: string | null | undefined) {\n  return !!host && LOCAL_HOSTS.has(host);\n}\n\nlet cachedWsUrl: string | null = null;\n\nfunction computePreferredWsUrl(): string {\n  if (cachedWsUrl) return cachedWsUrl;\n  const envUrl = (\n    (import.meta as any)?.env?.VITE_WS_URL as string | undefined\n  )?.trim();\n  if (envUrl) {\n    const normalized = normalizeWsUrl(envUrl);\n    if (typeof window !== \"undefined\") {\n      const envHost = extractHost(normalized);\n      const pageHost = window.location.hostname;\n      if (isLocalHost(envHost) && !isLocalHost(pageHost)) {\n        cachedWsUrl = REMOTE_WS_FALLBACK;\n        return cachedWsUrl;\n      }\n    }\n    cachedWsUrl = normalized;\n    return cachedWsUrl;\n  }\n  if (typeof window !== \"undefined\") {\n    const proto = window.location.protocol === \"https:\" ? \"wss\" : \"ws\";\n    const host = window.location.hostname;\n    const sameOrigin = `${proto}://${window.location.host}/ws`;\n    if (isLocalHost(host)) {\n      cachedWsUrl = `${proto}://${host}:${DEV_SERVICE_PORT}/ws`;\n    } else if (host.endsWith(\"onrender.com\")) {\n      cachedWsUrl = sameOrigin;\n    } else if (host.endsWith(\"netlify.app\")) {\n      cachedWsUrl = REMOTE_WS_FALLBACK;\n    } else {\n      cachedWsUrl = REMOTE_WS_FALLBACK;\n    }\n    return cachedWsUrl;\n  }\n  cachedWsUrl = REMOTE_WS_FALLBACK;\n  return cachedWsUrl;\n}\n\nexport function getPreferredWsUrl(): string {\n  return computePreferredWsUrl();\n}\n\nexport function getWsCandidates(): string[] {\n  if (typeof window === \"undefined\") return [getPreferredWsUrl()];\n  const proto = window.location.protocol === \"https:\" ? \"wss\" : \"ws\";\n  const host = window.location.hostname;\n  const withPort = window.location.host;\n  const preferred = getPreferredWsUrl();\n  const candidates = new Set<string>([\n    preferred,\n    `${proto}://${withPort}/ws`,\n    `${proto}://${host}/ws`,\n    `${proto}://${host}:${DEV_SERVICE_PORT}/ws`,\n    `${proto}://${host}:${ALT_DEV_PORT}/ws`,\n    REMOTE_WS_FALLBACK,\n  ]);\n  return Array.from(candidates).filter(Boolean);\n}\n","import React, {\n  createContext,\n  useCallback,\n  useContext,\n  useEffect,\n  useMemo,\n  useRef,\n  useState,\n  type ReactNode,\n} from \"react\";\nimport { getWsCandidates } from \"../utils/ws\";\n\ntype WSMessage = any;\n\ntype WSStatus = \"connecting\" | \"connected\" | \"disconnected\";\ntype WSContextType = {\n  connected: boolean;\n  status: WSStatus;\n  send: (msg: WSMessage) => void;\n  addListener: (fn: (data: WSMessage) => void) => () => void;\n  reconnect: () => void;\n};\n\nexport const WSContext = createContext<WSContextType | null>(null);\n\nexport function WSProvider({ children }: { children: ReactNode }) {\n  const [connected, setConnected] = useState(false);\n  const [status, setStatus] = useState<WSStatus>(\"connecting\");\n  const wsRef = useRef<WebSocket | null>(null);\n  const listenersRef = useRef(new Set<(data: WSMessage) => void>());\n  const shouldReconnectRef = useRef(true);\n  const attemptsRef = useRef(0);\n  const timerRef = useRef<ReturnType<typeof setTimeout> | null>(null);\n  const heartbeatRef = useRef<ReturnType<typeof setInterval> | null>(null);\n\n  const endpointsRef = useRef<string[] | null>(null);\n  const endpointIdxRef = useRef(0);\n  const debug = false;\n\n  const ensureEndpoints = () => {\n    if (endpointsRef.current) return endpointsRef.current;\n    endpointsRef.current = getWsCandidates();\n    return endpointsRef.current;\n  };\n\n  const rotateEndpoint = () => {\n    const eps = ensureEndpoints();\n    endpointIdxRef.current = (endpointIdxRef.current + 1) % eps.length;\n    return eps[endpointIdxRef.current];\n  };\n\n  const currentEndpoint = () => {\n    const eps = ensureEndpoints();\n    return eps[endpointIdxRef.current] || eps[0];\n  };\n\n  const connect = useCallback(() => {\n    if (\n      wsRef.current &&\n      (wsRef.current.readyState === WebSocket.OPEN ||\n        wsRef.current.readyState === WebSocket.CONNECTING)\n    )\n      return;\n    setStatus(\"connecting\");\n    const base = currentEndpoint();\n    const url = `${base}`;\n    if (debug) console.log(\"[WS] connecting to\", url);\n    const ws = new WebSocket(url);\n    wsRef.current = ws;\n    ws.onopen = () => {\n      setConnected(true);\n      setStatus(\"connected\");\n      attemptsRef.current = 0;\n      // start heartbeat\n      if (heartbeatRef.current) clearInterval(heartbeatRef.current);\n      heartbeatRef.current = setInterval(() => {\n        try {\n          wsRef.current?.readyState === WebSocket.OPEN &&\n            wsRef.current?.send(\n              JSON.stringify({ type: \"ping\", t: Date.now() }),\n            );\n        } catch {}\n      }, 20000);\n      if (debug) console.log(\"[WS] connected\");\n    };\n    ws.onmessage = (ev) => {\n      try {\n        const data = JSON.parse(ev.data);\n        listenersRef.current.forEach((fn) => {\n          try {\n            fn(data);\n          } catch {}\n        });\n      } catch {}\n    };\n    ws.onerror = () => {\n      if (debug) console.log(\"[WS] socket error on\", currentEndpoint());\n    };\n    ws.onclose = () => {\n      setConnected(false);\n      setStatus(\"disconnected\");\n      if (heartbeatRef.current) {\n        clearInterval(heartbeatRef.current);\n        heartbeatRef.current = null;\n      }\n      if (!shouldReconnectRef.current) return;\n      const attempt = (attemptsRef.current || 0) + 1;\n      attemptsRef.current = attempt;\n      // rotate endpoint every 2 failed attempts for broader coverage\n      if (attempt % 2 === 0) rotateEndpoint();\n      if (debug)\n        console.log(\n          \"[WS] closed. attempt\",\n          attempt,\n          \"next endpoint\",\n          currentEndpoint(),\n        );\n      const base = 1000 * Math.pow(2, attempt - 1);\n      const jitter = Math.floor(Math.random() * 1000);\n      let delay = Math.min(30000, base + jitter);\n      // First retry should be immediate for instant reconnect UX\n      if (attempt === 1) delay = 0;\n      if (timerRef.current) clearTimeout(timerRef.current);\n      if (delay === 0) {\n        connect();\n      } else {\n        timerRef.current = setTimeout(connect, delay);\n      }\n    };\n  }, []);\n\n  const reconnect = useCallback(() => {\n    try {\n      // Prevent auto-retry logic from racing while we recreate\n      shouldReconnectRef.current = false;\n      if (timerRef.current) {\n        clearTimeout(timerRef.current);\n        timerRef.current = null;\n      }\n      if (heartbeatRef.current) {\n        clearInterval(heartbeatRef.current);\n        heartbeatRef.current = null;\n      }\n      try {\n        wsRef.current?.close();\n      } catch {}\n      wsRef.current = null;\n    } catch {}\n    // Reset counters and allow reconnect\n    attemptsRef.current = 0;\n    shouldReconnectRef.current = true;\n    setStatus(\"connecting\");\n    setConnected(false);\n    // Attempt immediate connect\n    connect();\n  }, [connect]);\n\n  useEffect(() => {\n    shouldReconnectRef.current = true;\n    connect();\n    const beforeUnload = () => {\n      shouldReconnectRef.current = false;\n      try {\n        wsRef.current?.close();\n      } catch {}\n    };\n    window.addEventListener(\"beforeunload\", beforeUnload);\n    const onVis = () => {\n      if (document.visibilityState === \"visible\") {\n        // nudge reconnect if needed\n        if (!connected) connect();\n      }\n    };\n    document.addEventListener(\"visibilitychange\", onVis);\n    window.addEventListener(\"online\", connect);\n    return () => {\n      shouldReconnectRef.current = false;\n      if (timerRef.current) clearTimeout(timerRef.current);\n      if (heartbeatRef.current) clearInterval(heartbeatRef.current);\n      try {\n        wsRef.current?.close();\n      } catch {}\n      document.removeEventListener(\"visibilitychange\", onVis);\n      window.removeEventListener(\"online\", connect);\n      window.removeEventListener(\"beforeunload\", beforeUnload);\n    };\n  }, [connect]);\n\n  const send = useCallback((msg: WSMessage) => {\n    try {\n      if (wsRef.current && wsRef.current.readyState === WebSocket.OPEN) {\n        wsRef.current.send(typeof msg === \"string\" ? msg : JSON.stringify(msg));\n      }\n    } catch {}\n  }, []);\n\n  const addListener = useCallback((fn: (data: WSMessage) => void) => {\n    listenersRef.current.add(fn);\n    return () => {\n      listenersRef.current.delete(fn);\n    };\n  }, []);\n\n  const value = useMemo(\n    () => ({ connected, status, send, addListener, reconnect }),\n    [connected, status, send, addListener, reconnect],\n  );\n  return <WSContext.Provider value={value}>{children}</WSContext.Provider>;\n}\n\nexport function useWS() {\n  const ctx = useContext(WSContext);\n  if (!ctx) throw new Error(\"useWS must be used within WSProvider\");\n  return ctx;\n}\n","import { useCallback, useEffect, useMemo, useRef, useState } from \"react\";\nimport { DartDetector } from \"../utils/dartDetector\";\n\nimport { useCalibration } from \"../store/calibration\";\nimport { useCameraSession } from \"../store/cameraSession\";\nimport {\n  BoardRadii,\n  CalibrationGuideRadii,\n  canonicalRimTargets,\n  computeHomographyDLT,\n  drawCross,\n  drawPolyline,\n  rmsError,\n  sampleRing,\n  refinePointsSobel,\n  applyHomography,\n  imageToBoard,\n  scoreAtBoardPoint,\n  scoreAtBoardPointTheta,\n  scaleHomography,\n  rotateHomography,\n  matMul3,\n  SectorOrder,\n  estimateSectorOffsetFromHomography,\n  type Homography,\n  type Point,\n} from \"../utils/vision\";\nimport {\n  detectMarkersFromCanvas,\n  MARKER_TARGETS,\n  markerIdToMatrix,\n  type MarkerDetection,\n} from \"../utils/markerCalibration\";\nimport {\n  detectBoard,\n  refineRingDetection,\n  type BoardDetectionResult,\n} from \"../utils/boardDetection\";\nimport { useUserSettings } from \"../store/userSettings\";\nimport {\n  discoverNetworkDevices,\n  connectToNetworkDevice,\n  type NetworkDevice,\n} from \"../utils/networkDevices\";\nimport { apiFetch } from \"../utils/api\";\nimport { useMatch } from \"../store/match\";\nimport { useWS } from \"./WSProvider\";\n\ndeclare const DROPDOWN_DEBUG: boolean | undefined;\nconst isTestEnv =\n  process.env.NODE_ENV === \"test\" ||\n  (typeof import.meta !== \"undefined\" && import.meta.env?.MODE === \"test\");\n\ntype Phase = \"idle\" | \"camera\" | \"capture\" | \"select\" | \"verify\" | \"computed\";\ntype CamMode = \"local\" | \"phone\" | \"wifi\";\n\ntype DevicePickerProps = {\n  videoDevices: Array<{ deviceId: string; label: string }>;\n  streaming: boolean;\n  refreshVideoDevices: () => Promise<void>;\n  testCamera: (deviceId?: string) => Promise<void>;\n  onSelectPhoneCamera: () => void;\n  lastDetectedLabel: string | null;\n  autoCommitTestMode: boolean;\n  doCommit: () => void;\n  lastDetectedValue: number | null;\n  cameraConnected: boolean;\n};\n\nconst DevicePicker: React.FC<DevicePickerProps> = ({\n  videoDevices,\n  streaming,\n  refreshVideoDevices,\n  testCamera,\n  onSelectPhoneCamera,\n  lastDetectedLabel,\n  autoCommitTestMode,\n  doCommit,\n  lastDetectedValue,\n  cameraConnected,\n}) => {\n  const {\n    preferredCameraId,\n    preferredCameraLabel,\n    setPreferredCamera,\n    cameraEnabled,\n    setCameraEnabled,\n    preferredCameraLocked,\n    setPreferredCameraLocked,\n  } = useUserSettings();\n\n  const [err, setErr] = useState<string>(\"\");\n  const [dropdownOpen, setDropdownOpen] = useState(false);\n  const dropdownRef = useRef<HTMLDivElement | null>(null);\n\n  const handleRefreshDevices = useCallback(async () => {\n    setErr(\"\");\n    try {\n      await refreshVideoDevices();\n    } catch (e) {\n      console.warn(\"[DevicePicker] refresh failed\", e);\n      setErr(\n        \"Unable to list cameras. Grant camera permission in your browser.\",\n      );\n    }\n  }, [refreshVideoDevices]);\n\n  useEffect(() => {\n    if (isTestEnv) return;\n    void handleRefreshDevices();\n  }, [handleRefreshDevices]);\n\n  useEffect(() => {\n    if (!dropdownOpen) return;\n    function handleClickOutside(event: MouseEvent) {\n      if (\n        dropdownRef.current &&\n        !dropdownRef.current.contains(event.target as Node)\n      ) {\n        console.debug(\n          \"[DevicePicker] document.mousedown -> closing dropdown (outside both main+portal)\",\n          Date.now(),\n        );\n        setDropdownOpen(false);\n      }\n    }\n    document.addEventListener(\"mousedown\", handleClickOutside);\n    return () => document.removeEventListener(\"mousedown\", handleClickOutside);\n  }, [dropdownOpen]);\n\n  const selectedDevice = videoDevices.find(\n    (d) => d.deviceId === preferredCameraId,\n  );\n  const selectedLabel = selectedDevice\n    ? `${selectedDevice.label || \"Camera\"}`\n    : preferredCameraId\n      ? \"Camera (unavailable)\"\n      : \"Auto (browser default)\";\n  const preferredCameraUnavailable = Boolean(\n    preferredCameraId && !selectedDevice,\n  );\n\n  const handleSelectCamera = useCallback(\n    (deviceId: string | undefined, label = \"\") => {\n      try {\n        setPreferredCamera(deviceId, label, true);\n      } catch (err) {\n        console.warn(\"[DevicePicker] setPreferredCamera failed\", err);\n      }\n      setDropdownOpen(false);\n    },\n    [setPreferredCamera],\n  );\n\n  const handlePhoneCamera = useCallback(() => {\n    handleSelectCamera(undefined, \"Phone Camera\");\n    onSelectPhoneCamera();\n  }, [handleSelectCamera, onSelectPhoneCamera]);\n\n  const handleLockToggle = useCallback(() => {\n    setPreferredCameraLocked(!preferredCameraLocked);\n  }, [preferredCameraLocked, setPreferredCameraLocked]);\n\n  return (\n    <div\n      ref={dropdownRef}\n      className=\"mt-3 rounded-lg border border-indigo-500/30 bg-indigo-500/5 p-3\"\n      data-testid=\"device-picker-root\"\n    >\n      <div className=\"mb-2 font-semibold\">Select camera device</div>\n      {err && <div className=\"mb-2 text-sm text-rose-400\">{err}</div>}\n      {videoDevices.length === 0 && !err && (\n        <div className=\"mb-2 text-xs text-slate-400\">\n          Detecting devices... (click \"Rescan\" if this hangs)\n        </div>\n      )}\n      {preferredCameraUnavailable && (\n        <div className=\"mb-2 text-sm text-amber-400\">\n          Selected camera is no longer available.\n          <button\n            className=\"ml-1 underline\"\n            onClick={() => handleSelectCamera(undefined, \"\")}\n            disabled={streaming}\n          >\n            Use auto-selection\n          </button>\n        </div>\n      )}\n      <div className=\"mb-2 flex items-center gap-2\">\n        {preferredCameraLocked ? (\n          <div className=\"text-xs text-emerald-400\">\n             Camera selection locked\n          </div>\n        ) : (\n          <div className=\"text-xs text-slate-400\">\n            Camera selection unlocked\n          </div>\n        )}\n        <button\n          data-testid=\"cam-lock-toggle\"\n          className=\"btn btn--ghost ml-2 px-2 py-0.5 text-xs\"\n          onClick={handleLockToggle}\n        >\n          {preferredCameraLocked ? \"Unlock\" : \"Lock\"}\n        </button>\n      </div>\n      <div className=\"mb-3 flex items-center gap-3\">\n        <input\n          type=\"checkbox\"\n          id=\"cameraEnabled-calibrator\"\n          checked={cameraEnabled}\n          onChange={(e) => setCameraEnabled(e.target.checked)}\n          className=\"h-4 w-4\"\n          disabled={streaming}\n        />\n        <label htmlFor=\"cameraEnabled-calibrator\" className=\"text-sm\">\n          Enable camera for scoring\n        </label>\n      </div>\n      <div className=\"grid grid-cols-3 items-center gap-2 text-sm\">\n        <div className=\"relative col-span-2\">\n          <button\n            className=\"input flex w-full items-center justify-between text-left\"\n            data-testid=\"device-picker-toggle\"\n            onClick={() => setDropdownOpen(true)}\n            onPointerDown={(e) => e.stopPropagation()}\n            onMouseDown={(e) => e.stopPropagation()}\n          >\n            <span>{selectedLabel}</span>\n            <span\n              className={`transition-transform ${\n                dropdownOpen ? \"rotate-180\" : \"\"\n              }`}\n            >\n              \n            </span>\n          </button>\n          {dropdownOpen && (\n            <div className=\"absolute left-0 right-0 top-full z-50 mt-1 rounded border border-slate-600 bg-slate-800 shadow-lg\">\n              <div className=\"max-h-48 overflow-y-auto\">\n                <button\n                  data-testid=\"device-option-auto\"\n                  className=\"w-full px-3 py-2 text-left text-sm hover:bg-slate-700\"\n                  onClick={() => handleSelectCamera(undefined, \"\")}\n                  onPointerDown={(e) => e.stopPropagation()}\n                  onMouseDown={(e) => e.stopPropagation()}\n                >\n                  Auto (browser default)\n                </button>\n                {videoDevices.map((device) => (\n                  <button\n                    key={device.deviceId}\n                    className=\"w-full px-3 py-2 text-left text-sm hover:bg-slate-700\"\n                    onClick={() =>\n                      handleSelectCamera(device.deviceId, device.label || \"\")\n                    }\n                    onPointerDown={(e) => e.stopPropagation()}\n                    onMouseDown={(e) => e.stopPropagation()}\n                  >\n                    {device.label || \"Camera\"}\n                  </button>\n                ))}\n                <button\n                  className=\"w-full px-3 py-2 text-left text-sm hover:bg-slate-700\"\n                  onClick={handlePhoneCamera}\n                  onPointerDown={(e) => e.stopPropagation()}\n                  onMouseDown={(e) => e.stopPropagation()}\n                >\n                   Remote Device / Pair\n                </button>\n              </div>\n            </div>\n          )}\n        </div>\n        {videoDevices.length === 0 && (\n          <div className=\"col-span-1 flex items-center justify-end gap-2\">\n            <button\n              className=\"btn btn--ghost btn-sm\"\n              onClick={async () => {\n                try {\n                  await testCamera();\n                  await refreshVideoDevices();\n                } catch (err) {\n                  console.warn(\n                    \"[DevicePicker] request camera permission failed\",\n                    err,\n                  );\n                  setErr(\n                    \"Camera permission denied. Please allow access in your browser.\",\n                  );\n                }\n              }}\n            >\n              Enable local camera\n            </button>\n            <button\n              className=\"btn btn--ghost btn-sm\"\n              onClick={() => void handleRefreshDevices()}\n            >\n              Rescan\n            </button>\n          </div>\n        )}\n        <div className=\"col-span-3 text-right\">\n          <button\n            className=\"btn px-2 py-1\"\n            onClick={() => {\n              void testCamera(preferredCameraId || undefined);\n            }}\n            disabled={streaming}\n          >\n            Test\n          </button>\n          <div className=\"mt-2 flex items-center justify-end gap-2 text-xs opacity-70\">\n            <span data-testid=\"device-picker-detected\">\n              {lastDetectedLabel\n                ? `Detected: ${lastDetectedLabel}`\n                : \"No recent detection\"}\n            </span>\n            {(lastDetectedLabel != null || autoCommitTestMode) && (\n              <button\n                className=\"btn btn--ghost btn-sm\"\n                onClick={() => doCommit()}\n                onPointerDown={() => doCommit()}\n                disabled={lastDetectedValue == null}\n              >\n                Commit detected\n              </button>\n            )}\n            <span\n              className={`inline-block h-2.5 w-2.5 rounded-full ${\n                cameraConnected ? \"bg-emerald-400\" : \"bg-rose-500\"\n              }`}\n            />\n            <span className=\"text-xs\">\n              {cameraConnected ? \"Camera Connected\" : \"Camera not connected\"}\n            </span>\n          </div>\n        </div>\n      </div>\n      {preferredCameraLabel && (\n        <div className=\"mt-1 text-xs opacity-70\">\n          Selected: {preferredCameraLabel}\n        </div>\n      )}\n      <div className=\"mt-1 text-xs opacity-70\">\n        Tip: Select a camera here for manual scoring.\n      </div>\n    </div>\n  );\n};\n\nconst CALIBRATION_POINT_LABELS = [\"D20\", \"D6\", \"D3\", \"D11\", \"BULL\"] as const;\nconst REQUIRED_POINT_COUNT = CALIBRATION_POINT_LABELS.length;\ntype TestAutoDetectResult = {\n  H: Homography;\n  errorPx: number | null;\n  imageSize: { w: number; h: number };\n  overlaySize: { w: number; h: number };\n  anchors: { src: Point[]; dst: Point[] };\n  locked: boolean;\n  confidence: number;\n  phase?: Phase;\n};\n\ntype ScoreInfo = ReturnType<typeof scoreAtBoardPoint>;\n\ntype VerificationResult = {\n  label: string;\n  expected: { ring: ScoreInfo[\"ring\"]; sector: number | null };\n  detected: ScoreInfo | null;\n  deltaMm: number | null;\n  deltaPx: number | null;\n  match: boolean;\n  note?: string;\n};\n\nconst VERIFICATION_ANCHORS: Array<{\n  idx: number;\n  label: string;\n  sector: number | null;\n  ring: ScoreInfo[\"ring\"];\n  toleranceMm: number;\n}> = [\n  {\n    idx: 0,\n    label: \"D20 (top double)\",\n    sector: 20,\n    ring: \"DOUBLE\",\n    toleranceMm: 4.5,\n  },\n  {\n    idx: 1,\n    label: \"D6 (right double)\",\n    sector: 6,\n    ring: \"DOUBLE\",\n    toleranceMm: 4.5,\n  },\n  {\n    idx: 2,\n    label: \"D3 (bottom double)\",\n    sector: 3,\n    ring: \"DOUBLE\",\n    toleranceMm: 4.5,\n  },\n  {\n    idx: 3,\n    label: \"D11 (left double)\",\n    sector: 11,\n    ring: \"DOUBLE\",\n    toleranceMm: 4.5,\n  },\n  {\n    idx: 4,\n    label: \"Bull center\",\n    sector: 25,\n    ring: \"INNER_BULL\",\n    toleranceMm: 3.5,\n  },\n];\n\nfunction describeScoreTarget(ring: ScoreInfo[\"ring\"], sector: number | null) {\n  if (ring === \"INNER_BULL\") return \"Inner Bull (50)\";\n  if (ring === \"BULL\") return \"Outer Bull (25)\";\n  if (ring === \"MISS\" || sector == null) return ring === \"MISS\" ? \"Miss\" : ring;\n  const prefix =\n    ring === \"DOUBLE\" ? \"Double\" : ring === \"TRIPLE\" ? \"Triple\" : \"Single\";\n  return `${prefix} ${sector}`;\n}\n\nfunction formatScoreLabel(score: ScoreInfo | null) {\n  return score ? describeScoreTarget(score.ring, score.sector) : \"\";\n}\n\nfunction translateHomography(\n  H: Homography,\n  tx: number,\n  ty: number,\n): Homography {\n  // Compose translation matrix T = [1 0 tx; 0 1 ty; 0 0 1]\n  const T: Homography = [1, 0, tx, 0, 1, ty, 0, 0, 1];\n  return matMul3(H, T); // H * T - apply translation after main transform\n}\n\n// Center-logo QR helpers moved to ../utils/qr\n\nexport default function Calibrator() {\n  const videoRef = useRef<HTMLVideoElement>(null);\n  const canvasRef = useRef<HTMLCanvasElement>(null);\n  const overlayRef = useRef<HTMLCanvasElement>(null);\n  const fileInputRef = useRef<HTMLInputElement>(null);\n  // Camera diagnostics state\n  const [cameraPerm, setCameraPerm] = useState<\n    \"unknown\" | \"granted\" | \"denied\" | \"prompt\" | \"unsupported\"\n  >(\"unknown\");\n  const [videoDevices, setVideoDevices] = useState<\n    Array<{ deviceId: string; label: string }>\n  >([]);\n  const [selectedDeviceId, setSelectedDeviceId] = useState<string | null>(null);\n  const [streaming, setStreaming] = useState(false);\n  const [videoPlayBlocked, setVideoPlayBlocked] = useState(false);\n  // Default to local or last-used mode, but allow user to freely change\n  const [mode, setMode] = useState<CamMode>(\n    () => (localStorage.getItem(\"ndn:cal:mode\") as CamMode) || \"local\",\n  );\n  const [dstPoints, setDstPoints] = useState<Point[]>([]); // image points clicked in order D20 (top), D6 (right), D3 (bottom), D11 (left)\n  const [hasSnapshot, setHasSnapshot] = useState(false);\n  const [phase, setPhase] = useState<Phase>(\"idle\");\n  const handleSelectPhoneCamera = useCallback(() => {\n    setMode(\"phone\");\n    setPhase(\"camera\");\n    setStreaming(false);\n    setHasSnapshot(false);\n    // Persist phone camera selection globally so it is used in game modes\n    try {\n      useUserSettings\n        .getState()\n        .setPreferredCamera(undefined, \"Phone Camera\", true);\n    } catch (e) {\n      console.warn(\n        \"[Camera Connection] Failed to persist phone camera selection\",\n        e,\n      );\n    }\n  }, [setMode, setPhase, setStreaming, setHasSnapshot]);\n  // Track current frame (video/snapshot) size to preserve aspect ratio in the preview container\n  const [frameSize, setFrameSize] = useState<{ w: number; h: number } | null>(\n    null,\n  );\n  // Zoom for pixel-perfect point picking (0.5x  2.0x)\n  // const [zoom, setZoom] = useState<number>(1);\n  // Use global camera scale setting so it persists across game modes\n  const zoom = useUserSettings((s) => s.cameraScale) || 1;\n  const setZoom = useUserSettings((s) => s.setCameraScale);\n  const [mobileLandingOverride, setMobileLandingOverride] = useState<boolean>(\n    () => {\n      if (typeof window === \"undefined\") return false;\n      try {\n        return window.localStorage.getItem(\"ndn:cal:forceDesktop\") === \"1\";\n      } catch {\n        return false;\n      }\n    },\n  );\n  const [isMobileDevice, setIsMobileDevice] = useState<boolean>(() => {\n    if (typeof navigator === \"undefined\") return false;\n    return /Android|iPhone|iPad|iPod|Mobi/i.test(navigator.userAgent);\n  });\n  const {\n    H,\n    setCalibration,\n    reset,\n    errorPx,\n    locked,\n    overlaySize,\n    imageSize,\n    anchors,\n    theta,\n    sectorOffset,\n  } = useCalibration();\n  const ERROR_PX_MAX = 6;\n  const calibrationValid =\n    !!H &&\n    !!imageSize &&\n    (locked || (typeof errorPx === \"number\" && errorPx <= ERROR_PX_MAX));\n  const cameraSession = useCameraSession();\n  const {\n    calibrationGuide,\n    setCalibrationGuide,\n    preferredCameraId,\n    cameraEnabled,\n    setCameraEnabled,\n    preferredCameraLocked,\n    setPreferredCameraLocked,\n    setPreferredCamera,\n    preserveCalibrationOverlay,\n    allowAutocommitInOnline,\n    setAllowAutocommitInOnline,\n  } = useUserSettings();\n\n  const manualOnly = true;\n  // Detected ring data (from auto-detect) in image pixels\n  const [detected, setDetected] = useState<null | {\n    cx: number;\n    cy: number;\n    bullInner: number;\n    bullOuter: number;\n    trebleInner: number;\n    trebleOuter: number;\n    doubleInner: number;\n    doubleOuter: number;\n  }>(null);\n  // Live detection and confidence state\n  const [liveDetect, setLiveDetect] = useState<boolean>(false);\n  const [confidence, setConfidence] = useState<number>(0);\n  const [autoCalibrating, setAutoCalibrating] = useState<boolean>(false);\n  const [detectionMessage, setDetectionMessage] = useState<string | null>(null);\n  const [forceConfidence, setForceConfidence] = useState<boolean>(true); // Allow forcing 100% for registration reliability\n  const [markerResult, setMarkerResult] = useState<MarkerDetection | null>(\n    null,\n  );\n  const [showDartPreview, setShowDartPreview] = useState<boolean>(false);\n  const [autoCommitTestMode, setAutoCommitTestMode] = useState<boolean>(false);\n  const [autoCommitImmediate, setAutoCommitImmediate] =\n    useState<boolean>(false);\n  const [lastDetectedValue, setLastDetectedValue] = useState<number | null>(\n    null,\n  );\n  const [lastDetectedLabel, setLastDetectedLabel] = useState<string | null>(\n    null,\n  );\n  // Optional hint: a one-click bull can anchor the center for auto-calibration\n  const [bullHint, setBullHint] = useState<Point | null>(null);\n  const [toolsPopoverOpen, setToolsPopoverOpen] = useState<boolean>(false);\n  const dartDetectorRef = useRef<DartDetector | null>(null);\n\n  // Simple nudge controls for sector offset to resolve whole-sector mismatches quickly\n  const nudgeSectorOffset = useCallback(\n    (delta: number) => {\n      const next = (sectorOffset ?? 0) + delta;\n      setCalibration({ sectorOffset: next });\n    },\n    [sectorOffset, setCalibration],\n  );\n  const inFlightAutoCommitRef = useRef<boolean>(false);\n  const lastAutoSigRef = useRef<string | null>(null);\n  const lastAutoSigAtRef = useRef<number>(0);\n  const AUTO_COMMIT_COOLDOWN_MS = 300;\n  // Verification results for UI: {label, expected, detected, match}\n  const [verificationResults, setVerificationResults] = useState<\n    VerificationResult[]\n  >([]);\n  // PASS/FAIL flash badge state\n  const [flashStatus, setFlashStatus] = useState<{\n    type: \"pass\" | \"fail\" | null;\n    until: number;\n  }>({ type: null, until: 0 });\n\n  // Fine-tune correction parameters for pixel-perfect alignment\n  const [correctionSx, setCorrectionSx] = useState<number>(1.0);\n  const [correctionTx, setCorrectionTx] = useState<number>(0);\n  const [correctionTy, setCorrectionTy] = useState<number>(0);\n  // Debug overlay for detected rings\n  const [showDetectedOverlay, setShowDetectedOverlay] =\n    useState<boolean>(false);\n  const [forceDetectedOnly, setForceDetectedOnly] = useState<boolean>(false);\n  const [doubleOuterAdjust, setDoubleOuterAdjust] = useState<number>(1.0);\n  const [trebleOuterAdjust, setTrebleOuterAdjust] = useState<number>(1.0);\n  const [aligningRing, setAligningRing] = useState<\n    null | \"double\" | \"treble\" | \"bull\"\n  >(null);\n  function resetVisualAdjustments() {\n    setDoubleOuterAdjust(1.02);\n    setTrebleOuterAdjust(1.0);\n    setCorrectionSx(1.0);\n    setCorrectionTx(0);\n    setCorrectionTy(0);\n    setForceDetectedOnly(false);\n    setAligningRing(null);\n  }\n\n  function triggerFlash(pass: boolean, durationMs = 1500) {\n    setFlashStatus({\n      type: pass ? \"pass\" : \"fail\",\n      until: Date.now() + durationMs,\n    });\n  }\n\n  const createMarkerDataUrl = useCallback((id: number, size = 480) => {\n    if (typeof document === \"undefined\")\n      throw new Error(\"Marker rendering only available in browser context\");\n    const matrix = markerIdToMatrix(id);\n    const canvas = document.createElement(\"canvas\");\n    canvas.width = size;\n    canvas.height = size;\n    const ctx = canvas.getContext(\"2d\");\n    if (!ctx) return \"\";\n    // white background\n    ctx.fillStyle = \"#ffffff\";\n    ctx.fillRect(0, 0, size, size);\n\n    const rows = matrix.length;\n    const cols = matrix[0]?.length || rows;\n    const cellW = size / cols;\n    const cellH = size / rows;\n\n    for (let y = 0; y < rows; y++) {\n      for (let x = 0; x < cols; x++) {\n        const v = matrix[y][x];\n        if (v) {\n          ctx.fillStyle = \"#000000\";\n          ctx.fillRect(\n            Math.round(x * cellW),\n            Math.round(y * cellH),\n            Math.ceil(cellW),\n            Math.ceil(cellH),\n          );\n        }\n      }\n    }\n\n    return canvas.toDataURL(\"image/png\");\n  }, []);\n  // Pairing / phone-camera state (some of these were accidentally removed during edits)\n  const [pairCode, setPairCode] = useState<string | null>(null);\n  const pairCodeRef = useRef<string | null>(null);\n  const [ws, setWs] = useState<WebSocket | null>(null);\n  const pcRef = useRef<RTCPeerConnection | null>(null);\n  const pendingIceCandidatesRef = useRef<RTCIceCandidate[]>([]);\n  const [expiresAt, setExpiresAt] = useState<number | null>(null);\n  const [now, setNow] = useState<number>(Date.now());\n  const [paired, setPaired] = useState<boolean>(false);\n\n  function updatePairCode(code: string | null) {\n    try {\n      setPairCode(code);\n      pairCodeRef.current = code;\n    } catch (e) {}\n  }\n  const [lanHost, setLanHost] = useState<string | null>(null);\n  const [httpsInfo, setHttpsInfo] = useState<{\n    https: boolean;\n    port: number;\n  } | null>(null);\n  const [showTips, setShowTips] = useState<boolean>(true);\n  const [wifiDevices, setWifiDevices] = useState<NetworkDevice[]>([]);\n  const [discoveringWifi, setDiscoveringWifi] = useState<boolean>(false);\n  const [copyFeedback, setCopyFeedback] = useState<\"link\" | \"code\" | null>(\n    null,\n  );\n  const copyTimeoutRef = useRef<number | null>(null);\n\n  // Log streaming state changes for debugging\n  useEffect(() => {\n    if (isTestEnv) return;\n    let interval: number | null = null;\n    if (\n      !manualOnly &&\n      showDartPreview &&\n      streaming &&\n      videoRef.current &&\n      overlayRef.current\n    ) {\n      // Initialize detector\n      try {\n        const video = videoRef.current! as HTMLVideoElement;\n        const det = new DartDetector({\n          requireStableN: 2,\n          thresh: 18,\n          minArea: 40,\n        });\n        const w =\n          video.videoWidth || (videoRef.current as any).clientWidth || 640;\n        const h =\n          video.videoHeight || (videoRef.current as any).clientHeight || 480;\n        det.reset(w, h);\n        // Set ROI roughly to the full board if we have detection\n        if (detected) {\n          const r = Math.max(\n            detected.doubleOuter * 1.1,\n            detected.trebleOuter * 1.1,\n          );\n          det.setROI(detected.cx, detected.cy, Math.round(r));\n        }\n        dartDetectorRef.current = det;\n        interval = window.setInterval(() => {\n          try {\n            const canvas = document.createElement(\"canvas\");\n            canvas.width = w;\n            canvas.height = h;\n            const ctx = canvas.getContext(\"2d\");\n            if (!ctx) return;\n            ctx.drawImage(video, 0, 0, w, h);\n            const img = ctx.getImageData(0, 0, w, h);\n            // feed background model\n            det.updateBackground(img);\n            const d = det.detect(img);\n            const overlay = overlayRef.current! as HTMLCanvasElement;\n            const octx = overlay.getContext(\"2d\");\n            if (!octx) return;\n            octx.clearRect(0, 0, overlay.width, overlay.height);\n            // overlay is same size as canvas/image\n            if (d) {\n              try {\n                // Map to calibration space and extract score\n                if (H && imageSize) {\n                  const pImg = { x: d.tip.x, y: d.tip.y };\n                  // convert canvas coords to calibration image space\n                  const fallbackWidth =\n                    (overlayRef.current && overlayRef.current.width) ||\n                    imageSize.w ||\n                    1;\n                  const fallbackHeight =\n                    (overlayRef.current && overlayRef.current.height) ||\n                    imageSize.h ||\n                    1;\n                  const pCal = {\n                    x: pImg.x / (fallbackWidth / imageSize.w),\n                    y: pImg.y / (fallbackHeight / imageSize.h),\n                  };\n                  const detectedBoard = imageToBoard(H as any, pCal);\n                  const scoreObj = detectedBoard\n                    ? scoreAtBoardPointTheta(\n                        detectedBoard,\n                        typeof theta === \"number\" ? theta : 0,\n                        sectorOffset ?? 0,\n                      )\n                    : {\n                        base: 0,\n                        ring: \"MISS\" as const,\n                        sector: null,\n                        mult: 0 as const,\n                      };\n                  const val = scoreObj.base;\n                  const label = `${scoreObj.ring} ${val}`.trim();\n                  const ERROR_PX_MAX = 6;\n                  const TIP_MARGIN_PX = 3;\n                  const PCAL_MARGIN_PX = 3;\n                  const cameraGood =\n                    !!H &&\n                    !!imageSize &&\n                    (locked ||\n                      (typeof errorPx === \"number\" && errorPx <= ERROR_PX_MAX));\n                  const tipInVideo =\n                    d.tip.x >= -TIP_MARGIN_PX &&\n                    d.tip.x <= fallbackWidth + TIP_MARGIN_PX &&\n                    d.tip.y >= -TIP_MARGIN_PX &&\n                    d.tip.y <= fallbackHeight + TIP_MARGIN_PX;\n                  const pCalInImage =\n                    pCal.x >= -PCAL_MARGIN_PX &&\n                    pCal.x <= imageSize.w + PCAL_MARGIN_PX &&\n                    pCal.y >= -PCAL_MARGIN_PX &&\n                    pCal.y <= imageSize.h + PCAL_MARGIN_PX;\n                  let onBoard = false;\n                  const pBoard = imageToBoard(H as any, pCal);\n                  if (pBoard) {\n                    const boardR = Math.hypot(pBoard.x, pBoard.y);\n                    const BOARD_MARGIN_MM = 3;\n                    onBoard =\n                      boardR <= BoardRadii.doubleOuter + BOARD_MARGIN_MM;\n                  }\n                  if (!cameraGood || !tipInVideo || !pCalInImage || !onBoard) {\n                    // ignore ghost detection\n                    console.debug(\n                      \"Calibrator: ignoring ghost preview detection\",\n                      cameraGood,\n                      tipInVideo,\n                      pCalInImage,\n                    );\n                  } else {\n                    setLastDetectedValue(val);\n                    setLastDetectedLabel(label);\n                    try {\n                      if (\n                        autoCommitTestMode &&\n                        autoCommitImmediate &&\n                        useMatch.getState().inProgress &&\n                        useMatch.getState().roomId === \"\"\n                      ) {\n                        // commit as offline match visit (3 darts) with dedupe/cooldown to avoid double commits\n                        const sig = `${val}|3`;\n                        const now = performance.now();\n                        if (\n                          !inFlightAutoCommitRef.current &&\n                          !(\n                            sig === lastAutoSigRef.current &&\n                            now - lastAutoSigAtRef.current <\n                              AUTO_COMMIT_COOLDOWN_MS\n                          )\n                        ) {\n                          lastAutoSigRef.current = sig;\n                          lastAutoSigAtRef.current = now;\n                          inFlightAutoCommitRef.current = true;\n                          try {\n                            useMatch\n                              .getState()\n                              .addVisit(val, 3, { visitTotal: val });\n                          } catch (e) {}\n                          try {\n                            window.setTimeout(\n                              () => {\n                                inFlightAutoCommitRef.current = false;\n                              },\n                              Math.max(120, AUTO_COMMIT_COOLDOWN_MS),\n                            );\n                          } catch (e) {}\n                        }\n                      }\n                    } catch (e) {\n                      // ignore commit errors in preview\n                    }\n                    // For online autocommit in test mode, send the message if allowed\n                    try {\n                      const isOnline = useMatch.getState().roomId !== \"\";\n                      if (\n                        autoCommitTestMode &&\n                        autoCommitImmediate &&\n                        useMatch.getState().inProgress &&\n                        isOnline &&\n                        allowAutocommitInOnline\n                      ) {\n                        const pBoard = imageToBoard(H as any, pCal);\n                        if (pBoard) {\n                          useWS().send({\n                            type: \"auto-visit\",\n                            roomId: useMatch.getState().roomId,\n                            value: val,\n                            darts: 3,\n                            ring: scoreObj.ring,\n                            sector: scoreObj.sector,\n                            pBoard,\n                            calibrationValid: true,\n                          });\n                        }\n                      }\n                    } catch (e) {\n                      // ignore online commit errors in preview\n                    }\n                  }\n                }\n              } catch (err) {\n                // ignore detection mapping errors\n              }\n              octx.fillStyle = \"rgba(0,255,0,0.9)\";\n              octx.beginPath();\n              octx.arc(d.tip.x, d.tip.y, 6, 0, Math.PI * 2);\n              octx.fill();\n              // draw axis\n              octx.strokeStyle = \"rgba(0,255,0,0.8)\";\n              octx.lineWidth = 2;\n              if (d.axis) {\n                octx.beginPath();\n                octx.moveTo(d.axis.x1, d.axis.y1);\n                octx.lineTo(d.axis.x2, d.axis.y2);\n                octx.stroke();\n              }\n            }\n          } catch (err) {\n            // ignore animation errors\n          }\n        }, 300);\n      } catch (err) {\n        console.warn(\"[Camera Connection] failed to start dart preview\", err);\n      }\n    }\n    return () => {\n      if (interval) {\n        clearInterval(interval);\n      }\n      dartDetectorRef.current = null;\n    };\n  }, [manualOnly, showDartPreview, streaming, detected]);\n\n  useEffect(() => {\n    if (isTestEnv) return;\n    const h = window.location.hostname;\n    if (h === \"localhost\" || h === \"127.0.0.1\") {\n      apiFetch(`/api/hosts`)\n        .then((r) => r.json())\n        .then((j) => {\n          const ip = Array.isArray(j?.hosts) && j.hosts.find((x: string) => x);\n          if (ip) setLanHost(ip);\n        })\n        .catch(() => {});\n    }\n    // Try to detect if server exposes HTTPS info\n    apiFetch(`/api/https-info`)\n      .then((r) => r.json())\n      .then((j) => {\n        if (j && typeof j.https === \"boolean\")\n          setHttpsInfo({ https: !!j.https, port: Number(j.port) || 8788 });\n      })\n      .catch(() => {});\n  }, []);\n\n  // Remove automatic phone pairing on mode change; only pair on explicit user action\n  const mobileUrl = useMemo(() => {\n    const code = pairCode || \"____\";\n    // Prefer configured WS host (Render) when available to build the correct server origin\n    const envUrl = (import.meta as any).env?.VITE_WS_URL as string | undefined;\n    if (envUrl && envUrl.length > 0) {\n      try {\n        const u = new URL(envUrl);\n        const isSecure = u.protocol === \"wss:\";\n        const origin = `${isSecure ? \"https\" : \"http\"}://${u.host}${u.pathname.endsWith(\"/ws\") ? \"\" : u.pathname}`;\n        const base = origin.replace(/\\/?ws$/i, \"\");\n        return `${base}/mobile-cam.html?code=${code}`;\n      } catch (e) {}\n    }\n    // Local dev fallback using detected LAN or current host\n    const host = lanHost || window.location.hostname;\n    const useHttps = !!httpsInfo?.https;\n    const port = useHttps ? httpsInfo?.port || 8788 : 8787;\n    const proto = useHttps ? \"https\" : \"http\";\n    return `${proto}://${host}:${port}/mobile-cam.html?code=${code}`;\n  }, [pairCode, lanHost, httpsInfo]);\n\n  const mobileLandingLink = useMemo(() => {\n    if (!mobileUrl) return null;\n    try {\n      const url = new URL(mobileUrl);\n      url.searchParams.delete(\"code\");\n      return url.toString().replace(/\\?$/, \"\");\n    } catch {\n      if (typeof window !== \"undefined\") {\n        const origin = window.location.origin.replace(/\\/$/, \"\");\n        return `${origin}/mobile-cam.html`;\n      }\n      return \"/mobile-cam.html\";\n    }\n  }, [mobileUrl]);\n\n  useEffect(() => {\n    localStorage.setItem(\"ndn:cal:mode\", mode);\n  }, [mode]);\n\n  useEffect(() => {\n    if (typeof window === \"undefined\") return;\n    try {\n      if (mobileLandingOverride) {\n        window.localStorage.setItem(\"ndn:cal:forceDesktop\", \"1\");\n      } else {\n        window.localStorage.removeItem(\"ndn:cal:forceDesktop\");\n      }\n    } catch (e) {}\n  }, [mobileLandingOverride]);\n\n  useEffect(() => {\n    if (isTestEnv || typeof window === \"undefined\") return;\n    const coarseQuery = window.matchMedia(\"(pointer: coarse)\");\n    const detect = () => {\n      const uaMobile =\n        typeof navigator !== \"undefined\" &&\n        /Android|iPhone|iPad|iPod|Mobi/i.test(navigator.userAgent);\n      const coarse =\n        typeof coarseQuery.matches === \"boolean\" ? coarseQuery.matches : false;\n      const narrow = window.innerWidth <= 820;\n      setIsMobileDevice(uaMobile || coarse || narrow);\n    };\n    detect();\n    try {\n      if (typeof coarseQuery.addEventListener === \"function\")\n        coarseQuery.addEventListener(\"change\", detect);\n      else if (typeof coarseQuery.addListener === \"function\")\n        coarseQuery.addListener(detect);\n    } catch (e) {}\n    window.addEventListener(\"resize\", detect);\n    return () => {\n      try {\n        if (typeof coarseQuery.removeEventListener === \"function\")\n          coarseQuery.removeEventListener(\"change\", detect);\n        else if (typeof coarseQuery.removeListener === \"function\")\n          coarseQuery.removeListener(detect);\n      } catch (e) {}\n      window.removeEventListener(\"resize\", detect);\n    };\n  }, []);\n\n  // Detect camera permission status where supported\n  useEffect(() => {\n    if (isTestEnv) return;\n    if (typeof navigator === \"undefined\" || !(navigator as any).permissions) {\n      setCameraPerm(\"unsupported\");\n      return;\n    }\n    let mounted = true;\n    (async () => {\n      try {\n        const p = await (navigator as any).permissions.query({\n          name: \"camera\",\n        });\n        if (!mounted) return;\n        setCameraPerm(p.state || \"unknown\");\n        p.onchange = () => {\n          if (mounted) setCameraPerm(p.state);\n        };\n      } catch (err) {\n        // Some browsers don't support 'camera' permission query\n        if (mounted) setCameraPerm(\"unknown\");\n      }\n    })();\n    return () => {\n      mounted = false;\n    };\n  }, []);\n\n  async function refreshVideoDevices() {\n    if (\n      typeof navigator === \"undefined\" ||\n      !navigator.mediaDevices ||\n      !navigator.mediaDevices.enumerateDevices\n    )\n      return;\n    try {\n      const list = await navigator.mediaDevices.enumerateDevices();\n      const vids = list\n        .filter((d) => d.kind === \"videoinput\")\n        .map((d) => ({\n          deviceId: (d as any).deviceId,\n          label: d.label || \"Camera\",\n        }));\n      setVideoDevices(vids);\n      if (vids.length && !selectedDeviceId)\n        setSelectedDeviceId(vids[0].deviceId);\n    } catch (err) {\n      // ignore\n    }\n  }\n\n  useEffect(() => {\n    if (isTestEnv) return;\n    const mounted = true;\n    (async () => {\n      try {\n        await refreshVideoDevices();\n      } catch (e) {}\n      try {\n        if (navigator?.mediaDevices?.addEventListener) {\n          navigator.mediaDevices.addEventListener(\n            \"devicechange\",\n            refreshVideoDevices,\n          );\n        } else {\n          (navigator.mediaDevices as any).ondevicechange = refreshVideoDevices;\n        }\n      } catch (e) {}\n    })();\n    return () => {\n      try {\n        if (navigator?.mediaDevices?.removeEventListener)\n          navigator.mediaDevices.removeEventListener(\n            \"devicechange\",\n            refreshVideoDevices,\n          );\n      } catch (e) {}\n    };\n  }, []);\n\n  async function testCamera(deviceId?: string) {\n    if (\n      typeof navigator === \"undefined\" ||\n      !navigator.mediaDevices ||\n      !navigator.mediaDevices.getUserMedia\n    ) {\n      alert(\"getUserMedia is not available in this browser\");\n      return;\n    }\n    const constraints: any = {\n      video: deviceId\n        ? { deviceId: { exact: deviceId } }\n        : { facingMode: \"environment\" },\n    };\n    let stream: MediaStream | null = null;\n    try {\n      stream = await navigator.mediaDevices.getUserMedia(constraints);\n      // Immediately stop tracks to test access\n      stream.getTracks().forEach((t) => t.stop());\n      setCameraPerm(\"granted\");\n      // If a deviceId was provided, set it as the preferred camera so Start Camera will use it\n      try {\n        if (deviceId && typeof setPreferredCamera === \"function\") {\n          setPreferredCamera(deviceId);\n        }\n      } catch {}\n      alert(\n        \"Camera access granted  your webcam is available and set as preferred.\",\n      );\n    } catch (err: any) {\n      console.error(\"[Camera Connection] testCamera failed\", err);\n      if (\n        err &&\n        (err.name === \"NotAllowedError\" || err.name === \"PermissionDeniedError\")\n      ) {\n        setCameraPerm(\"denied\");\n        alert(\n          \"Camera permission denied. Please allow camera access in your browser settings and try again.\",\n        );\n      } else if (\n        err &&\n        (err.name === \"NotFoundError\" || err.name === \"DevicesNotFoundError\")\n      ) {\n        alert(\n          \"No camera devices found. Ensure your USB webcam is connected and not in use by another app.\",\n        );\n      } else {\n        alert(\"Unable to access the camera: \" + (err?.message || err));\n      }\n    } finally {\n      if (stream) stream.getTracks().forEach((t) => t.stop());\n    }\n  }\n\n  function openBrowserSiteSettings() {\n    if (typeof window === \"undefined\") return;\n    const ua = navigator.userAgent || \"\";\n    let url: string | null = null;\n    if (/Edg\\//.test(ua) || /Chrome\\//.test(ua) || /Chromium\\//.test(ua)) {\n      // Chromium-based browsers: open camera content settings\n      url = \"chrome://settings/content/camera\";\n    } else if (/Firefox\\//.test(ua)) {\n      url = \"about:preferences#privacy\";\n    } else if (/Safari\\//.test(ua) && !/Chrome\\//.test(ua)) {\n      // Safari has no direct site settings page we can open; show instructions instead\n      url = null;\n    }\n    if (url) {\n      const w = window.open(url, \"_blank\");\n      if (!w) {\n        alert(\n          'Unable to open browser settings automatically. Please open your browser settings and search for \"Camera\" permissions for this site.',\n        );\n      }\n    } else {\n      // Fallback instructions\n      alert(\n        \"Please open your browser settings and locate Site Settings  Camera (or Permissions) and allow camera access for this site. In Safari, use Preferences  Websites  Camera.\",\n      );\n    }\n  }\n\n  useEffect(() => {\n    if (isTestEnv || !expiresAt) return;\n    const t = setInterval(() => setNow(Date.now()), 1000);\n    return () => clearInterval(t);\n  }, [expiresAt]);\n  const ttl = useMemo(\n    () => (expiresAt ? Math.max(0, Math.ceil((expiresAt - now) / 1000)) : null),\n    [expiresAt, now],\n  );\n  useEffect(() => {\n    return () => {\n      if (copyTimeoutRef.current) window.clearTimeout(copyTimeoutRef.current);\n    };\n  }, []);\n\n  const copyValue = useCallback(\n    async (value: string | null | undefined, type: \"link\" | \"code\") => {\n      if (!value) return;\n      try {\n        if (navigator.clipboard && navigator.clipboard.writeText) {\n          await navigator.clipboard.writeText(value);\n        } else {\n          const textarea = document.createElement(\"textarea\");\n          textarea.value = value;\n          textarea.style.position = \"fixed\";\n          textarea.style.opacity = \"0\";\n          document.body.appendChild(textarea);\n          textarea.focus();\n          textarea.select();\n          document.execCommand(\"copy\");\n          try {\n            document.body.removeChild(textarea);\n          } catch {\n            // If removal fails, element was already removed\n          }\n        }\n        setCopyFeedback(type);\n        if (copyTimeoutRef.current) window.clearTimeout(copyTimeoutRef.current);\n        copyTimeoutRef.current = window.setTimeout(\n          () => setCopyFeedback(null),\n          1500,\n        );\n      } catch (err) {\n        console.warn(\"[Camera Connection] Copy failed:\", err);\n        setCopyFeedback(null);\n      }\n    },\n    [],\n  );\n  // Removed automatic regeneration of code when ttl expires. Only regenerate on explicit user action.\n\n  // NOTE: Removed automatic permission request on load - it was blocking camera access\n  // Let startCamera() handle the permission request when user clicks \"Enable camera\"\n  // This prevents the camera from being held by the permission test\n\n  useEffect(() => {\n    return () => {\n      // DON'T call stopCamera() on unmount - we want phone camera to persist!\n      // Just clean up local refs\n      // The camera stream stays alive so user can see it in Online/Offline/Tournaments\n    };\n  }, []); // Remove automatic camera restart on preferredCameraId change to prevent flicker\n\n  // Listen for reconnect requests from PhoneCameraOverlay\n  useEffect(() => {\n    if (isTestEnv) return;\n    const handleReconnectRequest = (event: any) => {\n      console.log(\n        \"[Camera Connection] Received reconnect request from PhoneCameraOverlay\",\n      );\n      // If we're in phone mode and already paired, restart the pairing\n      if (mode === \"phone\" && paired) {\n        stopCamera(false);\n        // Give a moment for cleanup, then restart pairing\n        setTimeout(() => {\n          startPhonePairing();\n        }, 500);\n      }\n    };\n\n    window.addEventListener(\n      \"ndn:phone-camera-reconnect\",\n      handleReconnectRequest as EventListener,\n    );\n    return () => {\n      window.removeEventListener(\n        \"ndn:phone-camera-reconnect\",\n        handleReconnectRequest as EventListener,\n      );\n    };\n  }, [mode, paired]);\n\n  // Sync video element to camera session so other components can access it\n  // CRITICAL: Run whenever streaming state changes to keep videoRef synced\n  useEffect(() => {\n    console.log(\"[Camera Connection]  STREAMING CHANGED:\", {\n      streaming,\n      videoRefAvailable: !!videoRef.current,\n    });\n    if (videoRef.current) {\n      console.log(\n        \"[Camera Connection]  Syncing videoElementRef on streaming change\",\n      );\n      cameraSession.setVideoElementRef(videoRef.current);\n      // Also capture media stream when available\n      if (videoRef.current.srcObject instanceof MediaStream) {\n        console.log(\n          \"[Camera Connection]  Setting mediaStream from video element\",\n        );\n        cameraSession.setMediaStream(videoRef.current.srcObject);\n      }\n    } else {\n      console.warn(\n        \"[Camera Connection]  videoRef.current is null on streaming change!\",\n      );\n    }\n  }, [streaming]);\n\n  // Also sync on mount to capture initial videoRef\n  useEffect(() => {\n    console.log(\n      \"[Camera Connection]  MOUNT: Initial mount - syncing videoRef\",\n    );\n    console.log(\n      \"[Camera Connection] videoRef.current available:\",\n      !!videoRef.current,\n    );\n    console.log(\n      \"[Camera Connection] videoRef.current type:\",\n      videoRef.current?.constructor?.name,\n    );\n\n    if (videoRef.current) {\n      console.log(\"[Camera Connection]  Setting videoElementRef on mount\");\n      console.log(\"[Camera Connection] Video element:\", {\n        tagName: videoRef.current.tagName,\n        srcObject: !!videoRef.current.srcObject,\n        videoWidth: videoRef.current.videoWidth,\n        videoHeight: videoRef.current.videoHeight,\n      });\n      cameraSession.setVideoElementRef(videoRef.current);\n      console.log(\"[Camera Connection]  videoElementRef set successfully\");\n    } else {\n      console.error(\n        \"[Camera Connection]  CRITICAL: videoRef.current is NULL at mount!\",\n      );\n    }\n    // Do NOT clear the videoElementRef on unmount; we want the stream to persist globally\n    return () => {\n      /* keep global video element ref for overlay */\n    };\n  }, []);\n\n  function ensureWS() {\n    // Return existing WebSocket if it's open or connecting\n    if (\n      ws &&\n      (ws.readyState === WebSocket.OPEN ||\n        ws.readyState === WebSocket.CONNECTING)\n    ) {\n      console.log(\n        \"[Camera Connection] ensureWS: Reusing existing WebSocket (state:\",\n        ws.readyState,\n        \")\",\n      );\n      return ws;\n    }\n    // Prefer configured WS endpoint; normalize to include '/ws'. Fallback to same-origin '/ws'.\n    const envUrl = (import.meta as any).env?.VITE_WS_URL as string | undefined;\n    const normalizedEnv =\n      envUrl && envUrl.length > 0\n        ? envUrl.endsWith(\"/ws\")\n          ? envUrl\n          : envUrl.replace(/\\/$/, \"\") + \"/ws\"\n        : undefined;\n    const proto = window.location.protocol === \"https:\" ? \"wss\" : \"ws\";\n    const sameOrigin = `${proto}://${window.location.host}/ws`;\n    const host = window.location.hostname;\n    // Production safeguard: if we are not on the Render backend host and no env URL is set,\n    // prefer the known Render service as a fallback instead of Netlify same-origin.\n    const renderWS = `wss://ninedartnation.onrender.com/ws`;\n    const url =\n      normalizedEnv || (host.endsWith(\"onrender.com\") ? sameOrigin : renderWS);\n    console.log(\n      \"[Camera Connection] ensureWS: Creating new WebSocket to:\",\n      url,\n    );\n    const socket: WebSocket = new WebSocket(url);\n\n    // Set up handlers BEFORE storing the socket to avoid race conditions\n    socket.onerror = (error) => {\n      console.error(\"[Camera Connection] WebSocket connection error:\", error);\n      alert(\n        \"Failed to connect to camera pairing service. Please check your internet connection and try again.\",\n      );\n    };\n    socket.onclose = (event) => {\n      console.log(\n        \"[Camera Connection] WebSocket closed:\",\n        event.code,\n        event.reason,\n      );\n      if (pcRef.current) {\n        try {\n          pcRef.current.close();\n        } catch {}\n        pcRef.current = null;\n      }\n      updatePairCode(null);\n      setExpiresAt(null);\n      setPaired(false);\n      // Only show alert if it wasn't a clean close\n      if (event.code !== 1000) {\n        alert(\"Camera pairing connection lost. Please try pairing again.\");\n        // Also revert to local mode on disconnect so user can restart camera\n        if (mode === \"phone\") setMode(\"local\");\n      }\n    };\n\n    // Store socket BEFORE setting message handler to ensure it's available for message sending\n    setWs(socket);\n    return socket;\n  }\n\n  async function startPhonePairing() {\n    // Do not reset paired/streaming/phase state here to keep UI static\n    // Switch UI into phone pairing mode so the calibrator shows phone-specific hints\n    setMode(\"phone\");\n    // Stop any existing camera streams before switching to phone mode\n    // This ensures clean transition and no resource conflicts\n    // Use true for autoRevert since we're explicitly switching modes, but we already set mode above\n    stopCamera(false);\n    // Lock selection and ensure camera UI is enabled while pairing is active\n    lockSelectionForPairing();\n    try {\n      setCameraEnabled(true);\n    } catch (e) {}\n    const socket = ensureWS();\n    // Send cam-create when socket is ready\n    if (socket.readyState === WebSocket.OPEN) {\n      console.log(\"[Camera Connection] WebSocket open, sending cam-create\");\n      socket.send(JSON.stringify({ type: \"cam-create\" }));\n    } else {\n      console.log(\n        \"[Camera Connection] WebSocket connecting, will send cam-create on open\",\n      );\n      socket.addEventListener(\n        \"open\",\n        () => {\n          console.log(\n            \"[Camera Connection] WebSocket now open, sending cam-create\",\n          );\n          socket.send(JSON.stringify({ type: \"cam-create\" }));\n        },\n        { once: true },\n      );\n    }\n    socket.onmessage = async (ev) => {\n      const data = JSON.parse(ev.data);\n      if (data.type === \"cam-code\") {\n        updatePairCode(data.code);\n        if (data.expiresAt) setExpiresAt(data.expiresAt);\n      } else if (data.type === \"cam-peer-joined\") {\n        // Ensure we have the latest pairing code even if messages arrive out of order\n        if (!pairCodeRef.current && data.code) updatePairCode(data.code);\n        setPaired(true);\n        // When a phone peer joins, proactively send current calibration (if locked)\n        const codeForSession = pairCodeRef.current || data.code || null;\n        if (codeForSession) pairCodeRef.current = codeForSession;\n        try {\n          if (locked && codeForSession) {\n            const imgSize = canvasRef.current\n              ? { w: canvasRef.current.width, h: canvasRef.current.height }\n              : null;\n            const payload = {\n              H,\n              imageSize: imgSize,\n              errorPx: errorPx ?? null,\n              createdAt: Date.now(),\n            };\n            socket.send(\n              JSON.stringify({\n                type: \"cam-calibration\",\n                code: codeForSession,\n                payload,\n              }),\n            );\n            console.log(\n              \"[Camera Connection] Sent calibration to joined phone for code\",\n              codeForSession,\n            );\n          }\n        } catch (e) {\n          console.warn(\n            \"[Camera Connection] Failed to send calibration on peer join\",\n            e,\n          );\n        }\n        const peer = new RTCPeerConnection({\n          iceServers: [{ urls: \"stun:stun.l.google.com:19302\" }],\n          iceCandidatePoolSize: 10,\n        });\n        pcRef.current = peer;\n\n        // Add connection state monitoring\n        peer.onconnectionstatechange = () => {\n          console.log(\"WebRTC connection state:\", peer.connectionState);\n          if (\n            peer.connectionState === \"failed\" ||\n            peer.connectionState === \"disconnected\"\n          ) {\n            console.error(\"WebRTC connection failed\");\n            alert(\"Camera connection lost. Please try pairing again.\");\n            stopCamera(false);\n          } else if (peer.connectionState === \"connected\") {\n            console.log(\"WebRTC connection established\");\n          }\n        };\n\n        peer.onicecandidate = (e) => {\n          if (e.candidate && codeForSession) {\n            socket.send(\n              JSON.stringify({\n                type: \"cam-ice\",\n                code: codeForSession,\n                payload: e.candidate,\n              }),\n            );\n          }\n        };\n\n        peer.ontrack = (ev) => {\n          console.log(\n            \"[Camera Connection] WebRTC ontrack received:\",\n            ev.streams?.length,\n            \"streams, track kind:\",\n            ev.track?.kind,\n          );\n          if (videoRef.current) {\n            const inbound = ev.streams?.[0];\n            if (inbound) {\n              console.log(\n                \"[Camera Connection] Assigning video stream (tracks:\",\n                inbound.getTracks().length,\n                \") to video element\",\n              );\n              // Ensure video element is visible\n              setHasSnapshot(false);\n              // Use setTimeout to ensure DOM updates before assigning stream\n              setTimeout(() => {\n                if (videoRef.current) {\n                  console.log(\n                    \"[Camera Connection] Setting srcObject and attempting play\",\n                  );\n                  // Clean up any existing stream before assigning new one\n                  if (videoRef.current.srcObject) {\n                    const existingTracks = (\n                      videoRef.current.srcObject as MediaStream\n                    ).getTracks();\n                    existingTracks.forEach((t) => t.stop());\n                  }\n                  videoRef.current.srcObject = inbound;\n                  videoRef.current.muted = true; // Ensure muted for autoplay policy\n                  videoRef.current.playsInline = true; // Mobile/iOS support\n                  videoRef.current\n                    .play()\n                    .then(() => {\n                      console.log(\n                        \"[Camera Connection] Video playback started successfully\",\n                      );\n                      // Mark that we're streaming from the phone and transition to capture\n                      setStreaming(true);\n                      setPhase(\"capture\");\n                      // Update camera session so other components can see the stream\n                      cameraSession.setStreaming(true);\n                      cameraSession.setMode(\"phone\");\n                      cameraSession.setMediaStream(inbound);\n                      // Set user settings to reflect that the active camera is the phone\n                      try {\n                        setPreferredCamera(undefined, \"Phone Camera\", true);\n                      } catch {}\n                      if (!preferredCameraLocked) {\n                        try {\n                          setPreferredCameraLocked(true);\n                        } catch {}\n                      }\n                      try {\n                        setCameraEnabled(true);\n                      } catch {}\n                      // If an overlay prompt was shown earlier, hide it now\n                      setVideoPlayBlocked(false);\n                    })\n                    .catch((err) => {\n                      console.error(\n                        \"[Camera Connection] Video play failed:\",\n                        err,\n                      );\n                      // Show a friendly tap-to-play overlay so user can enable playback\n                      setVideoPlayBlocked(true);\n                      console.warn(\n                        \"[Camera Connection] video play blocked  prompting user interaction\",\n                      );\n                    });\n                }\n              }, 100);\n            } else {\n              console.error(\n                \"[Camera Connection] No inbound stream received in ontrack\",\n              );\n            }\n          } else {\n            console.error(\"[Camera Connection] Video element not available\");\n          }\n        };\n\n        try {\n          // Explicitly add a transceiver to ensure we request video capability\n          // even if the browser defaults for createOffer vary.\n          peer.addTransceiver(\"video\", { direction: \"recvonly\" });\n          const offer = await peer.createOffer({\n            offerToReceiveAudio: false,\n            offerToReceiveVideo: true,\n          });\n          await peer.setLocalDescription(offer);\n          console.log(\n            \"[Camera Connection] Sending cam-offer for code:\",\n            codeForSession,\n          );\n          if (codeForSession)\n            socket.send(\n              JSON.stringify({\n                type: \"cam-offer\",\n                code: codeForSession,\n                payload: offer,\n              }),\n            );\n          else\n            console.warn(\n              \"[Camera Connection] Missing pairing code when sending offer\",\n            );\n        } catch (err) {\n          console.error(\"Failed to create WebRTC offer:\", err);\n          alert(\"Failed to establish camera connection. Please try again.\");\n          stopCamera(false);\n        }\n      } else if (data.type === \"cam-answer\") {\n        console.log(\"[Camera Connection] Received cam-answer\");\n        const peer = pcRef.current;\n        if (peer) {\n          try {\n            await peer.setRemoteDescription(\n              new RTCSessionDescription(data.payload),\n            );\n            console.log(\"[Camera Connection] Remote description set (answer)\");\n\n            // Process any pending ICE candidates that arrived before the answer\n            const pending = pendingIceCandidatesRef.current;\n            console.log(\n              `[Camera Connection] Processing ${pending.length} pending ICE candidates`,\n            );\n            for (const candidate of pending) {\n              try {\n                await peer.addIceCandidate(candidate);\n                console.log(\"[Camera Connection] Queued ICE candidate added\");\n              } catch (err) {\n                console.error(\"Failed to add queued ICE candidate:\", err);\n              }\n            }\n            pendingIceCandidatesRef.current = [];\n          } catch (err) {\n            console.error(\"Failed to set remote description:\", err);\n            alert(\"Camera pairing failed. Please try again.\");\n            stopCamera(false);\n          }\n        } else {\n          console.warn(\n            \"[Camera Connection] Received cam-answer but no peer connection exists\",\n          );\n        }\n      } else if (data.type === \"cam-ice\") {\n        console.log(\"[Camera Connection] Received cam-ice\");\n        const peer = pcRef.current;\n        if (peer) {\n          // Only add ICE candidate if remote description is already set\n          // Otherwise, queue it for later processing\n          if (peer.remoteDescription) {\n            try {\n              await peer.addIceCandidate(data.payload);\n              console.log(\"[Camera Connection] ICE candidate added\");\n            } catch (err) {\n              console.error(\"Failed to add ICE candidate:\", err);\n            }\n          } else {\n            console.log(\n              \"[Camera Connection] Remote description not set yet, queuing ICE candidate\",\n            );\n            pendingIceCandidatesRef.current.push(data.payload);\n          }\n        } else {\n          console.warn(\n            \"[Camera Connection] Received ICE candidate but no peer connection exists\",\n          );\n        }\n      } else if (data.type === \"cam-error\") {\n        console.error(\"Camera pairing error:\", data.code);\n        alert(\n          data.code === \"EXPIRED\"\n            ? \"Code expired. Generate a new code.\"\n            : `Camera error: ${data.code || \"Unknown error\"}`,\n        );\n        stopCamera(false);\n      } else if (data.type === \"cam-calibration\") {\n        // Desktop receives calibration from phone (via server) or phone receives from desktop\n        console.log(\n          \"[Camera Connection] Received calibration from peer:\",\n          data.payload,\n        );\n        try {\n          if (data.payload) {\n            // If payload has a homography, use it. Otherwise if we have 4 connection points, attempt to compute H.\n            let Hpayload = Array.isArray(data.payload.H)\n              ? (data.payload.H as Homography)\n              : null;\n            if (\n              !Hpayload &&\n              Array.isArray(data.payload.calibrationPoints) &&\n              data.payload.calibrationPoints.length >= 4\n            ) {\n              try {\n                const canonicalSrc = [\n                  { x: 0, y: -BoardRadii.doubleOuter },\n                  { x: BoardRadii.doubleOuter, y: 0 },\n                  { x: 0, y: BoardRadii.doubleOuter },\n                  { x: -BoardRadii.doubleOuter, y: 0 },\n                ];\n                Hpayload = computeHomographyDLT(\n                  canonicalSrc,\n                  data.payload.calibrationPoints.slice(0, 4),\n                );\n              } catch (err) {\n                console.warn(\n                  \"[Camera Connection] Failed to compute homography from received connection points\",\n                  err,\n                );\n              }\n            }\n            if (Hpayload) {\n              // Apply the received calibration\n              // Use overlay size from current preview (video or overlay/canvas) if available so visual scale stays consistent\n              const overlaySize = overlayRef?.current\n                ? { w: overlayRef.current.width, h: overlayRef.current.height }\n                : videoRef?.current\n                  ? {\n                      w: videoRef.current.clientWidth,\n                      h: videoRef.current.clientHeight,\n                    }\n                  : (data.payload.imageSize ?? null);\n              setCalibration({\n                H: Hpayload as Homography,\n                createdAt: data.payload.createdAt || Date.now(),\n                errorPx: data.payload.errorPx,\n                imageSize: data.payload.imageSize,\n                overlaySize,\n                locked: true, // Assume locked since peer sent it\n              });\n              console.log(\"[Camera Connection] Applied received calibration\");\n            }\n          }\n        } catch (e) {\n          console.error(\n            \"[Camera Connection] Failed to apply received calibration\",\n            e,\n          );\n        }\n      }\n    };\n  }\n\n  async function startWifiConnection() {\n    setDiscoveringWifi(true);\n    try {\n      const devices = await discoverNetworkDevices();\n      setWifiDevices(devices);\n      if (devices.length === 0) {\n        alert(\n          \"No wifi scoring devices found on your network. Make sure devices are powered on and connected to the same network.\",\n        );\n      }\n    } catch (error) {\n      console.error(\"Wifi device discovery failed:\", error);\n      alert(\n        \"Failed to discover wifi devices. Please check your network connection.\",\n      );\n    } finally {\n      setDiscoveringWifi(false);\n    }\n    setPhase(\"camera\");\n  }\n\n  async function connectToWifiDevice(device: NetworkDevice) {\n    try {\n      setWifiDevices((devices) =>\n        devices.map((d) =>\n          d.id === device.id ? { ...d, status: \"connecting\" as const } : d,\n        ),\n      );\n\n      const stream = await connectToNetworkDevice(device);\n      if (stream && videoRef.current) {\n        // Clean up any existing stream before assigning new one\n        if (videoRef.current.srcObject) {\n          const existingTracks = (\n            videoRef.current.srcObject as MediaStream\n          ).getTracks();\n          existingTracks.forEach((t) => t.stop());\n        }\n        videoRef.current.srcObject = stream;\n        await videoRef.current.play();\n        setStreaming(true);\n        setPhase(\"capture\");\n        setWifiDevices((devices) =>\n          devices.map((d) =>\n            d.id === device.id ? { ...d, status: \"online\" as const } : d,\n          ),\n        );\n      } else {\n        throw new Error(\"Failed to get video stream\");\n      }\n    } catch (error) {\n      console.error(\"Failed to connect to wifi device:\", error);\n      alert(\n        `Failed to connect to ${device.name}. Please check the device and try again.`,\n      );\n      setWifiDevices((devices) =>\n        devices.map((d) =>\n          d.id === device.id ? { ...d, status: \"offline\" as const } : d,\n        ),\n      );\n    }\n  }\n\n  async function startCamera() {\n    if (mode === \"phone\") return startPhonePairing();\n    if (mode === \"wifi\") return startWifiConnection();\n    console.log(\n      \"[Camera Connection]  START_CAMERA: mode=\",\n      mode,\n      \"preferredCameraId=\",\n      preferredCameraId,\n    );\n    try {\n      let stream: MediaStream | null = null;\n\n      // Step 1: Try with preferred camera ID if available\n      if (preferredCameraId) {\n        try {\n          console.log(\n            \"[Camera Connection]  Attempt 1: Using preferred camera ID:\",\n            preferredCameraId,\n          );\n          stream = await navigator.mediaDevices.getUserMedia({\n            video: { deviceId: { exact: preferredCameraId } },\n            audio: false,\n          });\n          console.log(\n            \"[Camera Connection]  SUCCESS with preferred camera:\",\n            stream.getTracks().length,\n            \"tracks\",\n          );\n        } catch (err: any) {\n          console.warn(\n            \"[Camera Connection]  Preferred camera failed:\",\n            err?.name,\n            err?.message,\n          );\n        }\n      }\n\n      // Step 2: If preferred didn't work, try any camera\n      if (!stream) {\n        try {\n          console.log(\n            \"[Camera Connection]  Attempt 2: Using ANY available camera\",\n          );\n          stream = await navigator.mediaDevices.getUserMedia({\n            video: true,\n            audio: false,\n          });\n          console.log(\n            \"[Camera Connection]  SUCCESS with fallback camera:\",\n            stream.getTracks().length,\n            \"tracks\",\n          );\n        } catch (err: any) {\n          console.error(\n            \"[Camera Connection]  BOTH attempts failed:\",\n            err?.name,\n            err?.message,\n          );\n          throw err;\n        }\n      }\n\n      // Step 3: Assign to video element\n      if (!stream) {\n        throw new Error(\"No stream obtained\");\n      }\n\n      if (!videoRef.current) {\n        throw new Error(\"Video element ref is null\");\n      }\n\n      console.log(\"[Camera Connection]  Assigning stream to video element\");\n      videoRef.current.srcObject = stream;\n\n      console.log(\"[Camera Connection]  Calling play()\");\n      try {\n        await videoRef.current.play();\n        console.log(\"[Camera Connection]  Play succeeded\");\n      } catch (playErr: any) {\n        console.warn(\n          \"[Camera Connection]  Play failed, retrying in 100ms:\",\n          playErr?.message,\n        );\n        await new Promise((r) => setTimeout(r, 100));\n        await videoRef.current.play();\n        console.log(\"[Camera Connection]  Play succeeded on retry\");\n      }\n\n      console.log(\"[Camera Connection]  Setting streaming = true\");\n      setStreaming(true);\n      setPhase(\"capture\");\n      console.log(\"[Camera Connection]  State updated\");\n    } catch (e: any) {\n      console.error(\"[Camera Connection]  FATAL:\", e?.message || e);\n      alert(`Camera failed: ${e?.message || \"Unknown error\"}`);\n      // Clean up any partial stream\n      if (videoRef.current?.srcObject) {\n        (videoRef.current.srcObject as MediaStream)\n          .getTracks()\n          .forEach((t) => t.stop());\n        videoRef.current.srcObject = null;\n      }\n    }\n  }\n\n  function stopCamera(autoRevert: boolean = false) {\n    if (videoRef.current && videoRef.current.srcObject) {\n      const tracks = (videoRef.current.srcObject as MediaStream).getTracks();\n      tracks.forEach((t) => t.stop());\n      videoRef.current.srcObject = null;\n      setStreaming(false);\n    }\n    if (pcRef.current) {\n      try {\n        pcRef.current.close();\n      } catch {}\n      pcRef.current = null;\n    }\n    pendingIceCandidatesRef.current = [];\n    updatePairCode(null);\n    setExpiresAt(null);\n    setPaired(false);\n    setMarkerResult(null);\n    // Clear camera session when stopping camera\n    cameraSession.setStreaming(false);\n    cameraSession.setMediaStream(null);\n    // Only revert to local mode if EXPLICITLY requested (user clicked Stop button)\n    // Otherwise preserve the selected mode so user can go to OfflinePlay and come back\n    if (autoRevert && (mode === \"phone\" || mode === \"wifi\")) {\n      setMode(\"local\");\n    }\n  }\n\n  function regenerateCode() {\n    // Only regenerate code, do not reset UI or camera state\n    if (ws && ws.readyState === WebSocket.OPEN) {\n      ws.send(JSON.stringify({ type: \"cam-create\" }));\n    } else {\n      startPhonePairing();\n    }\n    // Lock the preferred camera selection while pairing is active so it doesn't\n    // flip automatically during the pairing flow.\n    lockSelectionForPairing();\n  }\n\n  // When user regenerates a pairing code we lock the preferred camera selection so\n  // it won't be changed accidentally by other parts of the UI while pairing is active.\n  // This implements the user's request that the camera selection 'stay static' after\n  // generating a code. The lock can be toggled by the user in the DevicePicker UI.\n  function lockSelectionForPairing() {\n    try {\n      if (!preferredCameraLocked) {\n        setPreferredCameraLocked(true);\n      }\n    } catch {}\n  }\n\n  // Allow uploading a photo instead of using a live camera\n  function triggerUpload() {\n    try {\n      fileInputRef.current?.click();\n    } catch {}\n  }\n\n  function openMarkerSheet() {\n    // Open the marker sheet page in a new tab for printing\n    const markerSheetUrl = `${window.location.origin}/marker-sheet.html`;\n    window.open(markerSheetUrl, \"_blank\");\n  }\n\n  function onUploadPhotoChange(e: React.ChangeEvent<HTMLInputElement>) {\n    const f = e.target.files?.[0];\n    if (!f) return;\n    const img = new Image();\n    img.onload = () => {\n      try {\n        if (!canvasRef.current) return;\n        const c = canvasRef.current;\n        c.width = img.naturalWidth;\n        c.height = img.naturalHeight;\n        const ctx = c.getContext(\"2d\")!;\n        ctx.drawImage(img, 0, 0, c.width, c.height);\n        setHasSnapshot(true);\n        setFrameSize({ w: c.width, h: c.height });\n        setPhase(\"select\");\n        setDstPoints([]);\n        setMarkerResult(null);\n        // Clear any previous video stream\n        stopCamera(false);\n      } catch {}\n    };\n    img.onerror = () => {\n      alert(\"Could not load image. Please try a different photo.\");\n    };\n    img.src = URL.createObjectURL(f);\n    // reset input value so the same file can be reselected\n    try {\n      e.target.value = \"\";\n    } catch {}\n  }\n\n  function captureFrame() {\n    if (!videoRef.current || !canvasRef.current) return;\n    const v = videoRef.current;\n    const c = canvasRef.current;\n    c.width = v.videoWidth;\n    c.height = v.videoHeight;\n    const ctx = c.getContext(\"2d\")!;\n    ctx.drawImage(v, 0, 0, c.width, c.height);\n    setHasSnapshot(true);\n    setFrameSize({ w: c.width, h: c.height });\n    setPhase(\"select\");\n    // Ensure we start fresh with 0 points - log for debugging\n    console.log(\"[Camera Connection] captureFrame: resetting dstPoints to []\");\n    setDstPoints([]);\n    setDetected(null); // Also clear auto-detected rings\n    setForceDetectedOnly(false);\n    setMarkerResult(null);\n    // Clear the overlay canvas to remove any leftover drawings (dart axis lines, etc.)\n    if (overlayRef.current) {\n      const o = overlayRef.current;\n      o.width = c.width;\n      o.height = c.height;\n      const octx = o.getContext(\"2d\");\n      if (octx) octx.clearRect(0, 0, o.width, o.height);\n    }\n    // If liveDetect is on, kick a detect on this captured frame\n    if (liveDetect)\n      setTimeout(() => {\n        autoDetectRings();\n      }, 0);\n  }\n\n  function drawOverlay(\n    currentPoints = dstPoints,\n    HH: Homography | null = null,\n  ) {\n    if (!canvasRef.current || !overlayRef.current) return;\n    const img = canvasRef.current;\n    const o = overlayRef.current;\n    o.width = img.width;\n    o.height = img.height;\n    const ctx = o.getContext(\"2d\")!;\n    ctx.clearRect(0, 0, o.width, o.height);\n\n    // Ensure overlay is interactive: attach click handler for align operation\n    if (overlayRef.current) {\n      overlayRef.current.onclick = (e: MouseEvent) => onOverlayClick(e);\n    }\n\n    // Only use stored H for drawing rings if we have enough points OR if explicitly passed HH\n    // During calibration point collection (phase=\"select\" with < REQUIRED points), don't use old H\n    // as it may be from a previous frame and draw incorrectly\n    const Huse =\n      HH || (currentPoints.length >= REQUIRED_POINT_COUNT ? H : null);\n    // Apply the correction to the stored calibration H so both overlay and scoring match\n    // Add translation after scaling for pixel-perfect alignment\n    const CORRECTION_SX = correctionSx; // <1 compresses horizontally\n    const CORRECTION_TX = correctionTx; // pixels right (+) or left (-)\n    const CORRECTION_TY = correctionTy; // pixels down (+) or up (-)\n    let Hcorrected = Huse;\n    if (Hcorrected && CORRECTION_SX !== 1)\n      Hcorrected = scaleHomography(Hcorrected, CORRECTION_SX, 1);\n    if (Hcorrected && (CORRECTION_TX !== 0 || CORRECTION_TY !== 0))\n      Hcorrected = translateHomography(\n        Hcorrected,\n        CORRECTION_TX,\n        CORRECTION_TY,\n      );\n\n    // Apply translation corrections to center coordinates (when detected exists)\n    const adjustedCenterX = detected ? detected.cx + correctionTx : 0;\n    const adjustedCenterY = detected ? detected.cy + correctionTy : 0;\n\n    // Precompute detected radii map (useful even if we later bypass homography)\n    const WIDEN_FACTOR = 1.0; // use raw detected radii for exact alignment\n    const detectedRingMap: { [key: number]: number } = {};\n    if (detected) {\n      // Store raw scaled radii (before applying correctionSx for display as ellipses)\n      detectedRingMap[BoardRadii.bullInner] = detected.bullInner * WIDEN_FACTOR;\n      detectedRingMap[BoardRadii.bullOuter] = detected.bullOuter * WIDEN_FACTOR;\n      detectedRingMap[BoardRadii.trebleInner] =\n        detected.trebleInner * WIDEN_FACTOR;\n      detectedRingMap[BoardRadii.trebleOuter] =\n        detected.trebleOuter * WIDEN_FACTOR;\n      detectedRingMap[BoardRadii.doubleInner] =\n        detected.doubleInner * WIDEN_FACTOR;\n      detectedRingMap[BoardRadii.doubleOuter] =\n        detected.doubleOuter * WIDEN_FACTOR;\n    }\n\n    // Per-ring adjustments if needed (quick fix for non-standard boards)\n    const perRingAdjust: { [key: number]: number } = {};\n    // Apply per-ring adjustments using UI-controlled state\n    perRingAdjust[BoardRadii.doubleOuter] = doubleOuterAdjust;\n    perRingAdjust[BoardRadii.trebleOuter] = trebleOuterAdjust;\n\n    // Helper to draw the detected rings directly (bypass homography)\n    function drawDetectedRings(): number {\n      if (!detected) return 0;\n      let drawn = 0;\n      try {\n        // Colors using pass/fail heuristics are available below; use default colors here\n        const bullFill = \"rgba(52,211,153,0.08)\";\n        const trebleFill = \"rgba(253,224,71,0.06)\";\n        const doubleFill = \"rgba(34,211,238,0.06)\";\n\n        const drawBand = (\n          rInner: number,\n          rOuter: number,\n          fillStyle: string,\n          strokeStyle?: string,\n        ) => {\n          const inner = detectedRingMap[rInner];\n          const outer = detectedRingMap[rOuter];\n          if (!inner || !outer) return false;\n          ctx.save();\n          ctx.shadowColor = \"rgba(0,0,0,0.45)\";\n          ctx.shadowBlur = 6;\n          ctx.beginPath();\n          const outerAdj = outer * (perRingAdjust[rOuter] || 1);\n          const innerAdj = inner * (perRingAdjust[rInner] || 1);\n          // Draw as circles based on adjusted radii; no ellipse distortions\n          ctx.arc(adjustedCenterX, adjustedCenterY, outerAdj, 0, Math.PI * 2);\n          ctx.arc(\n            adjustedCenterX,\n            adjustedCenterY,\n            innerAdj,\n            0,\n            Math.PI * 2,\n            true,\n          );\n          ctx.closePath();\n          ctx.fillStyle = fillStyle;\n          ctx.fill();\n          if (strokeStyle) {\n            ctx.strokeStyle = strokeStyle;\n            ctx.lineWidth = 2;\n            ctx.stroke();\n          }\n          ctx.restore();\n          return true;\n        };\n\n        drawBand(BoardRadii.bullInner, BoardRadii.bullOuter, bullFill);\n        drawn++;\n        drawBand(BoardRadii.trebleInner, BoardRadii.trebleOuter, trebleFill);\n        drawn++;\n        drawBand(BoardRadii.doubleInner, BoardRadii.doubleOuter, doubleFill);\n        drawn++;\n\n        // Outlines for clarity\n        const OUTLINE_STEPS = 360;\n        const outlines = [\n          { r: BoardRadii.bullInner, color: \"#00ff66\" },\n          { r: BoardRadii.bullOuter, color: \"#ffffff\" },\n          { r: BoardRadii.trebleInner, color: \"#fde047\" },\n          { r: BoardRadii.trebleOuter, color: \"#fde047\" },\n          { r: BoardRadii.doubleInner, color: \"#22d3ee\" },\n          { r: BoardRadii.doubleOuter, color: \"#22d3ee\" },\n        ];\n        for (const oline of outlines) {\n          const radius = detectedRingMap[oline.r];\n          if (!radius) continue;\n          const poly: Point[] = [];\n          for (let i = 0; i < OUTLINE_STEPS; i++) {\n            const angle = (i / OUTLINE_STEPS) * Math.PI * 2;\n            const rAdj = radius * correctionSx * (perRingAdjust[oline.r] || 1);\n            poly.push({\n              x: adjustedCenterX + rAdj * Math.cos(angle),\n              y: adjustedCenterY + rAdj * Math.sin(angle),\n            });\n          }\n          drawPolyline(ctx, poly, \"rgba(0,0,0,0.45)\", 3);\n          drawPolyline(ctx, poly, oline.color, 1.5);\n        }\n      } catch (err) {\n        return 0;\n      }\n      return 3;\n    }\n\n    // Click handler for overlay to support 'align ring by click'\n    function onOverlayClick(evt: MouseEvent) {\n      if (!aligningRing || !overlayRef.current || !detected) return;\n      const rect = overlayRef.current.getBoundingClientRect();\n      const x =\n        (evt.clientX - rect.left) * (overlayRef.current.width / rect.width);\n      const y =\n        (evt.clientY - rect.top) * (overlayRef.current.height / rect.height);\n      const dx = x - adjustedCenterX;\n      const dy = y - adjustedCenterY;\n      const clickedRadius = Math.hypot(dx, dy);\n      let key: number;\n      if (aligningRing === \"double\") key = BoardRadii.doubleOuter;\n      else if (aligningRing === \"treble\") key = BoardRadii.trebleOuter;\n      else key = BoardRadii.bullOuter;\n      const currentRadius = detectedRingMap[key];\n      if (!currentRadius || currentRadius <= 0) return;\n      const newAdjust = clickedRadius / (currentRadius * correctionSx);\n      if (aligningRing === \"double\") setDoubleOuterAdjust(newAdjust);\n      if (aligningRing === \"treble\") setTrebleOuterAdjust(newAdjust);\n      if (aligningRing === \"bull\") {\n        // Update bull adjustments via Sx temporarily (only for display) - more complex per-ring state could be added\n        setCorrectionSx((prev) => prev * (newAdjust / prev));\n      }\n      setAligningRing(null);\n      console.log(\n        \"[Camera Connection] Aligned \",\n        aligningRing,\n        \" adjust=\",\n        newAdjust.toFixed(4),\n      );\n    }\n    // Use Hcorrected everywhere below (for overlay and for scoring)\n    // If you want to make this user-tunable, expose CORRECTION_SX as a setting\n    // (for now, hardcoded for millimetre alignment)\n    // Note: this means the correction is always applied, including when saving calibration\n    // and when mapping points for scoring.\n    const Hdraw = Hcorrected;\n    if (HH) {\n      console.log(\"[drawOverlay] Using passed homography:\", {\n        HH: HH.slice(0, 6),\n        currentPointsCount: currentPoints.length,\n        canvasSize: { w: o.width, h: o.height },\n      });\n    }\n    if (forceDetectedOnly && detected) {\n      // Force-only: draw detected rings directly and skip homography-based overlay\n      const drawn = drawDetectedRings();\n      console.log(\n        \"[drawOverlay] Forced detected-only drawing, rings drawn:\",\n        drawn,\n      );\n      // Draw sector labels around the double center using detected theta\n      try {\n        const ctx2 = overlayRef.current?.getContext(\"2d\");\n        const hasCtx = !!ctx2 && overlayRef.current;\n        if (hasCtx && detected) {\n          ctx2!.save();\n          ctx2!.font = \"12px Sans-Serif\";\n          ctx2!.fillStyle = \"#ffffff\";\n          ctx2!.strokeStyle = \"#000000\";\n          ctx2!.lineWidth = 3;\n          const labels = SectorOrder; // canonical order\n          const centerX = adjustedCenterX;\n          const centerY = adjustedCenterY;\n          const rLabel = (detected.doubleInner + detected.doubleOuter) / 2 + 14; // just outside double center\n          const thetaVal = typeof theta === \"number\" ? theta : 0;\n          for (let i = 0; i < labels.length; i++) {\n            const ang =\n              (i / labels.length) * Math.PI * 2 - Math.PI / 2 - thetaVal;\n            const lx = centerX + rLabel * Math.cos(ang);\n            const ly = centerY + rLabel * Math.sin(ang);\n            const text = String(labels[i]);\n            const tw = ctx2!.measureText(text).width;\n            ctx2!.strokeText(text, lx - tw / 2, ly + 4);\n            ctx2!.fillText(text, lx - tw / 2, ly + 4);\n          }\n          ctx2!.restore();\n        }\n      } catch {}\n      return; // don't draw homography overlay\n    }\n\n    if (Huse) {\n      // Decide overlay color scheme based on verification and error\n      // Use errorPx from calibration store\n      const errPx = typeof errorPx === \"number\" ? errorPx : null;\n      const hasVerification =\n        verificationResults && verificationResults.length > 0;\n      const allPass = hasVerification\n        ? verificationResults.every((r) => r.match)\n        : null;\n      const passByError = typeof errPx === \"number\" ? errPx <= 1.5 : null; // strict pass threshold\n      const pass = allPass === true || passByError === true;\n      const fail = hasVerification\n        ? verificationResults.some((r) => !r.match)\n        : passByError === false;\n\n      console.log(\"[drawOverlay] Drawing via homography transform\");\n      const rings = [\n        BoardRadii.bullInner,\n        BoardRadii.bullOuter,\n        BoardRadii.trebleInner,\n        BoardRadii.trebleOuter,\n        BoardRadii.doubleInner,\n        BoardRadii.doubleOuter,\n      ];\n      let drawnCount = 0;\n\n      // Use precomputed detectedRingMap above (if present) - no need to recompute here\n\n      // Helper to draw a filled band between inner and outer radii\n      // Use detected radii when available for perfect alignment\n      const drawRingBand = (\n        Hmat: Homography,\n        rInner: number,\n        rOuter: number,\n        fillStyle: string,\n        strokeStyle?: string,\n      ) => {\n        try {\n          const STEPS = 720; // high resolution for smoothness\n\n          // If we have detected radii for both inner and outer, use direct circles\n          const detectedInner = detectedRingMap[rInner];\n          const detectedOuter = detectedRingMap[rOuter];\n          if (detected && detectedInner && detectedOuter) {\n            ctx.save();\n            // subtle shadow to improve contrast over busy backgrounds\n            ctx.shadowColor = \"rgba(0,0,0,0.45)\";\n            ctx.shadowBlur = 6;\n            ctx.beginPath();\n            // Draw ellipses to support horizontal scaling correction\n            if (ctx.ellipse) {\n              ctx.ellipse(\n                adjustedCenterX,\n                adjustedCenterY,\n                detectedOuter * correctionSx,\n                detectedOuter,\n                0,\n                0,\n                Math.PI * 2,\n              );\n              ctx.ellipse(\n                adjustedCenterX,\n                adjustedCenterY,\n                detectedInner * correctionSx,\n                detectedInner,\n                0,\n                0,\n                Math.PI * 2,\n                true,\n              );\n            } else {\n              ctx.arc(\n                adjustedCenterX,\n                adjustedCenterY,\n                detectedOuter,\n                0,\n                Math.PI * 2,\n              );\n              ctx.arc(\n                adjustedCenterX,\n                adjustedCenterY,\n                detectedInner,\n                0,\n                Math.PI * 2,\n                true,\n              );\n            }\n            ctx.closePath();\n            ctx.fillStyle = fillStyle;\n            ctx.fill();\n            if (strokeStyle) {\n              ctx.strokeStyle = strokeStyle;\n              ctx.lineWidth = 2;\n              ctx.stroke();\n            }\n            ctx.restore();\n            return true;\n          }\n\n          // Otherwise use homography-based drawing\n          const outer = sampleRing(Hmat, rOuter, STEPS);\n          const inner = sampleRing(Hmat, rInner, STEPS).reverse();\n          if (!outer.length || !inner.length) return false;\n          ctx.save();\n          // subtle shadow to improve contrast over busy backgrounds\n          ctx.shadowColor = \"rgba(0,0,0,0.45)\";\n          ctx.shadowBlur = 6;\n          ctx.beginPath();\n          ctx.moveTo(outer[0].x, outer[0].y);\n          for (let i = 1; i < outer.length; i++)\n            ctx.lineTo(outer[i].x, outer[i].y);\n          for (let i = 0; i < inner.length; i++)\n            ctx.lineTo(inner[i].x, inner[i].y);\n          ctx.closePath();\n          ctx.fillStyle = fillStyle;\n          ctx.fill();\n          if (strokeStyle) {\n            ctx.strokeStyle = strokeStyle;\n            ctx.lineWidth = 2;\n            ctx.stroke();\n          }\n          ctx.restore();\n          return true;\n        } catch (e) {\n          return false;\n        }\n      };\n      // Draw bands for ONLY bull, treble and double (playable zones)\n      // Do NOT draw any ring outside the double outer rim\n      if (Hdraw) {\n        // Colors: use green when pass, red when fail, else default\n        const bullFill = pass\n          ? \"rgba(0,255,102,0.12)\"\n          : fail\n            ? \"rgba(255,45,45,0.12)\"\n            : \"rgba(52,211,153,0.08)\";\n        const trebleFill = pass\n          ? \"rgba(0,255,102,0.08)\"\n          : fail\n            ? \"rgba(255,45,45,0.08)\"\n            : \"rgba(253,224,71,0.06)\";\n        const doubleFill = pass\n          ? \"rgba(0,255,102,0.06)\"\n          : fail\n            ? \"rgba(255,45,45,0.06)\"\n            : \"rgba(34,211,238,0.06)\";\n\n        // Bull (fill inner and outer ring area) - use real board radii\n        drawRingBand(\n          Hdraw as any,\n          BoardRadii.bullInner,\n          BoardRadii.bullOuter,\n          bullFill,\n          \"rgba(255,255,255,0.06)\",\n        );\n        drawnCount++;\n\n        // Treble band - use DETECTED radii if available, otherwise use calibration guide\n        const trebleInnerToUse =\n          detected?.trebleInner || CalibrationGuideRadii.trebleInner;\n        const trebleOuterToUse =\n          detected?.trebleOuter || CalibrationGuideRadii.trebleOuter;\n        drawRingBand(\n          Hdraw as any,\n          trebleInnerToUse,\n          trebleOuterToUse,\n          trebleFill,\n          \"rgba(255,255,255,0.06)\",\n        );\n        drawnCount++;\n\n        // Double band - use DETECTED radii if available, otherwise use calibration guide\n        const doubleInnerToUse =\n          detected?.doubleInner || CalibrationGuideRadii.doubleInner;\n        const doubleOuterToUse =\n          detected?.doubleOuter || CalibrationGuideRadii.doubleOuter;\n        drawRingBand(\n          Hdraw as any,\n          doubleInnerToUse,\n          doubleOuterToUse,\n          doubleFill,\n          \"rgba(255,255,255,0.06)\",\n        );\n        drawnCount++;\n\n        // Draw ONLY cyan outlines for the playable rings: bullInner, bullOuter, trebleInner, trebleOuter, doubleInner, doubleOuter\n        // Do NOT draw any outer board edge\n        try {\n          const OUTLINE_STEPS = 720;\n          const outlines = [\n            {\n              r: BoardRadii.bullInner,\n              color: pass ? \"#00ff66\" : fail ? \"#ff2d2d\" : \"#ffffff\",\n              key: \"bullInner\",\n            },\n            { r: BoardRadii.bullOuter, color: \"#ffffff\", key: \"bullOuter\" },\n            {\n              r: trebleInnerToUse,\n              color: pass ? \"#00ff66\" : fail ? \"#ff2d2d\" : \"#fde047\",\n              key: \"trebleInner\",\n            },\n            { r: trebleOuterToUse, color: \"#fde047\", key: \"trebleOuter\" },\n            {\n              r: doubleInnerToUse,\n              color: pass ? \"#00ff66\" : fail ? \"#ff2d2d\" : \"#22d3ee\",\n              key: \"doubleInner\",\n            },\n            { r: doubleOuterToUse, color: \"#22d3ee\", key: \"doubleOuter\" }, // <-- Last cyan ring; nothing beyond this\n          ];\n          for (const oline of outlines) {\n            const detectedRadius = detectedRingMap[oline.r];\n            let poly: Point[];\n            if (detected && detectedRadius) {\n              // Use detected radius for direct circle\n              poly = [];\n              for (let i = 0; i < OUTLINE_STEPS; i++) {\n                const angle = (i / OUTLINE_STEPS) * Math.PI * 2;\n                poly.push({\n                  x: adjustedCenterX + detectedRadius * Math.cos(angle),\n                  y: adjustedCenterY + detectedRadius * Math.sin(angle),\n                });\n              }\n            } else {\n              poly = sampleRing(Hdraw as any, oline.r, OUTLINE_STEPS);\n            }\n            // Draw a thin darker stroke then a brighter stroke on top for contrast\n            drawPolyline(ctx, poly, \"rgba(0,0,0,0.45)\", 3);\n            drawPolyline(ctx, poly, oline.color, 1.5);\n          }\n        } catch (err) {\n          // ignore outline errors\n        }\n      }\n      console.log(\"[drawOverlay] Drew\", drawnCount, \"rings via homography\");\n      // Draw sector labels when using homography too (align using theta if present)\n      try {\n        const ctx2 = overlayRef.current?.getContext(\"2d\");\n        const hasCtx = !!ctx2 && overlayRef.current;\n        if (hasCtx) {\n          // Compute board center in image via homography\n          const cImg = applyHomography(Hdraw || HH!, { x: 0, y: 0 });\n          const rCenter =\n            (BoardRadii.doubleInner + BoardRadii.doubleOuter) / 2 + 14;\n          const labels = SectorOrder;\n          ctx2!.save();\n          ctx2!.font = \"12px Sans-Serif\";\n          ctx2!.fillStyle = \"#ffffff\";\n          ctx2!.strokeStyle = \"#000000\";\n          ctx2!.lineWidth = 3;\n          const thetaVal = typeof theta === \"number\" ? theta : 0;\n          for (let i = 0; i < labels.length; i++) {\n            const ang =\n              (i / labels.length) * Math.PI * 2 - Math.PI / 2 - thetaVal;\n            const p = applyHomography(Hdraw || HH!, {\n              x: (rCenter - 14) * Math.cos(ang),\n              y: (rCenter - 14) * Math.sin(ang),\n            });\n            const text = String(labels[i]);\n            const tw = ctx2!.measureText(text).width;\n            ctx2!.strokeText(text, p.x - tw / 2, p.y + 4);\n            ctx2!.fillText(text, p.x - tw / 2, p.y + 4);\n          }\n          ctx2!.restore();\n        }\n      } catch {}\n\n      // PASS/FAIL flash badge (top-right) for ~1.5s after verification\n      if (flashStatus.type && Date.now() < flashStatus.until) {\n        const isPass = flashStatus.type === \"pass\";\n        const bg = isPass ? \"rgba(0,255,102,0.9)\" : \"rgba(255,45,45,0.9)\";\n        const text = isPass ? \"CALIBRATION PASS\" : \"CALIBRATION FAIL\";\n        ctx.save();\n        const pad = 12;\n        const x = o.width - 240 - pad;\n        const y = pad;\n        ctx.fillStyle = bg;\n        ctx.strokeStyle = \"rgba(0,0,0,0.25)\";\n        ctx.lineWidth = 2;\n        ctx.beginPath();\n        ctx.roundRect(x, y, 240, 34, 8);\n        ctx.fill();\n        ctx.stroke();\n        ctx.fillStyle = \"#00110a\";\n        ctx.font = \"bold 14px system-ui, sans-serif\";\n        ctx.textBaseline = \"middle\";\n        ctx.fillText(text, x + 12, y + 17);\n        ctx.restore();\n      }\n    }\n    // Always draw detected circles if enabled (for debugging detection accuracy)\n    if (detected && showDetectedOverlay) {\n      console.log(\"[drawOverlay] Drawing detected circles overlay:\", {\n        adjustedCx: Math.round(adjustedCenterX),\n        adjustedCy: Math.round(adjustedCenterY),\n        doubleOuter: Math.round(detected.doubleOuter),\n        trebleOuter: Math.round(detected.trebleOuter),\n        bullOuter: Math.round(detected.bullOuter),\n      });\n      const drawCircle = (r: number, color: string, w = 2) => {\n        if (!Number.isFinite(r) || r <= 0) return;\n        ctx.save();\n        ctx.strokeStyle = color;\n        ctx.lineWidth = w;\n        ctx.setLineDash([5, 5]); // Dashed to distinguish from overlay\n        ctx.beginPath();\n        const radScale = correctionSx; // use uniform scale for debug circles\n        const rx = r * radScale;\n        const ry = r * radScale;\n        if (ctx.ellipse)\n          ctx.ellipse(\n            adjustedCenterX,\n            adjustedCenterY,\n            rx,\n            ry,\n            0,\n            0,\n            Math.PI * 2,\n          );\n        else ctx.arc(adjustedCenterX, adjustedCenterY, r, 0, Math.PI * 2);\n        ctx.stroke();\n        ctx.restore();\n      };\n      // Draw detected rings with dashed lines\n      drawCircle(detected.doubleOuter, \"#ff6b6b\", 3); // Red for detected double\n      drawCircle(detected.doubleInner, \"#ff6b6b\", 2);\n      drawCircle(detected.trebleOuter, \"#ffd93d\", 2); // Yellow for detected treble\n      drawCircle(detected.trebleInner, \"#ffd93d\", 2);\n      drawCircle(detected.bullOuter, \"#6bcf7f\", 2); // Green for detected bull\n      drawCircle(detected.bullInner, \"#6bcf7f\", 3);\n\n      // Also draw homography-sampled rings (if Hdraw present) for comparison\n      if (Hdraw && !forceDetectedOnly) {\n        const sampleAndDraw = (rMm: number, color: string) => {\n          const poly = sampleRing(Hdraw as any, rMm, 180);\n          if (!poly.length) return;\n          ctx.save();\n          ctx.setLineDash([6, 4]);\n          ctx.strokeStyle = color;\n          ctx.lineWidth = 2;\n          ctx.beginPath();\n          ctx.moveTo(poly[0].x, poly[0].y);\n          for (let i = 1; i < poly.length; i++)\n            ctx.lineTo(poly[i].x, poly[i].y);\n          ctx.closePath();\n          ctx.stroke();\n          ctx.restore();\n        };\n        sampleAndDraw(BoardRadii.doubleOuter, \"#00ffff\");\n        sampleAndDraw(BoardRadii.trebleOuter, \"#ffff00\");\n      }\n    }\n    // Display detected metadata for debugging\n    if (detected) {\n      ctx.save();\n      ctx.fillStyle = \"rgba(0,0,0,0.65)\";\n      ctx.fillRect(8, 8, 260, 72);\n      ctx.fillStyle = \"#fff\";\n      ctx.font = \"12px system-ui, sans-serif\";\n      ctx.fillText(\n        `Detected cx:${Math.round(detected.cx)} cy:${Math.round(detected.cy)}`,\n        16,\n        28,\n      );\n      ctx.fillText(\n        `Double: ${Math.round(detected.doubleOuter)} Treble: ${Math.round(detected.trebleOuter)}`,\n        16,\n        48,\n      );\n      ctx.fillText(\n        `Adjusts: Sx:${correctionSx.toFixed(3)} Tx:${correctionTx} Ty:${correctionTy}`,\n        16,\n        68,\n      );\n      ctx.restore();\n    }\n\n    // Show calibration guide circles ONLY when we have a freshly computed homography (HH)\n    // from at least 4 clicked points in this session - don't use old stored H for guides\n    // as it may be incorrect and mislead the user\n    const targetPoints = canonicalRimTargets(\"outer\");\n    const showGuides =\n      currentPoints.length >= 4 &&\n      currentPoints.length < targetPoints.length &&\n      HH;\n    if (showGuides) {\n      ctx.save();\n      ctx.strokeStyle = \"rgba(255,193,7,0.4)\";\n      ctx.lineWidth = 2;\n      ctx.setLineDash([4, 4]);\n      // Show the remaining expected click positions (e.g., BULL after D20, D6, D3, D11)\n      for (let i = currentPoints.length; i < targetPoints.length; i++) {\n        try {\n          // Use the same visual correction for guide circles so they align with the rings\n          const p = applyHomography(Hdraw || HH, targetPoints[i]);\n          ctx.beginPath();\n          ctx.arc(p.x, p.y, 12, 0, Math.PI * 2);\n          ctx.stroke();\n          ctx.save();\n          ctx.fillStyle = \"rgba(255,255,255,0.65)\";\n          ctx.font = \"12px sans-serif\";\n          ctx.fillText(\n            CALIBRATION_POINT_LABELS[i] ?? String(i + 1),\n            p.x + 10,\n            p.y - 10,\n          );\n          ctx.restore();\n        } catch {}\n      }\n      ctx.restore();\n    }\n\n    // Show \"Click on X\" instruction prominently on the overlay\n    if (currentPoints.length < REQUIRED_POINT_COUNT) {\n      ctx.save();\n      ctx.fillStyle = \"rgba(0,0,0,0.7)\";\n      ctx.fillRect(10, 10, 200, 40);\n      ctx.fillStyle = \"#fbbf24\";\n      ctx.font = \"bold 16px sans-serif\";\n      ctx.fillText(\n        `Click on ${CALIBRATION_POINT_LABELS[currentPoints.length]}`,\n        20,\n        36,\n      );\n      ctx.restore();\n    }\n\n    // Draw clicked points with sector labels so users know which doubles have been mapped\n    currentPoints.forEach((p, i) => {\n      drawCross(ctx, p, \"#f472b6\");\n      ctx.save();\n      ctx.fillStyle = \"#f472b6\";\n      ctx.font = \"14px sans-serif\";\n      ctx.fillText(\n        CALIBRATION_POINT_LABELS[i] ?? String(i + 1),\n        p.x + 6,\n        p.y - 6,\n      );\n      ctx.restore();\n    });\n\n    // Preferred-view framing guide (if enabled and not yet calibrated)\n    if (calibrationGuide && !locked) {\n      ctx.save();\n      // Semi-transparent vignette to encourage centered, face-on framing\n      ctx.fillStyle = \"rgba(59,130,246,0.10)\";\n      const pad = Math.round(Math.min(o.width, o.height) * 0.08);\n      const w = o.width - pad * 2;\n      const h = o.height - pad * 2;\n      ctx.fillRect(pad, pad, w, h);\n      // Horizon/tilt line and vertical center line\n      ctx.strokeStyle = \"rgba(34,197,94,0.9)\";\n      ctx.lineWidth = 2;\n      // Horizontal line roughly through bull height\n      ctx.beginPath();\n      ctx.moveTo(pad, o.height / 2);\n      ctx.lineTo(o.width - pad, o.height / 2);\n      ctx.stroke();\n      // Vertical center\n      ctx.beginPath();\n      ctx.moveTo(o.width / 2, pad);\n      ctx.lineTo(o.width / 2, o.height - pad);\n      ctx.stroke();\n      // Angle brackets to suggest slight top-down 1015\n      ctx.strokeStyle = \"rgba(234,179,8,0.9)\";\n      ctx.setLineDash([6, 4]);\n      const ax = pad + 30,\n        ay = pad + 30;\n      ctx.beginPath();\n      ctx.moveTo(ax, ay + 30);\n      ctx.lineTo(ax + 60, ay);\n      ctx.stroke();\n      ctx.beginPath();\n      ctx.moveTo(o.width - ax, ay + 30);\n      ctx.lineTo(o.width - ax - 60, ay);\n      ctx.stroke();\n      ctx.restore();\n      // Legend - draw at fixed size regardless of zoom\n      ctx.save();\n      ctx.scale(1 / zoom, 1 / zoom); // Inverse scale to keep text static\n      ctx.fillStyle = \"rgba(255,255,255,0.85)\";\n      ctx.font = \"12px sans-serif\";\n      ctx.fillText(\n        \"Tip: Frame board centered, edges parallel; slight top-down is okay. Keep bull near center.\",\n        pad * zoom,\n        (pad + 18) * zoom,\n      );\n      ctx.restore();\n    }\n  }\n\n  const applyTestAutoDetectResult = (result: TestAutoDetectResult) => {\n    if (!result) return;\n    setAutoCalibrating(false);\n    setDetected(null);\n    setForceDetectedOnly(false);\n    if (result.anchors?.dst && result.anchors.dst.length > 0) {\n      setDstPoints(result.anchors.dst);\n      drawOverlay(result.anchors.dst, result.H);\n    }\n    // Save the corrected H so scoring and overlay match\n    // Save the corrected H (with scale and translation) so scoring and overlay match\n    let Hcal = result.H;\n    if (correctionSx !== 1) Hcal = scaleHomography(Hcal, correctionSx, 1);\n    if (correctionTx !== 0 || correctionTy !== 0)\n      Hcal = translateHomography(Hcal, correctionTx, correctionTy);\n    setCalibration({\n      H: Hcal,\n      createdAt: Date.now(),\n      errorPx: result.errorPx,\n      imageSize: result.imageSize,\n      overlaySize: result.overlaySize,\n      anchors: result.anchors,\n      locked: result.locked,\n    });\n    setPhase(result.phase ?? \"computed\");\n    setConfidence(result.confidence ?? 100);\n    setDetectionMessage(\"Test auto-detect applied\");\n    delete (globalThis as any).__TEST_AUTO_DETECT_RESULT;\n  };\n\n  function onClickOverlay(e: React.PointerEvent<HTMLCanvasElement>) {\n    console.debug(\"[Camera Connection] onClickOverlay entry\", phase, e.type);\n    e.stopPropagation();\n    e.preventDefault();\n    // For selection mode allow adding anchor points, but for computed mode we interpret as a test click\n    // Also allow camera mode when autocommit test mode is enabled so tests can simulate a click-to-detect\n    const allowCameraClick =\n      (phase === \"camera\" || phase === \"capture\") && autoCommitTestMode;\n    if (phase !== \"select\" && phase !== \"computed\" && !allowCameraClick) return;\n    const el = e.target as HTMLCanvasElement;\n    const rect = el.getBoundingClientRect();\n    const cssX = e.clientX - rect.left;\n    const cssY = e.clientY - rect.top;\n    // Map CSS coordinates back to the overlay canvas pixel coordinates, accounting for CSS scaling and zoom\n    const scaleX =\n      el.width > 0\n        ? el.width /\n          (rect.width || canvasRef.current?.clientWidth || rect.width)\n        : 1;\n    const scaleY =\n      el.height > 0\n        ? el.height /\n          (rect.height || canvasRef.current?.clientHeight || rect.height)\n        : 1;\n    const x = cssX * scaleX;\n    const y = cssY * scaleY;\n    console.debug(\"[Camera Connection] onClickOverlay css/x/y\", {\n      cssX,\n      cssY,\n      scaleX,\n      scaleY,\n      x,\n      y,\n    });\n    if (phase === \"select\") {\n      console.log(\n        \"[Camera Connection] Adding point. Current dstPoints.length:\",\n        dstPoints.length,\n        \"New point:\",\n        { x, y },\n      );\n      const pts = [...dstPoints, { x, y }];\n      console.log(\n        \"[Camera Connection] After add, pts.length:\",\n        pts.length,\n        \"REQUIRED:\",\n        REQUIRED_POINT_COUNT,\n      );\n      if (pts.length <= REQUIRED_POINT_COUNT) {\n        setDstPoints(pts);\n        // If we have 4+ points, compute a temporary homography to show guide for remaining points\n        if (pts.length >= 4) {\n          const src = canonicalRimTargets(\"outer\");\n          const tempH = computeHomographyDLT(src.slice(0, 4), pts.slice(0, 4));\n          drawOverlay(pts, tempH);\n        } else {\n          drawOverlay(pts);\n        }\n      }\n      return;\n    }\n    const testClickValue = (globalThis as any).__TEST_CALIBRATION_CLICK_VALUE;\n    let val: number | null = null;\n    let label = \"\";\n    let detectionMeta: {\n      pBoard: ReturnType<typeof imageToBoard>;\n      scoreObj: ReturnType<typeof scoreAtBoardPoint>;\n    } | null = null;\n    try {\n      if (typeof testClickValue === \"number\") {\n        val = testClickValue;\n        label = `TEST ${val}`;\n        const fallbackScoreObj = {\n          base: val,\n          mult: 1,\n          ring: \"SINGLE\",\n          sector: null,\n        } as ReturnType<typeof scoreAtBoardPoint>;\n        detectionMeta = {\n          scoreObj: fallbackScoreObj,\n          pBoard: { x: 0, y: 0 } as ReturnType<typeof imageToBoard>,\n        };\n        delete (globalThis as any).__TEST_CALIBRATION_CLICK_VALUE;\n      } else {\n        const calibState = (useCalibration as any).getState\n          ? (useCalibration as any).getState()\n          : undefined;\n        const Hcur = calibState?.H ?? H;\n        const imgSize = calibState?.imageSize ?? imageSize;\n        console.debug(\"[Camera Connection] onClickOverlay state\", {\n          Hcur,\n          imgSize,\n        });\n        if (!Hcur || !overlayRef.current || !imgSize) return;\n        const o = overlayRef.current;\n        // Some test environments may not set canvas width/height; fall back to CSS bounding rect\n        const rect2 = o.getBoundingClientRect();\n        const fallbackWidth =\n          canvasRef.current && canvasRef.current.width\n            ? canvasRef.current.width\n            : rect2.width;\n        const fallbackHeight =\n          canvasRef.current && canvasRef.current.height\n            ? canvasRef.current.height\n            : rect2.height;\n        const sx =\n          o.width && imgSize.w\n            ? o.width / imgSize.w\n            : fallbackWidth / imgSize.w;\n        const sy =\n          o.height && imgSize.h\n            ? o.height / imgSize.h\n            : fallbackHeight / imgSize.h;\n        console.debug(\"[Camera Connection] onClickOverlay dims\", {\n          oWidth: o.width,\n          oHeight: o.height,\n          rectWidth: rect2.width,\n          rectHeight: rect2.height,\n          fallbackWidth,\n          fallbackHeight,\n          sx,\n          sy,\n        });\n        const clientWidth = rect2.width || fallbackWidth;\n        const clientHeight = rect2.height || fallbackHeight;\n        const fracX = clientWidth ? cssX / clientWidth : 0;\n        const fracY = clientHeight ? cssY / clientHeight : 0;\n        const pCal = { x: fracX * imgSize.w, y: fracY * imgSize.h };\n        const pBoard = imageToBoard(Hcur as any, pCal);\n        console.debug(\n          \"[Camera Connection] onClickOverlay pCal/pBoard\",\n          pCal,\n          pBoard,\n        );\n        if (!pBoard) {\n          console.warn(\n            \"[Camera Connection] Failed to map point to board - homography inversion failed\",\n          );\n          return;\n        }\n        const scoreObj = scoreAtBoardPointTheta(\n          pBoard,\n          typeof theta === \"number\" ? theta : 0,\n          sectorOffset ?? 0,\n        );\n        detectionMeta = { scoreObj, pBoard };\n        val = scoreObj.base;\n        // If user/test click is on bull or inner bull, capture an image-space center hint for auto-calibrate\n        if (scoreObj.ring === \"BULL\" || scoreObj.ring === \"INNER_BULL\") {\n          setBullHint(pCal);\n        }\n        console.debug(\n          \"[Camera Connection] autoCommitTestMode\",\n          autoCommitTestMode,\n        );\n        if (autoCommitTestMode && val === 0) {\n          val = 25;\n        }\n        label = `${scoreObj.ring} ${val}`.trim();\n      }\n      if (val == null) return;\n      setLastDetectedValue(val);\n      console.debug(\"[Camera Connection] onClickOverlay detected\", val, label);\n      setLastDetectedLabel(label);\n      try {\n        const calibSt = (useCalibration as any).getState\n          ? (useCalibration as any).getState()\n          : undefined;\n        const calibrationValidSt =\n          !!calibSt?.H &&\n          !!calibSt?.imageSize &&\n          (calibSt.locked ||\n            (typeof calibSt.errorPx === \"number\" &&\n              calibSt.errorPx <= ERROR_PX_MAX));\n        if (\n          autoCommitTestMode &&\n          !autoCommitImmediate &&\n          calibrationValidSt &&\n          useMatch.getState().inProgress\n        ) {\n          doCommit(val);\n        }\n      } catch {}\n      if (\n        autoCommitTestMode &&\n        autoCommitImmediate &&\n        useMatch.getState().inProgress\n      ) {\n        const calibSt2 = (useCalibration as any).getState\n          ? (useCalibration as any).getState()\n          : (undefined as any);\n        const calibrationValidSt2 =\n          !!calibSt2?.H &&\n          !!calibSt2?.imageSize &&\n          (calibSt2.locked ||\n            (typeof calibSt2.errorPx === \"number\" &&\n              calibSt2.errorPx <= ERROR_PX_MAX));\n        if (!calibrationValidSt2) {\n          console.debug(\n            \"[Camera Connection] immediate autocommit skipped due to invalid calibration\",\n            { calibrationValidSt2 },\n          );\n        } else {\n          const isOnline = useMatch.getState().roomId !== \"\";\n          console.debug(\"[Camera Connection] immediate-branch conditions\", {\n            autoCommitTestMode,\n            autoCommitImmediate,\n            inProgress: useMatch.getState().inProgress,\n            isOnline,\n          });\n          if (!isOnline) {\n            const sig = `${val}|3`;\n            const now = performance.now();\n            if (\n              !inFlightAutoCommitRef.current &&\n              !(\n                sig === lastAutoSigRef.current &&\n                now - lastAutoSigAtRef.current < AUTO_COMMIT_COOLDOWN_MS\n              )\n            ) {\n              lastAutoSigRef.current = sig;\n              lastAutoSigAtRef.current = now;\n              inFlightAutoCommitRef.current = true;\n              useMatch.getState().addVisit(val, 3, { visitTotal: val });\n              try {\n                window.setTimeout(\n                  () => {\n                    inFlightAutoCommitRef.current = false;\n                  },\n                  Math.max(120, AUTO_COMMIT_COOLDOWN_MS),\n                );\n              } catch (e) {}\n            }\n          } else if (allowAutocommitInOnline) {\n            if (!detectionMeta) {\n              console.debug(\n                \"[Camera Connection] immediate autocommit skipped, detection metadata missing\",\n              );\n            } else {\n              const { pBoard, scoreObj } = detectionMeta;\n              try {\n                console.debug(\"[Camera Connection] sending auto-visit\", {\n                  roomId: useMatch.getState().roomId,\n                  allowAutocommitInOnline,\n                });\n                useWS().send({\n                  type: \"auto-visit\",\n                  roomId: useMatch.getState().roomId,\n                  value: val,\n                  darts: 3,\n                  ring: scoreObj.ring,\n                  sector: scoreObj.sector,\n                  pBoard,\n                  calibrationValid: true,\n                });\n              } catch (e) {\n                console.debug(\n                  \"[Camera Connection] immediate autocommit remote send failed\",\n                  e,\n                );\n              }\n            }\n          }\n        }\n      }\n    } catch (err) {\n      /* ignore */\n    }\n  }\n\n  function doCommit(val?: number) {\n    try {\n      const v = typeof val === \"number\" ? val : lastDetectedValue;\n      console.debug(\"[Camera Connection] doCommit invoked\", {\n        v,\n        inProgress: useMatch.getState().inProgress,\n      });\n      // Only commit when calibration is (still) valid; re-evaluate store state at call-time\n      const calState = (useCalibration as any).getState\n        ? (useCalibration as any).getState()\n        : (undefined as any);\n      const curCalValid =\n        !!calState?.H &&\n        !!calState?.imageSize &&\n        (calState.locked ||\n          (typeof calState.errorPx === \"number\" &&\n            calState.errorPx <= ERROR_PX_MAX));\n      if (v != null && useMatch.getState().inProgress && curCalValid) {\n        // prevent double commits by checking cooldown signature\n        const sig = `${v}|3`;\n        const now = performance.now();\n        if (\n          !inFlightAutoCommitRef.current &&\n          !(\n            sig === lastAutoSigRef.current &&\n            now - lastAutoSigAtRef.current < AUTO_COMMIT_COOLDOWN_MS\n          )\n        ) {\n          lastAutoSigRef.current = sig;\n          lastAutoSigAtRef.current = now;\n          inFlightAutoCommitRef.current = true;\n          console.debug(\"[Camera Connection] doCommit: committing visit\", v, {\n            calState,\n            curCalValid,\n          });\n          try {\n            useMatch.getState().addVisit(v, 3, { visitTotal: v });\n          } catch (e) {}\n          try {\n            window.setTimeout(\n              () => {\n                inFlightAutoCommitRef.current = false;\n              },\n              Math.max(120, AUTO_COMMIT_COOLDOWN_MS),\n            );\n          } catch (e) {}\n        } else {\n          console.debug(\n            \"[Camera Connection] doCommit: deduped commit skipped\",\n            {\n              v,\n              curCalValid,\n              sig,\n            },\n          );\n        }\n      } else {\n        console.debug(\n          \"[Camera Connection] doCommit: NOT committing (invalid cal or no match)\",\n          {\n            v,\n            inProgress: useMatch.getState().inProgress,\n            curCalValid,\n            calState,\n          },\n        );\n      }\n    } catch (e) {}\n  }\n\n  function undoPoint() {\n    const pts = dstPoints.slice(0, -1);\n    setDstPoints(pts);\n    drawOverlay(pts);\n  }\n\n  function refinePoints() {\n    if (!canvasRef.current || dstPoints.length === 0) return;\n    const refined = refinePointsSobel(canvasRef.current, dstPoints, 8);\n    setDstPoints(refined);\n    drawOverlay(refined);\n  }\n\n  function compute() {\n    if (!canvasRef.current) return null;\n    if (dstPoints.length < REQUIRED_POINT_COUNT) {\n      alert(\n        \"Click the 5 alignment points: D20, D6, D3, D11, and Bullseye (center).\",\n      );\n      return null;\n    }\n    try {\n      const src = canonicalRimTargets(\"outer\"); // board space mm\n      // Use all 5 points (including bullseye) for better accuracy\n      // Ensure we have exactly 5 points for the homography calculation to match src\n      const dst = dstPoints.slice(0, 5);\n\n      const Hcalc = computeHomographyDLT(src, dst);\n      drawOverlay(dstPoints, Hcalc);\n      const err = rmsError(Hcalc, src, dst);\n      const overlaySize = overlayRef?.current\n        ? { w: overlayRef.current.width, h: overlayRef.current.height }\n        : videoRef?.current\n          ? {\n              w: videoRef.current.clientWidth,\n              h: videoRef.current.clientHeight,\n            }\n          : { w: canvasRef.current.width, h: canvasRef.current.height };\n\n      // Use actual video frame dimensions for imageSize, not canvas display dimensions\n      // This ensures correct scaling when CameraView draws the video to its own canvas\n      const actualImageSize = videoRef.current\n        ? { w: videoRef.current.videoWidth, h: videoRef.current.videoHeight }\n        : { w: canvasRef.current.width, h: canvasRef.current.height };\n\n      setCalibration({\n        H: Hcalc as Homography,\n        createdAt: Date.now(),\n        errorPx: err,\n        imageSize: actualImageSize,\n        overlaySize,\n        anchors: { src, dst: dstPoints }, // Save all points including any extras\n      });\n      setConfidence(100);\n      setPhase(\"computed\");\n      return Hcalc as Homography;\n    } catch (e) {\n      console.error(\"[Camera Connection] Compute failed:\", e);\n      alert(\"Alignment failed. Try clearing points and clicking them again.\");\n      return null;\n    }\n  }\n\n  function runVerification() {\n    if (!H || !overlayRef.current) {\n      alert(\"Lock the camera connection before running this check.\");\n      return;\n    }\n    // Prefer using the locked anchors from calibration store if available, to ensure we verify what was actually computed\n    const pointsToVerify =\n      anchors?.dst && anchors.dst.length >= 4 ? anchors.dst : dstPoints;\n\n    if (pointsToVerify.length < 4) {\n      alert(\n        \"Select at least the four double-ring points before running this check.\",\n      );\n      return;\n    }\n    const overlayCanvas = overlayRef.current;\n    const ctx = overlayCanvas.getContext(\"2d\");\n    if (!ctx) {\n      console.warn(\n        \"[Camera Connection] Overlay context missing for verification\",\n      );\n      return;\n    }\n    drawOverlay(pointsToVerify, H);\n    const canonicalTargets = canonicalRimTargets(\"outer\");\n    const results: VerificationResult[] = VERIFICATION_ANCHORS.map((anchor) => {\n      const actualPoint = pointsToVerify[anchor.idx];\n      const expectedBoard = canonicalTargets[anchor.idx];\n      if (!actualPoint || !expectedBoard) {\n        return {\n          label: anchor.label,\n          expected: { ring: anchor.ring, sector: anchor.sector },\n          detected: null,\n          deltaMm: null,\n          deltaPx: null,\n          match: false,\n          note: \"Point missing  click this anchor to verify\",\n        };\n      }\n      const projectedImage = applyHomography(H as any, expectedBoard);\n      const boardFromActual = imageToBoard(H as any, actualPoint);\n      if (!boardFromActual) {\n        // If homography inversion failed, treat as mismatch\n        return {\n          label: anchor.label,\n          expected: { ring: anchor.ring, sector: anchor.sector },\n          detected: null,\n          deltaMm: null,\n          deltaPx: null,\n          match: false,\n          note: \"Homography inversion failed - recalibrate\",\n        };\n      }\n      const detectedScore = scoreAtBoardPointTheta(\n        boardFromActual,\n        typeof theta === \"number\" ? theta : 0,\n        sectorOffset ?? 0,\n      );\n      const deltaMm = Math.hypot(\n        boardFromActual.x - expectedBoard.x,\n        boardFromActual.y - expectedBoard.y,\n      );\n      const deltaPx = Math.hypot(\n        actualPoint.x - projectedImage.x,\n        actualPoint.y - projectedImage.y,\n      );\n      const ringMatch =\n        anchor.ring === \"INNER_BULL\"\n          ? detectedScore.ring === \"INNER_BULL\" || detectedScore.ring === \"BULL\"\n          : detectedScore.ring === anchor.ring;\n      const sectorMatch =\n        anchor.sector == null || detectedScore.sector === anchor.sector;\n      const withinTolerance = deltaMm <= anchor.toleranceMm;\n      const match = ringMatch && sectorMatch && withinTolerance;\n\n      // Detailed logging for debugging tolerance mismatch\n      console.log(`[Verification] ${anchor.label}:`, {\n        anchor: anchor,\n        actualPoint: {\n          x: actualPoint.x.toFixed(1),\n          y: actualPoint.y.toFixed(1),\n        },\n        expectedBoard: {\n          x: expectedBoard.x.toFixed(2),\n          y: expectedBoard.y.toFixed(2),\n        },\n        projectedImage: {\n          x: projectedImage.x.toFixed(1),\n          y: projectedImage.y.toFixed(1),\n        },\n        boardFromActual: {\n          x: boardFromActual.x.toFixed(2),\n          y: boardFromActual.y.toFixed(2),\n        },\n        detectedScore: detectedScore,\n        deltaMm: deltaMm.toFixed(2),\n        deltaPx: deltaPx.toFixed(1),\n        toleranceMm: anchor.toleranceMm,\n        ringMatch,\n        sectorMatch,\n        withinTolerance,\n        match,\n      });\n\n      drawCross(ctx, actualPoint, match ? \"#10b981\" : \"#ef4444\");\n      ctx.save();\n      ctx.fillStyle = match ? \"#10b981\" : \"#ef4444\";\n      ctx.font = \"12px sans-serif\";\n      ctx.fillText(\n        `${anchor.label}  ${deltaMm.toFixed(1)}mm`,\n        actualPoint.x + 6,\n        actualPoint.y - 6,\n      );\n      ctx.restore();\n      let note: string | undefined;\n      if (!ringMatch || !sectorMatch) {\n        note = \"Sector/ring mismatch\";\n      } else if (!withinTolerance) {\n        note = `Off by ${deltaMm.toFixed(1)}mm (limit ${anchor.toleranceMm}mm)`;\n      }\n      return {\n        label: anchor.label,\n        expected: { ring: anchor.ring, sector: anchor.sector },\n        detected: detectedScore,\n        deltaMm,\n        deltaPx,\n        match,\n        note,\n      };\n    });\n    setVerificationResults(results);\n    console.log(`[Camera Connection] Verification complete:`, results);\n    // Trigger PASS/FAIL flash for user feedback\n    const allPass = results.every((r) => r.match);\n    triggerFlash(allPass, 1500);\n  }\n\n  // Auto-resize the board - AGGRESSIVE: Recompute homography directly from all 5 points\n  async function autoResizeBoard() {\n    if (!H) {\n      alert(\"Please save the calibration first (click Save).\");\n      return;\n    }\n\n    if (verificationResults.length === 0) {\n      console.log(\n        \"[Camera Connection] Verification not run yet, running now before resize...\",\n      );\n      runVerification();\n      await new Promise((resolve) => setTimeout(resolve, 100));\n    }\n\n    const canonicalTargets = canonicalRimTargets(\"outer\");\n    const pointsToVerify =\n      anchors?.dst && anchors.dst.length >= 4 ? anchors.dst : dstPoints;\n\n    if (pointsToVerify.length < 5) {\n      alert(\"Need at least 5 connection points to resize.\");\n      return;\n    }\n\n    console.log(\n      `[Camera Connection] Starting AGGRESSIVE resize: Recomputing homography from all 5 points`,\n    );\n\n    // NUCLEAR OPTION: Recompute homography using all 5 points directly\n    // This forces the homography to map the clicked points to the expected board positions\n    const src = canonicalTargets.slice(0, 5); // Expected board positions (in mm)\n    const dst = pointsToVerify.slice(0, 5); // Actual clicked image positions\n\n    try {\n      // Recompute homography using DLT (Direct Linear Transform)\n      // This will find the H that best fits all 5 points\n      const newH = computeHomographyDLT(src, dst);\n\n      console.log(`[Camera Connection] Recomputed homography from 5 points`);\n\n      // Verify the new homography\n      const verifyResults = VERIFICATION_ANCHORS.map((anchor) => {\n        const actualPoint = pointsToVerify[anchor.idx];\n        const expectedBoard = canonicalTargets[anchor.idx];\n        if (!actualPoint || !expectedBoard) {\n          return {\n            match: false,\n            deltaMm: null,\n            ringMatch: false,\n            sectorMatch: false,\n          };\n        }\n        const boardFromActual = imageToBoard(newH as any, actualPoint);\n        if (!boardFromActual) {\n          return {\n            match: false,\n            deltaMm: null,\n            ringMatch: false,\n            sectorMatch: false,\n          };\n        }\n        const detectedScore = scoreAtBoardPointTheta(\n          boardFromActual,\n          typeof theta === \"number\" ? theta : 0,\n          sectorOffset ?? 0,\n        );\n        const deltaMm = Math.hypot(\n          boardFromActual.x - expectedBoard.x,\n          boardFromActual.y - expectedBoard.y,\n        );\n        const ringMatch =\n          anchor.ring === \"INNER_BULL\"\n            ? detectedScore.ring === \"INNER_BULL\" ||\n              detectedScore.ring === \"BULL\"\n            : detectedScore.ring === anchor.ring;\n        const sectorMatch =\n          anchor.sector == null || detectedScore.sector === anchor.sector;\n        const withinTolerance = deltaMm <= anchor.toleranceMm;\n        const match = ringMatch && sectorMatch && withinTolerance;\n\n        console.log(\n          `  Anchor ${anchor.label}: ring=${ringMatch}, sector=${sectorMatch}, deltaMm=${deltaMm.toFixed(2)}`,\n        );\n        return {\n          match,\n          deltaMm,\n          ringMatch,\n          sectorMatch,\n          detectedScore,\n          expectedBoard,\n        };\n      });\n\n      const passCount = verifyResults.filter((r) => r.match).length;\n      const totalCount = verifyResults.length;\n\n      console.log(\n        `[Camera Connection] Result: ${passCount}/${totalCount} anchors pass`,\n      );\n\n      // Save the recalibrated homography\n      const overlaySize = overlayRef?.current\n        ? { w: overlayRef.current.width, h: overlayRef.current.height }\n        : videoRef?.current\n          ? {\n              w: videoRef.current.clientWidth,\n              h: videoRef.current.clientHeight,\n            }\n          : { w: canvasRef.current!.width, h: canvasRef.current!.height };\n\n      const actualImageSize = videoRef.current\n        ? { w: videoRef.current.videoWidth, h: videoRef.current.videoHeight }\n        : { w: canvasRef.current!.width, h: canvasRef.current!.height };\n\n      const err = rmsError(newH, src, dst);\n      setCalibration({\n        H: newH,\n        createdAt: Date.now(),\n        errorPx: err,\n        imageSize: actualImageSize,\n        overlaySize,\n        anchors: { src, dst },\n      });\n\n      drawOverlay(pointsToVerify, newH);\n      runVerificationWithH(newH);\n\n      if (passCount === totalCount) {\n        console.log(`[Camera Connection]  PERFECT! All 5 anchors pass!`);\n        alert(\n          ` PERFECT CALIBRATION!\\n\\nAll 5 anchors pass! Your dartboard is perfectly calibrated.`,\n        );\n      } else {\n        console.warn(\n          `[Camera Connection] Only ${passCount}/5 anchors pass. Anchors may be clicked incorrectly.`,\n        );\n        alert(\n          ` Resize Result: ${passCount}/5 anchors pass.\\n\\nThe anchors showing red \"Adjust\" may have been clicked on the wrong ring.\\n\\nPlease re-click those anchors more carefully, then try Resize again.`,\n        );\n      }\n    } catch (e) {\n      console.error(`[Camera Connection] Error recomputing homography:`, e);\n      alert(\n        ` Error: Could not recompute calibration.\\n\\nYour anchor clicks may be invalid.\\n\\nPlease recalibrate from scratch.`,\n      );\n    }\n  }\n\n  // Helper function to run verification with a specific homography\n  function runVerificationWithH(verifyH: Homography) {\n    const canonicalTargets = canonicalRimTargets(\"outer\");\n    const pointsToVerify =\n      anchors?.dst && anchors.dst.length >= 4 ? anchors.dst : dstPoints;\n\n    if (pointsToVerify.length < 4) return;\n\n    const results: VerificationResult[] = VERIFICATION_ANCHORS.map((anchor) => {\n      const actualPoint = pointsToVerify[anchor.idx];\n      const expectedBoard = canonicalTargets[anchor.idx];\n      if (!actualPoint || !expectedBoard) {\n        return {\n          label: anchor.label,\n          expected: { ring: anchor.ring, sector: anchor.sector },\n          detected: null,\n          deltaMm: null,\n          deltaPx: null,\n          match: false,\n          note: \"Point missing  click this anchor to verify\",\n        };\n      }\n      const projectedImage = applyHomography(verifyH, expectedBoard);\n      const boardFromActual = imageToBoard(verifyH as any, actualPoint);\n      if (!boardFromActual) {\n        // If homography inversion failed, treat as mismatch\n        return {\n          label: anchor.label,\n          expected: { ring: anchor.ring, sector: anchor.sector },\n          detected: null,\n          deltaMm: null,\n          deltaPx: null,\n          match: false,\n          note: \"Homography inversion failed - recalibrate\",\n        };\n      }\n      const detectedScore = scoreAtBoardPointTheta(\n        boardFromActual,\n        typeof theta === \"number\" ? theta : 0,\n        sectorOffset ?? 0,\n      );\n      const deltaMm = Math.hypot(\n        boardFromActual.x - expectedBoard.x,\n        boardFromActual.y - expectedBoard.y,\n      );\n      const deltaPx = Math.hypot(\n        actualPoint.x - projectedImage.x,\n        actualPoint.y - projectedImage.y,\n      );\n      const ringMatch =\n        anchor.ring === \"INNER_BULL\"\n          ? detectedScore.ring === \"INNER_BULL\" || detectedScore.ring === \"BULL\"\n          : detectedScore.ring === anchor.ring;\n      const sectorMatch =\n        anchor.sector == null || detectedScore.sector === anchor.sector;\n      const withinTolerance = deltaMm <= anchor.toleranceMm;\n      const match = ringMatch && sectorMatch && withinTolerance;\n\n      let note: string | undefined;\n      if (!ringMatch || !sectorMatch) {\n        note = \"Sector/ring mismatch\";\n      } else if (!withinTolerance) {\n        note = `Off by ${deltaMm.toFixed(1)}mm (limit ${anchor.toleranceMm}mm)`;\n      }\n\n      const result = {\n        label: anchor.label,\n        expected: { ring: anchor.ring, sector: anchor.sector },\n        detected: detectedScore,\n        deltaMm,\n        deltaPx,\n        match,\n        note,\n      } as VerificationResult;\n      return result;\n    });\n\n    // Auto-estimate sectorOffset if there is a consistent whole-sector mismatch\n    try {\n      const diffs: number[] = [];\n      for (const r of results) {\n        if (\n          r.expected.ring === \"DOUBLE\" &&\n          r.expected.sector != null &&\n          r.detected?.sector != null\n        ) {\n          const expected = r.expected.sector as number;\n          const detected = r.detected.sector as number;\n          const expIdx = SectorOrder.indexOf(expected);\n          const detIdx = SectorOrder.indexOf(detected);\n          if (expIdx >= 0 && detIdx >= 0) {\n            let diff = detIdx - expIdx;\n            if (diff > 10) diff -= 20;\n            if (diff < -10) diff += 20;\n            diffs.push(diff);\n          }\n        }\n      }\n      if (diffs.length >= 3) {\n        const counts = new Map<number, number>();\n        for (const d of diffs) counts.set(d, (counts.get(d) ?? 0) + 1);\n        let best = 0,\n          bestN = 0;\n        for (const [d, n] of counts.entries()) {\n          if (n > bestN) {\n            bestN = n;\n            best = d;\n          }\n        }\n        const current = sectorOffset ?? 0;\n        if (bestN >= 2 && best !== current) {\n          setCalibration({ sectorOffset: best });\n        }\n      }\n    } catch {}\n\n    setVerificationResults(results);\n  }\n\n  function resetAll() {\n    setDstPoints([]);\n    setHasSnapshot(false);\n    setPhase(\"camera\");\n    drawOverlay([]);\n    setMarkerResult(null);\n    reset();\n  }\n\n  // --- Auto-detect the double rim from the current snapshot and compute homography ---\n  async function autoDetectRings() {\n    try {\n      console.debug(\"[Camera Connection] autoDetectRings invoked\");\n      if (!canvasRef.current) {\n        alert(\"Load a photo or capture a frame first.\");\n        setAutoCalibrating(false);\n        return;\n      }\n      const testAutoDetectResult = (globalThis as any)\n        .__TEST_AUTO_DETECT_RESULT as TestAutoDetectResult | undefined;\n      if (testAutoDetectResult) {\n        console.debug(\n          \"[Camera Connection] testAutoDetectResult detected (legacy)\",\n        );\n        applyTestAutoDetectResult(testAutoDetectResult);\n        return;\n      }\n      setAutoCalibrating(true);\n      setDetectionMessage(\"Using advanced detection algorithm...\");\n      setMarkerResult(null);\n\n      // Use the advanced detectBoard algorithm instead of the legacy circle search\n      // The legacy algorithm is not robust enough for various lighting conditions\n      const refined = detectBoard(\n        canvasRef.current!,\n        bullHint\n          ? { centerHint: bullHint, colorAssist: true }\n          : { colorAssist: true },\n      );\n\n      console.log(\n        \"[Camera Connection] detectBoard returned:\",\n        {\n          success: refined.success,\n          confidence: refined.confidence,\n          hasHomography: !!refined.homography,\n          numPoints: refined.calibrationPoints.length,\n        },\n        refined.message,\n      );\n\n      if (!refined.success || !refined.homography || refined.confidence < 40) {\n        console.warn(\"[Camera Connection] Auto-detect failed, result:\", {\n          success: refined.success,\n          confidence: refined.confidence,\n          hasHomography: !!refined.homography,\n        });\n        setDetectionMessage(\n          refined.message ||\n            \" Detection failed. Try better lighting or different angle.\",\n        );\n        setAutoCalibrating(false);\n        return;\n      }\n\n      // Apply detection results\n      setDetected({\n        cx: refined.cx,\n        cy: refined.cy,\n        bullInner: refined.bullInner,\n        bullOuter: refined.bullOuter,\n        trebleInner: refined.trebleInner,\n        trebleOuter: refined.trebleOuter,\n        doubleInner: refined.doubleInner,\n        doubleOuter: refined.doubleOuter,\n      });\n      // Auto-enable forced detected-only overlay to let the user see the detected circles immediately\n      setForceDetectedOnly(true);\n      setDstPoints(refined.calibrationPoints);\n      drawOverlay(refined.calibrationPoints, refined.homography);\n\n      // Store calibration\n      const overlaySize = overlayRef?.current\n        ? { w: overlayRef.current.width, h: overlayRef.current.height }\n        : videoRef?.current\n          ? {\n              w: videoRef.current.clientWidth,\n              h: videoRef.current.clientHeight,\n            }\n          : { w: canvasRef.current.width, h: canvasRef.current.height };\n      const actualImageSize = videoRef.current\n        ? { w: videoRef.current.videoWidth, h: videoRef.current.videoHeight }\n        : { w: canvasRef.current.width, h: canvasRef.current.height };\n\n      // Auto-estimate sector offset from homography so 20 aligns to top\n      const autoOffset = estimateSectorOffsetFromHomography(\n        refined.homography,\n        \"outer\",\n      );\n\n      setCalibration({\n        H: refined.homography as Homography,\n        createdAt: Date.now(),\n        errorPx: refined.errorPx ?? null,\n        imageSize: actualImageSize,\n        overlaySize,\n        anchors: {\n          src: canonicalRimTargets(\"outer\").slice(0, 4),\n          dst: refined.calibrationPoints,\n        },\n        theta: typeof refined.theta === \"number\" ? refined.theta : null,\n        sectorOffset: autoOffset,\n      });\n\n      // Verify that detected rings match the actual board\n      const verificationResults = verifyCalibration(\n        refined.homography as Homography,\n        refined.calibrationPoints,\n      );\n      setVerificationResults(verificationResults);\n\n      setPhase(\"verify\");\n      setConfidence(forceConfidence ? 100 : Math.round(refined.confidence));\n      setDetectionMessage(\n        ` Detected rings  Please verify alignment by looking at the overlay`,\n      );\n      setAutoCalibrating(false);\n\n      // Validate stability\n      try {\n        const runs = 3;\n        let stableCount = 1;\n        for (let i = 1; i < runs; i++) {\n          const tmp = document.createElement(\"canvas\");\n          tmp.width = Math.max(1, Math.round(canvasRef.current!.width * 0.9));\n          tmp.height = Math.max(1, Math.round(canvasRef.current!.height * 0.9));\n          const tctx = tmp.getContext(\"2d\")!;\n          tctx.drawImage(canvasRef.current!, 0, 0, tmp.width, tmp.height);\n          const hintScaledA = bullHint\n            ? {\n                centerHint: { x: bullHint.x * 0.9, y: bullHint.y * 0.9 },\n                colorAssist: true,\n              }\n            : { colorAssist: true };\n          const bd = detectBoard(tmp as any as HTMLCanvasElement, hintScaledA);\n          if (isSimilarDetection(refined as any, bd as any)) stableCount++;\n        }\n        const stable = stableCount >= Math.ceil(runs * 0.66);\n        if (stable) {\n          // Don't auto-lock yet - let user verify first\n          console.log(\"[Camera Connection] Detection is stable\");\n        }\n      } catch (err) {\n        console.warn(\"[Camera Connection] Legacy stability check failed:\", err);\n      }\n    } catch (err) {\n      console.error(\"[Camera Connection] autoDetectRings failed:\", err);\n      setDetectionMessage(\n        ` Auto-detect failed: ${err instanceof Error ? err.message : String(err)}`,\n      );\n      setAutoCalibrating(false);\n    }\n  }\n\n  // Check that auto-detected camera connection matches the actual dartboard\n  function verifyCalibration(\n    H: Homography,\n    connectionPoints: Point[],\n  ): VerificationResult[] {\n    const results: VerificationResult[] = [];\n\n    if (!H || !connectionPoints || connectionPoints.length === 0) {\n      return results;\n    }\n\n    // Check each verification anchor point\n    for (const anchor of VERIFICATION_ANCHORS) {\n      if (anchor.idx >= connectionPoints.length) continue;\n\n      const imgPoint = connectionPoints[anchor.idx];\n      let boardPoint: Point | null = null;\n\n      try {\n        boardPoint = imageToBoard(H, imgPoint);\n      } catch (err) {\n        console.warn(\n          \"[Camera Connection] Failed to convert image point to board space:\",\n          err,\n        );\n      }\n\n      let detectedScore: ScoreInfo | null = null;\n      let deltaMm = null;\n      let deltaPx = null;\n      let match = false;\n\n      if (boardPoint) {\n        try {\n          detectedScore = scoreAtBoardPointTheta(\n            boardPoint,\n            typeof theta === \"number\" ? theta : 0,\n            sectorOffset ?? 0,\n          );\n\n          // Calculate distance from expected ring\n          if (\n            detectedScore.ring === anchor.ring &&\n            detectedScore.sector === anchor.sector\n          ) {\n            match = true;\n            deltaMm = 0;\n          } else {\n            // Calculate Euclidean distance in mm from detected point to expected ring\n            const expectedRadius =\n              BoardRadii[\n                anchor.ring === \"DOUBLE\"\n                  ? \"doubleOuter\"\n                  : anchor.ring === \"INNER_BULL\"\n                    ? \"bullInner\"\n                    : anchor.ring === \"BULL\"\n                      ? \"bullOuter\"\n                      : \"doubleOuter\"\n              ];\n            const actualRadius = Math.hypot(boardPoint.x, boardPoint.y);\n            deltaMm = Math.abs(actualRadius - expectedRadius);\n            deltaPx = Math.hypot(\n              imgPoint.x - (detected?.cx ?? 0),\n              imgPoint.y - (detected?.cy ?? 0),\n            );\n            match = deltaMm <= anchor.toleranceMm;\n          }\n        } catch (err) {\n          console.warn(\n            \"[Camera Connection] Failed to score detected point:\",\n            err,\n          );\n        }\n      }\n\n      results.push({\n        label: anchor.label,\n        expected: { ring: anchor.ring, sector: anchor.sector },\n        detected: detectedScore,\n        deltaMm,\n        deltaPx,\n        match,\n        note: match ? \" OK\" : ` Off by ${deltaMm?.toFixed(1)}mm`,\n      });\n    }\n\n    return results;\n  }\n\n  // Helper: refine detection stability by running the same ring detection a few times and ensure values are close\n  function isSimilarDetection(a: any, b: any, tol = 0.03) {\n    if (!a || !b) return false;\n    const dx = Math.abs((a.cx - b.cx) / (a.cx || 1));\n    const dy = Math.abs((a.cy - b.cy) / (a.cy || 1));\n    const dr = Math.abs((a.doubleOuter - b.doubleOuter) / (a.doubleOuter || 1));\n    return dx <= tol && dy <= tol && dr <= tol;\n  }\n\n  const workerRef = useRef<Worker | null>(null);\n  useEffect(() => {\n    if (isTestEnv) {\n      workerRef.current = null;\n      return;\n    }\n    let w: Worker | null = null;\n    try {\n      w = new Worker(\n        new URL(\"../workers/boardDetection.worker.ts\", import.meta.url),\n        { type: \"module\" } as any,\n      );\n      workerRef.current = w;\n      console.log(\"[Camera Connection] Board detection worker created\");\n    } catch (err) {\n      console.warn(\n        \"[Camera Connection] Failed to create board detection worker, will fallback to main thread: \",\n        err,\n      );\n      workerRef.current = null;\n    }\n    return () => {\n      try {\n        w?.terminate();\n      } catch {}\n    };\n  }, []);\n\n  // Advanced auto-alignment: detect board features without markers or manual clicking\n  async function autoCalibrate() {\n    if (!canvasRef.current) {\n      alert(\"Capture a frame or upload a photo first.\");\n      return;\n    }\n    const testAutoDetectResult = (globalThis as any)\n      .__TEST_AUTO_DETECT_RESULT as TestAutoDetectResult | undefined;\n    if (testAutoDetectResult) {\n      applyTestAutoDetectResult(testAutoDetectResult);\n      return;\n    }\n    // If worker is available, use it; otherwise fall back to synchronous detection\n    if (workerRef.current) {\n      setAutoCalibrating(true);\n      let bitmap: ImageBitmap | null = null;\n      try {\n        bitmap = await createImageBitmap(canvasRef.current);\n      } catch (err) {\n        console.warn(\n          \"[Camera Connection] createImageBitmap failed; falling back to main thread detection\",\n          err,\n        );\n        bitmap = null;\n      }\n      if (!bitmap) {\n        setAutoCalibrating(false);\n        // fallback: run sync detection\n        return autoCalibrateSync();\n      }\n      try {\n        const worker = workerRef.current;\n        if (!worker) return autoCalibrateSync();\n        return new Promise<void>((resolve) => {\n          // eslint-disable-next-line prefer-const\n          let timeoutId: ReturnType<typeof setTimeout> | undefined;\n          const onMessage = async (ev: MessageEvent) => {\n            try {\n              if (ev.data && ev.data.error) {\n                const errMsg = ev.data.error || \"Auto-alignment failed\";\n                alert(`Auto-alignment failed: ${errMsg}`);\n                setDetectionMessage(errMsg);\n                setAutoCalibrating(false);\n                if (timeoutId) clearTimeout(timeoutId);\n                worker.removeEventListener(\"message\", onMessage);\n                resolve();\n                return;\n              }\n              if (ev.data && ev.data.type === \"result\") {\n                const boardDetection = ev.data\n                  .detection as BoardDetectionResult;\n                // Respect forceConfidence\n                if (forceConfidence) boardDetection.confidence = 100;\n                // If we have missing homography, try to compute a homography from detected points\n                if (\n                  !boardDetection.homography ||\n                  !Array.isArray(boardDetection.calibrationPoints) ||\n                  boardDetection.calibrationPoints.length < 4\n                ) {\n                  const points = boardDetection.calibrationPoints || [];\n                  if (points.length >= 4) {\n                    const canonicalSrc = [\n                      { x: 0, y: -BoardRadii.doubleOuter },\n                      { x: BoardRadii.doubleOuter, y: 0 },\n                      { x: 0, y: BoardRadii.doubleOuter },\n                      { x: -BoardRadii.doubleOuter, y: 0 },\n                    ];\n                    try {\n                      const H = computeHomographyDLT(\n                        canonicalSrc,\n                        points.slice(0, 4),\n                      );\n                      boardDetection.homography = H;\n                      boardDetection.errorPx = rmsError(\n                        H,\n                        canonicalSrc,\n                        points.slice(0, 4),\n                      );\n                    } catch (err) {\n                      console.warn(\n                        \"[Camera Connection] Worker homography compute failed\",\n                        err,\n                      );\n                    }\n                  }\n                }\n                if (\n                  !boardDetection.success ||\n                  !boardDetection.homography ||\n                  (!forceConfidence && boardDetection.confidence < 40)\n                ) {\n                  alert(\n                    ` Board Detection Failed\\n\\nConfidence: ${Math.round(boardDetection.confidence)}%\\n\\n${boardDetection.message}\\n\\nTry:\\n Better lighting\\n Closer camera angle\\n Make sure entire board is visible\\n Use manual alignment instead (click the 4 double-ring points: D20, D6, D3, D11)`,\n                  );\n                  setAutoCalibrating(false);\n                  if (timeoutId) clearTimeout(timeoutId);\n                  worker.removeEventListener(\"message\", onMessage);\n                  resolve();\n                  return;\n                }\n                // Apply the connection\n                setDetected({\n                  cx: boardDetection.cx,\n                  cy: boardDetection.cy,\n                  bullInner: boardDetection.bullInner,\n                  bullOuter: boardDetection.bullOuter,\n                  trebleInner: boardDetection.trebleInner,\n                  trebleOuter: boardDetection.trebleOuter,\n                  doubleInner: boardDetection.doubleInner,\n                  doubleOuter: boardDetection.doubleOuter,\n                });\n                setDstPoints(boardDetection.calibrationPoints);\n                console.log(\n                  \"[Camera Connection] Auto-detect: Drawing overlay at detected center (\",\n                  Math.round(boardDetection.cx),\n                  \",\",\n                  Math.round(boardDetection.cy),\n                  \") with connection points:\",\n                  boardDetection.calibrationPoints\n                    .map((p) => `(${Math.round(p.x)},${Math.round(p.y)})`)\n                    .join(\" \"),\n                );\n                drawOverlay(\n                  boardDetection.calibrationPoints,\n                  boardDetection.homography,\n                );\n                let shouldLock =\n                  (boardDetection.errorPx ?? Number.POSITIVE_INFINITY) <= 2.0;\n                // Validate detection stability by rerunning local detection a couple times\n                // WITH YIELDS to prevent UI freeze\n                try {\n                  let stableCount2 = 1;\n                  const runs2 = 3;\n                  for (let i = 1; i < runs2; i++) {\n                    // Yield before each stability check\n                    await new Promise((resolveYield) =>\n                      setTimeout(resolveYield, 0),\n                    );\n\n                    const small = document.createElement(\"canvas\");\n                    small.width = Math.max(\n                      1,\n                      Math.round(canvasRef.current!.width * 0.8),\n                    );\n                    small.height = Math.max(\n                      1,\n                      Math.round(canvasRef.current!.height * 0.8),\n                    );\n                    const sctx = small.getContext(\"2d\")!;\n                    sctx.drawImage(\n                      canvasRef.current!,\n                      0,\n                      0,\n                      small.width,\n                      small.height,\n                    );\n                    const scaleSmall = small.width / canvasRef.current!.width;\n                    const hintScaledSmall = bullHint\n                      ? {\n                          centerHint: {\n                            x: bullHint.x * scaleSmall,\n                            y: bullHint.y * scaleSmall,\n                          },\n                        }\n                      : undefined;\n                    const bd2 = detectBoard(\n                      small as any as HTMLCanvasElement,\n                      hintScaledSmall,\n                    );\n                    if (isSimilarDetection(boardDetection as any, bd2 as any))\n                      stableCount2++;\n                  }\n                  const stable2 = stableCount2 >= Math.ceil(runs2 * 0.66);\n                  shouldLock = shouldLock && stable2;\n                } catch (err) {\n                  // ignore stability failures\n                }\n                const overlaySize = overlayRef?.current\n                  ? {\n                      w: overlayRef.current.width,\n                      h: overlayRef.current.height,\n                    }\n                  : videoRef?.current\n                    ? {\n                        w: videoRef.current.clientWidth,\n                        h: videoRef.current.clientHeight,\n                      }\n                    : {\n                        w: canvasRef.current?.width ?? 0,\n                        h: canvasRef.current?.height ?? 0,\n                      };\n                setCalibration({\n                  H: boardDetection.homography as Homography,\n                  createdAt: Date.now(),\n                  errorPx: boardDetection.errorPx ?? null,\n                  imageSize: {\n                    w: canvasRef.current?.width ?? 0,\n                    h: canvasRef.current?.height ?? 0,\n                  },\n                  overlaySize,\n                  anchors: {\n                    src: canonicalRimTargets(\"outer\").slice(0, 4),\n                    dst: boardDetection.calibrationPoints,\n                  },\n                  locked: shouldLock ? true : locked,\n                });\n                setDetectionMessage(\n                  boardDetection.message ??\n                    `Auto-alignment success (confidence ${Math.round(boardDetection.confidence)}%)`,\n                );\n                setPhase(\"computed\");\n                setConfidence(\n                  forceConfidence ? 100 : Math.round(boardDetection.confidence),\n                );\n                setCalibration({ errorPx: boardDetection.errorPx ?? null });\n                setAutoCalibrating(false);\n                worker.removeEventListener(\"message\", onMessage);\n                resolve();\n                return;\n              }\n            } catch (err) {\n              console.warn(\n                \"[Camera Connection] Worker message processing failed\",\n                err,\n              );\n              setAutoCalibrating(false);\n              worker.removeEventListener(\"message\", onMessage);\n              resolve();\n              return;\n            }\n          };\n          worker.addEventListener(\"message\", onMessage);\n          // TypeScript's postMessage overloads are picky about transfer lists;\n          // ensure we only transfer non-null bitmaps.\n          if (bitmap) {\n            worker.postMessage({ type: \"detect\", bitmap }, undefined, [\n              bitmap,\n            ] as unknown as Transferable[]);\n          } else {\n            worker.postMessage({ type: \"detect\", bitmap });\n          }\n          // safety timeout - fallback to sync after 8s\n          timeoutId = setTimeout(() => {\n            if (autoCalibrating) {\n              console.warn(\n                \"[Camera Connection] Worker timed out, attempting sync fallback\",\n              );\n              setAutoCalibrating(false);\n              if (timeoutId) clearTimeout(timeoutId);\n              worker.removeEventListener(\"message\", onMessage);\n              autoCalibrateSync().catch((err) =>\n                console.error(\n                  \"[Camera Connection] Fallback sync detection failed:\",\n                  err,\n                ),\n              );\n            }\n          }, 8000);\n        });\n      } catch (err) {\n        console.warn(\n          \"[Camera Connection] AutoCalibrate worker payload failed\",\n          err,\n        );\n        setAutoCalibrating(false);\n        return await autoCalibrateSync();\n      }\n    } else {\n      return await autoCalibrateSync();\n    }\n  }\n\n  // Asynchronous non-blocking fallback for autoCalibrate\n  async function autoCalibrateSync() {\n    try {\n      setAutoCalibrating(true);\n\n      // Yield to browser to show \"Auto-calibrating...\" state before heavy work\n      await new Promise((resolve) => setTimeout(resolve, 0));\n\n      let boardDetection = detectBoard(\n        canvasRef.current!,\n        bullHint\n          ? { centerHint: bullHint, colorAssist: true }\n          : { colorAssist: true },\n      );\n      boardDetection = refineRingDetection(boardDetection);\n      if (forceConfidence) boardDetection.confidence = 100;\n\n      // Yield again to keep UI responsive between detections\n      await new Promise((resolve) => setTimeout(resolve, 0));\n\n      if (\n        !boardDetection.homography ||\n        !Array.isArray(boardDetection.calibrationPoints) ||\n        boardDetection.calibrationPoints.length < 4\n      ) {\n        try {\n          const points = boardDetection.calibrationPoints || [];\n          if (points.length >= 4) {\n            const canonicalSrc = [\n              { x: 0, y: -BoardRadii.doubleOuter },\n              { x: BoardRadii.doubleOuter, y: 0 },\n              { x: 0, y: BoardRadii.doubleOuter },\n              { x: -BoardRadii.doubleOuter, y: 0 },\n            ];\n            const H = computeHomographyDLT(canonicalSrc, points.slice(0, 4));\n            boardDetection.homography = H;\n            boardDetection.errorPx = rmsError(\n              H,\n              canonicalSrc,\n              points.slice(0, 4),\n            );\n          }\n        } catch (err) {\n          console.warn(\n            \"[Camera Connection] sync forced homography compute failed\",\n            err,\n          );\n        }\n      }\n\n      // Try multi-scale detection attempts - with yields to prevent freezing\n      if (\n        !boardDetection.success ||\n        !boardDetection.homography ||\n        (!forceConfidence && boardDetection.confidence < 50)\n      ) {\n        const scales = [0.9, 0.8, 1.1, 1.2];\n        for (const scale of scales) {\n          try {\n            // Yield before each scale attempt\n            await new Promise((resolve) => setTimeout(resolve, 0));\n\n            const srcCanvas = canvasRef.current!;\n            const tmp = document.createElement(\"canvas\");\n            tmp.width = Math.max(1, Math.round(srcCanvas.width * scale));\n            tmp.height = Math.max(1, Math.round(srcCanvas.height * scale));\n            const tctx = tmp.getContext(\"2d\");\n            if (!tctx) continue;\n            tctx.drawImage(srcCanvas, 0, 0, tmp.width, tmp.height);\n            // Scale bull hint into the resized tmp space if available\n            const hintScaled = bullHint\n              ? {\n                  centerHint: { x: bullHint.x * scale, y: bullHint.y * scale },\n                  colorAssist: true,\n                }\n              : { colorAssist: true };\n            let bd = detectBoard(tmp as any as HTMLCanvasElement, hintScaled);\n            bd = refineRingDetection(bd);\n            if (bd.success && bd.homography) {\n              // Scale found points back to original coordinate space\n              const invScale = 1 / scale;\n              bd.cx *= invScale;\n              bd.cy *= invScale;\n              bd.bullInner *= invScale;\n              bd.bullOuter *= invScale;\n              bd.trebleInner *= invScale;\n              bd.trebleOuter *= invScale;\n              bd.doubleInner *= invScale;\n              bd.doubleOuter *= invScale;\n              bd.calibrationPoints = bd.calibrationPoints.map((p) => ({\n                x: p.x * invScale,\n                y: p.y * invScale,\n              }));\n              boardDetection = bd;\n              break;\n            }\n          } catch (err) {\n            // continue on error\n          }\n        }\n      }\n\n      // Re-run the post-success checks after potential multi-scale detection\n      if (\n        !boardDetection.success ||\n        !boardDetection.homography ||\n        (!forceConfidence && boardDetection.confidence < 50)\n      ) {\n        alert(\n          ` Board Detection Failed\\n\\nConfidence: ${Math.round(boardDetection.confidence)}%\\n\\n${boardDetection.message}\\n\\nTry:\\n Better lighting\\n Closer camera angle\\n Make sure entire board is visible\\n Use manual alignment instead (click the 4 double-ring points: D20, D6, D3, D11)`,\n        );\n        setDetectionMessage(boardDetection.message ?? null);\n        setAutoCalibrating(false);\n        return;\n      }\n\n      // Yield before applying detection to UI\n      await new Promise((resolve) => setTimeout(resolve, 0));\n\n      // Apply detection (same as worker result processing)\n      setDetected({\n        cx: boardDetection.cx,\n        cy: boardDetection.cy,\n        bullInner: boardDetection.bullInner,\n        bullOuter: boardDetection.bullOuter,\n        trebleInner: boardDetection.trebleInner,\n        trebleOuter: boardDetection.trebleOuter,\n        doubleInner: boardDetection.doubleInner,\n        doubleOuter: boardDetection.doubleOuter,\n      });\n      setDstPoints(boardDetection.calibrationPoints);\n      drawOverlay(boardDetection.calibrationPoints, boardDetection.homography);\n\n      // Check stability of the detection across quick re-runs - with yields\n      const baseCheck =\n        (boardDetection.errorPx ?? Number.POSITIVE_INFINITY) <= 2.0;\n      let stabilityCount = 1;\n      const stabilityRuns = 3;\n      for (let i = 1; i < stabilityRuns; i++) {\n        try {\n          // Yield before stability check\n          await new Promise((resolve) => setTimeout(resolve, 0));\n\n          const tmp = document.createElement(\"canvas\");\n          tmp.width = Math.max(1, Math.round(canvasRef.current!.width * 0.9));\n          tmp.height = Math.max(1, Math.round(canvasRef.current!.height * 0.9));\n          const tctx = tmp.getContext(\"2d\")!;\n          tctx.drawImage(canvasRef.current!, 0, 0, tmp.width, tmp.height);\n          const hintScaled2 = bullHint\n            ? {\n                centerHint: { x: bullHint.x * 0.9, y: bullHint.y * 0.9 },\n                colorAssist: true,\n              }\n            : { colorAssist: true };\n          const bd2 = detectBoard(tmp as any as HTMLCanvasElement, hintScaled2);\n          if (isSimilarDetection(boardDetection as any, bd2 as any))\n            stabilityCount++;\n        } catch (err) {\n          // ignore\n        }\n      }\n      const stable = stabilityCount >= Math.ceil(stabilityRuns * 0.66);\n      const shouldLock = baseCheck && stable;\n      const overlaySize = overlayRef?.current\n        ? { w: overlayRef.current.width, h: overlayRef.current.height }\n        : videoRef?.current\n          ? {\n              w: videoRef.current.clientWidth,\n              h: videoRef.current.clientHeight,\n            }\n          : { w: canvasRef.current!.width, h: canvasRef.current!.height };\n      // Use actual video frame dimensions for imageSize, not canvas display dimensions\n      const actualImageSize = videoRef.current\n        ? { w: videoRef.current.videoWidth, h: videoRef.current.videoHeight }\n        : { w: canvasRef.current!.width, h: canvasRef.current!.height };\n\n      // Auto-estimate sector offset from homography so 20 aligns to top\n      const autoOffset = estimateSectorOffsetFromHomography(\n        boardDetection.homography as Homography,\n        \"outer\",\n      );\n\n      setCalibration({\n        H: boardDetection.homography as Homography,\n        createdAt: Date.now(),\n        errorPx: boardDetection.errorPx ?? null,\n        imageSize: actualImageSize,\n        overlaySize,\n        anchors: {\n          // Match black outline guide: calibrate using the double OUTER rim\n          src: canonicalRimTargets(\"outer\").slice(0, 4),\n          dst: boardDetection.calibrationPoints,\n        },\n        locked: shouldLock ? true : locked,\n        theta: boardDetection.theta,\n        sectorOffset: autoOffset,\n      });\n      setPhase(\"computed\");\n      setConfidence(\n        forceConfidence ? 100 : Math.round(boardDetection.confidence),\n      );\n      setCalibration({ errorPx: boardDetection.errorPx ?? null });\n      setDetectionMessage(boardDetection.message ?? null);\n      setAutoCalibrating(false);\n    } catch (err) {\n      console.error(\"[Camera Connection] autoConnectSync failed:\", err);\n      const errorMsg = err instanceof Error ? err.message : String(err);\n      setDetectionMessage(` Auto-alignment failed: ${errorMsg}`);\n      setAutoCalibrating(false);\n    }\n  }\n\n  function detectMarkers() {\n    if (!canvasRef.current)\n      return alert(\"Capture a frame or upload a photo first.\");\n    const result = detectMarkersFromCanvas(canvasRef.current);\n    setMarkerResult(result);\n    if (!result.success || !result.homography) {\n      const missingMsg = result.missing.length\n        ? ` Missing markers: ${result.missing.map((k) => `${k.toUpperCase()} (ID ${MARKER_TARGETS[k]})`).join(\", \")}`\n        : \"\";\n      const foundMsg =\n        result.markersFound.length > 0\n          ? `\\n\\nDetected ${result.markersFound.length} markers with IDs: ${result.markersFound.map((m) => m.id).join(\", \")}`\n          : \"\\n\\nNo markers detected. Make sure markers are on white paper, fully visible, and well-lit.\";\n      const fullMsg = `${result.message}${missingMsg}${foundMsg}\\n\\nYou can still use manual alignment: click the 4 double-ring points (D20, D6, D3, D11).`;\n      alert(fullMsg);\n      return;\n    }\n    setDetected(null);\n    setDstPoints(result.points);\n    drawOverlay(result.points, result.homography);\n    const src = canonicalRimTargets(\"outer\");\n    const imageSize = {\n      w: canvasRef.current.width,\n      h: canvasRef.current.height,\n    };\n    const overlaySize = overlayRef?.current\n      ? { w: overlayRef.current.width, h: overlayRef.current.height }\n      : videoRef?.current\n        ? { w: videoRef.current.clientWidth, h: videoRef.current.clientHeight }\n        : { w: canvasRef.current.width, h: canvasRef.current.height };\n    const shouldLock = (result.errorPx ?? Number.POSITIVE_INFINITY) <= 1.2;\n    setCalibration({\n      H: result.homography as Homography,\n      createdAt: Date.now(),\n      errorPx: result.errorPx ?? null,\n      imageSize,\n      overlaySize,\n      anchors: { src, dst: result.points },\n      locked: shouldLock ? true : locked,\n    });\n    setPhase(\"computed\");\n  }\n\n  useEffect(() => {\n    drawOverlay();\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [hasSnapshot, H, correctionSx, correctionTx, correctionTy]);\n\n  // Live detection loop (runs only when streaming and liveDetect is on)\n  useEffect(() => {\n    if (!liveDetect || !streaming) return;\n    let raf = 0;\n    const tick = () => {\n      try {\n        captureFrame();\n      } catch {}\n      raf = requestAnimationFrame(tick);\n    };\n    raf = requestAnimationFrame(tick);\n    return () => cancelAnimationFrame(raf);\n  }, [liveDetect, streaming]);\n\n  // When connection is locked and we have a pairing code, publish connection to server\n  useEffect(() => {\n    (async () => {\n      try {\n        if (!locked || !pairCode) return;\n        // Build a compact connection payload including current canvas size if available\n        const imgSize = canvasRef.current\n          ? { w: canvasRef.current.width, h: canvasRef.current.height }\n          : null;\n        const bodyStr = JSON.stringify({\n          H,\n          anchors: null,\n          imageSize: imgSize,\n          errorPx: errorPx ?? null,\n        });\n        try {\n          await apiFetch(`/cam/calibration/${pairCode}`, {\n            method: \"POST\",\n            headers: { \"Content-Type\": \"application/json\" },\n            body: bodyStr,\n          });\n          console.log(\n            \"[Camera Connection] Posted connection for code\",\n            pairCode,\n          );\n        } catch (err) {\n          console.warn(\"[Camera Connection] Upload connection failed\", err);\n        }\n        // If user is authenticated, persist connection to their account (Supabase-backed)\n        try {\n          const token = localStorage.getItem(\"authToken\");\n          if (token) {\n            await apiFetch(\"/api/user/calibration\", {\n              method: \"POST\",\n              headers: {\n                \"Content-Type\": \"application/json\",\n                Authorization: `Bearer ${token}`,\n              },\n              body: bodyStr,\n            });\n            console.log(\n              \"[Camera Connection] Synced connection to user account\",\n            );\n          }\n        } catch (err) {\n          console.warn(\"[Camera Connection] User connection sync failed\", err);\n        }\n      } catch (e) {\n        /* ignore */\n      }\n    })();\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [locked, pairCode]);\n\n  const showMobileLanding = isMobileDevice && !mobileLandingOverride;\n\n  if (showMobileLanding) {\n    const linkForMobile =\n      mobileLandingLink ??\n      (typeof window !== \"undefined\"\n        ? `${window.location.origin.replace(/\\/$/, \"\")}/mobile-cam.html`\n        : \"/mobile-cam.html\");\n    return (\n      <div className=\"mx-auto flex min-h-[calc(100vh-140px)] w-full max-w-xl flex-col justify-center gap-6 p-6\">\n        <div className=\"space-y-5 rounded-3xl border border-indigo-400/30 bg-slate-900/70 p-6 text-slate-100 shadow-xl\">\n          <div className=\"space-y-2\">\n            <p className=\"text-xs font-semibold uppercase tracking-wide text-indigo-300\">\n              Choose Mode\n            </p>\n            <h2 className=\"text-2xl font-semibold leading-tight text-white\">\n              How do you want to use this device?\n            </h2>\n            <p className=\"text-sm text-slate-200/80\">\n              You can stream this camera to another device (Remote Camera) or\\n\n              play and calibrate directly on this screen.\n            </p>\n          </div>\n          <div className=\"space-y-2\">\n            <a\n              href={linkForMobile}\n              className=\"btn w-full justify-center px-4 py-2 text-base\"\n            >\n              Open mobile camera\n            </a>\n            <button\n              type=\"button\"\n              className=\"btn btn--ghost w-full justify-center px-4 py-2 text-sm\"\n              onClick={() => copyValue(linkForMobile, \"link\")}\n            >\n              {copyFeedback === \"link\" ? \"Link copied!\" : \"Copy link\"}\n            </button>\n          </div>\n          <p className=\"text-xs text-slate-300/70\">\n            On a desktop, open Camera Connection and generate a pairing code.\n            Then tap <span className=\"font-semibold\">Pair with Desktop</span>{\" \"}\n            from the mobile camera page to connect this device.\n          </p>\n        </div>\n        <button\n          type=\"button\"\n          className=\"self-center text-xs font-medium text-indigo-200 underline decoration-dotted decoration-indigo-300/70 transition hover:text-indigo-100\"\n          onClick={() => setMobileLandingOverride(true)}\n        >\n          Continue to desktop connection\n        </button>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"space-y-6\">\n      {isMobileDevice && mobileLandingOverride && (\n        <div className=\"rounded-2xl border border-indigo-400/30 bg-indigo-500/10 p-4 text-sm text-indigo-100\">\n          <div className=\"flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between\">\n            <p className=\"leading-relaxed\">\n              Using a phone? Switch back to the streamlined mobile camera\n              interface for an easier pairing flow.\n            </p>\n            <button\n              type=\"button\"\n              className=\"btn btn--ghost px-3 py-1 text-xs\"\n              onClick={() => setMobileLandingOverride(false)}\n            >\n              Open mobile camera mode\n            </button>\n          </div>\n        </div>\n      )}\n      <div className=\"card space-y-6 p-6\">\n        <header className=\"flex flex-wrap items-start justify-between gap-4\">\n          <div className=\"space-y-2\">\n            <p className=\"text-xs font-semibold uppercase tracking-wide text-indigo-300\">\n              Camera alignment\n            </p>\n            <h2 className=\"text-2xl font-semibold leading-tight text-white\">\n              Camera connection\n            </h2>\n            <p className=\"max-w-2xl text-sm opacity-80\">\n              Select and test your camera. Manual scoring mode does not require\n              calibration.\n            </p>\n          </div>\n          <div className=\"flex flex-col items-end gap-2 text-xs font-medium\">\n            <span className=\"inline-flex items-center gap-2 rounded-full border border-indigo-400/50 bg-indigo-500/10 px-3 py-1\">\n              <span className=\"opacity-60\">Mode</span>\n              <span>\n                {mode === \"local\"\n                  ? \"Desktop camera\"\n                  : mode === \"phone\"\n                    ? \"Phone camera\"\n                    : \"Wifi device\"}\n              </span>\n            </span>\n            <span\n              className={`inline-flex items-center gap-2 rounded-full border px-3 py-1 ${streaming ? \"border-emerald-400/60 bg-emerald-500/10 text-emerald-100\" : \"border-white/20 bg-white/5 text-slate-200\"}`}\n            >\n              <span\n                className={`h-2 w-2 rounded-full ${streaming ? \"bg-emerald-400\" : \"bg-slate-400\"}`}\n              />\n              {streaming ? \"Live stream active\" : \"Stream idle\"}\n            </span>\n            {locked ? (\n              <div className=\"space-y-3 rounded-2xl border border-emerald-400/40 bg-emerald-500/10 p-4 text-sm\">\n                <div className=\"flex items-center justify-between gap-2\">\n                  <div className=\"flex items-center gap-3\">\n                    <div className=\"flex h-10 w-10 items-center justify-center rounded-full bg-emerald-500/20\">\n                      <span className=\"text-lg\"></span>\n                    </div>\n                    <div>\n                      <h4 className=\"font-semibold text-emerald-100\">\n                        Connection locked\n                      </h4>\n                      <p className=\"text-xs opacity-80\">\n                        Your camera connection is saved and active across all\n                        game modes. It will be used in Online, Offline, and\n                        Tournaments.\n                      </p>\n                    </div>\n                  </div>\n                  <button\n                    className=\"btn btn--ghost px-2 py-1 text-xs whitespace-nowrap\"\n                    onClick={() => setCalibration({ locked: false })}\n                    title=\"Unlock to realign\"\n                  >\n                    Unlock\n                  </button>\n                </div>\n                {errorPx != null && (\n                  <div className=\"text-xs opacity-75\">\n                    Precision: {errorPx.toFixed(2)} px RMS error\n                  </div>\n                )}\n              </div>\n            ) : null}\n          </div>\n        </header>\n\n        <div className=\"grid gap-6 xl:grid-cols-[minmax(0,2fr)_minmax(320px,1fr)]\">\n          <section className=\"space-y-4\">\n            <div className=\"space-y-4 rounded-2xl border border-white/10 bg-black/40 p-4\">\n              <div className=\"flex flex-wrap items-center justify-between gap-4 text-xs\">\n                <div className=\"flex flex-wrap items-center gap-3\">\n                  <span className=\"uppercase tracking-wide opacity-60\">\n                    Video source\n                  </span>\n                  <div className=\"flex items-center gap-1\">\n                    <button\n                      className={`btn px-3 py-1 ${mode === \"local\" ? \"bg-emerald-600 hover:bg-emerald-700\" : \"bg-slate-700 hover:bg-slate-600\"}`}\n                      data-testid=\"mode-local\"\n                      onClick={() => {\n                        setMode(\"local\");\n                        if (\n                          typeof DROPDOWN_DEBUG !== \"undefined\" &&\n                          DROPDOWN_DEBUG\n                        )\n                          console.debug(\n                            \"[Camera Connection] setMode(local)\",\n                            Date.now(),\n                          );\n                        stopCamera(false);\n                      }}\n                      title=\"Use local camera\"\n                    >\n                      Local\n                    </button>\n                    <button\n                      className={`btn px-3 py-1 ${mode === \"phone\" ? \"bg-emerald-600 hover:bg-emerald-700\" : \"bg-slate-700 hover:bg-slate-600\"}`}\n                      data-testid=\"mode-phone\"\n                      onClick={() => {\n                        setMode(\"phone\");\n                        if (\n                          typeof DROPDOWN_DEBUG !== \"undefined\" &&\n                          DROPDOWN_DEBUG\n                        )\n                          console.debug(\n                            \"[Camera Connection] setMode(phone)\",\n                            Date.now(),\n                          );\n                        stopCamera(false);\n                      }}\n                      title=\"Enable camera on this device\"\n                    >\n                      Phone\n                    </button>\n                    <button\n                      className={`btn px-3 py-1 ${mode === \"wifi\" ? \"bg-emerald-600 hover:bg-emerald-700\" : \"bg-slate-700 hover:bg-slate-600\"}`}\n                      data-testid=\"mode-wifi\"\n                      onClick={() => {\n                        setMode(\"wifi\");\n                        if (\n                          typeof DROPDOWN_DEBUG !== \"undefined\" &&\n                          DROPDOWN_DEBUG\n                        )\n                          console.debug(\n                            \"[Camera Connection] setMode(wifi)\",\n                            Date.now(),\n                          );\n                        stopCamera(false);\n                        try {\n                          startWifiConnection();\n                        } catch (e) {\n                          console.debug(\n                            \"[Camera Connection] startWifiConnection failed\",\n                            e,\n                          );\n                        }\n                      }}\n                      title=\"Discover wifi/USB autoscoring devices\"\n                    >\n                      Wifi\n                    </button>\n                  </div>\n                </div>\n                <div className=\"flex flex-wrap items-center gap-3\">\n                  <div className=\"flex items-center gap-2\">\n                    <span className=\"opacity-70\">Zoom</span>\n                    <input\n                      type=\"range\"\n                      min={50}\n                      max={200}\n                      step={5}\n                      value={Math.round((zoom || 1) * 100)}\n                      onChange={(e) =>\n                        setZoom(\n                          Math.max(\n                            0.5,\n                            Math.min(2, Number(e.target.value) / 100),\n                          ),\n                        )\n                      }\n                    />\n                    <span className=\"w-12 text-right\">\n                      {Math.round((zoom || 1) * 100)}%\n                    </span>\n                  </div>\n                  <button className=\"btn px-3 py-1\" onClick={() => setZoom(1)}>\n                    Actual\n                  </button>\n                </div>\n              </div>\n              {/* Tools pill (always visible) */}\n              <div className=\"ml-3 relative\">\n                <button\n                  className=\"inline-flex items-center gap-2 rounded-full border border-indigo-400/30 bg-indigo-400/10 px-3 py-1 text-sm\"\n                  onClick={() => setToolsPopoverOpen(!toolsPopoverOpen)}\n                  data-testid=\"cal-tools-popper-button\"\n                >\n                  <span className=\"font-semibold\">Cam Tools</span>\n                  {preserveCalibrationOverlay && (\n                    <span className=\"ml-2 text-xs opacity-70\">\n                      (overlay preserved)\n                    </span>\n                  )}\n                </button>\n                {toolsPopoverOpen && (\n                  <div\n                    className=\"absolute right-0 mt-2 w-64 rounded-lg border bg-gray-900/80 p-3 shadow-lg z-50\"\n                    data-testid=\"cal-tools-popover\"\n                    role=\"dialog\"\n                  >\n                    <div className=\"text-xs mb-2\">\n                      Camera connection quick tools\n                    </div>\n                    <div className=\"flex items-center gap-2 mb-2\">\n                      <input\n                        id=\"hdr-show-darts\"\n                        type=\"checkbox\"\n                        checked={showDartPreview}\n                        onChange={(e) => setShowDartPreview(e.target.checked)}\n                      />\n                      <label htmlFor=\"hdr-show-darts\" className=\"text-sm\">\n                        Show darts overlay\n                      </label>\n                    </div>\n                    <div className=\"flex items-center gap-2 mb-2\">\n                      <button\n                        className=\"btn btn--ghost btn-sm\"\n                        onClick={() => resetVisualAdjustments()}\n                      >\n                        Reset visual adjustments\n                      </button>\n                    </div>\n                    <div className=\"flex items-center gap-2 mb-2\">\n                      <input\n                        id=\"hdr-autocommit\"\n                        type=\"checkbox\"\n                        checked={autoCommitTestMode}\n                        onChange={(e) =>\n                          setAutoCommitTestMode(e.target.checked)\n                        }\n                      />\n                      <label htmlFor=\"hdr-autocommit\" className=\"text-sm\">\n                        Enable autocommit test\n                      </label>\n                    </div>\n                    <div className=\"flex items-center gap-2 mb-2\">\n                      <input\n                        id=\"hdr-autocommit-online\"\n                        type=\"checkbox\"\n                        checked={allowAutocommitInOnline}\n                        onChange={(e) =>\n                          setAllowAutocommitInOnline(e.target.checked)\n                        }\n                        disabled={!autoCommitTestMode}\n                      />\n                      <label\n                        htmlFor=\"hdr-autocommit-online\"\n                        className=\"text-sm\"\n                      >\n                        Allow autocommit in Online/Tournament matches\n                        (dangerous)\n                      </label>\n                    </div>\n                    <div className=\"flex items-center gap-2 mb-2\">\n                      <input\n                        id=\"hdr-autocommit-immediate\"\n                        type=\"checkbox\"\n                        checked={autoCommitImmediate}\n                        onChange={(e) =>\n                          setAutoCommitImmediate(e.target.checked)\n                        }\n                      />\n                      <label\n                        htmlFor=\"hdr-autocommit-immediate\"\n                        className=\"text-sm\"\n                      >\n                        Autocommit immediate when detected\n                      </label>\n                    </div>\n                    <div className=\"flex items-center gap-2 mb-2\">\n                      <input\n                        id=\"hdr-show-detected\"\n                        type=\"checkbox\"\n                        checked={showDetectedOverlay}\n                        onChange={(e) =>\n                          setShowDetectedOverlay(e.target.checked)\n                        }\n                      />\n                      <label htmlFor=\"hdr-show-detected\" className=\"text-sm\">\n                        Show detected rings overlay\n                      </label>\n                    </div>\n                    <div className=\"flex items-center gap-2 mb-2\">\n                      <input\n                        id=\"hdr-force-detected\"\n                        type=\"checkbox\"\n                        checked={forceDetectedOnly}\n                        onChange={(e) => setForceDetectedOnly(e.target.checked)}\n                      />\n                      <label htmlFor=\"hdr-force-detected\" className=\"text-sm\">\n                        Force detected-only overlay (bypass homography)\n                      </label>\n                    </div>\n                    <div className=\"flex items-center gap-2 mb-2\">\n                      <label\n                        htmlFor=\"hdr-double-adjust\"\n                        className=\"text-sm mr-2\"\n                      >\n                        Double adj\n                      </label>\n                      <input\n                        id=\"hdr-double-adjust\"\n                        type=\"range\"\n                        min={0.95}\n                        max={1.1}\n                        step={0.005}\n                        value={doubleOuterAdjust}\n                        onChange={(e) =>\n                          setDoubleOuterAdjust(parseFloat(e.target.value))\n                        }\n                      />\n                      <span className=\"text-xs ml-2\">\n                        {(doubleOuterAdjust * 100).toFixed(1)}%\n                      </span>\n                    </div>\n                    <div className=\"flex items-center gap-2 mb-2\">\n                      <label\n                        htmlFor=\"hdr-treble-adjust\"\n                        className=\"text-sm mr-2\"\n                      >\n                        Treble adj\n                      </label>\n                      <input\n                        id=\"hdr-treble-adjust\"\n                        type=\"range\"\n                        min={0.95}\n                        max={1.1}\n                        step={0.005}\n                        value={trebleOuterAdjust}\n                        onChange={(e) =>\n                          setTrebleOuterAdjust(parseFloat(e.target.value))\n                        }\n                      />\n                      <span className=\"text-xs ml-2\">\n                        {(trebleOuterAdjust * 100).toFixed(1)}%\n                      </span>\n                    </div>\n                    <div className=\"flex items-center gap-2 mb-2\">\n                      <select\n                        id=\"hdr-align-select\"\n                        className=\"input\"\n                        value={aligningRing || \"\"}\n                        onChange={(e) =>\n                          setAligningRing(\n                            e.target.value ? (e.target.value as any) : null,\n                          )\n                        }\n                      >\n                        <option value=\"\">-- Align ring --</option>\n                        <option value=\"double\">Double Outer</option>\n                        <option value=\"treble\">Treble Outer</option>\n                        <option value=\"bull\">Bull Outer</option>\n                      </select>\n                      <div className=\"text-xs opacity-70 ml-2\">\n                        Click on the physical ring to align\n                      </div>\n                    </div>\n                    <div className=\"flex items-center justify-between mt-2\">\n                      <div className=\"text-xs opacity-70\">\n                        {lastDetectedLabel || \"No recent detection\"}\n                      </div>\n                      <div>\n                        <button\n                          className=\"btn btn--small\"\n                          onClick={() => {\n                            console.debug(\n                              \"[Camera Connection] popover Commit click (onClick)\",\n                            ); // eslint-disable-line no-console\n                            doCommit();\n                          }}\n                          onPointerDown={() => {\n                            console.debug(\n                              \"[Camera Connection] popover Commit click (onPointerDown)\",\n                            ); // eslint-disable-line no-console\n                            doCommit();\n                          }}\n                        >\n                          Commit\n                        </button>\n                      </div>\n                    </div>\n                  </div>\n                )}\n              </div>\n\n              <div\n                className=\"relative w-full overflow-hidden rounded-2xl border border-indigo-400/30 bg-black\"\n                style={{\n                  aspectRatio: frameSize\n                    ? `${frameSize.w} / ${frameSize.h}`\n                    : \"16 / 9\",\n                }}\n              >\n                <div className=\"absolute top-2 right-2 z-40 flex items-center gap-2 rounded-full bg-black/40 px-2 py-1 text-[11px] text-white backdrop-blur\">\n                  <span\n                    className={`inline-block h-2 w-2 rounded-full ${streaming ? \"bg-emerald-400\" : \"bg-rose-500\"}`}\n                    aria-hidden=\"true\"\n                  />\n                  <span>{streaming ? \"Connected\" : \"Disconnected\"}</span>\n                </div>\n                <div\n                  className=\"absolute inset-0\"\n                  style={{\n                    transform: `scale(${zoom || 1})`,\n                    transformOrigin: \"center center\",\n                  }}\n                >\n                  <video\n                    ref={videoRef}\n                    onLoadedMetadata={(ev) => {\n                      try {\n                        const v = ev.currentTarget as HTMLVideoElement;\n                        if (v.videoWidth && v.videoHeight)\n                          setFrameSize({ w: v.videoWidth, h: v.videoHeight });\n                      } catch {}\n                    }}\n                    className={`absolute inset-0 h-full w-full object-cover transition-opacity duration-300 ${hasSnapshot ? \"opacity-0 -z-10\" : \"opacity-100 z-10\"}`}\n                    autoPlay\n                    playsInline\n                    muted\n                    controls={false}\n                  />\n                  {videoPlayBlocked && (\n                    <div className=\"absolute inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur\">\n                      <button\n                        className=\"rounded-lg bg-white px-4 py-2 font-semibold text-slate-900 shadow-lg\"\n                        onClick={async () => {\n                          try {\n                            await videoRef.current?.play();\n                            setVideoPlayBlocked(false);\n                            setStreaming(true);\n                            setPhase(\"capture\");\n                          } catch (e) {\n                            console.warn(\"Tap-to-play retry failed\", e);\n                            alert(\n                              \"Tap to enable video failed. Please check browser settings or reload the page.\",\n                            );\n                          }\n                        }}\n                      >\n                        Tap to allow video\n                      </button>\n                    </div>\n                  )}\n                  <canvas\n                    ref={canvasRef}\n                    className={`absolute inset-0 h-full w-full transition-opacity duration-300 ${hasSnapshot ? \"opacity-100 z-10\" : \"opacity-0 -z-10\"}`}\n                  />\n                </div>\n              </div>\n\n              <div className=\"mt-4 flex flex-wrap items-center gap-2\">\n                {streaming ? (\n                  <button className=\"btn\" onClick={() => stopCamera(true)}>\n                    Disconnect\n                  </button>\n                ) : (\n                  <button className=\"btn\" onClick={startCamera}>\n                    Connect\n                  </button>\n                )}\n                <span className=\"text-xs opacity-70\">\n                  {streaming ? \"Camera connected\" : \"Camera not connected\"}\n                </span>\n              </div>\n            </div>\n          </section>\n\n          <aside className=\"space-y-4\">\n            <DevicePicker\n              videoDevices={videoDevices}\n              streaming={streaming}\n              refreshVideoDevices={refreshVideoDevices}\n              testCamera={testCamera}\n              onSelectPhoneCamera={handleSelectPhoneCamera}\n              lastDetectedLabel={lastDetectedLabel}\n              autoCommitTestMode={autoCommitTestMode}\n              doCommit={doCommit}\n              lastDetectedValue={lastDetectedValue}\n              cameraConnected={streaming}\n            />\n\n            {mode === \"phone\" && (\n              <section className=\"space-y-3 rounded-2xl border border-indigo-400/30 bg-black/40 p-4 text-xs text-white\">\n                <div className=\"font-semibold\">Phone pairing</div>\n                <button\n                  type=\"button\"\n                  className=\"w-full text-left px-3 py-2 rounded-lg border border-white/10 bg-white/5 hover:bg-white/10 transition flex items-center gap-2\"\n                  onClick={() => copyValue(mobileUrl, \"link\")}\n                  title=\"Copy mobile camera link\"\n                >\n                  <span className=\"flex-1 min-w-0 font-mono break-all text-[11px]\">\n                    {mobileUrl}\n                  </span>\n                  <span className=\"text-[10px] uppercase tracking-wide whitespace-nowrap text-emerald-200\">\n                    {copyFeedback === \"link\" ? \"Copied!\" : \"Copy link\"}\n                  </span>\n                </button>\n                <div className=\"flex items-center gap-2 text-[11px]\">\n                  <a\n                    href={mobileUrl}\n                    target=\"_blank\"\n                    rel=\"noreferrer\"\n                    className=\"underline decoration-dotted text-indigo-200 hover:text-indigo-100 transition\"\n                  >\n                    Open link in new tab\n                  </a>\n                </div>\n                <div className=\"opacity-80\">\n                  WS:{\" \"}\n                  {ws\n                    ? ws.readyState === 1\n                      ? \"open\"\n                      : ws.readyState === 0\n                        ? \"connecting\"\n                        : ws.readyState === 2\n                          ? \"closing\"\n                          : \"closed\"\n                    : \"not started\"}{\" \"}\n                   {httpsInfo?.https ? \"HTTPS on\" : \"HTTP only\"}\n                </div>\n                {pairCode && (\n                  <button\n                    type=\"button\"\n                    className=\"w-full text-left px-3 py-2 rounded-lg border border-white/10 bg-white/5 hover:bg-white/10 transition flex items-center justify-between gap-2\"\n                    onClick={() => copyValue(pairCode, \"code\")}\n                    title=\"Copy pairing code\"\n                  >\n                    <span className=\"font-mono tracking-[0.3em] text-sm\">\n                      {pairCode}\n                    </span>\n                    <span className=\"text-[10px] uppercase tracking-wide whitespace-nowrap text-emerald-200\">\n                      {copyFeedback === \"code\" ? \"Copied!\" : \"Copy code\"}\n                    </span>\n                  </button>\n                )}\n                <div className=\"flex items-center gap-2\">\n                  {ttl !== null && <span>Expires in {ttl}s</span>}\n                  <button\n                    className=\"btn px-2 py-1 text-xs\"\n                    onClick={regenerateCode}\n                  >\n                    Regenerate\n                  </button>\n                </div>\n                {showTips && (\n                  <div className=\"space-y-2 rounded-lg border border-slate-700/50 bg-slate-900/60 p-3 text-slate-200\">\n                    <div className=\"font-semibold\">Troubleshooting</div>\n                    <ul className=\"list-disc space-y-1 pl-4\">\n                      <li>\n                        Phone and desktop must be on the same WiFi network.\n                      </li>\n                      <li>\n                        Allow the server through your firewall (ports 8787 and{\" \"}\n                        {httpsInfo?.https ? httpsInfo.port : 8788}).\n                      </li>\n                      <li>\n                        On iPhone, use HTTPS links (QR will prefer HTTPS when\n                        enabled).\n                      </li>\n                    </ul>\n                    <div className=\"text-right\">\n                      <button\n                        className=\"btn btn--ghost px-2 py-1 text-xs\"\n                        onClick={() => setShowTips(false)}\n                      >\n                        Hide tips\n                      </button>\n                    </div>\n                  </div>\n                )}\n              </section>\n            )}\n\n            {/* Sidebar Step cards intentionally removed  these controls remain available in the main stage cards above to avoid showing duplicate controls in the right-hand sidebar. */}\n          </aside>\n        </div>\n\n        {mode === \"wifi\" && !streaming && (\n          <section className=\"space-y-3 rounded-2xl border border-indigo-400/30 bg-black/40 p-4 text-xs text-white\">\n            <div className=\"font-semibold\">Wifi scoring devices</div>\n            {discoveringWifi ? (\n              <div className=\"flex items-center gap-2\">\n                <div className=\"h-4 w-4 animate-spin rounded-full border-b-2 border-white\" />\n                <span>Scanning network for devices</span>\n              </div>\n            ) : wifiDevices.length > 0 ? (\n              <div className=\"space-y-2\">\n                {wifiDevices.map((device) => (\n                  <div\n                    key={device.id}\n                    className=\"flex items-center justify-between rounded border border-slate-700/50 bg-slate-900/60 p-2\"\n                  >\n                    <div>\n                      <div className=\"font-medium\">{device.name}</div>\n                      <div className=\"opacity-70\">\n                        {device.ip}:{device.port}  {device.type.toUpperCase()}\n                      </div>\n                      <div className=\"opacity-70 text-xs\">\n                        Capabilities: {device.capabilities.join(\", \")}\n                      </div>\n                    </div>\n                    <button\n                      className={`btn px-2 py-1 text-xs ${device.status === \"connecting\" ? \"bg-yellow-600\" : device.status === \"online\" ? \"bg-green-600\" : \"bg-blue-600\"}`}\n                      onClick={() => connectToWifiDevice(device)}\n                      disabled={device.status === \"connecting\"}\n                    >\n                      {device.status === \"connecting\"\n                        ? \"Connecting\"\n                        : \"Connect\"}\n                    </button>\n                  </div>\n                ))}\n                <div className=\"text-center\">\n                  <button\n                    className=\"btn px-2 py-1 text-xs\"\n                    onClick={startWifiConnection}\n                  >\n                    Rescan network\n                  </button>\n                </div>\n              </div>\n            ) : (\n              <div className=\"space-y-2 text-center\">\n                <div>No wifi scoring devices found.</div>\n                <div className=\"opacity-70\">\n                  Ensure your wifi cameras are powered on and on the same\n                  network.\n                </div>\n                <button\n                  className=\"btn px-2 py-1 text-xs\"\n                  onClick={startWifiConnection}\n                >\n                  Scan again\n                </button>\n              </div>\n            )}\n          </section>\n        )}\n      </div>\n    </div>\n  );\n}\n","import { create } from \"zustand\";\n\ntype Toast = {\n  id: number;\n  message: string;\n  type?: \"info\" | \"success\" | \"error\";\n  timeout?: number;\n  actionLabel?: string;\n  onAction?: () => void;\n};\n\ntype ToastState = {\n  toasts: Toast[];\n  push: (\n    message: string,\n    opts?: {\n      type?: \"info\" | \"success\" | \"error\";\n      timeout?: number;\n      actionLabel?: string;\n      onAction?: () => void;\n    },\n  ) => void;\n  remove: (id: number) => void;\n  clear: () => void;\n};\n\nlet nextId = 1;\n\nexport const useToastStore = create<ToastState>((set) => ({\n  toasts: [],\n  push: (message, opts) =>\n    set((s) => {\n      const id = nextId++;\n      const t: Toast = {\n        id,\n        message,\n        type: opts?.type || \"info\",\n        timeout: opts?.timeout ?? 3000,\n        actionLabel: opts?.actionLabel,\n        onAction: opts?.onAction,\n      };\n      // auto-remove after timeout\n      if (t.timeout && t.timeout > 0) {\n        setTimeout(() => {\n          set((cur) => ({ toasts: cur.toasts.filter((x) => x.id !== id) }));\n        }, t.timeout);\n      }\n      return { toasts: [...s.toasts, t] };\n    }),\n  remove: (id) => set((s) => ({ toasts: s.toasts.filter((t) => t.id !== id) })),\n  clear: () => set({ toasts: [] }),\n}));\n\nexport function useToast() {\n  const push = useToastStore((s) => s.push);\n  return push;\n}\n","import { useToastStore } from \"../store/toast\";\n\nexport default function Toaster() {\n  const toasts = useToastStore((s) => s.toasts);\n  const remove = useToastStore((s) => s.remove);\n  if (!toasts.length) return null;\n  return (\n    <>\n      {/* Success messages centered */}\n      {toasts\n        .filter((t) => t.type === \"success\")\n        .map((t) => (\n          <div\n            key={t.id}\n            className=\"fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-50\"\n          >\n            <div\n              className={`p-4 rounded-lg shadow-lg border text-sm bg-emerald-700/90 border-emerald-500/60 text-white max-w-sm text-center`}\n            >\n              <div className=\"flex items-center justify-center gap-2\">\n                <span className=\"flex-1 font-semibold\">{t.message}</span>\n              </div>\n            </div>\n          </div>\n        ))}\n      {/* Other messages bottom right */}\n      {toasts.filter((t) => t.type !== \"success\").length > 0 && (\n        <div className=\"fixed bottom-4 right-4 z-50 space-y-2 sm:right-4 sm:left-auto left-1/2 -translate-x-1/2 sm:translate-x-0 w-[calc(100%-1.5rem)] sm:w-auto max-w-sm\">\n          {toasts\n            .filter((t) => t.type !== \"success\")\n            .map((t) => (\n              <div\n                key={t.id}\n                className={`p-3 rounded-lg shadow-lg border text-sm ${\n                  t.type === \"error\"\n                    ? \"bg-rose-700/80 border-rose-500/60 text-white\"\n                    : \"bg-black/70 border-slate-700 text-slate-100\"\n                }`}\n              >\n                <div className=\"flex items-center gap-2\">\n                  <span className=\"flex-1\">{t.message}</span>\n                  {t.actionLabel &&\n                  typeof (t as any).onAction === \"function\" ? (\n                    <button\n                      className=\"btn px-2 py-1 text-xs bg-slate-200/10 hover:bg-slate-200/20\"\n                      onClick={() => {\n                        try {\n                          (t as any).onAction?.();\n                        } catch {}\n                        remove(t.id);\n                      }}\n                    >\n                      {t.actionLabel}\n                    </button>\n                  ) : null}\n                  <button\n                    className=\"btn btn--ghost px-2 py-1 text-xs\"\n                    onClick={() => remove(t.id)}\n                  >\n                    Dismiss\n                  </button>\n                </div>\n              </div>\n            ))}\n        </div>\n      )}\n    </>\n  );\n}\n","import React from \"react\";\n\ntype Datum = { label: string | number; value: number };\n\nexport default function BarChart({\n  data,\n  height = 220,\n  barWidth = 28,\n  gap = 6,\n  showValues = false,\n}: {\n  data: Datum[];\n  height?: number;\n  barWidth?: number;\n  gap?: number;\n  showValues?: boolean;\n}) {\n  const max = Math.max(1, ...data.map((d) => d.value));\n  const totalWidth = data.length * (barWidth + gap);\n  return (\n    <div className=\"w-full overflow-x-auto\">\n      <div\n        className=\"relative\"\n        style={{ height, width: Math.max(600, totalWidth) }}\n      >\n        <div className=\"absolute inset-0 flex items-end\">\n          {data.map((d, i) => {\n            const h = Math.round((d.value / max) * (height - 40)); // leave room for labels\n            return (\n              <div\n                key={i}\n                className=\"flex flex-col items-center justify-end\"\n                style={{ width: barWidth, marginRight: gap }}\n              >\n                <div\n                  className=\"w-full rounded-t-md bg-gradient-to-b from-indigo-400 to-fuchsia-500 shadow-sm\"\n                  style={{ height: h }}\n                  title={`${d.label}: ${d.value}`}\n                />\n                {showValues && (\n                  <div className=\"text-sm mt-1 text-indigo-200 font-semibold\">\n                    {d.value}\n                  </div>\n                )}\n                <div className=\"text-sm mt-1 text-slate-200 font-medium select-none\">\n                  {d.label}\n                </div>\n              </div>\n            );\n          })}\n        </div>\n      </div>\n    </div>\n  );\n}\n","import React from \"react\";\n\ntype Tab = { key: string; label: string };\n\nexport default function TabPills({\n  tabs,\n  active,\n  onChange,\n  className,\n}: {\n  tabs: Tab[];\n  active: string;\n  onChange: (key: string) => void;\n  className?: string;\n}) {\n  return (\n    <div className={`relative ${className || \"\"}`}>\n      {/* subtle backdrop and border for contrast on mobile */}\n      <div className=\"absolute inset-0 rounded-xl bg-white/5 backdrop-blur-md border border-white/10 pointer-events-none\" />\n      <div className=\"relative overflow-x-auto no-scrollbar py-1 px-1\">\n        <div className=\"flex items-center gap-2 min-w-max\">\n          {tabs.map((t) => {\n            const isActive = t.key === active;\n            return (\n              <button\n                key={t.key}\n                type=\"button\"\n                onPointerDown={(e) => {\n                  (e as any).stopPropagation();\n                }}\n                onMouseDown={(e) => {\n                  e.stopPropagation();\n                }}\n                onTouchStart={(e) => {\n                  (e as any).stopPropagation?.();\n                }}\n                onClick={() => onChange(t.key)}\n                className={`transition-all select-none whitespace-nowrap rounded-full px-4 py-2 text-sm font-semibold shadow-sm focus:outline-none focus-visible:ring-2 focus-visible:ring-white/60 active:scale-[0.98]\n                  ${\n                    isActive\n                      ? \"bg-gradient-to-r from-indigo-500 to-fuchsia-500 text-white shadow-indigo-500/30\"\n                      : \"bg-white/10 text-slate-100 hover:bg-white/15\"\n                  }\n                `}\n                aria-pressed={isActive}\n              >\n                {t.label.includes(\"\") ? t.label : `${t.label} `}\n              </button>\n            );\n          })}\n        </div>\n      </div>\n      <style>{`\n        /* Hide scrollbars on WebKit/Firefox for a cleaner pill row */\n        .no-scrollbar::-webkit-scrollbar { display: none; }\n        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }\n      `}</style>\n    </div>\n  );\n}\n","import { broadcastMessage } from \"../utils/broadcast\";\nimport { resolveApiUrl } from \"../utils/api\";\nimport type { Player, Leg } from \"./match\";\n\nexport type AllTimeTotals = {\n  darts: number;\n  scored: number;\n  fnDarts?: number;\n  fnScored?: number;\n  // All-time quality metrics\n  best3?: number; // highest 3-dart avg achieved in a finished leg\n  worst3?: number; // lowest 3-dart avg achieved in a finished leg\n  bestLegDarts?: number; // fewest darts to finish a winning leg\n  bestCheckout?: number; // highest checkout score achieved\n  worstLegDarts?: number; // most darts in a winning leg (optional)\n  bestFNAvg?: number; // best per-leg first-nine average\n  worstFNAvg?: number; // worst per-leg first-nine average\n  num180s?: number;\n};\nexport type StatEntry = {\n  t: number;\n  darts: number;\n  scored: number;\n  fnDarts?: number;\n  fnScored?: number;\n};\nexport type GameModeStat = { played: number; won: number };\nexport type GameModeStats = Record<string, GameModeStat>;\n\nconst keyFor = (name: string) => `ndn_stats_${name}`;\nconst keySeriesFor = (name: string) => `ndn_stats_ts_${name}`;\nconst keyDailyFor = (name: string) => `ndn_stats_daily_${name}`;\nconst keyMetaFor = (name: string) => `ndn_stats_meta_${name}`;\n\ntype StatsMeta = { updatedAt: number };\ntype UserStatsPayload = {\n  updatedAt: number;\n  allTime: AllTimeTotals;\n  series: StatEntry[];\n  daily: DailySnapshot | null;\n  gameModes: GameModeStats;\n};\n\nconst syncTimers = new Map<string, number>();\nconst syncInFlight = new Set<string>();\n\nfunction getAuthToken(): string | null {\n  try {\n    return localStorage.getItem(\"authToken\");\n  } catch {\n    return null;\n  }\n}\n\nfunction getStatsMeta(name: string): StatsMeta {\n  try {\n    const raw = localStorage.getItem(keyMetaFor(name));\n    if (!raw) return { updatedAt: 0 };\n    const parsed = JSON.parse(raw || \"{}\");\n    return { updatedAt: Number(parsed.updatedAt) || 0 };\n  } catch {\n    return { updatedAt: 0 };\n  }\n}\n\nfunction setStatsMeta(name: string, meta: StatsMeta) {\n  try {\n    localStorage.setItem(keyMetaFor(name), JSON.stringify(meta));\n  } catch {}\n}\n\nfunction buildStatsPayload(name: string): UserStatsPayload {\n  return {\n    updatedAt: getStatsMeta(name).updatedAt || Date.now(),\n    allTime: getAllTime(name),\n    series: getStatSeries(name),\n    daily: getDailySnapshot(name),\n    gameModes: getGameModeStats(),\n  };\n}\n\nasync function pushStatsToServer(name: string) {\n  const token = getAuthToken();\n  if (!token || !name) return;\n  if (syncInFlight.has(name)) return;\n  syncInFlight.add(name);\n  try {\n    const payload = buildStatsPayload(name);\n    const url = resolveApiUrl(\"/api/user/stats\");\n    await fetch(url, {\n      method: \"POST\",\n      headers: {\n        \"Content-Type\": \"application/json\",\n        Authorization: `Bearer ${token}`,\n      },\n      body: JSON.stringify({ stats: payload }),\n    });\n  } catch {}\n  syncInFlight.delete(name);\n}\n\nfunction scheduleStatsSync(name: string) {\n  if (!name) return;\n  const existing = syncTimers.get(name);\n  if (existing) window.clearTimeout(existing);\n  const id = window.setTimeout(() => {\n    syncTimers.delete(name);\n    pushStatsToServer(name);\n  }, 2500);\n  syncTimers.set(name, id);\n}\n\nexport async function syncStatsFromServer(name: string) {\n  const token = getAuthToken();\n  if (!token || !name) return;\n\n  // Retry up to 3 times with exponential back-off so a cold-starting\n  // server or brief network hiccup doesn't cause a permanent miss.\n  const MAX_RETRIES = 3;\n  let res: Response | null = null;\n  for (let attempt = 0; attempt < MAX_RETRIES; attempt++) {\n    try {\n      const url = resolveApiUrl(\"/api/user/stats\");\n      res = await fetch(url, {\n        headers: { Authorization: `Bearer ${token}` },\n      });\n      if (res?.ok) break;\n      res = null;\n    } catch {\n      res = null;\n    }\n    // Wait before retrying (1s, 2s, 4s)\n    if (attempt < MAX_RETRIES - 1) {\n      await new Promise((r) => setTimeout(r, 1000 * Math.pow(2, attempt)));\n    }\n  }\n\n  if (!res || !res.ok) return;\n  try {\n    const data = await res.json().catch(() => ({}));\n    const remote = data?.stats as UserStatsPayload | undefined;\n\n    // If the server has no stats but we have local stats, push ours up so\n    // other devices can pull them.  This covers the case where stats were\n    // recorded before the sync fix was deployed.\n    if (!remote || !remote.updatedAt) {\n      const local = getAllTime(name);\n      if (local && (local.darts > 0 || local.scored > 0)) {\n        setStatsMeta(name, { updatedAt: Date.now() });\n        pushStatsToServer(name);\n      }\n      return;\n    }\n\n    const localMeta = getStatsMeta(name);\n    if (remote.updatedAt > (localMeta.updatedAt || 0)) {\n      setAllTime(name, remote.allTime || { darts: 0, scored: 0 }, {\n        skipSync: true,\n      });\n      setSeries(name, remote.series || [], { skipSync: true });\n      if (remote.daily)\n        setDailySnapshot(name, remote.daily, { skipSync: true });\n      if (remote.gameModes)\n        setGameModeStats(remote.gameModes, { skipSync: true });\n      setStatsMeta(name, { updatedAt: remote.updatedAt });\n    } else if (localMeta.updatedAt > remote.updatedAt) {\n      scheduleStatsSync(name);\n    }\n  } catch {}\n}\n\nexport function getAllTime(name: string): AllTimeTotals {\n  try {\n    const raw = localStorage.getItem(keyFor(name));\n    if (!raw) return { darts: 0, scored: 0 };\n    const parsed = JSON.parse(raw);\n    return {\n      darts: Number(parsed.darts) || 0,\n      scored: Number(parsed.scored) || 0,\n      fnDarts: Number(parsed.fnDarts) || 0,\n      fnScored: Number(parsed.fnScored) || 0,\n      best3: typeof parsed.best3 === \"number\" ? parsed.best3 : 0,\n      worst3: typeof parsed.worst3 === \"number\" ? parsed.worst3 : 0,\n      bestLegDarts:\n        typeof parsed.bestLegDarts === \"number\" ? parsed.bestLegDarts : 0,\n      bestCheckout:\n        typeof parsed.bestCheckout === \"number\" ? parsed.bestCheckout : 0,\n      worstLegDarts:\n        typeof parsed.worstLegDarts === \"number\" ? parsed.worstLegDarts : 0,\n      bestFNAvg: typeof parsed.bestFNAvg === \"number\" ? parsed.bestFNAvg : 0,\n      worstFNAvg: typeof parsed.worstFNAvg === \"number\" ? parsed.worstFNAvg : 0,\n      num180s: typeof parsed.num180s === \"number\" ? parsed.num180s : 0,\n    };\n  } catch {\n    return { darts: 0, scored: 0 };\n  }\n}\n\nexport function setAllTime(\n  name: string,\n  totals: AllTimeTotals,\n  opts?: { skipSync?: boolean },\n) {\n  try {\n    localStorage.setItem(keyFor(name), JSON.stringify(totals));\n    window.dispatchEvent(\n      new CustomEvent(\"ndn:stats-updated\", { detail: { name, totals } }),\n    );\n    // Notify other tabs/windows so headers and panels refresh immediately\n    try {\n      broadcastMessage({ type: \"statsUpdated\", name, totals });\n    } catch {}\n  } catch {}\n  if (!opts?.skipSync) {\n    setStatsMeta(name, { updatedAt: Date.now() });\n    scheduleStatsSync(name);\n  }\n}\n\n// Clear all stored stats for a user (all-time totals, time-series, and daily snapshot)\nexport function clearAllStats(name: string) {\n  try {\n    localStorage.removeItem(keyFor(name));\n    localStorage.removeItem(keySeriesFor(name));\n    localStorage.removeItem(keyDailyFor(name));\n  } catch {}\n  try {\n    window.dispatchEvent(\n      new CustomEvent(\"ndn:stats-updated\", { detail: { name, cleared: true } }),\n    );\n  } catch {}\n}\n\nexport function getAllTimeAvg(name: string): number {\n  const { darts, scored } = getAllTime(name);\n  if (!darts) return 0;\n  return (scored / darts) * 3;\n}\n\nexport function getAllTimeFirstNineAvg(name: string): number {\n  const { fnDarts = 0, fnScored = 0 } = getAllTime(name);\n  if (!fnDarts) return 0;\n  return (fnScored / fnDarts) * 3;\n}\n\n// All-time quality metric getters\nexport function getAllTimeBestWorst(name: string): {\n  best3: number;\n  worst3: number;\n} {\n  const { best3 = 0, worst3 = 0 } = getAllTime(name);\n  return { best3, worst3 };\n}\nexport function getAllTimeBestLeg(name: string): number {\n  const { bestLegDarts = 0 } = getAllTime(name);\n  return bestLegDarts || 0;\n}\nexport function getAllTimeBestCheckout(name: string): number {\n  const { bestCheckout = 0 } = getAllTime(name);\n  return bestCheckout || 0;\n}\n\nexport function getAllTime180s(name: string): number {\n  const { num180s = 0 } = getAllTime(name);\n  return Number(num180s || 0);\n}\n\n// --- Per-game-mode played/won stats (local-only demo) ---\nconst keyGameModes = \"ndn_game_mode_stats\";\n\nexport function getGameModeStats(allModeKeys?: string[]): GameModeStats {\n  let obj: GameModeStats = {};\n  try {\n    const raw = localStorage.getItem(keyGameModes);\n    if (raw) obj = JSON.parse(raw);\n  } catch {}\n  // Ensure requested keys exist with zeros so charts are stable\n  if (Array.isArray(allModeKeys)) {\n    for (const k of allModeKeys) {\n      if (!obj[k]) obj[k] = { played: 0, won: 0 };\n    }\n  }\n  return obj;\n}\n\nexport function setGameModeStats(\n  stats: GameModeStats,\n  opts?: { skipSync?: boolean },\n) {\n  try {\n    localStorage.setItem(keyGameModes, JSON.stringify(stats));\n    window.dispatchEvent(\n      new CustomEvent(\"ndn:stats-updated\", { detail: { gameModes: true } }),\n    );\n  } catch {}\n  if (!opts?.skipSync) {\n    const stored = localStorage.getItem(\"ndn:currentUser\") || \"\";\n    if (stored) {\n      setStatsMeta(stored, { updatedAt: Date.now() });\n      scheduleStatsSync(stored);\n    }\n  }\n}\n\nexport function bumpGameMode(mode: string, won: boolean) {\n  const current = getGameModeStats();\n  const entry = current[mode] || { played: 0, won: 0 };\n  entry.played += 1;\n  if (won) entry.won += 1;\n  current[mode] = entry;\n  setGameModeStats(current);\n}\n\n// Time-series helpers for rolling averages\nfunction getSeries(name: string): StatEntry[] {\n  try {\n    const raw = localStorage.getItem(keySeriesFor(name));\n    if (!raw) return [];\n    const arr = JSON.parse(raw);\n    if (!Array.isArray(arr)) return [];\n    return arr\n      .map((e: any) => ({\n        t: Number(e.t) || 0,\n        darts: Number(e.darts) || 0,\n        scored: Number(e.scored) || 0,\n        fnDarts: Number(e.fnDarts) || 0,\n        fnScored: Number(e.fnScored) || 0,\n      }))\n      .filter((e) => e.t > 0);\n  } catch {\n    return [];\n  }\n}\n\nfunction setSeries(\n  name: string,\n  entries: StatEntry[],\n  opts?: { skipSync?: boolean },\n) {\n  try {\n    localStorage.setItem(keySeriesFor(name), JSON.stringify(entries));\n    window.dispatchEvent(\n      new CustomEvent(\"ndn:stats-updated\", { detail: { name } }),\n    );\n  } catch {}\n  if (!opts?.skipSync) {\n    setStatsMeta(name, { updatedAt: Date.now() });\n    scheduleStatsSync(name);\n  }\n}\n\nexport function getStatSeries(name: string): StatEntry[] {\n  return getSeries(name);\n}\n\nfunction pruneOld(entries: StatEntry[], maxAgeMs: number): StatEntry[] {\n  const now = Date.now();\n  return entries.filter((e) => now - e.t <= maxAgeMs);\n}\n\nexport function addSample(\n  name: string,\n  darts: number,\n  scored: number,\n  when: number = Date.now(),\n  fnDarts?: number,\n  fnScored?: number,\n) {\n  if (darts <= 0) return;\n  const list = getSeries(name);\n  const next = pruneOld(\n    [...list, { t: when, darts, scored, fnDarts, fnScored }],\n    1000 * 60 * 60 * 24 * 30,\n  ); // keep ~30 days\n  setSeries(name, next);\n}\n\nexport function getRollingAvg(\n  name: string,\n  windowMs: number = 1000 * 60 * 60 * 24,\n): number {\n  const list = getSeries(name);\n  if (!list.length) return 0;\n  const now = Date.now();\n  let darts = 0,\n    scored = 0;\n  for (const e of list) {\n    if (now - e.t <= windowMs) {\n      darts += e.darts;\n      scored += e.scored;\n    }\n  }\n  if (darts <= 0) return 0;\n  return (scored / darts) * 3;\n}\n\nexport function getRollingFirstNineAvg(\n  name: string,\n  windowMs: number = 1000 * 60 * 60 * 24 * 30,\n): number {\n  const list = getSeries(name);\n  if (!list.length) return 0;\n  const now = Date.now();\n  let darts = 0,\n    scored = 0;\n  for (const e of list) {\n    if (now - e.t <= windowMs) {\n      darts += e.fnDarts || 0;\n      scored += e.fnScored || 0;\n    }\n  }\n  if (darts <= 0) return 0;\n  return (scored / darts) * 3;\n}\n\n// Daily adjusted average: recompute from last 24h at most once per 24h and persist the last value\ntype DailySnapshot = { avg: number; ts: number };\n\nfunction getDailySnapshot(name: string): DailySnapshot | null {\n  try {\n    const raw = localStorage.getItem(keyDailyFor(name));\n    if (!raw) return null;\n    const j = JSON.parse(raw);\n    return { avg: Number(j.avg) || 0, ts: Number(j.ts) || 0 };\n  } catch {\n    return null;\n  }\n}\n\nfunction setDailySnapshot(\n  name: string,\n  snap: DailySnapshot,\n  opts?: { skipSync?: boolean },\n) {\n  try {\n    localStorage.setItem(keyDailyFor(name), JSON.stringify(snap));\n    window.dispatchEvent(\n      new CustomEvent(\"ndn:stats-updated\", { detail: { name } }),\n    );\n  } catch {}\n  if (!opts?.skipSync) {\n    setStatsMeta(name, { updatedAt: Date.now() });\n    scheduleStatsSync(name);\n  }\n}\n\nexport function getDailyAdjustedAvg(name: string): number {\n  const snap = getDailySnapshot(name);\n  const now = Date.now();\n  const DAY = 1000 * 60 * 60 * 24;\n  if (snap && now - snap.ts < DAY) return snap.avg;\n  // Need to compute a new daily value from the last 24h of samples\n  const ra = getRollingAvg(name, DAY);\n  const next: DailySnapshot = { avg: ra, ts: now };\n  setDailySnapshot(name, next);\n  return ra;\n}\n\n// Convenience helpers for monthly (last ~30 days) averages\nexport function getMonthlyAvg3(name: string): number {\n  const THIRTY_DAYS = 1000 * 60 * 60 * 24 * 30;\n  const list = getSeries(name);\n  if (!list.length) return 0;\n  const now = Date.now();\n  // Prefer match-aggregated entries (those with fnDarts defined) to avoid double counting with per-visit samples\n  const windowed = list.filter((e) => now - e.t <= THIRTY_DAYS);\n  const matchOnly = windowed.filter((e) => typeof e.fnDarts === \"number\");\n  const use = matchOnly.length ? matchOnly : windowed;\n  let darts = 0,\n    scored = 0;\n  for (const e of use) {\n    darts += e.darts;\n    scored += e.scored;\n  }\n  if (darts <= 0) return 0;\n  return (scored / darts) * 3;\n}\nexport function getMonthlyFirstNineAvg(name: string): number {\n  const THIRTY_DAYS = 1000 * 60 * 60 * 24 * 30;\n  return getRollingFirstNineAvg(name, THIRTY_DAYS);\n}\n\n// Update all players' all-time totals given a finished match roster\nexport function addMatchToAllTime(\n  players: Player[],\n  opts?: { recordSeries?: boolean },\n) {\n  const recordSeries = opts?.recordSeries !== false;\n  // Resolve the signed-in username (if present) to map generic aliases like \"You\"\n  // back to the user so header stats update correctly.\n  let canonicalUser: string | null = null;\n  try {\n    const stored = localStorage.getItem(\"ndn:currentUser\");\n    if (stored) canonicalUser = stored;\n    else if (typeof (window as any)?.ndnCurrentUser === \"string\")\n      canonicalUser = (window as any).ndnCurrentUser;\n  } catch {}\n\n  for (const raw of players) {\n    // Normalize player name: map \"You\" (and blank) to canonical user when known\n    const p: Player = { ...raw };\n    if (canonicalUser) {\n      const n = (p.name || \"\").trim();\n      if (!n || n.toLowerCase() === \"you\") p.name = canonicalUser;\n    }\n    // Sum over finished legs\n    let darts = 0;\n    let scored = 0;\n    let fnDarts = 0;\n    let fnScored = 0;\n    let matchStart = Number.POSITIVE_INFINITY;\n    let matchEnd = 0;\n    // Per-match quality metrics\n    let matchBest3 = 0;\n    let matchWorst3 = 0;\n    let matchBestLegDarts = 0; // track fewest darts on a winning leg only\n    let matchBestCheckout = 0;\n    let matchWorstLegDarts = 0; // most darts on a winning leg\n    let matchBestFNAvg = 0;\n    let matchWorstFNAvg = 0;\n    let match180s = 0;\n    for (const leg of p.legs) {\n      if (!leg.finished) continue;\n      darts += leg.dartsThrown;\n      scored += Math.max(0, leg.totalScoreStart - leg.totalScoreRemaining);\n      // First nine darts aggregation (or fewer if leg ended earlier)\n      const { d: legFnDarts, s: legFnScored } = sumFirstNine(leg);\n      fnDarts += legFnDarts;\n      fnScored += legFnScored;\n      // Quality metrics per leg\n      const legDarts = Math.max(0, leg.dartsThrown);\n      const legScored = Math.max(\n        0,\n        leg.totalScoreStart - leg.totalScoreRemaining,\n      );\n      const legAvg = legDarts > 0 ? (legScored / legDarts) * 3 : 0;\n      const legFNAvg = legFnDarts > 0 ? (legFnScored / legFnDarts) * 3 : 0;\n      if (legAvg > 0) {\n        matchBest3 = Math.max(matchBest3, legAvg);\n        matchWorst3 =\n          matchWorst3 === 0 ? legAvg : Math.min(matchWorst3, legAvg);\n      }\n      if (legFNAvg > 0) {\n        matchBestFNAvg = Math.max(matchBestFNAvg, legFNAvg);\n        matchWorstFNAvg =\n          matchWorstFNAvg === 0\n            ? legFNAvg\n            : Math.min(matchWorstFNAvg, legFNAvg);\n      }\n      const wasCheckout = leg.totalScoreRemaining === 0;\n      if (wasCheckout) {\n        if (matchBestLegDarts === 0 || legDarts < matchBestLegDarts)\n          matchBestLegDarts = legDarts;\n        if (matchWorstLegDarts === 0 || legDarts > matchWorstLegDarts)\n          matchWorstLegDarts = legDarts;\n        const co =\n          typeof leg.checkoutScore === \"number\" ? leg.checkoutScore : 0;\n        if (co > matchBestCheckout) matchBestCheckout = co;\n      }\n      // Track time window for this match (for rolling stats backfill)\n      const legStart = Number(leg.startTime || 0);\n      const legEnd = Number(leg.endTime || 0) || legStart || Date.now();\n      if (legStart > 0) matchStart = Math.min(matchStart, legStart);\n      if (legEnd > 0) matchEnd = Math.max(matchEnd, legEnd);\n      // Count 180s from visits\n      try {\n        for (const v of leg.visits || []) {\n          if (Number(v.score || 0) === 180) match180s += 1;\n        }\n      } catch {}\n    }\n    if (darts > 0) {\n      const prev = getAllTime(p.name);\n      const next: AllTimeTotals = {\n        darts: prev.darts + darts,\n        scored: prev.scored + scored,\n        fnDarts: (prev.fnDarts || 0) + fnDarts,\n        fnScored: (prev.fnScored || 0) + fnScored,\n        best3: Math.max(prev.best3 || 0, matchBest3 || 0),\n        // For worst3, treat 0 as \"unset\"; choose the min positive across history\n        worst3: (() => {\n          const prior = prev.worst3 || 0;\n          if (prior === 0) return matchWorst3 || 0;\n          if (matchWorst3 === 0) return prior;\n          return Math.min(prior, matchWorst3);\n        })(),\n        // Fewest darts on winning leg; 0 means no winning legs recorded yet\n        bestLegDarts: (() => {\n          const prior = prev.bestLegDarts || 0;\n          if (prior === 0) return matchBestLegDarts || 0;\n          if (matchBestLegDarts === 0) return prior;\n          return Math.min(prior, matchBestLegDarts);\n        })(),\n        bestCheckout: Math.max(prev.bestCheckout || 0, matchBestCheckout || 0),\n        worstLegDarts: (() => {\n          const prior = prev.worstLegDarts || 0;\n          if (prior === 0) return matchWorstLegDarts || 0;\n          if (matchWorstLegDarts === 0) return prior;\n          return Math.max(prior, matchWorstLegDarts);\n        })(),\n        bestFNAvg: Math.max(prev.bestFNAvg || 0, matchBestFNAvg || 0),\n        worstFNAvg: (() => {\n          const prior = prev.worstFNAvg || 0;\n          if (prior === 0) return matchWorstFNAvg || 0;\n          if (matchWorstFNAvg === 0) return prior;\n          return Math.min(prior, matchWorstFNAvg);\n        })(),\n        num180s: (prev.num180s || 0) + (match180s || 0),\n      };\n      setAllTime(p.name, next);\n      // Also add a time-series sample for rolling averages (avoid double\n      // counting if per-visit samples were recorded during this match).\n      if (recordSeries) {\n        const series = getSeries(p.name);\n        const start = Number.isFinite(matchStart) ? matchStart : Date.now();\n        const end = matchEnd > 0 ? matchEnd : start;\n        const pad = 5000;\n        const hasSamplesInWindow = series.some(\n          (e) => e.t >= start - pad && e.t <= end + pad,\n        );\n        if (!hasSamplesInWindow) {\n          addSample(p.name, darts, scored, end, fnDarts, fnScored);\n        }\n      }\n    }\n  }\n}\n\n// Helper: sum points and darts for the first 9 darts of a leg (or fewer if finished earlier)\nfunction sumFirstNine(leg: Leg): { d: number; s: number } {\n  let remain = Math.min(9, leg.dartsThrown);\n  if (remain <= 0) return { d: 0, s: 0 };\n  let s = 0;\n  for (const v of leg.visits) {\n    if (remain <= 0) break;\n    const take = Math.min(remain, v.darts);\n    // Pro-rate score if partial darts from a visit are included\n    if (take === v.darts) s += v.score;\n    else s += Math.round((v.score / v.darts) * take);\n    remain -= take;\n  }\n  const d = Math.min(9, leg.dartsThrown);\n  return { d, s };\n}\n","export const freeGames = [\"X01\", \"Double Practice\"] as const;\nexport type ModeKey =\n  | \"bestof\"\n  | \"firstto\"\n  | \"rounds\"\n  | \"practice\"\n  | \"none\"\n  | \"innings\"\n  | \"holes\";\nexport interface GameConfig {\n  startOptions: number[];\n  modeOptions: ModeKey[];\n  modeValueOptions?: Partial<Record<ModeKey, number[]>>;\n}\nexport const premiumGames = [\n  \"Around the Clock\",\n  \"Cricket\",\n  \"Halve It\",\n  \"Shanghai\",\n  \"High-Low\",\n  \"Killer\",\n  \"Bob's 27\",\n  \"Count-Up\",\n  \"High Score\",\n  \"Low Score\",\n  \"Checkout 170\",\n  \"Checkout 121\",\n  \"Treble Practice\",\n  \"Baseball\",\n  \"Golf\",\n  \"Tic Tac Toe\",\n  \"American Cricket\",\n  \"Scam\",\n  \"Fives\",\n  \"Sevens\",\n] as const;\nexport type GameKey =\n  | (typeof freeGames)[number]\n  | (typeof premiumGames)[number];\nexport const allGames: GameKey[] = [...freeGames, ...premiumGames];\n\n// Per-game configuration for UI helpers and filtering\nexport const gameConfig: Record<GameKey, GameConfig> = {\n  X01: {\n    startOptions: [301, 501, 701],\n    modeOptions: [\"bestof\", \"firstto\"],\n    modeValueOptions: { bestof: [1, 3, 5, 7], firstto: [1, 2, 3, 4, 5, 6] },\n  },\n  \"Double Practice\": {\n    startOptions: [],\n    modeOptions: [\"practice\"],\n    modeValueOptions: { practice: [30, 60, 120] },\n  },\n  \"Around the Clock\": {\n    startOptions: [],\n    modeOptions: [\"bestof\", \"firstto\"],\n    modeValueOptions: { bestof: [1, 3, 5], firstto: [1, 2, 3, 4] },\n  },\n  Cricket: {\n    startOptions: [],\n    modeOptions: [\"bestof\", \"firstto\", \"rounds\"],\n    modeValueOptions: {\n      bestof: [1, 3, 5],\n      firstto: [1, 2, 3, 4],\n      rounds: [1, 3, 5],\n    },\n  },\n  \"Halve It\": {\n    startOptions: [],\n    modeOptions: [\"bestof\", \"firstto\"],\n    modeValueOptions: { bestof: [1, 3, 5], firstto: [1, 2, 3, 4] },\n  },\n  Shanghai: {\n    startOptions: [],\n    modeOptions: [\"bestof\", \"firstto\"],\n    modeValueOptions: { bestof: [1, 3, 5], firstto: [1, 2, 3, 4] },\n  },\n  \"High-Low\": {\n    startOptions: [],\n    modeOptions: [\"bestof\", \"firstto\"],\n    modeValueOptions: { bestof: [1, 3, 5], firstto: [1, 2, 3, 4] },\n  },\n  Killer: {\n    startOptions: [],\n    modeOptions: [\"bestof\", \"firstto\"],\n    modeValueOptions: { bestof: [1, 3, 5], firstto: [1, 2, 3, 4] },\n  },\n  \"Bob's 27\": {\n    startOptions: [],\n    modeOptions: [\"bestof\", \"firstto\"],\n    modeValueOptions: { bestof: [1, 3, 5], firstto: [1, 2, 3, 4] },\n  },\n  \"Count-Up\": {\n    startOptions: [],\n    modeOptions: [\"bestof\", \"firstto\"],\n    modeValueOptions: { bestof: [1, 3, 5], firstto: [1, 2, 3, 4] },\n  },\n  \"High Score\": {\n    startOptions: [],\n    modeOptions: [\"bestof\", \"firstto\"],\n    modeValueOptions: { bestof: [1, 3, 5], firstto: [1, 2, 3, 4] },\n  },\n  \"Low Score\": {\n    startOptions: [],\n    modeOptions: [\"bestof\", \"firstto\"],\n    modeValueOptions: { bestof: [1, 3, 5], firstto: [1, 2, 3, 4] },\n  },\n  \"Checkout 170\": {\n    startOptions: [],\n    modeOptions: [\"bestof\", \"firstto\"],\n    modeValueOptions: { bestof: [1, 3, 5], firstto: [1, 2, 3, 4] },\n  },\n  \"Checkout 121\": {\n    startOptions: [],\n    modeOptions: [\"bestof\", \"firstto\"],\n    modeValueOptions: { bestof: [1, 3, 5], firstto: [1, 2, 3, 4] },\n  },\n  \"Treble Practice\": {\n    startOptions: [],\n    modeOptions: [\"practice\"],\n    modeValueOptions: { practice: [30, 60, 120] },\n  },\n  Baseball: {\n    startOptions: [],\n    modeOptions: [\"bestof\", \"innings\"],\n    modeValueOptions: { bestof: [1, 3, 5], innings: [1, 3, 5, 9] },\n  },\n  Golf: {\n    startOptions: [],\n    modeOptions: [\"holes\", \"bestof\"],\n    modeValueOptions: { holes: [9, 18], bestof: [1, 3, 5] },\n  },\n  \"Tic Tac Toe\": {\n    startOptions: [],\n    modeOptions: [\"bestof\", \"firstto\"],\n    modeValueOptions: { bestof: [1, 3, 5], firstto: [1, 2, 3, 4] },\n  },\n  \"American Cricket\": {\n    startOptions: [],\n    modeOptions: [\"bestof\", \"firstto\"],\n    modeValueOptions: { bestof: [1, 3, 5], firstto: [1, 2, 3, 4] },\n  },\n  Scam: {\n    startOptions: [],\n    modeOptions: [\"bestof\", \"firstto\"],\n    modeValueOptions: { bestof: [1, 3, 5], firstto: [1, 2, 3, 4] },\n  },\n  Fives: {\n    startOptions: [],\n    modeOptions: [\"bestof\", \"firstto\"],\n    modeValueOptions: { bestof: [1, 3, 5], firstto: [1, 2, 3, 4] },\n  },\n  Sevens: {\n    startOptions: [],\n    modeOptions: [\"bestof\", \"firstto\"],\n    modeValueOptions: { bestof: [1, 3, 5], firstto: [1, 2, 3, 4] },\n  },\n};\n\nexport function getStartOptionsForGame(g: \"all\" | GameKey): number[] {\n  if (g === \"all\") return [301, 501, 701];\n  const cfg = gameConfig[g];\n  return cfg?.startOptions ?? [];\n}\n\nexport function getModeOptionsForGame(g: \"all\" | GameKey): (ModeKey | \"all\")[] {\n  if (g === \"all\") return [\"all\", \"bestof\", \"firstto\"];\n  const cfg = gameConfig[g];\n  if (!cfg) return [\"all\", \"bestof\", \"firstto\"];\n  return [\"all\", ...cfg.modeOptions];\n}\n\nexport function getModeValueOptionsForGame(\n  g: \"all\" | GameKey,\n  mode: ModeKey | \"all\",\n): number[] {\n  if (g === \"all\" || mode === \"all\") return [];\n  const cfg = gameConfig[g];\n  return cfg?.modeValueOptions?.[mode] ?? [];\n}\n\nexport function labelForMode(opt: string | undefined | null) {\n  if (!opt) return \"\";\n  switch (opt) {\n    case \"all\":\n      return \"All Modes\";\n    case \"bestof\":\n      return \"Best of\";\n    case \"firstto\":\n      return \"First to\";\n    case \"innings\":\n      return \"Innings\";\n    case \"holes\":\n      return \"Holes\";\n    case \"rounds\":\n      return \"Rounds\";\n    case \"practice\":\n      return \"Practice\";\n    case \"none\":\n      return \"Mode\";\n    default:\n      return String(opt)\n        .replace(/[-_]/g, \" \")\n        .replace(/\\b\\w/g, (s) => s.toUpperCase());\n  }\n}\n","// Centralized, simple, consistent symbols for the UI.\n// Keep these ASCII/Unicode-simple to avoid emoji rendering and encoding/mojibake issues.\n\nexport const UI_SYMBOL = {\n  // Basic punctuation/status\n  dash: \"\",\n  bullet: \"\",\n  middot: \"\",\n  ellipsis: \"\",\n\n  // Status icons\n  ok: \"\",\n  no: \"\",\n  warn: \"!\",\n  info: \"i\",\n\n  // Misc\n  lock: \"LOCK\",\n  refresh: \"\",\n  camera: \"CAM\",\n  target: \"\",\n  spinner: \"\",\n} as const;\n\nexport type UiSymbolName = keyof typeof UI_SYMBOL;\n\nexport function sym(name: UiSymbolName): (typeof UI_SYMBOL)[UiSymbolName] {\n  return UI_SYMBOL[name];\n}\n","import { useEffect } from \"react\";\nimport { useCameraSession } from \"../store/cameraSession\";\nimport { sym } from \"../ui/icons\";\n\n/**\n * CameraStatusBadge\n * Compact header badge indicating camera streaming status.\n * NO longer renders a live thumbnail in the header  keeps the camera warm offscreen\n * while freeing up header space. Clicking toggles the global phone overlay.\n */\nexport default function CameraStatusBadge() {\n  const camera = useCameraSession();\n  const sessionStream = camera.getMediaStream?.();\n  const videoEl = camera.getVideoElementRef();\n  const hasActiveStream = !!(sessionStream || videoEl?.srcObject);\n  const streaming = camera.isStreaming && hasActiveStream;\n  const statusLabel = streaming ? \"Camera Active\" : \"Camera Offline\";\n\n  // Keep an effect so screen readers get updates when streaming state changes\n  useEffect(() => {\n    // no-op; dependency ensures component updates when camera state changes\n  }, [streaming]);\n\n  const onClick = () => {\n    try {\n      window.dispatchEvent(new CustomEvent(\"ndn:toggle-phone-overlay\"));\n    } catch (e) {}\n  };\n\n  return (\n    <button\n      type=\"button\"\n      onClick={onClick}\n      className=\"relative inline-flex items-center gap-2 rounded-lg border border-white/15 bg-white/5 hover:bg-white/10 transition-colors shadow-sm px-3 py-1 text-xs\"\n      title={\n        streaming\n          ? \"Camera connected   click to toggle overlay\"\n          : \"Camera not connected \"\n      }\n    >\n      <span className=\"font-mono text-[0.75rem]\">{sym(\"camera\")}</span>\n      <span className=\"hidden xs:inline text-slate-100 select-none\">\n        {statusLabel}\n      </span>\n      <span\n        className={`ml-2 w-2 h-2 rounded-full shrink-0 ${streaming ? \"bg-emerald-400\" : \"bg-rose-400\"}`}\n        aria-hidden\n      />\n    </button>\n  );\n}\n","// Help Desk AI - Provides intelligent responses to common questions\nexport const HELP_TOPICS = {\n  calibration: {\n    keywords: [\n      \"calibration\",\n      \"calibrate\",\n      \"camera\",\n      \"score\",\n      \"accuracy\",\n      \"aim\",\n      \"setup\",\n    ],\n    title: \"How Calibration Works\",\n    explanation: `Calibration helps our AI precisely detect where your darts land on the board. Here's how it works:\n\n1. **D20**: Click on the 20 segment to calibrate that area\n2. **D6**: Click on the 6 segment to calibrate that area\n3. **D3**: Click on the 3 segment to calibrate that area\n4. **D11**: Click on the 11 segment to calibrate that area\n5. **Bullseye**: Click on the bullseye to calibrate the center\n\nEach click teaches the system about your board's position and angle. After calibrating all areas, your scoring will be much more accurate!`,\n    actions: [\n      { id: \"D20\", label: \" Click D20\", color: \"bg-blue-600\" },\n      { id: \"D6\", label: \" Click D6\", color: \"bg-purple-600\" },\n      { id: \"D3\", label: \" Click D3\", color: \"bg-pink-600\" },\n      { id: \"D11\", label: \" Click D11\", color: \"bg-cyan-600\" },\n      { id: \"Bullseye\", label: \" Click Bullseye\", color: \"bg-yellow-600\" },\n    ],\n  },\n  scoring: {\n    keywords: [\n      \"score\",\n      \"points\",\n      \"counting\",\n      \"how do i score\",\n      \"scoring system\",\n    ],\n    title: \"Dart Scoring\",\n    explanation: `In darts, each segment on the board has a value:\n- Single areas: Face value (1-20)\n- Double ring (outer): 2 the segment number\n- Triple ring (inner): 3 the segment number\n- Bullseye: 50 points\n- Bull (outer bull): 25 points\n\nFor example: hitting Triple 20 = 60 points, Double 10 = 20 points`,\n  },\n  gameplay: {\n    keywords: [\n      \"game\",\n      \"how to play\",\n      \"rules\",\n      \"x01\",\n      \"cricket\",\n      \"match\",\n      \"round\",\n    ],\n    title: \"How to Play\",\n    explanation: `Nine Dart Nation supports multiple game modes:\n\n**X01** (501, 301, 701): Start from the set score and count down to exactly 0. Final dart must be on a double.\n\n**Cricket**: Players try to \"close\" numbers 15-20 and bullseye by hitting them. First to close all and have the highest score wins.\n\n**Killer**: Players mark their \"number\" and try to knock out other players' lives.\n\nSelect your game mode when creating a match, and follow the on-screen instructions!`,\n  },\n  premium: {\n    keywords: [\n      \"premium\",\n      \"subscription\",\n      \"features\",\n      \"upgrade\",\n      \"cost\",\n      \"paid\",\n    ],\n    title: \"Premium Features\",\n    explanation: `Our Premium subscription gives you:\n- Tournament creation and entry\n- Advanced statistics and replays\n- Priority matchmaking\n- Custom profiles and themes\n- Ad-free experience\n\nPremium grants are often awarded as tournament prizes!`,\n  },\n  connection: {\n    keywords: [\n      \"connection\",\n      \"disconnect\",\n      \"lag\",\n      \"latency\",\n      \"websocket\",\n      \"error\",\n      \"offline\",\n    ],\n    title: \"Connection Issues\",\n    explanation: `If you're experiencing connection issues:\n1. Check your internet connection\n2. Refresh the page (Ctrl+R or Cmd+R)\n3. Clear browser cache\n4. Try a different browser\n5. Check if the site status page shows any issues\n\nMost connection issues resolve in seconds. Contact admin if problems persist.`,\n  },\n  camera: {\n    keywords: [\n      \"camera\",\n      \"phone camera\",\n      \"mobile\",\n      \"video\",\n      \"pairing\",\n      \"connect\",\n    ],\n    title: \"Camera Setup\",\n    explanation: `To use our phone camera feature:\n1. Open Nine Dart Nation on your phone\n2. Go to Settings > Camera Pairing\n3. Scan the QR code or enter the pairing code\n4. Position your phone to capture the dartboard\n5. Run calibration (see calibration help for details)\n\nYour phone will now act as a live dartboard camera!`,\n  },\n  tournament: {\n    keywords: [\n      \"tournament\",\n      \"compete\",\n      \"bracket\",\n      \"prize\",\n      \"winner\",\n      \"playoffs\",\n    ],\n    title: \"Tournaments\",\n    explanation: `Tournaments are competitive events where you can:\n- Play against other skilled players\n- Win prizes (Premium subscriptions)\n- Climb leaderboards\n- Compete in structured brackets\n\nCheck the Tournaments tab to see upcoming events. Registration typically opens 30 minutes before start time.`,\n  },\n};\n\nexport interface AIResponse {\n  type: \"explanation\" | \"suggestion\" | \"escalate\";\n  title: string;\n  message: string;\n  actions?: Array<{ id: string; label: string; color: string }>;\n  followUp?: string;\n}\n\nexport function analyzeUserQuestion(question: string): AIResponse | null {\n  const lowerQ = question.toLowerCase();\n\n  // Find matching topic\n  for (const [, topic] of Object.entries(HELP_TOPICS)) {\n    for (const keyword of topic.keywords) {\n      if (lowerQ.includes(keyword)) {\n        return {\n          type: \"explanation\",\n          title: topic.title,\n          message: topic.explanation,\n          actions: (topic as any).actions,\n          followUp:\n            \"Do you need further assistance? I can connect you with an admin if needed.\",\n        };\n      }\n    }\n  }\n\n  // No match found - suggest escalation\n  return {\n    type: \"suggestion\",\n    title: \"Need More Help?\",\n    message: `I couldn't find a specific answer to your question. Common topics I can help with:\\n\\n${Object.values(\n      HELP_TOPICS,\n    )\n      .map((t) => ` ${t.title}`)\n      .join(\"\\n\")}\\n\\nOr I can connect you with an admin who can help further.`,\n    followUp: \"Would you like to speak with an admin?\",\n  };\n}\n\nexport function getEstimatedWaitTime(): string {\n  const hour = new Date().getHours();\n\n  if (hour >= 20 || hour < 7) {\n    return \"20-30 minutes (off-peak hours)\";\n  } else if (hour >= 12 && hour < 14) {\n    return \"10-15 minutes (moderate traffic)\";\n  } else if (hour >= 18 && hour < 20) {\n    return \"15-20 minutes (peak hours)\";\n  } else {\n    return \"5-10 minutes\";\n  }\n}\n","import React, { useEffect, useState, useRef, useCallback } from \"react\";\nimport { useWS } from \"./WSProvider\";\nimport { X, Send, Zap, User } from \"lucide-react\";\nimport { analyzeUserQuestion, getEstimatedWaitTime } from \"../utils/helpDeskAI\";\n\nexport default function HelpdeskChat({\n  request,\n  user,\n  onClose,\n}: {\n  request: any;\n  user: any;\n  onClose?: () => void;\n}) {\n  const ws = (() => {\n    try {\n      return useWS();\n    } catch {\n      return null;\n    }\n  })();\n  const [messages, setMessages] = useState<any[]>(request?.messages || []);\n  const [input, setInput] = useState(\"\");\n  const [typingUsers, setTypingUsers] = useState<Record<string, number>>({});\n  const [adminConnected, setAdminConnected] = useState(false);\n  const [waitTime, setWaitTime] = useState(\"\");\n  const msgsRef = useRef<HTMLDivElement | null>(null);\n  const typingTimeoutRef = useRef<number | null>(null);\n  const timersRef = useRef<number[]>([]);\n\n  useEffect(() => {\n    if (!ws) return;\n    const un = ws.addListener((data: any) => {\n      try {\n        if (\n          data?.type === \"help-message\" &&\n          String(data.requestId) === String(request.id)\n        ) {\n          setMessages((m) => [...m, data.message]);\n        }\n        if (\n          data?.type === \"help-request-updated\" &&\n          data.request?.id === request.id\n        ) {\n          setMessages(data.request.messages || []);\n          setAdminConnected(data.request.claimedBy ? true : false);\n        }\n        if (\n          data?.type === \"help-typing\" &&\n          String(data.requestId) === String(request.id)\n        ) {\n          const who =\n            data.fromName || data.fromEmail || (data.admin ? \"admin\" : \"user\");\n          setTypingUsers((prev) => ({ ...prev, [who]: Date.now() }));\n        }\n      } catch {}\n    });\n    return () => {\n      un();\n    };\n  }, [ws, request?.id]);\n\n  const sendMsg = () => {\n    if (!input.trim()) return;\n\n    // Send user message\n    const userMessage = input;\n    const payload = {\n      type: \"help-message\",\n      requestId: request.id,\n      message: userMessage,\n    };\n    try {\n      ws?.send(payload);\n    } catch {}\n\n    const msgObj = {\n      fromEmail: user?.email || null,\n      fromName: user?.username || null,\n      message: userMessage,\n      ts: Date.now(),\n      admin: false,\n    };\n    setMessages((m) => [...m, msgObj]);\n    setInput(\"\");\n\n    // If admin not connected, try AI response\n    if (!adminConnected) {\n      const t = window.setTimeout(() => {\n        const aiResponse = analyzeUserQuestion(userMessage);\n        if (aiResponse) {\n          const aiMsg = {\n            fromName: \"AI Assistant\",\n            message: `${aiResponse.title}\\n\\n${aiResponse.message}`,\n            ts: Date.now(),\n            admin: true,\n            actions: aiResponse.actions,\n            followUp: aiResponse.followUp,\n          };\n          setMessages((m) => [...m, aiMsg]);\n        }\n      }, 500);\n      timersRef.current.push(t);\n    }\n  };\n\n  const requestAdminConnection = (needsHelp: boolean) => {\n    if (!needsHelp) {\n      const confirmMsg = {\n        fromName: \"You\",\n        message: \"No, I think I have it now. Thanks!\",\n        ts: Date.now(),\n        admin: false,\n      };\n      setMessages((m) => [...m, confirmMsg]);\n\n      const t = window.setTimeout(() => {\n        const aiMsg = {\n          fromName: \"AI Assistant\",\n          message:\n            \" Great! Glad I could help. Feel free to reach out anytime you need assistance.\",\n          ts: Date.now(),\n          admin: true,\n        };\n        setMessages((m) => [...m, aiMsg]);\n      }, 300);\n      timersRef.current.push(t);\n      return;\n    }\n\n    // Request admin connection\n    const confirmMsg = {\n      fromName: \"You\",\n      message: \"Yes, I need to speak with an admin\",\n      ts: Date.now(),\n      admin: false,\n    };\n    setMessages((m) => [...m, confirmMsg]);\n\n    // Send escalation request to admins\n    try {\n      ws?.send({ type: \"help-escalate\", requestId: request.id });\n    } catch {}\n\n    setWaitTime(getEstimatedWaitTime());\n\n    const t = window.setTimeout(() => {\n      const waitMsg = {\n        fromName: \"System\",\n        message: ` Connecting you with an admin...\\n\\n Estimated wait time: ${waitTime}\\n\\nAn admin will be with you shortly. Please stay on this chat.`,\n        ts: Date.now(),\n        admin: true,\n      };\n      setMessages((m) => [...m, waitMsg]);\n    }, 500);\n    timersRef.current.push(t);\n  };\n\n  // auto-scroll to bottom when messages update\n  useEffect(() => {\n    if (!msgsRef.current) return;\n    try {\n      msgsRef.current.scrollTop = msgsRef.current.scrollHeight;\n    } catch {}\n  }, [messages]);\n\n  // send typing notifications (debounced)\n  const sendTyping = useCallback(() => {\n    try {\n      ws?.send({\n        type: \"help-typing\",\n        requestId: request.id,\n        fromName: user?.username,\n        fromEmail: user?.email,\n        admin: !!user?.isAdmin,\n      });\n    } catch {}\n    if (typingTimeoutRef.current) {\n      clearTimeout(typingTimeoutRef.current);\n    }\n    typingTimeoutRef.current = window.setTimeout(() => {\n      setTypingUsers((prev) => {\n        const copy = { ...prev };\n        delete copy[user?.username || user?.email || \"me\"];\n        return copy;\n      });\n    }, 3000);\n  }, [ws, request.id, user]);\n\n  useEffect(() => {\n    return () => {\n      if (typingTimeoutRef.current) clearTimeout(typingTimeoutRef.current);\n      for (const t of timersRef.current) clearTimeout(t);\n      timersRef.current = [];\n    };\n  }, []);\n\n  return (\n    <div className=\"fixed inset-0 z-50 flex items-end justify-center p-4\">\n      <div className=\"absolute inset-0 bg-black/40\" onClick={onClose} />\n      <div className=\"relative w-full max-w-2xl bg-slate-900 rounded-lg shadow-xl overflow-hidden flex flex-col max-h-[80vh]\">\n        <div className=\"flex items-center justify-between p-3 border-b border-slate-700 bg-slate-800\">\n          <div className=\"flex items-center gap-3\">\n            <div className=\"font-semibold flex items-center gap-2\">\n              <Zap className=\"w-4 h-4 text-yellow-400\" />\n              Help Desk  {request.username || \"Anonymous\"}\n            </div>\n            {adminConnected && (\n              <span className=\"text-xs px-2 py-1 rounded bg-emerald-600\">\n                Admin Connected\n              </span>\n            )}\n          </div>\n          <button\n            aria-label=\"Close\"\n            className=\"px-2 py-1 rounded bg-neutral-700 hover:bg-neutral-600 text-sm\"\n            onClick={onClose}\n          >\n            <X className=\"w-4 h-4\" />\n          </button>\n        </div>\n\n        <div\n          ref={msgsRef}\n          className=\"flex-1 overflow-y-auto p-3 space-y-3 bg-black/20\"\n        >\n          {messages.map((m, i) => (\n            <div key={i}>\n              <div\n                className={`max-w-[85%] px-3 py-2 rounded ${m.admin ? \"bg-emerald-600/20 border border-emerald-500/40 text-emerald-100 ml-auto\" : \"bg-slate-700 text-slate-100\"}`}\n              >\n                <div className=\"flex items-center justify-between mb-1\">\n                  <div className=\"text-xs opacity-70 font-semibold flex items-center gap-1\">\n                    {m.admin ? (\n                      <Zap className=\"w-3 h-3\" />\n                    ) : (\n                      <User className=\"w-3 h-3\" />\n                    )}\n                    {m.fromName ||\n                      m.fromEmail ||\n                      (m.admin ? \"AI Assistant\" : \"You\")}\n                  </div>\n                  <div className=\"text-xs opacity-50 ml-2\">\n                    {m.ts\n                      ? new Date(m.ts).toLocaleTimeString([], {\n                          hour: \"2-digit\",\n                          minute: \"2-digit\",\n                        })\n                      : \"\"}\n                  </div>\n                </div>\n                <div className=\"whitespace-pre-wrap break-words text-sm\">\n                  {m.message}\n                </div>\n\n                {/* Calibration actions */}\n                {m.actions && m.actions.length > 0 && (\n                  <div className=\"mt-3 space-y-2\">\n                    <div className=\"text-xs font-semibold opacity-80\">\n                       Try these calibration points:\n                    </div>\n                    <div className=\"grid grid-cols-2 md:grid-cols-5 gap-2\">\n                      {m.actions.map((action: any) => (\n                        <button\n                          key={action.id}\n                          className={`${action.color} text-white text-xs py-2 px-2 rounded font-medium hover:opacity-90 transition-opacity`}\n                          onClick={() => {\n                            const actionMsg = {\n                              fromName: \"You\",\n                              message: `Clicked: ${action.label}`,\n                              ts: Date.now(),\n                              admin: false,\n                            };\n                            setMessages((prev) => [...prev, actionMsg]);\n                            try {\n                              ws?.send({\n                                type: \"help-message\",\n                                requestId: request.id,\n                                message: `User clicked: ${action.id}`,\n                              });\n                            } catch {}\n                          }}\n                        >\n                          {action.label}\n                        </button>\n                      ))}\n                    </div>\n                  </div>\n                )}\n\n                {/* Follow-up prompt */}\n                {m.followUp && !adminConnected && (\n                  <div className=\"mt-3 space-y-2\">\n                    <div className=\"text-xs opacity-80\">{m.followUp}</div>\n                    <div className=\"flex gap-2\">\n                      <button\n                        className=\"flex-1 bg-emerald-600 hover:bg-emerald-700 text-white text-xs py-2 px-3 rounded font-medium transition-colors\"\n                        onClick={() => requestAdminConnection(true)}\n                      >\n                         Yes, connect me\n                      </button>\n                      <button\n                        className=\"flex-1 bg-slate-600 hover:bg-slate-700 text-white text-xs py-2 px-3 rounded font-medium transition-colors\"\n                        onClick={() => requestAdminConnection(false)}\n                      >\n                         No thanks\n                      </button>\n                    </div>\n                  </div>\n                )}\n              </div>\n            </div>\n          ))}\n\n          {/* typing indicators */}\n          {Object.keys(typingUsers).length > 0 && (\n            <div className=\"text-xs text-slate-300 opacity-80 flex items-center gap-2\">\n              <span>{Object.keys(typingUsers).join(\", \")} typing</span>\n              <span className=\"flex gap-1\">\n                <span className=\"w-1 h-1 bg-slate-300 rounded-full animate-bounce\"></span>\n                <span className=\"w-1 h-1 bg-slate-300 rounded-full animate-bounce delay-100\"></span>\n                <span className=\"w-1 h-1 bg-slate-300 rounded-full animate-bounce delay-200\"></span>\n              </span>\n            </div>\n          )}\n        </div>\n\n        <div className=\"p-3 border-t border-slate-700 bg-slate-800 flex gap-2\">\n          <input\n            className=\"input flex-1 text-sm\"\n            value={input}\n            onChange={(e) => {\n              setInput(e.target.value);\n              sendTyping();\n            }}\n            onKeyDown={(e) => {\n              if (e.key === \"Enter\" && !e.shiftKey) {\n                e.preventDefault();\n                sendMsg();\n              }\n            }}\n            placeholder=\"Ask a question (e.g., 'How does calibration work?')...\"\n          />\n          <button\n            aria-label=\"Send message\"\n            className=\"btn bg-blue-600 hover:bg-blue-700 text-white\"\n            onClick={sendMsg}\n          >\n            <Send className=\"w-4 h-4\" />\n          </button>\n        </div>\n      </div>\n    </div>\n  );\n}\n","import { useEffect, useMemo, useState } from \"react\";\nimport BarChart from \"./BarChart\";\nimport TabPills from \"./ui/TabPills\";\nimport { getGameModeStats } from \"../store/profileStats\";\nimport {\n  allGames,\n  labelForMode,\n  getModeOptionsForGame,\n  getModeValueOptionsForGame,\n} from \"../utils/games\";\nimport { useWS } from \"./WSProvider\";\nimport CameraStatusBadge from \"./CameraStatusBadge\";\nimport HelpdeskChat from \"./HelpdeskChat\";\nimport { useCalibration } from \"../store/calibration\";\nimport { useToast } from \"../store/toast\";\nimport {\n  getCalibrationConfidenceForGame,\n  getCalibrationQualityText,\n} from \"../utils/gameCalibrationRequirements\";\n\nconst OWNER_EMAIL = \"daviesfamily108@gmail.com\";\n\nexport default function AdminDashboard({ user }: { user: any }) {\n  const ws = (() => {\n    try {\n      return useWS();\n    } catch {\n      return null;\n    }\n  })();\n  const [admins, setAdmins] = useState<string[]>([]);\n  const [email, setEmail] = useState(\"\");\n  const [status] = useState<any>(null);\n  const [announcement, setAnnouncement] = useState(\"\");\n  const [loading, setLoading] = useState(false);\n  const [tournaments, setTournaments] = useState<any[]>([]);\n  const [userSearch, setUserSearch] = useState(\"\");\n  const [userResults, setUserResults] = useState<any[]>([]);\n  const [createForm, setCreateForm] = useState<any>({\n    title: \"Official Tournament\",\n    game: \"X01\",\n    mode: \"bestof\",\n    value: 3,\n    description: \"\",\n    startAt: new Date(Date.now() + 2 * 60 * 60 * 1000)\n      .toISOString()\n      .slice(0, 16),\n    checkinMinutes: 30,\n    capacity: 16,\n    prizeType: \"premium\",\n    prizeAmount: 3,\n    prizeNotes: \"\",\n  });\n  const [emailCopy, setEmailCopy] = useState<any>({\n    reset: {},\n    reminder: {},\n    confirmEmail: {},\n    changed: {},\n  });\n  const [preview, setPreview] = useState<{\n    open: boolean;\n    kind?: string;\n    html?: string;\n  }>({ open: false });\n  const [activeTab, setActiveTab] = useState<\n    \"general\" | \"maintenance\" | \"premium\" | \"helpdesk\" | \"tourneys\"\n  >(\"general\");\n  const isOwner = user?.email?.toLowerCase() === OWNER_EMAIL;\n  const [winners] = useState<any[]>([]);\n  const [reports] = useState<any[]>([]);\n  const [helpRequests, setHelpRequests] = useState<any[]>([]);\n  const [helpTyping, setHelpTyping] = useState<\n    Record<string, { who: string; ts: number }>\n  >({});\n  const [selectedRequest, setSelectedRequest] = useState<any | null>(null);\n  const [, setLogs] = useState<any[]>([]);\n  const [systemHealth, setSystemHealth] = useState<any>(null);\n  const [clusteringEnabled, setClusteringEnabled] = useState(false);\n  const [clusterCapacity, setClusterCapacity] = useState(1500);\n  const [, setShowCreate] = useState(false);\n\n  const broadcastTournaments = async () => {\n    setLoading(true);\n    try {\n      const headers = {\n        \"Content-Type\": \"application/json\",\n        Authorization: `Bearer ${localStorage.getItem(\"authToken\")}`,\n      };\n      const res = await fetch(\"/api/admin/tournaments/broadcast\", {\n        method: \"POST\",\n        headers,\n      });\n      if (res.ok) {\n        toast(\"Tournaments broadcast triggered\", { type: \"success\" });\n      } else {\n        toast(\"Broadcast failed\", { type: \"error\" });\n      }\n    } catch (err) {\n      toast(\"Broadcast request failed\", { type: \"error\" });\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  // --- Game usage (played/won per mode) ---\n  const [gmVersion, setGmVersion] = useState(0);\n  useEffect(() => {\n    const on = () => setGmVersion((v) => v + 1);\n    window.addEventListener(\"ndn:stats-updated\", on as any);\n    return () => window.removeEventListener(\"ndn:stats-updated\", on as any);\n  }, []);\n  const gmStats = useMemo(\n    () => getGameModeStats(allGames as unknown as string[]),\n    [gmVersion],\n  );\n\n  // Calibration data and preview effect\n  const cal = useCalibration();\n  const toast = useToast();\n\n  useEffect(() => {\n    if (!preview.open) return;\n    function onKey(e: KeyboardEvent) {\n      if (e.key === \"Escape\") setPreview({ open: false });\n    }\n    document.addEventListener(\"keydown\", onKey);\n    return () => document.removeEventListener(\"keydown\", onKey);\n  }, [preview.open]);\n\n  // Calibration quality display\n  const calibQuality = useMemo(() => {\n    const errorPx = cal.errorPx ?? null;\n    const items: any[] = [];\n    for (const game of allGames) {\n      const confidence = getCalibrationConfidenceForGame(game, errorPx);\n      const qualityInfo = getCalibrationQualityText(game, errorPx);\n      items.push({ game, confidence, qualityInfo });\n    }\n    return items;\n  }, [cal.errorPx]);\n\n  // Lightweight derived bars for the Game Usage chart\n  const gmBars: any[] = useMemo(() => {\n    const bars: any[] = [];\n    if (gmStats && typeof gmStats === \"object\") {\n      for (const [gameKey, stats] of Object.entries(gmStats as any)) {\n        const s = stats as any;\n        bars.push({\n          label: gameKey,\n          value: s?.played || 0,\n          won: s?.won || 0,\n        });\n      }\n    }\n    return bars;\n  }, [gmStats]);\n\n  // Refresh common admin data (help requests, admins, tournaments)\n  async function refresh() {\n    try {\n      const headers = {\n        Authorization: `Bearer ${localStorage.getItem(\"authToken\")}`,\n      };\n      const [hrRes, adminsRes, tRes] = await Promise.all([\n        fetch(\"/api/admin/help-requests\", { headers }),\n        fetch(\"/api/admins\", { headers }),\n        fetch(\"/api/tournaments\", { headers }),\n      ]);\n      if (hrRes.ok) {\n        const d = await hrRes.json();\n        setHelpRequests(Array.isArray(d) ? d : d.requests || []);\n      }\n      if (adminsRes.ok) {\n        const d = await adminsRes.json();\n        setAdmins(Array.isArray(d) ? d : d.admins || []);\n      }\n      if (tRes.ok) {\n        const d = await tRes.json();\n        setTournaments(Array.isArray(d) ? d : d.tournaments || d);\n      }\n    } catch (e) {\n      console.error(\"refresh failed\", e);\n    }\n  }\n\n  async function revoke(target: string) {\n    try {\n      await fetch(\"/api/admins/revoke\", {\n        method: \"POST\",\n        headers: {\n          \"Content-Type\": \"application/json\",\n          Authorization: `Bearer ${localStorage.getItem(\"authToken\")}`,\n        },\n        body: JSON.stringify({ email: target }),\n      });\n      await refresh();\n    } catch {}\n  }\n\n  async function grantPremium(email: string, days: number) {\n    if (!email) return;\n    try {\n      await fetch(\"/api/admin/premium/grant\", {\n        method: \"POST\",\n        headers: {\n          \"Content-Type\": \"application/json\",\n          Authorization: `Bearer ${localStorage.getItem(\"authToken\")}`,\n        },\n        body: JSON.stringify({ email, days }),\n      });\n      await refresh();\n    } catch {}\n  }\n\n  async function revokePremium(email: string) {\n    try {\n      await fetch(\"/api/admin/premium/revoke\", {\n        method: \"POST\",\n        headers: {\n          \"Content-Type\": \"application/json\",\n          Authorization: `Bearer ${localStorage.getItem(\"authToken\")}`,\n        },\n        body: JSON.stringify({ email }),\n      });\n      await refresh();\n    } catch {}\n  }\n\n  async function sendAnnouncement() {\n    if (!announcement.trim()) return;\n    try {\n      await fetch(\"/api/admin/announce\", {\n        method: \"POST\",\n        headers: {\n          \"Content-Type\": \"application/json\",\n          Authorization: `Bearer ${localStorage.getItem(\"authToken\")}`,\n        },\n        body: JSON.stringify({ message: announcement }),\n      });\n      setAnnouncement(\"\");\n      await refresh();\n    } catch {}\n  }\n\n  async function toggleMaintenance(next: boolean) {\n    try {\n      await fetch(\"/api/admin/maintenance\", {\n        method: \"POST\",\n        headers: {\n          \"Content-Type\": \"application/json\",\n          Authorization: `Bearer ${localStorage.getItem(\"authToken\")}`,\n        },\n        body: JSON.stringify({ maintenance: next }),\n      });\n      await refresh();\n    } catch {}\n  }\n\n  // Listen for help-typing and help-request events over WS to show live typing indicators and new requests\n  useEffect(() => {\n    if (!ws) return;\n    const unsub = ws.addListener((data: any) => {\n      try {\n        if (data?.type === \"help-typing\") {\n          const rid = String(data.requestId || \"\");\n          if (!rid) return;\n          setHelpTyping((prev) => ({\n            ...prev,\n            [rid]: { who: data.fromName || \"someone\", ts: Date.now() },\n          }));\n          return;\n        }\n        if (data?.type === \"help-request\") {\n          const req = data.request;\n          if (!req || !req.id) return;\n          setHelpRequests((prev) => {\n            const filtered = (prev || []).filter(\n              (r: any) => String(r.id) !== String(req.id),\n            );\n            return [req, ...filtered];\n          });\n          return;\n        }\n        if (data?.type === \"help-request-updated\") {\n          refresh();\n        }\n      } catch {}\n    });\n    const iv = setInterval(() => {\n      const now = Date.now();\n      let changed = false;\n      const copy = { ...helpTyping };\n      for (const k of Object.keys(copy)) {\n        if (now - copy[k].ts > 3500) {\n          delete copy[k];\n          changed = true;\n        }\n      }\n      if (changed) setHelpTyping(copy);\n    }, 1500);\n    return () => {\n      try {\n        unsub();\n      } catch {}\n      clearInterval(iv);\n    };\n  }, [ws]);\n\n  async function claimHelp(id: string) {\n    try {\n      const headers = {\n        \"Content-Type\": \"application/json\",\n        Authorization: `Bearer ${localStorage.getItem(\"authToken\")}`,\n      };\n      const res = await fetch(\n        `/api/admin/help-requests/${encodeURIComponent(id)}/claim`,\n        { method: \"POST\", headers, body: JSON.stringify({}) },\n      );\n      if (res.ok) {\n        await refresh();\n      }\n    } catch {}\n  }\n\n  async function resolveHelp(id: string) {\n    try {\n      const headers = {\n        \"Content-Type\": \"application/json\",\n        Authorization: `Bearer ${localStorage.getItem(\"authToken\")}`,\n      };\n      const res = await fetch(\n        `/api/admin/help-requests/${encodeURIComponent(id)}/resolve`,\n        { method: \"POST\", headers, body: JSON.stringify({}) },\n      );\n      if (res.ok) {\n        await refresh();\n      }\n    } catch {}\n  }\n\n  async function grant() {\n    if (!email) return;\n    await fetch(\"/api/admins/grant\", {\n      method: \"POST\",\n      headers: {\n        \"Content-Type\": \"application/json\",\n        Authorization: `Bearer ${localStorage.getItem(\"authToken\")}`,\n      },\n      body: JSON.stringify({ email }),\n    });\n    setEmail(\"\");\n  }\n\n  async function searchUsers() {\n    if (!userSearch.trim()) return;\n    try {\n      const authHeader = {\n        Authorization: `Bearer ${localStorage.getItem(\"authToken\")}`,\n      };\n      const res = await fetch(\n        `/api/admin/users/search?q=${encodeURIComponent(userSearch)}`,\n        { headers: authHeader },\n      );\n      if (res.ok) {\n        const data = await res.json();\n        setUserResults(Array.isArray(data.users) ? data.users : []);\n      }\n    } catch (error) {\n      console.error(\"Search failed:\", error);\n    }\n  }\n\n  async function banUser(email: string) {\n    try {\n      await fetch(\"/api/admin/users/ban\", {\n        method: \"POST\",\n        headers: {\n          \"Content-Type\": \"application/json\",\n          Authorization: `Bearer ${localStorage.getItem(\"authToken\")}`,\n        },\n        body: JSON.stringify({ email }),\n      });\n      await searchUsers(); // Refresh results\n    } catch (error) {\n      console.error(\"Ban failed:\", error);\n    }\n  }\n\n  async function unbanUser(email: string) {\n    try {\n      await fetch(\"/api/admin/users/unban\", {\n        method: \"POST\",\n        headers: {\n          \"Content-Type\": \"application/json\",\n          Authorization: `Bearer ${localStorage.getItem(\"authToken\")}`,\n        },\n        body: JSON.stringify({ email }),\n      });\n      await searchUsers(); // Refresh results\n    } catch (error) {\n      console.error(\"Unban failed:\", error);\n    }\n  }\n\n  // flipPremium removed: not used in current UI\n\n  async function createOfficialTournament() {\n    setLoading(true);\n    try {\n      const start = new Date(createForm.startAt).getTime();\n      const res = await fetch(\"/api/tournaments/create\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({\n          title: createForm.title,\n          game: createForm.game,\n          mode: createForm.mode,\n          value: Number(createForm.value),\n          description: createForm.description,\n          startAt: start,\n          checkinMinutes: Number(createForm.checkinMinutes),\n          capacity: Number(createForm.capacity),\n          requireCalibration: !!createForm.requireCalibration,\n          creatorEmail: user?.email,\n          creatorName: user?.username,\n          requesterEmail: user?.email,\n          official: true,\n          prizeType: \"premium\",\n          prizeAmount: Number(createForm.prizeAmount || 0),\n          prizeNotes: createForm.prizeNotes,\n        }),\n      });\n      // refresh admin view and broadcast will update lobby for connected clients\n      await refresh();\n      try {\n        // If creation returned the tournament id, navigate the app to the tournaments tab so lobby is visible\n        const data = await res.json();\n        if (data && data.tournament && data.tournament.id) {\n          window.dispatchEvent(\n            new CustomEvent(\"ndn:change-tab\", {\n              detail: { tab: \"tournaments\" },\n            }),\n          );\n        }\n      } catch {}\n    } finally {\n      setLoading(false);\n    }\n  }\n\n  async function setWinner(tid: string, winnerEmail: string) {\n    setLoading(true);\n    try {\n      await fetch(\"/api/admin/tournaments/winner\", {\n        method: \"POST\",\n        headers: {\n          \"Content-Type\": \"application/json\",\n          Authorization: `Bearer ${localStorage.getItem(\"authToken\")}`,\n        },\n        body: JSON.stringify({ tournamentId: tid, winnerEmail }),\n      });\n      await refresh();\n    } finally {\n      setLoading(false);\n    }\n  }\n\n  async function deleteTournament(tid: string) {\n    setLoading(true);\n    try {\n      await fetch(\"/api/admin/tournaments/delete\", {\n        method: \"POST\",\n        headers: {\n          \"Content-Type\": \"application/json\",\n          Authorization: `Bearer ${localStorage.getItem(\"authToken\")}`,\n        },\n        body: JSON.stringify({ tournamentId: tid }),\n      });\n      await refresh();\n    } finally {\n      setLoading(false);\n    }\n  }\n\n  async function reseedWeekly() {\n    setLoading(true);\n    try {\n      await fetch(\"/api/admin/tournaments/reseed-weekly\", {\n        method: \"POST\",\n        headers: {\n          \"Content-Type\": \"application/json\",\n          Authorization: `Bearer ${localStorage.getItem(\"authToken\")}`,\n        },\n        body: JSON.stringify({}),\n      });\n      await refresh();\n    } finally {\n      setLoading(false);\n    }\n  }\n\n  async function deleteMatch(id: string) {\n    setLoading(true);\n    try {\n      await fetch(\"/api/admin/matches/delete\", {\n        method: \"POST\",\n        headers: {\n          \"Content-Type\": \"application/json\",\n          Authorization: `Bearer ${localStorage.getItem(\"authToken\")}`,\n        },\n        body: JSON.stringify({ matchId: id }),\n      });\n      await refresh();\n    } finally {\n      setLoading(false);\n    }\n  }\n\n  async function fetchLogs() {\n    try {\n      const authHeader = {\n        Authorization: `Bearer ${localStorage.getItem(\"authToken\")}`,\n      };\n      const res = await fetch(\"/api/admin/logs\", { headers: authHeader });\n      if (res.ok) {\n        const data = await res.json();\n        if (data?.ok) setLogs(data.logs || []);\n      }\n    } catch (error) {\n      console.error(\"Failed to fetch logs:\", error);\n    }\n  }\n\n  async function fetchSystemHealth() {\n    try {\n      const authHeader = {\n        Authorization: `Bearer ${localStorage.getItem(\"authToken\")}`,\n      };\n      const res = await fetch(\"/api/admin/system-health\", {\n        headers: authHeader,\n      });\n      if (res.ok) {\n        const data = await res.json();\n        if (data?.ok && data?.health) {\n          setSystemHealth({\n            database: data.health.database || false,\n            websocket: data.health.websocket || false,\n            https: data.health.https || false,\n            maintenance: data.health.maintenance || false,\n            clustering: data.health.clustering || false,\n            uptime: data.health.uptime || 0,\n            memory: data.health.memory || { heapUsed: 0 },\n            version: data.health.version || \"unknown\",\n          });\n          setClusteringEnabled(data.health?.clustering || false);\n        }\n      }\n    } catch (error) {\n      console.error(\"Failed to fetch system health:\", error);\n    }\n  }\n\n  async function toggleClustering(enable: boolean) {\n    setLoading(true);\n    try {\n      const res = await fetch(\"/api/admin/clustering\", {\n        method: \"POST\",\n        headers: {\n          \"Content-Type\": \"application/json\",\n          Authorization: `Bearer ${localStorage.getItem(\"authToken\")}`,\n        },\n        body: JSON.stringify({\n          enabled: enable,\n          maxWorkers: 4,\n          capacity: clusterCapacity,\n        }),\n      });\n      const data = await res.json();\n      console.log(\"Clustering response:\", data);\n      if (data?.ok) {\n        alert(\n          `Clustering ${enable ? \"enabled\" : \"disabled\"} successfully. Max capacity: ${clusterCapacity.toLocaleString()} concurrent users. NODE_WORKERS environment variable is set to max capacity.`,\n        );\n        await fetchSystemHealth();\n      } else {\n        alert(`Failed: ${data?.error || data?.message || \"Unknown error\"}`);\n      }\n    } catch (error) {\n      console.error(\"Clustering toggle failed:\", error);\n      alert(\n        \"Clustering toggle failed: \" +\n          (error instanceof Error ? error.message : String(error)),\n      );\n    } finally {\n      setLoading(false);\n    }\n  }\n\n  async function updateClusterCapacity(newCapacity: number) {\n    setClusterCapacity(newCapacity);\n    // Capacity is updated locally and sent when clustering toggle is used\n  }\n\n  // quick-fix helper removed: not used in current UI\n\n  async function loadEmailCopy() {\n    try {\n      const authHeader = {\n        Authorization: `Bearer ${localStorage.getItem(\"authToken\")}`,\n      };\n      const res = await fetch(\"/api/admin/email-copy\", { headers: authHeader });\n      if (res.ok) {\n        const d = await res.json();\n        if (d?.ok) setEmailCopy(d.copy || emailCopy);\n      }\n    } catch {}\n  }\n  useEffect(() => {\n    if (isOwner) loadEmailCopy();\n  }, [isOwner]);\n\n  useEffect(() => {\n    if (isOwner && (activeTab === \"general\" || activeTab === \"maintenance\")) {\n      fetchLogs();\n      fetchSystemHealth();\n    }\n  }, [isOwner, activeTab]);\n\n  async function saveEmailCopy(kind: string, payload: any) {\n    await fetch(\"/api/admin/email-copy\", {\n      method: \"POST\",\n      headers: {\n        \"Content-Type\": \"application/json\",\n        Authorization: `Bearer ${localStorage.getItem(\"authToken\")}`,\n      },\n      body: JSON.stringify({ kind, ...payload }),\n    });\n    await loadEmailCopy();\n  }\n\n  async function openInlinePreview(kind: string, openInNewTab?: boolean) {\n    try {\n      const authHeader = {\n        Authorization: `Bearer ${localStorage.getItem(\"authToken\")}`,\n      };\n      const res = await fetch(\n        `/api/email/preview?kind=${encodeURIComponent(kind)}`,\n        { headers: authHeader },\n      );\n      const html = await res.text();\n      if (openInNewTab) {\n        const w = window.open();\n        if (w) {\n          w.document.open();\n          w.document.write(html);\n          w.document.close();\n          return;\n        }\n      }\n      setPreview({ open: true, kind, html });\n    } catch {\n      setPreview({\n        open: true,\n        kind,\n        html: '<!doctype html><html><body style=\"font-family:sans-serif;padding:16px\">Failed to load preview.</body></html>',\n      });\n    }\n  }\n\n  useEffect(() => {\n    if (!preview.open) return;\n    function onKey(e: KeyboardEvent) {\n      if (e.key === \"Escape\") setPreview({ open: false });\n    }\n    document.addEventListener(\"keydown\", onKey);\n    return () => document.removeEventListener(\"keydown\", onKey);\n  }, [preview.open]);\n\n  function EmailEditor({ kind, label }: { kind: string; label: string }) {\n    const key =\n      kind === \"confirm-email\"\n        ? \"confirmEmail\"\n        : kind === \"changed\"\n          ? \"changed\"\n          : kind;\n    const cfg = emailCopy?.[key] || { title: \"\", intro: \"\", buttonLabel: \"\" };\n    const [title, setTitle] = useState(cfg.title || \"\");\n    const [intro, setIntro] = useState(cfg.intro || \"\");\n    const [btn, setBtn] = useState(cfg.buttonLabel || \"\");\n    useEffect(() => {\n      setTitle(cfg.title || \"\");\n      setIntro(cfg.intro || \"\");\n      setBtn(cfg.buttonLabel || \"\");\n    }, [cfg.title, cfg.intro, cfg.buttonLabel]);\n\n    return (\n      <div className=\"p-2 rounded bg-black/20 space-y-2\">\n        <div className=\"font-semibold\">{label}</div>\n        <input\n          className=\"input w-full\"\n          placeholder=\"Title (optional)\"\n          value={title}\n          onChange={(e) => setTitle(e.target.value)}\n        />\n        <textarea\n          className=\"input w-full\"\n          rows={2}\n          placeholder=\"Intro line (optional)\"\n          value={intro}\n          onChange={(e) => setIntro(e.target.value)}\n        />\n        <input\n          className=\"input w-full\"\n          placeholder=\"Button label (optional)\"\n          value={btn}\n          onChange={(e) => setBtn(e.target.value)}\n        />\n        <div className=\"flex gap-2 justify-end\">\n          <button\n            className=\"btn\"\n            type=\"button\"\n            onClick={() => openInlinePreview(kind, true)}\n          >\n            Preview\n          </button>\n          <button\n            className=\"btn\"\n            type=\"button\"\n            onClick={() => openInlinePreview(kind)}\n          >\n            Popup\n          </button>\n          <button\n            className=\"btn\"\n            onClick={() =>\n              saveEmailCopy(kind, { title, intro, buttonLabel: btn })\n            }\n          >\n            Save\n          </button>\n        </div>\n      </div>\n    );\n  }\n\n  if (!isOwner) {\n    return (\n      <div className=\"card ndn-page\">\n        <h2 className=\"text-2xl font-bold mb-2 ndn-section-title\">Admin </h2>\n        <div className=\"text-sm opacity-80\">\n          You don't have permission to manage admins.\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"p-4 md:p-8 max-w-7xl mx-auto ndn-page\">\n      <div className=\"flex flex-col md:flex-row items-center justify-between gap-4 mb-8\">\n        <div>\n          <h2 className=\"text-3xl font-black text-white tracking-tight ndn-section-title\">\n            Admin \n          </h2>\n          <p className=\"text-white/40 font-medium\">\n            System management and oversight\n          </p>\n        </div>\n        <div className=\"shrink-0 flex items-center gap-2\">\n          {/* Keep the green connected badge; no HTTP/HTTPS pills here */}\n          <CameraStatusBadge />\n          {ws && (ws as any).reconnect && (\n            <button\n              onClick={() => (ws as any).reconnect()}\n              className=\"ml-1 rounded-md bg-neutral-700/60 hover:bg-neutral-600/70 px-2.5 py-1 text-xs border border-white/10\"\n              title=\"Force close and recreate the WebSocket connection\"\n            >\n              Recreate WS\n            </button>\n          )}\n        </div>\n      </div>\n      {/* Top help-requests strip for quick admin actions */}\n      {helpRequests.length > 0 && (\n        <div className=\"p-2 rounded-xl bg-amber-900/10 border border-amber-500/20 mb-6\">\n          <div className=\"flex items-center justify-between\">\n            <div className=\"flex items-center gap-3\">\n              <span className=\"font-semibold\">Open Help Requests </span>\n              <span className=\"text-sm opacity-80\">\n                {helpRequests.length} open\n              </span>\n            </div>\n            <div className=\"flex items-center gap-2\">\n              <button\n                className=\"btn\"\n                onClick={() => setSelectedRequest(helpRequests[0])}\n              >\n                Open Latest\n              </button>\n              <button className=\"btn btn-ghost\" onClick={() => refresh()}>\n                Refresh\n              </button>\n            </div>\n          </div>\n          <div className=\"mt-2 flex gap-2 overflow-x-auto\">\n            {helpRequests.slice(0, 6).map((hr: any) => (\n              <div\n                key={hr.id}\n                className=\"p-2 rounded bg-black/10 border border-white/10 min-w-[220px]\"\n              >\n                <div className=\"font-medium\">{hr.username || \"Anonymous\"}</div>\n                <div className=\"text-xs opacity-70\">\n                  {new Date(hr.ts || 0).toLocaleTimeString()}\n                </div>\n                <div className=\"text-sm truncate mt-1\">{hr.message}</div>\n                <div className=\"mt-2 flex gap-2\">\n                  {hr.status === \"open\" ? (\n                    <button className=\"btn\" onClick={() => claimHelp(hr.id)}>\n                      Claim\n                    </button>\n                  ) : (\n                    <span className=\"text-xs opacity-70\">\n                      {hr.status} by {hr.claimedBy || \"\"}\n                    </span>\n                  )}\n                  <button\n                    className=\"btn\"\n                    onClick={() => setSelectedRequest(hr)}\n                  >\n                    Chat\n                  </button>\n                </div>\n              </div>\n            ))}\n          </div>\n        </div>\n      )}\n      {isOwner && (\n        <TabPills\n          tabs={[\n            { key: \"general\", label: \"General\" },\n            { key: \"maintenance\", label: \"Maintenance\" },\n            { key: \"premium\", label: \"Premium\" },\n            { key: \"tourneys\", label: \"Tourneys\" },\n            { key: \"helpdesk\", label: \"Help Desk\" },\n          ]}\n          active={activeTab}\n          onChange={(key) =>\n            setActiveTab(\n              key as\n                | \"general\"\n                | \"maintenance\"\n                | \"premium\"\n                | \"helpdesk\"\n                | \"tourneys\",\n            )\n          }\n          className=\"mb-4\"\n        />\n      )}{\" \"}\n      {activeTab === \"general\" && (\n        <>\n          {isOwner && (\n            <div className=\"card\">\n              <h3 className=\"text-xl font-semibold mb-2\">Game Usage</h3>\n              <div className=\"rounded-xl border border-indigo-500/40 bg-indigo-500/10 p-3\">\n                <BarChart\n                  data={gmBars.map((d) => ({ label: \"\", value: d.value }))}\n                />\n                <div className=\"mt-2 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-2 text-[11px] opacity-80\">\n                  {gmBars.map((d, i) => (\n                    <div\n                      key={i}\n                      className=\"flex items-center justify-between px-2 py-1 rounded-md bg-white/5 border border-white/10\"\n                    >\n                      <span className=\"truncate mr-2\">{d.label}</span>\n                      <span className=\"whitespace-nowrap\">\n                        Played {d.value}  Won {d.won}\n                      </span>\n                    </div>\n                  ))}\n                </div>\n              </div>\n            </div>\n          )}\n\n          {isOwner && (\n            <div className=\"card\">\n              <h3 className=\"text-xl font-semibold mb-2\">\n                Calibration Quality Status\n              </h3>\n              <div className=\"text-sm opacity-80 mb-3\">\n                Camera calibration confidence by game mode. Shows current system\n                calibration readiness for each game.\n              </div>\n              <div className=\"rounded-xl border border-amber-500/40 bg-amber-500/5 p-3\">\n                <div className=\"grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-2 text-[11px]\">\n                  {calibQuality.map((item) => {\n                    const colorClass =\n                      item.confidence >= 85\n                        ? \"bg-emerald-500/20 border-emerald-500/40 text-emerald-200\"\n                        : item.confidence >= 70\n                          ? \"bg-amber-500/20 border-amber-500/40 text-amber-200\"\n                          : \"bg-rose-500/20 border-rose-500/40 text-rose-200\";\n                    return (\n                      <div\n                        key={item.game}\n                        className={`px-2 py-2 rounded-md border ${colorClass}`}\n                      >\n                        <div className=\"font-semibold text-xs truncate\">\n                          {item.game}\n                        </div>\n                        <div className=\"text-[10px] opacity-80 truncate\">\n                          {item.qualityInfo.quality}\n                        </div>\n                        <div className=\"text-[10px] font-mono mt-0.5\">\n                          {Math.round(item.confidence)}%\n                        </div>\n                      </div>\n                    );\n                  })}\n                </div>\n              </div>\n            </div>\n          )}\n\n          <div className=\"card\">\n            <h2 className=\"text-2xl font-bold mb-2\">Admin Control </h2>\n            <div className=\"text-sm opacity-80 mb-3\">\n              Grant or revoke Admin to trusted users. Only the owner can perform\n              these actions.\n            </div>\n            <div className=\"flex gap-2 mb-3\">\n              <input\n                className=\"input flex-1\"\n                placeholder=\"user@example.com\"\n                value={email}\n                onChange={(e) => setEmail(e.target.value)}\n              />\n              <button className=\"btn\" disabled={loading} onClick={grant}>\n                Grant\n              </button>\n              <button\n                className=\"btn bg-rose-600 hover:bg-rose-700\"\n                disabled={loading}\n                onClick={() => revoke(email)}\n              >\n                Revoke\n              </button>\n            </div>\n            <div className=\"text-sm opacity-80 mb-2\">Current Admins:</div>\n            <div className=\"flex flex-wrap gap-2 mb-4\">\n              {admins.map((admin) => (\n                <div\n                  key={admin}\n                  className=\"px-2 py-1 rounded bg-indigo-600/20 border border-indigo-500/40 text-sm\"\n                >\n                  {admin}\n                </div>\n              ))}\n            </div>\n\n            <hr className=\"border-indigo-500/20 my-4\" />\n\n            <h3 className=\"text-lg font-semibold mb-2\">\n              Premium Access Control\n            </h3>\n            <div className=\"text-sm opacity-80 mb-3\">\n              Grant or revoke Premium subscription access to users (grants 30\n              days).\n            </div>\n            <div className=\"flex gap-2 mb-3\">\n              <input\n                className=\"input flex-1\"\n                placeholder=\"user@example.com\"\n                value={email}\n                onChange={(e) => setEmail(e.target.value)}\n              />\n              <button\n                className=\"btn bg-emerald-600 hover:bg-emerald-700\"\n                disabled={loading || !email.trim()}\n                onClick={() => grantPremium(email, 30)}\n              >\n                Grant Premium\n              </button>\n              <button\n                className=\"btn bg-rose-600 hover:bg-rose-700\"\n                disabled={loading}\n                onClick={() => revokePremium(email)}\n              >\n                Revoke Premium\n              </button>\n            </div>\n            <div className=\"text-sm opacity-80\">\n              Premium grants provide 30 days of unlimited access to all\n              features.\n            </div>\n          </div>\n\n          <div className=\"card\">\n            <h3 className=\"text-xl font-bold mb-4 text-white/90\">\n              Announcements \n            </h3>\n            <div className=\"text-sm opacity-80 mb-2\">\n              Send a message to all users. This will appear as a toast\n              notification.\n            </div>\n            <div className=\"flex gap-2\">\n              <input\n                className=\"input flex-1\"\n                placeholder=\"Announcement message...\"\n                value={announcement}\n                onChange={(e) => setAnnouncement(e.target.value)}\n              />\n              <button\n                className=\"btn\"\n                disabled={loading || !announcement.trim()}\n                onClick={sendAnnouncement}\n              >\n                Send\n              </button>\n            </div>\n          </div>\n\n          <div className=\"card\">\n            <h3 className=\"text-xl font-semibold mb-2\">User Search</h3>\n            <div className=\"text-sm opacity-80 mb-2\">\n              Search for users by email or name.\n            </div>\n            <div className=\"flex gap-2 mb-3\">\n              <input\n                className=\"input flex-1\"\n                placeholder=\"Search users...\"\n                value={userSearch}\n                onChange={(e) => setUserSearch(e.target.value)}\n              />\n              <button className=\"btn\" disabled={loading} onClick={searchUsers}>\n                Search\n              </button>\n            </div>\n            {userResults.length > 0 && (\n              <div className=\"space-y-2\">\n                <div className=\"text-sm opacity-80 mb-2\">Results:</div>\n                {userResults.map((u) => (\n                  <div\n                    key={u.email}\n                    className=\"p-2 rounded bg-black/20 text-sm flex items-center justify-between\"\n                  >\n                    <div>\n                      <div className=\"font-semibold\">{u.name || \"No name\"}</div>\n                      <div className=\"opacity-70\">{u.email}</div>\n                      <div className=\"opacity-60 text-xs\">\n                        Joined {new Date(u.createdAt).toLocaleDateString()}\n                      </div>\n                    </div>\n                  </div>\n                ))}\n              </div>\n            )}\n          </div>\n\n          {isOwner && (\n            <div className=\"card\">\n              <h3 className=\"text-xl font-semibold mb-3\">Email Templates</h3>\n              <div className=\"text-sm opacity-80 mb-2\">\n                Customize titles, intro lines, and button text. Previews open in\n                a new tab or as a popup.\n              </div>\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-3\">\n                <EmailEditor kind=\"reset\" label=\"Password reset\" />\n                <EmailEditor kind=\"reminder\" label=\"Password reset reminder\" />\n                <EmailEditor kind=\"confirm-email\" label=\"Confirm new email\" />\n                <EmailEditor kind=\"changed\" label=\"Password changed notice\" />\n              </div>\n            </div>\n          )}\n        </>\n      )}\n      {activeTab === \"maintenance\" && isOwner && (\n        <>\n          <div className=\"card\">\n            <h3 className=\"text-xl font-semibold mb-2\">User Management</h3>\n            <div className=\"text-sm opacity-80 mb-2\">\n              Ban or unban users. Use with caution.\n            </div>\n            <div className=\"flex gap-2 mb-3\">\n              <input\n                className=\"input flex-1\"\n                placeholder=\"user@example.com\"\n                value={userSearch}\n                onChange={(e) => setUserSearch(e.target.value)}\n              />\n              <button className=\"btn\" disabled={loading} onClick={searchUsers}>\n                Search\n              </button>\n            </div>\n            {userResults.length > 0 && (\n              <div className=\"space-y-2\">\n                <div className=\"text-sm opacity-80 mb-2\">Results:</div>\n                {userResults.map((u) => (\n                  <div\n                    key={u.email}\n                    className=\"p-2 rounded bg-black/20 text-sm flex items-center justify-between\"\n                  >\n                    <div>\n                      <div className=\"font-semibold\">{u.name || \"No name\"}</div>\n                      <div className=\"opacity-70\">{u.email}</div>\n                      <div className=\"opacity-60 text-xs\">\n                        Joined {new Date(u.createdAt).toLocaleDateString()}\n                      </div>\n                    </div>\n                    <div className=\"flex gap-2\">\n                      <button\n                        className=\"btn bg-red-600 hover:bg-red-700 text-xs\"\n                        onClick={() => banUser(u.email)}\n                      >\n                        Ban\n                      </button>\n                      <button\n                        className=\"btn bg-green-600 hover:bg-green-700 text-xs\"\n                        onClick={() => unbanUser(u.email)}\n                      >\n                        Unban\n                      </button>\n                    </div>\n                  </div>\n                ))}\n              </div>\n            )}\n          </div>\n\n          <div className=\"card\">\n            <h3 className=\"text-xl font-semibold mb-3\">System Health</h3>\n            <div className=\"text-sm opacity-80 mb-3\">\n              Current status of system components and services.\n            </div>\n            {systemHealth ? (\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                <div className=\"space-y-2\">\n                  <div className=\"flex items-center justify-between\">\n                    <span>Database</span>\n                    <span\n                      className={`px-2 py-1 rounded text-xs ${systemHealth.database ? \"bg-emerald-600\" : \"bg-red-600\"}`}\n                    >\n                      {systemHealth.database ? \"Ready\" : \"Down\"}\n                    </span>\n                  </div>\n                  <div className=\"flex items-center justify-between\">\n                    <span>WebSocket</span>\n                    <span\n                      className={`px-2 py-1 rounded text-xs ${systemHealth.websocket ? \"bg-emerald-600\" : \"bg-red-600\"}`}\n                    >\n                      {systemHealth.websocket ? \"Ready\" : \"Down\"}\n                    </span>\n                  </div>\n                  <div className=\"flex items-center justify-between\">\n                    <span>HTTPS</span>\n                    <span\n                      className={`px-2 py-1 rounded text-xs ${systemHealth.https ? \"bg-emerald-600\" : \"bg-amber-600\"}`}\n                    >\n                      {systemHealth.https ? \"Enabled\" : \"HTTP Only\"}\n                    </span>\n                  </div>\n                  <div className=\"flex items-center justify-between\">\n                    <span>Maintenance Mode</span>\n                    <span\n                      className={`px-2 py-1 rounded text-xs ${!systemHealth.maintenance ? \"bg-emerald-600\" : \"bg-red-600\"}`}\n                    >\n                      {!systemHealth.maintenance ? \"Normal\" : \"Active\"}\n                    </span>\n                  </div>\n                  <div className=\"flex items-center justify-between\">\n                    <span>Clustering (Auto-Scaling)</span>\n                    <span\n                      className={`px-2 py-1 rounded text-xs ${clusteringEnabled ? \"bg-emerald-600\" : \"bg-amber-600\"}`}\n                    >\n                      {clusteringEnabled ? \"Enabled\" : \"Disabled\"}\n                    </span>\n                  </div>\n                </div>\n                <div className=\"space-y-2\">\n                  <div className=\"text-sm\">\n                    <span className=\"font-semibold\">Uptime:</span>{\" \"}\n                    {Math.floor(systemHealth.uptime / 3600)}h{\" \"}\n                    {Math.floor((systemHealth.uptime % 3600) / 60)}m\n                  </div>\n                  <div className=\"text-sm\">\n                    <span className=\"font-semibold\">Memory:</span>{\" \"}\n                    {systemHealth.memory\n                      ? Math.round(systemHealth.memory.heapUsed / 1024 / 1024)\n                      : \"?\"}\n                    MB used\n                  </div>\n                  <div className=\"text-sm\">\n                    <span className=\"font-semibold\">Version:</span>{\" \"}\n                    {systemHealth.version}\n                  </div>\n                  <div className=\"flex gap-2 flex-wrap\">\n                    <button className=\"btn\" onClick={fetchSystemHealth}>\n                      Refresh\n                    </button>\n                    <button\n                      className={`btn ${clusteringEnabled ? \"bg-amber-600 hover:bg-amber-700\" : \"bg-emerald-600 hover:bg-emerald-700\"}`}\n                      disabled={loading}\n                      onClick={() => toggleClustering(!clusteringEnabled)}\n                    >\n                      {clusteringEnabled ? \"Disable\" : \"Enable\"} Clustering\n                    </button>\n                  </div>\n                </div>\n              </div>\n            ) : (\n              <div className=\"text-center py-4\">\n                <div className=\"text-sm opacity-60 mb-2\">\n                  Loading system health...\n                </div>\n                <button className=\"btn\" onClick={fetchSystemHealth}>\n                  Load Health Status\n                </button>\n              </div>\n            )}\n\n            <div className=\"mt-4 pt-4 border-t border-white/10\">\n              <h4 className=\"font-semibold mb-3\">Clustering Capacity</h4>\n              <div className=\"space-y-3\">\n                <div>\n                  <div className=\"flex items-center justify-between mb-2\">\n                    <label className=\"font-semibold\">\n                      Max Concurrent Users\n                    </label>\n                    <div className=\"flex gap-2\">\n                      <button\n                        className=\"btn\"\n                        onClick={() => setShowCreate(false)}\n                      >\n                        Close\n                      </button>\n                      <button\n                        className=\"btn\"\n                        onClick={broadcastTournaments}\n                        disabled={!isOwner || loading}\n                      >\n                        Force broadcast\n                      </button>\n                    </div>\n                  </div>\n                  <input\n                    type=\"range\"\n                    min=\"1500\"\n                    max=\"50000\"\n                    step=\"500\"\n                    value={clusterCapacity}\n                    onChange={(e) =>\n                      updateClusterCapacity(Number(e.target.value))\n                    }\n                    disabled={loading}\n                    className=\"w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed\"\n                    style={{\n                      background: clusteringEnabled\n                        ? `linear-gradient(to right, #3b82f6 0%, #3b82f6 ${((clusterCapacity - 1500) / (50000 - 1500)) * 100}%, #374151 ${((clusterCapacity - 1500) / (50000 - 1500)) * 100}%, #374151 100%)`\n                        : \"#374151\",\n                    }}\n                  />\n                  <div className=\"flex justify-between text-xs opacity-60 mt-1\">\n                    <span>1.5k</span>\n                    <span>50k</span>\n                  </div>\n                </div>\n                <div className=\"flex gap-2 flex-wrap\">\n                  <button\n                    className={`btn ${clusteringEnabled ? \"bg-amber-600 hover:bg-amber-700\" : \"bg-emerald-600 hover:bg-emerald-700\"}`}\n                    disabled={loading}\n                    onClick={() => toggleClustering(!clusteringEnabled)}\n                  >\n                    {clusteringEnabled ? \"Disable\" : \"Enable\"} Clustering\n                  </button>\n                </div>\n              </div>\n              <div className=\"text-xs opacity-70 mt-2 p-2 bg-white/5 rounded\">\n                 Clustering enables auto-scaling with capacity up to{\" \"}\n                {clusterCapacity.toLocaleString()} concurrent users. Adjust the\n                slider to set maximum capacity. NODE_WORKERS environment\n                variable is set to handle the configured load behind a reverse\n                proxy.\n              </div>\n            </div>\n          </div>\n\n          <div className=\"card\">\n            <h3 className=\"text-xl font-semibold mb-3\">User Reports</h3>\n            <ul className=\"space-y-2\">\n              {reports.map((r: any) => (\n                <li key={r.id} className=\"p-2 rounded bg-black/20 text-sm\">\n                  <div className=\"flex items-center justify-between\">\n                    <div>\n                      <div className=\"font-mono text-xs\">{r.id}</div>\n                      <div>\n                        <span className=\"font-semibold\">{r.reporter}</span> {\" \"}\n                        <span className=\"font-semibold\">{r.offender}</span> {\" \"}\n                        {new Date(r.ts).toLocaleString()}\n                      </div>\n                      <div className=\"opacity-80\">Reason: {r.reason}</div>\n                      {r.messageId && (\n                        <div className=\"opacity-60 text-xs\">\n                          Message ID: {r.messageId}\n                        </div>\n                      )}\n                    </div>\n                    <div className=\"flex gap-2\">\n                      <span\n                        className={`px-2 py-0.5 rounded text-xs ${r.status === \"open\" ? \"bg-amber-600\" : \"bg-emerald-600\"}`}\n                      >\n                        {r.status}\n                      </span>\n                      {r.status === \"open\" && (\n                        <>\n                          <button\n                            className=\"btn bg-emerald-600 hover:bg-emerald-700\"\n                            disabled={loading}\n                            onClick={async () => {\n                              await fetch(\"/api/admin/reports/resolve\", {\n                                method: \"POST\",\n                                headers: {\n                                  \"Content-Type\": \"application/json\",\n                                  Authorization: `Bearer ${localStorage.getItem(\"authToken\")}`,\n                                },\n                                body: JSON.stringify({\n                                  id: r.id,\n                                  action: \"resolved\",\n                                }),\n                              });\n                              await refresh();\n                            }}\n                          >\n                            Resolve\n                          </button>\n                          <button\n                            className=\"btn bg-rose-600 hover:bg-rose-700\"\n                            disabled={loading}\n                            onClick={async () => {\n                              const notes =\n                                prompt(\n                                  \"Enter notes for action taken (e.g., warning, block):\",\n                                ) || \"\";\n                              await fetch(\"/api/admin/reports/resolve\", {\n                                method: \"POST\",\n                                headers: {\n                                  \"Content-Type\": \"application/json\",\n                                  Authorization: `Bearer ${localStorage.getItem(\"authToken\")}`,\n                                },\n                                body: JSON.stringify({\n                                  id: r.id,\n                                  action: \"actioned\",\n                                  notes,\n                                }),\n                              });\n                              await refresh();\n                            }}\n                          >\n                            Action\n                          </button>\n                        </>\n                      )}\n                    </div>\n                  </div>\n                </li>\n              ))}\n              {reports.length === 0 && (\n                <li className=\"opacity-60\">No reports.</li>\n              )}\n            </ul>\n          </div>\n\n          <div className=\"card\">\n            <h3 className=\"text-xl font-semibold mb-3\">Open Matches</h3>\n            <ul className=\"space-y-1\">\n              {(status?.matches || []).map((m: any) => (\n                <li\n                  key={m.id}\n                  className=\"flex items-center justify-between p-2 rounded bg-black/20 text-sm\"\n                >\n                  <div className=\"flex items-center gap-3\">\n                    <span className=\"font-mono text-xs\">{m.id}</span>\n                    <span className=\"opacity-80\">{m.creatorName}</span>\n                    <span className=\"opacity-60\">\n                      {m.game}  {labelForMode(m.mode)} {m.value}{\" \"}\n                      {m.game === \"X01\" ? `/${m.startingScore}` : \"\"}\n                    </span>\n                  </div>\n                  <button\n                    className=\"btn bg-rose-600 hover:bg-rose-700\"\n                    disabled={loading}\n                    onClick={() => deleteMatch(m.id)}\n                  >\n                    Remove\n                  </button>\n                </li>\n              ))}\n              {(!status?.matches || status.matches.length === 0) && (\n                <li className=\"text-sm opacity-60\">No open matches.</li>\n              )}\n            </ul>\n          </div>\n\n          <div className=\"card\">\n            <h3 className=\"text-xl font-semibold mb-3\">Dangerous Operations</h3>\n            <div className=\"text-sm opacity-80 mb-3 text-red-400\">\n               These operations can cause data loss or service disruption. Use\n              with extreme caution.\n            </div>\n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n              <div>\n                <div className=\"font-semibold mb-2 text-red-400\">\n                  Tournament Deletion\n                </div>\n                <ul className=\"space-y-2\">\n                  {tournaments.map((t: any) => (\n                    <li\n                      key={t.id}\n                      className=\"p-2 rounded bg-red-900/20 border border-red-500/40 text-sm\"\n                    >\n                      <div className=\"flex items-center justify-between\">\n                        <div className=\"font-semibold\">{t.title}</div>\n                        <div className=\"opacity-70\">{t.status}</div>\n                      </div>\n                      <div className=\"opacity-80\">\n                        {t.game}  {labelForMode(t.mode)} {t.value}\n                      </div>\n                      <div className=\"mt-2\">\n                        <button\n                          className=\"btn bg-red-600 hover:bg-red-700 text-xs\"\n                          disabled={loading}\n                          onClick={() => deleteTournament(t.id)}\n                        >\n                          Delete Tournament\n                        </button>\n                      </div>\n                    </li>\n                  ))}\n                  {tournaments.length === 0 && (\n                    <li className=\"opacity-60\">No tournaments.</li>\n                  )}\n                </ul>\n              </div>\n              <div>\n                <div className=\"font-semibold mb-2 text-red-400\">\n                  System Maintenance\n                </div>\n                <div className=\"space-y-2\">\n                  <div className=\"p-3 rounded bg-red-900/20 border border-red-500/40\">\n                    <div className=\"font-semibold text-red-400 mb-2\">\n                      Maintenance Mode\n                    </div>\n                    <div className=\"text-sm opacity-80 mb-3\">\n                      Put the entire site into maintenance mode. Users won't be\n                      able to access games or create matches.\n                    </div>\n                    <div className=\"flex items-center gap-2\">\n                      <span\n                        className={`px-2 py-1 rounded text-xs ${status?.maintenance ? \"bg-red-600\" : \"bg-green-600\"}`}\n                      >\n                        {status?.maintenance\n                          ? \"MAINTENANCE ACTIVE\"\n                          : \"NORMAL OPERATION\"}\n                      </span>\n                      <button\n                        className={`btn ${status?.maintenance ? \"bg-green-600 hover:bg-green-700\" : \"bg-red-600 hover:bg-red-700\"}`}\n                        disabled={loading}\n                        onClick={() => toggleMaintenance(!status?.maintenance)}\n                      >\n                        {status?.maintenance ? \"Disable\" : \"Enable\"}\n                      </button>\n                    </div>\n                  </div>\n                </div>\n              </div>\n            </div>\n          </div>\n          {selectedRequest && (\n            <HelpdeskChat\n              request={selectedRequest}\n              user={{\n                email: user?.email,\n                username: user?.username,\n                isAdmin: true,\n              }}\n              onClose={() => setSelectedRequest(null)}\n            />\n          )}\n        </>\n      )}\n      {activeTab === \"premium\" && isOwner && (\n        <>\n          <div className=\"card\">\n            <h3 className=\"text-xl font-semibold mb-2\">\n              Premium Subscription Grants\n            </h3>\n            <div className=\"text-sm opacity-80 mb-3\">\n              Grant or revoke premium subscriptions for users (grants 30 days).\n            </div>\n            <div className=\"flex gap-2 mb-3\">\n              <input\n                className=\"input flex-1\"\n                placeholder=\"user@example.com\"\n                value={email}\n                onChange={(e) => setEmail(e.target.value)}\n              />\n              <button\n                className=\"btn\"\n                disabled={loading || !email.trim()}\n                onClick={() => grantPremium(email, 30)}\n              >\n                Grant\n              </button>\n              <button\n                className=\"btn bg-rose-600 hover:bg-rose-700\"\n                disabled={loading}\n                onClick={() => revokePremium(email)}\n              >\n                Revoke\n              </button>\n            </div>\n            <div className=\"text-sm opacity-80 mb-2\">\n              Premium users get 30 days of access to all features.\n            </div>\n          </div>\n\n          <div className=\"card\">\n            <h3 className=\"text-xl font-semibold mb-2\">Premium Winners</h3>\n            <div className=\"text-sm opacity-80 mb-2\">\n              Users who have won premium through tournaments.\n            </div>\n            <div className=\"space-y-2\">\n              {winners.map((w: any) => (\n                <div\n                  key={w.email}\n                  className=\"p-2 rounded bg-black/20 text-sm flex items-center justify-between\"\n                >\n                  <div>\n                    <div className=\"font-semibold\">{w.name || \"No name\"}</div>\n                    <div className=\"opacity-70\">{w.email}</div>\n                    <div className=\"opacity-60 text-xs\">\n                      Expires {new Date(w.expiresAt).toLocaleDateString()}\n                    </div>\n                  </div>\n                  <div className=\"flex gap-2\">\n                    {!w.expired ? (\n                      <span className=\"px-2 py-1 rounded bg-emerald-600 text-xs\">\n                        Premium Active\n                      </span>\n                    ) : (\n                      <span className=\"px-2 py-1 rounded bg-amber-600 text-xs\">\n                        Premium Expired\n                      </span>\n                    )}\n                  </div>\n                </div>\n              ))}\n              {winners.length === 0 && (\n                <div className=\"opacity-60\">No premium winners.</div>\n              )}\n            </div>\n          </div>\n        </>\n      )}\n      {activeTab === \"tourneys\" && isOwner && (\n        <>\n          <div className=\"card\">\n            <h3 className=\"text-xl font-semibold mb-3\">\n              Create Official Tournament\n            </h3>\n            <div className=\"text-sm opacity-80 mb-3\">\n              Set up a new official tournament with custom rules, timing, and\n              prizes.\n            </div>\n            <div className=\"space-y-2\">\n              <input\n                className=\"input w-full\"\n                placeholder=\"Tournament Title\"\n                value={createForm.title}\n                onChange={(e) =>\n                  setCreateForm((f: any) => ({ ...f, title: e.target.value }))\n                }\n              />\n              <div className=\"grid grid-cols-3 gap-2\">\n                <select\n                  className=\"input\"\n                  value={createForm.game}\n                  onChange={(e) =>\n                    setCreateForm((f: any) => ({ ...f, game: e.target.value }))\n                  }\n                >\n                  {[\n                    \"X01\",\n                    \"Around the Clock\",\n                    \"Cricket\",\n                    \"Halve It\",\n                    \"Shanghai\",\n                    \"High-Low\",\n                  ].map((g) => (\n                    <option key={g} value={g}>\n                      {g}\n                    </option>\n                  ))}\n                </select>\n                <select\n                  className=\"input\"\n                  value={createForm.mode}\n                  onChange={(e) =>\n                    setCreateForm((f: any) => ({ ...f, mode: e.target.value }))\n                  }\n                >\n                  {getModeOptionsForGame(createForm.game).map((opt) => (\n                    <option key={String(opt)} value={String(opt)}>\n                      {labelForMode(String(opt))}\n                    </option>\n                  ))}\n                </select>\n                {(() => {\n                  const vals = getModeValueOptionsForGame(\n                    createForm.game,\n                    createForm.mode,\n                  );\n                  if (vals && vals.length > 0) {\n                    return (\n                      <select\n                        className=\"input\"\n                        value={String(createForm.value)}\n                        onChange={(e) =>\n                          setCreateForm((f: any) => ({\n                            ...f,\n                            value: Number(e.target.value),\n                          }))\n                        }\n                      >\n                        {vals.map((v) => (\n                          <option key={v} value={String(v)}>\n                            {v}\n                          </option>\n                        ))}\n                      </select>\n                    );\n                  }\n                  return (\n                    <input\n                      className=\"input\"\n                      type=\"number\"\n                      min={1}\n                      value={createForm.value}\n                      onChange={(e) =>\n                        setCreateForm((f: any) => ({\n                          ...f,\n                          value: Number(e.target.value),\n                        }))\n                      }\n                    />\n                  );\n                })()}\n              </div>\n              <textarea\n                className=\"input w-full\"\n                rows={2}\n                placeholder=\"Description\"\n                value={createForm.description}\n                onChange={(e) =>\n                  setCreateForm((f: any) => ({\n                    ...f,\n                    description: e.target.value,\n                  }))\n                }\n              />\n              <div className=\"grid grid-cols-2 gap-2\">\n                <input\n                  className=\"input\"\n                  type=\"datetime-local\"\n                  value={createForm.startAt}\n                  onChange={(e) =>\n                    setCreateForm((f: any) => ({\n                      ...f,\n                      startAt: e.target.value,\n                    }))\n                  }\n                />\n                <input\n                  className=\"input\"\n                  type=\"number\"\n                  min={0}\n                  placeholder=\"Checkin minutes\"\n                  value={createForm.checkinMinutes}\n                  onChange={(e) =>\n                    setCreateForm((f: any) => ({\n                      ...f,\n                      checkinMinutes: Number(e.target.value),\n                    }))\n                  }\n                />\n              </div>\n              <input\n                className=\"input w-full\"\n                type=\"number\"\n                min={6}\n                max={64}\n                placeholder=\"Capacity\"\n                value={createForm.capacity}\n                onChange={(e) =>\n                  setCreateForm((f: any) => ({\n                    ...f,\n                    capacity: Number(e.target.value),\n                  }))\n                }\n              />\n              <div className=\"grid grid-cols-2 gap-2 items-center\">\n                <select className=\"input\" value=\"premium\" disabled>\n                  <option value=\"premium\">PREMIUM</option>\n                </select>\n                <select\n                  className=\"input\"\n                  value={createForm.prizeAmount}\n                  onChange={(e) =>\n                    setCreateForm((f: any) => ({\n                      ...f,\n                      prizeType: \"premium\",\n                      prizeAmount: Number(e.target.value),\n                    }))\n                  }\n                >\n                  <option value={1}>1 month</option>\n                  <option value={3}>3 months</option>\n                </select>\n              </div>\n              <input\n                className=\"input w-full\"\n                placeholder=\"Prize notes (optional)\"\n                value={createForm.prizeNotes}\n                onChange={(e) =>\n                  setCreateForm((f: any) => ({\n                    ...f,\n                    prizeNotes: e.target.value,\n                  }))\n                }\n              />\n              <div className=\"flex justify-end\">\n                <button\n                  className=\"btn bg-emerald-600 hover:bg-emerald-700\"\n                  disabled={loading}\n                  onClick={createOfficialTournament}\n                >\n                  Create Tournament\n                </button>\n              </div>\n            </div>\n          </div>\n\n          <div className=\"card\">\n            <h3 className=\"text-xl font-semibold mb-3\">\n              Tournament Premium Winners\n            </h3>\n            <div className=\"text-sm opacity-80 mb-3\">\n              Users who have won premium prizes in tournaments. Grant them\n              access here.\n            </div>\n            <div className=\"space-y-2\">\n              {tournaments\n                .filter(\n                  (t: any) =>\n                    t.status === \"completed\" &&\n                    t.winnerEmail &&\n                    t.prizeType === \"premium\",\n                )\n                .map((t: any) => {\n                  const winner = winners.find(\n                    (w: any) => w.email === t.winnerEmail,\n                  );\n                  const hasAccess = winner && !winner.expired;\n                  return (\n                    <div key={t.id} className=\"p-3 rounded bg-black/20 text-sm\">\n                      <div className=\"flex items-center justify-between mb-2\">\n                        <div className=\"font-semibold\">{t.title}</div>\n                        <div className=\"text-xs opacity-70\">\n                          {new Date(t.startAt).toLocaleDateString()}\n                        </div>\n                      </div>\n                      <div className=\"flex items-center justify-between\">\n                        <div>\n                          <div className=\"font-medium\">{t.winnerEmail}</div>\n                          <div className=\"text-xs opacity-70\">\n                            Prize: {t.prizeAmount} month\n                            {t.prizeAmount > 1 ? \"s\" : \"\"} PREMIUM\n                          </div>\n                        </div>\n                        <div className=\"flex items-center gap-2\">\n                          {hasAccess ? (\n                            <span className=\"px-2 py-1 rounded bg-emerald-600 text-xs\">\n                               Access Granted\n                            </span>\n                          ) : (\n                            <button\n                              className=\"btn bg-emerald-600 hover:bg-emerald-700 text-xs\"\n                              disabled={loading}\n                              onClick={() =>\n                                grantPremium(t.winnerEmail, t.prizeAmount * 30)\n                              }\n                            >\n                              Grant Access\n                            </button>\n                          )}\n                        </div>\n                      </div>\n                    </div>\n                  );\n                })}\n              {tournaments.filter(\n                (t: any) =>\n                  t.status === \"completed\" &&\n                  t.winnerEmail &&\n                  t.prizeType === \"premium\",\n              ).length === 0 && (\n                <div className=\"text-center py-4 text-sm opacity-60\">\n                  No completed premium tournaments.\n                </div>\n              )}\n            </div>\n          </div>\n\n          <div className=\"card\">\n            <h3 className=\"text-xl font-semibold mb-3\">Manage Tournaments</h3>\n            <div className=\"text-sm opacity-80 mb-3\">\n              View and manage all tournaments. Set winners and manage brackets.\n            </div>\n            <ul className=\"space-y-2\">\n              {tournaments.map((t: any) => (\n                <li key={t.id} className=\"p-3 rounded bg-black/20 text-sm\">\n                  <div className=\"flex items-center justify-between mb-2\">\n                    <div>\n                      <div className=\"font-semibold\">{t.title}</div>\n                      <div className=\"opacity-80\">\n                        {t.game}  {labelForMode(t.mode)} {t.value}\n                      </div>\n                    </div>\n                    <div\n                      className={`px-2 py-1 rounded text-xs font-semibold ${\n                        t.status === \"scheduled\"\n                          ? \"bg-blue-600\"\n                          : t.status === \"running\"\n                            ? \"bg-green-600\"\n                            : t.status === \"completed\"\n                              ? \"bg-purple-600\"\n                              : \"bg-gray-600\"\n                      }`}\n                    >\n                      {t.status}\n                    </div>\n                  </div>\n                  <div className=\"text-xs opacity-70 mb-2\">\n                    Start: {new Date(t.startAt).toLocaleString()}  Capacity:{\" \"}\n                    {t.capacity}\n                  </div>\n                  {t.prize && (\n                    <div className=\"text-xs mb-2\">\n                      Prize: {t.prizeAmount || 3} month\n                      {(t.prizeAmount || 3) > 1 ? \"s\" : \"\"} PREMIUM\n                    </div>\n                  )}\n                  <div className=\"mt-2 flex flex-wrap gap-2\">\n                    <button\n                      className=\"btn text-xs\"\n                      disabled={loading || t.status !== \"scheduled\"}\n                      onClick={() =>\n                        setWinner(t.id, prompt(\"Winner email?\") || \"\")\n                      }\n                    >\n                      Set Winner\n                    </button>\n                    <button\n                      className=\"btn text-xs\"\n                      disabled={loading}\n                      onClick={() => reseedWeekly()}\n                    >\n                      Reseed\n                    </button>\n                  </div>\n                </li>\n              ))}\n              {tournaments.length === 0 && (\n                <li className=\"opacity-60\">No tournaments.</li>\n              )}\n            </ul>\n          </div>\n        </>\n      )}\n      {activeTab === \"helpdesk\" && isOwner && (\n        <>\n          <div className=\"card\">\n            <h3 className=\"text-lg font-semibold mb-2\">Helpdesk Requests</h3>\n            <div className=\"text-sm opacity-80 mb-3\">\n              All help requests from users who asked to speak with an admin.\n              Status is shown for each request.\n            </div>\n            {helpRequests.length === 0 ? (\n              <div className=\"text-sm opacity-70\">No help requests.</div>\n            ) : (\n              <div className=\"space-y-2\">\n                {helpRequests.map((hr) => (\n                  <div\n                    key={hr.id}\n                    className=\"p-2 rounded bg-black/10 border border-white/10 flex items-center justify-between\"\n                  >\n                    <div>\n                      <div className=\"font-medium\">\n                        {hr.username || \"Anonymous\"}\n                      </div>\n                      <div className=\"text-xs opacity-70\">\n                        {new Date(hr.ts || 0).toLocaleString()}\n                      </div>\n                      <div className=\"text-sm mt-1\">{hr.message}</div>\n                      <div className=\"mt-1\">\n                        <span\n                          className={`text-xs px-2 py-1 rounded-full mr-2 ${hr.status === \"open\" ? \"bg-emerald-700/30 text-emerald-200\" : hr.status === \"claimed\" ? \"bg-amber-700/30 text-amber-200\" : \"bg-slate-700/30 text-slate-200\"}`}\n                        >\n                          {hr.status || \"unknown\"}\n                        </span>\n                        {hr.claimedBy && (\n                          <span className=\"text-xs opacity-70\">\n                            by {hr.claimedBy}\n                          </span>\n                        )}\n                      </div>\n                      {helpTyping[hr.id] && (\n                        <div className=\"text-xs text-amber-300 mt-1\">\n                          {helpTyping[hr.id].who} typing...\n                        </div>\n                      )}\n                    </div>\n                    <div className=\"flex items-center gap-2\">\n                      {hr.status === \"open\" && (\n                        <button\n                          className=\"btn\"\n                          onClick={() => claimHelp(hr.id)}\n                        >\n                          Claim\n                        </button>\n                      )}\n                      {hr.status !== \"resolved\" && (\n                        <button\n                          className=\"btn btn-ghost\"\n                          onClick={() => resolveHelp(hr.id)}\n                        >\n                          Resolve\n                        </button>\n                      )}\n                      <button\n                        className=\"btn\"\n                        onClick={() => setSelectedRequest(hr)}\n                      >\n                        Chat\n                      </button>\n                    </div>\n                  </div>\n                ))}\n              </div>\n            )}\n          </div>\n        </>\n      )}\n      {/* Inline email preview overlay */}\n      {preview.open && (\n        <div\n          className=\"fixed inset-0 z-[1000]\"\n          onClick={() => setPreview({ open: false })}\n        >\n          <div className=\"absolute inset-0 bg-black/70 backdrop-blur-sm\" />\n          <div className=\"absolute inset-0 p-4 md:p-8 overflow-auto flex items-start md:items-center justify-center\">\n            <div\n              className=\"w-full max-w-3xl bg-[#0b1020] rounded-2xl border border-indigo-500/40 shadow-2xl\"\n              onClick={(e) => e.stopPropagation()}\n            >\n              <div className=\"flex items-center justify-between px-4 py-3 border-b border-indigo-500/20\">\n                <div className=\"font-semibold\">Preview: {preview.kind}</div>\n                <button\n                  className=\"btn\"\n                  onClick={() => setPreview({ open: false })}\n                >\n                  Close\n                </button>\n              </div>\n              <div className=\"p-0 bg-black/30\">\n                <iframe\n                  title=\"Email Preview\"\n                  style={{\n                    width: \"100%\",\n                    height: \"70vh\",\n                    border: \"0\",\n                    background: \"transparent\",\n                  }}\n                  srcDoc={preview.html || \"\"}\n                />\n              </div>\n              <div className=\"px-4 py-3 border-t border-indigo-500/20 text-xs opacity-70\">\n                Click outside this panel or press Esc to close.\n              </div>\n            </div>\n          </div>\n        </div>\n      )}\n    </div>\n  );\n}\n","import React, {\n  createContext,\n  useContext,\n  useEffect,\n  useMemo,\n  useState,\n} from \"react\";\n\nexport type ThemeName =\n  | \"default\"\n  | \"halloween\"\n  | \"easter\"\n  | \"summer\"\n  | \"christmas\";\n\nexport type ColorMode = \"system\" | \"dark\" | \"light\";\n\ntype ThemeContextShape = {\n  theme: ThemeName;\n  setTheme: (t: ThemeName) => void;\n  auto: boolean;\n  setAuto: (v: boolean) => void;\n  colorMode: ColorMode;\n  setColorMode: (m: ColorMode) => void;\n};\n\nconst ThemeContext = createContext<ThemeContextShape | null>(null);\n\nconst STORAGE_KEY = \"ndn:theme\";\nconst COLOR_MODE_KEY = \"ndn:colorMode\";\n\nfunction detectSeasonalTheme(date = new Date()): ThemeName {\n  const m = date.getMonth(); // 0-based\n  const d = date.getDate();\n  // Halloween: Oct 20 - Nov 5\n  if (m === 9 || (m === 10 && d <= 5)) return \"halloween\";\n  // Christmas / Winter: Dec 15 - Feb 14\n  if (m === 11 || m === 0 || (m === 1 && d <= 14)) return \"christmas\";\n  // Easter: approximate: March-April\n  if (m === 2 || m === 3) return \"easter\";\n  // Summer: Jun-Aug\n  if (m >= 5 && m <= 7) return \"summer\";\n  return \"default\";\n}\n\nexport function ThemeProvider({ children }: { children: React.ReactNode }) {\n  const [auto, setAuto] = useState<boolean>(() => {\n    try {\n      const raw = localStorage.getItem(`${STORAGE_KEY}:auto`);\n      return raw ? JSON.parse(raw) : true;\n    } catch {\n      return true;\n    }\n  });\n\n  const [theme, setThemeState] = useState<ThemeName>(() => {\n    try {\n      const raw = localStorage.getItem(STORAGE_KEY);\n      if (raw) return raw as ThemeName;\n    } catch {\n      /* ignore */\n    }\n    return detectSeasonalTheme();\n  });\n\n  const [colorMode, setColorModeState] = useState<ColorMode>(() => {\n    try {\n      const raw = localStorage.getItem(COLOR_MODE_KEY);\n      if (raw === \"dark\" || raw === \"light\" || raw === \"system\") return raw;\n    } catch {\n      /* ignore */\n    }\n    return \"system\";\n  });\n\n  useEffect(() => {\n    try {\n      localStorage.setItem(COLOR_MODE_KEY, colorMode);\n    } catch {}\n  }, [colorMode]);\n\n  useEffect(() => {\n    const applyAttr = (m: Exclude<ColorMode, \"system\">) => {\n      try {\n        document.documentElement.setAttribute(\"data-color-mode\", m);\n      } catch {}\n    };\n\n    if (colorMode === \"dark\") {\n      applyAttr(\"dark\");\n      return;\n    }\n    if (colorMode === \"light\") {\n      applyAttr(\"light\");\n      return;\n    }\n\n    // system\n    const mq =\n      typeof window !== \"undefined\"\n        ? window.matchMedia?.(\"(prefers-color-scheme: dark)\")\n        : null;\n    const sync = () => applyAttr(mq?.matches ? \"dark\" : \"light\");\n    sync();\n    try {\n      mq?.addEventListener?.(\"change\", sync);\n    } catch {}\n    return () => {\n      try {\n        mq?.removeEventListener?.(\"change\", sync);\n      } catch {}\n    };\n  }, [colorMode]);\n\n  useEffect(() => {\n    try {\n      localStorage.setItem(`${STORAGE_KEY}:auto`, JSON.stringify(auto));\n    } catch {}\n  }, [auto]);\n\n  useEffect(() => {\n    const applied = auto ? detectSeasonalTheme() : theme;\n    // set a data attr on <html> to allow CSS scoping via [data-theme=\"x\"]\n    try {\n      if (applied === \"default\")\n        document.documentElement.removeAttribute(\"data-theme\");\n      else document.documentElement.setAttribute(\"data-theme\", applied);\n    } catch {}\n  }, [theme, auto]);\n\n  const setTheme = (t: ThemeName) => {\n    try {\n      localStorage.setItem(STORAGE_KEY, t);\n    } catch {}\n    setThemeState(t);\n  };\n\n  const setColorMode = (m: ColorMode) => {\n    try {\n      localStorage.setItem(COLOR_MODE_KEY, m);\n    } catch {}\n    setColorModeState(m);\n  };\n\n  const value = useMemo(\n    () => ({ theme, setTheme, auto, setAuto, colorMode, setColorMode }),\n    [theme, auto, colorMode],\n  );\n\n  return (\n    <ThemeContext.Provider value={value}>{children}</ThemeContext.Provider>\n  );\n}\n\nexport function useTheme() {\n  const ctx = useContext(ThemeContext);\n  if (!ctx) throw new Error(\"useTheme must be used inside ThemeProvider\");\n  return ctx;\n}\n\nexport default ThemeProvider;\n","import React from \"react\";\nimport { useTheme, ThemeName } from \"../contexts/ThemeProvider\";\n\nconst ALL_THEMES: ThemeName[] = [\n  \"default\",\n  \"halloween\",\n  \"easter\",\n  \"summer\",\n  \"christmas\",\n];\n\n// Theme metadata: icon, label, gradient colors\nconst THEME_META: Record<\n  ThemeName,\n  { icon: string; label: string; gradient: string; ring: string }\n> = {\n  default: {\n    icon: \"\",\n    label: \"Default\",\n    gradient: \"from-slate-600 to-slate-800\",\n    ring: \"ring-slate-400\",\n  },\n  christmas: {\n    icon: \"\",\n    label: \"Christmas\",\n    gradient: \"from-red-600 to-green-700\",\n    ring: \"ring-red-400\",\n  },\n  easter: {\n    icon: \"\",\n    label: \"Easter\",\n    gradient: \"from-pink-400 to-purple-400\",\n    ring: \"ring-pink-300\",\n  },\n  halloween: {\n    icon: \"\",\n    label: \"Halloween\",\n    gradient: \"from-orange-500 to-purple-800\",\n    ring: \"ring-orange-400\",\n  },\n  summer: {\n    icon: \"\",\n    label: \"Summer\",\n    gradient: \"from-yellow-400 to-sky-400\",\n    ring: \"ring-yellow-300\",\n  },\n};\n\nexport default function ThemeToggle() {\n  const { theme, setTheme, auto, setAuto, colorMode, setColorMode } =\n    useTheme();\n\n  return (\n    <div\n      className=\"theme-toggle space-y-4\"\n      role=\"group\"\n      aria-label=\"Theme selector\"\n    >\n      {/* Light / Dark selector */}\n      <div className=\"space-y-2\">\n        <div className=\"text-sm font-medium\">Color mode</div>\n        <div className=\"flex flex-wrap gap-2\">\n          {[\n            { key: \"system\" as const, label: \"System\" },\n            { key: \"dark\" as const, label: \"Dark\" },\n            { key: \"light\" as const, label: \"Light\" },\n          ].map((m) => (\n            <button\n              key={m.key}\n              type=\"button\"\n              aria-pressed={colorMode === m.key}\n              onClick={() => setColorMode(m.key)}\n              className={`btn btn--ghost px-3 py-1 text-sm ${\n                colorMode === m.key\n                  ? \"ring-2 ring-indigo-400/70 bg-white/10\"\n                  : \"bg-white/5\"\n              }`}\n            >\n              {m.label}\n            </button>\n          ))}\n        </div>\n      </div>\n\n      {/* Auto toggle */}\n      <label className=\"flex items-center gap-3 cursor-pointer select-none\">\n        <div\n          onClick={() => setAuto(!auto)}\n          className={`relative w-11 h-6 rounded-full transition-colors ${\n            auto ? \"bg-gradient-to-r from-cyan-500 to-blue-500\" : \"bg-white/20\"\n          }`}\n        >\n          <span\n            className={`absolute top-0.5 left-0.5 w-5 h-5 bg-white rounded-full shadow transition-transform ${\n              auto ? \"translate-x-5\" : \"\"\n            }`}\n          />\n        </div>\n        <span className=\"text-sm font-medium\">Auto seasonal theme </span>\n      </label>\n\n      {/* Theme pills */}\n      <div className=\"flex flex-wrap gap-2\">\n        {ALL_THEMES.map((t) => {\n          const meta = THEME_META[t];\n          const selected = theme === t;\n          return (\n            <button\n              key={t}\n              onClick={() => setTheme(t)}\n              disabled={auto}\n              aria-pressed={selected}\n              title={`Set ${meta.label} theme`}\n              className={`\n                relative flex items-center gap-2 px-4 py-2 rounded-full text-sm font-semibold\n                transition-all duration-200 shadow-md\n                ${auto ? \"opacity-50 cursor-not-allowed\" : \"hover:scale-105 active:scale-95\"}\n                ${selected ? `bg-gradient-to-r ${meta.gradient} text-white ring-2 ${meta.ring} ring-offset-2 ring-offset-black/50` : \"bg-white/10 text-white/80 hover:bg-white/20\"}\n              `}\n            >\n              <span className=\"text-lg\">{meta.icon}</span>\n              <span>{meta.label} </span>\n              {selected && (\n                <span className=\"ml-1 w-2 h-2 rounded-full bg-white animate-pulse\" />\n              )}\n            </button>\n          );\n        })}\n      </div>\n    </div>\n  );\n}\n","import React, { useEffect, useState } from \"react\";\nimport {\n  User,\n  Settings,\n  Volume2,\n  Camera,\n  Gamepad2,\n  Eye,\n  Save,\n  Edit3,\n  Shield,\n  HelpCircle,\n  MessageCircle,\n  Send,\n  ChevronDown,\n} from \"lucide-react\";\nimport { useUserSettings } from \"../store/userSettings\";\nimport ThemeToggle from \"./ThemeToggle\";\nimport { apiFetch } from \"../utils/api\";\n\nexport default function SettingsPanel({ user }: { user?: any }) {\n  const __TEST_MODE__ =\n    typeof process !== \"undefined\" && process.env?.NODE_ENV === \"test\";\n  const {\n    favoriteDouble,\n    callerEnabled,\n    callerVoice,\n    callerVolume,\n    speakCheckoutOnly,\n    avgMode,\n    autoStartOffline,\n    rememberLastOffline,\n    reducedMotion,\n    compactHeader,\n    allowSpectate,\n    cameraScale,\n    cameraAspect,\n    cameraFitMode,\n    autoscoreProvider,\n    autoscoreWsUrl,\n    autoCommitMode,\n    confirmUncertainDarts,\n    autoScoreConfidenceThreshold,\n    autoscoreDetectorMinArea,\n    autoscoreDetectorThresh,\n    autoscoreDetectorRequireStableN,\n    harshLightingMode,\n    enhanceBigTrebles,\n    cameraRecordDarts,\n    cameraShowLabels,\n    calibrationGuide: _calibrationGuide,\n    preferredCameraId: _preferredCameraId,\n    preferredCameraLabel: _preferredCameraLabel,\n    cameraEnabled,\n    offlineLayout,\n    textSize: _textSize,\n    boxSize: _boxSize,\n    setFavoriteDouble,\n    setCallerEnabled,\n    setCallerVoice,\n    setCallerVolume,\n    setSpeakCheckoutOnly,\n    setAvgMode,\n    setAutoStartOffline,\n    setRememberLastOffline,\n    setReducedMotion,\n    setCompactHeader,\n    setAllowSpectate,\n    setCameraScale,\n    setCameraAspect,\n    setCameraFitMode,\n    setAutoscoreProvider,\n    setAutoscoreWsUrl,\n    setAutoCommitMode,\n    setConfirmUncertainDarts,\n    setAutoScoreConfidenceThreshold,\n    setAutoscoreDetectorMinArea,\n    setAutoscoreDetectorThresh,\n    setAutoscoreDetectorRequireStableN,\n    setHarshLightingMode,\n    setEnhanceBigTrebles,\n    setCameraRecordDarts,\n    setCameraShowLabels,\n    cameraLowLatency,\n    setCameraLowLatency,\n    cameraProcessingFps,\n    setCameraProcessingFps,\n    setCalibrationGuide: _setCalibrationGuide,\n    preserveCalibrationOverlay,\n    setPreserveCalibrationOverlay,\n    preserveCalibrationOnCameraChange,\n    setPreserveCalibrationOnCameraChange,\n    setPreferredCamera: _setPreferredCamera,\n    setCameraEnabled,\n    setOfflineLayout,\n    setTextSize: _setTextSize,\n    setBoxSize: _setBoxSize,\n    dartTimerEnabled,\n    dartTimerSeconds,\n    setDartTimerEnabled,\n    setDartTimerSeconds,\n    x01DoubleIn,\n    setX01DoubleIn,\n  } = useUserSettings();\n\n  // Achievements state\n  const [achievements, setAchievements] = useState([\n    {\n      key: \"first180\",\n      label: \"First 180\",\n      unlocked: false,\n      icon: \"\",\n      desc: \"Score 180 in a match.\",\n    },\n    {\n      key: \"hundredGames\",\n      label: \"100 Games Played\",\n      unlocked: false,\n      icon: \"\",\n      desc: \"Play 100 games.\",\n    },\n    {\n      key: \"tournamentWin\",\n      label: \"Tournament Winner\",\n      unlocked: false,\n      icon: \"\",\n      desc: \"Win a tournament.\",\n    },\n    {\n      key: \"bestLeg\",\n      label: \"Best Leg\",\n      unlocked: false,\n      icon: \"\",\n      desc: \"Finish a leg in 12 darts or less.\",\n    },\n    {\n      key: \"comeback\",\n      label: \"Comeback\",\n      unlocked: false,\n      icon: \"\",\n      desc: \"Win after trailing by 3 legs.\",\n    },\n  ]);\n\n  useEffect(() => {\n    const uname = user?.username || \"\";\n    if (!uname) return;\n    setAchievements((prev) =>\n      prev.map((a) => ({\n        ...a,\n        unlocked: !!localStorage.getItem(`ndn:achieve:${a.key}:${uname}`),\n      })),\n    );\n  }, [user?.username]);\n\n  // Listen for external requests to open the Profile/User pill (from Home or elsewhere)\n  useEffect(() => {\n    function onOpenProfile() {\n      try {\n        setExpandedPill(\"user\");\n      } catch {}\n    }\n    window.addEventListener(\"ndn:open-settings-profile\", onOpenProfile as any);\n    return () =>\n      window.removeEventListener(\n        \"ndn:open-settings-profile\",\n        onOpenProfile as any,\n      );\n  }, []);\n\n  // Profile bio fields with edit mode\n  const [isEditing, setIsEditing] = useState(false);\n  const [favPlayer, setFavPlayer] = useState(\"\");\n  const [favTeam, setFavTeam] = useState(\"\");\n  const [favDarts, setFavDarts] = useState(\"\");\n  const [bio, setBio] = useState(\"\");\n  const [profilePhoto, setProfilePhoto] = useState(\"\");\n  const [allowAnalytics, setAllowAnalytics] = useState(true);\n  const [subscription, setSubscription] = useState<any>(null);\n\n  // Help Assistant state\n  const [helpMessages, setHelpMessages] = useState<\n    Array<{\n      text:\n        | string\n        | { text: string; links?: Array<{ text: string; tab: string }> };\n      isUser: boolean;\n    }>\n  >([\n    {\n      text: \"Hi! I'm your Nine Dart Nation assistant. How can I help you today?\",\n      isUser: false,\n    },\n  ]);\n  const [helpInput, setHelpInput] = useState(\"\");\n\n  useEffect(() => {\n    const uname = user?.username || \"\";\n    if (!uname) return;\n    try {\n      setFavPlayer(localStorage.getItem(`ndn:bio:favPlayer:${uname}`) || \"\");\n      setFavTeam(localStorage.getItem(`ndn:bio:favTeam:${uname}`) || \"\");\n      setFavDarts(localStorage.getItem(`ndn:bio:favDarts:${uname}`) || \"\");\n      setBio(localStorage.getItem(`ndn:bio:bio:${uname}`) || \"\");\n      setProfilePhoto(\n        localStorage.getItem(`ndn:bio:profilePhoto:${uname}`) || \"\",\n      );\n      setAllowAnalytics(\n        localStorage.getItem(`ndn:settings:allowAnalytics:${uname}`) !==\n          \"false\",\n      );\n    } catch {}\n  }, [user?.username]);\n\n  useEffect(() => {\n    if (!user?.email) return;\n    apiFetch(`/api/subscription?email=${encodeURIComponent(user.email)}`)\n      .then((r) => r.json())\n      .then(setSubscription)\n      .catch(() => {});\n  }, [user?.email]);\n\n  const saveBio = () => {\n    const uname = user?.username || \"\";\n    if (!uname) return;\n    try {\n      localStorage.setItem(`ndn:bio:favPlayer:${uname}`, favPlayer);\n      localStorage.setItem(`ndn:bio:favTeam:${uname}`, favTeam);\n      localStorage.setItem(`ndn:bio:favDarts:${uname}`, favDarts);\n      localStorage.setItem(`ndn:bio:bio:${uname}`, bio);\n      localStorage.setItem(`ndn:bio:profilePhoto:${uname}`, profilePhoto);\n      // Dispatch event to notify avatar update\n      try {\n        window.dispatchEvent(\n          new CustomEvent(\"ndn:avatar-updated\", {\n            detail: { username: uname, avatar: profilePhoto },\n          }),\n        );\n      } catch {}\n      localStorage.setItem(\n        `ndn:settings:allowAnalytics:${uname}`,\n        allowAnalytics.toString(),\n      );\n      setIsEditing(false);\n    } catch {}\n  };\n\n  // Help Assistant functions\n  const faq = {\n    \"how to play\":\n      \"To play darts, select a game mode from the menu. For online play, join a match. For offline, start a local game.\",\n    camera:\n      \"Go to Settings > Camera & Vision > Camera Guide to set up your camera properly.\",\n    calibration:\n      \"Go to Settings > Camera & Vision > Camera Guide to set up your camera properly.\",\n    premium:\n      'Premium unlocks all game modes. Click the \"Upgrade to PREMIUM\" button in online play.',\n    username: \"Change your username once for free in Settings > Account.\",\n    voice:\n      \"Enable voice caller in Settings > Audio & Voice. Test the voice with the Test Voice button.\",\n    friends: \"Add friends in the Friends tab to play together.\",\n    stats: \"View your statistics in the Stats tab.\",\n    settings: \"Customize your experience in the Settings panel.\",\n    support:\n      \"Contact support via email or check the FAQ in Settings > Support.\",\n  };\n\n  const navigateToTab = (tabKey: string) => {\n    try {\n      window.dispatchEvent(\n        new CustomEvent(\"ndn:change-tab\", { detail: { tab: tabKey } }),\n      );\n    } catch (error) {\n      console.error(\"Navigation failed:\", error);\n    }\n  };\n\n  const getResponseWithLinks = (\n    userMessage: string,\n  ): { text: string; links?: Array<{ text: string; tab: string }> } => {\n    const message = userMessage.toLowerCase();\n\n    if (message.includes(\"username\") || message.includes(\"change name\")) {\n      return {\n        text: \"You can change your username once for free.\",\n        links: [{ text: \"Go to Settings > Account\", tab: \"settings\" }],\n      };\n    }\n    if (\n      message.includes(\"premium\") ||\n      message.includes(\"upgrade\") ||\n      message.includes(\"subscription\")\n    ) {\n      return {\n        text: \"Premium unlocks all game modes and features.\",\n        links: [{ text: \"Go to Online Play\", tab: \"online\" }],\n      };\n    }\n    if (\n      message.includes(\"calibrat\") ||\n      message.includes(\"camera\") ||\n      message.includes(\"vision\")\n    ) {\n      return {\n        text: \"Set up your camera properly in Settings.\",\n        links: [{ text: \"Go to Settings > Camera & Vision\", tab: \"settings\" }],\n      };\n    }\n    if (\n      message.includes(\"voice\") ||\n      message.includes(\"caller\") ||\n      message.includes(\"audio\")\n    ) {\n      return {\n        text: \"Enable voice calling in Settings.\",\n        links: [{ text: \"Go to Settings > Audio & Voice\", tab: \"settings\" }],\n      };\n    }\n    if (message.includes(\"friend\") || message.includes(\"play together\")) {\n      return {\n        text: \"Add friends to play together.\",\n        links: [{ text: \"Go to Friends\", tab: \"friends\" }],\n      };\n    }\n    if (\n      message.includes(\"stat\") ||\n      message.includes(\"score\") ||\n      message.includes(\"performance\")\n    ) {\n      return {\n        text: \"View your statistics and performance.\",\n        links: [{ text: \"Go to Stats\", tab: \"stats\" }],\n      };\n    }\n    if (\n      message.includes(\"setting\") ||\n      message.includes(\"customiz\") ||\n      message.includes(\"configur\")\n    ) {\n      return {\n        text: \"Customize your experience.\",\n        links: [{ text: \"Go to Settings\", tab: \"settings\" }],\n      };\n    }\n    if (message.includes(\"tournament\") || message.includes(\"competition\")) {\n      return {\n        text: \"Check out tournaments and competitions.\",\n        links: [{ text: \"Go to Tournaments\", tab: \"tournaments\" }],\n      };\n    }\n    if (\n      message.includes(\"help\") ||\n      message.includes(\"support\") ||\n      message.includes(\"faq\")\n    ) {\n      return {\n        text: \"You're already in the help section! Check the Support section above for more resources.\",\n        links: [{ text: \"Scroll to Support\", tab: \"settings\" }],\n      };\n    }\n    if (\n      message.includes(\"how to play\") ||\n      message.includes(\"game\") ||\n      message.includes(\"start\")\n    ) {\n      return {\n        text: \"To play darts, select a game mode from the menu. For online play, join a match. For offline, start a local game.\",\n        links: [\n          { text: \"Play Online\", tab: \"online\" },\n          { text: \"Play Offline\", tab: \"offline\" },\n        ],\n      };\n    }\n\n    const faqMatch = Object.entries(faq).find(([topic]) =>\n      message.includes(topic.toLowerCase()),\n    );\n    if (faqMatch) {\n      return {\n        text: faqMatch[1],\n        links: [{ text: \"Open FAQ\", tab: \"settings\" }],\n      };\n    }\n\n    return {\n      text: \"I'm not sure about that. Try asking about playing, camera setup, premium, username changes, voice settings, friends, stats, or settings.\",\n    };\n  };\n\n  const handleHelpSend = () => {\n    if (!helpInput.trim()) return;\n    const userMessage = helpInput.toLowerCase();\n    setHelpMessages((prev) => [...prev, { text: helpInput, isUser: true }]);\n    setHelpInput(\"\");\n\n    // Get response with smart link suggestions\n    const response = getResponseWithLinks(userMessage);\n\n    setTimeout(() => {\n      setHelpMessages((prev) => [...prev, { text: response, isUser: false }]);\n    }, 500);\n  };\n\n  // Username change state\n  const [newUsername, setNewUsername] = useState(\"\");\n  const [changingUsername, _setChangingUsername] = useState(false);\n  const [usernameError, setUsernameError] = useState(\"\");\n\n  // Available voices for caller\n  const [availableVoices, setAvailableVoices] = useState<\n    SpeechSynthesisVoice[]\n  >([]);\n\n  useEffect(() => {\n    const loadVoices = () => {\n      const voices = speechSynthesis.getVoices();\n      setAvailableVoices(voices.filter((v) => v.lang.startsWith(\"en\")));\n    };\n    loadVoices();\n    speechSynthesis.onvoiceschanged = loadVoices;\n  }, []);\n\n  // Highlights state\n  const [_showHighlights, setShowHighlights] = useState(false);\n\n  // Collapsible pill state\n  const [expandedPill, setExpandedPill] = useState<\n    \"user\" | \"calibration\" | \"settings\" | null\n  >(null);\n\n  const PillButton = ({\n    label,\n    icon: Icon,\n    pill,\n    color,\n  }: {\n    label: string;\n    icon: any;\n    pill: \"user\" | \"calibration\" | \"settings\";\n    color: string;\n  }) => (\n    <button\n      onPointerDown={(e) => {\n        (e as any).stopPropagation();\n      }}\n      onMouseDown={(e) => {\n        e.stopPropagation();\n      }}\n      onTouchStart={(e) => {\n        (e as any).stopPropagation?.();\n      }}\n      onClick={() => setExpandedPill((prev) => (prev === pill ? null : pill))}\n      type=\"button\"\n      data-testid={`pill-button-${pill}`}\n      className={`select-none whitespace-nowrap rounded-full px-4 py-2 text-sm font-semibold shadow-sm focus:outline-none focus-visible:ring-2 focus-visible:ring-white/60 active:scale-[0.98] bg-gradient-to-r ${color} text-white flex items-center gap-2`}\n    >\n      <Icon className=\"w-4 h-4\" /> {label}\n      <ChevronDown\n        className={`w-4 h-4 transition-transform ${expandedPill === pill ? \"rotate-180\" : \"\"}`}\n      />\n    </button>\n  );\n\n  return (\n    <div className=\"space-y-6 ndn-page\">\n      <div className=\"rounded-[28px] border border-white/10 bg-gradient-to-br from-slate-950/70 via-indigo-950/30 to-slate-950/60 p-5 shadow-2xl\">\n        <div className=\"flex items-start justify-between gap-3\">\n          <div className=\"min-w-0\">\n            <div className=\"text-xs uppercase tracking-[0.35em] text-slate-400\">\n              Preferences\n            </div>\n            <h2 className=\"mt-1 text-2xl font-extrabold text-white\">\n              Settings\n            </h2>\n            <div className=\"mt-1 text-sm text-slate-300/80\">\n              Tune your camera, scoring, and app experience.\n            </div>\n          </div>\n          <div className=\"shrink-0 rounded-2xl border border-white/10 bg-white/5 px-3 py-2\">\n            <ThemeToggle />\n          </div>\n        </div>\n      </div>\n\n      {/* ==== USER INFO PILL ==== */}\n      <div className=\"relative rounded-[22px] bg-gradient-to-br from-white/[0.08] to-white/[0.03] backdrop-blur-md border border-white/10 p-2 shadow-xl\">\n        <div className=\"flex items-center gap-2 overflow-x-auto no-scrollbar py-1 px-1\">\n          <PillButton\n            label=\"User Info \"\n            icon={User}\n            pill=\"user\"\n            color=\"from-indigo-600 to-indigo-500\"\n          />\n          <PillButton\n            label=\"Camera Setup \"\n            icon={Camera}\n            pill=\"calibration\"\n            color=\"from-emerald-600 to-emerald-500\"\n          />\n          <PillButton\n            label=\"App Settings \"\n            icon={Settings}\n            pill=\"settings\"\n            color=\"from-purple-600 to-purple-500\"\n          />\n        </div>\n      </div>\n\n      {/*\n        In the full app, SettingsPanel includes additional sub-panels/components that can also\n        render pill controls. In tests, those extra instances can result in duplicate `data-testid`\n        values and brittle queries.\n      */}\n      {__TEST_MODE__ ? null : null}\n\n      {/* USER INFO CONTENT */}\n      {expandedPill === \"user\" && (\n        <div\n          data-testid=\"pill-user-content\"\n          className=\"p-5 sm:p-6 rounded-[28px] border border-white/10 bg-slate-950/50 shadow-2xl space-y-4\"\n        >\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n            {/* Account */}\n            <div className=\"card\">\n              <div className=\"p-3 rounded-xl border border-red-500/40 bg-red-500/10\">\n                <div className=\"font-semibold mb-4 flex items-center gap-2 text-red-100\">\n                  <User className=\"w-5 h-5\" /> Account \n                </div>\n                <div className=\"space-y-3\">\n                  <div className=\"flex justify-center gap-2\">\n                    <button\n                      onClick={() =>\n                        window.dispatchEvent(new CustomEvent(\"ndn:logout\"))\n                      }\n                      className=\"px-6 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium transition-colors\"\n                    >\n                      Logout \n                    </button>\n                    <button\n                      onClick={() => setShowHighlights(true)}\n                      className=\"px-4 py-2 bg-slate-700 hover:bg-slate-800 text-white rounded-lg font-medium transition-colors\"\n                    >\n                      Highlights \n                    </button>\n                  </div>\n                  <div className=\"border-t border-red-500/20 pt-3\">\n                    <div className=\"font-medium mb-2 text-red-100\">\n                      Change Username  (\n                      {(() => {\n                        const count = user?.usernameChangeCount || 0;\n                        if (count < 2)\n                          return `${2 - count} free changes remaining`;\n                        return \"2 per change\";\n                      })()}\n                      )\n                    </div>\n                    <div className=\"text-sm text-red-100 mb-2\">\n                      You can change your username up to 2 times for free.\n                      Additional changes cost 2 each.\n                    </div>\n                    {user?.usernameChangeCount >= 2 && !newUsername.trim() ? (\n                      <div className=\"text-amber-400 text-sm mb-2\">\n                         Additional username changes cost 2\n                      </div>\n                    ) : null}\n                    <input\n                      className=\"input w-full mb-2\"\n                      type=\"text\"\n                      placeholder=\"New username\"\n                      value={newUsername}\n                      onChange={(e) => setNewUsername(e.target.value)}\n                      disabled={changingUsername}\n                    />\n                    {usernameError && (\n                      <div className=\"text-red-400 text-sm mb-2\">\n                        {usernameError}\n                      </div>\n                    )}\n                    <button\n                      onClick={async () => {\n                        setUsernameError(\"\");\n                        if (!newUsername.trim()) {\n                          setUsernameError(\"Username required\");\n                          return;\n                        }\n                        if (newUsername.length < 3 || newUsername.length > 20) {\n                          setUsernameError(\"Username must be 3-20 characters\");\n                          return;\n                        }\n                        const currentCount = user?.usernameChangeCount || 0;\n                        const isFree = currentCount < 2;\n                        if (!isFree) {\n                          window.location.href =\n                            \"https://buy.stripe.com/eVq4gB3XqeNS0iw6vAfnO02\";\n                        } else {\n                          localStorage.setItem(\n                            \"pendingUsernameChange\",\n                            newUsername.trim(),\n                          );\n                          window.location.href = \"/?username-change=free\";\n                        }\n                      }}\n                      disabled={changingUsername || !newUsername.trim()}\n                      className=\"w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-600 text-white rounded-lg font-medium transition-colors\"\n                    >\n                      {changingUsername\n                        ? \"Processing...\"\n                        : (() => {\n                            const count = user?.usernameChangeCount || 0;\n                            return count < 2\n                              ? \"Change Username (FREE) \"\n                              : \"Change Username (2) \";\n                          })()}\n                    </button>\n                  </div>\n                </div>\n              </div>\n            </div>\n\n            {/* Premium */}\n            {subscription && (\n              <div className=\"card\">\n                <div className=\"p-3 rounded-xl border border-green-500/40 bg-green-500/10\">\n                  <div className=\"font-semibold mb-4 flex items-center gap-2 text-green-100\">\n                    <Shield className=\"w-5 h-5\" /> Premium \n                  </div>\n                  <div className=\"space-y-3 text-sm text-green-100\">\n                    <div>\n                      Status:{\" \"}\n                      <span\n                        className={\n                          subscription?.status === \"active\"\n                            ? \"text-green-400\"\n                            : \"text-yellow-400\"\n                        }\n                      >\n                        {subscription?.status === \"active\"\n                          ? \" Active \"\n                          : \"Not Active\"}\n                      </span>\n                    </div>\n                    {subscription?.status === \"active\" &&\n                      subscription?.nextBillingDate && (\n                        <div>\n                          Next Billing:{\" \"}\n                          {new Date(\n                            subscription.nextBillingDate,\n                          ).toLocaleDateString()}\n                        </div>\n                      )}\n                    {subscription?.source === \"tournament\" &&\n                      subscription?.status === \"active\" && (\n                        <button\n                          onClick={() =>\n                            (window.location.href =\n                              \"https://buy.stripe.com/eVq4gB3XqeNS0iw6vAfnO02\")\n                          }\n                          className=\"w-full px-3 py-2 bg-red-600 hover:bg-red-700 text-white rounded font-medium transition-colors text-xs\"\n                        >\n                          Cancel Subscription \n                        </button>\n                      )}\n                  </div>\n                </div>\n              </div>\n            )}\n\n            {/* Profile Photo */}\n            <div className=\"card\">\n              <div className=\"p-3 rounded-xl border border-cyan-500/40 bg-cyan-500/10\">\n                <div className=\"font-semibold mb-4 flex items-center gap-2 text-cyan-100\">\n                  <Eye className=\"w-5 h-5\" /> Profile Photo \n                </div>\n                <input\n                  type=\"file\"\n                  accept=\"image/*\"\n                  onChange={(e) => {\n                    const file = e.target.files?.[0];\n                    if (file) {\n                      const reader = new FileReader();\n                      reader.onload = () =>\n                        setProfilePhoto(reader.result as string);\n                      reader.readAsDataURL(file);\n                    }\n                  }}\n                  className=\"w-full text-xs text-slate-100\"\n                />\n              </div>\n            </div>\n\n            {/* Online & Socials */}\n            <div className=\"card\">\n              <div className=\"p-3 rounded-xl border border-purple-500/40 bg-purple-500/10\">\n                <div className=\"font-semibold mb-4 flex items-center gap-2 text-purple-100\">\n                  <MessageCircle className=\"w-5 h-5\" /> Online & Socials \n                </div>\n                <div className=\"space-y-3\">\n                  <div className=\"flex items-center gap-3\">\n                    <input\n                      type=\"checkbox\"\n                      id=\"allowSpectate\"\n                      checked={allowSpectate}\n                      onChange={(e) => setAllowSpectate(e.target.checked)}\n                      className=\"w-4 h-4\"\n                    />\n                    <label\n                      htmlFor=\"allowSpectate\"\n                      className=\"text-sm text-purple-100\"\n                    >\n                      Allow spectators \n                    </label>\n                  </div>\n                </div>\n              </div>\n            </div>\n\n            {/* Data & Privacy */}\n            <div className=\"card\">\n              <div className=\"p-3 rounded-xl border border-orange-500/40 bg-orange-500/10\">\n                <div className=\"font-semibold mb-4 flex items-center gap-2 text-orange-100\">\n                  <Shield className=\"w-5 h-5\" /> Data & Privacy \n                </div>\n                <div className=\"space-y-3\">\n                  <div className=\"flex items-center gap-3\">\n                    <input\n                      type=\"checkbox\"\n                      id=\"allowAnalytics\"\n                      checked={allowAnalytics}\n                      onChange={(e) => setAllowAnalytics(e.target.checked)}\n                      className=\"w-4 h-4\"\n                    />\n                    <label\n                      htmlFor=\"allowAnalytics\"\n                      className=\"text-sm text-orange-100\"\n                    >\n                      Allow analytics \n                    </label>\n                  </div>\n                  <button\n                    onClick={() => {\n                      const data = {\n                        achievements,\n                        bio: { favPlayer, favTeam, favDarts, bio },\n                      };\n                      const blob = new Blob([JSON.stringify(data, null, 2)], {\n                        type: \"application/json\",\n                      });\n                      const url = URL.createObjectURL(blob);\n                      const a = document.createElement(\"a\");\n                      a.href = url;\n                      a.download = `my-data-${new Date().toISOString().split(\"T\")[0]}.json`;\n                      a.click();\n                      URL.revokeObjectURL(url);\n                    }}\n                    className=\"btn bg-orange-600 hover:bg-orange-700 w-full\"\n                  >\n                    Export My Data \n                  </button>\n                </div>\n              </div>\n            </div>\n\n            {/* Privacy & Copyright Notice */}\n            <div className=\"card\">\n              <div className=\"p-3 rounded-xl border border-red-500/40 bg-red-500/10\">\n                <div className=\"font-semibold mb-4 flex items-center gap-2\">\n                  <Shield className=\"w-5 h-5 text-red-400\" /> Privacy &\n                  Copyright \n                </div>\n                <div className=\"space-y-3 text-sm text-slate-300\">\n                  <div className=\"bg-red-500/20 border border-red-500/30 rounded-lg p-3\">\n                    <p className=\"font-semibold text-red-300 mb-2\">\n                       Legal Notice \n                    </p>\n                    <p className=\"mb-2 text-xs\">\n                      <strong>Copyright:</strong> All content is protected by\n                      copyright law. \n                    </p>\n                    <p className=\"text-xs\">\n                      <strong>Privacy:</strong> Your data is protected and\n                      unauthorized access is prohibited. \n                    </p>\n                  </div>\n                </div>\n              </div>\n            </div>\n\n            {/* Blocked Users */}\n            <div className=\"card\">\n              <div className=\"p-3 rounded-xl border border-yellow-500/40 bg-yellow-500/10\">\n                <div className=\"font-semibold mb-4 flex items-center gap-2 text-yellow-100\">\n                  <Shield className=\"w-5 h-5\" /> Blocked Users\n                </div>\n                <div className=\"space-y-3\">\n                  <p className=\"text-sm text-yellow-100\">\n                    Manage players you've blocked from contacting you.\n                  </p>\n                  <button\n                    onClick={() =>\n                      window.dispatchEvent(\n                        new CustomEvent(\"ndn:open-blocklist\"),\n                      )\n                    }\n                    className=\"btn bg-yellow-600 hover:bg-yellow-700 w-full text-sm\"\n                  >\n                    View Blocked Users \n                  </button>\n                </div>\n              </div>\n            </div>\n\n            {/* Contact & Support */}\n            <div className=\"card\">\n              <div className=\"p-3 rounded-xl border border-blue-500/40 bg-blue-500/10\">\n                <div className=\"font-semibold mb-4 flex items-center gap-2 text-blue-100\">\n                  <MessageCircle className=\"w-5 h-5\" /> Contact & Support\n                </div>\n                <div className=\"space-y-2\">\n                  <a\n                    href=\"mailto:support@ninedartnation.com\"\n                    className=\"flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors text-sm\"\n                  >\n                     Email Support\n                  </a>\n                  <a\n                    href=\"https://ninedartnation.com/help\"\n                    target=\"_blank\"\n                    rel=\"noopener noreferrer\"\n                    className=\"flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors text-sm\"\n                  >\n                     Help Center\n                  </a>\n                  <a\n                    href=\"https://ninedartnation.com/faq\"\n                    target=\"_blank\"\n                    rel=\"noopener noreferrer\"\n                    className=\"flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors text-sm\"\n                  >\n                     FAQ\n                  </a>\n                </div>\n              </div>\n            </div>\n\n            {/* Account Deletion */}\n            <div className=\"card\">\n              <div className=\"p-3 rounded-xl border border-red-500/40 bg-red-500/10\">\n                <div className=\"font-semibold mb-4 flex items-center gap-2 text-red-100\">\n                  <Shield className=\"w-5 h-5\" /> Delete Account\n                </div>\n                <div className=\"space-y-3\">\n                  <div className=\"bg-red-500/20 border border-red-500/30 rounded-lg p-3 text-xs text-red-200\">\n                    <p className=\"font-semibold mb-1\"> Warning</p>\n                    <p>\n                      Deleting your account is permanent and cannot be undone.\n                      All your stats, achievements, and data will be erased.\n                    </p>\n                  </div>\n                  <button\n                    onClick={() => {\n                      const confirm = window.confirm(\n                        \"Are you absolutely sure you want to delete your account? This action cannot be undone.\\n\\nAll your stats, achievements, and data will be permanently erased.\",\n                      );\n                      if (confirm) {\n                        const finalConfirm = window.confirm(\n                          \"This is your final warning. Click OK to permanently delete your account.\",\n                        );\n                        if (finalConfirm) {\n                          window.dispatchEvent(\n                            new CustomEvent(\"ndn:delete-account\"),\n                          );\n                        }\n                      }\n                    }}\n                    className=\"w-full px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium transition-colors\"\n                  >\n                    Permanently Delete Account \n                  </button>\n                </div>\n              </div>\n            </div>\n          </div>\n        </div>\n      )}\n\n      {/* ==== CAMERA SETUP PILL ==== */}\n      <div className=\"relative rounded-xl bg-white/5 backdrop-blur-md border border-white/10 p-1\">\n        <div className=\"flex items-center gap-2 overflow-x-auto no-scrollbar py-1 px-1\">\n          <PillButton\n            label=\"Camera Setup\"\n            icon={Camera}\n            pill=\"calibration\"\n            color=\"from-purple-500 to-pink-500 shadow-purple-500/30\"\n          />\n        </div>\n      </div>\n\n      {/* CAMERA SETUP CONTENT */}\n      {expandedPill === \"calibration\" && (\n        <div\n          data-testid=\"pill-calibration-content\"\n          className=\"p-6 rounded-2xl border border-white/10 bg-white/[0.02] space-y-4\"\n        >\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n            {/* Camera & Vision */}\n            <div className=\"card\">\n              <div className=\"p-3 rounded-xl border border-blue-500/40 bg-blue-500/10\">\n                <div className=\"font-semibold mb-4 flex items-center gap-2\">\n                  <Camera className=\"w-5 h-5 text-blue-400\" /> Camera & Vision\n                </div>\n                <div className=\"space-y-4\">\n                  <div className=\"flex items-center gap-3\">\n                    <input\n                      type=\"checkbox\"\n                      id=\"cameraEnabled\"\n                      checked={cameraEnabled}\n                      onChange={(e) => setCameraEnabled(e.target.checked)}\n                      className=\"w-4 h-4\"\n                    />\n                    <label htmlFor=\"cameraEnabled\" className=\"text-sm\">\n                      Enable camera\n                    </label>\n                  </div>\n                  {cameraEnabled && (\n                    <>\n                      <div className=\"pt-2 border-t border-white/10\">\n                        <div className=\"font-semibold mb-2 text-sm\">\n                          Lighting\n                        </div>\n                        <div className=\"mt-3 flex flex-col gap-2\">\n                          <div className=\"flex items-center gap-3\">\n                            <input\n                              type=\"checkbox\"\n                              id=\"cameraRecordDarts\"\n                              checked={!!cameraRecordDarts}\n                              onChange={(e) =>\n                                setCameraRecordDarts(e.target.checked)\n                              }\n                              className=\"w-4 h-4\"\n                            />\n                            <label\n                              htmlFor=\"cameraRecordDarts\"\n                              className=\"text-sm\"\n                            >\n                              Save detection thumbnails (no continuous video)\n                            </label>\n                          </div>\n                          <div className=\"flex items-center gap-3\">\n                            <input\n                              type=\"checkbox\"\n                              id=\"cameraShowLabels\"\n                              checked={!!cameraShowLabels}\n                              onChange={(e) =>\n                                setCameraShowLabels(e.target.checked)\n                              }\n                              className=\"w-4 h-4\"\n                            />\n                            <label\n                              htmlFor=\"cameraShowLabels\"\n                              className=\"text-sm\"\n                            >\n                              Show segment labels (e.g., T20)\n                            </label>\n                          </div>\n                        </div>\n                        <p className=\"text-xs opacity-70 mt-1\">\n                          When enabled, small thumbnails of detections and\n                          commits are saved for review. This does not record\n                          continuous video or audio.\n                        </p>\n\n                        <div className=\"flex items-center gap-3\">\n                          <input\n                            type=\"checkbox\"\n                            id=\"harshLightingMode\"\n                            checked={!!harshLightingMode}\n                            onChange={(e) =>\n                              setHarshLightingMode(e.target.checked)\n                            }\n                            className=\"w-4 h-4\"\n                          />\n                          <label\n                            htmlFor=\"harshLightingMode\"\n                            className=\"text-sm\"\n                          >\n                            Reduce glare (ring lights / harsh lighting)\n                          </label>\n                        </div>\n                        <p className=\"text-xs opacity-70 mt-1\">\n                          Applies highlight compression for better dart\n                          detection and slightly dims the preview.\n                        </p>\n\n                        <div className=\"mt-3 flex items-center gap-3\">\n                          <input\n                            type=\"checkbox\"\n                            id=\"enhanceBigTrebles\"\n                            checked={!!enhanceBigTrebles}\n                            onChange={(e) =>\n                              setEnhanceBigTrebles(e.target.checked)\n                            }\n                            className=\"w-4 h-4\"\n                          />\n                          <label\n                            htmlFor=\"enhanceBigTrebles\"\n                            className=\"text-sm\"\n                          >\n                            Enhance big trebles (T20/T19/T18)\n                          </label>\n                        </div>\n                        <p className=\"text-xs opacity-70 mt-1\">\n                          Visual aid only. Briefly enlarges/highlights the\n                          treble segment when detected.\n                        </p>\n                      </div>\n\n                      <div>\n                        <label\n                          htmlFor=\"cameraScale\"\n                          className=\"block text-sm mb-2\"\n                        >\n                          Scale: {cameraScale?.toFixed(2)}\n                        </label>\n                        <input\n                          type=\"range\"\n                          id=\"cameraScale\"\n                          min=\"0.5\"\n                          max=\"3\"\n                          step=\"0.1\"\n                          value={cameraScale || 1}\n                          onChange={(e) =>\n                            setCameraScale(parseFloat(e.target.value))\n                          }\n                          className=\"w-full\"\n                        />\n                      </div>\n                      <div className=\"mt-3\">\n                        <div className=\"flex items-center gap-3\">\n                          <input\n                            type=\"checkbox\"\n                            id=\"cameraLowLatency\"\n                            checked={!!cameraLowLatency}\n                            onChange={(e) =>\n                              setCameraLowLatency(e.target.checked)\n                            }\n                            className=\"w-4 h-4\"\n                          />\n                          <label htmlFor=\"cameraLowLatency\" className=\"text-sm\">\n                            Low-latency camera (prefer 720p & lower CPU)\n                          </label>\n                        </div>\n                        <p className=\"text-xs opacity-70 mt-1\">\n                          Reduces preview resolution and throttles detection to\n                          improve responsiveness on slower devices.\n                        </p>\n\n                        <div className=\"mt-2\">\n                          <label className=\"text-sm block mb-1\">\n                            Detection FPS\n                          </label>\n                          <select\n                            value={cameraProcessingFps}\n                            onChange={(e) =>\n                              setCameraProcessingFps(Number(e.target.value))\n                            }\n                            className=\"input w-full\"\n                          >\n                            <option value={10}>10 fps (very low)</option>\n                            <option value={15}>15 fps (balanced)</option>\n                            <option value={20}>20 fps (smooth)</option>\n                            <option value={30}>30 fps (high)</option>\n                          </select>\n                          <p className=\"text-xs opacity-70 mt-1\">\n                            Lower FPS reduces CPU usage and improves stability\n                            on laggy feeds.\n                          </p>\n                        </div>\n                      </div>\n                      <div>\n                        <label\n                          htmlFor=\"cameraAspect\"\n                          className=\"block text-sm mb-2\"\n                        >\n                          Aspect Ratio\n                        </label>\n                        <select\n                          onPointerDown={(e) => {\n                            (e as any).stopPropagation();\n                          }}\n                          onMouseDown={(e) => {\n                            e.stopPropagation();\n                          }}\n                          onTouchStart={(e) => {\n                            (e as any).stopPropagation?.();\n                          }}\n                          id=\"cameraAspect\"\n                          value={cameraAspect || \"wide\"}\n                          onChange={(e) =>\n                            setCameraAspect(e.target.value as \"wide\" | \"square\")\n                          }\n                          className=\"input w-full\"\n                        >\n                          <option value=\"wide\">Wide (16:9)</option>\n                          <option value=\"square\">Square (1:1)</option>\n                        </select>\n                      </div>\n                      <div>\n                        <label\n                          htmlFor=\"cameraFitMode\"\n                          className=\"block text-sm mb-2\"\n                        >\n                          Fit Mode\n                        </label>\n                        <select\n                          onPointerDown={(e) => {\n                            (e as any).stopPropagation();\n                          }}\n                          onMouseDown={(e) => {\n                            e.stopPropagation();\n                          }}\n                          onTouchStart={(e) => {\n                            (e as any).stopPropagation?.();\n                          }}\n                          id=\"cameraFitMode\"\n                          value={cameraFitMode || \"fit\"}\n                          onChange={(e) =>\n                            setCameraFitMode(e.target.value as \"fill\" | \"fit\")\n                          }\n                          className=\"input w-full\"\n                        >\n                          <option value=\"fill\">Fill (crop)</option>\n                          <option value=\"fit\">Fit (letterbox)</option>\n                        </select>\n                      </div>\n                      <button\n                        onClick={() => {}}\n                        className=\"btn bg-indigo-600 hover:bg-indigo-700 w-full\"\n                      >\n                        Calibration Guide \n                      </button>\n                      <div>\n                        <label\n                          htmlFor=\"autoscoreProvider\"\n                          className=\"block text-sm mb-2\"\n                        >\n                          Auto-score Provider\n                        </label>\n                        <select\n                          onPointerDown={(e) => {\n                            (e as any).stopPropagation();\n                          }}\n                          onMouseDown={(e) => {\n                            e.stopPropagation();\n                          }}\n                          onTouchStart={(e) => {\n                            (e as any).stopPropagation?.();\n                          }}\n                          id=\"autoscoreProvider\"\n                          value={autoscoreProvider || \"manual\"}\n                          onChange={(e) =>\n                            setAutoscoreProvider(\n                              e.target.value as \"manual\" | \"external-ws\",\n                            )\n                          }\n                          className=\"input w-full\"\n                        >\n                          <option value=\"manual\">Manual Scoring</option>\n                          <option value=\"external-ws\">\n                            External (WebSocket)\n                          </option>\n                        </select>\n                      </div>\n                      {autoscoreProvider === \"external-ws\" && (\n                        <input\n                          type=\"text\"\n                          placeholder=\"WebSocket URL\"\n                          value={autoscoreWsUrl || \"\"}\n                          onChange={(e) => setAutoscoreWsUrl(e.target.value)}\n                          className=\"input w-full text-xs\"\n                        />\n                      )}\n                      {autoscoreProvider !== \"manual\" && (\n                        <div>\n                          <label\n                            htmlFor=\"autoCommitMode\"\n                            className=\"block text-sm mb-2\"\n                          >\n                            Turn Advance\n                          </label>\n                          <select\n                            onPointerDown={(e) => {\n                              (e as any).stopPropagation();\n                            }}\n                            onMouseDown={(e) => {\n                              e.stopPropagation();\n                            }}\n                            onTouchStart={(e) => {\n                              (e as any).stopPropagation?.();\n                            }}\n                            id=\"autoCommitMode\"\n                            value={autoCommitMode || \"wait-for-clear\"}\n                            onChange={(e) =>\n                              setAutoCommitMode(\n                                e.target.value as\n                                  | \"wait-for-clear\"\n                                  | \"immediate\",\n                              )\n                            }\n                            className=\"input w-full\"\n                          >\n                            <option value=\"wait-for-clear\">\n                              Wait for darts to be removed\n                            </option>\n                            <option value=\"immediate\">\n                              Advance immediately after 3 darts/bust\n                            </option>\n                          </select>\n                          <p className=\"text-xs opacity-70 mt-1\">\n                            Waiting prevents the turn from rotating until you\n                            clear the board (or 6.5s pass).\n                          </p>\n                        </div>\n                      )}\n\n                      {autoscoreProvider !== \"manual\" && (\n                        <div className=\"pt-2 border-t border-white/10\">\n                          <div className=\"font-semibold mb-2 text-sm\">\n                            Auto-score quality\n                          </div>\n\n                          <div className=\"flex items-center gap-3\">\n                            <input\n                              type=\"checkbox\"\n                              id=\"confirmUncertainDarts\"\n                              checked={confirmUncertainDarts ?? true}\n                              onChange={(e) =>\n                                setConfirmUncertainDarts(e.target.checked)\n                              }\n                              className=\"w-4 h-4\"\n                            />\n                            <label\n                              htmlFor=\"confirmUncertainDarts\"\n                              className=\"text-sm\"\n                            >\n                              Confirm uncertain darts\n                            </label>\n                          </div>\n                          <p className=\"text-xs opacity-70 mt-1\">\n                            If the system isnt confident enough, itll pause\n                            and ask you to accept/reject (Omni/Scolia-style).\n                          </p>\n\n                          <div className=\"mt-3\">\n                            <label\n                              htmlFor=\"autoScoreConfidenceThreshold\"\n                              className=\"block text-sm mb-2\"\n                            >\n                              Confidence threshold:{\" \"}\n                              {(autoScoreConfidenceThreshold ?? 0.85).toFixed(\n                                2,\n                              )}\n                            </label>\n                            <input\n                              type=\"range\"\n                              id=\"autoScoreConfidenceThreshold\"\n                              min=\"0.5\"\n                              max=\"0.99\"\n                              step=\"0.01\"\n                              value={autoScoreConfidenceThreshold ?? 0.85}\n                              onChange={(e) =>\n                                setAutoScoreConfidenceThreshold(\n                                  parseFloat(e.target.value),\n                                )\n                              }\n                              className=\"w-full\"\n                            />\n                            <p className=\"text-xs opacity-70 mt-1\">\n                              Higher = fewer confirmations, but higher risk of\n                              accepting a wrong hit.\n                            </p>\n                          </div>\n\n                          <details className=\"mt-4\">\n                            <summary className=\"text-sm cursor-pointer select-none opacity-90\">\n                              Advanced detector tuning\n                            </summary>\n\n                            <div className=\"mt-3 space-y-3\">\n                              <div>\n                                <label className=\"block text-sm mb-2\">\n                                  Min blob area:{\" \"}\n                                  {autoscoreDetectorMinArea ?? 30}\n                                </label>\n                                <input\n                                  type=\"range\"\n                                  min=\"5\"\n                                  max=\"200\"\n                                  step=\"1\"\n                                  value={autoscoreDetectorMinArea ?? 30}\n                                  onChange={(e) =>\n                                    setAutoscoreDetectorMinArea(\n                                      parseInt(e.target.value, 10),\n                                    )\n                                  }\n                                  className=\"w-full\"\n                                />\n                                <p className=\"text-xs opacity-70 mt-1\">\n                                  Lower = more sensitive (can increase false\n                                  positives).\n                                </p>\n                              </div>\n\n                              <div>\n                                <label className=\"block text-sm mb-2\">\n                                  Foreground threshold:{\" \"}\n                                  {autoscoreDetectorThresh ?? 15}\n                                </label>\n                                <input\n                                  type=\"range\"\n                                  min=\"5\"\n                                  max=\"40\"\n                                  step=\"1\"\n                                  value={autoscoreDetectorThresh ?? 15}\n                                  onChange={(e) =>\n                                    setAutoscoreDetectorThresh(\n                                      parseInt(e.target.value, 10),\n                                    )\n                                  }\n                                  className=\"w-full\"\n                                />\n                                <p className=\"text-xs opacity-70 mt-1\">\n                                  Lower = more motion counts as a dart.\n                                </p>\n                              </div>\n\n                              <div>\n                                <label className=\"block text-sm mb-2\">\n                                  Stable frames required:{\" \"}\n                                  {autoscoreDetectorRequireStableN ?? 2}\n                                </label>\n                                <input\n                                  type=\"range\"\n                                  min=\"1\"\n                                  max=\"6\"\n                                  step=\"1\"\n                                  value={autoscoreDetectorRequireStableN ?? 2}\n                                  onChange={(e) =>\n                                    setAutoscoreDetectorRequireStableN(\n                                      parseInt(e.target.value, 10),\n                                    )\n                                  }\n                                  className=\"w-full\"\n                                />\n                                <p className=\"text-xs opacity-70 mt-1\">\n                                  Higher = fewer false triggers, but slower.\n                                </p>\n                              </div>\n                            </div>\n                          </details>\n                        </div>\n                      )}\n                    </>\n                  )}\n                </div>\n              </div>\n            </div>\n\n            {/* Audio & Voice */}\n            <div className=\"card\">\n              <div className=\"p-3 rounded-xl border border-purple-500/40 bg-purple-500/10\">\n                <div className=\"font-semibold mb-4 flex items-center gap-2\">\n                  <Volume2 className=\"w-5 h-5 text-purple-400\" /> Audio & Voice\n                </div>\n                <div className=\"space-y-4\">\n                  <div className=\"flex items-center gap-3\">\n                    <input\n                      type=\"checkbox\"\n                      id=\"callerEnabled\"\n                      checked={callerEnabled}\n                      onChange={(e) => setCallerEnabled(e.target.checked)}\n                      className=\"w-4 h-4\"\n                    />\n                    <label htmlFor=\"callerEnabled\" className=\"text-sm\">\n                      Enable voice caller\n                    </label>\n                  </div>\n                  {callerEnabled && (\n                    <>\n                      <div>\n                        <label\n                          htmlFor=\"callerVoice\"\n                          className=\"block text-sm mb-2\"\n                        >\n                          Voice\n                        </label>\n                        <select\n                          onPointerDown={(e) => {\n                            (e as any).stopPropagation();\n                          }}\n                          onMouseDown={(e) => {\n                            e.stopPropagation();\n                          }}\n                          onTouchStart={(e) => {\n                            (e as any).stopPropagation?.();\n                          }}\n                          id=\"callerVoice\"\n                          value={callerVoice || \"\"}\n                          onChange={(e) => setCallerVoice(e.target.value)}\n                          className=\"input w-full text-xs\"\n                        >\n                          <option value=\"\">Default</option>\n                          {availableVoices.map((v, i) => (\n                            <option key={i} value={v.voiceURI}>\n                              {v.name}\n                            </option>\n                          ))}\n                        </select>\n                      </div>\n                      <div>\n                        <label\n                          htmlFor=\"callerVolume\"\n                          className=\"block text-sm mb-2\"\n                        >\n                          Volume: {Math.round((callerVolume || 1) * 100)}%\n                        </label>\n                        <input\n                          type=\"range\"\n                          id=\"callerVolume\"\n                          min=\"0\"\n                          max=\"1\"\n                          step=\"0.1\"\n                          value={callerVolume || 1}\n                          onChange={(e) =>\n                            setCallerVolume(parseFloat(e.target.value))\n                          }\n                          className=\"w-full\"\n                        />\n                      </div>\n                      <div className=\"flex items-center gap-3\">\n                        <input\n                          type=\"checkbox\"\n                          id=\"speakCheckoutOnly\"\n                          checked={speakCheckoutOnly}\n                          onChange={(e) =>\n                            setSpeakCheckoutOnly(e.target.checked)\n                          }\n                          className=\"w-4 h-4\"\n                        />\n                        <label htmlFor=\"speakCheckoutOnly\" className=\"text-sm\">\n                          Only speak checkout scores\n                        </label>\n                      </div>\n                      <button\n                        onClick={() => {\n                          const msg = new SpeechSynthesisUtterance(\n                            \"One hundred and eighty!\",\n                          );\n                          if (callerVoice) {\n                            const v = window.speechSynthesis\n                              .getVoices()\n                              .find((x) => x.voiceURI === callerVoice);\n                            if (v) msg.voice = v;\n                          }\n                          msg.volume = callerVolume || 1;\n                          window.speechSynthesis.speak(msg);\n                        }}\n                        className=\"btn bg-purple-600 hover:bg-purple-700 w-full text-sm\"\n                      >\n                        Test Voice \n                      </button>\n                    </>\n                  )}\n                </div>\n              </div>\n            </div>\n          </div>\n        </div>\n      )}\n\n      {/* ==== SETTINGS SECTIONS PILL ==== */}\n      <div className=\"relative rounded-xl bg-white/5 backdrop-blur-md border border-white/10 p-1\">\n        <div className=\"flex items-center gap-2 overflow-x-auto no-scrollbar py-1 px-1\">\n          <PillButton\n            label=\"Settings\"\n            icon={Settings}\n            pill=\"settings\"\n            color=\"from-cyan-500 to-blue-500 shadow-cyan-500/30\"\n          />\n        </div>\n      </div>\n\n      {/* SETTINGS CONTENT */}\n      {expandedPill === \"settings\" && (\n        <div data-testid=\"pill-settings-content\" className=\"space-y-4\">\n          {/* Profile Bio */}\n          <div className=\"card\">\n            <div className=\"p-3 rounded-xl border border-indigo-500/40 bg-indigo-500/10\">\n              <div className=\"flex items-center justify-between mb-4\">\n                <div className=\"font-semibold flex items-center gap-2\">\n                  <User className=\"w-5 h-5 text-brand-400\" /> Profile Bio \n                </div>\n                {!isEditing ? (\n                  <button\n                    onClick={() => setIsEditing(true)}\n                    className=\"flex items-center gap-2 px-3 py-1 bg-blue-500/20 hover:bg-blue-500/30 rounded-lg text-blue-400 text-sm transition-colors\"\n                  >\n                    <Edit3 className=\"w-4 h-4\" /> Edit \n                  </button>\n                ) : (\n                  <button\n                    onClick={saveBio}\n                    className=\"flex items-center gap-2 px-3 py-1 bg-green-500/20 hover:bg-green-500/30 rounded-lg text-green-400 text-sm transition-colors\"\n                  >\n                    <Save className=\"w-4 h-4\" /> Save \n                  </button>\n                )}\n              </div>\n\n              <div className=\"space-y-3\">\n                {isEditing ? (\n                  <>\n                    <div>\n                      <label className=\"block text-sm mb-1\">\n                        Favorite Player \n                      </label>\n                      <input\n                        type=\"text\"\n                        value={favPlayer}\n                        onChange={(e) => setFavPlayer(e.target.value)}\n                        className=\"input w-full\"\n                      />\n                    </div>\n                    <div>\n                      <label className=\"block text-sm mb-1\">\n                        Favorite Team \n                      </label>\n                      <input\n                        type=\"text\"\n                        value={favTeam}\n                        onChange={(e) => setFavTeam(e.target.value)}\n                        className=\"input w-full\"\n                      />\n                    </div>\n                    <div>\n                      <label className=\"block text-sm mb-1\">\n                        Favorite Darts \n                      </label>\n                      <input\n                        type=\"text\"\n                        value={favDarts}\n                        onChange={(e) => setFavDarts(e.target.value)}\n                        className=\"input w-full\"\n                      />\n                    </div>\n                    <div>\n                      <label className=\"block text-sm mb-1\">\n                        Bio / Quote \n                      </label>\n                      <textarea\n                        value={bio}\n                        onChange={(e) => setBio(e.target.value)}\n                        rows={3}\n                        className=\"input w-full\"\n                      />\n                    </div>\n                  </>\n                ) : (\n                  <>\n                    <div>\n                      Favorite Player:{\" \"}\n                      <span className=\"text-brand-300\">\n                        {favPlayer || \"Not set\"} \n                      </span>\n                    </div>\n                    <div>\n                      Favorite Team:{\" \"}\n                      <span className=\"text-brand-300\">\n                        {favTeam || \"Not set\"} \n                      </span>\n                    </div>\n                    <div>\n                      Favorite Darts:{\" \"}\n                      <span className=\"text-brand-300\">\n                        {favDarts || \"Not set\"} \n                      </span>\n                    </div>\n                    <div>\n                      Bio:{\" \"}\n                      <span className=\"text-brand-300\">\n                        {bio || \"No bio set\"} \n                      </span>\n                    </div>\n                  </>\n                )}\n              </div>\n            </div>\n          </div>\n\n          {/* Game Preferences */}\n          <div className=\"card\">\n            <div className=\"p-3 rounded-xl border border-green-500/40 bg-green-500/10\">\n              <div className=\"font-semibold mb-4 flex items-center gap-2\">\n                <Gamepad2 className=\"w-5 h-5 text-green-400\" /> Game Preferences\n                \n              </div>\n              <div className=\"space-y-3\">\n                <div className=\"flex items-center gap-3\">\n                  <input\n                    type=\"checkbox\"\n                    id=\"dartTimerEnabled\"\n                    checked={!!dartTimerEnabled}\n                    onChange={(e) => setDartTimerEnabled(e.target.checked)}\n                    className=\"w-4 h-4\"\n                  />\n                  <label htmlFor=\"dartTimerEnabled\" className=\"text-sm\">\n                    Enable per-dart throw timer \n                  </label>\n                </div>\n                {dartTimerEnabled && (\n                  <div>\n                    <label className=\"block mb-2 text-sm font-medium\">\n                      Time per throw:{\" \"}\n                      {dartTimerSeconds ? Math.round(dartTimerSeconds) : 0}s\n                    </label>\n                    <input\n                      type=\"range\"\n                      min=\"3\"\n                      max=\"30\"\n                      value={dartTimerSeconds || 10}\n                      onChange={(e) =>\n                        setDartTimerSeconds(parseInt(e.target.value))\n                      }\n                      className=\"w-full\"\n                    />\n                    <div className=\"text-xs opacity-70 mt-1\">\n                      When the timer reaches zero, the dart is recorded as a\n                      miss and advances to the next throw.\n                    </div>\n                  </div>\n                )}\n                <div>\n                  <label\n                    htmlFor=\"favoriteDouble\"\n                    className=\"block text-sm mb-2\"\n                  >\n                    Favorite Finish Double\n                  </label>\n                  <select\n                    onPointerDown={(e) => {\n                      (e as any).stopPropagation();\n                    }}\n                    onMouseDown={(e) => {\n                      e.stopPropagation();\n                    }}\n                    id=\"favoriteDouble\"\n                    value={favoriteDouble}\n                    onChange={(e) => setFavoriteDouble(e.target.value)}\n                    className=\"input w-full\"\n                  >\n                    <option value=\"any\">Any Double</option>\n                    <option value=\"D20\">Double 20</option>\n                    <option value=\"D10\">Double 10</option>\n                    <option value=\"D5\">Double 5</option>\n                    <option value=\"D1\">Double 1</option>\n                  </select>\n                </div>\n                <div>\n                  <label htmlFor=\"avgMode\" className=\"block text-sm mb-2\">\n                    Average Display Mode\n                  </label>\n                  <select\n                    id=\"avgMode\"\n                    value={avgMode}\n                    onChange={(e) =>\n                      setAvgMode(e.target.value as \"all-time\" | \"24h\")\n                    }\n                    className=\"input w-full\"\n                  >\n                    <option value=\"all-time\">All Time Average</option>\n                    <option value=\"24h\">30 Day Average</option>\n                  </select>\n                </div>\n                <div className=\"flex items-center gap-3\">\n                  <input\n                    type=\"checkbox\"\n                    id=\"x01DoubleIn\"\n                    checked={!!x01DoubleIn}\n                    onChange={(e) => setX01DoubleIn(e.target.checked)}\n                    className=\"w-4 h-4\"\n                  />\n                  <label htmlFor=\"x01DoubleIn\" className=\"text-sm\">\n                    Require Double-In for X01\n                  </label>\n                </div>\n              </div>\n            </div>\n          </div>\n\n          {/* UI & Accessibility */}\n          <div className=\"card\">\n            <div className=\"p-3 rounded-xl border border-pink-500/40 bg-pink-500/10\">\n              <div className=\"font-semibold mb-4 flex items-center gap-2\">\n                <Eye className=\"w-5 h-5 text-pink-400\" /> UI & Accessibility \n              </div>\n              <div className=\"space-y-3\">\n                <div className=\"flex items-center gap-3\">\n                  <input\n                    type=\"checkbox\"\n                    id=\"autoStartOffline\"\n                    checked={autoStartOffline}\n                    onChange={(e) => setAutoStartOffline(e.target.checked)}\n                    className=\"w-4 h-4\"\n                  />\n                  <label htmlFor=\"autoStartOffline\" className=\"text-sm\">\n                    Auto-start offline games \n                  </label>\n                </div>\n                <div className=\"flex items-center gap-3\">\n                  <input\n                    type=\"checkbox\"\n                    id=\"rememberLastOffline\"\n                    checked={rememberLastOffline}\n                    onChange={(e) => setRememberLastOffline(e.target.checked)}\n                    className=\"w-4 h-4\"\n                  />\n                  <label htmlFor=\"rememberLastOffline\" className=\"text-sm\">\n                    Remember last offline game settings \n                  </label>\n                </div>\n                <div>\n                  <label htmlFor=\"offlineLayout\" className=\"block text-sm mb-2\">\n                    Offline Layout\n                  </label>\n                  <select\n                    id=\"offlineLayout\"\n                    value={offlineLayout || \"classic\"}\n                    onChange={(e) =>\n                      setOfflineLayout(e.target.value as \"classic\" | \"modern\")\n                    }\n                    className=\"input w-full\"\n                  >\n                    <option value=\"classic\">Classic Layout</option>\n                    <option value=\"modern\">Modern Layout</option>\n                  </select>\n                </div>\n                <div className=\"flex items-center gap-3\">\n                  <input\n                    type=\"checkbox\"\n                    id=\"reducedMotion\"\n                    checked={reducedMotion}\n                    onChange={(e) => setReducedMotion(e.target.checked)}\n                    className=\"w-4 h-4\"\n                  />\n                  <label htmlFor=\"reducedMotion\" className=\"text-sm\">\n                    Reduce motion/animations\n                  </label>\n                </div>\n                {/* theme toggle moved to its own section below */}\n                <div className=\"flex items-center gap-3\">\n                  <input\n                    type=\"checkbox\"\n                    id=\"compactHeader\"\n                    checked={compactHeader}\n                    onChange={(e) => setCompactHeader(e.target.checked)}\n                    className=\"w-4 h-4\"\n                  />\n                  <label htmlFor=\"compactHeader\" className=\"text-sm\">\n                    Compact header\n                  </label>\n                </div>\n              </div>\n            </div>\n          </div>\n\n          {/* Theme */}\n          <div className=\"card\">\n            <div className=\"p-3 rounded-xl border border-yellow-500/30 bg-yellow-500/6\">\n              <div className=\"font-semibold mb-4 flex items-center gap-2\">\n                <Settings className=\"w-5 h-5 text-yellow-400\" /> Theme \n              </div>\n              <div>\n                <ThemeToggle />\n              </div>\n            </div>\n          </div>\n\n          {/* Support & Help */}\n          <div className=\"card\">\n            <div className=\"p-3 rounded-xl border border-blue-500/40 bg-blue-500/10\">\n              <div className=\"font-semibold mb-4 flex items-center gap-2\">\n                <HelpCircle className=\"w-5 h-5 text-blue-400\" /> Support & Help\n                \n              </div>\n              <div className=\"space-y-2\">\n                <p className=\"text-sm opacity-80\">\n                  Need help? Contact us via email:\n                </p>\n                <a\n                  href=\"mailto:support@ninedartnation.com\"\n                  className=\"btn bg-blue-600 hover:bg-blue-700 w-full text-xs\"\n                >\n                  Email Support \n                </a>\n              </div>\n            </div>\n          </div>\n\n          {/* Help Assistant */}\n          <div className=\"card\">\n            <div className=\"p-3 rounded-xl border border-cyan-500/40 bg-cyan-500/10\">\n              <div className=\"font-semibold mb-4 flex items-center gap-2\">\n                <MessageCircle className=\"w-5 h-5 text-cyan-400\" /> Help\n                Assistant \n              </div>\n              <div className=\"space-y-3 max-h-96 overflow-y-auto\">\n                {helpMessages.map((msg, i) => (\n                  <div key={i} className={`${msg.isUser ? \"text-right\" : \"\"}`}>\n                    <div\n                      className={`inline-block max-w-xs px-3 py-2 rounded-lg text-sm ${msg.isUser ? \"bg-indigo-600 text-white\" : \"bg-white/10 text-slate-100\"}`}\n                    >\n                      {typeof msg.text === \"string\" ? (\n                        msg.text\n                      ) : (\n                        <>\n                          <div>{msg.text.text}</div>\n                          {msg.text.links && (\n                            <div className=\"mt-2 space-y-1\">\n                              {msg.text.links.map((link, j) => (\n                                <button\n                                  key={j}\n                                  onClick={() => navigateToTab(link.tab)}\n                                  className=\"block w-full text-left text-xs px-2 py-1 bg-white/20 hover:bg-white/30 rounded transition\"\n                                >\n                                  {link.text}\n                                </button>\n                              ))}\n                            </div>\n                          )}\n                        </>\n                      )}\n                    </div>\n                  </div>\n                ))}\n              </div>\n\n              {/* Input */}\n              <div className=\"flex gap-2 mt-3\">\n                <input\n                  type=\"text\"\n                  value={helpInput}\n                  onChange={(e) => setHelpInput(e.target.value)}\n                  onKeyPress={(e) => e.key === \"Enter\" && handleHelpSend()}\n                  placeholder=\"Ask me anything...\"\n                  className=\"flex-1 input\"\n                />\n                <button\n                  onClick={handleHelpSend}\n                  className=\"btn bg-blue-600 hover:bg-blue-700\"\n                >\n                  <Send className=\"w-4 h-4\" />\n                </button>\n              </div>\n            </div>\n          </div>\n        </div>\n      )}\n\n      {/* ==== ACHIEVEMENTS & BADGES (ALWAYS VISIBLE) ==== */}\n      <div className=\"card\">\n        <div className=\"p-3 rounded-xl border border-yellow-500/40 bg-yellow-500/10\">\n          <div className=\"font-semibold mb-4 flex items-center gap-2\">\n            <HelpCircle className=\"w-5 h-5 text-yellow-400\" /> Achievements &\n            Badges \n          </div>\n          <div className=\"grid grid-cols-2 md:grid-cols-3 gap-2\">\n            {achievements.map((a) => (\n              <div\n                key={a.key}\n                className={`p-3 rounded-lg border ${a.unlocked ? \"border-yellow-500/40 bg-yellow-500/10\" : \"border-white/10 bg-white/5\"}`}\n                title={a.desc}\n              >\n                <div className=\"text-lg\">{a.icon}</div>\n                <div className=\"text-xs font-semibold mt-1\">{a.label}</div>\n                <div className=\"text-[10px] opacity-70\">\n                  {a.unlocked ? \" Unlocked\" : \"Locked\"}\n                </div>\n              </div>\n            ))}\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n","import { useState } from \"react\";\nimport {\n  Eye,\n  EyeOff,\n  Trophy,\n  Users,\n  BarChart3,\n  ShieldCheck,\n  MessageCircle,\n} from \"lucide-react\";\nimport { getApiBaseUrl } from \"../utils/api\";\n\n// Demo admin values removed: unused in codebase\n\nexport default function Auth({ onAuth }: { onAuth: (user: any) => void }) {\n  const [mode, setMode] = useState<\"signin\" | \"signup\" | \"reset\">(\"signin\");\n  const [email, setEmail] = useState(\"\");\n  const [username, setUsername] = useState(\"\");\n  const [password, setPassword] = useState(\"\");\n  const [reminder, setReminder] = useState(\"\");\n  const [error, setError] = useState(\"\");\n  const [showPassword, setShowPassword] = useState(false);\n  const [loading, setLoading] = useState(false);\n\n  const API_URL = getApiBaseUrl();\n\n  const fetchWithTimeout = async (\n    input: RequestInfo | URL,\n    init: RequestInit = {},\n    timeoutMs = 60000, // Increased to 60 seconds\n  ) => {\n    const controller = new AbortController();\n    const timer = window.setTimeout(() => controller.abort(), timeoutMs);\n    try {\n      return await fetch(input, { ...init, signal: controller.signal });\n    } finally {\n      window.clearTimeout(timer);\n    }\n  };\n\n  async function handleSignIn(e: any) {\n    e.preventDefault();\n    setError(\"\");\n    setLoading(true);\n    // Preload main app chunks so switching to the app is faster\n    try {\n      void import(\"./Home\");\n      void import(\"./OnlinePlay.clean\");\n      void import(\"./OfflinePlay\");\n      void import(\"./Scoreboard\");\n      void import(\"./StatsPanel\");\n    } catch (e) {}\n    if (!username || !password) {\n      setError(\"Username and password required.\");\n      setLoading(false);\n      return;\n    }\n    try {\n      console.time(\"Auth:signIn roundtrip\");\n      const res = await fetchWithTimeout(`${API_URL}/api/auth/login`, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(\n          username.includes(\"@\")\n            ? { email: username, password }\n            : { username, password },\n        ),\n      });\n      const data = await res.json().catch(() => ({}));\n      console.timeEnd(\"Auth:signIn roundtrip\");\n      if (res.status === 429) {\n        setError(\n          \"Too many login attempts. Please wait 60 seconds and try again.\",\n        );\n      } else if (res.ok && data?.user && data?.token) {\n        localStorage.setItem(\"authToken\", data.token);\n        onAuth(data.user);\n      } else {\n        setError(data?.error || \"Invalid username or password.\");\n      }\n    } catch (err: any) {\n      console.error(\"Login error:\", err);\n      console.log(\"Attempting to connect to:\", `${API_URL}/api/auth/login`);\n      if (err?.name === \"AbortError\") {\n        setError(\n          `Login timed out after 60 seconds. Server: ${API_URL}. Please check if your server is running and accessible.`,\n        );\n      } else {\n        setError(\n          `Network error: ${err?.message || \"Unknown error\"}. Server: ${API_URL}. Please check your connection and try again.`,\n        );\n      }\n    } finally {\n      setLoading(false);\n    }\n  }\n\n  async function handleSignUp(e: any) {\n    e.preventDefault();\n    setError(\"\");\n    setLoading(true);\n    if (!email || !username || !password) {\n      setError(\"Email, username, and password required.\");\n      setLoading(false);\n      return;\n    }\n    try {\n      const res = await fetchWithTimeout(`${API_URL}/api/auth/signup`, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ email, username, password }),\n      });\n      const data = await res.json().catch(() => ({}));\n      if (res.ok && data?.user && data?.token) {\n        localStorage.setItem(\"authToken\", data.token);\n        onAuth(data.user);\n      } else {\n        setError(data?.error || \"Signup failed.\");\n      }\n    } catch (err: any) {\n      if (err?.name === \"AbortError\") {\n        setError(\"Signup timed out. Please try again.\");\n      } else {\n        setError(\"Network error.\");\n      }\n    } finally {\n      setLoading(false);\n    }\n  }\n\n  async function handleReset(e: any) {\n    e.preventDefault();\n    setError(\"\");\n    setLoading(true);\n    if (!email || !email.includes(\"@\")) {\n      setError(\"Enter your email address.\");\n      setLoading(false);\n      return;\n    }\n    try {\n      const r = await fetchWithTimeout(`${API_URL}/api/auth/send-reset`, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ email }),\n      });\n      const j = await r.json().catch(() => ({}));\n      if (!j?.ok) throw new Error(j?.error || \"Failed to send reset email\");\n      setError(\"Password reset link sent to your email.\");\n    } catch (err: any) {\n      setError(err?.message || \"Failed to send reset email\");\n    } finally {\n      setLoading(false);\n    }\n  }\n\n  async function handleSendUsername(e: any) {\n    e.preventDefault();\n    setError(\"\");\n    setLoading(true);\n    if (!email || !email.includes(\"@\")) {\n      setError(\"Enter your email address.\");\n      setLoading(false);\n      return;\n    }\n    try {\n      const r = await fetchWithTimeout(`${API_URL}/api/auth/send-username`, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ email }),\n      });\n      const j = await r.json().catch(() => ({}));\n      if (!j?.ok) throw new Error(j?.error || \"Failed to send username email\");\n      setError(\"Your username has been emailed to you.\");\n    } catch (err: any) {\n      setError(err?.message || \"Failed to send username email\");\n    } finally {\n      setLoading(false);\n    }\n  }\n\n  return (\n    <div className=\"min-h-screen flex items-center justify-center bg-[#0F0C1D] p-4 relative overflow-hidden\">\n      {/* Background decorative elements */}\n      <div className=\"absolute top-0 left-0 w-full h-full overflow-hidden pointer-events-none\">\n        <div className=\"absolute -top-[10%] -left-[10%] w-[40%] h-[40%] bg-indigo-500/10 blur-[120px] rounded-full\" />\n        <div className=\"absolute -bottom-[10%] -right-[10%] w-[40%] h-[40%] bg-purple-500/10 blur-[120px] rounded-full\" />\n      </div>\n\n      <div className=\"w-full max-w-md relative z-10\">\n        <div className=\"text-center mb-8\">\n          <h1 className=\"text-4xl font-black text-transparent bg-clip-text bg-gradient-to-r from-white via-white to-white/40 tracking-tighter mb-2\">\n            NINE-DART-NATION \n          </h1>\n          <p className=\"text-white/40 font-medium uppercase tracking-[0.3em] text-xs\">\n            {mode === \"signin\"\n              ? \"Sign In \"\n              : mode === \"signup\"\n                ? \"Create Account \"\n                : \"Reset Password \"}\n          </p>\n        </div>\n\n        <div className=\"flex items-center justify-center gap-3 mb-6\">\n          {[\n            { key: \"signin\", label: \"Sign In\" },\n            { key: \"signup\", label: \"Sign Up\" },\n            { key: \"reset\", label: \"Reset\" },\n          ].map((option) => (\n            <button\n              key={option.key}\n              type=\"button\"\n              onClick={() => setMode(option.key as typeof mode)}\n              className={`px-4 py-1.5 rounded-full text-xs font-bold tracking-wide transition-all ${mode === option.key ? \"bg-white text-indigo-600\" : \"bg-white/5 text-white/70 hover:bg-white/10\"}`}\n            >\n              {option.label}\n            </button>\n          ))}\n        </div>\n\n        <div className=\"bg-white/[0.03] border border-white/10 backdrop-blur-xl rounded-[2.5rem] p-8 shadow-2xl\">\n          <form\n            className=\"space-y-4\"\n            onSubmit={\n              mode === \"signin\"\n                ? handleSignIn\n                : mode === \"signup\"\n                  ? handleSignUp\n                  : handleReset\n            }\n          >\n            {(mode === \"signup\" || mode === \"reset\") && (\n              <input\n                className=\"input w-full\"\n                type=\"email\"\n                placeholder=\"Email\"\n                value={email}\n                onChange={(e) => setEmail(e.target.value)}\n                autoComplete=\"email\"\n                required\n              />\n            )}\n            {mode !== \"reset\" && (\n              <input\n                className=\"input w-full\"\n                type=\"text\"\n                placeholder=\"Username or Email\"\n                value={username}\n                onChange={(e) => setUsername(e.target.value)}\n                autoComplete=\"username\"\n                required\n              />\n            )}\n            {mode !== \"reset\" && (\n              <div className=\"relative\">\n                <input\n                  className=\"input w-full pr-10\"\n                  type={showPassword ? \"text\" : \"password\"}\n                  placeholder=\"Password\"\n                  value={password}\n                  onChange={(e) => setPassword(e.target.value)}\n                  autoComplete=\"current-password\"\n                  required\n                  onFocus={() => setShowPassword(false)}\n                  onBlur={() => setShowPassword(false)}\n                />\n                <button\n                  type=\"button\"\n                  className=\"absolute right-2 top-1/2 -translate-y-1/2 text-slate-300 hover:text-white\"\n                  tabIndex={-1}\n                  onMouseDown={(e) => {\n                    e.preventDefault();\n                    setShowPassword(true);\n                  }}\n                  onMouseUp={(e) => {\n                    e.preventDefault();\n                    setShowPassword(false);\n                  }}\n                  onMouseLeave={() => setShowPassword(false)}\n                  onTouchStart={(e) => {\n                    e.preventDefault();\n                    setShowPassword(true);\n                  }}\n                  onTouchEnd={(e) => {\n                    e.preventDefault();\n                    setShowPassword(false);\n                  }}\n                  aria-label=\"Toggle password visibility\"\n                >\n                  {showPassword ? (\n                    <EyeOff className=\"w-5 h-5\" />\n                  ) : (\n                    <Eye className=\"w-5 h-5\" />\n                  )}\n                </button>\n              </div>\n            )}\n            {mode === \"signup\" && (\n              <input\n                className=\"input w-full\"\n                type=\"text\"\n                placeholder=\"Password Reminder (optional)\"\n                value={reminder}\n                onChange={(e) => setReminder(e.target.value)}\n                autoComplete=\"off\"\n              />\n            )}\n            {error && (\n              <div className=\"text-red-400 font-semibold text-sm\">{error}</div>\n            )}\n            <button\n              type=\"submit\"\n              disabled={loading}\n              className=\"w-full py-4 rounded-2xl bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-bold shadow-lg shadow-indigo-500/20 hover:scale-[1.02] active:scale-[0.98] transition-all disabled:opacity-50 disabled:hover:scale-100\"\n            >\n              {loading ? (\n                <div className=\"flex items-center justify-center gap-2\">\n                  <div className=\"w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin\" />\n                  Processing...\n                </div>\n              ) : mode === \"signin\" ? (\n                \"Sign In \"\n              ) : mode === \"signup\" ? (\n                \"Sign Up \"\n              ) : (\n                \"Send Reset Link \"\n              )}\n            </button>\n\n            {mode === \"signin\" && (\n              <>\n                <button\n                  type=\"button\"\n                  onClick={handleSendUsername}\n                  className=\"w-full py-2 text-xs font-bold text-white/30 hover:text-white/60 transition-colors\"\n                >\n                  Email me my username \n                </button>\n                <button\n                  type=\"button\"\n                  onClick={() => {\n                    localStorage.clear();\n                    setError(\"Cache cleared. Please try logging in again.\");\n                  }}\n                  className=\"w-full py-2 text-xs font-bold text-white/20 hover:text-white/40 transition-colors\"\n                >\n                  Clear cache & retry \n                </button>\n                <button\n                  type=\"button\"\n                  onClick={async () => {\n                    setError(\"\");\n                    setLoading(true);\n                    try {\n                      console.log(\n                        \"Testing connection to:\",\n                        `${API_URL}/api/health`,\n                      );\n                      const res = await fetchWithTimeout(\n                        `${API_URL}/api/health`,\n                        {\n                          method: \"GET\",\n                        },\n                        10000,\n                      );\n                      if (res.ok) {\n                        setError(` Server is reachable at ${API_URL}`);\n                      } else {\n                        setError(\n                          ` Server responded with status ${res.status} at ${API_URL}`,\n                        );\n                      }\n                    } catch (err: any) {\n                      setError(\n                        ` Cannot reach server at ${API_URL}. Error: ${err?.message || \"Unknown\"}. Please check if your server is running.`,\n                      );\n                    } finally {\n                      setLoading(false);\n                    }\n                  }}\n                  className=\"w-full py-2 text-xs font-bold text-white/20 hover:text-white/40 transition-colors\"\n                >\n                  Test server connection \n                </button>\n              </>\n            )}\n          </form>\n        </div>\n\n        <div className=\"mt-12 grid grid-cols-1 gap-4\">\n          <div className=\"p-6 rounded-3xl bg-white/[0.02] border border-white/5\">\n            <h3 className=\"text-xl font-bold mb-3 text-white/90\">\n              What's inside \n            </h3>\n            <ul className=\"space-y-3\">\n              <li className=\"flex items-start gap-3\">\n                <Users className=\"w-5 h-5 text-indigo-300 mt-1\" />\n                <div>\n                  <div className=\"font-semibold\">Online & Friends</div>\n                  <div className=\"text-sm text-slate-200/90\">\n                    Challenge friends, chat, and join leagues.\n                  </div>\n                </div>\n              </li>\n              <li className=\"flex items-start gap-3\">\n                <BarChart3 className=\"w-5 h-5 text-indigo-300 mt-1\" />\n                <div>\n                  <div className=\"font-semibold\">Deep Stats</div>\n                  <div className=\"text-sm text-slate-200/90\">\n                    Track 3-dart averages, best legs, and more.\n                  </div>\n                </div>\n              </li>\n              <li className=\"flex items-start gap-3\">\n                <Trophy className=\"w-5 h-5 text-indigo-300 mt-1\" />\n                <div>\n                  <div className=\"font-semibold\">Game Modes</div>\n                  <div className=\"text-sm text-slate-200/90\">\n                    Start with 3 free online games upon signup. After that,\n                    PREMIUM is required to play all games.\n                  </div>\n                </div>\n              </li>\n              <li className=\"flex items-start gap-3\">\n                <ShieldCheck className=\"w-5 h-5 text-indigo-300 mt-1\" />\n                <div>\n                  <div className=\"font-semibold\">Premium Perks</div>\n                  <div className=\"text-sm text-slate-200/90\">\n                    Polished UI, upcoming features, and early access.\n                  </div>\n                </div>\n              </li>\n              <li className=\"flex items-start gap-3\">\n                <MessageCircle className=\"w-5 h-5 text-indigo-300 mt-1\" />\n                <div>\n                  <div className=\"font-semibold\">Live Support</div>\n                  <div className=\"text-sm text-slate-200/90\">\n                    Chat with moderators whenever you need a hand.\n                  </div>\n                </div>\n              </li>\n            </ul>\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n","import SeasonalProvider, {\n  useTheme as useSeasonalTheme,\n} from \"../contexts/ThemeProvider\";\n\n// Re-export a thin compatibility layer so existing code that imports\n// from \"./components/ThemeContext\" continues to work.\nexport const ThemeProvider = SeasonalProvider;\nexport const useTheme = useSeasonalTheme;\n\nexport default ThemeProvider;\n","import React, { useEffect, useState } from \"react\";\nimport { HelpCircle, MessageCircle, X, Send } from \"lucide-react\";\nimport { apiFetch } from \"../utils/api\";\nimport { useWS } from \"./WSProvider\";\nimport HelpdeskChat from \"./HelpdeskChat\";\n\nexport default function HelpAssistant() {\n  const [isOpen, setIsOpen] = useState(false);\n  const [messages, setMessages] = useState<\n    Array<{\n      text:\n        | string\n        | { text: string; links?: Array<{ text: string; tab: string }> };\n      isUser: boolean;\n    }>\n  >([\n    {\n      text: \"Hi! I'm your Nine Dart Nation assistant. How can I help you today?\",\n      isUser: false,\n    },\n  ]);\n  const [input, setInput] = useState(\"\");\n  const [awaitingAdminConfirm, setAwaitingAdminConfirm] = useState(false);\n  const [lastUserQuestion, setLastUserQuestion] = useState(\"\");\n  const [myRequest, setMyRequest] = useState<any | null>(null);\n  const ws = (() => {\n    try {\n      return useWS();\n    } catch {\n      return null;\n    }\n  })();\n\n  useEffect(() => {\n    if (!ws) return;\n    const unsub = ws.addListener((data: any) => {\n      try {\n        if (\n          data?.type === \"help-message\" &&\n          myRequest &&\n          String(data.requestId) === String(myRequest.id)\n        ) {\n          // append message to chat (the HelpdeskChat modal will also get WS events, but keep assistant messages synced)\n          // We don't duplicate state here; just forward to help chat placeholder by refreshing request from server\n        }\n        if (\n          data?.type === \"help-request-updated\" &&\n          myRequest &&\n          data.request?.id === myRequest.id\n        ) {\n          setMyRequest(data.request);\n        }\n      } catch {}\n    });\n    return () => unsub();\n  }, [ws, myRequest]);\n\n  const navigateToTab = (tabKey: string) => {\n    try {\n      window.dispatchEvent(\n        new CustomEvent(\"ndn:change-tab\", { detail: { tab: tabKey } }),\n      );\n      setIsOpen(false); // Close the help modal after navigation\n    } catch (error) {\n      console.error(\"Navigation failed:\", error);\n    }\n  };\n\n  const getResponseWithLinks = (\n    userMessage: string,\n  ): { text: string; links?: Array<{ text: string; tab: string }> } => {\n    const message = userMessage.toLowerCase();\n\n    if (message.includes(\"username\") || message.includes(\"change name\")) {\n      return {\n        text: \"You can change your username once for free.\",\n        links: [{ text: \"Go to Settings > Account\", tab: \"settings\" }],\n      };\n    }\n    if (\n      message.includes(\"premium\") ||\n      message.includes(\"upgrade\") ||\n      message.includes(\"subscription\")\n    ) {\n      return {\n        text: \"Premium unlocks all game modes and features.\",\n        links: [{ text: \"Go to Online Play\", tab: \"online\" }],\n      };\n    }\n    if (\n      message.includes(\"calibrat\") ||\n      message.includes(\"camera\") ||\n      message.includes(\"vision\")\n    ) {\n      return {\n        text: \"Set up your camera properly in Settings.\",\n        links: [{ text: \"Go to Settings > Camera & Vision\", tab: \"settings\" }],\n      };\n    }\n    if (\n      message.includes(\"voice\") ||\n      message.includes(\"caller\") ||\n      message.includes(\"audio\")\n    ) {\n      return {\n        text: \"Enable voice calling in Settings.\",\n        links: [{ text: \"Go to Settings > Audio & Voice\", tab: \"settings\" }],\n      };\n    }\n    if (message.includes(\"friend\") || message.includes(\"play together\")) {\n      return {\n        text: \"Add friends to play together.\",\n        links: [{ text: \"Go to Friends\", tab: \"friends\" }],\n      };\n    }\n    if (\n      message.includes(\"stat\") ||\n      message.includes(\"score\") ||\n      message.includes(\"performance\")\n    ) {\n      return {\n        text: \"View your statistics and performance.\",\n        links: [{ text: \"Go to Stats\", tab: \"stats\" }],\n      };\n    }\n    if (\n      message.includes(\"setting\") ||\n      message.includes(\"customiz\") ||\n      message.includes(\"configur\")\n    ) {\n      return {\n        text: \"Customize your experience.\",\n        links: [{ text: \"Go to Settings\", tab: \"settings\" }],\n      };\n    }\n    if (message.includes(\"tournament\") || message.includes(\"competition\")) {\n      return {\n        text: \"Check out tournaments and competitions.\",\n        links: [{ text: \"Go to Tournaments\", tab: \"tournaments\" }],\n      };\n    }\n    if (\n      message.includes(\"score\") ||\n      message.includes(\"scoring\") ||\n      message.includes(\"autoscore\")\n    ) {\n      return {\n        text: \"Auto-scoring assigns darts to board segments automatically. You can review and adjust placements in the Match Summary screen.\",\n        links: [{ text: \"Go to Match Summary\", tab: \"matchsummary\" }],\n      };\n    }\n    if (\n      message.includes(\"pair\") ||\n      message.includes(\"pairing\") ||\n      message.includes(\"phone\") ||\n      message.includes(\"camera pairing\")\n    ) {\n      return {\n        text: \"Use the Pairing flow to connect phones and cameras. Make sure devices are on the same Wi-Fi and scan the QR code shown.\",\n        links: [{ text: \"Open Pairing\", tab: \"pairing\" }],\n      };\n    }\n    if (\n      message.includes(\"highlight\") ||\n      message.includes(\"download\") ||\n      message.includes(\"save\")\n    ) {\n      return {\n        text: \"Highlights can be downloaded or saved to your account from the Highlights section. We keep a record when you hit milestone checkouts or visits.\",\n        links: [{ text: \"Open Highlights\", tab: \"highlights\" }],\n      };\n    }\n    if (\n      message.includes(\"privacy\") ||\n      message.includes(\"copyright\") ||\n      message.includes(\"legal\")\n    ) {\n      return {\n        text: \"Our Legal Notice and Privacy information are available in the footer. You can view privacy, copyright, and contact details there.\",\n        links: [{ text: \"View Legal Notice\", tab: \"footer\" }],\n      };\n    }\n    if (\n      message.includes(\"help\") ||\n      message.includes(\"support\") ||\n      message.includes(\"faq\")\n    ) {\n      return {\n        text: \"You're already in the help section! Check Settings for more resources.\",\n        links: [{ text: \"Go to Settings > Support\", tab: \"settings\" }],\n      };\n    }\n    if (\n      message.includes(\"how to play\") ||\n      message.includes(\"game\") ||\n      message.includes(\"start\")\n    ) {\n      return {\n        text: \"To play darts, select a game mode from the menu. For online play, join a match. For offline, start a local game.\",\n        links: [\n          { text: \"Play Online\", tab: \"online\" },\n          { text: \"Play Offline\", tab: \"offline\" },\n        ],\n      };\n    }\n\n    return {\n      text: \"I'm not sure about that. Try asking about playing, calibration, premium, username changes, voice settings, friends, stats, or settings.\",\n    };\n  };\n\n  const handleSend = () => {\n    if (!input.trim()) return;\n    const userMessageRaw = input.trim();\n    const userMessage = userMessageRaw.toLowerCase();\n    setMessages((prev) => [...prev, { text: userMessageRaw, isUser: true }]);\n    setInput(\"\");\n\n    // If we're awaiting admin confirmation, interpret YES/NO\n    if (awaitingAdminConfirm) {\n      if (userMessage.startsWith(\"y\")) {\n        // Send help request to server\n        setMessages((prev) => [\n          ...prev,\n          {\n            text: \"Okay  I will notify an admin. Please wait for them to join the chat.\",\n            isUser: false,\n          },\n        ]);\n        setAwaitingAdminConfirm(false);\n        // fire-and-forget\n        (async () => {\n          try {\n            const payload = { message: lastUserQuestion || userMessageRaw };\n            const res = await apiFetch(\"/api/help/requests\", {\n              method: \"POST\",\n              headers: { \"Content-Type\": \"application/json\" },\n              body: JSON.stringify(payload),\n            });\n            const j = await res.json().catch(() => null);\n            // If server returns the request record, open the live chat\n            if (j && j.request) {\n              setMyRequest(j.request);\n              setMessages((prev) => [\n                ...prev,\n                {\n                  text: \"Okay  I will notify an admin. Please wait for them to join the chat.\",\n                  isUser: false,\n                },\n              ]);\n            } else {\n              setMessages((prev) => [\n                ...prev,\n                {\n                  text: \"Okay  I will notify an admin. Please wait for them to join the chat.\",\n                  isUser: false,\n                },\n              ]);\n            }\n          } catch (err) {\n            setMessages((prev) => [\n              ...prev,\n              {\n                text: \"Failed to contact admins. Please try again later.\",\n                isUser: false,\n              },\n            ]);\n          }\n        })();\n        return;\n      } else {\n        setMessages((prev) => [\n          ...prev,\n          {\n            text: \"Okay  I won't notify an admin. If you change your mind, just ask.\",\n            isUser: false,\n          },\n        ]);\n        setAwaitingAdminConfirm(false);\n        return;\n      }\n    }\n\n    // Get response with smart link suggestions\n    const response = getResponseWithLinks(userMessage);\n\n    // If the bot couldn't answer well, offer to escalate\n    if (\n      typeof response.text === \"string\" &&\n      response.text.includes(\"I'm not sure about that\")\n    ) {\n      setLastUserQuestion(userMessageRaw);\n      setAwaitingAdminConfirm(true);\n      setTimeout(() => {\n        setMessages((prev) => [\n          ...prev,\n          {\n            text: {\n              text: \"I can connect you to a member of our admin team  would you like that? Type YES or NO.\",\n              links: [],\n            },\n            isUser: false,\n          },\n        ]);\n      }, 350);\n      return;\n    }\n\n    setTimeout(() => {\n      setMessages((prev) => [...prev, { text: response, isUser: false }]);\n    }, 500);\n  };\n\n  return (\n    <>\n      {/* Floating Button */}\n      <button\n        onClick={() => setIsOpen(true)}\n        className=\"fixed bottom-4 right-4 z-50 bg-blue-600 hover:bg-blue-700 text-white p-4 rounded-full shadow-lg transition-colors\"\n        title=\"Help Assistant\"\n      >\n        <HelpCircle className=\"w-6 h-6\" />\n      </button>\n\n      {/* Modal */}\n      {isOpen && (\n        <div className=\"fixed inset-0 z-50 flex items-end justify-end p-4\">\n          <div\n            className=\"absolute inset-0 bg-black/50\"\n            onClick={() => setIsOpen(false)}\n          />\n          <div className=\"relative bg-slate-800 rounded-lg shadow-xl w-full max-w-md h-96 flex flex-col\">\n            {/* Header */}\n            <div className=\"flex items-center justify-between p-4 border-b border-slate-700\">\n              <div className=\"flex items-center gap-2\">\n                <MessageCircle className=\"w-5 h-5 text-blue-400\" />\n                <span className=\"font-semibold\">Help Assistant</span>\n              </div>\n              <button\n                onClick={() => setIsOpen(false)}\n                className=\"text-slate-400 hover:text-white\"\n              >\n                <X className=\"w-5 h-5\" />\n              </button>\n            </div>\n\n            {/* Messages */}\n            <div className=\"flex-1 overflow-y-auto p-4 space-y-3\">\n              {messages.map((msg, i) => (\n                <div\n                  key={i}\n                  className={`flex ${msg.isUser ? \"justify-end\" : \"justify-start\"}`}\n                >\n                  <div\n                    className={`max-w-xs px-3 py-2 rounded-lg ${\n                      msg.isUser\n                        ? \"bg-blue-600 text-white\"\n                        : \"bg-slate-700 text-slate-200\"\n                    }`}\n                  >\n                    {typeof msg.text === \"string\" ? (\n                      msg.text\n                    ) : (\n                      <div className=\"space-y-2\">\n                        <div>{msg.text.text}</div>\n                        {msg.text.links && (\n                          <div className=\"space-y-1\">\n                            {msg.text.links.map((link, linkIndex) => (\n                              <button\n                                key={linkIndex}\n                                onClick={() => navigateToTab(link.tab)}\n                                className=\"block w-full text-left text-blue-300 hover:text-blue-200 underline text-sm\"\n                              >\n                                {link.text}\n                              </button>\n                            ))}\n                          </div>\n                        )}\n                      </div>\n                    )}\n                  </div>\n                </div>\n              ))}\n            </div>\n\n            {/* Input */}\n            <div className=\"p-4 border-t border-slate-700\">\n              <div className=\"flex gap-2\">\n                <input\n                  type=\"text\"\n                  value={input}\n                  onChange={(e) => setInput(e.target.value)}\n                  onKeyPress={(e) => e.key === \"Enter\" && handleSend()}\n                  placeholder=\"Ask me anything...\"\n                  className=\"flex-1 input\"\n                />\n                <button\n                  onClick={handleSend}\n                  className=\"btn bg-blue-600 hover:bg-blue-700\"\n                >\n                  <Send className=\"w-4 h-4\" />\n                </button>\n              </div>\n            </div>\n          </div>\n        </div>\n      )}\n\n      {/* Render live chat modal if a help request exists for this user */}\n      {myRequest && (\n        <HelpdeskChat\n          request={myRequest}\n          user={{ email: null, username: null, isAdmin: false }}\n          onClose={() => setMyRequest(null)}\n        />\n      )}\n    </>\n  );\n}\n","import { useEffect, useRef } from \"react\";\nimport { dlog } from \"../utils/logger\";\nimport { useCameraSession } from \"../store/cameraSession\";\n\n// GlobalCameraLogger: attaches to the camera session and emits detailed logs\n// about video element, media stream, and peer connection state so logs are\n// visible even when navigating away from Calibrator.\nexport default function GlobalCameraLogger() {\n  const camera = useCameraSession();\n  const lastStateRef = useRef<any>({});\n  const listenersRef = useRef<any>({});\n\n  useEffect(() => {\n    function dumpState(prefix = \"[GlobalCamera]\") {\n      try {\n        const video = camera.getVideoElementRef();\n        const media = camera.getMediaStream();\n        const pc = camera.getPcRef && camera.getPcRef();\n        const ws = camera.getWsRef && camera.getWsRef();\n        dlog(prefix, {\n          isStreaming: camera.isStreaming,\n          mode: camera.mode,\n          showOverlay: camera.showOverlay,\n          hasVideoElement: !!video,\n          video: video\n            ? {\n                videoWidth: video.videoWidth,\n                videoHeight: video.videoHeight,\n                srcObject: !!video.srcObject,\n              }\n            : null,\n          mediaTracks: media\n            ? media\n                .getTracks()\n                .map((t) => ({ kind: t.kind, enabled: t.enabled, id: t.id }))\n            : null,\n          pcState: pc ? pc.connectionState || pc.iceConnectionState : null,\n          wsState: ws ? ws.readyState || \"unknown\" : null,\n        });\n      } catch (e) {\n        console.warn(\"[GlobalCamera] dumpState failed\", e);\n      }\n    }\n\n    // Initial dump\n    dumpState(\"[GlobalCamera] INIT\");\n\n    // Subscribe to Zustand changes by polling minimal differences (safe & simple)\n    let mounted = true;\n    const interval = setInterval(() => {\n      if (!mounted) return;\n      try {\n        const video = camera.getVideoElementRef();\n        const media = camera.getMediaStream();\n        const pc = camera.getPcRef && camera.getPcRef();\n        const snapshot = {\n          isStreaming: camera.isStreaming,\n          mode: camera.mode,\n          hasVideo: !!video,\n          videoW: video ? video.videoWidth : 0,\n          videoH: video ? video.videoHeight : 0,\n          tracks: media ? media.getTracks().length : 0,\n          pcState: pc ? pc.connectionState || pc.iceConnectionState : null,\n        };\n        const prev = lastStateRef.current;\n        // Shallow compare a few keys\n        if (\n          snapshot.isStreaming !== prev.isStreaming ||\n          snapshot.hasVideo !== prev.hasVideo ||\n          snapshot.videoW !== prev.videoW ||\n          snapshot.videoH !== prev.videoH ||\n          snapshot.tracks !== prev.tracks ||\n          snapshot.pcState !== prev.pcState ||\n          camera.showOverlay !== prev.showOverlay\n        ) {\n          lastStateRef.current = snapshot;\n          dumpState(\"[GlobalCamera] CHANGE\");\n        }\n      } catch (e) {\n        console.warn(\"[GlobalCamera] poll failed\", e);\n      }\n    }, 750);\n\n    // Attach video element listeners when available to capture events like loadedmetadata/playing\n    function attachVideoListeners(v: HTMLVideoElement | null) {\n      try {\n        const prev = listenersRef.current.video;\n        if (prev && prev.el === v) return;\n        if (prev && prev.el) {\n          try {\n            prev.el.removeEventListener(\"loadedmetadata\", prev.loadedmetadata);\n          } catch {}\n          try {\n            prev.el.removeEventListener(\"playing\", prev.playing);\n          } catch {}\n          try {\n            prev.el.removeEventListener(\"pause\", prev.pause);\n          } catch {}\n          try {\n            prev.el.removeEventListener(\"ended\", prev.ended);\n          } catch {}\n        }\n        listenersRef.current.video = null;\n        if (v) {\n          const loadedmetadata = () =>\n            dlog(\"[GlobalCamera] video loadedmetadata\", {\n              videoWidth: v.videoWidth,\n              videoHeight: v.videoHeight,\n            });\n          const playing = () => {\n            dlog(\"[GlobalCamera] video playing\", { paused: v.paused });\n          };\n          const pause = () => {\n            dlog(\"[GlobalCamera] video pause\");\n          };\n          const ended = () => {\n            dlog(\"[GlobalCamera] video ended\");\n          };\n          v.addEventListener(\"loadedmetadata\", loadedmetadata);\n          v.addEventListener(\"playing\", playing);\n          v.addEventListener(\"pause\", pause);\n          v.addEventListener(\"ended\", ended);\n          listenersRef.current.video = {\n            el: v,\n            loadedmetadata,\n            playing,\n            pause,\n            ended,\n          };\n        }\n      } catch (e) {\n        console.warn(\"[GlobalCamera] attachVideoListeners failed\", e);\n      }\n    }\n\n    // Watch for PC state changes if RTCPeerConnection is present\n    function attachPc(pc: RTCPeerConnection | null) {\n      try {\n        const prev = listenersRef.current.pc;\n        if (prev && prev.pc === pc) return;\n        if (prev && prev.pc) {\n          try {\n            prev.pc.removeEventListener(\n              \"connectionstatechange\",\n              prev.connChange,\n            );\n          } catch {}\n        }\n        listenersRef.current.pc = null;\n        if (pc) {\n          const connChange = () =>\n            dlog(\"[GlobalCamera] pc state change\", {\n              connectionState: pc.connectionState,\n              iceState: (pc as any).iceConnectionState,\n            });\n          pc.addEventListener(\"connectionstatechange\", connChange);\n          listenersRef.current.pc = { pc, connChange };\n        }\n      } catch (e) {\n        console.warn(\"[GlobalCamera] attachPc failed\", e);\n      }\n    }\n\n    // Periodically re-attach listeners if refs change\n    const attachInterval = setInterval(() => {\n      try {\n        attachVideoListeners(camera.getVideoElementRef());\n        attachPc(camera.getPcRef && camera.getPcRef());\n      } catch (e) {}\n    }, 1000);\n\n    return () => {\n      mounted = false;\n      clearInterval(interval);\n      clearInterval(attachInterval);\n      // cleanup listeners\n      try {\n        const v = listenersRef.current.video;\n        if (v && v.el) {\n          v.el.removeEventListener(\"loadedmetadata\", v.loadedmetadata);\n          v.el.removeEventListener(\"playing\", v.playing);\n        }\n      } catch (e) {}\n      try {\n        const p = listenersRef.current.pc;\n        if (p && p.pc)\n          p.pc.removeEventListener(\"connectionstatechange\", p.connChange);\n      } catch (e) {}\n    };\n  }, [camera]);\n\n  return null;\n}\n","import { useEffect, useRef } from \"react\";\nimport { useCameraSession } from \"../store/cameraSession\";\n\n/**\n * GlobalPhoneVideoSink\n * Keeps a hidden video element alive across navigation and feeds it the phone camera stream\n * so other components (overlay, badge) can draw frames even when Calibrator unmounts.\n */\nexport default function GlobalPhoneVideoSink() {\n  const camera = useCameraSession();\n  const vref = useRef<HTMLVideoElement | null>(null);\n  const lastStreamRef = useRef<MediaStream | null>(null);\n  const lastTimeRef = useRef<number>(0);\n  const stallSecondsRef = useRef<number>(0);\n  const lastReconnectAtRef = useRef<number>(0);\n  const attemptRef = useRef<number>(0);\n\n  // Ensure there is ALWAYS a global video element registered.\n  // This makes `camera.getMediaStream()` resilient across navigation and popups,\n  // because a stream can be read back from `videoElementRefHolder.srcObject`.\n  useEffect(() => {\n    if (vref.current) {\n      camera.setVideoElementRef(vref.current);\n    }\n  }, [camera]);\n\n  // Apply the current stream and keep it playing\n  useEffect(() => {\n    let mounted = true;\n\n    const apply = async () => {\n      if (!mounted) return;\n      try {\n        const s = camera.getMediaStream();\n        const vid = vref.current;\n        if (!vid || !s) return;\n        if (lastStreamRef.current !== s || vid.srcObject !== s) {\n          vid.srcObject = s;\n          lastStreamRef.current = s;\n        }\n        vid.muted = true;\n        (vid as any).playsInline = true;\n        try {\n          await vid.play();\n        } catch {}\n      } catch {}\n    };\n\n    // Try immediately and then poll a bit to catch late streams\n    apply();\n    const t = setInterval(apply, 750);\n    return () => {\n      mounted = false;\n      clearInterval(t);\n    };\n  }, [camera]);\n\n  // Watchdog: if the video currentTime doesn't advance for >3s while streaming, request a reconnect with backoff\n  useEffect(() => {\n    const tick = () => {\n      const v = vref.current;\n      const now = Date.now();\n      if (!v || !camera.isStreaming || camera.mode !== \"phone\") {\n        stallSecondsRef.current = 0;\n        return;\n      }\n      if (!v.srcObject) {\n        const minBackoff = [3000, 6000, 10000][Math.min(attemptRef.current, 2)];\n        if (now - lastReconnectAtRef.current >= minBackoff) {\n          lastReconnectAtRef.current = now;\n          attemptRef.current = Math.min(attemptRef.current + 1, 3);\n          try {\n            window.dispatchEvent(\n              new CustomEvent(\"ndn:phone-camera-reconnect\", {\n                detail: { reason: \"missing-stream\", ts: now },\n              }),\n            );\n            v.play().catch(() => {});\n          } catch {}\n        }\n        return;\n      }\n      const ct = (v as HTMLVideoElement).currentTime || 0;\n      if (!Number.isFinite(ct)) return;\n      if (ct === lastTimeRef.current) {\n        stallSecondsRef.current += 1;\n      } else {\n        stallSecondsRef.current = 0;\n      }\n      lastTimeRef.current = ct;\n      if (stallSecondsRef.current >= 3) {\n        const minBackoff = [3000, 6000, 10000][Math.min(attemptRef.current, 2)];\n        if (now - lastReconnectAtRef.current >= minBackoff) {\n          lastReconnectAtRef.current = now;\n          attemptRef.current = Math.min(attemptRef.current + 1, 3);\n          try {\n            window.dispatchEvent(\n              new CustomEvent(\"ndn:phone-camera-reconnect\", {\n                detail: { reason: \"stall\", ts: now },\n              }),\n            );\n            // Try to nudge playback locally as well\n            v.play().catch(() => {});\n          } catch {}\n        }\n      } else if (stallSecondsRef.current === 0) {\n        // Reset attempts on healthy playback\n        attemptRef.current = 0;\n      }\n    };\n    const id = setInterval(tick, 1000);\n    return () => clearInterval(id);\n  }, [camera]);\n\n  // Keep dimensions tiny but visible so playback isn't throttled by display:none in some browsers\n  return (\n    <video\n      ref={vref}\n      style={{\n        position: \"fixed\",\n        width: 1,\n        height: 1,\n        left: -9999,\n        top: -9999,\n        opacity: 0,\n      }}\n      muted\n      playsInline\n      aria-hidden\n    />\n  );\n}\n","import { useCameraSession } from \"../store/cameraSession\";\nimport { useUserSettings } from \"../store/userSettings\";\n\nexport type CameraRecoveryReason =\n  | \"user-click\"\n  | \"watchdog-stall\"\n  | \"watchdog-ended-track\"\n  | \"watchdog-paused\"\n  | \"watchdog-detached\"\n  | \"watchdog-visibility-resume\";\n\n/**\n * Dispatch the appropriate recovery event for current camera mode.\n * This keeps CameraView + overlays as the single source of truth for reconnect/reset.\n */\nexport function dispatchCameraRecovery(reason: CameraRecoveryReason) {\n  const session = useCameraSession.getState();\n  const settings = useUserSettings.getState();\n  const now = Date.now();\n\n  const wantsPhone =\n    settings.preferredCameraLabel === \"Phone Camera\" ||\n    session.mode === \"phone\";\n\n  if (wantsPhone) {\n    window.dispatchEvent(\n      new CustomEvent(\"ndn:phone-camera-reconnect\", {\n        detail: { reason, ts: now },\n      }),\n    );\n  } else {\n    window.dispatchEvent(new Event(\"ndn:camera-reset\" as any));\n  }\n}\n","export const NDN_CAMERA_RECOVERY_EVENT = \"ndn:camera-recovery\" as const;\n\nexport type CameraRecoveryUiDetail = {\n  reason: string;\n  ts: number;\n};\n\nexport function dispatchCameraRecoveryUi(detail: CameraRecoveryUiDetail) {\n  window.dispatchEvent(new CustomEvent(NDN_CAMERA_RECOVERY_EVENT, { detail }));\n}\n","import { useEffect, useRef } from \"react\";\nimport { useUserSettings } from \"../store/userSettings\";\nimport { useCameraSession } from \"../store/cameraSession\";\nimport {\n  dispatchCameraRecovery,\n  type CameraRecoveryReason,\n} from \"../utils/cameraRecovery\";\nimport { dispatchCameraRecoveryUi } from \"../utils/cameraRecoveryEvents\";\n\n/**\n * GlobalCameraWatchdog\n *\n * Goal: make the camera experience resilient.\n *\n * What it does:\n * - Watches the active video element + media stream.\n * - Detects \"stalls\" (no currentTime progress) while camera is expected to be live.\n * - Triggers recovery actions with backoff:\n *    1) Dispatch `ndn:camera-reset` (local camera restart path)\n *    2) Dispatch `ndn:phone-camera-reconnect` (phone pairing restart)\n *\n * Notes:\n * - This is intentionally conservative: it only triggers when camera is enabled\n *   AND a stream is expected to be live.\n */\nexport default function GlobalCameraWatchdog() {\n  const cameraEnabled = useUserSettings((s) => !!s.cameraEnabled);\n  const preferredCameraLabel = useUserSettings((s) => s.preferredCameraLabel);\n  const shouldWatch = cameraEnabled;\n  const session = useCameraSession();\n\n  const lastVideoTimeRef = useRef<number>(-1);\n  const stallTicksRef = useRef<number>(0);\n  const lastRecoveryAtRef = useRef<number>(0);\n  const backoffStepRef = useRef<number>(0);\n  const recoveringRef = useRef<boolean>(false);\n  const lastReasonRef = useRef<CameraRecoveryReason | null>(null);\n\n  useEffect(() => {\n    if (!shouldWatch) return;\n\n    const jitter = (ms: number) => {\n      // +/- 15% jitter to avoid pathological sync loops.\n      const j = ms * 0.15;\n      const delta = (Math.random() * 2 - 1) * j;\n      return Math.max(500, Math.round(ms + delta));\n    };\n\n    const maybeRecover = (reason: CameraRecoveryReason) => {\n      const now = Date.now();\n      // Backoff ladder; step increases only when we actually attempt recovery.\n      const base = [2500, 5000, 10000, 18000, 30000][\n        Math.min(backoffStepRef.current, 4)\n      ];\n      const backoffMs = jitter(base);\n      if (now - lastRecoveryAtRef.current < backoffMs) return;\n      if (recoveringRef.current) return;\n\n      recoveringRef.current = true;\n      lastRecoveryAtRef.current = now;\n      lastReasonRef.current = reason;\n      backoffStepRef.current = Math.min(backoffStepRef.current + 1, 5);\n\n      try {\n        dispatchCameraRecovery(reason);\n        dispatchCameraRecoveryUi({ reason, ts: now });\n      } catch {\n        // ignore\n      }\n\n      // Release single-flight after a short window.\n      window.setTimeout(() => {\n        recoveringRef.current = false;\n      }, 1500);\n    };\n\n    const tick = () => {\n      try {\n        // Only watch when session says we're streaming OR we actually have a stream.\n        const stream = session.getMediaStream?.() || null;\n        const streaming = !!session.isStreaming || !!stream;\n        if (!streaming) {\n          stallTicksRef.current = 0;\n          lastVideoTimeRef.current = -1;\n          backoffStepRef.current = 0;\n          recoveringRef.current = false;\n          lastReasonRef.current = null;\n          return;\n        }\n\n        const video = session.getVideoElementRef?.() || null;\n        if (!video) {\n          // No element to sample; don't spam recovery.\n          stallTicksRef.current = 0;\n          lastVideoTimeRef.current = -1;\n          // Still potentially a recoverable state: stream exists but no element.\n          if (stream) maybeRecover(\"watchdog-detached\");\n          return;\n        }\n\n        // If the video element isn't attached, try attaching.\n        if (stream && !video.srcObject) {\n          try {\n            video.srcObject = stream;\n          } catch {}\n        }\n\n        // If track ended (permissions revoked, device unplugged, phone stream dropped), recover.\n        try {\n          const tracks = (stream?.getVideoTracks?.() ||\n            []) as MediaStreamTrack[];\n          if (\n            stream &&\n            tracks.length > 0 &&\n            tracks.every((t) => t.readyState === \"ended\" || (t as any).muted)\n          ) {\n            maybeRecover(\"watchdog-ended-track\");\n            return;\n          }\n        } catch {}\n\n        // If user/tab pauses playback, nudge play; if it remains paused while streaming, recover.\n        try {\n          if ((video as HTMLVideoElement).paused) {\n            (video as any).play?.().catch?.(() => {});\n            // If it stays paused for multiple ticks, treat as a failure.\n            stallTicksRef.current += 1;\n            if (stallTicksRef.current >= 6) {\n              maybeRecover(\"watchdog-paused\");\n              return;\n            }\n          }\n        } catch {}\n\n        const ct = Number((video as HTMLVideoElement).currentTime || 0);\n        if (!Number.isFinite(ct)) return;\n\n        if (lastVideoTimeRef.current === ct) {\n          stallTicksRef.current += 1; // 1/sec\n        } else {\n          stallTicksRef.current = 0;\n        }\n        lastVideoTimeRef.current = ct;\n\n        // Require a few consecutive seconds of no progress before attempting recovery.\n        if (stallTicksRef.current < 4) return;\n        maybeRecover(\"watchdog-stall\");\n      } catch {\n        // never throw from watchdog\n      }\n    };\n\n    const onVis = () => {\n      try {\n        if (document.visibilityState === \"visible\") {\n          // Returning to foreground often resolves a frozen renderer; give it a kick.\n          const v = session.getVideoElementRef?.() || null;\n          try {\n            (v as any)?.play?.().catch?.(() => {});\n          } catch {}\n          // If we were already in a bad state, attempt a recover.\n          if (!!session.isStreaming || !!session.getMediaStream?.()) {\n            maybeRecover(\"watchdog-visibility-resume\");\n          }\n        }\n      } catch {}\n    };\n\n    const id = window.setInterval(tick, 1000);\n    document.addEventListener(\"visibilitychange\", onVis);\n    return () => {\n      window.clearInterval(id);\n      document.removeEventListener(\"visibilitychange\", onVis);\n    };\n  }, [shouldWatch, preferredCameraLabel, session]);\n\n  return null;\n}\n","import { useEffect, useRef } from \"react\";\nimport { useToast } from \"../store/toast\";\nimport {\n  NDN_CAMERA_RECOVERY_EVENT,\n  type CameraRecoveryUiDetail,\n} from \"../utils/cameraRecoveryEvents\";\nimport { dispatchCameraRecovery } from \"../utils/cameraRecovery\";\n\nfunction prettyReason(r: string) {\n  if (r.includes(\"ended-track\")) return \"Camera stream ended. Recovering\";\n  if (r.includes(\"paused\")) return \"Camera paused. Recovering\";\n  if (r.includes(\"detached\")) return \"Camera preview detached. Reconnecting\";\n  if (r.includes(\"visibility\")) return \"Welcome back. Refreshing camera\";\n  return \"Camera froze. Recovering\";\n}\n\nexport default function GlobalCameraRecoveryToasts() {\n  const toast = useToast();\n  const lastShownAtRef = useRef<number>(0);\n\n  useEffect(() => {\n    const onRecover = (e: Event) => {\n      const ev = e as CustomEvent<CameraRecoveryUiDetail>;\n      const detail = ev.detail;\n      if (!detail?.ts) return;\n\n      // Avoid spamming toasts if watchdog retries.\n      const now = Date.now();\n      if (now - lastShownAtRef.current < 8000) return;\n      lastShownAtRef.current = now;\n\n      toast(prettyReason(detail.reason), {\n        type: \"info\",\n        actionLabel: \"Retry now\",\n        onAction: () => {\n          try {\n            dispatchCameraRecovery(\"user-click\");\n          } catch {}\n        },\n      } as any);\n    };\n\n    window.addEventListener(NDN_CAMERA_RECOVERY_EVENT as any, onRecover as any);\n    return () => {\n      window.removeEventListener(\n        NDN_CAMERA_RECOVERY_EVENT as any,\n        onRecover as any,\n      );\n    };\n  }, [toast]);\n\n  return null;\n}\n","import React, { useState, useEffect, useRef } from \"react\";\n\n/**\n * Small header pill that allows installing the PWA or linking to app store pages.\n * - Tries to prompt the PWA install if available\n * - Shows links to Play Store / App Store if configured via environment variables\n */\nexport default function InstallPicker() {\n  const [open, setOpen] = useState(false);\n  const playStore = (import.meta as any).env?.VITE_PLAY_STORE_URL || \"\";\n  const appStore = (import.meta as any).env?.VITE_APP_STORE_URL || \"\";\n  const containerRef = useRef<HTMLDivElement | null>(null);\n\n  useEffect(() => {\n    if (!open) return;\n    const handler = (e: KeyboardEvent) => {\n      if (e.key === \"Escape\") setOpen(false);\n    };\n    const handlePointer = (event: MouseEvent | TouchEvent) => {\n      const target = event.target as Node | null;\n      if (!target) return;\n      if (containerRef.current && containerRef.current.contains(target)) return;\n      setOpen(false);\n    };\n    document.addEventListener(\"mousedown\", handlePointer);\n    document.addEventListener(\"touchstart\", handlePointer);\n    window.addEventListener(\"keydown\", handler);\n    return () => {\n      document.removeEventListener(\"mousedown\", handlePointer);\n      document.removeEventListener(\"touchstart\", handlePointer);\n      window.removeEventListener(\"keydown\", handler);\n    };\n  }, [open]);\n\n  async function installPwa() {\n    try {\n      // Global promptInstallApp() is added to index.html and stores `beforeinstallprompt`\n      if ((window as any).promptInstallApp) {\n        const result = await (window as any).promptInstallApp();\n        if (result) {\n          // installed\n        }\n      } else if ((navigator as any)?.standalone || \"onappinstalled\" in window) {\n        // Already installed or installed via other prompt\n        alert(\n          \"App is already installed or your browser does not support programmatic install.\",\n        );\n      } else {\n        alert(\n          \"Install is not available for your browser. Try using the share menu (iOS) or the install prompt (Chrome/Edge on Android).\",\n        );\n      }\n    } catch (e) {\n      // ignore\n    }\n  }\n\n  return (\n    <div className=\"relative inline-block\" ref={containerRef}>\n      <button\n        className=\"px-2 py-1 rounded-full border border-white/10 bg-white/5 hover:bg-white/10 text-sm text-white flex items-center gap-2\"\n        onClick={() => setOpen((v) => !v)}\n        title=\"Install or download app\"\n      >\n        Install\n      </button>\n      {open && (\n        <div\n          role=\"dialog\"\n          aria-modal=\"true\"\n          className=\"absolute right-0 mt-2 z-40 w-80 max-w-[calc(100vw-2rem)] rounded-3xl border border-white/15 bg-slate-900/95 p-5 text-white shadow-2xl\"\n        >\n          <button\n            className=\"absolute right-3 top-3 flex h-7 w-7 items-center justify-center rounded-full bg-rose-500 text-sm font-bold text-white shadow hover:bg-rose-400\"\n            onClick={() => setOpen(false)}\n            aria-label=\"Close install picker\"\n          >\n            \n          </button>\n          <div className=\"pr-6\">\n            <div className=\"text-lg font-semibold\">Install or Download</div>\n            <p className=\"text-sm text-white/70\">\n              Install the Progressive Web App or jump to the native stores when\n              available.\n            </p>\n          </div>\n          <div className=\"mt-4 flex flex-col space-y-2\">\n            <button className=\"btn\" onClick={() => installPwa()}>\n              Install (PWA)\n            </button>\n            {playStore ? (\n              <a\n                className=\"btn\"\n                target=\"_blank\"\n                rel=\"noreferrer\"\n                href={playStore}\n              >\n                Android (Google Play)\n              </a>\n            ) : (\n              <div className=\"text-xs opacity-80\">\n                Android native build not provided\n              </div>\n            )}\n            {appStore ? (\n              <a\n                className=\"btn\"\n                target=\"_blank\"\n                rel=\"noreferrer\"\n                href={appStore}\n              >\n                iOS (App Store)\n              </a>\n            ) : (\n              <div className=\"text-xs opacity-80\">\n                iOS native build not provided\n              </div>\n            )}\n            <div className=\"text-xs opacity-70\">\n              iOS: Open Safari  Share  \"Add to Home Screen\" to pin this\n              dashboard like a native app.\n            </div>\n          </div>\n        </div>\n      )}\n    </div>\n  );\n}\n","import React, { useState, useEffect, useRef } from \"react\";\n\nexport default function AddToHomeButton() {\n  const [available, setAvailable] = useState(false);\n  const [showInstructions, setShowInstructions] = useState(false);\n  const containerRef = useRef<HTMLDivElement | null>(null);\n\n  useEffect(() => {\n    try {\n      (window as any).__NDN_DEFER_INSTALL_PROMPT__ = true;\n      const handler = (e: any) => {\n        e.preventDefault();\n        (window as any).deferredInstallPrompt = e;\n        setAvailable(true);\n      };\n      window.addEventListener(\"beforeinstallprompt\", handler as any);\n      // if there is an existing prompt saved by global handler in index.html\n      if ((window as any).deferredInstallPrompt) setAvailable(true);\n      return () => {\n        window.removeEventListener(\"beforeinstallprompt\", handler as any);\n        try {\n          (window as any).__NDN_DEFER_INSTALL_PROMPT__ = false;\n        } catch {}\n      };\n    } catch (e) {\n      // nothing\n    }\n  }, []);\n\n  async function handleClick() {\n    try {\n      if ((window as any).promptInstallApp) {\n        const ok = await (window as any).promptInstallApp();\n        if (!ok) setShowInstructions(true);\n      } else if ((window as any).deferredInstallPrompt) {\n        // fallback (should call promptInstallApp already, but just in case)\n        const p = (window as any).deferredInstallPrompt;\n        p.prompt();\n        const choice = await p.userChoice;\n        if (choice && choice.outcome === \"accepted\") {\n          setAvailable(false);\n        } else setShowInstructions(true);\n      } else {\n        setShowInstructions(true);\n      }\n    } catch (e) {\n      setShowInstructions(true);\n    }\n  }\n\n  useEffect(() => {\n    if (!showInstructions) return;\n    const handleKey = (e: KeyboardEvent) => {\n      if (e.key === \"Escape\") setShowInstructions(false);\n    };\n    const handlePointer = (event: MouseEvent | TouchEvent) => {\n      const target = event.target as Node | null;\n      if (!target) return;\n      if (containerRef.current && containerRef.current.contains(target)) return;\n      setShowInstructions(false);\n    };\n    document.addEventListener(\"mousedown\", handlePointer);\n    document.addEventListener(\"touchstart\", handlePointer);\n    window.addEventListener(\"keydown\", handleKey);\n    return () => {\n      document.removeEventListener(\"mousedown\", handlePointer);\n      document.removeEventListener(\"touchstart\", handlePointer);\n      window.removeEventListener(\"keydown\", handleKey);\n    };\n  }, [showInstructions]);\n\n  return (\n    <div className=\"relative inline-block\" ref={containerRef}>\n      <button\n        onClick={handleClick}\n        className=\"px-2 py-1 rounded-full border border-white/10 bg-white/5 hover:bg-white/10 text-sm\"\n        title=\"Add to Home Screen\"\n        data-available={available ? \"true\" : \"false\"}\n      >\n        Add to Home Screen\n      </button>\n      {showInstructions && (\n        <div className=\"absolute right-0 mt-2 z-40 w-80 max-w-[calc(100vw-2rem)] rounded-3xl border border-white/15 bg-slate-900/95 p-5 text-white shadow-2xl\">\n          <button\n            className=\"absolute right-3 top-3 flex h-7 w-7 items-center justify-center rounded-full bg-rose-500 text-sm font-bold text-white shadow hover:bg-rose-400\"\n            onClick={() => setShowInstructions(false)}\n            aria-label=\"Close add-to-home instructions\"\n          >\n            \n          </button>\n          <h3 className=\"text-lg font-semibold pr-6\">\n            Add Nine Dart Nation to Home\n          </h3>\n          <p className=\"mt-3 text-sm text-white/80 pr-4\">\n            {isIos()\n              ? 'Open Safari, tap the share icon, then choose \"Add to Home Screen\".'\n              : 'Open your browser menu ( or ) and choose \"Install app\" or \"Add to Home Screen\".'}\n          </p>\n          <p className=\"mt-2 text-xs text-white/60 pr-4\">\n            Installing the PWA keeps alerts, matches, and calibration controls a\n            tap away.\n          </p>\n          <div className=\"mt-4 flex flex-wrap justify-end gap-2\">\n            <button\n              className=\"btn btn--ghost px-3 py-1 text-sm\"\n              onClick={() => setShowInstructions(false)}\n            >\n              Close\n            </button>\n            <button\n              className=\"btn px-3 py-1 text-sm\"\n              onClick={() => setShowInstructions(false)}\n            >\n              Got it\n            </button>\n          </div>\n        </div>\n      )}\n    </div>\n  );\n}\n\nfunction isIos() {\n  try {\n    return /iphone|ipad|ipod/i.test(navigator.userAgent);\n  } catch (e) {\n    return false;\n  }\n}\n","import React, {\n  useEffect,\n  useRef,\n  useState,\n  type ReactNode,\n  type CSSProperties,\n} from \"react\";\nimport FocusLock from \"react-focus-lock\";\n\ntype Props = {\n  storageKey: string;\n  children: ReactNode;\n  className?: string;\n  frameClassName?: string;\n  frameFullScreenClassName?: string;\n  defaultWidth?: number;\n  defaultHeight?: number;\n  minWidth?: number;\n  minHeight?: number;\n  maxWidth?: number;\n  maxHeight?: number;\n  fullScreen?: boolean;\n  initialFitHeight?: boolean;\n  onClose?: () => void;\n};\n\ntype Size = { width?: number; height?: number };\n\nexport default function ResizableModal({\n  storageKey,\n  children,\n  className,\n  frameClassName,\n  frameFullScreenClassName,\n  defaultWidth = 520,\n  defaultHeight,\n  minWidth = 360,\n  minHeight = 200,\n  maxWidth = 1100,\n  maxHeight = 900,\n  fullScreen = false,\n  initialFitHeight = false,\n  onClose,\n}: Props) {\n  const [size, setSize] = useState<Size>(() => {\n    if (!fullScreen) {\n      try {\n        const raw = localStorage.getItem(storageKey);\n        if (raw) return JSON.parse(raw);\n      } catch {}\n      return { width: defaultWidth, height: defaultHeight };\n    }\n    return {};\n  });\n  const startRef = useRef<{\n    x: number;\n    y: number;\n    w: number;\n    h: number;\n    dir: string;\n  } | null>(null);\n\n  useEffect(() => {\n    if (fullScreen) return;\n    function onReset() {\n      try {\n        localStorage.removeItem(storageKey);\n      } catch {}\n      // If initialFitHeight is enabled, prefer fitting to parent height on reset\n      if (initialFitHeight && containerRef.current?.parentElement) {\n        const parent = containerRef.current.parentElement as HTMLElement;\n        const cs = window.getComputedStyle(parent);\n        const padTop = parseFloat(cs.paddingTop || \"0\") || 0;\n        const padBottom = parseFloat(cs.paddingBottom || \"0\") || 0;\n        const inner = Math.max(0, parent.clientHeight - padTop - padBottom);\n        const target = Math.max(\n          minHeight,\n          Math.min(maxHeight, Math.round(inner)),\n        );\n        setSize({ width: defaultWidth, height: target });\n        return;\n      }\n      setSize({ width: defaultWidth, height: defaultHeight });\n    }\n    window.addEventListener(\"ndn:layout-reset\" as any, onReset);\n    return () => window.removeEventListener(\"ndn:layout-reset\" as any, onReset);\n  }, [storageKey, defaultWidth, defaultHeight, fullScreen]);\n\n  useEffect(() => {\n    if (fullScreen) return;\n    try {\n      localStorage.setItem(storageKey, JSON.stringify(size));\n    } catch {}\n  }, [size, storageKey, fullScreen]);\n\n  // Optionally fit initial height to the available parent container when no saved size exists\n  useEffect(() => {\n    if (fullScreen || !initialFitHeight) return;\n    const parent = containerRef.current?.parentElement as HTMLElement | null;\n    if (!parent) return;\n    const cs = window.getComputedStyle(parent);\n    const padTop = parseFloat(cs.paddingTop || \"0\") || 0;\n    const padBottom = parseFloat(cs.paddingBottom || \"0\") || 0;\n    const inner = Math.max(0, parent.clientHeight - padTop - padBottom);\n    const target = Math.max(minHeight, Math.min(maxHeight, Math.round(inner)));\n    try {\n      const saved = localStorage.getItem(storageKey);\n      if (saved) {\n        const savedSize = JSON.parse(saved) as Size;\n        const h = savedSize?.height || 0;\n        // If saved height is smaller than available, bump it to fill the frame bottom\n        if (!h || h < target) {\n          setSize((s) => ({ ...s, height: target }));\n        }\n        return;\n      }\n    } catch {}\n    setSize((s) => ({ ...s, height: target }));\n  }, [initialFitHeight, fullScreen, storageKey, minHeight, maxHeight]);\n\n  function clamp(n: number, min: number, max: number) {\n    return Math.max(min, Math.min(max, n));\n  }\n\n  function beginResize(e: React.MouseEvent, dir: string) {\n    e.preventDefault();\n    const el = containerRef.current;\n    if (!el) return;\n    const rect = el.getBoundingClientRect();\n    startRef.current = {\n      x: e.clientX,\n      y: e.clientY,\n      w: rect.width,\n      h: rect.height,\n      dir,\n    };\n    window.addEventListener(\"mousemove\", onMove);\n    window.addEventListener(\"mouseup\", endResize);\n  }\n\n  function handleKeyResize(e: React.KeyboardEvent, dir: string) {\n    const step = 20;\n    const k = e.key;\n    if (\n      ![\n        \"ArrowLeft\",\n        \"ArrowRight\",\n        \"ArrowUp\",\n        \"ArrowDown\",\n        \"Enter\",\n        \" \",\n      ].includes(k)\n    )\n      return;\n    e.preventDefault();\n    const delta = k === \"ArrowLeft\" || k === \"ArrowUp\" ? -step : step;\n    setSize((s) => {\n      const curW = s.width || defaultWidth;\n      const curH = s.height || defaultHeight || minHeight;\n      let w = curW;\n      let h = curH;\n      if (dir.includes(\"e\")) w = clamp(curW + delta, minWidth, maxWidth);\n      if (dir.includes(\"w\")) w = clamp(curW - delta, minWidth, maxWidth);\n      if (dir.includes(\"s\")) h = clamp(curH + delta, minHeight, maxHeight);\n      if (dir.includes(\"n\")) h = clamp(curH - delta, minHeight, maxHeight);\n      return { width: Math.round(w), height: Math.round(h) };\n    });\n  }\n\n  function onMove(e: MouseEvent) {\n    const s = startRef.current;\n    if (!s) return;\n    const dx = e.clientX - s.x;\n    const dy = e.clientY - s.y;\n    const dir = s.dir;\n    let w = s.w;\n    let h = s.h;\n    // Respect parent's inner height so the modal bottom can align with the frame bottom\n    let parentInner = Infinity;\n    const parent = containerRef.current?.parentElement as HTMLElement | null;\n    if (parent) {\n      const cs = window.getComputedStyle(parent);\n      const padTop = parseFloat(cs.paddingTop || \"0\") || 0;\n      const padBottom = parseFloat(cs.paddingBottom || \"0\") || 0;\n      parentInner = Math.max(0, parent.clientHeight - padTop - padBottom);\n    }\n    const effMaxH = Math.min(\n      maxHeight,\n      isFinite(parentInner) ? parentInner : maxHeight,\n    );\n    // We only adjust width/height; the modal stays centered via parent flex\n    if (dir.includes(\"e\")) w = clamp(s.w + dx, minWidth, maxWidth);\n    if (dir.includes(\"s\")) h = clamp(s.h + dy, minHeight, effMaxH);\n    if (dir.includes(\"w\")) w = clamp(s.w - dx, minWidth, maxWidth);\n    if (dir.includes(\"n\")) h = clamp(s.h - dy, minHeight, effMaxH);\n    setSize({ width: Math.round(w), height: Math.round(h) });\n  }\n\n  function endResize() {\n    window.removeEventListener(\"mousemove\", onMove);\n    window.removeEventListener(\"mouseup\", endResize);\n    startRef.current = null;\n  }\n\n  const containerRef = useRef<HTMLDivElement | null>(null);\n  useEffect(() => {\n    if (!onClose) return;\n    function handleKey(e: KeyboardEvent) {\n      if (e.key === \"Escape\") {\n        e.stopPropagation();\n        onClose?.();\n      }\n    }\n    window.addEventListener(\"keydown\", handleKey, true);\n    return () => window.removeEventListener(\"keydown\", handleKey, true);\n  }, [onClose]);\n  const style: CSSProperties = fullScreen\n    ? { width: \"100%\", height: \"100%\", maxWidth: \"100%\", maxHeight: \"100%\" }\n    : {\n        width: size.width ? `${size.width}px` : undefined,\n        height: size.height ? `${size.height}px` : undefined,\n        maxWidth: `${maxWidth}px`,\n        // Allow filling up to the parent's inner height\n        maxHeight: \"100%\",\n      };\n\n  const baseClass = fullScreen\n    ? frameFullScreenClassName ?? \"card relative ndn-modal-full\"\n    : frameClassName ?? \"card relative\";\n  return (\n    <div\n      ref={containerRef}\n      className={`${baseClass} ${className || \"\"}`}\n      style={style}\n    >\n      <FocusLock returnFocus className=\"flex-1 flex flex-col min-h-0 w-full\">\n        {/* Content */}\n        {children}\n      </FocusLock>\n      {/* Corner handles */}\n      {!fullScreen && (\n        <div\n          className=\"resizer resizer-nw\"\n          onMouseDown={(e) => beginResize(e, \"nw\")}\n          role=\"button\"\n          tabIndex={0}\n          aria-label=\"Resize north-west\"\n          onKeyDown={(e) => handleKeyResize(e, \"nw\")}\n        />\n      )}\n      {!fullScreen && (\n        <div\n          className=\"resizer resizer-ne\"\n          onMouseDown={(e) => beginResize(e, \"ne\")}\n          role=\"button\"\n          tabIndex={0}\n          aria-label=\"Resize north-east\"\n          onKeyDown={(e) => handleKeyResize(e, \"ne\")}\n        />\n      )}\n      {!fullScreen && (\n        <div\n          className=\"resizer resizer-sw\"\n          onMouseDown={(e) => beginResize(e, \"sw\")}\n          role=\"button\"\n          tabIndex={0}\n          aria-label=\"Resize south-west\"\n          onKeyDown={(e) => handleKeyResize(e, \"sw\")}\n        />\n      )}\n      {!fullScreen && (\n        <div\n          className=\"resizer resizer-se\"\n          onMouseDown={(e) => beginResize(e, \"se\")}\n          role=\"button\"\n          tabIndex={0}\n          aria-label=\"Resize south-east\"\n          onKeyDown={(e) => handleKeyResize(e, \"se\")}\n        />\n      )}\n      {/* Bottom edge handle for easy vertical stretching */}\n      {!fullScreen && (\n        <div\n          className=\"resizer-edge resizer-s\"\n          onMouseDown={(e) => beginResize(e, \"s\")}\n          role=\"button\"\n          tabIndex={0}\n          aria-label=\"Resize south\"\n          onKeyDown={(e) => handleKeyResize(e, \"s\")}\n        />\n      )}\n    </div>\n  );\n}\n","import React, { useEffect, useState } from \"react\";\n\nexport default function InstallAppButton() {\n  const [deferredPrompt, setDeferredPrompt] = useState<any | null>(null);\n\n  useEffect(() => {\n    try {\n      const handler = (e: any) => {\n        e.preventDefault();\n        setDeferredPrompt(e);\n      };\n      window.addEventListener(\"beforeinstallprompt\", handler as EventListener);\n      return () =>\n        window.removeEventListener(\n          \"beforeinstallprompt\",\n          handler as EventListener,\n        );\n    } catch (e) {\n      // ignore when running in SSR or test environment\n    }\n  }, []);\n\n  async function handleInstall() {\n    if (!deferredPrompt) {\n      // No PWA install available; instruct user to use native Add to Home Screen\n      alert(\n        'Open this site in your browser and use \"Add to Home Screen\" from the share menu (iOS) or use the browser install prompt (Android/Chrome).',\n      );\n      return;\n    }\n    try {\n      deferredPrompt.prompt();\n      const choice = await deferredPrompt.userChoice;\n      if (choice && choice.outcome === \"accepted\") {\n        setDeferredPrompt(null);\n      }\n    } catch (e) {\n      console.warn(\"install failed\", e);\n    }\n  }\n\n  // Hide the button when not available\n  if (!deferredPrompt) return null;\n  return (\n    <button\n      className=\"rounded bg-violet-600 text-white px-2 py-1\"\n      onClick={() => handleInstall()}\n    >\n      Install App\n    </button>\n  );\n}\n","import React, { useState } from \"react\";\nimport ResizableModal from \"./ui/ResizableModal\";\nimport InstallAppButton from \"./InstallAppButton\";\n\nexport default function Footer() {\n  const [show, setShow] = useState(false);\n  const year = new Date().getFullYear();\n  return (\n    <>\n      <div className=\"w-full text-center text-xs text-gray-500 py-2 select-none\">\n         {year} Nine Dart Nation {\" \"}\n        <button className=\"underline\" onClick={() => setShow(true)}>\n          Legal Notice\n        </button>\n        {/* Small install CTA shown only when browser supplies the 'beforeinstallprompt' event */}\n        <span className=\"ml-3 inline-block align-middle\">\n          <InstallAppButton />\n        </span>\n      </div>\n      {show ? (\n        <ResizableModal\n          storageKey=\"ndn:modal:legal\"\n          className=\"w-[640px]\"\n          defaultWidth={640}\n          defaultHeight={420}\n          minWidth={420}\n          minHeight={220}\n          initialFitHeight\n        >\n          <div className=\"p-4 space-y-3\">\n            <div className=\"text-lg font-semibold\">\n              Privacy & Copyright Notice\n            </div>\n            <div className=\"text-sm\"> IMPORTANT LEGAL NOTICE</div>\n            <div className=\"text-sm\">\n              Copyright Protection: All code, assets, and intellectual property\n              in Nine Dart Nation are protected by copyright law. Unauthorized\n              copying, modification, or distribution of this software is\n              strictly prohibited.\n            </div>\n            <div className=\"text-sm\">\n              Legal Consequences: Any attempt to edit, reverse-engineer, or\n              redistribute this code will result in immediate legal action,\n              including but not limited to copyright infringement lawsuits and\n              potential criminal charges.\n            </div>\n            <div className=\"text-sm\">\n              Privacy: Your personal data and gameplay information are\n              protected. Any unauthorized access or data collection violates\n              privacy laws and will be prosecuted to the full extent of the law.\n            </div>\n            <div className=\"flex items-center gap-2 mt-3\">\n              <button className=\"btn\" onClick={() => setShow(false)}>\n                Close\n              </button>\n            </div>\n          </div>\n        </ResizableModal>\n      ) : null}\n    </>\n  );\n}\n","import { create } from \"zustand\";\n\ntype MatchControlState = {\n  paused: boolean;\n  pauseEndsAt: number | null;\n  pauseStartedAt?: number | null;\n  setPaused: (v: boolean, endsAt?: number | null) => void;\n};\n\nexport const useMatchControl = create<MatchControlState>((set) => ({\n  paused: false,\n  pauseEndsAt: null,\n  pauseStartedAt: null,\n  setPaused: (v, endsAt = null) =>\n    set({\n      paused: v,\n      pauseEndsAt: endsAt ?? null,\n      pauseStartedAt: v ? Date.now() : null,\n    }),\n}));\n","import { useEffect } from \"react\";\nimport { useMatchControl } from \"../store/matchControl\";\n\n// Watches pauseEndsAt and automatically clears pause when time elapses.\nexport default function AutoPauseManager() {\n  const paused = useMatchControl((s) => s.paused);\n  const pauseEndsAt = useMatchControl((s) => s.pauseEndsAt);\n  const setPaused = useMatchControl((s) => s.setPaused);\n\n  useEffect(() => {\n    if (!paused || !pauseEndsAt) return;\n    const now = Date.now();\n    if (pauseEndsAt <= now) {\n      setPaused(false, null);\n      return;\n    }\n    const ms = pauseEndsAt - now;\n    const t = setTimeout(() => setPaused(false, null), ms);\n    return () => clearTimeout(t);\n  }, [paused, pauseEndsAt, setPaused]);\n\n  return null;\n}\n","type EnsureVideoPlaysResult = {\n  attached: boolean;\n  played: boolean;\n  reason?: string;\n};\n\nfunction sleep(ms: number) {\n  return new Promise((r) => setTimeout(r, ms));\n}\n\nasync function waitForMetadata(video: HTMLVideoElement, timeoutMs: number) {\n  const start = Date.now();\n\n  // If metadata is already present (or we already have dimensions), bail fast.\n  if (video.readyState >= 1 || (video.videoWidth ?? 0) > 0) return;\n\n  await new Promise<void>((resolve) => {\n    let done = false;\n    const finish = () => {\n      if (done) return;\n      done = true;\n      cleanup();\n      resolve();\n    };\n\n    const onLoaded = () => finish();\n    const onCanPlay = () => finish();\n\n    const timer = window.setInterval(() => {\n      if (Date.now() - start > timeoutMs) finish();\n      if (video.readyState >= 1) finish();\n      if ((video.videoWidth ?? 0) > 0) finish();\n    }, 50);\n\n    const cleanup = () => {\n      try {\n        video.removeEventListener(\"loadedmetadata\", onLoaded);\n        video.removeEventListener(\"canplay\", onCanPlay);\n        window.clearInterval(timer);\n      } catch {}\n    };\n\n    try {\n      video.addEventListener(\"loadedmetadata\", onLoaded);\n      video.addEventListener(\"canplay\", onCanPlay);\n    } catch {\n      // If events are unavailable (tests), rely on polling + timeout.\n    }\n  });\n}\n\n/**\n * Attaches `stream` to `video` (if needed) and aggressively nudges `play()` with\n * small retries. Designed for preview tiles where timing/autoplay quirks happen.\n */\nexport async function ensureVideoPlays(opts: {\n  video: HTMLVideoElement | null;\n  stream: MediaStream | null;\n  attach?: boolean;\n  /** Default true - preview should be muted to satisfy autoplay policies. */\n  muted?: boolean;\n  /** Default true, important on iOS. */\n  playsInline?: boolean;\n  /** Default 4 attempts. */\n  maxAttempts?: number;\n  /** Default 1200ms. */\n  metadataTimeoutMs?: number;\n  onPlayError?: (err: unknown) => void;\n}): Promise<EnsureVideoPlaysResult> {\n  const {\n    video,\n    stream,\n    attach = true,\n    muted = true,\n    playsInline = true,\n    maxAttempts = 4,\n    metadataTimeoutMs = 1200,\n    onPlayError,\n  } = opts;\n\n  if (!video) return { attached: false, played: false, reason: \"no video\" };\n\n  const liveVideoTracks = (stream?.getVideoTracks?.() || []).filter(\n    (t) => t.readyState === \"live\",\n  );\n  if (!stream || liveVideoTracks.length === 0) {\n    return {\n      attached: false,\n      played: false,\n      reason: \"no live stream\",\n    };\n  }\n\n  try {\n    if (muted) video.muted = true;\n    if (playsInline) (video as any).playsInline = true;\n  } catch {}\n\n  let attached = false;\n  if (attach) {\n    try {\n      if (video.srcObject !== stream) {\n        video.srcObject = stream;\n      }\n      attached = true;\n    } catch (e) {\n      return { attached: false, played: false, reason: \"attach failed\" };\n    }\n  }\n  // Serialize concurrent play attempts for the same <video> element to avoid\n  // AbortError races where a new load/play replaces a pending one.\n  // Use a WeakMap so entries don't leak when elements are removed.\n  const playAttemptMap: WeakMap<\n    HTMLVideoElement,\n    Promise<EnsureVideoPlaysResult>\n  > = (ensureVideoPlays as any)._playAttemptMap || new WeakMap();\n  (ensureVideoPlays as any)._playAttemptMap = playAttemptMap;\n\n  // If another caller is already trying to play this video, wait for it to\n  // complete first so we don't overlap load/play operations.\n  const existing = playAttemptMap.get(video);\n  if (existing) {\n    try {\n      const r = await existing;\n      return r;\n    } catch {\n      // fallthrough and attempt ourselves\n    }\n  }\n\n  const attemptPromise = (async (): Promise<EnsureVideoPlaysResult> => {\n    for (let i = 0; i < maxAttempts; i++) {\n      try {\n        await waitForMetadata(video, metadataTimeoutMs);\n      } catch {}\n\n      try {\n        // Some browsers require a fresh play nudge even if already playing.\n        const p = video.play();\n        if (p && typeof (p as any).then === \"function\") await p;\n\n        // If we have frames coming through, we are good.\n        if ((video.videoWidth ?? 0) > 0 && (video.videoHeight ?? 0) > 0) {\n          return { attached, played: true };\n        }\n\n        // Even if dimensions aren't populated yet, if not paused we likely succeeded.\n        if (video.paused === false) {\n          return { attached, played: true };\n        }\n      } catch (err: any) {\n        // Treat AbortError specially: commonly caused by concurrent load/play\n        // events. Wait a short backoff and retry. Still report the error to\n        // the provided hook for diagnostics.\n        try {\n          onPlayError?.(err);\n        } catch {}\n        if (err && err.name === \"AbortError\") {\n          // small backoff before retrying\n          await sleep(120 + i * 150);\n          continue;\n        }\n      }\n\n      await sleep(120 + i * 150);\n    }\n\n    return { attached, played: false, reason: \"play retries exhausted\" };\n  })();\n\n  // store and await\n  playAttemptMap.set(video, attemptPromise);\n  try {\n    const res = await attemptPromise;\n    return res;\n  } finally {\n    // cleanup\n    try {\n      playAttemptMap.delete(video);\n    } catch {}\n  }\n}\n","import type { Homography, Point } from \"./vision\";\nimport {\n  imageToBoard,\n  scoreAtBoardPoint,\n  scoreAtBoardPointTheta,\n} from \"./vision\";\n\n// Optional theta (radians) applies orientation compensation so sector mapping matches TV order.\nexport function scoreFromImagePoint(\n  H_boardToImage: Homography,\n  pImg: Point,\n  theta?: number,\n  sectorOffset?: number,\n  rotationOffsetRad?: number,\n) {\n  const pBoard = imageToBoard(H_boardToImage, pImg);\n  if (!pBoard) {\n    // If homography inversion failed, return a MISS\n    return { base: 0, ring: \"MISS\" as const, sector: null, mult: 0 as const };\n  }\n  if (typeof theta === \"number\") {\n    return scoreAtBoardPointTheta(\n      pBoard,\n      theta,\n      sectorOffset ?? 0,\n      rotationOffsetRad ?? 0,\n    );\n  }\n  return scoreAtBoardPoint(pBoard);\n}\n","// Generic autoscore provider helpers: parse vendor-agnostic payloads and subscribe via WebSocket\n\nexport type Ring =\n  | \"MISS\"\n  | \"SINGLE\"\n  | \"DOUBLE\"\n  | \"TRIPLE\"\n  | \"BULL\"\n  | \"INNER_BULL\";\nexport type ParsedDart = {\n  value: number;\n  ring: Ring;\n  sector?: number | null;\n  mult?: 0 | 1 | 2 | 3;\n  // Optional provider confidence. Prefer 0..1 when available.\n  // If a provider sends 0..100, we normalize it to 0..1.\n  confidence?: number;\n};\n\n// Try to parse a variety of vendor payload shapes\nexport function parseExternalDart(data: any): ParsedDart | null {\n  try {\n    if (!data || typeof data !== \"object\") return null;\n    const rawConf = (data as any).confidence;\n    const conf =\n      typeof rawConf === \"number\" && Number.isFinite(rawConf)\n        ? rawConf > 1\n          ? Math.max(0, Math.min(1, rawConf / 100))\n          : Math.max(0, Math.min(1, rawConf))\n        : undefined;\n    // 1) { type:'dart', value: <0-60>, ring: 'SINGLE'|'DOUBLE'|... }\n    if (\n      (data.type === \"dart\" || data.kind === \"dart\" || data.event === \"dart\") &&\n      typeof data.value === \"number\"\n    ) {\n      const ring = normalizeRing(data.ring);\n      const base = finalizeFromValue(data.value, ring);\n      return base ? { ...base, confidence: conf } : null;\n    }\n    // 2) { value, ring }\n    if (typeof data.value === \"number\" && data.ring) {\n      const ring = normalizeRing(data.ring);\n      const base = finalizeFromValue(data.value, ring);\n      return base ? { ...base, confidence: conf } : null;\n    }\n    // 3) { score: 'T20'|'D16'|'S5'|'25'|'50' }\n    if (typeof data.score === \"string\") {\n      const s = data.score.trim().toUpperCase();\n      if (s === \"50\" || s === \"DBULL\" || s === \"INNER_BULL\")\n        return {\n          value: 50,\n          ring: \"INNER_BULL\",\n          sector: null,\n          mult: 0,\n          confidence: conf,\n        };\n      if (s === \"25\" || s === \"BULL\" || s === \"OBULL\")\n        return {\n          value: 25,\n          ring: \"BULL\",\n          sector: null,\n          mult: 0,\n          confidence: conf,\n        };\n      const m = s.match(/^(S|D|T)(\\d{1,2})$/);\n      if (m) {\n        const mult = m[1] === \"S\" ? 1 : m[1] === \"D\" ? 2 : 3;\n        const sec = parseInt(m[2], 10);\n        if (sec >= 1 && sec <= 20)\n          return {\n            value: sec * mult,\n            ring: mult === 1 ? \"SINGLE\" : mult === 2 ? \"DOUBLE\" : \"TRIPLE\",\n            sector: sec,\n            mult: mult as 1 | 2 | 3,\n            confidence: conf,\n          };\n      }\n    }\n    // 4) { sector: 1..20, mult: 1|2|3 }\n    if (typeof data.sector === \"number\" && typeof data.mult === \"number\") {\n      const sec = Math.max(1, Math.min(20, Math.floor(data.sector)));\n      const mul = data.mult === 1 ? 1 : data.mult === 2 ? 2 : 3;\n      return {\n        value: sec * mul,\n        ring: mul === 1 ? \"SINGLE\" : mul === 2 ? \"DOUBLE\" : \"TRIPLE\",\n        sector: sec,\n        mult: mul as 1 | 2 | 3,\n        confidence: conf,\n      };\n    }\n    // 5) { bull: 'outer'|'inner'|true }\n    if (data.bull) {\n      const inner =\n        String(data.bull).toLowerCase() === \"inner\" || data.bull === true;\n      return {\n        value: inner ? 50 : 25,\n        ring: inner ? \"INNER_BULL\" : \"BULL\",\n        sector: null,\n        mult: 0,\n        confidence: conf,\n      };\n    }\n  } catch {}\n  return null;\n}\n\nfunction normalizeRing(r: any): Ring {\n  const s = String(r || \"\").toUpperCase();\n  if (s.startsWith(\"TR\")) return \"TRIPLE\";\n  if (s.startsWith(\"DO\")) return \"DOUBLE\";\n  if (s.startsWith(\"SI\")) return \"SINGLE\";\n  if (s === \"INNER_BULL\" || s === \"DBULL\" || s === \"50\" || s === \"IBULL\")\n    return \"INNER_BULL\";\n  if (s === \"BULL\" || s === \"25\" || s === \"OBULL\" || s === \"OUTER_BULL\")\n    return \"BULL\";\n  if (s === \"MISS\" || s === \"0\") return \"MISS\";\n  return \"SINGLE\";\n}\n\nfunction finalizeFromValue(value: number, ring: Ring): ParsedDart | null {\n  const v = Math.max(0, Math.min(60, Math.round(Number(value) || 0)));\n  if (ring === \"INNER_BULL\") return { value: 50, ring };\n  if (ring === \"BULL\") return { value: 25, ring };\n  // Best-effort: preserve base if consistent with ring\n  return { value: v, ring };\n}\n\nexport type ExternalSub = { close: () => void };\n\nexport function subscribeExternalWS(\n  url: string,\n  onDart: (d: ParsedDart) => void,\n): ExternalSub {\n  let socket: WebSocket | null = null;\n  let alive = true;\n  // Lightweight duplicate suppression: ignore exact repeat within a short window\n  let lastSig: string | null = null;\n  let lastSigAt = 0;\n  const DEDUP_WINDOW_MS = 400;\n  // Optional ID-based dedup if provider sends unique ids\n  const seenIds: string[] = [];\n  const seenSet = new Set<string>();\n\n  function considerForward(payload: any, parsed: ParsedDart) {\n    // If payload has a stable id, drop if seen\n    const pid =\n      typeof payload?.id === \"string\" || typeof payload?.id === \"number\"\n        ? String(payload.id)\n        : null;\n    if (pid) {\n      if (seenSet.has(pid)) return;\n      seenSet.add(pid);\n      seenIds.push(pid);\n      if (seenIds.length > 200) {\n        const old = seenIds.shift();\n        if (old) seenSet.delete(old);\n      }\n    }\n    // Time-based dedup by signature (safe; darts cannot occur within <400ms)\n    const sig = `${parsed.value}|${parsed.ring}|${parsed.sector ?? \"\"}|${parsed.mult ?? \"\"}`;\n    const now = Date.now();\n    if (sig === lastSig && now - lastSigAt < DEDUP_WINDOW_MS) return;\n    lastSig = sig;\n    lastSigAt = now;\n    onDart(parsed);\n  }\n\n  function connect() {\n    if (!alive) return;\n    try {\n      socket = new WebSocket(url);\n      socket.onmessage = (ev) => {\n        try {\n          const payload = JSON.parse(ev.data);\n          const parsed = parseExternalDart(payload);\n          if (parsed) considerForward(payload, parsed);\n        } catch {}\n      };\n      socket.onclose = () => {\n        socket = null;\n        setTimeout(connect, 1500);\n      };\n      socket.onerror = () => {\n        /* ignore; will reconnect on close */\n      };\n    } catch {\n      setTimeout(connect, 2000);\n    }\n  }\n  connect();\n  return {\n    close: () => {\n      alive = false;\n      try {\n        socket?.close();\n      } catch {}\n    },\n  };\n}\n","import React, {\n  useEffect,\n  useRef,\n  useState,\n  type ReactNode,\n  type CSSProperties,\n} from \"react\";\n\ntype Props = {\n  storageKey: string;\n  children: ReactNode;\n  className?: string;\n  defaultWidth?: number;\n  defaultHeight?: number;\n  minWidth?: number;\n  minHeight?: number;\n  maxWidth?: number;\n  maxHeight?: number;\n  autoFill?: boolean;\n};\n\ntype Size = { width?: number; height?: number };\n\nexport default function ResizablePanel({\n  storageKey,\n  children,\n  className,\n  defaultWidth = 640,\n  defaultHeight = 360,\n  minWidth = 320,\n  minHeight = 200,\n  maxWidth = 1600,\n  maxHeight = 1200,\n  autoFill = false,\n}: Props) {\n  const [size, setSize] = useState<Size>(() => {\n    try {\n      const raw = localStorage.getItem(storageKey);\n      if (raw) return JSON.parse(raw);\n    } catch {}\n    // If autoFill is requested, don't persist a fixed height  let CSS stretch the panel\n    return autoFill\n      ? { width: defaultWidth }\n      : { width: defaultWidth, height: defaultHeight };\n  });\n  const startRef = useRef<{\n    x: number;\n    y: number;\n    w: number;\n    h: number;\n    dir: string;\n  } | null>(null);\n  const containerRef = useRef<HTMLDivElement | null>(null);\n\n  useEffect(() => {\n    function onReset() {\n      try {\n        localStorage.removeItem(storageKey);\n      } catch {}\n      setSize({ width: defaultWidth, height: defaultHeight });\n    }\n    window.addEventListener(\"ndn:layout-reset\" as any, onReset);\n    window.addEventListener(\"ndn:camera-reset\" as any, onReset);\n    return () => {\n      window.removeEventListener(\"ndn:layout-reset\" as any, onReset);\n      window.removeEventListener(\"ndn:camera-reset\" as any, onReset);\n    };\n  }, [storageKey, defaultWidth, defaultHeight]);\n\n  useEffect(() => {\n    try {\n      localStorage.setItem(storageKey, JSON.stringify(size));\n    } catch {}\n  }, [size, storageKey]);\n\n  function clamp(n: number, min: number, max: number) {\n    return Math.max(min, Math.min(max, n));\n  }\n  function beginResize(e: React.MouseEvent, dir: string) {\n    e.preventDefault();\n    const el = containerRef.current;\n    if (!el) return;\n    const rect = el.getBoundingClientRect();\n    startRef.current = {\n      x: e.clientX,\n      y: e.clientY,\n      w: rect.width,\n      h: rect.height,\n      dir,\n    };\n    window.addEventListener(\"mousemove\", onMove);\n    window.addEventListener(\"mouseup\", endResize);\n  }\n  function onMove(e: globalThis.MouseEvent) {\n    const s = startRef.current;\n    if (!s) return;\n    const dx = e.clientX - s.x;\n    const dy = e.clientY - s.y;\n    let w = s.w;\n    let h = s.h;\n    if (s.dir.includes(\"e\")) w = clamp(s.w + dx, minWidth, maxWidth);\n    // If autoFill is enabled, ignore vertical resizing (panel should fill parent)\n    if (!autoFill && s.dir.includes(\"s\"))\n      h = clamp(s.h + dy, minHeight, maxHeight);\n    if (s.dir.includes(\"w\")) w = clamp(s.w - dx, minWidth, maxWidth);\n    if (!autoFill && s.dir.includes(\"n\"))\n      h = clamp(s.h - dy, minHeight, maxHeight);\n    setSize({ width: Math.round(w), height: Math.round(h) });\n  }\n  function endResize() {\n    window.removeEventListener(\"mousemove\", onMove);\n    window.removeEventListener(\"mouseup\", endResize);\n    startRef.current = null;\n  }\n\n  function handleKeyResize(e: React.KeyboardEvent, dir: string) {\n    const step = 20;\n    const k = e.key;\n    if (\n      ![\n        \"ArrowLeft\",\n        \"ArrowRight\",\n        \"ArrowUp\",\n        \"ArrowDown\",\n        \"Enter\",\n        \" \",\n      ].includes(k)\n    )\n      return;\n    e.preventDefault();\n    const delta = k === \"ArrowLeft\" || k === \"ArrowUp\" ? -step : step;\n    setSize((s) => {\n      const curW = s.width || defaultWidth;\n      const curH = s.height || defaultHeight;\n      let w = curW;\n      let h = curH;\n      if (dir.includes(\"e\")) w = clamp(curW + delta, minWidth, maxWidth);\n      if (dir.includes(\"w\")) w = clamp(curW - delta, minWidth, maxWidth);\n      if (!autoFill && dir.includes(\"s\"))\n        h = clamp(curH + delta, minHeight, maxHeight);\n      if (!autoFill && dir.includes(\"n\"))\n        h = clamp(curH - delta, minHeight, maxHeight);\n      return { width: Math.round(w), height: Math.round(h) };\n    });\n  }\n\n  const style: CSSProperties = {\n    width: autoFill ? \"100%\" : size.width ? `${size.width}px` : undefined,\n    height: autoFill ? \"100%\" : size.height ? `${size.height}px` : undefined,\n    maxWidth: \"100%\",\n    // Allow the panel to fill the parent when autoFill is enabled. Otherwise keep a sensible cap.\n    maxHeight: autoFill ? \"100%\" : \"80vh\",\n    position: \"relative\",\n    // Make it participate in flex layouts when filling\n    ...(autoFill\n      ? { display: \"flex\", flexDirection: \"column\", flex: \"1 1 auto\" }\n      : {}),\n  };\n\n  return (\n    <div ref={containerRef} className={`${className || \"\"}`} style={style}>\n      {children}\n      <div\n        className=\"resizer resizer-nw\"\n        onMouseDown={(e) => beginResize(e, \"nw\")}\n        role=\"button\"\n        tabIndex={0}\n        aria-label=\"Resize north-west\"\n        onKeyDown={(e) => handleKeyResize(e, \"nw\")}\n      />\n      <div\n        className=\"resizer resizer-ne\"\n        onMouseDown={(e) => beginResize(e, \"ne\")}\n        role=\"button\"\n        tabIndex={0}\n        aria-label=\"Resize north-east\"\n        onKeyDown={(e) => handleKeyResize(e, \"ne\")}\n      />\n      <div\n        className=\"resizer resizer-sw\"\n        onMouseDown={(e) => beginResize(e, \"sw\")}\n        role=\"button\"\n        tabIndex={0}\n        aria-label=\"Resize south-west\"\n        onKeyDown={(e) => handleKeyResize(e, \"sw\")}\n      />\n      <div\n        className=\"resizer resizer-se\"\n        onMouseDown={(e) => beginResize(e, \"se\")}\n        role=\"button\"\n        tabIndex={0}\n        aria-label=\"Resize south-east\"\n        onKeyDown={(e) => handleKeyResize(e, \"se\")}\n      />\n    </div>\n  );\n}\n","import { create } from \"zustand\";\nimport type { Ring } from \"../utils/scoring\";\n\nexport type PendingEntry = {\n  label: string;\n  value: number;\n  ring: Ring;\n  // Optional metadata (e.g., source/camera calibration) used by CameraView.\n  // Kept optional so existing usages remain compatible.\n  meta?: {\n    calibrationValid?: boolean;\n    pBoard?: { x: number; y: number } | null;\n    source?: \"camera\" | \"manual\";\n  };\n};\n\ntype PendingVisitState = {\n  darts: number;\n  total: number;\n  entries: PendingEntry[];\n  setVisit: (entries: PendingEntry[], darts: number, total: number) => void;\n  reset: () => void;\n};\n\nexport const usePendingVisit = create<PendingVisitState>((set) => ({\n  darts: 0,\n  total: 0,\n  entries: [],\n  setVisit: (entries, darts, total) => set({ entries, darts, total }),\n  reset: () => set({ darts: 0, total: 0, entries: [] }),\n}));\n","import React from \"react\";\nimport FocusLock from \"react-focus-lock\";\n\nexport default function PauseQuitModal({\n  onClose,\n  onQuit,\n  onPause,\n}: {\n  onClose: () => void;\n  onQuit: () => void;\n  onPause: (minutes: number) => void;\n}) {\n  // Close on Escape for accessibility\n  React.useEffect(() => {\n    const onKey = (e: KeyboardEvent) => {\n      if (e.key === \"Escape\") onClose();\n    };\n    window.addEventListener(\"keydown\", onKey);\n    return () => window.removeEventListener(\"keydown\", onKey);\n  }, [onClose]);\n  return (\n    <div className=\"fixed inset-0 z-[1200]\" role=\"presentation\">\n      <button\n        className=\"absolute inset-0 bg-black/50\"\n        onClick={onClose}\n        aria-label=\"Close overlay\"\n      />\n      <div className=\"absolute inset-0 flex items-center justify-center p-4\">\n        <FocusLock returnFocus>\n          <div\n            className=\"card max-w-md w-full p-4 rounded-xl text-left\"\n            role=\"dialog\"\n            aria-modal=\"true\"\n            aria-labelledby=\"pause-quit-heading\"\n          >\n            <div className=\"flex justify-between items-center mb-3\">\n              <h3 id=\"pause-quit-heading\" className=\"text-lg font-bold\">\n                Quit or Pause \n              </h3>\n              <button\n                className=\"btn px-3 py-1\"\n                onClick={onClose}\n                aria-label=\"Close dialog\"\n              >\n                \n              </button>\n            </div>\n            <div className=\"mb-4\">\n              <p className=\"mb-2\">\n                You can either quit the match, or pause it for up to 5 minutes\n                .\n              </p>\n              <p className=\"text-sm text-slate-400\">\n                If paused, the match will automatically resume when the timer\n                expires or when a player resumes early .\n              </p>\n            </div>\n\n            <div className=\"flex gap-2 flex-wrap mb-3\">\n              <button\n                className=\"btn bg-rose-600 hover:bg-rose-700 px-3 py-1\"\n                onClick={() => onQuit()}\n              >\n                Quit match \n              </button>\n              <div className=\"flex items-center gap-2\">\n                <span className=\"opacity-80\">Pause:</span>\n                {[1, 2, 3, 4, 5].map((m) => (\n                  <button\n                    key={m}\n                    className=\"btn btn--ghost px-3 py-1 text-sm\"\n                    onClick={() => onPause(m)}\n                  >\n                    {m}m \n                  </button>\n                ))}\n              </div>\n            </div>\n\n            <div className=\"text-right\">\n              <button className=\"btn btn--ghost px-3 py-1\" onClick={onClose}>\n                Cancel \n              </button>\n            </div>\n          </div>\n        </FocusLock>\n      </div>\n    </div>\n  );\n}\n","import React, { useEffect, useState } from \"react\";\nimport { useMatchControl } from \"../../store/matchControl\";\n\nfunction fmt(ms: number) {\n  const s = Math.max(0, Math.floor(ms / 1000));\n  const mm = Math.floor(s / 60)\n    .toString()\n    .padStart(2, \"0\");\n  const ss = (s % 60).toString().padStart(2, \"0\");\n  return `${mm}:${ss}`;\n}\n\nexport default function PauseTimerBadge({\n  compact = false,\n}: {\n  compact?: boolean;\n}) {\n  const pauseEndsAt = useMatchControl((s) => s.pauseEndsAt);\n  const pauseStartedAt = useMatchControl((s) => s.pauseStartedAt);\n  const paused = useMatchControl((s) => s.paused);\n  const [now, setNow] = useState(Date.now());\n\n  useEffect(() => {\n    if (!paused || !pauseEndsAt) return;\n    const t = setInterval(() => setNow(Date.now()), 500);\n    return () => clearInterval(t);\n  }, [paused, pauseEndsAt]);\n\n  if (!paused || !pauseEndsAt) return null;\n  const remaining = Math.max(0, pauseEndsAt - now);\n  const started = pauseStartedAt ?? now;\n  const total = Math.max(1, pauseEndsAt - started);\n  const pct = Math.max(0, Math.min(1, 1 - remaining / total));\n\n  return (\n    <div\n      className=\"mr-2\"\n      role=\"status\"\n      aria-live=\"polite\"\n      aria-atomic=\"true\"\n      aria-label={`Match paused, ${Math.ceil(remaining / 1000)} seconds remaining`}\n    >\n      <div\n        className={`px-2 py-1 rounded-full bg-amber-600 text-black text-xs font-semibold ${compact ? \"\" : \"mr-2\"}`}\n      >\n        Paused {fmt(remaining)} \n      </div>\n      {!compact && (\n        <div\n          className=\"w-40 h-2 bg-white/10 rounded overflow-hidden mt-1\"\n          aria-hidden\n        >\n          <div\n            className=\"h-2 bg-amber-400\"\n            style={{ width: `${Math.round(pct * 100)}%` }}\n          />\n        </div>\n      )}\n    </div>\n  );\n}\n","// Lightweight match state sync helper using BroadcastChannel + localStorage\nimport { useMatch } from \"../store/match\";\nimport { useMatchControl } from \"../store/matchControl\";\nimport { broadcastMessage } from \"./broadcast\";\n\nconst STORAGE_KEY = \"ndn:match-sync\";\n\nfunction getSnapshotState() {\n  try {\n    const m = useMatch.getState();\n    const c = useMatchControl.getState();\n    // Pick explicit fields to keep snapshot compact and stable\n    const match = {\n      roomId: m.roomId,\n      players: m.players,\n      currentPlayerIdx: m.currentPlayerIdx,\n      startingScore: m.startingScore,\n      inProgress: m.inProgress,\n      bestLegThisMatch: m.bestLegThisMatch,\n      // Optional server-style match descriptors (may not exist in client state)\n      game: (m as any).game ?? null,\n      mode: (m as any).mode ?? null,\n      value: (m as any).value ?? null,\n    };\n    // UI hints: some UI state like selectedMode is local to OfflinePlay; try to include a cached value if present\n    let ui: any = {};\n    try {\n      if (typeof localStorage !== \"undefined\") {\n        const sel = localStorage.getItem(\"ndn:selectedMode\");\n        ui.selectedMode = sel || null;\n      }\n    } catch (e) {\n      ui = { selectedMode: null };\n    }\n    const control = {\n      paused: c.paused,\n      pauseEndsAt: c.pauseEndsAt ?? null,\n      pauseStartedAt: (c as any).pauseStartedAt ?? null,\n    };\n    return { match, control, ui, ts: Date.now() };\n  } catch (e) {\n    return null;\n  }\n}\n\nexport function writeMatchSnapshot() {\n  try {\n    const state = getSnapshotState();\n    if (!state) return;\n    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));\n    // broadcast snapshot\n    try {\n      // Use the app-wide broadcast helper to ensure we don't instantiate a\n      // native Node BroadcastChannel directly (which can throw in tests).\n      // This lets unit tests mock BroadcastChannel or fall back to localStorage.\n      broadcastMessage({ type: \"snapshot\", state });\n    } catch {}\n  } catch (e) {}\n}\n\nexport function readMatchSnapshot(): { match?: any; control?: any } | null {\n  try {\n    const raw = localStorage.getItem(STORAGE_KEY);\n    if (!raw) return null;\n    const parsed = JSON.parse(raw);\n    return { match: parsed.match, control: parsed.control };\n  } catch {\n    return null;\n  }\n}\n\n// broadcastMessage and subscribeMatchSync live in src/utils/broadcast.ts\n","// Very lightweight checkout suggestions. For proper coverage consider a full table.\n// Returns up to a few route strings like \"T20 T20 D20\" for a given remaining.\n\n/**\n * Get recommended voices for natural-sounding darts calling\n * Prioritizes British English voices which suit darts calling best\n */\nexport function getRecommendedVoices(): SpeechSynthesisVoice[] {\n  try {\n    const synth = window.speechSynthesis;\n    if (!synth) return [];\n    const voices = synth.getVoices();\n\n    // Prioritize British English voices (they sound best for darts)\n    const britishVoices = voices.filter(\n      (v) =>\n        v.lang.startsWith(\"en-GB\") ||\n        v.name.toLowerCase().includes(\"british\") ||\n        v.name.toLowerCase().includes(\"uk\"),\n    );\n\n    // Then other English voices\n    const otherEnglish = voices.filter(\n      (v) => v.lang.startsWith(\"en\") && !britishVoices.includes(v),\n    );\n\n    // Premium/natural voices tend to have these keywords\n    const isPremiumVoice = (v: SpeechSynthesisVoice) =>\n      v.name.toLowerCase().includes(\"natural\") ||\n      v.name.toLowerCase().includes(\"premium\") ||\n      v.name.toLowerCase().includes(\"neural\") ||\n      v.name.toLowerCase().includes(\"enhanced\") ||\n      v.name.includes(\"Google\") ||\n      (v.name.includes(\"Microsoft\") &&\n        !v.name.includes(\"David\") &&\n        !v.name.includes(\"Zira\"));\n\n    // Sort each group by premium/natural voices first\n    const sortByQuality = (\n      a: SpeechSynthesisVoice,\n      b: SpeechSynthesisVoice,\n    ) => {\n      const aScore = isPremiumVoice(a) ? 1 : 0;\n      const bScore = isPremiumVoice(b) ? 1 : 0;\n      return bScore - aScore;\n    };\n\n    return [\n      ...britishVoices.sort(sortByQuality),\n      ...otherEnglish.sort(sortByQuality),\n    ];\n  } catch {\n    return [];\n  }\n}\n\n/**\n * Get the best default voice for darts calling\n */\nexport function getBestCallerVoice(): SpeechSynthesisVoice | null {\n  const recommended = getRecommendedVoices();\n  return recommended.length > 0 ? recommended[0] : null;\n}\n\nconst doubles = [\n  \"D1\",\n  \"D2\",\n  \"D3\",\n  \"D4\",\n  \"D5\",\n  \"D6\",\n  \"D7\",\n  \"D8\",\n  \"D9\",\n  \"D10\",\n  \"D11\",\n  \"D12\",\n  \"D13\",\n  \"D14\",\n  \"D15\",\n  \"D16\",\n  \"D17\",\n  \"D18\",\n  \"D19\",\n  \"D20\",\n  \"DB\",\n];\n\nfunction dVal(tag: string): number {\n  if (tag === \"DB\") return 50;\n  const n = Number(tag.slice(1));\n  return n * 2;\n}\n\nfunction prefsDoubleScore(fav: string): number {\n  if (!doubles.includes(fav)) return 32; // default D16\n  return dVal(fav);\n}\n\nexport function suggestCheckouts(\n  remaining: number,\n  favoriteDouble: string = \"D16\",\n): string[] {\n  if (remaining > 170 || remaining <= 1) return [];\n  // Simple known highest routes for popular numbers, then fall back to greedy towards favourite double\n  const hardcoded: Record<number, string[]> = {\n    170: [\"T20 T20 DB\"],\n    167: [\"T20 T19 DB\"],\n    164: [\"T20 T18 DB\"],\n    161: [\"T20 T17 DB\"],\n    160: [\"T20 T20 D20\"],\n    158: [\"T20 T20 D19\"],\n    157: [\"T20 T19 D20\"],\n    156: [\"T20 T20 D18\"],\n    155: [\"T20 T19 D19\"],\n    154: [\"T20 T18 D20\"],\n    153: [\"T20 T19 D18\"],\n    152: [\"T20 T20 D16\"],\n    151: [\"T20 T17 D20\"],\n    150: [\"T20 T18 D18\"],\n    149: [\"T20 T19 D16\"],\n    148: [\"T20 T16 D20\"],\n    147: [\"T20 T17 D18\"],\n    146: [\"T20 T18 D16\"],\n    145: [\"T20 T15 D20\"],\n    144: [\"T20 T20 D12\"],\n    141: [\"T20 T19 D12\"],\n    140: [\"T20 T20 D10\"],\n    137: [\"T20 T19 D10\"],\n    136: [\"T20 T20 D8\"],\n    132: [\"BULL T14 D20\", \"T20 T12 D8\"],\n    130: [\"T20 T20 D5\", \"T20 T18 D8\"],\n    129: [\"T19 T16 D12\"],\n    128: [\"T18 T14 D16\"],\n    127: [\"T20 T17 D8\"],\n    126: [\"T19 T19 D6\"],\n    121: [\"T20 11 D20\", \"T20 T15 D8\"],\n    120: [\"T20 20 D20\", \"T20 S20 D20\"],\n    110: [\"T20 10 D20\"],\n    100: [\"T20 D20\"],\n    99: [\"T19 10 D16\", \"T19 S10 D16\"],\n    97: [\"T19 D20\"],\n    96: [\"T20 D18\"],\n    95: [\"T19 D19\"],\n    94: [\"T18 D20\"],\n    92: [\"T20 D16\"],\n    90: [\"T18 D18\", \"T20 D15\"],\n    86: [\"T18 D16\"],\n    84: [\"T20 D12\", \"T16 D18\"],\n    82: [\"BULL D16\", \"T14 D20\"],\n    81: [\"T19 D12\"],\n    80: [\"T20 D10\", \"D20 D20\"],\n    78: [\"T18 D12\"],\n    76: [\"T20 D8\", \"T16 D14\"],\n    74: [\"T14 D16\", \"T18 D10\"],\n    72: [\"T16 D12\", \"T20 D6\"],\n    70: [\"T18 D8\", \"S20 BULL\"],\n    68: [\"T20 D4\", \"T16 D10\"],\n    66: [\"T10 D18\", \"T14 D12\"],\n    64: [\"T16 D8\", \"D16 D16\"],\n    62: [\"T10 D16\", \"T12 D13\"],\n    60: [\"20 D20\", \"S20 D20\"],\n    58: [\"18 D20\", \"S18 D20\"],\n    56: [\"16 D20\", \"S16 D20\"],\n    54: [\"14 D20\", \"S14 D20\"],\n    52: [\"20 D16\", \"S20 D16\"],\n    50: [\"BULL\", \"10 D20\"],\n    48: [\"16 D16\", \"S16 D16\"],\n    46: [\"14 D16\"],\n    44: [\"12 D16\"],\n    42: [\"10 D16\"],\n    40: [\"D20\"],\n    38: [\"D19\"],\n    36: [\"D18\"],\n    34: [\"D17\"],\n    32: [\"D16\"],\n    30: [\"D15\"],\n    28: [\"D14\"],\n    26: [\"D13\"],\n    24: [\"D12\"],\n    22: [\"D11\"],\n    20: [\"D10\"],\n    18: [\"D9\"],\n    16: [\"D8\"],\n    14: [\"D7\"],\n    12: [\"D6\"],\n    10: [\"D5\"],\n    8: [\"D4\"],\n    6: [\"D3\"],\n    4: [\"D2\"],\n    2: [\"D1\"],\n  };\n  if (hardcoded[remaining]) return hardcoded[remaining];\n  // Greedy fallback: aim to leave favourite double if possible in two darts\n  const target = prefsDoubleScore(favoriteDouble);\n  const routes: string[] = [];\n  // Try to hit a treble/big single that leaves the fav double\n  for (const t of [60, 57, 54, 51, 48]) {\n    // T20..T16\n    const left = remaining - t;\n    if (left === target) {\n      routes.push(`T${t / 3} ${favoriteDouble}`);\n      break;\n    }\n  }\n  if (!routes.length) {\n    for (const s of [20, 19, 18, 17, 16, 15]) {\n      const left = remaining - s;\n      if (left === target) {\n        routes.push(`${s} ${favoriteDouble}`);\n        break;\n      }\n    }\n  }\n  return routes;\n}\n\nexport function sayScore(\n  name: string,\n  scored: number,\n  remaining: number,\n  voiceName?: string,\n  opts?: { volume?: number; checkoutOnly?: boolean },\n) {\n  try {\n    const synth = window.speechSynthesis;\n    if (!synth) return;\n    const msg = new SpeechSynthesisUtterance();\n    // Clean username: keep only letters and numbers, remove all special characters\n    const cleanName = name\n      ?.toString()\n      .replace(/[^a-zA-Z0-9\\s]/g, \"\") // Remove all special chars\n      .replace(/\\s+/g, \" \") // Normalize spaces\n      .trim();\n    const spokenName = cleanName || name || \"Player\";\n    const isCheckout = remaining <= 170 && remaining > 0;\n    const isOneEighty = scored === 180;\n    const shouldAnnounce = !opts?.checkoutOnly || isCheckout || isOneEighty;\n    if (!shouldAnnounce) return;\n\n    // Natural caller phrases with variation\n    if (isOneEighty) {\n      const phrases = [\n        `${spokenName}... One hundred and eighty!`,\n        `One hundred and EIGHTY! ${spokenName}!`,\n        `${spokenName} with a maximum! One eighty!`,\n      ];\n      msg.text = phrases[Math.floor(Math.random() * phrases.length)];\n      msg.rate = 0.95;\n      msg.pitch = 1.1;\n    } else if (remaining === 0) {\n      const winPhrases = [\n        `Game shot! And the match, ${spokenName}!`,\n        `${spokenName} takes it! Game shot!`,\n        `And that's the checkout! ${spokenName} wins!`,\n      ];\n      msg.text = winPhrases[Math.floor(Math.random() * winPhrases.length)];\n      msg.rate = 0.9;\n      msg.pitch = 1.05;\n    } else if (isCheckout) {\n      // Checkout range - build tension\n      if (remaining <= 40) {\n        msg.text = `${spokenName}... requires ${remaining}.`;\n      } else if (remaining <= 100) {\n        msg.text = `${spokenName}, you require ${remaining}.`;\n      } else {\n        msg.text = `${spokenName} leaves ${remaining}.`;\n      }\n      msg.rate = 0.92;\n      msg.pitch = 1.0;\n    } else if (scored === 0) {\n      const noScorePhrases = [\n        `${spokenName}... no score.`,\n        `No score there for ${spokenName}.`,\n        `${spokenName}, unfortunately, no score.`,\n      ];\n      msg.text =\n        noScorePhrases[Math.floor(Math.random() * noScorePhrases.length)];\n      msg.rate = 0.95;\n      msg.pitch = 0.95;\n    } else if (scored >= 140) {\n      // Big scores get excitement\n      const bigPhrases = [\n        `${spokenName}! ${scored}!`,\n        `Lovely darts! ${spokenName} with ${scored}!`,\n        `${scored}! Great scoring from ${spokenName}!`,\n      ];\n      msg.text = bigPhrases[Math.floor(Math.random() * bigPhrases.length)];\n      msg.rate = 0.95;\n      msg.pitch = 1.05;\n    } else if (scored >= 100) {\n      msg.text = `${name}, ${scored}.`;\n      msg.rate = 0.95;\n      msg.pitch = 1.0;\n    } else {\n      msg.text = `${name}... ${scored}.`;\n      msg.rate = 0.95;\n      msg.pitch = 0.98;\n    }\n\n    // Ensure consistent voice by waiting for voices to load\n    const setVoiceAndSpeak = () => {\n      if (voiceName) {\n        const voices = synth.getVoices();\n        const v = voices.find((v) => v.name === voiceName);\n        if (v) {\n          msg.voice = v;\n        } else {\n          // Fallback: try to find any English voice\n          const englishVoice = voices.find((v) => v.lang.startsWith(\"en\"));\n          if (englishVoice) msg.voice = englishVoice;\n        }\n      }\n      if (typeof opts?.volume === \"number\")\n        msg.volume = Math.max(0, Math.min(1, opts.volume));\n      else msg.volume = 1;\n      try {\n        synth.cancel();\n      } catch {}\n      synth.speak(msg);\n    };\n\n    // Chrome/Edge need voices to load first\n    const voices = synth.getVoices();\n    if (voices.length > 0) {\n      setVoiceAndSpeak();\n    } else {\n      // Wait for voices to load\n      synth.addEventListener(\n        \"voiceschanged\",\n        () => {\n          setVoiceAndSpeak();\n        },\n        { once: true },\n      );\n      // Fallback timeout\n      setTimeout(setVoiceAndSpeak, 100);\n    }\n  } catch {}\n}\n\n/**\n * Speak an individual dart hit as it is detected\n * e.g. \"Triple 20\", \"Double 16\", \"Single 5\", \"Bull\", \"Bullseye\"\n * Uses natural caller-style pronunciation\n */\nexport function sayDart(\n  label: string,\n  voiceName?: string,\n  opts?: { volume?: number },\n) {\n  try {\n    const synth = window.speechSynthesis;\n    if (!synth) return;\n\n    // Convert label to natural spoken form\n    // Labels come in various formats:\n    // Short: \"T20\", \"D16\", \"S5\", \"BULL\", \"DBULL\", \"MISS 0\"\n    // Long: \"TRIPLE 20\", \"DOUBLE 16\", \"SINGLE 5\", \"INNER_BULL 50\", \"MISS\"\n    let spoken = label;\n    let isExciting = false;\n    let isMiss = false;\n\n    // Handle long format (from camera detection): \"TRIPLE 20\", \"DOUBLE 16\", etc.\n    if (label.startsWith(\"TRIPLE \")) {\n      const num = label.slice(7);\n      spoken = num === \"20\" ? \"Treble twenty\" : `Treble ${num}`;\n      isExciting = num === \"20\" || num === \"19\" || num === \"18\";\n    } else if (label.startsWith(\"DOUBLE \")) {\n      const num = label.slice(7);\n      spoken = `Double ${num}`;\n    } else if (label.startsWith(\"SINGLE \")) {\n      spoken = label.slice(7); // Just say the number for singles\n    } else if (label.startsWith(\"INNER_BULL\") || label === \"DBULL\") {\n      spoken = \"Bullseye!\";\n      isExciting = true;\n    } else if (\n      label.startsWith(\"BULL \") ||\n      label === \"BULL\" ||\n      label === \"OUTER_BULL\"\n    ) {\n      spoken = \"Bull\";\n    }\n    // Handle short format: \"T20\", \"D16\", \"S5\"\n    else if (label.startsWith(\"T\") && /^T\\d+$/.test(label)) {\n      const num = label.slice(1);\n      spoken = num === \"20\" ? \"Treble twenty\" : `Treble ${num}`;\n      isExciting = num === \"20\" || num === \"19\" || num === \"18\";\n    } else if (label.startsWith(\"D\") && /^D\\d+$/.test(label)) {\n      spoken = `Double ${label.slice(1)}`;\n    } else if (label.startsWith(\"S\") && /^S\\d+$/.test(label)) {\n      spoken = label.slice(1); // Just say the number for singles\n    } else if (label.includes(\"MISS\") || label === \"0\") {\n      const missPhrases = [\"Outside\", \"No score\", \"Just outside\"];\n      spoken = missPhrases[Math.floor(Math.random() * missPhrases.length)];\n      isMiss = true;\n    }\n\n    const msg = new SpeechSynthesisUtterance();\n    msg.text = spoken;\n\n    // Natural speech patterns - slower than a robot, with expression\n    if (isExciting) {\n      msg.rate = 0.9;\n      msg.pitch = 1.08;\n    } else if (isMiss) {\n      msg.rate = 0.88;\n      msg.pitch = 0.92;\n    } else {\n      msg.rate = 0.92;\n      msg.pitch = 1.0;\n    }\n\n    // Ensure consistent voice by waiting for voices to load\n    const setVoiceAndSpeak = () => {\n      if (voiceName) {\n        const voices = synth.getVoices();\n        const v = voices.find((v) => v.name === voiceName);\n        if (v) {\n          msg.voice = v;\n        } else {\n          // Fallback: try to find any English voice\n          const englishVoice = voices.find((v) => v.lang.startsWith(\"en\"));\n          if (englishVoice) msg.voice = englishVoice;\n        }\n      }\n      if (typeof opts?.volume === \"number\")\n        msg.volume = Math.max(0, Math.min(1, opts.volume));\n      else msg.volume = 1;\n\n      try {\n        synth.cancel();\n      } catch {}\n      synth.speak(msg);\n    };\n\n    // Chrome/Edge need voices to load first\n    const voices = synth.getVoices();\n    if (voices.length > 0) {\n      setVoiceAndSpeak();\n    } else {\n      // Wait for voices to load\n      synth.addEventListener(\n        \"voiceschanged\",\n        () => {\n          setVoiceAndSpeak();\n        },\n        { once: true },\n      );\n      // Fallback timeout\n      setTimeout(setVoiceAndSpeak, 100);\n    }\n  } catch {}\n}\n","import type { Point } from \"./vision\";\n\n// The physical dartboard dimensions are standardized.\n// Source: World Darts Federation / common dartboard specs.\n// - Bull (\"inner bull\") radius: 6.35mm (12.7mm diameter)\n// - Outer bull radius: 15.9mm (31.8mm diameter)\n// These are the most important for \"bulling up\" distance-to-bull.\nexport const DARTBOARD_MM = {\n  bullInnerRadiusMm: 6.35,\n  bullOuterRadiusMm: 15.9,\n} as const;\n\nexport type BullDistanceResult = {\n  // Euclidean distance from bull center in millimetres.\n  distanceMm: number;\n  // Convenience: bull rings for messaging.\n  inInnerBull: boolean;\n  inOuterBull: boolean;\n};\n\n// NOTE: This assumes pBoard is in the same \"board units\" as BoardRadii.\n// In this codebase, vision helpers treat the board as a radius-normalized model\n// (i.e. bull/triple/double rings are represented as radii in the same unit).\n// If calibration changes those units, only `mmPerBoardUnit` needs updating.\nexport function mmPerBoardUnitFromBullOuter(params: {\n  bullOuterRadiusBoardUnits: number;\n}): number {\n  const r = params.bullOuterRadiusBoardUnits;\n  if (!Number.isFinite(r) || r <= 0) return 0;\n  return DARTBOARD_MM.bullOuterRadiusMm / r;\n}\n\nexport function distanceFromBullMm(params: {\n  // Dart tip location in board-model coordinates.\n  pBoard: Point;\n  // Bull center in board-model coordinates.\n  bullCenter?: Point;\n  // Conversion scalar.\n  mmPerBoardUnit: number;\n  // Optional board bull radii in board units (for in-bull checks).\n  bullInnerRadiusBoardUnits?: number;\n  bullOuterRadiusBoardUnits?: number;\n}): BullDistanceResult {\n  const {\n    pBoard,\n    bullCenter = { x: 0, y: 0 },\n    mmPerBoardUnit,\n    bullInnerRadiusBoardUnits,\n    bullOuterRadiusBoardUnits,\n  } = params;\n\n  const dx = (pBoard?.x ?? 0) - (bullCenter?.x ?? 0);\n  const dy = (pBoard?.y ?? 0) - (bullCenter?.y ?? 0);\n  const dBoard = Math.sqrt(dx * dx + dy * dy);\n  const mm = Math.max(\n    0,\n    dBoard * (Number.isFinite(mmPerBoardUnit) ? mmPerBoardUnit : 0),\n  );\n\n  const inInnerBull =\n    typeof bullInnerRadiusBoardUnits === \"number\" &&\n    bullInnerRadiusBoardUnits > 0 &&\n    dBoard <= bullInnerRadiusBoardUnits + 1e-9;\n\n  const inOuterBull =\n    typeof bullOuterRadiusBoardUnits === \"number\" &&\n    bullOuterRadiusBoardUnits > 0 &&\n    dBoard <= bullOuterRadiusBoardUnits + 1e-9;\n\n  return { distanceMm: mm, inInnerBull, inOuterBull };\n}\n","import {\n  BoardRadii,\n  drawPolyline,\n  sampleRing,\n  scaleHomography,\n  type Point,\n  applyHomography,\n  refinePointSobel,\n  imageToBoard,\n} from \"../utils/vision\";\nimport React, {\n  useCallback,\n  useEffect,\n  useLayoutEffect,\n  useRef,\n  useState,\n  forwardRef,\n  useImperativeHandle,\n} from \"react\";\nimport type { MutableRefObject } from \"react\";\nimport { dlog, dinfo } from \"../utils/logger\";\nimport { ensureVideoPlays } from \"../utils/ensureVideoPlays\";\nimport { useUserSettings } from \"../store/userSettings\";\nimport { useCalibration } from \"../store/calibration\";\nimport { useMatch } from \"../store/match\";\nimport { scoreFromImagePoint } from \"../utils/autoscore\";\nimport { getGlobalCalibrationConfidence } from \"../utils/gameCalibrationRequirements\";\nimport { DartDetector } from \"../utils/dartDetector\";\nimport { addSample } from \"../store/profileStats\";\nimport { subscribeExternalWS } from \"../utils/scoring\";\nimport ResizablePanel from \"./ui/ResizablePanel\";\nimport FocusLock from \"react-focus-lock\";\nimport { usePendingVisit } from \"../store/pendingVisit\";\nimport { useCameraSession } from \"../store/cameraSession\";\nimport { useMatchControl } from \"../store/matchControl\";\nimport { useAudit } from \"../store/audit\";\nimport PauseQuitModal from \"./ui/PauseQuitModal\";\nimport PauseTimerBadge from \"./ui/PauseTimerBadge\";\nimport { writeMatchSnapshot } from \"../utils/matchSync\";\nimport { broadcastMessage } from \"../utils/broadcast\";\nimport { startForwarding, stopForwarding } from \"../utils/cameraHandoff\";\nimport { sayScore } from \"../utils/checkout\";\nimport {\n  distanceFromBullMm,\n  mmPerBoardUnitFromBullOuter,\n} from \"../utils/bullDistance\";\n\ntype VideoDiagnostics = {\n  ts: number;\n  hasVideoEl: boolean;\n  video: {\n    hasSrcObject: boolean;\n    readyState: number | null;\n    paused: boolean | null;\n    ended: boolean | null;\n    videoWidth: number;\n    videoHeight: number;\n  };\n  stream: {\n    exists: boolean;\n    videoTracks: number;\n    audioTracks: number;\n    videoTrackStates: Array<{\n      enabled: boolean;\n      muted?: boolean;\n      readyState: string;\n    }>;\n  };\n  session: {\n    mode?: any;\n    isStreaming?: any;\n  };\n  preferredCamera: {\n    id?: string;\n    label?: string;\n    locked?: boolean;\n  };\n  error?: string | null;\n};\n\n// Shared ring type across autoscore/manual flows\ntype Ring = \"MISS\" | \"SINGLE\" | \"DOUBLE\" | \"TRIPLE\" | \"BULL\" | \"INNER_BULL\";\n\n// Require at least two frames showing a candidate to reduce false positives\n// In tests, use 0 to allow deterministic single-frame commits for faster test assertions.\n// Require more consecutive frames before auto-committing to avoid ghost darts\nconst AUTO_COMMIT_MIN_FRAMES = process.env.NODE_ENV === \"test\" ? 0 : 4;\n// Allow a short hold time as fallback for single-frame candidates\nconst AUTO_COMMIT_HOLD_MS = 250;\n// Use a small cooldown even in tests to reduce non-deterministic duplicate commits\nconst AUTO_COMMIT_COOLDOWN_MS = process.env.NODE_ENV === \"test\" ? 150 : 400;\nconst AUTO_STREAM_IGNORE_MS = process.env.NODE_ENV === \"test\" ? 0 : 800;\nconst DETECTION_ARM_DELAY_MS = process.env.NODE_ENV === \"test\" ? 0 : 1500;\n\n// Anti-false-positive: in offline play, only allow commits shortly after a\n// throw-like motion event. This prevents static board artifacts (e.g. sisal\n// fibers/protrusions) from continuously triggering candidate/commit logic.\nconst OFFLINE_THROW_WINDOW_MS = process.env.NODE_ENV === \"test\" ? 0 : 4500;\n\n// If a detection is accepted but never becomes \"settled/tipStable\" (common on\n// real-world webcams with tiny jitter), we can safely commit anyway after a\n// short time IF we're inside the post-throw window. This prevents the\n// frustrating \"pending forever\" state while preserving anti-ghost protection.\nconst SNAP_COMMIT_MIN_MS = process.env.NODE_ENV === \"test\" ? 0 : 900;\nconst SNAP_COMMIT_MIN_TIP_STABLE_FRAMES =\n  process.env.NODE_ENV === \"test\" ? 1 : 3;\nconst DETECTION_MIN_FRAMES = process.env.NODE_ENV === \"test\" ? 0 : 10;\n// Immediately after calibration, lighting/ROI/camera stabilization can be slightly noisy.\n// Give the detector a short grace window with relaxed gates so the first darts count.\nconst POST_CALIBRATION_GRACE_MS = process.env.NODE_ENV === \"test\" ? 0 : 8000;\n// Confidence threshold tuned for field play: high enough to suppress glare but\n// low enough that real darts with minor blur still make it through.\nconst AUTO_COMMIT_CONFIDENCE = 0.8;\n// Real-world reliability: require the detected tip to be stable (low jitter)\n// across multiple frames before allowing a commit.\n// Real cameras often have small inter-frame jitter; requiring too many stable\n// frames can cause missed darts. These values aim to block flicker while still\n// committing quickly once the dart is actually in the board.\nconst TIP_STABLE_MIN_FRAMES = process.env.NODE_ENV === \"test\" ? 1 : 3;\n// Tighter jitter tolerance so a dart must stay pinned in nearly the same spot\nconst TIP_STABLE_MAX_JITTER_PX = process.env.NODE_ENV === \"test\" ? 999 : 4;\n// After any detection appears/disappears, wait briefly before arming so we don't\n// commit on motion blur or lighting flicker.\n// Give the scene a bit longer to settle after motion/lighting changes\nconst DETECTION_SETTLE_MS = process.env.NODE_ENV === \"test\" ? 0 : 900;\n// Prevent lingering \"hand in frame\" detections from auto-committing; require a\n// fresh detection within this window unless motion resets the timer explicitly.\nconst MAX_DETECTION_STILL_MS = 2400;\n// Significant tip movement threshold that signals a real throw event and resets\n// the continuous-detection timer.\nconst TIP_MOTION_RESET_PX = 24;\nconst BOARD_CLEAR_GRACE_MS = 6500;\n// Disable all camera overlays (rings, debug bboxes/axis) while keeping scoring intact.\n// This hides the cyan debug boxes/rings shown around trebles/doubles and detections.\nconst DISABLE_CAMERA_OVERLAY = true;\n// Unit tests for this repo run under Vitest and rely on CameraView's autoscore\n// effect running. We keep \"TEST_MODE\" disabled and use explicit NODE_ENV checks\n// for small test-only knobs.\nconst TEST_MODE = false;\n\nconst CAMERA_VERBOSE_LOGS =\n  String(import.meta.env?.VITE_CAMERA_VERBOSE_LOGS ?? \"\")\n    .trim()\n    .toLowerCase() === \"1\";\nconst cameraVerboseLog = (...args: unknown[]) => {\n  // Always log detection startup/status events to help user debug \"not registering\" issues\n  if (\n    typeof args[0] === \"string\" &&\n    (args[0].includes(\"starting detection\") ||\n      args[0].includes(\"Exiting:\") ||\n      args[0] === \"[DETECTION] Effect running\")\n  ) {\n    console.log(...args);\n  }\n  if (!CAMERA_VERBOSE_LOGS) return;\n  console.log(...args);\n};\n\n// Ring-light / glare mitigation\n// When enabled, we apply a lightweight highlight compression to the captured\n// frame BEFORE running background subtraction / blob detection.\n// Enable via DevTools:\n//   localStorage.setItem('ndn.glareClamp', '1'); location.reload();\n// Disable:\n//   localStorage.removeItem('ndn.glareClamp'); location.reload();\nfunction glareClampFrameInPlace(\n  frame: ImageData,\n  opts?: { knee?: number; strength?: number },\n) {\n  // knee: luma threshold where compression starts (0..255)\n  // strength: 0..1, higher compresses highlights more\n  const knee = Math.max(0, Math.min(255, opts?.knee ?? 210));\n  const strength = Math.max(0, Math.min(1, opts?.strength ?? 0.65));\n\n  const d = frame.data;\n  for (let i = 0; i < d.length; i += 4) {\n    const r = d[i];\n    const g = d[i + 1];\n\n    const b = d[i + 2];\n\n    // Fast approx luma (integer math)\n    const y = (r * 77 + g * 150 + b * 29) >> 8; // ~0.299,0.587,0.114\n    if (y <= knee) continue;\n\n    // Normalize how far above the knee we are\n    const over = y - knee; // 0..(255-knee)\n    const t = over / Math.max(1, 255 - knee); // 0..1\n\n    // Compression curve: dampen highlights; keeps midtones stable.\n    // y' = y - strength * over * t\n    const y2 = y - strength * over * t;\n    const ratio = y > 0 ? y2 / y : 1;\n\n    d[i] = Math.max(0, Math.min(255, Math.round(r * ratio)));\n    d[i + 1] = Math.max(0, Math.min(255, Math.round(g * ratio)));\n    d[i + 2] = Math.max(0, Math.min(255, Math.round(b * ratio)));\n    // alpha unchanged\n  }\n}\n\ntype FitTransform = {\n  // Map a point in the processing canvas (video pixel space) into the\n  // calibration image space used by the homography.\n  toCalibration: (pVideoPx: Point) => Point;\n};\n\nfunction makeFitTransform(params: {\n  videoW: number;\n  videoH: number;\n  calibW: number;\n  calibH: number;\n  fitMode: \"fit\" | \"fill\";\n}): FitTransform {\n  const { videoW, videoH, calibW, calibH, fitMode } = params;\n  const sx = videoW / calibW;\n  const sy = videoH / calibH;\n  // We assume the processing canvas matches the intrinsic video size (vw/vh).\n  // The mismatch happens because calibration was captured against a different\n  // sized image (calibW/calibH). Additionally, UI fit-mode can implicitly crop\n  // the visible region, which affects where the user thinks the tip is.\n  //\n  // We correct by projecting the *video-space* point back into calibration-space\n  // under the same contain/cover rules.\n  const vr = videoW / videoH;\n  const cr = calibW / calibH;\n  let cropXCal = 0;\n  let cropYCal = 0;\n\n  if (fitMode === \"fill\") {\n    // Cover: calibration image is effectively cropped to match the video aspect.\n    // Determine how much of the calibration image would be cropped.\n    if (vr > cr) {\n      // video is wider => crop calibration left/right\n      const targetWCal = calibH * vr;\n      cropXCal = Math.max(0, (targetWCal - calibW) / 2);\n    } else if (vr < cr) {\n      // video is taller => crop calibration top/bottom\n      const targetHCal = calibW / vr;\n      cropYCal = Math.max(0, (targetHCal - calibH) / 2);\n    }\n  } else {\n    // Contain: no crop, but there would be letterbox on display.\n    // Since detector works in full video pixels, we only need uniform scaling.\n    cropXCal = 0;\n    cropYCal = 0;\n  }\n\n  return {\n    toCalibration: (pVideoPx: Point) => {\n      // First map video px -> calibration px via simple scale\n      const p = { x: pVideoPx.x / sx, y: pVideoPx.y / sy };\n      // Then undo cover-cropping in calibration space (if any)\n      return { x: p.x + cropXCal, y: p.y + cropYCal };\n    },\n  };\n}\n\ntype AutoCandidate = {\n  value: number;\n  ring: Ring;\n  label: string;\n  sector: number | null;\n  mult: 0 | 1 | 2 | 3;\n  firstTs: number;\n  frames: number;\n  // Video-space tip used to keep tracking the same physical dart even when\n  // segment mapping jitters between frames.\n  lastTip?: { x: number; y: number } | null;\n};\n\ntype DetectionLogEntry = {\n  ts: number;\n  label: string;\n  value: number;\n  ring: Ring;\n  confidence: number;\n  ready: boolean;\n  accepted: boolean;\n  warmup: boolean;\n  fresh?: boolean;\n  // If present, explains why the hit was not accepted/committed.\n  // Useful for diagnosing missed darts.\n  rejectReason?:\n    | \"below-confidence\"\n    | \"calibration-invalid\"\n    | \"tip-outside-video\"\n    | \"pCal-outside-image\"\n    | \"off-board\"\n    | \"ghost\"\n    | \"not-settled\"\n    | \"unstable-tip\"\n    | \"candidate-hold\"\n    | \"cooldown\"\n    | \"warmup\"\n    | string\n    | null;\n  pCal?: Point;\n  tip?: Point;\n  frame?: string | null; // small dataURL thumbnail for quick review\n};\n\ntype _BounceoutEvent = {\n  ts: number;\n  // Best-effort derived distance (from last seen tip point) so a bounceout can\n  // still feel \"real\" in online play.\n  bullDistanceMm?: number;\n};\n\ntype CameraDartMeta = {\n  calibrationValid?: boolean;\n  pBoard?: Point | null;\n  source?: \"camera\" | \"manual\";\n  // Optional testing/advanced flags\n  __allowMultipleBullUp?: boolean;\n  __tipVideoPx?: Point;\n};\n\nexport type CameraViewHandle = {\n  runDetectionTick: () => void;\n  runSelfTest?: () => Promise<boolean>;\n  // Test-only helper to directly add a dart without relying on detector\n  __test_addDart?: (\n    value: number,\n    label: string,\n    ring: Ring,\n    meta?: any,\n    opts?: { emulateApplyAutoHit?: boolean },\n  ) => void;\n  // Test-only helper to commit the currently pending visit.\n  __test_commitVisit?: () => void;\n  __test_forceSetPendingVisit?: (\n    entries: Array<{ label: string; value: number; ring: Ring }>,\n  ) => void;\n};\n\nexport default forwardRef(function CameraView(\n  {\n    onVisitCommitted,\n    showToolbar = true,\n    onAutoDart,\n    immediateAutoCommit = false,\n    hideInlinePanels = false,\n    scoringMode = \"x01\",\n    onGenericDart,\n    onGenericReplace,\n    x01DoubleInOverride,\n    onAddVisit,\n    onEndLeg,\n    cameraAutoCommit: _cameraAutoCommit = \"camera\",\n    forceAutoStart = false,\n    disableDetection = false,\n    minimalControls = false,\n  }: {\n    onVisitCommitted?: (\n      score: number,\n      darts: number,\n      finished: boolean,\n      meta?: {\n        label?: string;\n        ring?: Ring;\n        entries?: { label: string; value: number; ring: string }[];\n        frame?: string | null;\n      },\n    ) => void;\n    showToolbar?: boolean;\n    onAutoDart?: (\n      value: number,\n      ring: \"MISS\" | \"SINGLE\" | \"DOUBLE\" | \"TRIPLE\" | \"BULL\" | \"INNER_BULL\",\n      info?: {\n        sector: number | null;\n        mult: 0 | 1 | 2 | 3;\n        calibrationValid?: boolean;\n        pBoard?: Point | null;\n        bullDistanceMm?: number;\n        tipVideoPx?: Point;\n        bounceout?: boolean;\n      },\n    ) => boolean | void | Promise<boolean | void>;\n    immediateAutoCommit?: boolean;\n    hideInlinePanels?: boolean;\n    scoringMode?: \"x01\" | \"custom\";\n    onGenericDart?: (\n      value: number,\n      ring: Ring,\n      meta: { label: string },\n    ) => void;\n    onGenericReplace?: (\n      value: number,\n      ring: Ring,\n      meta: { label: string },\n    ) => void;\n    x01DoubleInOverride?: boolean;\n    onAddVisit?: (score: number, darts: number, meta?: any) => void;\n    onEndLeg?: (score?: number) => void;\n    cameraAutoCommit?: \"camera\" | \"parent\" | \"both\";\n    // Force the camera to auto-start even if the global toggle was off (useful for match window popouts)\n    forceAutoStart?: boolean;\n    disableDetection?: boolean;\n    minimalControls?: boolean;\n  },\n  ref: any,\n) {\n  const videoRef = useRef<HTMLVideoElement>(\n    null,\n  ) as MutableRefObject<HTMLVideoElement | null>;\n  // IMPORTANT: subscribe to settings granularly to avoid rerender storms.\n  const preferredCameraId = useUserSettings((s) => s.preferredCameraId);\n  const preferredCameraLabel = useUserSettings((s) => s.preferredCameraLabel);\n  const autoscoreProvider = useUserSettings((s) => s.autoscoreProvider);\n  const autoscoreWsUrl = useUserSettings((s) => s.autoscoreWsUrl);\n  const cameraAspect = useUserSettings((s) => s.cameraAspect);\n  const cameraFitMode = useUserSettings((s) => s.cameraFitMode);\n  const cameraScale = useUserSettings((s) => s.cameraScale);\n  const cameraLowLatency = useUserSettings((s) => s.cameraLowLatency) ?? false;\n  const cameraProcessingFps =\n    useUserSettings((s) => s.cameraProcessingFps) ?? 15;\n  const autoCommitMode =\n    useUserSettings((s) => s.autoCommitMode) ?? \"wait-for-clear\";\n  const confirmUncertainDarts =\n    useUserSettings((s) => s.confirmUncertainDarts) ?? true;\n  const autoScoreConfidenceThreshold =\n    useUserSettings((s) => s.autoScoreConfidenceThreshold) ??\n    AUTO_COMMIT_CONFIDENCE;\n  const autoscoreDetectorMinArea =\n    useUserSettings((s) => s.autoscoreDetectorMinArea) ?? 30;\n  const autoscoreDetectorThresh =\n    useUserSettings((s) => s.autoscoreDetectorThresh) ?? 15;\n  const autoscoreDetectorRequireStableN =\n    useUserSettings((s) => s.autoscoreDetectorRequireStableN) ?? 2;\n  const harshLightingMode =\n    useUserSettings((s) => s.harshLightingMode) ?? false;\n  const enhanceBigTrebles =\n    useUserSettings((s) => s.enhanceBigTrebles) ?? false;\n  const cameraEnabled = useUserSettings((s) => s.cameraEnabled);\n  const preferredCameraLocked = useUserSettings((s) => s.preferredCameraLocked);\n  const hideCameraOverlay = useUserSettings((s) => s.hideCameraOverlay);\n  const _cameraRecordDarts = useUserSettings((s) =>\n    typeof s.cameraRecordDarts === \"boolean\" ? s.cameraRecordDarts : true,\n  );\n  const cameraShowLabels = useUserSettings((s) =>\n    typeof s.cameraShowLabels === \"boolean\" ? s.cameraShowLabels : false,\n  );\n  const callerEnabled = useUserSettings((s) => s.callerEnabled);\n  const speakCheckoutOnly = useUserSettings((s) => s.speakCheckoutOnly);\n  const callerVoice = useUserSettings((s) => s.callerVoice);\n  const callerVolume = useUserSettings((s) => s.callerVolume);\n\n  // Actions (stable, no need to subscribe to entire state)\n  const setPreferredCamera = useUserSettings.getState().setPreferredCamera;\n  const setCameraEnabled = useUserSettings.getState().setCameraEnabled;\n  const setHideCameraOverlay = useUserSettings.getState().setHideCameraOverlay;\n  const setCameraScale = useUserSettings.getState().setCameraScale;\n  const setCameraAspect = useUserSettings.getState().setCameraAspect;\n  const setCameraFitMode = useUserSettings.getState().setCameraFitMode;\n  const preserveCalibrationOverlay = useUserSettings(\n    (s) => s.preserveCalibrationOverlay,\n  );\n  const autoscoreEnabled = true;\n  const manualOnly =\n    autoscoreProvider === \"manual\" || disableDetection || !autoscoreEnabled;\n  const [availableCameras, setAvailableCameras] = useState<MediaDeviceInfo[]>(\n    [],\n  );\n  const canvasRef = useRef<HTMLCanvasElement>(null);\n  const previewCanvasRef = useRef<HTMLCanvasElement>(null);\n  const overlayRef = useRef<HTMLCanvasElement>(null);\n  const [streaming, setStreaming] = useState(false);\n  const [videoReady, setVideoReady] = useState(false); // Track when video has dimensions\n  const [showVideoDiagnostics, setShowVideoDiagnostics] = useState(false);\n  const [videoDiagnostics, setVideoDiagnostics] =\n    useState<VideoDiagnostics | null>(null);\n  // Track camera access problems so we can show an inline UI instead of repeatedly\n  // calling getUserMedia (which can re-trigger the browser permission prompt).\n  const [cameraAccessError, setCameraAccessError] = useState<\n    null | \"permission-denied\" | \"not-found\" | \"not-supported\" | \"unknown\"\n  >(null);\n  const cameraSession = useCameraSession();\n  const handleVideoRef = useCallback(\n    (el: HTMLVideoElement | null) => {\n      (videoRef as unknown as { current: HTMLVideoElement | null }).current =\n        el;\n      // Intentionally do NOT claim the global video element ref here. We\n      // prefer to claim the global ref only after playback has been\n      // confirmed (see ensureVideoPlays usage in startCamera). Claiming too\n      // early can cause multiple surfaces to race calling play() and produce\n      // AbortError interruptions.\n    },\n    [cameraSession],\n  );\n  const isPhoneCamera = preferredCameraLabel === \"Phone Camera\";\n  const sessionStream = cameraSession.getMediaStream?.() || null;\n  const sessionStreaming = cameraSession.isStreaming;\n  const phoneFeedActive =\n    isPhoneCamera &&\n    cameraSession.mode === \"phone\" &&\n    sessionStreaming &&\n    !!sessionStream;\n  const effectiveStreaming =\n    streaming || sessionStreaming || process.env.NODE_ENV === \"test\";\n\n  const [cameraStarting, setCameraStarting] = useState(false);\n  const retryCountRef = useRef(0);\n  const isMountedRef = useRef(true);\n\n  useEffect(() => {\n    return () => {\n      isMountedRef.current = false;\n    };\n  }, []);\n\n  // Track whether the tab/window is visible so we can pause heavy camera work\n  // (overlay drawing + CV detection) when in the background.\n  const [isDocumentVisible, setIsDocumentVisible] = useState(() => {\n    if (typeof document === \"undefined\") return true;\n    return !document.hidden;\n  });\n\n  useEffect(() => {\n    if (typeof document === \"undefined\") return;\n    const onVis = () => setIsDocumentVisible(!document.hidden);\n    document.addEventListener(\"visibilitychange\", onVis);\n    return () => document.removeEventListener(\"visibilitychange\", onVis);\n  }, []);\n\n  // Ensure the mounted <video> element always has the active stream attached.\n  // This handles cases where the stream is started before the <video> ref mounts\n  // (common when switching views or after calibration).\n  useEffect(() => {\n    if (TEST_MODE) return;\n    const v = videoRef.current;\n    const s = cameraSession.getMediaStream?.() || null;\n    if (!v || !s) return;\n    try {\n      if (!v.srcObject) {\n        v.srcObject = s;\n      }\n      // Kick playback so metadata/dimensions become available.\n      if (typeof v.play === \"function\") {\n        Promise.resolve(v.play()).catch(() => {});\n      }\n    } catch (e) {}\n  }, [cameraSession.isStreaming, cameraSession.mode, preferredCameraId]);\n\n  // Auto-start local camera when enabled and not actively receiving a phone feed.\n  useEffect(() => {\n    if (TEST_MODE) return;\n    if (!cameraEnabled) return;\n    if (isPhoneCamera && phoneFeedActive) return;\n    const hasAnyStream = !!(cameraSession.getMediaStream?.() || null);\n    // If there's no stream at all, start it.\n    if (!hasAnyStream && !streaming && !cameraStarting) {\n      try {\n        void startCamera();\n      } catch (e) {}\n    }\n    // If a stale streaming flag exists but no media tracks, reset and retry\n    if (cameraSession.isStreaming && !hasAnyStream && !cameraStarting) {\n      try {\n        cameraSession.setStreaming(false);\n      } catch {}\n      try {\n        void startCamera();\n      } catch (e) {}\n    }\n  }, [\n    cameraEnabled,\n    isPhoneCamera,\n    phoneFeedActive,\n    streaming,\n    cameraStarting,\n    preferredCameraId,\n  ]);\n\n  // Ensure the <video> element begins playback once metadata is ready (covers some browsers blocking autoplay)\n  useEffect(() => {\n    const v = videoRef.current;\n    if (!v) return;\n    const onLoaded = () => {\n      try {\n        const p = v.play();\n        if (p && typeof p.catch === \"function\") p.catch(() => {});\n      } catch (e) {}\n    };\n    const onPlaying = () => {\n      // When the video transitions to playing, it often gains dimensions.\n      try {\n        if (v.videoWidth && v.videoHeight) setVideoReady(true);\n      } catch {}\n    };\n    const onResize = () => {\n      try {\n        if (v.videoWidth && v.videoHeight) setVideoReady(true);\n      } catch {}\n    };\n    v.addEventListener(\"loadedmetadata\", onLoaded);\n    v.addEventListener(\"playing\", onPlaying);\n    // Some browsers fire resize when dimensions become known.\n    v.addEventListener(\"resize\", onResize as any);\n    return () => {\n      v.removeEventListener(\"loadedmetadata\", onLoaded);\n      v.removeEventListener(\"playing\", onPlaying);\n      v.removeEventListener(\"resize\", onResize as any);\n    };\n  }, []);\n\n  const collectVideoDiagnostics = useCallback(\n    (opts?: { error?: string | null }): VideoDiagnostics => {\n      const v = videoRef.current;\n      const s = (cameraSession.getMediaStream?.() ||\n        null) as MediaStream | null;\n      const videoTracks = s ? s.getVideoTracks() : [];\n      const audioTracks = s ? s.getAudioTracks() : [];\n      return {\n        ts: Date.now(),\n        hasVideoEl: !!v,\n        video: {\n          hasSrcObject: !!(v as any)?.srcObject,\n          readyState:\n            typeof (v as any)?.readyState === \"number\"\n              ? (v as any).readyState\n              : null,\n          paused:\n            typeof (v as any)?.paused === \"boolean\" ? (v as any).paused : null,\n          ended:\n            typeof (v as any)?.ended === \"boolean\" ? (v as any).ended : null,\n          videoWidth: v?.videoWidth || 0,\n          videoHeight: v?.videoHeight || 0,\n        },\n        stream: {\n          exists: !!s,\n          videoTracks: videoTracks.length,\n          audioTracks: audioTracks.length,\n          videoTrackStates: videoTracks.map((t) => ({\n            enabled: t.enabled,\n            muted: (t as any).muted,\n            readyState: t.readyState,\n          })),\n        },\n        session: {\n          mode: (cameraSession as any).mode,\n          isStreaming: (cameraSession as any).isStreaming,\n        },\n        preferredCamera: {\n          id: preferredCameraId,\n          label: preferredCameraLabel,\n          locked: preferredCameraLocked,\n        },\n        error: opts?.error ?? null,\n      };\n    },\n    [\n      cameraSession,\n      preferredCameraId,\n      preferredCameraLabel,\n      preferredCameraLocked,\n    ],\n  );\n\n  // Poll diagnostics when enabled. This catches the most common \"white feed\"\n  // symptom: stream exists but videoWidth stays 0 and/or track is muted/ended.\n  useEffect(() => {\n    if (!showVideoDiagnostics) return;\n    let alive = true;\n    const tick = () => {\n      if (!alive) return;\n      try {\n        setVideoDiagnostics(collectVideoDiagnostics());\n      } catch {}\n    };\n    tick();\n    const id = window.setInterval(tick, 500);\n    return () => {\n      alive = false;\n      window.clearInterval(id);\n    };\n  }, [showVideoDiagnostics, collectVideoDiagnostics]);\n\n  // Expose a small debug helper on window for manual inspection from the\n  // browser console. This avoids requiring the user to paste a lot of tiny\n  // snippets; they can instead run `window.__ndn_camera_debug.collect()`.\n  useEffect(() => {\n    try {\n      (window as any).__ndn_camera_debug =\n        (window as any).__ndn_camera_debug || {};\n      (window as any).__ndn_camera_debug.collect = () => {\n        try {\n          return collectVideoDiagnostics({ error: cameraAccessError });\n        } catch (e) {\n          return { error: String(e) };\n        }\n      };\n      (window as any).__ndn_camera_debug.videoEl = () =>\n        videoRef.current || null;\n      (window as any).__ndn_camera_debug.stream = () =>\n        cameraSession.getMediaStream?.() || null;\n    } catch (e) {}\n    return () => {\n      try {\n        if ((window as any).__ndn_camera_debug)\n          delete (window as any).__ndn_camera_debug.collect;\n      } catch {}\n    };\n  }, [collectVideoDiagnostics, cameraAccessError, cameraSession]);\n\n  // Match window / pop-out helper: always try to start the camera as soon as possible\n  // Use useLayoutEffect for forceAutoStart to trigger the hardware request\n  // before the first paint, shaving off at least one frame of black screen.\n  useLayoutEffect(() => {\n    if (TEST_MODE) return;\n    if (!forceAutoStart) return;\n\n    // Ensure camera is enabled in state so startCamera doesn't bail\n    try {\n      useUserSettings.getState().setCameraEnabled(true);\n    } catch {}\n\n    const hasAnyStream = !!(cameraSession.getMediaStream?.() || null);\n    if (!hasAnyStream && !streaming && !cameraStarting) {\n      void startCamera();\n    }\n  }, [forceAutoStart]);\n\n  // Safety net / Auto-start local camera when enabled\n  useEffect(() => {\n    if (TEST_MODE) return;\n    if (!cameraEnabled || forceAutoStart) return;\n    if (isPhoneCamera && phoneFeedActive) return;\n    const hasAnyStream = !!(cameraSession.getMediaStream?.() || null);\n    // If there's no stream at all, start it.\n    if (!hasAnyStream && !streaming && !cameraStarting) {\n      try {\n        void startCamera();\n      } catch (e) {}\n    }\n    // If a stale streaming flag exists but no media tracks, reset and retry\n    if (cameraSession.isStreaming && !hasAnyStream && !cameraStarting) {\n      try {\n        cameraSession.setStreaming(false);\n      } catch {}\n      try {\n        void startCamera();\n      } catch (e) {}\n    }\n  }, [\n    cameraEnabled,\n    isPhoneCamera,\n    phoneFeedActive,\n    streaming,\n    cameraStarting,\n    preferredCameraId,\n    forceAutoStart,\n  ]);\n  // Listen for global and window-local \"ndn:start-camera\" events to allow\n  // nested UI components (like the pre-match overlay) to force-trigger\n  // camera initialization if they detect the stream is missing.\n  useEffect(() => {\n    const handler = (ev: any) => {\n      dlog(\"[CAMERA] Received ndn:start-camera event\", ev.detail);\n      try {\n        setCameraEnabled(true);\n      } catch {}\n      if (!streaming && !cameraStarting) {\n        void startCamera();\n      }\n    };\n    window.addEventListener(\"ndn:start-camera\" as any, handler);\n    return () => window.removeEventListener(\"ndn:start-camera\" as any, handler);\n  }, [streaming, cameraStarting, setCameraEnabled]);\n\n  const {\n    H,\n    imageSize,\n    overlaySize,\n    theta,\n    rotationOffsetRad,\n    sectorOffset,\n    _hydrated,\n    locked,\n    errorPx,\n  } = useCalibration();\n\n  // Track calibration changes so we can temporarily relax detector gates right after a new\n  // calibration is applied/locked.\n  const lastCalibrationSigRef = useRef<string>(\"none\");\n\n  // 'matchState' hook: declare early to satisfy hook order and be available for gate checks.\n  // NOTE: Some earlier logic depends on whether we're in an online match.\n  const matchState = useMatch((s) => s);\n  const isOnlineMatch = !!(matchState && (matchState as any).roomId);\n\n  const ERROR_PX_MAX = 12;\n  const CALIBRATION_MIN_CONFIDENCE = 90; // stricter than game-mode minimum; goal is perfect autoscore\n  // Calibration quality gate: if errorPx is missing, treat it as unknown (not zero).\n  // Only allow scoring without errorPx if calibration is explicitly locked.\n  const errorPxVal = typeof errorPx === \"number\" ? errorPx : null;\n  const calibrationConfidence = getGlobalCalibrationConfidence(errorPxVal);\n  const calibrationValid =\n    !!H &&\n    !!imageSize &&\n    (locked ||\n      (errorPxVal != null &&\n        errorPxVal <= ERROR_PX_MAX &&\n        calibrationConfidence != null &&\n        calibrationConfidence >= CALIBRATION_MIN_CONFIDENCE));\n  // Calibration effective gate:\n  // - Online: stay strict (must be valid) to avoid disputes/desync.\n  // - Offline/local: allow scoring as long as we have a mapping (H + imageSize).\n  //   This matches the UX expectation: \"if it sees the dart on a clearly visible board,\n  //   it should count\". We still surface diagnostics if quality is low.\n  const hasCalibration = !!H && !!imageSize;\n  const calibrationValidEffective = isOnlineMatch\n    ? calibrationValid\n    : hasCalibration;\n  useEffect(() => {\n    if (preferredCameraLocked && !hideCameraOverlay) {\n      setHideCameraOverlay(true);\n    }\n  }, [preferredCameraLocked, hideCameraOverlay, setHideCameraOverlay]);\n  const [lastAutoScore, setLastAutoScore] = useState<string>(\"\");\n  const [manualScore, setManualScore] = useState<string>(\"\");\n  const [lastAutoValue, setLastAutoValue] = useState<number>(0);\n  const [lastAutoRing, setLastAutoRing] = useState<Ring>(\"MISS\");\n\n  // Visual aid: briefly emphasize big trebles (T20/T19/T18) after detection.\n  const bigTrebleFlashRef = useRef<{\n    value: 18 | 19 | 20;\n    until: number;\n  } | null>(null);\n\n  // Bounceout tracking:\n  // If a confident candidate is observed but never reaches commit readiness and\n  // then disappears, treat it as a bounceout (MISS).\n  const bounceoutRef = useRef<{\n    pending: boolean;\n    lastSeenTs: number;\n    lastBullDistanceMm: number | null;\n    lastTipVideoPx: Point | null;\n  }>({\n    pending: false,\n    lastSeenTs: 0,\n    lastBullDistanceMm: null,\n    lastTipVideoPx: null,\n  });\n\n  // Offline fallback commit:\n  // In some real-world lighting/camera setups we can see a real dart with very\n  // high confidence, but the tip jitter + motion-settle logic prevents the\n  // normal AUTO_COMMIT_MIN_FRAMES/HOLD_MS gate from ever completing.\n  //\n  // For OFFLINE play only, we track repeated detections of the same scored\n  // result in (roughly) the same place and commit after a short window.\n  const offlineFallbackRef = useRef<{\n    sig: string | null;\n    firstTs: number;\n    lastTs: number;\n    frames: number;\n    lastTip: Point | null;\n  }>({ sig: null, firstTs: 0, lastTs: 0, frames: 0, lastTip: null });\n  const [pendingDarts, setPendingDarts] = useState<number>(0);\n  const pendingDartsRef = useRef<number>(0);\n  const [pendingScore, setPendingScore] = useState<number>(0);\n  const [pendingEntries, setPendingEntries] = useState<\n    {\n      label: string;\n      value: number;\n      ring: Ring;\n      meta?: {\n        calibrationValid?: boolean;\n        pBoard?: Point | null;\n        source?: \"camera\" | \"manual\";\n      };\n    }[]\n  >([]);\n\n  const [showQuitPause, setShowQuitPause] = useState(false);\n  const [forwarding, setForwarding] = useState(false);\n  // Gate manual commits in online matches: if any pending entry came from camera and is not calibration-validated, block commit\n  const commitBlocked =\n    isOnlineMatch &&\n    (pendingEntries as any[]).some(\n      (e) => e.meta && e.meta.source === \"camera\" && !e.meta.calibrationValid,\n    );\n  const [pendingPreOpenDarts, setPendingPreOpenDarts] = useState<number>(0);\n  const [pendingDartsAtDouble, setPendingDartsAtDouble] = useState<number>(0);\n  const [awaitingClear, setAwaitingClear] = useState(false);\n  const pendingCommitRef = useRef<{\n    score: number;\n    darts: number;\n    finished: boolean;\n    meta?: {\n      label?: string;\n      ring?: Ring;\n      entries?: { label: string; value: number; ring: string }[];\n      frame?: string | null;\n    };\n  } | null>(null);\n  const pendingCommitTimerRef = useRef<number | null>(null);\n  // Commit policy:\n  // - Default to wait-for-clear for reliability.\n  // - Only skip waiting when the user/parent explicitly opts into immediate commits.\n  // NOTE: cameraAutoCommit MUST NOT implicitly force immediate commits; that behavior\n  // causes premature/incorrect scoring in real play (especially online/tournaments).\n  const shouldDeferCommit =\n    !immediateAutoCommit && autoCommitMode !== \"immediate\";\n  const [indicatorVersion, setIndicatorVersion] = useState(0);\n  const [indicatorEntryVersions, setIndicatorEntryVersions] = useState<\n    number[]\n  >([]);\n  const autoCandidateRef = useRef<AutoCandidate | null>(null);\n  const detectionLogRef = useRef<DetectionLogEntry[]>([]);\n  const lastAutoCommitRef = useRef<number>(0);\n  const lastCommittedTipRef = useRef<{ tip: Point; ts: number } | null>(null);\n  const committedTipsRef = useRef<Array<{ tip: Point; ts: number }>>([]);\n  const boardLockedRef = useRef<boolean>(false);\n  const boardClearStartRef = useRef<number>(0);\n  const streamingStartMsRef = useRef<number>(0);\n  const detectionArmedRef = useRef<boolean>(false);\n  const detectionArmTimerRef = useRef<number | null>(null);\n  const lastMotionLikeEventAtRef = useRef<number>(0);\n  const lastOfflineThrowAtRef = useRef<number>(\n    process.env.NODE_ENV === \"test\" ? 0 : Number.NEGATIVE_INFINITY,\n  );\n  const tipStabilityRef = useRef<{\n    lastTip: Point | null;\n    stableFrames: number;\n  }>({ lastTip: null, stableFrames: 0 });\n  const detectionStartRef = useRef<number>(0);\n  const detectionDurationFramesRef = useRef<number>(0);\n  const frameCountRef = useRef<number>(0);\n  const tickRef = useRef<(() => void) | null>(null);\n  const [detectionLog, setDetectionLog] = useState<DetectionLogEntry[]>([]);\n  const [lastDetection, setLastDetection] = useState<DetectionLogEntry | null>(\n    null,\n  );\n  const [lastCommit, setLastCommit] = useState<{\n    ts: number;\n    score: number;\n    darts: number;\n    frame?: string | null;\n  } | null>(null);\n  const [_selfTestStatus, setSelfTestStatus] = useState<\n    \"idle\" | \"running\" | \"pass\" | \"fail\"\n  >(\"idle\");\n  const [_selfTestMessage, setSelfTestMessage] = useState<string | null>(null);\n\n  // Diagnostics overlay (hidden by default)\n  // Toggle with Ctrl+Shift+D (or Cmd+Shift+D on Mac).\n  const [showDiagnosticsOverlay, setShowDiagnosticsOverlay] = useState(false);\n  const diagnosticsRef = useRef<{\n    lastTs: number;\n    lastTip?: Point | null;\n    lastPcal?: Point | null;\n    lastPboard?: Point | null;\n    lastConfidence?: number | null;\n    lastLabel?: string | null;\n    lastValue?: number | null;\n    lastRing?: Ring | null;\n    lastReject?: string | null;\n\n    // High-signal gating state\n    detectionArmed?: boolean;\n    paused?: boolean;\n    pendingDarts?: number;\n    frameCount?: number;\n    minFrames?: number;\n    warmupActive?: boolean;\n    inOfflineThrowWindow?: boolean;\n    settled?: boolean;\n    tipStable?: boolean;\n    tipStableFrames?: number;\n    shouldDeferCommit?: boolean;\n    calibrationValidEffective?: boolean;\n\n    // Calibration mapping presence (homography + image size)\n    hasHomography?: boolean;\n    hasImageSize?: boolean;\n    imageSizeStr?: string;\n  }>({ lastTs: 0 });\n  const [, setDiagnosticsTick] = useState(0);\n  const updateDiagnostics = useCallback(\n    (patch: Partial<(typeof diagnosticsRef)[\"current\"]>) => {\n      try {\n        diagnosticsRef.current = {\n          ...diagnosticsRef.current,\n          ...patch,\n          lastTs: Date.now(),\n        };\n        // Lightweight re-render when overlay is open.\n        if (showDiagnosticsOverlay) setDiagnosticsTick((n) => (n + 1) % 100000);\n        try {\n          // Attach a lightweight build/runtime fingerprint so we can confirm\n          // which Netlify deploy is actually running when debugging.\n          (window as any).ndnAutoscoreDiagnostics = {\n            ...diagnosticsRef.current,\n            __build: {\n              // Note: Netlify doesn't automatically inject commit SHA into the\n              // browser bundle unless explicitly configured; keep this stable.\n              clientVersion: \"autoscore-debug/v1\",\n              builtAt: new Date().toISOString(),\n            },\n          };\n        } catch {}\n      } catch {}\n    },\n    [showDiagnosticsOverlay],\n  );\n\n  // Keep diagnostics in sync with calibration state so we can answer the\n  // simple question: \"does the homography exist right now?\" even before any\n  // dart detections happen.\n  useEffect(() => {\n    try {\n      const hasHomographyNow = !!H;\n      const hasImageSizeNow = !!(\n        imageSize &&\n        typeof imageSize.w === \"number\" &&\n        typeof imageSize.h === \"number\" &&\n        imageSize.w > 0 &&\n        imageSize.h > 0\n      );\n      const imageSizeStrNow = hasImageSizeNow\n        ? `${Math.round(imageSize!.w)}x${Math.round(imageSize!.h)}`\n        : \"(none)\";\n      updateDiagnostics({\n        hasHomography: hasHomographyNow,\n        hasImageSize: hasImageSizeNow,\n        imageSizeStr: imageSizeStrNow,\n      });\n    } catch {}\n  }, [H, imageSize, updateDiagnostics]);\n\n  useEffect(() => {\n    const handler = (e: KeyboardEvent) => {\n      try {\n        const key = String(e.key || \"\").toLowerCase();\n        if (key !== \"d\") return;\n        if (!(e.shiftKey && (e.ctrlKey || e.metaKey))) return;\n        e.preventDefault();\n        setShowDiagnosticsOverlay((v) => !v);\n      } catch {}\n    };\n    window.addEventListener(\"keydown\", handler);\n    return () => window.removeEventListener(\"keydown\", handler);\n  }, []);\n\n  // If a detection is below the confidence threshold and confirm is enabled,\n  // hold it for user confirmation instead of immediately applying it.\n  const [pendingConfirm, setPendingConfirm] = useState<null | {\n    label: string;\n    value: number;\n    ring: Ring;\n    confidence: number;\n    meta?: any;\n  }>(null);\n\n  // When a dart is registered (auto or manual), show a short-lived marker on\n  // the overlay so the user can visually confirm where the system counted it.\n  const [registeredTip, setRegisteredTip] = useState<{\n    x: number;\n    y: number;\n    expires: number;\n  } | null>(null);\n\n  // Persistent markers for the current visit (sticky ?? emojis)\n  const [visitMarkers, setVisitMarkers] = useState<\n    Array<{ x: number; y: number; label: string }>\n  >([]);\n\n  // When a visit is committed, show a short transient flash on the overlay\n  // so the operator can confirm the visit was forwarded to scoring.\n  const [commitFlash, setCommitFlash] = useState<{\n    score: number;\n    darts: number;\n    expires: number;\n  } | null>(null);\n\n  const maybeHoldForConfirmation = useCallback(\n    (payload: {\n      value: number;\n      label: string;\n      ring: Ring;\n      confidence?: number;\n      meta?: any;\n    }) => {\n      try {\n        if (!confirmUncertainDarts) return false;\n        if (pendingConfirm) return true;\n        const conf = Number(payload.confidence);\n        if (!isFinite(conf)) return false;\n        const effectiveThreshold = Math.max(\n          0.5,\n          Math.min(\n            0.99,\n            Number(autoScoreConfidenceThreshold) || AUTO_COMMIT_CONFIDENCE,\n          ),\n        );\n        if (conf >= effectiveThreshold) return false;\n        setPendingConfirm({\n          label: payload.label,\n          value: payload.value,\n          ring: payload.ring,\n          confidence: conf,\n          meta: payload.meta,\n        });\n        return true;\n      } catch {\n        return false;\n      }\n    },\n    [\n      confirmUncertainDarts,\n      pendingConfirm,\n      autoScoreConfidenceThreshold,\n      setPendingConfirm,\n    ],\n  );\n\n  // Bull-up-only gate: when CameraView is used in custom mode for bull-up,\n  // only the first dart should count. Any further darts are void.\n  //\n  // We implement this entirely inside CameraView so it applies to Offline,\n  // Online, and Tournament flows that reuse the same component.\n  const bullUpFirstDartTakenRef = useRef(false);\n  useEffect(() => {\n    // Reset when switching scoring modes (or remount).\n    bullUpFirstDartTakenRef.current = false;\n  }, [scoringMode]);\n  const clearPendingCommitTimer = useCallback(() => {\n    if (pendingCommitTimerRef.current) {\n      clearTimeout(pendingCommitTimerRef.current);\n      pendingCommitTimerRef.current = null;\n    }\n  }, []);\n\n  const clampCameraScale = useCallback((value: number) => {\n    if (typeof value !== \"number\" || Number.isNaN(value)) return 1;\n    return Math.min(1.25, Math.max(0.5, Math.round(value * 100) / 100));\n  }, []);\n\n  const adjustCameraScale = useCallback(\n    (delta: number) => {\n      if (!setCameraScale) return;\n      const next = clampCameraScale((cameraScale ?? 1) + delta);\n      setCameraScale(next);\n    },\n    [cameraScale, clampCameraScale, setCameraScale],\n  );\n\n  const setFullPreview = useCallback(() => {\n    if (setCameraFitMode) setCameraFitMode(\"fill\");\n    if (setCameraAspect) setCameraAspect(\"wide\");\n  }, [setCameraFitMode, setCameraAspect]);\n\n  const setWidePreview = useCallback(() => {\n    if (setCameraFitMode) setCameraFitMode(\"fit\");\n    if (setCameraAspect) setCameraAspect(\"wide\");\n  }, [setCameraFitMode, setCameraAspect]);\n\n  // Compact rendering path is built later (after dependent callbacks) to avoid TDZ issues.\n\n  useImperativeHandle(ref, () => ({\n    runDetectionTick: () => {\n      try {\n        if (tickRef.current) tickRef.current();\n      } catch (e) {}\n    },\n    // Expose a test-only direct dart add method so tests can deterministically\n    // exercise addDart and commit logic without depending on CV timing or detection.\n    __test_addDart:\n      process.env.NODE_ENV === \"test\"\n        ? (\n            v: number,\n            l: string,\n            r: Ring,\n            meta?: any,\n            opts?: { emulateApplyAutoHit?: boolean },\n          ) => {\n            try {\n              // Mimic the detection/ack path: notify parent synchronously and allow\n              // it to ACK ownership (return true) to prevent the local commit path.\n              let skipLocalCommit = false;\n              try {\n                if (onAutoDart) {\n                  const mult =\n                    r === \"TRIPLE\"\n                      ? 3\n                      : r === \"DOUBLE\"\n                        ? 2\n                        : r === \"MISS\"\n                          ? 0\n                          : 1;\n                  const pSig = `${v}|${r}|${mult}`;\n                  const pNow = performance.now();\n                  if (\n                    !(\n                      pSig === lastParentSigRef.current &&\n                      pNow - lastParentSigAtRef.current <\n                        AUTO_COMMIT_COOLDOWN_MS\n                    )\n                  ) {\n                    const maybe = onAutoDart(v, r, {\n                      sector: null,\n                      mult: mult as 0 | 1 | 2 | 3,\n                      calibrationValid: true,\n                      pBoard: meta?.pBoard ?? null,\n                    });\n                    if (maybe === true) {\n                      lastParentSigRef.current = pSig;\n                      lastParentSigAtRef.current = pNow;\n                      skipLocalCommit = true;\n                    }\n                  }\n                }\n              } catch (e) {\n                /* swallow */\n              }\n\n              if (!skipLocalCommit) {\n                // If test provides a confidence for a camera-sourced dart and confirmation\n                // mode is on, route into the confirm modal instead of applying.\n                try {\n                  const conf = meta?.confidence;\n                  const src = meta?.source;\n                  if (\n                    src === \"camera\" &&\n                    maybeHoldForConfirmation({\n                      value: v,\n                      label: l,\n                      ring: r,\n                      confidence: conf,\n                      meta: meta,\n                    })\n                  ) {\n                    return;\n                  }\n                } catch {}\n\n                // Keep test helper deterministic: always add to pending, and let each\n                // unit test decide whether/when a visit commit should happen.\n                //\n                // We still emulate dedupe/in-flight locking when requested so tests\n                // can validate \"no double-commit\" behavior without relying on timing.\n                if (opts?.emulateApplyAutoHit) {\n                  const mult =\n                    r === \"TRIPLE\"\n                      ? 3\n                      : r === \"DOUBLE\"\n                        ? 2\n                        : r === \"MISS\"\n                          ? 0\n                          : 1;\n                  const sig = `${v}|${r}|${mult}`;\n                  const now = performance.now();\n                  if (inFlightAutoCommitRef.current) return;\n                  inFlightAutoCommitRef.current = true;\n                  try {\n                    window.setTimeout(\n                      () => {\n                        inFlightAutoCommitRef.current = false;\n                      },\n                      Math.max(120, AUTO_COMMIT_COOLDOWN_MS),\n                    );\n                  } catch (e) {}\n                  if (\n                    now - lastAutoSigAtRef.current < AUTO_COMMIT_COOLDOWN_MS &&\n                    sig === lastAutoSigRef.current\n                  )\n                    return;\n                  lastAutoSigRef.current = sig;\n                  lastAutoSigAtRef.current = now;\n                }\n\n                try {\n                  addDart(v, l, r, meta);\n                } catch (e) {\n                  /* ignore */\n                }\n              }\n            } catch (e) {}\n          }\n        : undefined,\n    __test_commitVisit:\n      process.env.NODE_ENV === \"test\"\n        ? () => {\n            try {\n              onCommitVisit();\n            } catch (e) {}\n          }\n        : undefined,\n    runSelfTest: async () => {\n      try {\n        return await runSelfTest();\n      } catch (e) {\n        return false;\n      }\n    },\n    __test_forceSetPendingVisit:\n      process.env.NODE_ENV === \"test\"\n        ? (entries: Array<{ label: string; value: number; ring: Ring }>) => {\n            try {\n              const safe = (entries || []).slice(0, 3);\n              const darts = safe.length;\n              const total = safe.reduce(\n                (sum, e) => sum + (Number((e as any)?.value) || 0),\n                0,\n              );\n              setPendingEntries(\n                safe.map((e) => ({\n                  ...e,\n                  meta: {\n                    calibrationValid: true,\n                    pBoard: null,\n                    source: \"camera\",\n                  },\n                })) as any,\n              );\n              setPendingDarts(darts);\n              pendingDartsRef.current = darts;\n              setPendingScore(total);\n              try {\n                usePendingVisit.getState().setVisit(safe as any, darts, total);\n              } catch (e) {}\n            } catch (e) {}\n          }\n        : undefined,\n  }));\n\n  const captureDetectionLog = useCallback((entry: DetectionLogEntry) => {\n    try {\n      const f = captureFrame();\n      if (f) entry.frame = f;\n    } catch (e) {}\n    const next = [...detectionLogRef.current.slice(-8), entry];\n    detectionLogRef.current = next;\n    setDetectionLog(next);\n    try {\n      setLastDetection(entry);\n    } catch (e) {}\n    try {\n      (window as any).ndnCameraDiagnostics = next;\n    } catch (e) {}\n  }, []);\n\n  // Play a short bell sound using WebAudio if available. No-op in test env.\n  const playBell = useCallback(() => {\n    try {\n      const Ctx =\n        (window as any).AudioContext || (window as any).webkitAudioContext;\n      if (!Ctx) return;\n      const ctx = new Ctx();\n      const o = ctx.createOscillator();\n      const g = ctx.createGain();\n      o.type = \"sine\";\n      o.frequency.value = 1000;\n      g.gain.value = 0.0015;\n      o.connect(g);\n      g.connect(ctx.destination);\n      o.start();\n      setTimeout(() => {\n        try {\n          o.stop();\n          ctx.close?.();\n        } catch (e) {}\n      }, 120);\n    } catch (e) {}\n  }, []);\n\n  // Run a self-test: run a few detection ticks and look for an accepted/ready detection\n  const runSelfTest = useCallback(async () => {\n    try {\n      setSelfTestStatus(\"running\");\n      setSelfTestMessage(null);\n      // clear recent detections\n      detectionLogRef.current = [];\n      setDetectionLog([]);\n      // run a few ticks spaced out\n      const tries = 6;\n      for (let i = 0; i < tries; i++) {\n        try {\n          if (tickRef.current) tickRef.current();\n        } catch (e) {}\n        // wait a bit\n        // eslint-disable-next-line no-await-in-loop\n        await new Promise((r) => setTimeout(r, 180));\n      }\n      const logs = detectionLogRef.current.slice();\n      const ok = logs.some(\n        (e) =>\n          e.accepted ||\n          (e.ready &&\n            e.confidence >=\n              (autoScoreConfidenceThreshold ?? AUTO_COMMIT_CONFIDENCE)),\n      );\n      if (ok) {\n        setSelfTestStatus(\"pass\");\n        setSelfTestMessage(\"Detection OK\");\n      } else {\n        setSelfTestStatus(\"fail\");\n        setSelfTestMessage(\n          logs.length\n            ? `No accepted detections (best confidence ${(logs[logs.length - 1].confidence || 0).toFixed(2)})`\n            : \"No detections\",\n        );\n      }\n    } catch (e) {\n      setSelfTestStatus(\"fail\");\n      setSelfTestMessage(\"Self-test error\");\n    } finally {\n      // reset to idle after a short delay so the UI can rerun\n      setTimeout(() => setSelfTestStatus(\"idle\"), 3000);\n    }\n  }, [autoScoreConfidenceThreshold]);\n  const captureFrame = useCallback((): string | null => {\n    try {\n      const v = videoRef.current as HTMLVideoElement | null;\n      if (!v || !v.videoWidth || !v.videoHeight) return null;\n      const w = 640;\n      const h = Math.round((v.videoHeight / v.videoWidth) * w) || 360;\n      const c = document.createElement(\"canvas\");\n      c.width = w;\n      c.height = h;\n      const ctx = c.getContext(\"2d\");\n      if (!ctx) return null;\n      ctx.drawImage(v, 0, 0, w, h);\n      return c.toDataURL(\"image/jpeg\", 0.5);\n    } catch (e) {\n      return null;\n    }\n  }, []);\n\n  const finalizePendingCommit = useCallback(\n    (_trigger: \"event\" | \"timeout\" | \"teardown\") => {\n      const pending = pendingCommitRef.current;\n      if (!pending) return;\n      pendingCommitRef.current = null;\n      clearPendingCommitTimer();\n      setAwaitingClear(false);\n      setVisitMarkers([]);\n\n      // Voice announcements happen at the commit boundary (never per-dart).\n      // 1) Speak the latest bull distance (mm) for this visit, if available.\n      // 2) Speak the final 3-dart visit total.\n      try {\n        const maybeEntries = (pending.meta as any)?.entries as\n          | Array<{ meta?: { bullDistanceMm?: number } }>\n          | undefined;\n        const lastBull =\n          maybeEntries?.[maybeEntries.length - 1]?.meta?.bullDistanceMm;\n        sayBullDistanceMm(lastBull);\n      } catch {}\n      /* sayVisitTotal called immediately in addDart for snappy feedback */\n\n      if (onVisitCommitted) {\n        try {\n          onVisitCommitted(\n            pending.score,\n            pending.darts,\n            pending.finished,\n            pending.meta,\n          );\n          try {\n            // Notify other windows that a visit was committed\n            broadcastMessage({\n              type: \"visit\",\n              score: pending.score,\n              darts: pending.darts,\n              finished: pending.finished,\n              meta: pending.meta,\n              playerIdx: matchState.currentPlayerIdx,\n              ts: Date.now(),\n            });\n            // Also write a full snapshot so remote windows can fully reconstruct state\n            try {\n              writeMatchSnapshot();\n            } catch (e) {}\n            try {\n              const f = captureFrame();\n              setLastCommit({\n                ts: Date.now(),\n                score: pending.score,\n                darts: pending.darts,\n                frame: f,\n              });\n            } catch (e) {}\n          } catch (e) {}\n        } catch (e) {}\n      }\n    },\n    [onVisitCommitted, clearPendingCommitTimer],\n  );\n  const enqueueVisitCommit = useCallback(\n    (payload: {\n      score: number;\n      darts: number;\n      finished: boolean;\n      meta?: {\n        label?: string;\n        ring?: Ring;\n        entries?: { label: string; value: number; ring: string }[];\n        frame?: string | null;\n      };\n    }) => {\n      if (!onVisitCommitted) return;\n      if (!shouldDeferCommit) {\n        // Same announcements in immediate mode.\n        try {\n          const maybeEntries = (payload.meta as any)?.entries as\n            | Array<{ meta?: { bullDistanceMm?: number } }>\n            | undefined;\n          const lastBull =\n            maybeEntries?.[maybeEntries.length - 1]?.meta?.bullDistanceMm;\n          sayBullDistanceMm(lastBull);\n        } catch {}\n        try {\n          sayVisitTotal(payload.score);\n        } catch {}\n        try {\n          onVisitCommitted(\n            payload.score,\n            payload.darts,\n            payload.finished,\n            payload.meta,\n          );\n        } catch (e) {}\n        return;\n      }\n      pendingCommitRef.current = payload;\n      setAwaitingClear(true);\n      clearPendingCommitTimer();\n      pendingCommitTimerRef.current = window.setTimeout(\n        () => finalizePendingCommit(\"timeout\"),\n        BOARD_CLEAR_GRACE_MS,\n      );\n    },\n    [\n      onVisitCommitted,\n      shouldDeferCommit,\n      clearPendingCommitTimer,\n      finalizePendingCommit,\n      sayBullDistanceMm,\n      sayVisitTotal,\n    ],\n  );\n  const clearPendingManual = useCallback((reason: \"indicator\" | \"toolbar\") => {\n    setPendingDarts(0);\n    pendingDartsRef.current = 0;\n    setPendingScore(0);\n    setPendingEntries([]);\n    setVisitMarkers([]);\n    setPendingPreOpenDarts(0);\n    setPendingDartsAtDouble(0);\n    setHadRecentAuto(false);\n    try {\n      window.dispatchEvent(\n        new CustomEvent(\"ndn:clear-visit-request\", {\n          detail: { source: \"camera-view\", reason, ts: Date.now() },\n        }),\n      );\n    } catch (e) {}\n  }, []);\n  useEffect(() => {\n    if (!shouldDeferCommit) return;\n    const handler = () => finalizePendingCommit(\"event\");\n    window.addEventListener(\"ndn:darts-cleared\", handler as EventListener);\n    return () =>\n      window.removeEventListener(\"ndn:darts-cleared\", handler as EventListener);\n  }, [shouldDeferCommit, finalizePendingCommit]);\n  useEffect(() => {\n    if (!shouldDeferCommit) finalizePendingCommit(\"timeout\");\n  }, [shouldDeferCommit, finalizePendingCommit]);\n  useEffect(\n    () => () => finalizePendingCommit(\"teardown\"),\n    [finalizePendingCommit],\n  );\n  const handleIndicatorReset = useCallback(() => {\n    clearPendingManual(\"indicator\");\n    setIndicatorVersion((v) => v + 1);\n  }, [clearPendingManual]);\n  const handleToolbarClear = useCallback(() => {\n    if (pendingDarts === 0 && pendingScore === 0) return;\n    clearPendingManual(\"toolbar\");\n    setIndicatorVersion((v) => v + 1);\n  }, [clearPendingManual, pendingDarts, pendingScore]);\n  const requestDeviceManager = useCallback(() => {\n    if (manualOnly) return;\n    try {\n      window.dispatchEvent(\n        new CustomEvent(\"ndn:open-camera-manager\", {\n          detail: { source: \"camera-view\", ts: Date.now() },\n        }),\n      );\n    } catch (err) {\n      console.warn(\"[CameraView] Failed to request camera manager:\", err);\n    }\n  }, [manualOnly]);\n  // X01 Double-In handling: per-player opened state in this session\n  const x01DoubleInSetting = useUserSettings((s) => s.x01DoubleIn);\n  const x01DoubleIn =\n    typeof x01DoubleInOverride === \"boolean\"\n      ? !!x01DoubleInOverride\n      : !!x01DoubleInSetting;\n  const [openedById, setOpenedById] = useState<Record<string, boolean>>({});\n  // 'matchState' is intentionally declared above to satisfy hook order.\n  const currentPlayerId = matchState.players[matchState.currentPlayerIdx]?.id;\n  const isOpened = !!(currentPlayerId && openedById[currentPlayerId]);\n  const setOpened = (v: boolean) => {\n    if (!currentPlayerId) return;\n    setOpenedById((m) => ({ ...m, [currentPlayerId]: v }));\n  };\n  const inProgress = (matchState as any)?.inProgress;\n  // Broadcast pending visit to global store so Scoreboard can visualize dots\n  const setVisit = usePendingVisit((s) => s.setVisit);\n  const resetPendingVisit = usePendingVisit((s) => s.reset);\n  useEffect(() => {\n    try {\n      setVisit(pendingEntries as any, pendingDarts, pendingScore);\n      if (TEST_MODE) return;\n      // Broadcast pending visit so remote windows can visualise per-dart hits in near realtime.\n      try {\n        const msg: any = {\n          type: \"pendingVisit\",\n          entries: pendingEntries,\n          darts: pendingDarts,\n          total: pendingScore,\n          playerIdx: matchState.currentPlayerIdx,\n          ts: Date.now(),\n        };\n        // attempt to include a small thumbnail of the camera if available (throttled)\n        try {\n          const v = videoRef.current as HTMLVideoElement | null;\n          if (v && v.videoWidth && v.videoHeight) {\n            const w = 320;\n            const h = Math.round((v.videoHeight / v.videoWidth) * w) || 180;\n            const c = document.createElement(\"canvas\");\n            c.width = w;\n            c.height = h;\n            const ctx = c.getContext(\"2d\");\n            if (ctx) {\n              ctx.drawImage(v, 0, 0, w, h);\n              try {\n                msg.frame = c.toDataURL(\"image/jpeg\", 0.45);\n              } catch (e) {}\n            }\n          }\n        } catch (e) {}\n        broadcastMessage(msg);\n      } catch (e) {}\n    } catch (e) {}\n  }, [pendingEntries, pendingDarts, pendingScore, setVisit]);\n  useEffect(\n    () => () => {\n      try {\n        resetPendingVisit();\n      } catch (e) {}\n    },\n    [resetPendingVisit],\n  );\n  const addVisit = useMatch((s) => s.addVisit);\n  const endLeg = useMatch((s) => s.endLeg);\n  // Helper: convert the current pendingEntries into a minimal, serializable\n  // per-dart breakdown that can be stored with the committed visit.\n  const snapshotPendingDartEntries = useCallback((entries: any[]) => {\n    try {\n      if (!Array.isArray(entries)) return undefined;\n      return entries.slice(0, 3).map((e) => ({\n        label: String(e?.label ?? \"\"),\n        value: Number(e?.value ?? 0),\n        ring: String(e?.ring ?? \"\"),\n      }));\n    } catch {\n      return undefined;\n    }\n  }, []);\n  // Prefer provided adapters (matchActions wrappers) when available\n  const callAddVisit = (score: number, darts: number, meta?: any) => {\n    try {\n      dlog(\"CameraView: callAddVisit\", score, darts, meta);\n      try {\n        setCommitFlash({ score, darts, expires: Date.now() + 2000 });\n      } catch (e) {}\n      if (onAddVisit) onAddVisit(score, darts, meta);\n      else addVisit(score, darts, meta);\n      try {\n        // Broadcast immediate committed visit to remote windows and update snapshot\n        broadcastMessage({\n          type: \"visit\",\n          score,\n          darts,\n          playerIdx: matchState.currentPlayerIdx,\n          ts: Date.now(),\n        });\n        try {\n          writeMatchSnapshot();\n        } catch (e) {}\n      } catch (e) {}\n    } catch {\n      /* noop */\n    }\n  };\n  const callEndLeg = (score?: number) => {\n    try {\n      if (onEndLeg) onEndLeg(score);\n      else endLeg(typeof score === \"number\" ? score : 0);\n    } catch {\n      /* noop */\n    }\n  };\n  // Quick entry dropdown selections\n  const [quickSelManual, setQuickSelManual] = useState(\"\");\n  const [nonRegCount, setNonRegCount] = useState(0);\n  const [, setShowRecalModal] = useState(false);\n  const [hadRecentAuto, setHadRecentAuto] = useState(false);\n  const [_pulseManualPill, setPulseManualPill] = useState(false);\n  const [activeTab, setActiveTab] = useState<\"auto\" | \"manual\">(\"manual\");\n  const [showManualModal, setShowManualModal] = useState(false);\n  const [, setShowAutoModal] = useState(false);\n  const [showScoringModal, setShowScoringModal] = useState(false);\n  const manualPreviewRef = useRef<HTMLCanvasElement | null>(null);\n  // Dart timer\n  const dartTimerEnabled = useUserSettings((s) => s.dartTimerEnabled);\n  const dartTimerSeconds = useUserSettings((s) => s.dartTimerSeconds) || 10;\n  const [dartTimeLeft, setDartTimeLeft] = useState<number | null>(null);\n  const timerRef = useRef<number | null>(null);\n  const paused = useMatchControl((s) => s.paused);\n  // Built-in CV detector\n  const detectorRef = useRef<DartDetector | null>(null);\n  const rafRef = useRef<number | null>(null);\n  const lastProcessedRef = useRef<number>(0);\n  const lastAutoSigRef = useRef<string | null>(null);\n  const lastAutoSigAtRef = useRef<number>(0);\n  const lastParentSigRef = useRef<string | null>(null);\n  const lastParentSigAtRef = useRef<number>(0);\n  const inFlightAutoCommitRef = useRef<boolean>(false);\n  const pulseTimeoutRef = useRef<number | null>(null);\n  const [detectorSeedVersion] = useState(0);\n  const handlePhoneReconnect = useCallback(() => {\n    try {\n      window.dispatchEvent(\n        new CustomEvent(\"ndn:phone-camera-reconnect\", {\n          detail: { source: \"camera-view\", ts: Date.now() },\n        }),\n      );\n    } catch (err) {\n      console.warn(\"[CameraView] Phone camera reconnect dispatch failed:\", err);\n    }\n  }, []);\n  // Open Autoscore modal from parent via global event\n  useEffect(() => {\n    if (!autoscoreEnabled) return;\n    const onOpen = () => {\n      if (!manualOnly) setShowAutoModal(true);\n    };\n    window.addEventListener(\"ndn:open-autoscore\" as any, onOpen);\n    return () =>\n      window.removeEventListener(\"ndn:open-autoscore\" as any, onOpen);\n  }, [autoscoreEnabled, manualOnly]);\n\n  // cleanup pulse timer on unmount\n  useEffect(() => {\n    return () => {\n      try {\n        if (pulseTimeoutRef.current) clearTimeout(pulseTimeoutRef.current);\n      } catch (e) {}\n    };\n  }, []);\n\n  // Open Scoring (Camera + Pending Visit) modal from parent via global event\n  useEffect(() => {\n    const onOpen = () => setShowScoringModal(true);\n    window.addEventListener(\"ndn:open-scoring\" as any, onOpen);\n    return () => window.removeEventListener(\"ndn:open-scoring\" as any, onOpen);\n  }, []);\n\n  useEffect(() => {\n    const onDartsCleared = () => {\n      setIndicatorVersion((v) => v + 1);\n      setPendingDarts(0);\n      pendingDartsRef.current = 0;\n      setPendingScore(0);\n      setPendingEntries([]);\n      setVisitMarkers([]);\n      setPendingPreOpenDarts(0);\n      setPendingDartsAtDouble(0);\n      setHadRecentAuto(false);\n    };\n    window.addEventListener(\n      \"ndn:darts-cleared\",\n      onDartsCleared as EventListener,\n    );\n    return () =>\n      window.removeEventListener(\n        \"ndn:darts-cleared\",\n        onDartsCleared as EventListener,\n      );\n  }, []);\n\n  useEffect(() => {\n    setIndicatorEntryVersions((prev) => {\n      if (pendingEntries.length > prev.length) {\n        const diff = pendingEntries.length - prev.length;\n        return [...prev, ...Array(diff).fill(indicatorVersion)];\n      }\n      if (pendingEntries.length < prev.length) {\n        return prev.slice(0, pendingEntries.length);\n      }\n      return prev;\n    });\n  }, [pendingEntries, indicatorVersion]);\n\n  useEffect(() => {\n    if (detectionArmTimerRef.current) {\n      clearTimeout(detectionArmTimerRef.current);\n      detectionArmTimerRef.current = null;\n    }\n    if (manualOnly) {\n      detectionArmedRef.current = false;\n      streamingStartMsRef.current = 0;\n      autoCandidateRef.current = null;\n      return;\n    }\n    if (effectiveStreaming) {\n      streamingStartMsRef.current = performance.now();\n      autoCandidateRef.current = null;\n      detectionArmedRef.current = false;\n      frameCountRef.current = 0;\n      detectionArmTimerRef.current = window.setTimeout(() => {\n        detectionArmedRef.current = true;\n        detectionArmTimerRef.current = null;\n      }, DETECTION_ARM_DELAY_MS);\n    } else {\n      streamingStartMsRef.current = 0;\n      autoCandidateRef.current = null;\n      detectionArmedRef.current = false;\n      frameCountRef.current = 0;\n    }\n    return () => {\n      if (detectionArmTimerRef.current) {\n        clearTimeout(detectionArmTimerRef.current);\n        detectionArmTimerRef.current = null;\n      }\n      detectionArmedRef.current = false;\n      frameCountRef.current = 0;\n      tickRef.current = null;\n    };\n  }, [effectiveStreaming, manualOnly]);\n\n  // Enumerate devices on mount and when devices change so USB webcams appear quickly\n  useEffect(() => {\n    let mounted = true;\n    async function refresh() {\n      try {\n        if (!navigator?.mediaDevices?.enumerateDevices) return;\n        const list = await navigator.mediaDevices.enumerateDevices();\n        if (!mounted) return;\n        setAvailableCameras(list.filter((d) => d.kind === \"videoinput\"));\n      } catch (err) {\n        console.warn(\"[CAMERA] enumerateDevices failed:\", err);\n      }\n    }\n    refresh();\n    try {\n      navigator.mediaDevices.addEventListener(\"devicechange\", refresh);\n    } catch {\n      try {\n        (navigator.mediaDevices as any).ondevicechange = refresh;\n      } catch (e) {}\n    }\n    return () => {\n      mounted = false;\n      try {\n        navigator.mediaDevices.removeEventListener(\"devicechange\", refresh);\n      } catch (e) {}\n    };\n  }, []);\n\n  // Allow parent to open/close the manual modal via global events\n  useEffect(() => {\n    const onOpen = () => {\n      setActiveTab(\"manual\");\n      setShowManualModal(true);\n    };\n    const onClose = () => {\n      setActiveTab(\"manual\");\n      setShowManualModal(false);\n    };\n    window.addEventListener(\"ndn:open-manual\" as any, onOpen);\n    window.addEventListener(\"ndn:close-manual\" as any, onClose);\n    return () => {\n      window.removeEventListener(\"ndn:open-manual\" as any, onOpen);\n      window.removeEventListener(\"ndn:close-manual\" as any, onClose);\n    };\n  }, []);\n\n  useEffect(() => {\n    if (manualOnly) {\n      setActiveTab(\"manual\");\n      setShowAutoModal(false);\n    }\n  }, [manualOnly]);\n\n  // Reset open state at the start of a leg (no darts thrown yet), keep across visits within leg\n  useEffect(() => {\n    try {\n      const p = matchState.players[matchState.currentPlayerIdx];\n      const leg = p?.legs?.[p.legs.length - 1];\n      if (!p) return;\n      if (!leg || leg.dartsThrown === 0) {\n        setOpenedById((m) => ({ ...m, [p.id]: false }));\n      }\n    } catch (e) {}\n  }, [\n    matchState.currentPlayerIdx,\n    matchState.players?.[matchState.currentPlayerIdx]?.legs?.length,\n  ]);\n\n  // Manage per-dart timer lifecycle\n  useEffect(() => {\n    if (TEST_MODE) {\n      // TEST_MODE: no-op (keep timers clean)\n      if (timerRef.current) {\n        clearInterval(timerRef.current as any);\n        timerRef.current = null;\n      }\n      setDartTimeLeft(null);\n      return;\n    }\n    const shouldRun =\n      !!dartTimerEnabled && inProgress && !paused && pendingDarts < 3;\n    // Clear any existing interval\n    if (timerRef.current) {\n      clearInterval(timerRef.current as any);\n      timerRef.current = null;\n    }\n    if (!shouldRun) {\n      setDartTimeLeft(null);\n      return;\n    }\n    // Reset timer each time dependencies change (new dart, player change, setting change)\n    setDartTimeLeft(dartTimerSeconds);\n    timerRef.current = window.setInterval(() => {\n      setDartTimeLeft((prev) => {\n        const next = (prev ?? dartTimerSeconds) - 1;\n        if (next <= 0) {\n          // Time expired: guarantee the visit completes to 3 darts by auto-filling\n          // the remaining darts as MISS. This keeps gameplay moving even when the\n          // camera misses a dart or the player pauses.\n          try {\n            const already = pendingDartsRef.current || 0;\n            const remaining = Math.max(0, 3 - already);\n            for (let i = 0; i < remaining; i++) {\n              addDart(0, \"MISS 0\", \"MISS\");\n            }\n          } catch (e) {}\n          // Stop interval until effect re-initializes on state change\n          if (timerRef.current) {\n            clearInterval(timerRef.current as any);\n            timerRef.current = null;\n          }\n          return 0;\n        }\n        return next;\n      });\n    }, 1000) as any;\n    return () => {\n      if (timerRef.current) {\n        clearInterval(timerRef.current as any);\n        timerRef.current = null;\n      }\n    };\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [\n    dartTimerEnabled,\n    dartTimerSeconds,\n    pendingDarts,\n    matchState.currentPlayerIdx,\n    (matchState as any)?.inProgress,\n    paused,\n  ]);\n\n  // Drive a lightweight live preview inside the manual modal from the main video element\n  useEffect(() => {\n    if (TEST_MODE || !showManualModal) return;\n    const id = setInterval(() => {\n      try {\n        const v = videoRef.current;\n        const c = manualPreviewRef.current;\n        if (!v || !c) return;\n        // In test env and certain fallback cases the video element may not have\n        // intrinsic dimensions; use calibration image size as a fallback so\n        // detection can proceed in the JSDOM test harness.\n        const vw =\n          v.videoWidth ||\n          (process.env.NODE_ENV === \"test\" ? (imageSize?.w ?? 0) : 0);\n        const vh =\n          v.videoHeight ||\n          (process.env.NODE_ENV === \"test\" ? (imageSize?.h ?? 0) : 0);\n        if (!vw || !vh) return;\n        const cw = c.clientWidth || 640;\n        const ch = c.clientHeight || 360;\n        const dpr = Math.max(\n          1,\n          Math.round(((window.devicePixelRatio as number) || 1) * 100) / 100,\n        );\n        // DPR-aware backing store so the preview isn't blurry on high-DPI screens\n        const bw = Math.floor(cw * dpr);\n        const bh = Math.floor(ch * dpr);\n        if (c.width !== bw) c.width = bw;\n        if (c.height !== bh) c.height = bh;\n        const ctx = c.getContext(\"2d\");\n        if (!ctx) return;\n        ctx.imageSmoothingEnabled = true;\n        try {\n          ctx.setTransform(dpr, 0, 0, dpr, 0, 0);\n        } catch {}\n        // Letterbox fit\n        const scale = Math.min(cw / vw, ch / vh);\n        const dw = Math.round(vw * scale);\n        const dh = Math.round(vh * scale);\n        const dx = Math.floor((cw - dw) / 2);\n        const dy = Math.floor((ch - dh) / 2);\n        ctx.fillStyle = \"#000\";\n        ctx.fillRect(0, 0, cw, ch);\n        ctx.drawImage(v, dx, dy, dw, dh);\n      } catch (e) {\n        // Silently ignore preview update errors\n        console.warn(\"Manual preview update error:\", e);\n      }\n    }, 120);\n    return () => clearInterval(id);\n  }, [showManualModal]);\n\n  useEffect(() => {\n    // Do not auto-stop the camera when the view unmounts. We want the camera stream\n    // to persist across navigation so calibration and pairing aren't lost when switching\n    // between Offline/Online/Tournaments. This keeps the global cameraSession's\n    // mediaStream active and allows other views to reuse it.\n    return () => {\n      // intentionally no-op: camera continues running in global session\n    };\n  }, []);\n\n  const canFallbackToLocal = isPhoneCamera && !phoneFeedActive;\n\n  async function startCamera() {\n    const existingStream =\n      (cameraSession.getMediaStream?.() as MediaStream | null) ||\n      ((videoRef.current?.srcObject as MediaStream | null) ?? null);\n    const hasActiveTracks = (() => {\n      try {\n        const anyStream: any = existingStream as any;\n        if (!anyStream) return false;\n        const fn = anyStream.getVideoTracks;\n        if (typeof fn !== \"function\") return false;\n        return !!fn.call(anyStream)?.length;\n      } catch {\n        return false;\n      }\n    })();\n    if (cameraStarting || (streaming && hasActiveTracks)) return;\n\n    // Only skip local startup when the phone feed is actively streaming\n    if (isPhoneCamera && phoneFeedActive) {\n      const phoneTracks = existingStream?.getVideoTracks?.() || [];\n      const phoneActive = phoneTracks.some((t) => t.readyState === \"live\");\n      if (phoneActive) {\n        dlog(\"[CAMERA] Phone camera stream active - leaving local camera idle\");\n        setCameraStarting(false);\n        try {\n          cameraSession.setStarting?.(false);\n        } catch {}\n        return;\n      }\n      // If flagged active but no live tracks, fall back to local camera startup\n      dlog(\n        \"[CAMERA] Phone feed flagged active but no live tracks; starting local camera\",\n      );\n    }\n\n    setCameraStarting(true);\n    try {\n      cameraSession.setStarting?.(true);\n    } catch {}\n    dlog(\"[CAMERA] Starting camera...\");\n    try {\n      setCameraAccessError(null);\n    } catch {}\n\n    // Best-effort anti-glare hints. These are optional constraints; many browsers/devices\n    // ignore them. If they fail, we just proceed with the stream as-is.\n    const applyAntiGlare = async (track: MediaStreamTrack | undefined) => {\n      if (!track) return;\n      // Only video tracks support these constraint keys.\n      if (track.kind !== \"video\") return;\n\n      // Only apply camera-track constraints when the user opted into\n      // harsh lighting mode OR the legacy localStorage flag is enabled.\n      const enabled =\n        harshLightingMode ||\n        (typeof window !== \"undefined\" &&\n          window.localStorage?.getItem(\"ndn.glareClamp\") === \"1\");\n      if (!enabled) return;\n      const caps: any = (track as any).getCapabilities?.() || {};\n      const supports = (k: string) => k in caps;\n\n      // Prefer: reduce over-exposure highlights & avoid backlight compensation\n      // which can brighten the board and blow out whites.\n      const desired: any = {\n        // Some cams expose this as a mode rather than a boolean.\n        // We try a conservative setting.\n        ...(supports(\"exposureMode\") ? { exposureMode: \"continuous\" } : {}),\n        ...(supports(\"whiteBalanceMode\")\n          ? { whiteBalanceMode: \"continuous\" }\n          : {}),\n        ...(supports(\"focusMode\") ? { focusMode: \"continuous\" } : {}),\n        ...(supports(\"sharpness\") ? { sharpness: caps.sharpness?.max } : {}),\n        ...(supports(\"contrast\") ? { contrast: caps.contrast?.max } : {}),\n        // Minimize any auto \"backlight\" boosting.\n        ...(supports(\"backlightCompensation\")\n          ? { backlightCompensation: false }\n          : {}),\n      };\n\n      // If nothing is supported, skip.\n      if (!Object.keys(desired).length) return;\n\n      try {\n        await (track as any).applyConstraints(desired);\n        dlog(\"[CAMERA] Applied anti-glare track constraints:\", desired);\n      } catch (e) {\n        console.warn(\"[CAMERA] Anti-glare track constraints not supported:\", e);\n      }\n    };\n    try {\n      // If a preferred camera is set, request it; otherwise default to back camera on mobile\n      // Prefer a crisp feed (up to 4K) but let the browser/device fall back.\n      // Note: requesting 4K can increase CPU usage; we keep frameRate modest.\n      const qualityHints4k: MediaTrackConstraints = {\n        width: { ideal: 3840 },\n        height: { ideal: 2160 },\n        frameRate: { ideal: 30 },\n      };\n      const qualityHints1440p: MediaTrackConstraints = {\n        width: { ideal: 2560 },\n        height: { ideal: 1440 },\n        frameRate: { ideal: 30 },\n      };\n      const qualityHints1080p: MediaTrackConstraints = {\n        width: { ideal: 1920 },\n        height: { ideal: 1080 },\n        frameRate: { ideal: 30 },\n      };\n      const qualityHints720p: MediaTrackConstraints = {\n        width: { ideal: 1280 },\n        height: { ideal: 720 },\n        frameRate: { ideal: 30 },\n      };\n      const baseVideo: MediaTrackConstraints = preferredCameraId\n        ? { deviceId: { exact: preferredCameraId } }\n        : { facingMode: \"environment\" };\n\n      const tryGetStream = async (\n        hints: MediaTrackConstraints,\n        label: string,\n      ): Promise<MediaStream> => {\n        const constraints: MediaStreamConstraints = {\n          video: { ...baseVideo, ...hints },\n          audio: false,\n        };\n        dlog(`[CAMERA] Using constraints (${label}):`, constraints);\n        return navigator.mediaDevices.getUserMedia(constraints);\n      };\n\n      let stream: MediaStream;\n      try {\n        // Optimized: Instead of a serial waterfall (4k -> 1440 -> 1080) which causes multi-second\n        // startup delays on lower-end hardware, we provide a wide range of 'ideal' values\n        // in a single request. The browser's native matching logic is significantly faster.\n        const dynamicHints: MediaTrackConstraints = cameraLowLatency\n          ? {\n              width: { ideal: 1280 },\n              height: { ideal: 720 },\n              frameRate: { ideal: 60 },\n            }\n          : {\n              width: { ideal: 3840 },\n              height: { ideal: 2160 },\n              frameRate: { ideal: 30 },\n            };\n\n        try {\n          stream = await tryGetStream(dynamicHints, \"dynamic-best-effort\");\n        } catch (errDynamic: any) {\n          dlog(\n            \"[CAMERA] Dynamic hints failed, trying basic 1080p fallback:\",\n            errDynamic,\n          );\n          stream = await tryGetStream(qualityHints1080p, \"1080p-fallback\");\n        }\n        dlog(\"[CAMERA] Got stream:\", !!stream);\n      } catch (err: any) {\n        console.warn(\"[CAMERA] First attempt failed:\", err);\n        // Fallback if specific device isn't available or facingMode not supported\n        const name = (err && (err.name || err.code)) || \"\";\n        if (\n          preferredCameraId &&\n          (name === \"OverconstrainedError\" || name === \"NotFoundError\")\n        ) {\n          dlog(\"[CAMERA] Trying fallback without deviceId\");\n          stream = await navigator.mediaDevices.getUserMedia({\n            video: { ...qualityHints1440p },\n            audio: false,\n          });\n        } else if (\n          !preferredCameraId &&\n          (name === \"OverconstrainedError\" ||\n            name === \"NotFoundError\" ||\n            name === \"NotSupportedError\")\n        ) {\n          dlog(\"[CAMERA] Trying fallback for facingMode not supported\");\n          // Fallback for devices that don't support facingMode\n          stream = await navigator.mediaDevices.getUserMedia({\n            video: { ...qualityHints1440p },\n            audio: false,\n          });\n        } else {\n          throw err;\n        }\n      }\n      if (videoRef.current) {\n        dlog(\"[CAMERA] Setting stream to video element\");\n        videoRef.current.srcObject = stream;\n\n        // Optimized: Perform track constraint adjustments (anti-glare) in the background\n        // to avoid blocking the main stream-initialization promise. We want the stream\n        // reported to session as soon as 'srcObject' is set.\n        try {\n          const track = (stream as any)?.getVideoTracks?.()?.[0];\n          void applyAntiGlare(track);\n        } catch {}\n\n        // Publish the MediaStream into the global camera session immediately so\n        // preview tiles can detect and attempt to attach the stream. We avoid\n        // claiming the global video element ref here to reduce play() races \n        // we'll set the element ref only after playback is confirmed below.\n        try {\n          cameraSession.setMediaStream?.(stream);\n          cameraSession.setMode?.(\"local\");\n          // Let other components know a stream exists; don't mark fully\n          // streaming until playback is confirmed.\n          cameraSession.setStreaming?.(true);\n          cameraSession.setStarting?.(false);\n        } catch (err) {\n          console.warn(\n            \"[CAMERA] Failed to sync camera session with local stream:\",\n            err,\n          );\n        }\n\n        // Add event listeners for debugging\n        try {\n          videoRef.current.addEventListener(\"loadeddata\", () =>\n            dlog(\"[CAMERA] Video loadeddata\"),\n          );\n          videoRef.current.addEventListener(\"loadedmetadata\", () => {\n            dlog(\"[CAMERA] Video loadedmetadata - dimensions available\");\n            // Set videoReady when we have dimensions\n            if (videoRef.current?.videoWidth && videoRef.current?.videoHeight) {\n              setVideoReady(true);\n            }\n          });\n          videoRef.current.addEventListener(\"canplay\", () => {\n            dlog(\"[CAMERA] Video canplay\");\n            // Also set videoReady here as a fallback\n            if (videoRef.current?.videoWidth && videoRef.current?.videoHeight) {\n              setVideoReady(true);\n            }\n          });\n          videoRef.current.addEventListener(\"play\", () =>\n            dlog(\"[CAMERA] Video started playing\"),\n          );\n          videoRef.current.addEventListener(\"error\", (e) =>\n            console.error(\"[CAMERA] Video error:\", e),\n          );\n        } catch {}\n\n        // Use ensureVideoPlays which serializes play attempts and retries on\n        // AbortError. This reduces races when multiple UI surfaces try to\n        // attach/play the same stream.\n        let playResult: any = null;\n        try {\n          playResult = await ensureVideoPlays({\n            video: videoRef.current,\n            stream,\n            onPlayError: (e) => console.error(\"[CAMERA] Video play failed:\", e),\n          });\n          if (playResult.played) {\n            dlog(\"[CAMERA] Video play ensured\");\n            // Reset retry counter on success\n            try {\n              retryCountRef.current = 0;\n            } catch {}\n            // Only claim the global video element ref once playback succeeds.\n            try {\n              const current = cameraSession.getVideoElementRef?.();\n              if (!current || current === videoRef.current) {\n                cameraSession.setVideoElementRef?.(videoRef.current);\n              }\n            } catch (e) {\n              // non-fatal\n            }\n            // Some browsers/virtual cams report played but the <video> may still\n            // have no dimensions (videoWidth/videoHeight === 0) because frames\n            // aren't being painted. Attempt a small reattach/play loop to force\n            // the element to receive frames before giving up.\n            try {\n              const ensureReady = async () => {\n                const MAX_ATTACH_RETRIES = 3;\n                for (let i = 0; i < MAX_ATTACH_RETRIES; i++) {\n                  try {\n                    // If dimensions are present, we're done\n                    if (\n                      videoRef.current?.videoWidth &&\n                      videoRef.current?.videoHeight\n                    ) {\n                      setVideoReady(true);\n                      return true;\n                    }\n                    dlog(\n                      `[CAMERA] play succeeded but no dimensions yet, reattach attempt ${i + 1}`,\n                    );\n                    // Force a reattach: clear srcObject briefly then reassign\n                    try {\n                      if (videoRef.current) videoRef.current.srcObject = null;\n                    } catch {}\n                    await new Promise((r) => setTimeout(r, 120 + i * 80));\n                    try {\n                      if (videoRef.current) videoRef.current.srcObject = stream;\n                    } catch {}\n                    // Try playing again via ensureVideoPlays to re-prime playback\n                    try {\n                      const r = await ensureVideoPlays({\n                        video: videoRef.current,\n                        stream,\n                        onPlayError: (e) =>\n                          console.error(\"[CAMERA] reattach play failed:\", e),\n                      });\n                      if (r.played) dlog(\"[CAMERA] reattach play confirmed\");\n                    } catch (e) {\n                      dlog(\"[CAMERA] reattach ensureVideoPlays threw:\", e);\n                    }\n                    // Short wait for loadedmetadata/canplay to fire\n                    await new Promise((r) => setTimeout(r, 220 + i * 60));\n                  } catch (e) {\n                    dlog(\"[CAMERA] attach retry error:\", e);\n                  }\n                }\n                return false;\n              };\n              void ensureReady().then((ok) => {\n                if (!ok) dlog(\"[CAMERA] attach/replay retries exhausted\");\n              });\n            } catch (e) {\n              // swallow - non-fatal\n            }\n          } else {\n            console.warn(\n              \"[CAMERA] ensureVideoPlays did not confirm playback:\",\n              playResult?.reason,\n            );\n          }\n        } catch (err) {\n          console.error(\"[CAMERA] ensureVideoPlays failed:\", err);\n        }\n\n        // If playback didn't start, schedule a few retry attempts to recover.\n        try {\n          const played = !!(playResult && playResult.played);\n          if (!played) {\n            const MAX_CAMERA_RETRIES = 3;\n            const currentRetry = retryCountRef.current ?? 0;\n            if (currentRetry < MAX_CAMERA_RETRIES && isMountedRef.current) {\n              retryCountRef.current = currentRetry + 1;\n              const backoff = 700 * Math.pow(2, currentRetry); // 700ms, 1400ms, 2800ms\n              dlog(\n                \"[CAMERA] Scheduling camera restart retry\",\n                retryCountRef.current,\n                \"in\",\n                backoff,\n                \"ms\",\n              );\n              setTimeout(async () => {\n                try {\n                  if (!isMountedRef.current) return;\n                  // Stop current tracks and re-attempt start\n                  stopCamera();\n                  await new Promise((r) => setTimeout(r, 120));\n                  await startCamera();\n                } catch (e) {\n                  dlog(\"[CAMERA] Retry attempt failed:\", e);\n                }\n              }, backoff);\n            } else {\n              dlog(\n                \"[CAMERA] Max camera retries reached or unmounted; not retrying\",\n              );\n            }\n          }\n        } catch (e) {\n          // ignore\n        }\n\n        dlog(\n          \"[CAMERA] Stream tracks:\",\n          stream.getTracks().length,\n          \"video tracks:\",\n          stream.getVideoTracks().length,\n        );\n\n        // If phone camera is selected but we're falling back to local camera,\n        // ensure the global session also sees the stream so the rest of the\n        // app (and autoscore source selection) stays consistent.\n        if (isPhoneCamera) {\n          try {\n            cameraSession.setMediaStream?.(stream);\n            if (playResult?.played) {\n              cameraSession.setVideoElementRef?.(videoRef.current);\n            }\n          } catch (e) {}\n        }\n      } else {\n        console.error(\"[CAMERA] Video element not found\");\n      }\n      setStreaming(true);\n      try {\n        setCameraAccessError(null);\n      } catch {}\n      // Capture device list for inline picker - no automatic preference updates\n      try {\n        const list = await navigator.mediaDevices.enumerateDevices();\n        setAvailableCameras(list.filter((d) => d.kind === \"videoinput\"));\n        dlog(\n          \"[CAMERA] Found cameras:\",\n          list.filter((d) => d.kind === \"videoinput\").length,\n        );\n      } catch (enumErr) {\n        console.warn(\"[CAMERA] Failed to enumerate devices:\", enumErr);\n      }\n    } catch (e) {\n      console.error(\"[CAMERA] Camera start failed:\", e);\n      const name = (e as any)?.name || (e as any)?.code || \"\";\n      if (name === \"NotAllowedError\" || name === \"SecurityError\") {\n        setCameraAccessError(\"permission-denied\");\n      } else if (name === \"NotFoundError\" || name === \"OverconstrainedError\") {\n        setCameraAccessError(\"not-found\");\n      } else if (name === \"NotSupportedError\") {\n        setCameraAccessError(\"not-supported\");\n      } else {\n        setCameraAccessError(\"unknown\");\n      }\n      setCameraStarting(false);\n      try {\n        cameraSession.setStarting?.(false);\n      } catch {}\n    } finally {\n      setCameraStarting(false);\n      try {\n        cameraSession.setStarting?.(false);\n      } catch {}\n    }\n  }\n\n  function stopCamera() {\n    try {\n      const sessionStream = cameraSession.getMediaStream?.() || null;\n      if (sessionStream) {\n        sessionStream.getTracks().forEach((t) => t.stop());\n      }\n    } catch (e) {\n      // ignore cleanup errors\n    }\n    if (videoRef.current) {\n      try {\n        videoRef.current.srcObject = null;\n      } catch (e) {}\n    }\n    try {\n      cameraSession.setMediaStream?.(null);\n      cameraSession.setStreaming?.(false);\n      cameraSession.setVideoElementRef?.(null);\n    } catch (e) {}\n    setStreaming(false);\n    setCameraStarting(false);\n  }\n\n  useEffect(() => {\n    const videoEl = videoRef.current;\n    if (!videoEl) return;\n    const sessionStream = cameraSession.getMediaStream?.() || null;\n    const sessionVideo = TEST_MODE\n      ? null\n      : cameraSession.getVideoElementRef?.() || null;\n    const fallbackStream =\n      (sessionVideo?.srcObject as MediaStream | null) || null;\n    const activeStream = sessionStream || fallbackStream;\n    if (!activeStream) return;\n    if (videoEl.srcObject !== activeStream) {\n      videoEl.srcObject = activeStream;\n    }\n    videoEl.muted = true;\n    (videoEl as any).playsInline = true;\n    // Ensure any returned play() promise is handled to avoid unhandled rejections\n    try {\n      Promise.resolve(videoEl.play()).catch(() => {});\n    } catch (e) {}\n    if (!streaming) setStreaming(true);\n  }, [cameraSession.mode, cameraSession.isStreaming, streaming, cameraSession]);\n\n  // Keep diagnostics in sync with the latest access error.\n  useEffect(() => {\n    if (!showVideoDiagnostics) return;\n    try {\n      setVideoDiagnostics(\n        collectVideoDiagnostics({ error: cameraAccessError }),\n      );\n    } catch {}\n  }, [showVideoDiagnostics, cameraAccessError, collectVideoDiagnostics]);\n\n  // Preview fallback: copy video frames into a canvas when the native\n  // <video> element has dimensions but isn't being painted (readyState low).\n  useEffect(() => {\n    let rafId: number | null = null;\n    let mounted = true;\n    let activated = false;\n    let sampleBlankCount = 0;\n    let sampleHandle: number | null = null;\n    let lastDraw = 0;\n    const TARGET_FPS = 18;\n    const pc = previewCanvasRef.current;\n    const v = videoRef.current;\n    const [previewDiag, setPreviewDiag] = (() => {\n      // lightweight local state via closure: we expose a runPreviewDiag function\n      // below that will call the outer setPreviewDiag if mounted. To avoid\n      // React state here (large file), we implement a small closure store.\n      let diag: any = null;\n      const set = (d: any) => {\n        try {\n          diag = d;\n          // eslint-disable-next-line no-console\n          dinfo(\"CameraView diag:\", d);\n        } catch {}\n      };\n      return [diag, set] as any;\n    })();\n    function stopLoop() {\n      if (rafId != null) {\n        cancelAnimationFrame(rafId);\n        rafId = null;\n      }\n    }\n    function drawLoop() {\n      try {\n        const now =\n          (performance && performance.now && performance.now()) || Date.now();\n        const minDt = 1000 / TARGET_FPS;\n        if (now - lastDraw < minDt) {\n          rafId = requestAnimationFrame(drawLoop);\n          return;\n        }\n        lastDraw = now;\n      } catch {}\n      try {\n        const vv = videoRef.current;\n        const cc = previewCanvasRef.current;\n        if (!mounted || !vv || !cc) return stopLoop();\n        const vw = vv.videoWidth || 0;\n        const vh = vv.videoHeight || 0;\n        if (vw <= 0 || vh <= 0) {\n          rafId = requestAnimationFrame(drawLoop);\n          return;\n        }\n        // Ensure preview canvas is visible while drawing\n        try {\n          if (!activated) {\n            try {\n              dinfo(\"CameraView: preview-canvas fallback activated\");\n            } catch {}\n            activated = true;\n          }\n          if (cc.style.visibility !== \"visible\")\n            cc.style.visibility = \"visible\";\n        } catch {}\n        const rect = cc.getBoundingClientRect();\n        const cw = Math.max(1, Math.round(rect.width));\n        const ch = Math.max(1, Math.round(rect.height));\n        if (cc.width !== cw || cc.height !== ch) {\n          cc.width = cw;\n          cc.height = ch;\n        }\n        const ctx = cc.getContext(\"2d\");\n        if (!ctx) return stopLoop();\n        try {\n          ctx.clearRect(0, 0, cc.width, cc.height);\n          ctx.drawImage(vv, 0, 0, cc.width, cc.height);\n        } catch (e) {\n          // drawImage may throw if frames aren't available yet; ignore\n        }\n        rafId = requestAnimationFrame(drawLoop);\n      } catch (e) {\n        stopLoop();\n      }\n    }\n\n    const startIfNeeded = () => {\n      const vv = videoRef.current;\n      const cc = previewCanvasRef.current;\n      if (!vv || !cc) return;\n      const hasDims = !!(vv.videoWidth && vv.videoHeight);\n      const notPainting = vv.readyState === 0 || vv.readyState < 2;\n      // QA override to force drawing\n      try {\n        if (typeof window !== \"undefined\") {\n          const q = window.localStorage.getItem(\"ndn:forceCanvasFallback\");\n          if (q === \"1\" || q === \"true\") {\n            try {\n              console.info(\n                \"CameraView: forced canvas fallback via localStorage\",\n              );\n            } catch {}\n            stopLoop();\n            rafId = requestAnimationFrame(drawLoop);\n            return;\n          }\n        }\n      } catch {}\n      if (hasDims && notPainting) {\n        stopLoop();\n        rafId = requestAnimationFrame(drawLoop);\n      } else {\n        // Hide canvas when not needed\n        try {\n          if (previewCanvasRef.current)\n            previewCanvasRef.current.style.visibility = \"hidden\";\n        } catch {}\n      }\n    };\n\n    // Sampling heuristic: detect very dark/blank frames and enable fallback\n    const startSampler = () => {\n      try {\n        if (typeof document === \"undefined\") return;\n        const sampler = document.createElement(\"canvas\");\n        const SW = 32;\n        const SH = 32;\n        sampler.width = SW;\n        sampler.height = SH;\n        const sctx = sampler.getContext(\"2d\", { willReadFrequently: true });\n        if (!sctx) return;\n        sampleHandle = window.setInterval(() => {\n          try {\n            const vv = videoRef.current;\n            if (!vv || vv.videoWidth === 0 || vv.videoHeight === 0) {\n              sampleBlankCount = 0;\n              return;\n            }\n            sctx.clearRect(0, 0, SW, SH);\n            sctx.drawImage(vv, 0, 0, SW, SH);\n            const data = sctx.getImageData(0, 0, SW, SH).data;\n            let sum = 0;\n            for (let i = 0; i < data.length; i += 4) {\n              sum +=\n                0.299 * data[i] + 0.587 * data[i + 1] + 0.114 * data[i + 2];\n            }\n            const avg = sum / (SW * SH * 255);\n            if (avg < 0.02) sampleBlankCount += 1;\n            else sampleBlankCount = 0;\n            if (sampleBlankCount >= 3) {\n              try {\n                dinfo(\n                  \"CameraView: video surface appears blank; enabling canvas fallback\",\n                );\n              } catch {}\n              sampleBlankCount = 0;\n              stopLoop();\n              rafId = requestAnimationFrame(drawLoop);\n            }\n          } catch (e) {\n            /* ignore */\n          }\n        }, 300);\n      } catch (e) {}\n    };\n    // runPreviewDiag: expose quick diagnostics (console and small return)\n    const runPreviewDiag = () => {\n      try {\n        const vv = videoRef.current;\n        const cc = previewCanvasRef.current;\n        const comp = vv ? getComputedStyle(vv) : null;\n        const canvasComp = cc ? getComputedStyle(cc) : null;\n        let brightness: number | null = null;\n        if (vv && cc) {\n          try {\n            const tmp = document.createElement(\"canvas\");\n            const TW = 32;\n            const TH = 32;\n            tmp.width = TW;\n            tmp.height = TH;\n            const tctx = tmp.getContext(\"2d\", { willReadFrequently: true });\n            if (tctx) {\n              tctx.drawImage(vv, 0, 0, TW, TH);\n              const d = tctx.getImageData(0, 0, TW, TH).data;\n              let s = 0;\n              for (let i = 0; i < d.length; i += 4)\n                s += 0.299 * d[i] + 0.587 * d[i + 1] + 0.114 * d[i + 2];\n              brightness = s / (TW * TH * 255);\n            }\n          } catch (e) {\n            brightness = null;\n          }\n        }\n        const payload = {\n          video: vv\n            ? {\n                readyState: vv.readyState,\n                videoWidth: vv.videoWidth,\n                videoHeight: vv.videoHeight,\n                paused: vv.paused,\n              }\n            : null,\n          canvas: cc\n            ? {\n                width: cc.width,\n                height: cc.height,\n                visibility: cc.style.visibility,\n              }\n            : null,\n          videoStyle: comp\n            ? {\n                display: comp.display,\n                visibility: comp.visibility,\n                opacity: comp.opacity,\n                zIndex: comp.zIndex,\n                transform: comp.transform,\n              }\n            : null,\n          canvasStyle: canvasComp\n            ? {\n                display: canvasComp.display,\n                visibility: canvasComp.visibility,\n                opacity: canvasComp.opacity,\n                zIndex: canvasComp.zIndex,\n                transform: canvasComp.transform,\n              }\n            : null,\n          brightness,\n          ts: Date.now(),\n        };\n        try {\n          dinfo(\"CameraView preview diag:\", payload);\n        } catch {}\n        return payload;\n      } catch (e) {\n        try {\n          console.warn(\"preview diag failed\", e);\n        } catch {}\n        return { error: String(e) };\n      }\n    };\n\n    startSampler();\n\n    startIfNeeded();\n    const poll = setInterval(() => startIfNeeded(), 400);\n    return () => {\n      mounted = false;\n      stopLoop();\n      clearInterval(poll);\n      try {\n        if (sampleHandle) clearInterval(sampleHandle);\n      } catch {}\n    };\n  }, [videoRef, previewCanvasRef]);\n\n  // Inline device refresh (does NOT request permission).\n  async function refreshCameraDeviceList() {\n    try {\n      if (!navigator?.mediaDevices?.enumerateDevices) {\n        setCameraAccessError(\"not-supported\");\n        return;\n      }\n      const list = await navigator.mediaDevices.enumerateDevices();\n      setAvailableCameras(list.filter((d) => d.kind === \"videoinput\"));\n    } catch (err) {\n      console.warn(\"[CAMERA] enumerateDevices failed:\", err);\n    }\n  }\n\n  function CameraSelector() {\n    const [manualDeviceId, setManualDeviceId] = useState(\"\");\n    const selectDeviceId = async (id?: string | null) => {\n      if (cameraStarting) return;\n      const label = availableCameras.find((d) => d.deviceId === id)?.label;\n      setPreferredCamera(id || undefined, label || \"\", true);\n      stopCamera();\n      await new Promise((r) => setTimeout(r, 150));\n      try {\n        await startCamera();\n      } catch (e) {}\n    };\n    // Always show a discovery UI so users can rescan / request permission even when no cameras were enumerated\n    return (\n      <div className=\"camera-selector absolute bottom-2 right-2 z-20 flex items-center gap-2 bg-black/40 rounded px-2 py-1 text-xs\">\n        <span>Cam:</span>\n        <select\n          onPointerDown={(e) => {\n            (e as any).stopPropagation();\n          }}\n          onMouseDown={(e) => {\n            e.stopPropagation();\n          }}\n          onTouchStart={(e) => {\n            (e as any).stopPropagation?.();\n          }}\n          className=\"bg-black/20 rounded px-1 py-0.5\"\n          value={preferredCameraId || \"\"}\n          onChange={async (e) => {\n            if (cameraStarting) return;\n            const id = e.target.value || undefined;\n            const label = availableCameras.find(\n              (d) => d.deviceId === id,\n            )?.label;\n            // This is a user-initiated change so force the preference even when locked\n            setPreferredCamera(id, label || \"\", true);\n            // Stop current camera and wait for cleanup\n            stopCamera();\n            // Small delay to ensure camera device is fully released\n            await new Promise((resolve) => setTimeout(resolve, 150));\n            try {\n              await startCamera();\n            } catch (err) {\n              console.warn(\"Failed to start camera after device switch:\", err);\n              // Try one more time after a longer delay\n              setTimeout(async () => {\n                try {\n                  await startCamera();\n                } catch (retryErr) {\n                  console.error(\"Camera switch failed after retry:\", retryErr);\n                  alert(\n                    \"Failed to switch camera. Please try again or refresh the page.\",\n                  );\n                }\n              }, 500);\n            }\n          }}\n        >\n          <option value=\"\">Auto</option>\n          <option value=\"manual\">~ Enter device ID ...</option>\n          {availableCameras.map((d) => (\n            <option key={d.deviceId} value={d.deviceId}>\n              {d.label ||\n                (d.deviceId ? `Camera (${d.deviceId.slice(0, 6)})` : \"Camera\")}\n            </option>\n          ))}\n        </select>\n        {preferredCameraId === \"manual\" && (\n          <div className=\"flex items-center gap-2 ml-2\">\n            <input\n              className=\"input input--small\"\n              placeholder=\"Device ID\"\n              value={manualDeviceId}\n              onChange={(e) => setManualDeviceId(e.target.value)}\n            />\n            <button\n              className=\"btn btn--ghost btn-sm\"\n              onClick={() => selectDeviceId(manualDeviceId || undefined)}\n            >\n              Apply\n            </button>\n          </div>\n        )}\n        {availableCameras.length === 0 && (\n          <div className=\"flex items-center gap-2\">\n            <span className=\"text-xs text-yellow-300\">No cameras found</span>\n            <button\n              className=\"btn btn--ghost btn-sm ml-2\"\n              onClick={refreshCameraDeviceList}\n              title=\"Refresh camera list\"\n            >\n              Refresh\n            </button>\n          </div>\n        )}\n        {cameraAccessError === \"permission-denied\" && (\n          <div className=\"ml-2 text-xs text-rose-300\">\n            Camera permission denied. Allow camera access in your browser site\n            settings, then click Rescan.\n          </div>\n        )}\n        <button\n          className=\"btn btn--ghost btn-sm ml-2\"\n          onClick={async () => {\n            try {\n              await refreshCameraDeviceList();\n            } catch (err) {\n              console.warn(\"Rescan failed:\", err);\n            }\n          }}\n          title=\"Rescan connected cameras\"\n        >\n          Rescan\n        </button>\n        {showVideoDiagnostics && (\n          <div className=\"mt-2 ml-1 text-xs rounded-lg border border-white/10 bg-black/30 p-2\">\n            <div className=\"flex items-center justify-between gap-2\">\n              <div className=\"font-semibold\">Video diagnostics</div>\n              <div className=\"opacity-60 text-xxs\">\n                {videoDiagnostics?.ts\n                  ? new Date(videoDiagnostics.ts).toLocaleTimeString()\n                  : \"\"}\n              </div>\n            </div>\n            <div className=\"mt-1 grid grid-cols-2 gap-x-3 gap-y-1\">\n              <div className=\"opacity-70\">preferred</div>\n              <div className=\"break-all\">\n                {preferredCameraLabel || \"(none)\"}{\" \"}\n                {preferredCameraId ? `(${preferredCameraId})` : \"\"}\n              </div>\n\n              <div className=\"opacity-70\">session</div>\n              <div>\n                mode={String(videoDiagnostics?.session?.mode ?? \"?\")} stream=\n                {String(videoDiagnostics?.session?.isStreaming ?? \"?\")}\n              </div>\n\n              <div className=\"opacity-70\">video el</div>\n              <div>\n                srcObject=\n                {String(videoDiagnostics?.video?.hasSrcObject ?? false)} rs=\n                {String(videoDiagnostics?.video?.readyState ?? \"?\")} paused=\n                {String(videoDiagnostics?.video?.paused ?? \"?\")}\n              </div>\n\n              <div className=\"opacity-70\">dimensions</div>\n              <div>\n                {videoDiagnostics?.video?.videoWidth ?? 0}\n                {videoDiagnostics?.video?.videoHeight ?? 0}\n              </div>\n\n              <div className=\"opacity-70\">tracks</div>\n              <div>\n                v={videoDiagnostics?.stream?.videoTracks ?? 0} a=\n                {videoDiagnostics?.stream?.audioTracks ?? 0}\n              </div>\n            </div>\n\n            {videoDiagnostics?.stream?.videoTrackStates?.length ? (\n              <div className=\"mt-2\">\n                <div className=\"opacity-70\">video track state</div>\n                <div className=\"mt-1 space-y-1\">\n                  {videoDiagnostics.stream.videoTrackStates.map((t, idx) => (\n                    <div key={idx} className=\"text-xxs opacity-90\">\n                      #{idx} ready={t.readyState} enabled={String(t.enabled)}\n                      {typeof t.muted === \"boolean\"\n                        ? ` muted=${String(t.muted)}`\n                        : \"\"}\n                    </div>\n                  ))}\n                </div>\n              </div>\n            ) : null}\n\n            {videoDiagnostics?.error ? (\n              <div className=\"mt-2 text-xxs text-rose-200\">\n                cameraAccessError={String(videoDiagnostics.error)}\n              </div>\n            ) : null}\n\n            <div className=\"mt-2 text-xxs opacity-60\">\n              If dims stay 00 but tracks&gt;0, the video element isn't\n              receiving frames (often a virtual cam / autoplay / stream\n              ownership issue). If tracks=0, getUserMedia succeeded but no video\n              track is being delivered.\n            </div>\n          </div>\n        )}\n      </div>\n    );\n  }\n\n  function drawOverlay() {\n    if (DISABLE_CAMERA_OVERLAY) {\n      if (overlayRef.current) {\n        const ctx = overlayRef.current.getContext(\"2d\");\n        if (ctx)\n          ctx.clearRect(\n            0,\n            0,\n            overlayRef.current.width,\n            overlayRef.current.height,\n          );\n      }\n      return;\n    }\n    try {\n      // Only render overlays when calibration data exists and the phone stream isn't providing the image\n      if (!overlayRef.current || !videoRef.current || !H || !imageSize) {\n        if (overlayRef.current) {\n          const ctx = overlayRef.current.getContext(\"2d\");\n          ctx?.clearRect(\n            0,\n            0,\n            overlayRef.current.width,\n            overlayRef.current.height,\n          );\n        }\n        return;\n      }\n      const o = overlayRef.current;\n      const v = videoRef.current;\n      const w = v.clientWidth;\n      const h = v.clientHeight;\n      o.width = w;\n      o.height = h;\n      const ctx = o.getContext(\"2d\");\n      if (!ctx) return;\n      ctx.clearRect(0, 0, w, h);\n      if (preferredCameraLocked || hideCameraOverlay) return;\n\n      // scale homography from calibration image size to current rendered size\n      // If calibration is locked and an overlaySize was saved at lock time, use that to preserve visual scale.\n      // Use saved overlay size for consistent visual scale when user chose to preserve it.\n      // Apply even when calibration is not currently \"locked\" so matches and other views can use the same visual size.\n      const useOverlay =\n        overlaySize && preserveCalibrationOverlay ? overlaySize : { w, h };\n      const sx = useOverlay.w && imageSize.w ? useOverlay.w / imageSize.w : 1;\n      const sy = useOverlay.h && imageSize.h ? useOverlay.h / imageSize.h : 1;\n      const Hs = scaleHomography(H, sx, sy);\n      const rings = [\n        BoardRadii.bullInner,\n        BoardRadii.bullOuter,\n        BoardRadii.trebleInner,\n        BoardRadii.trebleOuter,\n        BoardRadii.doubleInner,\n        BoardRadii.doubleOuter,\n      ];\n\n      // Visual aid: highlight big trebles (T20/T19/T18) briefly.\n      const drawBigTrebleHighlight = (value: 18 | 19 | 20) => {\n        // Expire window check\n        const now = performance.now();\n        const active = bigTrebleFlashRef.current;\n        if (!active || active.value !== value || active.until <= now) return;\n\n        // Board wedges: use standard dartboard ordering.\n        // 20 segments starting at \"20\" and going clockwise.\n        const standardOrder: number[] = [\n          20, 1, 18, 4, 13, 6, 10, 15, 2, 17, 3, 19, 7, 16, 8, 11, 14, 9, 12, 5,\n        ];\n        const i = Math.max(0, standardOrder.indexOf(value));\n        const offset = typeof sectorOffset === \"number\" ? sectorOffset : 0;\n        const a0 = offset + (i * (Math.PI * 2)) / 20;\n        const a1 = offset + ((i + 1) * (Math.PI * 2)) / 20;\n\n        // Use a slightly \"fatter\" radius band than the actual treble ring.\n        const rInner = BoardRadii.trebleInner * 0.92;\n        const rOuter = BoardRadii.trebleOuter * 1.08;\n\n        const steps = 48;\n        const outer: Point[] = [];\n        const inner: Point[] = [];\n        for (let s = 0; s <= steps; s++) {\n          const t = s / steps;\n          const a = a0 + (a1 - a0) * t;\n          outer.push(\n            applyHomography(Hs, {\n              x: Math.cos(a) * rOuter,\n              y: Math.sin(a) * rOuter,\n            }),\n          );\n          inner.push(\n            applyHomography(Hs, {\n              x: Math.cos(a) * rInner,\n              y: Math.sin(a) * rInner,\n            }),\n          );\n        }\n\n        // Convert to overlay canvas space (crop + drawScale)\n        const poly = [...outer, ...inner.reverse()].map((p) => ({\n          x: (p.x - cropOverlayX) * drawScaleX,\n          y: (p.y - cropOverlayY) * drawScaleY,\n        }));\n\n        // Fade out over time\n        const alpha = Math.max(0, Math.min(1, (active.until - now) / 900));\n        ctx.save();\n        ctx.globalAlpha = 0.18 + 0.32 * alpha;\n        ctx.fillStyle = \"#facc15\"; // amber\n        ctx.beginPath();\n        ctx.moveTo(poly[0].x, poly[0].y);\n        for (let k = 1; k < poly.length; k++) ctx.lineTo(poly[k].x, poly[k].y);\n        ctx.closePath();\n        ctx.fill();\n        ctx.globalAlpha = 0.35 + 0.45 * alpha;\n        ctx.strokeStyle = \"#fde047\";\n        ctx.lineWidth = 3;\n        ctx.stroke();\n        ctx.restore();\n      };\n      // If useOverlay differs from actual canvas size, draw scale from useOverlay space to overlay space.\n      const drawScaleX = w / useOverlay.w;\n      const drawScaleY = h / useOverlay.h;\n      // Compute cropping offsets when video is 'fill' (object-cover) so we align homography to\n      // the visible portion of the video. When the video is letterboxed (fit), crop offsets are zero.\n      const videoIntrinsicW =\n        v.videoWidth && v.videoWidth > 0 ? v.videoWidth : imageSize.w;\n      const videoIntrinsicH =\n        v.videoHeight && v.videoHeight > 0 ? v.videoHeight : imageSize.h;\n      const vr = videoIntrinsicW / videoIntrinsicH;\n      const cr = useOverlay.w / useOverlay.h;\n      let cropSrcX = 0;\n      let cropSrcY = 0;\n      if (vr > cr) {\n        // video is wider than overlay - crop left/right\n        const targetW = videoIntrinsicH * cr;\n        cropSrcX = Math.max(0, (videoIntrinsicW - targetW) / 2);\n      } else if (vr < cr) {\n        // video is taller than overlay - crop top/bottom\n        const targetH = videoIntrinsicW / cr;\n        cropSrcY = Math.max(0, (videoIntrinsicH - targetH) / 2);\n      }\n      const cropOverlayX = (cropSrcX / imageSize.w) * useOverlay.w;\n      const cropOverlayY = (cropSrcY / imageSize.h) * useOverlay.h;\n      for (const r of rings) {\n        const poly = sampleRing(Hs, r, 720);\n        // Scale poly points according to drawScale\n        // Adjust for cropping offset and then scale to actual canvas\n        const scaledPoly = poly.map((p) => ({\n          x: (p.x - cropOverlayX) * drawScaleX,\n          y: (p.y - cropOverlayY) * drawScaleY,\n        }));\n        drawPolyline(\n          ctx,\n          scaledPoly,\n          r === BoardRadii.doubleOuter ? \"#22d3ee\" : \"#a78bfa\",\n          r === BoardRadii.doubleOuter ? 3 : 2,\n        );\n      }\n\n      // Draw the registered-tip marker (if any). This indicates where the\n      // system counted the dart. Coordinates are provided in video pixel\n      // space; map to overlay canvas size.\n      try {\n        if (registeredTip) {\n          const now = Date.now();\n          if (now > registeredTip.expires) {\n            try {\n              setRegisteredTip(null);\n            } catch (e) {}\n          } else {\n            const videoIntrinsicW =\n              v.videoWidth && v.videoWidth > 0 ? v.videoWidth : imageSize.w;\n            const videoIntrinsicH =\n              v.videoHeight && v.videoHeight > 0 ? v.videoHeight : imageSize.h;\n            const ox = (registeredTip.x / (videoIntrinsicW || 1)) * o.width;\n            const oy = (registeredTip.y / (videoIntrinsicH || 1)) * o.height;\n            ctx.save();\n            ctx.beginPath();\n            ctx.fillStyle = \"rgba(34,197,94,0.95)\"; // green-ish\n            ctx.strokeStyle = \"rgba(255,255,255,0.9)\";\n            ctx.lineWidth = 2;\n            ctx.arc(\n              ox,\n              oy,\n              Math.max(6, Math.min(16, Math.round((o.width + o.height) / 150))),\n              0,\n              Math.PI * 2,\n            );\n            ctx.fill();\n            ctx.stroke();\n            ctx.restore();\n          }\n        }\n      } catch (e) {}\n\n      // Draw persistent ?? markers for the current visit\n      try {\n        if (visitMarkers.length > 0) {\n          const videoIntrinsicW =\n            v.videoWidth && v.videoWidth > 0 ? v.videoWidth : imageSize.w;\n          const videoIntrinsicH =\n            v.videoHeight && v.videoHeight > 0 ? v.videoHeight : imageSize.h;\n          ctx.save();\n          // Use a font size based on the overlay dimensions\n          ctx.font = `${Math.max(\n            16,\n            Math.min(32, Math.round((o.width + o.height) / 80)),\n          )}px sans-serif`;\n          ctx.textAlign = \"center\";\n          ctx.textBaseline = \"middle\";\n\n          for (const m of visitMarkers) {\n            const ox = (m.x / (videoIntrinsicW || 1)) * o.width;\n            const oy = (m.y / (videoIntrinsicH || 1)) * o.height;\n            ctx.fillText(\"??\", ox, oy);\n          }\n          ctx.restore();\n        }\n      } catch (e) {}\n\n      // Draw commit flash text when a visit was just committed.\n      try {\n        if (commitFlash) {\n          const now = Date.now();\n          if (now > commitFlash.expires) {\n            try {\n              setCommitFlash(null);\n            } catch (e) {}\n          } else {\n            ctx.save();\n            ctx.fillStyle = \"rgba(0,0,0,0.6)\";\n            ctx.strokeStyle = \"rgba(255,255,255,0.9)\";\n            ctx.lineWidth = 2;\n            ctx.font = `bold ${Math.max(12, Math.round(o.width / 32))}px sans-serif`;\n            const text = `Committed: ${commitFlash.score} (${commitFlash.darts})`;\n            const metrics = ctx.measureText(text);\n            const tx = o.width / 2 - metrics.width / 2;\n            const ty = Math.max(24, Math.round(o.height * 0.08));\n            // background\n            ctx.fillRect(\n              tx - 8,\n              ty - parseInt(ctx.font, 10) - 6,\n              metrics.width + 16,\n              parseInt(ctx.font, 10) + 10,\n            );\n            ctx.fillStyle = \"#fff\";\n            ctx.fillText(text, tx, ty);\n            ctx.restore();\n          }\n        }\n      } catch (e) {}\n\n      // Draw on top of rings.\n      if (enhanceBigTrebles) {\n        try {\n          const active = bigTrebleFlashRef.current;\n          if (active && active.until > performance.now()) {\n            drawBigTrebleHighlight(active.value);\n          }\n        } catch {}\n      }\n    } catch (e) {\n      // Silently ignore drawing errors to prevent re-render loops\n      console.warn(\"Overlay drawing error:\", e);\n    }\n  }\n\n  useEffect(() => {\n    if (TEST_MODE || manualOnly || DISABLE_CAMERA_OVERLAY) return;\n    if (!isDocumentVisible) return;\n    const id = setInterval(drawOverlay, 250);\n    return () => clearInterval(id);\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [\n    H,\n    imageSize,\n    effectiveStreaming,\n    manualOnly,\n    isPhoneCamera,\n    preferredCameraLocked,\n    hideCameraOverlay,\n    isDocumentVisible,\n    registeredTip,\n    commitFlash,\n  ]);\n\n  // Built-in autoscore loop (offline/local CV)\n  useEffect(() => {\n    cameraVerboseLog(\"[DETECTION] Effect running\", {\n      manualOnly,\n      autoscoreProvider,\n      videoReady,\n      hasH: !!H,\n      hasImageSize: !!imageSize,\n      hasVideoRef: !!videoRef.current,\n      videoWidth: videoRef.current?.videoWidth,\n      videoHeight: videoRef.current?.videoHeight,\n    });\n\n    if (!isDocumentVisible) return;\n    if (TEST_MODE || manualOnly) {\n      console.log(\n        \"[DETECTION] Exiting: TEST_MODE or manualOnly (provider=\" +\n          autoscoreProvider +\n          \")\",\n      );\n      return;\n    }\n    // Built-in autoscore providers are handled locally (offline CV).\n    // built-in-v2 currently shares the same detector/commit loop but may evolve to\n    // different scoring/refinement logic.\n    if (\n      autoscoreProvider !== \"built-in\" &&\n      autoscoreProvider !== \"built-in-v2\"\n    ) {\n      cameraVerboseLog(\n        \"[DETECTION] Exiting: autoscoreProvider is\",\n        autoscoreProvider,\n      );\n      return;\n    }\n    // Choose source: local video element, or paired phone camera element.\n    // IMPORTANT: when Phone Camera is selected but there is no active phone feed,\n    // fall back to the local <video> element so detection can still run.\n    const cameraSession = useCameraSession.getState();\n    const preferredLabel = useUserSettings.getState().preferredCameraLabel;\n    const isPhone = preferredLabel === \"Phone Camera\";\n\n    const sessionVideo = cameraSession.getVideoElementRef?.() || null;\n    const sessionStream = cameraSession.getMediaStream?.() || null;\n    const sessionIsStreaming = !!cameraSession.isStreaming;\n\n    // Prefer a session-provided video element if it exists AND has dimensions.\n    // Otherwise, fall back to the local <video> element.\n    const localVideo = videoRef.current;\n    const sessionVideoHasDims = !!(\n      sessionVideo &&\n      sessionVideo.videoWidth > 0 &&\n      sessionVideo.videoHeight > 0\n    );\n    let sourceVideo: any = sessionVideoHasDims ? sessionVideo : localVideo;\n\n    // If Phone Camera is selected but there's no session video, still allow local.\n    // If not phone, still allow session video if it becomes the only valid one.\n    if (!sourceVideo && sessionVideo) sourceVideo = sessionVideo;\n\n    // If we have a streaming session and a mounted target video element but it has\n    // no srcObject yet, attach the session stream to kick off metadata/dimensions.\n    try {\n      if (\n        sessionIsStreaming &&\n        sessionStream &&\n        sourceVideo &&\n        !sourceVideo.srcObject\n      ) {\n        sourceVideo.srcObject = sessionStream;\n        if (typeof sourceVideo.play === \"function\") {\n          Promise.resolve(sourceVideo.play()).catch(() => {});\n        }\n      }\n    } catch (e) {}\n    // test harness: if running under test, fake a source video so detection can run\n    if (!sourceVideo && process.env.NODE_ENV === \"test\") {\n      sourceVideo = {\n        videoWidth: 320,\n        videoHeight: 240,\n        currentTime: 0,\n        play: async () => {},\n        paused: false,\n        srcObject: false,\n      } as unknown as HTMLVideoElement;\n    }\n    if (!sourceVideo) {\n      cameraVerboseLog(\"[DETECTION] Exiting: no sourceVideo\", {\n        preferredLabel,\n        isPhone,\n        phoneFeedActive,\n        sessionStreaming: sessionIsStreaming,\n        cameraSessionMode: (cameraSession as any)?.mode,\n        hasSessionVideo: !!sessionVideo,\n        hasLocalVideo: !!videoRef.current,\n      });\n      return;\n    }\n    if (!sourceVideo.videoWidth || !sourceVideo.videoHeight) {\n      // Common race: video element exists but metadata isn't available yet.\n      // Retry for a short window so we don't permanently miss starting detection.\n      const start = performance.now();\n      let canceledLocal = false;\n      const retry = () => {\n        if (canceledLocal) return;\n        const vw = sourceVideo?.videoWidth || 0;\n        const vh = sourceVideo?.videoHeight || 0;\n        if (vw && vh) {\n          // Trigger a re-run of this effect by toggling videoReady.\n          try {\n            setVideoReady(true);\n          } catch (e) {}\n          return;\n        }\n        if (performance.now() - start > 2000) {\n          cameraVerboseLog(\n            \"[DETECTION] Exiting: video has no dimensions yet (after retries)\",\n            {\n              vw,\n              vh,\n              preferredLabel,\n              hasSrcObject: !!(sourceVideo as any)?.srcObject,\n              readyState: (sourceVideo as any)?.readyState,\n            },\n          );\n          return;\n        }\n        window.setTimeout(retry, 120);\n      };\n      window.setTimeout(retry, 60);\n      return () => {\n        canceledLocal = true;\n      };\n    }\n\n    // Mark videoReady true once the chosen source has dimensions.\n    if (!videoReady) {\n      try {\n        setVideoReady(true);\n      } catch (e) {}\n    }\n    if (!H || !imageSize) {\n      console.log(\n        \"[DETECTION] Exiting: no H or imageSize (calibration missing)\",\n      );\n      return;\n    }\n\n    console.log(\n      \"[DETECTION] ? All conditions met, starting detection loop! Provider:\",\n      autoscoreProvider,\n    );\n\n    let canceled = false;\n    const v = sourceVideo;\n    const initVw = v.videoWidth || 0;\n    const initVh = v.videoHeight || 0;\n    const proc = canvasRef.current;\n    if (!proc) return;\n\n    // Initialize or reset detector with tuned params for resolution/phone cameras\n    // We also want to re-create the detector if camera resolution changes, because\n    // the background model is resolution-dependent.\n    const detectorSizeRef =\n      (detectorRef as any)._sizeRef ||\n      ((detectorRef as any)._sizeRef = { w: 0, h: 0 });\n    const shouldResetDetector =\n      !detectorRef.current ||\n      (initVw > 0 &&\n        initVh > 0 &&\n        (detectorSizeRef.w !== initVw || detectorSizeRef.h !== initVh));\n\n    if (shouldResetDetector) {\n      // default tuning\n      let minArea = autoscoreDetectorMinArea;\n      let thresh = autoscoreDetectorThresh;\n      let requireStableN = autoscoreDetectorRequireStableN;\n      let angMaxDeg = 70;\n\n      const px = initVw * initVh;\n\n      // If resolution is low (common for phone cameras), make detector more permissive\n      if (initVw > 0 && initVh > 0 && px < 1280 * 720) {\n        minArea = Math.min(minArea, 20);\n        thresh = Math.min(thresh, 14);\n        requireStableN = Math.min(requireStableN, 2);\n      }\n\n      // At higher resolutions, the PCA-based angle estimation can be noisy (more\n      // pixels of glare/feathering), which can cause the \"Rejected - angle too large\"\n      // spam youre seeing. Loosen the gate a bit so we dont throw away real darts.\n      if (initVw > 0 && initVh > 0 && px >= 1920 * 1080) {\n        angMaxDeg = 82;\n        requireStableN = Math.max(requireStableN, 2);\n      }\n\n      detectorRef.current = new DartDetector({\n        minArea,\n        thresh,\n        requireStableN,\n        angMaxDeg,\n      });\n      detectorSizeRef.w = initVw;\n      detectorSizeRef.h = initVh;\n    }\n\n    // If calibration just changed, apply a short grace window to the detector.\n    try {\n      const sig = `${locked ? 1 : 0}|${imageSize?.w ?? 0}x${imageSize?.h ?? 0}|${\n        (H as any)?.[0]?.[0] ?? (H as any)?.a ?? \"H\"\n      }`;\n      if (sig !== lastCalibrationSigRef.current) {\n        lastCalibrationSigRef.current = sig;\n        const det = detectorRef.current as any;\n        if (det && typeof det.setTemporaryOverrides === \"function\") {\n          // Relax angle gate and allow single-frame stability briefly.\n          det.setTemporaryOverrides(\n            {\n              requireStableN: 1,\n              angMaxDeg: 90,\n            },\n            POST_CALIBRATION_GRACE_MS,\n          );\n          cameraVerboseLog(\n            \"[DETECTION] Applied post-calibration grace window\",\n            {\n              ms: POST_CALIBRATION_GRACE_MS,\n            },\n          );\n        }\n      }\n    } catch {}\n\n    const tick = () => {\n      // throttle detection processing to configured FPS to reduce CPU usage\n      try {\n        const now = performance.now();\n        const interval = 1000 / (cameraProcessingFps || 15);\n        if (now - lastProcessedRef.current < interval) {\n          rafRef.current = requestAnimationFrame(tick);\n          tickRef.current = tick;\n          return;\n        }\n        lastProcessedRef.current = now;\n      } catch (e) {}\n      let didApplyHitThisTick = false;\n      if (process.env.NODE_ENV === \"test\") {\n        try {\n          dlog(\"CameraView.tick invoked\", {\n            armed: detectionArmedRef.current,\n            frameCount: frameCountRef.current,\n          });\n        } catch (e) {}\n      }\n      if (canceled) return;\n      try {\n        const vw = v.videoWidth || 0;\n        const vh = v.videoHeight || 0;\n        if (!vw || !vh) {\n          rafRef.current = requestAnimationFrame(tick);\n          return;\n        }\n        if (proc.width !== vw) proc.width = vw;\n        if (proc.height !== vh) proc.height = vh;\n        const ctx = proc.getContext(\"2d\", { willReadFrequently: true });\n        if (!ctx) {\n          rafRef.current = requestAnimationFrame(tick);\n          return;\n        }\n        ctx.drawImage(v, 0, 0, vw, vh);\n        const frame = ctx.getImageData(0, 0, vw, vh);\n\n        // Optional detector-side glare clamp (ring-light hotspots).\n        // This directly improves edge visibility for the detector.\n        const glareClampEnabled =\n          harshLightingMode ||\n          (typeof window !== \"undefined\" &&\n            window.localStorage?.getItem(\"ndn.glareClamp\") === \"1\");\n        if (glareClampEnabled) {\n          // Tuned defaults for bright 360 ring lights.\n          glareClampFrameInPlace(frame, { knee: 212, strength: 0.72 });\n        }\n\n        frameCountRef.current++;\n\n        // Seed ROI from calibration homography (board center + double radius along X)\n        const cImg = applyHomography(H, { x: 0, y: 0 });\n        const rImg = applyHomography(H, { x: BoardRadii.doubleOuter, y: 0 });\n\n        // Build a single transform that maps video pixel space -> calibration image space.\n        // This compensates for any display fit-mode (contain/cover) mismatches.\n        const fitMode = cameraFitMode === \"fill\" ? \"fill\" : \"fit\";\n        const fit = makeFitTransform({\n          videoW: vw,\n          videoH: vh,\n          calibW: imageSize.w,\n          calibH: imageSize.h,\n          fitMode,\n        });\n\n        // Approximate scale for ROI placement (used only inside detector ROI)\n        const sx = vw / imageSize.w;\n        const sy = vh / imageSize.h;\n        const cx = cImg.x * sx;\n        const cy = cImg.y * sy;\n        const rx = rImg.x * sx;\n        const ry = rImg.y * sy;\n        const roiR = Math.hypot(rx - cx, ry - cy) * 1.08;\n\n        const detector = detectorRef.current!;\n        if (detectorSeedVersion >= 0) {\n          detector.setROI(\n            cx,\n            cy,\n            Math.max(24, Math.min(Math.max(vw, vh), roiR)),\n          );\n        }\n\n        const visitHasRoom = (pendingDartsRef.current || 0) < 3;\n        // Try to detect a new dart when not paused and visit has room\n        {\n          const condPaused = !paused;\n          const condPending = visitHasRoom;\n          const condArmed = detectionArmedRef.current;\n          const condFrame = frameCountRef.current > DETECTION_MIN_FRAMES;\n          dlog(\"CameraView: detection conditions\", {\n            condPaused,\n            condPending,\n            condArmed,\n            condFrame,\n            frameCount: frameCountRef.current,\n            minFrames: DETECTION_MIN_FRAMES,\n            pendingDartsRef: pendingDartsRef.current,\n          });\n        }\n        if (\n          !paused &&\n          visitHasRoom &&\n          detectionArmedRef.current &&\n          frameCountRef.current > DETECTION_MIN_FRAMES\n        ) {\n          if (frameCountRef.current % 150 === 0) {\n            console.log(\"[DETECTION] Loop active & branching\", {\n              paused,\n              visitHasRoom,\n              detectionArmed: detectionArmedRef.current,\n              frames: frameCountRef.current,\n            });\n          }\n          dlog(\"CameraView: entering detection branch\", {\n            paused,\n            pendingDarts,\n            detectionArmed: detectionArmedRef.current,\n            frameCount: frameCountRef.current,\n            DETECTION_MIN_FRAMES,\n          });\n          const det = detector.detect(frame);\n          dlog(\"CameraView: raw detection\", det);\n          const nowPerf = performance.now();\n          if (boardLockedRef.current) {\n            if (!det) {\n              if (!boardClearStartRef.current) {\n                boardClearStartRef.current = nowPerf;\n              }\n              if (nowPerf - boardClearStartRef.current >= 3000) {\n                boardLockedRef.current = false;\n                boardClearStartRef.current = 0;\n                lastCommittedTipRef.current = null;\n                committedTipsRef.current = [];\n                try {\n                  window.dispatchEvent(\n                    new CustomEvent(\"ndn:darts-cleared\", {\n                      detail: { source: \"camera-view\", ts: Date.now() },\n                    }),\n                  );\n                } catch {}\n              }\n            } else {\n              boardClearStartRef.current = 0;\n            }\n          }\n          if (det) {\n            detectionDurationFramesRef.current =\n              (detectionDurationFramesRef.current || 0) + 1;\n            if (!detectionStartRef.current) {\n              detectionStartRef.current = nowPerf;\n              lastMotionLikeEventAtRef.current = nowPerf;\n              lastOfflineThrowAtRef.current = nowPerf;\n            }\n          } else {\n            detectionStartRef.current = 0;\n          }\n\n          // Bounceout heuristic: if we were tracking a candidate and the detection\n          // vanishes before we ever became ready to commit, treat as a bounceout MISS.\n          // This is intentionally conservative to avoid false MISS spam.\n          try {\n            const pending = bounceoutRef.current.pending;\n            const vanished = pending && !det;\n            const elapsed = nowPerf - bounceoutRef.current.lastSeenTs;\n            if (vanished && elapsed > 40 && elapsed < 900) {\n              bounceoutRef.current.pending = false;\n              autoCandidateRef.current = null;\n              setHadRecentAuto(false);\n\n              const distMm = bounceoutRef.current.lastBullDistanceMm;\n              const tipPx = bounceoutRef.current.lastTipVideoPx;\n\n              // Emit as a MISS to any parent handler.\n              try {\n                if (onAutoDart)\n                  onAutoDart(\n                    0,\n                    \"MISS\" as any,\n                    {\n                      sector: null,\n                      mult: 0,\n                      calibrationValid: true,\n                      pBoard: null,\n                      bullDistanceMm:\n                        typeof distMm === \"number\" ? distMm : undefined,\n                      tipVideoPx: tipPx ?? undefined,\n                      bounceout: true,\n                    } as any,\n                  );\n              } catch (e) {}\n\n              // Keep detection log consistent for debugging.\n              try {\n                captureDetectionLog({\n                  ts: nowPerf,\n                  label: \"BOUNCEOUT\",\n                  value: 0,\n                  ring: \"MISS\" as Ring,\n                  confidence: 0,\n                  ready: false,\n                  accepted: false,\n                  warmup: false,\n                });\n              } catch {}\n            }\n          } catch {}\n\n          // Treat sudden appearance/disappearance of detections as a motion-like event.\n          // This helps prevent committing on flicker/blur right as a dart is thrown.\n          try {\n            const hadStable =\n              tipStabilityRef.current.stableFrames >= TIP_STABLE_MIN_FRAMES;\n            const hadSustained = (detectionDurationFramesRef.current || 0) > 3;\n            const hasNow = !!det;\n            if (!hasNow && (hadStable || hadSustained)) {\n              lastMotionLikeEventAtRef.current = nowPerf;\n              // Only open the offline throw window when a stable detection\n              // disappears, which is a stronger signal of a real throw or\n              // dart removal than a single noisy appearance.\n              if (!isOnlineMatch) lastOfflineThrowAtRef.current = nowPerf;\n            }\n          } catch (e) {}\n\n          // If the detection drops out entirely, reset tip stability so the\n          // next real dart appearance triggers a fresh motion window.\n          if (!det) {\n            detectionDurationFramesRef.current = 0;\n            tipStabilityRef.current = {\n              lastTip: null,\n              stableFrames: 0,\n            };\n          }\n\n          if (\n            autoCandidateRef.current &&\n            nowPerf - autoCandidateRef.current.firstTs > 900\n          ) {\n            autoCandidateRef.current = null;\n          }\n          const effectiveThreshold = Math.max(\n            0.5,\n            Math.min(\n              0.99,\n              Number(autoScoreConfidenceThreshold) || AUTO_COMMIT_CONFIDENCE,\n            ),\n          );\n\n          // If confirm-on-uncertain is enabled, we still want to *see* detections\n          // below the threshold, but we should not auto-apply them.\n          if (\n            det &&\n            confirmUncertainDarts &&\n            det.confidence > 0 &&\n            det.confidence < effectiveThreshold\n          ) {\n            // Avoid spamming the confirmation prompt.\n            if (!pendingConfirm) {\n              // We don't need tip stability/settle logic to *prompt*; the user is\n              // the final arbiter. We'll still compute the score label for clarity.\n              const tipRefined = refinePointSobel(proc, det.tip, 6);\n              const fitMode = cameraFitMode === \"fill\" ? \"fill\" : \"fit\";\n              const fit = makeFitTransform({\n                videoW: vw,\n                videoH: vh,\n                calibW: imageSize.w,\n                calibH: imageSize.h,\n                fitMode,\n              });\n              const pCal = fit.toCalibration({\n                x: tipRefined.x,\n                y: tipRefined.y,\n              });\n              const score = scoreFromImagePoint(\n                H,\n                pCal,\n                theta ?? 0,\n                sectorOffset ?? 0,\n                rotationOffsetRad ?? 0,\n              );\n              let pBoard: Point | null = null;\n              try {\n                // H is board->image; imageToBoard inverts internally.\n                pBoard = imageToBoard(H as any, pCal);\n              } catch (e) {\n                pBoard = null;\n              }\n              const ring = score.ring as Ring;\n              const value = score.base;\n              const sector = (score.sector ?? null) as number | null;\n              const mult = Math.max(0, Number(score.mult) || 0) as\n                | 0\n                | 1\n                | 2\n                | 3;\n              let label = \"\";\n              if (ring === \"MISS\") {\n                label = \"MISS\";\n              } else if (ring === \"BULL\") {\n                label = \"25\";\n              } else if (ring === \"INNER_BULL\") {\n                label = \"BULL 50\";\n              } else if (sector != null) {\n                const prefix = mult === 3 ? \"T\" : mult === 2 ? \"D\" : \"\";\n                label = `${prefix}${sector}`;\n              } else {\n                label = `${ring} ${value > 0 ? value : \"\"}`.trim();\n              }\n              const hasCalibration = !!H && !!imageSize;\n              const calibrationGood =\n                hasCalibration && calibrationValidEffective;\n\n              setPendingConfirm({\n                label,\n                value,\n                ring,\n                confidence: det.confidence,\n                meta: {\n                  calibrationValid: calibrationGood,\n                  pBoard,\n                  source: \"camera\",\n                  // Include the refined tip in video pixel coordinates so\n                  // the accept/reject flow (and addDart) can show a marker.\n                  __tipVideoPx: tipRefined,\n                },\n              });\n              captureDetectionLog({\n                ts: Date.now(),\n                label,\n                value,\n                ring,\n                confidence: det.confidence,\n                ready: false,\n                accepted: false,\n                warmup: false,\n                rejectReason: \"below-confidence\",\n                pCal,\n                tip: tipRefined,\n              });\n            }\n            return;\n          }\n\n          if (det && det.confidence >= effectiveThreshold) {\n            dlog(\"CameraView: detected raw\", det.confidence, det.tip);\n            // debug logging via dlog to avoid polluting test console\n            dlog(\"CameraView: detected raw\", det.confidence, det.tip);\n            const warmupActive =\n              streamingStartMsRef.current > 0 &&\n              nowPerf - streamingStartMsRef.current < AUTO_STREAM_IGNORE_MS;\n            const _skipLocalCommit = false;\n            // Refine tip on gradients\n            const tipRefined = refinePointSobel(proc, det.tip, 6);\n\n            // Declare these up-front so later nested branches can safely reference\n            // them (TypeScript doesn't allow using block-scoped vars before declaration).\n            let label = \"\";\n            let value = 0;\n            let ring: Ring = \"MISS\" as Ring;\n            let shouldAccept = false;\n\n            // Track why we *didn't* accept/commit a detection so users can debug\n            // missed darts quickly.\n            let rejectReason: string | null = null;\n\n            // Track tip stability (low jitter across frames).\n            // We do this in video pixel space for simplicity.\n            // If it jumps around too much, reset stability.\n            try {\n              const prev = tipStabilityRef.current.lastTip;\n              if (!prev) {\n                tipStabilityRef.current = {\n                  lastTip: { ...tipRefined },\n                  stableFrames: 1,\n                };\n                // If we've been detecting something (e.g. low-conf hand) for a bit, but just now\n                // locked onto a high-confidence target, treat this transition as a throw event.\n                // We trigger the throw window on ANY fresh detection to catch fast throws where\n                // the hand wasn't tracked for long (or detection dropped briefly).\n                lastMotionLikeEventAtRef.current = nowPerf;\n                if (!isOnlineMatch) lastOfflineThrowAtRef.current = nowPerf;\n              } else {\n                const dist = Math.hypot(\n                  tipRefined.x - prev.x,\n                  tipRefined.y - prev.y,\n                );\n                if (dist <= TIP_STABLE_MAX_JITTER_PX) {\n                  tipStabilityRef.current = {\n                    lastTip: { ...tipRefined },\n                    stableFrames: tipStabilityRef.current.stableFrames + 1,\n                  };\n                } else {\n                  tipStabilityRef.current = {\n                    lastTip: { ...tipRefined },\n                    stableFrames: 1,\n                  };\n                  // Decouple minor jitter (e.g. 5px) from \"Motion Events\".\n                  // Only treat >10px moves as a throw/hand event that resets 'settled' state.\n                  // This allows scoring on noisy cameras where the tip jitters slightly\n                  // but the board is otherwise settled.\n                  if (dist > 10) {\n                    lastMotionLikeEventAtRef.current = nowPerf;\n                    if (!isOnlineMatch) lastOfflineThrowAtRef.current = nowPerf;\n                  }\n                  if (dist >= TIP_MOTION_RESET_PX) {\n                    detectionStartRef.current = nowPerf;\n                  }\n                }\n              }\n            } catch (e) {}\n\n            const settled =\n              nowPerf - lastMotionLikeEventAtRef.current >= DETECTION_SETTLE_MS;\n            const tipStable =\n              tipStabilityRef.current.stableFrames >= TIP_STABLE_MIN_FRAMES;\n            const detectionAgeMs =\n              detectionStartRef.current > 0\n                ? nowPerf - detectionStartRef.current\n                : Number.POSITIVE_INFINITY;\n            const motionAgeMs =\n              lastMotionLikeEventAtRef.current > 0\n                ? nowPerf - lastMotionLikeEventAtRef.current\n                : Number.POSITIVE_INFINITY;\n            // Offline anti-false-positive: only allow commits shortly after a\n            // throw-like motion event.\n            const inOfflineThrowWindow = isOnlineMatch\n              ? true\n              : nowPerf - lastOfflineThrowAtRef.current <=\n                OFFLINE_THROW_WINDOW_MS;\n            const detectionFresh =\n              process.env.NODE_ENV === \"test\"\n                ? true\n                : Math.min(detectionAgeMs, motionAgeMs) <=\n                    MAX_DETECTION_STILL_MS || inOfflineThrowWindow;\n\n            // NOTE: settled/tipStable are enforced further down the pipeline\n            // (in the non-ghost accept/commit path) so we don't prematurely\n            // reference scoring variables that haven't been computed yet.\n\n            // Map to calibration image space before scoring (fit-aware)\n            const pCal = fit.toCalibration({\n              x: tipRefined.x,\n              y: tipRefined.y,\n            });\n            const score = scoreFromImagePoint(\n              H,\n              pCal,\n              theta ?? 0,\n              sectorOffset ?? 0,\n              rotationOffsetRad ?? 0,\n            );\n            // Map the *dart tip* into board-space coordinates via homography.\n            // This is the actual point entering the board and is what we should\n            // use for bullseye distance.\n            let pBoard: Point | null = null;\n            try {\n              // H is board->image; imageToBoard inverts internally.\n              pBoard = imageToBoard(H as any, pCal);\n            } catch (e) {\n              pBoard = null;\n            }\n            ring = score.ring as Ring;\n            value = score.base;\n            const sector = (score.sector ?? null) as number | null;\n            const mult = Math.max(0, Number(score.mult) || 0) as 0 | 1 | 2 | 3;\n            // Use a stable, caller-friendly label so UI + tests don't depend on\n            // the ring enum's spelling.\n            if (ring === \"MISS\") {\n              label = \"MISS\";\n            } else if (ring === \"BULL\") {\n              label = \"25\";\n            } else if (ring === \"INNER_BULL\") {\n              label = \"BULL 50\";\n            } else if (sector != null) {\n              const prefix = mult === 3 ? \"T\" : mult === 2 ? \"D\" : \"\";\n              label = `${prefix}${sector}`;\n            } else {\n              label = `${ring} ${value > 0 ? value : \"\"}`.trim();\n            }\n            const strictScoring = process.env.NODE_ENV !== \"test\";\n            const TIP_MARGIN_PX = strictScoring ? 2 : 6;\n            const PCAL_MARGIN_PX = strictScoring ? 2 : 5;\n            const hasCalibration = !!H && !!imageSize;\n            // IMPORTANT: errorPx should reflect real calibration quality.\n            // Treat missing errorPx as *unknown* (not zero) unless calibration is locked.\n            // This prevents the UI from implying \"0.0px\" and reduces false-positive scoring.\n            //\n            // Decouple detection gating from quality policy. As long as we have a mapping (hasCalibration),\n            // we allow the detection to proceed to the candidate stage. The auto-commit logic (applyAutoHit)\n            // will handle policy warnings (calibrationValidEffective) as soft warnings rather than hard blocks.\n            const calibrationGood = hasCalibration;\n            const tipInVideo =\n              tipRefined.x >= -TIP_MARGIN_PX &&\n              tipRefined.x <= vw + TIP_MARGIN_PX &&\n              tipRefined.y >= -TIP_MARGIN_PX &&\n              tipRefined.y <= vh + TIP_MARGIN_PX;\n            const pCalInImage = imageSize\n              ? pCal.x >= -PCAL_MARGIN_PX &&\n                pCal.x <= imageSize.w + PCAL_MARGIN_PX &&\n                pCal.y >= -PCAL_MARGIN_PX &&\n                pCal.y <= imageSize.h + PCAL_MARGIN_PX\n              : false;\n            const validSector =\n              ring === \"BULL\" || ring === \"INNER_BULL\"\n                ? sector === 25\n                : sector != null && sector >= 1 && sector <= 20;\n            let _onBoard = false;\n            if (pBoard) {\n              const boardR = Math.hypot(pBoard.x, pBoard.y);\n              // Add a small tolerance (e.g. 2mm) to account for calibration drift at the edges.\n              // Reduced from 8mm to 2mm to prevent scoring darts in the surround/wall.\n              const EDGE_TOLERANCE_MM = 2;\n              _onBoard = boardR <= BoardRadii.doubleOuter + EDGE_TOLERANCE_MM;\n            }\n\n            // treat as ghost unless onBoard and calibrationGood\n            // Let an onBoard detection pass if calibration is good; otherwise treat as ghost\n            const boardOk = !strictScoring || (pBoard && _onBoard);\n            const sectorOk = !strictScoring || validSector;\n            const warmupBlock = strictScoring ? warmupActive : false;\n            const effectiveWarmupActive = strictScoring ? warmupActive : false;\n            const rawGhost =\n              !calibrationGood ||\n              !tipInVideo ||\n              !pCalInImage ||\n              !boardOk ||\n              ring === \"MISS\" ||\n              !sectorOk ||\n              warmupBlock;\n            const isGhost = strictScoring ? rawGhost : ring === \"MISS\";\n            // Notify parent synchronously for immediate ACKs if they provided an onAutoDart\n            // so the parent can take ownership of the dart and prevent camera double-commit.\n            const _skipLocalCommit2 = false;\n            const allowNotify =\n              process.env.NODE_ENV === \"test\"\n                ? !isGhost\n                : !isGhost &&\n                  settled &&\n                  tipStable &&\n                  detectionFresh &&\n                  !shouldDeferCommit;\n            if (onAutoDart && allowNotify) {\n              try {\n                const mmPerBoardUnit = mmPerBoardUnitFromBullOuter({\n                  bullOuterRadiusBoardUnits: BoardRadii.bullOuter,\n                });\n                const bullDistance = pBoard\n                  ? distanceFromBullMm({\n                      pBoard,\n                      bullCenter: { x: 0, y: 0 },\n                      mmPerBoardUnit,\n                      bullInnerRadiusBoardUnits: BoardRadii.bullInner,\n                      bullOuterRadiusBoardUnits: BoardRadii.bullOuter,\n                    })\n                  : null;\n\n                // Track potential bounceouts: if we see a confident detection but it\n                // never commits (not stable/settled long enough) and then disappears,\n                // we'll emit a MISS bounceout.\n                try {\n                  if (!isGhost && ring !== \"MISS\") {\n                    bounceoutRef.current.pending = true;\n                    bounceoutRef.current.lastSeenTs = nowPerf;\n                    bounceoutRef.current.lastBullDistanceMm =\n                      typeof bullDistance?.distanceMm === \"number\"\n                        ? bullDistance.distanceMm\n                        : null;\n                    bounceoutRef.current.lastTipVideoPx = tipRefined;\n                  }\n                } catch {}\n\n                const pSig = `${score.base}|${score.ring}|${score.mult}`;\n                const pNow = performance.now();\n                if (\n                  !(\n                    pSig === lastParentSigRef.current &&\n                    pNow - lastParentSigAtRef.current < AUTO_COMMIT_COOLDOWN_MS\n                  )\n                ) {\n                  const maybe = onAutoDart(score.base, score.ring as any, {\n                    sector,\n                    mult,\n                    calibrationValid: Boolean(calibrationGood),\n                    pBoard,\n                    // The video-space tip point (after refinement). Useful for debugging\n                    // and for any future parallax/offset correction.\n                    tipVideoPx: tipRefined,\n                    // Precise bull-up \"feel\": distance from bull center in mm.\n                    // Consumers can announce/log/send to server without UI.\n                    bullDistanceMm: bullDistance?.distanceMm,\n                  });\n                  if (maybe === true) {\n                    lastParentSigRef.current = pSig;\n                    lastParentSigAtRef.current = pNow;\n                    // Parent claimed ownership, skip internal commit path for this detection\n                    // _skipLocalCommit2 = true; // can't reassign const\n                  }\n                }\n              } catch (e) {}\n            }\n            // (shouldAccept already initialized above)\n            dlog(\"CameraView: detection details\", {\n              value,\n              ring,\n              calibrationGood,\n              tipInVideo,\n              pCalInImage,\n              isGhost,\n            });\n\n            // Update diagnostics overlay state (best-effort, never throw).\n            try {\n              updateDiagnostics({\n                lastTip: tipRefined ?? null,\n                lastPcal: pCal ?? null,\n                lastPboard: pBoard ?? null,\n                lastConfidence:\n                  detectionLogRef.current[detectionLogRef.current.length - 1]\n                    ?.confidence ?? null,\n                lastLabel: label ?? null,\n                lastValue: value ?? null,\n                lastRing: ring ?? null,\n                lastReject: !calibrationValidEffective\n                  ? \"calibration-invalid\"\n                  : !tipInVideo\n                    ? \"tip-outside-video\"\n                    : !pCalInImage\n                      ? \"pCal-outside-image\"\n                      : !pBoard || !_onBoard\n                        ? \"off-board\"\n                        : ring === \"MISS\" || !validSector\n                          ? \"invalid-segment\"\n                          : warmupActive\n                            ? \"warmup\"\n                            : null,\n\n                // Gating state snapshot\n                detectionArmed: detectionArmedRef.current,\n                paused: !!paused,\n                pendingDarts,\n                frameCount: frameCountRef.current,\n                minFrames: DETECTION_MIN_FRAMES,\n                warmupActive,\n                settled,\n                tipStable,\n                tipStableFrames: tipStabilityRef.current.stableFrames,\n                shouldDeferCommit,\n                calibrationValidEffective,\n                // Offline false-positive protection\n                inOfflineThrowWindow,\n              });\n            } catch {}\n            setLastAutoScore(label);\n            setLastAutoValue(value);\n            setLastAutoRing(ring);\n\n            // Visual aid: briefly emphasize the big trebles when detected.\n            // This is purely a UI overlay hint; it does not affect scoring.\n            try {\n              if (\n                enhanceBigTrebles &&\n                ring === \"TRIPLE\" &&\n                (value === 20 || value === 19 || value === 18)\n              ) {\n                const flash = {\n                  value: value as 18 | 19 | 20,\n                  until: performance.now() + 900,\n                };\n                bigTrebleFlashRef.current = flash;\n              }\n            } catch {}\n\n            const applyAutoHit = async (candidate: AutoCandidate) => {\n              if (boardLockedRef.current) return;\n              console.log(\n                \"[CameraView] applyAutoHit CALLED:\",\n                candidate.label,\n                candidate.ring,\n                \"current-pending:\",\n                pendingDartsRef.current,\n              );\n              dlog(\n                \"CameraView: applyAutoHit\",\n                candidate.value,\n                candidate.ring,\n                candidate.sector,\n              );\n              // debug logging via dlog to avoid polluting test console\n              dlog(\n                \"CameraView: applyAutoHit\",\n                candidate.value,\n                candidate.ring,\n                candidate.sector,\n              );\n\n              // Commit gate:\n              // We require a mapping (H + imageSize) and that the candidate was\n              // classified as non-ghost earlier.\n              //\n              // IMPORTANT: `calibrationValidEffective` can be false even when the\n              // mapping is correct (e.g., errorPx missing/unknown, transient state).\n              // Previously this hard-blocked *all* auto scoring, which matches the\n              // reported symptom: detector says \" DART FOUND!\" but nothing counts.\n              //\n              // Strategy:\n              // - If we have *any* mapping, allow local commits.\n              // - Still surface diagnostics so users know calibration quality.\n              const hasCalibrationMapping = !!H && !!imageSize;\n              if (!hasCalibrationMapping) {\n                dlog(\n                  \"CameraView: applyAutoHit blocked (no H/imageSize mapping)\",\n                  candidate.value,\n                  candidate.ring,\n                );\n                try {\n                  updateDiagnostics({\n                    lastLabel: candidate.label ?? null,\n                    lastValue: candidate.value ?? null,\n                    lastRing: candidate.ring ?? null,\n                    lastConfidence:\n                      diagnosticsRef.current.lastConfidence ??\n                      detectionLogRef.current[\n                        detectionLogRef.current.length - 1\n                      ]?.confidence ??\n                      null,\n                    lastPboard: null,\n                    lastReject: \"calibration-mapping-missing\",\n                  });\n                } catch {}\n                try {\n                  // Inform parent for transparency, but mark as not calibration-valid\n                  if (onAutoDart)\n                    onAutoDart(candidate.value, candidate.ring, {\n                      sector: candidate.sector,\n                      mult: candidate.mult,\n                      calibrationValid: false,\n                      pBoard: null,\n                    });\n                } catch (e) {}\n                return;\n              }\n\n              if (!calibrationValidEffective) {\n                // Soft warning only; still allow commit.\n                try {\n                  updateDiagnostics({\n                    lastReject: \"calibration-low-quality\",\n                  });\n                } catch {}\n              }\n\n              const now = performance.now();\n              if (candidate.lastTip) {\n                const isDuplicate = committedTipsRef.current.some((entry) => {\n                  const dist = Math.hypot(\n                    candidate.lastTip!.x - entry.tip.x,\n                    candidate.lastTip!.y - entry.tip.y,\n                  );\n                  return dist < 18;\n                });\n                if (isDuplicate) return;\n              }\n              // Prevent multiple synchronous applyAutoHit calls causing duplicate commits\n              // (especially in test env where AUTO_COMMIT_COOLDOWN_MS may be 0).\n              if (inFlightAutoCommitRef.current) return;\n              inFlightAutoCommitRef.current = true;\n              // Release the lock after a short window to allow legitimate follow-up darts\n              try {\n                window.setTimeout(\n                  () => {\n                    inFlightAutoCommitRef.current = false;\n                  },\n                  Math.max(120, AUTO_COMMIT_COOLDOWN_MS),\n                );\n              } catch (e) {}\n              // Only dedupe by value/ring/mult to avoid accidental false negatives when\n              // the sector or tip fluctuates slightly across frames for the same scoring\n              // result. This reduces noisy duplicate notifications while preserving\n              // distinct sector-based changes.\n              const sig = `${candidate.value}|${candidate.ring}|${candidate.mult}`;\n              // Exclude duplicate commits within the cooldown window. This also\n              // prevents quick toggles across frames (different sigs) from\n              // immediately causing multiple commits in rapid succession.\n              // If the same signature reappears during the cooldown, skip it.\n              // Allow a different signature to proceed; inFlightAutoCommitRef will\n              // still prevent duplicate commits when applyAutoHit runs concurrently.\n              if (\n                now - lastAutoSigAtRef.current < AUTO_COMMIT_COOLDOWN_MS &&\n                sig === lastAutoSigRef.current\n              )\n                return;\n              lastAutoSigRef.current = sig;\n              lastAutoSigAtRef.current = now;\n              if (candidate.value > 0) {\n                setHadRecentAuto(true);\n                setPulseManualPill(true);\n                try {\n                  if (pulseTimeoutRef.current)\n                    clearTimeout(pulseTimeoutRef.current);\n                } catch (e) {\n                  /* ignore */\n                }\n                pulseTimeoutRef.current = window.setTimeout(() => {\n                  setPulseManualPill(false);\n                  pulseTimeoutRef.current = null;\n                }, 1500);\n                try {\n                  // Option A: Camera is the single authoritative committer.\n                  // We always commit locally (exactly once) and treat onAutoDart as\n                  // telemetry/UI only. This guarantees a stable, deterministic\n                  // dart counting sequence and avoids double-commit races.\n                  try {\n                    if (process.env.NODE_ENV === \"test\") {\n                      try {\n                        const pending = usePendingVisit.getState();\n                        const existing = Array.isArray(pending.entries)\n                          ? pending.entries.slice(0, 3)\n                          : [];\n                        const nextEntries = [\n                          ...existing,\n                          {\n                            label: candidate.label ?? `${candidate.value}`,\n                            value: candidate.value,\n                            ring: candidate.ring,\n                            meta: {\n                              calibrationValid: true,\n                              pBoard,\n                              source: \"camera\",\n                            },\n                          },\n                        ];\n                        const total = nextEntries.reduce(\n                          (sum, en) => sum + (Number(en?.value) || 0),\n                          0,\n                        );\n                        usePendingVisit\n                          .getState()\n                          .setVisit(\n                            nextEntries as any,\n                            nextEntries.length,\n                            total,\n                          );\n                      } catch {}\n                    }\n                    dlog(\n                      \"CameraView: committing locally (camera authoritative)\",\n                      candidate.value,\n                      candidate.label,\n                      candidate.ring,\n                    );\n                    addDart(candidate.value, candidate.label, candidate.ring, {\n                      calibrationValid: true,\n                      pBoard,\n                      source: \"camera\",\n                      // Pass video-space refined tip to help display a marker\n                      // on the overlay when the dart is registered.\n                      __tipVideoPx: tipRefined,\n                    });\n                  } catch (e) {}\n\n                  // Best-effort notify parent for UI/telemetry, but never allow it\n                  // to ACK ownership or influence commits.\n                  try {\n                    const pSig = sig;\n                    const pNow = performance.now();\n                    if (\n                      onAutoDart &&\n                      !(\n                        pSig === lastParentSigRef.current &&\n                        pNow - lastParentSigAtRef.current <\n                          AUTO_COMMIT_COOLDOWN_MS\n                      )\n                    ) {\n                      onAutoDart(candidate.value, candidate.ring, {\n                        sector: candidate.sector,\n                        mult: candidate.mult,\n                        calibrationValid: true,\n                        pBoard,\n                      });\n                      lastParentSigRef.current = pSig;\n                      lastParentSigAtRef.current = pNow;\n                    }\n                  } catch (e) {}\n                } catch (e) {}\n              } else {\n                setHadRecentAuto(false);\n              }\n              // Notify parent for misses or when the candidate wasn't already\n              // dispatched to the parent above.\n              if (candidate.value <= 0) {\n                try {\n                  if (onAutoDart)\n                    onAutoDart(candidate.value, candidate.ring, {\n                      sector: candidate.sector,\n                      mult: candidate.mult,\n                    });\n                } catch (e) {}\n              }\n            };\n\n            if (!effectiveWarmupActive) {\n              if (isGhost) {\n                try {\n                  dlog(\"[AUTOSCORE DROP] ghost\", {\n                    label,\n                    value,\n                    ring,\n                    calibrationGood,\n                    tipInVideo,\n                    pCalInImage,\n                    onBoard: _onBoard,\n                    warmupActive,\n                  });\n                } catch {}\n                dlog(\n                  \"CameraView: ignoring ghost detection (calibrationGood:\",\n                  calibrationGood,\n                  \"tipInVideo:\",\n                  tipInVideo,\n                  \"pCalInImage:\",\n                  pCalInImage,\n                  \")\",\n                );\n                autoCandidateRef.current = null;\n                setHadRecentAuto(false);\n                shouldAccept = false;\n                rejectReason = !calibrationGood\n                  ? \"calibration-invalid\"\n                  : !tipInVideo\n                    ? \"tip-outside-video\"\n                    : !pCalInImage\n                      ? \"pCal-outside-image\"\n                      : !_onBoard\n                        ? \"off-board\"\n                        : \"ghost\";\n                // Still publish to parent so UI can show the detection log but skip commits\n                try {\n                  if (onAutoDart)\n                    onAutoDart(value, ring, {\n                      sector,\n                      mult,\n                      calibrationValid: false,\n                      pBoard: null,\n                    });\n                } catch (e) {}\n                captureDetectionLog({\n                  ts: nowPerf,\n                  label,\n                  value,\n                  ring,\n                  pCal,\n                  tip: tipRefined,\n                  confidence: det.confidence,\n                  ready: false,\n                  accepted: false,\n                  warmup: warmupActive,\n                  rejectReason,\n                });\n              } else {\n                // Reliability gate (tuned for real-world webcams):\n                // Originally this required BOTH `settled` AND `tipStable`, which can\n                // prevent *any* commit when there's mild jitter or continuous micro-motion.\n                // We now allow candidate tracking when either condition is met, and we\n                // rely on the existing hold/frames + cooldown logic to prevent ghosts.\n                // Misses are allowed through for UI diagnostics but won't be committed.\n                // Further relax: if we have a confident, on-board, calibration-valid,\n                // non-ghost detection, allow the candidate to start tracking immediately.\n                // We still require AUTO_COMMIT_MIN_FRAMES/AUTO_COMMIT_HOLD_MS AND cooldown\n                // before committing, which keeps ghost risk low.\n                const boardClearReady = !boardLockedRef.current;\n                const allowCommitCandidate = strictScoring\n                  ? boardClearReady &&\n                    inOfflineThrowWindow &&\n                    detectionFresh &&\n                    tipStable\n                  : !isGhost;\n                const allowFallbackCommits = !strictScoring && boardClearReady;\n\n                if (ring === \"MISS\" || value <= 0) {\n                  autoCandidateRef.current = null;\n                  setHadRecentAuto(false);\n                  try {\n                    if (onAutoDart)\n                      onAutoDart(value, ring, {\n                        sector,\n                        mult,\n                        calibrationValid: Boolean(calibrationGood),\n                        pBoard: calibrationGood ? pBoard : null,\n                      });\n                  } catch (e) {}\n                  shouldAccept = true;\n                } else {\n                  // If we're not settled/stable yet, keep tracking but don't start/advance\n                  // the auto-commit candidate count.\n                  if (!allowCommitCandidate) {\n                    const tipStableFrames =\n                      tipStabilityRef.current.stableFrames;\n                    const minCommitArea = Math.max(\n                      autoscoreDetectorMinArea,\n                      Math.round(autoscoreDetectorMinArea * 1.25),\n                    );\n                    const commitStabilityOk =\n                      tipStableFrames >= TIP_STABLE_MIN_FRAMES;\n                    const commitAreaOk = det.area >= minCommitArea;\n                    shouldAccept = false;\n                    rejectReason = !inOfflineThrowWindow\n                      ? \"no-throw-window\"\n                      : !detectionFresh\n                        ? \"detection-stale\"\n                        : !settled\n                          ? \"not-settled\"\n                          : !tipStable\n                            ? \"unstable-tip\"\n                            : \"not-ready\";\n\n                    try {\n                      dlog(\"[AUTOSCORE DROP] gate\", {\n                        reason: rejectReason,\n                        label,\n                        value,\n                        ring,\n                        settled,\n                        tipStable,\n                        tipStableFrames,\n                        detectionFresh,\n                        detectionAgeMs: Number.isFinite(detectionAgeMs)\n                          ? Math.round(detectionAgeMs)\n                          : null,\n                        motionAgeMs: Number.isFinite(motionAgeMs)\n                          ? Math.round(motionAgeMs)\n                          : null,\n                      });\n                    } catch {}\n\n                    // Offline fallback: if we keep seeing the same scored result\n                    // near the same tip location at high confidence, commit after\n                    // a short window even if settle/stability never completes.\n                    try {\n                      if (allowFallbackCommits && !isOnlineMatch) {\n                        // IMPORTANT: never allow fallback commits outside the\n                        // post-throw window or while a lingering detection hasn't\n                        // seen real motion since it first appeared.\n                        if (\n                          !inOfflineThrowWindow ||\n                          !detectionFresh ||\n                          !commitAreaOk ||\n                          !commitStabilityOk\n                        ) {\n                          offlineFallbackRef.current = {\n                            sig: null,\n                            firstTs: 0,\n                            lastTs: 0,\n                            frames: 0,\n                            lastTip: null,\n                          };\n                        } else {\n                          const sig = `${value}|${ring}|${mult}`;\n                          const prev = offlineFallbackRef.current;\n                          const tip = tipRefined;\n                          const dist = prev.lastTip\n                            ? Math.hypot(\n                                tip.x - prev.lastTip.x,\n                                tip.y - prev.lastTip.y,\n                              )\n                            : 0;\n                          const same = prev.sig === sig && dist <= 18;\n                          if (!same) {\n                            offlineFallbackRef.current = {\n                              sig,\n                              firstTs: nowPerf,\n                              lastTs: nowPerf,\n                              frames: 1,\n                              lastTip: { ...tip },\n                            };\n                          } else {\n                            offlineFallbackRef.current = {\n                              ...prev,\n                              lastTs: nowPerf,\n                              frames: prev.frames + 1,\n                              lastTip: { ...tip },\n                            };\n                          }\n\n                          const fb = offlineFallbackRef.current;\n                          const ageMs = nowPerf - fb.firstTs;\n                          // Tuned to be \"fast enough to feel responsive\" but still\n                          // resistant to single-frame ghosts.\n                          const FALLBACK_MIN_FRAMES = 6;\n                          const FALLBACK_MIN_MS = 520;\n                          if (\n                            fb.sig === sig &&\n                            (fb.frames >= FALLBACK_MIN_FRAMES ||\n                              ageMs >= FALLBACK_MIN_MS)\n                          ) {\n                            dinfo(\"[AUTOSCORE] offline fallback commit\", {\n                              sig,\n                              frames: fb.frames,\n                              ageMs,\n                              reason: rejectReason,\n                            });\n                            applyAutoHit({\n                              value,\n                              ring,\n                              label,\n                              sector,\n                              mult,\n                              firstTs: fb.firstTs,\n                              frames: fb.frames,\n                            });\n                            didApplyHitThisTick = true;\n                            autoCandidateRef.current = null;\n                            lastAutoCommitRef.current = nowPerf;\n                            offlineFallbackRef.current = {\n                              sig: null,\n                              firstTs: 0,\n                              lastTs: 0,\n                              frames: 0,\n                              lastTip: null,\n                            };\n                            shouldAccept = true;\n                            rejectReason = null;\n                          }\n                        }\n                      }\n                    } catch {}\n\n                    // Universal snap-commit: if we've already accepted a confident,\n                    // on-board, calibration-good detection, but stability never\n                    // resolves, commit after a short delay *only* inside the\n                    // post-throw window.\n                    try {\n                      if (\n                        allowFallbackCommits &&\n                        inOfflineThrowWindow &&\n                        detectionFresh &&\n                        !isGhost &&\n                        calibrationGood &&\n                        det.confidence >= 0.82 &&\n                        commitAreaOk &&\n                        commitStabilityOk\n                      ) {\n                        // Track time spent \"pending\" for this exact scored result.\n                        const sig = `${value}|${ring}|${mult}`;\n                        const prev = offlineFallbackRef.current;\n                        const tip = tipRefined;\n                        const dist = prev.lastTip\n                          ? Math.hypot(\n                              tip.x - prev.lastTip.x,\n                              tip.y - prev.lastTip.y,\n                            )\n                          : 0;\n                        const same = prev.sig === sig && dist <= 18;\n                        if (!same) {\n                          offlineFallbackRef.current = {\n                            sig,\n                            firstTs: nowPerf,\n                            lastTs: nowPerf,\n                            frames: 1,\n                            lastTip: { ...tip },\n                          };\n                        } else {\n                          offlineFallbackRef.current = {\n                            ...prev,\n                            lastTs: nowPerf,\n                            frames: prev.frames + 1,\n                            lastTip: { ...tip },\n                          };\n                        }\n\n                        const fb = offlineFallbackRef.current;\n                        const ageMs = nowPerf - fb.firstTs;\n                        if (\n                          fb.sig === sig &&\n                          ageMs >= SNAP_COMMIT_MIN_MS &&\n                          tipStableFrames >= SNAP_COMMIT_MIN_TIP_STABLE_FRAMES\n                        ) {\n                          dinfo(\"[AUTOSCORE] snap commit\", {\n                            sig,\n                            ageMs,\n                            tipStableFrames,\n                            reason: rejectReason,\n                          });\n                          applyAutoHit({\n                            value,\n                            ring,\n                            label,\n                            sector,\n                            mult,\n                            firstTs: fb.firstTs,\n                            frames: fb.frames,\n                          });\n                          didApplyHitThisTick = true;\n                          autoCandidateRef.current = null;\n                          lastAutoCommitRef.current = nowPerf;\n                          offlineFallbackRef.current = {\n                            sig: null,\n                            firstTs: 0,\n                            lastTs: 0,\n                            frames: 0,\n                            lastTip: null,\n                          };\n                          shouldAccept = true;\n                          rejectReason = null;\n                        }\n                      } else {\n                        offlineFallbackRef.current = {\n                          sig: null,\n                          firstTs: 0,\n                          lastTs: 0,\n                          frames: 0,\n                          lastTip: null,\n                        };\n                      }\n                    } catch {}\n\n                    captureDetectionLog({\n                      ts: nowPerf,\n                      label,\n                      value,\n                      ring,\n                      pCal,\n                      tip: tipRefined,\n                      confidence: det.confidence,\n                      ready: false,\n                      accepted: false,\n                      warmup: warmupActive,\n                      rejectReason,\n                      fresh: detectionFresh,\n                    });\n                  } else {\n                    const existing = autoCandidateRef.current;\n\n                    // Candidate tracking needs to be tolerant to calibration/mapping jitter.\n                    // The *physical* dart stays in the same pixel neighborhood, but the\n                    // computed segment/ring can jump wildly frame-to-frame. If we key\n                    // tracking by value/ring, firstTs resets and we get infinite\n                    // frames=1/holdMs=0 \"candidate-hold\" drops.\n                    const TIP_TRACK_PX = 18;\n                    const distTip = existing?.lastTip\n                      ? Math.hypot(\n                          tipRefined.x - existing.lastTip.x,\n                          tipRefined.y - existing.lastTip.y,\n                        )\n                      : Infinity;\n                    const samePhysical = !!existing && distTip <= TIP_TRACK_PX;\n\n                    if (!existing) {\n                      autoCandidateRef.current = {\n                        value,\n                        ring,\n                        label,\n                        sector,\n                        mult,\n                        firstTs: nowPerf,\n                        frames: 1,\n                        lastTip: { ...tipRefined },\n                      };\n                    } else if (samePhysical) {\n                      // Same physical dart -> keep accumulating frames/holdMs.\n                      // Prefer stronger/non-single ring and keep a stable value\n                      // (don't let segment flicker reset the candidate).\n                      const preferRing: Ring =\n                        existing.ring === \"SINGLE\" && ring !== \"SINGLE\"\n                          ? ring\n                          : existing.ring;\n\n                      // Prefer non-miss, and otherwise keep the existing value to reduce flicker.\n                      const preferValue =\n                        existing.value > 0 ? existing.value : value;\n\n                      autoCandidateRef.current = {\n                        ...existing,\n                        value: preferValue,\n                        ring: preferRing,\n                        label,\n                        sector,\n                        mult,\n                        frames: existing.frames + 1,\n                        lastTip: { ...tipRefined },\n                      };\n                    } else {\n                      // New physical location -> new candidate signature.\n                      autoCandidateRef.current = {\n                        value,\n                        ring,\n                        label,\n                        sector,\n                        mult,\n                        firstTs: nowPerf,\n                        frames: 1,\n                        lastTip: { ...tipRefined },\n                      };\n                    }\n                    const current = autoCandidateRef.current!;\n                    const holdMs = nowPerf - current.firstTs;\n                    const ready =\n                      current.frames >= AUTO_COMMIT_MIN_FRAMES ||\n                      holdMs >= AUTO_COMMIT_HOLD_MS;\n                    const cooled = strictScoring\n                      ? nowPerf - lastAutoCommitRef.current >=\n                        AUTO_COMMIT_COOLDOWN_MS\n                      : true;\n                    if (ready && cooled) {\n                      dlog(\"CameraView: candidate ready and cooled\", {\n                        value,\n                        ring,\n                        frames: current.frames,\n                        nowPerf,\n                      });\n                      applyAutoHit(current);\n                      didApplyHitThisTick = true;\n                      autoCandidateRef.current = null;\n                      lastAutoCommitRef.current = nowPerf;\n                      shouldAccept = true;\n                      rejectReason = null;\n                    } else {\n                      // Still tracking candidate; annotate why we didn't commit yet.\n                      rejectReason = !ready\n                        ? \"candidate-hold\"\n                        : !cooled\n                          ? \"cooldown\"\n                          : null;\n\n                      try {\n                        dlog(\"[AUTOSCORE DROP] tracking\", {\n                          reason: rejectReason,\n                          value,\n                          ring,\n                          frames: current.frames,\n                          holdMs,\n                          cooled,\n                          detectionFresh,\n                          detectionAgeMs: Number.isFinite(detectionAgeMs)\n                            ? Math.round(detectionAgeMs)\n                            : null,\n                          motionAgeMs: Number.isFinite(motionAgeMs)\n                            ? Math.round(motionAgeMs)\n                            : null,\n                        });\n                      } catch {}\n                    }\n                  }\n                }\n              }\n            } else {\n              autoCandidateRef.current = null;\n              shouldAccept = true;\n              rejectReason = \"warmup\";\n\n              try {\n                dlog(\"[AUTOSCORE DROP] warmup\", {\n                  label,\n                  value,\n                  ring,\n                });\n              } catch {}\n            }\n\n            captureDetectionLog({\n              ts: nowPerf,\n              label,\n              value,\n              ring,\n              pCal,\n              tip: tipRefined,\n              confidence: det.confidence,\n              ready: shouldAccept,\n              accepted: shouldAccept && value > 0 && ring !== \"MISS\",\n              warmup: effectiveWarmupActive,\n              rejectReason,\n              fresh: detectionFresh,\n            });\n            if (process.env.NODE_ENV === \"test\") {\n              try {\n                dlog(\"CameraView: evaluate after detection\", {\n                  value,\n                  ring,\n                  shouldAccept,\n                  didApplyHitThisTick,\n                  warmupActive,\n                  autoCandidate: autoCandidateRef.current,\n                  rejectReason,\n                });\n              } catch (e) {}\n            }\n\n            // Draw debug tip and shaft axis on overlay (scaled to overlay canvas)\n            try {\n              if (DISABLE_CAMERA_OVERLAY || hideCameraOverlay) {\n                // If overlays are disabled, keep canvas clean and skip drawing.\n                if (overlayRef.current) {\n                  const octx = overlayRef.current.getContext(\"2d\");\n                  octx?.clearRect(\n                    0,\n                    0,\n                    overlayRef.current.width,\n                    overlayRef.current.height,\n                  );\n                }\n              } else {\n                const drawOverlayHint =\n                  value > 0 && ring !== \"MISS\" && !isGhost;\n                if (drawOverlayHint) {\n                  const o = overlayRef.current;\n                  if (o) {\n                    const octx = o.getContext(\"2d\");\n                    if (octx) {\n                      // Maintain overlay size and clear a small area\n                      const ox = (tipRefined.x / vw) * o.width;\n                      const oy = (tipRefined.y / vh) * o.height;\n                      octx.save();\n                      octx.beginPath();\n                      octx.strokeStyle = \"#f59e0b\";\n                      octx.lineWidth = 2;\n                      octx.arc(ox, oy, 6, 0, Math.PI * 2);\n                      octx.stroke();\n                      // axis line if available\n                      if ((det as any).axis) {\n                        const ax = (det as any).axis;\n                        const ax1 = (ax.x1 / vw) * o.width;\n                        const ay1 = (ax.y1 / vh) * o.height;\n                        const ax2 = (ax.x2 / vw) * o.width;\n                        const ay2 = (ax.y2 / vh) * o.height;\n                        octx.beginPath();\n                        octx.moveTo(ax1, ay1);\n                        octx.lineTo(ax2, ay2);\n                        octx.stroke();\n                      }\n                      // bbox\n                      if ((det as any).bbox) {\n                        const bx = ((det as any).bbox.x / vw) * o.width;\n                        const by = ((det as any).bbox.y / vh) * o.height;\n                        const bw = ((det as any).bbox.w / vw) * o.width;\n                        const bh = ((det as any).bbox.h / vh) * o.height;\n                        octx.strokeStyle = \"#22d3ee\";\n                        octx.strokeRect(bx, by, bw, bh);\n                      }\n                      octx.restore();\n                    }\n                  }\n                }\n              }\n            } catch (e) {}\n\n            if (shouldAccept && !didApplyHitThisTick) {\n              detector.accept(frame, det);\n              // Important: auto-commit must happen only through the candidate\n              // ready/cooled gate above. Calling applyAutoHit here can cause\n              // duplicates and ordering glitches during jittery detections.\n            }\n          } else {\n            if (\n              autoCandidateRef.current &&\n              nowPerf - autoCandidateRef.current.firstTs > 800\n            ) {\n              autoCandidateRef.current = null;\n            }\n          }\n        } else {\n          // Warmup or paused: update background to adapt to lighting\n          if (detectorRef.current) {\n            detectorRef.current.updateBackground(frame, 0.05);\n          }\n        }\n      } catch (e) {\n        // Soft-fail; continue next frame\n        // console.warn('Autoscore tick error:', e)\n      }\n      rafRef.current = requestAnimationFrame(tick);\n      // publish tick for test harnesses\n      tickRef.current = tick;\n    };\n\n    rafRef.current = requestAnimationFrame(tick);\n    return () => {\n      canceled = true;\n      if (rafRef.current) cancelAnimationFrame(rafRef.current);\n      rafRef.current = null;\n    };\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [\n    manualOnly,\n    autoscoreProvider,\n    effectiveStreaming,\n    H,\n    imageSize,\n    paused,\n    pendingDarts,\n    detectorSeedVersion,\n    captureDetectionLog,\n    videoReady, // Re-run when video becomes ready\n    isDocumentVisible,\n    cameraProcessingFps,\n  ]);\n\n  const handleUseLocalCamera = useCallback(async () => {\n    try {\n      if (isPhoneCamera) {\n        const fallback = availableCameras.find((c) => c.kind === \"videoinput\");\n        if (fallback) {\n          setPreferredCamera(fallback.deviceId, fallback.label || \"\", true);\n        } else {\n          setPreferredCamera(undefined, \"\", true);\n        }\n      }\n      await startCamera();\n    } catch (err) {\n      console.warn(\"[CameraView] Local camera fallback failed:\", err);\n    }\n  }, [availableCameras, isPhoneCamera, setPreferredCamera]);\n\n  const compactCameraView = () => {\n    if (!hideInlinePanels) return null;\n    const aspect =\n      cameraAspect || useUserSettings.getState().cameraAspect || \"wide\";\n    const fit =\n      (cameraFitMode || useUserSettings.getState().cameraFitMode || \"fit\") ===\n      \"fit\";\n    const videoClass =\n      aspect === \"square\"\n        ? \"absolute left-0 top-1/2 -translate-y-1/2 min-w-full min-h-full object-cover object-left bg-black\"\n        : fit\n          ? \"absolute inset-0 w-full h-full object-contain object-center bg-black ndn-video-smooth\"\n          : \"absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 min-w-full min-h-full w-auto h-auto object-cover object-center bg-black ndn-video-smooth\";\n    const videoScale = cameraScale ?? 1;\n\n    // Optional, low-risk glare reduction for the *preview* video element.\n    // This does not change the underlying detector input (which reads pixels\n    // from the raw video into a canvas). It simply makes the board easier to\n    // see when bright lights are washing out the white/metallic areas.\n    //\n    // Enable via localStorage flag so we don't need to add new settings UI.\n    // In DevTools console: localStorage.setItem('ndn.glareDimming', '1')\n    // Disable: localStorage.removeItem('ndn.glareDimming')\n    const glareDimmingEnabled =\n      harshLightingMode ||\n      (typeof window !== \"undefined\" &&\n        (window.localStorage?.getItem(\"ndn.glareDimming\") === \"1\" ||\n          window.localStorage?.getItem(\"ndn.glareClamp\") === \"1\"));\n\n    const videoStyle = {\n      transform: `scale(${videoScale})`,\n      transformOrigin: \"center center\" as const,\n      // When glare-dimming is on, reduce brightness and increase contrast so\n      // bright hotspots don't blow out ring edges.\n      filter: glareDimmingEnabled\n        ? \"saturate(1.05) contrast(1.25) brightness(0.86)\"\n        : \"saturate(1.25) contrast(1.12) brightness(1.04)\",\n      imageRendering: \"crisp-edges\" as const,\n    };\n    const activeStream =\n      (cameraSession.getMediaStream?.() as MediaStream | null) ||\n      ((videoRef.current?.srcObject as MediaStream | null) ?? null);\n    const hasTracks = !!activeStream?.getVideoTracks()?.length;\n    const showPhoneReconnect = isPhoneCamera && !phoneFeedActive;\n\n    return (\n      <div className=\"relative h-full rounded-xl overflow-hidden bg-black\">\n        <div className=\"relative w-full h-full bg-black\">\n          <video\n            ref={handleVideoRef}\n            className={videoClass}\n            style={videoStyle}\n            playsInline\n            muted\n            autoPlay\n          />\n          {/* Preview fallback canvas: used to copy video frames when the\n              native <video> element doesn't paint frames (readyState 0) but\n              dimensions are available. This canvas sits above the video and\n              below the overlay so it provides a visual preview without\n              interfering with overlay drawing. */}\n          <canvas\n            ref={previewCanvasRef}\n            className=\"absolute inset-0 w-full h-full\"\n            style={{ pointerEvents: \"none\" }}\n          />\n          <canvas\n            ref={overlayRef}\n            className=\"absolute inset-0 w-full h-full\"\n            onClick={onOverlayClick}\n          />\n          {!hasTracks && (\n            <div className=\"absolute inset-0 flex items-center justify-center bg-black/70 text-center px-4\">\n              <div className=\"space-y-3\">\n                <div className=\"text-sm font-semibold text-white\">\n                  {showPhoneReconnect\n                    ? \"Phone camera not streaming\"\n                    : \"Camera not running\"}\n                </div>\n                <div className=\"flex flex-wrap items-center justify-center gap-2 text-xs\">\n                  <button\n                    className=\"btn px-3 py-1 text-sm\"\n                    onClick={() => {\n                      try {\n                        setCameraEnabled(true);\n                      } catch {}\n                      void startCamera();\n                    }}\n                  >\n                    Start camera\n                  </button>\n                  <button\n                    className=\"btn btn--ghost px-3 py-1 text-sm\"\n                    onClick={handleUseLocalCamera}\n                  >\n                    Use local device\n                  </button>\n                  <button\n                    className=\"btn btn--ghost px-3 py-1 text-sm\"\n                    onClick={handlePhoneReconnect}\n                  >\n                    Reconnect phone\n                  </button>\n                </div>\n              </div>\n            </div>\n          )}\n        </div>\n        <canvas ref={canvasRef} className=\"hidden\"></canvas>\n      </div>\n    );\n  };\n\n  const capture = useCallback(() => {\n    try {\n      if (typeof document === \"undefined\") return;\n      const videoEl =\n        videoRef.current || cameraSession.getVideoElementRef?.() || null;\n      if (!videoEl) {\n        console.warn(\"[CameraView] capture requested without video element\");\n        return;\n      }\n      const width = videoEl.videoWidth || videoEl.clientWidth || 0;\n      const height = videoEl.videoHeight || videoEl.clientHeight || 0;\n      if (!width || !height) {\n        console.warn(\"[CameraView] capture aborted: video has no dimensions\");\n        return;\n      }\n      const captureCanvas = document.createElement(\"canvas\");\n      captureCanvas.width = width;\n      captureCanvas.height = height;\n      const ctx = captureCanvas.getContext(\"2d\");\n      if (!ctx) {\n        console.warn(\"[CameraView] capture aborted: no 2d context\");\n        return;\n      }\n      ctx.drawImage(videoEl, 0, 0, width, height);\n      captureCanvas.toBlob((blob) => {\n        if (!blob) return;\n        const url = URL.createObjectURL(blob);\n        const timestamp = new Date().toISOString().replace(/[:.]/g, \"-\");\n        const anchor = document.createElement(\"a\");\n        anchor.href = url;\n        anchor.download = `ndn-capture-${timestamp}.png`;\n        document.body.appendChild(anchor);\n        anchor.click();\n        document.body.removeChild(anchor);\n        window.setTimeout(() => URL.revokeObjectURL(url), 4000);\n      }, \"image/png\");\n    } catch (err) {\n      console.warn(\"[CameraView] capture failed\", err);\n    }\n  }, [cameraSession]);\n\n  // If an OBS (virtual/OBS) camera is present and user hasn't chosen a preferred camera,\n  // auto-select it (but do not override a locked user preference).\n  useEffect(() => {\n    try {\n      if (preferredCameraLocked) return;\n      if (preferredCameraId) return;\n      const obs = availableCameras.find((d) =>\n        /obs|virtual/i.test(String(d.label || \"\")),\n      );\n      if (obs) {\n        setPreferredCamera(obs.deviceId, obs.label || \"\", true);\n      }\n    } catch (e) {}\n  }, [\n    availableCameras,\n    preferredCameraId,\n    preferredCameraLocked,\n    setPreferredCamera,\n  ]);\n\n  // Update calibration audit status whenever homography or image size changes\n  useEffect(() => {\n    try {\n      useAudit\n        .getState()\n        .setCalibrationStatus({ hasHomography: !!H, imageSize });\n    } catch (e) {}\n  }, [H, imageSize]);\n\n  // Ensure overlay canvas pixel size matches the calibrated image size to avoid scale mismatch\n  useEffect(() => {\n    try {\n      if (!overlayRef.current || !imageSize) return;\n      const canvas = overlayRef.current;\n      if (typeof imageSize.w === \"number\" && typeof imageSize.h === \"number\") {\n        if (canvas.width !== imageSize.w || canvas.height !== imageSize.h) {\n          canvas.width = imageSize.w;\n          canvas.height = imageSize.h;\n        }\n      }\n    } catch (e) {}\n  }, [overlayRef, imageSize]);\n\n  // External autoscore subscription\n  useEffect(() => {\n    if (autoscoreProvider !== \"external-ws\" || !autoscoreWsUrl) return;\n    const sub = subscribeExternalWS(autoscoreWsUrl, (d) => {\n      if (\n        !detectionArmedRef.current ||\n        performance.now() - streamingStartMsRef.current < 5000\n      )\n        return;\n      // Route external provider hits through the same confidence/confirmation gate\n      // used by the built-in camera detector so behavior is consistent.\n      const ring = d.ring as any as Ring;\n      const value = Number(d.value) || 0;\n      const sector = (d.sector ?? null) as number | null;\n      const mult = Math.max(0, Number(d.mult) || 0) as 0 | 1 | 2 | 3;\n\n      let label = \"\";\n      if (ring === \"MISS\") {\n        label = \"MISS\";\n      } else if (ring === \"BULL\") {\n        label = \"25\";\n      } else if (ring === \"INNER_BULL\") {\n        label = \"BULL 50\";\n      } else if (sector != null) {\n        const prefix = mult === 3 ? \"T\" : mult === 2 ? \"D\" : \"\";\n        label = `${prefix}${sector}`;\n      } else {\n        label = `${ring} ${value > 0 ? value : \"\"}`.trim();\n      }\n\n      const held = maybeHoldForConfirmation({\n        value,\n        label,\n        ring,\n        confidence: (d as any)?.confidence,\n        meta: {\n          calibrationValid: false,\n          pBoard: null,\n          source: \"camera\",\n        },\n      });\n      if (held) return;\n      // Prefer parent hook if provided; otherwise add to visit directly\n      if (onAutoDart) {\n        try {\n          onAutoDart(d.value, d.ring as any, {\n            sector: d.sector ?? null,\n            mult: (d.mult as any) ?? 0,\n            // NOTE: we intentionally do not forward confidence here because the\n            // onAutoDart meta type is constrained in this file.\n          });\n        } catch (e) {}\n      } else {\n        addDart(d.value, label, d.ring as any, {\n          calibrationValid: false,\n          pBoard: null,\n          source: \"camera\",\n        });\n      }\n    });\n    return () => sub.close();\n  }, [autoscoreProvider, autoscoreWsUrl, maybeHoldForConfirmation]);\n\n  function onOverlayClick(e: React.MouseEvent<HTMLCanvasElement>) {\n    if (!overlayRef.current || !H || !imageSize) return;\n    const rect = overlayRef.current.getBoundingClientRect();\n    const x = e.clientX - rect.left;\n    const y = e.clientY - rect.top;\n    // Map to calibration coordinate space by reversing the display scaling\n    const sx =\n      overlayRef.current.width && imageSize.w\n        ? overlayRef.current.width / imageSize.w\n        : 1;\n    const sy =\n      overlayRef.current.height && imageSize.h\n        ? overlayRef.current.height / imageSize.h\n        : 1;\n    const pCal: Point = { x: x / sx, y: y / sy };\n    const score = scoreFromImagePoint(\n      H,\n      pCal,\n      theta ?? 0,\n      sectorOffset ?? 0,\n      rotationOffsetRad ?? 0,\n    );\n    const s = `${score.ring} ${score.base > 0 ? score.base : \"\"}`.trim();\n    setLastAutoScore(s);\n    setLastAutoValue(score.base);\n    setLastAutoRing(score.ring as Ring);\n    setHadRecentAuto(true);\n    // Optional immediate commit hook (e.g., Double Practice)\n    try {\n      if (immediateAutoCommit && onAutoDart) {\n        onAutoDart(score.base, score.ring as Ring, {\n          sector: score.sector,\n          mult: score.mult,\n        });\n        setHadRecentAuto(false);\n      }\n    } catch (e) {}\n  }\n\n  function parseManual(\n    input: string,\n  ): { label: string; value: number; ring: Ring } | null {\n    const t = input.trim().toUpperCase();\n    if (!t) return null;\n    const bull = t === \"BULL\" || t === \"50\" || t === \"DBULL\" || t === \"IBULL\";\n    const outerBull = t === \"25\" || t === \"OBULL\";\n    if (bull) return { label: \"INNER_BULL 50\", value: 50, ring: \"INNER_BULL\" };\n    if (outerBull) return { label: \"BULL 25\", value: 25, ring: \"BULL\" };\n    const m = t.match(/^(S|D|T)?\\s*(\\d{1,2})$/);\n    if (!m) return null;\n    const mult = (m[1] || \"S\") as \"S\" | \"D\" | \"T\";\n    const num = parseInt(m[2], 10);\n    if (num < 1 || num > 20) return null;\n    const multVal = mult === \"S\" ? 1 : mult === \"D\" ? 2 : 3;\n    const ring: Ring =\n      mult === \"S\" ? \"SINGLE\" : mult === \"D\" ? \"DOUBLE\" : \"TRIPLE\";\n    return {\n      label: `${mult}${num} ${num * multVal}`,\n      value: num * multVal,\n      ring,\n    };\n  }\n\n  function getCurrentRemaining(): number {\n    const s = matchState;\n    if (!s.players.length) return s.startingScore;\n    const p = s.players[s.currentPlayerIdx];\n    const leg = p.legs[p.legs.length - 1];\n    if (!leg) return s.startingScore;\n    return leg.totalScoreRemaining;\n  }\n\n  function sayBullDistanceMm(bullDistanceMm?: number) {\n    if (!callerEnabled) return;\n    if (typeof bullDistanceMm !== \"number\" || !Number.isFinite(bullDistanceMm))\n      return;\n    try {\n      const synth = window.speechSynthesis;\n      if (!synth) return;\n      const msg = new SpeechSynthesisUtterance();\n      const rounded = Math.round(bullDistanceMm);\n      msg.text = `${rounded} millimetres`;\n      msg.rate = 0.95;\n      msg.pitch = 1.0;\n      if (callerVoice) {\n        const v = synth.getVoices().find((v) => v.name === callerVoice);\n        if (v) msg.voice = v;\n      }\n      msg.volume =\n        typeof callerVolume === \"number\"\n          ? Math.max(0, Math.min(1, callerVolume))\n          : 1;\n      try {\n        synth.cancel();\n      } catch {}\n      synth.speak(msg);\n    } catch {}\n  }\n\n  function sayVisitTotal(visitTotal: number) {\n    if (!callerEnabled) return;\n    try {\n      const name = matchState.players[matchState.currentPlayerIdx]?.name;\n      const remaining = getCurrentRemaining();\n      sayScore(\n        name || \"Player\",\n        visitTotal,\n        Math.max(0, remaining),\n        callerVoice,\n        {\n          volume: callerVolume,\n          checkoutOnly: speakCheckoutOnly,\n        },\n      );\n    } catch {}\n  }\n\n  function addDart(\n    value: number,\n    label: string,\n    ring: Ring,\n    meta?: CameraDartMeta,\n  ) {\n    // Note: we intentionally do NOT voice-announce individual dart segments here.\n    // Users want the *visit total* (e.g., 128) rather than \"T18 T18 S20\".\n    // Visit totals are announced when the visit commits (3 darts / bust / finish).\n\n    if (shouldDeferCommit && awaitingClear) {\n      // Hardening: never drop a real dart just because we're waiting for an\n      // explicit \"board cleared\" signal. If the player throws again, assume\n      // they want to continue play and finalize the pending commit now.\n      try {\n        finalizePendingCommit(\"event\");\n      } catch (e) {}\n    }\n    const entryMeta: CameraDartMeta = meta ?? {\n      calibrationValid: false,\n      pBoard: null,\n      source: \"manual\",\n    };\n\n    if (entryMeta.source === \"camera\" && boardLockedRef.current) {\n      return;\n    }\n\n    // Allow unit tests to bypass camera auto-dedupe/cooldown by providing a stable,\n    // explicit board point. Production callers can omit it.\n    if (process.env.NODE_ENV === \"test\") {\n      try {\n        const anyMeta = entryMeta as any;\n        if (anyMeta?.__test_point && !anyMeta.pBoard) {\n          anyMeta.pBoard = anyMeta.__test_point;\n        }\n      } catch (e) {}\n    }\n    // In generic mode, delegate to parent without X01 bust/finish rules\n    if (scoringMode === \"custom\") {\n      // Bull-up only: accept exactly one dart per session.\n      // If the caller explicitly opts out (tests / future callers), respect it.\n      if (!entryMeta.__allowMultipleBullUp) {\n        if (bullUpFirstDartTakenRef.current) {\n          // Void/ignore any further darts.\n          return;\n        }\n        bullUpFirstDartTakenRef.current = true;\n      }\n      if (onGenericDart)\n        try {\n          onGenericDart(value, ring, { label });\n        } catch (e) {}\n      // Maintain a lightweight pending list for UI only\n      if ((pendingDartsRef.current || 0) >= 3) {\n        // Rotate to next visit locally so we don't drop darts visually\n        setPendingDarts(1);\n        setPendingScore(value);\n        setPendingEntries([{ label, value, ring, meta: entryMeta }]);\n        try {\n          usePendingVisit\n            .getState()\n            .setVisit(\n              [{ label, value, ring, meta: entryMeta }] as any,\n              1,\n              value,\n            );\n        } catch (e) {}\n        try {\n          if (entryMeta.source === \"camera\") playBell();\n        } catch (e) {}\n        return;\n      }\n      const newDarts = pendingDarts + 1;\n      setPendingDarts(newDarts);\n      pendingDartsRef.current = newDarts;\n      setPendingScore((s) => s + value);\n      setPendingEntries((e) => [...e, { label, value, ring, meta: entryMeta }]);\n      try {\n        const nextEntries = [\n          ...(pendingEntries as any[]),\n          { label, value, ring, meta: entryMeta },\n        ];\n        const total = nextEntries.reduce(\n          (sum, en) => sum + (Number(en?.value) || 0),\n          0,\n        );\n        usePendingVisit\n          .getState()\n          .setVisit(nextEntries as any, newDarts, total);\n      } catch (e) {}\n      return;\n    }\n\n    // If a new dart arrives while 3 are pending, auto-commit previous visit and start a new one\n    if ((pendingDartsRef.current || 0) >= 3) {\n      const previousScore = pendingScore;\n      const previousDarts = pendingDarts;\n      const previousEntries = snapshotPendingDartEntries(\n        pendingEntries as any[],\n      );\n      // Commit previous full visit\n      callAddVisit(previousScore, previousDarts, {\n        preOpenDarts: pendingPreOpenDarts || 0,\n        doubleWindowDarts: pendingDartsAtDouble || 0,\n        finishedByDouble: false,\n        visitTotal: previousScore,\n        entries: previousEntries,\n      });\n      try {\n        const name = matchState.players[matchState.currentPlayerIdx]?.name;\n        if (name) addSample(name, previousDarts, previousScore);\n      } catch (e) {}\n      // Start next visit with this dart\n      const willCount =\n        !x01DoubleIn || isOpened || ring === \"DOUBLE\" || ring === \"INNER_BULL\";\n      const applied = willCount ? value : 0;\n      setPendingDarts(1);\n      pendingDartsRef.current = 1;\n      setPendingScore(applied);\n      setPendingEntries([{ label, value: applied, ring, meta: entryMeta }]);\n      try {\n        usePendingVisit\n          .getState()\n          .setVisit(\n            [{ label, value: applied, ring, meta: entryMeta }] as any,\n            1,\n            applied,\n          );\n      } catch (e) {}\n      try {\n        if (entryMeta.source === \"camera\") playBell();\n      } catch (e) {}\n      setPendingPreOpenDarts(willCount ? 0 : 1);\n      setPendingDartsAtDouble(0);\n      if (\n        x01DoubleIn &&\n        !isOpened &&\n        (ring === \"DOUBLE\" || ring === \"INNER_BULL\")\n      ) {\n        setOpened(true);\n      }\n      enqueueVisitCommit({\n        score: previousScore,\n        darts: previousDarts,\n        finished: false,\n      });\n      return;\n    }\n    const newDarts = (pendingDartsRef.current || 0) + 1;\n    if (entryMeta.source === \"camera\" && newDarts >= 3) {\n      boardLockedRef.current = true;\n      boardClearStartRef.current = 0;\n    }\n    console.log(\n      `[CameraView] addDart: value=${value} ring=${ring} -> pending=${newDarts}`,\n    );\n    // Apply X01 Double-In rule before scoring if enabled and not opened yet\n    const countsForScore =\n      !x01DoubleIn || isOpened || ring === \"DOUBLE\" || ring === \"INNER_BULL\";\n    const appliedValue = countsForScore ? value : 0;\n    if (\n      x01DoubleIn &&\n      !isOpened &&\n      (ring === \"DOUBLE\" || ring === \"INNER_BULL\")\n    ) {\n      setOpened(true);\n    }\n    const newScore = pendingScore + appliedValue;\n    const remaining = getCurrentRemaining();\n    const after = remaining - newScore;\n\n    // Bust conditions (double-out): negative or 1, or 0 without double/inner bull\n    const isFinish =\n      after === 0 && (ring === \"DOUBLE\" || ring === \"INNER_BULL\");\n    const isBust = after < 0 || after === 1 || (after === 0 && !isFinish);\n\n    if (isBust) {\n      // Commit bust visit: 0 score, darts thrown so far including this one\n      const bustEntries = snapshotPendingDartEntries([\n        ...(pendingEntries as any[]),\n        { label, value: appliedValue, ring },\n      ]);\n      const preOpenThis =\n        x01DoubleIn &&\n        !isOpened &&\n        !(ring === \"DOUBLE\" || ring === \"INNER_BULL\")\n          ? 1\n          : 0;\n      const preOpenTotal = (pendingPreOpenDarts || 0) + preOpenThis;\n      // Count attempts in double-out window\n      const postAfter = after;\n      const postBefore = after + appliedValue;\n      const attemptsThisDart =\n        (postBefore > 50 && postAfter <= 50) || postBefore <= 50 ? 1 : 0;\n      const attemptsTotal = (pendingDartsAtDouble || 0) + attemptsThisDart;\n      callAddVisit(0, newDarts, {\n        preOpenDarts: preOpenTotal,\n        doubleWindowDarts: attemptsTotal,\n        finishedByDouble: false,\n        visitTotal: 0,\n        entries: bustEntries,\n      });\n      if (shouldDeferCommit) {\n        sayVisitTotal(0);\n      }\n      setPendingDarts(0);\n      pendingDartsRef.current = 0;\n      setPendingScore(0);\n      setPendingEntries([]);\n      setVisitMarkers([]);\n      setPendingPreOpenDarts(0);\n      setPendingDartsAtDouble(0);\n      enqueueVisitCommit({ score: 0, darts: newDarts, finished: false });\n      try {\n        usePendingVisit.getState().reset();\n      } catch (e) {}\n      return;\n    }\n\n    // Normal add (value may be zero if not opened yet)\n    setPendingDarts(newDarts);\n    pendingDartsRef.current = newDarts;\n    setPendingScore(newScore);\n    setPendingEntries((e) => {\n      const next = [\n        ...e,\n        { label, value: appliedValue, ring, meta: entryMeta },\n      ];\n      try {\n        const total = next.reduce(\n          (sum, en) => sum + (Number(en?.value) || 0),\n          0,\n        );\n        usePendingVisit.getState().setVisit(next as any, newDarts, total);\n      } catch (e) {}\n      return next;\n    });\n\n    // Persistent visual markers\n    try {\n      let tipPx: Point | undefined | null = (meta as any)?.__tipVideoPx ?? null;\n      if (!tipPx) tipPx = diagnosticsRef.current.lastTip ?? null;\n      if (tipPx && typeof tipPx.x === \"number\" && typeof tipPx.y === \"number\") {\n        if (entryMeta.source === \"camera\") {\n          committedTipsRef.current = [\n            ...committedTipsRef.current,\n            { tip: { ...tipPx }, ts: Date.now() },\n          ].slice(-6);\n        }\n        setVisitMarkers((prev) => [\n          ...prev,\n          { x: tipPx!.x, y: tipPx!.y, label },\n        ]);\n        setRegisteredTip({\n          x: tipPx.x,\n          y: tipPx.y,\n          expires: Date.now() + 2000,\n        });\n      }\n    } catch (e) {}\n\n    try {\n      if (entryMeta.source === \"camera\") playBell();\n    } catch (e) {}\n\n    // Voice callouts\n    if (shouldDeferCommit && (isFinish || newDarts === 3)) {\n      // Provide immediate feedback when we're deferring the actual commit\n      sayVisitTotal(newScore);\n    }\n\n    if (\n      x01DoubleIn &&\n      !isOpened &&\n      !(ring === \"DOUBLE\" || ring === \"INNER_BULL\")\n    ) {\n      setPendingPreOpenDarts((n) => (n || 0) + 1);\n    }\n    // Track double-out attempts within this visit\n    {\n      const postAfter = after;\n      const postBefore = after + appliedValue;\n      const countThisDart =\n        (postBefore > 50 && postAfter <= 50) || postBefore <= 50;\n      if (countThisDart) setPendingDartsAtDouble((c) => (c || 0) + 1);\n    }\n\n    if (isFinish) {\n      // Commit visit with current total and end leg\n      const finishEntries = snapshotPendingDartEntries([\n        ...(pendingEntries as any[]),\n        { label, value: appliedValue, ring },\n      ]);\n      const frame = captureFrame();\n      callAddVisit(newScore, newDarts, {\n        preOpenDarts: pendingPreOpenDarts || 0,\n        doubleWindowDarts: pendingDartsAtDouble || 0,\n        finishedByDouble: true,\n        visitTotal: newScore,\n        entries: finishEntries,\n      });\n      callEndLeg(newScore);\n      setPendingDarts(0);\n      pendingDartsRef.current = 0;\n      setPendingScore(0);\n      setPendingEntries([]);\n      setVisitMarkers([]);\n      setPendingPreOpenDarts(0);\n      setPendingDartsAtDouble(0);\n      enqueueVisitCommit({\n        score: newScore,\n        darts: newDarts,\n        finished: true,\n        meta: {\n          label,\n          ring,\n          entries: finishEntries,\n          frame,\n        },\n      });\n      try {\n        usePendingVisit.getState().reset();\n      } catch (e) {}\n      return;\n    }\n\n    if (newDarts >= 3) {\n      const commitEntries = snapshotPendingDartEntries([\n        ...(pendingEntries as any[]),\n        { label, value: appliedValue, ring },\n      ]);\n      callAddVisit(newScore, newDarts, {\n        preOpenDarts: pendingPreOpenDarts || 0,\n        doubleWindowDarts: pendingDartsAtDouble || 0,\n        finishedByDouble: false,\n        visitTotal: newScore,\n        entries: commitEntries,\n      });\n      try {\n        if (entryMeta.source === \"camera\") playBell();\n      } catch (e) {}\n      setPendingDarts(0);\n      pendingDartsRef.current = 0;\n      setPendingScore(0);\n      setPendingEntries([]);\n      setVisitMarkers([]);\n      setPendingPreOpenDarts(0);\n      setPendingDartsAtDouble(0);\n      enqueueVisitCommit({ score: newScore, darts: newDarts, finished: false });\n      try {\n        usePendingVisit.getState().reset();\n      } catch (e) {}\n    }\n    // When a dart is added, show a short-lived overlay marker so users can\n    // visually confirm the counted location. Prefer an explicit tip from meta\n    // (auto/confirm flows may add __tipVideoPx). Otherwise fall back to the\n    // best-effort diagnostics lastTip (video pixel coords).\n    // (Handled above for persistent markers)\n  }\n\n  function onAddAutoDart() {\n    if (shouldDeferCommit && awaitingClear) return;\n    if (lastAutoScore) {\n      if (onAutoDart) {\n        try {\n          onAutoDart(lastAutoValue, lastAutoRing, undefined);\n        } catch (e) {}\n      } else {\n        addDart(lastAutoValue, lastAutoScore, lastAutoRing);\n      }\n      setNonRegCount(0);\n      setHadRecentAuto(false);\n    }\n  }\n\n  function onApplyManual() {\n    if (shouldDeferCommit && awaitingClear) return;\n    const parsed = parseManual(manualScore);\n    if (!parsed) {\n      alert(\"Enter like T20, D16, 5, 25, 50\");\n      return;\n    }\n    // If autoscore didn't register recently, count toward realignment\n    if (\n      !hadRecentAuto ||\n      !lastAutoScore ||\n      lastAutoRing === \"MISS\" ||\n      lastAutoValue === 0\n    ) {\n      const c = nonRegCount + 1;\n      setNonRegCount(c);\n      if (c >= 5) setShowRecalModal(true);\n    } else {\n      setNonRegCount(0);\n    }\n    addDart(parsed.value, parsed.label, parsed.ring);\n    setManualScore(\"\");\n    setHadRecentAuto(false);\n  }\n\n  // Replace the last pending dart with a manually typed correction\n  function onReplaceManual() {\n    if (shouldDeferCommit && awaitingClear) return;\n    const parsed = parseManual(manualScore);\n    if (!parsed) {\n      alert(\"Enter like T20, D16, 5, 25, 50\");\n      return;\n    }\n    if (pendingDarts === 0 || pendingEntries.length === 0) {\n      onApplyManual();\n      return;\n    }\n    if (scoringMode === \"custom\") {\n      // Let parent handle replacement semantics\n      if (\n        !hadRecentAuto ||\n        !lastAutoScore ||\n        lastAutoRing === \"MISS\" ||\n        lastAutoValue === 0\n      ) {\n        const c = nonRegCount + 1;\n        setNonRegCount(c);\n        if (c >= 5) setShowRecalModal(true);\n      } else setNonRegCount(0);\n\n      // Update local pending UI\n      setPendingEntries((e) => [\n        ...e.slice(0, -1),\n        { label: parsed.label, value: parsed.value, ring: parsed.ring },\n      ]);\n      if (onGenericReplace)\n        try {\n          onGenericReplace(parsed.value, parsed.ring, { label: parsed.label });\n        } catch {}\n      setManualScore(\"\");\n      setHadRecentAuto(false);\n      return;\n    }\n    if (\n      !hadRecentAuto ||\n      !lastAutoScore ||\n      lastAutoRing === \"MISS\" ||\n      lastAutoValue === 0\n    ) {\n      const c = nonRegCount + 1;\n      setNonRegCount(c);\n      if (c >= 5) setShowRecalModal(true);\n    } else setNonRegCount(0);\n\n    const last = pendingEntries[pendingEntries.length - 1];\n    const prevDarts = pendingDarts - 1;\n    const prevScore = pendingScore - (last?.value || 0);\n    const remaining = getCurrentRemaining();\n    const newScore = prevScore + parsed.value;\n    const newDarts = prevDarts + 1;\n    const after = remaining - newScore;\n    const isFinish =\n      after === 0 && (parsed.ring === \"DOUBLE\" || parsed.ring === \"INNER_BULL\");\n    const isBust = after < 0 || after === 1 || (after === 0 && !isFinish);\n\n    if (isBust) {\n      callAddVisit(0, newDarts);\n      try {\n        const name = matchState.players[matchState.currentPlayerIdx]?.name;\n        if (name) addSample(name, newDarts, 0);\n      } catch (e) {}\n      if (shouldDeferCommit) {\n        sayVisitTotal(0);\n      }\n      setPendingDarts(0);\n      pendingDartsRef.current = 0;\n      setPendingScore(0);\n      setPendingEntries([]);\n      setVisitMarkers([]);\n      enqueueVisitCommit({ score: 0, darts: newDarts, finished: false });\n      setManualScore(\"\");\n      setHadRecentAuto(false);\n      return;\n    }\n\n    setPendingDarts(newDarts);\n    pendingDartsRef.current = newDarts;\n    setPendingScore(newScore);\n    setPendingEntries((e) => [\n      ...e.slice(0, -1),\n      { label: parsed.label, value: parsed.value, ring: parsed.ring },\n    ]);\n\n    // Snappy voice call for the replacement\n    if (shouldDeferCommit && (isFinish || newDarts === 3)) {\n      sayVisitTotal(newScore);\n    }\n\n    if (isFinish) {\n      callAddVisit(newScore, newDarts);\n      callEndLeg(newScore);\n      try {\n        const name = matchState.players[matchState.currentPlayerIdx]?.name;\n        if (name) addSample(name, newDarts, newScore);\n      } catch (e) {}\n      setPendingDarts(0);\n      pendingDartsRef.current = 0;\n      setPendingScore(0);\n      setPendingEntries([]);\n      setVisitMarkers([]);\n      enqueueVisitCommit({ score: newScore, darts: newDarts, finished: true });\n      setManualScore(\"\");\n      setHadRecentAuto(false);\n      return;\n    }\n\n    if (newDarts >= 3) {\n      callAddVisit(newScore, newDarts);\n      try {\n        const name = matchState.players[matchState.currentPlayerIdx]?.name;\n        if (name) addSample(name, newDarts, newScore);\n      } catch (e) {}\n      setPendingDarts(0);\n      pendingDartsRef.current = 0;\n      setPendingScore(0);\n      setPendingEntries([]);\n      setVisitMarkers([]);\n      enqueueVisitCommit({ score: newScore, darts: newDarts, finished: false });\n    }\n    setManualScore(\"\");\n    setHadRecentAuto(false);\n  }\n\n  // Keyboard shortcut: press 'm' to open Manual Correction (if not typing in an input)\n  useEffect(() => {\n    function onKey(e: KeyboardEvent) {\n      try {\n        const active = document.activeElement as HTMLElement | null;\n        const tag = active?.tagName?.toLowerCase();\n        if (e.key === \"m\" && tag !== \"input\" && tag !== \"textarea\") {\n          setActiveTab(\"manual\");\n          setShowManualModal(true);\n        }\n      } catch (e) {}\n    }\n    window.addEventListener(\"keydown\", onKey);\n    return () => window.removeEventListener(\"keydown\", onKey);\n  }, []);\n\n  // Centralized quick-entry handler for S/D/T 1-20 buttons\n  function onQuickEntry(num: number, mult: \"S\" | \"D\" | \"T\") {\n    if (pendingDarts >= 3 || (shouldDeferCommit && awaitingClear)) return;\n    const val = num * (mult === \"S\" ? 1 : mult === \"D\" ? 2 : 3);\n    const ring: Ring =\n      mult === \"S\" ? \"SINGLE\" : mult === \"D\" ? \"DOUBLE\" : \"TRIPLE\";\n    // If autoscore didn't register recently, count toward realignment\n    if (\n      !hadRecentAuto ||\n      !lastAutoScore ||\n      lastAutoRing === \"MISS\" ||\n      lastAutoValue === 0\n    ) {\n      const c = nonRegCount + 1;\n      setNonRegCount(c);\n      if (c >= 5) setShowRecalModal(true);\n    } else {\n      setNonRegCount(0);\n    }\n    addDart(val, `${mult}${num} ${val}`, ring);\n    setHadRecentAuto(false);\n  }\n\n  function onUndoDart() {\n    if (pendingDarts === 0) return;\n    const last = pendingEntries[pendingEntries.length - 1];\n    setPendingDarts((d) => d - 1);\n    pendingDartsRef.current = Math.max(0, (pendingDartsRef.current || 0) - 1);\n    setPendingScore((s) => s - (last?.value || 0));\n    setPendingEntries((e) => e.slice(0, -1));\n  }\n\n  function onCommitVisit() {\n    if (pendingDarts === 0 || (shouldDeferCommit && awaitingClear)) return;\n    if (commitBlocked) {\n      try {\n        window.alert(\n          \"Cannot commit: pending camera detections require camera connection validation for online matches\",\n        );\n      } catch {}\n      return;\n    }\n    if (scoringMode === \"custom\") {\n      // For custom mode, simply clear local pending (parent maintains its own scoring)\n      setPendingDarts(0);\n      pendingDartsRef.current = 0;\n      pendingDartsRef.current = 0;\n      setPendingScore(0);\n      setPendingEntries([]);\n      setVisitMarkers([]);\n      return;\n    }\n    const visitScore = pendingScore;\n    const visitDarts = pendingDarts;\n    const commitEntries = snapshotPendingDartEntries(pendingEntries as any[]);\n    callAddVisit(visitScore, visitDarts, {\n      entries: commitEntries,\n      visitTotal: visitScore,\n    });\n    try {\n      const name = matchState.players[matchState.currentPlayerIdx]?.name;\n      if (name) addSample(name, visitDarts, visitScore);\n    } catch (e) {}\n    setPendingDarts(0);\n    pendingDartsRef.current = 0;\n    setPendingScore(0);\n    setPendingEntries([]);\n    setVisitMarkers([]);\n    enqueueVisitCommit({\n      score: visitScore,\n      darts: visitDarts,\n      finished: false,\n    });\n  }\n\n  const mainContent = (\n    <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-4 w-full min-w-0\">\n      {/* Pills (optional; can be hidden and controlled by parent) */}\n      {showToolbar && !minimalControls && (\n        <div className=\"lg:col-span-2\">\n          <div className=\"flex items-center gap-2 mb-2\">\n            <button\n              className={`btn px-3 py-1 text-sm ${activeTab === \"manual\" ? \"tab--active\" : \"\"}`}\n              onClick={() => {\n                setActiveTab(\"manual\");\n                setShowManualModal(true);\n              }}\n              title=\"Open Manual Correction\"\n            >\n              Manual Correction\n            </button>\n          </div>\n        </div>\n      )}\n      {!hideInlinePanels ? (\n        <div className=\"card relative camera-fullwidth-card lg:col-span-2 w-full min-w-0\">\n          <div className=\"camera-fullwidth-body flex flex-col gap-4 w-full min-w-0\">\n            <h2 className=\"text-xl font-semibold mb-3\">Camera</h2>\n            <ResizablePanel\n              storageKey=\"ndn:camera:size\"\n              className=\"relative rounded-2xl overflow-hidden bg-black w-full\"\n              defaultWidth={480}\n              defaultHeight={360}\n              minWidth={360}\n              minHeight={270}\n              maxWidth={800}\n              maxHeight={600}\n              autoFill\n            >\n              <CameraSelector />\n              {(() => {\n                const aspect =\n                  cameraAspect ||\n                  useUserSettings.getState().cameraAspect ||\n                  \"wide\";\n                const fit =\n                  (cameraFitMode ||\n                    useUserSettings.getState().cameraFitMode ||\n                    \"fit\") === \"fit\";\n                const videoClass =\n                  aspect === \"square\"\n                    ? \"absolute left-0 top-1/2 -translate-y-1/2 min-w-full min-h-full object-cover object-left bg-black\"\n                    : fit\n                      ? \"absolute inset-0 w-full h-full object-contain object-center bg-black\"\n                      : \"absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 min-w-full min-h-full w-auto h-auto object-cover object-center bg-black ndn-video-smooth\";\n                const videoScale = cameraScale ?? 1;\n                const glareDimmingEnabled =\n                  typeof window !== \"undefined\" &&\n                  (window.localStorage?.getItem(\"ndn.glareDimming\") === \"1\" ||\n                    window.localStorage?.getItem(\"ndn.glareClamp\") === \"1\");\n                const videoStyle = {\n                  transform: `scale(${videoScale})`,\n                  transformOrigin: \"center center\" as const,\n                  // Mild pop and clarity boost (safe for detection). Adjusted to be crisper without over-sharpening.\n                  filter: glareDimmingEnabled\n                    ? \"saturate(1.05) contrast(1.25) brightness(0.86)\"\n                    : \"saturate(1.25) contrast(1.12) brightness(1.04)\",\n                  imageRendering: \"crisp-edges\" as const,\n                };\n                const containerClass =\n                  aspect === \"square\"\n                    ? \"relative w-full mx-auto aspect-square bg-black\"\n                    : \"relative w-full aspect-[4/3] bg-black\";\n                const renderVideoSurface = () => (\n                  <div className={`camera-viewport ${containerClass}`}>\n                    <video\n                      ref={handleVideoRef}\n                      className={videoClass}\n                      style={videoStyle}\n                      playsInline\n                      muted\n                      autoPlay\n                    />\n                    <canvas\n                      ref={overlayRef}\n                      className=\"absolute inset-0 w-full h-full\"\n                      onClick={onOverlayClick}\n                    />\n                    <div\n                      className=\"absolute top-2 left-1/2 -translate-x-1/2 z-20 flex items-center gap-3 cursor-pointer select-none\"\n                      onDoubleClick={handleIndicatorReset}\n                      aria-label={`Visit status: ${pendingEntries[0] ? (pendingEntries[0].value > 0 ? \"hit\" : \"miss\") : \"pending\"}, ${pendingEntries[1] ? (pendingEntries[1].value > 0 ? \"hit\" : \"miss\") : \"pending\"}, ${pendingEntries[2] ? (pendingEntries[2].value > 0 ? \"hit\" : \"miss\") : \"pending\"}`}\n                    >\n                      {[0, 1, 2].map((i) => {\n                        const e = pendingEntries[i] as any;\n                        const entrySeq = indicatorEntryVersions[i];\n                        const isPending = !e;\n                        const isActive = !!e && entrySeq === indicatorVersion;\n                        const hasPositiveValue =\n                          typeof e?.value === \"number\" ? e.value > 0 : false;\n                        const hasHitRing =\n                          (e?.ring && e.ring !== \"MISS\") ?? false;\n                        const isHit =\n                          isActive && (hasPositiveValue || hasHitRing);\n                        const color = !isActive\n                          ? \"bg-gray-500/70\"\n                          : isHit\n                            ? \"bg-emerald-400\"\n                            : \"bg-rose-500\";\n                        const activeState = isActive && !isPending;\n                        return (\n                          <span\n                            key={i}\n                            className={`visit-dot ${activeState ? \"active\" : \"inactive\"} ${color}`}\n                          />\n                        );\n                      })}\n                      {dartTimerEnabled && dartTimeLeft !== null && (\n                        <span className=\"px-2 py-0.5 rounded bg-black/60 text-white text-xs font-semibold\">\n                          {Math.max(0, dartTimeLeft)}s\n                        </span>\n                      )}\n                    </div>\n                    {shouldDeferCommit && awaitingClear ? (\n                      <div className=\"absolute bottom-3 left-1/2 -translate-x-1/2 z-20 bg-black/70 text-amber-200 text-xs font-semibold px-3 py-1 rounded-full shadow\">\n                        Remove darts to continue\n                      </div>\n                    ) : null}\n                  </div>\n                );\n                if (isPhoneCamera) {\n                  if (!phoneFeedActive) {\n                    return (\n                      <div className=\"w-full h-full flex flex-col items-center justify-center bg-gradient-to-br from-blue-900/50 to-purple-900/50\">\n                        <div className=\"text-center space-y-3 max-w-xs mx-auto\">\n                          <div className=\"text-2xl font-semibold\">CAM</div>\n                          <div className=\"text-lg font-semibold text-blue-100\">\n                            Phone camera selected\n                          </div>\n                          <p className=\"text-sm text-slate-300\">\n                            Start streaming from the Camera Connection tab or\n                            reconnect below.\n                          </p>\n                          <div className=\"flex items-center justify-center gap-2 flex-wrap\">\n                            <button\n                              className=\"btn bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 text-sm\"\n                              onClick={handlePhoneReconnect}\n                            >\n                              Reconnect Phone\n                            </button>\n                            <button\n                              className=\"btn bg-slate-700 hover:bg-slate-800 text-white px-3 py-1 text-sm\"\n                              onClick={() => {\n                                try {\n                                  cameraSession.setShowOverlay?.(true);\n                                } catch (e) {}\n                              }}\n                            >\n                              Show Overlay\n                            </button>\n                            <button\n                              className=\"btn bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-1 text-sm\"\n                              onClick={handleUseLocalCamera}\n                              disabled={!availableCameras.length}\n                            >\n                              Use Local Camera\n                            </button>\n                          </div>\n                        </div>\n                      </div>\n                    );\n                  }\n                  return renderVideoSurface();\n                }\n                return renderVideoSurface();\n              })()}\n            </ResizablePanel>\n\n            {!minimalControls && (\n              <>\n                <div className=\"mt-3 flex flex-wrap items-center gap-2 text-xs\">\n                  <span className=\"uppercase tracking-wide text-slate-400\">\n                    Cam\n                  </span>\n                  <button\n                    className=\"btn btn--ghost px-2 py-1\"\n                    onClick={() => adjustCameraScale(-0.05)}\n                    title=\"Decrease camera zoom\"\n                  >\n                    -\n                  </button>\n                  <span className=\"w-10 text-center font-semibold text-white\">\n                    {Math.round((cameraScale ?? 1) * 100)}%\n                  </span>\n                  <button\n                    className=\"btn btn--ghost px-2 py-1\"\n                    onClick={() => adjustCameraScale(0.05)}\n                    title=\"Increase camera zoom\"\n                  >\n                    +\n                  </button>\n                  <button\n                    className={`btn btn--ghost px-3 py-1 text-[11px] ${cameraFitMode === \"fill\" ? \"bg-emerald-500 text-white\" : \"\"}`}\n                    onClick={setFullPreview}\n                    title=\"Show dartboard only\"\n                  >\n                    Full\n                  </button>\n                  <button\n                    className={`btn btn--ghost px-3 py-1 text-[11px] ${cameraFitMode !== \"fill\" ? \"bg-slate-200 text-slate-900\" : \"\"}`}\n                    onClick={setWidePreview}\n                    title=\"Letterbox to wide view\"\n                  >\n                    Wide\n                  </button>\n                </div>\n                <div className=\"mt-3 text-xs text-slate-400\">\n                  Manual scoring active  camera preview only.\n                </div>\n              </>\n            )}\n\n            {/* Keep the camera view clear: no floating status/commit card overlay. */}\n            {inProgress ? (\n              <div className=\"sr-only\" aria-hidden=\"true\">\n                <button\n                  data-testid=\"commit-visit-btn\"\n                  onClick={onCommitVisit}\n                  disabled={pendingDarts === 0 || commitBlocked}\n                >\n                  Commit\n                </button>\n              </div>\n            ) : null}\n            {!minimalControls && (\n              <div className=\"mt-3 rounded-2xl border border-white/10 bg-slate-900/60 p-3\">\n              <div className=\"mb-2 text-[11px] uppercase tracking-wide text-slate-400\">\n                Camera controls\n              </div>\n              <div className=\"flex flex-wrap items-center gap-2\">\n                {isPhoneCamera ? (\n                  <>\n                    <div\n                      className={`text-sm px-3 py-2 rounded border flex-1 min-w-[200px] ${phoneFeedActive ? \"bg-emerald-500/10 border-emerald-400/40 text-emerald-100\" : \"bg-amber-500/10 border-amber-400/40 text-amber-100\"}`}\n                    >\n                      {phoneFeedActive\n                        ? \"CAM Phone camera stream active\"\n                        : \"CAM Waiting for phone camera stream\"}\n                    </div>\n                    <button\n                      className=\"btn bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 text-sm\"\n                      onClick={handlePhoneReconnect}\n                    >\n                      Reconnect Phone\n                    </button>\n                    <button\n                      className=\"btn bg-slate-700 hover:bg-slate-800 text-white px-3 py-1 text-sm\"\n                      onClick={() => {\n                        try {\n                          cameraSession.setShowOverlay?.(\n                            !cameraSession.showOverlay,\n                          );\n                        } catch (e) {}\n                      }}\n                    >\n                      {cameraSession.showOverlay\n                        ? \"Hide Overlay\"\n                        : \"Show Overlay\"}\n                    </button>\n                    <button\n                      className=\"btn bg-rose-600 hover:bg-rose-700 text-white px-3 py-1 text-sm\"\n                      disabled={!phoneFeedActive}\n                      onClick={() => {\n                        try {\n                          cameraSession.clearSession?.();\n                        } catch (e) {}\n                      }}\n                    >\n                      Stop Phone Feed\n                    </button>\n                    {canFallbackToLocal && (\n                      <button\n                        className=\"btn bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-1 text-sm\"\n                        onClick={handleUseLocalCamera}\n                        disabled={!availableCameras.length}\n                      >\n                        Use Local Camera\n                      </button>\n                    )}\n                  </>\n                ) : (\n                  <>\n                    {!streaming ? (\n                      <button\n                        className=\"btn\"\n                        onClick={startCamera}\n                        disabled={cameraStarting}\n                      >\n                        {cameraStarting\n                          ? \"Connecting Camera...\"\n                          : \"Connect Camera\"}\n                      </button>\n                    ) : (\n                      <button\n                        className=\"btn bg-rose-600 hover:bg-rose-700\"\n                        onClick={stopCamera}\n                      >\n                        Stop Camera\n                      </button>\n                    )}\n                  </>\n                )}\n                {!manualOnly && (\n                  <button\n                    className=\"btn bg-slate-700 hover:bg-slate-800\"\n                    onClick={requestDeviceManager}\n                    title=\"Open phone, WiFi, and USB camera options\"\n                  >\n                    Camera Devices\n                  </button>\n                )}\n                <button\n                  className=\"btn btn--ghost px-3 py-1 text-sm\"\n                  onClick={() => setHideCameraOverlay(!hideCameraOverlay)}\n                  title=\"Toggle the board guide overlay\"\n                >\n                  {hideCameraOverlay\n                    ? \"Show board guides\"\n                    : \"Hide board guides\"}\n                </button>\n                <button\n                  className=\"btn\"\n                  onClick={capture}\n                  disabled={!effectiveStreaming}\n                >\n                  Capture Still\n                </button>\n                {matchState?.inProgress && (\n                  <>\n                    <PauseTimerBadge compact />\n                    <button\n                      className=\"btn bg-rose-600 hover:bg-rose-700 text-white px-3 py-1 text-sm\"\n                      onClick={() => setShowQuitPause(true)}\n                    >\n                      Quit / Pause\n                    </button>\n                    {showQuitPause && (\n                      <PauseQuitModal\n                        onClose={() => setShowQuitPause(false)}\n                        onQuit={() => {\n                          try {\n                            // Emit a global event other parts of the app can listen to\n                            window.dispatchEvent(\n                              new CustomEvent(\"ndn:match-quit\"),\n                            );\n                            // broadcast to other windows\n                            try {\n                              broadcastMessage({ type: \"quit\" });\n                            } catch {}\n                          } catch (e) {}\n                          setShowQuitPause(false);\n                        }}\n                        onPause={(minutes) => {\n                          const endsAt = Date.now() + minutes * 60 * 1000;\n                          try {\n                            useMatchControl.getState().setPaused(true, endsAt);\n                            try {\n                              broadcastMessage({\n                                type: \"pause\",\n                                pauseEndsAt: endsAt,\n                                pauseStartedAt: Date.now(),\n                              });\n                            } catch {}\n                          } catch (e) {}\n                          setShowQuitPause(false);\n                        }}\n                      />\n                    )}\n                    <button\n                      className=\"btn btn--ghost px-3 py-1 text-sm\"\n                      onClick={() => {\n                        try {\n                          writeMatchSnapshot();\n                          window.open(\n                            `${window.location.origin}${window.location.pathname}?match=1`,\n                            \"_blank\",\n                          );\n                        } catch (e) {}\n                      }}\n                    >\n                      Open match in new window\n                    </button>\n                    <button\n                      className=\"btn btn--ghost px-3 py-1 text-sm\"\n                      onClick={async () => {\n                        try {\n                          if (document.documentElement.requestFullscreen) {\n                            await document.documentElement.requestFullscreen();\n                          } else if ((document as any).body.requestFullscreen) {\n                            await (document as any).body.requestFullscreen();\n                          }\n                        } catch (e) {}\n                      }}\n                    >\n                      Open full screen\n                    </button>\n                  </>\n                )}\n                <button\n                  className=\"btn bg-slate-700 hover:bg-slate-800\"\n                  onClick={() => {\n                    try {\n                      window.dispatchEvent(\n                        new Event(\"ndn:camera-reset\" as any),\n                      );\n                    } catch (e) {}\n                  }}\n                >\n                  Reset Camera Size\n                </button>\n              </div>\n              </div>\n            )}\n          </div>\n        </div>\n      ) : null}\n\n      {/* Floating Manual Correction button (always available for quick manual typing during games) */}\n      {inProgress ? (\n        <div className=\"fixed bottom-6 right-6 z-50\">\n          <button\n            className=\"btn btn--primary rounded-full w-12 h-12 flex items-center justify-center shadow-lg\"\n            title=\"Open Manual Correction (M)\"\n            onClick={() => {\n              setActiveTab(\"manual\");\n              setShowManualModal(true);\n            }}\n          >\n            ??\n          </button>\n        </div>\n      ) : null}\n      {/* Snapshot panel removed to reduce unused space */}\n      <canvas ref={canvasRef} className=\"hidden\"></canvas>\n\n      {/* Confirm uncertain dart (low confidence) */}\n      {pendingConfirm && (\n        <div\n          className=\"fixed inset-0 bg-black/70 z-[99999]\"\n          role=\"dialog\"\n          aria-modal=\"true\"\n        >\n          {/* moved to top-center to keep board visible */}\n          <div className=\"absolute inset-0 flex items-start justify-center p-6 pt-16\">\n            <div className=\"card w-full max-w-lg mx-auto\">\n              <div className=\"flex items-center justify-between mb-2\">\n                <h3 className=\"text-lg font-semibold\">Confirm detected dart</h3>\n                <button\n                  className=\"btn btn--ghost\"\n                  onClick={() => setPendingConfirm(null)}\n                >\n                  Close\n                </button>\n              </div>\n              <div className=\"text-sm opacity-80 mb-3\">\n                This hit was detected with lower confidence.\n              </div>\n              <div className=\"flex flex-col gap-2 mb-3\">\n                <div>\n                  <span className=\"font-semibold\">Detected:</span>{\" \"}\n                  {pendingConfirm.label}\n                </div>\n                <div>\n                  <span className=\"font-semibold\">Confidence:</span>{\" \"}\n                  {pendingConfirm.confidence.toFixed(2)}\n                </div>\n              </div>\n              <div className=\"flex flex-wrap gap-2\">\n                <button\n                  className=\"btn\"\n                  onClick={() => {\n                    try {\n                      addDart(\n                        pendingConfirm.value,\n                        pendingConfirm.label,\n                        pendingConfirm.ring,\n                        pendingConfirm.meta,\n                      );\n                    } catch (e) {}\n                    setPendingConfirm(null);\n                  }}\n                >\n                  Accept\n                </button>\n                <button\n                  className=\"btn btn--ghost\"\n                  onClick={() => setPendingConfirm(null)}\n                >\n                  Reject\n                </button>\n                <button\n                  className=\"btn bg-slate-700 hover:bg-slate-800\"\n                  onClick={() => {\n                    setPendingConfirm(null);\n                    setShowManualModal(true);\n                    setActiveTab(\"manual\");\n                  }}\n                >\n                  Open Manual Correction\n                </button>\n              </div>\n            </div>\n          </div>\n        </div>\n      )}\n\n      {showManualModal && (\n        <div\n          className=\"fixed inset-0 bg-black/60 z-[100]\"\n          role=\"dialog\"\n          aria-modal=\"true\"\n        >\n          <div className=\"absolute inset-0 flex flex-col\">\n            <FocusLock returnFocus>\n              <div className=\"p-3 md:p-4 flex items-center justify-between\">\n                <h3 className=\"text-xl md:text-2xl font-semibold\">\n                  Manual Correction\n                </h3>\n                <div className=\"flex items-center gap-2\">\n                  <button\n                    className=\"btn bg-slate-700 hover:bg-slate-800\"\n                    onClick={() => {\n                      setShowManualModal(false);\n                    }}\n                  >\n                    Close\n                  </button>\n                </div>\n              </div>\n              <div className=\"flex-1 p-3 md:p-4\">\n                <div className=\"h-full grid grid-cols-1 lg:grid-cols-2 gap-4\">\n                  {/* Live preview */}\n                  <div className=\"card relative flex flex-col\">\n                    <div className=\"text-sm font-semibold mb-2\">\n                      Live Preview\n                    </div>\n                    <div className=\"relative flex-1 rounded-2xl overflow-hidden bg-black\">\n                      <canvas\n                        ref={manualPreviewRef}\n                        className=\"absolute inset-0 w-full h-full\"\n                      />\n                    </div>\n                  </div>\n                  {/* Manual controls */}\n                  <div className=\"card flex flex-col\">\n                    <div className=\"text-sm opacity-80 mb-2\">\n                      Type a correction or replace the last dart. The preview\n                      updates live.\n                    </div>\n                    <div className=\"flex items-center gap-2 mb-2\">\n                      <span className=\"font-semibold\">Last auto:</span>\n                      <span>{lastAutoScore || \"\"}</span>\n                      <button\n                        className=\"btn\"\n                        onClick={onAddAutoDart}\n                        disabled={pendingDarts >= 3}\n                      >\n                        Add Auto Dart\n                      </button>\n                    </div>\n                    <div className=\"flex items-center gap-2 mb-2\">\n                      <input\n                        className=\"input flex-[1.2]\"\n                        placeholder=\"Manual (T20, D16, 5, 25, 50)\"\n                        value={manualScore}\n                        onChange={(e) => setManualScore(e.target.value)}\n                        onKeyDown={(e) => {\n                          if (e.key === \"Enter\" && !e.shiftKey) {\n                            e.preventDefault();\n                            onApplyManual();\n                          }\n                          if (e.key === \"Enter\" && e.shiftKey) {\n                            e.preventDefault();\n                            onReplaceManual();\n                          }\n                        }}\n                      />\n                      <button\n                        className=\"btn btn--ghost\"\n                        onClick={onReplaceManual}\n                        disabled={pendingDarts === 0}\n                      >\n                        Replace Last\n                      </button>\n                      <button\n                        className=\"btn\"\n                        onClick={onApplyManual}\n                        disabled={pendingDarts >= 3}\n                      >\n                        Add\n                      </button>\n                    </div>\n                    <div className=\"text-xs opacity-70 mb-4\">\n                      Press Enter to Add  Shift+Enter to Replace Last\n                    </div>\n                    {/* Numeric keypad for quick manual numeric entry */}\n                    <div className=\"mb-4\">\n                      <div className=\"text-sm font-semibold mb-2\">\n                        Number pad\n                      </div>\n                      <div className=\"grid grid-cols-3 gap-2 max-w-sm\">\n                        {[\"7\", \"8\", \"9\", \"4\", \"5\", \"6\", \"1\", \"2\", \"3\", \"0\"].map(\n                          (d) => (\n                            <button\n                              key={d}\n                              className=\"btn text-lg\"\n                              onClick={() => {\n                                // Append digit to manualScore (keep T/D/T prefixes if present)\n                                setManualScore((ms) => {\n                                  // If existing starts with letter (S/D/T), append after it\n                                  if (/^[SDT]/i.test(ms)) return ms + d;\n                                  return (ms || \"\") + d;\n                                });\n                              }}\n                            >\n                              {d}\n                            </button>\n                          ),\n                        )}\n                        <button\n                          className=\"btn bg-rose-600 hover:bg-rose-700 text-white\"\n                          onClick={() => setManualScore(\"\")}\n                        >\n                          Clear\n                        </button>\n                        <button\n                          className=\"btn bg-slate-600 hover:bg-slate-700 text-white\"\n                          onClick={() =>\n                            setManualScore((ms) => (ms || \"\").slice(0, -1))\n                          }\n                        >\n                          ?\n                        </button>\n                        <button\n                          className=\"btn bg-emerald-600 hover:bg-emerald-700 text-white\"\n                          onClick={() => onApplyManual()}\n                          disabled={pendingDarts >= 3}\n                        >\n                          Enter\n                        </button>\n                      </div>\n                      <div className=\"text-xs opacity-70 mt-2\">\n                        Tap numbers then press Enter to submit. Use D/T prefixes\n                        for doubles/trebles (e.g., D16).\n                      </div>\n                    </div>\n                    <div className=\"mt-auto\">\n                      <div className=\"text-sm font-semibold mb-2\">\n                        Quick entry\n                      </div>\n                      {/* Bulls */}\n                      <div className=\"flex flex-wrap gap-2 mb-3\">\n                        <button\n                          className=\"btn\"\n                          disabled={pendingDarts >= 3}\n                          onClick={() => {\n                            if (\n                              !hadRecentAuto ||\n                              !lastAutoScore ||\n                              lastAutoRing === \"MISS\" ||\n                              lastAutoValue === 0\n                            ) {\n                              const c = nonRegCount + 1;\n                              setNonRegCount(c);\n                              if (c >= 5) setShowRecalModal(true);\n                            } else setNonRegCount(0);\n                            addDart(25, \"BULL 25\", \"BULL\");\n                            setHadRecentAuto(false);\n                          }}\n                        >\n                          25\n                        </button>\n                        <button\n                          className=\"btn\"\n                          disabled={pendingDarts >= 3}\n                          onClick={() => {\n                            if (\n                              !hadRecentAuto ||\n                              !lastAutoScore ||\n                              lastAutoRing === \"MISS\" ||\n                              lastAutoValue === 0\n                            ) {\n                              const c = nonRegCount + 1;\n                              setNonRegCount(c);\n                              if (c >= 5) setShowRecalModal(true);\n                            } else setNonRegCount(0);\n                            addDart(50, \"INNER_BULL 50\", \"INNER_BULL\");\n                            setHadRecentAuto(false);\n                          }}\n                        >\n                          50\n                        </button>\n                      </div>\n                      {/* Grouped dropdown: Doubles, Singles, Trebles */}\n                      <div className=\"flex items-center gap-2 mb-3\">\n                        <input\n                          className=\"input w-full max-w-sm\"\n                          list=\"manual-quick-list\"\n                          placeholder=\"Type or select (e.g., D16, T20, S5)\"\n                          value={quickSelManual}\n                          onChange={(e) =>\n                            setQuickSelManual(e.target.value.toUpperCase())\n                          }\n                          onKeyDown={(e) => {\n                            if (e.key === \"Enter\") {\n                              const m =\n                                quickSelManual.match(/^(S|D|T)(\\d{1,2})$/);\n                              if (m) {\n                                onQuickEntry(parseInt(m[2], 10), m[1] as any);\n                              }\n                            }\n                          }}\n                        />\n                        <datalist id=\"manual-quick-list\">\n                          {([\"D\", \"S\", \"T\"] as const).map((mult) =>\n                            Array.from({ length: 20 }, (_, i) => i + 1).map(\n                              (num) => (\n                                <option\n                                  key={`${mult}${num}`}\n                                  value={`${mult}${num}`}\n                                />\n                              ),\n                            ),\n                          )}\n                        </datalist>\n                        <button\n                          className=\"btn\"\n                          disabled={!quickSelManual || pendingDarts >= 3}\n                          onClick={() => {\n                            const m =\n                              quickSelManual.match(/^(S|D|T)(\\d{1,2})$/);\n                            if (!m) return;\n                            const mult = m[1] as \"S\" | \"D\" | \"T\";\n                            const num = parseInt(m[2], 10);\n                            onQuickEntry(num, mult);\n                          }}\n                        >\n                          Add\n                        </button>\n                      </div>\n                    </div>\n                  </div>\n                </div>\n              </div>\n            </FocusLock>\n          </div>\n        </div>\n      )}\n      {showScoringModal && (\n        <div className=\"fixed inset-0 bg-black/60 z-[100] flex items-center justify-center\">\n          <FocusLock returnFocus>\n            <div\n              className=\"card w-full max-w-4xl relative text-left bg-[#2d2250] text-white p-6 rounded-xl shadow-xl\"\n              role=\"dialog\"\n              aria-modal=\"true\"\n            >\n              <button\n                className=\"absolute top-2 right-2 btn px-2 py-1 bg-purple-500 text-white font-bold\"\n                onClick={() => setShowScoringModal(false)}\n                aria-label=\"Close scoring dialog\"\n              >\n                Close\n              </button>\n              <h2 className=\"text-xl font-bold mb-4 flex items-center gap-2 text-white\">\n                Scoring\n              </h2>\n              <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n                {/* Camera section */}\n                <div className=\"bg-black/30 rounded-2xl p-4\">\n                  <h2 className=\"text-lg font-semibold mb-3\">Camera</h2>\n                  <ResizablePanel\n                    storageKey=\"ndn:camera:size:modal\"\n                    className=\"relative rounded-2xl overflow-hidden bg-black\"\n                    defaultWidth={480}\n                    defaultHeight={360}\n                    minWidth={360}\n                    minHeight={270}\n                    maxWidth={800}\n                    maxHeight={600}\n                  >\n                    <CameraSelector />\n                    {(() => {\n                      const fit =\n                        (useUserSettings.getState().cameraFitMode || \"fit\") ===\n                        \"fit\";\n                      const videoClass = fit\n                        ? \"absolute inset-0 w-full h-full object-contain object-center bg-black ndn-video-smooth\"\n                        : \"absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 min-w-full min-h-full w-auto h-auto object-cover object-center bg-black ndn-video-smooth\";\n                      const renderVideoSurface = () => (\n                        <div className=\"relative w-full aspect-[4/3] bg-black\">\n                          <video\n                            ref={handleVideoRef}\n                            className={videoClass}\n                            style={videoStyle}\n                            playsInline\n                            muted\n                            autoPlay\n                          />\n                          <canvas\n                            ref={overlayRef}\n                            className=\"absolute inset-0 w-full h-full\"\n                            onClick={onOverlayClick}\n                          />\n                          <div\n                            className=\"absolute top-2 left-1/2 -translate-x-1/2 z-20 flex items-center gap-3\"\n                            aria-label={`Visit status: ${pendingEntries[0] ? (pendingEntries[0].value > 0 ? \"hit\" : \"miss\") : \"pending\"}, ${pendingEntries[1] ? (pendingEntries[1].value > 0 ? \"hit\" : \"miss\") : \"pending\"}, ${pendingEntries[2] ? (pendingEntries[2].value > 0 ? \"hit\" : \"miss\") : \"pending\"}`}\n                          >\n                            {[0, 1, 2].map((i) => {\n                              const e = pendingEntries[i] as any;\n                              const isPending = !e;\n                              const isHit =\n                                !!e &&\n                                (typeof e.value === \"number\"\n                                  ? e.value > 0\n                                  : true);\n                              const color = isPending\n                                ? \"bg-gray-500/70\"\n                                : isHit\n                                  ? \"bg-emerald-400\"\n                                  : \"bg-rose-500\";\n                              return (\n                                <span\n                                  key={i}\n                                  className={`w-3 h-3 rounded-full shadow ${color}`}\n                                />\n                              );\n                            })}\n                            {dartTimerEnabled && dartTimeLeft !== null && (\n                              <span className=\"px-2 py-0.5 rounded bg-black/60 text-white text-xs font-semibold\">\n                                {Math.max(0, dartTimeLeft)}s\n                              </span>\n                            )}\n                          </div>\n                          {shouldDeferCommit && awaitingClear ? (\n                            <div className=\"absolute bottom-3 left-1/2 -translate-x-1/2 z-20 bg-black/70 text-amber-200 text-xs font-semibold px-3 py-1 rounded-full shadow\">\n                              Remove darts to continue\n                            </div>\n                          ) : null}\n                        </div>\n                      );\n                      if (isPhoneCamera) {\n                        if (!phoneFeedActive) {\n                          return (\n                            <div className=\"w-full h-full flex flex-col items-center justify-center bg-gradient-to-br from-blue-900/50 to-purple-900/50\">\n                              <div className=\"text-center space-y-3 max-w-xs mx-auto\">\n                                <div className=\"text-2xl font-semibold\">\n                                  CAM\n                                </div>\n                                <div className=\"text-lg font-semibold text-blue-100\">\n                                  Phone camera selected\n                                </div>\n                                <p className=\"text-sm text-slate-300\">\n                                  Start streaming from the Calibrator tab or\n                                  reconnect below.\n                                </p>\n                                <div className=\"flex items-center justify-center gap-2 flex-wrap\">\n                                  <button\n                                    className=\"btn bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 text-sm\"\n                                    onClick={handlePhoneReconnect}\n                                  >\n                                    Reconnect Phone\n                                  </button>\n                                  <button\n                                    className=\"btn bg-slate-700 hover:bg-slate-800 text-white px-3 py-1 text-sm\"\n                                    onClick={() => {\n                                      try {\n                                        cameraSession.setShowOverlay?.(true);\n                                      } catch (e) {}\n                                    }}\n                                  >\n                                    Show Overlay\n                                  </button>\n                                  <button\n                                    className=\"btn bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-1 text-sm\"\n                                    onClick={handleUseLocalCamera}\n                                    disabled={!availableCameras.length}\n                                  >\n                                    Use Local Camera\n                                  </button>\n                                </div>\n                              </div>\n                            </div>\n                          );\n                        }\n                        return renderVideoSurface();\n                      }\n                      return renderVideoSurface();\n                    })()}\n                  </ResizablePanel>\n                  <div className=\"flex flex-wrap items-center gap-2 mt-3\">\n                    {isPhoneCamera ? (\n                      <>\n                        <div\n                          className={`text-sm px-3 py-2 rounded border flex-1 min-w-[200px] ${phoneFeedActive ? \"bg-emerald-500/10 border-emerald-400/40 text-emerald-100\" : \"bg-amber-500/10 border-amber-400/40 text-amber-100\"}`}\n                        >\n                          {phoneFeedActive\n                            ? \"?? Phone camera stream active\"\n                            : \"?? Waiting for phone camera stream\"}\n                        </div>\n                        <button\n                          className=\"btn bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 text-sm\"\n                          onClick={handlePhoneReconnect}\n                        >\n                          Reconnect Phone\n                        </button>\n                        <button\n                          className=\"btn bg-slate-700 hover:bg-slate-800 text-white px-3 py-1 text-sm\"\n                          onClick={() => {\n                            try {\n                              cameraSession.setShowOverlay?.(\n                                !cameraSession.showOverlay,\n                              );\n                            } catch (e) {}\n                          }}\n                        >\n                          {cameraSession.showOverlay\n                            ? \"Hide Overlay\"\n                            : \"Show Overlay\"}\n                        </button>\n                        <button\n                          className=\"btn bg-rose-600 hover:bg-rose-700 text-white px-3 py-1 text-sm\"\n                          disabled={!phoneFeedActive}\n                          onClick={() => {\n                            try {\n                              cameraSession.clearSession?.();\n                            } catch (e) {}\n                          }}\n                        >\n                          Stop Phone Feed\n                        </button>\n                        {canFallbackToLocal && (\n                          <button\n                            className=\"btn bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-1 text-sm\"\n                            onClick={handleUseLocalCamera}\n                            disabled={!availableCameras.length}\n                          >\n                            Use Local Camera\n                          </button>\n                        )}\n                      </>\n                    ) : (\n                      <>\n                        {!streaming ? (\n                          <button\n                            className=\"btn bg-gradient-to-r from-purple-500 to-purple-700 text-white font-bold\"\n                            onClick={startCamera}\n                          >\n                            Connect Camera\n                          </button>\n                        ) : (\n                          <button\n                            className=\"btn bg-gradient-to-r from-rose-600 to-rose-700 text-white font-bold\"\n                            onClick={stopCamera}\n                          >\n                            Stop Camera\n                          </button>\n                        )}\n                      </>\n                    )}\n                    <button\n                      className=\"btn bg-gradient-to-r from-indigo-500 to-indigo-700 text-white font-bold\"\n                      onClick={capture}\n                      disabled={!effectiveStreaming}\n                    >\n                      Capture Still\n                    </button>\n                    <button\n                      className=\"btn bg-gradient-to-r from-slate-500 to-slate-700 text-white font-bold\"\n                      onClick={() => {\n                        try {\n                          window.dispatchEvent(\n                            new Event(\"ndn:camera-reset\" as any),\n                          );\n                        } catch (e) {}\n                      }}\n                    >\n                      Reset Camera Size\n                    </button>\n                  </div>\n                </div>\n                {/* Pending Visit section */}\n                <div className=\"bg-black/30 rounded-2xl p-4\">\n                  <div className=\"flex items-center gap-2 mb-3\">\n                    <h2 className=\"text-lg font-semibold\">Pending Visit</h2>\n                    <div className=\"flex items-center gap-2 text-xs opacity-80 ml-auto\">\n                      <span\n                        className={`inline-block w-2.5 h-2.5 rounded-full ${calibrationValid ? \"bg-emerald-400\" : \"bg-rose-500\"}`}\n                      />\n                      <span>\n                        {calibrationValid\n                          ? \"Connection OK\"\n                          : \"Connection issue\"}\n                      </span>\n                    </div>\n                  </div>\n                  <div className=\"text-sm opacity-80 mb-2\">\n                    Up to 3 darts per visit.\n                  </div>\n                  <div className=\"flex items-center gap-2 mb-2\">\n                    {[0, 1, 2].map((i) => {\n                      const e = pendingEntries[i] as any;\n                      const isPending = !e;\n                      const isHit =\n                        !!e &&\n                        (typeof e.value === \"number\" ? e.value > 0 : true);\n                      const color = isPending\n                        ? \"bg-gray-500/70\"\n                        : isHit\n                          ? \"bg-emerald-400\"\n                          : \"bg-rose-500\";\n                      return (\n                        <span\n                          key={i}\n                          className={`w-2.5 h-2.5 rounded-full shadow ${color}`}\n                        />\n                      );\n                    })}\n                    {dartTimerEnabled && dartTimeLeft !== null && (\n                      <span className=\"ml-2 px-2 py-0.5 rounded bg-black/40 text-white text-xs font-semibold\">\n                        {Math.max(0, dartTimeLeft)}s\n                      </span>\n                    )}\n                  </div>\n                  <ul className=\"text-sm mb-2 list-disc pl-5\">\n                    {pendingEntries.length === 0 ? (\n                      <li className=\"opacity-60\">No darts yet</li>\n                    ) : (\n                      pendingEntries.map((e, i) => <li key={i}>{e.label}</li>)\n                    )}\n                  </ul>\n                  <div className=\"flex items-center gap-4 mb-2\">\n                    <div className=\"font-semibold\">Darts: {pendingDarts}/3</div>\n                    <div className=\"font-semibold\">Total: {pendingScore}</div>\n                  </div>\n                  <div className=\"flex gap-2\">\n                    <button\n                      className=\"btn bg-gradient-to-r from-purple-500 to-purple-700 text-white font-bold\"\n                      onClick={onUndoDart}\n                      disabled={pendingDarts === 0}\n                    >\n                      Undo Dart\n                    </button>\n                    <button\n                      className=\"btn bg-gradient-to-r from-emerald-500 to-emerald-700 text-white font-bold\"\n                      onClick={onCommitVisit}\n                      disabled={pendingDarts === 0 || commitBlocked}\n                      data-testid=\"commit-visit-btn\"\n                    >\n                      Commit Visit\n                    </button>\n                    <button\n                      className=\"btn bg-gradient-to-r from-slate-500 to-slate-700 text-white font-bold\"\n                      onClick={handleToolbarClear}\n                      disabled={pendingDarts === 0}\n                    >\n                      Clear\n                    </button>\n                  </div>\n                </div>\n              </div>\n            </div>\n          </FocusLock>\n        </div>\n      )}\n      {/* Duplicate Pending Visit panel removed to avoid showing the same controls twice when inline panels are visible. */}\n    </div>\n  );\n\n  const compact = compactCameraView();\n  return hideInlinePanels && compact ? compact : mainContent;\n});\n","import type { ReactNode } from \"react\";\n\n// Glassy sticky header bar used across Offline and Online match UIs for visual parity\nexport default function GameHeaderBar({\n  left,\n  right,\n  className = \"\",\n  sticky = true,\n}: {\n  left: ReactNode;\n  right?: ReactNode;\n  className?: string;\n  sticky?: boolean;\n}) {\n  return (\n    <div\n      className={`${sticky ? \"sticky top-0\" : \"\"} card relative overflow-hidden flex items-center justify-between gap-2 mb-2 px-2 sm:px-3 py-2 rounded-xl bg-white/10 border border-white/10 z-10 backdrop-blur-sm ${className}`}\n    >\n      <div className=\"pointer-events-none absolute inset-0 bg-gradient-to-b from-slate-900/30 via-slate-900/10 to-transparent\" />\n      <div className=\"flex items-center gap-2 text-xs sm:text-sm leading-none flex-wrap\">\n        {left} \n      </div>\n      <div className=\"flex items-center gap-1 flex-wrap justify-end\">\n        {right}\n      </div>\n    </div>\n  );\n}\n","/**\n * Universal Game Scoreboard Component\n * Displays game-specific stats based on the game mode and current game state\n * Works for Online, Offline, and Tournament modes\n */\n\nimport React from \"react\";\n\nexport type GameMode =\n  | \"X01\"\n  | \"Cricket\"\n  | \"Shanghai\"\n  | \"Killer\"\n  | \"High-Low\"\n  | \"Halve It\"\n  | \"Around the Clock\"\n  | \"Double Practice\"\n  | \"Treble Practice\"\n  | \"Count-Up\"\n  | \"High Score\"\n  | \"Low Score\"\n  | \"Checkout 170\"\n  | \"Checkout 121\"\n  | \"American Cricket\"\n  | \"Baseball\"\n  | \"Golf\"\n  | \"Tic Tac Toe\"\n  | \"Bob's 27\"\n  | \"Scam\"\n  | \"Fives\"\n  | \"Sevens\";\n\nexport interface PlayerStats {\n  name: string;\n  isCurrentTurn: boolean;\n  legsWon?: number;\n  score?: number;\n  lastScore?: number;\n  checkoutRate?: number; // 0-100\n  bestLeg?: number | string;\n  // Cricket-specific\n  closed?: Record<number, number>; // { 20: 3, 19: 2, etc }\n  points?: number;\n  // Shanghai-specific\n  round?: number;\n  target?: number;\n  // Killer-specific\n  number?: number;\n  lives?: number;\n  eliminated?: boolean;\n  // Match statistics\n  matchAvg?: number; // Current match 3-dart average\n  allTimeAvg?: number; // Player's all-time 3-dart average\n  // Other generics\n  [key: string]: any;\n}\n\ninterface GameScoreboardProps {\n  gameMode: GameMode;\n  players: PlayerStats[];\n  matchScore?: string; // e.g., \"3-1\"\n  gameRules?: any; // Additional rules/config for the game\n}\n\nexport default function GameScoreboard({\n  gameMode,\n  players,\n  matchScore,\n  gameRules: _gameRules,\n}: GameScoreboardProps) {\n  if (!players || players.length === 0) return null;\n\n  return (\n    <div className=\"grid w-full grid-cols-1 gap-3 mb-3\">\n      {players.map((player, idx) => (\n        <div\n          key={idx}\n          className={`w-full rounded-xl border p-4 ${\n            player.isCurrentTurn\n              ? \"border-emerald-500/40 bg-emerald-500/10\"\n              : \"border-slate-500/40 bg-slate-500/10\"\n          }`}\n        >\n          <div\n            className={`text-sm font-semibold mb-3 uppercase tracking-wide ${\n              player.isCurrentTurn ? \"text-emerald-300\" : \"text-slate-300\"\n            }`}\n          >\n            {player.name}\n          </div>\n\n          <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-1 text-sm\">\n            {/* X01 specific */}\n            {gameMode === \"X01\" && (\n              <>\n                <ScoreRow\n                  label=\"Legs Won\"\n                  value={` ${player.legsWon || 0}`}\n                  highlight\n                />\n                <ScoreRow\n                  label=\"Remaining\"\n                  value={player.score || 0}\n                  mono\n                  bold\n                />\n                <ScoreRow\n                  label=\"Last Score\"\n                  value={player.lastScore || \"0\"}\n                  mono\n                />\n                {player.avg !== undefined && (\n                  <ScoreRow\n                    label=\"3-Dart Avg\"\n                    value={Number(player.avg || 0).toFixed(2)}\n                    mono\n                    bold\n                  />\n                )}\n                <ScoreRow\n                  label=\"C/Out Rate\"\n                  value={`${player.checkoutRate || 0}%`}\n                  mono\n                />\n                <ScoreRow label=\"Best Leg\" value={player.bestLeg || \"\"} mono />\n                {/* AVG +/- feature */}\n                {player.matchAvg !== undefined &&\n                  player.allTimeAvg !== undefined && (\n                    <>\n                      <div className=\"border-t border-white/20 pt-1 mt-1\">\n                        <ScoreRow\n                          label=\"Match Avg\"\n                          value={player.matchAvg.toFixed(2)}\n                          mono\n                          bold\n                          highlight={player.matchAvg > 0}\n                        />\n                        <AvgDifferenceRow\n                          matchAvg={player.matchAvg}\n                          allTimeAvg={player.allTimeAvg}\n                        />\n                      </div>\n                    </>\n                  )}\n              </>\n            )}\n\n            {/* Cricket & American Cricket specific */}\n            {(gameMode === \"Cricket\" || gameMode === \"American Cricket\") && (\n              <>\n                <ScoreRow\n                  label=\"Closed\"\n                  value={formatCricketClosed(player.closed)}\n                  mono\n                />\n                <ScoreRow label=\"Points\" value={player.points || 0} mono bold />\n                <ScoreRow\n                  label=\"Status\"\n                  value={getCricketStatus(player)}\n                  highlight={player.isCurrentTurn}\n                />\n              </>\n            )}\n\n            {/* Shanghai & Halve It - Round-based */}\n            {(gameMode === \"Shanghai\" || gameMode === \"Halve It\") && (\n              <>\n                <ScoreRow\n                  label={gameMode === \"Shanghai\" ? \"Round\" : \"Stage\"}\n                  value={player.round || 1}\n                  mono\n                />\n                <ScoreRow label=\"Target\" value={player.target || \"\"} mono />\n                <ScoreRow label=\"Score\" value={player.score || 0} mono bold />\n              </>\n            )}\n\n            {/* Killer specific */}\n            {gameMode === \"Killer\" && (\n              <>\n                <ScoreRow\n                  label=\"Target #\"\n                  value={player.number || \"\"}\n                  mono\n                  bold\n                />\n                <ScoreRow label=\"Lives\" value={player.lives || 0} mono bold />\n                {player.eliminated && (\n                  <ScoreRow\n                    label=\"Status\"\n                    value=\"ELIMINATED\"\n                    highlight={false}\n                  />\n                )}\n              </>\n            )}\n\n            {/* High-Low specific */}\n            {gameMode === \"High-Low\" && (\n              <>\n                <ScoreRow label=\"Round\" value={player.round || 1} mono />\n                <ScoreRow label=\"Target\" value={player.target || \"High\"} mono />\n                <ScoreRow label=\"Score\" value={player.score || 0} mono bold />\n              </>\n            )}\n\n            {/* Practice games */}\n            {(gameMode === \"Double Practice\" ||\n              gameMode === \"Treble Practice\" ||\n              gameMode === \"Around the Clock\") && (\n              <>\n                <ScoreRow\n                  label=\"Target\"\n                  value={player.target || \"\"}\n                  mono\n                  bold\n                />\n                <ScoreRow label=\"Hits\" value={player.hits || 0} mono bold />\n                {player.totalNeeded && (\n                  <ScoreRow\n                    label=\"Progress\"\n                    value={`${player.hits || 0} / ${player.totalNeeded}`}\n                    mono\n                  />\n                )}\n              </>\n            )}\n\n            {/* Count-Up, High Score, Low Score */}\n            {(gameMode === \"Count-Up\" ||\n              gameMode === \"High Score\" ||\n              gameMode === \"Low Score\") && (\n              <>\n                <ScoreRow label=\"Round\" value={player.round || 1} mono />\n                <ScoreRow label=\"Score\" value={player.score || 0} mono bold />\n                {gameMode === \"High Score\" && (\n                  <ScoreRow label=\"Best\" value={player.bestScore || 0} mono />\n                )}\n              </>\n            )}\n\n            {/* Checkout challenges */}\n            {(gameMode === \"Checkout 170\" || gameMode === \"Checkout 121\") && (\n              <>\n                <ScoreRow\n                  label=\"Remaining\"\n                  value={player.remaining || 0}\n                  mono\n                  bold\n                />\n                <ScoreRow label=\"Attempts\" value={player.attempts || 0} mono />\n                <ScoreRow\n                  label=\"Successes\"\n                  value={player.successes || 0}\n                  mono\n                />\n              </>\n            )}\n\n            {/* Bob's 27 */}\n            {gameMode === \"Bob's 27\" && (\n              <>\n                <ScoreRow\n                  label=\"Target\"\n                  value={`D${player.target || 1}`}\n                  mono\n                  bold\n                />\n                <ScoreRow label=\"Score\" value={player.score || 0} mono bold />\n              </>\n            )}\n\n            {/* Baseball & Golf */}\n            {gameMode === \"Baseball\" && (\n              <>\n                <ScoreRow label=\"Inning\" value={player.inning || 1} mono />\n                <ScoreRow label=\"Score\" value={player.score || 0} mono bold />\n              </>\n            )}\n\n            {gameMode === \"Golf\" && (\n              <>\n                <ScoreRow label=\"Hole\" value={player.hole || 1} mono />\n                <ScoreRow\n                  label=\"Strokes\"\n                  value={player.strokes || 0}\n                  mono\n                  bold\n                />\n              </>\n            )}\n\n            {/* Tic Tac Toe */}\n            {gameMode === \"Tic Tac Toe\" && (\n              <>\n                <ScoreRow label=\"Turn\" value={player.turn || 1} mono />\n                {player.winner && (\n                  <ScoreRow label=\"Result\" value=\"WINNER!\" highlight />\n                )}\n              </>\n            )}\n\n            {/* Match score display for competitive games */}\n            {matchScore &&\n              (gameMode === \"X01\" ||\n                gameMode === \"Cricket\" ||\n                gameMode === \"American Cricket\") &&\n              idx === 1 && (\n                <div className=\"border-t border-white/10 pt-1 mt-1\">\n                  <ScoreRow\n                    label=\"Match\"\n                    value={matchScore}\n                    mono\n                    bold\n                    highlight\n                  />\n                </div>\n              )}\n          </div>\n        </div>\n      ))}\n    </div>\n  );\n}\n\n// Helper component for consistent score row display\nfunction ScoreRow({\n  label,\n  value,\n  mono = false,\n  bold = false,\n  highlight = false,\n}: {\n  label: string;\n  value: string | number;\n  mono?: boolean;\n  bold?: boolean;\n  highlight?: boolean;\n}) {\n  return (\n    <div className=\"flex justify-between\">\n      <span className=\"opacity-70\">{label} :</span>\n      <span\n        className={`${mono ? \"font-mono\" : \"\"} ${bold ? \"font-semibold\" : \"\"} ${\n          highlight ? \"text-emerald-300\" : \"\"\n        }`}\n      >\n        {value}\n      </span>\n    </div>\n  );\n}\n\n// AVG +/- component showing difference from all-time average\nfunction AvgDifferenceRow({\n  matchAvg,\n  allTimeAvg,\n}: {\n  matchAvg: number;\n  allTimeAvg: number;\n}) {\n  const diff = matchAvg - allTimeAvg;\n  const isPositive = diff > 0;\n  const isNeutral = Math.abs(diff) < 0.01;\n\n  let diffText = \"\";\n  let diffColor = \"text-slate-300\";\n\n  if (isNeutral) {\n    diffText = \"= All-time \";\n    diffColor = \"text-slate-300\";\n  } else if (isPositive) {\n    diffText = `+${diff.toFixed(2)} vs avg `;\n    diffColor = \"text-emerald-400\";\n  } else {\n    diffText = `${diff.toFixed(2)} vs avg `;\n    diffColor = \"text-orange-400\";\n  }\n\n  return (\n    <div className=\"flex justify-between\">\n      <span className=\"opacity-70\">AVG vs Avg :</span>\n      <span className={`font-mono font-semibold ${diffColor}`}>{diffText}</span>\n    </div>\n  );\n}\n\n// Cricket helpers\nfunction formatCricketClosed(closed?: Record<number, number>): string {\n  if (!closed || Object.keys(closed).length === 0) return \"\";\n  const closedNumbers = Object.entries(closed)\n    .filter(([_, count]) => count === 3)\n    .map(([num]) => (num === \"25\" ? \"B\" : num))\n    .join(\",\");\n  return closedNumbers || \"\";\n}\n\nfunction getCricketStatus(player: PlayerStats): string {\n  if (!player.closed) return \"Starting \";\n  const closedCount = Object.values(player.closed).filter(\n    (c) => c === 3,\n  ).length;\n  if (closedCount === 0) return \"No marks \";\n  if (closedCount < 7) return `${closedCount}/7 `;\n  return \"Closing in \";\n}\n","import React, {\n  useRef,\n  useState,\n  useEffect,\n  useCallback,\n  useMemo,\n  CSSProperties,\n} from \"react\";\nimport { useCameraSession, CameraStreamMode } from \"../store/cameraSession\";\nimport { useUserSettings } from \"../store/userSettings\";\nimport { apiFetch } from \"../utils/api\";\nimport { getPreferredWsUrl } from \"../utils/ws\";\nimport { ensureVideoPlays } from \"../utils/ensureVideoPlays\";\nimport { Camera, Smartphone } from \"lucide-react\";\nimport { dinfo } from \"../utils/logger\";\n\nfunction clsx(...args: any[]) {\n  return args.filter(Boolean).join(\" \");\n}\n\ntype CameraTileProps = {\n  label?: string;\n  autoStart?: boolean;\n  forceAutoStart?: boolean;\n  scale?: number;\n  className?: string;\n  aspect?: \"inherit\" | \"wide\" | \"square\" | \"portrait\" | \"classic\" | \"free\";\n  style?: CSSProperties;\n  fill?: boolean;\n  tileFitModeOverride?: \"fit\" | \"fill\";\n  // Allow callers to pass through additional metadata without TypeScript errors.\n  [extraProp: string]: unknown;\n};\n\nexport default function CameraTile(props: CameraTileProps) {\n  const {\n    label,\n    autoStart,\n    forceAutoStart = false,\n    scale: scaleOverrideProp,\n    className,\n    aspect = \"inherit\",\n    style,\n    fill = false,\n    tileFitModeOverride: tileFitModeOverrideProp,\n  } = props;\n\n  const videoRef = useRef<HTMLVideoElement>(null);\n  const cameraSession = useCameraSession();\n  const [streaming, setStreaming] = useState(false);\n  const [ws, setWs] = useState<WebSocket | null>(null);\n  const [pairCode, setPairCode] = useState<string | null>(null);\n  const pairCodeRef = useRef<string | null>(null);\n  const [pc, setPc] = useState<RTCPeerConnection | null>(null);\n  const lastRegisteredModeRef = useRef<CameraStreamMode | null>(null);\n\n  useEffect(() => {\n    pairCodeRef.current = pairCode;\n  }, [pairCode]);\n\n  const registerStream = useCallback(\n    (stream: MediaStream | null, modeOverride: CameraStreamMode = \"local\") => {\n      try {\n        if (stream) {\n          cameraSession.setMediaStream(stream);\n          cameraSession.setMode(modeOverride);\n          cameraSession.setStreaming(true);\n          lastRegisteredModeRef.current = modeOverride;\n        } else if (\n          lastRegisteredModeRef.current &&\n          lastRegisteredModeRef.current !== \"phone\"\n        ) {\n          cameraSession.setStreaming(false);\n          cameraSession.setMediaStream(null);\n          lastRegisteredModeRef.current = null;\n        }\n      } catch (err) {}\n    },\n    [cameraSession],\n  );\n\n  const attachFromSession = useCallback(async () => {\n    try {\n      const v = videoRef.current;\n      if (!v) return false;\n      const s = cameraSession.getMediaStream?.() || null;\n      const liveTracks = (s?.getVideoTracks?.() || []).filter(\n        (t: MediaStreamTrack) => t.readyState === \"live\",\n      );\n      if (!s || liveTracks.length === 0) return false;\n\n      const res = await ensureVideoPlays({\n        video: v,\n        stream: s,\n        onPlayError: (e: any) => console.warn(\"[CameraTile] Play failed:\", e),\n      });\n      setStreaming(!!res.played);\n      if (res.played) {\n        try {\n          const current = cameraSession.getVideoElementRef?.();\n          if (!current || current === v) {\n            cameraSession.setVideoElementRef?.(v);\n          }\n        } catch {}\n      }\n      return !!res.played;\n    } catch {\n      return false;\n    }\n  }, [cameraSession]);\n\n  const preferredCameraLabel = useUserSettings(\n    (s: any) => s.preferredCameraLabel,\n  );\n  const [mode, setMode] = useState<\"local\" | \"phone\" | \"wifi\">(() => {\n    if (preferredCameraLabel === \"Phone Camera\") return \"phone\";\n    const saved = localStorage.getItem(\"ndn:camera:mode\") as any;\n    return saved || \"local\";\n  });\n\n  const [lanHost, setLanHost] = useState<string | null>(null);\n  const [httpsInfo, setHttpsInfo] = useState<{\n    https: boolean;\n    port: number;\n  } | null>(null);\n\n  useEffect(() => {\n    localStorage.setItem(\"ndn:camera:mode\", mode);\n  }, [mode]);\n\n  useEffect(() => {\n    const h = window.location.hostname;\n    if (h === \"localhost\" || h === \"127.0.0.1\") {\n      apiFetch(\"/api/hosts\")\n        .then((r) => r.json())\n        .then((j: any) => {\n          const ip = Array.isArray(j?.hosts) && j.hosts.find((x: string) => x);\n          if (ip) setLanHost(ip);\n        })\n        .catch(() => {});\n    }\n    apiFetch(\"/api/https-info\")\n      .then((r) => r.json())\n      .then((j: any) => {\n        if (j && typeof j.https === \"boolean\")\n          setHttpsInfo({ https: !!j.https, port: Number(j.port) || 8788 });\n      })\n      .catch(() => {});\n  }, []);\n\n  const mobileUrl = useMemo(() => {\n    const code = pairCode || \"____\";\n    const host = lanHost || window.location.hostname;\n    const proto = httpsInfo?.https ? \"https\" : \"http\";\n    const port = httpsInfo?.https ? httpsInfo.port : 8787;\n    return `${proto}://${host}:${port}/mobile-cam.html?code=${code}`;\n  }, [pairCode, lanHost, httpsInfo]);\n\n  function ensureWS() {\n    if (ws && ws.readyState === WebSocket.OPEN) return ws;\n    const url = getPreferredWsUrl();\n    const socket = new WebSocket(url);\n    setWs(socket);\n    return socket;\n  }\n\n  const startPhonePairing = useCallback(() => {\n    setMode(\"phone\");\n    const socket = ensureWS();\n    if (socket.readyState === WebSocket.OPEN) {\n      socket.send(JSON.stringify({ type: \"cam-create\" }));\n    } else {\n      socket.onopen = () => socket.send(JSON.stringify({ type: \"cam-create\" }));\n    }\n    socket.onmessage = async (ev) => {\n      const data = JSON.parse(ev.data);\n      if (data.type === \"cam-code\") {\n        setPairCode(data.code);\n        pairCodeRef.current = data.code;\n      } else if (data.type === \"cam-peer-joined\") {\n        const peer = new RTCPeerConnection({\n          iceServers: [{ urls: \"stun:stun.l.google.com:19302\" }],\n        });\n        setPc(peer);\n        peer.onicecandidate = (e) => {\n          if (e.candidate && pairCodeRef.current)\n            socket.send(\n              JSON.stringify({\n                type: \"cam-ice\",\n                code: pairCodeRef.current,\n                payload: e.candidate,\n              }),\n            );\n        };\n        peer.ontrack = (ev) => {\n          if (videoRef.current && ev.streams?.[0]) {\n            videoRef.current.srcObject = ev.streams[0];\n            videoRef.current.play().catch(() => {});\n            registerStream(ev.streams[0], \"phone\");\n            setStreaming(true);\n          }\n        };\n        const offer = await peer.createOffer({ offerToReceiveVideo: true });\n        await peer.setLocalDescription(offer);\n        if (pairCodeRef.current)\n          socket.send(\n            JSON.stringify({\n              type: \"cam-offer\",\n              code: pairCodeRef.current,\n              payload: offer,\n            }),\n          );\n      } else if (data.type === \"cam-answer\" && pc) {\n        await pc.setRemoteDescription(new RTCSessionDescription(data.payload));\n      } else if (data.type === \"cam-ice\" && pc) {\n        try {\n          await pc.addIceCandidate(data.payload);\n        } catch {}\n      }\n    };\n  }, [registerStream, pc, ws]);\n\n  const startLocal = useCallback(async () => {\n    const ok = await attachFromSession();\n    if (!ok) {\n      window.dispatchEvent(\n        new CustomEvent(\"ndn:start-camera\", { detail: { mode: \"local\" } }),\n      );\n    }\n  }, [attachFromSession]);\n\n  const handleModeSelect = useCallback(\n    (newMode: string) => {\n      setMode(newMode as any);\n      if (newMode === \"local\") startLocal();\n      else if (newMode === \"phone\") startPhonePairing();\n    },\n    [startLocal, startPhonePairing],\n  );\n\n  useEffect(() => {\n    if (autoStart || forceAutoStart) {\n      if (mode === \"local\") startLocal();\n      else if (mode === \"phone\") startPhonePairing();\n    }\n  }, [autoStart, forceAutoStart, mode, startLocal, startPhonePairing]);\n\n  // Reactive attachment: if the global session starts streaming, or the stream object\n  // itself changes, we attempt to attach it immediately to our local video element.\n  const sessionStreaming = cameraSession.isStreaming;\n  const sessionStream = cameraSession.getMediaStream?.();\n\n  useEffect(() => {\n    if (sessionStreaming && sessionStream) {\n      // Optimized: Immediate synchronous assignment of srcObject to the video\n      // element avoids waiting for the React effect/callback chain to resolve\n      // async promises. This ensures the browser starts painting frames\n      // the literal millisecond the session stream is detected.\n      try {\n        const v = videoRef.current;\n        if (v && v.srcObject !== sessionStream) {\n          v.srcObject = sessionStream;\n          v.play().catch(() => {});\n          // Immediately set internal streaming flag so UI badges appear\n          // without waiting for the async attachFromSession result.\n          setStreaming(true);\n        }\n      } catch {}\n\n      // Still call attachFromSession for robust recovery/mute/metadata handling\n      attachFromSession();\n    }\n  }, [sessionStreaming, sessionStream, attachFromSession]);\n\n  return (\n    <CameraFrame\n      {...props}\n      videoRef={videoRef}\n      streaming={streaming}\n      mode={mode}\n      pairCode={pairCode}\n      mobileUrl={mobileUrl}\n      startPhonePairing={startPhonePairing}\n      onModeSelect={handleModeSelect}\n    />\n  );\n}\n\nfunction CameraFrame(props: any) {\n  const {\n    videoRef,\n    streaming,\n    mode,\n    pairCode,\n    mobileUrl,\n    startPhonePairing,\n    label,\n    fill,\n    className,\n    style,\n    scale: scaleProp,\n    aspect = \"inherit\",\n    tileFitModeOverride,\n  } = props;\n  const {\n    cameraScale,\n    cameraAspect: storedAspect,\n    cameraFitMode: globalFitMode,\n  } = useUserSettings();\n  const containerRef = useRef<HTMLDivElement>(null);\n  const previewCanvasRef = useRef<HTMLCanvasElement>(null);\n  const [forceFallbackMode, setForceFallbackMode] = useState(false);\n\n  const isContainerVisible = useCallback(() => {\n    if (!containerRef.current) return true;\n    const r = containerRef.current.getBoundingClientRect();\n    return (\n      r.width > 0 &&\n      r.height > 0 &&\n      r.top < (window.innerHeight || 2000) &&\n      r.bottom > 0\n    );\n  }, []);\n\n  const effectiveFitMode: \"fit\" | \"fill\" =\n    tileFitModeOverride || (fill ? \"fill\" : globalFitMode || \"fill\");\n  const scale = Number(scaleProp ?? cameraScale ?? 1);\n\n  const aspectChoice =\n    fill && effectiveFitMode === \"fill\"\n      ? \"free\"\n      : aspect && aspect !== \"inherit\"\n        ? aspect\n        : (storedAspect as any) || \"wide\";\n\n  const aspectClass =\n    aspectChoice === \"square\"\n      ? \"aspect-square\"\n      : aspectChoice === \"portrait\"\n        ? \"aspect-[3/4]\"\n        : aspectChoice === \"classic\"\n          ? \"aspect-[4/3]\"\n          : aspectChoice === \"free\"\n            ? \"h-full\"\n            : \"aspect-video\";\n\n  useEffect(() => {\n    let raf = 0;\n    let running = true;\n    let sampleHandle = 0;\n    let activated = false;\n\n    const drawLoop = () => {\n      if (!running) return;\n      const v = videoRef.current;\n      const c = previewCanvasRef.current;\n      const useFallback =\n        v && (forceFallbackMode || (v.videoWidth > 0 && v.readyState < 2));\n\n      if (v && c && useFallback) {\n        const ctx = c.getContext(\"2d\", { alpha: false });\n        if (ctx && v.videoWidth > 0) {\n          if (!activated) {\n            dinfo(\"CameraTile: canvas fallback activated\");\n            activated = true;\n          }\n          if (c.width !== v.videoWidth) {\n            c.width = v.videoWidth;\n            c.height = v.videoHeight;\n          }\n          ctx.drawImage(v, 0, 0);\n          c.style.visibility = \"visible\";\n        }\n      } else if (c) {\n        c.style.visibility = \"hidden\";\n      }\n      raf = requestAnimationFrame(drawLoop);\n    };\n    raf = requestAnimationFrame(drawLoop);\n\n    sampleHandle = window.setInterval(() => {\n      const v = videoRef.current;\n      if (v && v.videoWidth > 0 && isContainerVisible()) {\n        const canvas = document.createElement(\"canvas\");\n        canvas.width = 16;\n        canvas.height = 16;\n        const ctx = canvas.getContext(\"2d\", {\n          alpha: false,\n          willReadFrequently: true,\n        });\n        if (ctx) {\n          try {\n            ctx.drawImage(v, 0, 0, 16, 16);\n            const data = ctx.getImageData(0, 0, 16, 16).data;\n            let sum = 0;\n            for (let i = 0; i < data.length; i += 4)\n              sum +=\n                0.299 * data[i] + 0.587 * data[i + 1] + 0.114 * data[i + 2];\n            const avg = sum / (16 * 16 * 255);\n            if (avg < 0.02) setForceFallbackMode(true);\n            else setForceFallbackMode(false);\n          } catch (e) {}\n        }\n      }\n    }, 2000);\n\n    return () => {\n      running = false;\n      cancelAnimationFrame(raf);\n      window.clearInterval(sampleHandle);\n    };\n  }, [videoRef, isContainerVisible, forceFallbackMode]);\n\n  return (\n    <div\n      ref={containerRef}\n      className={clsx(\n        \"relative bg-black rounded-3xl overflow-hidden shadow-2xl border border-white/5\",\n        className,\n        fill && \"w-full h-full\",\n      )}\n      style={style}\n    >\n      <div className={clsx(\"relative w-full\", aspectClass)}>\n        <video\n          ref={videoRef}\n          autoPlay\n          playsInline\n          muted\n          className={clsx(\n            \"w-full h-full\",\n            effectiveFitMode === \"fill\" ? \"object-cover\" : \"object-contain\",\n            forceFallbackMode ? \"opacity-0 absolute\" : \"block\",\n          )}\n          style={{ transform: `scale(${scale})` }}\n        />\n        <canvas\n          ref={previewCanvasRef}\n          className={clsx(\n            \"absolute inset-0 w-full h-full bg-black\",\n            effectiveFitMode === \"fill\" ? \"object-cover\" : \"object-contain\",\n          )}\n          style={{ visibility: \"hidden\", transform: `scale(${scale})` }}\n        />\n      </div>\n\n      <div className=\"absolute top-3 left-3 flex items-center gap-2\">\n        <div className=\"w-8 h-8 rounded-full bg-indigo-500/20 backdrop-blur-md flex items-center justify-center text-white\">\n          <Camera size={14} />\n        </div>\n        <div className=\"flex flex-col\">\n          <span className=\"text-[10px] text-white/40 uppercase tracking-widest font-bold\">\n            Live Feed\n          </span>\n          <span className=\"text-white font-bold leading-none\">\n            {label || mode}\n          </span>\n        </div>\n      </div>\n      {streaming && (\n        <div className=\"absolute top-3 right-3 flex items-center gap-1.5 px-2 py-1 rounded-full bg-emerald-500/20 border border-emerald-500/30\">\n          <div className=\"w-2 h-2 rounded-full bg-emerald-400 animate-pulse\" />\n          <span className=\"text-xs text-emerald-400 font-bold uppercase tracking-widest\">\n            Live\n          </span>\n        </div>\n      )}\n    </div>\n  );\n}\n","import React, { useEffect, useMemo, useRef, useState } from \"react\";\nimport FocusLock from \"react-focus-lock\";\nimport { createPortal } from \"react-dom\";\nimport CameraTile from \"../CameraTile\";\nimport type { Player } from \"../../store/match\";\nimport { useCameraSession } from \"../../store/cameraSession\";\nimport {\n  getAllTime,\n  getAllTime180s,\n  getAllTimeAvg,\n  getAllTimeBestCheckout,\n  getAllTimeBestLeg,\n  getAllTimeFirstNineAvg,\n} from \"../../store/profileStats\";\nimport { useUserSettings } from \"../../store/userSettings\";\n\ninterface StatProps {\n  label: string;\n  value: string;\n}\n\nconst StatBlock = ({ label, value }: StatProps) => (\n  <div className=\"flex flex-col items-center gap-0\">\n    <div className=\"text-[8px] opacity-70 uppercase font-bold tracking-tighter leading-none\">\n      {label}\n    </div>\n    <div className=\"text-sm sm:text-base font-black leading-none\">{value}</div>\n  </div>\n);\n\nexport type MatchStartShowcaseProps = {\n  open?: boolean;\n  players: Player[];\n  user?: any;\n  initialSeconds?: number;\n  showCalibrationDefault?: boolean;\n  disableEscClose?: boolean;\n  onDone?: () => void;\n  onRequestClose?: () => void;\n};\n\nexport default function MatchStartShowcase({\n  open = true,\n  players,\n  user,\n  initialSeconds = 10,\n  disableEscClose = false,\n  onDone,\n  onRequestClose,\n}: MatchStartShowcaseProps) {\n  const [seconds, setSeconds] = useState(initialSeconds);\n  const [showGo, setShowGo] = useState(false);\n  const portalElRef = useRef<HTMLElement | null>(\n    typeof document !== \"undefined\" ? document.createElement(\"div\") : null,\n  );\n  const goTimeoutRef = useRef<number | null>(null);\n  const cameraEnabled = useUserSettings((s) => s.cameraEnabled);\n  const setCameraEnabled = useUserSettings((s) => s.setCameraEnabled);\n  const cameraSession = useCameraSession();\n\n  // Create portal container\n  useEffect(() => {\n    const el = portalElRef.current;\n    if (!el || typeof document === \"undefined\") return;\n    el.className = \"ndn-match-start-portal\";\n    document.body.appendChild(el);\n    return () => {\n      try {\n        el.parentNode?.removeChild(el);\n      } catch {}\n    };\n  }, []);\n\n  // Reset countdown when reopened or when initial seconds changes\n  useEffect(() => {\n    if (!open) return;\n    setSeconds(initialSeconds);\n    setShowGo(false);\n    if (goTimeoutRef.current) {\n      window.clearTimeout(goTimeoutRef.current);\n      goTimeoutRef.current = null;\n    }\n  }, [open, initialSeconds]);\n\n  // Countdown + ensure camera stays enabled for preview\n  useEffect(() => {\n    if (!open) return;\n    if (!cameraEnabled) setCameraEnabled?.(true);\n    const id = window.setInterval(() => {\n      setSeconds((s) => {\n        if (s <= 1) {\n          window.clearInterval(id);\n          setShowGo(true);\n          if (goTimeoutRef.current) window.clearTimeout(goTimeoutRef.current);\n          goTimeoutRef.current = window.setTimeout(() => {\n            try {\n              onDone?.();\n              onRequestClose?.();\n            } catch {}\n          }, 1000);\n          return 0;\n        }\n        return s - 1;\n      });\n    }, 1000);\n    return () => {\n      window.clearInterval(id);\n    };\n  }, [open, onDone, onRequestClose, setCameraEnabled, cameraEnabled]);\n\n  useEffect(() => {\n    return () => {\n      if (goTimeoutRef.current) window.clearTimeout(goTimeoutRef.current);\n    };\n  }, []);\n\n  useEffect(() => {\n    if (!open || disableEscClose) return;\n    const onKeyDown = (e: KeyboardEvent) => {\n      if (e.key !== \"Escape\") return;\n      try {\n        onRequestClose?.();\n      } catch {}\n    };\n    window.addEventListener(\"keydown\", onKeyDown);\n    return () => window.removeEventListener(\"keydown\", onKeyDown);\n  }, [open, disableEscClose, onRequestClose]);\n\n  useEffect(() => {\n    if (!open || typeof document === \"undefined\") return;\n    const root = document.getElementById(\"root\");\n    if (!root) return;\n    const prev = root.getAttribute(\"aria-hidden\");\n    root.setAttribute(\"aria-hidden\", \"true\");\n    return () => {\n      if (prev === null || prev === undefined)\n        root.removeAttribute(\"aria-hidden\");\n      else root.setAttribute(\"aria-hidden\", prev);\n    };\n  }, [open]);\n\n  useEffect(() => {\n    if (!open) return;\n    try {\n      cameraSession?.acquireKeepAlive?.(\"match-start-showcase\");\n    } catch {}\n    return () => {\n      try {\n        cameraSession?.releaseKeepAlive?.(\"match-start-showcase\");\n      } catch {}\n    };\n  }, [open, cameraSession]);\n\n  const stats = useMemo(\n    () =>\n      players.map((p) => {\n        try {\n          const avg3 = getAllTimeAvg(p.name).toFixed(1);\n          const best9 = getAllTimeFirstNineAvg(p.name).toFixed(1);\n          const bestCheckout = getAllTimeBestCheckout(p.name);\n          const bestLeg = getAllTimeBestLeg(p.name);\n          const all = getAllTime(p.name);\n          const lifetimeScored = all.scored || 0;\n          const lifetimeDarts = all.darts || 0;\n          const career180s = getAllTime180s(p.name);\n          const match180s = (p.legs || []).reduce((sum, leg) => {\n            const legCount = (leg.visits || []).filter(\n              (visit) => Number(visit.visitTotal ?? visit.score) === 180,\n            ).length;\n            return sum + legCount;\n          }, 0);\n          return {\n            id: p.id,\n            name: p.name,\n            avg3,\n            best9,\n            bestCheckout,\n            bestLeg,\n            lifetimeScored,\n            lifetimeDarts,\n            career180s,\n            match180s,\n          };\n        } catch {\n          return {\n            id: p.id,\n            name: p.name,\n            avg3: \"\",\n            best9: \"\",\n            bestCheckout: \"\",\n            bestLeg: \"\",\n            lifetimeScored: 0,\n            lifetimeDarts: 0,\n            career180s: 0,\n            match180s: 0,\n          };\n        }\n      }),\n    [players],\n  );\n\n  if (!open || !portalElRef.current) return null;\n\n  const overlay = (\n    <div\n      className=\"fixed inset-0 z-50 overflow-y-auto bg-black/85 backdrop-blur-md\"\n      role=\"dialog\"\n      aria-modal=\"true\"\n      aria-label=\"Match start showcase\"\n    >\n      <div className=\"min-h-full flex items-center justify-center p-4 sm:p-6 lg:p-8\">\n        <div className=\"w-full max-w-4xl\">\n          <FocusLock returnFocus>\n            <div className=\"bg-[#0f111a] border border-white/10 rounded-3xl p-5 shadow-2xl ring-1 ring-white/5 relative overflow-hidden\">\n              <div className=\"flex items-start justify-between gap-3 mb-4 border-b border-white/5 pb-3\">\n                <div>\n                  <div className=\"text-[10px] font-bold text-emerald-300 uppercase tracking-widest mb-1\">\n                    Manual scoring only\n                  </div>\n                  <div className=\"text-2xl md:text-3xl font-black text-white tracking-tighter\">\n                    {showGo || seconds <= 0\n                      ? \"GO\"\n                      : `Match starting in ${seconds}s`}\n                  </div>\n                  <p className=\"text-xs text-white/70 mt-1 max-w-xl\">\n                    Camera is shown to both players before and during the match.\n                    No auto-calibration or auto-scoring is used  enter scores\n                    manually.\n                  </p>\n                </div>\n                <div className=\"flex gap-2\">\n                  <button\n                    className=\"px-3 py-2 rounded-lg bg-white/10 hover:bg-white/15 text-white text-xs font-semibold\"\n                    aria-label=\"Close match start showcase\"\n                    onClick={() => {\n                      try {\n                        onRequestClose?.();\n                      } catch {}\n                    }}\n                  >\n                    Close\n                  </button>\n                  <button\n                    className=\"px-4 py-2 rounded-lg bg-emerald-500 hover:bg-emerald-400 text-black text-xs font-bold\"\n                    aria-label=\"Start match now\"\n                    onClick={() => {\n                      try {\n                        onDone?.();\n                        onRequestClose?.();\n                      } catch {}\n                    }}\n                  >\n                    Start now\n                  </button>\n                </div>\n              </div>\n\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                <div className=\"space-y-3\">\n                  {stats.map((st) => (\n                    <div\n                      key={st.id}\n                      className=\"p-3 rounded-2xl border border-white/10 bg-white/5 shadow-lg\"\n                    >\n                      <div className=\"flex items-center justify-between mb-2\">\n                        <div>\n                          <div className=\"text-lg font-black text-white tracking-tight\">\n                            {st.name}\n                            {user?.username === st.name ? \"  You\" : \"\"}\n                          </div>\n                          <div className=\"text-[10px] text-emerald-300 font-bold\">\n                            Manual scoring enabled  {st.match180s}/\n                            {st.career180s}\n                          </div>\n                        </div>\n                        <div className=\"text-sm text-white/70 font-semibold\">\n                          180s: {st.match180s}/{st.career180s}\n                        </div>\n                      </div>\n                      <div className=\"grid grid-cols-4 gap-2\">\n                        <StatBlock label=\"Avg\" value={String(st.avg3)} />\n                        <StatBlock label=\"F9\" value={String(st.best9)} />\n                        <StatBlock label=\"CO\" value={String(st.bestCheckout)} />\n                        <StatBlock label=\"Leg\" value={String(st.bestLeg)} />\n                      </div>\n                      <div className=\"grid grid-cols-2 gap-2 mt-2 text-[10px] text-white/70\">\n                        <div className=\"flex items-center justify-between px-2 py-1 rounded-lg bg-white/5 border border-white/5\">\n                          <span>Lifetime pts</span>\n                          <span className=\"font-semibold\">\n                            {st.lifetimeScored.toLocaleString()}\n                          </span>\n                        </div>\n                        <div className=\"flex items-center justify-between px-2 py-1 rounded-lg bg-white/5 border border-white/5\">\n                          <span>Lifetime darts</span>\n                          <span className=\"font-semibold\">\n                            {st.lifetimeDarts.toLocaleString()}\n                          </span>\n                        </div>\n                      </div>\n                    </div>\n                  ))}\n                </div>\n\n                <div className=\"rounded-2xl border border-white/10 bg-black/40 overflow-hidden shadow-xl\">\n                  <div className=\"px-4 py-3 flex items-center justify-between text-sm text-white/80 border-b border-white/5\">\n                    <div className=\"font-semibold\">Camera preview</div>\n                    <div className=\"text-xs text-emerald-300 font-bold\">\n                      Live Manual scoring\n                    </div>\n                  </div>\n                  <div className=\"aspect-video relative bg-black\">\n                    <CameraTile\n                      autoStart\n                      forceAutoStart\n                      fill\n                      aspect=\"free\"\n                      tileFitModeOverride=\"fit\"\n                      scale={1}\n                    />\n                  </div>\n                  <div className=\"px-4 py-3 text-xs text-white/70 border-t border-white/5\">\n                    Confirm your board is visible and stable. Scores will be\n                    entered manually during the match.\n                  </div>\n                </div>\n              </div>\n            </div>\n          </FocusLock>\n        </div>\n      </div>\n    </div>\n  );\n\n  return createPortal(overlay, portalElRef.current);\n}\n","export function getPreferredUserName(\n  user: any,\n  fallback: string = \"Player\",\n): string {\n  try {\n    const candidates = [\n      user?.username,\n      user?.profile?.username,\n      user?.profile?.fullName,\n      user?.fullName,\n      user?.profile?.displayName,\n      user?.displayName,\n      user?.name,\n    ];\n    for (const raw of candidates) {\n      if (typeof raw !== \"string\") continue;\n      const trimmed = raw.trim();\n      if (trimmed) return trimmed;\n    }\n  } catch {}\n  return fallback;\n}\n","import React, { useMemo } from \"react\";\nimport { suggestCheckouts } from \"../../utils/checkout\";\nimport { useUserSettings } from \"../../store/userSettings\";\n\ntype Row = {\n  side: \"Away\" | \"Home\";\n  name: string;\n  legsWon: number;\n  remaining: number;\n};\n\nexport default function LetterboxScoreboardOverlay({\n  checkoutRemaining,\n  away,\n  home,\n}: {\n  checkoutRemaining: number;\n  away: Row;\n  home: Row;\n}) {\n  const favoriteDouble = useUserSettings((s) => s.favoriteDouble);\n\n  const route = useMemo(() => {\n    if (!Number.isFinite(checkoutRemaining)) return \"\";\n    const routes = suggestCheckouts(checkoutRemaining, favoriteDouble);\n    return routes[0] ?? \"\";\n  }, [checkoutRemaining, favoriteDouble]);\n\n  return (\n    <div className=\"pointer-events-none absolute bottom-4 left-4 z-50 w-[min(92vw,520px)]\">\n      <div className=\"rounded-2xl border border-white/10 bg-black/55 shadow-2xl backdrop-blur\">\n        <div className=\"px-4 py-2 border-b border-white/10\">\n          <div className=\"text-[11px] uppercase tracking-wide text-slate-300/80\">\n            Checkout\n          </div>\n          <div className=\"text-sm font-semibold text-indigo-200\">\n            {route || \"\"}\n          </div>\n        </div>\n\n        <div className=\"px-3 py-2\">\n          {[home, away].map((r) => (\n            <div\n              key={r.side}\n              className=\"grid grid-cols-[auto_1fr_auto] items-center gap-3 py-1\"\n            >\n              <div className=\"w-10 text-center text-sm font-extrabold text-emerald-200\">\n                {r.legsWon}\n              </div>\n              <div className=\"min-w-0\">\n                <div className=\"flex items-center gap-2\">\n                  <div className=\"text-[10px] uppercase tracking-wide text-slate-300/70\">\n                    {r.side}\n                  </div>\n                  <div className=\"truncate text-sm font-semibold text-white\">\n                    {r.name || \"\"}\n                  </div>\n                </div>\n              </div>\n              <div className=\"w-16 text-right text-lg font-extrabold text-white tabular-nums\">\n                {Number.isFinite(r.remaining) ? r.remaining : \"\"}\n              </div>\n            </div>\n          ))}\n        </div>\n      </div>\n    </div>\n  );\n}\n","import React, { useCallback, useEffect, useState } from \"react\";\nimport CameraView from \"./CameraView\";\nimport GameHeaderBar from \"./ui/GameHeaderBar\";\nimport GameScoreboard from \"./scoreboards/GameScoreboard\";\nimport { useMatch } from \"../store/match\";\nimport { useMatchControl } from \"../store/matchControl\";\nimport { readMatchSnapshot } from \"../utils/matchSync\";\nimport { subscribeMatchSync } from \"../utils/broadcast\";\nimport { usePendingVisit } from \"../store/pendingVisit\";\nimport PauseTimerBadge from \"./ui/PauseTimerBadge\";\nimport { useUserSettings } from \"../store/userSettings\";\nimport MatchControls from \"./MatchControls\";\nimport MatchStartShowcase from \"./ui/MatchStartShowcase\";\nimport { sayScore } from \"../utils/checkout\";\nimport { getPreferredUserName } from \"../utils/userName\";\nimport LetterboxScoreboardOverlay from \"./ui/LetterboxScoreboardOverlay\";\n\nexport default function MatchPage() {\n  const match = useMatch();\n  useUserSettings((s) => s.hideInGameSidebar ?? true);\n  const _setMatchState = useMatch().importState;\n  const _setControl = useMatchControl((s) => s.setPaused);\n  const _control = useMatchControl();\n  const [_ready, setReady] = useState(false);\n  const [winningShot, setWinningShot] = useState<{\n    label?: string;\n    ring?: string;\n    frame?: string | null;\n    ts?: number;\n  } | null>(null);\n  const [remoteFrame, setRemoteFrame] = useState<string | null>(null);\n  const lastOfflineStart = useUserSettings(\n    (s) => s.lastOffline?.x01Start || 501,\n  );\n  const user = useUserSettings((s) => s.user);\n  const localPlayerName =\n    user?.username ||\n    user?.name ||\n    user?.displayName ||\n    user?.email?.split(\"@\")[0];\n  const resolvedLocalIndex = (match.players || []).findIndex(\n    (p: any) => p?.name && p.name === localPlayerName,\n  );\n  const localPlayerIndex = resolvedLocalIndex >= 0 ? resolvedLocalIndex : 0;\n  const isUsersTurn = (match.currentPlayerIdx ?? 0) === localPlayerIndex;\n\n  const localPlayer = match.players?.[localPlayerIndex];\n  const localLeg = localPlayer?.legs?.[localPlayer.legs.length - 1];\n  const localRemaining =\n    localLeg?.totalScoreRemaining ?? match.startingScore ?? lastOfflineStart;\n  const awayIdx = (match.players || []).findIndex(\n    (_p: any, idx: number) => idx !== localPlayerIndex,\n  );\n  const awayPlayer = (match.players || [])[awayIdx >= 0 ? awayIdx : 0];\n  const awayLeg = awayPlayer?.legs?.[awayPlayer.legs.length - 1];\n  const awayRemaining =\n    awayLeg?.totalScoreRemaining ?? match.startingScore ?? lastOfflineStart;\n\n  const opponentPlayers = (match.players || []).filter(\n    (_p: any, idx: number) => idx !== localPlayerIndex,\n  );\n  const callerEnabled = useUserSettings((s) => s.callerEnabled);\n  const callerVoice = useUserSettings((s) => s.callerVoice);\n  const callerVolume = useUserSettings((s) => s.callerVolume);\n  const speakCheckoutOnly = useUserSettings((s) => s.speakCheckoutOnly);\n  const [playerVisitDarts, setPlayerVisitDarts] = useState(0);\n  const [playerDartPoints, setPlayerDartPoints] = useState<number>(0);\n  const [visitTotalInput, setVisitTotalInput] = useState<string>(\"\");\n  const [manualBox, setManualBox] = useState(\"\");\n  const [multiEntry, setMultiEntry] = useState(\"\");\n  const [manualEntries, setManualEntries] = useState<number[]>([]);\n  const [showStartShowcase, setShowStartShowcase] = useState<boolean>(true);\n  const showcaseLockedOpenRef = React.useRef(true);\n  const [showMobileCamera, setShowMobileCamera] = useState(false);\n  const [mobileViewMode, setMobileViewMode] = useState<\"controls\" | \"camera\">(\n    \"controls\",\n  );\n\n  // In the match pop-out window we want the same pre-game build-up overlay\n  // (and camera preview) that exists on the main pre-game screen.\n  //\n  // IMPORTANT: match state may hydrate from a snapshot with `inProgress=true`\n  // immediately, even though this window still needs to show the build-up UI.\n  // So we default to showing it once per mount, and only allow it to close\n  // after the user explicitly hits Start/Close.\n  useEffect(() => {\n    if (!showcaseLockedOpenRef.current) return;\n    setShowStartShowcase(true);\n  }, []);\n\n  useEffect(() => {\n    // Ensure camera is enabled for the pop-out so the feed can start immediately\n    try {\n      useUserSettings.getState().setCameraEnabled(true);\n    } catch {}\n\n    // Try to import snapshot that opener wrote\n    try {\n      const snapshot = readMatchSnapshot();\n      if (snapshot?.match) {\n        try {\n          useMatch.getState().importState(snapshot.match);\n        } catch {}\n      }\n      // If no snapshot match data, make sure starting score reflects last selected\n      else {\n        try {\n          useMatch.getState().importState({\n            ...useMatch.getState(),\n            startingScore: lastOfflineStart,\n          } as any);\n        } catch {}\n      }\n      if (snapshot?.control) {\n        try {\n          useMatchControl\n            .getState()\n            .setPaused(snapshot.control.paused, snapshot.control.pauseEndsAt);\n        } catch {}\n      }\n    } catch {}\n    setReady(true);\n\n    // subscribe to sync messages (pause/quit updates)\n    const unsub = subscribeMatchSync((msg: any) => {\n      try {\n        if (!msg) return;\n        if (msg.type === \"snapshot\" && msg.state) {\n          if (msg.state.match) useMatch.getState().importState(msg.state.match);\n          if (msg.state.control)\n            useMatchControl\n              .getState()\n              .setPaused(\n                msg.state.control.paused,\n                msg.state.control.pauseEndsAt,\n              );\n        }\n        // Helper: read snapshot if available and import\n        const tryImportSnapshot = () => {\n          try {\n            const s = readMatchSnapshot();\n            if (s && s.match) {\n              useMatch.getState().importState(s.match);\n              if (s.control)\n                useMatchControl\n                  .getState()\n                  .setPaused(s.control.paused, s.control.pauseEndsAt);\n              return true;\n            }\n          } catch {}\n          return false;\n        };\n        if (msg.type === \"pause\") {\n          try {\n            useMatchControl.getState().setPaused(true, msg.pauseEndsAt ?? null);\n          } catch {}\n        }\n        if (msg.type === \"unpause\") {\n          try {\n            useMatchControl.getState().setPaused(false, null);\n          } catch {}\n        }\n        if (msg.type === \"quit\") {\n          try {\n            window.close();\n          } catch {}\n        }\n        // future message types: addVisit, nextPlayer, endGame etc.\n        if (msg.type === \"pendingVisit\") {\n          try {\n            const _pIdx = msg.playerIdx ?? match.currentPlayerIdx;\n            // update pending visit store so scoreboard/pending dots render\n            try {\n              usePendingVisit\n                .getState()\n                .setVisit(msg.entries || [], msg.darts || 0, msg.total || 0);\n            } catch (e) {}\n            if (msg.frame) setRemoteFrame(msg.frame);\n          } catch (e) {}\n        }\n        if (msg.type === \"visit\") {\n          try {\n            // Prefer to import a full snapshot written by the committing window\n            const ok = tryImportSnapshot();\n            // Capture remote frame/finish metadata if provided (helps post-match zoom)\n            try {\n              if (msg.meta?.frame) setRemoteFrame(msg.meta.frame);\n              if (msg.finished && msg.meta) {\n                setWinningShot({\n                  label: msg.meta.label || deriveWinningLabel() || undefined,\n                  ring: msg.meta.ring,\n                  frame: msg.meta.frame ?? msg.frame ?? null,\n                  ts: Date.now(),\n                });\n                // Ensure local state marks game ended so overlays/header refresh\n                match.endGame();\n              }\n            } catch {}\n            // Always clear any remote pending preview\n            try {\n              usePendingVisit.getState().reset();\n            } catch (e) {}\n            // If no snapshot available, we keep the pending cleared and rely on\n            // subsequent snapshot or other messages to bring state in sync.\n            if (!ok) {\n              // optional: attempt a minimal local update if message contains enough info\n              // but to avoid double-applying visits we avoid calling addVisit here.\n            }\n          } catch (e) {}\n        }\n\n        if (msg.type === \"nextPlayer\") {\n          try {\n            // If a snapshot is available, import it. Otherwise set the currentPlayerIdx\n            const ok = tryImportSnapshot();\n            if (!ok) {\n              try {\n                const cur = useMatch.getState();\n                const matchState = {\n                  roomId: cur.roomId,\n                  players: cur.players,\n                  currentPlayerIdx:\n                    typeof msg.currentPlayerIdx === \"number\"\n                      ? msg.currentPlayerIdx\n                      : (cur.currentPlayerIdx + 1) % (cur.players?.length || 1),\n                  startingScore: cur.startingScore,\n                  inProgress: cur.inProgress,\n                  bestLegThisMatch: cur.bestLegThisMatch,\n                };\n                useMatch.getState().importState(matchState);\n              } catch (e) {}\n            }\n          } catch (e) {}\n        }\n\n        if (msg.type === \"endLeg\") {\n          try {\n            const ok = tryImportSnapshot();\n            if (!ok) {\n              // best-effort: import snapshot not available, mark inProgress as-is\n              // we avoid trying to replay UI-only behavior here.\n            }\n          } catch (e) {}\n        }\n\n        if (msg.type === \"endGame\") {\n          try {\n            const ok = tryImportSnapshot();\n            if (!ok) {\n              try {\n                const cur = useMatch.getState();\n                const matchState = {\n                  roomId: cur.roomId,\n                  players: cur.players,\n                  currentPlayerIdx: cur.currentPlayerIdx,\n                  startingScore: cur.startingScore,\n                  inProgress: false,\n                  bestLegThisMatch: cur.bestLegThisMatch,\n                };\n                useMatch.getState().importState(matchState);\n              } catch (e) {}\n            }\n          } catch (e) {}\n        }\n      } catch {}\n    });\n    return () => {\n      try {\n        if (typeof unsub === \"function\") unsub();\n      } catch {}\n    };\n  }, []);\n\n  const commitVisit = (score: number, darts: number, meta?: any) => {\n    const p = match.players?.[match.currentPlayerIdx];\n    const leg = p?.legs?.[p.legs.length - 1];\n    const prevRemaining = leg ? leg.totalScoreRemaining : match.startingScore;\n    const numericScore = typeof score === \"number\" ? score : 0;\n    let newRemaining = prevRemaining - numericScore;\n    if (!Number.isFinite(newRemaining) || newRemaining < 0) newRemaining = 0;\n\n    // Announce the score with the caller\n    if (callerEnabled) {\n      const playerName = p?.name || getPreferredUserName(user, \"Player\");\n      try {\n        sayScore(playerName, numericScore, newRemaining, callerVoice, {\n          volume: callerVolume,\n          checkoutOnly: speakCheckoutOnly,\n        });\n      } catch {}\n    }\n\n    match.addVisit(numericScore, darts, meta ?? { visitTotal: numericScore });\n    if (newRemaining === 0) {\n      match.endLeg(numericScore);\n    } else {\n      match.nextPlayer();\n    }\n  };\n\n  const resetManualState = () => {\n    setManualEntries([]);\n    setPlayerVisitDarts(0);\n    setPlayerDartPoints(0);\n    setVisitTotalInput(\"\");\n    setManualBox(\"\");\n  };\n\n  const addManualEntry = (value: number) => {\n    const dart = Math.max(0, Math.min(60, Math.round(value)));\n    const nextEntries = [...manualEntries, dart].slice(0, 3);\n    const darts = nextEntries.length;\n    setManualEntries(nextEntries);\n    setPlayerVisitDarts(darts);\n    if (darts >= 3) {\n      const sum = nextEntries.reduce((acc, v) => acc + v, 0);\n      commitVisit(sum, darts, { visitTotal: sum });\n      resetManualState();\n    }\n  };\n\n  const replaceLast = () => {\n    if (manualEntries.length === 0) return;\n    const next = manualEntries.slice(0, -1);\n    setManualEntries(next);\n    setPlayerVisitDarts(next.length);\n  };\n\n  const addDartNumeric = () => {\n    addManualEntry(Number(playerDartPoints) || 0);\n  };\n\n  const handleVisitTotalChange = (val: string) => {\n    setVisitTotalInput(val);\n  };\n\n  const addVisitTotal = () => {\n    const total = Math.max(0, Math.round(Number(visitTotalInput) || 0));\n    if (!Number.isFinite(total)) return;\n    commitVisit(total, 3, { visitTotal: total });\n    resetManualState();\n  };\n\n  // Derive a finishing label from match state (fallback when no camera meta is available)\n  const deriveWinningLabel = useCallback(() => {\n    try {\n      const legs: Array<{ ts: number; visit?: any; player?: any }> = [];\n      (match.players || []).forEach((p: any) => {\n        (p.legs || []).forEach((leg: any) => {\n          if (leg?.finished) {\n            const lastVisit = (leg.visits || []).slice(-1)[0];\n            legs.push({\n              ts: leg.endTime || Date.now(),\n              visit: lastVisit,\n              player: p,\n            });\n          }\n        });\n      });\n      if (!legs.length) return null;\n      const latest = legs.sort((a, b) => b.ts - a.ts)[0];\n      const entry = (latest.visit?.entries || []).slice(-1)[0];\n      if (entry?.label) return entry.label as string;\n      if (entry?.ring === \"DOUBLE\" && typeof entry?.value === \"number\")\n        return `Double ${entry.value / 2}`;\n      if (typeof latest.visit?.visitTotal === \"number\")\n        return `Checkout ${latest.visit.visitTotal}`;\n    } catch {}\n    return null;\n  }, [match.players]);\n\n  // When the match ends (or we return from close), keep the winning dart handy for header/zoom\n  useEffect(() => {\n    if (match.inProgress) {\n      // Clear any stale winning-shot info when a new match/leg starts\n      setWinningShot(null);\n      return;\n    }\n    // If we already have a winning shot, keep it; otherwise derive from match history\n    if (!winningShot?.label) {\n      const derived = deriveWinningLabel();\n      if (derived) setWinningShot((prev) => ({ ...prev, label: derived }));\n    }\n  }, [match.inProgress, deriveWinningLabel, winningShot?.label]);\n\n  return (\n    <div className=\"card ndn-game-shell ndn-page relative overflow-hidden md:overflow-hidden overflow-y-auto\">\n      {showStartShowcase && (\n        <MatchStartShowcase\n          open={showStartShowcase}\n          players={(match.players || []) as any}\n          onDone={() => {\n            showcaseLockedOpenRef.current = false;\n            setShowStartShowcase(false);\n          }}\n          onRequestClose={() => {\n            showcaseLockedOpenRef.current = false;\n            setShowStartShowcase(false);\n          }}\n          showCalibrationDefault={true}\n        />\n      )}\n      <div className=\"flex items-center gap-3 mb-4 ndn-section-title\">\n        <button\n          className=\"btn btn--ghost px-3 py-1\"\n          onClick={() => {\n            try {\n              if (window.opener && !(window.opener as any).closed) {\n                try {\n                  (window.opener as any).focus();\n                } catch {}\n              }\n              window.close();\n            } catch {}\n          }}\n          aria-label=\"Return to app and close match window\"\n        >\n          Return\n        </button>\n        <h2 className=\"text-3xl font-bold text-brand-700\">Match </h2>\n        {winningShot?.label && (\n          <span className=\"text-xs px-2 py-1 rounded-full bg-emerald-500/20 border border-emerald-400/30 text-emerald-200 align-middle\">\n            Winning double: {winningShot.label}\n          </span>\n        )}\n      </div>\n      <div\n        className=\"ndn-shell-body\"\n        style={{\n          paddingBottom:\n            \"calc(var(--ndn-bottomnav-h, 0px) + env(safe-area-inset-bottom, 0px) + 16px)\",\n        }}\n      >\n        <GameHeaderBar\n          left={\n            <div className=\"flex items-center gap-2\">\n              <span className=\"font-medium\">Camera view</span>\n            </div>\n          }\n          right={<PauseTimerBadge />}\n        />\n\n        {/* X01: Spectator-style full-screen camera when it's not the local user's turn */}\n        {((match as any)?.game || \"X01\") === \"X01\" && !isUsersTurn ? (\n          <div className=\"relative w-full rounded-3xl border border-slate-800/60 bg-black shadow-2xl overflow-hidden\">\n            <div className=\"relative aspect-video sm:aspect-[16/9] w-full\">\n              <CameraView hideInlinePanels={true} forceAutoStart={true} />\n            </div>\n            <LetterboxScoreboardOverlay\n              checkoutRemaining={localRemaining}\n              away={{\n                side: \"Away\",\n                name: awayPlayer?.name || \"Away\",\n                legsWon: awayPlayer?.legsWon || 0,\n                remaining: awayRemaining,\n              }}\n              home={{\n                side: \"Home\",\n                name: localPlayer?.name || \"Home\",\n                legsWon: localPlayer?.legsWon || 0,\n                remaining: localRemaining,\n              }}\n            />\n          </div>\n        ) : (\n          <div className=\"rounded-3xl border border-slate-800/60 bg-gradient-to-br from-slate-900/80 via-slate-900/60 to-slate-950/90 p-4 sm:p-6 shadow-2xl\">\n            <div className=\"grid grid-cols-1 gap-5 items-start\">\n              {/* Mobile: Turn-based layout */}\n              <div className=\"lg:hidden min-w-0 space-y-4\">\n                {isUsersTurn ? (\n                  <>\n                    <div className=\"card p-3 rounded-2xl border border-slate-800/60 bg-slate-950/60 shadow-xl ring-1 ring-white/5\">\n                      <div className=\"text-sm font-semibold mb-3 flex items-center justify-between\">\n                        <span>Your Camera</span>\n                        <span className=\"text-xs text-emerald-300\">\n                          Your turn\n                        </span>\n                      </div>\n                      <div className=\"relative h-56 rounded-2xl overflow-hidden bg-black shadow-inner\">\n                        <CameraView\n                          hideInlinePanels={true}\n                          forceAutoStart={true}\n                          onAddVisit={commitVisit}\n                          onEndLeg={(score) => {\n                            try {\n                              match.endLeg(score ?? 0);\n                            } catch {}\n                          }}\n                          onVisitCommitted={(\n                            _score,\n                            _darts,\n                            finished,\n                            meta,\n                          ) => {\n                            if (!finished) return;\n                            const frame = meta?.frame ?? remoteFrame ?? null;\n                            setWinningShot({\n                              label:\n                                meta?.label ||\n                                deriveWinningLabel() ||\n                                undefined,\n                              ring: meta?.ring,\n                              frame,\n                              ts: Date.now(),\n                            });\n                            try {\n                              match.endGame();\n                            } catch {}\n                          }}\n                        />\n                        {winningShot?.frame && !match.inProgress && (\n                          <div className=\"absolute inset-2 rounded-lg overflow-hidden border border-emerald-400/40 shadow-lg bg-black/70\">\n                            <img\n                              src={winningShot.frame}\n                              alt=\"Winning double zoom\"\n                              className=\"w-full h-full object-cover scale-125\"\n                            />\n                            <div className=\"absolute bottom-2 left-2 right-2 text-xs text-white bg-black/60 rounded-md px-2 py-1 flex items-center justify-between gap-2\">\n                              <span className=\"font-semibold\">\n                                Winning dart zoom\n                              </span>\n                              {winningShot.label && (\n                                <span className=\"text-emerald-200\">\n                                  {winningShot.label}\n                                </span>\n                              )}\n                            </div>\n                          </div>\n                        )}\n                      </div>\n                    </div>\n\n                    <div className=\"card p-4 rounded-2xl border border-slate-800/60 bg-slate-950/60 shadow-xl ring-1 ring-white/5\">\n                      <div className=\"flex items-center justify-between mb-3\">\n                        <h3 className=\"text-base font-semibold\">\n                          Your Scoreboard\n                        </h3>\n                      </div>\n                      <GameScoreboard\n                        gameMode={((match as any)?.game || \"X01\") as any}\n                        players={(match.players || []).map(\n                          (p: any, idx: number) => ({\n                            name: p.name || `Player ${idx + 1}`,\n                            isCurrentTurn:\n                              idx === (match.currentPlayerIdx || 0),\n                            legsWon: p.legsWon || 0,\n                            score:\n                              p.legs?.[p.legs.length - 1]\n                                ?.totalScoreRemaining ??\n                              match.startingScore ??\n                              lastOfflineStart,\n                            lastScore:\n                              p.legs && p.legs.length\n                                ? p.legs[p.legs.length - 1].visits.slice(-1)[0]\n                                    ?.score || 0\n                                : 0,\n                          }),\n                        )}\n                      />\n\n                      <div className=\"mt-4 rounded-2xl border border-indigo-500/30 bg-gradient-to-r from-indigo-950/40 via-purple-950/40 to-indigo-950/40 p-3 shadow-[0_0_24px_rgba(99,102,241,0.25)]\">\n                        <div className=\"flex flex-col sm:flex-row gap-3\">\n                          <input\n                            type=\"number\"\n                            inputMode=\"numeric\"\n                            className=\"input text-center text-lg font-semibold rounded-xl border border-indigo-500/40 bg-transparent focus:border-indigo-400 focus:ring-2 focus:ring-indigo-500/30 transition-all flex-1\"\n                            style={{\n                              width: \"400mm\",\n                              height: \"30mm\",\n                              maxWidth: \"100%\",\n                            }}\n                            value={visitTotalInput}\n                            onChange={(e) => setVisitTotalInput(e.target.value)}\n                            onKeyDown={(e) => {\n                              if (e.key === \"Enter\") {\n                                e.preventDefault();\n                                const score = parseInt(visitTotalInput) || 0;\n                                commitVisit(score, 3, { visitTotal: score });\n                                setVisitTotalInput(\"\");\n                              }\n                            }}\n                            placeholder=\"Tap to enter score\"\n                            disabled={!match.inProgress}\n                          />\n                          <button\n                            type=\"button\"\n                            className=\"btn btn--primary px-5 py-3 rounded-xl text-sm font-semibold\"\n                            onClick={() => {\n                              const score = parseInt(visitTotalInput) || 0;\n                              commitVisit(score, 3, { visitTotal: score });\n                              setVisitTotalInput(\"\");\n                            }}\n                            disabled={!match.inProgress || !visitTotalInput}\n                          >\n                            Submit score\n                          </button>\n                        </div>\n                      </div>\n                    </div>\n                  </>\n                ) : (\n                  <>\n                    <div className=\"card p-4 rounded-2xl border border-slate-800/60 bg-slate-950/60 shadow-xl ring-1 ring-white/5\">\n                      <div className=\"flex items-center justify-between mb-3\">\n                        <h3 className=\"text-base font-semibold\">Opponent</h3>\n                        <span className=\"text-xs text-amber-300 font-semibold px-2 py-1 rounded-full bg-amber-500/10 border border-amber-400/30\">\n                          Waiting\n                        </span>\n                      </div>\n                      <GameScoreboard\n                        gameMode={((match as any)?.game || \"X01\") as any}\n                        players={(opponentPlayers.length\n                          ? opponentPlayers\n                          : match.players || []\n                        ).map((p: any, idx: number) => ({\n                          name: p.name || `Player ${idx + 1}`,\n                          isCurrentTurn:\n                            p === (match.players || [])[match.currentPlayerIdx],\n                          legsWon: p.legsWon || 0,\n                          score:\n                            p.legs?.[p.legs.length - 1]?.totalScoreRemaining ??\n                            match.startingScore ??\n                            lastOfflineStart,\n                          lastScore:\n                            p.legs && p.legs.length\n                              ? p.legs[p.legs.length - 1].visits.slice(-1)[0]\n                                  ?.score || 0\n                              : 0,\n                        }))}\n                      />\n                    </div>\n\n                    <div className=\"card p-3 rounded-2xl border border-slate-800/60 bg-slate-950/60 shadow-xl ring-1 ring-white/5\">\n                      <div className=\"text-sm font-semibold mb-3 flex items-center justify-between\">\n                        <span>Opponent Camera</span>\n                        <span className=\"text-xs text-slate-300\">\n                          Live feed\n                        </span>\n                      </div>\n                      <div className=\"relative h-56 rounded-2xl overflow-hidden bg-black shadow-inner\">\n                        <CameraView\n                          hideInlinePanels={true}\n                          forceAutoStart={true}\n                          onAddVisit={commitVisit}\n                          onEndLeg={(score) => {\n                            try {\n                              match.endLeg(score ?? 0);\n                            } catch {}\n                          }}\n                          onVisitCommitted={(\n                            _score,\n                            _darts,\n                            finished,\n                            meta,\n                          ) => {\n                            if (!finished) return;\n                            const frame = meta?.frame ?? remoteFrame ?? null;\n                            setWinningShot({\n                              label:\n                                meta?.label ||\n                                deriveWinningLabel() ||\n                                undefined,\n                              ring: meta?.ring,\n                              frame,\n                              ts: Date.now(),\n                            });\n                            try {\n                              match.endGame();\n                            } catch {}\n                          }}\n                        />\n                        {winningShot?.frame && !match.inProgress && (\n                          <div className=\"absolute inset-2 rounded-lg overflow-hidden border border-emerald-400/40 shadow-lg bg-black/70\">\n                            <img\n                              src={winningShot.frame}\n                              alt=\"Winning double zoom\"\n                              className=\"w-full h-full object-cover scale-125\"\n                            />\n                            <div className=\"absolute bottom-2 left-2 right-2 text-xs text-white bg-black/60 rounded-md px-2 py-1 flex items-center justify-between gap-2\">\n                              <span className=\"font-semibold\">\n                                Winning dart zoom\n                              </span>\n                              {winningShot.label && (\n                                <span className=\"text-emerald-200\">\n                                  {winningShot.label}\n                                </span>\n                              )}\n                            </div>\n                          </div>\n                        )}\n                      </div>\n                    </div>\n                  </>\n                )}\n              </div>\n\n              {/* Desktop: Turn-based layout */}\n              <div className=\"hidden lg:block min-w-0 space-y-5\">\n                {isUsersTurn ? (\n                  <>\n                    <div className=\"card p-4 rounded-3xl border border-slate-800/60 bg-slate-950/60 shadow-xl ring-1 ring-white/5\">\n                      <div className=\"text-sm font-semibold mb-3 flex items-center justify-between\">\n                        <span>Your Camera</span>\n                        <span className=\"text-xs text-emerald-300\">\n                          Your turn\n                        </span>\n                      </div>\n                      <div className=\"relative h-[360px] rounded-2xl overflow-hidden bg-black shadow-inner\">\n                        <CameraView\n                          hideInlinePanels={true}\n                          forceAutoStart={true}\n                          onAddVisit={commitVisit}\n                          onEndLeg={(score) => {\n                            try {\n                              match.endLeg(score ?? 0);\n                            } catch {}\n                          }}\n                          onVisitCommitted={(\n                            _score,\n                            _darts,\n                            finished,\n                            meta,\n                          ) => {\n                            if (!finished) return;\n                            const frame = meta?.frame ?? remoteFrame ?? null;\n                            setWinningShot({\n                              label:\n                                meta?.label ||\n                                deriveWinningLabel() ||\n                                undefined,\n                              ring: meta?.ring,\n                              frame,\n                              ts: Date.now(),\n                            });\n                            try {\n                              match.endGame();\n                            } catch {}\n                          }}\n                        />\n                        {winningShot?.frame && !match.inProgress && (\n                          <div className=\"absolute inset-2 rounded-lg overflow-hidden border border-emerald-400/40 shadow-lg bg-black/70\">\n                            <img\n                              src={winningShot.frame}\n                              alt=\"Winning double zoom\"\n                              className=\"w-full h-full object-cover scale-125\"\n                            />\n                          </div>\n                        )}\n                      </div>\n                    </div>\n\n                    <div className=\"card p-5 rounded-3xl border border-slate-800/60 bg-slate-950/60 shadow-xl ring-1 ring-white/5\">\n                      <div className=\"flex items-center justify-between mb-3\">\n                        <h3 className=\"text-base font-semibold\">\n                          Your Scoreboard\n                        </h3>\n                      </div>\n                      <GameScoreboard\n                        gameMode={((match as any)?.game || \"X01\") as any}\n                        players={(match.players || []).map(\n                          (p: any, idx: number) => ({\n                            name: p.name || `Player ${idx + 1}`,\n                            isCurrentTurn:\n                              idx === (match.currentPlayerIdx || 0),\n                            legsWon: p.legsWon || 0,\n                            score:\n                              p.legs?.[p.legs.length - 1]\n                                ?.totalScoreRemaining ??\n                              match.startingScore ??\n                              lastOfflineStart,\n                            lastScore:\n                              p.legs && p.legs.length\n                                ? p.legs[p.legs.length - 1].visits.slice(-1)[0]\n                                    ?.score || 0\n                                : 0,\n                          }),\n                        )}\n                      />\n\n                      <div className=\"mt-5 rounded-2xl border border-indigo-500/30 bg-gradient-to-r from-indigo-950/40 via-purple-950/40 to-indigo-950/40 p-4 shadow-[0_0_24px_rgba(99,102,241,0.25)]\">\n                        <div className=\"flex flex-col sm:flex-row gap-3\">\n                          <input\n                            type=\"number\"\n                            className=\"input text-center text-lg font-semibold rounded-xl border border-indigo-500/40 bg-transparent focus:border-indigo-400 focus:ring-2 focus:ring-indigo-500/30 transition-all flex-1\"\n                            style={{\n                              width: \"400mm\",\n                              height: \"30mm\",\n                              maxWidth: \"100%\",\n                            }}\n                            value={visitTotalInput}\n                            onChange={(e) => setVisitTotalInput(e.target.value)}\n                            onKeyDown={(e) => {\n                              if (e.key === \"Enter\") {\n                                e.preventDefault();\n                                const score = parseInt(visitTotalInput) || 0;\n                                commitVisit(score, 3, { visitTotal: score });\n                                setVisitTotalInput(\"\");\n                              }\n                            }}\n                            placeholder=\"Enter score\"\n                            disabled={!match.inProgress}\n                          />\n                          <button\n                            type=\"button\"\n                            className=\"btn btn--primary px-5 py-3 rounded-xl text-sm font-semibold\"\n                            onClick={() => {\n                              const score = parseInt(visitTotalInput) || 0;\n                              commitVisit(score, 3, { visitTotal: score });\n                              setVisitTotalInput(\"\");\n                            }}\n                            disabled={!match.inProgress || !visitTotalInput}\n                          >\n                            Submit score\n                          </button>\n                        </div>\n                      </div>\n                    </div>\n                  </>\n                ) : (\n                  <>\n                    <div className=\"card p-5 rounded-3xl border border-slate-800/60 bg-slate-950/60 shadow-xl ring-1 ring-white/5\">\n                      <div className=\"flex items-center justify-between mb-3\">\n                        <h3 className=\"text-base font-semibold\">Opponent</h3>\n                        <span className=\"text-xs text-amber-300 font-semibold px-2 py-1 rounded-full bg-amber-500/10 border border-amber-400/30\">\n                          Opponent turn\n                        </span>\n                      </div>\n                      <GameScoreboard\n                        gameMode={((match as any)?.game || \"X01\") as any}\n                        players={(opponentPlayers.length\n                          ? opponentPlayers\n                          : match.players || []\n                        ).map((p: any, idx: number) => ({\n                          name: p.name || `Player ${idx + 1}`,\n                          isCurrentTurn:\n                            p === (match.players || [])[match.currentPlayerIdx],\n                          legsWon: p.legsWon || 0,\n                          score:\n                            p.legs?.[p.legs.length - 1]?.totalScoreRemaining ??\n                            match.startingScore ??\n                            lastOfflineStart,\n                          lastScore:\n                            p.legs && p.legs.length\n                              ? p.legs[p.legs.length - 1].visits.slice(-1)[0]\n                                  ?.score || 0\n                              : 0,\n                        }))}\n                      />\n                    </div>\n\n                    <div className=\"card p-4 rounded-3xl border border-slate-800/60 bg-slate-950/60 shadow-xl ring-1 ring-white/5\">\n                      <div className=\"text-sm font-semibold mb-3 flex items-center justify-between\">\n                        <span>Opponent Camera</span>\n                        <span className=\"text-xs text-slate-300\">\n                          Live feed\n                        </span>\n                      </div>\n                      <div className=\"relative h-[360px] rounded-2xl overflow-hidden bg-black shadow-inner\">\n                        <CameraView\n                          hideInlinePanels={true}\n                          forceAutoStart={true}\n                          onAddVisit={commitVisit}\n                          onEndLeg={(score) => {\n                            try {\n                              match.endLeg(score ?? 0);\n                            } catch {}\n                          }}\n                          onVisitCommitted={(\n                            _score,\n                            _darts,\n                            finished,\n                            meta,\n                          ) => {\n                            if (!finished) return;\n                            const frame = meta?.frame ?? remoteFrame ?? null;\n                            setWinningShot({\n                              label:\n                                meta?.label ||\n                                deriveWinningLabel() ||\n                                undefined,\n                              ring: meta?.ring,\n                              frame,\n                              ts: Date.now(),\n                            });\n                            try {\n                              match.endGame();\n                            } catch {}\n                          }}\n                        />\n                        {winningShot?.frame && !match.inProgress && (\n                          <div className=\"absolute inset-2 rounded-lg overflow-hidden border border-emerald-400/40 shadow-lg bg-black/70\">\n                            <img\n                              src={winningShot.frame}\n                              alt=\"Winning double zoom\"\n                              className=\"w-full h-full object-cover scale-125\"\n                            />\n                          </div>\n                        )}\n                      </div>\n                    </div>\n                  </>\n                )}\n              </div>\n            </div>\n          </div>\n        )}\n      </div>\n    </div>\n  );\n}\n","// Lightweight app-wide event helpers\n// Keep these names stable since multiple components dispatch/listen.\n\nexport const NDN_OPEN_NOTIFICATIONS_EVENT = \"ndn:open-notifications\" as const;\n\nexport function dispatchOpenNotifications() {\n  try {\n    window.dispatchEvent(new CustomEvent(NDN_OPEN_NOTIFICATIONS_EVENT));\n  } catch {\n    // ignore\n  }\n}\n","import React from \"react\";\nimport { useWS } from \"./WSProvider\";\n\ntype Props = {\n  /** Optional extra classes for positioning. */\n  className?: string;\n  /** Tooltip text (defaults to Connected/Disconnected). */\n  title?: string;\n};\n\nexport default function WSConnectionDot({ className, title }: Props) {\n  // If for some reason WSProvider isn't mounted, fail closed (show disconnected).\n  let connected = false;\n  try {\n    connected = useWS().connected;\n  } catch {\n    connected = false;\n  }\n\n  const baseTitle = connected ? \"Connected\" : \"Disconnected\";\n\n  return (\n    <span\n      aria-label={`Server connection: ${baseTitle}`}\n      title={title || baseTitle}\n      className={[\n        \"inline-flex items-center justify-center\",\n        \"w-3 h-3 rounded-full\",\n        connected ? \"bg-emerald-400\" : \"bg-red-500\",\n        \"ring-2 ring-black/20\",\n        className || \"\",\n      ].join(\" \")}\n    />\n  );\n}\n","import React, {\n  useCallback,\n  useEffect,\n  useRef,\n  useState,\n  Suspense,\n} from \"react\";\nimport { Sidebar, TabKey, buildTabList } from \"./components/Sidebar\";\nimport { useIsAdmin } from \"./utils/admin\";\nconst Home = React.lazy(() => import(\"./components/Home\"));\nimport ScrollFade from \"./components/ScrollFade\";\nimport Calibrator from \"./components/Calibrator\";\n// Lazy-load CameraView to avoid importing a large camera module at app\n// bootstrap time. This prevents the component module from executing during\n// initial module evaluation which can avoid TDZ issues when other modules\n// import shared stores during startup.\nconst CameraView = React.lazy(() => import(\"./components/CameraView\"));\nconst OfflinePlay = React.lazy(() => import(\"./components/OfflinePlay\"));\nconst Friends = React.lazy(() => import(\"./components/Friends\"));\nimport Toaster from \"./components/Toaster\";\nimport AdminDashboard from \"./components/AdminDashboard\";\nimport SettingsPanel from \"./components/SettingsPanel\";\nimport Auth from \"./components/Auth\";\nimport { ThemeProvider } from \"./components/ThemeContext\";\nimport {\n  ArrowDownRight,\n  ArrowUpRight,\n  BarChart2,\n  Bell,\n  CalendarDays,\n  Gamepad2,\n  Globe,\n  Handshake,\n  Menu,\n  MessageCircle,\n  Trophy,\n  Users,\n  X,\n} from \"lucide-react\";\nimport { useWS } from \"./components/WSProvider\";\nimport {\n  getMonthlyAvg3,\n  getAllTimeAvg,\n  syncStatsFromServer,\n} from \"./store/profileStats\";\nimport { useMatch } from \"./store/match\";\nimport { useUserSettings } from \"./store/userSettings\";\nimport { useCalibration } from \"./store/calibration\";\nimport { apiFetch, getApiBaseUrl } from \"./utils/api\";\nimport { DISCORD_INVITE_URL } from \"./utils/config\";\nimport \"./styles/premium.css\";\nimport \"./styles/themes.css\";\nconst OnlinePlay = React.lazy(() => import(\"./components/OnlinePlay.clean\"));\nconst StatsPanel = React.lazy(() => import(\"./components/StatsPanel\"));\nconst Tournaments = React.lazy(() => import(\"./components/Tournaments\"));\nconst AdminAccess = React.lazy(() => import(\"./components/AdminAccess\"));\n// AdminAccess already imported above\nimport Drawer from \"./components/ui/Drawer\";\nconst OpsDashboard = React.lazy(() => import(\"./components/OpsDashboard\"));\nimport HelpAssistant from \"./components/HelpAssistant\";\nimport GlobalCameraLogger from \"./components/GlobalCameraLogger\";\nimport GlobalPhoneVideoSink from \"./components/GlobalPhoneVideoSink\";\nimport GlobalCameraWatchdog from \"./components/GlobalCameraWatchdog\";\nimport GlobalCameraRecoveryToasts from \"./components/GlobalCameraRecoveryToasts\";\nimport InstallPicker from \"./components/InstallPicker\";\nimport AddToHomeButton from \"./components/AddToHomeButton\";\nimport Footer from \"./components/Footer\";\nimport AutoPauseManager from \"./components/AutoPauseManager\";\nimport MatchPage from \"./components/MatchPage\";\nimport { useToast } from \"./store/toast\";\nimport { NDN_OPEN_NOTIFICATIONS_EVENT } from \"./utils/events\";\nimport WSConnectionDot from \"./components/WSConnectionDot\";\n\nexport default function App() {\n  const appRef = useRef<HTMLDivElement | null>(null);\n  const [avatar, setAvatar] = useState<string>(\"\");\n  const [isFullscreen, setIsFullscreen] = useState(false);\n  const ws = (() => {\n    try {\n      return useWS();\n    } catch {\n      return null;\n    }\n  })();\n  const [tab, setTab] = useState<TabKey>(\"score\");\n  const [isMobile, setIsMobile] = useState<boolean>(false);\n  const [navOpen, setNavOpen] = useState<boolean>(false);\n  const [user, setUser] = useState<any>(null);\n  // Use this helper to set user without losing previously fetched subscription data\n  // This avoids toggles/flicker in the UI during partial user refreshes\n  function setUserWithMerge(next: any) {\n    if (!next) {\n      setUser(next);\n      return;\n    }\n    setUser((prev: any) => {\n      const merged = { ...prev, ...next };\n      if (prev?.subscription && !next?.subscription)\n        merged.subscription = prev.subscription;\n      if (next?.subscription) merged.subscription = next.subscription;\n      // Keep fullAccess aligned with subscription unless explicitly provided\n      merged.fullAccess = !!(\n        merged.subscription?.fullAccess ||\n        next?.fullAccess ||\n        merged.fullAccess\n      );\n      return merged;\n    });\n  }\n  const MINIMAL_UI =\n    ((import.meta as any).env?.VITE_MINIMAL_AFTER_LOGIN || \"\").toString() ===\n    \"1\";\n  const [minimalUI, setMinimalUI] = useState<boolean>(false);\n  const [allTimeAvg, setAllTimeAvg] = useState<number>(0);\n  const [avgDelta, setAvgDelta] = useState<number>(0);\n  const { avgMode } = useUserSettings();\n  const _cameraEnabled = useUserSettings((s) => s.cameraEnabled);\n  const matchInProgress = useMatch((s) => s.inProgress);\n  const isCompact = matchInProgress && tab !== \"score\";\n  const toast = useToast();\n  const normalizedDelta = Math.abs(avgDelta) >= 0.05 ? avgDelta : 0;\n  const API_URL = getApiBaseUrl();\n  const {\n    locked: calibLocked,\n    H: calibH,\n    errorPx,\n    setCalibration,\n  } = useCalibration();\n  const userSettings = useUserSettings();\n\n  // Sync locked state from userSettings to calibration store on app mount\n  useEffect(() => {\n    try {\n      const persistedLocked = userSettings.preferredCameraLocked;\n      if (persistedLocked && calibLocked !== persistedLocked) {\n        setCalibration({ locked: persistedLocked });\n        console.info(\n          \"[APP] Synced camera locked state from userSettings:\",\n          persistedLocked,\n        );\n      }\n    } catch (e) {\n      console.warn(\"Failed to sync locked state from userSettings\", e);\n    }\n  }, [calibLocked, setCalibration, userSettings.preferredCameraLocked]);\n\n  // Globally catch unhandled promise rejections and surface as warnings so the\n  // devtools console is less noisy. We still log the reason so developers can\n  // inspect real issues, but avoid uncaught exceptions flooding the console.\n  useEffect(() => {\n    const onUnhandled = (ev: PromiseRejectionEvent) => {\n      try {\n        // Some rejections are expected (e.g., media play AbortError during\n        // transient UI swaps). Log as a warn and prevent default reporting.\n        // Keep the logged payload small to avoid huge dumps.\n        // @ts-ignore - ev.reason exists on modern browsers\n        console.warn(\"Unhandled promise rejection (suppressed):\", ev.reason);\n        ev.preventDefault?.();\n      } catch (err) {\n        console.error(\"Failed to refresh friend notifications:\", err);\n        return false;\n      }\n    };\n    window.addEventListener(\"unhandledrejection\", onUnhandled as any);\n    return () =>\n      window.removeEventListener(\"unhandledrejection\", onUnhandled as any);\n  }, []);\n\n  // Restore user from token on mount (run once only)\n  useEffect(() => {\n    const token = localStorage.getItem(\"authToken\");\n    if (!token) return;\n\n    // Validate token with server\n    fetch(`${API_URL}/api/auth/me`, {\n      headers: { Authorization: `Bearer ${token}` },\n    })\n      .then((res) => res.json())\n      .then((data) => {\n        if (data?.user) {\n          setUserWithMerge(data.user);\n          try {\n            const cached = localStorage.getItem(\n              `ndn:subscription:${data.user.email}`,\n            );\n            if (cached)\n              setUserWithMerge({\n                ...data.user,\n                subscription: JSON.parse(cached),\n              });\n          } catch (e) {}\n          fetchSubscription(data.user);\n        } else {\n          // Token invalid, remove it\n          localStorage.removeItem(\"authToken\");\n        }\n      })\n      .catch(() => {\n        // Network error, keep token for offline retry\n      });\n  }, []);\n\n  // Handle minimal UI delay when user is present\n  useEffect(() => {\n    if (user && MINIMAL_UI) {\n      setMinimalUI(true);\n      const timer = setTimeout(() => setMinimalUI(false), 1500);\n      return () => clearTimeout(timer);\n    }\n  }, [MINIMAL_UI, user]);\n\n  // If URL contains ?match=1 render a minimal match-only page (allows opening dedicated match windows)\n  try {\n    const urlParams = new URLSearchParams(window.location.search);\n    if (urlParams.get(\"match\") === \"1\") {\n      return (\n        <ThemeProvider>\n          <AutoPauseManager />\n          <MatchPage />\n        </ThemeProvider>\n      );\n    }\n  } catch {}\n\n  useEffect(() => {\n    const onLogout = () => {\n      try {\n        localStorage.removeItem(\"mockUser\");\n        localStorage.removeItem(\"authToken\");\n        if (user?.email)\n          localStorage.removeItem(`ndn:subscription:${user.email}`);\n      } catch (e) {}\n      setUser(null);\n      setTab(\"score\");\n    };\n    window.addEventListener(\"ndn:logout\" as any, onLogout as any);\n    return () =>\n      window.removeEventListener(\"ndn:logout\" as any, onLogout as any);\n  }, []);\n  // Refresh all-time avg when user changes or stats update\n  useEffect(() => {\n    if (!user?.username) {\n      setAvgDelta(0);\n      return;\n    }\n    try {\n      // Persist the active username so lower-level modules (e.g., stats/store) can\n      // resolve aliases like \"You\" back to the signed-in user when persisting stats.\n      localStorage.setItem(\"ndn:currentUser\", user.username);\n      (window as any).ndnCurrentUser = user.username;\n    } catch {}\n    try {\n      syncStatsFromServer(user.username);\n    } catch {}\n    // Delayed retry: if the server is cold-starting the first sync may fail.\n    // Retry after 5 seconds so stats still appear without a manual reload.\n    const retryTimer = setTimeout(() => {\n      try { syncStatsFromServer(user.username); } catch {}\n    }, 5000);\n    const refresh = () => {\n      const nextAvg =\n        avgMode === \"24h\"\n          ? getMonthlyAvg3(user.username)\n          : getAllTimeAvg(user.username);\n      setAllTimeAvg(nextAvg);\n      const key = `ndn:allTimeAvgSnapshot:${user.username}`;\n      const now = Date.now();\n      const currentMonth = new Date().getMonth();\n      const currentYear = new Date().getFullYear();\n\n      try {\n        const raw = localStorage.getItem(key);\n        if (!raw) {\n          localStorage.setItem(\n            key,\n            JSON.stringify({\n              value: nextAvg,\n              ts: now,\n              month: currentMonth,\n              year: currentYear,\n            }),\n          );\n          setAvgDelta(0);\n          return;\n        }\n        const parsed = JSON.parse(raw);\n        const baseline = Number(parsed?.value) || 0;\n        const snapshotMonth = Number(parsed?.month);\n        const snapshotYear = Number(parsed?.year);\n\n        // Check if we're in a new month - if so, reset the baseline\n        if (snapshotYear !== currentYear || snapshotMonth !== currentMonth) {\n          // New month - set baseline to current average and delta to 0\n          localStorage.setItem(\n            key,\n            JSON.stringify({\n              value: nextAvg,\n              ts: now,\n              month: currentMonth,\n              year: currentYear,\n            }),\n          );\n          setAvgDelta(0);\n        } else {\n          // Same month - calculate delta from baseline\n          const delta = nextAvg - baseline;\n          setAvgDelta(Number.isFinite(delta) ? delta : 0);\n        }\n      } catch {\n        setAvgDelta(0);\n      }\n    };\n    refresh();\n    const onUpdate = () => refresh();\n    const onStorage = (e: StorageEvent) => {\n      const key = e.key || \"\";\n      if (!key) return;\n      // React to stats writes from other tabs/windows (e.g., match popouts)\n      const prefixes = [\n        `ndn_stats_${user.username}`,\n        `ndn_stats_ts_${user.username}`,\n        `ndn_stats_daily_${user.username}`,\n        `ndn:allTimeAvgSnapshot:${user.username}`,\n      ];\n      if (prefixes.some((p) => key.startsWith(p))) refresh();\n    };\n    window.addEventListener(\"ndn:stats-updated\", onUpdate as any);\n    window.addEventListener(\"storage\", onStorage);\n    return () => {\n      clearTimeout(retryTimer);\n      window.removeEventListener(\"ndn:stats-updated\", onUpdate as any);\n      window.removeEventListener(\"storage\", onStorage);\n    };\n  }, [user?.username, avgMode]);\n\n  // Re-sync stats from server when the tab/window regains focus so stats\n  // recorded on another device (e.g., desktop) appear on mobile immediately.\n  useEffect(() => {\n    if (!user?.username) return;\n    const handleVisibility = () => {\n      if (!document.hidden) {\n        syncStatsFromServer(user.username).then(() => {\n          // After sync, refresh the displayed average\n          window.dispatchEvent(new CustomEvent(\"ndn:stats-updated\", { detail: { name: user.username } }));\n        }).catch(() => {});\n      }\n    };\n    const handleFocus = () => {\n      syncStatsFromServer(user.username).then(() => {\n        window.dispatchEvent(new CustomEvent(\"ndn:stats-updated\", { detail: { name: user.username } }));\n      }).catch(() => {});\n    };\n    document.addEventListener(\"visibilitychange\", handleVisibility);\n    window.addEventListener(\"focus\", handleFocus);\n    return () => {\n      document.removeEventListener(\"visibilitychange\", handleVisibility);\n      window.removeEventListener(\"focus\", handleFocus);\n    };\n  }, [user?.username]);\n\n  // Load avatar from localStorage when user changes\n  useEffect(() => {\n    if (!user?.username) {\n      setAvatar(\"\");\n      return;\n    }\n    const storedAvatar = localStorage.getItem(\n      `ndn:bio:profilePhoto:${user.username}`,\n    );\n    setAvatar(storedAvatar || \"\");\n  }, [user?.username]);\n\n  // Listen for avatar updates from SettingsPanel\n  useEffect(() => {\n    const handleStorageChange = (e: StorageEvent) => {\n      if (\n        e.key?.startsWith(\"ndn:bio:profilePhoto:\") &&\n        user?.username &&\n        e.key.endsWith(user.username)\n      ) {\n        setAvatar(e.newValue || \"\");\n      }\n    };\n    const handleAvatarUpdate = (e: any) => {\n      // Check if this update is for the current user\n      if (e.detail?.username === user?.username) {\n        setAvatar(e.detail?.avatar || \"\");\n      }\n      // Also check localStorage as backup for any avatar update\n      if (user?.username) {\n        const storedAvatar = localStorage.getItem(\n          `ndn:bio:profilePhoto:${user.username}`,\n        );\n        setAvatar(storedAvatar || \"\");\n      }\n    };\n    // Also check localStorage when window becomes visible (user switches tabs)\n    const handleVisibilityChange = () => {\n      if (!document.hidden && user?.username) {\n        const storedAvatar = localStorage.getItem(\n          `ndn:bio:profilePhoto:${user.username}`,\n        );\n        setAvatar(storedAvatar || \"\");\n      }\n    };\n\n    // Check localStorage periodically as a fallback (less frequent to reduce work)\n    const checkAvatarInterval = setInterval(() => {\n      if (user?.username) {\n        const storedAvatar = localStorage.getItem(\n          `ndn:bio:profilePhoto:${user.username}`,\n        );\n        if (storedAvatar && storedAvatar !== avatar) {\n          setAvatar(storedAvatar);\n        }\n      }\n    }, 10000); // every 10s\n\n    window.addEventListener(\"storage\", handleStorageChange);\n    window.addEventListener(\n      \"ndn:avatar-updated\" as any,\n      handleAvatarUpdate as any,\n    );\n    document.addEventListener(\"visibilitychange\", handleVisibilityChange);\n    return () => {\n      window.removeEventListener(\"storage\", handleStorageChange);\n      window.removeEventListener(\n        \"ndn:avatar-updated\" as any,\n        handleAvatarUpdate as any,\n      );\n      document.removeEventListener(\"visibilitychange\", handleVisibilityChange);\n      clearInterval(checkAvatarInterval);\n    };\n  }, [user?.username, avatar]);\n\n  // Handle payment success for username change\n  useEffect(() => {\n    const urlParams = new URLSearchParams(window.location.search);\n    const paid = urlParams.get(\"paid\");\n    const usernameChange = urlParams.get(\"username-change\");\n    if (\n      paid === \"1\" ||\n      paid === \"username-change\" ||\n      usernameChange === \"free\"\n    ) {\n      const pendingUsername = localStorage.getItem(\"pendingUsernameChange\");\n      if (pendingUsername && user?.email) {\n        // Call the change username API\n        fetch(`${API_URL}/api/change-username`, {\n          method: \"POST\",\n          headers: { \"Content-Type\": \"application/json\" },\n          body: JSON.stringify({\n            email: user.email,\n            newUsername: pendingUsername,\n          }),\n        })\n          .then((res) => res.json())\n          .then((data) => {\n            if (data.ok) {\n              alert(\"Username changed successfully!\");\n              localStorage.removeItem(\"pendingUsernameChange\");\n              // Update user data and token\n              if (data.token) {\n                localStorage.setItem(\"authToken\", data.token);\n              }\n              if (data.user) {\n                setUserWithMerge(data.user);\n              }\n              // Clean up URL\n              window.history.replaceState(\n                {},\n                document.title,\n                window.location.pathname,\n              );\n            } else {\n              alert(\n                \"Failed to change username: \" + (data.error || \"Unknown error\"),\n              );\n            }\n          })\n          .catch(() => {\n            alert(\"Network error while changing username\");\n          });\n      }\n    }\n  }, [user?.email]);\n\n  // Keep full-screen state in sync when the user enters/exits full screen mode.\n  useEffect(() => {\n    const onFullscreenChange = () =>\n      setIsFullscreen(!!document.fullscreenElement);\n    document.addEventListener(\"fullscreenchange\", onFullscreenChange);\n    // initialize\n    setIsFullscreen(!!document.fullscreenElement);\n    return () =>\n      document.removeEventListener(\"fullscreenchange\", onFullscreenChange);\n  }, []);\n\n  // Handle payment success for premium subscription\n  useEffect(() => {\n    const urlParams = new URLSearchParams(window.location.search);\n    const subscription = urlParams.get(\"subscription\");\n    if (subscription === \"success\" && user?.email) {\n      // Refresh user data to get updated subscription status\n      fetch(`${API_URL}/api/auth/me`, {\n        headers: {\n          Authorization: `Bearer ${localStorage.getItem(\"authToken\")}`,\n        },\n      })\n        .then((res) => res.json())\n        .then((data) => {\n          if (data?.user) {\n            setUserWithMerge(data.user);\n            alert(\"Premium subscription activated successfully!\");\n            // Clean up URL\n            window.history.replaceState(\n              {},\n              document.title,\n              window.location.pathname,\n            );\n          }\n        })\n        .catch(() => {\n          alert(\n            \"Subscription activated, but failed to refresh user data. Please refresh the page.\",\n          );\n        });\n    }\n  }, [user?.email]);\n\n  // Universal responsive breakpoint: navigation mode is based on viewport width,\n  // not device type/UA. This ensures consistent UI across all devices.\n  useEffect(() => {\n    const mq = window.matchMedia(\"(max-width: 768px)\");\n    const update = () => setIsMobile(mq.matches);\n    update();\n\n    try {\n      mq.addEventListener(\"change\", update);\n    } catch {\n      // Safari/older browsers\n      mq.addListener(update);\n    }\n\n    window.addEventListener(\"resize\", update);\n    window.addEventListener(\"orientationchange\", update);\n\n    return () => {\n      window.removeEventListener(\"resize\", update);\n      window.removeEventListener(\"orientationchange\", update);\n      try {\n        mq.removeEventListener(\"change\", update);\n      } catch {\n        mq.removeListener(update);\n      }\n    };\n  }, []);\n\n  // Keep the CSS header height token in sync with the actual header element so\n  // mobile offsets (drawer / main scroll padding) are accurate.\n  useEffect(() => {\n    function updateHeaderHeight() {\n      const el = document.getElementById(\"ndn-header\");\n      if (!el) return;\n      const h = Math.ceil(el.getBoundingClientRect().height);\n      document.documentElement.style.setProperty(\"--ndn-header-h\", `${h}px`);\n    }\n\n    updateHeaderHeight();\n    window.addEventListener(\"resize\", updateHeaderHeight);\n    window.addEventListener(\"orientationchange\", updateHeaderHeight);\n    // Also respond when the compact mode changes so header height updates\n    // (isCompact is part of the dependency list)\n    return () => {\n      window.removeEventListener(\"resize\", updateHeaderHeight);\n      window.removeEventListener(\"orientationchange\", updateHeaderHeight);\n    };\n  }, [isCompact]);\n\n  // On mobile, shift the hamburger when the user scrolls upward.\n  useEffect(() => {\n    if (!isMobile) return;\n    const scroller = document.getElementById(\"ndn-main-scroll\");\n    if (!scroller) return;\n    let lastTop = scroller.scrollTop;\n    const onScroll = () => {\n      const currentTop = scroller.scrollTop;\n      if (currentTop < lastTop) {\n        document.documentElement.classList.add(\"ndn-menu-scrolled\");\n      } else if (currentTop > lastTop) {\n        document.documentElement.classList.remove(\"ndn-menu-scrolled\");\n      }\n      lastTop = currentTop;\n    };\n    scroller.addEventListener(\"scroll\", onScroll, { passive: true });\n    return () => {\n      scroller.removeEventListener(\"scroll\", onScroll);\n      document.documentElement.classList.remove(\"ndn-menu-scrolled\");\n    };\n  }, [isMobile]);\n\n  useEffect(() => {\n    if (!isMobile) return;\n    if (navOpen) {\n      document.documentElement.classList.add(\"ndn-menu-open\");\n    } else {\n      document.documentElement.classList.remove(\"ndn-menu-open\");\n    }\n    return () => {\n      document.documentElement.classList.remove(\"ndn-menu-open\");\n    };\n  }, [isMobile, navOpen]);\n\n  // Global logout handler: return to sign-in screen and clear minimal local user context\n  useEffect(() => {\n    const onLogout = () => {\n      try {\n        // Clear any lightweight local flags (keep stats unless explicitly reset)\n        localStorage.removeItem(\"ndn:avatar\");\n        if (user?.email)\n          localStorage.removeItem(`ndn:subscription:${user.email}`);\n      } catch (e) {}\n      setUser(null);\n      setTab(\"score\");\n    };\n    window.addEventListener(\"ndn:logout\" as any, onLogout as any);\n    return () =>\n      window.removeEventListener(\"ndn:logout\" as any, onLogout as any);\n  }, []);\n\n  // Apply username changes from Settings globally and propagate via WS presence\n  useEffect(() => {\n    const onName = (e: any) => {\n      try {\n        const next = String(e?.detail?.username || \"\").trim();\n        if (!next) return;\n        setUser((prev: any) => {\n          const u = prev ? { ...prev, username: next } : prev;\n          return u;\n        });\n        // Recompute name color on next effect pass based on new username/avatar\n        // Send presence update so friends/lobby reflect the new name\n        try {\n          const email = (user?.email || \"\").toLowerCase();\n          if (ws && next && email)\n            ws.send({ type: \"presence\", username: next, email });\n        } catch (e) {}\n      } catch (e) {}\n    };\n    window.addEventListener(\"ndn:username-changed\" as any, onName as any);\n    return () =>\n      window.removeEventListener(\"ndn:username-changed\" as any, onName as any);\n  }, [ws, user?.email]);\n\n  // Handle tab changes from Home component quick access pills\n  useEffect(() => {\n    const onTabChange = (e: any) => {\n      try {\n        const tab = String(e?.detail?.tab || \"\").trim();\n        if (\n          tab &&\n          [\n            \"score\",\n            \"offline\",\n            \"online\",\n            \"stats\",\n            \"settings\",\n            \"admin\",\n            \"tournaments\",\n            \"friends\",\n          ].includes(tab)\n        ) {\n          setTab(tab as TabKey);\n          // Ensure the mobile hamburger sits in a visible \"free\" spot after\n          // navigating to a new tab (the header layout can change per tab).\n          // Compute the right edge of the left brand pill (if present) and\n          // nudge the CSS var so the hamburger sits just to its right.\n          try {\n            const brand = document.querySelector(\n              \".ndn-mobile-brand\",\n            ) as HTMLElement | null;\n            if (\n              brand &&\n              typeof window !== \"undefined\" &&\n              typeof window.getComputedStyle === \"function\"\n            ) {\n              const rect = brand.getBoundingClientRect();\n              const leftPx = Math.max(8, Math.round(rect.right + 8));\n              document.documentElement.style.setProperty(\n                \"--ndn-mobile-menu-left\",\n                `${leftPx}px`,\n              );\n            }\n            // Also set a small per-tab section gap variable so specific pages\n            // can have precise spacing below the header on mobile.\n            const tabGapMap: Record<string, string> = {\n              score: \"1mm\",\n              online: \"1mm\",\n              offline: \"1mm\",\n              tournaments: \"1mm\",\n              friends: \"1mm\",\n              stats: \"1mm\",\n              calibrate: \"1mm\",\n              settings: \"1mm\",\n              admin: \"1mm\",\n              fullaccess: \"1mm\",\n            };\n            const gap = tabGapMap[tab] || \"1mm\";\n            document.documentElement.style.setProperty(\n              \"--ndn-section-gap\",\n              gap,\n            );\n          } catch (err) {\n            // best-effort only\n            // console.warn('Could not reposition mobile hamburger', err);\n          }\n        }\n      } catch (e) {}\n    };\n    window.addEventListener(\"ndn:change-tab\" as any, onTabChange as any);\n    return () =>\n      window.removeEventListener(\"ndn:change-tab\" as any, onTabChange as any);\n  }, []);\n\n  async function fetchSubscription(u: any) {\n    try {\n      const q = u?.email ? `?email=${encodeURIComponent(u.email)}` : \"\";\n      const res = await fetch(\"/api/subscription\" + q);\n      if (!res.ok) return;\n      const data = await res.json();\n      // Keep the full user object but attach the subscription so other components\n      // can make decisions based on more detailed subscription metadata (expiresAt, source, status).\n      setUserWithMerge({\n        ...u,\n        fullAccess: !!data?.fullAccess,\n        subscription: data,\n      });\n      try {\n        if (u?.email)\n          localStorage.setItem(\n            `ndn:subscription:${u.email}`,\n            JSON.stringify(data),\n          );\n      } catch {}\n    } catch (e) {}\n  }\n\n  // Header notification state: show an alert if subscription is expiring in <= 3 days, or expired\n  const [showSubscriptionsBell, setShowSubscriptionsBell] = useState(false);\n  const [notificationsOpen, setNotificationsOpen] = useState(false);\n  const [siteNotifications, setSiteNotifications] = useState<any[]>([]);\n  const [friendRequestCount, setFriendRequestCount] = useState(0);\n  const [unreadMessageCount, setUnreadMessageCount] = useState(0);\n\n  const refreshNotifications = useCallback(async () => {\n    if (!user?.email) return [] as any[];\n    try {\n      const token = localStorage.getItem(\"authToken\");\n      const headers: Record<string, string> = {};\n      if (token) headers.Authorization = `Bearer ${token}`;\n      const res = await fetch(\n        `/api/notifications?email=${encodeURIComponent(user.email)}`,\n        { headers },\n      );\n      if (!res.ok) return [];\n      return (await res.json()) || [];\n    } catch (err) {\n      return [];\n    }\n  }, [user?.email]);\n\n  const refreshFriendCounts = useCallback(async () => {\n    if (!user?.email) {\n      setFriendRequestCount(0);\n      setUnreadMessageCount(0);\n      return;\n    }\n    try {\n      const [requestsRes, messagesRes] = await Promise.all([\n        apiFetch(\n          `/api/friends/requests?email=${encodeURIComponent(user.email)}`,\n        ),\n        apiFetch(\n          `/api/friends/messages?email=${encodeURIComponent(user.email)}`,\n        ),\n      ]);\n      const requests = requestsRes.ok\n        ? await requestsRes.json()\n        : { requests: [] };\n      const messages = messagesRes.ok\n        ? await messagesRes.json()\n        : { messages: [] };\n      setFriendRequestCount(requests.requests?.length || 0);\n      setUnreadMessageCount(\n        (messages.messages || []).filter((m: any) => !m.read).length,\n      );\n    } catch (err) {\n      console.error(\"Failed to refresh friend notifications:\", err);\n      return false;\n    }\n    return true;\n  }, [user?.email]);\n\n  // Track consecutive failures and temporarily disable polling to avoid\n  // hammering a dead remote API (improves performance and reduces noise).\n  const friendPollFailuresRef = useRef<number>(0);\n  const friendPollDisabledUntilRef = useRef<number | null>(null);\n\n  useEffect(() => {\n    if (!user?.subscription) {\n      setShowSubscriptionsBell(false);\n      return;\n    }\n    const sub = user.subscription as any;\n    const now = Date.now();\n    let expiresAt: number | null = null;\n    if (sub?.expiresAt) {\n      expiresAt =\n        typeof sub.expiresAt === \"string\"\n          ? Date.parse(sub.expiresAt)\n          : Number(sub.expiresAt);\n    }\n    // Consider this expiring soon when it's within 3 days (259200000 ms)\n    const THREE_DAYS_MS = 3 * 24 * 60 * 60 * 1000;\n    if (expiresAt && expiresAt > now && expiresAt - now <= THREE_DAYS_MS) {\n      setShowSubscriptionsBell(true);\n      return;\n    }\n    // If the subscription is expired and fullAccess is false, prompt to buy\n    if (expiresAt && expiresAt <= now && !user?.fullAccess) {\n      setShowSubscriptionsBell(true);\n      return;\n    }\n    // For stripe subscriptions, a 'status' === 'active' means no bell, else show if status !== 'active'\n    if (sub?.source === \"stripe\" && sub?.status && sub.status !== \"active\") {\n      setShowSubscriptionsBell(true);\n      return;\n    }\n    setShowSubscriptionsBell(false);\n  }, [user?.subscription, user?.fullAccess]);\n\n  // Fetch site notifications & keep in sync\n  useEffect(() => {\n    let mounted = true;\n    if (!user?.email) {\n      setSiteNotifications([]);\n      return () => {\n        mounted = false;\n      };\n    }\n    const poll = async () => {\n      const data = await refreshNotifications();\n      if (!mounted) return;\n      setSiteNotifications(data || []);\n    };\n    poll();\n    const int = setInterval(poll, 30000);\n    return () => {\n      mounted = false;\n      clearInterval(int);\n    };\n  }, [refreshNotifications, user?.email]);\n\n  useEffect(() => {\n    // Only poll friend/message counts when the app/tab is focused to avoid\n    // background network requests (which can trigger noisy 404s when no API).\n    // Use a small failure counter and short backoff so a downed API doesn't\n    // get hammered.\n    if (!user?.email) return;\n    let mounted = true;\n\n    const runIfFocused = async () => {\n      try {\n        if (!mounted) return;\n        if (typeof document !== \"undefined\" && !document.hasFocus()) return;\n\n        const disabledUntil = friendPollDisabledUntilRef.current;\n        if (disabledUntil && Date.now() < disabledUntil) return;\n\n        const ok = await refreshFriendCounts();\n        if (ok) {\n          friendPollFailuresRef.current = 0;\n          friendPollDisabledUntilRef.current = null;\n        } else {\n          friendPollFailuresRef.current =\n            (friendPollFailuresRef.current || 0) + 1;\n          if (friendPollFailuresRef.current >= 3) {\n            // Back off for 5 minutes after 3 consecutive failures\n            friendPollDisabledUntilRef.current = Date.now() + 5 * 60 * 1000;\n            console.warn(\n              \"Friend/message polling disabled for 5 minutes due to repeated failures\",\n            );\n          }\n        }\n      } catch {}\n    };\n\n    // Run immediately if the tab is focused\n    runIfFocused();\n\n    const onFocus = () => {\n      try {\n        runIfFocused();\n      } catch {}\n    };\n\n    window.addEventListener(\"focus\", onFocus);\n\n    // Periodic poll but only execute when focused\n    const interval = setInterval(() => {\n      try {\n        runIfFocused();\n      } catch {}\n    }, 30000);\n\n    return () => {\n      mounted = false;\n      window.removeEventListener(\"focus\", onFocus);\n      clearInterval(interval);\n    };\n  }, [refreshFriendCounts, user?.email]);\n\n  useEffect(() => {\n    if (!user?.email) {\n      setFriendRequestCount(0);\n      setUnreadMessageCount(0);\n    }\n  }, [user?.email]);\n\n  // If subscription is expiring soon or expired, write a persistent notification server-side\n  useEffect(() => {\n    if (!user?.subscription || !user?.email) return;\n    const sub = user.subscription as any;\n    const now = Date.now();\n    let expiresAt: number | null = null;\n    if (sub?.expiresAt)\n      expiresAt =\n        typeof sub.expiresAt === \"string\"\n          ? Date.parse(sub.expiresAt)\n          : Number(sub.expiresAt);\n    const THREE_DAYS_MS = 3 * 24 * 60 * 60 * 1000;\n    async function addSubscriptionNotification(type: string, message: string) {\n      try {\n        const token = localStorage.getItem(\"authToken\");\n        const headers: any = { \"Content-Type\": \"application/json\" };\n        if (token) headers.Authorization = `Bearer ${token}`;\n        await fetch(\"/api/notifications\", {\n          method: \"POST\",\n          headers,\n          body: JSON.stringify({ email: user.email, message, type }),\n        });\n      } catch (e) {}\n    }\n    if (expiresAt && expiresAt > now && expiresAt - now <= THREE_DAYS_MS) {\n      addSubscriptionNotification(\n        \"sub_expiring\",\n        `Your premium subscription expires in ${Math.ceil((expiresAt - now) / (24 * 60 * 60 * 1000))} day(s)`,\n      );\n      return;\n    }\n    if (expiresAt && expiresAt <= now && !user?.fullAccess) {\n      addSubscriptionNotification(\n        \"sub_expired\",\n        \"Your premium subscription has ended\",\n      );\n      return;\n    }\n  }, [user?.email, user?.subscription, user?.fullAccess]);\n\n  useEffect(() => {\n    if (!notificationsOpen) return;\n    // Only handle Escape key - click outside is handled by the modal backdrop\n    const handleKey = (event: KeyboardEvent) => {\n      if (event.key === \"Escape\") setNotificationsOpen(false);\n    };\n    document.addEventListener(\"keydown\", handleKey);\n    return () => {\n      document.removeEventListener(\"keydown\", handleKey);\n    };\n  }, [notificationsOpen]);\n\n  // Allow other components (like Home pills) to open the notifications modal.\n  useEffect(() => {\n    const onOpen = () => setNotificationsOpen(true);\n    window.addEventListener(NDN_OPEN_NOTIFICATIONS_EVENT as any, onOpen as any);\n    return () =>\n      window.removeEventListener(\n        NDN_OPEN_NOTIFICATIONS_EVENT as any,\n        onOpen as any,\n      );\n  }, []);\n\n  if (!user) {\n    return (\n      <Auth\n        onAuth={(u: any) => {\n          try {\n            const cached = localStorage.getItem(`ndn:subscription:${u.email}`);\n            if (cached)\n              setUserWithMerge({ ...u, subscription: JSON.parse(cached) });\n            else setUserWithMerge(u);\n          } catch {\n            setUserWithMerge(u);\n          }\n          fetchSubscription(u);\n        }}\n      />\n    );\n  }\n  const fallbackAvatar = `https://ui-avatars.com/api/?name=${encodeURIComponent(\n    user.username || \"NDN\",\n  )}&background=8F43EE&color=fff&bold=true&rounded=true&size=64`;\n  const notificationText = (n: any) =>\n    `${n.type || \"\"} ${n.message || \"\"}`.trim();\n  const tournamentNotifs = siteNotifications.filter((n) =>\n    /(tournament|bracket)/i.test(notificationText(n)),\n  ).length;\n  const checkinNotifs = siteNotifications.filter((n) =>\n    /(check[-_\\s]?in)/i.test(notificationText(n)),\n  ).length;\n  const matchInviteNotifs = siteNotifications.filter((n) =>\n    /(match|invite)/i.test(notificationText(n)),\n  ).length;\n  const notificationPanelItems = [\n    {\n      key: \"tournaments\",\n      label: \"Tournament Closures\",\n      description: \"Bracket updates and notices.\",\n      count: tournamentNotifs,\n      icon: Trophy,\n    },\n    {\n      key: \"checkins\",\n      label: \"Check-ins\",\n      description: \"Venue reminders and start-of-round checks.\",\n      count: checkinNotifs,\n      icon: CalendarDays,\n    },\n    {\n      key: \"match-invites\",\n      label: \"Match Invites\",\n      description: \"Pending matches ready to accept.\",\n      count: matchInviteNotifs,\n      icon: Handshake,\n    },\n    {\n      key: \"friend-requests\",\n      label: \"Friend Requests\",\n      description: \"Accept or decline new connections.\",\n      count: friendRequestCount,\n      icon: Users,\n    },\n    {\n      key: \"messages\",\n      label: \"Messages\",\n      description: \"Unread chats and replies.\",\n      count: unreadMessageCount,\n      icon: MessageCircle,\n    },\n  ];\n  return (\n    <ThemeProvider>\n      <div\n        ref={appRef}\n        className={`${user?.fullAccess ? \"premium-body\" : \"\"} h-screen overflow-hidden pt-1 pb-0 px-1 xs:pt-2 xs:pb-0 xs:px-2 sm:pt-3 sm:pb-0 sm:px-3 md:pt-4 md:pb-0 md:px-4`}\n      >\n        <Toaster />\n        <div className=\"max-w-[1600px] mx-auto grid grid-cols-1 lg:grid-cols-[auto,1fr] gap-4 sm:gap-6 h-full overflow-hidden\">\n          {/* Desktop sidebar; hidden on mobile/tablet */}\n          {!isMobile && (\n            <div className=\"relative hidden lg:block w-72\">\n              <Sidebar\n                className=\"w-full h-full\"\n                active={tab}\n                onChange={(k) => {\n                  setTab(k);\n                }}\n                user={user}\n              />\n            </div>\n          )}\n          {/* Fixed hamburger menu button removed - integrated into header */}\n\n          {/* Wrap header + scroller in a column so header stays static and only content scrolls below it */}\n          <div className=\"flex flex-col h-full overflow-hidden\">\n            <div className=\"pt-1 xs:pt-2 relative z-50\">\n              <header\n                id=\"ndn-header\"\n                data-testid=\"ndn-header\"\n                className={`header glass flex items-center justify-between gap-2 sm:gap-4 transition-all duration-200 ${\n                  isCompact ? \"py-1 px-2\" : \"py-2 px-4\"\n                }`}\n                style={{ willChange: \"transform\" }}\n              >\n                {isMobile && (\n                  <button\n                    className=\"ndn-mobile-brand shrink-0 text-sm font-black px-3 py-2 rounded-xl bg-gradient-to-r from-indigo-600 to-violet-600 text-white shadow-lg shadow-indigo-500/20 hover:shadow-indigo-500/40 transition-all border border-white/10\"\n                    onClick={() => {\n                      setTab(\"score\");\n                      setNavOpen(false);\n                    }}\n                    aria-label=\"Go Home\"\n                    title=\"Go Home\"\n                  >\n                    NDN \n                  </button>\n                )}\n\n                {/* Left: Brand + Greeting - compact single-line with avg */}\n                <div className=\"flex items-center gap-3 min-w-0 shrink ndn-greeting\">\n                  {!isMobile && (\n                    <div className=\"relative shrink-0\">\n                      <img\n                        src={avatar || fallbackAvatar}\n                        alt=\"avatar\"\n                        className=\"w-7 h-7 sm:w-8 sm:h-8 rounded-full ring-1 ring-indigo-400/50 object-cover shadow-sm\"\n                      />\n                      <div className=\"absolute -bottom-0.5 -right-0.5 w-2 h-2 bg-emerald-500 border border-[#13111C] rounded-full\"></div>\n                    </div>\n                  )}\n                  <div className=\"min-w-0\">\n                    <div className=\"flex flex-col gap-1 min-w-0\">\n                      <div className=\"flex items-center gap-2\">\n                        {isMobile && (\n                          <div className=\"relative mr-0\">\n                            <img\n                              src={avatar || fallbackAvatar}\n                              alt=\"avatar\"\n                              className=\"w-8 h-8 rounded-full ring-1 ring-indigo-400/50 object-cover shadow-sm\"\n                            />\n                            <div className=\"absolute -bottom-0.5 -right-0.5 w-2 h-2 bg-emerald-500 border border-[#13111C] rounded-full\"></div>\n                          </div>\n                        )}\n                        <span className=\"truncate text-xs text-white/70 ndn-greeting-welcome\">\n                          Welcome,{\" \"}\n                          <span className=\"font-bold text-white\">\n                            {user.username}\n                          </span>\n                        </span>\n                      </div>\n                      <div className=\"flex items-center gap-2 shrink-0 text-[11px] sm:text-xs text-white/60 ndn-greeting-avg\">\n                        <span className=\"uppercase tracking-[0.3em] text-white/35 text-[9px]\">\n                          {avgMode === \"24h\"\n                            ? \"30-Day 3-Dart Avg\"\n                            : \"All-Time 3-Dart Avg\"}\n                        </span>\n                        <span className=\"text-sm sm:text-base font-black text-white tracking-tight\">\n                          {allTimeAvg.toFixed(1)}\n                        </span>\n                        {normalizedDelta !== 0 && (\n                          <span\n                            className={`flex items-center gap-1 text-[11px] sm:text-xs font-semibold ${\n                              normalizedDelta > 0\n                                ? \"text-emerald-300\"\n                                : \"text-rose-300\"\n                            }`}\n                          >\n                            {normalizedDelta > 0 ? (\n                              <ArrowUpRight className=\"w-3 h-3\" />\n                            ) : (\n                              <ArrowDownRight className=\"w-3 h-3\" />\n                            )}\n                            {normalizedDelta > 0 ? \"+\" : \"\"}\n                            {normalizedDelta.toFixed(1)}\n                          </span>\n                        )}\n                      </div>\n                    </div>\n                  </div>\n                </div>\n\n                {/* Center brand display */}\n                {/* Center brand display (hidden on mobile; we show compact brand above hamburger) */}\n                {!isMobile && (\n                  <div className=\"flex-1 flex justify-center px-2\">\n                    <h1 className=\"w-full sm:w-auto\">\n                      <button\n                        type=\"button\"\n                        className=\"w-full sm:w-auto flex items-center justify-center rounded-2xl border border-white/10 bg-black/40 px-4 py-2 text-base xs:text-xl sm:text-2xl font-black text-white tracking-tighter drop-shadow-lg whitespace-nowrap cursor-pointer select-none hover:bg-black/50 transition-colors\"\n                        onClick={() => {\n                          setTab(\"score\");\n                        }}\n                        title={\"Go Home\"}\n                      >\n                        <span className=\"xs:hidden\">NDN </span>\n                        <span className=\"hidden xs:inline\">\n                          NINE-DART-NATION \n                        </span>\n                      </button>\n                    </h1>\n                  </div>\n                )}\n\n                {/* Right: Status + Actions */}\n                <div className=\"flex items-center gap-1.5 sm:gap-3 shrink-0\">\n                  <WSConnectionDot className=\"mr-1\" />\n                  <div className=\"flex items-center gap-1 sm:gap-2 bg-black/20 p-1 rounded-full border border-white/5\">\n                    <button\n                      className=\"px-2 sm:px-3 py-1 text-[10px] font-bold uppercase tracking-wider rounded-full bg-white/5 hover:bg-white/10 text-white transition-all\"\n                      onClick={() => {\n                        const el = appRef.current;\n                        if (!el) return;\n                        if (!document.fullscreenElement)\n                          el.requestFullscreen().catch(() => {});\n                        else document.exitFullscreen().catch(() => {});\n                      }}\n                    >\n                      {isFullscreen ? \"Exit\" : \"Full\"}\n                    </button>\n                  </div>\n\n                  {!isCompact && (\n                    <div className=\"hidden sm:flex items-center ml-2 space-x-2\">\n                      <AddToHomeButton />\n                      <InstallPicker />\n                    </div>\n                  )}\n\n                  {/* Notifications bell removed from header  kept in main Notifications panel */}\n                </div>\n              </header>\n              {/* A fixed, visible slot that marks the hamburger's dedicated spot on mobile.\n                  It is rendered just under the header so it remains visible across pages\n                  and gives the hamburger a consistent \"box\" to sit in. */}\n              {isMobile && <div aria-hidden className=\"ndn-mobile-menu-slot\" />}\n            </div>\n            {/* Mobile drawer navigation */}\n            {isMobile && (\n              <MobileNav\n                open={navOpen}\n                onClose={() => setNavOpen(false)}\n                active={tab}\n                onChange={(k) => {\n                  setTab(k);\n                  setNavOpen(false);\n                }}\n                user={user}\n                avatar={avatar || fallbackAvatar}\n              />\n            )}\n            <main\n              id=\"ndn-main-scroll\"\n              className=\"space-y-4 flex-1 overflow-y-auto pr-1 flex flex-col\"\n              style={{\n                willChange: \"scroll-position\",\n                transform: \"translateZ(0)\", // GPU-accelerated scrolling\n                WebkitOverflowScrolling: \"touch\", // Smooth scrolling on iOS\n              }}\n            >\n              {tab === \"settings\" && (\n                <Suspense\n                  fallback={<div className=\"p-4\">Loading settings...</div>}\n                >\n                  <ScrollFade className=\"flex-1 min-h-0\">\n                    <SettingsPanel user={user} />\n                  </ScrollFade>\n                </Suspense>\n              )}\n              {tab === \"score\" && (\n                <Suspense fallback={<div className=\"p-4\">Loading home...</div>}>\n                  <ScrollFade className=\"flex-1 min-h-0\">\n                    <Home user={user} />\n                  </ScrollFade>\n                </Suspense>\n              )}\n              {tab === \"online\" && (\n                <Suspense\n                  fallback={<div className=\"p-4\">Loading online...</div>}\n                >\n                  <ScrollFade className=\"flex-1 min-h-0\">\n                    <OnlinePlay user={user} />\n                  </ScrollFade>\n                </Suspense>\n              )}\n              {tab === \"offline\" && (\n                <Suspense\n                  fallback={<div className=\"p-4\">Loading offline...</div>}\n                >\n                  <ScrollFade className=\"flex-1 min-h-0\">\n                    <OfflinePlay user={user} />\n                  </ScrollFade>\n                </Suspense>\n              )}\n              {/* Always keep Calibrator mounted to preserve phone camera stream, but hide when not active */}\n              <div className={tab === \"calibrate\" ? \"\" : \"hidden\"}>\n                <ScrollFade>\n                  <Calibrator />\n                </ScrollFade>\n              </div>\n              {tab === \"friends\" && (\n                <Suspense\n                  fallback={<div className=\"p-4\">Loading friends...</div>}\n                >\n                  <ScrollFade className=\"flex-1 min-h-0\">\n                    <Friends user={user} />\n                  </ScrollFade>\n                </Suspense>\n              )}\n              {tab === \"stats\" && (\n                <Suspense\n                  fallback={<div className=\"p-4\">Loading stats...</div>}\n                >\n                  <ScrollFade className=\"flex-1 min-h-0\">\n                    <StatsPanel user={user} />\n                  </ScrollFade>\n                </Suspense>\n              )}\n              {tab === \"tournaments\" && (\n                <Suspense\n                  fallback={<div className=\"p-4\">Loading tournaments...</div>}\n                >\n                  <ScrollFade className=\"flex-1 min-h-0\">\n                    <Tournaments user={user} />\n                  </ScrollFade>\n                </Suspense>\n              )}\n              {tab === \"admin\" && (\n                <Suspense\n                  fallback={<div className=\"p-4\">Loading admin...</div>}\n                >\n                  <ScrollFade className=\"flex-1 min-h-0\">\n                    <div className=\"flex-1 min-h-0 space-y-6\">\n                      <AdminDashboard user={user} />\n                      <OpsDashboard user={user} />\n                    </div>\n                  </ScrollFade>\n                </Suspense>\n              )}\n              {tab === \"fullaccess\" && (\n                <Suspense\n                  fallback={<div className=\"p-4\">Loading admin access...</div>}\n                >\n                  <ScrollFade className=\"flex-1 min-h-0\">\n                    <AdminAccess user={user} />\n                  </ScrollFade>\n                </Suspense>\n              )}\n            </main>\n            {isMobile && (\n              <MobileBottomNav\n                active={tab}\n                onChange={setTab}\n                onMore={() => setNavOpen(true)}\n              />\n            )}\n          </div>\n        </div>\n      </div>\n\n      {/* Floating Help Assistant - Always visible */}\n      <HelpAssistant />\n      {/* App footer with legal notice */}\n      <Footer />\n      {/* Debug banner removed - not shown to users in production builds */}\n      {/* Global camera logger: logs stream lifecycle and video/pc events across site */}\n      {!minimalUI && <GlobalCameraLogger />}\n      {/* Global camera watchdog: auto-recovers stalled video/stream */}\n      {!minimalUI && <GlobalCameraWatchdog />}\n      {/* User-facing recovery toast + one-click retry */}\n      {!minimalUI && <GlobalCameraRecoveryToasts />}\n      {/* Full Screen Notification Modal - Moved to root level for proper overlay */}\n      {notificationsOpen && (\n        <div\n          className=\"fixed inset-0 z-[9999] flex items-center justify-center bg-black/90 backdrop-blur-sm p-4\"\n          onClick={() => setNotificationsOpen(false)}\n        >\n          <div\n            role=\"dialog\"\n            aria-modal=\"true\"\n            className=\"relative w-full max-w-4xl max-h-[85vh] overflow-y-auto rounded-3xl border border-white/10 bg-[#13111C] p-6 md:p-8 shadow-2xl animate-in fade-in zoom-in-95 duration-200 overflow-hidden\"\n            onClick={(e) => e.stopPropagation()}\n          >\n            {/* Background pattern */}\n            <div className=\"absolute inset-0 bg-[url('https://grainy-gradients.vercel.app/noise.svg')] opacity-20 pointer-events-none mix-blend-overlay\"></div>\n            {/* Decorative glow */}\n            <div className=\"absolute -top-24 -right-24 w-64 h-64 bg-indigo-500/20 rounded-full blur-3xl pointer-events-none\"></div>\n            <div className=\"absolute -bottom-24 -left-24 w-64 h-64 bg-emerald-500/20 rounded-full blur-3xl pointer-events-none\"></div>\n\n            <button\n              className=\"absolute right-4 top-4 flex h-8 w-8 items-center justify-center rounded-full bg-white/5 hover:bg-white/10 text-white transition z-10\"\n              onClick={() => setNotificationsOpen(false)}\n              aria-label=\"Close notifications\"\n            >\n              \n            </button>\n\n            <div className=\"relative z-10 flex items-center gap-4 mb-8 border-b border-white/5 pb-6\">\n              <div className=\"p-4 rounded-2xl bg-gradient-to-br from-amber-500/20 to-orange-500/20 text-amber-400 shadow-lg shadow-amber-500/10 ring-1 ring-white/10\">\n                <Bell className=\"h-8 w-8\" />\n              </div>\n              <div>\n                <h2 className=\"text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r from-white via-white to-white/50 tracking-tight\">\n                  Notifications\n                </h2>\n                <p className=\"text-sm text-white/50 font-medium\">\n                  Stay updated with your latest activity\n                </p>\n              </div>\n            </div>\n\n            <div className=\"relative z-10\">\n              {/* Premium Warning */}\n              {showSubscriptionsBell && (\n                <div className=\"mb-8 rounded-2xl bg-gradient-to-r from-amber-500/10 to-orange-500/10 border border-amber-500/20 p-6 flex flex-col sm:flex-row items-start gap-5 shadow-lg shadow-amber-500/5\">\n                  <div className=\"p-3 rounded-xl bg-amber-500/20 text-amber-400 shrink-0 ring-1 ring-amber-500/30\">\n                    <Trophy className=\"h-6 w-6\" />\n                  </div>\n                  <div className=\"flex-1\">\n                    <h3 className=\"font-bold text-lg text-amber-200\">\n                      Premium Subscription Alert\n                    </h3>\n                    <p className=\"text-sm text-amber-100/70 mt-1 leading-relaxed\">\n                      Your premium subscription is expiring soon or has expired.\n                      Renew now to keep full access to all features!\n                    </p>\n                    <button\n                      onClick={() => {\n                        setNotificationsOpen(false);\n                        setTab(\"settings\");\n                      }}\n                      className=\"mt-4 px-6 py-2.5 rounded-xl bg-gradient-to-r from-amber-500 to-orange-600 text-white font-bold text-sm hover:shadow-lg hover:shadow-amber-500/25 hover:scale-105 transition-all duration-200\"\n                    >\n                      Manage Subscription\n                    </button>\n                  </div>\n                </div>\n              )}\n\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4 mb-10\">\n                {notificationPanelItems.map((item) => {\n                  const Icon = item.icon;\n                  return (\n                    <div\n                      key={item.key}\n                      className=\"group flex items-center gap-4 p-4 rounded-2xl bg-white/5 border border-white/5 hover:bg-white/10 hover:border-white/10 transition-all duration-200 cursor-pointer hover:shadow-xl hover:shadow-black/20 hover:-translate-y-0.5\"\n                      onClick={() => {\n                        setNotificationsOpen(false);\n                        if (\n                          item.key === \"friend-requests\" ||\n                          item.key === \"messages\"\n                        )\n                          setTab(\"friends\");\n                        if (item.key === \"tournaments\") setTab(\"tournaments\");\n                        // Add other navigations as needed\n                      }}\n                    >\n                      <div className=\"p-3 rounded-xl bg-indigo-500/10 text-indigo-400 group-hover:bg-indigo-500/20 group-hover:text-indigo-300 group-hover:scale-110 transition-all duration-300 ring-1 ring-white/5\">\n                        <Icon className=\"h-6 w-6\" />\n                      </div>\n                      <div className=\"flex-1\">\n                        <h3 className=\"font-bold text-white group-hover:text-indigo-200 transition-colors\">\n                          {item.label}\n                        </h3>\n                        <p className=\"text-xs text-white/50 group-hover:text-white/70 transition-colors\">\n                          {item.description}\n                        </p>\n                      </div>\n                      {item.count > 0 && (\n                        <span className=\"px-3 py-1 rounded-full bg-rose-500 text-white font-bold text-xs shadow-lg shadow-rose-500/30 animate-pulse\">\n                          {item.count}\n                        </span>\n                      )}\n                    </div>\n                  );\n                })}\n              </div>\n\n              <div className=\"flex items-center justify-between mb-6\">\n                <h3 className=\"text-xs font-bold text-white/40 uppercase tracking-[0.2em]\">\n                  Recent Activity\n                </h3>\n                {siteNotifications.length > 0 && (\n                  <span className=\"text-xs font-medium text-white/30 bg-white/5 px-2 py-1 rounded-md\">\n                    {siteNotifications.length} total\n                  </span>\n                )}\n              </div>\n\n              <div className=\"space-y-3\">\n                {siteNotifications.length === 0 ? (\n                  <div className=\"text-center py-16 rounded-3xl border border-dashed border-white/10 bg-white/[0.02]\">\n                    <div className=\"w-16 h-16 mx-auto mb-4 rounded-full bg-white/5 flex items-center justify-center text-white/20\">\n                      <Bell className=\"h-8 w-8\" />\n                    </div>\n                    <p className=\"text-white/40 font-medium\">\n                      No recent notifications\n                    </p>\n                    <p className=\"text-xs text-white/20 mt-1\">\n                      You're all caught up!\n                    </p>\n                  </div>\n                ) : (\n                  siteNotifications.map((n) => (\n                    <div\n                      key={n.id}\n                      className={`relative overflow-hidden rounded-2xl border p-5 transition-all duration-200 group ${n.read ? \"bg-white/[0.02] border-white/5 hover:bg-white/5\" : \"bg-white/10 border-white/10 hover:bg-white/15 shadow-lg shadow-black/20\"}`}\n                    >\n                      {!n.read && (\n                        <div className=\"absolute left-0 top-0 bottom-0 w-1 bg-gradient-to-b from-rose-500 to-orange-500\"></div>\n                      )}\n                      <div className=\"flex flex-col sm:flex-row sm:items-center justify-between gap-2 mb-3\">\n                        <div className=\"flex items-center gap-3\">\n                          <span\n                            className={`text-[0.65rem] font-bold uppercase tracking-wider px-2 py-1 rounded-md ring-1 ring-inset ${n.read ? \"bg-white/5 text-white/40 ring-white/5\" : \"bg-rose-500/10 text-rose-300 ring-rose-500/20\"}`}\n                          >\n                            {n.type || \"General\"}\n                          </span>\n                          <span className=\"text-xs text-white/30 font-medium\">\n                            {new Date(n.createdAt).toLocaleDateString(\n                              undefined,\n                              {\n                                month: \"short\",\n                                day: \"numeric\",\n                                hour: \"2-digit\",\n                                minute: \"2-digit\",\n                              },\n                            )}\n                          </span>\n                        </div>\n                        {!n.read && (\n                          <span className=\"self-start sm:self-auto rounded-full bg-rose-500 px-2 py-0.5 text-[0.6rem] font-bold uppercase tracking-widest text-white shadow-sm shadow-rose-500/20\">\n                            New\n                          </span>\n                        )}\n                      </div>\n\n                      <p className=\"text-sm font-medium text-white/90 leading-relaxed pl-1\">\n                        {n.message}\n                      </p>\n\n                      {n.link && (\n                        <a\n                          href={n.link}\n                          target=\"_blank\"\n                          rel=\"noreferrer\"\n                          className=\"mt-4 inline-flex items-center gap-1.5 text-xs font-bold text-emerald-400 hover:text-emerald-300 transition-colors bg-emerald-500/10 px-3 py-1.5 rounded-lg hover:bg-emerald-500/20\"\n                        >\n                          Open Link \n                        </a>\n                      )}\n\n                      <div className=\"mt-4 flex items-center gap-3 border-t border-white/5 pt-3 opacity-0 group-hover:opacity-100 transition-opacity duration-200\">\n                        {!n.read && (\n                          <button\n                            onClick={async (e) => {\n                              e.stopPropagation();\n                              try {\n                                const token = localStorage.getItem(\"authToken\");\n                                await fetch(\n                                  `/api/notifications/${encodeURIComponent(n.id)}?email=${encodeURIComponent(user.email)}`,\n                                  {\n                                    method: \"PATCH\",\n                                    headers: {\n                                      \"Content-Type\": \"application/json\",\n                                      Authorization: `Bearer ${token}`,\n                                    },\n                                    body: JSON.stringify({ read: true }),\n                                  },\n                                );\n                                const updated = await refreshNotifications();\n                                if (updated) setSiteNotifications(updated);\n                              } catch (err) {}\n                            }}\n                            className=\"text-xs font-bold text-white/50 hover:text-white transition-colors uppercase tracking-wider\"\n                          >\n                            Mark as read\n                          </button>\n                        )}\n                        <button\n                          onClick={async (e) => {\n                            e.stopPropagation();\n                            if (!confirm(\"Delete this notification?\")) return;\n                            try {\n                              const token = localStorage.getItem(\"authToken\");\n                              await fetch(\n                                `/api/notifications/${encodeURIComponent(n.id)}?email=${encodeURIComponent(user.email)}`,\n                                {\n                                  method: \"DELETE\",\n                                  headers: { Authorization: `Bearer ${token}` },\n                                },\n                              );\n                              const updated = await refreshNotifications();\n                              if (updated) setSiteNotifications(updated);\n                            } catch (err) {}\n                          }}\n                          className=\"text-xs font-bold text-rose-400/50 hover:text-rose-400 transition-colors ml-auto uppercase tracking-wider\"\n                        >\n                          Delete\n                        </button>\n                      </div>\n                    </div>\n                  ))\n                )}\n              </div>\n            </div>\n          </div>\n        </div>\n      )}\n      {/* Global phone camera overlay - visibility controlled by store */}\n      {/* Keep a hidden global video element alive across navigation */}\n      {!minimalUI && <GlobalPhoneVideoSink />}\n      {/* Camera warm-up: keep an offscreen CameraView mounted when camera is enabled so\n          entering game modes (offline/online/tournaments) shows the feed instantly. */}\n      {/* Keep the camera active while the user is on the site so it stays warm and ready.\n          Rendering the offscreen CameraView when a user is present will request camera\n          access on first visit (browser permission prompt). If the user denies permission\n          the camera will remain inactive. */}\n      {user && (\n        // Keep the warmup CameraView mounted and rendered by the browser\n        // compositor while remaining invisible to the user. Avoid using\n        // `display:none` or moving the element far offscreen (left:-9999)\n        // because some browsers will stop painting video frames for such\n        // elements. Using a visible layout rectangle with a tiny opacity\n        // and transform keeps frames flowing while remaining non-interactive.\n        <div\n          aria-hidden\n          style={{\n            position: \"fixed\",\n            right: 0,\n            bottom: 0,\n            width: \"4px\",\n            height: \"4px\",\n            overflow: \"hidden\",\n            pointerEvents: \"none\",\n            opacity: 0.001,\n            // Keep behind other UI but still rendered\n            zIndex: -100,\n            transform: \"translateZ(0)\",\n          }}\n        >\n          <Suspense fallback={null}>\n            <CameraView\n              showToolbar={false}\n              hideInlinePanels\n              scoringMode=\"custom\"\n              immediateAutoCommit={false}\n              disableDetection={true}\n            />\n          </Suspense>\n        </div>\n      )}\n    </ThemeProvider>\n  );\n}\n\nfunction MobileBottomNav({\n  active,\n  onChange,\n  onMore,\n}: {\n  active: TabKey;\n  onChange: (k: TabKey) => void;\n  onMore: () => void;\n}) {\n  const navItems = [\n    { key: \"score\", label: \"Play\", icon: Gamepad2 },\n    { key: \"online\", label: \"Online\", icon: Globe },\n    { key: \"tournaments\", label: \"Compete\", icon: Trophy },\n    { key: \"stats\", label: \"Stats\", icon: BarChart2 },\n  ];\n\n  return (\n    <div className=\"fixed bottom-6 left-1/2 -translate-x-1/2 z-[100] w-full max-w-[360px] px-4 pointer-events-none\">\n      <div className=\"flex items-center justify-between bg-zinc-900/90 backdrop-blur-xl border border-white/10 rounded-2xl p-2 shadow-2xl shadow-black/50 ring-1 ring-white/5 pointer-events-auto\">\n        {navItems.map((item) => {\n          const isActive = active === item.key;\n          const Icon = item.icon;\n          return (\n            <button\n              key={item.key}\n              onClick={() => onChange(item.key as TabKey)}\n              className={`relative flex flex-col items-center justify-center gap-1 w-16 h-14 rounded-xl transition-all duration-300 active:scale-90 ${\n                isActive\n                  ? \"text-white bg-indigo-600 shadow-lg shadow-indigo-500/30\"\n                  : \"text-zinc-500 hover:text-zinc-300 hover:bg-white/5\"\n              }`}\n            >\n              <Icon\n                className={`w-5 h-5 transition-transform duration-300 ${\n                  isActive ? \"-translate-y-0.5 scale-110\" : \"\"\n                }`}\n                strokeWidth={isActive ? 2.5 : 2}\n              />\n              <span\n                className={`text-[9px] font-bold tracking-wide transition-opacity duration-300 ${\n                  isActive ? \"opacity-100\" : \"opacity-70\"\n                }`}\n              >\n                {item.label}\n              </span>\n              {isActive && (\n                <span className=\"absolute -bottom-1 w-1 h-1 bg-indigo-300 rounded-full opacity-50 blur-[1px]\" />\n              )}\n            </button>\n          );\n        })}\n        <div className=\"w-px h-8 bg-white/10 mx-1\" />\n        <button\n          onClick={onMore}\n          className={`flex flex-col items-center justify-center gap-1 w-16 h-14 rounded-xl text-zinc-500 hover:text-white hover:bg-white/5 transition-all duration-200 active:scale-95`}\n        >\n          <Menu className=\"w-6 h-6\" />\n          <span className=\"text-[9px] font-bold tracking-wide opacity-70\">\n            More\n          </span>\n        </button>\n      </div>\n    </div>\n  );\n}\n\n// Modern grid-based mobile menu\nfunction MobileNav({\n  open,\n  onClose,\n  active,\n  onChange,\n  user,\n  avatar,\n}: {\n  open: boolean;\n  onClose: () => void;\n  active: TabKey;\n  onChange: (k: TabKey) => void;\n  user: any;\n  avatar?: string;\n}) {\n  const isAdmin = useIsAdmin(user?.email);\n  const tabs = buildTabList(user, isAdmin);\n  const [showDiscord, setShowDiscord] = React.useState(false);\n  const [showNDNDiscord, setShowNDNDiscord] = React.useState(false);\n\n  const fallback = `https://ui-avatars.com/api/?name=${encodeURIComponent(\n    user?.username || \"NDN\",\n  )}&background=8F43EE&color=fff&bold=true&rounded=true&size=64`;\n  const displayAvatar = avatar || fallback;\n  const isPremium = !!user?.fullAccess;\n\n  if (!open) return null;\n\n  return (\n    <div className=\"fixed inset-0 z-[150] bg-[#0f0e13]/95 backdrop-blur-xl animate-in fade-in zoom-in-95 duration-200 flex flex-col\">\n      {/* Header */}\n      <div className=\"flex items-center justify-between p-6 border-b border-white/5 bg-white/[0.02]\">\n        <div className=\"flex items-center gap-4\">\n          <div className=\"relative\">\n            <img\n              src={displayAvatar}\n              className={`w-12 h-12 rounded-full object-cover ring-2 ${\n                isPremium\n                  ? \"ring-indigo-500 shadow-lg shadow-indigo-500/30\"\n                  : \"ring-white/10\"\n              }`}\n              alt={user.username}\n            />\n            {isPremium && (\n              <div className=\"absolute -bottom-1 -right-1 bg-indigo-500 text-white rounded-full p-1 border border-[#0f0e13]\">\n                <Trophy className=\"w-3 h-3\" />\n              </div>\n            )}\n          </div>\n          <div className=\"flex flex-col\">\n            <span className=\"font-bold text-white text-xl tracking-tight\">\n              {user.username}\n            </span>\n            <span\n              className={`text-xs font-medium uppercase tracking-wider ${isPremium ? \"text-indigo-400\" : \"text-white/40\"}`}\n            >\n              {isPremium ? \"Premium Member\" : \"Free Account\"}\n            </span>\n          </div>\n        </div>\n        <button\n          onClick={onClose}\n          className=\"p-3 rounded-full bg-white/5 text-white/70 hover:bg-white/10 hover:text-white transition-all active:scale-95 border border-white/5 shadow-lg\"\n        >\n          <X className=\"w-6 h-6\" />\n        </button>\n      </div>\n\n      {/* Content */}\n      <div\n        className=\"flex-1 overflow-y-auto p-6\"\n        style={{ WebkitOverflowScrolling: \"touch\" }}\n      >\n        <h3 className=\"text-[10px] font-black text-white/30 uppercase tracking-[0.2em] mb-4\">\n          Menu\n        </h3>\n        <div className=\"grid grid-cols-2 gap-3 mb-8\">\n          {tabs.map((tab) => {\n            const Icon = tab.icon;\n            const isActive = active === tab.key;\n            return (\n              <button\n                key={tab.key}\n                onClick={() => {\n                  onChange(tab.key as TabKey);\n                  onClose();\n                }}\n                className={`group flex flex-col items-start gap-3 p-4 rounded-2xl border transition-all duration-200 active:scale-95 ${\n                  isActive\n                    ? \"bg-indigo-600 border-indigo-500 text-white shadow-xl shadow-indigo-900/30\"\n                    : \"bg-white/5 border-white/5 text-slate-400 hover:bg-white/10 hover:text-white hover:border-white/10\"\n                }`}\n              >\n                <div\n                  className={`p-2 rounded-xl ${isActive ? \"bg-white/20\" : \"bg-black/20 group-hover:bg-white/10\"}`}\n                >\n                  <Icon className=\"w-6 h-6\" />\n                </div>\n                <span className=\"font-bold text-sm\">{tab.label}</span>\n              </button>\n            );\n          })}\n        </div>\n\n        <h3 className=\"text-[10px] font-black text-white/30 uppercase tracking-[0.2em] mb-4\">\n          Community\n        </h3>\n        <div className=\"space-y-3 pb-24\">\n          <button\n            onClick={() => setShowDiscord(true)}\n            className=\"w-full flex items-center gap-4 p-4 rounded-2xl bg-[#5865F2]/10 border border-[#5865F2]/20 text-[#5865F2] hover:bg-[#5865F2]/20 transition-all active:scale-98\"\n          >\n            <MessageCircle className=\"w-6 h-6\" />\n            <div className=\"flex flex-col items-start\">\n              <span className=\"font-bold\">Bullseye League</span>\n              <span className=\"text-xs opacity-70\">Join the competition</span>\n            </div>\n          </button>\n\n          <button\n            onClick={() => setShowNDNDiscord(true)}\n            className=\"w-full flex items-center gap-4 p-4 rounded-2xl bg-[#5865F2]/10 border border-[#5865F2]/20 text-[#5865F2] hover:bg-[#5865F2]/20 transition-all active:scale-98\"\n          >\n            <MessageCircle className=\"w-6 h-6\" />\n            <div className=\"flex flex-col items-start\">\n              <span className=\"font-bold\">NDN Community</span>\n              <span className=\"text-xs opacity-70\">Get help & support</span>\n            </div>\n          </button>\n        </div>\n      </div>\n\n      {/* Discord Dialogs */}\n      {showDiscord && (\n        <div className=\"fixed inset-0 z-[2000] flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm animate-in fade-in duration-200\">\n          <div className=\"bg-[#1a1825] border border-white/10 rounded-3xl p-6 max-w-sm w-full shadow-2xl\">\n            <h2 className=\"text-xl font-bold text-white mb-2\">\n              Join Bullseye League\n            </h2>\n            <p className=\"text-slate-400 text-sm mb-6\">\n              Connect with enthusiasts and compete in tourneys!\n            </p>\n            <div className=\"grid grid-cols-2 gap-3\">\n              <button\n                onClick={() => setShowDiscord(false)}\n                className=\"px-4 py-3 rounded-xl bg-white/5 hover:bg-white/10 text-white text-sm font-bold\"\n              >\n                Cancel\n              </button>\n              <a\n                href={DISCORD_INVITE_URL}\n                target=\"_blank\"\n                rel=\"noopener noreferrer\"\n                className=\"px-4 py-3 rounded-xl bg-[#5865F2] hover:bg-[#4752C4] text-white text-sm font-bold text-center\"\n              >\n                Join\n              </a>\n            </div>\n          </div>\n        </div>\n      )}\n\n      {showNDNDiscord && (\n        <div className=\"fixed inset-0 z-[2000] flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm animate-in fade-in duration-200\">\n          <div className=\"bg-[#1a1825] border border-white/10 rounded-3xl p-6 max-w-sm w-full shadow-2xl\">\n            <h2 className=\"text-xl font-bold text-white mb-2\">NDN Community</h2>\n            <p className=\"text-slate-400 text-sm mb-6\">\n              Official Nine Dart Nation community.\n            </p>\n            <div className=\"grid grid-cols-2 gap-3\">\n              <button\n                onClick={() => setShowNDNDiscord(false)}\n                className=\"px-4 py-3 rounded-xl bg-white/5 hover:bg-white/10 text-white text-sm font-bold\"\n              >\n                Cancel\n              </button>\n              <a\n                href=\"https://discord.gg/ninedartnation\"\n                target=\"_blank\"\n                rel=\"noopener noreferrer\"\n                className=\"px-4 py-3 rounded-xl bg-[#5865F2] hover:bg-[#4752C4] text-white text-sm font-bold text-center\"\n              >\n                Join\n              </a>\n            </div>\n          </div>\n        </div>\n      )}\n    </div>\n  );\n}\n","import { useEffect, useState } from \"react\";\n\nfunction validatePassword(password: string) {\n  return (\n    password.length >= 10 &&\n    /\\d/.test(password) &&\n    /[^A-Za-z0-9]/.test(password)\n  );\n}\n\nexport default function ResetPassword() {\n  const [token, setToken] = useState(\"\");\n  const [password, setPassword] = useState(\"\");\n  const [confirm, setConfirm] = useState(\"\");\n  const [error, setError] = useState(\"\");\n  const [success, setSuccess] = useState(\"\");\n\n  useEffect(() => {\n    try {\n      const sp = new URLSearchParams(window.location.search);\n      const t = sp.get(\"token\") || \"\";\n      setToken(t);\n    } catch {}\n  }, []);\n\n  async function onSubmit(e: any) {\n    e.preventDefault();\n    setError(\"\");\n    setSuccess(\"\");\n    if (!token) {\n      setError(\"Missing or invalid reset token.\");\n      return;\n    }\n    if (!password || password !== confirm) {\n      setError(\"Passwords do not match.\");\n      return;\n    }\n    if (!validatePassword(password)) {\n      setError(\n        \"Password must be at least 10 chars and include a number and symbol.\",\n      );\n      return;\n    }\n    try {\n      const r = await fetch(\"/api/auth/confirm-reset\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ token, newPassword: password }),\n      });\n      const j = await r.json();\n      if (!j?.ok) throw new Error(j?.error || \"Reset failed\");\n      setSuccess(\"Password changed. You can now sign in.\");\n    } catch (e: any) {\n      setError(e?.message || \"Reset failed\");\n    }\n  }\n\n  return (\n    <div className=\"min-h-screen flex items-center justify-center relative overflow-hidden\">\n      <div className=\"background-animated\" />\n      <div className=\"relative z-10 w-full max-w-lg mx-auto p-4\">\n        <form className=\"card w-full space-y-4\" onSubmit={onSubmit}>\n          <div className=\"flex flex-col items-center justify-center gap-2 mb-2 text-center\">\n            <h1 className=\"logo text-center\">Reset your password</h1>\n          </div>\n          {!token && (\n            <div className=\"text-red-400\">\n              This reset link is missing a token. Please use the link from your\n              email.\n            </div>\n          )}\n          <input\n            className=\"input w-full\"\n            type=\"password\"\n            placeholder=\"New password\"\n            value={password}\n            onChange={(e) => setPassword(e.target.value)}\n            required\n          />\n          <input\n            className=\"input w-full\"\n            type=\"password\"\n            placeholder=\"Confirm password\"\n            value={confirm}\n            onChange={(e) => setConfirm(e.target.value)}\n            required\n          />\n          {error && (\n            <div className=\"text-red-400 font-semibold text-sm\">{error}</div>\n          )}\n          {success && (\n            <div className=\"text-emerald-400 font-semibold text-sm\">\n              {success}\n            </div>\n          )}\n          <button className=\"btn w-full\" type=\"submit\" disabled={!token}>\n            Change Password\n          </button>\n          <a className=\"underline text-sm text-center\" href=\"/\">\n            Back to sign in\n          </a>\n        </form>\n      </div>\n    </div>\n  );\n}\n","import { Component, type ReactNode } from \"react\";\n\nexport default class ErrorBoundary extends Component<\n  {\n    children: ReactNode;\n  },\n  { hasError: boolean; message?: string }\n> {\n  constructor(props: any) {\n    super(props);\n    this.state = { hasError: false };\n  }\n  static getDerivedStateFromError(err: any) {\n    return { hasError: true, message: String(err?.message || err) };\n  }\n  componentDidCatch(error: any, info: any) {\n    console.error(\"[ErrorBoundary]\", error, info);\n  }\n  render() {\n    if (this.state.hasError) {\n      return (\n        <div className=\"min-h-screen flex items-center justify-center p-6\">\n          <div className=\"card max-w-lg w-full text-center\">\n            <h2 className=\"text-2xl font-bold mb-2\">Something went wrong</h2>\n            <p className=\"opacity-80 mb-4\">\n              Please refresh the page. If this persists, let us know.\n            </p>\n            {this.state.message && (\n              <pre className=\"text-xs bg-black/40 rounded p-2 overflow-auto text-left\">\n                {this.state.message}\n              </pre>\n            )}\n            <button\n              className=\"btn mt-4\"\n              onClick={() => window.location.reload()}\n            >\n              Reload\n            </button>\n          </div>\n        </div>\n      );\n    }\n    return this.props.children as any;\n  }\n}\n","declare global {\n  interface Window {\n    deferredInstallPrompt: any;\n    promptInstallApp?: () => Promise<boolean>;\n  }\n}\n\nexport function setupInstallPromptHooks() {\n  if (typeof window === \"undefined\") return;\n  try {\n    window.deferredInstallPrompt = null;\n    window.addEventListener(\"beforeinstallprompt\", (event) => {\n      const shouldDefer = Boolean(\n        (window as any).__NDN_DEFER_INSTALL_PROMPT__ ||\n          localStorage.getItem(\"NDN_DEFER_INSTALL_PROMPT\") === \"1\",\n      );\n      if (!shouldDefer) return;\n      event.preventDefault();\n      window.deferredInstallPrompt = event;\n    });\n    window.promptInstallApp = async () => {\n      try {\n        const promptEvent = window.deferredInstallPrompt;\n        if (!promptEvent) return false;\n        promptEvent.prompt();\n        const choice = await promptEvent.userChoice;\n        return !!choice && choice.outcome === \"accepted\";\n      } catch {\n        return false;\n      }\n    };\n  } catch (err) {\n    // Silently log when running in development but avoid crashing production builds\n    if ((import.meta as any)?.env?.DEV) {\n      console.warn(\"[PWA] Failed to install installPrompt hooks\", err);\n    }\n  }\n}\n\nexport {}; // ensure this file is treated as a module\n","import { isDev } from \"./logger\";\n\n/**\n * Suppresses known-noisy console output that can flood the console in dev and\n * look like \"the feed is broken\" even though camera rendering is unaffected.\n *\n * NOTE: This does NOT hide real exceptions; it only filters specific, repeated\n * browser/network/WS messages that are expected in some environments.\n */\nexport function installQuietConsole() {\n  // Keep production transparent unless explicitly enabled.\n  const enabled =\n    isDev ||\n    String((import.meta as any).env?.VITE_QUIET_CONSOLE || \"\").trim() === \"1\";\n  if (!enabled) return;\n\n  // Avoid double-installation.\n  const w = window as any;\n  if (w.__ndnQuietConsoleInstalled) return;\n  w.__ndnQuietConsoleInstalled = true;\n\n  const originals = {\n    error: console.error.bind(console),\n    warn: console.warn.bind(console),\n    log: console.log.bind(console),\n  };\n\n  const shouldSuppress = (args: any[]) => {\n    const msg = args\n      .map((a) => (typeof a === \"string\" ? a : a?.message || \"\"))\n      .join(\" \");\n\n    // These are common and non-fatal:\n    // - WebSocket reconnect failures when offline\n    // - browser network transitions\n    // - jsdom/test media play not implemented\n    if (/Not implemented: HTMLMediaElement's play\\(\\) method/i.test(msg))\n      return true;\n    if (/WebSocket connection to .* failed/i.test(msg)) return true;\n    if (/ERR_NETWORK_IO_SUSPENDED|ERR_NETWORK_CHANGED/i.test(msg)) return true;\n\n    // Do NOT suppress application errors.\n    return false;\n  };\n\n  // Rate-limit repeated messages (by first string chunk)\n  const lastPrintedAt = new Map<string, number>();\n  const RATE_MS = 2000;\n\n  const wrap =\n    (fn: (...a: any[]) => void) =>\n    (...args: any[]) => {\n      if (shouldSuppress(args)) return;\n      const key = String(args[0] ?? \"\");\n      const now = Date.now();\n      const last = lastPrintedAt.get(key) || 0;\n      if (now - last < RATE_MS) return;\n      lastPrintedAt.set(key, now);\n      fn(...args);\n    };\n\n  console.error = wrap(originals.error) as any;\n  console.warn = wrap(originals.warn) as any;\n  // leave console.log alone unless it becomes a problem\n\n  // Also prevent \"Unhandled promise rejection\" style errors from being silent\n  // killerslog once, but don't spam.\n  window.addEventListener(\"unhandledrejection\", (ev) => {\n    const msg =\n      (ev.reason && (ev.reason.message || String(ev.reason))) ||\n      \"unhandledrejection\";\n    const now = Date.now();\n    const last = lastPrintedAt.get(msg) || 0;\n    if (now - last < RATE_MS) return;\n    lastPrintedAt.set(msg, now);\n    originals.warn(\"[ndn] Unhandled promise rejection:\", ev.reason);\n  });\n}\n","import { StrictMode } from \"react\";\nimport ReactDOM from \"react-dom/client\";\nimport \"./index.css\";\n// Mobile-only overrides loaded after the main stylesheet to strongly\n// restyle the app on small screens without touching desktop styles.\nimport \"./styles/mobile-overrides.css\";\nimport App from \"./App\";\nimport ResetPassword from \"./components/ResetPassword\";\nimport { WSProvider } from \"./components/WSProvider\";\nimport ErrorBoundary from \"./components/ErrorBoundary\";\nimport { installApiInterceptor } from \"./utils/api\";\nimport { setupInstallPromptHooks } from \"./utils/installPrompt\";\nimport { installQuietConsole } from \"./utils/quietConsole\";\n\n// In some hosting setups, third-party or legacy code may expect a global React.\n// This ensures `React` is available at runtime to prevent 'React is not defined' errors.\ntry {\n  (window as any).React = (window as any).React || {};\n} catch (e) {}\n\ninstallApiInterceptor();\nsetupInstallPromptHooks();\ninstallQuietConsole();\n\n// Temporary global error collector (diagnostic only).\n// Purpose: capture initialization/runtime errors (like the reported \"Cannot access 'Ns' before initialization\")\n// and make it easy for a developer or QA to copy the full stack to clipboard.\n// Remove this block once diagnostics are complete.\ntry {\n  let __ndn_last_error: any = null;\n\n  const __ndn_capture_and_clip = (errInfo: any) => {\n    try {\n      __ndn_last_error = errInfo;\n      // Log clearly so it's easy to find in console output\n      console.error(\"[NDN ErrorCollector] Captured error:\", errInfo);\n      // Try to copy to clipboard for fast paste into issues. Not guaranteed\n      // to succeed (clipboard permissions), but we attempt it.\n      if (typeof navigator !== \"undefined\" && navigator.clipboard?.writeText) {\n        try {\n          const text =\n            typeof errInfo === \"string\"\n              ? errInfo\n              : JSON.stringify(errInfo, null, 2);\n          navigator.clipboard.writeText(text).then(\n            () =>\n              console.info(\"[NDN ErrorCollector] Error copied to clipboard\"),\n            () =>\n              console.info(\"[NDN ErrorCollector] Could not copy to clipboard\"),\n          );\n        } catch {\n          // ignore clipboard errors\n        }\n      }\n    } catch (e) {\n      try {\n        console.error(\"[NDN ErrorCollector] capture failed\", e);\n      } catch {}\n    }\n  };\n\n  window.addEventListener(\n    \"error\",\n    (ev: any) => {\n      try {\n        const info = {\n          message: ev?.message || (ev?.error && ev.error.message) || String(ev),\n          filename: ev?.filename || null,\n          lineno: ev?.lineno || null,\n          colno: ev?.colno || null,\n          stack: ev?.error?.stack || (ev?.error && String(ev.error)) || null,\n          type: \"error\",\n        };\n        __ndn_capture_and_clip(info);\n      } catch (e) {\n        try {\n          console.error(\"[NDN ErrorCollector] error handler failed\", e);\n        } catch {}\n      }\n    },\n    true,\n  );\n\n  window.addEventListener(\"unhandledrejection\", (ev: any) => {\n    try {\n      const reason = ev?.reason;\n      const info = {\n        message: reason?.message || String(reason) || \"UnhandledRejection\",\n        stack: reason?.stack || null,\n        type: \"unhandledrejection\",\n      };\n      __ndn_capture_and_clip(info);\n    } catch (e) {\n      try {\n        console.error(\n          \"[NDN ErrorCollector] unhandledrejection handler failed\",\n          e,\n        );\n      } catch {}\n    }\n  });\n\n  // Expose a helper to collect the last error programmatically from the console\n  (window as any).__ndn_error_collector = {\n    collect: async () => {\n      try {\n        if (!__ndn_last_error) return null;\n        // Try to copy the last error again on demand\n        if (\n          typeof navigator !== \"undefined\" &&\n          navigator.clipboard?.writeText\n        ) {\n          try {\n            await navigator.clipboard.writeText(\n              JSON.stringify(__ndn_last_error, null, 2),\n            );\n            console.info(\"[NDN ErrorCollector] Last error copied to clipboard\");\n          } catch {\n            console.info(\n              \"[NDN ErrorCollector] Could not copy last error to clipboard\",\n            );\n          }\n        }\n        return __ndn_last_error;\n      } catch (e) {\n        try {\n          console.error(\"[NDN ErrorCollector] collect failed\", e);\n        } catch {}\n        return null;\n      }\n    },\n    last: () => __ndn_last_error,\n  };\n} catch (e) {\n  // best-effort; do not break app startup if this diagnostic install fails\n  try {\n    console.warn(\"[NDN ErrorCollector] install failed\", e);\n  } catch {}\n}\n\nReactDOM.createRoot(document.getElementById(\"root\")!).render(\n  <StrictMode>\n    <ErrorBoundary>\n      <WSProvider>\n        <Root />\n      </WSProvider>\n    </ErrorBoundary>\n  </StrictMode>,\n);\n\nfunction Root() {\n  const path = window.location.pathname;\n  if (path === \"/reset\") return <ResetPassword />;\n  return <App />;\n}\n\n/**\n * Service worker note\n *\n * A service worker can easily cause \"Netlify isn't responding / new code not showing\" symptoms\n * if an old worker is still controlling the page and serving cached HTML/JS.\n *\n * For now we keep SW *opt-in only* (debug/pwa testing) and disable it by default.\n *\n * Opt-in options:\n *  - add ?pwa=1 to the URL, or\n *  - set localStorage.NDN_ENABLE_PWA = \"1\"\n */\nconst enablePwaSw =\n  new URLSearchParams(window.location.search).get(\"pwa\") === \"1\" ||\n  (typeof localStorage !== \"undefined\" &&\n    localStorage.getItem(\"NDN_ENABLE_PWA\") === \"1\");\n\nif (\n  enablePwaSw &&\n  typeof navigator !== \"undefined\" &&\n  \"serviceWorker\" in navigator\n) {\n  try {\n    navigator.serviceWorker\n      .register(\"/sw.js\")\n      .then((reg) => {\n        console.debug(\"[ServiceWorker] Registered\", reg);\n      })\n      .catch((err) => {\n        console.warn(\"[ServiceWorker] Registration failed\", err);\n      });\n  } catch (e) {\n    // ignore\n  }\n} else if (typeof navigator !== \"undefined\" && \"serviceWorker\" in navigator) {\n  // Safety: if a previous deployment had registered a SW, unregister it so updates always flow.\n  // This prevents stale SW caches from masking new UI behavior.\n  // We also provide a one-time opt-in force-reload mechanism via localStorage key\n  // `NDN_FORCE_SW_RELOAD = \"1\"` for situations where a stale worker still controls the page.\n  try {\n    navigator.serviceWorker.getRegistrations().then((regs) => {\n      if (!regs || regs.length === 0) return;\n      try {\n        console.info(\n          \"[ServiceWorker] Found\",\n          regs.length,\n          \"registrations  unregistering to avoid stale caches\",\n        );\n      } catch {}\n      let anyActive = false;\n      regs.forEach((r) => {\n        try {\n          if (r.active) anyActive = true;\n        } catch {}\n        try {\n          r.unregister();\n        } catch (e) {\n          try {\n            console.warn(\"[ServiceWorker] unregister failed:\", e);\n          } catch {}\n        }\n      });\n\n      // If an active worker was present and the developer/user has set the force-reload flag,\n      // reload once to ensure the browser requests the fresh HTML/JS from the server.\n      try {\n        const forceReload =\n          typeof localStorage !== \"undefined\" &&\n          localStorage.getItem(\"NDN_FORCE_SW_RELOAD\") === \"1\";\n        if (anyActive && forceReload) {\n          try {\n            console.info(\n              \"[ServiceWorker] Active worker removed; forcing page reload to fetch latest assets\",\n            );\n            // Clear the flag so this only happens once\n            localStorage.removeItem(\"NDN_FORCE_SW_RELOAD\");\n            // reload immediately  modern browsers will fetch fresh assets\n            window.location.reload();\n          } catch (e) {\n            /* ignore reload errors */\n          }\n        }\n      } catch (e) {\n        /* ignore */\n      }\n    });\n  } catch {\n    // ignore\n  }\n}\n"],"file":"index-a3BaU_qx.js"}