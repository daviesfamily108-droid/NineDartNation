import{A as en,C as tn,j as t,h as Ms,u as qe,t as ys,l as sn,s as mt,R as nn,D as Ns,B as rn,E as an}from"./index-QB6Os3F3.js";import{r}from"./ui-CuWypN7C.js";import{u as Gt,a as ln}from"./match-DA6kjEGb.js";import{u as Cs}from"./pendingVisit-CK_ujpKW.js";function js(u,a){const i=en(u,a);return tn(i)}class cn{width=0;height=0;bg=null;lastAcceptTs=0;cooldownMs=600;roiRadius=0;roiCx=0;roiCy=0;initialized=!1;thresh=28;minArea=90;maxArea=6e3;prevTip=null;prevArea=0;stableCount=0;requireStableN=1;constructor(){}setROI(a,i,x){this.roiCx=a,this.roiCy=i,this.roiRadius=Math.max(0,x|0)}reset(a,i){this.width=a,this.height=i,this.bg=new Float32Array(a*i),this.initialized=!1}updateBackground(a,i=.05){const{width:x,height:c,data:g}=a;(!this.bg||x!==this.width||c!==this.height)&&this.reset(x,c);const L=this.bg,U=x*c;for(let w=0,v=0;w<U;w++,v+=4){const S=g[v],m=g[v+1],M=g[v+2],D=.299*S+.587*m+.114*M;this.initialized?L[w]=(1-i)*L[w]+i*D:L[w]=D}this.initialized=!0}inRoi(a,i){if(this.roiRadius<=0)return!0;const x=a-this.roiCx,c=i-this.roiCy;return x*x+c*c<=this.roiRadius*this.roiRadius}detect(a){const x=Date.now()-this.lastAcceptTs<this.cooldownMs,{width:c,height:g,data:L}=a;(!this.bg||c!==this.width||g!==this.height)&&this.reset(c,g);const U=this.bg;if(!this.initialized)return this.updateBackground(a,1),null;const w=c*g,v=new Uint8Array(w),S=new Float32Array(w);let m=0,M=0,D=0;const Q=new Uint8Array(w);for(let b=0,E=0;b<w;b++,E+=4){const R=L[E],O=L[E+1],le=L[E+2],J=Math.max(R,O,le),$e=Math.min(R,O,le),Y=.299*R+.587*O+.114*le,G=Math.abs(Y-U[b]);S[b]=G;const Je=Math.floor(b/c),Tt=b-Je*c,Ut=J===0?0:(J-$e)/J,H=J>=250&&Ut<=.12;H&&(Q[b]=1),this.inRoi(Tt,Je)&&!H&&(m+=G,M+=G*G,D++)}const V=D?m/D:0,oe=D?Math.max(0,M/D-V*V):0,Ue=Math.sqrt(oe),at=Math.max(this.thresh,V+1.2*Ue);for(let b=0;b<w;b++){if(Q[b]){v[b]=0;continue}if(S[b]>at){const E=Math.floor(b/c),R=b-E*c;v[b]=this.inRoi(R,E)?1:0}}this._dilate(v,c,g),this._erode(v,c,g);const C=new Uint8Array(w);let y=0,te=null;for(let b=0;b<w;b++){if(v[b]===0||C[b])continue;const E=[];let R=0,O=0;const le=[b];for(C[b]=1;O<le.length;){const J=le[O++];E.push(J),R++;const $e=J/c|0,Y=[J-1,J+1,J-c,J+c];for(const G of Y)G<0||G>=w||C[G]||(G===J-1||G===J+1)&&(G/c|0)!==$e||v[G]&&(C[G]=1,le.push(G))}R>y&&(y=R,te=E)}if(!te||y<this.minArea||y>this.maxArea)return x||this.updateBackground(a,.02),null;let ae=c,ie=g,ye=0,B=0,W=0,fe=0;for(const b of te){const E=b/c|0,R=b-E*c;W+=R,fe+=E,R<ae&&(ae=R),R>ye&&(ye=R),E<ie&&(ie=E),E>B&&(B=E)}W/=y,fe/=y;let Ee=0,ue=0,de=0;for(const b of te){const E=b/c|0,O=b-E*c-W,le=E-fe;Ee+=O*O,ue+=le*le,de+=O*le}Ee/=y,ue/=y,de/=y;const Oe=Ee+ue,I=Ee*ue-de*de,xe=Math.sqrt(Math.max(0,Oe*Oe/4-I)),Ye=Oe/2+xe;let me=de,P=Ye-Ee;Math.hypot(me,P)<1e-6&&(me=Ye-ue,P=de);const Ne=Math.hypot(me,P)||1;me/=Ne,P/=Ne;const Be=W-this.roiCx,Pe=fe-this.roiCy,Dt=Be*me+Pe*P>0?1:-1;me*=Dt,P*=Dt;const ht=Math.hypot(Be,Pe)||1,be=Be/ht,ge=Pe/ht,It=Math.max(-1,Math.min(1,me*be+P*ge));if(Math.acos(It)*180/Math.PI>55)return x||this.updateBackground(a,.02),null;let z=-1/0,Ge=W,_e=fe;for(const b of te){const E=b/c|0,R=b-E*c,O=(R-W)*me+(E-fe)*P;O>z&&(z=O,Ge=R,_e=E)}const pe=Ge-this.roiCx,se=_e-this.roiCy,ft=pe*pe+se*se,ne=Math.max(1,ye-ae+1),it=Math.max(1,B-ie+1),p=ne*it,F=y/p,Ce=Math.sqrt(ft)/Math.max(1,this.roiRadius);let T=.5;F<.45&&(T+=.2),F<.25&&(T+=.15),Ce<1.1&&(T+=.1);const j=Oe-Ye;return(Ye>0?1-j/Ye:0)>.3&&(T+=.1),T=Math.max(0,Math.min(1,T)),!this._isStable({x:Ge+.5,y:_e+.5},y)||x?null:{tip:{x:Ge+.5,y:_e+.5},axis:{x1:W-me*20,y1:fe-P*20,x2:W+me*20,y2:fe+P*20},area:y,bbox:{x:ae,y:ie,w:ne,h:it},confidence:T}}accept(a,i){if(this.lastAcceptTs=Date.now(),this.prevTip=null,this.prevArea=0,this.stableCount=0,!this.bg)return;const{width:x}=a,c=this.bg,{x:g,y:L,w:U,h:w}=i.bbox,v=.5;for(let S=L;S<L+w;S++)for(let m=g;m<g+U;m++){const M=S*x+m,D=M*4,Q=a.data[D],V=a.data[D+1],oe=a.data[D+2],Ue=.299*Q+.587*V+.114*oe;c[M]=(1-v)*c[M]+v*Ue}}_isStable(a,i){const x=(c,g)=>Math.hypot(c.x-g.x,c.y-g.y)<=6;if(!this.prevTip)return this.prevTip={...a},this.prevArea=i,this.stableCount=1,!1;if(x(this.prevTip,a)&&Math.abs(i-this.prevArea)/Math.max(1,i)<.3)this.prevTip={...a},this.prevArea=i,this.stableCount++;else return this.prevTip={...a},this.prevArea=i,this.stableCount=1,!1;return this.stableCount>=this.requireStableN}_dilate(a,i,x){const c=new Uint8Array(a.length);for(let g=0;g<x;g++)for(let L=0;L<i;L++){let U=0;for(let w=-1;w<=1;w++){for(let v=-1;v<=1;v++){const S=g+w,m=L+v;if(!(S<0||S>=x||m<0||m>=i)&&a[S*i+m]){U=1;break}}if(U)break}c[g*i+L]=U}a.set(c)}_erode(a,i,x){const c=new Uint8Array(a.length);for(let g=0;g<x;g++)for(let L=0;L<i;L++){let U=1;for(let w=-1;w<=1;w++){for(let v=-1;v<=1;v++){const S=g+w,m=L+v;if(!(S<0||S>=x||m<0||m>=i)&&!a[S*i+m]){U=0;break}}if(!U)break}c[g*i+L]=U}a.set(c)}}function on(u){try{if(!u||typeof u!="object")return null;if((u.type==="dart"||u.kind==="dart"||u.event==="dart")&&typeof u.value=="number"){const a=Ss(u.ring);return Es(u.value,a)}if(typeof u.value=="number"&&u.ring){const a=Ss(u.ring);return Es(u.value,a)}if(typeof u.score=="string"){const a=u.score.trim().toUpperCase();if(a==="50"||a==="DBULL"||a==="INNER_BULL")return{value:50,ring:"INNER_BULL",sector:null,mult:0};if(a==="25"||a==="BULL"||a==="OBULL")return{value:25,ring:"BULL",sector:null,mult:0};const i=a.match(/^(S|D|T)(\d{1,2})$/);if(i){const x=i[1]==="S"?1:i[1]==="D"?2:3,c=parseInt(i[2],10);if(c>=1&&c<=20)return{value:c*x,ring:x===1?"SINGLE":x===2?"DOUBLE":"TRIPLE",sector:c,mult:x}}}if(typeof u.sector=="number"&&typeof u.mult=="number"){const a=Math.max(1,Math.min(20,Math.floor(u.sector))),i=u.mult===1?1:u.mult===2?2:3;return{value:a*i,ring:i===1?"SINGLE":i===2?"DOUBLE":"TRIPLE",sector:a,mult:i}}if(u.bull){const a=String(u.bull).toLowerCase()==="inner"||u.bull===!0;return{value:a?50:25,ring:a?"INNER_BULL":"BULL",sector:null,mult:0}}}catch{}return null}function Ss(u){const a=String(u||"").toUpperCase();return a.startsWith("TR")?"TRIPLE":a.startsWith("DO")?"DOUBLE":a.startsWith("SI")?"SINGLE":a==="INNER_BULL"||a==="DBULL"||a==="50"||a==="IBULL"?"INNER_BULL":a==="BULL"||a==="25"||a==="OBULL"||a==="OUTER_BULL"?"BULL":a==="MISS"||a==="0"?"MISS":"SINGLE"}function Es(u,a){const i=Math.max(0,Math.min(60,Math.round(Number(u)||0)));return a==="INNER_BULL"?{value:50,ring:a}:a==="BULL"?{value:25,ring:a}:{value:i,ring:a}}function un(u,a){let i=null,x=!0,c=null,g=0;const L=400,U=[],w=new Set;function v(m,M){const D=typeof m?.id=="string"||typeof m?.id=="number"?String(m.id):null;if(D){if(w.has(D))return;if(w.add(D),U.push(D),U.length>200){const oe=U.shift();oe&&w.delete(oe)}}const Q=`${M.value}|${M.ring}|${M.sector??""}|${M.mult??""}`,V=Date.now();Q===c&&V-g<L||(c=Q,g=V,a(M))}function S(){if(x)try{i=new WebSocket(u),i.onmessage=m=>{try{const M=JSON.parse(m.data),D=on(M);D&&v(M,D)}catch{}},i.onclose=()=>{i=null,setTimeout(S,1500)},i.onerror=()=>{}}catch{setTimeout(S,2e3)}}return S(),{close:()=>{x=!1;try{i?.close()}catch{}}}}function Ls({storageKey:u,children:a,className:i,defaultWidth:x=640,defaultHeight:c=360,minWidth:g=320,minHeight:L=200,maxWidth:U=1600,maxHeight:w=1200,autoFill:v=!1}){const[S,m]=r.useState(()=>{try{const C=localStorage.getItem(u);if(C)return JSON.parse(C)}catch{}return v?{width:x}:{width:x,height:c}}),M=r.useRef(null),D=r.useRef(null);r.useEffect(()=>{function C(){try{localStorage.removeItem(u)}catch{}m({width:x,height:c})}return window.addEventListener("ndn:layout-reset",C),window.addEventListener("ndn:camera-reset",C),()=>{window.removeEventListener("ndn:layout-reset",C),window.removeEventListener("ndn:camera-reset",C)}},[u,x,c]),r.useEffect(()=>{try{localStorage.setItem(u,JSON.stringify(S))}catch{}},[S,u]);function Q(C,y,te){return Math.max(y,Math.min(te,C))}function V(C,y){C.preventDefault();const te=D.current;if(!te)return;const ae=te.getBoundingClientRect();M.current={x:C.clientX,y:C.clientY,w:ae.width,h:ae.height,dir:y},window.addEventListener("mousemove",oe),window.addEventListener("mouseup",Ue)}function oe(C){const y=M.current;if(!y)return;const te=C.clientX-y.x,ae=C.clientY-y.y;let ie=y.w,ye=y.h;y.dir.includes("e")&&(ie=Q(y.w+te,g,U)),!v&&y.dir.includes("s")&&(ye=Q(y.h+ae,L,w)),y.dir.includes("w")&&(ie=Q(y.w-te,g,U)),!v&&y.dir.includes("n")&&(ye=Q(y.h-ae,L,w)),m({width:Math.round(ie),height:Math.round(ye)})}function Ue(){window.removeEventListener("mousemove",oe),window.removeEventListener("mouseup",Ue),M.current=null}const at={width:v?"100%":S.width?`${S.width}px`:void 0,height:v?"100%":S.height?`${S.height}px`:void 0,maxWidth:"100%",maxHeight:v?"100%":"80vh",position:"relative",...v?{display:"flex",flexDirection:"column",flex:"1 1 auto"}:{}};return t.jsxs("div",{ref:D,className:`${i||""}`,style:at,children:[a,t.jsx("div",{className:"resizer resizer-nw",onMouseDown:C=>V(C,"nw")}),t.jsx("div",{className:"resizer resizer-ne",onMouseDown:C=>V(C,"ne")}),t.jsx("div",{className:"resizer resizer-sw",onMouseDown:C=>V(C,"sw")}),t.jsx("div",{className:"resizer resizer-se",onMouseDown:C=>V(C,"se")})]})}const dn=Ms((u,a)=>({samples:[],addSample:i=>u(x=>({samples:[...x.samples,i]})),clear:()=>u({samples:[]}),export:()=>a().samples.slice()})),mn=Ms(u=>({paused:!1,pauseEndsAt:null,setPaused:(a,i=null)=>u({paused:a,pauseEndsAt:i??null})})),hn=1,fn=120,xn=400,bn=450,gn=5e3,pn=.85,vn=6500;function wn({onVisitCommitted:u,showToolbar:a=!0,onAutoDart:i,immediateAutoCommit:x=!1,hideInlinePanels:c=!1,scoringMode:g="x01",onGenericDart:L,onGenericReplace:U,x01DoubleInOverride:w,onAddVisit:v,onEndLeg:S}){const m=r.useRef(null),{preferredCameraId:M,preferredCameraLabel:D,setPreferredCamera:Q,autoscoreProvider:V,autoscoreWsUrl:oe,cameraAspect:Ue,cameraFitMode:at,autoCommitMode:C="wait-for-clear",cameraEnabled:y,setCameraEnabled:te,preferredCameraLocked:ae,hideCameraOverlay:ie,setHideCameraOverlay:ye}=qe(),B=V==="manual",[W,fe]=r.useState([]),Ee=r.useRef(null),ue=r.useRef(null),[de,Oe]=r.useState(!1),I=ys(),xe=D==="Phone Camera",Ye=I.getMediaStream?.()||null,me=I.isStreaming,P=xe&&I.mode==="phone"&&me&&!!Ye,Ne=de||me,[Be,Pe]=r.useState(!1),[Dt,ht]=r.useState(null),{H:be,imageSize:ge,reset:It,_hydrated:Rs}=sn();r.useEffect(()=>{ae&&!ie&&ye(!0)},[ae,ie,ye]);const[z,Ge]=r.useState(""),[_e,pe]=r.useState(""),[se,ft]=r.useState(0),[ne,it]=r.useState("MISS"),[p,F]=r.useState(0),[Ce,T]=r.useState(0),[j,q]=r.useState([]),[lt,b]=r.useState(0),[E,R]=r.useState(0),[O,le]=r.useState(!1),J=r.useRef(null),$e=r.useRef(null),Y=!x&&C!=="immediate",[G,Je]=r.useState(0),[Tt,Ut]=r.useState([]),H=r.useRef(null),Xt=r.useRef([]),Kt=r.useRef(0),Ze=r.useRef(0),Xe=r.useRef(!1),Ve=r.useRef(null),ct=r.useRef(0),[Ot,ks]=r.useState([]),[Qt,As]=r.useState(!1),xt=r.useCallback(()=>{$e.current&&(clearTimeout($e.current),$e.current=null)},[]),Jt=r.useCallback(e=>{const s=[...Xt.current.slice(-8),e];Xt.current=s,ks(s);try{window.ndnCameraDiagnostics=s}catch{}},[]),ze=r.useCallback(e=>{const s=J.current;if(s&&(J.current=null,xt(),le(!1),u))try{u(s.score,s.darts,s.finished)}catch{}},[u,xt]),Fe=r.useCallback(e=>{if(u){if(!Y){try{u(e.score,e.darts,e.finished)}catch{}return}J.current=e,le(!0),xt(),$e.current=window.setTimeout(()=>ze("timeout"),vn)}},[u,Y,xt,ze]),bt=r.useCallback(e=>{F(0),T(0),q([]),b(0),R(0),X(!1);try{window.dispatchEvent(new CustomEvent("ndn:clear-visit-request",{detail:{source:"camera-view",reason:e,ts:Date.now()}}))}catch{}},[]);r.useEffect(()=>{if(!Y)return;const e=()=>ze("event");return window.addEventListener("ndn:darts-cleared",e),()=>window.removeEventListener("ndn:darts-cleared",e)},[Y,ze]),r.useEffect(()=>{Y||ze("timeout")},[Y,ze]),r.useEffect(()=>()=>ze("teardown"),[ze]);const Ds=r.useCallback(()=>{bt("indicator"),Je(e=>e+1)},[bt]),Is=r.useCallback(()=>{p===0&&Ce===0||(bt("toolbar"),Je(e=>e+1))},[bt,p,Ce]),Ts=r.useCallback(()=>{if(!B)try{window.dispatchEvent(new CustomEvent("ndn:open-camera-manager",{detail:{source:"camera-view",ts:Date.now()}}))}catch(e){console.warn("[CameraView] Failed to request camera manager:",e)}},[B]),Us=qe(e=>e.x01DoubleIn),et=typeof w=="boolean"?!!w:!!Us,[Os,Zt]=r.useState({}),k=Gt(e=>e),gt=k.players[k.currentPlayerIdx]?.id,tt=!!(gt&&Os[gt]),es=e=>{gt&&Zt(s=>({...s,[gt]:e}))},Bt=k?.inProgress,ts=Cs(e=>e.setVisit),ss=Cs(e=>e.reset);r.useEffect(()=>{try{ts(j,p,Ce)}catch{}},[j,p,Ce,ts]),r.useEffect(()=>()=>{try{ss()}catch{}},[ss]);const Bs=Gt(e=>e.addVisit),Ps=Gt(e=>e.endLeg),He=(e,s,n)=>{try{v?v(e,s,n):Bs(e,s,n)}catch{}},ns=e=>{try{S?S(e):Ps(e)}catch{}},Pt=dn(e=>e.addSample),[pt,_s]=r.useState(""),[vt,$s]=r.useState(""),[Le,_]=r.useState(0),[Vs,ve]=r.useState(!1),[je,X]=r.useState(!1),[rs,wt]=r.useState(!1),Me=r.useRef(null),[as,De]=r.useState("auto"),[_t,Ie]=r.useState(!1),[zs,yt]=r.useState(!1),[Fs,is]=r.useState(!1),ls=r.useRef(null),ot=qe(e=>e.dartTimerEnabled),$t=qe(e=>e.dartTimerSeconds)||10,[st,Vt]=r.useState(null),Re=r.useRef(null),Nt=mn(e=>e.paused),ut=r.useRef(null),Ke=r.useRef(null),[cs,os]=r.useState(0),Ct=r.useCallback(()=>{try{window.dispatchEvent(new CustomEvent("ndn:phone-camera-reconnect",{detail:{source:"camera-view",ts:Date.now()}}))}catch(e){console.warn("[CameraView] Phone camera reconnect dispatch failed:",e)}},[]);r.useEffect(()=>{const e=()=>{B||yt(!0)};return window.addEventListener("ndn:open-autoscore",e),()=>window.removeEventListener("ndn:open-autoscore",e)},[B]),r.useEffect(()=>()=>{try{Me.current&&clearTimeout(Me.current)}catch{}},[]),r.useEffect(()=>{const e=()=>is(!0);return window.addEventListener("ndn:open-scoring",e),()=>window.removeEventListener("ndn:open-scoring",e)},[]),r.useEffect(()=>{const e=()=>{Je(s=>s+1),F(0),T(0),q([]),b(0),R(0),X(!1)};return window.addEventListener("ndn:darts-cleared",e),()=>window.removeEventListener("ndn:darts-cleared",e)},[]),r.useEffect(()=>{Ut(e=>{if(j.length>e.length){const s=j.length-e.length;return[...e,...Array(s).fill(G)]}return j.length<e.length?e.slice(0,j.length):e})},[j,G]),r.useEffect(()=>{if(Ve.current&&(clearTimeout(Ve.current),Ve.current=null),B){Xe.current=!1,Ze.current=0,H.current=null;return}return Ne?(Ze.current=performance.now(),H.current=null,Xe.current=!1,ct.current=0,Ve.current=window.setTimeout(()=>{Xe.current=!0,Ve.current=null},gn)):(Ze.current=0,H.current=null,Xe.current=!1,ct.current=0),()=>{Ve.current&&(clearTimeout(Ve.current),Ve.current=null),Xe.current=!1,ct.current=0}},[Ne,B]),r.useEffect(()=>{let e=!0;async function s(){try{if(!navigator?.mediaDevices?.enumerateDevices)return;const n=await navigator.mediaDevices.enumerateDevices();if(!e)return;fe(n.filter(l=>l.kind==="videoinput"))}catch(n){console.warn("[CAMERA] enumerateDevices failed:",n)}}s();try{navigator.mediaDevices.addEventListener("devicechange",s)}catch{try{navigator.mediaDevices.ondevicechange=s}catch{}}return()=>{e=!1;try{navigator.mediaDevices.removeEventListener("devicechange",s)}catch{}}},[]),r.useEffect(()=>{const e=()=>{De("manual"),Ie(!0)},s=()=>{De("auto"),Ie(!1)};return window.addEventListener("ndn:open-manual",e),window.addEventListener("ndn:close-manual",s),()=>{window.removeEventListener("ndn:open-manual",e),window.removeEventListener("ndn:close-manual",s)}},[]),r.useEffect(()=>{B&&(De("manual"),yt(!1))},[B]),r.useEffect(()=>{try{const e=k.players[k.currentPlayerIdx],s=e?.legs?.[e.legs.length-1];if(!e)return;(!s||s.dartsThrown===0)&&Zt(n=>({...n,[e.id]:!1}))}catch{}},[k.currentPlayerIdx,k.players?.[k.currentPlayerIdx]?.legs?.length]),r.useEffect(()=>{const e=!!ot&&Bt&&!Nt&&p<3;if(Re.current&&(clearInterval(Re.current),Re.current=null),!e){Vt(null);return}return Vt($t),Re.current=window.setInterval(()=>{Vt(s=>{const n=(s??$t)-1;if(n<=0){try{ke(0,"MISS 0","MISS")}catch{}return Re.current&&(clearInterval(Re.current),Re.current=null),0}return n})},1e3),()=>{Re.current&&(clearInterval(Re.current),Re.current=null)}},[ot,$t,p,k.currentPlayerIdx,k?.inProgress,Nt]),r.useEffect(()=>{if(!_t)return;const e=setInterval(()=>{try{const s=m.current,n=ls.current;if(!s||!n)return;const l=s.videoWidth||0,f=s.videoHeight||0;if(!l||!f)return;const d=n.clientWidth||640,o=n.clientHeight||360;n.width!==d&&(n.width=d),n.height!==o&&(n.height=o);const h=n.getContext("2d");if(!h)return;h.imageSmoothingEnabled=!0;const N=Math.min(d/l,o/f),ce=Math.round(l*N),A=Math.round(f*N),$=Math.floor((d-ce)/2),K=Math.floor((o-A)/2);h.fillStyle="#000",h.fillRect(0,0,d,o),h.drawImage(s,$,K,ce,A)}catch(s){console.warn("Manual preview update error:",s)}},120);return()=>clearInterval(e)},[_t]),r.useEffect(()=>()=>jt(),[]);const us=xe&&!P;async function dt(){if(!(Be||de)){if(xe&&P){console.log("[CAMERA] Phone camera stream active - leaving local camera idle"),Pe(!1);return}Pe(!0),console.log("[CAMERA] Starting camera...");try{const e=M?{video:{deviceId:{exact:M}},audio:!1}:{video:{facingMode:"environment"},audio:!1};console.log("[CAMERA] Using constraints:",e);let s;try{s=await navigator.mediaDevices.getUserMedia(e),console.log("[CAMERA] Got stream:",!!s)}catch(n){console.warn("[CAMERA] First attempt failed:",n);const l=n&&(n.name||n.code)||"";if(M&&(l==="OverconstrainedError"||l==="NotFoundError"))console.log("[CAMERA] Trying fallback without deviceId"),s=await navigator.mediaDevices.getUserMedia({video:!0,audio:!1});else if(!M&&(l==="OverconstrainedError"||l==="NotFoundError"||l==="NotSupportedError"))console.log("[CAMERA] Trying fallback for facingMode not supported"),s=await navigator.mediaDevices.getUserMedia({video:!0,audio:!1});else throw n}if(m.current){console.log("[CAMERA] Setting stream to video element"),m.current.srcObject=s,console.log("[CAMERA] Stream tracks:",s.getTracks().length,"video tracks:",s.getVideoTracks().length),m.current.addEventListener("loadeddata",()=>console.log("[CAMERA] Video loadeddata")),m.current.addEventListener("canplay",()=>console.log("[CAMERA] Video canplay")),m.current.addEventListener("play",()=>console.log("[CAMERA] Video started playing")),m.current.addEventListener("error",n=>console.error("[CAMERA] Video error:",n));try{m.current.play(),console.log("[CAMERA] Play called successfully")}catch(n){console.error("[CAMERA] Video play failed:",n),setTimeout(()=>{try{m.current?.play(),console.log("[CAMERA] Retry play called")}catch(l){console.error("[CAMERA] Retry play failed:",l)}},100)}try{I.setVideoElementRef?.(m.current),I.setMediaStream?.(s),I.setMode?.("local"),I.setStreaming?.(!0)}catch(n){console.warn("[CAMERA] Failed to sync camera session with local stream:",n)}}else console.error("[CAMERA] Video element not found");Oe(!0);try{const n=await navigator.mediaDevices.enumerateDevices();fe(n.filter(l=>l.kind==="videoinput")),console.log("[CAMERA] Found cameras:",n.filter(l=>l.kind==="videoinput").length)}catch(n){console.warn("[CAMERA] Failed to enumerate devices:",n)}}catch(e){console.error("[CAMERA] Camera start failed:",e),alert("Camera permission denied or not available.")}finally{Pe(!1)}}}function jt(){m.current&&m.current.srcObject&&(m.current.srcObject.getTracks().forEach(s=>s.stop()),m.current.srcObject=null,Oe(!1),Pe(!1))}r.useEffect(()=>{const e=m.current;if(!e)return;const s=I.getMediaStream?.()||null,l=(I.getVideoElementRef?.()||null)?.srcObject||null,f=s||l;if(f){e.srcObject!==f&&(e.srcObject=f),e.muted=!0,e.playsInline=!0;try{e.play?.()}catch{}de||Oe(!0)}},[I.mode,I.isStreaming,de,I]);function ds(){try{if(!Ee.current)return;const e=m.current,s=I.getVideoElementRef?.()||null,n=e&&e.videoWidth>0&&e.videoHeight>0?e:s||e;if(!n)return;const l=n,f=Ee.current;f.width=l.videoWidth,f.height=l.videoHeight;const d=f.getContext("2d");if(!d)return;d.drawImage(l,0,0,f.width,f.height);const o=f.toDataURL("image/png");ht(o)}catch(e){console.warn("Capture error:",e)}}function ms(){return W.length?t.jsxs("div",{className:"absolute top-2 right-2 z-20 flex items-center gap-2 bg-black/40 rounded px-2 py-1 text-xs",children:[t.jsx("span",{children:"Cam:"}),t.jsxs("select",{className:"bg-black/20 rounded px-1 py-0.5",value:M||"",onChange:async e=>{if(Be)return;const s=e.target.value||void 0,n=W.find(l=>l.deviceId===s)?.label;Q(s,n||"",!0),jt(),await new Promise(l=>setTimeout(l,150));try{await dt()}catch(l){console.warn("Failed to start camera after device switch:",l),setTimeout(async()=>{try{await dt()}catch(f){console.error("Camera switch failed after retry:",f),alert("Failed to switch camera. Please try again or refresh the page.")}},500)}},children:[t.jsx("option",{value:"",children:"Auto"}),W.map(e=>t.jsx("option",{value:e.deviceId,children:e.label||(e.deviceId?`Camera (${e.deviceId.slice(0,6)})`:"Camera")},e.deviceId))]}),t.jsx("button",{className:"btn btn--ghost btn-sm ml-2",onClick:async()=>{try{const e=await navigator.mediaDevices.enumerateDevices();fe(e.filter(s=>s.kind==="videoinput"))}catch(e){console.warn("Rescan failed:",e),alert("Failed to rescan devices. Ensure camera permissions are granted.")}},title:"Rescan connected cameras",children:"Rescan"})]}):null}r.useEffect(()=>{},[be,ge,Ne,B,xe,ae,ie]),r.useEffect(()=>{if(B||V!=="built-in")return;const e=ys.getState(),n=qe.getState().preferredCameraLabel==="Phone Camera"?e.getVideoElementRef?.()||null:m.current;if(!n||!be||!ge)return;let l=!1;const f=n,d=Ee.current;if(!d)return;ut.current||(ut.current=new cn);const o=()=>{if(!l){try{const h=f.videoWidth||0,N=f.videoHeight||0;if(!h||!N){Ke.current=requestAnimationFrame(o);return}d.width!==h&&(d.width=h),d.height!==N&&(d.height=N);const ce=d.getContext("2d",{willReadFrequently:!0});if(!ce){Ke.current=requestAnimationFrame(o);return}ce.drawImage(f,0,0,h,N);const A=ce.getImageData(0,0,h,N);ct.current++;const $=Ns(be,{x:0,y:0}),K=Ns(be,{x:rn.doubleOuter,y:0}),Se=h/ge.w,he=N/ge.h,Qe=$.x*Se,Mt=$.y*he,Gs=K.x*Se,Xs=K.y*he,Ks=Math.hypot(Gs-Qe,Xs-Mt)*1.08,zt=ut.current;if(cs>=0&&zt.setROI(Qe,Mt,Math.max(24,Math.min(Math.max(h,N),Ks))),!Nt&&p<3&&Xe.current&&ct.current>150){const we=zt.detect(A),We=performance.now();if(H.current&&We-H.current.firstTs>900&&(H.current=null),we&&we.confidence>=pn){const ps=Ze.current>0&&We-Ze.current<bn,Rt=an(d,we.tip,6),Qs={x:Rt.x/Se,y:Rt.y/he},kt=js(be,Qs),Te=kt.ring,Ae=kt.base,At=`${Te} ${Ae>0?Ae:""}`.trim(),vs=kt.sector??null,ws=Math.max(0,Number(kt.mult)||0);let nt=!1;Ge(At),ft(Ae),it(Te);const Js=re=>{if(re.value>0){X(!0),wt(!0);try{Me.current&&clearTimeout(Me.current)}catch{}Me.current=window.setTimeout(()=>{wt(!1),Me.current=null},1500);try{ke(re.value,re.label,re.ring)}catch{}}else X(!1);try{i&&i(re.value,re.ring,{sector:re.sector,mult:re.mult})}catch{}};if(ps)H.current=null,nt=!0;else if(Te==="MISS"||Ae<=0){H.current=null,X(!1);try{i&&i(Ae,Te,{sector:vs,mult:ws})}catch{}nt=!0}else{const re=H.current;!re||re.value!==Ae||re.ring!==Te?H.current={value:Ae,ring:Te,label:At,sector:vs,mult:ws,firstTs:We,frames:1}:H.current={...re,label:At,frames:re.frames+1};const Z=H.current,ee=We-Z.firstTs,Ft=Z.frames>=hn||ee>=fn,Ht=We-Kt.current>=xn;Ft&&Ht&&(Js(Z),H.current=null,Kt.current=We,nt=!0)}Jt({ts:We,label:At,value:Ae,ring:Te,confidence:we.confidence,ready:nt,accepted:nt&&Ae>0&&Te!=="MISS",warmup:ps});try{if(Ae>0&&Te!=="MISS"){const Z=ue.current;if(Z){const ee=Z.getContext("2d");if(ee){const Ft=Rt.x/h*Z.width,Ht=Rt.y/N*Z.height;if(ee.save(),ee.beginPath(),ee.strokeStyle="#f59e0b",ee.lineWidth=2,ee.arc(Ft,Ht,6,0,Math.PI*2),ee.stroke(),we.axis){const rt=we.axis,Wt=rt.x1/h*Z.width,qt=rt.y1/N*Z.height,Yt=rt.x2/h*Z.width,Zs=rt.y2/N*Z.height;ee.beginPath(),ee.moveTo(Wt,qt),ee.lineTo(Yt,Zs),ee.stroke()}if(we.bbox){const rt=we.bbox.x/h*Z.width,Wt=we.bbox.y/N*Z.height,qt=we.bbox.w/h*Z.width,Yt=we.bbox.h/N*Z.height;ee.strokeStyle="#22d3ee",ee.strokeRect(rt,Wt,qt,Yt)}ee.restore()}}}}catch{}nt&&zt.accept(A,we)}else H.current&&We-H.current.firstTs>800&&(H.current=null)}}catch{}Ke.current=requestAnimationFrame(o)}};return Ke.current=requestAnimationFrame(o),()=>{l=!0,Ke.current&&cancelAnimationFrame(Ke.current),Ke.current=null}},[B,V,Ne,be,ge,Nt,p,cs,Jt]);const St=r.useCallback(async()=>{try{if(xe){const e=W.find(s=>s.kind==="videoinput");e?Q(e.deviceId,e.label||"",!0):Q(void 0,"",!0)}await dt()}catch(e){console.warn("[CameraView] Local camera fallback failed:",e)}},[W,xe,Q]);r.useEffect(()=>{try{ln.getState().setCalibrationStatus({hasHomography:!!be,imageSize:ge})}catch{}},[be,ge]),r.useEffect(()=>{if(V!=="external-ws"||!oe)return;const e=un(oe,s=>{if(!(!Xe.current||performance.now()-Ze.current<5e3))if(i){try{i(s.value,s.ring,{sector:s.sector??null,mult:s.mult??0})}catch{}try{Pt({playerId:k.players[k.currentPlayerIdx]?.id??null,sector:s.sector??null,mult:s.mult??0,ring:s.ring,ts:Date.now()})}catch{}}else{const n=s.ring==="INNER_BULL"?"INNER_BULL 50":s.ring==="BULL"?"BULL 25":`${s.ring[0]}${s.value/(s.mult||1)||s.value} ${s.value}`;ke(s.value,n,s.ring);try{Pt({playerId:k.players[k.currentPlayerIdx]?.id??null,sector:s.sector??null,mult:s.mult??0,ring:s.ring,ts:Date.now()})}catch{}}});return()=>e.close()},[V,oe]);function hs(e){if(!ue.current||!be||!ge)return;const s=ue.current.getBoundingClientRect(),n=e.clientX-s.left,l=e.clientY-s.top,f=ue.current.width/ge.w,d=ue.current.height/ge.h,o={x:n/f,y:l/d},h=js(be,o),N=`${h.ring} ${h.base>0?h.base:""}`.trim();Ge(N),ft(h.base),it(h.ring),X(!0);try{if(x&&i){i(h.base,h.ring,{sector:h.sector,mult:h.mult});try{Pt({playerId:k.players[k.currentPlayerIdx]?.id??null,sector:h.sector??null,mult:h.mult??0,ring:h.ring,ts:Date.now()})}catch{}X(!1)}}catch{}}function fs(e){const s=e.trim().toUpperCase();if(!s)return null;const n=s==="BULL"||s==="50"||s==="DBULL"||s==="IBULL",l=s==="25"||s==="OBULL";if(n)return{label:"INNER_BULL 50",value:50,ring:"INNER_BULL"};if(l)return{label:"BULL 25",value:25,ring:"BULL"};const f=s.match(/^(S|D|T)?\s*(\d{1,2})$/);if(!f)return null;const d=f[1]||"S",o=parseInt(f[2],10);if(o<1||o>20)return null;const h=d==="S"?1:d==="D"?2:3,N=d==="S"?"SINGLE":d==="D"?"DOUBLE":"TRIPLE";return{label:`${d}${o} ${o*h}`,value:o*h,ring:N}}function xs(){const e=k;if(!e.players.length)return e.startingScore;const s=e.players[e.currentPlayerIdx],n=s.legs[s.legs.length-1];return n?n.totalScoreRemaining:e.startingScore}function ke(e,s,n){if(Y&&O){if(!rs){wt(!0);try{Me.current&&clearTimeout(Me.current)}catch{}Me.current=window.setTimeout(()=>{wt(!1),Me.current=null},1200)}return}if(g==="custom"){if(L)try{L(e,n,{label:s})}catch{}if(p>=3){F(1),T(e),q([{label:s,value:e,ring:n}]);return}const $=p+1;F($),T(K=>K+e),q(K=>[...K,{label:s,value:e,ring:n}]);return}if(p>=3){const $=Ce,K=p;He($,K,{preOpenDarts:lt||0,doubleWindowDarts:E||0,finishedByDouble:!1,visitTotal:$});try{const Qe=k.players[k.currentPlayerIdx]?.name;Qe&&mt(Qe,K,$)}catch{}const Se=!et||tt||n==="DOUBLE"||n==="INNER_BULL",he=Se?e:0;F(1),T(he),q([{label:s,value:he,ring:n}]),b(Se?0:1),R(0),et&&!tt&&(n==="DOUBLE"||n==="INNER_BULL")&&es(!0),Fe({score:$,darts:K,finished:!1});return}const l=p+1,d=!et||tt||n==="DOUBLE"||n==="INNER_BULL"?e:0;et&&!tt&&(n==="DOUBLE"||n==="INNER_BULL")&&es(!0);const o=Ce+d,N=xs()-o,ce=N===0&&(n==="DOUBLE"||n==="INNER_BULL");if(N<0||N===1||N===0&&!ce){const K=(lt||0)+(et&&!tt&&!(n==="DOUBLE"||n==="INNER_BULL")?1:0),Se=N,he=N+d,Qe=he>50&&Se<=50||he<=50?1:0,Mt=(E||0)+Qe;He(0,l,{preOpenDarts:K,doubleWindowDarts:Mt,finishedByDouble:!1,visitTotal:0}),F(0),T(0),q([]),b(0),R(0),Fe({score:0,darts:l,finished:!1});return}F(l),T(o),q($=>[...$,{label:s,value:d,ring:n}]),et&&!tt&&!(n==="DOUBLE"||n==="INNER_BULL")&&b($=>($||0)+1);{const $=N,K=N+d;(K>50&&$<=50||K<=50)&&R(he=>(he||0)+1)}if(ce){He(o,l,{preOpenDarts:lt||0,doubleWindowDarts:E||0,finishedByDouble:!0,visitTotal:o}),ns(o),F(0),T(0),q([]),b(0),R(0),Fe({score:o,darts:l,finished:!0});return}l>=3&&(He(o,l,{preOpenDarts:lt||0,doubleWindowDarts:E||0,finishedByDouble:!1,visitTotal:o}),F(0),T(0),q([]),b(0),R(0),Fe({score:o,darts:l,finished:!1}))}function bs(){if(!(Y&&O)&&z){if(i)try{i(se,ne,void 0)}catch{}else ke(se,z,ne);_(0),X(!1)}}function Et(){if(Y&&O)return;const e=fs(_e);if(!e){alert("Enter like T20, D16, 5, 25, 50");return}if(!je||!z||ne==="MISS"||se===0){const s=Le+1;_(s),s>=5&&ve(!0)}else _(0);ke(e.value,e.label,e.ring),pe(""),X(!1)}function gs(){if(Y&&O)return;const e=fs(_e);if(!e){alert("Enter like T20, D16, 5, 25, 50");return}if(p===0||j.length===0){Et();return}if(g==="custom"){if(!je||!z||ne==="MISS"||se===0){const A=Le+1;_(A),A>=5&&ve(!0)}else _(0);if(q(A=>[...A.slice(0,-1),{label:e.label,value:e.value,ring:e.ring}]),U)try{U(e.value,e.ring,{label:e.label})}catch{}pe(""),X(!1);return}if(!je||!z||ne==="MISS"||se===0){const A=Le+1;_(A),A>=5&&ve(!0)}else _(0);const s=j[j.length-1],n=p-1,l=Ce-(s?.value||0),f=xs(),d=l+e.value,o=n+1,h=f-d,N=h===0&&(e.ring==="DOUBLE"||e.ring==="INNER_BULL");if(h<0||h===1||h===0&&!N){He(0,o);try{const A=k.players[k.currentPlayerIdx]?.name;A&&mt(A,o,0)}catch{}F(0),T(0),q([]),Fe({score:0,darts:o,finished:!1}),pe(""),X(!1);return}if(F(o),T(d),q(A=>[...A.slice(0,-1),{label:e.label,value:e.value,ring:e.ring}]),N){He(d,o),ns(d);try{const A=k.players[k.currentPlayerIdx]?.name;A&&mt(A,o,d)}catch{}F(0),T(0),q([]),Fe({score:d,darts:o,finished:!0}),pe(""),X(!1);return}if(o>=3){He(d,o);try{const A=k.players[k.currentPlayerIdx]?.name;A&&mt(A,o,d)}catch{}F(0),T(0),q([]),Fe({score:d,darts:o,finished:!1})}pe(""),X(!1)}function Hs(){ve(!1),_(0);try{window.dispatchEvent(new CustomEvent("ndn:request-calibrate"))}catch{}}function Ws(){It(),ve(!1),_(0)}r.useEffect(()=>{function e(s){try{const l=document.activeElement?.tagName?.toLowerCase();s.key==="m"&&l!=="input"&&l!=="textarea"&&(De("manual"),Ie(!0))}catch{}}return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[]);function Lt(e,s){if(p>=3||Y&&O)return;const n=e*(s==="S"?1:s==="D"?2:3),l=s==="S"?"SINGLE":s==="D"?"DOUBLE":"TRIPLE";if(!je||!z||ne==="MISS"||se===0){const f=Le+1;_(f),f>=5&&ve(!0)}else _(0);ke(n,`${s}${e} ${n}`,l),X(!1)}function qs(){if(p===0)return;const e=j[j.length-1];F(s=>s-1),T(s=>s-(e?.value||0)),q(s=>s.slice(0,-1))}function Ys(){if(p===0||Y&&O)return;if(g==="custom"){F(0),T(0),q([]);return}const e=Ce,s=p;He(e,s);try{const n=k.players[k.currentPlayerIdx]?.name;n&&mt(n,s,e)}catch{}F(0),T(0),q([]),Fe({score:e,darts:s,finished:!1})}return t.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-4",children:[a&&t.jsx("div",{className:"lg:col-span-2",children:t.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[!B&&t.jsx("button",{className:`btn px-3 py-1 text-sm ${as==="auto"?"tab--active":""}`,onClick:()=>{De("auto"),Ie(!1),yt(!0)},children:"Autoscore"}),t.jsx("button",{className:`btn px-3 py-1 text-sm ${as==="manual"?"tab--active":""}`,onClick:()=>{De("manual"),Ie(!0)},title:"Open Manual Correction",children:"Manual Correction"}),B&&t.jsx("span",{className:"text-xs opacity-70",children:"Manual scoring mode active"})]})}),!c&&!B?t.jsxs("div",{className:"card relative camera-fullwidth-card lg:col-span-2",children:[t.jsx("h2",{className:"text-xl font-semibold mb-3",children:"Camera"}),t.jsxs(Ls,{storageKey:"ndn:camera:size",className:"relative rounded-2xl overflow-hidden bg-black",defaultWidth:480,defaultHeight:360,minWidth:360,minHeight:270,maxWidth:800,maxHeight:600,autoFill:!0,children:[t.jsx(ms,{}),(()=>{const e=Ue||qe.getState().cameraAspect||"wide",s=(at||qe.getState().cameraFitMode||"fit")==="fit",n=e==="square"?"absolute left-0 top-1/2 -translate-y-1/2 min-w-full min-h-full object-cover object-left bg-black":s?"absolute inset-0 w-full h-full object-contain object-center bg-black":"absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 min-w-full min-h-full w-auto h-auto object-cover object-center bg-black",l=e==="square"?"relative w-full mx-auto aspect-square bg-black":"relative w-full aspect-[4/3] bg-black",f=()=>t.jsxs("div",{className:l,children:[t.jsx("video",{ref:m,className:n,playsInline:!0,"webkit-playsinline":"true",muted:!0,autoPlay:!0}),t.jsx("canvas",{ref:ue,className:"absolute inset-0 w-full h-full",onClick:hs}),t.jsxs("div",{className:"absolute top-2 left-1/2 -translate-x-1/2 z-20 flex items-center gap-3 cursor-pointer select-none",onDoubleClick:Ds,"aria-label":`Visit status: ${j[0]?j[0].value>0?"hit":"miss":"pending"}, ${j[1]?j[1].value>0?"hit":"miss":"pending"}, ${j[2]?j[2].value>0?"hit":"miss":"pending"}`,children:[[0,1,2].map(d=>{const o=j[d],h=Tt[d],N=!o,ce=!!o&&h===G,A=typeof o?.value=="number"?o.value>0:!1,$=(o?.ring&&o.ring!=="MISS")??!1,Se=ce?ce&&(A||$)?"bg-emerald-400":"bg-rose-500":"bg-gray-500/70",he=ce&&!N;return t.jsx("span",{className:`visit-dot ${he?"active":"inactive"} ${Se}`},d)}),ot&&st!==null&&t.jsxs("span",{className:"px-2 py-0.5 rounded bg-black/60 text-white text-xs font-semibold",children:[Math.max(0,st),"s"]})]}),Y&&O?t.jsx("div",{className:"absolute bottom-3 left-1/2 -translate-x-1/2 z-20 bg-black/70 text-amber-200 text-xs font-semibold px-3 py-1 rounded-full shadow",children:"Remove darts to continue"}):null]});return xe?P?f():t.jsx("div",{className:"w-full h-full flex flex-col items-center justify-center bg-gradient-to-br from-blue-900/50 to-purple-900/50",children:t.jsxs("div",{className:"text-center space-y-3 max-w-xs mx-auto",children:[t.jsx("div",{className:"text-4xl",children:"ðŸ“±"}),t.jsx("div",{className:"text-lg font-semibold text-blue-100",children:"Phone camera selected"}),t.jsx("p",{className:"text-sm text-slate-300",children:"Start streaming from the Calibrator tab or reconnect below."}),t.jsxs("div",{className:"flex items-center justify-center gap-2 flex-wrap",children:[t.jsx("button",{className:"btn bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 text-sm",onClick:Ct,children:"Reconnect Phone"}),t.jsx("button",{className:"btn bg-slate-700 hover:bg-slate-800 text-white px-3 py-1 text-sm",onClick:()=>{try{I.setShowOverlay?.(!0)}catch{}},children:"Show Overlay"}),t.jsx("button",{className:"btn bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-1 text-sm",onClick:St,disabled:!W.length,children:"Use Local Camera"})]})]})}):f()})()]}),t.jsxs("div",{className:"mt-3 flex items-center justify-between gap-2",children:[t.jsxs("button",{className:"btn btn--ghost px-3 py-1 text-xs font-semibold",onClick:()=>As(e=>!e),children:[Qt?"Hide":"Show"," detection log"]}),t.jsxs("span",{className:"text-xs text-slate-400",children:["Recent detections: ",Ot.length]})]}),Qt&&t.jsx("div",{className:"mt-2 rounded-2xl border border-white/15 bg-slate-900/80 p-3 text-xs text-white font-mono max-h-36 overflow-y-auto space-y-1",children:Ot.length===0?t.jsx("div",{className:"text-center text-slate-400",children:"No autoscore detections yet."}):Ot.slice().reverse().map(e=>t.jsxs("div",{className:"flex items-center justify-between gap-3",children:[t.jsx("span",{className:"truncate flex-1",title:`Value ${e.value} ${e.ring}`,children:e.label.padEnd(6," ")}),t.jsx("span",{className:"text-slate-400",children:e.confidence.toFixed(2)}),t.jsx("span",{className:`px-2 rounded-full text-[10px] font-semibold ${e.accepted?"bg-emerald-500/80":e.ready?"bg-amber-500/80":"bg-rose-500/80"}`,children:e.accepted?"accepted":e.ready?"queued":"ignored"})]},e.ts))}),Bt?t.jsx("div",{className:"absolute top-3 right-3 z-30",children:(()=>{let e="bg-white/90 text-slate-800",s="Manual Correction (M)";je&&(!!z&&ne!=="MISS"&&se>0?(e="bg-emerald-600 text-white",s=`Manual Correction (M) â€” Autoscore: ${z} (confirmed)`):(e="bg-amber-400 text-black",s=`Manual Correction (M) â€” Autoscore ambiguous: ${z||"â€”"}`));const n="px-4 py-2 rounded-full text-base font-semibold shadow-sm hover:opacity-90",l=je&&!!z&&ne!=="MISS"&&se>0,f=rs&&l?"ring-4 ring-emerald-400/60 animate-ping":je&&!l?"animate-pulse":"";return t.jsx("button",{className:`${n} ${e} ${f}`,onClick:()=>{De("manual"),Ie(!0)},title:s,children:"Manual"})})()}):null,t.jsxs("div",{className:"flex flex-wrap items-center gap-2 mt-3",children:[xe?t.jsxs(t.Fragment,{children:[t.jsx("div",{className:`text-sm px-3 py-2 rounded border flex-1 min-w-[200px] ${P?"bg-emerald-500/10 border-emerald-400/40 text-emerald-100":"bg-amber-500/10 border-amber-400/40 text-amber-100"}`,children:P?"ðŸ“± Phone camera stream active":"ðŸ“± Waiting for phone camera stream"}),t.jsx("button",{className:"btn bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 text-sm",onClick:Ct,children:"Reconnect Phone"}),t.jsx("button",{className:"btn bg-slate-700 hover:bg-slate-800 text-white px-3 py-1 text-sm",onClick:()=>{try{I.setShowOverlay?.(!I.showOverlay)}catch{}},children:I.showOverlay?"Hide Overlay":"Show Overlay"}),t.jsx("button",{className:"btn bg-rose-600 hover:bg-rose-700 text-white px-3 py-1 text-sm",disabled:!P,onClick:()=>{try{I.clearSession?.()}catch{}},children:"Stop Phone Feed"}),us&&t.jsx("button",{className:"btn bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-1 text-sm",onClick:St,disabled:!W.length,children:"Use Local Camera"})]}):t.jsx(t.Fragment,{children:de?t.jsx("button",{className:"btn bg-rose-600 hover:bg-rose-700",onClick:jt,children:"Stop Camera"}):t.jsx("button",{className:"btn",onClick:dt,disabled:Be,children:Be?"Connecting Camera...":"Connect Camera"})}),!B&&t.jsx("button",{className:"btn bg-slate-700 hover:bg-slate-800",onClick:Ts,title:"Open phone, WiFi, and USB camera options",children:"Camera Devices"}),t.jsx("button",{className:"btn btn--ghost px-3 py-1 text-sm",onClick:()=>ye(!ie),title:"Toggle the board guide overlay",children:ie?"Show board guides":"Hide board guides"}),t.jsx("button",{className:`btn ${y?"bg-rose-600 hover:bg-rose-700 text-white":"bg-emerald-600 hover:bg-emerald-700 text-white"}`,onClick:()=>te(!y),title:"Toggle whether the camera is used for scoring",children:y?"Disable camera mode":"Enable camera mode"}),t.jsx("button",{className:"btn",onClick:ds,disabled:!Ne,children:"Capture Still"}),t.jsx("button",{className:"btn bg-slate-700 hover:bg-slate-800",disabled:!Ne,onClick:()=>{ut.current=null,os(e=>e+1)},children:"Reset Autoscore Background"}),t.jsx("button",{className:"btn bg-slate-700 hover:bg-slate-800",onClick:()=>{try{window.dispatchEvent(new Event("ndn:camera-reset"))}catch{}},children:"Reset Camera Size"})]})]}):null,Bt?t.jsx("div",{className:"fixed bottom-6 right-6 z-50",children:t.jsx("button",{className:"btn btn--primary rounded-full w-12 h-12 flex items-center justify-center shadow-lg",title:"Open Manual Correction (M)",onClick:()=>{De("manual"),Ie(!0)},children:"âœï¸"})}):null,!c&&B&&t.jsxs("div",{className:"card",children:[t.jsx("h2",{className:"text-xl font-semibold mb-3",children:"Manual Scoring"}),t.jsx("p",{className:"text-sm opacity-80 mb-3",children:"Camera-based autoscore is disabled. Use the manual visit input or open the Manual Correction panel to record darts."}),t.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[t.jsx("button",{className:"btn",onClick:()=>{Ie(!0),De("manual")},children:"Open Manual Correction"}),t.jsx("button",{className:"btn btn--ghost",onClick:()=>{try{window.dispatchEvent(new Event("ndn:open-scoring"))}catch{}},children:"Manage Pending Visit"})]})]}),t.jsx("canvas",{ref:Ee,className:"hidden"}),zs&&!B&&t.jsx("div",{className:"fixed inset-0 bg-black/60 z-[100]",role:"dialog","aria-modal":"true",children:t.jsx("div",{className:"absolute inset-0 flex items-center justify-center p-4",children:t.jsxs(nn,{storageKey:"ndn:autoscore:size",className:"w-full max-w-3xl",defaultWidth:720,defaultHeight:520,minWidth:420,minHeight:320,maxWidth:1400,maxHeight:900,initialFitHeight:!0,children:[t.jsxs("div",{className:"flex items-center justify-between mb-3",children:[t.jsx("h2",{className:"text-xl font-semibold",children:"Autoscore"}),t.jsx("div",{className:"flex items-center gap-2",children:t.jsx("button",{className:"btn btn--ghost",onClick:()=>yt(!1),children:"Close"})})]}),t.jsx("div",{className:"text-sm opacity-80 mb-3",children:"Click the camera overlay to autoscore. Use Manual Correction if the last auto is off."}),t.jsxs("div",{className:"flex items-center gap-2 mb-3 flex-wrap",children:[t.jsx("span",{className:"font-semibold",children:"Last auto:"}),t.jsx("span",{children:z||"â€”"}),t.jsx("button",{className:"btn",onClick:bs,disabled:p>=3,children:"Add Auto Dart"}),Le>0&&t.jsxs("span",{className:"text-sm opacity-80",children:["No-registers: ",Le,"/3"]})]}),t.jsxs("div",{className:"mt-2",children:[t.jsx("div",{className:"text-sm font-semibold mb-2",children:"Quick entry"}),t.jsxs("div",{className:"flex flex-wrap gap-2 mb-3",children:[t.jsx("button",{className:"btn",disabled:p>=3,onClick:()=>{if(!je||!z||ne==="MISS"||se===0){const e=Le+1;_(e),e>=5&&ve(!0)}else _(0);ke(25,"BULL 25","BULL"),X(!1)},children:"25"}),t.jsx("button",{className:"btn",disabled:p>=3,onClick:()=>{if(!je||!z||ne==="MISS"||se===0){const e=Le+1;_(e),e>=5&&ve(!0)}else _(0);ke(50,"INNER_BULL 50","INNER_BULL"),X(!1)},children:"50"})]}),t.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[t.jsx("input",{className:"input w-full max-w-sm",list:"autoscore-quick-list",placeholder:"Type or select (e.g., D16, T20, S5)",value:pt,onChange:e=>_s(e.target.value.toUpperCase()),onKeyDown:e=>{if(e.key==="Enter"){const s=pt.match(/^(S|D|T)(\d{1,2})$/);s&&Lt(parseInt(s[2],10),s[1])}}}),t.jsx("datalist",{id:"autoscore-quick-list",children:["D","S","T"].map(e=>Array.from({length:20},(s,n)=>n+1).map(s=>t.jsx("option",{value:`${e}${s}`},`${e}${s}`)))}),t.jsx("button",{className:"btn",disabled:!pt||p>=3,onClick:()=>{const e=pt.match(/^(S|D|T)(\d{1,2})$/);if(!e)return;const s=e[1],n=parseInt(e[2],10);Lt(n,s)},children:"Add"})]})]})]})})}),_t&&t.jsx("div",{className:"fixed inset-0 bg-black/60 z-[100]",role:"dialog","aria-modal":"true",children:t.jsxs("div",{className:"absolute inset-0 flex flex-col",children:[t.jsxs("div",{className:"p-3 md:p-4 flex items-center justify-between",children:[t.jsx("h3",{className:"text-xl md:text-2xl font-semibold",children:"Manual Correction"}),t.jsx("div",{className:"flex items-center gap-2",children:t.jsx("button",{className:"btn bg-slate-700 hover:bg-slate-800",onClick:()=>{Ie(!1)},children:"Close"})})]}),t.jsx("div",{className:"flex-1 p-3 md:p-4",children:t.jsxs("div",{className:"h-full grid grid-cols-1 lg:grid-cols-2 gap-4",children:[t.jsxs("div",{className:"card relative flex flex-col",children:[t.jsx("div",{className:"text-sm font-semibold mb-2",children:"Live Preview"}),t.jsx("div",{className:"relative flex-1 rounded-2xl overflow-hidden bg-black",children:t.jsx("canvas",{ref:ls,className:"absolute inset-0 w-full h-full"})})]}),t.jsxs("div",{className:"card flex flex-col",children:[t.jsx("div",{className:"text-sm opacity-80 mb-2",children:"Type a correction or replace the last dart. The preview updates live."}),t.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[t.jsx("span",{className:"font-semibold",children:"Last auto:"}),t.jsx("span",{children:z||"â€”"}),t.jsx("button",{className:"btn",onClick:bs,disabled:p>=3,children:"Add Auto Dart"})]}),t.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[t.jsx("input",{className:"input flex-[1.2]",placeholder:"Manual (T20, D16, 5, 25, 50)",value:_e,onChange:e=>pe(e.target.value),onKeyDown:e=>{e.key==="Enter"&&!e.shiftKey&&(e.preventDefault(),Et()),e.key==="Enter"&&e.shiftKey&&(e.preventDefault(),gs())}}),t.jsx("button",{className:"btn btn--ghost",onClick:gs,disabled:p===0,children:"Replace Last"}),t.jsx("button",{className:"btn",onClick:Et,disabled:p>=3,children:"Add"})]}),t.jsx("div",{className:"text-xs opacity-70 mb-4",children:"Press Enter to Add Â· Shift+Enter to Replace Last"}),t.jsxs("div",{className:"mb-4",children:[t.jsx("div",{className:"text-sm font-semibold mb-2",children:"Number pad"}),t.jsxs("div",{className:"grid grid-cols-3 gap-2 max-w-sm",children:[["7","8","9","4","5","6","1","2","3","0"].map(e=>t.jsx("button",{className:"btn text-lg",onClick:()=>{pe(s=>/^[SDT]/i.test(s)?s+e:(s||"")+e)},children:e},e)),t.jsx("button",{className:"btn bg-rose-600 hover:bg-rose-700 text-white",onClick:()=>pe(""),children:"Clear"}),t.jsx("button",{className:"btn bg-slate-600 hover:bg-slate-700 text-white",onClick:()=>pe(e=>(e||"").slice(0,-1)),children:"âŒ«"}),t.jsx("button",{className:"btn bg-emerald-600 hover:bg-emerald-700 text-white",onClick:()=>Et(),disabled:p>=3,children:"Enter"})]}),t.jsx("div",{className:"text-xs opacity-70 mt-2",children:"Tap numbers then press Enter to submit. Use D/T prefixes for doubles/trebles (e.g., D16)."})]}),t.jsxs("div",{className:"mt-auto",children:[t.jsx("div",{className:"text-sm font-semibold mb-2",children:"Quick entry"}),t.jsxs("div",{className:"flex flex-wrap gap-2 mb-3",children:[t.jsx("button",{className:"btn",disabled:p>=3,onClick:()=>{if(!je||!z||ne==="MISS"||se===0){const e=Le+1;_(e),e>=5&&ve(!0)}else _(0);ke(25,"BULL 25","BULL"),X(!1)},children:"25"}),t.jsx("button",{className:"btn",disabled:p>=3,onClick:()=>{if(!je||!z||ne==="MISS"||se===0){const e=Le+1;_(e),e>=5&&ve(!0)}else _(0);ke(50,"INNER_BULL 50","INNER_BULL"),X(!1)},children:"50"})]}),t.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[t.jsx("input",{className:"input w-full max-w-sm",list:"manual-quick-list",placeholder:"Type or select (e.g., D16, T20, S5)",value:vt,onChange:e=>$s(e.target.value.toUpperCase()),onKeyDown:e=>{if(e.key==="Enter"){const s=vt.match(/^(S|D|T)(\d{1,2})$/);s&&Lt(parseInt(s[2],10),s[1])}}}),t.jsx("datalist",{id:"manual-quick-list",children:["D","S","T"].map(e=>Array.from({length:20},(s,n)=>n+1).map(s=>t.jsx("option",{value:`${e}${s}`},`${e}${s}`)))}),t.jsx("button",{className:"btn",disabled:!vt||p>=3,onClick:()=>{const e=vt.match(/^(S|D|T)(\d{1,2})$/);if(!e)return;const s=e[1],n=parseInt(e[2],10);Lt(n,s)},children:"Add"})]})]})]})]})})]})}),Fs&&t.jsx("div",{className:"fixed inset-0 bg-black/60 z-[100] flex items-center justify-center",children:t.jsxs("div",{className:"card w-full max-w-4xl relative text-left bg-[#2d2250] text-white p-6 rounded-xl shadow-xl",children:[t.jsx("button",{className:"absolute top-2 right-2 btn px-2 py-1 bg-purple-500 text-white font-bold",onClick:()=>is(!1),children:"Close"}),t.jsx("h2",{className:"text-xl font-bold mb-4 flex items-center gap-2 text-white",children:"Scoring"}),t.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[t.jsxs("div",{className:"bg-black/30 rounded-2xl p-4",children:[t.jsx("h2",{className:"text-lg font-semibold mb-3",children:"Camera"}),t.jsxs(Ls,{storageKey:"ndn:camera:size:modal",className:"relative rounded-2xl overflow-hidden bg-black",defaultWidth:480,defaultHeight:360,minWidth:360,minHeight:270,maxWidth:800,maxHeight:600,children:[t.jsx(ms,{}),(()=>{const s=(qe.getState().cameraFitMode||"fit")==="fit"?"absolute inset-0 w-full h-full object-contain object-center bg-black":"absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 min-w-full min-h-full w-auto h-auto object-cover object-center bg-black",n=()=>t.jsxs("div",{className:"relative w-full aspect-[4/3] bg-black",children:[t.jsx("video",{ref:m,className:s,playsInline:!0,"webkit-playsinline":"true",muted:!0,autoPlay:!0}),t.jsx("canvas",{ref:ue,className:"absolute inset-0 w-full h-full",onClick:hs}),t.jsxs("div",{className:"absolute top-2 left-1/2 -translate-x-1/2 z-20 flex items-center gap-3","aria-label":`Visit status: ${j[0]?j[0].value>0?"hit":"miss":"pending"}, ${j[1]?j[1].value>0?"hit":"miss":"pending"}, ${j[2]?j[2].value>0?"hit":"miss":"pending"}`,children:[[0,1,2].map(l=>{const f=j[l],d=!f,o=!!f&&(typeof f.value=="number"?f.value>0:!0),h=d?"bg-gray-500/70":o?"bg-emerald-400":"bg-rose-500";return t.jsx("span",{className:`w-3 h-3 rounded-full shadow ${h}`},l)}),ot&&st!==null&&t.jsxs("span",{className:"px-2 py-0.5 rounded bg-black/60 text-white text-xs font-semibold",children:[Math.max(0,st),"s"]})]}),Y&&O?t.jsx("div",{className:"absolute bottom-3 left-1/2 -translate-x-1/2 z-20 bg-black/70 text-amber-200 text-xs font-semibold px-3 py-1 rounded-full shadow",children:"Remove darts to continue"}):null]});return xe?P?n():t.jsx("div",{className:"w-full h-full flex flex-col items-center justify-center bg-gradient-to-br from-blue-900/50 to-purple-900/50",children:t.jsxs("div",{className:"text-center space-y-3 max-w-xs mx-auto",children:[t.jsx("div",{className:"text-4xl",children:"ðŸ“±"}),t.jsx("div",{className:"text-lg font-semibold text-blue-100",children:"Phone camera selected"}),t.jsx("p",{className:"text-sm text-slate-300",children:"Start streaming from the Calibrator tab or reconnect below."}),t.jsxs("div",{className:"flex items-center justify-center gap-2 flex-wrap",children:[t.jsx("button",{className:"btn bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 text-sm",onClick:Ct,children:"Reconnect Phone"}),t.jsx("button",{className:"btn bg-slate-700 hover:bg-slate-800 text-white px-3 py-1 text-sm",onClick:()=>{try{I.setShowOverlay?.(!0)}catch{}},children:"Show Overlay"}),t.jsx("button",{className:"btn bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-1 text-sm",onClick:St,disabled:!W.length,children:"Use Local Camera"})]})]})}):n()})()]}),t.jsxs("div",{className:"flex flex-wrap items-center gap-2 mt-3",children:[xe?t.jsxs(t.Fragment,{children:[t.jsx("div",{className:`text-sm px-3 py-2 rounded border flex-1 min-w-[200px] ${P?"bg-emerald-500/10 border-emerald-400/40 text-emerald-100":"bg-amber-500/10 border-amber-400/40 text-amber-100"}`,children:P?"ðŸ“± Phone camera stream active":"ðŸ“± Waiting for phone camera stream"}),t.jsx("button",{className:"btn bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 text-sm",onClick:Ct,children:"Reconnect Phone"}),t.jsx("button",{className:"btn bg-slate-700 hover:bg-slate-800 text-white px-3 py-1 text-sm",onClick:()=>{try{I.setShowOverlay?.(!I.showOverlay)}catch{}},children:I.showOverlay?"Hide Overlay":"Show Overlay"}),t.jsx("button",{className:"btn bg-rose-600 hover:bg-rose-700 text-white px-3 py-1 text-sm",disabled:!P,onClick:()=>{try{I.clearSession?.()}catch{}},children:"Stop Phone Feed"}),us&&t.jsx("button",{className:"btn bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-1 text-sm",onClick:St,disabled:!W.length,children:"Use Local Camera"})]}):t.jsx(t.Fragment,{children:de?t.jsx("button",{className:"btn bg-gradient-to-r from-rose-600 to-rose-700 text-white font-bold",onClick:jt,children:"Stop Camera"}):t.jsx("button",{className:"btn bg-gradient-to-r from-purple-500 to-purple-700 text-white font-bold",onClick:dt,children:"Connect Camera"})}),t.jsx("button",{className:"btn bg-gradient-to-r from-indigo-500 to-indigo-700 text-white font-bold",onClick:ds,disabled:!Ne,children:"Capture Still"}),t.jsx("button",{className:"btn bg-gradient-to-r from-slate-600 to-slate-800 text-white font-bold",disabled:!Ne,onClick:()=>{ut.current=null,os(e=>e+1)},children:"Reset Autoscore Background"}),t.jsx("button",{className:"btn bg-gradient-to-r from-slate-500 to-slate-700 text-white font-bold",onClick:()=>{try{window.dispatchEvent(new Event("ndn:camera-reset"))}catch{}},children:"Reset Camera Size"})]})]}),t.jsxs("div",{className:"bg-black/30 rounded-2xl p-4",children:[t.jsx("h2",{className:"text-lg font-semibold mb-3",children:"Pending Visit"}),t.jsx("div",{className:"text-sm opacity-80 mb-2",children:"Up to 3 darts per visit."}),t.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[[0,1,2].map(e=>{const s=j[e],n=!s,l=!!s&&(typeof s.value=="number"?s.value>0:!0),f=n?"bg-gray-500/70":l?"bg-emerald-400":"bg-rose-500";return t.jsx("span",{className:`w-2.5 h-2.5 rounded-full shadow ${f}`},e)}),ot&&st!==null&&t.jsxs("span",{className:"ml-2 px-2 py-0.5 rounded bg-black/40 text-white text-xs font-semibold",children:[Math.max(0,st),"s"]})]}),t.jsx("ul",{className:"text-sm mb-2 list-disc pl-5",children:j.length===0?t.jsx("li",{className:"opacity-60",children:"No darts yet"}):j.map((e,s)=>t.jsx("li",{children:e.label},s))}),t.jsxs("div",{className:"flex items-center gap-4 mb-2",children:[t.jsxs("div",{className:"font-semibold",children:["Darts: ",p,"/3"]}),t.jsxs("div",{className:"font-semibold",children:["Total: ",Ce]})]}),t.jsxs("div",{className:"flex gap-2",children:[t.jsx("button",{className:"btn bg-gradient-to-r from-purple-500 to-purple-700 text-white font-bold",onClick:qs,disabled:p===0,children:"Undo Dart"}),t.jsx("button",{className:"btn bg-gradient-to-r from-emerald-500 to-emerald-700 text-white font-bold",onClick:Ys,disabled:p===0,children:"Commit Visit"}),t.jsx("button",{className:"btn bg-gradient-to-r from-slate-500 to-slate-700 text-white font-bold",onClick:Is,disabled:p===0,children:"Clear"})]})]})]})]})}),Vs&&t.jsx("div",{className:"fixed inset-0 bg-black/60 z-50 flex items-center justify-center",children:t.jsxs("div",{className:"card max-w-md w-full relative text-left bg-[#2d2250] text-white p-6 rounded-xl shadow-xl",children:[t.jsx("button",{className:"absolute top-2 right-2 btn px-2 py-1 bg-purple-500 text-white font-bold",onClick:()=>{ve(!1),_(0)},children:"Close"}),t.jsx("h3",{className:"text-xl font-bold mb-2 flex items-center gap-2 text-white",children:"Recalibration Recommended"}),t.jsx("div",{className:"mb-4 text-lg font-semibold text-indigo-200",children:"We detected 3 incorrect autoscores in a row. You can recalibrate now or reset calibration and try again."}),t.jsxs("div",{className:"flex gap-2",children:[t.jsx("button",{className:"btn bg-gradient-to-r from-purple-500 to-purple-700 text-white font-bold",onClick:Hs,children:"Go to Calibrate"}),t.jsx("button",{className:"btn bg-gradient-to-r from-slate-500 to-slate-700 text-white font-bold",onClick:Ws,children:"Reset Calibration"}),t.jsx("button",{className:"btn bg-gradient-to-r from-slate-500 to-slate-700 text-white font-bold",onClick:()=>{ve(!1),_(0)},children:"Dismiss"})]})]})})]})}const Sn=Object.freeze(Object.defineProperty({__proto__:null,default:wn},Symbol.toStringTag,{value:"Module"}));export{wn as C,Ls as R,mn as a,Sn as b,dn as u};
//# sourceMappingURL=CameraView-C1ehnpRI.js.map
