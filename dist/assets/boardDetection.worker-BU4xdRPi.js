(function(){"use strict";const a={bullInner:6.35,bullOuter:15.9,trebleInner:99,trebleOuter:107,doubleInner:162,doubleOuter:170};function T(t,s){const o=s.x,n=s.y,u=t[6]*o+t[7]*n+t[8],e=(t[0]*o+t[1]*n+t[2])/u,l=(t[3]*o+t[4]*n+t[5])/u;return{x:e,y:l}}function V(t,s){if(t.length<4||s.length<4)throw new Error("Need at least 4 correspondences");if(t.length!==s.length)throw new Error("Correspondences must have equal length");const o=[],n=[];for(let l=0;l<t.length;l++){const{x:r,y:b}=t[l],{x:d,y}=s[l];o.push([r,b,1,0,0,0,-d*r,-d*b]),n.push(d),o.push([0,0,0,r,b,1,-y*r,-y*b]),n.push(y)}const u=X(o,n);return[u[0],u[1],u[2],u[3],u[4],u[5],u[6],u[7],1]}function X(t,s){const o=t.length,n=t[0].length,u=Array.from({length:n},()=>new Array(n).fill(0)),e=new Array(n).fill(0);for(let l=0;l<o;l++)for(let r=0;r<n;r++){e[r]+=t[l][r]*s[l];for(let b=0;b<n;b++)u[r][b]+=t[l][r]*t[l][b]}return Y(u,e)}function Y(t,s){const o=s.length,n=t.map((e,l)=>e.concat([s[l]]));for(let e=0;e<o;e++){let l=e;for(let r=e+1;r<o;r++)Math.abs(n[r][e])>Math.abs(n[l][e])&&(l=r);if(Math.abs(n[l][e])<1e-12)throw new Error("Singular matrix");if(l!==e){const r=n[e];n[e]=n[l],n[l]=r}for(let r=e+1;r<o;r++){const b=n[r][e]/n[e][e];for(let d=e;d<=o;d++)n[r][d]-=b*n[e][d]}}const u=new Array(o).fill(0);for(let e=o-1;e>=0;e--){let l=n[e][o];for(let r=e+1;r<o;r++)l-=n[e][r]*u[r];u[e]=l/n[e][e]}return u}function W(t,s,o){let n=0;for(let u=0;u<s.length;u++){const e=T(t,s[u]),l=e.x-o[u].x,r=e.y-o[u].y;n+=l*l+r*r}return Math.sqrt(n/s.length)}const z=t=>!!t&&Number.isFinite(t.x)&&Number.isFinite(t.y),G=t=>Array.isArray(t)&&t.length===9&&t.every(Number.isFinite);function J(t){const s=t.getContext("2d");if(!s)return null;const o=t.width,n=t.height,e=s.getImageData(0,0,o,n).data,l=[],r=Math.round(Math.max(8,Math.min(32,(o+n)/120))),b=new Float32Array(o*n);for(let c=0;c<n;c++)for(let i=0;i<o;i++){const h=(c*o+i)*4;b[c*o+i]=e[h]*.299+e[h+1]*.587+e[h+2]*.114}const d=new Float32Array(o*n);for(let c=1;c<n-1;c++)for(let i=1;i<o-1;i++){let h=0;for(let f=-1;f<=1;f++)for(let M=-1;M<=1;M++)h+=b[(c+f)*o+(i+M)];d[c*o+i]=h/9}for(let c=2;c<n-2;c++)for(let i=2;i<o-2;i++){let h=0,f=0;for(let g=-1;g<=1;g++)for(let R=-1;R<=1;R++){const _=d[(c+g)*o+(i+R)];R!==0&&(h+=(R>0?1:-1)*_),g!==0&&(f+=(g>0?1:-1)*_)}const M=Math.hypot(h,f);M>r&&l.push({x:i,y:c,mag:M})}if(l.length===0)return null;const y=Math.max(3,Math.round(o*n/(640*480)*10));let I=null,m=0,P=0;const w=Math.max(6,Math.round(Math.min(o,n)/40));for(let c=Math.round(n*.3);c<Math.round(n*.7);c+=w)for(let i=Math.round(o*.3);i<Math.round(o*.7);i+=w){let h=0,f=0;const g=Math.min(o,n)*.45/a.doubleOuter,R=[a.bullInner*g,a.bullOuter*g,a.trebleInner*g,a.trebleOuter*g,a.doubleInner*g,a.doubleOuter*g],_=Math.round(Math.min(Math.min(i,o-i),Math.min(c,n-c))),C=new Float32Array(_+1);let F=0;for(const x of l){const O=Math.round(Math.hypot(x.x-i,x.y-c));O<=0||O>_||(C[O]+=x.mag,C[O]>F&&(F=C[O]))}const j=[],Z=Math.max(12,F*.08);for(let x=2;x<_-2;x++){const O=C[x];O<=Z||O>C[x-1]&&O>=C[x+1]&&j.push(x)}for(const x of R){const O=Math.max(3,Math.round(x*.02));let $=-1,v=1/0;for(const L of j){const q=Math.abs(L-x);q<v&&(v=q,$=L)}$>=0&&v<=O&&(h++,f+=C[$]||0)}h>=3&&f>m&&(m=f,I={cx:i,cy:c},P=h)}if(!I)return null;const S=I.cx,p=I.cy,A=Math.min(o,n)*.45,D=Math.max(6,Math.round(A*.5)),B=Math.min(Math.round(Math.max(o,n)-4),Math.round(A*1.5));let E=Math.round(A),N=0;for(let c=D;c<=B;c+=Math.max(2,Math.round((B-D)/60))){let i=0,h=0;for(const f of l){const M=Math.hypot(f.x-S,f.y-p),g=Math.max(2,Math.round(c*.01));Math.abs(M-c)<g&&(i+=f.mag,h++)}h>Math.max(6,Math.round(y*.6))&&i>N&&(N=i,E=c)}let k=0;const U=E/a.doubleOuter;for(const c of[a.bullInner,a.bullOuter,a.trebleInner,a.trebleOuter,a.doubleInner,a.doubleOuter]){const i=c*U;for(const h of l){const f=Math.hypot(h.x-S,h.y-p),M=Math.max(3,Math.round(i*.02));if(Math.abs(f-i)<M){k+=15;break}}}return k=Math.min(100,k),{cx:S,cy:p,r:E,confidence:k,ringCount:P,ringStrength:Math.round(m)}}function K(t){try{const s=t.width,o=t.height,n=s/2,u=o/2,e=J(t);if(!e)return{success:!1,cx:n,cy:u,bullInner:0,bullOuter:0,trebleInner:0,trebleOuter:0,doubleInner:0,doubleOuter:0,confidence:0,homography:null,errorPx:null,calibrationPoints:[],message:"No dartboard detected. Ensure board is clearly visible with good contrast between rings and background."};const l=e.r/a.doubleOuter,r={cx:e.cx,cy:e.cy,bullInner:a.bullInner*l,bullOuter:a.bullOuter*l,trebleInner:a.trebleInner*l,trebleOuter:a.trebleOuter*l,doubleInner:a.doubleInner*l,doubleOuter:e.r},b=[{x:r.cx,y:r.cy-r.doubleOuter},{x:r.cx+r.doubleOuter,y:r.cy},{x:r.cx,y:r.cy+r.doubleOuter},{x:r.cx-r.doubleOuter,y:r.cy}],d=[{x:0,y:-a.doubleOuter},{x:a.doubleOuter,y:0},{x:0,y:a.doubleOuter},{x:-a.doubleOuter,y:0}];let y=null,I=null,m=e.confidence;try{y=V(d,b),I=W(y,d,b);const D=Math.max(10,Math.min(95,100-Math.max(0,I-1)*10));m=(m+D)/2}catch{m=Math.max(40,m)}const P=b.every(z),w=G(y),S=!!w&&P&&m>50,p=e.ringCount??0,A=e.ringStrength??0;return{success:S,cx:r.cx,cy:r.cy,bullInner:r.bullInner,bullOuter:r.bullOuter,trebleInner:r.trebleInner,trebleOuter:r.trebleOuter,doubleInner:r.doubleInner,doubleOuter:r.doubleOuter,confidence:m,homography:w?y:null,errorPx:w?I:null,calibrationPoints:P?b:[],message:!P||!w?`❌ Detection produced unstable calibration data. Adjust camera framing or calibrate manually. (rings: ${p}, r:${Math.round(e.r)})`:m>80?`✅ High confidence detection (rings: ${p}, r:${Math.round(e.r)})`:m>50?`⚠️ Detection found but could be better (rings: ${p}, r:${Math.round(e.r)})`:`❌ Low confidence - try better lighting (rings: ${p}, r:${Math.round(e.r)})`}}catch(s){return{success:!1,cx:t.width/2,cy:t.height/2,bullInner:0,bullOuter:0,trebleInner:0,trebleOuter:0,doubleInner:0,doubleOuter:0,confidence:0,homography:null,errorPx:null,calibrationPoints:[],message:s instanceof Error?s.message:"Board detection failed"}}}function Q(t){if(t.confidence>70)return t;const s={bullInner_to_bullOuter:a.bullInner/a.bullOuter,bullOuter_to_trebleInner:a.bullOuter/a.trebleInner,trebleOuter_to_doubleInner:a.trebleOuter/a.doubleInner,doubleInner_to_doubleOuter:a.doubleInner/a.doubleOuter},o={bullInner_to_bullOuter:t.bullInner/t.bullOuter,bullOuter_to_trebleInner:t.bullOuter/t.trebleInner,trebleOuter_to_doubleInner:t.trebleOuter/t.doubleInner,doubleInner_to_doubleOuter:t.doubleInner/t.doubleOuter};let n=0,u=0;for(const[r,b]of Object.entries(s)){const d=o[r],y=Math.abs(d-b)/b;n+=y,u++}const e=n/u,l=Math.max(10,t.confidence-e*100);return{...t,confidence:l,message:l>70?"✅ High confidence detection":l>50?"⚠️ Rings detected but ratios off - may need refinement":"❌ Low confidence - try repositioning camera"}}self.onmessage=async t=>{try{const{type:s,bitmap:o}=t.data||{};if(s!=="detect"||!o)return;const n=new OffscreenCanvas(o.width,o.height),u=n.getContext("2d");if(!u){postMessage({error:"OffscreenCanvas context unavailable"});return}u.drawImage(o,0,0,n.width,n.height);let e=K(n);e=Q(e),postMessage({type:"result",detection:e})}catch(s){postMessage({error:s?.message||String(s)||"Worker error"})}}})();
//# sourceMappingURL=boardDetection.worker-BU4xdRPi.js.map
