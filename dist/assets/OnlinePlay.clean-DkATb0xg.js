import{G as E,u as oe,w as ce,j as e,H as ie,I as de,m as Z}from"./index-CQ32xty6.js";import{r,R as G}from"./ui-gqBJRRJB.js";import{G as me}from"./GameCalibrationStatus-DrVaDDtY.js";import{M as _}from"./MatchStartShowcase-DtmkGApf.js";import"./vendor-D3F3s8fL.js";function he({open:u,onClose:x,onCreate:S}){const[m]=r.useState(()=>document.createElement("div")),[d,C]=r.useState("X01"),[l,p]=r.useState("bestof"),[k,b]=r.useState(3),f=r.useRef(null),[g,y]=r.useState(0),[N,M]=r.useState(()=>E(d)?.[0]),j=oe().username||"Anonymous";r.useLayoutEffect(()=>(m.className="ndn-create-match-portal",document.body.appendChild(m),()=>{try{m&&m.remove()}catch{}}),[m]),r.useLayoutEffect(()=>{function s(c){c.key==="Escape"&&x()}return u&&document.addEventListener("keydown",s),()=>document.removeEventListener("keydown",s)},[u,x]);const n=()=>{S({createdBy:j,game:d,modeType:l,legs:k,avgChoice:g,startingScore:N}),x()};return!u||!m?null:ce.createPortal(e.jsxs("div",{className:"fixed inset-0 z-60 flex items-center justify-center bg-black/60 p-4",children:[e.jsx("button",{"aria-label":"Close dialog",className:"absolute inset-0 w-full h-full bg-transparent",onClick:x}),e.jsxs("div",{className:"card rounded-xl p-6 max-w-lg w-full relative text-white",role:"dialog",children:[e.jsx("button",{"aria-label":"Close",className:"absolute top-3 right-3 text-rose-400 font-bold",onClick:x,children:"✕"}),e.jsx("h2",{className:"text-lg font-semibold mb-3",children:"Create Match"}),e.jsxs("div",{className:"grid grid-cols-1 gap-3",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm opacity-80",children:"Created By"}),e.jsx("div",{className:"mt-1 p-2 bg-white/5 rounded text-white",children:j})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm opacity-80",htmlFor:"match-game",children:"Match Name (Game)"}),e.jsx("select",{id:"match-game",className:"w-full p-2 border border-white/10 bg-white/5 rounded text-white",value:d,onChange:s=>{const c=s.target.value;C(c);const J=E(c);M(J?.[0])},onPointerDown:s=>{s.stopPropagation()},onMouseDown:s=>{s.stopPropagation()},onTouchStart:s=>{s.stopPropagation?.()},children:ie.map(s=>e.jsx("option",{value:s,children:s},s))})]}),E(d).length>0?e.jsxs("div",{children:[e.jsx("label",{className:"text-sm opacity-80",htmlFor:"match-start",children:`${d} Starting Score`}),e.jsx("select",{id:"match-start",className:"ml-2 p-2 border border-white/10 bg-white/5 rounded text-white w-full",value:N,onChange:s=>M(Number(s.target.value)),onPointerDown:s=>{s.stopPropagation()},onMouseDown:s=>{s.stopPropagation()},onTouchStart:s=>{s.stopPropagation?.()},children:E(d).map(s=>e.jsx("option",{value:s,children:s},s))})]}):null,e.jsxs("div",{children:[e.jsx("div",{className:"text-sm opacity-80",children:"Mode"}),e.jsxs("div",{className:"flex gap-2 mt-1 justify-center",children:[e.jsxs("label",{className:`btn ${l==="bestof"?"btn-primary":"btn-ghost"}`,children:[e.jsx("input",{type:"radio",name:"mode",value:"bestof",checked:l==="bestof",onChange:()=>{p("bestof"),b(s=>{const c=Math.max(1,s||3);return c%2===1?c:c+1}),setTimeout(()=>f.current?.focus(),0)},className:"sr-only"})," ","Best Of"]}),e.jsxs("label",{className:`btn ${l==="firstto"?"btn-primary":"btn-ghost"}`,children:[e.jsx("input",{type:"radio",name:"mode",value:"firstto",checked:l==="firstto",onChange:()=>{p("firstto"),b(s=>Math.max(1,s||3)),setTimeout(()=>f.current?.focus(),0)},className:"sr-only"})," ","First To"]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm opacity-80",htmlFor:"match-legs",children:l==="bestof"?"Best Of":"First To"}),e.jsx("input",{id:"match-legs",type:"number",min:1,value:k,onChange:s=>b(Math.max(1,Number(s.target.value||1))),ref:f,className:"w-full p-2 border border-white/10 bg-white/5 rounded text-white"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm opacity-80",htmlFor:"match-avg",children:"Average Choice (±)"}),e.jsx("input",{id:"match-avg",type:"number",value:g,onChange:s=>y(Number(s.target.value||0)),className:"w-full p-2 border border-white/10 bg-white/5 rounded text-white"})]})]}),e.jsx("div",{className:"flex justify-end mt-4",children:e.jsx("button",{className:"btn btn-primary",onClick:n,children:"Create Match"})})]})]}),m)}function je({user:u}){const x=u?.username||"You",[S,m]=r.useState(0),[d,C]=r.useState(()=>[{id:1,name:"room-1",matches:[]}]),l=(()=>{try{return de()}catch{return null}})(),[p,k]=r.useState([]),b=Z(t=>t.inProgress),f=Z(t=>t.players),[g,y]=r.useState(!1),N=G.useRef(!1);r.useEffect(()=>{b&&(N.current||(N.current=!0,y(!0)))},[b]);const[M,j]=r.useState(!1),[n,s]=r.useState(null),c=G.useRef(null),[J,ee]=r.useState(null),[te,q]=r.useState({}),[P,A]=r.useState(30),D=G.useRef(!1),[h,R]=r.useState(null),[L,T]=r.useState({}),[U,B]=r.useState(!1),[$,W]=r.useState(null),[Y,O]=r.useState(null),[z,H]=r.useState(null),[F,I]=r.useState(!1),w=d[S],K=12,X=r.useMemo(()=>p&&p.length?p:d.flatMap(t=>t.matches.map(a=>({...a,roomName:t.name}))),[d,p]),Q=r.useMemo(()=>{const t=w?.matches||[],a=new Set(t.map(i=>i.id)),o=(X||[]).filter(i=>!a.has(i.id));return[...t,...o]},[w,X]),se=t=>{const a={id:`m-${Date.now()}`,createdBy:t.createdBy||x,game:t.game,modeType:t.modeType,legs:t.legs,startingScore:t.startingScore,createdAt:Date.now()};C(o=>o.map((i,v)=>v===S?{...i,matches:[a,...i.matches]}:i));try{l?.connected&&l.send({type:"create-match",game:t.game,mode:t.modeType,value:t.legs,startingScore:t.startingScore,creatorAvg:t.avgChoice||0})}catch{}},ae=()=>{C(t=>{const a=t.length+1,o=[...t,{id:a,name:`room-${a}`,matches:[]}];return m(o.length-1),o})};r.useEffect(()=>l?(l.connected&&l.send({type:"list-matches"}),l.addListener(a=>{try{if(a?.type==="joined"&&a.id&&ee(a.id),a?.type==="presence")try{a.id&&q(o=>({...o,[a.id]:a.username||a.name||a.id}))}catch{}if(a?.type==="matches"&&k(a.matches||[]),a?.type==="match-prestart"){const o=a.match||null;o&&(o.prestartEndsAt=a.prestartEndsAt);try{o?.creatorId&&o?.creatorName&&q(v=>({...v,[o.creatorId]:o.creatorName}))}catch{}D.current=!0,s(o);const i=a.prestartEndsAt||Date.now();A(Math.max(0,Math.ceil(((i||Date.now())-Date.now())/1e3))),setTimeout(()=>{D.current=!1},0),R(null),T({}),B(!1),W(null),O(null)}if(a?.type==="match-start"&&n&&a.roomId===n.id&&(s(null),R(null),T({})),a?.type==="prestart-choice-notify"){const{roomId:o,playerId:i,choice:v}=a;if(!o||!v)return;T(le=>({...le||{},[i]:v}))}a?.type==="prestart-bull"&&(B(!0),I(!1),H(null)),a?.type==="prestart-bull-winner"&&(O(a.winnerId||null),B(!1),I(!1)),a?.type==="prestart-bull-tie"&&(O(null),B(!1),I(!1))}catch{}})):void 0,[l,h]),r.useEffect(()=>{if(!n||D.current||n.prestartEndsAt)return;A(30),R(null),T({});const t=setInterval(()=>A(a=>Math.max(0,a-1)),1e3);return()=>clearInterval(t)},[n]),r.useEffect(()=>{n&&setTimeout(()=>c.current?.focus(),0)},[n]);const re=()=>{try{l?.connected&&n?.id&&l.send({type:"invite-response",matchId:n.id,accept:!0,toId:n.creatorId})}catch{}s(null)},ne=t=>{s(t);try{l?.connected&&l.send({type:"join-match",matchId:t.id,calibrated:!0})}catch{}},V=t=>{R(t);try{l?.connected&&n?.id&&l.send({type:"prestart-choice",roomId:n.id,choice:t})}catch{}};return e.jsx("div",{className:"flex-1 min-h-0",style:{position:"relative",marginTop:0},children:e.jsxs("div",{className:"card ndn-game-shell relative overflow-hidden h-full flex flex-col",children:[g&&e.jsx(_,{players:f||[],user:u,onDone:()=>y(!1),onRequestClose:()=>y(!1)}),e.jsx("h2",{className:"text-3xl font-bold text-black dark:text-white mb-4",children:"Online Play"}),e.jsx("div",{className:"ndn-shell-body flex-1 overflow-hidden p-3 pb-0",children:e.jsxs("div",{className:"rounded-xl border border-slate-700 bg-black/10 p-3 flex-1 min-h-0 overflow-hidden flex flex-col",children:[e.jsxs("div",{className:"mb-3 p-3 rounded-xl bg-indigo-500/10 border border-indigo-500/40 flex items-center justify-between gap-2 flex-wrap",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("div",{className:"text-sm opacity-80",children:"Room"}),e.jsxs("div",{className:"px-3 py-1 bg-white/5 rounded border border-white/10",children:["Room (",w?.id,")"]}),e.jsx("div",{style:{width:12}}),e.jsx("button",{className:"btn btn-ghost",onClick:ae,children:"New Room"})]}),e.jsxs("div",{className:"shrink-0 flex items-center gap-2",children:[e.jsx("button",{className:"btn btn-primary",onClick:()=>j(!0),disabled:(w?.matches?.length||0)>=K,children:"Create Match +"}),(w?.matches?.length||0)>=K&&e.jsx("div",{className:"text-xs text-rose-400 mt-1",children:"Room full — create a new room"})]})]}),e.jsx("p",{className:"mb-2"}),e.jsxs("div",{className:"flex-1 overflow-auto",children:[e.jsx("h3",{className:"font-semibold underline mb-3",children:"Matches in this Room"}),e.jsx("div",{className:"mb-3 p-3 rounded-xl border border-slate-700 bg-black/10",children:e.jsx("div",{className:"mb-4",children:(Q.length||0)===0?e.jsx("div",{className:"text-sm opacity-60",children:"No matches in this room yet."}):e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3 max-h-[28rem] overflow-auto","data-testid":"matches-grid",children:Q.map(t=>e.jsxs("div",{className:"p-3 rounded border bg-black/10 flex items-start justify-between h-24","data-testid":`match-${t.id}`,children:[e.jsxs("div",{children:[e.jsxs("div",{className:"font-semibold text-sm",children:[t.game," ",t.modeType==="bestof"?"(Best Of)":"(First To)"," ","- ",t.legs," legs"]}),t.startingScore&&e.jsxs("div",{className:"text-xs opacity-80",children:["Starting:"," ",e.jsx("span",{className:"font-mono",children:t.startingScore})]}),e.jsxs("div",{className:"text-xs opacity-70 flex items-center gap-2",children:["Created by: ",t.createdBy,t.roomName&&e.jsxs("div",{className:"ml-2 inline-flex items-center gap-2 text-xs uppercase px-2 py-0.5 rounded-full bg-white/5 border border-white/10",children:["Room: ",t.roomName]})]})]}),e.jsx("div",{className:"ml-4 shrink-0",children:e.jsx("button",{className:"btn btn-sm",onClick:()=>ne(t),children:"Join Now!"})})]},t.id))})})})]})]})}),e.jsx(he,{open:M,onClose:()=>j(!1),onCreate:t=>{se(t),j(!1)}}),n&&e.jsx("div",{role:"dialog","aria-modal":"true","aria-labelledby":"join-heading",tabIndex:-1,className:"fixed inset-0 z-60 flex items-center justify-center bg-black/60 p-4",children:e.jsxs("div",{className:"bg-slate-800 rounded-2xl p-6 max-w-md w-full",children:[e.jsx("div",{id:"join-heading",className:"text-lg font-bold mb-2",children:"Join Match"}),e.jsxs("div",{className:"mb-3",children:[n.game," - ",n.modeType," • ",n.legs," legs"]}),e.jsxs("div",{className:"text-sm opacity-80 mb-3",children:["Created by ",n.createdBy]}),e.jsx("div",{className:"mb-3",children:e.jsx(me,{gameMode:n.game,compact:!0})}),n.startingScore&&e.jsxs("div",{className:"mb-3",children:["Starting score:"," ",e.jsx("span",{className:"font-mono",children:n.startingScore})]}),e.jsx(_,{open:g,players:f,user:u,onRequestClose:()=>{},onDone:()=>{}}),e.jsxs("div",{className:"mb-3",children:["Timer: ",e.jsxs("span",{className:"font-mono",children:[P,"s"]})]}),(P<=15||n?.prestartEndsAt)&&e.jsxs("div",{className:"mb-3",children:["Choose:"," ",e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{className:`btn ${h==="bull"?"btn-primary":"btn-ghost"}`,onClick:()=>V("bull"),children:"Bull Up"}),e.jsx("button",{className:`btn ${h==="skip"?"btn-primary":"btn-ghost"}`,onClick:()=>V("skip"),children:"Skip"})]}),e.jsx("div",{className:"text-xs opacity-70 mt-2",children:h?`You chose: ${h}`:"Please choose Bull Up or Skip before accepting"}),Object.keys(L).length>0&&e.jsx("div",{className:"text-xs opacity-70 mt-2",role:"status","aria-live":"polite",children:Object.entries(L).map(([t,a])=>e.jsxs("div",{children:[te[t]||t," chose: ",a]},t))}),h==="skip"&&e.jsx("div",{className:"text-xs opacity-70 mt-2",children:"Skip requires both players to click Skip. Waiting for other player…"}),h==="skip"&&Object.values(L).some(t=>t==="skip")&&e.jsx("div",{className:"text-sm font-semibold mt-2",children:"Both players skipped — Left player throws first"}),U&&e.jsxs("div",{className:"text-xs opacity-70 mt-2",children:["Bull Up active —",F?` you threw ${z??50}`:" throw to win the bull!"]}),U&&!F&&e.jsxs("div",{className:"flex items-center gap-2 mt-2",children:[e.jsx("input",{className:"input input-sm","aria-label":"bull-throw",type:"number",min:0,max:50,value:$??50,onChange:t=>W(Math.max(0,Math.min(50,Number(t.target.value||0))))}),e.jsx("button",{className:"btn btn-primary",onClick:()=>{try{l?.connected&&n?.id&&l.send({type:"prestart-bull-throw",roomId:n.id,score:$??50})}catch{}H($??50),I(!0)},children:"Throw Bull"})]}),F&&e.jsxs("div",{className:"text-sm font-semibold mt-2 animate-pulse",children:["You threw: ",z??50]}),Y&&e.jsxs("div",{className:"text-sm font-semibold mt-2",children:["Bull winner: ",Y]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{ref:c,"aria-label":"Accept invitation",className:"btn btn-primary",onClick:re,disabled:P<=15&&!h,children:"Accept"}),e.jsx("button",{className:"btn btn-ghost",onClick:()=>{s(null)},children:"Cancel"})]})]})})]})})}export{je as default};
//# sourceMappingURL=OnlinePlay.clean-DkATb0xg.js.map
