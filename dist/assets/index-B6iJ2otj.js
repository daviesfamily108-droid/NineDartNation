import{r as Ir,a as bo,g as ma}from"./vendor-D3F3s8fL.js";import{r as m,S as On,L as _l,M as an,a as Hl,U as br,T as na,C as go,P as Wl,R as zl,b as Ta,c as fi,d as ql,e as Vl,G as Gl,V as Jl,E as yo,f as Kl,g as vo,h as jo,i as Yl,j as Xl,k as Ql,X as Zl}from"./ui-Dx22kTqm.js";(function(){const a=document.createElement("link").relList;if(a&&a.supports&&a.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))i(n);new MutationObserver(n=>{for(const r of n)if(r.type==="childList")for(const o of r.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&i(o)}).observe(document,{childList:!0,subtree:!0});function s(n){const r={};return n.integrity&&(r.integrity=n.integrity),n.referrerPolicy&&(r.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?r.credentials="include":n.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function i(n){if(n.ep)return;n.ep=!0;const r=s(n);fetch(n.href,r)}})();var Ia={exports:{}},Rn={};/**
 * @license React
 * react-jsx-runtime.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var xi;function ec(){if(xi)return Rn;xi=1;var t=Ir(),a=Symbol.for("react.element"),s=Symbol.for("react.fragment"),i=Object.prototype.hasOwnProperty,n=t.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,r={key:!0,ref:!0,__self:!0,__source:!0};function o(l,d,c){var u,h={},x=null,p=null;c!==void 0&&(x=""+c),d.key!==void 0&&(x=""+d.key),d.ref!==void 0&&(p=d.ref);for(u in d)i.call(d,u)&&!r.hasOwnProperty(u)&&(h[u]=d[u]);if(l&&l.defaultProps)for(u in d=l.defaultProps,d)h[u]===void 0&&(h[u]=d[u]);return{$$typeof:a,type:l,key:x,ref:p,props:h,_owner:n.current}}return Rn.Fragment=s,Rn.jsx=o,Rn.jsxs=o,Rn}var pi;function tc(){return pi||(pi=1,Ia.exports=ec()),Ia.exports}var e=tc(),Zn={},bi;function sc(){if(bi)return Zn;bi=1;var t=bo();return Zn.createRoot=t.createRoot,Zn.hydrateRoot=t.hydrateRoot,Zn}var nc=sc();const ac=ma(nc);var gr=bo();const rc=ma(gr),No=t=>`ndn_online_quota_${t}`;function aa(t=new Date){const a=new Date(Date.UTC(t.getFullYear(),t.getMonth(),t.getDate())),s=a.getUTCDay()||7;a.setUTCDate(a.getUTCDate()+4-s);const i=new Date(Date.UTC(a.getUTCFullYear(),0,1)),n=Math.ceil(((a.getTime()-i.getTime())/864e5+1)/7),r=String(n).padStart(2,"0");return`${a.getUTCFullYear()}-${r}`}function wo(t){try{const a=localStorage.getItem(No(t));if(!a)return{week:aa(),used:0};const s=JSON.parse(a),i=aa();return!s.week||s.week!==i?{week:i,used:0}:{week:String(s.week),used:Number(s.used)||0}}catch{return{week:aa(),used:0}}}function ic(t,a){try{localStorage.setItem(No(t),JSON.stringify(a))}catch{}}function gi(t,a=3){const s=aa(),i=wo(t),n={week:s,used:(i.week===s?i.used:0)+1};return ic(t,n),n}function So(t,a=3){const s=wo(t);return Math.max(0,a-(s.used||0))}const Co={BASE_URL:"/",DEV:!1,MODE:"production",PROD:!0,SSR:!1,VITE_API_URL:"http://localhost:8787",VITE_WS_URL:"ws://localhost:8787"},ko="ndn:isAdmin:v1";function Eo(){try{const t=localStorage.getItem(ko);return t?JSON.parse(t):{}}catch{return{}}}function oc(t,a){try{const s=Eo();s[(t||"").toLowerCase()]={v:a,ts:Date.now()},localStorage.setItem(ko,JSON.stringify(s))}catch{}}async function lc(t){const a=String(t||"").toLowerCase();if(!a)return!1;try{const n=String(Co?.VITE_OWNER_EMAIL||"").toLowerCase();if(n&&a===n)return!0}catch{}if(a==="daviesfamily108@gmail.com")return!0;try{const n=localStorage.getItem("ndn:forceAdmin");if(n==="1"||n==="true")return!0}catch{}const i=Eo()[a];if(i&&Date.now()-i.ts<300*1e3)return!!i.v;try{const o=!!(await(await fetch(`/api/admins/check?email=${encodeURIComponent(a)}`)).json().catch(()=>({})))?.isAdmin;return oc(a,o),o}catch{return!!i?.v}}function To(t){const a=String(t||"").toLowerCase(),[s,i]=m.useState(!1);return m.useEffect(()=>{let n=!0;if(!a){i(!1);return}try{const r=String(Co?.VITE_OWNER_EMAIL||"").toLowerCase(),o=(()=>{try{const l=localStorage.getItem("ndn:forceAdmin");return l==="1"||l==="true"}catch{return!1}})();if(r&&a===r){i(!0);return}if(o){i(!0);return}}catch{}if(a==="daviesfamily108@gmail.com"){i(!0);return}return lc(a).then(r=>{n&&i(!!r)}),()=>{n=!1}},[a]),s}const cc={},dc=5,mc={GBP:1,EUR:1.16,USD:1.26,AUD:1.92,NZD:2.08,CAD:1.73};function Io(t,a=dc){const s=(t||"GBP").toUpperCase(),i=mc[s]??1,n=a*i;try{return new Intl.NumberFormat(void 0,{style:"currency",currency:s}).format(n)}catch{return`${s} ${n.toFixed(2)}`}}function Mo(){try{const t=new Intl.NumberFormat().resolvedOptions(),a=String(t.locale).toLowerCase();return a.includes("-gb")?"GBP":a.includes("-ie")||a.includes("-de")||a.includes("-fr")||a.includes("-es")||a.includes("-it")||a.includes("-nl")?"EUR":a.includes("-us")?"USD":a.includes("-au")?"AUD":a.includes("-nz")?"NZD":a.includes("-ca")?"CAD":"GBP"}catch{return"GBP"}}const uc=cc?.VITE_DISCORD_INVITE_URL||"https://discord.gg/nCfT4hJz";let $s=null;function hc(){if($s)return $s;const t="http://localhost:8787".trim();if(t)return $s=t.replace(/\/$/,""),$s;if(typeof window<"u"){const{protocol:a,host:s,hostname:i}=window.location,n=`${a}//${s}`;return i.endsWith("onrender.com")||i==="localhost"||i==="127.0.0.1"?$s=n.replace(/\/$/,""):$s="https://ninedartnation.onrender.com",$s}return $s="https://ninedartnation.onrender.com",$s}function fc(t){if(/^https?:\/\//i.test(t))return t;const a=hc(),s=t.startsWith("/")?t:`/${t}`;return`${a}${s}`}function ra(t){return fc(t)}function kt(t,a){const s=ra(t);return fetch(s,a)}function xc(){if(typeof window>"u"||typeof window.fetch!="function")return;const t=window;if(t.__ndnApiPatched)return;const a=window.fetch.bind(window);window.fetch=(s,i)=>{try{if(typeof s=="string")return s.startsWith("/")?a(ra(s),i):a(s,i);if(s instanceof Request){const n=s.url.startsWith("/")?ra(s.url):s.url;if(n===s.url)return a(s,i);const r=new Request(n,s);return a(r,i)}if(s instanceof URL){const n=s.href.startsWith("/")?ra(s.href):s.href;return a(n,i)}}catch(n){console.warn("[API] Interceptor failed, falling back to original fetch",n)}return a(s,i)},t.__ndnApiPatched=!0}function pc(t){const a=[{key:"score",label:"Home",icon:Hl},{key:"online",label:"Online",icon:br},{key:"offline",label:"Offline",icon:na},{key:"tournaments",label:"Tournaments",icon:na},{key:"friends",label:"Friends",icon:br},{key:"stats",label:"Stats",icon:na},{key:"calibrate",label:"Calibrate",icon:go},{key:"settings",label:"Settings",icon:On}];return t?.fullAccess||a.push({key:"fullaccess",label:"PREMIUM £€$",icon:Wl}),a}function Do({active:t,onChange:a,user:s,className:i}){const n=pc(s),r=To(s?.email);if(r&&!n.some(p=>p.key==="admin")){const p=n.findIndex(S=>S.key==="settings"),g={key:"admin",label:"Admin",icon:On};p>=0?n.splice(p,0,g):n.push(g)}const[o,l]=m.useState(!1),[d,c]=m.useState(!1),u=s?.username&&!s?.fullAccess?So(s.username):1/0,[h,x]=m.useState({friendRequests:0,messages:0,tournaments:0});return m.useEffect(()=>{if(!s?.email)return;const p=async()=>{try{const[S,D]=await Promise.all([kt(`/api/friends/requests?email=${encodeURIComponent(s.email)}`),kt(`/api/friends/messages?email=${encodeURIComponent(s.email)}`)]),I=S.ok?await S.json():{requests:[]},E=(D.ok?await D.json():{messages:[]}).messages?.filter(A=>!A.read).length||0;x({friendRequests:I.requests?.length||0,messages:E,tournaments:0})}catch(S){console.error("Failed to fetch notifications:",S)}};p();const g=setInterval(p,3e4);return()=>clearInterval(g)},[s?.email]),m.useEffect(()=>{if(!o)return;const p=g=>{(g.key==="Escape"||g.key==="Enter")&&l(!1)};return document.addEventListener("keydown",p),()=>document.removeEventListener("keydown",p)},[o]),e.jsxs("aside",{className:`${s?.fullAccess?"premium-sidebar":""} sidebar glass ${i?"":"w-60"} p-2 sm:p-4 rounded-2xl ${i??"hidden sm:flex"} flex-col gap-2 overflow-y-auto overflow-x-hidden ${i?"":"fixed top-2 bottom-2 sm:top-4 sm:bottom-4"}`,children:[n.map(({key:p,label:g,icon:S})=>p==="admin"&&!r?null:e.jsxs("button",{className:`tab whitespace-nowrap flex items-center justify-start gap-3 ${t===p?"tab--active":"tab--inactive"} `,onClick:()=>a(p),title:g,style:{fontWeight:700,fontSize:"1.1rem",color:t===p?"#fff":"#E5E7EB",letterSpacing:"0.02em"},children:[e.jsx(S,{className:"w-6 h-6"}),e.jsxs("span",{className:"flex items-center gap-2",children:[g,p==="online"&&!s?.fullAccess&&u<=0&&e.jsxs("span",{title:"Weekly free games used",className:"inline-flex items-center gap-1 text-[0.65rem] px-2 py-0.5 rounded-full bg-rose-600 text-white",children:[e.jsx(_l,{className:"w-3 h-3"}),"Locked"]}),p==="friends"&&h.friendRequests>0&&e.jsx("span",{className:"inline-flex items-center justify-center w-5 h-5 text-xs font-bold text-white bg-orange-500 rounded-full",children:h.friendRequests>9?"9+":h.friendRequests}),p==="score"&&(h.messages>0||h.tournaments>0)&&e.jsx("span",{className:"inline-flex items-center justify-center w-5 h-5 text-xs font-bold text-white bg-orange-500 rounded-full",children:h.messages+h.tournaments>9?"9+":h.messages+h.tournaments})]})]},p)),e.jsxs("button",{className:"tab tab--compact whitespace-nowrap flex items-center justify-start gap-3 bg-[#5865F2] text-white mt-2",onClick:()=>l(!0),title:"BullseyeDartsLeague",style:{fontWeight:700,fontSize:"1.1rem",letterSpacing:"0.02em"},children:[e.jsx(an,{className:"w-6 h-6"}),e.jsx("span",{className:"truncate",children:"BullseyeDartsLeague"})]}),e.jsxs("button",{className:"tab tab--compact whitespace-nowrap flex items-center justify-start gap-3 bg-[#5865F2] text-white mt-1",onClick:()=>c(!0),title:"NineDartNation",style:{fontWeight:700,fontSize:"1.1rem",letterSpacing:"0.02em"},children:[e.jsx(an,{className:"w-6 h-6"}),e.jsx("span",{className:"truncate",children:"NineDartNation"})]}),o&&gr.createPortal(e.jsxs("div",{className:"fixed inset-0 z-[1000]",children:[e.jsx("div",{className:"absolute inset-0 bg-black/50",onClick:()=>l(!1),onTouchStart:()=>l(!1)}),e.jsx("div",{className:"absolute inset-0 flex items-center justify-center p-4",children:e.jsxs("div",{role:"dialog","aria-modal":"true",className:"card max-w-md w-full relative text-left p-6 rounded-xl",children:[e.jsx("button",{className:"absolute -top-3 -right-3 btn px-3 py-1","aria-label":"Close",onClick:()=>l(!1),children:"✕"}),e.jsxs("h3",{className:"text-xl font-bold mb-2 flex items-center gap-2 text-[#8ea1e1]",children:[e.jsx(an,{className:"w-6 h-6"})," BullseyeDartsLeague"]}),e.jsx("div",{className:"mb-4 text-lg font-semibold",children:"Join this fantastic Online Darts League with divisions and other cool stuff included"}),e.jsx("a",{href:uc,target:"_blank",rel:"noopener noreferrer nofollow",className:"btn bg-[#5865F2] text-white w-full font-bold text-lg",children:"Join Discord"})]})})]}),document.body),d&&gr.createPortal(e.jsxs("div",{className:"fixed inset-0 z-[1000]",children:[e.jsx("div",{className:"absolute inset-0 bg-black/50",onClick:()=>c(!1),onTouchStart:()=>c(!1)}),e.jsx("div",{className:"absolute inset-0 flex items-center justify-center p-4",children:e.jsxs("div",{role:"dialog","aria-modal":"true",className:"card max-w-md w-full relative text-left p-6 rounded-xl",children:[e.jsx("button",{className:"absolute -top-3 -right-3 btn px-3 py-1","aria-label":"Close",onClick:()=>c(!1),children:"✕"}),e.jsxs("h3",{className:"text-xl font-bold mb-2 flex items-center gap-2 text-[#8ea1e1]",children:[e.jsx(an,{className:"w-6 h-6"})," NineDartNation"]}),e.jsx("div",{className:"mb-4 text-lg font-semibold",children:"Join the NineDartNation Discord community"}),e.jsx("a",{href:"https://discord.gg/Q33J5FTVve",target:"_blank",rel:"noopener noreferrer nofollow",className:"btn bg-[#5865F2] text-white w-full font-bold text-lg",children:"Join Discord"})]})})]}),document.body)]})}const bc={},yi=t=>{let a;const s=new Set,i=(u,h)=>{const x=typeof u=="function"?u(a):u;if(!Object.is(x,a)){const p=a;a=h??(typeof x!="object"||x===null)?x:Object.assign({},a,x),s.forEach(g=>g(a,p))}},n=()=>a,d={setState:i,getState:n,getInitialState:()=>c,subscribe:u=>(s.add(u),()=>s.delete(u)),destroy:()=>{(bc?"production":void 0)!=="production"&&console.warn("[DEPRECATED] The `destroy` method will be unsupported in a future version. Instead use unsubscribe function returned by subscribe. Everything will be garbage-collected if store is garbage-collected."),s.clear()}},c=a=t(i,n,d);return d},gc=t=>t?yi(t):yi;var Ma={exports:{}},Da={},Aa={exports:{}},Ra={};/**
 * @license React
 * use-sync-external-store-shim.production.js
 *
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var vi;function yc(){if(vi)return Ra;vi=1;var t=Ir();function a(h,x){return h===x&&(h!==0||1/h===1/x)||h!==h&&x!==x}var s=typeof Object.is=="function"?Object.is:a,i=t.useState,n=t.useEffect,r=t.useLayoutEffect,o=t.useDebugValue;function l(h,x){var p=x(),g=i({inst:{value:p,getSnapshot:x}}),S=g[0].inst,D=g[1];return r(function(){S.value=p,S.getSnapshot=x,d(S)&&D({inst:S})},[h,p,x]),n(function(){return d(S)&&D({inst:S}),h(function(){d(S)&&D({inst:S})})},[h]),o(p),p}function d(h){var x=h.getSnapshot;h=h.value;try{var p=x();return!s(h,p)}catch{return!0}}function c(h,x){return x()}var u=typeof window>"u"||typeof window.document>"u"||typeof window.document.createElement>"u"?c:l;return Ra.useSyncExternalStore=t.useSyncExternalStore!==void 0?t.useSyncExternalStore:u,Ra}var ji;function vc(){return ji||(ji=1,Aa.exports=yc()),Aa.exports}/**
 * @license React
 * use-sync-external-store-shim/with-selector.production.js
 *
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var Ni;function jc(){if(Ni)return Da;Ni=1;var t=Ir(),a=vc();function s(c,u){return c===u&&(c!==0||1/c===1/u)||c!==c&&u!==u}var i=typeof Object.is=="function"?Object.is:s,n=a.useSyncExternalStore,r=t.useRef,o=t.useEffect,l=t.useMemo,d=t.useDebugValue;return Da.useSyncExternalStoreWithSelector=function(c,u,h,x,p){var g=r(null);if(g.current===null){var S={hasValue:!1,value:null};g.current=S}else S=g.current;g=l(function(){function I(M){if(!N){if(N=!0,E=M,M=x(M),p!==void 0&&S.hasValue){var v=S.value;if(p(v,M))return A=v}return A=M}if(v=A,i(E,M))return v;var b=x(M);return p!==void 0&&p(v,b)?(E=M,v):(E=M,A=b)}var N=!1,E,A,O=h===void 0?null:h;return[function(){return I(u())},O===null?void 0:function(){return I(O())}]},[u,h,x,p]);var D=n(c,g[0],g[1]);return o(function(){S.hasValue=!0,S.value=D},[D]),d(D),D},Da}var wi;function Nc(){return wi||(wi=1,Ma.exports=jc()),Ma.exports}var wc=Nc();const Sc=ma(wc),Ao={},{useDebugValue:Cc}=zl,{useSyncExternalStoreWithSelector:kc}=Sc;let Si=!1;const Ec=t=>t;function Tc(t,a=Ec,s){(Ao?"production":void 0)!=="production"&&s&&!Si&&(console.warn("[DEPRECATED] Use `createWithEqualityFn` instead of `create` or use `useStoreWithEqualityFn` instead of `useStore`. They can be imported from 'zustand/traditional'. https://github.com/pmndrs/zustand/discussions/1937"),Si=!0);const i=kc(t.subscribe,t.getState,t.getServerState||t.getInitialState,a,s);return Cc(i),i}const Ci=t=>{(Ao?"production":void 0)!=="production"&&typeof t!="function"&&console.warn("[DEPRECATED] Passing a vanilla store will be unsupported in a future version. Instead use `import { useStore } from 'zustand'`.");const a=typeof t=="function"?gc(t):t,s=(i,n)=>Tc(a,i,n);return Object.assign(s,a),s},Zs=t=>t?Ci(t):Ci;let Ic=1;const yr=Zs(t=>({toasts:[],push:(a,s)=>t(i=>{const n=Ic++,r={id:n,message:a,type:s?.type||"info",timeout:s?.timeout??3e3};return r.timeout&&r.timeout>0&&setTimeout(()=>{t(o=>({toasts:o.toasts.filter(l=>l.id!==n)}))},r.timeout),{toasts:[...i.toasts,r]}}),remove:a=>t(s=>({toasts:s.toasts.filter(i=>i.id!==a)})),clear:()=>t({toasts:[]})}));function wn(){return yr(a=>a.push)}function ut(t){return(t??0).toFixed(2)}const Mc=t=>`ndn_stats_${t}`,Ro=t=>`ndn_stats_ts_${t}`;function ms(t){try{const a=localStorage.getItem(Mc(t));if(!a)return{darts:0,scored:0};const s=JSON.parse(a);return{darts:Number(s.darts)||0,scored:Number(s.scored)||0,fnDarts:Number(s.fnDarts)||0,fnScored:Number(s.fnScored)||0,best3:typeof s.best3=="number"?s.best3:0,worst3:typeof s.worst3=="number"?s.worst3:0,bestLegDarts:typeof s.bestLegDarts=="number"?s.bestLegDarts:0,bestCheckout:typeof s.bestCheckout=="number"?s.bestCheckout:0,worstLegDarts:typeof s.worstLegDarts=="number"?s.worstLegDarts:0,bestFNAvg:typeof s.bestFNAvg=="number"?s.bestFNAvg:0,worstFNAvg:typeof s.worstFNAvg=="number"?s.worstFNAvg:0}}catch{return{darts:0,scored:0}}}function Xs(t){const{darts:a,scored:s}=ms(t);return a?s/a*3:0}function Pa(t){const{fnDarts:a=0,fnScored:s=0}=ms(t);return a?s/a*3:0}const Po="ndn_game_mode_stats";function Mr(t){let a={};try{const s=localStorage.getItem(Po);s&&(a=JSON.parse(s))}catch{}if(Array.isArray(t))for(const s of t)a[s]||(a[s]={played:0,won:0});return a}function Dc(t){try{localStorage.setItem(Po,JSON.stringify(t)),window.dispatchEvent(new CustomEvent("ndn:stats-updated",{detail:{gameModes:!0}}))}catch{}}function Ac(t,a){const s=Mr(),i=s[t]||{played:0,won:0};i.played+=1,a&&(i.won+=1),s[t]=i,Dc(s)}function ua(t){try{const a=localStorage.getItem(Ro(t));if(!a)return[];const s=JSON.parse(a);return Array.isArray(s)?s.map(i=>({t:Number(i.t)||0,darts:Number(i.darts)||0,scored:Number(i.scored)||0,fnDarts:Number(i.fnDarts)||0,fnScored:Number(i.fnScored)||0})).filter(i=>i.t>0):[]}catch{return[]}}function Rc(t,a){try{localStorage.setItem(Ro(t),JSON.stringify(a)),window.dispatchEvent(new CustomEvent("ndn:stats-updated",{detail:{name:t}}))}catch{}}function Pc(t,a){const s=Date.now();return t.filter(i=>s-i.t<=a)}function rn(t,a,s,i=Date.now(),n,r){if(a<=0)return;const o=ua(t),l=Pc([...o,{t:i,darts:a,scored:s,fnDarts:n,fnScored:r}],1e3*60*60*24*30);Rc(t,l)}function Lc(t,a=1e3*60*60*24){const s=ua(t);if(!s.length)return 0;const i=Date.now();let n=0,r=0;for(const o of s)i-o.t<=a&&(n+=o.darts,r+=o.scored);return n<=0?0:r/n*3}function Oc(t,a=1e3*60*60*24*30){const s=ua(t);if(!s.length)return 0;const i=Date.now();let n=0,r=0;for(const o of s)i-o.t<=a&&(n+=o.fnDarts||0,r+=o.fnScored||0);return n<=0?0:r/n*3}function La(t){const s=ua(t);if(!s.length)return 0;const i=Date.now(),n=s.filter(c=>i-c.t<=2592e6),r=n.filter(c=>typeof c.fnDarts=="number"),o=r.length?r:n;let l=0,d=0;for(const c of o)l+=c.darts,d+=c.scored;return l<=0?0:d/l*3}function Oa(t){return Oc(t,2592e6)}const Lo="ndn_user_settings";function vr(){try{const t=localStorage.getItem(Lo);if(!t)return{favoriteDouble:"D16",callerEnabled:!0,callerVoice:"",callerVolume:1,speakCheckoutOnly:!1,avgMode:"all-time",autoStartOffline:!1,rememberLastOffline:!0,lastOffline:{mode:"X01",x01Start:501,firstTo:1,aiLevel:"None"},reducedMotion:!1,compactHeader:!1,allowSpectate:!0,cameraScale:1,cameraAspect:"wide",calibrationGuide:!0,preferredCameraId:void 0,preferredCameraLabel:void 0,cameraEnabled:!0,offlineLayout:"modern",autoscoreProvider:"built-in",autoscoreWsUrl:"",textSize:"medium",boxSize:"medium"};const a=JSON.parse(t);return{favoriteDouble:a.favoriteDouble||"D16",callerEnabled:typeof a.callerEnabled=="boolean"?a.callerEnabled:!0,callerVoice:a.callerVoice||"",callerVolume:typeof a.callerVolume=="number"?Math.max(0,Math.min(1,a.callerVolume)):1,speakCheckoutOnly:!!a.speakCheckoutOnly,avgMode:a.avgMode==="24h"?"24h":"all-time",autoStartOffline:!!a.autoStartOffline,rememberLastOffline:typeof a.rememberLastOffline=="boolean"?a.rememberLastOffline:!0,lastOffline:a.lastOffline&&typeof a.lastOffline=="object"?{mode:a.lastOffline.mode||"X01",x01Start:Number(a.lastOffline.x01Start)||501,firstTo:Number(a.lastOffline.firstTo)||1,aiLevel:a.lastOffline.aiLevel||"None"}:{mode:"X01",x01Start:501,firstTo:1,aiLevel:"None"},reducedMotion:!!a.reducedMotion,compactHeader:!!a.compactHeader,allowSpectate:typeof a.allowSpectate=="boolean"?a.allowSpectate:!0,cameraScale:typeof a.cameraScale=="number"&&isFinite(a.cameraScale)?Math.max(.5,Math.min(1.25,a.cameraScale)):1,cameraAspect:a.cameraAspect==="square"?"square":"wide",autoscoreProvider:a.autoscoreProvider==="external-ws"?"external-ws":a.autoscoreProvider==="manual"?"manual":"built-in",autoscoreWsUrl:typeof a.autoscoreWsUrl=="string"?a.autoscoreWsUrl:"",calibrationGuide:typeof a.calibrationGuide=="boolean"?a.calibrationGuide:!0,preferredCameraId:typeof a.preferredCameraId=="string"?a.preferredCameraId:void 0,preferredCameraLabel:typeof a.preferredCameraLabel=="string"?a.preferredCameraLabel:void 0,preferredCameraLocked:typeof a.preferredCameraLocked=="boolean"?a.preferredCameraLocked:!1,cameraEnabled:typeof a.cameraEnabled=="boolean"?a.cameraEnabled:!0,offlineLayout:a.offlineLayout==="classic"?"classic":"modern",textSize:a.textSize==="small"||a.textSize==="large"?a.textSize:"medium",boxSize:a.boxSize==="small"||a.boxSize==="large"?a.boxSize:"medium"}}catch{return{favoriteDouble:"D16",callerEnabled:!0,callerVoice:"",callerVolume:1,speakCheckoutOnly:!1,avgMode:"all-time",autoStartOffline:!1,rememberLastOffline:!0,lastOffline:{mode:"X01",x01Start:501,firstTo:1,aiLevel:"None"},reducedMotion:!1,compactHeader:!1,allowSpectate:!0,cameraScale:1,cameraAspect:"wide",calibrationGuide:!0,preferredCameraId:void 0,preferredCameraLabel:void 0,preferredCameraLocked:!1,cameraEnabled:!0,offlineLayout:"modern",autoscoreProvider:"built-in",autoscoreWsUrl:"",textSize:"medium",boxSize:"medium"}}}function Ct(t){try{const a=vr();localStorage.setItem(Lo,JSON.stringify({...a,...t}))}catch{}}const is=Zs((t,a)=>({...vr(),setFavoriteDouble:s=>{Ct({favoriteDouble:s}),t({favoriteDouble:s})},setCallerEnabled:s=>{Ct({callerEnabled:s}),t({callerEnabled:s})},setCallerVoice:s=>{Ct({callerVoice:s}),t({callerVoice:s})},setAvgMode:s=>{Ct({avgMode:s}),t({avgMode:s})},setCallerVolume:s=>{const i=Math.max(0,Math.min(1,s));Ct({callerVolume:i}),t({callerVolume:i})},setSpeakCheckoutOnly:s=>{Ct({speakCheckoutOnly:s}),t({speakCheckoutOnly:s})},setAutoStartOffline:s=>{Ct({autoStartOffline:s}),t({autoStartOffline:s})},setRememberLastOffline:s=>{Ct({rememberLastOffline:s}),t({rememberLastOffline:s})},setLastOffline:s=>{const n={...vr().lastOffline,...s};Ct({lastOffline:n}),t({lastOffline:n})},setReducedMotion:s=>{Ct({reducedMotion:s}),t({reducedMotion:s})},setCompactHeader:s=>{Ct({compactHeader:s}),t({compactHeader:s})},setAllowSpectate:s=>{Ct({allowSpectate:s}),t({allowSpectate:s})},setCameraScale:s=>{const i=Math.max(.5,Math.min(1.25,s));Ct({cameraScale:i}),t({cameraScale:i})},setCameraAspect:s=>{const i=s==="square"?"square":"wide";Ct({cameraAspect:i}),t({cameraAspect:i})},setAutoscoreProvider:s=>{Ct({autoscoreProvider:s}),t({autoscoreProvider:s})},setAutoscoreWsUrl:s=>{Ct({autoscoreWsUrl:s}),t({autoscoreWsUrl:s})},setCalibrationGuide:s=>{Ct({calibrationGuide:s}),t({calibrationGuide:s})},setPreferredCamera:(s,i,n=!1)=>{try{const r=a();if(console.log("[USERSETTINGS] setPreferredCamera called:",{id:s,label:i,force:n,locked:r.preferredCameraLocked}),r.preferredCameraLocked&&!n){console.log("[USERSETTINGS] Camera selection locked and force=false, ignoring update");return}}catch{}console.log("[USERSETTINGS] Saving preferred camera:",{id:s,label:i}),Ct({preferredCameraId:s,preferredCameraLabel:i}),t({preferredCameraId:s,preferredCameraLabel:i})},setPreferredCameraLocked:s=>{Ct({preferredCameraLocked:s}),t({preferredCameraLocked:s})},setCameraEnabled:s=>{Ct({cameraEnabled:s}),t({cameraEnabled:s})},setOfflineLayout:s=>{Ct({offlineLayout:s}),t({offlineLayout:s})},setTextSize:s=>{Ct({textSize:s}),t({textSize:s})},setBoxSize:s=>{Ct({boxSize:s}),t({boxSize:s})}}));function ea(t){try{window.dispatchEvent(new CustomEvent("ndn:change-tab",{detail:{tab:t}}))}catch{}}const Bc="http://localhost:8787";function Uc({user:t}){const[a,s]=m.useState(!1),[i,n]=m.useState(!1),[r,o]=m.useState(""),{lastOffline:l}=is(),d=wn();return m.useEffect(()=>{const c=["The fastest televised 9-darter took roughly 25 seconds!","A perfect leg (501) can be finished in nine darts.","The inner bull is worth 50; the outer bull is 25.","Standard dartboards are made from compressed sisal fibers.","Doubles and trebles are the thin outer and middle rings.","Professional oche (throw line) distance is 7 ft 9¼ in (2.37 m).","“Dartitis” is a real condition affecting a player’s throwing motion.","Phil Taylor holds a record number of World Championship titles.","Checkout routes often end on a double—classic “double-out”.","The highest 3-dart score is 180 (triple 20, triple 20, triple 20)."],u=Math.floor(Math.random()*c.length);o(c[u])},[]),e.jsxs("div",{className:`${t?.fullAccess?"premium-main":""} relative min-h-[600px] flex flex-col items-center justify-center overflow-hidden`,children:[e.jsxs("div",{className:"absolute inset-0 z-0",children:[e.jsx("div",{className:"w-full h-full bg-gradient-to-br from-purple-700 via-indigo-500 to-blue-600 opacity-60 blur-2xl"}),e.jsx("div",{className:"absolute top-20 left-1/4 w-40 h-40 bg-pink-400 rounded-full opacity-30 blur-2xl animate-pulse"}),e.jsx("div",{className:"absolute bottom-10 right-1/4 w-32 h-32 bg-blue-400 rounded-full opacity-30 blur-2xl animate-pulse"})]}),e.jsxs("div",{className:"relative z-10 w-full max-w-6xl mx-auto bg-white/10 backdrop-blur-lg rounded-2xl sm:rounded-3xl shadow-2xl p-4 sm:p-6 md:p-8 lg:p-10 flex flex-col items-center",children:[e.jsx("h2",{className:"text-2xl sm:text-4xl md:text-5xl lg:text-6xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-indigo-300 via-purple-400 to-blue-400 mb-2 sm:mb-3 md:mb-4 drop-shadow-xl text-center leading-tight",children:"Welcome to Nine Dart Nation"}),e.jsx("p",{className:"text-base sm:text-lg md:text-xl lg:text-2xl text-white/80 mb-2 font-semibold text-center px-2",children:"Your home for competitive darts, stats, and online play."}),e.jsx("p",{className:"text-xs sm:text-sm md:text-base lg:text-lg text-white/60 mb-3 sm:mb-4 italic text-center px-2",children:'"Where every dart counts and every player matters."'}),r&&e.jsx("div",{className:"w-full mb-4 sm:mb-6 px-2 sm:px-0",children:e.jsxs("div",{className:"mx-auto max-w-xs sm:max-w-xl rounded-full px-3 sm:px-5 py-2 text-center text-indigo-100 bg-gradient-to-r from-indigo-600/80 to-fuchsia-600/80 shadow-md",children:[e.jsx("span",{className:"font-semibold text-sm sm:text-base",children:"Did you know?"})," ",e.jsx("span",{className:"opacity-90 text-sm sm:text-base",children:r})]})}),e.jsxs("div",{className:"flex flex-wrap gap-3 sm:gap-4 md:gap-6 justify-center mb-6 md:mb-8 w-full max-w-4xl mx-auto",children:[e.jsxs("button",{onClick:()=>{ea("offline");try{window.dispatchEvent(new CustomEvent("ndn:offline-format",{detail:{formatType:"first",formatCount:Number(l?.firstTo)||1,startScore:Number(l?.x01Start)||501}}))}catch{}try{setTimeout(()=>{window.dispatchEvent(new CustomEvent("ndn:auto-start",{detail:{mode:l?.mode||"X01"}}))},50)}catch{}},className:"flex-1 min-w-[200px] sm:flex-none px-4 sm:px-6 md:px-8 py-3 md:py-4 rounded-full bg-gradient-to-r from-purple-500 to-indigo-500 text-white font-bold shadow-xl hover:scale-105 active:scale-95 transition-transform duration-150 flex items-center justify-center gap-2 text-base sm:text-lg md:text-xl touch-manipulation",children:[e.jsx("span",{"aria-hidden":!0,children:"🎯"})," Start New Match"]}),e.jsxs("button",{onClick:()=>ea("stats"),className:"flex-1 min-w-[200px] sm:flex-none px-4 sm:px-6 md:px-8 py-3 md:py-4 rounded-full bg-gradient-to-r from-blue-500 to-purple-500 text-white font-bold shadow-xl hover:scale-105 active:scale-95 transition-transform duration-150 flex items-center justify-center gap-2 text-base sm:text-lg md:text-xl touch-manipulation",children:[e.jsx("span",{"aria-hidden":!0,children:"📊"})," View Stats"]}),e.jsxs("button",{onClick:()=>ea("online"),className:"flex-1 min-w-[200px] sm:flex-none px-4 sm:px-6 md:px-8 py-3 md:py-4 rounded-full bg-gradient-to-r from-green-500 to-blue-400 text-white font-bold shadow-xl hover:scale-105 active:scale-95 transition-transform duration-150 flex items-center justify-center gap-2 text-base sm:text-lg md:text-xl touch-manipulation",children:[e.jsx("span",{"aria-hidden":!0,children:"🏆"})," Join Online League"]}),e.jsxs("button",{onClick:()=>{ea("offline");try{window.dispatchEvent(new CustomEvent("ndn:auto-start",{detail:{mode:"Double Practice"}}))}catch{}},className:"flex-1 min-w-[200px] sm:flex-none px-4 sm:px-6 md:px-8 py-3 md:py-4 rounded-full bg-gradient-to-r from-pink-500 to-indigo-500 text-white font-bold shadow-xl hover:scale-105 active:scale-95 transition-transform duration-150 flex items-center justify-center gap-2 text-base sm:text-lg md:text-xl touch-manipulation",children:[e.jsx("span",{"aria-hidden":!0,children:"💡"})," Practice Doubles"]})]}),(()=>{const c=t?.username||"Player 1",u=ms(c),h=!!t?.fullAccess,x="grid grid-cols-[120px,1fr,1fr] sm:grid-cols-[160px,1fr,1fr]",p=({label:g,left:S,right:D,lock:I})=>e.jsxs("div",{className:`relative ${x} gap-2 items-center p-2 rounded-lg ${I?"bg-white/5 border border-white/10 overflow-hidden":"bg-indigo-500/10 border border-indigo-500/40"} mb-2`,children:[e.jsx("div",{className:"text-[12px] opacity-80 pl-2 text-left",children:g}),e.jsx("div",{className:`text-sm font-semibold text-center ${I?"opacity-50 blur-[0.5px]":""}`,children:S}),e.jsx("div",{className:`text-sm font-semibold text-center ${I?"opacity-50 blur-[0.5px]":""}`,children:D}),I&&e.jsx("button",{className:"absolute inset-0 flex items-center justify-center rounded-lg bg-slate-900/35 hover:bg-slate-900/45 transition",onClick:async()=>{try{const E=await(await fetch(`${Bc}/api/stripe/create-checkout-session`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:t.email})})).json();E.ok&&E.url?window.location.href=E.url:E.error==="STRIPE_NOT_CONFIGURED"?d("Premium purchases are not available in this development environment. Please visit the production site to upgrade.",{type:"error",timeout:4e3}):d("Failed to create checkout session. Please try again.",{type:"error",timeout:4e3})}catch{d("Error creating checkout. Please try again.",{type:"error",timeout:4e3})}},title:"Unlock with PREMIUM",children:e.jsx("span",{className:"text-[12px] font-semibold",children:"Unlock PREMIUM"})})]});return e.jsxs("div",{className:"w-full mt-2 rounded-2xl p-2 sm:p-3 bg-white/5 border border-white/10 overflow-x-auto",children:[e.jsxs("div",{className:`${x} gap-2 mb-2 px-1 items-center min-w-[280px] sm:min-w-0`,children:[e.jsx("div",{className:"text-[12px] opacity-0 select-none",children:"label"}),e.jsx("div",{className:"text-[12px] font-semibold text-center",children:"BEST"}),e.jsx("div",{className:"text-[12px] font-semibold text-center",children:"WORST"})]}),e.jsx(p,{label:"3-dart avg",left:ut(u.best3||0),right:ut(u.worst3||0)}),e.jsx(p,{label:"9-dart avg",left:ut(u.bestFNAvg||0),right:ut(u.worstFNAvg||0),lock:!h}),e.jsx(p,{label:"Leg (darts)",left:String(u.bestLegDarts||0),right:String(u.worstLegDarts||0),lock:!h}),e.jsx(p,{label:"Checkout",left:String(u.bestCheckout||0),right:"—",lock:!h})]})})(),e.jsx("button",{className:"mt-6 sm:mt-8 md:mt-10 px-6 sm:px-8 md:px-10 py-3 md:py-4 rounded-full bg-gradient-to-r from-purple-500 to-indigo-500 text-white font-bold shadow-xl hover:scale-105 active:scale-95 transition-transform duration-150 text-base sm:text-lg md:text-xl touch-manipulation",onClick:()=>n(!0),children:"How to Play / Getting Started"})]}),e.jsx("footer",{className:"w-full py-2 md:py-2 text-center text-white/80 text-xs md:text-sm font-medium absolute bottom-0 left-0 z-20 flex items-center justify-center gap-1 md:gap-2",children:e.jsxs("button",{className:"flex items-center gap-1 md:gap-2 hover:text-white transition",onClick:()=>s(!0),children:[e.jsx("span",{children:"©"}),e.jsx("span",{style:{letterSpacing:"0.05em"},children:"NINEDARTNATION"})]})}),a&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50",children:e.jsxs("div",{className:"card max-w-lg w-full relative text-left bg-[#2d2250] text-white p-6 rounded-xl shadow-xl",children:[e.jsx("button",{className:"absolute top-2 right-2 btn px-2 py-1 bg-purple-500 text-white font-bold",onClick:()=>s(!1),children:"Close"}),e.jsx("h3",{className:"text-xl font-bold mb-2",children:"Legal Information"}),e.jsxs("ul",{className:"list-disc pl-5 mb-2",children:[e.jsx("li",{children:"Terms & Conditions: All users must follow fair play and site rules."}),e.jsx("li",{children:"Privacy Policy: Your data is protected and never shared without consent."}),e.jsxs("li",{children:["Copyright © ",new Date().getFullYear()," NINEDARTNATION. All rights reserved."]}),e.jsx("li",{children:"Contact: support@ninedartnation.com"})]}),e.jsx("p",{className:"text-sm text-purple-200",children:"For full legal details, please contact us or visit our legal page."})]})}),i&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50",children:e.jsxs("div",{className:"card max-w-lg w-full relative text-left bg-[#2d2250] text-white p-6 rounded-xl shadow-xl",children:[e.jsx("button",{className:"absolute top-2 right-2 btn px-2 py-1 bg-purple-500 text-white font-bold",onClick:()=>n(!1),children:"Close"}),e.jsx("h3",{className:"text-xl font-bold mb-2",children:"Getting Started"}),e.jsxs("ul",{className:"list-disc pl-5 mb-2",children:[e.jsx("li",{children:"Choose a game mode and invite friends or play solo."}),e.jsx("li",{children:"Track your stats and progress in the Stats tab."}),e.jsx("li",{children:"Join the BullseyeDartsLeague for online competition."}),e.jsx("li",{children:"Upgrade to PREMIUM for advanced features and modes."}),e.jsx("li",{children:"Need help? Visit the Settings tab for support and tips."})]}),e.jsx("p",{className:"text-sm text-purple-200",children:'Ready to play? Hit "Start New Match" and let the darts fly!'})]})})]})}function As({children:t,className:a,style:s}){const i=m.useRef(null);return m.useEffect(()=>{let n=0;const r=()=>{const d=i.current;if(!d)return;const c=document.getElementById("ndn-header");if(!c){d.style.clipPath="";return}const u=document.getElementById("ndn-main-scroll"),h=u?u.scrollTop:window.scrollY||0,x=c.getBoundingClientRect().height,p=h>0?x:0;d.style.marginTop=p>0?`${p}px`:"0px"};r();const o=()=>{n&&cancelAnimationFrame(n),n=requestAnimationFrame(r)},l=document.getElementById("ndn-main-scroll");return l?.addEventListener("scroll",o,{passive:!0}),window.addEventListener("scroll",o,{passive:!0}),window.addEventListener("resize",o),()=>{l?.removeEventListener("scroll",o),window.removeEventListener("scroll",o),window.removeEventListener("resize",o),n&&cancelAnimationFrame(n)}},[]),e.jsx("div",{ref:i,className:a,style:s,children:t})}const $c=({calibrationComplete:t})=>{const[a,s]=m.useState(!1),[i,n]=m.useState(!1);return m.useEffect(()=>{t?(s(!0),setTimeout(()=>n(!0),1200)):(s(!1),n(!1))},[t]),e.jsxs("div",{className:`flex flex-col items-center justify-center w-full h-full transition-opacity duration-700 ${i?"opacity-0":"opacity-100"}`,style:{pointerEvents:"none",position:"absolute",inset:0,zIndex:10},children:[e.jsxs("div",{className:"flex items-center justify-center",children:[e.jsx("svg",{width:"80",height:"80",viewBox:"0 0 80 80",className:`animate-spin-slow ${a?"opacity-0":"opacity-100"} transition-opacity duration-500`,style:{transition:"opacity 0.5s"},children:e.jsxs("g",{children:[e.jsx("rect",{x:"36",y:"10",width:"8",height:"40",rx:"3",fill:"#a78bfa"}),e.jsx("polygon",{points:"40,10 44,22 36,22",fill:"#f472b6"}),e.jsx("rect",{x:"36",y:"50",width:"8",height:"18",rx:"2",fill:"#22d3ee"}),e.jsx("polygon",{points:"36,68 44,68 40,78",fill:"#10b981"})]})}),a&&e.jsxs("svg",{width:"80",height:"80",viewBox:"0 0 80 80",className:"absolute",style:{left:0,top:0},children:[e.jsx("circle",{cx:"40",cy:"40",r:"32",fill:"none",stroke:"#10b981",strokeWidth:"6"}),e.jsx("polyline",{points:"28,44 38,54 54,30",fill:"none",stroke:"#10b981",strokeWidth:"6",strokeLinecap:"round",strokeLinejoin:"round"})]})]}),e.jsx("div",{className:"mt-4 text-lg font-semibold text-indigo-200",children:a?"Calibration Complete!":"Initializing Camera..."})]})};var jn={},Ba,ki;function Fc(){return ki||(ki=1,Ba=function(){return typeof Promise=="function"&&Promise.prototype&&Promise.prototype.then}),Ba}var Ua={},qs={},Ei;function ln(){if(Ei)return qs;Ei=1;let t;const a=[0,26,44,70,100,134,172,196,242,292,346,404,466,532,581,655,733,815,901,991,1085,1156,1258,1364,1474,1588,1706,1828,1921,2051,2185,2323,2465,2611,2761,2876,3034,3196,3362,3532,3706];return qs.getSymbolSize=function(i){if(!i)throw new Error('"version" cannot be null or undefined');if(i<1||i>40)throw new Error('"version" should be in range from 1 to 40');return i*4+17},qs.getSymbolTotalCodewords=function(i){return a[i]},qs.getBCHDigit=function(s){let i=0;for(;s!==0;)i++,s>>>=1;return i},qs.setToSJISFunction=function(i){if(typeof i!="function")throw new Error('"toSJISFunc" is not a valid function.');t=i},qs.isKanjiModeEnabled=function(){return typeof t<"u"},qs.toSJIS=function(i){return t(i)},qs}var $a={},Ti;function Dr(){return Ti||(Ti=1,(function(t){t.L={bit:1},t.M={bit:0},t.Q={bit:3},t.H={bit:2};function a(s){if(typeof s!="string")throw new Error("Param is not a string");switch(s.toLowerCase()){case"l":case"low":return t.L;case"m":case"medium":return t.M;case"q":case"quartile":return t.Q;case"h":case"high":return t.H;default:throw new Error("Unknown EC Level: "+s)}}t.isValid=function(i){return i&&typeof i.bit<"u"&&i.bit>=0&&i.bit<4},t.from=function(i,n){if(t.isValid(i))return i;try{return a(i)}catch{return n}}})($a)),$a}var Fa,Ii;function _c(){if(Ii)return Fa;Ii=1;function t(){this.buffer=[],this.length=0}return t.prototype={get:function(a){const s=Math.floor(a/8);return(this.buffer[s]>>>7-a%8&1)===1},put:function(a,s){for(let i=0;i<s;i++)this.putBit((a>>>s-i-1&1)===1)},getLengthInBits:function(){return this.length},putBit:function(a){const s=Math.floor(this.length/8);this.buffer.length<=s&&this.buffer.push(0),a&&(this.buffer[s]|=128>>>this.length%8),this.length++}},Fa=t,Fa}var _a,Mi;function Hc(){if(Mi)return _a;Mi=1;function t(a){if(!a||a<1)throw new Error("BitMatrix size must be defined and greater than 0");this.size=a,this.data=new Uint8Array(a*a),this.reservedBit=new Uint8Array(a*a)}return t.prototype.set=function(a,s,i,n){const r=a*this.size+s;this.data[r]=i,n&&(this.reservedBit[r]=!0)},t.prototype.get=function(a,s){return this.data[a*this.size+s]},t.prototype.xor=function(a,s,i){this.data[a*this.size+s]^=i},t.prototype.isReserved=function(a,s){return this.reservedBit[a*this.size+s]},_a=t,_a}var Ha={},Di;function Wc(){return Di||(Di=1,(function(t){const a=ln().getSymbolSize;t.getRowColCoords=function(i){if(i===1)return[];const n=Math.floor(i/7)+2,r=a(i),o=r===145?26:Math.ceil((r-13)/(2*n-2))*2,l=[r-7];for(let d=1;d<n-1;d++)l[d]=l[d-1]-o;return l.push(6),l.reverse()},t.getPositions=function(i){const n=[],r=t.getRowColCoords(i),o=r.length;for(let l=0;l<o;l++)for(let d=0;d<o;d++)l===0&&d===0||l===0&&d===o-1||l===o-1&&d===0||n.push([r[l],r[d]]);return n}})(Ha)),Ha}var Wa={},Ai;function zc(){if(Ai)return Wa;Ai=1;const t=ln().getSymbolSize,a=7;return Wa.getPositions=function(i){const n=t(i);return[[0,0],[n-a,0],[0,n-a]]},Wa}var za={},Ri;function qc(){return Ri||(Ri=1,(function(t){t.Patterns={PATTERN000:0,PATTERN001:1,PATTERN010:2,PATTERN011:3,PATTERN100:4,PATTERN101:5,PATTERN110:6,PATTERN111:7};const a={N1:3,N2:3,N3:40,N4:10};t.isValid=function(n){return n!=null&&n!==""&&!isNaN(n)&&n>=0&&n<=7},t.from=function(n){return t.isValid(n)?parseInt(n,10):void 0},t.getPenaltyN1=function(n){const r=n.size;let o=0,l=0,d=0,c=null,u=null;for(let h=0;h<r;h++){l=d=0,c=u=null;for(let x=0;x<r;x++){let p=n.get(h,x);p===c?l++:(l>=5&&(o+=a.N1+(l-5)),c=p,l=1),p=n.get(x,h),p===u?d++:(d>=5&&(o+=a.N1+(d-5)),u=p,d=1)}l>=5&&(o+=a.N1+(l-5)),d>=5&&(o+=a.N1+(d-5))}return o},t.getPenaltyN2=function(n){const r=n.size;let o=0;for(let l=0;l<r-1;l++)for(let d=0;d<r-1;d++){const c=n.get(l,d)+n.get(l,d+1)+n.get(l+1,d)+n.get(l+1,d+1);(c===4||c===0)&&o++}return o*a.N2},t.getPenaltyN3=function(n){const r=n.size;let o=0,l=0,d=0;for(let c=0;c<r;c++){l=d=0;for(let u=0;u<r;u++)l=l<<1&2047|n.get(c,u),u>=10&&(l===1488||l===93)&&o++,d=d<<1&2047|n.get(u,c),u>=10&&(d===1488||d===93)&&o++}return o*a.N3},t.getPenaltyN4=function(n){let r=0;const o=n.data.length;for(let d=0;d<o;d++)r+=n.data[d];return Math.abs(Math.ceil(r*100/o/5)-10)*a.N4};function s(i,n,r){switch(i){case t.Patterns.PATTERN000:return(n+r)%2===0;case t.Patterns.PATTERN001:return n%2===0;case t.Patterns.PATTERN010:return r%3===0;case t.Patterns.PATTERN011:return(n+r)%3===0;case t.Patterns.PATTERN100:return(Math.floor(n/2)+Math.floor(r/3))%2===0;case t.Patterns.PATTERN101:return n*r%2+n*r%3===0;case t.Patterns.PATTERN110:return(n*r%2+n*r%3)%2===0;case t.Patterns.PATTERN111:return(n*r%3+(n+r)%2)%2===0;default:throw new Error("bad maskPattern:"+i)}}t.applyMask=function(n,r){const o=r.size;for(let l=0;l<o;l++)for(let d=0;d<o;d++)r.isReserved(d,l)||r.xor(d,l,s(n,d,l))},t.getBestMask=function(n,r){const o=Object.keys(t.Patterns).length;let l=0,d=1/0;for(let c=0;c<o;c++){r(c),t.applyMask(c,n);const u=t.getPenaltyN1(n)+t.getPenaltyN2(n)+t.getPenaltyN3(n)+t.getPenaltyN4(n);t.applyMask(c,n),u<d&&(d=u,l=c)}return l}})(za)),za}var ta={},Pi;function Oo(){if(Pi)return ta;Pi=1;const t=Dr(),a=[1,1,1,1,1,1,1,1,1,1,2,2,1,2,2,4,1,2,4,4,2,4,4,4,2,4,6,5,2,4,6,6,2,5,8,8,4,5,8,8,4,5,8,11,4,8,10,11,4,9,12,16,4,9,16,16,6,10,12,18,6,10,17,16,6,11,16,19,6,13,18,21,7,14,21,25,8,16,20,25,8,17,23,25,9,17,23,34,9,18,25,30,10,20,27,32,12,21,29,35,12,23,34,37,12,25,34,40,13,26,35,42,14,28,38,45,15,29,40,48,16,31,43,51,17,33,45,54,18,35,48,57,19,37,51,60,19,38,53,63,20,40,56,66,21,43,59,70,22,45,62,74,24,47,65,77,25,49,68,81],s=[7,10,13,17,10,16,22,28,15,26,36,44,20,36,52,64,26,48,72,88,36,64,96,112,40,72,108,130,48,88,132,156,60,110,160,192,72,130,192,224,80,150,224,264,96,176,260,308,104,198,288,352,120,216,320,384,132,240,360,432,144,280,408,480,168,308,448,532,180,338,504,588,196,364,546,650,224,416,600,700,224,442,644,750,252,476,690,816,270,504,750,900,300,560,810,960,312,588,870,1050,336,644,952,1110,360,700,1020,1200,390,728,1050,1260,420,784,1140,1350,450,812,1200,1440,480,868,1290,1530,510,924,1350,1620,540,980,1440,1710,570,1036,1530,1800,570,1064,1590,1890,600,1120,1680,1980,630,1204,1770,2100,660,1260,1860,2220,720,1316,1950,2310,750,1372,2040,2430];return ta.getBlocksCount=function(n,r){switch(r){case t.L:return a[(n-1)*4+0];case t.M:return a[(n-1)*4+1];case t.Q:return a[(n-1)*4+2];case t.H:return a[(n-1)*4+3];default:return}},ta.getTotalCodewordsCount=function(n,r){switch(r){case t.L:return s[(n-1)*4+0];case t.M:return s[(n-1)*4+1];case t.Q:return s[(n-1)*4+2];case t.H:return s[(n-1)*4+3];default:return}},ta}var qa={},Pn={},Li;function Vc(){if(Li)return Pn;Li=1;const t=new Uint8Array(512),a=new Uint8Array(256);return(function(){let i=1;for(let n=0;n<255;n++)t[n]=i,a[i]=n,i<<=1,i&256&&(i^=285);for(let n=255;n<512;n++)t[n]=t[n-255]})(),Pn.log=function(i){if(i<1)throw new Error("log("+i+")");return a[i]},Pn.exp=function(i){return t[i]},Pn.mul=function(i,n){return i===0||n===0?0:t[a[i]+a[n]]},Pn}var Oi;function Gc(){return Oi||(Oi=1,(function(t){const a=Vc();t.mul=function(i,n){const r=new Uint8Array(i.length+n.length-1);for(let o=0;o<i.length;o++)for(let l=0;l<n.length;l++)r[o+l]^=a.mul(i[o],n[l]);return r},t.mod=function(i,n){let r=new Uint8Array(i);for(;r.length-n.length>=0;){const o=r[0];for(let d=0;d<n.length;d++)r[d]^=a.mul(n[d],o);let l=0;for(;l<r.length&&r[l]===0;)l++;r=r.slice(l)}return r},t.generateECPolynomial=function(i){let n=new Uint8Array([1]);for(let r=0;r<i;r++)n=t.mul(n,new Uint8Array([1,a.exp(r)]));return n}})(qa)),qa}var Va,Bi;function Jc(){if(Bi)return Va;Bi=1;const t=Gc();function a(s){this.genPoly=void 0,this.degree=s,this.degree&&this.initialize(this.degree)}return a.prototype.initialize=function(i){this.degree=i,this.genPoly=t.generateECPolynomial(this.degree)},a.prototype.encode=function(i){if(!this.genPoly)throw new Error("Encoder not initialized");const n=new Uint8Array(i.length+this.degree);n.set(i);const r=t.mod(n,this.genPoly),o=this.degree-r.length;if(o>0){const l=new Uint8Array(this.degree);return l.set(r,o),l}return r},Va=a,Va}var Ga={},Ja={},Ka={},Ui;function Bo(){return Ui||(Ui=1,Ka.isValid=function(a){return!isNaN(a)&&a>=1&&a<=40}),Ka}var Rs={},$i;function Uo(){if($i)return Rs;$i=1;const t="[0-9]+",a="[A-Z $%*+\\-./:]+";let s="(?:[u3000-u303F]|[u3040-u309F]|[u30A0-u30FF]|[uFF00-uFFEF]|[u4E00-u9FAF]|[u2605-u2606]|[u2190-u2195]|u203B|[u2010u2015u2018u2019u2025u2026u201Cu201Du2225u2260]|[u0391-u0451]|[u00A7u00A8u00B1u00B4u00D7u00F7])+";s=s.replace(/u/g,"\\u");const i="(?:(?![A-Z0-9 $%*+\\-./:]|"+s+`)(?:.|[\r
]))+`;Rs.KANJI=new RegExp(s,"g"),Rs.BYTE_KANJI=new RegExp("[^A-Z0-9 $%*+\\-./:]+","g"),Rs.BYTE=new RegExp(i,"g"),Rs.NUMERIC=new RegExp(t,"g"),Rs.ALPHANUMERIC=new RegExp(a,"g");const n=new RegExp("^"+s+"$"),r=new RegExp("^"+t+"$"),o=new RegExp("^[A-Z0-9 $%*+\\-./:]+$");return Rs.testKanji=function(d){return n.test(d)},Rs.testNumeric=function(d){return r.test(d)},Rs.testAlphanumeric=function(d){return o.test(d)},Rs}var Fi;function cn(){return Fi||(Fi=1,(function(t){const a=Bo(),s=Uo();t.NUMERIC={id:"Numeric",bit:1,ccBits:[10,12,14]},t.ALPHANUMERIC={id:"Alphanumeric",bit:2,ccBits:[9,11,13]},t.BYTE={id:"Byte",bit:4,ccBits:[8,16,16]},t.KANJI={id:"Kanji",bit:8,ccBits:[8,10,12]},t.MIXED={bit:-1},t.getCharCountIndicator=function(r,o){if(!r.ccBits)throw new Error("Invalid mode: "+r);if(!a.isValid(o))throw new Error("Invalid version: "+o);return o>=1&&o<10?r.ccBits[0]:o<27?r.ccBits[1]:r.ccBits[2]},t.getBestModeForData=function(r){return s.testNumeric(r)?t.NUMERIC:s.testAlphanumeric(r)?t.ALPHANUMERIC:s.testKanji(r)?t.KANJI:t.BYTE},t.toString=function(r){if(r&&r.id)return r.id;throw new Error("Invalid mode")},t.isValid=function(r){return r&&r.bit&&r.ccBits};function i(n){if(typeof n!="string")throw new Error("Param is not a string");switch(n.toLowerCase()){case"numeric":return t.NUMERIC;case"alphanumeric":return t.ALPHANUMERIC;case"kanji":return t.KANJI;case"byte":return t.BYTE;default:throw new Error("Unknown mode: "+n)}}t.from=function(r,o){if(t.isValid(r))return r;try{return i(r)}catch{return o}}})(Ja)),Ja}var _i;function Kc(){return _i||(_i=1,(function(t){const a=ln(),s=Oo(),i=Dr(),n=cn(),r=Bo(),o=7973,l=a.getBCHDigit(o);function d(x,p,g){for(let S=1;S<=40;S++)if(p<=t.getCapacity(S,g,x))return S}function c(x,p){return n.getCharCountIndicator(x,p)+4}function u(x,p){let g=0;return x.forEach(function(S){const D=c(S.mode,p);g+=D+S.getBitsLength()}),g}function h(x,p){for(let g=1;g<=40;g++)if(u(x,g)<=t.getCapacity(g,p,n.MIXED))return g}t.from=function(p,g){return r.isValid(p)?parseInt(p,10):g},t.getCapacity=function(p,g,S){if(!r.isValid(p))throw new Error("Invalid QR Code version");typeof S>"u"&&(S=n.BYTE);const D=a.getSymbolTotalCodewords(p),I=s.getTotalCodewordsCount(p,g),N=(D-I)*8;if(S===n.MIXED)return N;const E=N-c(S,p);switch(S){case n.NUMERIC:return Math.floor(E/10*3);case n.ALPHANUMERIC:return Math.floor(E/11*2);case n.KANJI:return Math.floor(E/13);case n.BYTE:default:return Math.floor(E/8)}},t.getBestVersionForData=function(p,g){let S;const D=i.from(g,i.M);if(Array.isArray(p)){if(p.length>1)return h(p,D);if(p.length===0)return 1;S=p[0]}else S=p;return d(S.mode,S.getLength(),D)},t.getEncodedBits=function(p){if(!r.isValid(p)||p<7)throw new Error("Invalid QR Code version");let g=p<<12;for(;a.getBCHDigit(g)-l>=0;)g^=o<<a.getBCHDigit(g)-l;return p<<12|g}})(Ga)),Ga}var Ya={},Hi;function Yc(){if(Hi)return Ya;Hi=1;const t=ln(),a=1335,s=21522,i=t.getBCHDigit(a);return Ya.getEncodedBits=function(r,o){const l=r.bit<<3|o;let d=l<<10;for(;t.getBCHDigit(d)-i>=0;)d^=a<<t.getBCHDigit(d)-i;return(l<<10|d)^s},Ya}var Xa={},Qa,Wi;function Xc(){if(Wi)return Qa;Wi=1;const t=cn();function a(s){this.mode=t.NUMERIC,this.data=s.toString()}return a.getBitsLength=function(i){return 10*Math.floor(i/3)+(i%3?i%3*3+1:0)},a.prototype.getLength=function(){return this.data.length},a.prototype.getBitsLength=function(){return a.getBitsLength(this.data.length)},a.prototype.write=function(i){let n,r,o;for(n=0;n+3<=this.data.length;n+=3)r=this.data.substr(n,3),o=parseInt(r,10),i.put(o,10);const l=this.data.length-n;l>0&&(r=this.data.substr(n),o=parseInt(r,10),i.put(o,l*3+1))},Qa=a,Qa}var Za,zi;function Qc(){if(zi)return Za;zi=1;const t=cn(),a=["0","1","2","3","4","5","6","7","8","9","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z"," ","$","%","*","+","-",".","/",":"];function s(i){this.mode=t.ALPHANUMERIC,this.data=i}return s.getBitsLength=function(n){return 11*Math.floor(n/2)+6*(n%2)},s.prototype.getLength=function(){return this.data.length},s.prototype.getBitsLength=function(){return s.getBitsLength(this.data.length)},s.prototype.write=function(n){let r;for(r=0;r+2<=this.data.length;r+=2){let o=a.indexOf(this.data[r])*45;o+=a.indexOf(this.data[r+1]),n.put(o,11)}this.data.length%2&&n.put(a.indexOf(this.data[r]),6)},Za=s,Za}var er,qi;function Zc(){if(qi)return er;qi=1;const t=cn();function a(s){this.mode=t.BYTE,typeof s=="string"?this.data=new TextEncoder().encode(s):this.data=new Uint8Array(s)}return a.getBitsLength=function(i){return i*8},a.prototype.getLength=function(){return this.data.length},a.prototype.getBitsLength=function(){return a.getBitsLength(this.data.length)},a.prototype.write=function(s){for(let i=0,n=this.data.length;i<n;i++)s.put(this.data[i],8)},er=a,er}var tr,Vi;function ed(){if(Vi)return tr;Vi=1;const t=cn(),a=ln();function s(i){this.mode=t.KANJI,this.data=i}return s.getBitsLength=function(n){return n*13},s.prototype.getLength=function(){return this.data.length},s.prototype.getBitsLength=function(){return s.getBitsLength(this.data.length)},s.prototype.write=function(i){let n;for(n=0;n<this.data.length;n++){let r=a.toSJIS(this.data[n]);if(r>=33088&&r<=40956)r-=33088;else if(r>=57408&&r<=60351)r-=49472;else throw new Error("Invalid SJIS character: "+this.data[n]+`
Make sure your charset is UTF-8`);r=(r>>>8&255)*192+(r&255),i.put(r,13)}},tr=s,tr}var sr={exports:{}},Gi;function td(){return Gi||(Gi=1,(function(t){var a={single_source_shortest_paths:function(s,i,n){var r={},o={};o[i]=0;var l=a.PriorityQueue.make();l.push(i,0);for(var d,c,u,h,x,p,g,S,D;!l.empty();){d=l.pop(),c=d.value,h=d.cost,x=s[c]||{};for(u in x)x.hasOwnProperty(u)&&(p=x[u],g=h+p,S=o[u],D=typeof o[u]>"u",(D||S>g)&&(o[u]=g,l.push(u,g),r[u]=c))}if(typeof n<"u"&&typeof o[n]>"u"){var I=["Could not find a path from ",i," to ",n,"."].join("");throw new Error(I)}return r},extract_shortest_path_from_predecessor_list:function(s,i){for(var n=[],r=i;r;)n.push(r),s[r],r=s[r];return n.reverse(),n},find_path:function(s,i,n){var r=a.single_source_shortest_paths(s,i,n);return a.extract_shortest_path_from_predecessor_list(r,n)},PriorityQueue:{make:function(s){var i=a.PriorityQueue,n={},r;s=s||{};for(r in i)i.hasOwnProperty(r)&&(n[r]=i[r]);return n.queue=[],n.sorter=s.sorter||i.default_sorter,n},default_sorter:function(s,i){return s.cost-i.cost},push:function(s,i){var n={value:s,cost:i};this.queue.push(n),this.queue.sort(this.sorter)},pop:function(){return this.queue.shift()},empty:function(){return this.queue.length===0}}};t.exports=a})(sr)),sr.exports}var Ji;function sd(){return Ji||(Ji=1,(function(t){const a=cn(),s=Xc(),i=Qc(),n=Zc(),r=ed(),o=Uo(),l=ln(),d=td();function c(I){return unescape(encodeURIComponent(I)).length}function u(I,N,E){const A=[];let O;for(;(O=I.exec(E))!==null;)A.push({data:O[0],index:O.index,mode:N,length:O[0].length});return A}function h(I){const N=u(o.NUMERIC,a.NUMERIC,I),E=u(o.ALPHANUMERIC,a.ALPHANUMERIC,I);let A,O;return l.isKanjiModeEnabled()?(A=u(o.BYTE,a.BYTE,I),O=u(o.KANJI,a.KANJI,I)):(A=u(o.BYTE_KANJI,a.BYTE,I),O=[]),N.concat(E,A,O).sort(function(v,b){return v.index-b.index}).map(function(v){return{data:v.data,mode:v.mode,length:v.length}})}function x(I,N){switch(N){case a.NUMERIC:return s.getBitsLength(I);case a.ALPHANUMERIC:return i.getBitsLength(I);case a.KANJI:return r.getBitsLength(I);case a.BYTE:return n.getBitsLength(I)}}function p(I){return I.reduce(function(N,E){const A=N.length-1>=0?N[N.length-1]:null;return A&&A.mode===E.mode?(N[N.length-1].data+=E.data,N):(N.push(E),N)},[])}function g(I){const N=[];for(let E=0;E<I.length;E++){const A=I[E];switch(A.mode){case a.NUMERIC:N.push([A,{data:A.data,mode:a.ALPHANUMERIC,length:A.length},{data:A.data,mode:a.BYTE,length:A.length}]);break;case a.ALPHANUMERIC:N.push([A,{data:A.data,mode:a.BYTE,length:A.length}]);break;case a.KANJI:N.push([A,{data:A.data,mode:a.BYTE,length:c(A.data)}]);break;case a.BYTE:N.push([{data:A.data,mode:a.BYTE,length:c(A.data)}])}}return N}function S(I,N){const E={},A={start:{}};let O=["start"];for(let M=0;M<I.length;M++){const v=I[M],b=[];for(let F=0;F<v.length;F++){const z=v[F],T=""+M+F;b.push(T),E[T]={node:z,lastCount:0},A[T]={};for(let U=0;U<O.length;U++){const w=O[U];E[w]&&E[w].node.mode===z.mode?(A[w][T]=x(E[w].lastCount+z.length,z.mode)-x(E[w].lastCount,z.mode),E[w].lastCount+=z.length):(E[w]&&(E[w].lastCount=z.length),A[w][T]=x(z.length,z.mode)+4+a.getCharCountIndicator(z.mode,N))}}O=b}for(let M=0;M<O.length;M++)A[O[M]].end=0;return{map:A,table:E}}function D(I,N){let E;const A=a.getBestModeForData(I);if(E=a.from(N,A),E!==a.BYTE&&E.bit<A.bit)throw new Error('"'+I+'" cannot be encoded with mode '+a.toString(E)+`.
 Suggested mode is: `+a.toString(A));switch(E===a.KANJI&&!l.isKanjiModeEnabled()&&(E=a.BYTE),E){case a.NUMERIC:return new s(I);case a.ALPHANUMERIC:return new i(I);case a.KANJI:return new r(I);case a.BYTE:return new n(I)}}t.fromArray=function(N){return N.reduce(function(E,A){return typeof A=="string"?E.push(D(A,null)):A.data&&E.push(D(A.data,A.mode)),E},[])},t.fromString=function(N,E){const A=h(N,l.isKanjiModeEnabled()),O=g(A),M=S(O,E),v=d.find_path(M.map,"start","end"),b=[];for(let F=1;F<v.length-1;F++)b.push(M.table[v[F]].node);return t.fromArray(p(b))},t.rawSplit=function(N){return t.fromArray(h(N,l.isKanjiModeEnabled()))}})(Xa)),Xa}var Ki;function nd(){if(Ki)return Ua;Ki=1;const t=ln(),a=Dr(),s=_c(),i=Hc(),n=Wc(),r=zc(),o=qc(),l=Oo(),d=Jc(),c=Kc(),u=Yc(),h=cn(),x=sd();function p(M,v){const b=M.size,F=r.getPositions(v);for(let z=0;z<F.length;z++){const T=F[z][0],U=F[z][1];for(let w=-1;w<=7;w++)if(!(T+w<=-1||b<=T+w))for(let _=-1;_<=7;_++)U+_<=-1||b<=U+_||(w>=0&&w<=6&&(_===0||_===6)||_>=0&&_<=6&&(w===0||w===6)||w>=2&&w<=4&&_>=2&&_<=4?M.set(T+w,U+_,!0,!0):M.set(T+w,U+_,!1,!0))}}function g(M){const v=M.size;for(let b=8;b<v-8;b++){const F=b%2===0;M.set(b,6,F,!0),M.set(6,b,F,!0)}}function S(M,v){const b=n.getPositions(v);for(let F=0;F<b.length;F++){const z=b[F][0],T=b[F][1];for(let U=-2;U<=2;U++)for(let w=-2;w<=2;w++)U===-2||U===2||w===-2||w===2||U===0&&w===0?M.set(z+U,T+w,!0,!0):M.set(z+U,T+w,!1,!0)}}function D(M,v){const b=M.size,F=c.getEncodedBits(v);let z,T,U;for(let w=0;w<18;w++)z=Math.floor(w/3),T=w%3+b-8-3,U=(F>>w&1)===1,M.set(z,T,U,!0),M.set(T,z,U,!0)}function I(M,v,b){const F=M.size,z=u.getEncodedBits(v,b);let T,U;for(T=0;T<15;T++)U=(z>>T&1)===1,T<6?M.set(T,8,U,!0):T<8?M.set(T+1,8,U,!0):M.set(F-15+T,8,U,!0),T<8?M.set(8,F-T-1,U,!0):T<9?M.set(8,15-T-1+1,U,!0):M.set(8,15-T-1,U,!0);M.set(F-8,8,1,!0)}function N(M,v){const b=M.size;let F=-1,z=b-1,T=7,U=0;for(let w=b-1;w>0;w-=2)for(w===6&&w--;;){for(let _=0;_<2;_++)if(!M.isReserved(z,w-_)){let ie=!1;U<v.length&&(ie=(v[U]>>>T&1)===1),M.set(z,w-_,ie),T--,T===-1&&(U++,T=7)}if(z+=F,z<0||b<=z){z-=F,F=-F;break}}}function E(M,v,b){const F=new s;b.forEach(function(_){F.put(_.mode.bit,4),F.put(_.getLength(),h.getCharCountIndicator(_.mode,M)),_.write(F)});const z=t.getSymbolTotalCodewords(M),T=l.getTotalCodewordsCount(M,v),U=(z-T)*8;for(F.getLengthInBits()+4<=U&&F.put(0,4);F.getLengthInBits()%8!==0;)F.putBit(0);const w=(U-F.getLengthInBits())/8;for(let _=0;_<w;_++)F.put(_%2?17:236,8);return A(F,M,v)}function A(M,v,b){const F=t.getSymbolTotalCodewords(v),z=l.getTotalCodewordsCount(v,b),T=F-z,U=l.getBlocksCount(v,b),w=F%U,_=U-w,ie=Math.floor(F/U),R=Math.floor(T/U),Z=R+1,ae=ie-R,Me=new d(ae);let st=0;const Se=new Array(U),Te=new Array(U);let dt=0;const ye=new Uint8Array(M.buffer);for(let te=0;te<U;te++){const at=te<_?R:Z;Se[te]=ye.slice(st,st+at),Te[te]=Me.encode(Se[te]),st+=at,dt=Math.max(dt,at)}const We=new Uint8Array(F);let Ve=0,Ge,Re;for(Ge=0;Ge<dt;Ge++)for(Re=0;Re<U;Re++)Ge<Se[Re].length&&(We[Ve++]=Se[Re][Ge]);for(Ge=0;Ge<ae;Ge++)for(Re=0;Re<U;Re++)We[Ve++]=Te[Re][Ge];return We}function O(M,v,b,F){let z;if(Array.isArray(M))z=x.fromArray(M);else if(typeof M=="string"){let ie=v;if(!ie){const R=x.rawSplit(M);ie=c.getBestVersionForData(R,b)}z=x.fromString(M,ie||40)}else throw new Error("Invalid data");const T=c.getBestVersionForData(z,b);if(!T)throw new Error("The amount of data is too big to be stored in a QR Code");if(!v)v=T;else if(v<T)throw new Error(`
The chosen QR Code version cannot contain this amount of data.
Minimum version required to store current data is: `+T+`.
`);const U=E(v,b,z),w=t.getSymbolSize(v),_=new i(w);return p(_,v),g(_),S(_,v),I(_,b,0),v>=7&&D(_,v),N(_,U),isNaN(F)&&(F=o.getBestMask(_,I.bind(null,_,b))),o.applyMask(F,_),I(_,b,F),{modules:_,version:v,errorCorrectionLevel:b,maskPattern:F,segments:z}}return Ua.create=function(v,b){if(typeof v>"u"||v==="")throw new Error("No input text");let F=a.M,z,T;return typeof b<"u"&&(F=a.from(b.errorCorrectionLevel,a.M),z=c.from(b.version),T=o.from(b.maskPattern),b.toSJISFunc&&t.setToSJISFunction(b.toSJISFunc)),O(v,z,F,T)},Ua}var nr={},ar={},Yi;function $o(){return Yi||(Yi=1,(function(t){function a(s){if(typeof s=="number"&&(s=s.toString()),typeof s!="string")throw new Error("Color should be defined as hex string");let i=s.slice().replace("#","").split("");if(i.length<3||i.length===5||i.length>8)throw new Error("Invalid hex color: "+s);(i.length===3||i.length===4)&&(i=Array.prototype.concat.apply([],i.map(function(r){return[r,r]}))),i.length===6&&i.push("F","F");const n=parseInt(i.join(""),16);return{r:n>>24&255,g:n>>16&255,b:n>>8&255,a:n&255,hex:"#"+i.slice(0,6).join("")}}t.getOptions=function(i){i||(i={}),i.color||(i.color={});const n=typeof i.margin>"u"||i.margin===null||i.margin<0?4:i.margin,r=i.width&&i.width>=21?i.width:void 0,o=i.scale||4;return{width:r,scale:r?4:o,margin:n,color:{dark:a(i.color.dark||"#000000ff"),light:a(i.color.light||"#ffffffff")},type:i.type,rendererOpts:i.rendererOpts||{}}},t.getScale=function(i,n){return n.width&&n.width>=i+n.margin*2?n.width/(i+n.margin*2):n.scale},t.getImageWidth=function(i,n){const r=t.getScale(i,n);return Math.floor((i+n.margin*2)*r)},t.qrToImageData=function(i,n,r){const o=n.modules.size,l=n.modules.data,d=t.getScale(o,r),c=Math.floor((o+r.margin*2)*d),u=r.margin*d,h=[r.color.light,r.color.dark];for(let x=0;x<c;x++)for(let p=0;p<c;p++){let g=(x*c+p)*4,S=r.color.light;if(x>=u&&p>=u&&x<c-u&&p<c-u){const D=Math.floor((x-u)/d),I=Math.floor((p-u)/d);S=h[l[D*o+I]?1:0]}i[g++]=S.r,i[g++]=S.g,i[g++]=S.b,i[g]=S.a}}})(ar)),ar}var Xi;function ad(){return Xi||(Xi=1,(function(t){const a=$o();function s(n,r,o){n.clearRect(0,0,r.width,r.height),r.style||(r.style={}),r.height=o,r.width=o,r.style.height=o+"px",r.style.width=o+"px"}function i(){try{return document.createElement("canvas")}catch{throw new Error("You need to specify a canvas element")}}t.render=function(r,o,l){let d=l,c=o;typeof d>"u"&&(!o||!o.getContext)&&(d=o,o=void 0),o||(c=i()),d=a.getOptions(d);const u=a.getImageWidth(r.modules.size,d),h=c.getContext("2d"),x=h.createImageData(u,u);return a.qrToImageData(x.data,r,d),s(h,c,u),h.putImageData(x,0,0),c},t.renderToDataURL=function(r,o,l){let d=l;typeof d>"u"&&(!o||!o.getContext)&&(d=o,o=void 0),d||(d={});const c=t.render(r,o,d),u=d.type||"image/png",h=d.rendererOpts||{};return c.toDataURL(u,h.quality)}})(nr)),nr}var rr={},Qi;function rd(){if(Qi)return rr;Qi=1;const t=$o();function a(n,r){const o=n.a/255,l=r+'="'+n.hex+'"';return o<1?l+" "+r+'-opacity="'+o.toFixed(2).slice(1)+'"':l}function s(n,r,o){let l=n+r;return typeof o<"u"&&(l+=" "+o),l}function i(n,r,o){let l="",d=0,c=!1,u=0;for(let h=0;h<n.length;h++){const x=Math.floor(h%r),p=Math.floor(h/r);!x&&!c&&(c=!0),n[h]?(u++,h>0&&x>0&&n[h-1]||(l+=c?s("M",x+o,.5+p+o):s("m",d,0),d=0,c=!1),x+1<r&&n[h+1]||(l+=s("h",u),u=0)):d++}return l}return rr.render=function(r,o,l){const d=t.getOptions(o),c=r.modules.size,u=r.modules.data,h=c+d.margin*2,x=d.color.light.a?"<path "+a(d.color.light,"fill")+' d="M0 0h'+h+"v"+h+'H0z"/>':"",p="<path "+a(d.color.dark,"stroke")+' d="'+i(u,c,d.margin)+'"/>',g='viewBox="0 0 '+h+" "+h+'"',D='<svg xmlns="http://www.w3.org/2000/svg" '+(d.width?'width="'+d.width+'" height="'+d.width+'" ':"")+g+' shape-rendering="crispEdges">'+x+p+`</svg>
`;return typeof l=="function"&&l(null,D),D},rr}var Zi;function id(){if(Zi)return jn;Zi=1;const t=Fc(),a=nd(),s=ad(),i=rd();function n(r,o,l,d,c){const u=[].slice.call(arguments,1),h=u.length,x=typeof u[h-1]=="function";if(!x&&!t())throw new Error("Callback required as last argument");if(x){if(h<2)throw new Error("Too few arguments provided");h===2?(c=l,l=o,o=d=void 0):h===3&&(o.getContext&&typeof c>"u"?(c=d,d=void 0):(c=d,d=l,l=o,o=void 0))}else{if(h<1)throw new Error("Too few arguments provided");return h===1?(l=o,o=d=void 0):h===2&&!o.getContext&&(d=l,l=o,o=void 0),new Promise(function(p,g){try{const S=a.create(l,d);p(r(S,o,d))}catch(S){g(S)}})}try{const p=a.create(l,d);c(null,r(p,o,d))}catch(p){c(p)}}return jn.create=a.create,jn.toCanvas=n.bind(null,s.render),jn.toDataURL=n.bind(null,s.renderToDataURL),jn.toString=n.bind(null,function(r,o,l){return i.render(r,l)}),jn}var od=id();const Fo=ma(od),ld={};function Ar(t,a){let s;try{s=t()}catch{return}return{getItem:n=>{var r;const o=d=>d===null?null:JSON.parse(d,void 0),l=(r=s.getItem(n))!=null?r:null;return l instanceof Promise?l.then(o):o(l)},setItem:(n,r)=>s.setItem(n,JSON.stringify(r,void 0)),removeItem:n=>s.removeItem(n)}}const Wn=t=>a=>{try{const s=t(a);return s instanceof Promise?s:{then(i){return Wn(i)(s)},catch(i){return this}}}catch(s){return{then(i){return this},catch(i){return Wn(i)(s)}}}},cd=(t,a)=>(s,i,n)=>{let r={getStorage:()=>localStorage,serialize:JSON.stringify,deserialize:JSON.parse,partialize:D=>D,version:0,merge:(D,I)=>({...I,...D}),...a},o=!1;const l=new Set,d=new Set;let c;try{c=r.getStorage()}catch{}if(!c)return t((...D)=>{console.warn(`[zustand persist middleware] Unable to update item '${r.name}', the given storage is currently unavailable.`),s(...D)},i,n);const u=Wn(r.serialize),h=()=>{const D=r.partialize({...i()});let I;const N=u({state:D,version:r.version}).then(E=>c.setItem(r.name,E)).catch(E=>{I=E});if(I)throw I;return N},x=n.setState;n.setState=(D,I)=>{x(D,I),h()};const p=t((...D)=>{s(...D),h()},i,n);let g;const S=()=>{var D;if(!c)return;o=!1,l.forEach(N=>N(i()));const I=((D=r.onRehydrateStorage)==null?void 0:D.call(r,i()))||void 0;return Wn(c.getItem.bind(c))(r.name).then(N=>{if(N)return r.deserialize(N)}).then(N=>{if(N)if(typeof N.version=="number"&&N.version!==r.version){if(r.migrate)return r.migrate(N.state,N.version);console.error("State loaded from storage couldn't be migrated since no migrate function was provided")}else return N.state}).then(N=>{var E;return g=r.merge(N,(E=i())!=null?E:p),s(g,!0),h()}).then(()=>{I?.(g,void 0),o=!0,d.forEach(N=>N(g))}).catch(N=>{I?.(void 0,N)})};return n.persist={setOptions:D=>{r={...r,...D},D.getStorage&&(c=D.getStorage())},clearStorage:()=>{c?.removeItem(r.name)},getOptions:()=>r,rehydrate:()=>S(),hasHydrated:()=>o,onHydrate:D=>(l.add(D),()=>{l.delete(D)}),onFinishHydration:D=>(d.add(D),()=>{d.delete(D)})},S(),g||p},dd=(t,a)=>(s,i,n)=>{let r={storage:Ar(()=>localStorage),partialize:S=>S,version:0,merge:(S,D)=>({...D,...S}),...a},o=!1;const l=new Set,d=new Set;let c=r.storage;if(!c)return t((...S)=>{console.warn(`[zustand persist middleware] Unable to update item '${r.name}', the given storage is currently unavailable.`),s(...S)},i,n);const u=()=>{const S=r.partialize({...i()});return c.setItem(r.name,{state:S,version:r.version})},h=n.setState;n.setState=(S,D)=>{h(S,D),u()};const x=t((...S)=>{s(...S),u()},i,n);n.getInitialState=()=>x;let p;const g=()=>{var S,D;if(!c)return;o=!1,l.forEach(N=>{var E;return N((E=i())!=null?E:x)});const I=((D=r.onRehydrateStorage)==null?void 0:D.call(r,(S=i())!=null?S:x))||void 0;return Wn(c.getItem.bind(c))(r.name).then(N=>{if(N)if(typeof N.version=="number"&&N.version!==r.version){if(r.migrate)return[!0,r.migrate(N.state,N.version)];console.error("State loaded from storage couldn't be migrated since no migrate function was provided")}else return[!1,N.state];return[!1,void 0]}).then(N=>{var E;const[A,O]=N;if(p=r.merge(O,(E=i())!=null?E:x),s(p,!0),A)return u()}).then(()=>{I?.(p,void 0),p=i(),o=!0,d.forEach(N=>N(p))}).catch(N=>{I?.(void 0,N)})};return n.persist={setOptions:S=>{r={...r,...S},S.storage&&(c=S.storage)},clearStorage:()=>{c?.removeItem(r.name)},getOptions:()=>r,rehydrate:()=>g(),hasHydrated:()=>o,onHydrate:S=>(l.add(S),()=>{l.delete(S)}),onFinishHydration:S=>(d.add(S),()=>{d.delete(S)})},r.skipHydration||g(),p||x},md=(t,a)=>"getStorage"in a||"serialize"in a||"deserialize"in a?((ld?"production":void 0)!=="production"&&console.warn("[DEPRECATED] `getStorage`, `serialize` and `deserialize` options are deprecated. Use `storage` option instead."),cd(t,a)):dd(t,a),_o=md,ha=Zs()(_o((t,a)=>({H:null,createdAt:null,errorPx:null,imageSize:null,anchors:null,locked:!1,_hydrated:!1,setCalibration:s=>t(i=>({...i,...s})),reset:()=>t({H:null,createdAt:null,errorPx:null,imageSize:null,anchors:null,locked:!1})}),{name:"ndn-calibration-v1",storage:Ar(()=>localStorage),onRehydrateStorage:()=>(t,a)=>{if(!(a||!t))try{if(t&&!t.H){const s=localStorage.getItem("ndn:calibration:v1");if(s){const i=JSON.parse(s);i&&(i.H||i.imageSize)&&t.setCalibration({H:i.H??null,createdAt:i.createdAt??null,errorPx:i.errorPx??null,imageSize:i.imageSize??null,anchors:i.anchors??null,locked:!!i.locked})}}t._hydrated=!0}catch{}}}));let ir=null,or=null,lr=null,cr=null;const zn=Zs()(_o((t,a)=>({isStreaming:!1,mode:"local",pairingCode:null,expiresAt:null,isPaired:!1,mobileUrl:null,showOverlay:!0,setStreaming:s=>{console.log("[CAMERA_SESSION] setStreaming:",s),t({isStreaming:s})},setMode:s=>{console.log("[CAMERA_SESSION] setMode:",s),t({mode:s})},setPairingCode:s=>t({pairingCode:s}),setExpiresAt:s=>t({expiresAt:s}),setPaired:s=>t({isPaired:s}),setMobileUrl:s=>t({mobileUrl:s}),setShowOverlay:s=>t({showOverlay:!!s}),setMediaStream:s=>{or=s},getMediaStream:()=>or,setPcRef:s=>{lr=s},getPcRef:()=>lr,setWsRef:s=>{cr=s},getWsRef:()=>cr,getVideoElementRef:()=>{const s=ir;return s||console.warn("[cameraSession] ⚠️ getVideoElementRef called but ref is NULL"),s},setVideoElementRef:s=>{s?console.log("[cameraSession] ✅ setVideoElementRef called - storing HTMLVideoElement",{tagName:s.tagName,hasStream:!!s.srcObject}):console.log("[cameraSession] 🛑 setVideoElementRef called - clearing ref"),ir=s},clearSession:()=>{ir=null,or=null,lr=null,cr=null,t({isStreaming:!1,pairingCode:null,expiresAt:null,isPaired:!1,mobileUrl:null})}}),{name:"ndn-camera-session",storage:Ar(()=>localStorage),partialize:t=>({isStreaming:t.isStreaming,mode:t.mode,pairingCode:t.pairingCode,expiresAt:t.expiresAt,isPaired:t.isPaired,mobileUrl:t.mobileUrl,showOverlay:t.showOverlay})})),He={bullInner:6.35,bullOuter:15.9,trebleInner:99,trebleOuter:107,doubleInner:162,doubleOuter:170},ud=[20,1,18,4,13,6,10,15,2,17,3,19,7,16,8,11,14,9,12,5];function fa(t,a){const s=a.x,i=a.y,n=t[6]*s+t[7]*i+t[8],r=(t[0]*s+t[1]*i+t[2])/n,o=(t[3]*s+t[4]*i+t[5])/n;return{x:r,y:o}}function hd(t,a,s){return[a*t[0],a*t[1],a*t[2],s*t[3],s*t[4],s*t[5],t[6],t[7],t[8]]}function fd(t){const a=t,s=a[0],i=a[1],n=a[2],r=a[3],o=a[4],l=a[5],d=a[6],c=a[7],u=a[8],h=o*u-l*c,x=n*c-i*u,p=i*l-n*o,g=l*d-r*u,S=s*u-n*d,D=n*r-s*l,I=r*c-o*d,N=i*d-s*c,E=s*o-i*r,A=s*h+i*g+n*I;if(Math.abs(A)<1e-12)throw new Error("Singular homography");return[h/A,x/A,p/A,g/A,S/A,D/A,I/A,N/A,E/A]}function jr(t,a){if(t.length<4||a.length<4)throw new Error("Need at least 4 correspondences");if(t.length!==a.length)throw new Error("Correspondences must have equal length");const s=[],i=[];for(let o=0;o<t.length;o++){const{x:l,y:d}=t[o],{x:c,y:u}=a[o];s.push([l,d,1,0,0,0,-c*l,-c*d]),i.push(c),s.push([0,0,0,l,d,1,-u*l,-u*d]),i.push(u)}const n=xd(s,i);return[n[0],n[1],n[2],n[3],n[4],n[5],n[6],n[7],1]}function xd(t,a){const s=t.length,i=t[0].length,n=Array.from({length:i},()=>new Array(i).fill(0)),r=new Array(i).fill(0);for(let o=0;o<s;o++)for(let l=0;l<i;l++){r[l]+=t[o][l]*a[o];for(let d=0;d<i;d++)n[l][d]+=t[o][l]*t[o][d]}return pd(n,r)}function pd(t,a){const s=a.length,i=t.map((r,o)=>r.concat([a[o]]));for(let r=0;r<s;r++){let o=r;for(let l=r+1;l<s;l++)Math.abs(i[l][r])>Math.abs(i[o][r])&&(o=l);if(Math.abs(i[o][r])<1e-12)throw new Error("Singular matrix");if(o!==r){const l=i[r];i[r]=i[o],i[o]=l}for(let l=r+1;l<s;l++){const d=i[l][r]/i[r][r];for(let c=r;c<=s;c++)i[l][c]-=d*i[r][c]}}const n=new Array(s).fill(0);for(let r=s-1;r>=0;r--){let o=i[r][s];for(let l=r+1;l<s;l++)o-=i[r][l]*n[l];n[r]=o/i[r][r]}return n}function Ln(){const t=He.doubleOuter;return[{x:0,y:-t},{x:t,y:0},{x:0,y:t},{x:-t,y:0},{x:0,y:0},{x:0,y:-15.9}]}function Ho(t,a,s=256){const i=[];for(let n=0;n<s;n++){const r=n/s*Math.PI*2,o=fa(t,{x:a*Math.cos(r),y:a*Math.sin(r)});i.push(o)}return i}function Nr(t,a,s){let i=0;for(let n=0;n<a.length;n++){const r=fa(t,a[n]),o=r.x-s[n].x,l=r.y-s[n].y;i+=o*o+l*l}return Math.sqrt(i/a.length)}function bd(t,a){const s=fd(t);return fa(s,a)}function gd(t){const a=Math.hypot(t.x,t.y);let i=Math.atan2(t.y,t.x)*180/Math.PI;i=(i+360+90)%360;const n=ud[Math.floor((360-i)%360/18)];return a<=He.bullInner?{base:50,ring:"INNER_BULL",sector:25,mult:2}:a<=He.bullOuter?{base:25,ring:"BULL",sector:25,mult:1}:a>=He.doubleOuter?{base:0,ring:"MISS",sector:null,mult:0}:a>=He.doubleInner?{base:n*2,ring:"DOUBLE",sector:n,mult:2}:a>=He.trebleOuter?{base:n,ring:"SINGLE",sector:n,mult:1}:a>=He.trebleInner?{base:n*3,ring:"TRIPLE",sector:n,mult:3}:{base:n,ring:"SINGLE",sector:n,mult:1}}function Wo(t,a,s="#10b981",i=2){if(a.length){t.save(),t.strokeStyle=s,t.lineWidth=i,t.beginPath(),t.moveTo(a[0].x,a[0].y);for(let n=1;n<a.length;n++)t.lineTo(a[n].x,a[n].y);t.closePath(),t.stroke(),t.restore()}}function yd(t,a,s="#f59e0b"){t.save(),t.strokeStyle=s,t.lineWidth=2,t.beginPath(),t.moveTo(a.x-8,a.y),t.lineTo(a.x+8,a.y),t.moveTo(a.x,a.y-8),t.lineTo(a.x,a.y+8),t.stroke(),t.restore()}function oa(t,a,s){return Math.max(a,Math.min(s,t))}function vd(t,a,s){const{width:i,data:n}=t,r=[[-1,0,1],[-2,0,2],[-1,0,1]],o=[[-1,-2,-1],[0,0,0],[1,2,1]];let l=0,d=0;for(let c=-1;c<=1;c++)for(let u=-1;u<=1;u++){const h=oa(a+u,0,i-1),p=(oa(s+c,0,t.height-1)*i+h)*4,g=n[p],S=n[p+1],D=n[p+2],I=.299*g+.587*S+.114*D;l+=I*r[c+1][u+1],d+=I*o[c+1][u+1]}return Math.hypot(l,d)}function jd(t,a,s=6){const n=t.getContext("2d").getImageData(0,0,t.width,t.height),r=oa(Math.round(a.x),1,t.width-2),o=oa(Math.round(a.y),1,t.height-2);let l={x:r,y:o,mag:-1};for(let d=o-s;d<=o+s;d++)for(let c=r-s;c<=r+s;c++){if(c<=0||d<=0||c>=t.width-1||d>=t.height-1)continue;const u=vd(n,c,d);u>l.mag&&(l={x:c,y:d,mag:u})}return{x:l.x,y:l.y}}function Nd(t,a,s=6){return a.map(i=>jd(t,i,s))}var dr,eo;function zo(){if(eo)return dr;eo=1;var t=t||{};return t.Image=function(a,s,i){this.width=a||0,this.height=s||0,this.data=i||[]},t.grayscale=function(a,s){for(var i=a.data,n=s.data,r=i.length,o=0,l=0;o<r;o+=4)n[l++]=i[o]*.299+i[o+1]*.587+i[o+2]*.114+.5&255;return s.width=a.width,s.height=a.height,s},t.threshold=function(a,s,i){var n=a.data,r=s.data,o=n.length,l=[],d;for(d=0;d<256;++d)l[d]=d<=i?0:255;for(d=0;d<o;++d)r[d]=l[n[d]];return s.width=a.width,s.height=a.height,s},t.adaptiveThreshold=function(a,s,i,n){var r=a.data,o=s.data,l=r.length,d=[],c;for(t.stackBoxBlur(a,s,i),c=0;c<768;++c)d[c]=c-255<=-n?255:0;for(c=0;c<l;++c)o[c]=d[r[c]-o[c]+255];return s.width=a.width,s.height=a.height,s},t.otsu=function(a){var s=a.data,i=s.length,n=[],r=0,o=0,l=0,d=0,c=0,u=0,h,x,p;for(p=0;p<256;++p)n[p]=0;for(p=0;p<i;++p)n[s[p]]++;for(p=0;p<256;++p)o+=n[p]*p;for(p=0;p<256;++p)if(d+=n[p],d!==0){if(c=i-d,c===0)break;l+=n[p]*p,h=l/d-(o-l)/c,x=d*c*h*h,x>u&&(u=x,r=p)}return r},t.stackBoxBlurMult=[1,171,205,293,57,373,79,137,241,27,391,357,41,19,283,265],t.stackBoxBlurShift=[0,9,10,11,9,12,10,11,12,9,13,13,10,9,13,13],t.BlurStack=function(){this.color=0,this.next=null},t.stackBoxBlur=function(a,s,i){var n=a.data,r=s.data,o=a.height,l=a.width,d=o-1,c=l-1,u=i+i+1,h=i+1,x=t.stackBoxBlurMult[i],p=t.stackBoxBlurShift[i],g,S,D,I,N,E,A,O,M,v;for(g=S=new t.BlurStack,v=1;v<u;++v)g=g.next=new t.BlurStack;for(g.next=S,N=0,M=0;M<o;++M){for(E=N,D=n[N],I=h*D,g=S,v=0;v<h;++v)g.color=D,g=g.next;for(v=1;v<h;++v)g.color=n[N+v],I+=g.color,g=g.next;for(g=S,O=0;O<l;++O)r[N++]=I*x>>>p,A=O+h,A=E+(A<c?A:c),I-=g.color-n[A],g.color=n[A],g=g.next}for(O=0;O<l;++O){for(N=O,E=N+l,D=r[N],I=h*D,g=S,v=0;v<h;++v)g.color=D,g=g.next;for(v=1;v<h;++v)g.color=r[E],I+=g.color,g=g.next,E+=l;for(g=S,M=0;M<o;++M)r[N]=I*x>>>p,A=M+h,A=O+(A<d?A:d)*l,I-=g.color-r[A],g.color=r[A],g=g.next,N+=l}return s},t.gaussianBlur=function(a,s,i,n){var r=t.gaussianKernel(n);return s.width=a.width,s.height=a.height,i.width=a.width,i.height=a.height,t.gaussianBlurFilter(a,i,r,!0),t.gaussianBlurFilter(i,s,r,!1),s},t.gaussianBlurFilter=function(a,s,i,n){var r=a.data,o=s.data,l=a.height,d=a.width,c=0,u=i.length>>1,h,x,p,g,S;for(p=0;p<l;++p)for(g=0;g<d;++g){for(x=0,S=-u;S<=u;++S)n?(h=c+S,(g+S<0||g+S>=d)&&(h=c)):(h=c+S*d,(p+S<0||p+S>=l)&&(h=c)),x+=i[u+S]*r[h];o[c++]=n?x:x+.5&255}return s},t.gaussianKernel=function(a){var s=[[1],[.25,.5,.25],[.0625,.25,.375,.25,.0625],[.03125,.109375,.21875,.28125,.21875,.109375,.03125]],i=[],n,r,o,l,d,c;if(a<=7&&a%2===1)i=s[a>>1];else{for(n=(a-1)*.5,r=.8+.3*(n-1),o=-.5/(r*r),l=0,c=0;c<a;++c)d=c-n,l+=i[c]=Math.exp(o*d*d);for(l=1/l,c=0;c<a;++c)i[c]*=l}return i},t.findContours=function(a,s){var i=a.width,n=a.height,r=[],o,l,d,c,u,h,x,p,g;for(o=t.binaryBorder(a,s),l=t.neighborhoodDeltas(i+2),d=i+3,u=1,p=0;p<n;++p,d+=2)for(g=0;g<i;++g,++d)c=o[d],c!==0&&(h=x=!1,c===1&&o[d-1]===0?h=!0:c>=1&&o[d+1]===0&&(x=!0),(h||x)&&(++u,r.push(t.borderFollowing(o,d,u,{x:g,y:p},x,l))));return r},t.borderFollowing=function(a,s,i,n,r,o){var l=[],d,c,u,h,x;l.hole=r,h=x=r?0:4;do if(h=h-1&7,d=s+o[h],a[d]!==0)break;while(h!==x);if(h===x)a[s]=-i,l.push({x:n.x,y:n.y});else for(c=s;;){x=h;do u=c+o[++h];while(a[u]===0);if(h&=7,h-1>>>0<x>>>0?a[c]=-i:a[c]===1&&(a[c]=i),l.push({x:n.x,y:n.y}),n.x+=t.neighborhood[h][0],n.y+=t.neighborhood[h][1],u===s&&c===d)break;c=u,h=h+4&7}return l},t.neighborhood=[[1,0],[1,-1],[0,-1],[-1,-1],[-1,0],[-1,1],[0,1],[1,1]],t.neighborhoodDeltas=function(a){for(var s=[],i=t.neighborhood.length,n=0;n<i;++n)s[n]=t.neighborhood[n][0]+t.neighborhood[n][1]*a;return s.concat(s)},t.approxPolyDP=function(a,s){var i={start_index:0,end_index:0},n={start_index:0,end_index:0},r=[],o=[],l=a.length,d,c,u,h,x,p,g,S,D,I,N;for(s*=s,N=0,D=0;D<3;++D)for(x=0,N=(N+n.start_index)%l,c=a[N],++N===l&&(N=0),I=1;I<l;++I)d=a[N],++N===l&&(N=0),g=d.x-c.x,S=d.y-c.y,h=g*g+S*S,h>x&&(x=h,n.start_index=I);for(x<=s?r.push({x:c.x,y:c.y}):(i.start_index=N,i.end_index=n.start_index+=i.start_index,n.start_index-=n.start_index>=l?l:0,n.end_index=i.start_index,n.end_index<n.start_index&&(n.end_index+=l),o.push({start_index:n.start_index,end_index:n.end_index}),o.push({start_index:i.start_index,end_index:i.end_index}));o.length!==0;){if(i=o.pop(),u=a[i.end_index%l],c=a[N=i.start_index%l],++N===l&&(N=0),i.end_index<=i.start_index+1)p=!0;else{for(x=0,g=u.x-c.x,S=u.y-c.y,D=i.start_index+1;D<i.end_index;++D)d=a[N],++N===l&&(N=0),h=Math.abs((d.y-c.y)*g-(d.x-c.x)*S),h>x&&(x=h,n.start_index=D);p=x*x<=s*(g*g+S*S)}p?r.push({x:c.x,y:c.y}):(n.end_index=i.end_index,i.end_index=n.start_index,o.push({start_index:n.start_index,end_index:n.end_index}),o.push({start_index:i.start_index,end_index:i.end_index}))}return r},t.warp=function(a,s,i,n){var r=a.data,o=s.data,l=a.width,d=a.height,c=0,u,h,x,p,g,S,D,I,N,E,A,O,M,v,b,F,z,T,U,w,_,ie,R;for(M=t.getPerspectiveTransform(i,n-1),v=M[8],b=M[2],F=M[5],ie=0;ie<n;++ie)for(v+=M[7],b+=M[1],F+=M[4],z=v,T=b,U=F,R=0;R<n;++R)z+=M[6],T+=M[0],U+=M[3],w=T/z,_=U/z,u=w>>>0,h=u===l-1?u:u+1,x=w-u,p=1-x,g=_>>>0,S=g===d-1?g:g+1,D=_-g,I=1-D,N=E=g*l,A=O=S*l,o[c++]=I*(p*r[N+u]+x*r[E+h])+D*(p*r[A+u]+x*r[O+h])&255;return s.width=n,s.height=n,s},t.getPerspectiveTransform=function(a,s){var i=t.square2quad(a);return i[0]/=s,i[1]/=s,i[3]/=s,i[4]/=s,i[6]/=s,i[7]/=s,i},t.square2quad=function(a){var s=[],i,n,r,o,l,d,c;return i=a[0].x-a[1].x+a[2].x-a[3].x,n=a[0].y-a[1].y+a[2].y-a[3].y,i===0&&n===0?(s[0]=a[1].x-a[0].x,s[1]=a[2].x-a[1].x,s[2]=a[0].x,s[3]=a[1].y-a[0].y,s[4]=a[2].y-a[1].y,s[5]=a[0].y,s[6]=0,s[7]=0,s[8]=1):(r=a[1].x-a[2].x,o=a[3].x-a[2].x,l=a[1].y-a[2].y,d=a[3].y-a[2].y,c=r*d-o*l,s[6]=(i*d-o*n)/c,s[7]=(r*n-i*l)/c,s[8]=1,s[0]=a[1].x-a[0].x+s[6]*a[1].x,s[1]=a[3].x-a[0].x+s[7]*a[3].x,s[2]=a[0].x,s[3]=a[1].y-a[0].y+s[6]*a[1].y,s[4]=a[3].y-a[0].y+s[7]*a[3].y,s[5]=a[0].y),s},t.isContourConvex=function(a){var s=0,i=!0,n=a.length,r=0,o=0,l,d,c,u,h,x,p,g;for(d=a[n-1],l=a[0],h=l.x-d.x,x=l.y-d.y;r<n;++r){if(++o===n&&(o=0),d=l,l=a[o],p=l.x-d.x,g=l.y-d.y,c=p*x,u=g*h,s|=u>c?1:u<c?2:3,s===3){i=!1;break}h=p,x=g}return i},t.perimeter=function(a){for(var s=a.length,i=0,n=s-1,r=0,o,l;i<s;n=i++)o=a[i].x-a[n].x,l=a[i].y-a[n].y,r+=Math.sqrt(o*o+l*l);return r},t.minEdgeLength=function(a){for(var s=a.length,i=0,n=s-1,r=1/0,o,l,d;i<s;n=i++)l=a[i].x-a[n].x,d=a[i].y-a[n].y,o=l*l+d*d,o<r&&(r=o);return Math.sqrt(r)},t.countNonZero=function(a,s){var i=a.data,n=s.height,r=s.width,o=s.x+s.y*a.width,l=a.width-r,d=0,c,u;for(c=0;c<n;++c){for(u=0;u<r;++u)i[o++]!==0&&++d;o+=l}return d},t.binaryBorder=function(a,s){var i=a.data,n=a.height,r=a.width,o=0,l=0,d,c;for(c=-2;c<r;++c)s[l++]=0;for(d=0;d<n;++d){for(s[l++]=0,c=0;c<r;++c)s[l++]=i[o++]===0?0:1;s[l++]=0}for(c=-2;c<r;++c)s[l++]=0;return s},dr=t,dr}var mr,to;function wd(){if(to)return mr;to=1;var t=zo(),a=a||{};return a.Marker=function(s,i){this.id=s,this.corners=i},a.Detector=function(){this.grey=new t.Image,this.thres=new t.Image,this.homography=new t.Image,this.binary=[],this.contours=[],this.polys=[],this.candidates=[]},a.Detector.prototype.detect=function(s){return t.grayscale(s,this.grey),t.adaptiveThreshold(this.grey,this.thres,2,7),this.contours=t.findContours(this.thres,this.binary),this.candidates=this.findCandidates(this.contours,s.width*.2,.05,10),this.candidates=this.clockwiseCorners(this.candidates),this.candidates=this.notTooNear(this.candidates,10),this.findMarkers(this.grey,this.candidates,49)},a.Detector.prototype.findCandidates=function(s,i,n,r){var o=[],l=s.length,d,c,u;for(this.polys=[],u=0;u<l;++u)d=s[u],d.length>=i&&(c=t.approxPolyDP(d,d.length*n),this.polys.push(c),c.length===4&&t.isContourConvex(c)&&t.minEdgeLength(c)>=r&&o.push(c));return o},a.Detector.prototype.clockwiseCorners=function(s){var i=s.length,n,r,o,l,d,c;for(c=0;c<i;++c)n=s[c][1].x-s[c][0].x,o=s[c][1].y-s[c][0].y,r=s[c][2].x-s[c][0].x,l=s[c][2].y-s[c][0].y,n*l-o*r<0&&(d=s[c][1],s[c][1]=s[c][3],s[c][3]=d);return s},a.Detector.prototype.notTooNear=function(s,i){var n=[],r=s.length,o,l,d,c,u,h;for(c=0;c<r;++c)for(u=c+1;u<r;++u){for(o=0,h=0;h<4;++h)l=s[c][h].x-s[u][h].x,d=s[c][h].y-s[u][h].y,o+=l*l+d*d;o/4<i*i&&(t.perimeter(s[c])<t.perimeter(s[u])?s[c].tooNear=!0:s[u].tooNear=!0)}for(c=0;c<r;++c)s[c].tooNear||n.push(s[c]);return n},a.Detector.prototype.findMarkers=function(s,i,n){var r=[],o=i.length,l,d,c;for(c=0;c<o;++c)l=i[c],t.warp(s,this.homography,l,n),t.threshold(this.homography,this.homography,t.otsu(this.homography)),d=this.getMarker(this.homography,l),d&&r.push(d);return r},a.Detector.prototype.getMarker=function(s,i){var n=s.width/7>>>0,r=n*n>>1,o=[],l=[],d=[],c,u,h,x,p;for(x=0;x<7;++x)for(h=x===0||x===6?1:6,p=0;p<7;p+=h)if(c={x:p*n,y:x*n,width:n,height:n},t.countNonZero(s,c)>r)return null;for(x=0;x<5;++x)for(o[x]=[],p=0;p<5;++p)c={x:(p+1)*n,y:(x+1)*n,width:n,height:n},o[x][p]=t.countNonZero(s,c)>r?1:0;for(l[0]=o,d[0]=this.hammingDistance(l[0]),u={first:d[0],second:0},x=1;x<4;++x)l[x]=this.rotate(l[x-1]),d[x]=this.hammingDistance(l[x]),d[x]<u.first&&(u.first=d[x],u.second=x);return u.first!==0?null:new a.Marker(this.mat2id(l[u.second]),this.rotate2(i,4-u.second))},a.Detector.prototype.hammingDistance=function(s){var i=[[1,0,0,0,0],[1,0,1,1,1],[0,1,0,0,1],[0,1,1,1,0]],n=0,r,o,l,d,c;for(l=0;l<5;++l){for(o=1/0,d=0;d<4;++d){for(r=0,c=0;c<5;++c)r+=s[l][c]===i[d][c]?0:1;r<o&&(o=r)}n+=o}return n},a.Detector.prototype.mat2id=function(s){var i=0,n;for(n=0;n<5;++n)i<<=1,i|=s[n][1],i<<=1,i|=s[n][3];return i},a.Detector.prototype.rotate=function(s){var i=[],n=s.length,r,o;for(r=0;r<n;++r)for(i[r]=[],o=0;o<s[r].length;++o)i[r][o]=s[s[r].length-o-1][r];return i},a.Detector.prototype.rotate2=function(s,i){var n=[],r=s.length,o;for(o=0;o<r;++o)n[o]=s[(i+o)%r];return n},mr=a,mr}var ur,so;function Rr(){if(so)return ur;so=1;var t=t||{};return t.svdcmp=function(a,s,i,n,r){var o,l,d,c,u,h,x,p,g=0,S,D,I=0,N,E,A=0,O,M,v,b=[];for(l=0;l<i;++l){if(x=l+1,b[l]=A*I,I=E=A=0,l<s){for(h=l;h<s;++h)A+=Math.abs(a[h][l]);if(A!==0){for(h=l;h<s;++h)a[h][l]/=A,E+=a[h][l]*a[h][l];for(D=a[l][l],I=-t.sign(Math.sqrt(E),D),N=D*I-E,a[l][l]=D-I,c=x;c<i;++c){for(E=0,h=l;h<s;++h)E+=a[h][l]*a[h][c];for(D=E/N,h=l;h<s;++h)a[h][c]+=D*a[h][l]}for(h=l;h<s;++h)a[h][l]*=A}}if(n[l]=A*I,I=E=A=0,l<s&&l!==i-1){for(h=x;h<i;++h)A+=Math.abs(a[l][h]);if(A!==0){for(h=x;h<i;++h)a[l][h]/=A,E+=a[l][h]*a[l][h];for(D=a[l][x],I=-t.sign(Math.sqrt(E),D),N=D*I-E,a[l][x]=D-I,h=x;h<i;++h)b[h]=a[l][h]/N;for(c=x;c<s;++c){for(E=0,h=x;h<i;++h)E+=a[c][h]*a[l][h];for(h=x;h<i;++h)a[c][h]+=E*b[h]}for(h=x;h<i;++h)a[l][h]*=A}}g=Math.max(g,Math.abs(n[l])+Math.abs(b[l]))}for(l=i-1;l>=0;--l){if(l<i-1){if(I!==0){for(c=x;c<i;++c)r[c][l]=a[l][c]/a[l][x]/I;for(c=x;c<i;++c){for(E=0,h=x;h<i;++h)E+=a[l][h]*r[h][c];for(h=x;h<i;++h)r[h][c]+=E*r[h][l]}}for(c=x;c<i;++c)r[l][c]=r[c][l]=0}r[l][l]=1,I=b[l],x=l}for(l=Math.min(i,s)-1;l>=0;--l){for(x=l+1,I=n[l],c=x;c<i;++c)a[l][c]=0;if(I!==0){for(I=1/I,c=x;c<i;++c){for(E=0,h=x;h<s;++h)E+=a[h][l]*a[h][c];for(D=E/a[l][l]*I,h=l;h<s;++h)a[h][c]+=D*a[h][l]}for(c=l;c<s;++c)a[c][l]*=I}else for(c=l;c<s;++c)a[c][l]=0;++a[l][l]}for(h=i-1;h>=0;--h)for(d=1;d<=30;++d){for(o=!0,x=h;x>=0;--x){if(p=x-1,Math.abs(b[x])+g===g){o=!1;break}if(Math.abs(n[p])+g===g)break}if(o)for(S=0,E=1,l=x;l<=h&&(D=E*b[l],Math.abs(D)+g!==g);++l)for(I=n[l],N=t.pythag(D,I),n[l]=N,N=1/N,S=I*N,E=-D*N,c=1;c<=s;++c)M=a[c][p],v=a[c][l],a[c][p]=M*S+v*E,a[c][l]=v*S-M*E;if(v=n[h],x===h){if(v<0)for(n[h]=-v,c=0;c<i;++c)r[c][h]=-r[c][h];break}if(d===30)return!1;for(O=n[x],p=h-1,M=n[p],I=b[p],N=b[h],D=((M-v)*(M+v)+(I-N)*(I+N))/(2*N*M),I=t.pythag(D,1),D=((O-v)*(O+v)+N*(M/(D+t.sign(I,D))-N))/O,S=E=1,c=x;c<=p;++c){for(l=c+1,I=b[l],M=n[l],N=E*I,I=S*I,v=t.pythag(D,N),b[c]=v,S=D/v,E=N/v,D=O*S+I*E,I=I*S-O*E,N=M*E,M*=S,u=0;u<i;++u)O=r[u][c],v=r[u][l],r[u][c]=O*S+v*E,r[u][l]=v*S-O*E;for(v=t.pythag(D,N),n[c]=v,v!==0&&(v=1/v,S=D*v,E=N*v),D=S*I+E*M,O=S*M-E*I,u=0;u<s;++u)M=a[u][c],v=a[u][l],a[u][c]=M*S+v*E,a[u][l]=v*S-M*E}b[x]=0,b[h]=D,n[h]=O}return!0},t.pythag=function(a,s){var i=Math.abs(a),n=Math.abs(s),r;return i>n?(r=n/i,i*Math.sqrt(1+r*r)):n===0?0:(r=i/n,n*Math.sqrt(1+r*r))},t.sign=function(a,s){return s>=0?Math.abs(a):-Math.abs(a)},ur=t,ur}var hr,no;function Sd(){if(no)return hr;no=1;var t=Rr(),a=a||{};return a.Posit=function(s,i){this.objectPoints=this.buildModel(s),this.focalLength=i,this.objectVectors=[],this.objectNormal=[],this.objectMatrix=[[],[],[]],this.init()},a.Posit.prototype.buildModel=function(s){var i=s/2;return[[-i,i,0],[i,i,0],[i,-i,0],[-i,-i,0]]},a.Posit.prototype.init=function(){var s=this.objectPoints.length,i=[],n=[],r=0,o=2,l;for(l=0;l<s;++l)this.objectVectors[l]=[this.objectPoints[l][0]-this.objectPoints[0][0],this.objectPoints[l][1]-this.objectPoints[0][1],this.objectPoints[l][2]-this.objectPoints[0][2]],i[l]=[this.objectVectors[l][0],this.objectVectors[l][1],this.objectVectors[l][2]];for(;r===0;)n[0]=this.objectVectors[1][1]*this.objectVectors[o][2]-this.objectVectors[1][2]*this.objectVectors[o][1],n[1]=this.objectVectors[1][2]*this.objectVectors[o][0]-this.objectVectors[1][0]*this.objectVectors[o][2],n[2]=this.objectVectors[1][0]*this.objectVectors[o][1]-this.objectVectors[1][1]*this.objectVectors[o][0],r=Math.sqrt(n[0]*n[0]+n[1]*n[1]+n[2]*n[2]),++o;for(l=0;l<3;++l)this.objectNormal[l]=n[l]/r;a.pseudoInverse(i,s,this.objectMatrix)},a.Posit.prototype.pose=function(s){var i=[[],[],[]],n=[[],[],[]],r=[],o=[[],[],[]],l=[[],[],[]],d=[],c=[],u,h,x,p,g,S;for(this.pos(s,i,n,r),x=this.isValid(i,r),x?u=this.iterate(s,i,r,o,d):u={euclidean:-1,pixels:-1,maximum:-1},p=this.isValid(n,r),p?h=this.iterate(s,n,r,l,c):h={euclidean:-1,pixels:-1,maximum:-1},g=0;g<3;++g)for(S=0;S<3;++S)x&&(d[g]-=o[g][S]*this.objectPoints[0][S]),p&&(c[g]-=l[g][S]*this.objectPoints[0][S]);return u.euclidean<h.euclidean?new a.Pose(u.pixels,o,d,h.pixels,l,c):new a.Pose(h.pixels,l,c,u.pixels,o,d)},a.Posit.prototype.pos=function(s,i,n,r){var o=this.objectPoints.length,l=[],d=[],c=[],u=[],h=[],x=[],p=[],g=[],S,D,I,N,E,A,O,M,v,b;for(v=0;v<o;++v)l[v]=[s[v].x-s[0].x,s[v].y-s[0].y];for(v=0;v<3;++v)for(d[v]=0,c[v]=0,b=0;b<o;++b)d[v]+=this.objectMatrix[v][b]*l[b][0],c[v]+=this.objectMatrix[v][b]*l[b][1];for(S=d[0]*d[0]+d[1]*d[1]+d[2]*d[2],D=c[0]*c[0]+c[1]*c[1]+c[2]*c[2],I=d[0]*c[0]+d[1]*c[1]+d[2]*c[2],N=(D-S)*(D-S)+4*(I*I),D-S>=0?E=(D-S+Math.sqrt(N))/2:E=(D-S-Math.sqrt(N))/2,E>=0?(A=Math.sqrt(E),A===0?O=0:O=-I/A):(A=Math.sqrt(-(I*I)/E),A===0?O=Math.sqrt(S-D):O=-I/A),v=0;v<3;++v)u[v]=d[v]+A*this.objectNormal[v],h[v]=c[v]+O*this.objectNormal[v];for(M=Math.sqrt(u[0]*u[0]+u[1]*u[1]+u[2]*u[2]),v=0;v<3;++v)x[v]=u[v]/M,p[v]=h[v]/M;for(g[0]=x[1]*p[2]-x[2]*p[1],g[1]=x[2]*p[0]-x[0]*p[2],g[2]=x[0]*p[1]-x[1]*p[0],v=0;v<3;++v)i[0][v]=x[v],i[1][v]=p[v],i[2][v]=g[v];for(v=0;v<3;++v)u[v]=d[v]-A*this.objectNormal[v],h[v]=c[v]-O*this.objectNormal[v];for(v=0;v<3;++v)x[v]=u[v]/M,p[v]=h[v]/M;for(g[0]=x[1]*p[2]-x[2]*p[1],g[1]=x[2]*p[0]-x[0]*p[2],g[2]=x[0]*p[1]-x[1]*p[0],v=0;v<3;++v)n[0][v]=x[v],n[1][v]=p[v],n[2][v]=g[v];r[0]=s[0].x/M,r[1]=s[0].y/M,r[2]=this.focalLength/M},a.Posit.prototype.isValid=function(s,i){for(var n=this.objectPoints.length,r=1/0,o=0,l;o<n;++o)l=i[2]+(s[2][0]*this.objectVectors[o][0]+s[2][1]*this.objectVectors[o][1]+s[2][2]*this.objectVectors[o][2]),l<r&&(r=l);return r>=0},a.Posit.prototype.iterate=function(s,i,n,r,o){var l=this.objectPoints.length,d=[],c=[],u=[[],[],[]],h=[[],[],[]],x=[],p=[],g=!1,S=0,D,I,N,E,A,O,M,v,b;for(v=0;v<l;++v)d[v]={x:s[v].x,y:s[v].y};for(v=0;v<3;++v){for(b=0;b<3;++b)r[v][b]=i[v][b];o[v]=n[v]}for(v=0;v<l;++v){for(N=0,b=0;b<3;++b)N+=this.objectVectors[v][b]*r[2][b]/o[2];c[v]={x:(1+N)*s[v].x,y:(1+N)*s[v].y}}for(I=0,v=0;v<l;++v)I+=Math.abs(c[v].x-d[v].x),I+=Math.abs(c[v].y-d[v].y);for(v=0;v<3;++v)x[v]=o[v]-(r[v][0]*this.objectPoints[0][0]+r[v][1]*this.objectPoints[0][1]+r[v][2]*this.objectPoints[0][2]);for(E=A=this.error(s,r,x),g=A.pixels===0||I<.01;S++<100&&!g;){for(v=0;v<l;++v)d[v].x=c[v].x,d[v].y=c[v].y;for(this.pos(c,u,h,o),v=0;v<3;++v)x[v]=o[v]-(u[v][0]*this.objectPoints[0][0]+u[v][1]*this.objectPoints[0][1]+u[v][2]*this.objectPoints[0][2]),p[v]=o[v]-(h[v][0]*this.objectPoints[0][0]+h[v][1]*this.objectPoints[0][1]+h[v][2]*this.objectPoints[0][2]);if(A=this.error(s,u,x),O=this.error(s,h,p),A.euclidean>=0&&O.euclidean>=0)if(O.euclidean<A.euclidean)for(E=O,v=0;v<3;++v)for(b=0;b<3;++b)r[v][b]=h[v][b];else for(E=A,v=0;v<3;++v)for(b=0;b<3;++b)r[v][b]=u[v][b];if(A.euclidean<0&&O.euclidean>=0)for(E=O,v=0;v<3;++v)for(b=0;b<3;++b)r[v][b]=h[v][b];if(O.euclidean<0&&A.euclidean>=0)for(E=A,v=0;v<3;++v)for(b=0;b<3;++b)r[v][b]=u[v][b];for(v=0;v<l;++v){for(N=0,b=0;b<3;++b)N+=this.objectVectors[v][b]*r[2][b]/o[2];c[v].x=(1+N)*s[v].x,c[v].y=(1+N)*s[v].y}for(D=I,I=0,v=0;v<l;++v)I+=Math.abs(c[v].x-d[v].x),I+=Math.abs(c[v].y-d[v].y);M=Math.abs(I-D),g=E.pixels===0||M<.01}return E},a.Posit.prototype.error=function(s,i,n){var r=this.objectPoints.length,o=[],l=[],d=[],c=0,u=0,h=0,x,p,g;if(!this.isValid(i,n))return{euclidean:-1,pixels:-1,maximum:-1};for(x=0;x<r;++x)for(o[x]=[],p=0;p<3;++p)o[x][p]=n[p];for(x=0;x<r;++x)for(p=0;p<3;++p)for(g=0;g<3;++g)o[x][p]+=i[p][g]*this.objectPoints[x][g];for(x=0;x<r;++x)for(l[x]=[],p=0;p<2;++p)l[x][p]=this.focalLength*o[x][p]/o[x][2];for(x=0;x<r;++x)d[x]=[l[x][0]-s[x].x,l[x][1]-s[x].y];for(x=0;x<r;++x)c+=Math.sqrt(d[x][0]*d[x][0]+d[x][1]*d[x][1]),u+=Math.abs(Math.round(l[x][0])-Math.round(s[x].x))+Math.abs(Math.round(l[x][1])-Math.round(s[x].y)),Math.abs(d[x][0])>h&&(h=Math.abs(d[x][0])),Math.abs(d[x][1])>h&&(h=Math.abs(d[x][1]));return{euclidean:c/r,pixels:u,maximum:h}},a.pseudoInverse=function(s,i,n){var r=[],o=[[],[],[]],l=[[],[],[]],d=0,c=0,u,h,x;for(t.svdcmp(s,i,3,r,o),u=0;u<3;++u)r[u]>d&&(d=r[u]);for(d*=.01,u=0;u<3;++u)r[u]<d&&(r[u]=0);for(h=0;h<3;++h)if(r[h]===0)for(++c,x=h;x<2;++x){for(u=0;u<i;++u)s[u][x]=s[u][x+1];for(u=0;u<3;++u)o[u][x]=o[u][x+1]}for(h=0;h<2;++h)r[h]===0&&(r[h]=r[h+1]);for(u=0;u<3;++u)for(h=0;h<3-c;++h)l[u][h]=o[u][h]/r[h];for(u=0;u<3;++u)for(h=0;h<i;++h)for(n[u][h]=0,x=0;x<3-c;++x)n[u][h]+=l[u][x]*s[h][x]},a.Pose=function(s,i,n,r,o,l){this.bestError=s,this.bestRotation=i,this.bestTranslation=n,this.alternativeError=r,this.alternativeRotation=o,this.alternativeTranslation=l},hr=a,hr}var fr,ao;function Cd(){if(ao)return fr;ao=1;var t=Rr(),a=a||{};a.Posit=function(n,r){this.model=this.buildModel(n),this.focalLength=r,this.init()},a.Posit.prototype.buildModel=function(n){var r=n/2;return[new s(-r,r,0),new s(r,r,0),new s(r,-r,0),new s(-r,-r,0)]},a.Posit.prototype.init=function(){var n=new s,r=new i,o;this.modelVectors=i.fromRows(s.sub(this.model[1],this.model[0]),s.sub(this.model[2],this.model[0]),s.sub(this.model[3],this.model[0])),o=i.clone(this.modelVectors),t.svdcmp(o.m,3,3,n.v,r.m),this.modelPseudoInverse=i.mult(i.mult(r,i.fromDiagonal(s.inverse(n))),i.transpose(o)),this.modelNormal=r.column(n.minIndex())},a.Posit.prototype.pose=function(n){var r=new s(1,1,1),o=new i,l=new i,d=new s,c=new s,u,h;return this.pos(n,r,o,l,d,c),u=this.iterate(n,o,d),h=this.iterate(n,l,c),u<h?new a.Pose(u,o.m,d.v,h,l.m,c.v):new a.Pose(h,l.m,c.v,u,o.m,d.v)},a.Posit.prototype.pos=function(n,r,o,l,d,c){var u=new s(n[1].x,n[2].x,n[3].x),h=new s(n[1].y,n[2].y,n[3].y),x=s.addScalar(s.mult(u,r),-n[0].x),p=s.addScalar(s.mult(h,r),-n[0].y),g=i.multVector(this.modelPseudoInverse,x),S=i.multVector(this.modelPseudoInverse,p),D=S.square()-g.square(),I=s.dot(g,S),N=0,E=0,A,O,M,v,b,F,z,T,U;D===0?(N=Math.sqrt(Math.abs(2*I)),E=-Math.PI/2*(I<0?-1:I>0?1:0)):(N=Math.sqrt(Math.sqrt(D*D+4*I*I)),E=Math.atan(-2*I/D),D<0&&(E+=Math.PI),E/=2),T=N*Math.cos(E),U=N*Math.sin(E),A=s.add(g,s.multScalar(this.modelNormal,T)),O=s.add(S,s.multScalar(this.modelNormal,U)),v=A.normalize(),b=O.normalize(),M=s.cross(A,O),o.copy(i.fromRows(A,O,M)),F=(v+b)/2,z=i.multVector(o,this.model[0]),d.v=[n[0].x/F-z.v[0],n[0].y/F-z.v[1],this.focalLength/F],A=s.sub(g,s.multScalar(this.modelNormal,T)),O=s.sub(S,s.multScalar(this.modelNormal,U)),v=A.normalize(),b=O.normalize(),M=s.cross(A,O),l.copy(i.fromRows(A,O,M)),F=(v+b)/2,z=i.multVector(l,this.model[0]),c.v=[n[0].x/F-z.v[0],n[0].y/F-z.v[1],this.focalLength/F]},a.Posit.prototype.iterate=function(n,r,o){for(var l=1/0,d=new i,c=new i,u=new s,h=new s,x=0,p,g,S,D;x<100&&(p=s.addScalar(s.multScalar(i.multVector(this.modelVectors,r.row(2)),1/o.v[2]),1),this.pos(n,p,d,c,u,h),S=this.getError(n,d,u),D=this.getError(n,c,h),S<D?(r.copy(d),o.copy(u),g=S):(r.copy(c),o.copy(h),g=D),!(g<=2||g>l));++x)l=g;return g},a.Posit.prototype.getError=function(n,r,o){var l=s.add(i.multVector(r,this.model[0]),o),d=s.add(i.multVector(r,this.model[1]),o),c=s.add(i.multVector(r,this.model[2]),o),u=s.add(i.multVector(r,this.model[3]),o),h,x,p,g,S,D,I,N,E;return l=l.v,d=d.v,c=c.v,u=u.v,l[0]*=this.focalLength/l[2],l[1]*=this.focalLength/l[2],d[0]*=this.focalLength/d[2],d[1]*=this.focalLength/d[2],c[0]*=this.focalLength/c[2],c[1]*=this.focalLength/c[2],u[0]*=this.focalLength/u[2],u[1]*=this.focalLength/u[2],h=[{x:l[0],y:l[1]},{x:d[0],y:d[1]},{x:c[0],y:c[1]},{x:u[0],y:u[1]}],x=this.angle(n[0],n[1],n[3]),p=this.angle(n[1],n[2],n[0]),g=this.angle(n[2],n[3],n[1]),S=this.angle(n[3],n[0],n[2]),D=this.angle(h[0],h[1],h[3]),I=this.angle(h[1],h[2],h[0]),N=this.angle(h[2],h[3],h[1]),E=this.angle(h[3],h[0],h[2]),(Math.abs(x-D)+Math.abs(p-I)+Math.abs(g-N)+Math.abs(S-E))/4},a.Posit.prototype.angle=function(n,r,o){var l=r.x-n.x,d=r.y-n.y,c=o.x-n.x,u=o.y-n.y;return Math.acos((l*c+d*u)/(Math.sqrt(l*l+d*d)*Math.sqrt(c*c+u*u)))*180/Math.PI},a.Pose=function(n,r,o,l,d,c){this.bestError=n,this.bestRotation=r,this.bestTranslation=o,this.alternativeError=l,this.alternativeRotation=d,this.alternativeTranslation=c};var s=function(n,r,o){this.v=[n||0,r||0,o||0]};s.prototype.copy=function(n){var r=this.v;return n=n.v,r[0]=n[0],r[1]=n[1],r[2]=n[2],this},s.add=function(n,r){var o=new s,l=o.v;return n=n.v,r=r.v,l[0]=n[0]+r[0],l[1]=n[1]+r[1],l[2]=n[2]+r[2],o},s.sub=function(n,r){var o=new s,l=o.v;return n=n.v,r=r.v,l[0]=n[0]-r[0],l[1]=n[1]-r[1],l[2]=n[2]-r[2],o},s.mult=function(n,r){var o=new s,l=o.v;return n=n.v,r=r.v,l[0]=n[0]*r[0],l[1]=n[1]*r[1],l[2]=n[2]*r[2],o},s.addScalar=function(n,r){var o=new s,l=o.v;return n=n.v,l[0]=n[0]+r,l[1]=n[1]+r,l[2]=n[2]+r,o},s.multScalar=function(n,r){var o=new s,l=o.v;return n=n.v,l[0]=n[0]*r,l[1]=n[1]*r,l[2]=n[2]*r,o},s.dot=function(n,r){return n=n.v,r=r.v,n[0]*r[0]+n[1]*r[1]+n[2]*r[2]},s.cross=function(n,r){return n=n.v,r=r.v,new s(n[1]*r[2]-n[2]*r[1],n[2]*r[0]-n[0]*r[2],n[0]*r[1]-n[1]*r[0])},s.prototype.normalize=function(){var n=this.v,r=Math.sqrt(n[0]*n[0]+n[1]*n[1]+n[2]*n[2]);return r>0&&(n[0]/=r,n[1]/=r,n[2]/=r),r},s.inverse=function(n){var r=new s,o=r.v;return n=n.v,n[0]!==0&&(o[0]=1/n[0]),n[1]!==0&&(o[1]=1/n[1]),n[2]!==0&&(o[2]=1/n[2]),r},s.prototype.square=function(){var n=this.v;return n[0]*n[0]+n[1]*n[1]+n[2]*n[2]},s.prototype.minIndex=function(){var n=this.v;return n[0]<n[1]?n[0]<n[2]?0:2:n[1]<n[2]?1:2};var i=function(){this.m=[[0,0,0],[0,0,0],[0,0,0]]};return i.clone=function(n){var r=new i,o=r.m;return n=n.m,o[0][0]=n[0][0],o[0][1]=n[0][1],o[0][2]=n[0][2],o[1][0]=n[1][0],o[1][1]=n[1][1],o[1][2]=n[1][2],o[2][0]=n[2][0],o[2][1]=n[2][1],o[2][2]=n[2][2],r},i.prototype.copy=function(n){var r=this.m;return n=n.m,r[0][0]=n[0][0],r[0][1]=n[0][1],r[0][2]=n[0][2],r[1][0]=n[1][0],r[1][1]=n[1][1],r[1][2]=n[1][2],r[2][0]=n[2][0],r[2][1]=n[2][1],r[2][2]=n[2][2],this},i.fromRows=function(n,r,o){var l=new i,d=l.m;return n=n.v,r=r.v,o=o.v,d[0][0]=n[0],d[0][1]=n[1],d[0][2]=n[2],d[1][0]=r[0],d[1][1]=r[1],d[1][2]=r[2],d[2][0]=o[0],d[2][1]=o[1],d[2][2]=o[2],l},i.fromDiagonal=function(n){var r=new i,o=r.m;return n=n.v,o[0][0]=n[0],o[1][1]=n[1],o[2][2]=n[2],r},i.transpose=function(n){var r=new i,o=r.m;return n=n.m,o[0][0]=n[0][0],o[0][1]=n[1][0],o[0][2]=n[2][0],o[1][0]=n[0][1],o[1][1]=n[1][1],o[1][2]=n[2][1],o[2][0]=n[0][2],o[2][1]=n[1][2],o[2][2]=n[2][2],r},i.mult=function(n,r){var o=new i,l=o.m;return n=n.m,r=r.m,l[0][0]=n[0][0]*r[0][0]+n[0][1]*r[1][0]+n[0][2]*r[2][0],l[0][1]=n[0][0]*r[0][1]+n[0][1]*r[1][1]+n[0][2]*r[2][1],l[0][2]=n[0][0]*r[0][2]+n[0][1]*r[1][2]+n[0][2]*r[2][2],l[1][0]=n[1][0]*r[0][0]+n[1][1]*r[1][0]+n[1][2]*r[2][0],l[1][1]=n[1][0]*r[0][1]+n[1][1]*r[1][1]+n[1][2]*r[2][1],l[1][2]=n[1][0]*r[0][2]+n[1][1]*r[1][2]+n[1][2]*r[2][2],l[2][0]=n[2][0]*r[0][0]+n[2][1]*r[1][0]+n[2][2]*r[2][0],l[2][1]=n[2][0]*r[0][1]+n[2][1]*r[1][1]+n[2][2]*r[2][1],l[2][2]=n[2][0]*r[0][2]+n[2][1]*r[1][2]+n[2][2]*r[2][2],o},i.multVector=function(n,r){return n=n.m,r=r.v,new s(n[0][0]*r[0]+n[0][1]*r[1]+n[0][2]*r[2],n[1][0]*r[0]+n[1][1]*r[1]+n[1][2]*r[2],n[2][0]*r[0]+n[2][1]*r[1]+n[2][2]*r[2])},i.prototype.column=function(n){var r=this.m;return new s(r[0][n],r[1][n],r[2][n])},i.prototype.row=function(n){var r=this.m;return new s(r[n][0],r[n][1],r[n][2])},fr=a,fr}var xr,ro;function kd(){return ro||(ro=1,xr={CV:zo(),AR:wd(),SVD:Rr(),POS1:Sd(),POS2:Cd()}),xr}var Ed=kd();const io=["top","right","bottom","left"],vs={top:0,right:1,bottom:2,left:3};let pr=null;function Td(){return pr||(pr=new Ed.AR.Detector),pr}function Id(t){const a=t.reduce((i,n)=>({x:i.x+n.x,y:i.y+n.y}),{x:0,y:0}),s=t.length||1;return{x:a.x/s,y:a.y/s}}function Md(t){try{const s=Td().detect(t)||[],i={},n=[];for(const h of s){const x=Id(h.corners);n.push({id:h.id,center:x});const p=Object.keys(vs).find(g=>vs[g]===h.id);p&&(i[p]={id:h.id,center:x})}const r=Object.keys(vs).filter(h=>!i[h]);if(r.length>0)return{success:!1,points:[],missing:r,markersFound:n,assignments:i,homography:null,errorPx:null,message:"Not all calibration markers were detected."};const o=[i.top.center,i.right.center,i.bottom.center,i.left.center],d=Ln().slice(0,4),c=jr(d,o),u=Nr(c,d,o);return{success:!0,points:o,missing:[],markersFound:n,assignments:i,homography:c,errorPx:u}}catch(a){return{success:!1,points:[],missing:Object.keys(vs),markersFound:[],assignments:{},homography:null,errorPx:null,message:a instanceof Error?a.message:"Marker detection failed"}}}function Dd(t){const a=t.getContext("2d");if(!a)return{success:!1,points:[],missing:Object.keys(vs),markersFound:[],assignments:{},homography:null,errorPx:null,message:"Canvas context unavailable for marker detection."};const s=a.getImageData(0,0,t.width,t.height);return Md(s)}const Ad={"0,0":[1,0,0,0,0],"0,1":[1,0,1,1,1],"1,0":[0,1,0,0,1],"1,1":[0,1,1,1,0]};function Rd(t){const a=new Array(5);let s=t>>>0;for(let n=4;n>=0;n--){const r=s&1;s>>=1;const o=s&1;s>>=1;const l=Ad[`${o},${r}`];if(!l)throw new Error(`Unsupported marker id pattern for row ${n}`);a[n]=l.slice()}const i=Array.from({length:7},()=>new Array(7).fill(0));for(let n=0;n<5;n++)for(let r=0;r<5;r++)i[n+1][r+1]=a[n][r];return i}async function qo(){const t=[];try{const a=await Pd();for(const s of a){const i=await Od(s,[80,8080,8787,8788,3e3,5e3]);for(const n of i){const r=await Ud(n.ip,n.port);r&&t.push(r)}}}catch(a){console.error("Network discovery failed:",a)}return t}async function Pd(){const t=[];try{const a=new RTCPeerConnection({iceServers:[]});a.createDataChannel("");const s=await a.createOffer();return await a.setLocalDescription(s),new Promise(i=>{const n=setTimeout(()=>{a.close(),i(t)},5e3);a.onicecandidate=r=>{if(r.candidate){const l=r.candidate.candidate.match(/(\d+\.\d+\.\d+\.\d+)/);if(l&&l[1]&&!t.includes(l[1])){const d=l[1];Ld(d)&&t.push(d)}}else clearTimeout(n),a.close(),i(t)}})}catch(a){return console.error("Failed to get local IPs:",a),["192.168.1.0"]}}function Ld(t){const a=t.split(".").map(Number);return a[0]===10||a[0]===172&&a[1]>=16&&a[1]<=31||a[0]===192&&a[1]===168}async function Od(t,a){const s=[],i=t.split(".").slice(0,3).join("."),n=[];for(let o=1;o<=254;o++){const l=`${i}.${o}`;for(const d of a)n.push(Bd(l,d))}return(await Promise.allSettled(n)).forEach((o,l)=>{if(o.status==="fulfilled"&&o.value){const d=l%a.length,c=Math.floor(l/a.length),u=`${i}.${c+1}`;s.push({ip:u,port:a[d]})}}),s}async function Bd(t,a){try{const s=await fetch(`http://${t}:${a}/`,{method:"HEAD",mode:"no-cors",signal:AbortSignal.timeout(2e3)});return!0}catch{return!1}}async function Ud(t,a){try{const s=["/","/api/info","/api/status","/camera","/stream"];for(const i of s)try{const n=await fetch(`http://${t}:${a}${i}`,{method:"GET",signal:AbortSignal.timeout(3e3)});if(n.ok){const r=n.headers.get("content-type")||"",o=await n.text();if(o.includes("OMNI")||o.includes("omni")||i.includes("omni"))return{id:`omni-${t}-${a}`,name:`OMNI Camera (${t})`,ip:t,port:a,type:"omni",capabilities:["video","calibration"],status:"online",connectionType:"wifi"};if(o.includes("VERT")||o.includes("vert")||i.includes("vert"))return{id:`vert-${t}-${a}`,name:`VERT Camera (${t})`,ip:t,port:a,type:"vert",capabilities:["video","calibration"],status:"online",connectionType:"wifi"};if(r.includes("video")||o.includes("stream")||i==="/stream")return{id:`generic-${t}-${a}`,name:`Network Camera (${t})`,ip:t,port:a,type:"generic",capabilities:["video"],status:"online",connectionType:"wifi"}}}catch{}}catch(s){console.error(`Failed to probe device ${t}:${a}:`,s)}return null}async function $d(){const t=[];try{if(!("serial"in navigator))return console.warn("Web Serial API not supported in this browser"),t;const a=await navigator.serial.getPorts();for(const s of a){const i=await Vo(s);i&&t.push(i)}}catch(a){console.error("USB device discovery failed:",a)}return t}async function Fd(){try{if(!("serial"in navigator))return alert("Web Serial API not supported in this browser. Please use a compatible browser like Chrome or Edge."),null;const t=await navigator.serial.requestPort();return await Vo(t)}catch(t){return t.name!=="NotFoundError"&&console.error("USB device request failed:",t),null}}async function Vo(t){try{await t.open({baudRate:9600,dataBits:8,stopBits:1,parity:"none"});const a=t.readable?.getReader();if(a)try{const s=setTimeout(()=>a.cancel(),2e3),{value:i,done:n}=await a.read();if(clearTimeout(s),!n&&i){const r=new TextDecoder().decode(i);if(r.includes("OMNI")||r.includes("omni"))return a.releaseLock(),{id:`usb-omni-${Date.now()}`,name:"OMNI Camera (USB)",type:"omni",capabilities:["video","calibration"],status:"online",port:t};if(r.includes("VERT")||r.includes("vert"))return a.releaseLock(),{id:`usb-vert-${Date.now()}`,name:"VERT Camera (USB)",type:"vert",capabilities:["video","calibration"],status:"online",port:t}}}catch{}finally{try{a.releaseLock()}catch{}}return{id:`usb-generic-${Date.now()}`,name:"USB Scoring Device",type:"generic",capabilities:["video"],status:"online",port:t}}catch(a){return console.error("Failed to probe USB device:",a),null}}async function Go(t){try{const a=`http://${t.ip}:${t.port}/stream`,s=document.createElement("video");return s.src=a,s.crossOrigin="anonymous",new Promise((i,n)=>{s.onloadeddata=()=>{const r=document.createElement("canvas"),o=r.getContext("2d");r.width=s.videoWidth,r.height=s.videoHeight;const l=r.captureStream(30),d=()=>{s.readyState>=2&&o.drawImage(s,0,0),requestAnimationFrame(d)};d(),i(l)},s.onerror=()=>n(new Error("Failed to load video stream")),s.load()})}catch(a){return console.error("Failed to connect to network device:",a),null}}async function _d(t){try{if(!t.port)throw new Error("No serial port available");return console.log("USB device connection not fully implemented yet"),null}catch(a){return console.error("Failed to connect to USB device:",a),null}}function Hd(){const t=m.useRef(null),a=m.useRef(null),s=m.useRef(null),i=m.useRef(null),[n,r]=m.useState(!1),[o,l]=m.useState(!1),[d,c]=m.useState("camera"),[u,h]=m.useState(()=>localStorage.getItem("ndn:cal:mode")||"local"),[x,p]=m.useState([]),[g,S]=m.useState(!1),[D,I]=m.useState(null),[N,E]=m.useState(1),[A,O]=m.useState(()=>{if(typeof window>"u")return!1;try{return window.localStorage.getItem("ndn:cal:forceDesktop")==="1"}catch{return!1}}),[M,v]=m.useState(()=>typeof navigator>"u"?!1:/Android|iPhone|iPad|iPod|Mobi/i.test(navigator.userAgent)),{H:b,setCalibration:F,reset:z,errorPx:T,locked:U}=ha(),w=zn(),{calibrationGuide:_,setCalibrationGuide:ie,preferredCameraId:R,cameraEnabled:Z,setCameraEnabled:ae,preferredCameraLocked:Me,setPreferredCameraLocked:st,setPreferredCamera:Se}=is(),[Te,dt]=m.useState(null),[ye,We]=m.useState(!1),[Ve,Ge]=m.useState(0),[Re,te]=m.useState(null),at=m.useCallback((B,X=480)=>{if(typeof document>"u")throw new Error("Marker rendering only available in browser context");const K=Rd(B),q=document.createElement("canvas");q.width=X,q.height=X;const V=q.getContext("2d");if(!V)throw new Error("Unable to create marker canvas context");V.imageSmoothingEnabled=!1,V.fillStyle="#ffffff",V.fillRect(0,0,X,X);const Ce=X*.08,pe=K.length,be=(X-Ce*2)/pe,ot=Ce;for(let Nt=0;Nt<pe;Nt++)for(let vt=0;vt<pe;vt++){const It=K[Nt][vt];V.fillStyle=It===1?"#000000":"#ffffff",V.fillRect(ot+vt*be,ot+Nt*be,be,be)}return V.strokeStyle="#000000",V.lineWidth=Math.max(2,be*.08),V.strokeRect(ot,ot,be*pe,be*pe),q.toDataURL("image/png")},[]);m.useCallback(()=>{try{const B=io.map(q=>{const V=vs[q];return{key:q,id:V,dataUrl:at(V)}}),X=window.open("","_blank","width=900,height=1200");if(!X)throw new Error("Popup blocked by browser");const K=`<!DOCTYPE html>
			<html>
			<head>
				<meta charset="utf-8" />
				<title>Nine Dart Nation – Marker Sheet</title>
				<style>
					body { font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; margin: 24px; color: #0f172a; }
					h1 { font-size: 20px; margin-bottom: 4px; }
					p { margin-top: 0; opacity: 0.7; }
					.grid { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 32px; margin-top: 24px; }
					.marker { text-align: center; }
					.marker h2 { font-size: 16px; margin: 12px 0 8px; }
					.marker img { width: 100%; max-width: 360px; border: 1px solid #0f172a; }
					footer { margin-top: 24px; font-size: 12px; opacity: 0.6; }
				</style>
			</head>
			<body>
				<h1>Marker sheet</h1>
				<p>Print at 100% scale on letter/A4 paper. Cut out and tape each marker so it is flush with the outer double ring.</p>
				<div class="grid">
					${B.map(q=>`
						<div class="marker">
							<h2>${q.key.toUpperCase()} • ID ${q.id}</h2>
							<img src="${q.dataUrl}" alt="Marker ${q.key}" />
						</div>
					`).join("")}
				</div>
				<footer>Tip: Keep markers flat, smooth, and unobstructed for best detection results.</footer>
			</body>
			</html>`;X.document.write(K),X.document.close()}catch(B){console.error("Marker sheet generation failed",B),alert(`Unable to open marker sheet: ${B?.message||B}`)}},[at]);const[fe,Pe]=m.useState(null),he=m.useRef(!1),[ce,rt]=m.useState(null),De=m.useRef(null),mt=m.useCallback(B=>{De.current=B,rt(B)},[rt]),[tt,ne]=m.useState(null),[de,ge]=m.useState(Date.now()),[me,ze]=m.useState(!1),ke=m.useRef(null),lt=m.useRef([]),[yt,k]=m.useState(""),[ee,At]=m.useState(null),[Ae,Mt]=m.useState(null),[Rt,Pt]=m.useState(!0),[Oe,_t]=m.useState([]),[Et,Lt]=m.useState(!1),[ht,$t]=m.useState(null),jt=m.useRef(null);m.useEffect(()=>{const B=window.location.hostname;(B==="localhost"||B==="127.0.0.1")&&kt("/api/hosts").then(X=>X.json()).then(X=>{const K=Array.isArray(X?.hosts)&&X.hosts.find(q=>q);K&&At(K)}).catch(()=>{}),kt("/api/https-info").then(X=>X.json()).then(X=>{X&&typeof X.https=="boolean"&&Mt({https:!!X.https,port:Number(X.port)||8788})}).catch(()=>{})},[]);const Tt=m.useMemo(()=>{const B=ce||"____",X="ws://localhost:8787";if(X.length>0)try{const pe=new URL(X);return`${`${pe.protocol==="wss:"?"https":"http"}://${pe.host}${pe.pathname.endsWith("/ws")?"":pe.pathname}`.replace(/\/?ws$/i,"")}/mobile-cam.html?code=${B}`}catch{}const K=ee||window.location.hostname,q=!!Ae?.https,V=q?Ae?.port||8788:8787;return`${q?"https":"http"}://${K}:${V}/mobile-cam.html?code=${B}`},[ce,ee,Ae]),H=m.useMemo(()=>{if(!Tt)return null;try{const B=new URL(Tt);return B.searchParams.delete("code"),B.toString().replace(/\?$/,"")}catch{return typeof window<"u"?`${window.location.origin.replace(/\/$/,"")}/mobile-cam.html`:"/mobile-cam.html"}},[Tt]);m.useEffect(()=>{localStorage.setItem("ndn:cal:mode",u)},[u]),m.useEffect(()=>{if(!(typeof window>"u"))try{A?window.localStorage.setItem("ndn:cal:forceDesktop","1"):window.localStorage.removeItem("ndn:cal:forceDesktop")}catch{}},[A]),m.useEffect(()=>{if(typeof window>"u")return;const B=window.matchMedia("(pointer: coarse)"),X=()=>{const K=typeof navigator<"u"&&/Android|iPhone|iPad|iPod|Mobi/i.test(navigator.userAgent),q=typeof B.matches=="boolean"?B.matches:!1,V=window.innerWidth<=820;v(K||q||V)};X();try{typeof B.addEventListener=="function"?B.addEventListener("change",X):typeof B.addListener=="function"&&B.addListener(X)}catch{}return window.addEventListener("resize",X),()=>{try{typeof B.removeEventListener=="function"?B.removeEventListener("change",X):typeof B.removeListener=="function"&&B.removeListener(X)}catch{}window.removeEventListener("resize",X)}},[]),m.useEffect(()=>{if(!ce){k("");return}Fo.toDataURL(Tt,{width:160,margin:1,color:{dark:"#000000",light:"#ffffff"}}).then(k).catch(()=>k(""))},[Tt,ce]),m.useEffect(()=>{if(!tt)return;const B=setInterval(()=>ge(Date.now()),1e3);return()=>clearInterval(B)},[tt]);const Ne=m.useMemo(()=>tt?Math.max(0,Math.ceil((tt-de)/1e3)):null,[tt,de]);m.useEffect(()=>()=>{jt.current&&window.clearTimeout(jt.current)},[]);const Ye=m.useCallback(async(B,X)=>{if(B)try{if(navigator.clipboard&&navigator.clipboard.writeText)await navigator.clipboard.writeText(B);else{const K=document.createElement("textarea");K.value=B,K.style.position="fixed",K.style.opacity="0",document.body.appendChild(K),K.focus(),K.select(),document.execCommand("copy"),document.body.removeChild(K)}$t(X),jt.current&&window.clearTimeout(jt.current),jt.current=window.setTimeout(()=>$t(null),1500)}catch(K){console.warn("[Calibrator] Copy failed:",K),$t(null)}},[]);m.useEffect(()=>{async function B(){try{if(console.log("[Calibrator] Requesting camera permission on load..."),await navigator.mediaDevices.getUserMedia({video:!0,audio:!1}),console.log("[Calibrator] Camera permission granted"),navigator.mediaDevices){const X=await navigator.mediaDevices.enumerateDevices();console.log("[Calibrator] Found devices:",X.filter(K=>K.kind==="videoinput").length,"cameras")}}catch(X){const K=X&&(X.name||X.code)||"";K==="NotAllowedError"?console.warn("[Calibrator] Camera permission denied by user"):K==="NotFoundError"||K==="NotAvailable"?console.warn("[Calibrator] No camera device found"):console.warn("[Calibrator] Camera permission request failed:",X)}}B()},[]),m.useEffect(()=>()=>{},[]),m.useEffect(()=>{const B=X=>{console.log("[Calibrator] Received reconnect request from PhoneCameraOverlay"),u==="phone"&&me&&(le(!1),setTimeout(()=>{Ot()},500))};return window.addEventListener("ndn:phone-camera-reconnect",B),()=>{window.removeEventListener("ndn:phone-camera-reconnect",B)}},[u,me]),m.useEffect(()=>{console.log("[Calibrator] 🔄 STREAMING CHANGED:",{streaming:n,videoRefAvailable:!!t.current}),t.current?(console.log("[Calibrator] ✅ Syncing videoElementRef on streaming change"),w.setVideoElementRef(t.current),t.current.srcObject instanceof MediaStream&&(console.log("[Calibrator] ✅ Setting mediaStream from video element"),w.setMediaStream(t.current.srcObject))):console.warn("[Calibrator] ⚠️ videoRef.current is null on streaming change!")},[n]),m.useEffect(()=>(console.log("[Calibrator] 🚀 MOUNT: Initial mount - syncing videoRef"),console.log("[Calibrator] videoRef.current available:",!!t.current),console.log("[Calibrator] videoRef.current type:",t.current?.constructor?.name),t.current?(console.log("[Calibrator] ✅ Setting videoElementRef on mount"),console.log("[Calibrator] Video element:",{tagName:t.current.tagName,srcObject:!!t.current.srcObject,videoWidth:t.current.videoWidth,videoHeight:t.current.videoHeight}),w.setVideoElementRef(t.current),console.log("[Calibrator] ✅ videoElementRef set successfully")):console.error("[Calibrator] ❌ CRITICAL: videoRef.current is NULL at mount!"),()=>{console.log("[Calibrator] 🛑 UNMOUNT: Clearing videoElementRef"),w.setVideoElementRef(null)}),[]);function Ht(){if(fe&&(fe.readyState===WebSocket.OPEN||fe.readyState===WebSocket.CONNECTING))return console.log("[Calibrator] ensureWS: Reusing existing WebSocket (state:",fe.readyState,")"),fe;const B="ws://localhost:8787",X=B.length>0?B.endsWith("/ws")?B:B.replace(/\/$/,"")+"/ws":void 0,q=`${window.location.protocol==="https:"?"wss":"ws"}://${window.location.host}/ws`,V=window.location.hostname,pe=X||(V.endsWith("onrender.com")?q:"wss://ninedartnation.onrender.com/ws");console.log("[Calibrator] ensureWS: Creating new WebSocket to:",pe);let Fe=new WebSocket(pe);return Fe.onerror=be=>{console.error("[Calibrator] WebSocket connection error:",be),alert("Failed to connect to camera pairing service. Please check your internet connection and try again.")},Fe.onclose=be=>{if(console.log("[Calibrator] WebSocket closed:",be.code,be.reason),ke.current){try{ke.current.close()}catch{}ke.current=null}mt(null),ne(null),ze(!1),be.code!==1e3&&(alert("Camera pairing connection lost. Please try pairing again."),u==="phone"&&h("local"))},Pe(Fe),Fe}async function Ot(){h("phone"),le(!1),Le();try{ae(!0)}catch{}const B=Ht();B.readyState===WebSocket.OPEN?(console.log("[Calibrator] WebSocket open, sending cam-create"),B.send(JSON.stringify({type:"cam-create"}))):(console.log("[Calibrator] WebSocket connecting, will send cam-create on open"),B.onopen=()=>{console.log("[Calibrator] WebSocket now open, sending cam-create"),B.send(JSON.stringify({type:"cam-create"}))}),B.onmessage=async X=>{const K=JSON.parse(X.data);if(K.type==="cam-code")mt(K.code),K.expiresAt&&ne(K.expiresAt);else if(K.type==="cam-peer-joined"){!De.current&&K.code&&mt(K.code),ze(!0);const q=De.current||K.code||null;q&&(De.current=q);try{if(U&&q){const Ce=a.current?{w:a.current.width,h:a.current.height}:null,pe={H:b,imageSize:Ce,errorPx:T??null,createdAt:Date.now()};B.send(JSON.stringify({type:"cam-calibration",code:q,payload:pe})),console.log("[Calibrator] Sent calibration to joined phone for code",q)}}catch(Ce){console.warn("[Calibrator] Failed to send calibration on peer join",Ce)}const V=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}],iceCandidatePoolSize:10});ke.current=V,V.onconnectionstatechange=()=>{console.log("WebRTC connection state:",V.connectionState),V.connectionState==="failed"||V.connectionState==="disconnected"?(console.error("WebRTC connection failed"),alert("Camera connection lost. Please try pairing again."),le(!1)):V.connectionState==="connected"&&console.log("WebRTC connection established")},V.onicecandidate=Ce=>{Ce.candidate&&q&&B.send(JSON.stringify({type:"cam-ice",code:q,payload:Ce.candidate}))},V.ontrack=Ce=>{if(console.log("[Calibrator] WebRTC ontrack received:",Ce.streams?.length,"streams, track kind:",Ce.track?.kind),t.current){const pe=Ce.streams?.[0];pe?(console.log("[Calibrator] Assigning video stream (tracks:",pe.getTracks().length,") to video element"),S(!1),setTimeout(()=>{t.current&&(console.log("[Calibrator] Setting srcObject and attempting play"),t.current.srcObject&&t.current.srcObject.getTracks().forEach(be=>be.stop()),t.current.srcObject=pe,t.current.muted=!0,t.current.playsInline=!0,t.current.play().then(()=>{console.log("[Calibrator] Video playback started successfully"),r(!0),c("capture"),w.setStreaming(!0),w.setMode("phone"),w.setMediaStream(pe);try{Se(void 0,"Phone Camera",!0)}catch{}if(!Me)try{st(!0),he.current=!0}catch{}try{ae(!0)}catch{}l(!1)}).catch(Fe=>{console.error("[Calibrator] Video play failed:",Fe),l(!0),console.warn("[Calibrator] video play blocked — prompting user interaction")}))},100)):console.error("[Calibrator] No inbound stream received in ontrack")}else console.error("[Calibrator] Video element not available")};try{const Ce=await V.createOffer({offerToReceiveAudio:!1,offerToReceiveVideo:!0});await V.setLocalDescription(Ce),console.log("[Calibrator] Sending cam-offer for code:",q),q?B.send(JSON.stringify({type:"cam-offer",code:q,payload:Ce})):console.warn("[Calibrator] Missing pairing code when sending offer")}catch(Ce){console.error("Failed to create WebRTC offer:",Ce),alert("Failed to establish camera connection. Please try again."),le(!1)}}else if(K.type==="cam-answer"){console.log("[Calibrator] Received cam-answer");const q=ke.current;if(q)try{await q.setRemoteDescription(new RTCSessionDescription(K.payload)),console.log("[Calibrator] Remote description set (answer)");const V=lt.current;console.log(`[Calibrator] Processing ${V.length} pending ICE candidates`);for(const Ce of V)try{await q.addIceCandidate(Ce),console.log("[Calibrator] Queued ICE candidate added")}catch(pe){console.error("Failed to add queued ICE candidate:",pe)}lt.current=[]}catch(V){console.error("Failed to set remote description:",V),alert("Camera pairing failed. Please try again."),le(!1)}else console.warn("[Calibrator] Received cam-answer but no peer connection exists")}else if(K.type==="cam-ice"){console.log("[Calibrator] Received cam-ice");const q=ke.current;if(q)if(q.remoteDescription)try{await q.addIceCandidate(K.payload),console.log("[Calibrator] ICE candidate added")}catch(V){console.error("Failed to add ICE candidate:",V)}else console.log("[Calibrator] Remote description not set yet, queuing ICE candidate"),lt.current.push(K.payload);else console.warn("[Calibrator] Received ICE candidate but no peer connection exists")}else if(K.type==="cam-error")console.error("Camera pairing error:",K.code),alert(K.code==="EXPIRED"?"Code expired. Generate a new code.":`Camera error: ${K.code||"Unknown error"}`),le(!1);else if(K.type==="cam-calibration"){console.log("[Calibrator] Received calibration from peer:",K.payload);try{K.payload&&K.payload.H&&Array.isArray(K.payload.H)&&(F({H:K.payload.H,createdAt:K.payload.createdAt||Date.now(),errorPx:K.payload.errorPx,imageSize:K.payload.imageSize,locked:!0}),console.log("[Calibrator] Applied received calibration"))}catch(q){console.error("[Calibrator] Failed to apply received calibration",q)}}}}async function $(){Lt(!0);try{const B=await qo();_t(B),B.length===0&&alert("No wifi scoring devices found on your network. Make sure devices are powered on and connected to the same network.")}catch(B){console.error("Wifi device discovery failed:",B),alert("Failed to discover wifi devices. Please check your network connection.")}finally{Lt(!1)}c("camera")}async function J(B){try{_t(K=>K.map(q=>q.id===B.id?{...q,status:"connecting"}:q));const X=await Go(B);if(X&&t.current)t.current.srcObject&&t.current.srcObject.getTracks().forEach(q=>q.stop()),t.current.srcObject=X,await t.current.play(),r(!0),c("capture"),_t(K=>K.map(q=>q.id===B.id?{...q,status:"online"}:q));else throw new Error("Failed to get video stream")}catch(X){console.error("Failed to connect to wifi device:",X),alert(`Failed to connect to ${B.name}. Please check the device and try again.`),_t(K=>K.map(q=>q.id===B.id?{...q,status:"offline"}:q))}}async function ue(){if(u==="phone")return Ot();if(u==="wifi")return $();try{console.log("[Calibrator] Attempting camera access...");const B={video:R?{deviceId:{exact:R}}:{facingMode:"environment"},audio:!1};console.log("[Calibrator] Camera constraints:",B);let X;try{X=await navigator.mediaDevices.getUserMedia(B),console.log("[Calibrator] Camera stream obtained:",X)}catch(K){const q=K&&(K.name||K.code)||"";if(console.warn("[Calibrator] Preferred camera not available:",K),R&&(q==="OverconstrainedError"||q==="NotFoundError"||q==="NotAllowedError"))X=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"},audio:!1}),console.log("[Calibrator] Fallback camera stream obtained:",X);else throw K}if(t.current)t.current.srcObject&&t.current.srcObject.getTracks().forEach(q=>q.stop()),t.current.srcObject=X,await t.current.play(),console.log("[Calibrator] Video playback started"),r(!0),c("capture");else throw console.warn("[Calibrator] videoRef.current is null - cannot display camera"),X.getTracks().forEach(K=>K.stop()),new Error("Camera element not available")}catch(B){console.error("[Calibrator] Camera access failed:",B),alert(`Camera access failed: ${B instanceof Error?B.message:"Unknown error"}. Try refreshing the page or check camera permissions.`)}}function le(B=!1){if(t.current&&t.current.srcObject&&(t.current.srcObject.getTracks().forEach(K=>K.stop()),t.current.srcObject=null,r(!1)),ke.current){try{ke.current.close()}catch{}ke.current=null}if(lt.current=[],mt(null),ne(null),ze(!1),te(null),w.setStreaming(!1),w.setMediaStream(null),he.current){try{st(!1)}catch{}he.current=!1}B&&(u==="phone"||u==="wifi")&&h("local")}function Xe(){fe&&fe.readyState===WebSocket.OPEN?fe.send(JSON.stringify({type:"cam-create"})):Ot(),Le()}function Le(){try{Me?he.current:(st(!0),he.current=!0)}catch{}}function je(){try{i.current?.click()}catch{}}function $e(B){const X=B.target.files?.[0];if(!X)return;const K=new Image;K.onload=()=>{try{if(!a.current)return;const q=a.current;q.width=K.naturalWidth,q.height=K.naturalHeight,q.getContext("2d").drawImage(K,0,0,q.width,q.height),S(!0),I({w:q.width,h:q.height}),c("select"),p([]),te(null),le(!1)}catch{}},K.onerror=()=>{alert("Could not load image. Please try a different photo.")},K.src=URL.createObjectURL(X);try{B.target.value=""}catch{}}function Bt(){if(!t.current||!a.current)return;const B=t.current,X=a.current;X.width=B.videoWidth,X.height=B.videoHeight,X.getContext("2d").drawImage(B,0,0,X.width,X.height),S(!0),I({w:X.width,h:X.height}),c("select"),p([]),te(null),ye&&setTimeout(()=>{Fs()},0)}function it(B=x,X=null){if(!a.current||!s.current)return;const K=a.current,q=s.current;q.width=K.width,q.height=K.height;const V=q.getContext("2d");V.clearRect(0,0,q.width,q.height);const Ce=X||b;if(Ce){const pe=[He.bullInner,He.bullOuter,He.trebleInner,He.trebleOuter,He.doubleInner,He.doubleOuter];for(const Fe of pe){const be=U?"#10b981":Fe===He.doubleOuter?"#22d3ee":"#a78bfa",ot=U||Fe===He.doubleOuter?3:2,Nt=Ho(Ce,Fe,360);Wo(V,Nt,be,ot)}}if(!Ce&&Te){const pe=(Fe,be,ot=2)=>{V.save(),V.strokeStyle=be,V.lineWidth=ot,V.beginPath(),V.arc(Te.cx,Te.cy,Fe,0,Math.PI*2),V.stroke(),V.restore()};pe(Te.doubleOuter,"#22d3ee",3),pe(Te.doubleInner,"#22d3ee",2),pe(Te.trebleOuter,"#fde047",2),pe(Te.trebleInner,"#fde047",2),pe(Te.bullOuter,"#34d399",2),pe(Te.bullInner,"#10b981",3)}if(B.length<6&&Ce){V.save(),V.strokeStyle="rgba(255,193,7,0.4)",V.lineWidth=2,V.setLineDash([4,4]);const pe=Ln();for(let Fe=B.length;Fe<6&&Fe<pe.length;Fe++)try{const be=fa(Ce,pe[Fe]);V.beginPath(),V.arc(be.x,be.y,12,0,Math.PI*2),V.stroke()}catch{}V.restore()}if(B.forEach((pe,Fe)=>{yd(V,pe,"#f472b6"),V.save(),V.fillStyle="#f472b6",V.font="14px sans-serif",V.fillText(String(Fe+1),pe.x+6,pe.y-6),V.restore()}),_&&!U){V.save(),V.fillStyle="rgba(59,130,246,0.10)";const pe=Math.round(Math.min(q.width,q.height)*.08),Fe=q.width-pe*2,be=q.height-pe*2;V.fillRect(pe,pe,Fe,be),V.strokeStyle="rgba(34,197,94,0.9)",V.lineWidth=2,V.beginPath(),V.moveTo(pe,q.height/2),V.lineTo(q.width-pe,q.height/2),V.stroke(),V.beginPath(),V.moveTo(q.width/2,pe),V.lineTo(q.width/2,q.height-pe),V.stroke(),V.strokeStyle="rgba(234,179,8,0.9)",V.setLineDash([6,4]);const ot=pe+30,Nt=pe+30;V.beginPath(),V.moveTo(ot,Nt+30),V.lineTo(ot+60,Nt),V.stroke(),V.beginPath(),V.moveTo(q.width-ot,Nt+30),V.lineTo(q.width-ot-60,Nt),V.stroke(),V.restore(),V.save(),V.scale(1/N,1/N),V.fillStyle="rgba(255,255,255,0.85)",V.font="12px sans-serif",V.fillText("Tip: Frame board centered, edges parallel; slight top-down is okay. Keep bull near center.",pe*N,(pe+18)*N),V.restore()}}function nt(B){if(d!=="select")return;const X=B.target,K=X.getBoundingClientRect(),q=B.clientX-K.left,V=B.clientY-K.top,Ce=X.width>0?X.width/K.width:1,pe=X.height>0?X.height/K.height:1,Fe=q*Ce,be=V*pe,ot=[...x,{x:Fe,y:be}];ot.length<=6&&(p(ot),it(ot))}function Ps(){const B=x.slice(0,-1);p(B),it(B)}function Es(){if(!a.current||x.length===0)return;const B=Nd(a.current,x,8);p(B),it(B)}function dn(){if(!a.current)return;if(x.length<4)return alert("Please click at least 4 points on the board.");if(x.length<6)return alert("For best accuracy, click all 6 calibration points: TOP, RIGHT, BOTTOM, LEFT of double rim, plus BULLSEYE center and OUTER BULL top.");const B=Ln(),X=jr(B,x);it(x,X);const K=Nr(X,B,x);F({H:X,createdAt:Date.now(),errorPx:K,imageSize:{w:a.current.width,h:a.current.height},anchors:{src:B,dst:x}}),c("computed")}function Ts(){p([]),S(!1),c("camera"),it([]),te(null),z()}async function Fs(){if(!a.current)return alert("Load a photo or capture a frame first.");te(null);const B=a.current,K=Math.min(1,800/B.width),q=Math.max(1,Math.round(B.width*K)),V=Math.max(1,Math.round(B.height*K)),Ce=document.createElement("canvas");Ce.width=q,Ce.height=V;const pe=Ce.getContext("2d");pe.drawImage(B,0,0,q,V);const Fe=pe.getImageData(0,0,q,V),be=new Float32Array(q*V);for(let qe=0,xe=0;qe<Fe.data.length;qe+=4,xe++){const Be=Fe.data[qe],bt=Fe.data[qe+1],xt=Fe.data[qe+2];be[xe]=.299*Be+.587*bt+.114*xt}const ot=new Float32Array(q*V),Nt=new Float32Array(q*V);for(let qe=1;qe<V-1;qe++)for(let xe=1;xe<q-1;xe++){const Be=qe*q+xe,bt=be[Be-q-1],xt=be[Be-q],gt=be[Be-q+1],pt=be[Be-1],St=be[Be+1],ds=be[Be+q-1],_s=be[Be+q],Je=be[Be+q+1];ot[Be]=-bt-2*pt-ds+(gt+2*St+Je),Nt[Be]=-bt-2*xt-gt+(ds+2*_s+Je)}const vt=new Float32Array(q*V);let It=1;for(let qe=0;qe<vt.length;qe++){const xe=Math.hypot(ot[qe],Nt[qe]);vt[qe]=xe,xe>It&&(It=xe)}const wt=Math.floor(q/2),Is=Math.floor(V/2),us=Math.floor(Math.min(q,V)*.35),ls=Math.floor(Math.min(q,V)*.52);let ft={score:-1,cx:wt,cy:Is,r:Math.floor((us+ls)/2)};const Ms=Math.max(2,Math.floor(Math.min(q,V)*.01)),ve=Math.max(2,Math.floor(Math.min(q,V)*.01));for(let qe=Is-Math.floor(V*.08);qe<=Is+Math.floor(V*.08);qe+=Ms)for(let xe=wt-Math.floor(q*.08);xe<=wt+Math.floor(q*.08);xe+=Ms)for(let Be=us;Be<=ls;Be+=ve){let bt=0;const xt=360;for(let gt=0;gt<xt;gt++){const pt=gt*Math.PI/180,St=Math.round(xe+Be*Math.cos(pt)),ds=Math.round(qe+Be*Math.sin(pt));St<=0||St>=q-1||ds<=0||ds>=V-1||(bt+=vt[ds*q+St])}bt>ft.score&&(ft={score:bt,cx:xe,cy:qe,r:Be})}const Yt=1/K,Xt=ft.cx*Yt,Gt=ft.cy*Yt,hs=ft.r*Yt;function Jt(qe){let xe=0;const Be=qe*K,bt=360;for(let xt=0;xt<bt;xt++){const gt=xt*Math.PI/180,pt=Math.round(ft.cx+Be*Math.cos(gt)),St=Math.round(ft.cy+Be*Math.sin(gt));pt<=0||pt>=q-1||St<=0||St>=V-1||(xe+=vt[St*q+pt])}return xe}const fs={bullInner:He.bullInner/He.doubleOuter,bullOuter:He.bullOuter/He.doubleOuter,trebleInner:He.trebleInner/He.doubleOuter,trebleOuter:He.trebleOuter/He.doubleOuter,doubleInner:He.doubleInner/He.doubleOuter};function ct(qe,xe=.08){const Be=Math.max(1,Math.floor(qe*(1-xe))),bt=Math.max(Be+1,Math.floor(qe*(1+xe)));let xt=Be,gt=-1;for(let pt=Be;pt<=bt;pt++){const St=Jt(pt);St>gt&&(gt=St,xt=pt)}return xt}const Wt=hs,xs=ct(Wt*fs.doubleInner),Zt=ct(Wt*fs.trebleOuter),Ds=ct(Wt*fs.trebleInner),ts=ct(Wt*fs.bullOuter),Ls=ct(Wt*fs.bullInner);dt({cx:Xt,cy:Gt,bullInner:Ls,bullOuter:ts,trebleInner:Ds,trebleOuter:Zt,doubleInner:xs,doubleOuter:Wt});const Dt=qe=>{let Be=0;for(let bt=0;bt<180;bt++){const xt=bt*Math.PI/90,gt=Math.round(ft.cx+qe*K*Math.cos(xt)),pt=Math.round(ft.cy+qe*K*Math.sin(xt));gt<=0||gt>=q-1||pt<=0||pt>=V-1||(Be+=vt[pt*q+gt])}return Be/180},ps=(Dt(ft.r)+Dt(Zt)+Dt(Ds)+Dt(xs)+Dt(ts)+Dt(Ls))/(It*6),un=Math.max(0,Math.min(1,ps)),cs=Math.min(un,Math.min(Dt(ft.r)/It,Dt(Zt)/It,Dt(Ds)/It,Dt(xs)/It,Dt(ts)/It,Dt(Ls)/It));Ge(Math.round(cs*100));const Kt=[{x:Xt,y:Gt-Wt},{x:Xt+Wt,y:Gt},{x:Xt,y:Gt+Wt},{x:Xt-Wt,y:Gt},{x:Xt,y:Gt},{x:Xt,y:Gt-ts}];p(Kt),it(Kt);try{const qe=Ln(),xe=jr(qe,Kt);it(Kt,xe);const Be=Nr(xe,qe,Kt);F({H:xe,createdAt:Date.now(),errorPx:Be,imageSize:{w:a.current.width,h:a.current.height},anchors:{src:qe,dst:Kt}}),c("computed")}catch(qe){console.error("[Calibrator] Auto-detect compute failed:",qe)}const js=cs>=.95;F({locked:js})}function Vt(){if(!a.current)return alert("Capture a frame or upload a photo first.");const B=Dd(a.current);if(te(B),!B.success||!B.homography){const V=B.missing.length?` Missing markers: ${B.missing.map(Ce=>`${Ce.toUpperCase()} (ID ${vs[Ce]})`).join(", ")}`:"";alert(B.message?`${B.message}${V}`:`Marker detection failed.${V}`);return}dt(null),p(B.points),it(B.points,B.homography);const X=Ln(),K={w:a.current.width,h:a.current.height},q=(B.errorPx??Number.POSITIVE_INFINITY)<=1.2;F({H:B.homography,createdAt:Date.now(),errorPx:B.errorPx??null,imageSize:K,anchors:{src:X,dst:B.points},locked:q?!0:U}),c("computed")}m.useEffect(()=>{it()},[g,b]),m.useEffect(()=>{if(!ye||!n)return;let B=0;const X=()=>{try{Bt()}catch{}B=requestAnimationFrame(X)};return B=requestAnimationFrame(X),()=>cancelAnimationFrame(B)},[ye,n]),m.useEffect(()=>{(async()=>{try{if(!U||!ce)return;const B=a.current?{w:a.current.width,h:a.current.height}:null,X=JSON.stringify({H:b,anchors:null,imageSize:B,errorPx:T??null});try{await kt(`/cam/calibration/${ce}`,{method:"POST",headers:{"Content-Type":"application/json"},body:X}),console.log("[Calibrator] Posted calibration for code",ce)}catch(K){console.warn("[Calibrator] Upload calibration failed",K)}try{const K=localStorage.getItem("authToken");K&&(await kt("/api/user/calibration",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${K}`},body:X}),console.log("[Calibrator] Synced calibration to user account"))}catch(K){console.warn("[Calibrator] User calibration sync failed",K)}}catch{}})()},[U,ce]);function mn(){const{preferredCameraId:B,preferredCameraLabel:X,setPreferredCamera:K,cameraEnabled:q,setCameraEnabled:V,preferredCameraLocked:Ce,setPreferredCameraLocked:pe}=is(),[Fe,be]=m.useState([]),[ot,Nt]=m.useState(""),[vt,It]=m.useState(!1),wt=m.useRef(null),Is=document.getElementById("dropdown-portal-root")||(()=>{const ve=document.createElement("div");return ve.id="dropdown-portal-root",document.body.appendChild(ve),ve})();async function us(){Nt("");try{try{await navigator.mediaDevices.getUserMedia({video:!0})}catch{}const Yt=(await navigator.mediaDevices.enumerateDevices()).filter(Xt=>Xt.kind==="videoinput");be(Yt)}catch{Nt("Unable to list cameras. Grant camera permission in your browser.")}}m.useEffect(()=>{us()},[]),m.useEffect(()=>{function ve(Yt){wt.current&&!wt.current.contains(Yt.target)&&It(!1)}return document.addEventListener("mousedown",ve),()=>document.removeEventListener("mousedown",ve)},[]);const ls=Fe.find(ve=>ve.deviceId===B),ft=ls?`${ls.label||"Camera"}`:B?"Camera (unavailable)":"Auto (browser default)",Ms=B&&!ls;return e.jsxs("div",{className:"mt-3 p-3 rounded-lg border border-indigo-500/30 bg-indigo-500/5",children:[e.jsx("div",{className:"font-semibold mb-2",children:"Select camera device"}),ot&&e.jsx("div",{className:"text-rose-400 text-sm mb-2",children:ot}),Ms&&e.jsxs("div",{className:"text-amber-400 text-sm mb-2",children:["Selected camera is no longer available.",e.jsx("button",{className:"underline ml-1",onClick:()=>K(void 0,"",!0),disabled:n,children:"Use auto-selection"})]}),e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[Ce?e.jsx("div",{className:"text-xs text-emerald-400",children:"🔒 Camera selection locked"}):e.jsx("div",{className:"text-xs text-slate-400",children:"Camera selection unlocked"}),e.jsx("button",{className:"btn btn--ghost px-2 py-0.5 text-xs ml-2",onClick:()=>{he.current=!1,pe(!Ce)},children:Ce?"Unlock":"Lock"})]}),e.jsxs("div",{className:"flex items-center gap-3 mb-3",children:[e.jsx("input",{type:"checkbox",id:"cameraEnabled-calibrator",checked:q,onChange:ve=>V(ve.target.checked),className:"w-4 h-4",disabled:n}),e.jsx("label",{htmlFor:"cameraEnabled-calibrator",className:"text-sm",children:"Enable camera for scoring"})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-2 items-center text-sm",children:[e.jsxs("div",{className:"col-span-2 relative",ref:wt,children:[e.jsxs("div",{className:"input w-full flex items-center justify-between cursor-pointer",onClick:()=>It(!vt),children:[e.jsx("span",{className:"truncate",children:ft}),e.jsx("svg",{className:`w-4 h-4 transition-transform ${vt?"rotate-180":""}`,fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})]}),vt&&rc.createPortal(e.jsx("div",{className:"fixed left-0 top-0 w-full h-full z-[9999]",style:{pointerEvents:"none"},children:e.jsx("div",{className:"absolute",style:{left:wt.current?.getBoundingClientRect().left||0,top:wt.current?.getBoundingClientRect().bottom||0,width:wt.current?.offsetWidth||240,pointerEvents:"auto"},children:e.jsxs("div",{className:"bg-slate-800 border border-slate-600 rounded-lg shadow-lg max-h-48 overflow-y-auto",children:[e.jsx("div",{className:"px-3 py-2 hover:bg-slate-700 cursor-pointer text-sm",onClick:()=>{K(void 0,"",!0)},children:"Auto (browser default)"}),Fe.map(ve=>{const Yt=`${ve.label||"Camera"}`;return e.jsx("div",{className:"px-3 py-2 hover:bg-slate-700 cursor-pointer text-sm",onClick:()=>{K(ve.deviceId,ve.label||"",!0)},children:Yt},ve.deviceId)}),e.jsx("div",{className:"px-3 py-2 hover:bg-slate-700 cursor-pointer text-sm text-indigo-400",onClick:()=>{h("phone"),c("camera"),r(!1),S(!1)},children:"📱 Phone Camera"},"phone-camera"),e.jsx("div",{className:"px-3 py-2 text-right",children:e.jsx("button",{className:"btn btn--ghost px-2 py-1 text-xs",onClick:()=>It(!1),children:"Close"})})]})})}),Is)]}),e.jsx("div",{className:"text-right",children:e.jsx("button",{className:"btn px-2 py-1",onClick:us,disabled:n,children:"Refresh"})})]}),X&&e.jsxs("div",{className:"text-xs opacity-70 mt-1",children:["Selected: ",X]}),e.jsx("div",{className:"text-xs opacity-70 mt-1",children:"Tip: All camera technology is supported for autoscoring needs—select your camera here and then open Calibrator to align."})]})}if(M&&!A){const B=H??(typeof window<"u"?`${window.location.origin.replace(/\/$/,"")}/mobile-cam.html`:"/mobile-cam.html");return e.jsxs("div",{className:"mx-auto flex min-h-[calc(100vh-140px)] w-full max-w-xl flex-col justify-center gap-6 p-6",children:[e.jsxs("div",{className:"space-y-5 rounded-3xl border border-indigo-400/30 bg-slate-900/70 p-6 text-slate-100 shadow-xl",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-xs font-semibold uppercase tracking-wide text-indigo-300",children:"Mobile camera"}),e.jsx("h2",{className:"text-2xl font-semibold leading-tight text-white",children:"This device is ready to stream as your dartboard camera"}),e.jsx("p",{className:"text-sm text-slate-200/80",children:"Open the lightweight mobile camera page to stream video to your desktop calibrator. You can still come back here if you need the full desktop tools."})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("a",{href:B,className:"btn w-full justify-center px-4 py-2 text-base",children:"Open mobile camera"}),e.jsx("button",{type:"button",className:"btn btn--ghost w-full justify-center px-4 py-2 text-sm",onClick:()=>Ye(B,"link"),children:ht==="link"?"Link copied!":"Copy link"})]}),e.jsxs("p",{className:"text-xs text-slate-300/70",children:["On a desktop, open Calibrator and generate a pairing code. Then tap ",e.jsx("span",{className:"font-semibold",children:"Pair with Desktop"})," from the mobile camera page to connect this device."]})]}),e.jsx("button",{type:"button",className:"self-center text-xs font-medium text-indigo-200 underline decoration-dotted decoration-indigo-300/70 transition hover:text-indigo-100",onClick:()=>O(!0),children:"Continue to desktop calibrator"})]})}return e.jsxs("div",{className:"space-y-6",children:[M&&A&&e.jsx("div",{className:"rounded-2xl border border-indigo-400/30 bg-indigo-500/10 p-4 text-sm text-indigo-100",children:e.jsxs("div",{className:"flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between",children:[e.jsx("p",{className:"leading-relaxed",children:"Using a phone? Switch back to the streamlined mobile camera interface for an easier pairing flow."}),e.jsx("button",{type:"button",className:"btn btn--ghost px-3 py-1 text-xs",onClick:()=>O(!1),children:"Open mobile camera mode"})]})}),e.jsxs("div",{className:"card space-y-6 p-6",children:[e.jsxs("header",{className:"flex flex-wrap items-start justify-between gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-xs font-semibold uppercase tracking-wide text-indigo-300",children:"Marker calibration"}),e.jsx("h2",{className:"text-2xl font-semibold leading-tight text-white",children:"Align your board with the autoscoring overlay"}),e.jsx("p",{className:"max-w-2xl text-sm opacity-80",children:"Place the printable fiducial markers around the double ring, capture a clear frame, and let the calibrator compute a precise homography."})]}),e.jsxs("div",{className:"flex flex-col items-end gap-2 text-xs font-medium",children:[e.jsxs("span",{className:"inline-flex items-center gap-2 rounded-full border border-indigo-400/50 bg-indigo-500/10 px-3 py-1",children:[e.jsx("span",{className:"opacity-60",children:"Mode"}),e.jsx("span",{children:u==="local"?"Desktop camera":u==="phone"?"Phone camera":"Wifi device"})]}),e.jsxs("span",{className:`inline-flex items-center gap-2 rounded-full border px-3 py-1 ${n?"border-emerald-400/60 bg-emerald-500/10 text-emerald-100":"border-white/20 bg-white/5 text-slate-200"}`,children:[e.jsx("span",{className:`h-2 w-2 rounded-full ${n?"bg-emerald-400":"bg-slate-400"}`}),n?"Live stream active":"Stream idle"]}),U?e.jsx("span",{className:"inline-flex items-center gap-2 rounded-full border border-emerald-400/60 bg-emerald-500/10 px-3 py-1 text-emerald-100",children:e.jsxs("span",{children:["Locked • ",T!=null?`${T.toFixed(2)}px error`:"ready"]})}):e.jsxs("span",{className:"inline-flex items-center gap-2 rounded-full border border-amber-400/40 bg-amber-500/10 px-3 py-1 text-amber-100",children:[e.jsx("span",{children:"Not locked"}),T!=null&&e.jsxs("span",{children:["• ",T.toFixed(2),"px"]})]})]})]}),U&&b&&e.jsxs("section",{className:"space-y-3 rounded-2xl border border-emerald-400/40 bg-emerald-500/10 p-4 text-sm",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"flex h-10 w-10 items-center justify-center rounded-full bg-emerald-500/20",children:e.jsx("span",{className:"text-lg",children:"✓"})}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold text-emerald-100",children:"Calibration active"}),e.jsx("p",{className:"text-xs opacity-80",children:"Your calibration is saved and active across all game modes. It will be used in Online, Offline, and Tournaments."})]})]}),e.jsx("button",{className:"btn btn--ghost px-2 py-1 text-xs whitespace-nowrap",onClick:()=>F({locked:!1}),title:"Unlock to recalibrate",children:"Unlock"})]}),T!=null&&e.jsxs("div",{className:"text-xs opacity-75",children:["Precision: ",T.toFixed(2)," px RMS error"]})]}),e.jsxs("div",{className:"grid gap-6 xl:grid-cols-[minmax(0,2fr)_minmax(320px,1fr)]",children:[e.jsxs("section",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-4 rounded-2xl border border-white/10 bg-black/40 p-4",children:[e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-4 text-xs",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[e.jsx("span",{className:"uppercase tracking-wide opacity-60",children:"Video source"}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{className:`btn px-3 py-1 ${u==="local"?"bg-emerald-600 hover:bg-emerald-700":"bg-slate-700 hover:bg-slate-600"}`,onClick:()=>{h("local"),le(!1)},title:"Use local camera",children:"Local"}),e.jsx("button",{className:`btn px-3 py-1 ${u==="phone"?"bg-emerald-600 hover:bg-emerald-700":"bg-slate-700 hover:bg-slate-600"}`,onClick:()=>{h("phone"),le(!1)},title:"Pair phone camera",children:"Phone"}),e.jsx("button",{className:`btn px-3 py-1 ${u==="wifi"?"bg-emerald-600 hover:bg-emerald-700":"bg-slate-700 hover:bg-slate-600"}`,onClick:()=>{h("wifi"),le(!1),$()},title:"Discover wifi/USB autoscoring devices",children:"Wifi"})]})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"opacity-70",children:"Zoom"}),e.jsx("input",{type:"range",min:50,max:200,step:5,value:Math.round((N||1)*100),onChange:B=>E(Math.max(.5,Math.min(2,Number(B.target.value)/100)))}),e.jsxs("span",{className:"w-12 text-right",children:[Math.round((N||1)*100),"%"]})]}),e.jsx("button",{className:"btn px-3 py-1",onClick:()=>E(1),children:"Actual"})]})]}),e.jsxs("div",{className:"relative w-full overflow-hidden rounded-2xl border border-indigo-400/30 bg-black",style:{aspectRatio:D?`${D.w} / ${D.h}`:"16 / 9"},children:[(!n||!me)&&e.jsx("div",{className:"absolute inset-0 z-20 flex items-center justify-center bg-gradient-to-br from-black/40 to-black/10",children:e.jsx($c,{calibrationComplete:d==="computed"})}),e.jsxs("div",{className:"absolute inset-0",style:{transform:`scale(${N||1})`,transformOrigin:"center center"},children:[e.jsx("video",{ref:t,onLoadedMetadata:B=>{try{const X=B.currentTarget;X.videoWidth&&X.videoHeight&&I({w:X.videoWidth,h:X.videoHeight})}catch{}},className:`absolute inset-0 h-full w-full object-cover transition-opacity duration-300 ${g?"opacity-0 -z-10":"opacity-100 z-10"}`,autoPlay:!0,playsInline:!0,muted:!0,controls:!1}),o&&e.jsx("div",{className:"absolute inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur",children:e.jsx("button",{className:"rounded-lg bg-white px-4 py-2 font-semibold text-slate-900 shadow-lg",onClick:async()=>{try{await t.current?.play(),l(!1),r(!0),c("capture")}catch(B){console.warn("Tap-to-play retry failed",B),alert("Tap to enable video failed. Please check browser settings or reload the page.")}},children:"Tap to allow video"})}),e.jsx("canvas",{ref:a,className:`absolute inset-0 h-full w-full transition-opacity duration-300 ${g?"opacity-100 z-10":"opacity-0 -z-10"}`}),e.jsx("canvas",{ref:s,onClick:nt,className:"absolute inset-0 z-30 h-full w-full cursor-crosshair"})]})]}),e.jsxs("label",{className:"flex items-center gap-2 text-xs",children:[e.jsx("input",{type:"checkbox",className:"accent-indigo-600",checked:_,onChange:B=>ie(B.target.checked)}),"Show preferred-view guide overlay"]})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-3 text-xs sm:grid-cols-3",children:[e.jsxs("div",{className:"rounded-xl border border-white/10 bg-white/5 px-3 py-2",children:[e.jsx("div",{className:"uppercase tracking-wide opacity-60",children:"Phase"}),e.jsx("div",{className:"text-sm font-semibold capitalize",children:d})]}),e.jsxs("div",{className:"rounded-xl border border-white/10 bg-white/5 px-3 py-2",children:[e.jsx("div",{className:"uppercase tracking-wide opacity-60",children:"Points selected"}),e.jsxs("div",{className:"text-sm font-semibold",children:[x.length," / 6"]})]}),e.jsxs("div",{className:"rounded-xl border border-white/10 bg-white/5 px-3 py-2",children:[e.jsx("div",{className:"uppercase tracking-wide opacity-60",children:"Fit error"}),e.jsx("div",{className:"text-sm font-semibold",children:T!=null?`${T.toFixed(2)} px`:"—"})]})]})]}),e.jsxs("aside",{className:"space-y-4",children:[e.jsx(mn,{}),u==="phone"&&e.jsxs("section",{className:"space-y-3 rounded-2xl border border-indigo-400/30 bg-black/40 p-4 text-xs text-white",children:[e.jsx("div",{className:"font-semibold",children:"Phone pairing"}),e.jsxs("button",{type:"button",className:"w-full text-left px-3 py-2 rounded-lg border border-white/10 bg-white/5 hover:bg-white/10 transition flex items-center gap-2",onClick:()=>Ye(Tt,"link"),title:"Copy mobile camera link",children:[e.jsx("span",{className:"flex-1 min-w-0 font-mono break-all text-[11px]",children:Tt}),e.jsx("span",{className:"text-[10px] uppercase tracking-wide whitespace-nowrap text-emerald-200",children:ht==="link"?"Copied!":"Copy link"})]}),e.jsx("div",{className:"flex items-center gap-2 text-[11px]",children:e.jsx("a",{href:Tt,target:"_blank",rel:"noreferrer",className:"underline decoration-dotted text-indigo-200 hover:text-indigo-100 transition",children:"Open link in new tab"})}),e.jsxs("div",{className:"opacity-80",children:["WS: ",fe?fe.readyState===1?"open":fe.readyState===0?"connecting":fe.readyState===2?"closing":"closed":"not started"," · ",Ae?.https?"HTTPS on":"HTTP only"]}),ce&&e.jsxs("button",{type:"button",className:"w-full text-left px-3 py-2 rounded-lg border border-white/10 bg-white/5 hover:bg-white/10 transition flex items-center justify-between gap-2",onClick:()=>Ye(ce,"code"),title:"Copy pairing code",children:[e.jsx("span",{className:"font-mono tracking-[0.3em] text-sm",children:ce}),e.jsx("span",{className:"text-[10px] uppercase tracking-wide whitespace-nowrap text-emerald-200",children:ht==="code"?"Copied!":"Copy code"})]}),yt&&e.jsx("img",{className:"mt-1 h-40 w-40 rounded bg-white",alt:"Scan to open",src:yt}),e.jsxs("div",{className:"flex items-center gap-2",children:[Ne!==null&&e.jsxs("span",{children:["Expires in ",Ne,"s"]}),e.jsx("button",{className:"btn px-2 py-1 text-xs",onClick:Xe,children:"Regenerate"})]}),Rt&&e.jsxs("div",{className:"space-y-2 rounded-lg border border-slate-700/50 bg-slate-900/60 p-3 text-slate-200",children:[e.jsx("div",{className:"font-semibold",children:"Troubleshooting"}),e.jsxs("ul",{className:"list-disc space-y-1 pl-4",children:[e.jsx("li",{children:"Phone and desktop must be on the same Wi‑Fi network."}),e.jsxs("li",{children:["Allow the server through your firewall (ports 8787 and ",Ae?.https?Ae.port:8788,")."]}),e.jsx("li",{children:"On iPhone, use HTTPS links (QR will prefer HTTPS when enabled)."})]}),e.jsx("div",{className:"text-right",children:e.jsx("button",{className:"btn btn--ghost px-2 py-1 text-xs",onClick:()=>Pt(!1),children:"Hide tips"})})]})]}),e.jsxs("section",{className:"space-y-3 rounded-2xl border border-white/10 bg-white/5 p-4",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-semibold",children:"Step 1 · Capture image"}),e.jsx("p",{className:"text-xs opacity-70",children:"Start your preferred camera or upload a static photo of the board."})]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:n?e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"btn bg-rose-600 hover:bg-rose-700",onClick:()=>le(!0),children:"Stop camera"}),e.jsx("button",{className:"btn",onClick:Bt,disabled:!n,children:"Capture frame"})]}):e.jsxs(e.Fragment,{children:[u==="local"&&e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"btn",onClick:ue,title:"Click to enable camera (will request permission if needed)",children:"Enable camera"}),e.jsx("button",{className:"btn btn--ghost text-xs",onClick:async()=>{try{await navigator.mediaDevices.getUserMedia({video:!0,audio:!1}),console.log("[Calibrator] Camera permission granted via button")}catch{alert("Camera permission denied. Please enable camera access in your browser settings.")}},children:"Request permission"})]}),u==="phone"&&e.jsx("button",{className:"btn",onClick:Ot,children:"Pair phone camera"}),u==="wifi"&&e.jsx("button",{className:"btn",onClick:$,children:"Connect wifi camera"})]})}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx("input",{ref:i,type:"file",accept:"image/*",className:"hidden",onChange:$e}),e.jsx("button",{className:"btn",onClick:je,children:"Upload photo"})]})]}),e.jsxs("section",{className:"space-y-3 rounded-2xl border border-white/10 bg-white/5 p-4",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-semibold",children:"Step 2 · Detect markers"}),e.jsx("p",{className:"text-xs opacity-70",children:"Use fiducials or auto-detect to seed the rim points."})]}),e.jsxs("span",{className:`inline-flex items-center gap-2 rounded-full border px-3 py-1 text-[11px] ${Ve>=85?"border-emerald-400/60 bg-emerald-500/10 text-emerald-100":"border-white/20 bg-white/5 text-slate-200"}`,children:[e.jsx("span",{className:"opacity-70",children:"Confidence"}),e.jsxs("span",{children:[Ve,"%"]})]})]}),e.jsxs("label",{className:"inline-flex items-center gap-2 text-xs",children:[e.jsx("input",{type:"checkbox",className:"accent-indigo-600",checked:ye,onChange:B=>We(B.target.checked)}),"Live auto-detect while streaming"]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx("button",{className:"btn",disabled:!g,onClick:Fs,children:"Auto detect"}),e.jsx("button",{className:"btn",disabled:!g,onClick:Vt,children:"Detect markers"})]}),Re&&e.jsx("div",{className:`rounded-lg border px-3 py-2 text-xs ${Re.success?"bg-emerald-500/10 border-emerald-500/30 text-emerald-100":"bg-rose-500/10 border-rose-500/30 text-rose-100"}`,children:Re.success?e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{children:["Detected markers → board anchors:"," ",io.map(B=>{const X=Re.assignments?.[B];return`${B.toUpperCase()}→${X?`ID ${X.id}`:"—"}`}).join(", ")]}),Re.errorPx!=null&&e.jsxs("div",{children:["RMS error: ",Re.errorPx.toFixed(2)," px"]}),e.jsxs("div",{className:"opacity-80",children:["Markers correspond to IDs TOP ",vs.top,", RIGHT ",vs.right,", BOTTOM ",vs.bottom,", LEFT ",vs.left,"."]})]}):e.jsxs("div",{className:"space-y-1",children:[e.jsx("div",{children:Re.message||"Unable to detect all markers."}),Re.missing.length>0&&e.jsxs("div",{children:["Missing: ",Re.missing.map(B=>`${B.toUpperCase()} (ID ${vs[B]})`).join(", ")]})]})})]}),e.jsxs("section",{className:"space-y-3 rounded-2xl border border-white/10 bg-white/5 p-4",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-semibold",children:"Step 3 · Align & lock"}),e.jsx("p",{className:"text-xs opacity-70",children:"Click 6 points in order: ① TOP ② RIGHT ③ BOTTOM ④ LEFT of double rim, then ⑤ BULLSEYE center ⑥ outer bull top. Refine edges, then lock."})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx("button",{className:"btn",disabled:x.length<4,onClick:dn,children:"Compute"}),e.jsx("button",{className:`btn ${U?"bg-emerald-600 hover:bg-emerald-700":""}`,onClick:()=>F({locked:!U}),children:U?"Unlock":"Lock in"})]}),U&&e.jsxs("div",{className:"text-xs opacity-75",children:["Calibration saved ",T!=null?`· error ${T.toFixed(2)} px`:""]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx("button",{className:"btn",disabled:x.length===0,onClick:Ps,children:"Undo"}),e.jsx("button",{className:"btn",disabled:x.length===0,onClick:Es,children:"Refine points"}),e.jsx("button",{className:"btn",onClick:Ts,children:"Reset"})]})]})]})]}),u==="wifi"&&!n&&e.jsxs("div",{className:"space-y-3 rounded-2xl border border-indigo-400/30 bg-black/40 p-4 text-xs text-white",children:[e.jsx("div",{className:"font-semibold",children:"Wifi scoring devices"}),Et?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"h-4 w-4 animate-spin rounded-full border-b-2 border-white"}),e.jsx("span",{children:"Scanning network for devices…"})]}):Oe.length>0?e.jsxs("div",{className:"space-y-2",children:[Oe.map(B=>e.jsxs("div",{className:"flex items-center justify-between rounded border border-slate-700/50 bg-slate-900/60 p-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:B.name}),e.jsxs("div",{className:"opacity-70",children:[B.ip,":",B.port," · ",B.type.toUpperCase()]}),e.jsxs("div",{className:"opacity-70 text-xs",children:["Capabilities: ",B.capabilities.join(", ")]})]}),e.jsx("button",{className:`btn px-2 py-1 text-xs ${B.status==="connecting"?"bg-yellow-600":B.status==="online"?"bg-green-600":"bg-blue-600"}`,onClick:()=>J(B),disabled:B.status==="connecting",children:B.status==="connecting"?"Connecting…":"Connect"})]},B.id)),e.jsx("div",{className:"text-center",children:e.jsx("button",{className:"btn px-2 py-1 text-xs",onClick:$,children:"Rescan network"})})]}):e.jsxs("div",{className:"space-y-2 text-center",children:[e.jsx("div",{children:"No wifi scoring devices found."}),e.jsx("div",{className:"opacity-70",children:"Ensure your wifi cameras are powered on and on the same network."}),e.jsx("button",{className:"btn px-2 py-1 text-xs",onClick:$,children:"Scan again"})]})]})]})]})}const Wd=["D1","D2","D3","D4","D5","D6","D7","D8","D9","D10","D11","D12","D13","D14","D15","D16","D17","D18","D19","D20","DB"];function zd(t){return t==="DB"?50:Number(t.slice(1))*2}function qd(t){return Wd.includes(t)?zd(t):32}function la(t,a="D16"){if(t>170||t<=1)return[];const s={170:["T20 T20 DB"],167:["T20 T19 DB"],164:["T20 T18 DB"],161:["T20 T17 DB"],160:["T20 T20 D20"],158:["T20 T20 D19"],157:["T20 T19 D20"],156:["T20 T20 D18"],155:["T20 T19 D19"],154:["T20 T18 D20"],153:["T20 T19 D18"],152:["T20 T20 D16"],151:["T20 T17 D20"],150:["T20 T18 D18"],149:["T20 T19 D16"],148:["T20 T16 D20"],147:["T20 T17 D18"],146:["T20 T18 D16"],145:["T20 T15 D20"],144:["T20 T20 D12"],141:["T20 T19 D12"],140:["T20 T20 D10"],137:["T20 T19 D10"],136:["T20 T20 D8"],132:["BULL T14 D20","T20 T12 D8"],130:["T20 T20 D5","T20 T18 D8"],129:["T19 T16 D12"],128:["T18 T14 D16"],127:["T20 T17 D8"],126:["T19 T19 D6"],121:["T20 11 D20","T20 T15 D8"],120:["T20 20 D20","T20 S20 D20"],110:["T20 10 D20"],100:["T20 D20"],99:["T19 10 D16","T19 S10 D16"],97:["T19 D20"],96:["T20 D18"],95:["T19 D19"],94:["T18 D20"],92:["T20 D16"],90:["T18 D18","T20 D15"],86:["T18 D16"],84:["T20 D12","T16 D18"],82:["BULL D16","T14 D20"],81:["T19 D12"],80:["T20 D10","D20 D20"],78:["T18 D12"],76:["T20 D8","T16 D14"],74:["T14 D16","T18 D10"],72:["T16 D12","T20 D6"],70:["T18 D8","S20 BULL"],68:["T20 D4","T16 D10"],66:["T10 D18","T14 D12"],64:["T16 D8","D16 D16"],62:["T10 D16","T12 D13"],60:["20 D20","S20 D20"],58:["18 D20","S18 D20"],56:["16 D20","S16 D20"],54:["14 D20","S14 D20"],52:["20 D16","S20 D16"],50:["BULL","10 D20"],48:["16 D16","S16 D16"],46:["14 D16"],44:["12 D16"],42:["10 D16"],40:["D20"],38:["D19"],36:["D18"],34:["D17"],32:["D16"],30:["D15"],28:["D14"],26:["D13"],24:["D12"],22:["D11"],20:["D10"],18:["D9"],16:["D8"],14:["D7"],12:["D6"],10:["D5"],8:["D4"],6:["D3"],4:["D2"],2:["D1"]};if(s[t])return s[t];const i=qd(a),n=[];for(const r of[60,57,54,51,48])if(t-r===i){n.push(`T${r/3} ${a}`);break}if(!n.length){for(const r of[20,19,18,17,16,15])if(t-r===i){n.push(`${r} ${a}`);break}}return n}function ia(t,a,s,i,n){try{const r=window.speechSynthesis;if(!r)return;const o=new SpeechSynthesisUtterance,l=s<=170&&s>0;if(n?.checkoutOnly&&!l)return;if(o.text=l?`${t}, you have ${s} remaining.`:`${a}`,i){const d=r.getVoices().find(c=>c.name===i);d&&(o.voice=d)}typeof n?.volume=="number"&&(o.volume=Math.max(0,Math.min(1,n.volume))),o.rate=1,o.pitch=1,r.speak(o)}catch{}}function ca({label:t,autoStart:a=!1,scale:s,className:i,aspect:n="inherit",style:r,fill:o=!1}){const l=m.useRef(null),[d,c]=m.useState(!1),[u,h]=m.useState(null),[x,p]=m.useState(null),[g,S]=m.useState(null),D=is(ne=>ne.preferredCameraLabel),[I,N]=m.useState(()=>{if(D==="Phone Camera")return console.log("[CAMERATILE] Initializing mode to phone (from preferred camera selection)"),"phone";const ne=localStorage.getItem("ndn:camera:mode");return console.log("[CAMERATILE] Initializing mode to",ne||"local","(from localStorage)"),ne||"local"}),[E,A]=m.useState(null),[O,M]=m.useState(Date.now()),[v,b]=m.useState(!1),[F,z]=m.useState(null),[T,U]=m.useState(null),[w,_]=m.useState(!0),[ie,R]=m.useState([]),[Z,ae]=m.useState(!1),[Me,st]=m.useState([]),[Se,Te]=m.useState(!1),dt=is(ne=>ne.autoscoreProvider),ye=is(ne=>ne.setPreferredCameraLocked);if(dt==="manual"){const de=[o?"rounded-2xl overflow-hidden bg-black w-full flex flex-col":"rounded-2xl overflow-hidden bg-black w-full mx-auto",i].filter(Boolean).join(" ").trim(),ge={...r||{}};return!o&&ge.aspectRatio===void 0&&ge.height===void 0&&ge.minHeight===void 0&&(ge.aspectRatio="4 / 3"),e.jsx("div",{className:de,style:ge,children:e.jsx("div",{className:"flex-1 w-full h-full flex items-center justify-center bg-slate-900 text-slate-200 text-xs p-4 text-center",children:"Manual scoring mode active — camera feeds are disabled."})})}m.useEffect(()=>{const ne=window.location.hostname;(ne==="localhost"||ne==="127.0.0.1")&&kt("/api/hosts").then(de=>de.json()).then(de=>{const ge=Array.isArray(de?.hosts)&&de.hosts.find(me=>me);ge&&z(ge)}).catch(()=>{}),kt("/api/https-info").then(de=>de.json()).then(de=>{de&&typeof de.https=="boolean"&&U({https:!!de.https,port:Number(de.port)||8788})}).catch(()=>{})},[]);const We=m.useMemo(()=>{const ne=x||"____",de="ws://localhost:8787";if(de.length>0)try{const lt=new URL(de);return`${`${lt.protocol==="wss:"?"https":"http"}://${lt.host}${lt.pathname.endsWith("/ws")?"":lt.pathname}`.replace(/\/?ws$/i,"")}/mobile-cam.html?code=${ne}`}catch{}const ge=F||window.location.hostname,me=!!T?.https,ze=me?T?.port||8788:8787;return`${me?"https":"http"}://${ge}:${ze}/mobile-cam.html?code=${ne}`},[x,F,T]);m.useEffect(()=>{console.log("[CAMERATILE] Mode changed to:",I,"- persisting to localStorage"),localStorage.setItem("ndn:camera:mode",I)},[I]),m.useEffect(()=>{console.log("[CAMERATILE] Checking camera selection sync: preferredCameraLabel=",D,"mode=",I),D==="Phone Camera"&&I!=="phone"&&(console.log("[CAMERATILE] Syncing mode to phone from Calibrator selection"),N("phone"))},[D,I]);const[Ve,Ge]=m.useState("");m.useEffect(()=>{if(!x){Ge("");return}Fo.toDataURL(We,{width:160,margin:1,color:{dark:"#000000",light:"#ffffff"}}).then(Ge).catch(()=>Ge(""))},[We,x]),m.useEffect(()=>{if(!E)return;const ne=setInterval(()=>M(Date.now()),1e3);return()=>clearInterval(ne)},[E]);const Re=m.useMemo(()=>E?Math.max(0,Math.ceil((E-O)/1e3)):null,[E,O]);m.useEffect(()=>{a?te().catch(()=>{}):at()},[a,D]);async function te(){if(I==="wifi")return fe();if(D==="Phone Camera"){console.log("[CAMERATILE] Phone camera is selected - skipping local camera startup"),console.log("[CAMERATILE] Phone camera feed shown via overlay");return}try{const{preferredCameraId:ne,setPreferredCamera:de}=is.getState(),ge=ne?{video:{deviceId:{exact:ne}},audio:!1}:{video:!0,audio:!1};let me;try{me=await navigator.mediaDevices.getUserMedia(ge)}catch(ze){const ke=ze&&(ze.name||ze.code)||"";if(ne&&(ke==="OverconstrainedError"||ke==="NotFoundError"))me=await navigator.mediaDevices.getUserMedia({video:!0,audio:!1});else throw ze}l.current&&(l.current.srcObject=me,await l.current.play(),c(!0))}catch{}}function at(){l.current&&l.current.srcObject&&(l.current.srcObject.getTracks().forEach(de=>de.stop()),l.current.srcObject=null,c(!1))}async function fe(){ae(!0);try{const ne=await qo();R(ne),ne.length===0&&alert("No wifi scoring devices found on your network. Make sure devices are powered on and connected to the same network.")}catch(ne){console.error("Wifi device discovery failed:",ne),alert("Failed to discover wifi devices. Please check your network connection.")}finally{ae(!1)}}async function Pe(ne){try{R(ge=>ge.map(me=>me.id===ne.id?{...me,status:"connecting"}:me));const de=await Go(ne);if(de&&l.current)l.current.srcObject=de,await l.current.play(),c(!0),R(ge=>ge.map(me=>me.id===ne.id?{...me,status:"online"}:me));else throw new Error("Failed to get video stream")}catch(de){console.error("Failed to connect to wifi device:",de),alert(`Failed to connect to ${ne.name}. Please check the device and try again.`),R(ge=>ge.map(me=>me.id===ne.id?{...me,status:"offline"}:me))}}async function he(){Te(!0);try{const ne=await $d();st(ne);const de=await Fd();de&&st(ge=>[...ge,de]),ne.length===0&&!de&&alert("No USB scoring devices found. Please connect a device and try again.")}catch(ne){console.error("USB device discovery failed:",ne),alert("Failed to discover USB devices. Please check device connections.")}finally{Te(!1)}}async function ce(ne){try{st(ge=>ge.map(me=>me.id===ne.id?{...me,status:"connecting"}:me));const de=await _d(ne);if(de&&l.current)l.current.srcObject=de,await l.current.play(),c(!0),N("wifi"),st(ge=>ge.map(me=>me.id===ne.id?{...me,status:"online"}:me));else throw new Error("Failed to get video stream")}catch(de){console.error("Failed to connect to USB device:",de),alert(`Failed to connect to ${ne.name}. Please check the device and try again.`),st(ge=>ge.map(me=>me.id===ne.id?{...me,status:"offline"}:me))}}function rt(){if(u&&u.readyState===WebSocket.OPEN)return u;const ne="ws://localhost:8787",de=ne.length>0?ne.endsWith("/ws")?ne:ne.replace(/\/$/,"")+"/ws":void 0,ge=window.location.protocol==="https:"?"wss":"ws",me=`${ge}://${window.location.host}/ws`,ze=window.location.hostname,ke=ze==="localhost"||ze==="127.0.0.1",lt=ze.endsWith("onrender.com"),yt="wss://ninedartnation.onrender.com/ws";let k=de;k||(ke?k=`${ge}://${ze}:8787/ws`:lt?k=me:k=yt),k||(k=me);const ee=new WebSocket(k);return h(ee),ee}async function De(){N("phone"),b(!1);const ne=rt();ne.readyState===WebSocket.OPEN?ne.send(JSON.stringify({type:"cam-create"})):ne.onopen=()=>ne.send(JSON.stringify({type:"cam-create"})),ne.onmessage=async de=>{const ge=JSON.parse(de.data);if(ge.type==="cam-code")p(ge.code),ge.expiresAt&&A(ge.expiresAt);else if(ge.type==="cam-peer-joined"){b(!0);const me=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}]});S(me),me.onicecandidate=ke=>{ke.candidate&&x&&ne.send(JSON.stringify({type:"cam-ice",code:x,payload:ke.candidate}))},me.ontrack=ke=>{if(l.current){const lt=ke.streams?.[0];lt&&(l.current.srcObject=lt,l.current.play().catch(()=>{}),c(!0))}};const ze=await me.createOffer({offerToReceiveAudio:!1,offerToReceiveVideo:!0});await me.setLocalDescription(ze),x&&ne.send(JSON.stringify({type:"cam-offer",code:x,payload:ze}))}else if(ge.type==="cam-answer")g&&await g.setRemoteDescription(new RTCSessionDescription(ge.payload));else if(ge.type==="cam-ice"&&g)try{await g.addIceCandidate(ge.payload)}catch{}}}function mt(){p(null),A(null),b(!1),u&&u.readyState===WebSocket.OPEN?u.send(JSON.stringify({type:"cam-create"})):De();try{ye(!0)}catch{}}function tt(){if(at(),p(null),b(!1),A(null),g){try{g.close()}catch{}S(null)}}return e.jsx(Vd,{label:t,autoStart:a,start:te,stopAll:tt,startPhonePairing:De,startWifiConnection:fe,startUsbConnection:he,connectToWifiDevice:Pe,connectToUsbDevice:ce,videoRef:l,streaming:d,mode:I,setMode:N,pairCode:x,mobileUrl:We,ttl:Re,qrDataUrl:Ve,regenerateCode:mt,httpsInfo:T,showTips:w,setShowTips:_,wifiDevices:ie,usbDevices:Me,discoveringWifi:Z,discoveringUsb:Se,scaleOverride:s,className:i,aspect:n,style:r,fill:o})}function Vd(t){const{cameraScale:a,cameraAspect:s}=is(),i=Math.max(.5,Math.min(1.25,Number(t.scaleOverride??a??1))),{label:n,start:r,stopAll:o,startPhonePairing:l,startWifiConnection:d,startUsbConnection:c,connectToWifiDevice:u,connectToUsbDevice:h,videoRef:x,streaming:p,mode:g,setMode:S,pairCode:D,mobileUrl:I,ttl:N,qrDataUrl:E,regenerateCode:A,httpsInfo:O,showTips:M,setShowTips:v,wifiDevices:b,usbDevices:F,discoveringWifi:z,discoveringUsb:T,className:U,aspect:w,style:_,fill:ie}=t,[R,Z]=m.useState(null),ae=m.useRef(null);m.useEffect(()=>()=>{ae.current&&window.clearTimeout(ae.current)},[]);const Me=w&&w!=="inherit"?w:s||"wide",st=Me!=="free",Se=st?Me==="square"?"aspect-square":Me==="portrait"?"aspect-[3/4]":Me==="classic"?"aspect-[4/3]":"aspect-video":"",dt=[ie?"rounded-2xl overflow-hidden bg-black w-full flex flex-col":"rounded-2xl overflow-hidden bg-black w-full mx-auto flex flex-col",U].filter(Boolean).join(" ").trim(),ye={..._||{}},We=ie?"relative flex-1 min-h-[220px] bg-black":"relative w-full bg-black",Ve={style:{transform:`scale(${i})`,transformOrigin:"center"}},Ge=(()=>{const te="absolute inset-0 w-full h-full object-contain object-center bg-black";return ie?st?e.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:e.jsx("div",{className:`relative w-full max-w-full max-h-full ${Se}`,children:e.jsx("video",{ref:x,className:te,...Ve})})}):e.jsx("video",{ref:x,className:te,...Ve}):st?e.jsx("div",{className:`relative w-full ${Se}`,children:e.jsx("video",{ref:x,className:te,...Ve})}):e.jsx("video",{ref:x,className:"w-full h-full object-contain object-center bg-black",...Ve})})();async function Re(te,at){if(te)try{if(navigator.clipboard&&navigator.clipboard.writeText)await navigator.clipboard.writeText(te);else{const fe=document.createElement("textarea");fe.value=te,fe.style.position="fixed",fe.style.opacity="0",document.body.appendChild(fe),fe.focus(),fe.select(),document.execCommand("copy"),document.body.removeChild(fe)}Z(at),ae.current&&window.clearTimeout(ae.current),ae.current=window.setTimeout(()=>Z(null),1500)}catch(fe){console.warn("Copy to clipboard failed:",fe),Z(null)}}return e.jsxs("div",{className:dt,style:ye,children:[e.jsx("div",{className:We,children:g==="phone"&&p?e.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-gradient-to-b from-slate-900 to-slate-950 text-slate-300 text-sm",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-2xl mb-2",children:"📱"}),e.jsx("div",{className:"font-semibold",children:"Phone Camera Active"}),e.jsx("div",{className:"text-xs opacity-75 mt-1",children:"Feed displayed above in floating overlay"})]})}):Ge}),e.jsxs("div",{className:"p-1 flex items-center justify-between bg-black/60 text-white text-[10px] gap-1",children:[e.jsx("span",{className:"truncate",children:n||(p?g==="phone"?"PHONE LIVE":g==="wifi"?"WIFI LIVE":"LIVE":"Camera")}),e.jsxs("div",{className:"flex items-center gap-1",children:[!p&&e.jsxs(e.Fragment,{children:[e.jsx("button",{className:`px-1 py-0.5 rounded ${g==="local"?"bg-emerald-600":"bg-slate-700"}`,onClick:()=>{S("local"),r()},children:"Local"}),e.jsx("button",{className:`px-1 py-0.5 rounded ${g==="phone"?"bg-emerald-600":"bg-slate-700"}`,onClick:l,children:"Phone"}),e.jsx("button",{className:`px-1 py-0.5 rounded ${g==="wifi"?"bg-emerald-600":"bg-slate-700"}`,onClick:()=>{S("wifi"),d()},children:"Wifi"}),e.jsx("button",{className:`px-1 py-0.5 rounded ${g==="wifi"?"bg-emerald-600":"bg-slate-700"}`,onClick:()=>{S("wifi"),c()},children:"USB"})]}),p?e.jsx("button",{className:"px-1 py-0.5 rounded bg-rose-600",onClick:o,children:"Stop"}):null]})]}),g==="phone"&&D&&!p&&e.jsxs("div",{className:"p-2 text-white text-[10px] bg-black/50",children:[e.jsx("div",{className:"text-xs opacity-80",children:"Launch on your mobile:"}),e.jsxs("button",{type:"button",className:"mt-1 w-full text-left px-2 py-1 rounded bg-white/5 border border-white/10 hover:bg-white/10 transition flex items-center gap-2",onClick:()=>Re(I,"link"),title:"Copy mobile camera link",children:[e.jsx("span",{className:"flex-1 min-w-0 font-mono break-all",children:I}),e.jsx("span",{className:"text-[9px] uppercase tracking-wide whitespace-nowrap text-emerald-200",children:R==="link"?"Copied!":"Copy"})]}),e.jsxs("div",{className:"mt-1 flex items-center gap-2",children:[e.jsx("a",{href:I,target:"_blank",rel:"noreferrer",className:"px-2 py-1 rounded border border-indigo-500/30 text-indigo-100 hover:bg-indigo-500/20 transition",children:"Open link"}),e.jsxs("button",{type:"button",className:"flex-1 text-left px-2 py-1 rounded bg-white/5 border border-white/10 hover:bg-white/10 transition flex items-center justify-between gap-2",onClick:()=>Re(D,"code"),title:"Copy pairing code",children:[e.jsx("span",{className:"font-mono tracking-[0.3em] text-sm",children:D}),e.jsx("span",{className:"text-[9px] uppercase tracking-wide whitespace-nowrap text-emerald-200",children:R==="code"?"Copied!":"Copy"})]})]}),E&&e.jsx("img",{className:"mt-1 w-[160px] h-[160px] bg-white rounded",alt:"Scan to open",src:E}),e.jsxs("div",{className:"mt-1 flex items-center gap-2",children:[N!==null&&e.jsxs("span",{children:["Expires in ",N,"s"]}),e.jsx("button",{className:"px-1 py-0.5 rounded bg-slate-700",onClick:A,children:"Regenerate"})]}),M&&e.jsxs("div",{className:"mt-2 p-2 rounded bg-slate-900/60 border border-slate-700/50 text-slate-200",children:[e.jsx("div",{className:"font-semibold mb-1",children:"Troubleshooting"}),e.jsxs("ul",{className:"list-disc pl-4 space-y-1",children:[e.jsx("li",{children:"Phone and desktop must be on the same Wi‑Fi network."}),e.jsxs("li",{children:["Allow the server through your firewall (ports 8787 and ",O?.https?O.port:8788,")."]}),e.jsx("li",{children:"On iPhone, use HTTPS links (QR will prefer https when enabled)."})]}),e.jsx("div",{className:"mt-2 text-right",children:e.jsx("button",{className:"btn btn--ghost px-2 py-1 text-xs",onClick:()=>v(!1),children:"Hide tips"})})]})]}),g==="wifi"&&!p&&e.jsxs("div",{className:"p-2 text-white text-[10px] bg-black/50",children:[e.jsx("div",{className:"font-semibold mb-2",children:"Scoring Devices"}),e.jsxs("div",{className:"mb-3",children:[e.jsx("div",{className:"font-medium mb-1",children:"WiFi Devices"}),z?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"animate-spin rounded-full h-3 w-3 border-b-2 border-white"}),e.jsx("span",{children:"Scanning network..."})]}):b.length>0?e.jsxs("div",{className:"space-y-1",children:[b.map(te=>e.jsxs("div",{className:"flex items-center justify-between p-1 rounded bg-slate-900/60",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"font-medium truncate",children:te.name}),e.jsxs("div",{className:"opacity-70 text-[9px]",children:[te.ip,":",te.port]})]}),e.jsx("button",{className:`px-1 py-0.5 rounded text-[9px] ${te.status==="connecting"?"bg-yellow-600":te.status==="online"?"bg-green-600":"bg-blue-600"}`,onClick:()=>u(te),disabled:te.status==="connecting",children:te.status==="connecting"?"...":"Connect"})]},te.id)),e.jsx("div",{className:"text-center mt-2",children:e.jsx("button",{className:"px-1 py-0.5 rounded bg-slate-700 text-[9px]",onClick:d,children:"Rescan WiFi"})})]}):e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"mb-1 opacity-70",children:"No WiFi devices found"}),e.jsx("button",{className:"px-1 py-0.5 rounded bg-slate-700 text-[9px]",onClick:d,children:"Scan WiFi"})]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium mb-1",children:"USB Devices"}),T?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"animate-spin rounded-full h-3 w-3 border-b-2 border-white"}),e.jsx("span",{children:"Scanning USB..."})]}):F.length>0?e.jsxs("div",{className:"space-y-1",children:[F.map(te=>e.jsxs("div",{className:"flex items-center justify-between p-1 rounded bg-slate-900/60",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"font-medium truncate",children:te.name}),e.jsx("div",{className:"opacity-70 text-[9px]",children:te.type.toUpperCase()})]}),e.jsx("button",{className:`px-1 py-0.5 rounded text-[9px] ${te.status==="connecting"?"bg-yellow-600":te.status==="online"?"bg-green-600":"bg-blue-600"}`,onClick:()=>h(te),disabled:te.status==="connecting",children:te.status==="connecting"?"...":"Connect"})]},te.id)),e.jsx("div",{className:"text-center mt-2",children:e.jsx("button",{className:"px-1 py-0.5 rounded bg-slate-700 text-[9px]",onClick:c,children:"Rescan USB"})})]}):e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"mb-1 opacity-70",children:"No USB devices found"}),e.jsx("button",{className:"px-1 py-0.5 rounded bg-slate-700 text-[9px]",onClick:c,children:"Scan USB"})]})]})]})]})}function Gd(t){return t.dartsThrown===0?0:(t.totalScoreStart-t.totalScoreRemaining)/t.dartsThrown*3}function Jd(t){const a=Gd(t),s=t.finished;return{avg:a,isCompleted:s,darts:t.dartsThrown,checkout:t.checkoutScore??0}}function Kd(t){if(t.legs.length===0)return;const a=[];let s,i=t.bestCheckout??0;for(const n of t.legs){if(!n.finished)continue;const r=Jd(n);a.push(r.avg),(!s||r.darts<s.darts||r.darts===s.darts&&(n.endTime??0)<s.timestamp)&&(s={darts:r.darts,timestamp:n.endTime??Date.now()}),r.checkout>i&&(i=r.checkout)}a.length&&(t.bestThreeDartAvg=Math.max(...a),t.worstThreeDartAvg=Math.min(...a)),s&&(t.bestNineDart=s),t.bestCheckout=i}const Bn=Zs((t,a)=>({roomId:"",players:[],currentPlayerIdx:0,startingScore:501,inProgress:!1,newMatch:(s,i,n="")=>t(()=>({players:s.map((o,l)=>({id:`${l}`,name:o,legsWon:0,legs:[]})),currentPlayerIdx:0,startingScore:i,inProgress:!0,roomId:n,bestLegThisMatch:void 0})),addVisit:(s,i)=>t(n=>{if(!n.inProgress)return n;const r=n.players[n.currentPlayerIdx];let o=r.legs[r.legs.length-1];return(!o||o.finished)&&(o={visits:[],totalScoreStart:n.startingScore,totalScoreRemaining:n.startingScore,dartsThrown:0,finished:!1,checkoutScore:null,startTime:Date.now()},r.legs.push(o)),o.visits.push({darts:i,score:s}),o.dartsThrown+=i,o.totalScoreRemaining=Math.max(0,o.totalScoreRemaining-s),{...n}}),undoVisit:()=>t(s=>{const i=s.players[s.currentPlayerIdx],n=i.legs[i.legs.length-1];if(!n||n.finished||n.visits.length===0)return s;const r=n.visits.pop();return n.dartsThrown-=r.darts,n.totalScoreRemaining+=r.score,{...s}}),endLeg:s=>t(i=>{const n=i.players[i.currentPlayerIdx],r=n.legs[n.legs.length-1];if(!r||r.finished)return i;if(r.finished=!0,r.checkoutScore=s,r.endTime=Date.now(),r.totalScoreRemaining===0){n.legsWon+=1;const o=i.bestLegThisMatch;(!o||r.dartsThrown<o.darts)&&(i.bestLegThisMatch={playerId:n.id,darts:r.dartsThrown,timestamp:r.endTime})}return{...i}}),nextPlayer:()=>t(s=>({...s,currentPlayerIdx:(s.currentPlayerIdx+1)%s.players.length})),endGame:()=>t(s=>{for(const i of s.players)Kd(i);return{...s,inProgress:!1}}),importState:s=>t(()=>({...s}))}));function Yd(t,a){const s=bd(t,a);return gd(s)}function Xd(t){try{if(!t||typeof t!="object")return null;if((t.type==="dart"||t.kind==="dart"||t.event==="dart")&&typeof t.value=="number"){const a=oo(t.ring);return lo(t.value,a)}if(typeof t.value=="number"&&t.ring){const a=oo(t.ring);return lo(t.value,a)}if(typeof t.score=="string"){const a=t.score.trim().toUpperCase();if(a==="50"||a==="DBULL"||a==="INNER_BULL")return{value:50,ring:"INNER_BULL",sector:null,mult:0};if(a==="25"||a==="BULL"||a==="OBULL")return{value:25,ring:"BULL",sector:null,mult:0};const s=a.match(/^(S|D|T)(\d{1,2})$/);if(s){const i=s[1]==="S"?1:s[1]==="D"?2:3,n=parseInt(s[2],10);if(n>=1&&n<=20)return{value:n*i,ring:i===1?"SINGLE":i===2?"DOUBLE":"TRIPLE",sector:n,mult:i}}}if(typeof t.sector=="number"&&typeof t.mult=="number"){const a=Math.max(1,Math.min(20,Math.floor(t.sector))),s=t.mult===1?1:t.mult===2?2:3;return{value:a*s,ring:s===1?"SINGLE":s===2?"DOUBLE":"TRIPLE",sector:a,mult:s}}if(t.bull){const a=String(t.bull).toLowerCase()==="inner"||t.bull===!0;return{value:a?50:25,ring:a?"INNER_BULL":"BULL",sector:null,mult:0}}}catch{}return null}function oo(t){const a=String(t||"").toUpperCase();return a.startsWith("TR")?"TRIPLE":a.startsWith("DO")?"DOUBLE":a.startsWith("SI")?"SINGLE":a==="INNER_BULL"||a==="DBULL"||a==="50"||a==="IBULL"?"INNER_BULL":a==="BULL"||a==="25"||a==="OBULL"||a==="OUTER_BULL"?"BULL":a==="MISS"||a==="0"?"MISS":"SINGLE"}function lo(t,a){const s=Math.max(0,Math.min(60,Math.round(Number(t)||0)));return a==="INNER_BULL"?{value:50,ring:a}:a==="BULL"?{value:25,ring:a}:{value:s,ring:a}}function Qd(t,a){let s=null,i=!0;function n(){if(i)try{s=new WebSocket(t),s.onmessage=r=>{try{const o=JSON.parse(r.data),l=Xd(o);l&&a(l)}catch{}},s.onclose=()=>{s=null,setTimeout(n,1500)},s.onerror=()=>{}}catch{setTimeout(n,2e3)}}return n(),{close:()=>{i=!1;try{s?.close()}catch{}}}}function co({storageKey:t,children:a,className:s,defaultWidth:i=640,defaultHeight:n=360,minWidth:r=320,minHeight:o=200,maxWidth:l=1600,maxHeight:d=1200}){const[c,u]=m.useState(()=>{try{const N=localStorage.getItem(t);if(N)return JSON.parse(N)}catch{}return{width:i,height:n}}),h=m.useRef(null),x=m.useRef(null);m.useEffect(()=>{function N(){try{localStorage.removeItem(t)}catch{}u({width:i,height:n})}return window.addEventListener("ndn:layout-reset",N),window.addEventListener("ndn:camera-reset",N),()=>{window.removeEventListener("ndn:layout-reset",N),window.removeEventListener("ndn:camera-reset",N)}},[t,i,n]),m.useEffect(()=>{try{localStorage.setItem(t,JSON.stringify(c))}catch{}},[c,t]);function p(N,E,A){return Math.max(E,Math.min(A,N))}function g(N,E){N.preventDefault();const A=x.current;if(!A)return;const O=A.getBoundingClientRect();h.current={x:N.clientX,y:N.clientY,w:O.width,h:O.height,dir:E},window.addEventListener("mousemove",S),window.addEventListener("mouseup",D)}function S(N){const E=h.current;if(!E)return;const A=N.clientX-E.x,O=N.clientY-E.y;let M=E.w,v=E.h;E.dir.includes("e")&&(M=p(E.w+A,r,l)),E.dir.includes("s")&&(v=p(E.h+O,o,d)),E.dir.includes("w")&&(M=p(E.w-A,r,l)),E.dir.includes("n")&&(v=p(E.h-O,o,d)),u({width:Math.round(M),height:Math.round(v)})}function D(){window.removeEventListener("mousemove",S),window.removeEventListener("mouseup",D),h.current=null}const I={width:c.width?`${c.width}px`:void 0,height:c.height?`${c.height}px`:void 0,maxWidth:"100%",maxHeight:"80vh",position:"relative"};return e.jsxs("div",{ref:x,className:`${s||""}`,style:I,children:[a,e.jsx("div",{className:"resizer resizer-nw",onMouseDown:N=>g(N,"nw")}),e.jsx("div",{className:"resizer resizer-ne",onMouseDown:N=>g(N,"ne")}),e.jsx("div",{className:"resizer resizer-sw",onMouseDown:N=>g(N,"sw")}),e.jsx("div",{className:"resizer resizer-se",onMouseDown:N=>g(N,"se")})]})}function Qs({storageKey:t,children:a,className:s,defaultWidth:i=520,defaultHeight:n,minWidth:r=360,minHeight:o=200,maxWidth:l=1100,maxHeight:d=900,fullScreen:c=!1,initialFitHeight:u=!1}){const[h,x]=m.useState(()=>{if(!c){try{const O=localStorage.getItem(t);if(O)return JSON.parse(O)}catch{}return{width:i,height:n}}return{}}),p=m.useRef(null);m.useEffect(()=>{if(c)return;function O(){try{localStorage.removeItem(t)}catch{}if(u&&N.current?.parentElement){const M=N.current.parentElement,v=window.getComputedStyle(M),b=parseFloat(v.paddingTop||"0")||0,F=parseFloat(v.paddingBottom||"0")||0,z=Math.max(0,M.clientHeight-b-F),T=Math.max(o,Math.min(d,Math.round(z)));x({width:i,height:T});return}x({width:i,height:n})}return window.addEventListener("ndn:layout-reset",O),()=>window.removeEventListener("ndn:layout-reset",O)},[t,i,n,c]),m.useEffect(()=>{if(!c)try{localStorage.setItem(t,JSON.stringify(h))}catch{}},[h,t,c]),m.useEffect(()=>{if(c||!u)return;const O=N.current?.parentElement;if(!O)return;const M=window.getComputedStyle(O),v=parseFloat(M.paddingTop||"0")||0,b=parseFloat(M.paddingBottom||"0")||0,F=Math.max(0,O.clientHeight-v-b),z=Math.max(o,Math.min(d,Math.round(F)));try{const T=localStorage.getItem(t);if(T){const w=JSON.parse(T)?.height||0;(!w||w<z)&&x(_=>({..._,height:z}));return}}catch{}x(T=>({...T,height:z}))},[u,c,t,o,d]);function g(O,M,v){return Math.max(M,Math.min(v,O))}function S(O,M){O.preventDefault();const v=N.current;if(!v)return;const b=v.getBoundingClientRect();p.current={x:O.clientX,y:O.clientY,w:b.width,h:b.height,dir:M},window.addEventListener("mousemove",D),window.addEventListener("mouseup",I)}function D(O){const M=p.current;if(!M)return;const v=O.clientX-M.x,b=O.clientY-M.y,F=M.dir;let z=M.w,T=M.h,U=1/0;const w=N.current?.parentElement;if(w){const ie=window.getComputedStyle(w),R=parseFloat(ie.paddingTop||"0")||0,Z=parseFloat(ie.paddingBottom||"0")||0;U=Math.max(0,w.clientHeight-R-Z)}const _=Math.min(d,isFinite(U)?U:d);F.includes("e")&&(z=g(M.w+v,r,l)),F.includes("s")&&(T=g(M.h+b,o,_)),F.includes("w")&&(z=g(M.w-v,r,l)),F.includes("n")&&(T=g(M.h-b,o,_)),x({width:Math.round(z),height:Math.round(T)})}function I(){window.removeEventListener("mousemove",D),window.removeEventListener("mouseup",I),p.current=null}const N=m.useRef(null),E=c?{width:"100%",height:"100%",maxWidth:"100%",maxHeight:"100%"}:{width:h.width?`${h.width}px`:void 0,height:h.height?`${h.height}px`:void 0,maxWidth:`${l}px`,maxHeight:"100%"},A=c?"card relative ndn-modal-full":"card relative";return e.jsxs("div",{ref:N,className:`${A} ${s||""}`,style:E,children:[a,!c&&e.jsx("div",{className:"resizer resizer-nw",onMouseDown:O=>S(O,"nw")}),!c&&e.jsx("div",{className:"resizer resizer-ne",onMouseDown:O=>S(O,"ne")}),!c&&e.jsx("div",{className:"resizer resizer-sw",onMouseDown:O=>S(O,"sw")}),!c&&e.jsx("div",{className:"resizer resizer-se",onMouseDown:O=>S(O,"se")}),!c&&e.jsx("div",{className:"resizer-edge resizer-s",onMouseDown:O=>S(O,"s")})]})}const Jo=Zs((t,a)=>({samples:[],addSample:s=>t(i=>({samples:[...i.samples,s]})),clear:()=>t({samples:[]}),export:()=>a().samples.slice()}));function Ze({onVisitCommitted:t,showToolbar:a=!0,onAutoDart:s,immediateAutoCommit:i=!1,hideInlinePanels:n=!1,scoringMode:r="x01",onGenericDart:o,onGenericReplace:l}){const d=m.useRef(null),{preferredCameraId:c,preferredCameraLabel:u,setPreferredCamera:h,autoscoreProvider:x,autoscoreWsUrl:p}=is(),g=x==="manual",[S,D]=m.useState([]),I=m.useRef(null),N=m.useRef(null),[E,A]=m.useState(!1),[O,M]=m.useState(!1),[v,b]=m.useState(null),{H:F,imageSize:z,reset:T,_hydrated:U}=ha(),[w,_]=m.useState(""),[ie,R]=m.useState(""),[Z,ae]=m.useState(0),[Me,st]=m.useState("MISS"),[Se,Te]=m.useState(0),[dt,ye]=m.useState(0),[We,Ve]=m.useState([]),Ge=Bn($=>$.addVisit),Re=Bn($=>$.endLeg),te=Bn($=>$),at=Jo($=>$.addSample),[fe,Pe]=m.useState(""),[he,ce]=m.useState(""),[rt,De]=m.useState(0),[mt,tt]=m.useState(!1),[ne,de]=m.useState(!1),[ge,me]=m.useState("auto"),[ze,ke]=m.useState(!1),[lt,yt]=m.useState(!1),[k,ee]=m.useState(!1),At=m.useRef(null);m.useEffect(()=>{const $=()=>{g||yt(!0)};return window.addEventListener("ndn:open-autoscore",$),()=>window.removeEventListener("ndn:open-autoscore",$)},[g]),m.useEffect(()=>{const $=()=>ee(!0);return window.addEventListener("ndn:open-scoring",$),()=>window.removeEventListener("ndn:open-scoring",$)},[]),m.useEffect(()=>{const $=()=>{me("manual"),ke(!0)},J=()=>{me("auto"),ke(!1)};return window.addEventListener("ndn:open-manual",$),window.addEventListener("ndn:close-manual",J),()=>{window.removeEventListener("ndn:open-manual",$),window.removeEventListener("ndn:close-manual",J)}},[]),m.useEffect(()=>{g&&(me("manual"),yt(!1))},[g]),m.useEffect(()=>{if(!ze)return;const $=setInterval(()=>{try{const J=d.current,ue=At.current;if(!J||!ue)return;const le=J.videoWidth||0,Xe=J.videoHeight||0;if(!le||!Xe)return;const Le=ue.clientWidth||640,je=ue.clientHeight||360;ue.width!==Le&&(ue.width=Le),ue.height!==je&&(ue.height=je);const $e=ue.getContext("2d");if(!$e)return;$e.imageSmoothingEnabled=!0;const Bt=Math.min(Le/le,je/Xe),it=Math.round(le*Bt),nt=Math.round(Xe*Bt),Ps=Math.floor((Le-it)/2),Es=Math.floor((je-nt)/2);$e.fillStyle="#000",$e.fillRect(0,0,Le,je),$e.drawImage(J,Ps,Es,it,nt)}catch(J){console.warn("Manual preview update error:",J)}},120);return()=>clearInterval($)},[ze]),m.useEffect(()=>()=>Mt(),[]);async function Ae(){if(!(O||E)){if(u==="Phone Camera"){console.log("[CAMERA] Phone camera is selected - skipping local camera startup"),console.log("[CAMERA] Phone camera feed shown via overlay in game tabs"),M(!1);return}M(!0),console.log("[CAMERA] Starting camera...");try{const $=c?{video:{deviceId:{exact:c}},audio:!1}:{video:{facingMode:"environment"},audio:!1};console.log("[CAMERA] Using constraints:",$);let J;try{J=await navigator.mediaDevices.getUserMedia($),console.log("[CAMERA] Got stream:",!!J)}catch(ue){console.warn("[CAMERA] First attempt failed:",ue);const le=ue&&(ue.name||ue.code)||"";if(c&&(le==="OverconstrainedError"||le==="NotFoundError"))console.log("[CAMERA] Trying fallback without deviceId"),J=await navigator.mediaDevices.getUserMedia({video:!0,audio:!1});else if(!c&&(le==="OverconstrainedError"||le==="NotFoundError"||le==="NotSupportedError"))console.log("[CAMERA] Trying fallback for facingMode not supported"),J=await navigator.mediaDevices.getUserMedia({video:!0,audio:!1});else throw ue}if(d.current){console.log("[CAMERA] Setting stream to video element"),d.current.srcObject=J,console.log("[CAMERA] Stream tracks:",J.getTracks().length,"video tracks:",J.getVideoTracks().length),d.current.addEventListener("loadeddata",()=>console.log("[CAMERA] Video loadeddata")),d.current.addEventListener("canplay",()=>console.log("[CAMERA] Video canplay")),d.current.addEventListener("play",()=>console.log("[CAMERA] Video started playing")),d.current.addEventListener("error",ue=>console.error("[CAMERA] Video error:",ue));try{d.current.play(),console.log("[CAMERA] Play called successfully")}catch(ue){console.error("[CAMERA] Video play failed:",ue),setTimeout(()=>{try{d.current?.play(),console.log("[CAMERA] Retry play called")}catch(le){console.error("[CAMERA] Retry play failed:",le)}},100)}}else console.error("[CAMERA] Video element not found");A(!0);try{const ue=await navigator.mediaDevices.enumerateDevices();D(ue.filter(le=>le.kind==="videoinput")),console.log("[CAMERA] Found cameras:",ue.filter(le=>le.kind==="videoinput").length)}catch(ue){console.warn("[CAMERA] Failed to enumerate devices:",ue)}}catch($){console.error("[CAMERA] Camera start failed:",$),alert("Camera permission denied or not available.")}finally{M(!1)}}}function Mt(){d.current&&d.current.srcObject&&(d.current.srcObject.getTracks().forEach(J=>J.stop()),d.current.srcObject=null,A(!1),M(!1))}function Rt(){try{if(!d.current||!I.current)return;const $=d.current,J=I.current;J.width=$.videoWidth,J.height=$.videoHeight;const ue=J.getContext("2d");if(!ue)return;ue.drawImage($,0,0,J.width,J.height);const le=J.toDataURL("image/png");b(le)}catch($){console.warn("Capture error:",$)}}function Pt(){return S.length?e.jsxs("div",{className:"absolute top-2 right-2 z-20 flex items-center gap-2 bg-black/40 rounded px-2 py-1 text-xs",children:[e.jsx("span",{children:"Cam:"}),e.jsxs("select",{className:"bg-black/20 rounded px-1 py-0.5",value:c||"",onChange:async $=>{if(O)return;const J=$.target.value||void 0,ue=S.find(le=>le.deviceId===J)?.label;h(J,ue||"",!0),Mt(),await new Promise(le=>setTimeout(le,100));try{await Ae()}catch(le){console.warn("Failed to start camera after device switch:",le),setTimeout(async()=>{try{await Ae()}catch(Xe){console.error("Camera switch failed after retry:",Xe),alert("Failed to switch camera. Please try again or refresh the page.")}},500)}},children:[e.jsx("option",{value:"",children:"Auto"}),S.map($=>e.jsx("option",{value:$.deviceId,children:$.label||"Camera"},$.deviceId))]})]}):null}function Oe(){try{if(!N.current||!d.current||!F||!z)return;const $=N.current,J=d.current,ue=J.clientWidth,le=J.clientHeight;$.width=ue,$.height=le;const Xe=$.getContext("2d");if(!Xe)return;Xe.clearRect(0,0,ue,le);const Le=ue/z.w,je=le/z.h,$e=hd(F,Le,je),Bt=[He.bullInner,He.bullOuter,He.trebleInner,He.trebleOuter,He.doubleInner,He.doubleOuter];for(const it of Bt){const nt=Ho($e,it,360);Wo(Xe,nt,it===He.doubleOuter?"#22d3ee":"#a78bfa",it===He.doubleOuter?3:2)}}catch($){console.warn("Overlay drawing error:",$)}}m.useEffect(()=>{if(g)return;const $=setInterval(Oe,250);return()=>clearInterval($)},[F,z,E,g]),m.useEffect(()=>{if(x!=="external-ws"||!p)return;const $=Qd(p,J=>{if(s){try{s(J.value,J.ring,{sector:J.sector??null,mult:J.mult??0})}catch{}try{at({playerId:te.players[te.currentPlayerIdx]?.id??null,sector:J.sector??null,mult:J.mult??0,ring:J.ring,ts:Date.now()})}catch{}}else{const ue=J.ring==="INNER_BULL"?"INNER_BULL 50":J.ring==="BULL"?"BULL 25":`${J.ring[0]}${J.value/(J.mult||1)||J.value} ${J.value}`;ht(J.value,ue,J.ring);try{at({playerId:te.players[te.currentPlayerIdx]?.id??null,sector:J.sector??null,mult:J.mult??0,ring:J.ring,ts:Date.now()})}catch{}}});return()=>$.close()},[x,p]);function _t($){if(!N.current||!F||!z)return;const J=N.current.getBoundingClientRect(),ue=$.clientX-J.left,le=$.clientY-J.top,Xe=N.current.width/z.w,Le=N.current.height/z.h,je={x:ue/Xe,y:le/Le},$e=Yd(F,je),Bt=`${$e.ring} ${$e.base>0?$e.base:""}`.trim();_(Bt),ae($e.base),st($e.ring),de(!0);try{if(i&&s){s($e.base,$e.ring,{sector:$e.sector,mult:$e.mult});try{at({playerId:te.players[te.currentPlayerIdx]?.id??null,sector:$e.sector??null,mult:$e.mult??0,ring:$e.ring,ts:Date.now()})}catch{}de(!1)}}catch{}}function Et($){const J=$.trim().toUpperCase();if(!J)return null;const ue=J==="BULL"||J==="50"||J==="DBULL"||J==="IBULL",le=J==="25"||J==="OBULL";if(ue)return{label:"INNER_BULL 50",value:50,ring:"INNER_BULL"};if(le)return{label:"BULL 25",value:25,ring:"BULL"};const Xe=J.match(/^(S|D|T)?\s*(\d{1,2})$/);if(!Xe)return null;const Le=Xe[1]||"S",je=parseInt(Xe[2],10);if(je<1||je>20)return null;const $e=Le==="S"?1:Le==="D"?2:3,Bt=Le==="S"?"SINGLE":Le==="D"?"DOUBLE":"TRIPLE";return{label:`${Le}${je} ${je*$e}`,value:je*$e,ring:Bt}}function Lt(){const $=te;if(!$.players.length)return $.startingScore;const J=$.players[$.currentPlayerIdx],ue=J.legs[J.legs.length-1];return ue?ue.totalScoreRemaining:$.startingScore}function ht($,J,ue){if(r==="custom"){if(o)try{o($,ue,{label:J})}catch{}if(Se>=3)return;const it=Se+1;Te(it),ye(nt=>nt+$),Ve(nt=>[...nt,{label:J,value:$,ring:ue}]);return}if(Se>=3)return;const le=Se+1,Xe=dt+$,je=Lt()-Xe,$e=je===0&&(ue==="DOUBLE"||ue==="INNER_BULL");if(je<0||je===1||je===0&&!$e){Ge(0,le),Te(0),ye(0),Ve([]),t&&t(0,le,!1);return}if(Te(le),ye(Xe),Ve(it=>[...it,{label:J,value:$,ring:ue}]),$e){Ge(Xe,le),Re(Xe),Te(0),ye(0),Ve([]),t&&t(Xe,le,!0);return}le>=3&&(Ge(Xe,le),Te(0),ye(0),Ve([]),t&&t(Xe,le,!1))}function $t(){if(w){if(s)try{s(Z,Me,void 0)}catch{}else ht(Z,w,Me);De(0),de(!1)}}function jt(){const $=Et(ie);if(!$){alert("Enter like T20, D16, 5, 25, 50");return}if(!ne||!w||Me==="MISS"||Z===0){const J=rt+1;De(J),J>=3&&tt(!0)}else De(0);ht($.value,$.label,$.ring),R(""),de(!1)}function Tt(){const $=Et(ie);if(!$){alert("Enter like T20, D16, 5, 25, 50");return}if(Se===0||We.length===0){jt();return}if(r==="custom"){if(!ne||!w||Me==="MISS"||Z===0){const nt=rt+1;De(nt),nt>=3&&tt(!0)}else De(0);if(Ve(nt=>[...nt.slice(0,-1),{label:$.label,value:$.value,ring:$.ring}]),l)try{l($.value,$.ring,{label:$.label})}catch{}R(""),de(!1);return}if(!ne||!w||Me==="MISS"||Z===0){const nt=rt+1;De(nt),nt>=3&&tt(!0)}else De(0);const J=We[We.length-1],ue=Se-1,le=dt-(J?.value||0),Xe=Lt(),Le=le+$.value,je=ue+1,$e=Xe-Le,Bt=$e===0&&($.ring==="DOUBLE"||$.ring==="INNER_BULL");if($e<0||$e===1||$e===0&&!Bt){Ge(0,je);try{const nt=te.players[te.currentPlayerIdx]?.name;nt&&rn(nt,je,0)}catch{}Te(0),ye(0),Ve([]),t&&t(0,je,!1),R(""),de(!1);return}if(Te(je),ye(Le),Ve(nt=>[...nt.slice(0,-1),{label:$.label,value:$.value,ring:$.ring}]),Bt){Ge(Le,je),Re(Le);try{const nt=te.players[te.currentPlayerIdx]?.name;nt&&rn(nt,je,Le)}catch{}Te(0),ye(0),Ve([]),t&&t(Le,je,!0),R(""),de(!1);return}if(je>=3){Ge(Le,je);try{const nt=te.players[te.currentPlayerIdx]?.name;nt&&rn(nt,je,Le)}catch{}Te(0),ye(0),Ve([]),t&&t(Le,je,!1)}R(""),de(!1)}function H(){tt(!1),De(0);try{window.dispatchEvent(new CustomEvent("ndn:request-calibrate"))}catch{}}function Ne(){T(),tt(!1),De(0)}function Ye($,J){if(Se>=3)return;const ue=$*(J==="S"?1:J==="D"?2:3),le=J==="S"?"SINGLE":J==="D"?"DOUBLE":"TRIPLE";if(!ne||!w||Me==="MISS"||Z===0){const Xe=rt+1;De(Xe),Xe>=3&&tt(!0)}else De(0);ht(ue,`${J}${$} ${ue}`,le),de(!1)}function Ht(){if(Se===0)return;const $=We[We.length-1];Te(J=>J-1),ye(J=>J-($?.value||0)),Ve(J=>J.slice(0,-1))}function Ot(){if(Se!==0){if(r==="custom"){Te(0),ye(0),Ve([]);return}Ge(dt,Se);try{const $=te.players[te.currentPlayerIdx]?.name;$&&rn($,Se,dt)}catch{}Te(0),ye(0),Ve([]),t&&t(dt,Se,!1)}}return e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-4",children:[a&&e.jsx("div",{className:"lg:col-span-2",children:e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[!g&&e.jsx("button",{className:`btn px-3 py-1 text-sm ${ge==="auto"?"tab--active":""}`,onClick:()=>{me("auto"),ke(!1),yt(!0)},children:"Autoscore"}),e.jsx("button",{className:`btn px-3 py-1 text-sm ${ge==="manual"?"tab--active":""}`,onClick:()=>{me("manual"),ke(!0)},title:"Open Manual Correction",children:"Manual Correction"}),g&&e.jsx("span",{className:"text-xs opacity-70",children:"Manual scoring mode active"})]})}),!n&&!g?e.jsxs("div",{className:"card",children:[e.jsx("h2",{className:"text-xl font-semibold mb-3",children:"Camera"}),e.jsxs(co,{storageKey:"ndn:camera:size",className:"relative rounded-2xl overflow-hidden bg-black",defaultWidth:480,defaultHeight:360,minWidth:320,minHeight:240,maxWidth:1600,maxHeight:900,children:[e.jsx(Pt,{}),u==="Phone Camera"?e.jsx("div",{className:"w-full h-full flex flex-col items-center justify-center bg-gradient-to-br from-blue-900/50 to-purple-900/50",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-4xl mb-4",children:"📱"}),e.jsx("div",{className:"text-lg font-semibold text-blue-100 mb-2",children:"Phone Camera Active"}),e.jsx("div",{className:"text-sm text-slate-300 mb-4",children:"Your phone camera feed is shown in the floating overlay"}),e.jsx("div",{className:"text-xs text-slate-400",children:"Camera controls available in Calibrator tab"})]})}):e.jsxs(e.Fragment,{children:[e.jsx("video",{ref:d,className:"w-full h-full object-cover",playsInline:!0,"webkit-playsinline":"true",muted:!0,autoPlay:!0}),e.jsx("canvas",{ref:N,className:"absolute inset-0 w-full h-full",onClick:_t})]})]}),e.jsxs("div",{className:"flex gap-2 mt-3",children:[u==="Phone Camera"?e.jsx("div",{className:"text-sm text-blue-200 px-3 py-2 rounded bg-blue-900/30 flex-1",children:"📱 Using phone camera from overlay"}):e.jsxs(e.Fragment,{children:[E?e.jsx("button",{className:"btn bg-rose-600 hover:bg-rose-700",onClick:Mt,children:"Stop Camera"}):e.jsx("button",{className:"btn",onClick:Ae,disabled:O,children:O?"Connecting Camera...":"Connect Camera"}),e.jsx("button",{className:"btn",onClick:Rt,disabled:!E,children:"Capture Still"})]}),e.jsx("button",{className:"btn bg-slate-700 hover:bg-slate-800",onClick:()=>{try{window.dispatchEvent(new Event("ndn:camera-reset"))}catch{}},children:"Reset Camera Size"})]})]}):null,!n&&g&&e.jsxs("div",{className:"card",children:[e.jsx("h2",{className:"text-xl font-semibold mb-3",children:"Manual Scoring"}),e.jsx("p",{className:"text-sm opacity-80 mb-3",children:"Camera-based autoscore is disabled. Use the manual visit input or open the Manual Correction panel to record darts."}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsx("button",{className:"btn",onClick:()=>{ke(!0),me("manual")},children:"Open Manual Correction"}),e.jsx("button",{className:"btn btn--ghost",onClick:()=>{try{window.dispatchEvent(new Event("ndn:open-scoring"))}catch{}},children:"Manage Pending Visit"})]})]}),e.jsx("canvas",{ref:I,className:"hidden"}),lt&&!g&&e.jsx("div",{className:"fixed inset-0 bg-black/60 z-[100]",role:"dialog","aria-modal":"true",children:e.jsx("div",{className:"absolute inset-0 flex items-center justify-center p-4",children:e.jsxs(Qs,{storageKey:"ndn:autoscore:size",className:"w-full max-w-3xl",defaultWidth:720,defaultHeight:520,minWidth:420,minHeight:320,maxWidth:1400,maxHeight:900,initialFitHeight:!0,children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h2",{className:"text-xl font-semibold",children:"Autoscore"}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("button",{className:"btn btn--ghost",onClick:()=>yt(!1),children:"Close"})})]}),e.jsx("div",{className:"text-sm opacity-80 mb-3",children:"Click the camera overlay to autoscore. Use Manual Correction if the last auto is off."}),e.jsxs("div",{className:"flex items-center gap-2 mb-3 flex-wrap",children:[e.jsx("span",{className:"font-semibold",children:"Last auto:"}),e.jsx("span",{children:w||"—"}),e.jsx("button",{className:"btn",onClick:$t,disabled:Se>=3,children:"Add Auto Dart"}),rt>0&&e.jsxs("span",{className:"text-sm opacity-80",children:["No-registers: ",rt,"/3"]})]}),e.jsxs("div",{className:"mt-2",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"Quick entry"}),e.jsxs("div",{className:"flex flex-wrap gap-2 mb-3",children:[e.jsx("button",{className:"btn",disabled:Se>=3,onClick:()=>{if(!ne||!w||Me==="MISS"||Z===0){const $=rt+1;De($),$>=3&&tt(!0)}else De(0);ht(25,"BULL 25","BULL"),de(!1)},children:"25"}),e.jsx("button",{className:"btn",disabled:Se>=3,onClick:()=>{if(!ne||!w||Me==="MISS"||Z===0){const $=rt+1;De($),$>=3&&tt(!0)}else De(0);ht(50,"INNER_BULL 50","INNER_BULL"),de(!1)},children:"50"})]}),e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx("input",{className:"input w-full max-w-sm",list:"autoscore-quick-list",placeholder:"Type or select (e.g., D16, T20, S5)",value:fe,onChange:$=>Pe($.target.value.toUpperCase()),onKeyDown:$=>{if($.key==="Enter"){const J=fe.match(/^(S|D|T)(\d{1,2})$/);J&&Ye(parseInt(J[2],10),J[1])}}}),e.jsx("datalist",{id:"autoscore-quick-list",children:["D","S","T"].map($=>Array.from({length:20},(J,ue)=>ue+1).map(J=>e.jsx("option",{value:`${$}${J}`},`${$}${J}`)))}),e.jsx("button",{className:"btn",disabled:!fe||Se>=3,onClick:()=>{const $=fe.match(/^(S|D|T)(\d{1,2})$/);if(!$)return;const J=$[1],ue=parseInt($[2],10);Ye(ue,J)},children:"Add"})]})]})]})})}),ze&&e.jsx("div",{className:"fixed inset-0 bg-black/60 z-[100]",role:"dialog","aria-modal":"true",children:e.jsxs("div",{className:"absolute inset-0 flex flex-col",children:[e.jsxs("div",{className:"p-3 md:p-4 flex items-center justify-between",children:[e.jsx("h3",{className:"text-xl md:text-2xl font-semibold",children:"Manual Correction"}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("button",{className:"btn bg-slate-700 hover:bg-slate-800",onClick:()=>{ke(!1)},children:"Close"})})]}),e.jsx("div",{className:"flex-1 p-3 md:p-4",children:e.jsxs("div",{className:"h-full grid grid-cols-1 lg:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"card relative flex flex-col",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"Live Preview"}),e.jsx("div",{className:"relative flex-1 rounded-2xl overflow-hidden bg-black",children:e.jsx("canvas",{ref:At,className:"absolute inset-0 w-full h-full"})})]}),e.jsxs("div",{className:"card flex flex-col",children:[e.jsx("div",{className:"text-sm opacity-80 mb-2",children:"Type a correction or replace the last dart. The preview updates live."}),e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("span",{className:"font-semibold",children:"Last auto:"}),e.jsx("span",{children:w||"—"}),e.jsx("button",{className:"btn",onClick:$t,disabled:Se>=3,children:"Add Auto Dart"})]}),e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("input",{className:"input flex-1",placeholder:"Manual (T20, D16, 5, 25, 50)",value:ie,onChange:$=>R($.target.value),onKeyDown:$=>{$.key==="Enter"&&!$.shiftKey&&($.preventDefault(),jt()),$.key==="Enter"&&$.shiftKey&&($.preventDefault(),Tt())}}),e.jsx("button",{className:"btn btn--ghost",onClick:Tt,disabled:Se===0,children:"Replace Last"}),e.jsx("button",{className:"btn",onClick:jt,disabled:Se>=3,children:"Add"})]}),e.jsx("div",{className:"text-xs opacity-70 mb-4",children:"Press Enter to Add · Shift+Enter to Replace Last"}),e.jsxs("div",{className:"mt-auto",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"Quick entry"}),e.jsxs("div",{className:"flex flex-wrap gap-2 mb-3",children:[e.jsx("button",{className:"btn",disabled:Se>=3,onClick:()=>{if(!ne||!w||Me==="MISS"||Z===0){const $=rt+1;De($),$>=3&&tt(!0)}else De(0);ht(25,"BULL 25","BULL"),de(!1)},children:"25"}),e.jsx("button",{className:"btn",disabled:Se>=3,onClick:()=>{if(!ne||!w||Me==="MISS"||Z===0){const $=rt+1;De($),$>=3&&tt(!0)}else De(0);ht(50,"INNER_BULL 50","INNER_BULL"),de(!1)},children:"50"})]}),e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx("input",{className:"input w-full max-w-sm",list:"manual-quick-list",placeholder:"Type or select (e.g., D16, T20, S5)",value:he,onChange:$=>ce($.target.value.toUpperCase()),onKeyDown:$=>{if($.key==="Enter"){const J=he.match(/^(S|D|T)(\d{1,2})$/);J&&Ye(parseInt(J[2],10),J[1])}}}),e.jsx("datalist",{id:"manual-quick-list",children:["D","S","T"].map($=>Array.from({length:20},(J,ue)=>ue+1).map(J=>e.jsx("option",{value:`${$}${J}`},`${$}${J}`)))}),e.jsx("button",{className:"btn",disabled:!he||Se>=3,onClick:()=>{const $=he.match(/^(S|D|T)(\d{1,2})$/);if(!$)return;const J=$[1],ue=parseInt($[2],10);Ye(ue,J)},children:"Add"})]})]})]})]})})]})}),k&&e.jsx("div",{className:"fixed inset-0 bg-black/60 z-[100] flex items-center justify-center",children:e.jsxs("div",{className:"card w-full max-w-4xl relative text-left bg-[#2d2250] text-white p-6 rounded-xl shadow-xl",children:[e.jsx("button",{className:"absolute top-2 right-2 btn px-2 py-1 bg-purple-500 text-white font-bold",onClick:()=>ee(!1),children:"Close"}),e.jsx("h2",{className:"text-xl font-bold mb-4 flex items-center gap-2 text-white",children:"Scoring"}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"bg-black/30 rounded-2xl p-4",children:[e.jsx("h2",{className:"text-lg font-semibold mb-3",children:"Camera"}),e.jsxs(co,{storageKey:"ndn:camera:size:modal",className:"relative rounded-2xl overflow-hidden bg-black",defaultWidth:480,defaultHeight:360,minWidth:320,minHeight:240,maxWidth:1600,maxHeight:900,children:[e.jsx(Pt,{}),u==="Phone Camera"?e.jsx("div",{className:"w-full h-full flex flex-col items-center justify-center bg-gradient-to-br from-blue-900/50 to-purple-900/50",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-4xl mb-4",children:"📱"}),e.jsx("div",{className:"text-lg font-semibold text-blue-100 mb-2",children:"Phone Camera Active"}),e.jsx("div",{className:"text-sm text-slate-300 mb-4",children:"Your phone camera feed is shown in the floating overlay"}),e.jsx("div",{className:"text-xs text-slate-400",children:"Camera controls available in Calibrator tab"})]})}):e.jsxs(e.Fragment,{children:[e.jsx("video",{ref:d,className:"w-full h-full object-cover",playsInline:!0,"webkit-playsinline":"true",muted:!0,autoPlay:!0}),e.jsx("canvas",{ref:N,className:"absolute inset-0 w-full h-full",onClick:_t})]})]}),e.jsxs("div",{className:"flex gap-2 mt-3",children:[u==="Phone Camera"?e.jsx("div",{className:"text-sm text-blue-200 px-3 py-2 rounded bg-blue-900/30 flex-1",children:"📱 Using phone camera from overlay"}):e.jsxs(e.Fragment,{children:[E?e.jsx("button",{className:"btn bg-gradient-to-r from-rose-600 to-rose-700 text-white font-bold",onClick:Mt,children:"Stop Camera"}):e.jsx("button",{className:"btn bg-gradient-to-r from-purple-500 to-purple-700 text-white font-bold",onClick:Ae,children:"Connect Camera"}),e.jsx("button",{className:"btn bg-gradient-to-r from-indigo-500 to-indigo-700 text-white font-bold",onClick:Rt,disabled:!E,children:"Capture Still"})]}),e.jsx("button",{className:"btn bg-gradient-to-r from-slate-500 to-slate-700 text-white font-bold",onClick:()=>{try{window.dispatchEvent(new Event("ndn:camera-reset"))}catch{}},children:"Reset Camera Size"})]})]}),e.jsxs("div",{className:"bg-black/30 rounded-2xl p-4",children:[e.jsx("h2",{className:"text-lg font-semibold mb-3",children:"Pending Visit"}),e.jsx("div",{className:"text-sm opacity-80 mb-2",children:"Up to 3 darts per visit."}),e.jsx("ul",{className:"text-sm mb-2 list-disc pl-5",children:We.length===0?e.jsx("li",{className:"opacity-60",children:"No darts yet"}):We.map(($,J)=>e.jsx("li",{children:$.label},J))}),e.jsxs("div",{className:"flex items-center gap-4 mb-2",children:[e.jsxs("div",{className:"font-semibold",children:["Darts: ",Se,"/3"]}),e.jsxs("div",{className:"font-semibold",children:["Total: ",dt]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{className:"btn bg-gradient-to-r from-purple-500 to-purple-700 text-white font-bold",onClick:Ht,disabled:Se===0,children:"Undo Dart"}),e.jsx("button",{className:"btn bg-gradient-to-r from-emerald-500 to-emerald-700 text-white font-bold",onClick:Ot,disabled:Se===0,children:"Commit Visit"}),e.jsx("button",{className:"btn bg-gradient-to-r from-slate-500 to-slate-700 text-white font-bold",onClick:()=>{Te(0),ye(0),Ve([])},disabled:Se===0,children:"Clear"})]})]})]})]})}),mt&&e.jsx("div",{className:"fixed inset-0 bg-black/60 z-50 flex items-center justify-center",children:e.jsxs("div",{className:"card max-w-md w-full relative text-left bg-[#2d2250] text-white p-6 rounded-xl shadow-xl",children:[e.jsx("button",{className:"absolute top-2 right-2 btn px-2 py-1 bg-purple-500 text-white font-bold",onClick:()=>{tt(!1),De(0)},children:"Close"}),e.jsx("h3",{className:"text-xl font-bold mb-2 flex items-center gap-2 text-white",children:"Recalibration Recommended"}),e.jsx("div",{className:"mb-4 text-lg font-semibold text-indigo-200",children:"We detected 3 incorrect autoscores in a row. You can recalibrate now or reset calibration and try again."}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{className:"btn bg-gradient-to-r from-purple-500 to-purple-700 text-white font-bold",onClick:H,children:"Go to Calibrate"}),e.jsx("button",{className:"btn bg-gradient-to-r from-slate-500 to-slate-700 text-white font-bold",onClick:Ne,children:"Reset Calibration"}),e.jsx("button",{className:"btn bg-gradient-to-r from-slate-500 to-slate-700 text-white font-bold",onClick:()=>{tt(!1),De(0)},children:"Dismiss"})]})]})}),n?null:e.jsxs("div",{className:"card",children:[e.jsx("h2",{className:"text-xl font-semibold mb-3",children:"Pending Visit"}),e.jsx("div",{className:"text-sm opacity-80 mb-2",children:"Up to 3 darts per visit."}),e.jsx("ul",{className:"text-sm mb-2 list-disc pl-5",children:We.length===0?e.jsx("li",{className:"opacity-60",children:"No darts yet"}):We.map(($,J)=>e.jsx("li",{children:$.label},J))}),e.jsxs("div",{className:"flex items-center gap-4 mb-2",children:[e.jsxs("div",{className:"font-semibold",children:["Darts: ",Se,"/3"]}),e.jsxs("div",{className:"font-semibold",children:["Total: ",dt]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{className:"btn",onClick:Ht,disabled:Se===0,children:"Undo Dart"}),e.jsx("button",{className:"btn",onClick:Ot,disabled:Se===0,children:"Commit Visit"}),e.jsx("button",{className:"btn",onClick:()=>{Te(0),ye(0),Ve([])},disabled:Se===0,children:"Clear"})]})]})]})}function Pr(){const t=zn(),[a,s]=m.useState(!1),[i,n]=m.useState({x:20,y:20}),[r,o]=m.useState(!1),[l,d]=m.useState({x:0,y:0}),[c,u]=m.useState(!1),[h,x]=m.useState(!1),[p,g]=m.useState(!1),[S,D]=m.useState(!1),I=m.useRef(null),N=m.useRef(null),E=m.useRef(null);m.useEffect(()=>{const T=zn.persist?.onFinishHydration?.(()=>{console.log("[PhoneCameraOverlay] Zustand hydration complete"),s(!0)});return s(!0),()=>{T&&typeof T=="function"&&T()}},[]);const A=t.getVideoElementRef(),O=t.showOverlay&&t.isStreaming&&t.mode==="phone"&&A;if(m.useEffect(()=>{console.log("[PhoneCameraOverlay] Render check:",{hasHydrated:a,isStreaming:t.isStreaming,mode:t.mode,hasVideoElement:!!A,videoElementType:A?.constructor?.name,shouldShow:O,minimized:c}),O?console.log("[PhoneCameraOverlay] ✓ ALL CONDITIONS MET - Should display camera overlay"):console.warn("[PhoneCameraOverlay] NOT SHOWING - At least one condition failed")},[O,t.isStreaming,t.mode,t.showOverlay,A,a]),m.useEffect(()=>{if(!O||!N.current||c){E.current&&(cancelAnimationFrame(E.current),E.current=null);return}const T=N.current,U=T.getContext("2d");if(!U)return;const w=t.getVideoElementRef(),_=()=>{if(w&&U){(T.width===0||T.height===0)&&(w.videoWidth&&w.videoHeight?(T.width=w.videoWidth,T.height=w.videoHeight):(T.width=640,T.height=360));try{U.drawImage(w,0,0,T.width,T.height)}catch(ie){console.debug("[PhoneCameraOverlay] Canvas render frame error (expected during stream setup):",ie)}}E.current=requestAnimationFrame(_)};return E.current=requestAnimationFrame(_),()=>{E.current&&(cancelAnimationFrame(E.current),E.current=null)}},[O,c]),m.useEffect(()=>{const T=()=>{try{t.setShowOverlay(!t.showOverlay)}catch{}};return window.addEventListener("ndn:toggle-phone-overlay",T),()=>{window.removeEventListener("ndn:toggle-phone-overlay",T)}},[t.showOverlay]),!O)return console.warn("[PhoneCameraOverlay] DEBUG: Not showing. State:",{isStreaming:t.isStreaming,mode:t.mode,videoElement:!!A,hasHydrated:a}),null;const M=T=>{T.target.classList.contains("phone-camera-header")&&(o(!0),d({x:T.clientX-i.x,y:T.clientY-i.y}))},v=T=>{r&&n({x:T.clientX-l.x,y:T.clientY-l.y})},b=()=>{o(!1)},F=async()=>{g(!0);try{if(N.current){const T=N.current.getContext("2d");if(T){T.fillStyle="#000000",T.fillRect(0,0,N.current.width,N.current.height);const U=t.getVideoElementRef();U&&N.current.width>0&&T.drawImage(U,0,0,N.current.width,N.current.height)}}console.log("[PhoneCameraOverlay] Camera refreshed")}catch(T){console.error("[PhoneCameraOverlay] Refresh failed:",T)}finally{g(!1)}},z=()=>{D(!0);try{window.dispatchEvent(new CustomEvent("ndn:phone-camera-reconnect",{detail:{timestamp:Date.now()}})),console.log("[PhoneCameraOverlay] Reconnect requested"),setTimeout(()=>{D(!1)},1e3)}catch(T){console.error("[PhoneCameraOverlay] Reconnect failed:",T),D(!1)}};return e.jsxs("div",{ref:I,className:"fixed z-40 bg-black rounded-lg shadow-xl overflow-hidden border border-blue-500",style:{left:`${i.x}px`,top:`${i.y}px`,width:c?"160px":"320px",transition:r?"none":"all 0.2s ease-out",cursor:r?"grabbing":"grab",boxShadow:"0 0 10px rgba(59, 130, 246, 0.5)"},onMouseMove:v,onMouseUp:b,onMouseLeave:b,children:[e.jsxs("div",{className:"phone-camera-header bg-gradient-to-r from-blue-600 to-blue-700 px-2 py-1 flex items-center justify-between cursor-grab active:cursor-grabbing select-none",onMouseDown:M,children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-2 h-2 bg-red-500 rounded-full animate-pulse"}),e.jsx("span",{className:"text-xs font-semibold text-white",children:"Phone Camera"})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{onClick:()=>x(!h),className:"text-white hover:bg-blue-800 px-1.5 py-0.5 rounded text-xs font-bold transition-colors",title:"Show controls",children:"⚙"}),e.jsx("button",{onClick:()=>u(!c),className:"text-white hover:bg-blue-800 px-2 py-0.5 rounded text-xs font-bold transition-colors",title:c?"Expand":"Minimize",children:c?"▶":"▼"})]})]}),!c&&h&&e.jsxs("div",{className:"bg-slate-800 border-t border-blue-500 px-2 py-2 flex gap-1",children:[e.jsx("button",{onClick:F,disabled:p,className:`flex-1 text-xs py-1 px-2 rounded font-semibold transition-colors ${p?"bg-blue-500/50 text-white cursor-wait":"bg-blue-600 hover:bg-blue-700 text-white"}`,title:"Refresh camera feed",children:p?"🔄 Refreshing...":"🔄 Refresh"}),e.jsx("button",{onClick:z,disabled:S,className:`flex-1 text-xs py-1 px-2 rounded font-semibold transition-colors ${S?"bg-amber-500/50 text-white cursor-wait":"bg-amber-600 hover:bg-amber-700 text-white"}`,title:"Reconnect phone camera",children:S?"⟳ Reconnecting...":"⟳ Reconnect"})]}),!c&&e.jsx("div",{className:"bg-black w-full relative overflow-hidden",style:{aspectRatio:"16/9"},children:e.jsx("canvas",{ref:N,className:"w-full h-full object-contain bg-black"})})]})}function mo(t,a,s,i){const n=(i-90)*Math.PI/180;return{x:t+s*Math.cos(n),y:a+s*Math.sin(n)}}function uo(t){return[20,1,18,4,13,6,10,15,2,17,3,19,7,16,8,11,14,9,12,5].indexOf(t)*18+9}function Zd({width:t=320,height:a=320}){const s=Jo(n=>n.samples),i=m.useRef(null);return m.useEffect(()=>{const n=i.current;if(!n)return;const r=n.getContext("2d");if(!r)return;n.width=t,n.height=a,r.clearRect(0,0,t,a);const o=t/2,l=a/2,d=Math.min(t,a)/(He.doubleOuter*2+20),c={bullInner:He.bullInner*d,bullOuter:He.bullOuter*d,trebleInner:He.trebleInner*d,trebleOuter:He.trebleOuter*d,doubleInner:He.doubleInner*d,doubleOuter:He.doubleOuter*d};r.strokeStyle="rgba(255,255,255,0.06)",r.lineWidth=1;const u=["doubleOuter","doubleInner","trebleOuter","trebleInner","bullOuter","bullInner"];for(const p of u)r.beginPath(),r.arc(o,l,c[p],0,Math.PI*2),r.stroke();const h=[];for(const p of s){let g=Math.random()*360,S=Math.random()*c.doubleOuter;typeof p.sector=="number"&&p.sector>=1&&p.sector<=20&&(g=uo(p.sector),p.ring==="DOUBLE"?S=(c.doubleInner+c.doubleOuter)/2:p.ring==="TRIPLE"?S=(c.trebleInner+c.trebleOuter)/2:p.ring==="INNER_BULL"?S=c.bullInner*.5:p.ring==="BULL"?S=c.bullOuter*.8:S=(c.trebleOuter+c.doubleInner)/2*(.6+Math.random()*.4));const D=mo(o,l,S,g);h.push({x:D.x,y:D.y,w:1})}for(const p of h){const g=r.createRadialGradient(p.x,p.y,1,p.x,p.y,60);g.addColorStop(0,"rgba(255,0,0,0.9)"),g.addColorStop(.3,"rgba(255,100,0,0.5)"),g.addColorStop(1,"rgba(255,100,0,0)"),r.fillStyle=g,r.beginPath(),r.arc(p.x,p.y,60,0,Math.PI*2),r.fill()}r.fillStyle="rgba(255,255,255,0.85)",r.font="12px ui-sans-serif";const x={};for(const p of s)p.sector&&(x[p.sector]=(x[p.sector]||0)+1);for(const p of Object.keys(x)){const g=Number(p),S=uo(g),D=mo(o,l,c.trebleOuter+18,S);r.fillText(String(x[g]),D.x-6,D.y+4)}},[s,t,a]),e.jsx("canvas",{ref:i,style:{width:"100%",height:"auto",borderRadius:8,background:"#081018"}})}const ys=[...Array.from({length:20},(t,a)=>({label:`D${a+1}`,score:(a+1)*2})),{label:"DBULL",score:50,isBull:!0}];function wr(t,a){const s=ys[a];return!!s&&t===s.score}function Gs(t){const a=t.trim().toUpperCase();if(!a)return null;if(a==="50"||a==="BULL"||a==="DBULL"||a==="IBULL")return 50;if(a==="25"||a==="OBULL")return 25;const s=a.match(/^(S|D|T)?\s*(\d{1,2})$/);if(!s)return null;const i=s[1]||"S",n=parseInt(s[2],10);return n<1||n>20?null:n*(i==="S"?1:i==="D"?2:3)}const Ut=[...Array.from({length:20},(t,a)=>a+1),25,50],qn=[20,19,18,17,16,15,25];function on(){const t={};return qn.forEach(a=>{t[a]=0}),{marks:t,points:0}}function Ko(t,a,s,i,n=()=>!1){let r=null,o=0;if(s==="BULL"||s==="INNER_BULL"||a===25||a===50)r=25,o=s==="INNER_BULL"||a===50?2:1;else if(typeof i=="number"&&i>=15&&i<=20)r=i,s==="TRIPLE"?o=3:s==="DOUBLE"?o=2:o=1;else if(a){const p=[20,19,18,17,16,15];for(const g of p){if(a===g){r=g,o=1;break}if(a===g*2){r=g,o=2;break}if(a===g*3){r=g,o=3;break}}!r&&(a===25||a===50)&&(r=25,o=a===50?2:1)}if(!r)return 0;const l=t.marks[r];let d=Math.max(0,3-l);const c=Math.min(d,o),u=Math.max(0,o-c),h=l+c;t.marks[r]=h>3?3:h;let x=0;return u>0&&!n(r)&&(r===25?s==="INNER_BULL"?x+=50*u:x+=25*u:x+=r*u),t.points+=x,x}function em(t){return qn.every(a=>(t.marks[a]||0)>=3)}function Js(){return{round:1,score:0,finished:!1,shanghaiAchieved:!1,turnHits:{singles:0,doubles:0,triples:0}}}function tm(t){return t.round}function Yo(t,a,s,i){if(t.finished)return 0;const n=tm(t);let r=0;return typeof i=="number"&&i===n?s==="TRIPLE"?(r=n*3,t.turnHits.triples++):s==="DOUBLE"?(r=n*2,t.turnHits.doubles++):s==="SINGLE"&&(r=n*1,t.turnHits.singles++):!i&&(a===n||a===n*2||a===n*3)&&(a===n*3?(r=n*3,t.turnHits.triples++):a===n*2?(r=n*2,t.turnHits.doubles++):a===n&&(r=n,t.turnHits.singles++)),t.score+=r,r}function Xo(t){if(!t.finished){if(t.turnHits.singles>0&&t.turnHits.doubles>0&&t.turnHits.triples>0){t.shanghaiAchieved=!0,t.finished=!0;return}const a=t.round+1;a>20?t.finished=!0:t.round=a}t.turnHits={singles:0,doubles:0,triples:0}}function Ks(){return{stage:0,targets:[{kind:"NUMBER",num:20},{kind:"DOUBLE",num:16},{kind:"TRIPLE",num:14},{kind:"NUMBER",num:19},{kind:"BULL"},{kind:"ANY_NUMBER"}],score:0,finished:!1,hitThisRound:!1}}function da(t){return t.targets[t.stage]||null}function Qo(t,a,s,i){if(t.finished)return 0;const n=da(t);if(!n)return 0;let r=0;switch(n.kind){case"NUMBER":{typeof i=="number"&&i===n.num?s==="TRIPLE"?r=n.num*3:s==="DOUBLE"?r=n.num*2:s==="SINGLE"&&(r=n.num):!i&&(a===n.num||a===n.num*2||a===n.num*3)&&(r=a),r>0&&(t.hitThisRound=!0);break}case"DOUBLE":{(s==="DOUBLE"&&i===n.num||a===n.num*2)&&(r=n.num*2,t.hitThisRound=!0);break}case"TRIPLE":{(s==="TRIPLE"&&i===n.num||a===n.num*3)&&(r=n.num*3,t.hitThisRound=!0);break}case"BULL":{(s==="BULL"||s==="INNER_BULL"||a===25||a===50)&&(r=s==="INNER_BULL"||a===50?50:25,t.hitThisRound=!0);break}case"ANY_NUMBER":{a>0&&(r=a,t.hitThisRound=!0);break}}return t.score+=r,r}function Zo(t){t.finished||(t.hitThisRound||(t.score=Math.floor(t.score/2)),t.hitThisRound=!1,t.stage+=1,t.stage>=t.targets.length&&(t.finished=!0))}function Ys(){return{round:1,score:0,target:"HIGH",finished:!1}}function el(t,a,s,i){if(t.finished)return 0;let n=0;if(t.target==="HIGH")if(s==="INNER_BULL")n=50;else if(typeof i=="number"){const o=i*(s==="TRIPLE"?3:s==="DOUBLE"?2:1);i>=20&&(n=o)}else a>=40&&(n=a);else if(typeof i=="number"){const o=i*(s==="TRIPLE"?3:s==="DOUBLE"?2:1);i<=10&&(n=o)}else a>0&&a<=30&&(n=a);return t.score+=n,n}function tl(t){if(!t.finished){if(t.round+=1,t.round>10){t.finished=!0;return}t.target=t.target==="HIGH"?"LOW":"HIGH"}}function sl(t,a=3){return{number:t,lives:a,isKiller:!1,eliminated:!1}}function sm(t){const a=Array.from({length:20},(i,n)=>n+1),s={};for(const i of t){const n=Math.floor(Math.random()*a.length),r=a.splice(n,1)[0];s[i]=r}return s}function Sr(t,a,s,i){const n=a[t];if(!n||!i||!s)return{becameKiller:!1};if(!n.isKiller&&s==="DOUBLE"&&i===n.number)return n.isKiller=!0,{becameKiller:!0};if(n.isKiller&&(s==="DOUBLE"||s==="TRIPLE")){const r=Object.keys(a).find(o=>o!==t&&!a[o].eliminated&&a[o].number===i);if(r){const o=a[r],l=s==="TRIPLE"?2:1;return o.lives=Math.max(0,o.lives-l),o.lives===0&&(o.eliminated=!0),{becameKiller:!1,victimId:r,livesRemoved:l}}}return{becameKiller:!1}}function Cr(t){const a=Object.entries(t).filter(([,s])=>!s.eliminated&&s.lives>0);return a.length===1?a[0][0]:null}function Un(){return{inning:1,score:0,dartsThisInning:0,finished:!1}}function nl(t,a,s,i){if(t.finished)return 0;let n=0;if(typeof i=="number"&&i===t.inning?s==="TRIPLE"?n=3:s==="DOUBLE"?n=2:n=1:!i&&(a===t.inning||a===t.inning*2||a===t.inning*3)&&(n=a===t.inning*3?3:a===t.inning*2?2:1),t.score+=n,t.dartsThisInning+=1,t.dartsThisInning>=3){const r=t.inning+1;r>9?t.finished=!0:(t.inning=r,t.dartsThisInning=0)}return n}const al={1:5,2:20,3:1,4:18,5:4,6:13,7:6,8:10,9:15,10:2,11:17,12:3,13:19,14:7,15:16,16:8,17:11,18:14};function $n(){return{hole:1,strokes:0,dartsThisHole:0,finished:!1}}function rl(t,a,s,i){if(t.finished)return!1;const n=al[t.hole];if(t.dartsThisHole+=1,typeof i=="number"&&i===n&&(s==="SINGLE"||s==="DOUBLE"||s==="TRIPLE")||!i&&(a===n||a===n*2||a===n*3)){t.strokes+=t.dartsThisHole;const o=t.hole+1;return o>18?t.finished=!0:(t.hole=o,t.dartsThisHole=0),!0}if(t.dartsThisHole>=3){t.strokes+=3;const o=t.hole+1;o>18?t.finished=!0:(t.hole=o,t.dartsThisHole=0)}return!1}const Fn={0:{type:"NUM",num:20},1:{type:"NUM",num:19},2:{type:"NUM",num:18},3:{type:"NUM",num:17},4:{type:"BULL"},5:{type:"NUM",num:16},6:{type:"NUM",num:15},7:{type:"NUM",num:14},8:{type:"NUM",num:13}};function kr(){return{board:Array(9).fill(null),turn:"X",finished:!1,winner:null}}function nm(t){const a=[[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];for(const[s,i,n]of a)if(t[s]&&t[s]===t[i]&&t[s]===t[n])return t[s];return t.every(s=>s)?"Draw":null}function il(t,a,s,i,n){if(t.finished||t.board[a])return!1;const r=Fn[a];let o=!1;if(r.type==="BULL"?o=i==="BULL"||i==="INNER_BULL"||s===25||s===50:r.type==="NUM"&&typeof r.num=="number"&&(typeof n=="number"&&n===r.num||!n&&(s===r.num||s===r.num*2||s===r.num*3))&&(o=!0),!o)return!1;t.board[a]=t.turn;const l=nm(t.board);return l?(t.finished=!0,t.winner=l,!0):(t.turn=t.turn==="X"?"O":"X",!0)}const xa=[20,19,18,17,16,15,14,13,12,25];function _n(){const t={};return xa.forEach(a=>{t[a]=0}),{marks:t,points:0}}function ol(t,a,s,i,n=()=>!1){let r=null,o=0;if(s==="BULL"||s==="INNER_BULL"||a===25||a===50)r=25,o=s==="INNER_BULL"||a===50?2:1;else if(typeof i=="number"&&i>=12&&i<=20)r=i,s==="TRIPLE"?o=3:s==="DOUBLE"?o=2:o=1;else if(a){for(const p of[20,19,18,17,16,15,14,13,12]){if(a===p){r=p,o=1;break}if(a===p*2){r=p,o=2;break}if(a===p*3){r=p,o=3;break}}!r&&(a===25||a===50)&&(r=25,o=a===50?2:1)}if(!r)return 0;const l=t.marks[r],d=Math.max(0,3-l),c=Math.min(d,o),u=Math.max(0,o-c),h=l+c;t.marks[r]=h>3?3:h;let x=0;return u>0&&!n(r)&&(r===25?s==="INNER_BULL"?x+=50*u:x+=25*u:x+=r*u),t.points+=x,x}function am(t){return xa.every(a=>(t.marks[a]||0)>=3)}const ho=["X01","Double Practice"],rm=["Around the Clock","Cricket","Halve It","Shanghai","High-Low","Killer","Bob's 27","Count-Up","High Score","Low Score","Checkout 170","Checkout 121","Treble Practice"],im=["Easy","Medium","Hardened"];function Hn(t,a,s){return Math.max(a,Math.min(s,t))}function om(t,a){let s=0;if(a==="Easy"){const i=[22,26,41,45,60];s=i[Math.floor(Math.random()*i.length)]}else a==="Medium"?s=Math.round(Hn(60+(Math.random()*30-15),30,100)):s=Math.round(Hn(80+(Math.random()*20-10),50,120));return t<=0?0:s>t?[100,85,81,60,57,45,41,26,22,20,1].find(n=>n<=t)??0:s}function lm({onClose:t}){return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50",children:e.jsxs("div",{className:"card max-w-lg w-full relative",children:[e.jsx("button",{className:"absolute top-2 right-2 btn px-2 py-1",onClick:t,children:"Close"}),e.jsx("h3",{className:"text-xl font-bold mb-2",children:"X01 Rules & Regulations"}),e.jsxs("ul",{className:"list-disc pl-5 text-left mb-2",children:[e.jsx("li",{children:"Double In: Start scoring only after hitting a double."}),e.jsx("li",{children:"Double Out: Finish the game by hitting a double to reach exactly zero."}),e.jsx("li",{children:"Best Of: Play a set number of legs, winner is first to reach majority."}),e.jsx("li",{children:"First To: Play until a player reaches a set number of legs."}),e.jsx("li",{children:"No Cheating: All scores must be valid, no manual score changes mid-leg."}),e.jsx("li",{children:"Competitive Standard: Follow latest WDF/PDC rules for match play."})]}),e.jsx("p",{className:"text-sm text-slate-600",children:"For full details, see official darts governing body rules."})]})})}const cm="http://localhost:8787";function dm({user:t}){const{offlineLayout:a}=is(),[s,i]=m.useState("X01"),[n,r]=m.useState(501),[o,l]=m.useState("None"),[d,c]=m.useState(!1),[u,h]=m.useState(!1),[x,p]=m.useState(n),[g,S]=m.useState(n),[D,I]=m.useState(!1),[N,E]=m.useState(!1),[A,O]=m.useState(1),[M,v]=m.useState(0),[b,F]=m.useState(0),[z,T]=m.useState(null),[U,w]=m.useState(1),[_,ie]=m.useState(1),[R,Z]=m.useState([]),[ae,Me]=m.useState(2e3),st=wn(),[Se,Te]=m.useState(!1),[dt,ye]=m.useState(a==="modern"),[We,Ve]=m.useState(a==="modern");m.useEffect(()=>{ye(a==="modern"),Ve(a==="modern")},[a]);const[Ge,Re]=m.useState(1),[te,at]=m.useState(!0),[fe,Pe]=m.useState(0),[he,ce]=m.useState(0),[rt,De]=m.useState(0),[mt,tt]=m.useState(0),[ne,de]=m.useState(0),[ge,me]=m.useState(on()),[ze,ke]=m.useState(Js()),[lt,yt]=m.useState(Ks()),[k,ee]=m.useState(Ys()),[At,Ae]=m.useState(0),[Mt,Rt]=m.useState(1),[Pt,Oe]=m.useState(27),[_t,Et]=m.useState(0),[Lt,ht]=m.useState(0),[$t,jt]=m.useState(!1),[Tt,H]=m.useState(1),[Ne,Ye]=m.useState(0),[Ht,Ot]=m.useState(0),$=8,[J,ue]=m.useState(1),[le,Xe]=m.useState(0),[Le,je]=m.useState(0),$e=10,[Bt,it]=m.useState(1),[nt,Ps]=m.useState(0),[Es,dn]=m.useState(0),Ts=10,[Fs,Vt]=m.useState(170),[mn,os]=m.useState(0),[B,X]=m.useState(0),[K,q]=m.useState(0),[V,Ce]=m.useState(121),[pe,Fe]=m.useState(0),[be,ot]=m.useState(0),[Nt,vt]=m.useState(0),[It,wt]=m.useState(20),[Is,us]=m.useState(0),[ls,ft]=m.useState(0),[Ms,ve]=m.useState(Un()),[Yt,Xt]=m.useState($n()),[Gt,hs]=m.useState(kr()),[Jt,fs]=m.useState(_n()),[ct,Wt]=m.useState([{id:"p1",name:"Player 1"},{id:"p2",name:"Player 2"}]),[xs,Zt]=m.useState({}),[Ds,ts]=m.useState({}),[Ls,Dt]=m.useState(!1),[ss,ps]=m.useState(0),[un,cs]=m.useState(0),[Kt,js]=m.useState(null),[qe,xe]=m.useState(""),[Be,bt]=m.useState(0),[xt,gt]=m.useState(0),[pt,St]=m.useState(0),[ds,_s]=m.useState(n),[Je,Os]=m.useState(0),[en,Ns]=m.useState(0),[Hs,Ws]=m.useState(0);m.useRef(null);const[ws,hn]=m.useState(0),[tn,Sn]=m.useState(0),[ns,bs]=m.useState(0),[Bs,Ss]=m.useState(0),[Us,Cn]=m.useState(0),[fn,kn]=m.useState(0),[sn,En]=m.useState(0),[zs,Vn]=m.useState(0),[xn,Tn]=m.useState(0),[f,j]=m.useState(0),[C,P]=m.useState(0),[Q,re]=m.useState(0),[oe,W]=m.useState(0),[Qe,zt]=m.useState(0),[as,rs]=m.useState(0),[Ue,In]=m.useState(0),[Or,Mn]=m.useState(0),[Cs,Dn]=m.useState(0),[fl,Br]=m.useState(0),[xl,Ur]=m.useState(0),[pl,ba]=m.useState(!1),[es,Qt]=m.useState(""),[$r,ga]=m.useState(""),{favoriteDouble:Fr,callerEnabled:bl,callerVoice:gl,callerVolume:yl,speakCheckoutOnly:vl,rememberLastOffline:jl,setLastOffline:Nl,autoStartOffline:_r,cameraScale:pn,setCameraScale:Gn,cameraAspect:Hr="wide",setCameraAspect:wl,cameraEnabled:qt,textSize:An,boxSize:Jn,autoscoreProvider:Sl}=is(),Cl=Sl==="manual",Kn=(y=>{switch(y){case"small":return"px-1.5 py-0.5 text-xs";case"large":return"px-3 py-1 text-sm";default:return"px-2 py-0.5 text-sm"}})(An),bn=m.useRef(null),gn=m.useRef(null),ya=m.useRef(null),[yn,va]=m.useState("first"),[Yn,Wr]=m.useState(1),kl=m.useRef(null);m.useEffect(()=>{const y=Math.max(1,Math.floor(Number(Yn)||1)),L=yn==="first"?y:Math.max(1,Math.ceil(y/2));O(L)},[yn,Yn]),m.useEffect(()=>{if(!We){Re(1);return}const y=()=>{const Y=bn.current,se=gn.current;if(!Y||!se)return;const _e=ya.current?ya.current.getBoundingClientRect().height:0,Ke=Math.max(0,Y.clientHeight-_e-6),Ee=Math.max(0,Y.clientWidth-8),we=se.getBoundingClientRect(),Ie=Ge||1,et=we.height/Ie,Ft=we.width/Ie,gs=Ke>0?Ke/et:1,nn=Ee>0?Ee/Ft:1,ks=Math.min(1,Math.max(.5,Math.min(gs,nn)));Re(ks)};y();const L=window.ResizeObserver,G=L?new L(()=>y()):null;return G&&bn.current&&G.observe(bn.current),G&&gn.current&&G.observe(gn.current),window.addEventListener("resize",y),()=>{window.removeEventListener("resize",y);try{G&&bn.current&&G.unobserve(bn.current)}catch{}try{G&&gn.current&&G.unobserve(gn.current)}catch{}}},[We,Ge]),m.useEffect(()=>{const y=L=>{const G=L?.detail?.mode;G&&(i(G),vn())};return window.addEventListener("ndn:auto-start",y),()=>window.removeEventListener("ndn:auto-start",y)},[]),m.useEffect(()=>{const y=L=>{const G=L?.detail?.formatType,Y=L?.detail?.formatCount,se=L?.detail?.startScore;(G==="first"||G==="best")&&va(G),typeof Y=="number"&&isFinite(Y)&&Wr(Math.max(1,Math.floor(Y))),typeof se=="number"&&isFinite(se)&&r(Math.max(1,Math.floor(se)))};return window.addEventListener("ndn:offline-format",y),()=>window.removeEventListener("ndn:offline-format",y)},[]),m.useEffect(()=>{if(!_r)return;const y=setTimeout(()=>vn(),50);return()=>clearTimeout(y)},[_r]),m.useEffect(()=>{if(!Se||te||o==="None"||Hs<=0)return;let y,L=performance.now();const G=Y=>{const se=Y-L;L=Y,Ws(_e=>{const Ke=_e-se;if(Ke<=0){let Ee=0,we=g;for(;Ee<3&&we>0;){const Ie=om(we,o),et=Hn(Ie-Ee*20,0,Math.min(60,we)),Ft=we-et;if(Sn(et),hn(ks=>ks+1),j(ks=>ks+1),Ft<0){we=g,bs(0),Ss(0);break}bs(ks=>ks+et),re(ks=>ks+et);const gs=we,nn=Ft;if(gs>50&&nn<=50?Ss(1):gs<=50&&Ss(ks=>ks+1),we=Ft,Ee+=1,we===0)break}if(S(we),we===0){ns===180?In(et=>et+1):ns>=140?Mn(et=>et+1):ns>=100&&Dn(et=>et+1);const Ie=g;Ie<=170&&Ur(et=>Math.max(et,Ie)),g<=50&&(En(et=>et+(Bs>0?Bs:1)),Vn(et=>et+1)),bs(0),Ss(0),T("ai"),E(!0)}return we>0&&Ee>=3&&(ns===180?In(Ie=>Ie+1):ns>=140?Mn(Ie=>Ie+1):ns>=100&&Dn(Ie=>Ie+1),bs(0),Ss(0)),at(!0),0}return Ke}),Hs>0&&(y=requestAnimationFrame(G))};return y=requestAnimationFrame(G),()=>cancelAnimationFrame(y)},[Se,te,o,Hs,g]);function vn(){h(!0),p(n),S(n),I(!1),Te(!0),at(!0),Pe(0),bt(0),gt(0),St(0),_s(n),Os(0),Ns(0),Ws(0),hn(0),Sn(0),bs(0),T(null),v(0),F(0),Z([]),Tn(0),j(0),P(0),re(0),W(0),zt(0),rs(0),In(0),Mn(0),Dn(0),Br(0),Ur(0),Cn(0),kn(0),En(0),Vn(0);const y=Math.max(1,Math.floor(Number(Yn)||1));if(O(yn==="first"?y:Math.max(1,Math.ceil(y/2))),jl)try{Nl({mode:s,x01Start:n,firstTo:A,aiLevel:o})}catch{}}function El(){p(n),S(n),I(!1),Te(!0),at(!0),Pe(0),bt(0),gt(0),St(0),_s(n),Os(0),Ns(0),Ws(0),hn(0),Sn(0),bs(0),T(null)}function zr(y){St(0),_s(y===0?n:x),Ns(0),o!=="None"?(at(!1),Ws(ae)):at(!1)}function Xn(y){const L=x-y,G=pt+1;if(gt(y),bt(Ee=>Ee+1),Tn(Ee=>Ee+1),L<0){p(ds),zr(ds),Pe(0),Os(0),Ns(0);return}p(L),bl&&ia(t?.username||"Player",y,Math.max(L,0),gl,{volume:yl,checkoutOnly:vl}),St(G),Os(Ee=>Ee+y),P(Ee=>Ee+y),Pe(0);const Y=x,se=L,_e=Y>50&&se<=50,Ke=Y<=50;if(_e?Ns(1):Ke&&Ns(Ee=>Ee+1),L===0){Je+y===180?W(we=>we+1):Je+y>=140?zt(we=>we+1):Je+y>=100&&rs(we=>we+1);const Ee=ds;Ee<=170&&Br(we=>Math.max(we,Ee)),Y<=50&&(Cn(we=>we+(en>0?en:1)),kn(we=>we+1)),T("player"),E(!0);return}G>=3&&(Je+y===180?W(Ee=>Ee+1):Je+y>=140?zt(Ee=>Ee+1):Je+y>=100&&rs(Ee=>Ee+1),zr(L),Os(0),Ns(0))}function qr(){const y=Hn(Math.round(Number(fe)||0),0,60);Xn(y)}function Vr(y){const L=Hn(Math.round(y||0),0,60);if(gt(L),bt(G=>G+1),Tn(G=>G+1),wr(L,he)){const G=rt+1;De(G),ce(Y=>Math.min(20,Y+1)),G>=21&&(T("player"),E(!0))}Pe(0)}function Gr(){Vr(Number(fe))}function Jr(){const y=Gs(es);if(y==null){alert("Enter like D16, 50, 25, T20");return}Vr(y),Qt("")}function Kr(y,L,G){if($t)return;const Y=Mt,se=L==="DOUBLE"&&G===Y||!L&&y===Y*2;se&&ht(_e=>_e+1),Et(_e=>{const Ke=_e+1;if(Ke>=3){const Ee=Lt+(se?1:0);Ee>0?Oe(Ie=>Ie+Ee*Y*2):Oe(Ie=>Ie-Y*2);const we=Y+1;return Rt(we),ht(0),we>20&&jt(!0),0}return Ke})}function Yr(){Kr(Math.max(0,fe|0)),Pe(0)}function Xr(){Rt(1),Oe(27),Et(0),ht(0),jt(!1)}function ja(y){Ye(L=>L+Math.max(0,y|0)),Ot(L=>{const G=L+1;return G>=3?(H(Y=>Y+1),0):G})}function Na(y){Xe(L=>L+Math.max(0,y|0)),je(L=>{const G=L+1;return G>=3?(ue(Y=>Y+1),0):G})}function wa(y){Ps(L=>L+Math.max(0,y|0)),dn(L=>{const G=L+1;return G>=3?(it(Y=>Y+1),0):G})}function Qr(y,L,G,Y,se,_e,Ke,Ee){const we=y-Ke;if(!(we<0))if(we===0){if(Ee==="DOUBLE"||Ee==="INNER_BULL"){_e(Ie=>Ie+1),se(Ie=>Ie+1),Y(()=>0),L(y);return}}else L(we);Y(Ie=>{const et=Ie+1;return et>=3?(se(Ft=>Ft+1),0):et})}function Zr(y,L){Qr(Fs,Vt,mn,os,X,q,y,L),mn+1>=3&&Vt(170)}function ei(y,L){Qr(V,Ce,pe,Fe,ot,vt,y,L),pe+1>=3&&Ce(121)}function Qn(y){const L=Gs(es);if(L==null){alert("Enter like T20, D16, 25, 50");return}const G=es.trim().toUpperCase(),Y=G.startsWith("D")||G==="50"||G==="BULL"||G==="DBULL"||G==="IBULL"||G.includes("INNER");y?Zr(L,Y?"DOUBLE":void 0):ei(L,Y?"DOUBLE":void 0),Qt("")}function Tl(){Vt(170),os(0),X(0),q(0)}function Il(){Ce(121),Fe(0),ot(0),vt(0)}function Sa(y,L,G){L==="TRIPLE"&&G===It?us(Y=>Y+1):!L&&y===It*3&&us(Y=>Y+1),ft(Y=>Y+1)}function Ml(){us(0),ft(0)}function Dl(y,L,G){ve(Y=>{const se={...Y};return nl(se,y,L,G),se})}function Al(){ve(Un())}function Rl(y,L,G){Xt(Y=>{const se={...Y};return rl(se,y,L,G),se})}function Pl(){Xt($n())}function Ll(y,L,G,Y){hs(se=>{const _e={...se,board:[...se.board]};return il(_e,y,L,G,Y),_e})}function Ol(){hs(kr())}function Bl(y,L,G){fs(Y=>{const se={...Y,marks:{...Y.marks}};return ol(se,y,L,G,()=>!1),se})}function ti(){fs(_n())}function Ca(y,L,G){const Y=Ut[mt];let se=!1;if(typeof G=="number"&&G===Y&&(L==="SINGLE"||L==="DOUBLE"||L==="TRIPLE")&&(se=!0),Y===25&&(L==="BULL"||y===25)&&(se=!0),Y===50&&(L==="INNER_BULL"||y===50)&&(se=!0),se||(y===Y||y===Y*2||y===Y*3)&&(se=!0),se){const _e=ne+1;de(_e),tt(Ke=>Ke+1)}}function si(){Ca(Math.max(0,fe|0)),Pe(0)}function ni(){const y=Gs(es);if(y==null){alert("Enter like T20, D5, 25, 50");return}Ca(y),Qt("")}function ai(y,L,G){me(Y=>{const se={...Y,marks:{...Y.marks}};return Ko(se,y,L,G,()=>!1),se}),Ae(Y=>{const se=Y+1;return se>=3?0:se})}function ri(){ai(Math.max(0,fe|0)),Pe(0)}function ii(y,L,G){ke(Y=>{const se={...Y,turnHits:{...Y.turnHits}};return Yo(se,y,L,G),se}),Ae(Y=>{const se=Y+1;return se>=3?(ke(_e=>{const Ke={..._e,turnHits:{..._e.turnHits}};return Xo(Ke),Ke}),0):se})}function oi(){ii(Math.max(0,fe|0)),Pe(0)}function li(y,L,G){yt(Y=>{const se={...Y,targets:[...Y.targets]};return Qo(se,y,L,G),se}),Ae(Y=>{const se=Y+1;return se>=3?(yt(_e=>{const Ke={..._e,targets:[..._e.targets]};return Zo(Ke),Ke}),0):se})}function ci(){li(Math.max(0,fe|0)),Pe(0)}function di(y,L,G){ee(Y=>{const se={...Y};return el(se,y,L,G),se}),Ae(Y=>{const se=Y+1;return se>=3?(ee(_e=>{const Ke={..._e};return tl(Ke),Ke}),0):se})}function mi(){di(Math.max(0,fe|0)),Pe(0)}function ui(){const y=es.trim().toUpperCase();if(!y)return null;if(y==="50"||y==="BULL"||y==="DBULL"||y==="IBULL")return 50;if(y==="25"||y==="OBULL")return 25;const L=y.match(/^(S|D|T)?\s*(\d{1,2})$/);if(!L)return null;const G=L[1]||"S",Y=parseInt(L[2],10);return Y<1||Y>20?null:Y*(G==="S"?1:G==="D"?2:3)}function ka(){const y=ui();if(y==null){alert("Enter like T20, D16, 5, 25, 50");return}Xn(y),Qt("")}function Ul(){const y=$r.trim().split(`
`).map(L=>L.trim()).filter(L=>L);if(y.length!==0){for(const L of y){const G=Gs(L);if(G==null){alert(`Invalid score: ${L}`);return}Xn(G)}ga("")}}function $l(){pt!==0&&(p(y=>y+xt),St(y=>Math.max(0,y-1)))}function hi(){const y=ui();if(y==null){alert("Enter like T20, D16, 5, 25, 50");return}if(pt===0){ka();return}const L=xt;p(G=>G+L),St(G=>Math.max(0,G-1)),setTimeout(()=>Xn(y),0),Qt("")}function Fl(){const y=z??"player",L=y==="player"?en||void 0:Bs||void 0;Z([...R,{winner:y,doubleDarts:U,checkoutDarts:_,doublesAtt:L,doublesHit:1}]),E(!1);let Y=M,se=b;if(z==="player"?Y+=1:z==="ai"&&(se+=1),v(Y),F(se),T(null),Y>=A||se>=A){try{Ac(s,y==="player")}catch{}Te(!1),h(!1),p(n),S(n),ba(!0);return}El()}const Ea=!ho.includes(s)&&!(t?.fullAccess||t?.admin);return e.jsxs("div",{className:"card relative overflow-hidden",children:[e.jsxs("h2",{className:"text-2xl font-bold text-brand-700 mb-4",children:["Offline Game Modes ",a==="classic"?e.jsx("span",{className:"ml-2 text-xs px-2 py-0.5 rounded-full bg-white/10 border border-white/10 align-middle",children:"Classic layout"}):e.jsx("span",{className:"ml-2 text-xs px-2 py-0.5 rounded-full bg-emerald-500/20 border border-emerald-400/30 text-emerald-200 align-middle",children:"Modern layout"})]}),e.jsxs("div",{className:"mb-4 flex flex-col gap-3",children:[e.jsx("label",{className:"font-semibold",children:"Select game mode:"}),e.jsxs("select",{className:"input w-full",value:s,onChange:y=>i(y.target.value),children:[ho.map(y=>e.jsx("option",{value:y,children:y},y)),rm.map(y=>e.jsxs("option",{value:y,disabled:!(t?.fullAccess||t?.admin),children:[y," ",t?.fullAccess||t?.admin?"":"(Premium)"]},y))]}),!t?.fullAccess&&e.jsxs("div",{className:"mt-2 p-2 rounded-lg bg-slate-800/40 border border-slate-700/40 text-slate-200 text-sm flex items-center gap-2",children:[e.jsx("span",{children:"🔒"}),e.jsx("span",{children:"Only X01 and Double Practice are free. Advanced modes (Killer, Cricket, Shanghai, etc.) require PREMIUM."})]}),s==="X01"&&e.jsxs(e.Fragment,{children:[e.jsx("label",{className:"font-semibold mt-2",children:"Enter starting score (1-1001):"}),e.jsx("input",{className:"input w-full",type:"number",min:1,max:1001,value:n,onChange:y=>r(Number(y.target.value))}),e.jsx("label",{className:"font-semibold mt-2",children:"Play against AI bot?"}),e.jsxs("select",{className:"input w-full",value:o,onChange:y=>l(y.target.value),children:[e.jsx("option",{value:"None",children:"None"}),im.map(y=>e.jsx("option",{value:y,children:y},y))]}),o!=="None"&&e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-2 items-end mt-2",children:[e.jsxs("div",{className:"sm:col-span-2",children:[e.jsx("label",{className:"font-semibold",children:"AI throw delay (seconds)"}),e.jsx("input",{className:"input w-full",type:"number",min:.5,max:10,step:.5,value:ae/1e3,onChange:y=>Me(Math.round(Number(y.target.value)*1e3))})]}),e.jsx("div",{className:"text-sm text-slate-300",children:"Controls how long the AI waits before its visit."})]}),e.jsx("button",{className:"btn mt-2",onClick:()=>c(!0),children:"X01 Rules & Regulations!"})]}),s==="Double Practice"&&e.jsx("div",{className:"mt-2 text-brand-600",children:"Hit doubles D1 → D20 → DBULL in as few darts as possible. AI and X01 settings don’t apply."})]}),!u&&e.jsx("button",{className:"btn",disabled:Ea,title:Ea?"PREMIUM required for this mode":"",onClick:vn,children:"Start Match"}),Se&&e.jsx("div",{className:`absolute inset-0 z-[1000] ${dt?"":"flex items-center justify-center p-3 sm:p-4"}`,children:e.jsx(Qs,{storageKey:"ndn:modal:offline-match",className:`${dt?"w-full h-full ndn-modal-tight":""} relative flex flex-col overflow-hidden`,fullScreen:dt,defaultWidth:1100,defaultHeight:720,minWidth:720,minHeight:480,maxWidth:1600,maxHeight:1200,initialFitHeight:!0,children:e.jsxs("div",{className:"flex-1 min-h-0 overflow-x-hidden pr-1 pt-2 pb-2",style:{overflowY:We?"hidden":"auto"},ref:y=>{bn.current=y},children:[e.jsxs("div",{ref:y=>{ya.current=y},className:"sticky top-0 relative overflow-hidden flex items-center justify-between gap-2 mb-2 px-2 sm:px-3 py-2 rounded-xl bg-white/10 border border-white/10 z-10 backdrop-blur-sm",children:[e.jsx("div",{className:"pointer-events-none absolute inset-0 bg-gradient-to-b from-slate-900/30 via-slate-900/10 to-transparent"}),e.jsxs("div",{className:"flex items-center gap-2 text-xs sm:text-sm leading-none flex-wrap",children:[e.jsx("span",{className:"hidden xs:inline px-2 py-0.5 rounded-full bg-indigo-500/20 text-indigo-200 border border-indigo-400/30 text-[10px] sm:text-xs",children:"Game Mode"}),e.jsxs("span",{className:"font-medium whitespace-nowrap",children:[s,s==="X01"?` / ${n}`:""]}),e.jsxs("span",{className:"opacity-80 whitespace-nowrap",children:["First to ",A," · Legs ",M,"-",b]}),e.jsx("span",{className:`ml-2 px-2 py-0.5 rounded-full border text-[10px] sm:text-xs ${a==="modern"?"bg-emerald-500/15 text-emerald-200 border-emerald-400/30":"bg-white/10 text-white/70 border-white/20"}`,children:a==="modern"?"Modern layout":"Classic layout"})]}),e.jsxs("div",{className:"flex items-center gap-1 flex-wrap justify-end",children:[e.jsxs("div",{className:"hidden items-center gap-2 mr-2 text-xs",children:[e.jsx("span",{className:"opacity-80",children:"Cam"}),e.jsx("button",{className:"btn btn--ghost px-2 py-1",onClick:()=>Gn(Math.max(.5,Math.round((pn-.05)*100)/100)),title:"Decrease camera size",children:"−"}),e.jsxs("span",{className:"w-9 text-center",children:[Math.round(pn*100),"%"]}),e.jsx("button",{className:"btn btn--ghost px-2 py-1",onClick:()=>Gn(Math.min(1.25,Math.round((pn+.05)*100)/100)),title:"Increase camera size",children:"+"})]}),e.jsx("button",{className:"btn btn--ghost px-3 py-1 text-sm",title:We?"Actual Size":"Fit All",onClick:()=>Ve(y=>!y),children:We?"Actual Size":"Fit All"}),e.jsx("button",{className:"btn btn--ghost px-3 py-1 text-sm",title:dt?"Restore":"Maximize",onClick:()=>ye(y=>!y),children:dt?"Restore":"Maximize"}),e.jsx("button",{className:"btn bg-slate-700 hover:bg-slate-800 px-3 py-1 text-sm",onClick:()=>{vn()},children:"Restart"}),e.jsx("button",{className:"btn bg-rose-600 hover:bg-rose-700 px-3 py-1 text-sm",onClick:()=>{Te(!1),h(!1)},children:"Quit"})]})]}),e.jsxs("div",{ref:y=>{gn.current=y},className:"will-change-transform",style:We?{transform:`scale(${Ge})`,transformOrigin:"top left",width:"100%",fontSize:`${Math.max(.8,Math.min(1,Ge))}em`}:void 0,children:[e.jsx("h3",{className:"text-xl font-bold mb-2 mt-1 leading-tight",children:s==="X01"?"X01 Match":s}),e.jsxs("div",{className:"flex items-center gap-2 mb-2 text-xs flex-wrap",children:[e.jsxs("span",{className:"px-2 py-0.5 rounded-full bg-white/10 border border-white/10",children:["Mode: ",s]}),e.jsxs("span",{className:"px-2 py-0.5 rounded-full bg-white/10 border border-white/10",children:["Start: ",n]}),e.jsxs("div",{ref:kl,className:"inline-flex items-center gap-2 px-2 py-0.5 rounded-full bg-white/10 border border-white/10",children:[e.jsx("span",{children:"Format:"}),(()=>{const y=x!==n||g!==n||pt>0,L=`px-2 py-0.5 rounded border text-xs ${y?"opacity-50 cursor-not-allowed":"cursor-pointer"} `;return e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{type:"button",className:`${L} ${yn==="first"?"bg-indigo-500/20 text-indigo-100 border-indigo-400/30":"bg-white/10 text-white/80 border-white/20"}`,onClick:()=>{y||va("first")},title:"First to N",children:"First to"}),e.jsx("button",{type:"button",className:`${L} ${yn==="best"?"bg-indigo-500/20 text-indigo-100 border-indigo-400/30":"bg-white/10 text-white/80 border-white/20"}`,onClick:()=>{y||va("best")},title:"Best of N (wins = ceil(N/2)",children:"Best of"})]}),e.jsx("input",{className:`input w-16 text-center ${y?"opacity-50":""}`,type:"number",min:1,step:1,value:Yn,onChange:G=>Wr(Math.max(1,Math.floor(Number(G.target.value)||1))),disabled:y,title:yn==="first"?"First to N":"Best of N (wins = ceil(N/2))"})]})})()]}),e.jsxs("span",{className:"px-2 py-0.5 rounded-full bg-white/10 border border-white/10",children:["Legs: ",M,"–",b]})]}),s!=="X01"?e.jsxs("div",{className:"p-3 rounded-2xl glass text-white border border-white/10 min-w-0 flex flex-col h-full mb-2",children:[s==="Double Practice"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"text-xs text-slate-600 flex items-center justify-between",children:[e.jsx("span",{className:"opacity-80",children:"Current Target"}),e.jsx("span",{className:"px-2 py-0.5 rounded-full bg-emerald-500/20 text-emerald-200 text-xs font-bold",children:ys[he]?.label||"—"})]}),e.jsxs("div",{className:"text-3xl font-extrabold tracking-tight",children:[rt," / 21"]})]}),s==="Around the Clock"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"text-xs text-slate-600 flex items-center justify-between",children:[e.jsx("span",{className:"opacity-80",children:"Current Target"}),e.jsx("span",{className:"px-2 py-0.5 rounded-full bg-emerald-500/20 text-emerald-200 text-xs font-bold",children:Ut[mt]===25?"25 (Outer Bull)":Ut[mt]===50?"50 (Inner Bull)":Ut[mt]||"—"})]}),e.jsxs("div",{className:"text-3xl font-extrabold tracking-tight",children:[ne," / ",Ut.length]})]}),s==="Cricket"&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"text-xs text-slate-600 mb-1",children:"Cricket — Close 20–15 and Bull; overflow scores points"}),e.jsx("div",{className:"grid grid-cols-7 gap-1 text-center text-[11px] mb-2",children:qn.map(y=>e.jsxs("div",{className:"p-1 rounded bg-slate-800/50 border border-slate-700/50",children:[e.jsx("div",{className:"opacity-70",children:y===25?"Bull":y}),e.jsxs("div",{className:"font-semibold",children:[Math.min(3,ge.marks?.[y]||0)," / 3"]})]},y))}),e.jsxs("div",{className:"text-sm",children:["Points: ",e.jsx("span",{className:"font-semibold",children:ge.points})]}),em(ge)&&e.jsxs("div",{className:"mt-2 text-xs px-2 py-1 rounded bg-emerald-500/20 text-emerald-200 border border-emerald-400/30 inline-block",children:["Completed! ",e.jsx("button",{className:"ml-2 underline",onClick:()=>{me(on()),Ae(0)},children:"Reset"})]})]}),s==="Shanghai"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"text-xs text-slate-600 flex items-center justify-between",children:[e.jsx("span",{children:"Round"}),e.jsx("span",{className:"px-2 py-0.5 rounded-full bg-emerald-500/20 text-emerald-200 border border-emerald-400/30 text-xs font-semibold",children:ze.round})]}),e.jsxs("div",{className:"text-3xl font-extrabold tracking-tight",children:["Score: ",ze.score]}),ze.finished&&e.jsxs("div",{className:"mt-2 text-xs px-2 py-1 rounded bg-emerald-500/20 text-emerald-200 border border-emerald-400/30 inline-block",children:["Completed! ",e.jsx("button",{className:"ml-2 underline",onClick:()=>{ke(Js()),Ae(0)},children:"Reset"})]})]}),s==="Halve It"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"text-xs text-slate-600 flex items-center justify-between",children:[e.jsx("span",{children:"Stage"}),e.jsxs("span",{className:"px-2 py-0.5 rounded-full bg-emerald-500/20 text-emerald-200 border border-emerald-400/30 text-xs font-semibold",children:[lt.stage+1,"/",lt.targets.length]})]}),e.jsxs("div",{className:"text-sm",children:["Target: ",e.jsx("span",{className:"font-semibold",children:(()=>{const y=da(lt);return y?y.kind==="ANY_NUMBER"?"Any":y.kind==="BULL"?"Bull":y.kind==="DOUBLE"||y.kind==="TRIPLE"||y.kind==="NUMBER"?`${y.kind} ${y.num}`:"—":"—"})()})]}),e.jsxs("div",{className:"text-3xl font-extrabold tracking-tight",children:["Score: ",lt.score]}),lt.finished&&e.jsxs("div",{className:"mt-2 text-xs px-2 py-1 rounded bg-emerald-500/20 text-emerald-200 border border-emerald-400/30 inline-block",children:["Completed! ",e.jsx("button",{className:"ml-2 underline",onClick:()=>{yt(Ks()),Ae(0)},children:"Reset"})]})]}),s==="High-Low"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"text-xs text-slate-600",children:["Round ",k.round," · Target ",k.target]}),e.jsxs("div",{className:"text-3xl font-extrabold tracking-tight",children:["Score: ",k.score]}),k.finished&&e.jsxs("div",{className:"mt-2 text-xs px-2 py-1 rounded bg-emerald-500/20 text-emerald-200 border border-emerald-400/30 inline-block",children:["Completed! ",e.jsx("button",{className:"ml-2 underline",onClick:()=>{ee(Ys()),Ae(0)},children:"Reset"})]})]}),s==="Bob's 27"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"text-xs text-slate-600 flex items-center justify-between",children:[e.jsx("span",{children:"Target"}),e.jsxs("span",{className:"px-2 py-0.5 rounded-full bg-emerald-500/20 text-emerald-200 text-xs font-semibold",children:["D",Mt]})]}),e.jsxs("div",{className:"text-3xl font-extrabold tracking-tight",children:["Score: ",Pt]}),$t&&e.jsxs("div",{className:"mt-2 text-xs px-2 py-1 rounded bg-emerald-500/20 text-emerald-200 border border-emerald-400/30 inline-block",children:["Completed! ",e.jsx("button",{className:"ml-2 underline",onClick:Xr,children:"Reset"})]})]}),s==="Count-Up"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"text-xs text-slate-600",children:["Round ",Tt,"/8"]}),e.jsxs("div",{className:"text-3xl font-extrabold tracking-tight",children:["Score: ",Ne]})]}),s==="High Score"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"text-xs text-slate-600",children:["Round ",J,"/10"]}),e.jsxs("div",{className:"text-3xl font-extrabold tracking-tight",children:["Score: ",le]})]}),s==="Low Score"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"text-xs text-slate-600",children:["Round ",Bt,"/10"]}),e.jsxs("div",{className:"text-3xl font-extrabold tracking-tight",children:["Score: ",nt]})]}),s==="Checkout 170"&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"text-xs text-slate-600",children:"Remaining"}),e.jsx("div",{className:"text-3xl font-extrabold tracking-tight",children:Fs}),e.jsxs("div",{className:"text-xs text-slate-400 mt-1",children:["Attempts: ",B," · Successes: ",K]})]}),s==="Checkout 121"&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"text-xs text-slate-600",children:"Remaining"}),e.jsx("div",{className:"text-3xl font-extrabold tracking-tight",children:V}),e.jsxs("div",{className:"text-xs text-slate-400 mt-1",children:["Attempts: ",be," · Successes: ",Nt]})]}),s==="Treble Practice"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"text-xs text-slate-600",children:["Treble Target: T",It]}),e.jsxs("div",{className:"text-3xl font-extrabold tracking-tight",children:["Hits: ",Is]})]}),s==="Baseball"&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"text-xs text-slate-600",children:"Inning"}),e.jsx("div",{className:"text-3xl font-extrabold tracking-tight",children:Ms.inning}),e.jsxs("div",{className:"text-sm",children:["Score: ",e.jsx("span",{className:"font-semibold",children:Ms.score})]})]}),s==="Golf"&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"text-xs text-slate-600",children:"Hole"}),e.jsx("div",{className:"text-3xl font-extrabold tracking-tight",children:Yt.hole}),e.jsxs("div",{className:"text-sm",children:["Strokes: ",e.jsx("span",{className:"font-semibold",children:Yt.strokes})]})]}),s==="Tic Tac Toe"&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"text-xs text-slate-600",children:"Turn"}),e.jsx("div",{className:"text-3xl font-extrabold tracking-tight",children:Gt.turn}),Gt.finished&&e.jsxs("div",{className:"mt-1 text-xs",children:["Winner: ",Gt.winner||"—"]})]}),s==="American Cricket"&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"text-xs text-slate-600 mb-1",children:"Close 20–12 and Bull; overflow scores points"}),e.jsx("div",{className:"grid grid-cols-10 gap-1 text-center text-[11px] mb-2",children:xa.map(y=>e.jsxs("div",{className:"p-1 rounded bg-slate-800/50 border border-slate-700/50",children:[e.jsx("div",{className:"opacity-70",children:y===25?"Bull":y}),e.jsxs("div",{className:"font-semibold",children:[Math.min(3,Jt.marks?.[y]||0)," / 3"]})]},y))}),e.jsxs("div",{className:"text-sm",children:["Points: ",e.jsx("span",{className:"font-semibold",children:Jt.points})]}),am(Jt)&&e.jsxs("div",{className:"mt-2 text-xs px-2 py-1 rounded bg-emerald-500/20 text-emerald-200 border border-emerald-400/30 inline-block",children:["Completed! ",e.jsx("button",{className:"ml-2 underline",onClick:ti,children:"Reset"})]})]}),s==="Killer"&&e.jsx(e.Fragment,{children:Ls?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"text-xs text-slate-600 flex items-center justify-between",children:[e.jsx("span",{children:"Turn"}),e.jsx("span",{className:"px-2 py-0.5 rounded-full bg-emerald-500/20 text-emerald-200 text-xs font-bold",children:ct[ss]?.name||"—"})]}),e.jsx("div",{className:"text-3xl font-extrabold tracking-tight",children:Kt?`${ct.find(y=>y.id===Kt)?.name||"Winner"} Wins`:qe||"Ready"})]}):e.jsx("div",{className:"text-xs text-slate-600",children:"Setup players and assign numbers"})})]}):a==="modern"?e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2 mb-2 items-stretch",children:[e.jsxs("div",{className:"flex flex-col gap-2 min-w-0",children:[e.jsxs("div",{className:"p-3 rounded-2xl glass text-white border border-white/10 min-w-0 flex flex-col",children:[e.jsxs("div",{className:"text-xs text-slate-600 flex items-center justify-between",children:[e.jsx("span",{className:"opacity-80",children:"You Remain"}),te?e.jsx("span",{className:"px-2 py-0.5 rounded-full bg-emerald-500/20 text-emerald-200 text-xs font-bold",children:"THROWING"}):e.jsx("span",{className:"px-2 py-0.5 rounded-full bg-slate-500/20 text-slate-200 text-xs font-bold",children:"WAITING TO THROW"})]}),e.jsx("div",{className:"text-3xl font-extrabold tracking-tight",children:x}),e.jsx("div",{className:"h-1.5 w-full bg-white/10 rounded-full mt-2 overflow-hidden",children:e.jsx("div",{className:"h-full bg-emerald-400/70",style:{width:`${Math.max(0,Math.min(100,(1-x/n)*100))}%`}})}),e.jsxs("div",{className:"text-sm mt-1 opacity-90",children:["Last dart: ",e.jsx("span",{className:"font-semibold",children:xt})]}),e.jsxs("div",{className:"text-sm opacity-90",children:["3-Dart Avg: ",e.jsx("span",{className:"font-semibold",children:Be>0?((n-x)/Be*3).toFixed(1):"0.0"})]}),e.jsxs("div",{className:"text-xs opacity-70 flex items-center gap-2",children:[e.jsxs("span",{children:["Darts thrown: ",Be]}),e.jsx("span",{className:"inline-flex items-center gap-1","aria-label":"Visit darts",children:[0,1,2].map(y=>e.jsx("span",{className:`w-2 h-2 rounded-full ${y<pt?"bg-emerald-400":"bg-white/20"}`},y))})]}),e.jsxs("div",{className:"text-xs opacity-80 mt-1",children:["Doubles: ",e.jsxs("span",{className:"font-semibold",children:["Att ",Us," · Hit ",fn]})]}),x<=170&&x>0&&(()=>{const L=la(x,Fr)[0]||"—";return e.jsxs("div",{className:"mt-2 inline-flex items-center gap-2 px-3 py-1 rounded-full bg-white/10 border border-white/10 text-white text-sm",children:[e.jsx("span",{className:"opacity-70",children:"Checkout"}),e.jsx("span",{className:"font-semibold",children:L})]})})()]}),e.jsxs("div",{className:`${Jn==="small"?"p-2":Jn==="large"?"p-4":"p-3"} rounded-2xl bg-slate-900/40 border border-white/10 text-white ${An==="small"?"text-xs":An==="large"?"text-base":"text-sm"}`,children:[e.jsx("div",{className:"font-semibold mb-2",children:"Match Summary"}),(()=>{const y=te?t?.username||"You":o==="None"?"—":`${o} AI`,L=te?x:o==="None"?0:g,G=te?xt:tn,Y=te?Je:ns,se=te?Be:ws,_e=n-(te?x:o==="None"?n:g),Ke=se>0?_e/se*3:0,Ee=`${M}-${b}`,we=R.length>0?`${Math.min(...R.map(Ie=>Ie.doubleDarts+(Ie.checkoutDarts||0)))||0} darts`:"—";return e.jsxs("div",{className:"grid grid-cols-2 gap-y-1",children:[e.jsx("div",{className:"opacity-80",children:"Current score"}),e.jsx("div",{className:"font-mono text-right",children:Ee}),e.jsx("div",{className:"opacity-80",children:"Current thrower"}),e.jsx("div",{className:"text-right font-semibold text-lg",children:y}),e.jsx("div",{className:"opacity-80",children:"Score remaining"}),e.jsx("div",{className:"text-right font-mono font-bold text-xl",children:L}),e.jsx("div",{className:"opacity-80",children:"3-dart avg"}),e.jsx("div",{className:"text-right font-mono",children:Ke.toFixed(1)}),e.jsx("div",{className:"opacity-80",children:"Last score"}),e.jsx("div",{className:"text-right font-mono",children:Y||G}),e.jsx("div",{className:"opacity-80",children:"Best leg"}),e.jsx("div",{className:"text-right",children:we})]})})()]}),e.jsxs("div",{className:"p-3 rounded-2xl glass text-white border border-white/10 min-w-0 flex flex-col",children:[e.jsxs("div",{className:"text-xs flex items-center justify-between opacity-80",children:[e.jsxs("span",{children:[o==="None"?"Opponent":`${o} AI`," Remain"]}),te?e.jsx("span",{className:"px-2 py-0.5 rounded-full bg-slate-500/20 text-slate-200 text-xs font-bold",children:"WAITING TO THROW"}):e.jsx("span",{className:"px-2 py-0.5 rounded-full bg-emerald-500/20 text-emerald-200 text-xs font-bold",children:"THROWING"})]}),e.jsx("div",{className:"text-3xl font-extrabold tracking-tight",children:o!=="None"?g:"N/A"}),o!=="None"&&e.jsx("div",{className:"h-1.5 w-full bg-white/10 rounded-full mt-2 overflow-hidden",children:e.jsx("div",{className:"h-full bg-fuchsia-400/70",style:{width:`${Math.max(0,Math.min(100,(1-g/n)*100))}%`}})}),e.jsxs("div",{className:"text-sm mt-1 opacity-90",children:["Last dart: ",e.jsx("span",{className:"font-semibold",children:o==="None"?0:tn})]}),e.jsxs("div",{className:"text-sm opacity-90",children:["3-Dart Avg: ",e.jsx("span",{className:"font-semibold",children:o!=="None"?ws>0?((n-g)/ws*3).toFixed(1):"0.0":"—"})]}),o!=="None"&&e.jsxs("div",{className:"text-xs opacity-70",children:["Darts thrown: ",ws]}),o!=="None"&&e.jsxs("div",{className:"text-xs opacity-80 mt-1",children:["Doubles: ",e.jsxs("span",{className:"font-semibold",children:["Att ",sn," · Hit ",zs]})]})]})]}),e.jsx("div",{className:"md:col-span-2 min-w-0 space-y-2",children:Cl?e.jsxs("div",{className:"card",children:[e.jsx("div",{className:"text-sm font-semibold mb-1",children:"Manual scoring active"}),e.jsx("div",{className:"text-xs opacity-70",children:"Camera previews are disabled. Use the manual entry controls below to record your turn."})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"flex items-center gap-1.5 mt-1",children:e.jsxs("div",{className:"ml-auto flex items-center gap-1 text-[10px]",children:[e.jsx("span",{className:"opacity-70",children:"Cam"}),e.jsx("button",{className:`btn ${Kn}`,onClick:()=>Gn(Math.max(.5,Math.round((pn-.05)*100)/100)),children:"−"}),e.jsxs("span",{className:`btn ${Kn} min-w-[2.5rem] text-center`,children:[Math.round(pn*100),"%"]}),e.jsx("button",{className:`btn ${Kn}`,onClick:()=>Gn(Math.min(1.25,Math.round((pn+.05)*100)/100)),children:"+"}),e.jsx("span",{className:"opacity-50",children:"|"}),e.jsx("button",{className:`btn ${Kn}`,title:"Toggle camera aspect",onClick:()=>wl(Hr==="square"?"wide":"square"),children:Hr==="square"?"Square":"Wide"})]})}),e.jsx("div",{className:"flex items-stretch justify-end min-w-0 md:min-h-[45vh]",children:e.jsx(ca,{label:"Your Board",autoStart:!0,className:"min-w-0 h-full",style:{minHeight:"45vh"},fill:!0})})]})})]}):e.jsx("div",{className:"grid grid-cols-1 md:[grid-template-columns:1fr_1.2fr_1fr] gap-2 mb-2 items-stretch min-w-0",children:e.jsxs("div",{className:"flex items-stretch justify-center md:px-3 min-w-0",children:[e.jsxs("div",{className:"p-3 rounded-2xl glass text-white border border-white/10 min-w-0 flex flex-col h-full",children:[e.jsxs("div",{className:"text-xs text-slate-600 flex items-center justify-between",children:[e.jsx("span",{className:"opacity-80",children:"You Remain"}),te?e.jsx("span",{className:"px-2 py-0.5 rounded-full bg-emerald-500/20 text-emerald-200 text-xs font-bold",children:"THROWING"}):e.jsx("span",{className:"px-2 py-0.5 rounded-full bg-slate-500/20 text-slate-200 text-xs font-bold",children:"WAITING TO THROW"})]}),e.jsx("div",{className:"text-3xl font-extrabold tracking-tight",children:x}),e.jsx("div",{className:"h-1.5 w-full bg-white/10 rounded-full mt-2 overflow-hidden",children:e.jsx("div",{className:"h-full bg-emerald-400/70",style:{width:`${Math.max(0,Math.min(100,(1-x/n)*100))}%`}})}),e.jsxs("div",{className:"text-sm mt-1 opacity-90",children:["Last dart: ",e.jsx("span",{className:"font-semibold",children:xt})]}),e.jsxs("div",{className:"text-sm opacity-90",children:["3-Dart Avg: ",e.jsx("span",{className:"font-semibold",children:Be>0?((n-x)/Be*3).toFixed(1):"0.0"})]}),e.jsxs("div",{className:"text-xs opacity-70 flex items-center gap-2",children:[e.jsxs("span",{children:["Darts thrown: ",Be]}),e.jsx("span",{className:"inline-flex items-center gap-1","aria-label":"Visit darts",children:[0,1,2].map(y=>e.jsx("span",{className:`w-2 h-2 rounded-full ${y<pt?"bg-emerald-400":"bg-white/20"}`},y))})]}),e.jsxs("div",{className:"text-xs opacity-80 mt-1",children:["Doubles: ",e.jsxs("span",{className:"font-semibold",children:["Att ",Us," · Hit ",fn]})]}),x<=170&&x>0&&(()=>{const L=la(x,Fr)[0]||"—";return e.jsxs("div",{className:"mt-2 inline-flex items-center gap-2 px-3 py-1 rounded-full bg-white/10 border border-white/10 text-white text-sm",children:[e.jsx("span",{className:"opacity-70",children:"Checkout"}),e.jsx("span",{className:"font-semibold",children:L})]})})()]}),e.jsx("div",{className:"flex items-stretch justify-end md:px-3 min-w-0 md:min-h-[45vh]",children:e.jsx(ca,{label:"Your Board",autoStart:!0,className:"min-w-0 h-full",style:{minHeight:"45vh"},fill:!0})}),e.jsxs("div",{className:`mt-2 ${Jn==="small"?"p-2":Jn==="large"?"p-4":"p-3"} rounded-2xl bg-slate-900/40 border border-white/10 text-white ${An==="small"?"text-xs":An==="large"?"text-base":"text-sm"}`,children:[e.jsx("div",{className:"font-semibold mb-2",children:"Match Summary"}),(()=>{const y=te?t?.username||"You":o==="None"?"—":`${o} AI`,L=te?x:o==="None"?0:g,G=te?xt:tn,Y=te?Je:ns,se=te?Be:ws,_e=n-(te?x:o==="None"?n:g),Ke=se>0?_e/se*3:0,Ee=`${M}-${b}`,we=R.length>0?`${Math.min(...R.map(Ie=>Ie.doubleDarts+(Ie.checkoutDarts||0)))||0} darts`:"—";return e.jsxs("div",{className:"grid grid-cols-2 gap-y-1",children:[e.jsx("div",{className:"opacity-80",children:"Current score"}),e.jsx("div",{className:"font-mono text-right",children:Ee}),e.jsx("div",{className:"opacity-80",children:"Current thrower"}),e.jsx("div",{className:"text-right font-semibold text-lg",children:y}),e.jsx("div",{className:"opacity-80",children:"Score remaining"}),e.jsx("div",{className:"text-right font-mono font-bold text-xl",children:L}),e.jsx("div",{className:"opacity-80",children:"3-dart avg"}),e.jsx("div",{className:"text-right font-mono",children:Ke.toFixed(1)}),e.jsx("div",{className:"opacity-80",children:"Last score"}),e.jsx("div",{className:"text-right font-mono",children:Y||G}),e.jsx("div",{className:"opacity-80",children:"Best leg"}),e.jsx("div",{className:"text-right",children:we})]})})()]}),e.jsxs("div",{className:"p-3 rounded-2xl glass text-white border border-white/10 min-w-0 flex flex-col h-full",children:[e.jsxs("div",{className:"text-xs flex items-center justify-between opacity-80",children:[e.jsxs("span",{children:[o==="None"?"Opponent":`${o} AI`," Remain"]}),te?e.jsx("span",{className:"px-2 py-0.5 rounded-full bg-slate-500/20 text-slate-200 text-xs font-bold",children:"WAITING TO THROW"}):e.jsx("span",{className:"px-2 py-0.5 rounded-full bg-emerald-500/20 text-emerald-200 text-xs font-bold",children:"THROWING"})]}),e.jsx("div",{className:"text-3xl font-extrabold tracking-tight",children:o!=="None"?g:"N/A"}),o!=="None"&&e.jsx("div",{className:"h-1.5 w-full bg-white/10 rounded-full mt-2 overflow-hidden",children:e.jsx("div",{className:"h-full bg-fuchsia-400/70",style:{width:`${Math.max(0,Math.min(100,(1-g/n)*100))}%`}})}),e.jsxs("div",{className:"text-sm mt-1 opacity-90",children:["Last dart: ",e.jsx("span",{className:"font-semibold",children:o==="None"?0:tn})]}),e.jsxs("div",{className:"text-sm opacity-90",children:["3-Dart Avg: ",e.jsx("span",{className:"font-semibold",children:o!=="None"?ws>0?((n-g)/ws*3).toFixed(1):"0.0":"—"})]}),o!=="None"&&e.jsxs("div",{className:"text-xs opacity-70",children:["Darts thrown: ",ws]}),o!=="None"&&e.jsxs("div",{className:"text-xs opacity-80 mt-1",children:["Doubles: ",e.jsxs("span",{className:"font-semibold",children:["Att ",sn," · Hit ",zs]})]})]})]})}),s!=="X01"?e.jsxs("div",{className:"space-y-2",children:[s==="Double Practice"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"font-semibold",children:["Target: ",e.jsx("span",{className:"px-2 py-0.5 rounded-full bg-white/10 border border-white/10",children:ys[he]?.label||"—"})]}),qt&&e.jsx("div",{className:"rounded-2xl overflow-hidden bg-black",children:e.jsx(Ze,{scoringMode:"custom",showToolbar:!1,onAutoDart:(y,L)=>{if((L==="DOUBLE"||L==="INNER_BULL")&&wr(y,he)){const Y=rt+1,se=he+1;De(Y),ce(se),Y>=ys.length&&setTimeout(()=>{De(0),ce(0)},250)}},immediateAutoCommit:!0})}),e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{className:"input w-24",type:"number",min:0,max:60,value:fe,onChange:y=>Pe(Number(y.target.value||0)),onKeyDown:y=>{y.key==="Enter"&&Gr()}}),e.jsx("button",{className:"btn px-3 py-1 text-sm",onClick:Gr,children:"Add Dart"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{className:"input w-44",placeholder:"Manual (D16, 50, 25, T20)",value:es,onChange:y=>Qt(y.target.value),onKeyDown:y=>{y.key==="Enter"&&Jr()}}),e.jsx("button",{className:"btn px-3 py-1 text-sm",onClick:Jr,children:"Add"})]})]}),e.jsxs("div",{className:"text-xs text-slate-300",children:["Progress: ",rt," of 21"]})]}),s==="Around the Clock"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"font-semibold",children:["Target: ",e.jsx("span",{className:"px-2 py-0.5 rounded-full bg-white/10 border border-white/10",children:Ut[mt]===25?"25 (Outer Bull)":Ut[mt]===50?"50 (Inner Bull)":Ut[mt]||"—"})]}),qt&&e.jsx("div",{className:"rounded-2xl overflow-hidden bg-black",children:e.jsx(Ze,{scoringMode:"custom",showToolbar:!1,immediateAutoCommit:!0,onAutoDart:(y,L,G)=>{Ca(y,L==="MISS"?void 0:L,G?.sector??null)}})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{className:"input w-24",type:"number",min:0,value:fe,onChange:y=>Pe(Number(y.target.value||0)),onKeyDown:y=>{y.key==="Enter"&&si()}}),e.jsx("button",{className:"btn px-3 py-1 text-sm",onClick:si,children:"Add Dart"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{className:"input w-44",placeholder:"Manual (T20, D5, 25, 50)",value:es,onChange:y=>Qt(y.target.value),onKeyDown:y=>{y.key==="Enter"&&ni()}}),e.jsx("button",{className:"btn px-3 py-1 text-sm",onClick:ni,children:"Add"})]}),ne>=Ut.length&&e.jsxs("div",{className:"mt-2 text-xs px-2 py-1 rounded bg-emerald-500/20 text-emerald-200 border border-emerald-400/30 inline-block",children:["Completed! ",e.jsx("button",{className:"ml-2 underline",onClick:()=>{de(0),tt(0)},children:"Reset"})]})]}),s==="Cricket"&&e.jsxs(e.Fragment,{children:[qt&&e.jsx("div",{className:"rounded-2xl overflow-hidden bg-black",children:e.jsx(Ze,{scoringMode:"custom",showToolbar:!1,immediateAutoCommit:!0,onAutoDart:(y,L,G)=>{ai(y,L==="MISS"?void 0:L,G?.sector??null)}})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{className:"input w-24",type:"number",min:0,value:fe,onChange:y=>Pe(Number(y.target.value||0)),onKeyDown:y=>{y.key==="Enter"&&ri()}}),e.jsx("button",{className:"btn px-3 py-1 text-sm",onClick:ri,children:"Add Dart"}),e.jsx("button",{className:"btn bg-slate-700 hover:bg-slate-800 px-3 py-1 text-sm",onClick:()=>{me(on()),Ae(0)},children:"Reset"})]})]}),s==="Shanghai"&&e.jsxs(e.Fragment,{children:[qt&&e.jsx("div",{className:"rounded-2xl overflow-hidden bg-black",children:e.jsx(Ze,{scoringMode:"custom",showToolbar:!1,immediateAutoCommit:!0,onAutoDart:(y,L,G)=>{ii(y,L==="MISS"?void 0:L,G?.sector??null)}})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{className:"input w-24",type:"number",min:0,value:fe,onChange:y=>Pe(Number(y.target.value||0)),onKeyDown:y=>{y.key==="Enter"&&oi()}}),e.jsx("button",{className:"btn px-3 py-1 text-sm",onClick:oi,children:"Add Dart"}),e.jsx("button",{className:"btn bg-slate-700 hover:bg-slate-800 px-3 py-1 text-sm",onClick:()=>{ke(Js()),Ae(0)},children:"Reset"})]})]}),s==="Halve It"&&e.jsxs(e.Fragment,{children:[qt&&e.jsx("div",{className:"rounded-2xl overflow-hidden bg-black",children:e.jsx(Ze,{scoringMode:"custom",showToolbar:!1,immediateAutoCommit:!0,onAutoDart:(y,L,G)=>{li(y,L==="MISS"?void 0:L,G?.sector??null)}})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{className:"input w-24",type:"number",min:0,value:fe,onChange:y=>Pe(Number(y.target.value||0)),onKeyDown:y=>{y.key==="Enter"&&ci()}}),e.jsx("button",{className:"btn px-3 py-1 text-sm",onClick:ci,children:"Add Dart"}),e.jsx("button",{className:"btn bg-slate-700 hover:bg-slate-800 px-3 py-1 text-sm",onClick:()=>{yt(Ks()),Ae(0)},children:"Reset"})]})]}),s==="High-Low"&&e.jsxs(e.Fragment,{children:[qt&&e.jsx("div",{className:"rounded-2xl overflow-hidden bg-black",children:e.jsx(Ze,{scoringMode:"custom",showToolbar:!1,immediateAutoCommit:!0,onAutoDart:(y,L,G)=>{di(y,L==="MISS"?void 0:L,G?.sector??null)}})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{className:"input w-24",type:"number",min:0,value:fe,onChange:y=>Pe(Number(y.target.value||0)),onKeyDown:y=>{y.key==="Enter"&&mi()}}),e.jsx("button",{className:"btn px-3 py-1 text-sm",onClick:mi,children:"Add Dart"}),e.jsx("button",{className:"btn bg-slate-700 hover:bg-slate-800 px-3 py-1 text-sm",onClick:()=>{ee(Ys()),Ae(0)},children:"Reset"})]})]}),s==="Bob's 27"&&e.jsxs(e.Fragment,{children:[qt&&e.jsx("div",{className:"rounded-2xl overflow-hidden bg-black",children:e.jsx(Ze,{scoringMode:"custom",showToolbar:!1,immediateAutoCommit:!0,onAutoDart:(y,L,G)=>{Kr(y,L==="MISS"?void 0:L,G?.sector??null)}})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{className:"input w-24",type:"number",min:0,value:fe,onChange:y=>Pe(Number(y.target.value||0)),onKeyDown:y=>{y.key==="Enter"&&Yr()}}),e.jsx("button",{className:"btn px-3 py-1 text-sm",onClick:Yr,children:"Add Dart"}),e.jsx("button",{className:"btn bg-slate-700 hover:bg-slate-800 px-3 py-1 text-sm",onClick:Xr,children:"Reset"})]})]}),s==="Count-Up"&&e.jsxs(e.Fragment,{children:[qt&&e.jsx("div",{className:"rounded-2xl overflow-hidden bg-black",children:e.jsx(Ze,{scoringMode:"custom",showToolbar:!1,immediateAutoCommit:!0,onAutoDart:y=>ja(y)})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{className:"input w-24",type:"number",min:0,value:fe,onChange:y=>Pe(Number(y.target.value||0)),onKeyDown:y=>{y.key==="Enter"&&(ja(fe),Pe(0))}}),e.jsx("button",{className:"btn px-3 py-1 text-sm",onClick:()=>{ja(fe),Pe(0)},children:"Add Dart"}),e.jsx("button",{className:"btn bg-slate-700 hover:bg-slate-800 px-3 py-1 text-sm",onClick:()=>{H(1),Ye(0),Ot(0)},children:"Reset"})]}),e.jsxs("div",{className:"text-xs text-slate-400",children:["Round ",Tt,"/",$]})]}),s==="High Score"&&e.jsxs(e.Fragment,{children:[qt&&e.jsx("div",{className:"rounded-2xl overflow-hidden bg-black",children:e.jsx(Ze,{scoringMode:"custom",showToolbar:!1,immediateAutoCommit:!0,onAutoDart:y=>Na(y)})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{className:"input w-24",type:"number",min:0,value:fe,onChange:y=>Pe(Number(y.target.value||0)),onKeyDown:y=>{y.key==="Enter"&&(Na(fe),Pe(0))}}),e.jsx("button",{className:"btn px-3 py-1 text-sm",onClick:()=>{Na(fe),Pe(0)},children:"Add Dart"}),e.jsx("button",{className:"btn bg-slate-700 hover:bg-slate-800 px-3 py-1 text-sm",onClick:()=>{ue(1),Xe(0),je(0)},children:"Reset"})]}),e.jsxs("div",{className:"text-xs text-slate-400",children:["Round ",J,"/",$e]})]}),s==="Low Score"&&e.jsxs(e.Fragment,{children:[qt&&e.jsx("div",{className:"rounded-2xl overflow-hidden bg-black",children:e.jsx(Ze,{scoringMode:"custom",showToolbar:!1,immediateAutoCommit:!0,onAutoDart:y=>wa(y)})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{className:"input w-24",type:"number",min:0,value:fe,onChange:y=>Pe(Number(y.target.value||0)),onKeyDown:y=>{y.key==="Enter"&&(wa(fe),Pe(0))}}),e.jsx("button",{className:"btn px-3 py-1 text-sm",onClick:()=>{wa(fe),Pe(0)},children:"Add Dart"}),e.jsx("button",{className:"btn bg-slate-700 hover:bg-slate-800 px-3 py-1 text-sm",onClick:()=>{it(1),Ps(0),dn(0)},children:"Reset"})]}),e.jsxs("div",{className:"text-xs text-slate-400",children:["Round ",Bt,"/",Ts]})]}),s==="Checkout 170"&&e.jsxs(e.Fragment,{children:[qt&&e.jsx("div",{className:"rounded-2xl overflow-hidden bg-black",children:e.jsx(Ze,{scoringMode:"custom",showToolbar:!1,immediateAutoCommit:!0,onAutoDart:(y,L)=>Zr(y,L==="MISS"?void 0:L)})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{className:"input w-24",type:"text",placeholder:"Manual (D16, T20)",value:es,onChange:y=>Qt(y.target.value),onKeyDown:y=>{y.key==="Enter"&&Qn(!0)}}),e.jsx("button",{className:"btn px-3 py-1 text-sm",onClick:()=>Qn(!0),children:"Add Dart"}),e.jsx("button",{className:"btn bg-slate-700 hover:bg-slate-800 px-3 py-1 text-sm",onClick:Tl,children:"Reset"})]}),e.jsxs("div",{className:"text-xs text-slate-400",children:["Remaining: ",Fs," · Attempts: ",B," · Successes: ",K]})]}),s==="Checkout 121"&&e.jsxs(e.Fragment,{children:[qt&&e.jsx("div",{className:"rounded-2xl overflow-hidden bg-black",children:e.jsx(Ze,{scoringMode:"custom",showToolbar:!1,immediateAutoCommit:!0,onAutoDart:(y,L)=>ei(y,L==="MISS"?void 0:L)})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{className:"input w-24",type:"text",placeholder:"Manual (D16, T20)",value:es,onChange:y=>Qt(y.target.value),onKeyDown:y=>{y.key==="Enter"&&Qn(!1)}}),e.jsx("button",{className:"btn px-3 py-1 text-sm",onClick:()=>Qn(!1),children:"Add Dart"}),e.jsx("button",{className:"btn bg-slate-700 hover:bg-slate-800 px-3 py-1 text-sm",onClick:Il,children:"Reset"})]}),e.jsxs("div",{className:"text-xs text-slate-400",children:["Remaining: ",V," · Attempts: ",be," · Successes: ",Nt]})]}),s==="Treble Practice"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"text-sm",children:"Target"}),e.jsx("select",{className:"input w-24",value:It,onChange:y=>wt(parseInt(y.target.value,10)),children:Array.from({length:20},(y,L)=>L+1).map(y=>e.jsx("option",{value:y,children:y},y))}),e.jsx("button",{className:"btn px-3 py-1 text-sm",onClick:Ml,children:"Reset"})]}),qt&&e.jsx("div",{className:"rounded-2xl overflow-hidden bg-black",children:e.jsx(Ze,{scoringMode:"custom",showToolbar:!1,immediateAutoCommit:!0,onAutoDart:(y,L,G)=>{Sa(y,L==="MISS"?void 0:L,G?.sector??null)}})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{className:"input w-24",type:"text",placeholder:"Manual (T20)",value:es,onChange:y=>Qt(y.target.value),onKeyDown:y=>{if(y.key==="Enter"){const L=Gs(es);L!=null&&Sa(L,void 0,void 0),Qt("")}}}),e.jsx("button",{className:"btn px-3 py-1 text-sm",onClick:()=>{const y=Gs(es);y!=null&&Sa(y,void 0,void 0),Qt("")},children:"Add Dart"})]}),e.jsxs("div",{className:"text-xs text-slate-400",children:["Hits: ",Is," · Darts: ",ls]})]}),s==="Baseball"&&e.jsxs(e.Fragment,{children:[qt&&e.jsx("div",{className:"rounded-2xl overflow-hidden bg-black",children:e.jsx(Ze,{scoringMode:"custom",showToolbar:!1,immediateAutoCommit:!0,onAutoDart:(y,L,G)=>{Dl(y,L==="MISS"?void 0:L,G?.sector??null)}})}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("button",{className:"btn bg-slate-700 hover:bg-slate-800 px-3 py-1 text-sm",onClick:Al,children:"Reset"})})]}),s==="Golf"&&e.jsxs(e.Fragment,{children:[qt&&e.jsx("div",{className:"rounded-2xl overflow-hidden bg-black",children:e.jsx(Ze,{scoringMode:"custom",showToolbar:!1,immediateAutoCommit:!0,onAutoDart:(y,L,G)=>{Rl(y,L==="MISS"?void 0:L,G?.sector??null)}})}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("button",{className:"btn bg-slate-700 hover:bg-slate-800 px-3 py-1 text-sm",onClick:Pl,children:"Reset"})})]}),s==="Tic Tac Toe"&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"grid grid-cols-3 gap-1 mb-2",children:Array.from({length:9},(y,L)=>L).map(y=>e.jsx("button",{className:`h-16 rounded-xl border ${Gt.board[y]?"bg-emerald-500/20 border-emerald-400/30":"bg-slate-800/50 border-slate-700/50"}`,onClick:()=>{if(Gt.finished||Gt.board[y])return;const L=Number(prompt("Enter dart score for this cell (e.g., 20, 40, 60; 25 or 50 for center)")||0),G=L%3===0?"TRIPLE":L%2===0?"DOUBLE":"SINGLE",Y=y,se=Fn[Y],_e=se.type==="BULL"?null:se.num||null;Ll(Y,L,G,_e)},children:Gt.board[y]||""},y))}),qt&&e.jsx("div",{className:"rounded-2xl overflow-hidden bg-black",children:e.jsx(Ze,{scoringMode:"custom",showToolbar:!1,immediateAutoCommit:!0,onAutoDart:(y,L,G)=>{}})}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("button",{className:"btn bg-slate-700 hover:bg-slate-800 px-3 py-1 text-sm",onClick:Ol,children:"Reset"})})]}),s==="American Cricket"&&e.jsxs(e.Fragment,{children:[qt&&e.jsx("div",{className:"rounded-2xl overflow-hidden bg-black",children:e.jsx(Ze,{scoringMode:"custom",showToolbar:!1,immediateAutoCommit:!0,onAutoDart:(y,L,G)=>{Bl(y,L==="MISS"?void 0:L,G?.sector??null)}})}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("button",{className:"btn bg-slate-700 hover:bg-slate-800 px-3 py-1 text-sm",onClick:ti,children:"Reset"})})]}),s==="Killer"&&e.jsx(e.Fragment,{children:Ls?e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-2",children:ct.map(y=>{const L=xs[y.id],G=Ds[y.id];return e.jsxs("div",{className:`p-2 rounded-xl border ${L?.eliminated?"opacity-50 border-red-500/40 bg-red-500/10":"border-slate-700/50 bg-slate-800/50"}`,children:[e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsx("div",{className:"font-semibold",children:y.name}),e.jsx("div",{className:`text-[10px] px-1.5 py-0.5 rounded ${L?.isKiller?"bg-purple-500/20 text-purple-200 border border-purple-400/30":"bg-slate-600/30 text-slate-300"}`,children:L?.isKiller?"Killer":"Not Killer"})]}),e.jsxs("div",{className:"mt-1 text-sm",children:["Number: ",e.jsx("span",{className:"font-semibold",children:G})]}),e.jsxs("div",{className:"text-sm",children:["Lives: ",e.jsx("span",{className:"font-semibold",children:L?.lives??0})]})]},y.id)})}),qt&&e.jsx("div",{className:"rounded-2xl overflow-hidden bg-black",children:e.jsx(Ze,{scoringMode:"custom",showToolbar:!1,immediateAutoCommit:!0,onAutoDart:(y,L,G)=>{if(Kt)return;const Y=L==="MISS"?void 0:L,se=G?.sector??null,_e=ct[ss];_e&&(Zt(Ke=>{const Ee={};Object.keys(Ke).forEach(et=>Ee[et]={...Ke[et]});const we=Sr(_e.id,Ee,Y,se);if(we.becameKiller)xe(`${_e.name} became a Killer`);else if(we.victimId){const et=ct.find(Ft=>Ft.id===we.victimId);xe(`${_e.name} hit ${et?.name}'s ${Ds[we.victimId]} (${we.livesRemoved} life${(we.livesRemoved||0)>1?"s":""})`)}else xe("No effect");const Ie=Cr(Ee);return Ie&&js(Ie),Ee}),cs(Ke=>{const Ee=Ke+1;if(Ee>=3){let we=ss;for(let Ie=1;Ie<=ct.length;Ie++){const et=(ss+Ie)%ct.length,Ft=ct[et].id,gs=xs[Ft];if(gs&&!gs.eliminated&&gs.lives>0){we=et;break}}return ps(we),0}return Ee}))}})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{className:"input w-40",placeholder:"Manual (D16, T5)",value:es,onChange:y=>Qt(y.target.value),onKeyDown:y=>{if(y.key==="Enter"){if(Kt)return;const G=es.trim().toUpperCase().match(/^(S|D|T)?\s*(\d{1,2})$/);if(!G){Qt("");return}const Y=G[1]||"S",se=parseInt(G[2],10),_e=Y==="D"?"DOUBLE":Y==="T"?"TRIPLE":"SINGLE",Ke=ct[ss];Zt(Ee=>{const we={};Object.keys(Ee).forEach(Ft=>we[Ft]={...Ee[Ft]});const Ie=Sr(Ke.id,we,_e,se);if(Ie.becameKiller)xe(`${Ke.name} became a Killer`);else if(Ie.victimId){const Ft=ct.find(gs=>gs.id===Ie.victimId);xe(`${Ke.name} hit ${Ft?.name}'s ${Ds[Ie.victimId]} (${Ie.livesRemoved} life${(Ie.livesRemoved||0)>1?"s":""})`)}else xe("No effect");const et=Cr(we);return et&&js(et),we}),Qt(""),cs(Ee=>{const we=Ee+1;if(we>=3){let Ie=ss;for(let et=1;et<=ct.length;et++){const Ft=(ss+et)%ct.length,gs=ct[Ft].id,nn=xs[gs];if(nn&&!nn.eliminated&&nn.lives>0){Ie=Ft;break}}return ps(Ie),0}return we})}}}),e.jsx("button",{className:"btn px-3 py-1 text-sm",onClick:()=>{let y=ss;for(let L=1;L<=ct.length;L++){const G=(ss+L)%ct.length,Y=ct[G].id,se=xs[Y];if(se&&!se.eliminated&&se.lives>0){y=G;break}}ps(y),cs(0)},children:"Next Player"}),e.jsx("button",{className:"btn bg-slate-700 hover:bg-slate-800 px-3 py-1 text-sm",onClick:()=>{Zt({}),ts({}),Dt(!1),ps(0),cs(0),js(null),xe("")},children:"Reset"})]}),Kt&&e.jsxs("div",{className:"mt-2 text-xs px-2 py-1 rounded bg-emerald-500/20 text-emerald-200 border border-emerald-400/30 inline-block",children:["Winner: ",ct.find(y=>y.id===Kt)?.name," ",e.jsx("button",{className:"ml-2 underline",onClick:()=>{Zt({}),ts({}),Dt(!1),ps(0),cs(0),js(null),xe("")},children:"Play Again"})]})]}):e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"font-semibold",children:"Players"}),e.jsx("div",{className:"space-y-1",children:ct.map((y,L)=>e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{className:"input",value:y.name,onChange:G=>{const Y=G.target.value;Wt(se=>se.map((_e,Ke)=>Ke===L?{..._e,name:Y}:_e))}}),e.jsx("button",{className:"btn px-2 py-1",onClick:()=>Wt(G=>G.filter((Y,se)=>se!==L)),disabled:ct.length<=2,children:"Remove"})]},y.id))}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{className:"btn px-2 py-1",onClick:()=>Wt(y=>{const L=`p${y.length+1}`;return[...y,{id:L,name:`Player ${y.length+1}`}]}),children:"Add Player"}),e.jsx("button",{className:"btn bg-emerald-600 hover:bg-emerald-700 px-3 py-1",onClick:()=>{if(ct.length<2){alert("Need at least 2 players");return}const y=ct.map(Y=>Y.id),L=sm(y),G={};y.forEach(Y=>{G[Y]=sl(L[Y])}),ts(L),Zt(G),ps(0),cs(0),js(null),xe("Assigned numbers"),Dt(!0)},children:"Assign Numbers & Start"})]})]})})]}):te?e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"font-semibold",children:"Your Turn"}),e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{className:"input w-24",type:"number",min:0,max:60,value:fe,onChange:y=>Pe(Number(y.target.value||0)),onKeyDown:y=>{y.key==="Enter"&&(y.shiftKey?$l():qr())}}),e.jsx("button",{className:"btn px-3 py-1 text-sm",onClick:qr,children:"Add Dart"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{className:"input w-44",placeholder:"Manual (T20, D16, 5, 25, 50)",value:es,onChange:y=>Qt(y.target.value),onKeyDown:y=>{y.key==="Enter"&&(y.shiftKey?hi():ka())}}),e.jsx("button",{className:"btn btn--ghost px-3 py-1 text-sm",onClick:hi,disabled:pt===0,children:"Replace Last"}),e.jsx("button",{className:"btn px-3 py-1 text-sm",onClick:ka,children:"Add"})]}),e.jsxs("div",{children:[e.jsx("textarea",{className:"input w-full h-24 resize-none",placeholder:`Type scores manually (one per line, e.g. T20
D16
5
25
50) - No camera needed!`,value:$r,onChange:y=>ga(y.target.value)}),e.jsxs("div",{className:"flex gap-2 mt-1",children:[e.jsx("button",{className:"btn px-3 py-1 text-sm",onClick:Ul,children:"Add All Scores"}),e.jsx("button",{className:"btn btn--ghost px-3 py-1 text-sm",onClick:()=>ga(""),children:"Clear"})]})]})]}),e.jsx("div",{className:"text-xs text-slate-300",children:"Tip: Enter to Add · Shift+Enter to Replace Last"})]}):e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"font-semibold",children:[o==="None"?"Opponent":`${o} AI`," Turn"]}),o!=="None"?e.jsxs("div",{className:"text-sm text-slate-300",children:["Throwing in ",Math.ceil(Hs/1e3),"s..."]}):e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("button",{className:"btn",onClick:()=>at(!0),children:"Switch Back to You"})})]}),e.jsx("div",{className:"h-1"})]})]})})}),d&&e.jsx(lm,{onClose:()=>c(!1)}),Ea&&e.jsxs("div",{className:"absolute inset-0 z-40 flex items-center justify-center",children:[e.jsx("div",{className:"absolute inset-0 backdrop-blur-sm bg-slate-900/40"}),e.jsxs("div",{className:"relative z-10 p-4 rounded-xl bg-black/60 border border-slate-700 text-center",children:[e.jsx("div",{className:"text-3xl mb-2",children:"🔒"}),e.jsx("div",{className:"font-semibold",children:"Premium mode locked"}),e.jsx("div",{className:"text-sm text-slate-200/80",children:"Upgrade to PREMIUM to play modes like Killer, Cricket, Shanghai, and more."}),e.jsxs("button",{onClick:async()=>{try{const L=await(await fetch(`${cm}/api/stripe/create-checkout-session`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:t?.email})})).json();L.ok&&L.url?(window.location.href=L.url,L.development&&st("Opened Stripe test checkout (development mode)",{type:"info",timeout:3e3})):L.error==="STRIPE_NOT_CONFIGURED"?st("Premium purchases are not available in this development environment. Please visit the production site to upgrade.",{type:"error",timeout:4e3}):st("Failed to create checkout session. Please try again.",{type:"error",timeout:4e3})}catch{st("Error creating checkout. Please try again.",{type:"error",timeout:4e3})}},className:"btn mt-3 bg-gradient-to-r from-indigo-500 to-fuchsia-600 text-white font-bold",children:["Upgrade to PREMIUM · ",Io(Mo(),5)]})]})]}),N&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50",children:e.jsxs(Qs,{storageKey:"ndn:modal:offline-win",className:"w-full relative",defaultWidth:420,defaultHeight:360,minWidth:360,minHeight:300,maxWidth:800,maxHeight:700,children:[e.jsx("h3",{className:"text-lg font-bold mb-2",children:"Leg Won!"}),e.jsx("label",{className:"block mb-1",children:"Darts to hit double:"}),e.jsx("div",{className:"flex gap-2 mb-2",children:[1,2,3].map(y=>e.jsx("button",{className:`btn ${U===y?"bg-brand-600":""}`,onClick:()=>w(y),children:y},y))}),e.jsx("label",{className:"block mb-1",children:"Darts for checkout:"}),e.jsx("div",{className:"flex gap-2 mb-2",children:[1,2,3].map(y=>e.jsx("button",{className:`btn ${_===y?"bg-brand-600":""}`,onClick:()=>ie(y),children:y},y))}),e.jsxs("div",{className:"grid grid-cols-1 gap-2 mt-2",children:[e.jsx("button",{className:"btn w-full",onClick:Fl,children:"Submit"}),e.jsx("button",{className:"btn bg-emerald-600 hover:bg-emerald-700 w-full",onClick:()=>{E(!1),vn()},children:"Rematch"}),e.jsx("button",{className:"btn bg-slate-700 hover:bg-slate-800 w-full",onClick:()=>{E(!1),Te(!1),h(!1)},children:"Back to Menu"})]})]})}),pl&&e.jsx("div",{className:"fixed inset-0 bg-black/60 flex items-center justify-center z-[60]",children:e.jsxs(Qs,{storageKey:"ndn:modal:offline-summary",className:"w-full relative",defaultWidth:820,defaultHeight:520,minWidth:600,minHeight:400,maxWidth:1400,maxHeight:1e3,children:[e.jsx("h3",{className:"text-xl font-extrabold mb-2",children:"Match Summary"}),e.jsxs("div",{className:"text-xs opacity-80 mb-3",children:[s," · ",n," start · First to ",A]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-3",children:[e.jsxs("div",{className:"p-3 rounded-2xl glass border border-white/10",children:[e.jsx("div",{className:"text-sm font-semibold mb-1",children:"You"}),e.jsx("div",{className:"text-3xl font-extrabold",children:M}),e.jsx("div",{className:"text-xs opacity-80",children:"Legs Won"}),e.jsxs("div",{className:"mt-3 grid grid-cols-2 gap-2 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"opacity-70",children:"3-Dart Avg"}),e.jsx("div",{className:"font-semibold",children:xn>0?(C/xn*3).toFixed(1):"0.0"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"opacity-70",children:"1-Dart Avg"}),e.jsx("div",{className:"font-semibold",children:xn>0?(C/xn).toFixed(2):"0.00"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"opacity-70",children:"180s"}),e.jsx("div",{className:"font-semibold",children:oe})]}),e.jsxs("div",{children:[e.jsx("span",{className:"opacity-70",children:"140+"}),e.jsx("div",{className:"font-semibold",children:Qe})]}),e.jsxs("div",{children:[e.jsx("span",{className:"opacity-70",children:"100+"}),e.jsx("div",{className:"font-semibold",children:as})]}),e.jsxs("div",{children:[e.jsx("span",{className:"opacity-70",children:"High Checkout"}),e.jsx("div",{className:"font-semibold",children:fl||"—"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"opacity-70",children:"Dbl Att"}),e.jsx("div",{className:"font-semibold",children:Us})]}),e.jsxs("div",{children:[e.jsx("span",{className:"opacity-70",children:"Dbl Hit"}),e.jsx("div",{className:"font-semibold",children:fn})]})]})]}),e.jsx("div",{className:"hidden md:flex items-center justify-center",children:e.jsxs("div",{className:"text-4xl font-black",children:[M," – ",b]})}),e.jsxs("div",{className:"p-3 rounded-2xl glass border border-white/10",children:[e.jsx("div",{className:"text-sm font-semibold mb-1",children:o==="None"?"Opponent":`${o} AI`}),e.jsx("div",{className:"text-3xl font-extrabold",children:b}),e.jsx("div",{className:"text-xs opacity-80",children:"Legs Won"}),e.jsxs("div",{className:"mt-3 grid grid-cols-2 gap-2 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"opacity-70",children:"3-Dart Avg"}),e.jsx("div",{className:"font-semibold",children:f>0?(Q/f*3).toFixed(1):"0.0"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"opacity-70",children:"1-Dart Avg"}),e.jsx("div",{className:"font-semibold",children:f>0?(Q/f).toFixed(2):"0.00"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"opacity-70",children:"180s"}),e.jsx("div",{className:"font-semibold",children:Ue})]}),e.jsxs("div",{children:[e.jsx("span",{className:"opacity-70",children:"140+"}),e.jsx("div",{className:"font-semibold",children:Or})]}),e.jsxs("div",{children:[e.jsx("span",{className:"opacity-70",children:"100+"}),e.jsx("div",{className:"font-semibold",children:Cs})]}),e.jsxs("div",{children:[e.jsx("span",{className:"opacity-70",children:"High Checkout"}),e.jsx("div",{className:"font-semibold",children:xl||"—"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"opacity-70",children:"Dbl Att"}),e.jsx("div",{className:"font-semibold",children:sn})]}),e.jsxs("div",{children:[e.jsx("span",{className:"opacity-70",children:"Dbl Hit"}),e.jsx("div",{className:"font-semibold",children:zs})]})]})]})]}),e.jsxs("div",{className:"mt-4",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"Legs Timeline"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:R.map((y,L)=>e.jsxs("div",{className:`px-3 py-1 rounded-full border text-xs ${y.winner==="player"?"bg-emerald-500/15 border-emerald-400/30":"bg-fuchsia-500/15 border-fuchsia-400/30"}`,children:["Leg ",L+1,": ",y.winner==="player"?"You":o==="None"?"Opp":"AI"," · Dbl ",y.doubleDarts," · CO ",y.checkoutDarts]},L))})]}),e.jsxs("div",{className:"mt-4",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"Shot Heat Map"}),e.jsx("div",{className:"rounded-2xl overflow-hidden bg-black p-3",children:e.jsx(Zd,{})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 mt-4",children:[e.jsx("button",{className:"btn bg-slate-700 hover:bg-slate-800",onClick:()=>ba(!1),children:"Close"}),e.jsx("button",{className:"btn bg-emerald-600 hover:bg-emerald-700",onClick:()=>{ba(!1),vn()},children:"Rematch"})]})]})}),R.length>0&&e.jsxs("div",{className:"mt-4",children:[e.jsx("h4",{className:"font-semibold mb-2",children:"Leg Stats"}),e.jsx("ul",{children:R.map((y,L)=>e.jsxs("li",{children:["Leg ",L+1,": Double darts: ",y.doubleDarts,", Checkout darts: ",y.checkoutDarts]},L))})]}),e.jsx(Pr,{})]})}const ll="ndn:messages:inbox",cl="ndn:messages:unread";function mm(){try{const t=localStorage.getItem(ll),a=t?JSON.parse(t):[],s=Number(localStorage.getItem(cl)||"0")||0;return{inbox:Array.isArray(a)?a.filter(n=>n&&typeof n.id=="string").slice(0,200):[],unread:s}}catch{return{inbox:[],unread:0}}}function sa(t,a){try{localStorage.setItem(ll,JSON.stringify(t))}catch{}try{localStorage.setItem(cl,String(a))}catch{}}const fo=mm(),Er=Zs((t,a)=>({inbox:fo.inbox,unread:fo.unread,inGame:!1,setInGame:s=>t({inGame:s}),add:s=>t(i=>{const n=i.inbox.some(l=>l.id===s.id&&l.ts===s.ts),r=n?i.inbox:[s,...i.inbox].slice(0,200),o=i.unread+(n?0:1);return sa(r,o),{inbox:r,unread:o}}),load:s=>t(i=>{const n=[...s].sort((r,o)=>o.ts-r.ts).slice(0,200);return sa(n,i.unread),{inbox:n,unread:i.unread}}),markAllRead:()=>{const s=a();sa(s.inbox,0),t({unread:0})},remove:s=>t(i=>{const n=i.inbox.filter(o=>o.id!==s),r=i.unread;return sa(n,r),{inbox:n,unread:r}})})),dl=[/\b(f+[\W_]*u+[\W_]*c+[\W_]*k+)\b/gi,/\b(s+[\W_]*h+[\W_]*i+[\W_]*t+)\b/gi,/\b(b+[\W_]*i+[\W_]*t+[\W_]*c+[\W_]*h+)\b/gi,/\b(a+[\W_]*s+[\W_]*s+[\W_]*h+[\W_]*o+[\W_]*l+[\W_]*e+)\b/gi,/\b(d+[\W_]*a+[\W_]*m+[\W_]*n+)\b/gi,/\b(c+[\W_]*r+[\W_]*a+[\W_]*p+)\b/gi,/\b(p+[\W_]*i+[\W_]*s+[\W_]*s+)\b/gi];function um(t){return t.replace(/[\p{L}\p{N}]/gu,"*")}function ml(t){if(!t)return t;let a=t;for(const s of dl)a=a.replace(s,i=>um(i));return a}function hm(t){return t?dl.some(a=>a.test(t)):!1}function pa({tabs:t,active:a,onChange:s,className:i}){return e.jsxs("div",{className:`relative ${i||""}`,children:[e.jsx("div",{className:"absolute inset-0 rounded-xl bg-white/5 backdrop-blur-md border border-white/10 pointer-events-none"}),e.jsx("div",{className:"relative overflow-x-auto no-scrollbar py-1 px-1",children:e.jsx("div",{className:"flex items-center gap-2 min-w-max",children:t.map(n=>{const r=n.key===a;return e.jsx("button",{type:"button",onClick:()=>s(n.key),className:`transition-all select-none whitespace-nowrap rounded-full px-4 py-2 text-sm font-semibold shadow-sm focus:outline-none focus-visible:ring-2 focus-visible:ring-white/60 active:scale-[0.98]
                  ${r?"bg-gradient-to-r from-indigo-500 to-fuchsia-500 text-white shadow-indigo-500/30":"bg-white/10 text-slate-100 hover:bg-white/15"}
                `,"aria-pressed":r,children:n.label},n.key)})})}),e.jsx("style",{children:`
        /* Hide scrollbars on WebKit/Firefox for a cleaner pill row */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
      `})]})}function fm(t){if(!t)return"";const a=Math.floor((Date.now()-t)/1e3);if(a<60)return`${a}s ago`;const s=Math.floor(a/60);if(s<60)return`${s}m ago`;const i=Math.floor(s/60);return i<24?`${i}h ago`:`${Math.floor(i/24)}d ago`}function xm({user:t}){const a=wn(),s=String(t?.email||"").toLowerCase(),[i,n]=m.useState([]),[r,o]=m.useState([]),[l,d]=m.useState([]),[c,u]=m.useState(""),[h,x]=m.useState("all"),[p,g]=m.useState(!1),S=Er(),[D,I]=m.useState([]),[N,E]=m.useState([]),[A,O]=m.useState({show:!1});async function M(){if(s)try{const[w,_,ie,R]=await Promise.all([fetch(`/api/friends/list?email=${encodeURIComponent(s)}`).then(Z=>Z.json()),fetch(`/api/friends/suggested?email=${encodeURIComponent(s)}`).then(Z=>Z.json()),fetch(`/api/friends/requests?email=${encodeURIComponent(s)}`).then(Z=>Z.json()),fetch(`/api/friends/outgoing?email=${encodeURIComponent(s)}`).then(Z=>Z.json())]);n(w.friends||[]),o(_.suggestions||[]),I(ie.requests||[]),E(R.requests||[])}catch{}}m.useEffect(()=>{M()},[s]);async function v(w){if(u(w),!w){d([]);return}try{const ie=await(await fetch(`/api/friends/search?q=${encodeURIComponent(w)}`)).json();d(ie.results||[])}catch{}}async function b(w){if(!(!s||!w)){g(!0);try{await fetch("/api/friends/add",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:s,friend:w})}),await M(),u(""),d([]),a("Friend added",{type:"success"})}finally{g(!1)}}}async function F(w){if(!(!s||!w)){g(!0);try{await fetch("/api/friends/remove",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:s,friend:w})}),await M(),a("Friend removed",{type:"info"})}finally{g(!1)}}}const z=m.useMemo(()=>h==="all"?i:i.filter(w=>(w.status||"offline")===h),[i,h]);async function T(w){if(!w){a("Room unavailable",{type:"error"});return}try{const _=new CustomEvent("ndn:spectate-request",{detail:{roomId:w}});window.dispatchEvent(_),a("Opening spectator view…",{type:"info"})}catch{}}const U=D.length+N.length;return e.jsxs("div",{className:"card",children:[e.jsx("h2",{className:"text-2xl font-bold text-brand-700 mb-2",children:"Friends"}),e.jsx("p",{className:"mb-2 text-brand-600",children:"Manage your friends. See who’s online, in-game, or offline; find new teammates; and invite people to play."}),e.jsxs("div",{className:"text-xs opacity-70 mb-3",children:["Online: ",i.filter(w=>w.status==="online").length," · In-game: ",i.filter(w=>w.status==="ingame").length," · Offline: ",i.filter(w=>!w.status||w.status==="offline").length]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-3 mb-4",children:[e.jsxs("div",{className:"md:col-span-2 p-3 rounded-2xl bg-black/30 border border-white/10",children:[e.jsx("div",{className:"flex items-center justify-between mb-2",children:e.jsx("div",{className:"font-semibold text-white/90",children:"Your Friends"})}),e.jsx(pa,{tabs:[{key:"all",label:"All"},{key:"online",label:"Online"},{key:"ingame",label:"In-Game"},{key:"offline",label:"Offline"},{key:"requests",label:`Requests ${U>0?"("+U+")":""}`}],active:h,onChange:w=>x(w),className:"mb-3"}),h==="requests"?e.jsx("ul",{className:"space-y-2",children:U>0?e.jsxs(e.Fragment,{children:[D.length>0&&D.map(w=>e.jsxs("li",{className:"p-3 rounded bg-black/20 flex flex-col gap-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-semibold text-lg",children:w.fromUsername||w.fromEmail||"Unknown User"}),e.jsx("span",{className:"text-xs bg-blue-600/20 text-blue-400 px-2 py-1 rounded",children:"Incoming"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{className:"btn bg-emerald-600 hover:bg-emerald-700",onClick:async()=>{g(!0);try{if((await fetch("/api/friends/accept",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:s,requester:w.fromEmail})})).ok){I(R=>R.filter(Z=>Z.id!==w.id));const ie={email:w.fromEmail,username:w.fromUsername,status:"offline"};n(R=>[...R,ie]),E(R=>R.filter(Z=>Z.toEmail!==w.fromEmail)),a("Friend request accepted",{type:"success"}),setTimeout(()=>M(),100)}else a("Failed to accept request",{type:"error"})}catch{a("Error accepting request",{type:"error"})}finally{g(!1)}},children:"Accept"}),e.jsx("button",{className:"btn bg-rose-600 hover:bg-rose-700",onClick:async()=>{g(!0);try{(await fetch("/api/friends/decline",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:s,requester:w.fromEmail})})).ok?(I(ie=>ie.filter(R=>R.id!==w.id)),E(ie=>ie.filter(R=>R.toEmail!==w.fromEmail)),a("Friend request declined",{type:"info"}),setTimeout(()=>M(),100)):a("Failed to decline request",{type:"error"})}finally{g(!1)}},children:"Decline"})]})]},`incoming-${w.id||w.fromEmail}`)),N.length>0&&N.map(w=>e.jsxs("li",{className:"p-3 rounded bg-black/20 flex flex-col gap-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-semibold text-lg",children:w.toUsername||w.toEmail||"Unknown User"}),e.jsx("span",{className:"text-xs bg-amber-600/20 text-amber-400 px-2 py-1 rounded",children:"Pending"})]}),e.jsx("button",{className:"btn bg-slate-600 hover:bg-slate-700 self-start",onClick:async()=>{g(!0);try{(await fetch("/api/friends/cancel",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:s,friend:w.toEmail})})).ok?(E(ie=>ie.filter(R=>R.id!==w.id)),a("Friend request cancelled",{type:"info"}),setTimeout(()=>M(),100)):a("Failed to cancel request",{type:"error"})}finally{g(!1)}},children:"Cancel"})]},`outgoing-${w.id||w.toEmail}`))]}):e.jsx("li",{className:"text-sm opacity-70",children:"No friend requests yet."})}):e.jsxs("ul",{className:"space-y-2",children:[z.map(w=>e.jsxs("li",{className:"p-2 rounded bg-black/20 flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:`inline-block w-2 h-2 rounded-full ${w.status==="online"?"bg-emerald-400":w.status==="ingame"?"bg-amber-400":"bg-slate-400"}`}),e.jsx("span",{className:"font-semibold",children:w.username||w.email}),e.jsxs("span",{className:"text-xs opacity-70",children:[w.status||"offline",w.status!=="online"&&w.lastSeen?` · ${fm(w.lastSeen)}`:""]}),w.status==="ingame"&&w.match&&e.jsxs("span",{className:"text-[10px] opacity-70 px-2 py-0.5 rounded bg-indigo-500/20 border border-indigo-600/30",children:[w.match.game," ",w.match.mode==="firstto"?"FT":"BO"," ",w.match.value,w.match.game==="X01"&&w.match.startingScore?` · ${w.match.startingScore}`:""]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[w.status==="ingame"&&w.roomId&&e.jsx("button",{className:"btn",onClick:()=>T(w.roomId),children:"Spectate"}),e.jsx("button",{className:"btn",disabled:p||w.status!=="online"&&w.status!=="ingame",onClick:async()=>{g(!0);try{(await(await fetch("/api/friends/invite",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({fromEmail:s,toEmail:w.email,game:"X01",mode:"bestof",value:3,startingScore:501})})).json().catch(()=>({})))?.delivered?a("Invite sent",{type:"success"}):a("Friend is offline; invite queued",{type:"info"})}finally{g(!1)}},children:"Invite"}),e.jsx("button",{className:"btn",disabled:p,onClick:()=>O({show:!0,toUser:w.username||w.email,toEmail:w.email}),children:"Message"}),e.jsx("button",{className:"btn bg-rose-600 hover:bg-rose-700",disabled:p,onClick:()=>F(w.email),children:"Remove"})]})]},w.email)),z.length===0&&e.jsxs("li",{className:"text-sm opacity-70",children:["No friends ",h!=="all"?`in ${h}`:""," yet."]})]})]}),e.jsxs("div",{className:"p-3 rounded-2xl bg-black/20 border border-white/10",children:[e.jsx("div",{className:"font-semibold mb-2 text-white/90",children:"Find Friends"}),e.jsx("input",{className:"input w-full mb-2",placeholder:"Search by name or email",value:c,onChange:w=>v(w.target.value)}),e.jsxs("ul",{className:"space-y-1 mb-3 max-h-48 overflow-auto",children:[l.map(w=>e.jsxs("li",{className:"flex items-center justify-between p-2 rounded bg-black/10",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:`inline-block w-2 h-2 rounded-full ${w.status==="online"?"bg-emerald-400":w.status==="ingame"?"bg-amber-400":"bg-slate-400"}`}),e.jsx("span",{children:w.username||w.email})]}),e.jsx("button",{className:"btn",disabled:p,onClick:()=>b(w.email),children:"Add"})]},w.email)),l.length===0&&e.jsx("li",{className:"text-xs opacity-60",children:"Type to search…"})]}),e.jsx("div",{className:"font-semibold mb-1 text-white/90",children:"Suggested"}),e.jsxs("ul",{className:"space-y-1 max-h-48 overflow-auto",children:[r.map(w=>e.jsxs("li",{className:"flex items-center justify-between p-2 rounded bg-black/10",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:`inline-block w-2 h-2 rounded-full ${w.status==="online"?"bg-emerald-400":w.status==="ingame"?"bg-amber-400":"bg-slate-400"}`}),e.jsx("span",{children:w.username||w.email})]}),e.jsx("button",{className:"btn",disabled:p,onClick:()=>b(w.email),children:"Add"})]},w.email)),r.length===0&&e.jsx("li",{className:"text-xs opacity-60",children:"No suggestions right now."})]})]})]}),e.jsxs("div",{className:"p-3 rounded-xl bg-indigo-500/10 border border-indigo-500/40",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("div",{className:"font-semibold",children:"Messages"}),e.jsx("button",{className:"btn px-3 py-1 text-sm",onClick:()=>S.markAllRead(),children:"Mark all read"})]}),S.inbox.length===0?e.jsx("div",{className:"text-sm opacity-70",children:"No messages yet."}):e.jsx("ul",{className:"space-y-2 max-h-72 overflow-auto",children:S.inbox.map(w=>e.jsxs("li",{className:"p-2 rounded bg-black/20 text-sm",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-semibold",children:w.from})," ",e.jsxs("span",{className:"opacity-70 text-xs",children:["· ",new Date(w.ts).toLocaleString()]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{className:"btn px-2 py-1 text-xs",onClick:()=>O({show:!0,toUser:w.from,toEmail:w.from,replyTo:w.from}),children:"Reply"}),e.jsx("button",{className:"btn bg-slate-700 hover:bg-slate-800 px-2 py-1 text-xs",title:"Delete this message",onClick:()=>S.remove(w.id),children:"Delete"}),e.jsx("button",{className:"btn bg-rose-600 hover:bg-rose-700 px-2 py-1 text-xs",onClick:async()=>{const _=prompt("Report reason (what happened)?");if(_)try{await fetch("/api/friends/report",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({reporterEmail:s,offenderEmail:w.from,reason:_,messageId:w.id})}),a("Report sent to admin",{type:"info"})}catch{}},children:"Report"})]})]}),e.jsx("div",{className:"mt-1 whitespace-pre-wrap break-words",children:ml(w.message)})]},w.id))})]}),A.show&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-slate-800 border border-slate-600 rounded-lg p-6 max-w-md w-full mx-4",children:[e.jsx("div",{className:"text-center mb-4",children:e.jsxs("h3",{className:"text-lg font-semibold text-white",children:["Type Message To ",A.toUser]})}),e.jsx("textarea",{className:"w-full h-32 bg-slate-700 border border-slate-600 rounded p-3 text-white placeholder-slate-400 resize-none",placeholder:"Type your message here...",id:"message-input",autoFocus:!0}),e.jsxs("div",{className:"flex gap-3 mt-4",children:[e.jsx("button",{className:"flex-1 btn bg-emerald-600 hover:bg-emerald-700",onClick:async()=>{const _=document.getElementById("message-input")?.value?.trim();if(_){g(!0);try{await fetch("/api/friends/message",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({fromEmail:s,toEmail:A.toEmail,message:_})}),a("Message sent",{type:"success"}),O({show:!1})}catch{a("Failed to send message",{type:"error"})}finally{g(!1)}}},disabled:p,children:"Send"}),e.jsx("button",{className:"flex-1 btn bg-slate-600 hover:bg-slate-700",onClick:()=>O({show:!1}),children:"Cancel"})]})]})})]})}function pm(){const t=yr(s=>s.toasts),a=yr(s=>s.remove);return t.length?e.jsxs(e.Fragment,{children:[t.filter(s=>s.type==="success").map(s=>e.jsx("div",{className:"fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-50",children:e.jsx("div",{className:"p-4 rounded-lg shadow-lg border text-sm bg-emerald-700/90 border-emerald-500/60 text-white max-w-sm text-center",children:e.jsx("div",{className:"flex items-center justify-center gap-2",children:e.jsx("span",{className:"flex-1 font-semibold",children:s.message})})})},s.id)),t.filter(s=>s.type!=="success").length>0&&e.jsx("div",{className:"fixed bottom-4 right-4 z-50 space-y-2 sm:right-4 sm:left-auto left-1/2 -translate-x-1/2 sm:translate-x-0 w-[calc(100%-1.5rem)] sm:w-auto max-w-sm",children:t.filter(s=>s.type!=="success").map(s=>e.jsx("div",{className:`p-3 rounded-lg shadow-lg border text-sm ${s.type==="error"?"bg-rose-700/80 border-rose-500/60 text-white":"bg-black/70 border-slate-700 text-slate-100"}`,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"flex-1",children:s.message}),e.jsx("button",{className:"btn btn--ghost px-2 py-1 text-xs",onClick:()=>a(s.id),children:"Dismiss"})]})},s.id))})]}):null}function Tr({data:t,height:a=220,barWidth:s=28,gap:i=6,showValues:n=!1}){const r=Math.max(1,...t.map(l=>l.value)),o=t.length*(s+i);return e.jsx("div",{className:"w-full overflow-x-auto",children:e.jsx("div",{className:"relative",style:{height:a,width:Math.max(600,o)},children:e.jsx("div",{className:"absolute inset-0 flex items-end",children:t.map((l,d)=>{const c=Math.round(l.value/r*(a-40));return e.jsxs("div",{className:"flex flex-col items-center justify-end",style:{width:s,marginRight:i},children:[e.jsx("div",{className:"w-full rounded-t-md bg-gradient-to-b from-indigo-400 to-fuchsia-500 shadow-sm",style:{height:c},title:`${l.label}: ${l.value}`}),n&&e.jsx("div",{className:"text-[10px] mt-1 opacity-80",children:l.value}),e.jsx("div",{className:"text-[10px] mt-1 opacity-70 select-none",children:l.label})]},d)})})})})}const bm=["X01","Double Practice"],Vs=["Around the Clock","Cricket","Halve It","Shanghai","High-Low","Killer","Bob's 27","Count-Up","High Score","Low Score","Checkout 170","Checkout 121","Treble Practice","Baseball","Golf","Tic Tac Toe","American Cricket"],Nn=[...bm,...Vs],gm="daviesfamily108@gmail.com";function ym({user:t}){const[a,s]=m.useState([]),[i,n]=m.useState(""),[r,o]=m.useState(null),[l,d]=m.useState(""),[c,u]=m.useState(!1),[h,x]=m.useState([]),[p,g]=m.useState([]),[S,D]=m.useState(""),[I,N]=m.useState([]),[E,A]=m.useState({title:"Official Tournament",game:"X01",mode:"bestof",value:3,description:"",startAt:new Date(Date.now()+7200*1e3).toISOString().slice(0,16),checkinMinutes:30,capacity:16,prizeType:"premium",prizeAmount:3,currency:"GBP",prizeNotes:""}),[O,M]=m.useState({reset:{},reminder:{},confirmEmail:{},changed:{}}),[v,b]=m.useState({open:!1}),[F,z]=m.useState("general"),T=t?.email?.toLowerCase()===gm,[U,w]=m.useState([]),[_,ie]=m.useState([]),[R,Z]=m.useState([]),[ae,Me]=m.useState(null),[st,Se]=m.useState(0);m.useEffect(()=>{const k=()=>Se(ee=>ee+1);return window.addEventListener("ndn:stats-updated",k),()=>window.removeEventListener("ndn:stats-updated",k)},[]);const Te=m.useMemo(()=>Mr(Nn),[st]),dt=m.useMemo(()=>Nn.map(k=>({label:k,value:Te[k]?.played||0,won:Te[k]?.won||0})),[Te]);async function ye(){try{const ee=await(await fetch("/api/admins")).json();if(s(Array.isArray(ee.admins)?ee.admins:[]),T){const At=await fetch(`/api/admin/status?requesterEmail=${encodeURIComponent(t?.email||"")}`);At.ok&&o(await At.json());const Ae=await fetch(`/api/admin/tournaments?requesterEmail=${encodeURIComponent(t?.email||"")}`);if(Ae.ok){const Oe=await Ae.json();x(Array.isArray(Oe.tournaments)?Oe.tournaments:[])}const Mt=await fetch(`/api/admin/reports?requesterEmail=${encodeURIComponent(t?.email||"")}`);if(Mt.ok){const Oe=await Mt.json();ie(Array.isArray(Oe.reports)?Oe.reports:[])}const Rt=await fetch(`/api/admin/premium-winners?requesterEmail=${encodeURIComponent(t?.email||"")}`);if(Rt.ok){const Oe=await Rt.json();w(Array.isArray(Oe.winners)?Oe.winners:[])}const Pt=await fetch(`/api/admin/wallet/withdrawals?requesterEmail=${encodeURIComponent(t?.email||"")}`);if(Pt.ok){const Oe=await Pt.json();g(Array.isArray(Oe.withdrawals)?Oe.withdrawals:[])}}}catch{}}m.useEffect(()=>{ye()},[]);async function We(){i&&(await fetch("/api/admins/grant",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:i,requesterEmail:t?.email})}),n(""),ye())}async function Ve(k){await fetch("/api/admins/revoke",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:k,requesterEmail:t?.email})}),ye()}async function Ge(k,ee){k&&(await fetch("/api/admin/premium/grant",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:k,days:ee,requesterEmail:t?.email})}),await ye())}async function Re(k){await fetch("/api/admin/premium/revoke",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:k,requesterEmail:t?.email})}),await ye()}async function te(k){u(!0);try{await fetch("/api/admin/maintenance",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({enabled:k,requesterEmail:t?.email})}),await ye()}finally{u(!1)}}async function at(){if(l.trim()){u(!0);try{await fetch("/api/admin/announce",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:l,requesterEmail:t?.email})}),d(""),await ye()}finally{u(!1)}}}async function fe(){if(S.trim())try{const k=await fetch(`/api/admin/users/search?q=${encodeURIComponent(S)}&requesterEmail=${encodeURIComponent(t?.email||"")}`);if(k.ok){const ee=await k.json();N(Array.isArray(ee.users)?ee.users:[])}}catch(k){console.error("Search failed:",k)}}async function Pe(k){try{await fetch("/api/admin/users/ban",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:k,requesterEmail:t?.email})}),await fe()}catch(ee){console.error("Ban failed:",ee)}}async function he(k){try{await fetch("/api/admin/users/unban",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:k,requesterEmail:t?.email})}),await fe()}catch(ee){console.error("Unban failed:",ee)}}async function ce(){u(!0);try{const k=new Date(E.startAt).getTime();await fetch("/api/tournaments/create",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:E.title,game:E.game,mode:E.mode,value:Number(E.value),description:E.description,startAt:k,checkinMinutes:Number(E.checkinMinutes),capacity:Number(E.capacity),creatorEmail:t?.email,creatorName:t?.username,requesterEmail:t?.email,official:!0,prizeType:E.prizeType,prizeAmount:Number(E.prizeAmount||0),currency:E.currency,prizeNotes:E.prizeNotes})}),await ye()}finally{u(!1)}}async function rt(k,ee){u(!0);try{await fetch("/api/admin/tournaments/winner",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({tournamentId:k,winnerEmail:ee,requesterEmail:t?.email})}),await ye()}finally{u(!1)}}async function De(k){u(!0);try{await fetch("/api/admin/tournaments/mark-paid",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({tournamentId:k,requesterEmail:t?.email})}),await ye()}finally{u(!1)}}async function mt(k){u(!0);try{await fetch("/api/admin/tournaments/delete",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({tournamentId:k,requesterEmail:t?.email})}),await ye()}finally{u(!1)}}async function tt(){u(!0);try{await fetch("/api/admin/tournaments/reseed-weekly",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({requesterEmail:t?.email})}),await ye()}finally{u(!1)}}async function ne(k,ee){u(!0);try{await fetch("/api/admin/wallet/withdrawals/decide",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:k,approve:ee,requesterEmail:t?.email})}),await ye()}finally{u(!1)}}async function de(k){u(!0);try{await fetch("/api/admin/matches/delete",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({matchId:k,requesterEmail:t?.email})}),await ye()}finally{u(!1)}}async function ge(){try{const k=await fetch(`/api/admin/logs?requesterEmail=${encodeURIComponent(t?.email||"")}`);if(k.ok){const ee=await k.json();ee?.ok&&Z(ee.logs||[])}}catch(k){console.error("Failed to fetch logs:",k)}}async function me(){try{const k=await fetch(`/api/admin/system-health?requesterEmail=${encodeURIComponent(t?.email||"")}`);if(k.ok){const ee=await k.json();ee?.ok&&Me(ee.health)}}catch(k){console.error("Failed to fetch system health:",k)}}async function ze(){try{const k=await fetch(`/api/admin/email-copy?requesterEmail=${encodeURIComponent(t?.email||"")}`);if(k.ok){const ee=await k.json();ee?.ok&&M(ee.copy||O)}}catch{}}m.useEffect(()=>{T&&ze()},[T]),m.useEffect(()=>{T&&(F==="general"||F==="maintenance")&&(ge(),me())},[T,F]);async function ke(k,ee){await fetch("/api/admin/email-copy",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({requesterEmail:t?.email,kind:k,...ee})}),await ze()}async function lt(k){try{const At=await(await fetch(`/api/email/preview?kind=${encodeURIComponent(k)}&requesterEmail=${encodeURIComponent(t?.email||"")}`)).text();b({open:!0,kind:k,html:At})}catch{b({open:!0,kind:k,html:'<!doctype html><html><body style="font-family:sans-serif;padding:16px">Failed to load preview.</body></html>'})}}m.useEffect(()=>{if(!v.open)return;function k(ee){ee.key==="Escape"&&b({open:!1})}return document.addEventListener("keydown",k),()=>document.removeEventListener("keydown",k)},[v.open]);function yt({kind:k,label:ee}){const Ae=O?.[k==="confirm-email"?"confirmEmail":k==="changed"?"changed":k]||{title:"",intro:"",buttonLabel:""},[Mt,Rt]=m.useState(Ae.title||""),[Pt,Oe]=m.useState(Ae.intro||""),[_t,Et]=m.useState(Ae.buttonLabel||"");return m.useEffect(()=>{Rt(Ae.title||""),Oe(Ae.intro||""),Et(Ae.buttonLabel||"")},[Ae.title,Ae.intro,Ae.buttonLabel]),e.jsxs("div",{className:"p-2 rounded bg-black/20 space-y-2",children:[e.jsx("div",{className:"font-semibold",children:ee}),e.jsx("input",{className:"input w-full",placeholder:"Title (optional)",value:Mt,onChange:Lt=>Rt(Lt.target.value)}),e.jsx("textarea",{className:"input w-full",rows:2,placeholder:"Intro line (optional)",value:Pt,onChange:Lt=>Oe(Lt.target.value)}),e.jsx("input",{className:"input w-full",placeholder:"Button label (optional)",value:_t,onChange:Lt=>Et(Lt.target.value)}),e.jsxs("div",{className:"flex gap-2 justify-end",children:[e.jsx("a",{className:"btn",href:`/api/email/preview?kind=${encodeURIComponent(k)}&requesterEmail=${encodeURIComponent(t?.email||"")}`,target:"_blank",rel:"noreferrer",children:"Preview"}),e.jsx("button",{className:"btn",type:"button",onClick:()=>lt(k),children:"Popup"}),e.jsx("button",{className:"btn",onClick:()=>ke(k,{title:Mt,intro:Pt,buttonLabel:_t}),children:"Save"})]})]})}return T?e.jsxs("div",{className:"space-y-4",children:[T&&e.jsx(pa,{tabs:[{key:"general",label:"General"},{key:"maintenance",label:"Maintenance"},{key:"premium",label:"Premium"}],active:F,onChange:k=>z(k),className:"mb-4"}),F==="general"&&e.jsxs(e.Fragment,{children:[T&&e.jsxs("div",{className:"card",children:[e.jsx("h3",{className:"text-xl font-semibold mb-2",children:"Game Usage"}),e.jsx("div",{className:"text-sm opacity-80 mb-2",children:"Bar height shows total plays per mode. Wins are listed under each label. This helps decide which modes to keep or iterate on."}),e.jsxs("div",{className:"rounded-xl border border-indigo-500/40 bg-indigo-500/10 p-3",children:[e.jsx(Tr,{data:dt.map(k=>({label:k.label,value:k.value}))}),e.jsx("div",{className:"mt-2 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-2 text-[11px] opacity-80",children:dt.map((k,ee)=>e.jsxs("div",{className:"flex items-center justify-between px-2 py-1 rounded-md bg-white/5 border border-white/10",children:[e.jsx("span",{className:"truncate mr-2",children:k.label}),e.jsxs("span",{className:"whitespace-nowrap",children:["Played ",k.value," · Won ",k.won]})]},ee))})]})]}),e.jsxs("div",{className:"card",children:[e.jsx("h2",{className:"text-2xl font-bold mb-2",children:"Admin Control"}),e.jsx("div",{className:"text-sm opacity-80 mb-3",children:"Grant or revoke Admin to trusted users. Only the owner can perform these actions."}),e.jsxs("div",{className:"flex gap-2 mb-3",children:[e.jsx("input",{className:"input flex-1",placeholder:"user@example.com",value:i,onChange:k=>n(k.target.value)}),e.jsx("button",{className:"btn",disabled:c,onClick:We,children:"Grant"}),e.jsx("button",{className:"btn bg-rose-600 hover:bg-rose-700",disabled:c,onClick:()=>Ve(i),children:"Revoke"})]}),e.jsx("div",{className:"text-sm opacity-80 mb-2",children:"Current Admins:"}),e.jsx("div",{className:"flex flex-wrap gap-2 mb-4",children:a.map(k=>e.jsx("div",{className:"px-2 py-1 rounded bg-indigo-600/20 border border-indigo-500/40 text-sm",children:k},k))}),e.jsx("hr",{className:"border-indigo-500/20 my-4"}),e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"Premium Access Control"}),e.jsx("div",{className:"text-sm opacity-80 mb-3",children:"Grant or revoke Premium subscription access to users (grants 30 days)."}),e.jsxs("div",{className:"flex gap-2 mb-3",children:[e.jsx("input",{className:"input flex-1",placeholder:"user@example.com",value:i,onChange:k=>n(k.target.value)}),e.jsx("button",{className:"btn bg-emerald-600 hover:bg-emerald-700",disabled:c||!i.trim(),onClick:()=>Ge(i,30),children:"Grant Premium"}),e.jsx("button",{className:"btn bg-rose-600 hover:bg-rose-700",disabled:c,onClick:()=>Re(i),children:"Revoke Premium"})]}),e.jsx("div",{className:"text-sm opacity-80",children:"Premium grants provide 30 days of unlimited access to all features."})]}),e.jsxs("div",{className:"card",children:[e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"Tournament Premium Winners"}),e.jsx("div",{className:"text-sm opacity-80 mb-3",children:"Users who have won premium prizes in tournaments and need access granted."}),e.jsxs("div",{className:"space-y-2",children:[h.filter(k=>k.status==="completed"&&k.winnerEmail&&k.prizeType==="premium").map(k=>{const ee=U.find(Ae=>Ae.email===k.winnerEmail),At=ee&&!ee.expired;return e.jsxs("div",{className:"p-3 rounded bg-black/20 text-sm",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("div",{className:"font-semibold",children:k.title}),e.jsx("div",{className:"text-xs opacity-70",children:new Date(k.startAt).toLocaleDateString()})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:k.winnerEmail}),e.jsxs("div",{className:"text-xs opacity-70",children:["Prize: ",k.prizeAmount," month",k.prizeAmount>1?"s":""," PREMIUM"]})]}),e.jsx("div",{className:"flex items-center gap-2",children:At?e.jsx("span",{className:"px-2 py-1 rounded bg-emerald-600 text-xs",children:"Access Granted"}):e.jsx("button",{className:"btn bg-emerald-600 hover:bg-emerald-700 text-xs",disabled:c,onClick:()=>Ge(k.winnerEmail,k.prizeAmount*30*24*60*60*1e3),children:"Grant Access"})})]})]},k.id)}),h.filter(k=>k.status==="completed"&&k.winnerEmail&&k.prizeType==="premium").length===0&&e.jsx("div",{className:"text-center py-4 text-sm opacity-60",children:"No completed premium tournaments."})]})]}),e.jsxs("div",{className:"card",children:[e.jsx("h3",{className:"text-xl font-semibold mb-2",children:"Announcements"}),e.jsx("div",{className:"text-sm opacity-80 mb-2",children:"Send a message to all users. This will appear as a toast notification."}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{className:"input flex-1",placeholder:"Announcement message...",value:l,onChange:k=>d(k.target.value)}),e.jsx("button",{className:"btn",disabled:c||!l.trim(),onClick:at,children:"Send"})]})]}),e.jsxs("div",{className:"card",children:[e.jsx("h3",{className:"text-xl font-semibold mb-2",children:"User Search"}),e.jsx("div",{className:"text-sm opacity-80 mb-2",children:"Search for users by email or name."}),e.jsxs("div",{className:"flex gap-2 mb-3",children:[e.jsx("input",{className:"input flex-1",placeholder:"Search users...",value:S,onChange:k=>D(k.target.value)}),e.jsx("button",{className:"btn",disabled:c,onClick:fe,children:"Search"})]}),I.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-sm opacity-80 mb-2",children:"Results:"}),I.map(k=>e.jsx("div",{className:"p-2 rounded bg-black/20 text-sm flex items-center justify-between",children:e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold",children:k.name||"No name"}),e.jsx("div",{className:"opacity-70",children:k.email}),e.jsxs("div",{className:"opacity-60 text-xs",children:["Joined ",new Date(k.createdAt).toLocaleDateString()]})]})},k.email))]})]}),T&&e.jsxs("div",{className:"card",children:[e.jsx("h3",{className:"text-xl font-semibold mb-3",children:"Tournaments Management"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold mb-2",children:"Create Official"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("input",{className:"input w-full",placeholder:"Title",value:E.title,onChange:k=>A(ee=>({...ee,title:k.target.value}))}),e.jsxs("div",{className:"grid grid-cols-3 gap-2",children:[e.jsx("select",{className:"input",value:E.game,onChange:k=>A(ee=>({...ee,game:k.target.value})),children:["X01","Around the Clock","Cricket","Halve It","Shanghai","High-Low"].map(k=>e.jsx("option",{value:k,children:k},k))}),e.jsxs("select",{className:"input",value:E.mode,onChange:k=>A(ee=>({...ee,mode:k.target.value})),children:[e.jsx("option",{value:"bestof",children:"Best of"}),e.jsx("option",{value:"firstto",children:"First to"})]}),e.jsx("input",{className:"input",type:"number",min:1,value:E.value,onChange:k=>A(ee=>({...ee,value:Number(k.target.value)}))})]}),e.jsx("textarea",{className:"input w-full",rows:2,placeholder:"Description",value:E.description,onChange:k=>A(ee=>({...ee,description:k.target.value}))}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx("input",{className:"input",type:"datetime-local",value:E.startAt,onChange:k=>A(ee=>({...ee,startAt:k.target.value}))}),e.jsx("input",{className:"input",type:"number",min:0,value:E.checkinMinutes,onChange:k=>A(ee=>({...ee,checkinMinutes:Number(k.target.value)}))})]}),e.jsx("input",{className:"input w-full",type:"number",min:6,max:64,value:E.capacity,onChange:k=>A(ee=>({...ee,capacity:Number(k.target.value)}))}),e.jsxs("div",{className:"grid grid-cols-3 gap-2 items-center",children:[e.jsxs("select",{className:"input",value:E.prizeType,onChange:k=>{const ee=k.target.value;A(At=>({...At,prizeType:ee,prizeAmount:ee==="premium"?3:0}))},children:[e.jsx("option",{value:"premium",children:"PREMIUM"}),e.jsx("option",{value:"cash",children:"Cash"})]}),E.prizeType==="premium"?e.jsxs("select",{className:"input",value:E.prizeAmount,onChange:k=>A(ee=>({...ee,prizeAmount:Number(k.target.value)})),children:[e.jsx("option",{value:1,children:"1 month"}),e.jsx("option",{value:3,children:"3 months"})]}):e.jsx("input",{className:"input",type:"number",min:0,value:E.prizeAmount,onChange:k=>A(ee=>({...ee,prizeAmount:Number(k.target.value)}))}),e.jsxs("select",{className:"input",disabled:E.prizeType!=="cash",value:E.currency,onChange:k=>A(ee=>({...ee,currency:k.target.value})),children:[e.jsx("option",{value:"GBP",children:"GBP"}),e.jsx("option",{value:"USD",children:"USD"}),e.jsx("option",{value:"EUR",children:"EUR"}),e.jsx("option",{value:"CAD",children:"CAD"}),e.jsx("option",{value:"AUD",children:"AUD"})]})]}),e.jsx("input",{className:"input w-full",placeholder:"Prize notes (optional)",value:E.prizeNotes,onChange:k=>A(ee=>({...ee,prizeNotes:k.target.value}))}),e.jsx("div",{className:"flex justify-end",children:e.jsx("button",{className:"btn",disabled:c,onClick:ce,children:"Create"})})]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold mb-2",children:"Existing"}),e.jsxs("ul",{className:"space-y-2",children:[h.map(k=>e.jsxs("li",{className:"p-2 rounded bg-black/20 text-sm",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"font-semibold",children:k.title}),e.jsx("div",{className:"opacity-70",children:k.status})]}),e.jsxs("div",{className:"opacity-80",children:[k.game," · ",k.mode==="firstto"?"FT":"BO"," ",k.value," · ",new Date(k.startAt).toLocaleString()," · ",k.capacity," cap"]}),k.prize&&e.jsxs("div",{className:"text-xs mt-1",children:["Prize: ",k.prizeType==="cash"&&k.prizeAmount?`${k.currency||"USD"} ${k.prizeAmount}`:`${k.prizeAmount||3} month${(k.prizeAmount||3)>1?"s":""} PREMIUM`," ",k.prizeType==="cash"&&k.status==="completed"&&k.payoutStatus&&e.jsx("span",{className:`ml-2 px-1.5 py-0.5 rounded ${k.payoutStatus==="paid"?"bg-emerald-600":"bg-amber-600"}`,children:k.payoutStatus})]}),e.jsxs("div",{className:"mt-2 flex flex-wrap gap-2",children:[e.jsx("button",{className:"btn",disabled:c||k.status!=="scheduled",onClick:()=>rt(k.id,prompt("Winner email?")||""),children:"Set Winner"}),k.prizeType==="cash"&&k.status==="completed"&&k.payoutStatus!=="paid"&&e.jsx("button",{className:"btn",disabled:c,onClick:()=>De(k.id),children:"Mark Paid"})]})]},k.id)),h.length===0&&e.jsx("li",{className:"opacity-60",children:"No tournaments."})]}),e.jsx("div",{className:"mt-3 flex justify-end",children:e.jsx("button",{className:"btn",disabled:c,onClick:tt,children:"Reseed Weekly Giveaway"})})]})]})]}),T&&e.jsxs("div",{className:"card",children:[e.jsx("h3",{className:"text-xl font-semibold mb-3",children:"Email Templates"}),e.jsx("div",{className:"text-sm opacity-80 mb-2",children:"Customize titles, intro lines, and button text. Previews open in a new tab or as a popup."}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[e.jsx(yt,{kind:"reset",label:"Password reset"}),e.jsx(yt,{kind:"reminder",label:"Password reset reminder"}),e.jsx(yt,{kind:"confirm-email",label:"Confirm new email"}),e.jsx(yt,{kind:"changed",label:"Password changed notice"})]})]})]}),F==="maintenance"&&T&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"card",children:[e.jsx("h3",{className:"text-xl font-semibold mb-2",children:"User Management"}),e.jsx("div",{className:"text-sm opacity-80 mb-2",children:"Ban or unban users. Use with caution."}),e.jsxs("div",{className:"flex gap-2 mb-3",children:[e.jsx("input",{className:"input flex-1",placeholder:"user@example.com",value:S,onChange:k=>D(k.target.value)}),e.jsx("button",{className:"btn",disabled:c,onClick:fe,children:"Search"})]}),I.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-sm opacity-80 mb-2",children:"Results:"}),I.map(k=>e.jsxs("div",{className:"p-2 rounded bg-black/20 text-sm flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold",children:k.name||"No name"}),e.jsx("div",{className:"opacity-70",children:k.email}),e.jsxs("div",{className:"opacity-60 text-xs",children:["Joined ",new Date(k.createdAt).toLocaleDateString()]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{className:"btn bg-red-600 hover:bg-red-700 text-xs",onClick:()=>Pe(k.email),children:"Ban"}),e.jsx("button",{className:"btn bg-green-600 hover:bg-green-700 text-xs",onClick:()=>he(k.email),children:"Unban"})]})]},k.email))]})]}),e.jsxs("div",{className:"card",children:[e.jsx("h3",{className:"text-xl font-semibold mb-3",children:"Withdrawals"}),e.jsxs("ul",{className:"space-y-2",children:[p.map(k=>e.jsxs("li",{className:"p-2 rounded bg-black/20 text-sm flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-mono text-xs",children:k.id}),e.jsxs("div",{children:[k.email," · ",k.currency," ",(k.amountCents/100).toFixed(2)]}),e.jsxs("div",{className:"opacity-70",children:[k.status," · ",new Date(k.requestedAt).toLocaleString()]})]}),e.jsx("div",{className:"flex gap-2",children:k.status==="pending"&&e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"btn bg-emerald-600 hover:bg-emerald-700",disabled:c,onClick:()=>ne(k.id,!0),children:"Approve"}),e.jsx("button",{className:"btn bg-rose-600 hover:bg-rose-700",disabled:c,onClick:()=>ne(k.id,!1),children:"Reject"})]})})]},k.id)),p.length===0&&e.jsx("li",{className:"opacity-60",children:"No withdrawal requests."})]})]}),e.jsxs("div",{className:"card",children:[e.jsx("h3",{className:"text-xl font-semibold mb-3",children:"System Health"}),e.jsx("div",{className:"text-sm opacity-80 mb-3",children:"Current status of system components and services."}),ae?e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{children:"Database"}),e.jsx("span",{className:`px-2 py-1 rounded text-xs ${ae.database?"bg-emerald-600":"bg-red-600"}`,children:ae.database?"Ready":"Down"})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{children:"WebSocket"}),e.jsx("span",{className:`px-2 py-1 rounded text-xs ${ae.websocket?"bg-emerald-600":"bg-red-600"}`,children:ae.websocket?"Ready":"Down"})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{children:"HTTPS"}),e.jsx("span",{className:`px-2 py-1 rounded text-xs ${ae.https?"bg-emerald-600":"bg-amber-600"}`,children:ae.https?"Enabled":"HTTP Only"})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{children:"Maintenance Mode"}),e.jsx("span",{className:`px-2 py-1 rounded text-xs ${ae.maintenance?"bg-red-600":"bg-emerald-600"}`,children:ae.maintenance?"Active":"Normal"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"text-sm",children:[e.jsx("span",{className:"font-semibold",children:"Uptime:"})," ",Math.floor(ae.uptime/3600),"h ",Math.floor(ae.uptime%3600/60),"m"]}),e.jsxs("div",{className:"text-sm",children:[e.jsx("span",{className:"font-semibold",children:"Memory:"})," ",Math.round(ae.memory.heapUsed/1024/1024),"MB used"]}),e.jsxs("div",{className:"text-sm",children:[e.jsx("span",{className:"font-semibold",children:"Version:"})," ",ae.version]}),e.jsx("div",{className:"flex gap-2 mt-3",children:e.jsx("button",{className:"btn",onClick:me,children:"Refresh"})})]})]}):e.jsxs("div",{className:"text-center py-4",children:[e.jsx("div",{className:"text-sm opacity-60 mb-2",children:"Loading system health..."}),e.jsx("button",{className:"btn",onClick:me,children:"Load Health Status"})]})]}),e.jsxs("div",{className:"card",children:[e.jsx("h3",{className:"text-xl font-semibold mb-3",children:"User Reports"}),e.jsxs("ul",{className:"space-y-2",children:[_.map(k=>e.jsx("li",{className:"p-2 rounded bg-black/20 text-sm",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-mono text-xs",children:k.id}),e.jsxs("div",{children:[e.jsx("span",{className:"font-semibold",children:k.reporter})," → ",e.jsx("span",{className:"font-semibold",children:k.offender})," · ",new Date(k.ts).toLocaleString()]}),e.jsxs("div",{className:"opacity-80",children:["Reason: ",k.reason]}),k.messageId&&e.jsxs("div",{className:"opacity-60 text-xs",children:["Message ID: ",k.messageId]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("span",{className:`px-2 py-0.5 rounded text-xs ${k.status==="open"?"bg-amber-600":"bg-emerald-600"}`,children:k.status}),k.status==="open"&&e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"btn bg-emerald-600 hover:bg-emerald-700",disabled:c,onClick:async()=>{await fetch("/api/admin/reports/resolve",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:k.id,action:"resolved",requesterEmail:t?.email})}),await ye()},children:"Resolve"}),e.jsx("button",{className:"btn bg-rose-600 hover:bg-rose-700",disabled:c,onClick:async()=>{const ee=prompt("Enter notes for action taken (e.g., warning, block):")||"";await fetch("/api/admin/reports/resolve",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:k.id,action:"actioned",notes:ee,requesterEmail:t?.email})}),await ye()},children:"Action"})]})]})]})},k.id)),_.length===0&&e.jsx("li",{className:"opacity-60",children:"No reports."})]})]}),e.jsxs("div",{className:"card",children:[e.jsx("h3",{className:"text-xl font-semibold mb-3",children:"System Health"}),e.jsx("div",{className:"text-sm opacity-80 mb-3",children:"Current status of system components and services."}),ae?e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{children:"Database"}),e.jsx("span",{className:`px-2 py-1 rounded text-xs ${ae.database?"bg-emerald-600":"bg-red-600"}`,children:ae.database?"Ready":"Down"})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{children:"WebSocket"}),e.jsx("span",{className:`px-2 py-1 rounded text-xs ${ae.websocket?"bg-emerald-600":"bg-red-600"}`,children:ae.websocket?"Ready":"Down"})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{children:"HTTPS"}),e.jsx("span",{className:`px-2 py-1 rounded text-xs ${ae.https?"bg-emerald-600":"bg-amber-600"}`,children:ae.https?"Enabled":"HTTP Only"})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{children:"Maintenance Mode"}),e.jsx("span",{className:`px-2 py-1 rounded text-xs ${ae.maintenance?"bg-red-600":"bg-emerald-600"}`,children:ae.maintenance?"Active":"Normal"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"text-sm",children:[e.jsx("span",{className:"font-semibold",children:"Uptime:"})," ",Math.floor(ae.uptime/3600),"h ",Math.floor(ae.uptime%3600/60),"m"]}),e.jsxs("div",{className:"text-sm",children:[e.jsx("span",{className:"font-semibold",children:"Memory:"})," ",Math.round(ae.memory.heapUsed/1024/1024),"MB used"]}),e.jsxs("div",{className:"text-sm",children:[e.jsx("span",{className:"font-semibold",children:"Version:"})," ",ae.version]}),e.jsx("div",{className:"flex gap-2 mt-3",children:e.jsx("button",{className:"btn",onClick:me,children:"Refresh"})})]})]}):e.jsxs("div",{className:"text-center py-4",children:[e.jsx("div",{className:"text-sm opacity-60 mb-2",children:"Loading system health..."}),e.jsx("button",{className:"btn",onClick:me,children:"Load Health Status"})]})]}),e.jsxs("div",{className:"card",children:[e.jsx("h3",{className:"text-xl font-semibold mb-3",children:"Open Matches"}),e.jsxs("ul",{className:"space-y-1",children:[(r?.matches||[]).map(k=>e.jsxs("li",{className:"flex items-center justify-between p-2 rounded bg-black/20 text-sm",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"font-mono text-xs",children:k.id}),e.jsx("span",{className:"opacity-80",children:k.creatorName}),e.jsxs("span",{className:"opacity-60",children:[k.game," ",k.mode==="firstto"?"FT":"BO"," ",k.value," ",k.game==="X01"?`/${k.startingScore}`:""]})]}),e.jsx("button",{className:"btn bg-rose-600 hover:bg-rose-700",disabled:c,onClick:()=>de(k.id),children:"Remove"})]},k.id)),(!r?.matches||r.matches.length===0)&&e.jsx("li",{className:"text-sm opacity-60",children:"No open matches."})]})]}),e.jsxs("div",{className:"card",children:[e.jsx("h3",{className:"text-xl font-semibold mb-3",children:"Dangerous Operations"}),e.jsx("div",{className:"text-sm opacity-80 mb-3 text-red-400",children:"⚠️ These operations can cause data loss or service disruption. Use with extreme caution."}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold mb-2 text-red-400",children:"Tournament Deletion"}),e.jsxs("ul",{className:"space-y-2",children:[h.map(k=>e.jsxs("li",{className:"p-2 rounded bg-red-900/20 border border-red-500/40 text-sm",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"font-semibold",children:k.title}),e.jsx("div",{className:"opacity-70",children:k.status})]}),e.jsxs("div",{className:"opacity-80",children:[k.game," · ",k.mode==="firstto"?"FT":"BO"," ",k.value]}),e.jsx("div",{className:"mt-2",children:e.jsx("button",{className:"btn bg-red-600 hover:bg-red-700 text-xs",disabled:c,onClick:()=>mt(k.id),children:"Delete Tournament"})})]},k.id)),h.length===0&&e.jsx("li",{className:"opacity-60",children:"No tournaments."})]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold mb-2 text-red-400",children:"System Maintenance"}),e.jsx("div",{className:"space-y-2",children:e.jsxs("div",{className:"p-3 rounded bg-red-900/20 border border-red-500/40",children:[e.jsx("div",{className:"font-semibold text-red-400 mb-2",children:"Maintenance Mode"}),e.jsx("div",{className:"text-sm opacity-80 mb-3",children:"Put the entire site into maintenance mode. Users won't be able to access games or create matches."}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:`px-2 py-1 rounded text-xs ${r?.maintenance?"bg-red-600":"bg-green-600"}`,children:r?.maintenance?"MAINTENANCE ACTIVE":"NORMAL OPERATION"}),e.jsx("button",{className:`btn ${r?.maintenance?"bg-green-600 hover:bg-green-700":"bg-red-600 hover:bg-red-700"}`,disabled:c,onClick:()=>te(!r?.maintenance),children:r?.maintenance?"Disable":"Enable"})]})]})})]})]})]})]}),F==="premium"&&T&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"card",children:[e.jsx("h3",{className:"text-xl font-semibold mb-2",children:"Premium Subscription Grants"}),e.jsx("div",{className:"text-sm opacity-80 mb-3",children:"Grant or revoke premium subscriptions for users (grants 30 days)."}),e.jsxs("div",{className:"flex gap-2 mb-3",children:[e.jsx("input",{className:"input flex-1",placeholder:"user@example.com",value:i,onChange:k=>n(k.target.value)}),e.jsx("button",{className:"btn",disabled:c||!i.trim(),onClick:()=>Ge(i,30),children:"Grant"}),e.jsx("button",{className:"btn bg-rose-600 hover:bg-rose-700",disabled:c,onClick:()=>Re(i),children:"Revoke"})]}),e.jsx("div",{className:"text-sm opacity-80 mb-2",children:"Premium users get 30 days of access to all features."})]}),e.jsxs("div",{className:"card",children:[e.jsx("h3",{className:"text-xl font-semibold mb-2",children:"Premium Winners"}),e.jsx("div",{className:"text-sm opacity-80 mb-2",children:"Users who have won premium through tournaments."}),e.jsxs("div",{className:"space-y-2",children:[U.map(k=>e.jsxs("div",{className:"p-2 rounded bg-black/20 text-sm flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold",children:k.name||"No name"}),e.jsx("div",{className:"opacity-70",children:k.email}),e.jsxs("div",{className:"opacity-60 text-xs",children:["Expires ",new Date(k.expiresAt).toLocaleDateString()]})]}),e.jsx("div",{className:"flex gap-2",children:k.expired?e.jsx("span",{className:"px-2 py-1 rounded bg-amber-600 text-xs",children:"Premium Expired"}):e.jsx("span",{className:"px-2 py-1 rounded bg-emerald-600 text-xs",children:"Premium Active"})})]},k.email)),U.length===0&&e.jsx("div",{className:"opacity-60",children:"No premium winners."})]})]})]}),v.open&&e.jsxs("div",{className:"fixed inset-0 z-[1000]",onClick:()=>b({open:!1}),children:[e.jsx("div",{className:"absolute inset-0 bg-black/70 backdrop-blur-sm"}),e.jsx("div",{className:"absolute inset-0 p-4 md:p-8 overflow-auto flex items-start md:items-center justify-center",children:e.jsxs("div",{className:"w-full max-w-3xl bg-[#0b1020] rounded-2xl border border-indigo-500/40 shadow-2xl",onClick:k=>k.stopPropagation(),children:[e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b border-indigo-500/20",children:[e.jsxs("div",{className:"font-semibold",children:["Preview: ",v.kind]}),e.jsx("button",{className:"btn",onClick:()=>b({open:!1}),children:"Close"})]}),e.jsx("div",{className:"p-0 bg-black/30",children:e.jsx("iframe",{title:"Email Preview",style:{width:"100%",height:"70vh",border:"0",background:"transparent"},srcDoc:v.html||""})}),e.jsx("div",{className:"px-4 py-3 border-t border-indigo-500/20 text-xs opacity-70",children:"Click outside this panel or press Esc to close."})]})})]})]}):e.jsxs("div",{className:"card",children:[e.jsx("h2",{className:"text-2xl font-bold mb-2",children:"Admin"}),e.jsx("div",{className:"text-sm opacity-80",children:"You don’t have permission to manage admins."})]})}function vm({user:t}){const{favoriteDouble:a,callerEnabled:s,callerVoice:i,callerVolume:n,speakCheckoutOnly:r,avgMode:o,autoStartOffline:l,rememberLastOffline:d,reducedMotion:c,compactHeader:u,allowSpectate:h,cameraScale:x,cameraAspect:p,autoscoreProvider:g,autoscoreWsUrl:S,calibrationGuide:D,preferredCameraId:I,preferredCameraLabel:N,cameraEnabled:E,offlineLayout:A,textSize:O,boxSize:M,setFavoriteDouble:v,setCallerEnabled:b,setCallerVoice:F,setCallerVolume:z,setSpeakCheckoutOnly:T,setAvgMode:U,setAutoStartOffline:w,setRememberLastOffline:_,setReducedMotion:ie,setCompactHeader:R,setAllowSpectate:Z,setCameraScale:ae,setCameraAspect:Me,setAutoscoreProvider:st,setAutoscoreWsUrl:Se,setCalibrationGuide:Te,setPreferredCamera:dt,setCameraEnabled:ye,setOfflineLayout:We,setTextSize:Ve,setBoxSize:Ge}=is(),[Re,te]=m.useState([{key:"first180",label:"First 180",unlocked:!1,icon:"🎯",desc:"Score 180 in a match."},{key:"hundredGames",label:"100 Games Played",unlocked:!1,icon:"🏅",desc:"Play 100 games."},{key:"tournamentWin",label:"Tournament Winner",unlocked:!1,icon:"🥇",desc:"Win a tournament."},{key:"bestLeg",label:"Best Leg",unlocked:!1,icon:"⚡",desc:"Finish a leg in 12 darts or less."},{key:"comeback",label:"Comeback",unlocked:!1,icon:"🔥",desc:"Win after trailing by 3 legs."}]);m.useEffect(()=>{const H=t?.username||"";H&&te(Ne=>Ne.map(Ye=>({...Ye,unlocked:!!localStorage.getItem(`ndn:achieve:${Ye.key}:${H}`)})))},[t?.username]);const[at,fe]=m.useState(!1),[Pe,he]=m.useState(""),[ce,rt]=m.useState(""),[De,mt]=m.useState(""),[tt,ne]=m.useState(""),[de,ge]=m.useState(""),[me,ze]=m.useState(!0),[ke,lt]=m.useState(null),[yt,k]=m.useState([{text:"Hi! I'm your Nine Dart Nation assistant. How can I help you today?",isUser:!1}]),[ee,At]=m.useState("");m.useEffect(()=>{const H=t?.username||"";if(H)try{he(localStorage.getItem(`ndn:bio:favPlayer:${H}`)||""),rt(localStorage.getItem(`ndn:bio:favTeam:${H}`)||""),mt(localStorage.getItem(`ndn:bio:favDarts:${H}`)||""),ne(localStorage.getItem(`ndn:bio:bio:${H}`)||""),ge(localStorage.getItem(`ndn:bio:profilePhoto:${H}`)||""),ze(localStorage.getItem(`ndn:settings:allowAnalytics:${H}`)!=="false")}catch{}},[t?.username]),m.useEffect(()=>{t?.email&&kt(`/api/subscription?email=${encodeURIComponent(t.email)}`).then(H=>H.json()).then(lt).catch(()=>{})},[t?.email]);const Ae=()=>{const H=t?.username||"";if(H)try{localStorage.setItem(`ndn:bio:favPlayer:${H}`,Pe),localStorage.setItem(`ndn:bio:favTeam:${H}`,ce),localStorage.setItem(`ndn:bio:favDarts:${H}`,De),localStorage.setItem(`ndn:bio:bio:${H}`,tt),localStorage.setItem(`ndn:bio:profilePhoto:${H}`,de);try{window.dispatchEvent(new CustomEvent("ndn:avatar-updated",{detail:{username:H,avatar:de}}))}catch{}localStorage.setItem(`ndn:settings:allowAnalytics:${H}`,me.toString()),fe(!1)}catch{}},Mt=H=>{try{window.dispatchEvent(new CustomEvent("ndn:change-tab",{detail:{tab:H}}))}catch(Ne){console.error("Navigation failed:",Ne)}},Rt=H=>{const Ne=H.toLowerCase();return Ne.includes("username")||Ne.includes("change name")?{text:"You can change your username once for free.",links:[{text:"Go to Settings > Account",tab:"settings"}]}:Ne.includes("premium")||Ne.includes("upgrade")||Ne.includes("subscription")?{text:"Premium unlocks all game modes and features.",links:[{text:"Go to Online Play",tab:"online"}]}:Ne.includes("calibrat")||Ne.includes("camera")||Ne.includes("vision")?{text:"Set up your camera properly in Settings.",links:[{text:"Go to Settings > Camera & Vision",tab:"settings"}]}:Ne.includes("voice")||Ne.includes("caller")||Ne.includes("audio")?{text:"Enable voice calling in Settings.",links:[{text:"Go to Settings > Audio & Voice",tab:"settings"}]}:Ne.includes("friend")||Ne.includes("play together")?{text:"Add friends to play together.",links:[{text:"Go to Friends",tab:"friends"}]}:Ne.includes("stat")||Ne.includes("score")||Ne.includes("performance")?{text:"View your statistics and performance.",links:[{text:"Go to Stats",tab:"stats"}]}:Ne.includes("setting")||Ne.includes("customiz")||Ne.includes("configur")?{text:"Customize your experience.",links:[{text:"Go to Settings",tab:"settings"}]}:Ne.includes("tournament")||Ne.includes("competition")?{text:"Check out tournaments and competitions.",links:[{text:"Go to Tournaments",tab:"tournaments"}]}:Ne.includes("help")||Ne.includes("support")||Ne.includes("faq")?{text:"You're already in the help section! Check the Support section above for more resources.",links:[{text:"Scroll to Support",tab:"settings"}]}:Ne.includes("how to play")||Ne.includes("game")||Ne.includes("start")?{text:"To play darts, select a game mode from the menu. For online play, join a match. For offline, start a local game.",links:[{text:"Play Online",tab:"online"},{text:"Play Offline",tab:"offline"}]}:{text:"I'm not sure about that. Try asking about playing, calibration, premium, username changes, voice settings, friends, stats, or settings."}},Pt=()=>{if(!ee.trim())return;const H=ee.toLowerCase();k(Ye=>[...Ye,{text:ee,isUser:!0}]),At("");const Ne=Rt(H);setTimeout(()=>{k(Ye=>[...Ye,{text:Ne,isUser:!1}])},500)},[Oe,_t]=m.useState(""),[Et,Lt]=m.useState(!1),[ht,$t]=m.useState(""),[jt,Tt]=m.useState([]);return m.useEffect(()=>{const H=()=>{const Ne=speechSynthesis.getVoices();Tt(Ne.filter(Ye=>Ye.lang.startsWith("en")))};H(),speechSynthesis.onvoiceschanged=H},[]),e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"card",children:e.jsxs("div",{className:"p-3 rounded-xl border border-red-500/40 bg-red-500/10",children:[e.jsxs("div",{className:"font-semibold mb-4 flex items-center gap-2 text-black",children:[e.jsx(Ta,{className:"w-5 h-5"})," Account"]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"flex justify-center",children:e.jsx("button",{onClick:()=>window.dispatchEvent(new CustomEvent("ndn:logout")),className:"px-6 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium transition-colors",children:"Logout"})}),e.jsxs("div",{className:"border-t border-red-500/20 pt-3",children:[e.jsxs("div",{className:"font-medium mb-2 text-black",children:["Change Username (",(()=>{const H=t?.usernameChangeCount||0;return H<2?`${2-H} free changes remaining`:"£2 per change"})(),")"]}),e.jsx("div",{className:"text-sm text-black mb-2",children:"You can change your username up to 2 times for free. Additional changes cost £2 each."}),t?.usernameChangeCount>=2&&!Oe.trim()?e.jsx("div",{className:"text-amber-400 text-sm mb-2",children:"⚠️ Additional username changes cost £2"}):null,e.jsx("input",{className:"input w-full mb-2",type:"text",placeholder:"New username",value:Oe,onChange:H=>_t(H.target.value),disabled:Et}),ht&&e.jsx("div",{className:"text-red-400 text-sm mb-2",children:ht}),e.jsx("button",{onClick:async()=>{if($t(""),!Oe.trim()){$t("Username required");return}if(Oe.length<3||Oe.length>20){$t("Username must be 3-20 characters");return}(t?.usernameChangeCount||0)<2?(localStorage.setItem("pendingUsernameChange",Oe.trim()),window.location.href="/?username-change=free"):window.location.href="https://buy.stripe.com/eVq4gB3XqeNS0iw6vAfnO02"},disabled:Et||!Oe.trim(),className:"w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-600 text-white rounded-lg font-medium transition-colors",children:Et?"Processing...":(t?.usernameChangeCount||0)<2?"Change Username (FREE)":"Change Username (£2)"})]})]})]})}),ke&&e.jsx("div",{className:"card",children:e.jsxs("div",{className:"p-3 rounded-xl border border-green-500/40 bg-green-500/10",children:[e.jsxs("div",{className:"font-semibold mb-4 flex items-center gap-2 text-black",children:[e.jsx(fi,{className:"w-5 h-5"})," Premium"]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"text-sm",children:[e.jsxs("div",{className:"font-medium",children:["Status: ",ke.fullAccess?"Active":"Inactive"]}),ke.source&&e.jsxs("div",{className:"text-xs opacity-80",children:["Source: ",ke.source]}),ke.expiresAt&&e.jsxs("div",{className:"text-xs opacity-80",children:["Expires: ",new Date(ke.expiresAt).toLocaleDateString()]}),ke.renewalWarning&&e.jsxs("div",{className:"text-amber-600 text-xs mt-2 p-2 bg-amber-100 rounded",children:["⚠️ ",ke.renewalWarning]})]}),ke.source==="tournament"&&e.jsx("div",{className:"flex justify-center",children:e.jsx("button",{onClick:async()=>{if(confirm("Are you sure you want to cancel your premium subscription? You will lose access to premium features."))try{await kt("/api/admin/premium/revoke",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:t.email,requesterEmail:t.email})});const H=await kt(`/api/subscription?email=${encodeURIComponent(t.email)}`);lt(await H.json())}catch{alert("Failed to cancel premium. Please try again.")}},className:"px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium transition-colors",children:"Cancel Premium"})})]})]})}),e.jsx("div",{className:"card",children:e.jsxs("div",{className:"p-3 rounded-xl border border-indigo-500/40 bg-indigo-500/10",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{className:"font-semibold flex items-center gap-2",children:[e.jsx(Ta,{className:"w-5 h-5 text-brand-400"})," Profile Bio"]}),at?e.jsxs("button",{onClick:Ae,className:"flex items-center gap-2 px-3 py-1 bg-green-500/20 hover:bg-green-500/30 rounded-lg text-green-400 text-sm transition-colors",children:[e.jsx(Vl,{className:"w-4 h-4"})," Save"]}):e.jsxs("button",{onClick:()=>fe(!0),className:"flex items-center gap-2 px-3 py-1 bg-blue-500/20 hover:bg-blue-500/30 rounded-lg text-blue-400 text-sm transition-colors",children:[e.jsx(ql,{className:"w-4 h-4"})," Edit"]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block mb-1 text-sm font-medium",children:"Favourite Player:"}),at?e.jsx("input",{className:"input w-full",type:"text",value:Pe,onChange:H=>he(H.target.value),placeholder:"e.g. Michael van Gerwen"}):e.jsx("div",{className:"px-3 py-2 bg-slate-800/50 rounded-lg text-slate-300 min-h-[2.5rem] flex items-center",children:Pe||"Not set"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block mb-1 text-sm font-medium",children:"Favourite Football Team:"}),at?e.jsx("input",{className:"input w-full",type:"text",value:ce,onChange:H=>rt(H.target.value),placeholder:"e.g. Manchester United"}):e.jsx("div",{className:"px-3 py-2 bg-slate-800/50 rounded-lg text-slate-300 min-h-[2.5rem] flex items-center",children:ce||"Not set"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block mb-1 text-sm font-medium",children:"Favourite Darts:"}),at?e.jsx("input",{className:"input w-full",type:"text",value:De,onChange:H=>mt(H.target.value),placeholder:"e.g. Unicorn Phase 5, 24g"}):e.jsx("div",{className:"px-3 py-2 bg-slate-800/50 rounded-lg text-slate-300 min-h-[2.5rem] flex items-center",children:De||"Not set"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block mb-1 text-sm font-medium",children:"Short Bio / Quote:"}),at?e.jsx("textarea",{className:"input w-full",value:tt,onChange:H=>ne(H.target.value),placeholder:"Write something about yourself...",rows:3}):e.jsx("div",{className:"px-3 py-2 bg-slate-800/50 rounded-lg text-slate-300 min-h-[4rem] flex items-start",children:tt||"No bio set"})]})]})]})}),e.jsx("div",{className:"card",children:e.jsxs("div",{className:"p-3 rounded-xl border border-cyan-500/40 bg-cyan-500/10",children:[e.jsxs("div",{className:"font-semibold mb-2 flex items-center gap-2",children:[e.jsx(Ta,{className:"w-5 h-5 text-cyan-400"})," Profile Photo"]}),e.jsxs("div",{children:[de&&e.jsx("div",{className:"mb-2",children:e.jsx("img",{src:de,alt:"Profile",className:"w-16 h-16 rounded-full object-cover"})}),e.jsx("input",{type:"file",accept:"image/*",onChange:H=>{const Ne=H.target.files?.[0];if(Ne){const Ye=new FileReader;Ye.onload=Ht=>{const Ot=Ht.target?.result;ge(Ot);const $=t?.username||"";$&&localStorage.setItem(`ndn:bio:profilePhoto:${$}`,Ot);try{window.dispatchEvent(new CustomEvent("ndn:avatar-updated",{detail:{username:$,avatar:Ot}}))}catch{}},Ye.readAsDataURL(Ne)}},className:"hidden",id:"profile-photo-upload"}),e.jsx("label",{htmlFor:"profile-photo-upload",className:"btn bg-cyan-600 hover:bg-cyan-700 cursor-pointer",children:de?"Change Photo":"Upload Photo"})]})]})}),e.jsx("div",{className:"card",children:e.jsxs("div",{className:"p-3 rounded-xl border border-green-500/40 bg-green-500/10",children:[e.jsxs("div",{className:"font-semibold mb-4 flex items-center gap-2",children:[e.jsx(Gl,{className:"w-5 h-5 text-green-400"})," Game Preferences"]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block mb-2 text-sm font-medium",children:"Favourite Double:"}),e.jsxs("select",{className:"input w-full",value:a,onChange:H=>v(H.target.value),children:[e.jsx("option",{value:"any",children:"Any Double"}),e.jsx("option",{value:"D20",children:"Double 20"}),e.jsx("option",{value:"D19",children:"Double 19"}),e.jsx("option",{value:"D18",children:"Double 18"}),e.jsx("option",{value:"D17",children:"Double 17"}),e.jsx("option",{value:"D16",children:"Double 16"}),e.jsx("option",{value:"D15",children:"Double 15"}),e.jsx("option",{value:"D14",children:"Double 14"}),e.jsx("option",{value:"D13",children:"Double 13"}),e.jsx("option",{value:"D12",children:"Double 12"}),e.jsx("option",{value:"D11",children:"Double 11"}),e.jsx("option",{value:"D10",children:"Double 10"}),e.jsx("option",{value:"D9",children:"Double 9"}),e.jsx("option",{value:"D8",children:"Double 8"}),e.jsx("option",{value:"D7",children:"Double 7"}),e.jsx("option",{value:"D6",children:"Double 6"}),e.jsx("option",{value:"D5",children:"Double 5"}),e.jsx("option",{value:"D4",children:"Double 4"}),e.jsx("option",{value:"D3",children:"Double 3"}),e.jsx("option",{value:"D2",children:"Double 2"}),e.jsx("option",{value:"D1",children:"Double 1"}),e.jsx("option",{value:"DB",children:"Bullseye"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block mb-2 text-sm font-medium",children:"Average Display Mode:"}),e.jsxs("select",{className:"input w-full",value:o,onChange:H=>U(H.target.value),children:[e.jsx("option",{value:"all-time",children:"All Time Average"}),e.jsx("option",{value:"24h",children:"24 Hour Average"})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{type:"checkbox",id:"autoStartOffline",checked:l,onChange:H=>w(H.target.checked),className:"w-4 h-4"}),e.jsx("label",{htmlFor:"autoStartOffline",className:"text-sm",children:"Auto-start offline games"})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{type:"checkbox",id:"rememberLastOffline",checked:d,onChange:H=>_(H.target.checked),className:"w-4 h-4"}),e.jsx("label",{htmlFor:"rememberLastOffline",className:"text-sm",children:"Remember last offline game settings"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block mb-2 text-sm font-medium",children:"Offline Game Layout:"}),e.jsxs("select",{className:"input w-full",value:A||"classic",onChange:H=>We(H.target.value),children:[e.jsx("option",{value:"classic",children:"Classic Layout"}),e.jsx("option",{value:"modern",children:"Modern Layout"})]})]})]})]})}),e.jsx("div",{className:"card",children:e.jsxs("div",{className:"p-3 rounded-xl border border-purple-500/40 bg-purple-500/10",children:[e.jsxs("div",{className:"font-semibold mb-4 flex items-center gap-2",children:[e.jsx(Jl,{className:"w-5 h-5 text-purple-400"})," Audio & Voice"]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{type:"checkbox",id:"callerEnabled",checked:s,onChange:H=>b(H.target.checked),className:"w-4 h-4"}),e.jsx("label",{htmlFor:"callerEnabled",className:"text-sm font-medium",children:"Enable Voice Caller"})]}),s&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx("label",{className:"block mb-2 text-sm font-medium",children:"Voice:"}),e.jsx("select",{className:"input w-full",value:i,onChange:H=>F(H.target.value),children:jt.map(H=>e.jsxs("option",{value:H.name,children:[H.name," (",H.lang,")"]},H.name))}),e.jsx("button",{onClick:()=>{const H=new SpeechSynthesisUtterance("Test voice: 180 scored!");H.voice=jt.find(Ne=>Ne.name===i)||null,H.volume=n,speechSynthesis.speak(H)},className:"btn bg-blue-600 hover:bg-blue-700 mt-2",children:"Test Voice"})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block mb-2 text-sm font-medium",children:["Volume: ",Math.round(n*100),"%"]}),e.jsx("input",{type:"range",min:"0",max:"1",step:"0.1",value:n,onChange:H=>z(parseFloat(H.target.value)),className:"w-full"})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{type:"checkbox",id:"speakCheckoutOnly",checked:r,onChange:H=>T(H.target.checked),className:"w-4 h-4"}),e.jsx("label",{htmlFor:"speakCheckoutOnly",className:"text-sm",children:"Only announce checkouts"})]})]})]})]})}),e.jsx("div",{className:"card",children:e.jsxs("div",{className:"p-3 rounded-xl border border-blue-500/40 bg-blue-500/10",children:[e.jsxs("div",{className:"font-semibold mb-4 flex items-center gap-2",children:[e.jsx(go,{className:"w-5 h-5 text-blue-400"})," Camera & Vision"]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{type:"checkbox",id:"cameraEnabled",checked:E,onChange:H=>ye(H.target.checked),className:"w-4 h-4"}),e.jsx("label",{htmlFor:"cameraEnabled",className:"text-sm",children:"Enable camera for scoring"})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block mb-2 text-sm font-medium",children:["Camera Scale: ",x.toFixed(2),"x"]}),e.jsx("input",{type:"range",min:"0.5",max:"1.25",step:"0.05",value:x,onChange:H=>ae(parseFloat(H.target.value)),className:"w-full"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block mb-2 text-sm font-medium",children:"Camera Aspect Ratio:"}),e.jsxs("select",{className:"input w-full",value:p||"wide",onChange:H=>Me(H.target.value),children:[e.jsx("option",{value:"wide",children:"Wide (16:9)"}),e.jsx("option",{value:"square",children:"Square (1:1)"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block mb-2 text-sm font-medium",children:"Text Size:"}),e.jsxs("select",{className:"input w-full",value:O,onChange:H=>Ve(H.target.value),children:[e.jsx("option",{value:"small",children:"Small"}),e.jsx("option",{value:"medium",children:"Medium"}),e.jsx("option",{value:"large",children:"Large"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block mb-2 text-sm font-medium",children:"Box Size:"}),e.jsxs("select",{className:"input w-full",value:M,onChange:H=>Ge(H.target.value),children:[e.jsx("option",{value:"small",children:"Small"}),e.jsx("option",{value:"medium",children:"Medium"}),e.jsx("option",{value:"large",children:"Large"})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{type:"checkbox",id:"calibrationGuide",checked:D,onChange:H=>Te(H.target.checked),className:"w-4 h-4"}),e.jsx("label",{htmlFor:"calibrationGuide",className:"text-sm",children:"Show calibration guide"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block mb-2 text-sm font-medium",children:"Autoscore Provider:"}),e.jsxs("select",{className:"input w-full",value:g||"built-in",onChange:H=>st(H.target.value),children:[e.jsx("option",{value:"built-in",children:"Built-in Vision"}),e.jsx("option",{value:"manual",children:"Manual scoring only"}),e.jsx("option",{value:"external-ws",children:"External WebSocket"})]})]}),g==="manual"&&e.jsx("div",{className:"text-xs opacity-70",children:"Camera previews and autoscore overlays are hidden while manual scoring is selected. Use the score inputs or keyboard shortcuts to record each visit."}),g==="external-ws"&&e.jsxs("div",{children:[e.jsx("label",{className:"block mb-2 text-sm font-medium",children:"External WebSocket URL:"}),e.jsx("input",{className:"input w-full",type:"url",value:S||"",onChange:H=>Se(H.target.value),placeholder:"ws://localhost:8080"})]})]})]})}),e.jsx("div",{className:"card",children:e.jsxs("div",{className:"p-3 rounded-xl border border-orange-500/40 bg-orange-500/10",children:[e.jsxs("div",{className:"font-semibold mb-4 flex items-center gap-2",children:[e.jsx(yo,{className:"w-5 h-5 text-orange-400"})," UI & Accessibility"]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{type:"checkbox",id:"reducedMotion",checked:c,onChange:H=>ie(H.target.checked),className:"w-4 h-4"}),e.jsx("label",{htmlFor:"reducedMotion",className:"text-sm",children:"Reduce motion/animations"})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{type:"checkbox",id:"compactHeader",checked:u,onChange:H=>R(H.target.checked),className:"w-4 h-4"}),e.jsx("label",{htmlFor:"compactHeader",className:"text-sm",children:"Compact header layout"})]})]})]})}),e.jsx("div",{className:"card",children:e.jsxs("div",{className:"p-3 rounded-xl border border-pink-500/40 bg-pink-500/10",children:[e.jsxs("div",{className:"font-semibold mb-4 flex items-center gap-2",children:[e.jsx(Kl,{className:"w-5 h-5 text-pink-400"})," Online & Social"]}),e.jsx("div",{className:"space-y-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{type:"checkbox",id:"allowSpectate",checked:h,onChange:H=>Z(H.target.checked),className:"w-4 h-4"}),e.jsx("label",{htmlFor:"allowSpectate",className:"text-sm",children:"Allow others to spectate my games"})]})})]})}),e.jsx("div",{className:"card",children:e.jsxs("div",{className:"p-3 rounded-xl border border-yellow-500/40 bg-yellow-500/10",children:[e.jsxs("div",{className:"font-semibold mb-4 flex items-center gap-2 text-yellow-700",children:[e.jsx(On,{className:"w-5 h-5"})," Achievements & Badges"]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:Re.map(H=>e.jsxs("div",{className:`flex flex-col items-center p-3 rounded-xl border ${H.unlocked?"border-emerald-400 bg-emerald-500/10":"border-slate-400 bg-slate-700/10"}`,children:[e.jsx("div",{className:"text-3xl mb-2",children:H.icon}),e.jsx("div",{className:`font-bold mb-1 text-center ${H.unlocked?"text-emerald-400":"text-slate-400"}`,children:H.label}),e.jsx("div",{className:"text-xs text-slate-300 text-center mb-2",children:H.desc}),!H.unlocked&&e.jsx("div",{className:"text-xs text-amber-400 font-medium",children:"🔒 Locked"}),H.unlocked&&e.jsx("div",{className:"text-xs text-emerald-400 font-medium",children:"✅ Unlocked!"})]},H.key))})]})}),e.jsx("div",{className:"card",children:e.jsxs("div",{className:"p-3 rounded-xl border border-gray-500/40 bg-gray-500/10",children:[e.jsxs("div",{className:"font-semibold mb-4 flex items-center gap-2",children:[e.jsx(On,{className:"w-5 h-5 text-gray-400"})," Data & Privacy"]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{type:"checkbox",id:"allowAnalytics",checked:me,onChange:H=>ze(H.target.checked),className:"w-4 h-4"}),e.jsx("label",{htmlFor:"allowAnalytics",className:"text-sm",children:"Allow anonymous usage analytics"})]}),e.jsx("div",{children:e.jsx("button",{onClick:()=>{const H={username:t?.username,email:t?.email,favPlayer:Pe,favTeam:ce,favDarts:De,bio:tt,profilePhoto:de,settings:{favoriteDouble:a,avgMode:o,autoStartOffline:l,rememberLastOffline:d,reducedMotion:c,compactHeader:u,allowSpectate:h,cameraScale:x,cameraAspect:p,autoscoreProvider:g,autoscoreWsUrl:S,calibrationGuide:D,callerEnabled:s,callerVoice:i,callerVolume:n,speakCheckoutOnly:r,textSize:O}},Ne=new Blob([JSON.stringify(H,null,2)],{type:"application/json"}),Ye=URL.createObjectURL(Ne),Ht=document.createElement("a");Ht.href=Ye,Ht.download="ninedartnation-data.json",Ht.click(),URL.revokeObjectURL(Ye)},className:"btn bg-blue-600 hover:bg-blue-700",children:"Export My Data"})}),e.jsx("div",{children:e.jsx("button",{onClick:()=>{confirm("Are you sure you want to delete your account? This action cannot be undone.")&&alert("Account deletion not yet implemented. Please contact support.")},className:"btn bg-red-600 hover:bg-red-700",children:"Delete Account"})})]})]})}),e.jsx("div",{className:"card",children:e.jsxs("div",{className:"p-3 rounded-xl border border-red-500/40 bg-red-500/10",children:[e.jsxs("div",{className:"font-semibold mb-4 flex items-center gap-2",children:[e.jsx(fi,{className:"w-5 h-5 text-red-400"})," Privacy & Copyright Notice"]}),e.jsx("div",{className:"space-y-3 text-sm text-slate-300",children:e.jsxs("div",{className:"bg-red-500/20 border border-red-500/30 rounded-lg p-3",children:[e.jsx("p",{className:"font-semibold text-red-300 mb-2",children:"⚠️ IMPORTANT LEGAL NOTICE"}),e.jsxs("p",{className:"mb-2",children:[e.jsx("strong",{children:"Copyright Protection:"})," All code, assets, and intellectual property in Nine Dart Nation are protected by copyright law. Unauthorized copying, modification, or distribution of this software is strictly prohibited."]}),e.jsxs("p",{className:"mb-2",children:[e.jsx("strong",{children:"Legal Consequences:"})," Any attempt to edit, reverse-engineer, or redistribute this code will result in immediate legal action, including but not limited to copyright infringement lawsuits and potential criminal charges."]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Privacy:"})," Your personal data and gameplay information are protected. Any unauthorized access or data collection violates privacy laws and will be prosecuted to the full extent of the law."]})]})})]})}),e.jsx("div",{className:"card",children:e.jsxs("div",{className:"p-3 rounded-xl border border-teal-500/40 bg-teal-500/10",children:[e.jsxs("div",{className:"font-semibold mb-4 flex items-center gap-2",children:[e.jsx(On,{className:"w-5 h-5 text-teal-400"})," Support & Help"]}),e.jsx("div",{className:"space-y-4",children:e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-slate-300 mb-2",children:"Need help? Contact us:"}),e.jsx("a",{href:"mailto:support@ninedartnation.com",className:"btn bg-teal-600 hover:bg-teal-700",children:"Email Support"})]})})]})}),e.jsx("div",{className:"card",children:e.jsxs("div",{className:"p-3 rounded-xl border border-blue-500/40 bg-blue-500/10",children:[e.jsxs("div",{className:"font-semibold mb-4 flex items-center gap-2",children:[e.jsx(vo,{className:"w-5 h-5 text-blue-400"})," Help Assistant"]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"bg-slate-800 rounded-lg p-4 max-h-96 overflow-y-auto space-y-3",children:yt.map((H,Ne)=>e.jsx("div",{className:`flex ${H.isUser?"justify-end":"justify-start"}`,children:e.jsx("div",{className:`max-w-xs px-3 py-2 rounded-lg ${H.isUser?"bg-blue-600 text-white":"bg-slate-700 text-slate-200"}`,children:typeof H.text=="string"?H.text:e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{children:H.text.text}),H.text.links&&e.jsx("div",{className:"space-y-1",children:H.text.links.map((Ye,Ht)=>e.jsx("button",{onClick:()=>Mt(Ye.tab),className:"block w-full text-left text-blue-300 hover:text-blue-200 underline text-sm",children:Ye.text},Ht))})]})})},Ne))}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{type:"text",value:ee,onChange:H=>At(H.target.value),onKeyPress:H=>H.key==="Enter"&&Pt(),placeholder:"Ask me anything...",className:"flex-1 input"}),e.jsx("button",{onClick:Pt,className:"btn bg-blue-600 hover:bg-blue-700",children:e.jsx(jo,{className:"w-4 h-4"})})]})]})]})})]})}const jm={};function Nm({onAuth:t}){const[a,s]=m.useState("signin"),[i,n]=m.useState(""),[r,o]=m.useState(""),[l,d]=m.useState(""),[c,u]=m.useState(""),[h,x]=m.useState(""),[p,g]=m.useState(!1),[S,D]=m.useState(!1),I="http://localhost:8787";async function N(M){if(M.preventDefault(),x(""),D(!0),!r||!l){x("Username and password required."),D(!1);return}try{const v=await fetch(`${I}/api/auth/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:r,password:l})}),b=await v.json();v.ok&&b?.user&&b?.token?(localStorage.setItem("authToken",b.token),t(b.user)):x(b?.error||"Invalid username or password.")}catch{x("Network error.")}finally{D(!1)}}async function E(M){if(M.preventDefault(),x(""),D(!0),!i||!r||!l){x("Email, username, and password required."),D(!1);return}try{const v=await fetch(`${I}/api/auth/signup`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:i,username:r,password:l})}),b=await v.json();v.ok&&b?.user&&b?.token?(localStorage.setItem("authToken",b.token),t(b.user)):x(b?.error||"Signup failed.")}catch{x("Network error.")}finally{D(!1)}}async function A(M){if(M.preventDefault(),x(""),D(!0),!i||!i.includes("@")){x("Enter your email address."),D(!1);return}try{const b=await(await fetch(`${I}/api/auth/send-reset`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:i})})).json();if(!b?.ok)throw new Error(b?.error||"Failed to send reset email");x("Password reset link sent to your email.")}catch(v){x(v?.message||"Failed to send reset email")}finally{D(!1)}}async function O(M){if(M.preventDefault(),x(""),D(!0),!i||!i.includes("@")){x("Enter your email address."),D(!1);return}try{const b=await(await fetch(`${I}/api/auth/send-username`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:i})})).json();if(!b?.ok)throw new Error(b?.error||"Failed to send username email");x("Your username has been emailed to you.")}catch(v){x(v?.message||"Failed to send username email")}finally{D(!1)}}return e.jsxs("div",{className:"min-h-screen flex items-center justify-center relative overflow-hidden",children:[e.jsx("div",{className:"background-animated"}),e.jsxs("div",{className:"relative z-10 w-full max-w-5xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-6 p-4",children:[e.jsxs("form",{className:"card w-full space-y-4",onSubmit:a==="signin"?N:a==="signup"?E:A,children:[e.jsxs("div",{className:"flex flex-col items-center justify-center gap-2 mb-2 text-center",children:[e.jsx("h1",{className:"logo text-center",children:"NINE-DART-NATION 🎯"}),e.jsx("span",{className:"badge",children:"Welcome"})]}),e.jsx("h2",{className:"text-2xl font-bold",children:a==="signin"?"Sign In":a==="signup"?"Create Account":"Reset Password"}),(a==="signup"||a==="reset")&&e.jsx("input",{className:"input w-full",type:"email",placeholder:"Email",value:i,onChange:M=>n(M.target.value),required:!0}),a!=="reset"&&e.jsx("input",{className:"input w-full",type:"text",placeholder:"Username",value:r,onChange:M=>o(M.target.value),required:!0}),a!=="reset"&&e.jsxs("div",{className:"relative",children:[e.jsx("input",{className:"input w-full pr-10",type:p?"text":"password",placeholder:"Password",value:l,onChange:M=>d(M.target.value),autoComplete:"current-password",required:!0,onFocus:()=>g(!1),onBlur:()=>g(!1)}),e.jsx("button",{type:"button",className:"absolute right-2 top-1/2 -translate-y-1/2 text-slate-300 hover:text-white",tabIndex:-1,onMouseDown:M=>{M.preventDefault(),g(!0)},onMouseUp:M=>{M.preventDefault(),g(!1)},onMouseLeave:()=>g(!1),onTouchStart:M=>{M.preventDefault(),g(!0)},onTouchEnd:M=>{M.preventDefault(),g(!1)},"aria-label":"Toggle password visibility",children:p?e.jsx(Yl,{className:"w-5 h-5"}):e.jsx(yo,{className:"w-5 h-5"})})]}),a==="signup"&&e.jsx("input",{className:"input w-full",type:"text",placeholder:"Password Reminder (optional)",value:c,onChange:M=>u(M.target.value)}),h&&e.jsx("div",{className:"text-red-400 font-semibold text-sm",children:h}),e.jsx("button",{className:"btn w-full",type:"submit",disabled:S,children:S?"Signing In...":a==="signin"?"Sign In":a==="signup"?"Sign Up":"Send Reset Link"}),a==="reset"&&e.jsx("button",{className:"btn w-full mt-2 bg-white/10 hover:bg-white/20",type:"button",onClick:O,disabled:S,children:"Email me my username"}),e.jsxs("div",{className:"flex justify-between text-sm mt-2",children:[e.jsx("button",{type:"button",className:"underline",onClick:()=>s(a==="signin"?"signup":"signin"),disabled:S,children:a==="signin"?"Need an account? Sign Up":"Already have an account? Sign In"}),e.jsx("button",{type:"button",className:"underline",onClick:()=>s("reset"),disabled:S,children:"Forgot password?"})]})]}),e.jsxs("aside",{className:"card w-full",children:[e.jsx("h3",{className:"text-xl font-bold mb-3",children:"What’s inside"}),e.jsxs("ul",{className:"space-y-3",children:[e.jsxs("li",{className:"flex items-start gap-3",children:[e.jsx(br,{className:"w-5 h-5 text-indigo-300 mt-1"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold",children:"Online & Friends"}),e.jsx("div",{className:"text-sm text-slate-200/90",children:"Challenge friends, chat, and join leagues."})]})]}),e.jsxs("li",{className:"flex items-start gap-3",children:[e.jsx(Xl,{className:"w-5 h-5 text-indigo-300 mt-1"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold",children:"Deep Stats"}),e.jsx("div",{className:"text-sm text-slate-200/90",children:"Track 3-dart averages, best legs, and more."})]})]}),e.jsxs("li",{className:"flex items-start gap-3",children:[e.jsx(na,{className:"w-5 h-5 text-indigo-300 mt-1"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold",children:"Game Modes"}),e.jsx("div",{className:"text-sm text-slate-200/90",children:"Start with 3 free online games upon signup. After that, PREMIUM is required to play all games."})]})]}),e.jsxs("li",{className:"flex items-start gap-3",children:[e.jsx(Ql,{className:"w-5 h-5 text-indigo-300 mt-1"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold",children:"Premium Perks"}),e.jsx("div",{className:"text-sm text-slate-200/90",children:"Polished UI, upcoming features, and early access."})]})]})]}),e.jsxs("a",{href:jm?.VITE_DISCORD_INVITE_URL||"https://discord.gg/8GtbZ6RU",target:"_blank",rel:"noopener noreferrer",className:"btn mt-4 flex items-center justify-center gap-2",children:[e.jsx(an,{className:"w-5 h-5"})," Join BullseyeDartsLeague"]}),e.jsxs("a",{href:"https://discord.gg/NineDartNation",target:"_blank",rel:"noopener noreferrer",className:"btn mt-2 flex items-center justify-center gap-2 bg-white/10 hover:bg-white/20",children:[e.jsx(an,{className:"w-5 h-5"})," Join NineDartNation"]})]})]})]})}const wm=m.createContext({theme:"default",setTheme:t=>{}}),xo="ndn_theme";function Sm({children:t}){const[a,s]=m.useState("default");return m.useEffect(()=>{try{const i=localStorage.getItem(xo);i&&s(i)}catch{}},[]),m.useEffect(()=>{try{localStorage.setItem(xo,a)}catch{}},[a]),e.jsx(wm.Provider,{value:{theme:a,setTheme:s},children:e.jsx("div",{className:`theme-${a}`,children:t})})}const ul=m.createContext(null);function Cm({children:t}){const[a,s]=m.useState(!1),[i,n]=m.useState("connecting"),r=m.useRef(null),o=m.useRef(new Set),l=m.useRef(!0),d=m.useRef(0),c=m.useRef(null),u=m.useRef(null),h=m.useRef(null),x=m.useRef(0),p=()=>{if(h.current)return h.current;const A="ws://localhost:8787";if(A.length>0){const F=A.endsWith("/ws")?A:A.replace(/\/$/,"")+"/ws";return h.current=[F],h.current}const O=window.location.protocol==="https:"?"wss":"ws",M=window.location.hostname,b=[`${O}://${window.location.host}`+"/ws",`${O}://${M}/ws`,`${O}://${M}:8787/ws`,`${O}://${M}:3000/ws`];return h.current=Array.from(new Set(b)),h.current},g=()=>{const A=p();return x.current=(x.current+1)%A.length,A[x.current]},S=()=>{const A=p();return A[x.current]||A[0]},D=m.useCallback(()=>{if(r.current&&(r.current.readyState===WebSocket.OPEN||r.current.readyState===WebSocket.CONNECTING))return;n("connecting");const O=`${S()}`,M=new WebSocket(O);r.current=M,M.onopen=()=>{s(!0),n("connected"),d.current=0,u.current&&clearInterval(u.current),u.current=setInterval(()=>{try{r.current?.readyState===WebSocket.OPEN&&r.current?.send(JSON.stringify({type:"ping",t:Date.now()}))}catch{}},2e4)},M.onmessage=v=>{try{const b=JSON.parse(v.data);o.current.forEach(F=>{try{F(b)}catch{}})}catch{}},M.onerror=()=>{},M.onclose=()=>{if(s(!1),n("disconnected"),u.current&&(clearInterval(u.current),u.current=null),!l.current)return;const v=(d.current||0)+1;d.current=v,v%2===0&&g();const b=1e3*Math.pow(2,v-1),F=Math.floor(Math.random()*1e3);let z=Math.min(3e4,b+F);v===1&&(z=0),c.current&&clearTimeout(c.current),z===0?D():c.current=setTimeout(D,z)}},[]);m.useEffect(()=>{l.current=!0,D();const A=()=>{l.current=!1;try{r.current?.close()}catch{}};window.addEventListener("beforeunload",A);const O=()=>{document.visibilityState==="visible"&&(a||D())};return document.addEventListener("visibilitychange",O),window.addEventListener("online",D),()=>{l.current=!1,c.current&&clearTimeout(c.current),u.current&&clearInterval(u.current);try{r.current?.close()}catch{}document.removeEventListener("visibilitychange",O),window.removeEventListener("online",D),window.removeEventListener("beforeunload",A)}},[D]);const I=m.useCallback(A=>{try{r.current&&r.current.readyState===WebSocket.OPEN&&r.current.send(typeof A=="string"?A:JSON.stringify(A))}catch{}},[]),N=m.useCallback(A=>(o.current.add(A),()=>{o.current.delete(A)}),[]),E=m.useMemo(()=>({connected:a,status:i,send:I,addListener:N}),[a,i,I,N]);return e.jsx(ul.Provider,{value:E,children:t})}function Lr(){const t=m.useContext(ul);if(!t)throw new Error("useWS must be used within WSProvider");return t}function km({status:t,title:a,size:s=12}){const i=s;return t==="connecting"?e.jsx("span",{role:"img","aria-label":"Connecting",title:a||"Connecting…",className:"inline-flex items-center justify-center",style:{width:i,height:i},children:e.jsxs("svg",{width:i,height:i,viewBox:"0 0 24 24",className:"animate-spin","aria-hidden":"true",children:[e.jsx("circle",{cx:"12",cy:"12",r:"10",stroke:"#A7F3D0",strokeWidth:"3",fill:"none",opacity:"0.35"}),e.jsx("path",{d:"M22 12a10 10 0 0 0-10-10",stroke:"#34D399",strokeWidth:"3",strokeLinecap:"round",fill:"none"})]})}):t==="connected"?e.jsx("span",{role:"img","aria-label":"Connected",title:a||"Connected",className:"inline-flex items-center justify-center",style:{width:i,height:i},children:e.jsx("svg",{width:i,height:i,viewBox:"0 0 24 24","aria-hidden":"true",children:e.jsx("circle",{cx:"12",cy:"12",r:"10",fill:"#34D399"})})}):e.jsx("span",{role:"img","aria-label":"Disconnected",title:a||"Not connected",className:"inline-flex items-center justify-center",style:{width:i,height:i},children:e.jsxs("svg",{width:i,height:i,viewBox:"0 0 24 24","aria-hidden":"true",children:[e.jsx("circle",{cx:"12",cy:"12",r:"10",fill:"#F87171",opacity:"0.15"}),e.jsx("circle",{cx:"12",cy:"12",r:"9",stroke:"#F87171",strokeWidth:"2",fill:"none"}),e.jsx("rect",{x:"6",y:"11",width:"12",height:"2",rx:"1",fill:"#F87171"})]})})}const hl="ndn:blocked:v1";function Em(){try{const t=localStorage.getItem(hl);return t?JSON.parse(t):{}}catch{return{}}}function po(t){try{localStorage.setItem(hl,JSON.stringify(t))}catch{}}const Tm=Zs((t,a)=>({blocked:Em(),isBlocked:s=>!!a().blocked[(s||"").toLowerCase()],block:s=>t(i=>{const n={...i.blocked};return n[(s||"").toLowerCase()]=Date.now(),po(n),{blocked:n}}),unblock:s=>t(i=>{const n={...i.blocked};return delete n[(s||"").toLowerCase()],po(n),{blocked:n}}),all:()=>Object.keys(a().blocked)}));function Im({user:t}){const a="http://localhost:8787",s=wn(),i=(()=>{try{return Lr()}catch{return null}})(),n=Tm(),[r,o]=m.useState("room-1"),[l,d]=m.useState(!1),[c,u]=m.useState([]),[h,x]=m.useState(!1),[p,g]=m.useState(!1),S=m.useRef(null),[D,I]=m.useState(null),N=m.useRef(null),E=m.useRef(0),A=m.useRef(null),O=m.useRef(!0),M=m.useRef(0),v=m.useRef(!1),b=Bn(),F=Er(),{favoriteDouble:z,callerEnabled:T,callerVoice:U,callerVolume:w,speakCheckoutOnly:_,allowSpectate:ie,cameraScale:R,setCameraScale:Z,cameraEnabled:ae,textSize:Me,boxSize:st,autoscoreProvider:Se}=is(),Te=Se==="manual",ye=(f=>{switch(f){case"small":return"px-1.5 py-0.5 text-xs";case"large":return"px-3 py-1 text-sm";default:return"px-2 py-0.5 text-sm"}})(Me),[We,Ve]=m.useState(2),[Ge,Re]=m.useState(!1),[te,at]=m.useState([]),[fe,Pe]=m.useState(0),[he,ce]=m.useState(0),[rt,De]=m.useState(0),[mt,tt]=m.useState(0),[ne,de]=m.useState(""),[ge,me]=m.useState(0),[ze,ke]=m.useState(0),[lt,yt]=m.useState(""),[k,ee]=m.useState(null),[At,Ae]=m.useState(null),Mt=m.useRef(null),[Rt,Pt]=m.useState(""),[Oe,_t]=m.useState({}),[Et,Lt]=m.useState({}),[ht,$t]=m.useState({}),[jt,Tt]=m.useState({}),[H,Ne]=m.useState({}),[Ye,Ht]=m.useState({}),[Ot,$]=m.useState({}),[J,ue]=m.useState({}),[le,Xe]=m.useState(()=>kr()),[Le,je]=m.useState(0),[$e,Bt]=m.useState(()=>{try{const f=navigator.userAgent||"";return/Android|iPhone|iPad|iPod|Mobile/i.test(f)}catch{return!1}}),[it,nt]=m.useState(null),Ps=m.useRef(null),Es=m.useRef(null);function dn(){try{if(!Es.current){const f=window.AudioContext||window.webkitAudioContext;f&&(Es.current=new f)}Es.current?.resume?.().catch(()=>{})}catch{}}function Ts(f,j,C=0,P=.05){const Q=Es.current;if(!Q)return;const re=Q.createOscillator(),oe=Q.createGain();re.type="square",re.frequency.value=f,oe.gain.value=P,re.connect(oe),oe.connect(Q.destination);const W=Q.currentTime+C;re.start(W),re.stop(W+j/1e3)}function Fs(f){dn(),Es.current&&(f==="180"?(Ts(880,110,0,.06),Ts(1175,110,.06,.06),Ts(1568,140,.12,.06)):(Ts(659,140,0,.07),Ts(784,140,.08,.07),Ts(987,200,.16,.07)))}function Vt(f,j){const C=Date.now(),P=Ps.current;P&&P.kind===f&&P.by===j&&C-P.ts<500||(Ps.current={kind:f,by:j,ts:C},nt({kind:f,by:j,turnIdx:b.currentPlayerIdx,ts:C}),Fs(f))}const[mn,os]=m.useState(!1),[B,X]=m.useState([]),[K,q]=m.useState("bestof"),[V,Ce]=m.useState(5),[pe,Fe]=m.useState(501),[be,ot]=m.useState(null),[Nt,vt]=m.useState("");function It(f){vt(f),setTimeout(()=>vt(""),4e3);try{s(f||"Stripe checkout failed",{type:"error"})}catch{}}const[wt,Is]=m.useState(null),[us,ls]=m.useState(null),[ft,Ms]=m.useState("X01"),[ve,Yt]=m.useState("X01"),[Xt,Gt]=m.useState(!1),hs=t?.username&&!t?.fullAccess?So(t.username):1/0,Jt=!t?.fullAccess&&hs<=0,[fs,ct]=m.useState("all"),[Wt,xs]=m.useState("all"),[Zt,Ds]=m.useState("all"),[ts,Ls]=m.useState(!1),[Dt,ss]=m.useState(10),{H:ps}=ha(),un=t?.username?Xs(t.username):0,cs=Er(f=>f.unread),Kt=(B||[]).filter(f=>!(fs!=="all"&&f.mode!==fs||Wt!=="all"&&Number(f.startingScore)!==Number(Wt)||Zt!=="all"&&f.game!==Zt||ts&&(!un||!f.creatorAvg||Math.abs(Number(f.creatorAvg)-Number(un))>Dt)));m.useEffect(()=>{const f=j=>{const C=j?.detail||{};C.game&&Ms(C.game),(C.mode==="bestof"||C.mode==="firstto")&&q(C.mode),typeof C.value=="number"&&isFinite(C.value)&&Ce(Math.max(1,Math.floor(C.value))),typeof C.start=="number"&&isFinite(C.start)&&Fe(Math.max(1,Math.floor(C.start))),os(!0)};return window.addEventListener("ndn:online-demo",f),()=>window.removeEventListener("ndn:online-demo",f)},[]),m.useEffect(()=>{const f=String(t?.email||"").toLowerCase();f&&kt(`/api/friends/messages?email=${encodeURIComponent(f)}`).then(j=>j.json()).then(j=>{j?.ok&&Array.isArray(j.messages)&&F.load(j.messages)}).catch(()=>{})},[t?.email]),m.useEffect(()=>{const f=j=>{try{const C=j?.detail||{},P=Number(C.start||501);b.newMatch([t?.username||"You","Opponent"],P,r),b.addVisit(60,3),b.nextPlayer(),b.addVisit(85,3),b.nextPlayer(),b.addVisit(100,3),Yt("X01"),Re(!0)}catch{}};return window.addEventListener("ndn:online-match-demo",f),()=>window.removeEventListener("ndn:online-match-demo",f)},[]),m.useEffect(()=>(O.current=!0,js(),()=>{O.current=!1,A.current&&clearTimeout(A.current);try{N.current?.close()}catch{}}),[]),m.useEffect(()=>{F.setInGame(b.inProgress)},[b.inProgress]),m.useEffect(()=>{it&&b.currentPlayerIdx!==it.turnIdx&&nt(null)},[b.currentPlayerIdx,it?.turnIdx]),m.useEffect(()=>{try{i&&i.connected?i.send({type:"presence",username:t?.username||"guest",email:(t?.email||"").toLowerCase(),allowSpectate:ie}):N.current&&N.current.readyState===WebSocket.OPEN&&N.current.send(JSON.stringify({type:"presence",username:t?.username||"guest",email:(t?.email||"").toLowerCase(),allowSpectate:ie}))}catch{}},[ie,i?.connected]),m.useEffect(()=>{const f=j=>{const C=j?.detail?.roomId;C&&(o(C),i?i.send({type:"spectate",roomId:C}):N.current?.send(JSON.stringify({type:"spectate",roomId:C})),Re(!0),os(!1))};return window.addEventListener("ndn:spectate-room",f),()=>window.removeEventListener("ndn:spectate-room",f)},[i]);function js(){if(i){i.connected&&(i.send({type:"join",roomId:r}),i.send({type:"presence",username:t?.username||"guest",email:(t?.email||"").toLowerCase(),allowSpectate:ie}),i.send({type:"list-matches"}),d(!0));return}try{if(N.current&&(N.current.readyState===WebSocket.OPEN||N.current.readyState===WebSocket.CONNECTING))return}catch{}const f="ws://localhost:8787",j=window.location.protocol==="https:"?"wss":"ws",C=window.location.hostname,P=`${j}://${C}${window.location.port?"":":8787"}`,Q=f.length>0?f:P,re=new WebSocket(Q);N.current=re,re.onopen=()=>{d(!0),E.current=0,v.current?s("Reconnected to lobby",{type:"success"}):(s("Connected to lobby",{type:"success"}),v.current=!0),re.send(JSON.stringify({type:"join",roomId:r})),re.send(JSON.stringify({type:"presence",username:t?.username||"guest",email:(t?.email||"").toLowerCase(),allowSpectate:ie})),re.send(JSON.stringify({type:"list-matches"}))},re.onmessage=oe=>{const W=JSON.parse(oe.data);if(W.type==="state"){b.importState(W.payload);const Qe=Number(W.payload._dpIndex),zt=Number(W.payload._dpHits);Number.isFinite(Qe)&&De(Math.max(0,Qe)),Number.isFinite(zt)&&tt(Math.max(0,zt));const as=Number(W.payload._atcIndex),rs=Number(W.payload._atcHits);Number.isFinite(as)&&me(Math.max(0,as)),Number.isFinite(rs)&&ke(Math.max(0,rs));try{const Ue=W.payload._cricketById;Ue&&typeof Ue=="object"&&_t(Ue)}catch{}try{const Ue=W.payload._shanghaiById;Ue&&typeof Ue=="object"&&Lt(Ue)}catch{}try{const Ue=W.payload._halveById;Ue&&typeof Ue=="object"&&$t(Ue)}catch{}try{const Ue=W.payload._highlowById;Ue&&typeof Ue=="object"&&Tt(Ue)}catch{}try{const Ue=W.payload._killerById;Ue&&typeof Ue=="object"&&Ne(Ue)}catch{}try{const Ue=W.payload._amCricketById;Ue&&typeof Ue=="object"&&Ht(Ue)}catch{}try{const Ue=W.payload._baseballById;Ue&&typeof Ue=="object"&&$(Ue)}catch{}try{const Ue=W.payload._golfById;Ue&&typeof Ue=="object"&&ue(Ue)}catch{}try{const Ue=W.payload._tttState;Ue&&typeof Ue=="object"&&Xe(Ue)}catch{}try{const Ue=Number(W.payload._turnDarts);Number.isFinite(Ue)&&je(Math.max(0,Ue))}catch{}}else if(W.type==="joined")W.id&&I(W.id);else if(W.type==="presence"||W.type==="peer-joined")at(Qe=>{const zt=new Set(Qe);return W.id&&zt.add(W.id),Array.from(zt)});else if(W.type==="chat"){const Qe=!!(W.from&&D&&W.from===D),zt=Qe?t?.username||"me":W.from||"peer",as=String(W.from||"");if(!Qe&&as&&n.isBlocked(as))return;if(Qe&&S.current&&String(W.message||"")===S.current.text){S.current=null;return}u(rs=>[...rs,{from:zt,message:W.message,fromId:as||void 0}])}else if(W.type==="matches")X(Array.isArray(W.matches)?W.matches:[]);else if(W.type==="invite")ot({matchId:W.matchId,fromId:W.fromId,fromName:W.fromName,calibrated:!!W.calibrated,boardPreview:W.boardPreview||null,game:W.game,mode:W.mode,value:W.value,startingScore:W.startingScore});else if(W.type==="match-start")o(W.roomId),re.send(JSON.stringify({type:"join",roomId:W.roomId})),Re(!0),os(!1),W.match?.game&&Yt(W.match.game),t?.username&&!t?.fullAccess&&gi(t.username);else if(W.type==="declined")s("Invite declined",{type:"info"});else if(W.type==="error"){const Qe=typeof W.message=="string"?W.message:"Action not allowed";if(vt(Qe),W.code==="SPECTATE_NOT_ALLOWED")try{s("This player has spectating turned off.",{type:"error"})}catch{}W.code==="NOT_FOUND"&&wt&&ls({game:wt.game,mode:wt.mode,value:wt.value,startingScore:wt.startingScore}),setTimeout(()=>vt(""),3500)}else if(W.type==="friend-invite")confirm(`${W.fromName||W.fromEmail} invited you to play ${W.game||"X01"} (${W.mode==="firstto"?"First To":"Best Of"} ${W.value||1}). Accept?`)?re.send(JSON.stringify({type:"start-friend-match",toEmail:W.fromEmail,game:W.game,mode:W.mode,value:W.value,startingScore:W.startingScore})):s("Invite declined",{type:"info"});else if(W.type==="friend-message")F.add({id:W.id||`${W.ts}-${W.from}`,from:W.from,message:W.message,ts:W.ts||Date.now()}),b.inProgress||s(`${W.from}: ${W.message}`,{type:"info"});else if(W.type==="celebration"){const Qe=W.by||"Player",zt=W.kind==="leg"?"leg":"180";Vt(zt,Qe)}else if(W.type==="cam-code")console.log("Received cam-code:",W.code),ee(W.code),s(`Pairing code: ${W.code}`,{type:"info"});else if(W.type==="cam-peer-joined")console.log("Mobile peer joined for code:",W.code),Tn(W.code);else if(W.type==="cam-answer"){console.log("Received cam-answer");const Qe=window.mobilePC;Qe&&Qe.setRemoteDescription(new RTCSessionDescription(W.payload))}else if(W.type==="cam-ice"){console.log("Received cam-ice");const Qe=window.mobilePC;Qe&&Qe.addIceCandidate(W.payload)}},re.onclose=()=>{if(d(!1),!O.current)return;const oe=(E.current||0)+1;E.current=oe;const W=Math.min(3e4,1e3*Math.pow(2,oe-1)),Qe=Date.now();Qe-M.current>4e3&&(s(`Disconnected. Reconnecting in ${Math.round(W/1e3)}s...`,{type:"error"}),M.current=Qe),A.current&&clearTimeout(A.current),A.current=setTimeout(()=>{js()},W)}}function qe(){const f=b.players||[],j=b.currentPlayerIdx||0,C=f[j],P=C?.legs?.[C?.legs?.length-1],Q=P?P.totalScoreRemaining:b.startingScore,re=P?.dartsThrown||0,oe=P?P.totalScoreStart-P.totalScoreRemaining:0,W=re>0?oe/re*3:0,Qe=P?.visits?.[P.visits.length-1]?.score??0;let zt="ÔÇö";f.length===2?zt=`${f[0]?.legsWon||0}-${f[1]?.legsWon||0}`:f.length>2&&(zt=f.map(Cs=>`${Cs.name}:${Cs.legsWon||0}`).join(" = "));const as=b.bestLegThisMatch,rs=as?`${as.darts} darts${(()=>{const Cs=f.find(Dn=>Dn.id===as.playerId);return Cs?` (${Cs.name})`:""})()}`:"-",In=(Cs=>{switch(Cs){case"small":return"text-xs";case"large":return"text-base";default:return"text-sm"}})(Me),Mn=(Cs=>{switch(Cs){case"small":return"p-2";case"large":return"p-4";default:return"p-3"}})(st);return e.jsxs("div",{className:`${Mn} rounded-2xl bg-slate-900/40 border border-white/10 text-white ${In}`,children:[e.jsx("div",{className:"font-semibold mb-2",children:"Match Summary"}),e.jsxs("div",{className:"grid grid-cols-2 gap-y-1",children:[e.jsx("div",{className:"opacity-80",children:"Current score"}),e.jsx("div",{className:"font-mono text-right",children:zt}),e.jsx("div",{className:"opacity-80",children:"Current thrower"}),e.jsx("div",{className:"text-right font-semibold",children:C?.name||"ÔÇö"}),e.jsx("div",{className:"opacity-80",children:"Score remaining"}),e.jsx("div",{className:"text-right font-mono font-bold text-lg",children:Q}),e.jsx("div",{className:"opacity-80",children:"3-dart avg"}),e.jsx("div",{className:"text-right font-mono",children:W.toFixed(1)}),e.jsx("div",{className:"opacity-80",children:"Last score"}),e.jsx("div",{className:"text-right font-mono",children:Qe}),e.jsx("div",{className:"opacity-80",children:"Best leg"}),e.jsx("div",{className:"text-right",children:rs})]})]})}m.useEffect(()=>{if(!i)return;d(i.connected);const f=i.addListener(j=>{try{if(j.type==="state"){b.importState(j.payload);try{const C=Number(j.payload._dpIndex),P=Number(j.payload._dpHits);Number.isFinite(C)&&De(Math.max(0,C)),Number.isFinite(P)&&tt(Math.max(0,P))}catch{}try{const C=Number(j.payload._atcIndex),P=Number(j.payload._atcHits);Number.isFinite(C)&&me(Math.max(0,C)),Number.isFinite(P)&&ke(Math.max(0,P))}catch{}try{const C=j.payload._cricketById;C&&typeof C=="object"&&_t(C)}catch{}try{const C=j.payload._shanghaiById;C&&typeof C=="object"&&Lt(C)}catch{}try{const C=j.payload._halveById;C&&typeof C=="object"&&$t(C)}catch{}try{const C=j.payload._highlowById;C&&typeof C=="object"&&Tt(C)}catch{}try{const C=j.payload._killerById;C&&typeof C=="object"&&Ne(C)}catch{}try{const C=j.payload._amCricketById;C&&typeof C=="object"&&Ht(C)}catch{}try{const C=j.payload._baseballById;C&&typeof C=="object"&&$(C)}catch{}try{const C=j.payload._golfById;C&&typeof C=="object"&&ue(C)}catch{}try{const C=j.payload._tttState;C&&typeof C=="object"&&Xe(C)}catch{}try{const C=Number(j.payload._turnDarts);Number.isFinite(C)&&je(Math.max(0,C))}catch{}}else if(j.type==="joined")j.id&&I(j.id);else if(j.type==="presence"||j.type==="peer-joined")at(C=>Array.from(new Set([...C||[],j.id].filter(Boolean))));else if(j.type==="chat"){const C=!!(j.from&&D&&j.from===D),P=C?t?.username||"me":j.from||"peer",Q=String(j.from||"");if(!C&&Q&&n.isBlocked(Q))return;u(re=>[...re,{from:P,message:j.message,fromId:Q||void 0}])}else if(j.type==="matches")X(Array.isArray(j.matches)?j.matches:[]);else if(j.type==="invite")ot({matchId:j.matchId,fromId:j.fromId,fromName:j.fromName,calibrated:!!j.calibrated,boardPreview:j.boardPreview||null,game:j.game,mode:j.mode,value:j.value,startingScore:j.startingScore});else if(j.type==="match-start")o(j.roomId),i.send({type:"join",roomId:j.roomId}),Re(!0),os(!1),j.match?.game&&Yt(j.match.game),t?.username&&!t?.fullAccess&&gi(t.username);else if(j.type==="declined")s("Invite declined",{type:"info"});else if(j.type==="error"){const C=typeof j.message=="string"?j.message:"Action not allowed";if(vt(C),j.code==="SPECTATE_NOT_ALLOWED")try{s("This player has spectating turned off.",{type:"error"})}catch{}j.code==="NOT_FOUND"&&wt&&ls({game:wt.game,mode:wt.mode,value:wt.value,startingScore:wt.startingScore}),setTimeout(()=>vt(""),3500)}else if(j.type==="friend-invite")confirm(`${j.fromName||j.fromEmail} invited you to play ${j.game||"X01"} (${j.mode==="firstto"?"First To":"Best Of"} ${j.value||1}). Accept?`)?i.send({type:"start-friend-match",toEmail:j.fromEmail,game:j.game,mode:j.mode,value:j.value,startingScore:j.startingScore}):s("Invite declined",{type:"info"});else if(j.type==="friend-message")F.add({id:j.id||`${j.ts}-${j.from}`,from:j.from,message:j.message,ts:j.ts||Date.now()}),b.inProgress||s(`${j.from}: ${j.message}`,{type:"info"});else if(j.type==="celebration"){const C=j.by||"Player",P=j.kind==="leg"?"leg":"180";Vt(P,C)}}catch{}});return i.connected&&(i.send({type:"join",roomId:r}),i.send({type:"presence",username:t?.username||"guest",email:(t?.email||"").toLowerCase(),allowSpectate:ie}),i.send({type:"list-matches"})),()=>{f()}},[i?.connected]);function xe(){if(i){i.send({type:"state",payload:{...b,_turnIdx:fe,_participants:te,_dpIndex:rt,_dpHits:mt,_atcIndex:ge,_atcHits:ze,_cricketById:Oe,_shanghaiById:Et,_halveById:ht,_highlowById:jt,_killerById:H,_amCricketById:Ye,_baseballById:Ot,_golfById:J,_tttState:le,_turnDarts:Le}});return}const f=N.current;!f||f.readyState!==WebSocket.OPEN||f.send(JSON.stringify({type:"state",payload:{...b,_turnIdx:fe,_participants:te,_dpIndex:rt,_dpHits:mt,_atcIndex:ge,_atcHits:ze,_cricketById:Oe,_shanghaiById:Et,_halveById:ht,_highlowById:jt,_killerById:H,_amCricketById:Ye,_baseballById:Ot,_golfById:J,_tttState:le,_turnDarts:Le}}))}function Be(f){const j=t?.username||"me";if(u(P=>[...P,{from:j,message:f,fromId:D||"self"}]),S.current={text:f,ts:Date.now()},i){i.send({type:"chat",message:f});return}const C=N.current;!C||C.readyState!==WebSocket.OPEN||C.send(JSON.stringify({type:"chat",message:f}))}function bt(f){if(wr(f,rt)){const C=mt+1,P=rt+1;tt(C),De(P);try{if(C>=ys.length){const Q=b.players[b.currentPlayerIdx]?.name||"Player";Vt("leg",Q),tt(0),De(0)}}catch{}}xe()}function xt(){const f=Math.max(0,Math.floor(he|0));bt(f),ce(0)}function gt(){const f=Gs(ne);f!=null&&(bt(f),de(""))}function pt(f,j,C){const P=Ut[ge];return P==null?!1:typeof C=="number"&&C>=1&&C<=20&&C===P&&(j==="SINGLE"||j==="DOUBLE"||j==="TRIPLE")?!0:P===25?j==="BULL"||f===25:P===50?j==="INNER_BULL"||f===50:f===P||f===P*2||f===P*3}function St(f,j,C){if(pt(f,j,C)){const P=ze+1,Q=ge+1;ke(P),me(Q);try{if(P>=Ut.length){const re=b.players[b.currentPlayerIdx]?.name||"Player";Vt("leg",re),ke(0),me(0)}}catch{}}xe()}function ds(){const f=Math.max(0,Math.floor(he|0));St(f),ce(0)}function _s(){const f=Gs(lt);f!=null&&(St(f),yt(""))}function Je(){return b.players[b.currentPlayerIdx]?.id??String(b.currentPlayerIdx)}function Os(f){Oe[f]||_t(j=>({...j,[f]:on()}))}function en(f){Et[f]||Lt(j=>({...j,[f]:Js()}))}function Ns(f){ht[f]||$t(j=>({...j,[f]:Ks()}))}function Hs(f){jt[f]||Tt(j=>({...j,[f]:Ys()}))}function Ws(f){if(!H[f]){const j=new Set(Object.values(H||{}).map(Q=>Q.number)),C=[];for(let Q=1;Q<=20;Q++)j.has(Q)||C.push(Q);const P=C.length>0?C[Math.floor(Math.random()*C.length)]:20;Ne(Q=>({...Q,[f]:sl(P,3)}))}}function ws(f){Ye[f]||Ht(j=>({...j,[f]:_n()}))}function hn(f){Ot[f]||$(j=>({...j,[f]:Un()}))}function tn(f){J[f]||ue(j=>({...j,[f]:$n()}))}m.useEffect(()=>{je(0)},[b.currentPlayerIdx,ve]);function Sn(f,j){const C=b.players.filter(P=>P.id!==j);return C.length===0?!1:C.every(P=>(Oe[P.id]?.marks?.[f]||0)>=3)}function ns(f,j,C){const P=Je();Os(P),_t(re=>{const oe={...re},W={...oe[P]||on()};return Ko(W,f,j,C,Qe=>Sn(Qe,P)),oe[P]=W,oe});const Q=Le+1;je(Q),Q>=3&&(je(0),b.nextPlayer()),xe()}function bs(f,j,C){const P=Je();en(P),Lt(re=>{const oe={...re},W={...oe[P]||Js()};return Yo(W,f,j,C),oe[P]=W,oe});const Q=Le+1;je(Q),Q>=3&&(Lt(re=>{const oe={...re},W={...oe[P]||Js()};return Xo(W),oe[P]=W,oe}),je(0),b.nextPlayer()),xe()}function Bs(f,j,C){const P=Je();Ns(P),$t(re=>{const oe={...re},W={...oe[P]||Ks()};return Qo(W,f,j,C),oe[P]=W,oe});const Q=Le+1;je(Q),Q>=3&&($t(re=>{const oe={...re},W={...oe[P]||Ks()};return Zo(W),oe[P]=W,oe}),je(0),b.nextPlayer()),xe()}function Ss(f,j,C){const P=Je();Hs(P),Tt(re=>{const oe={...re},W={...oe[P]||Ys()};return el(W,f,j,C),oe[P]=W,oe});const Q=Le+1;je(Q),Q>=3&&(Tt(re=>{const oe={...re},W={...oe[P]||Ys()};return tl(W),oe[P]=W,oe}),je(0),b.nextPlayer()),xe()}function Us(f,j){const C=Je();b.players.forEach(Q=>Ws(Q.id)),Ne(Q=>{const re={};for(const[W,Qe]of Object.entries(Q))re[W]={...Qe};Sr(C,re,f,j);const oe=Cr(re);if(oe)try{Vt("leg",b.players.find(W=>W.id===oe)?.name||"Player")}catch{}return re});const P=Le+1;je(P),P>=3&&(je(0),b.nextPlayer()),xe()}function Cn(f,j,C){const P=Je();ws(P),Ht(re=>{const oe={...re},Qe={...oe[P]||_n()};return ol(Qe,f,j,C,as=>b.players.filter(rs=>rs.id!==P).every(rs=>(Ye[rs.id]?.marks?.[as]||0)>=3)),oe[P]=Qe,oe});const Q=Le+1;je(Q),Q>=3&&(je(0),b.nextPlayer()),xe()}function fn(f,j,C){const P=Je();hn(P),$(re=>{const oe={...re},W={...oe[P]||Un()};return nl(W,f,j,C),oe[P]=W,oe});const Q=Le+1;je(Q),Q>=3&&(je(0),b.nextPlayer()),xe()}function kn(f,j,C){const P=Je();tn(P),ue(re=>{const oe={...re},W={...oe[P]||$n()};return rl(W,f,j,C),oe[P]=W,oe});const Q=Le+1;je(Q),Q>=3&&(je(0),b.nextPlayer()),xe()}function sn(f,j,C,P){Xe(re=>{const oe={...re,board:[...re.board]};return il(oe,f,j,C,P),oe});const Q=Le+1;je(Q),Q>=3&&(je(0),b.nextPlayer()),xe()}function En(){try{window.dispatchEvent(new Event("ndn:open-manual"))}catch{}}function zs(f){const j=Math.max(0,f|0);b.addVisit(j,3),ce(0);const C=b.players[b.currentPlayerIdx],P=C.legs[C.legs.length-1];try{j===180&&Vt("180",C?.name||"Player"),P&&P.totalScoreRemaining===0&&Vt("leg",C?.name||"Player")}catch{}if(P&&P.totalScoreRemaining===0?b.endLeg(j):b.nextPlayer(),T){const Q=P?P.totalScoreRemaining:b.startingScore;ia(t?.username||"Player",j,Math.max(0,Q),U,{volume:w,checkoutOnly:_})}t?.username&&C?.name===t.username&&rn(t.username,3,j),xe()}function Vn(f,j){const C={type:"report",offenderId:f,reason:"Inappropriate language",message:j};try{i?i.send(C):N.current?.send(JSON.stringify(C))}catch{}try{s("Report submitted",{type:"info"})}catch{}}async function xn(){try{const f=await navigator.mediaDevices.getUserMedia({video:!0,audio:!1}),j=f.getVideoTracks?.()[0],C=document.createElement("video");C.srcObject=f,await C.play().catch(()=>{}),await new Promise(Qe=>setTimeout(Qe,120));const P=Math.min(320,C.videoWidth||320),Q=Math.max(1,Math.floor((C.videoHeight||180)*(P/Math.max(1,C.videoWidth||320)))),re=document.createElement("canvas");re.width=P,re.height=Q,re.getContext("2d").drawImage(C,0,0,P,Q);const W=re.toDataURL("image/jpeg",.7);try{j&&j.stop()}catch{}try{f.getTracks?.().forEach(Qe=>Qe.stop())}catch{}return W}catch{return null}}const Tn=async f=>{console.log("Starting WebRTC for code:",f);try{const j=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}]});j.ontrack=P=>{console.log("Received track:",P.streams[0]),Ae(P.streams[0]),Mt.current&&(Mt.current.srcObject=P.streams[0],console.log("Set video srcObject"))},j.onicecandidate=P=>{P.candidate&&(console.log("Sending ICE candidate"),i?i.send({type:"cam-ice",code:f,payload:P.candidate}):N.current&&N.current.readyState===WebSocket.OPEN&&N.current.send(JSON.stringify({type:"cam-ice",code:f,payload:P.candidate})))},j.onconnectionstatechange=()=>console.log("Connection state:",j.connectionState);const C=await j.createOffer();if(await j.setLocalDescription(C),console.log("Sending offer"),i)console.log("Sending offer via wsGlobal"),i.send({type:"cam-offer",code:f,payload:C});else if(N.current&&N.current.readyState===WebSocket.OPEN)console.log("Sending offer via wsRef"),N.current.send(JSON.stringify({type:"cam-offer",code:f,payload:C}));else{console.log("WS not available, POSTing offer to /cam/signal");try{await kt(`/cam/signal/${f}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({type:"cam-offer",payload:C,source:"desktop"})})}catch(P){console.warn("REST offer failed",P)}}window.mobilePC=j}catch(j){console.error("WebRTC error:",j),s("Failed to start mobile camera",{type:"error"})}};return e.jsxs("div",{className:"card flex flex-col min-h-[85vh] relative overflow-hidden",children:[e.jsx("h2",{className:"text-xl font-semibold mb-1",children:"Online Play"}),cs>0&&!b.inProgress&&e.jsxs("div",{className:"mb-3 text-sm px-3 py-2 rounded bg-amber-600/30 border border-amber-500/40",children:["You have ",cs," unread message",cs>1?"s":"",". Check the Friends tab."]}),e.jsx("div",{className:"relative",children:e.jsxs("div",{className:"rounded-2xl bg-white/5 backdrop-blur border border-white/10 p-2 flex items-center gap-2 overflow-x-auto no-scrollbar",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"text-xs opacity-70 shrink-0",children:"Room"}),e.jsx("input",{className:"input w-28",value:r,onChange:f=>o(f.target.value),placeholder:"room-1"})]}),l?e.jsx("span",{className:"text-[11px] px-2 py-1 rounded-full bg-emerald-600/20 text-emerald-200 border border-emerald-400/40 shrink-0",children:"Connected"}):e.jsx("button",{className:"btn bg-rose-600 hover:bg-rose-700 shrink-0",onClick:js,children:"Connect"}),e.jsx("button",{className:"btn shrink-0",onClick:xe,disabled:!l,children:"Sync"}),e.jsx("button",{className:"text-[11px] px-3 py-1 rounded-full bg-indigo-500/25 text-indigo-100 border border-indigo-400/40 hover:bg-indigo-500/40 shrink-0",title:"Open a simulated online match demo",onClick:()=>{try{window.dispatchEvent(new CustomEvent("ndn:online-match-demo",{detail:{game:"X01",start:501}}))}catch{}},children:"DEMO"}),l&&e.jsx("button",{className:"btn shrink-0",onClick:()=>Re(!0),disabled:Jt,title:Jt?"Weekly free games used":"",children:"Open Match"})]})}),e.jsx("div",{className:`mt-3 p-3 rounded-xl bg-indigo-500/10 border border-indigo-500/40 flex items-center justify-end ${!l||Jt?"opacity-60 cursor-not-allowed":"cursor-pointer"}`,role:"button",title:l?Jt?"Weekly free games used":"Create a new match":"Connect to the lobby first",onClick:()=>{!l||Jt||(os(!0),i?i.send({type:"list-matches"}):N.current?.send(JSON.stringify({type:"list-matches"})))},children:e.jsx("button",{className:"btn",disabled:!l||Jt,children:"Create Match +"})}),e.jsx("p",{className:"text-sm text-slate-600 mt-3",children:"Open this app on another device and join the same Room ID to sync scores."}),!t?.fullAccess&&e.jsxs("div",{className:"text-xs text-slate-400 mt-1",children:["Weekly free online games remaining: ",hs===1/0?"ÔÇö":hs]}),!t?.fullAccess&&hs!==1/0&&hs<=0&&e.jsx("div",{className:"mt-2 p-2 rounded-lg bg-rose-700/30 border border-rose-600/40 text-rose-200 text-sm",children:"You've used your 3 free online games this week. PREMIUM required to continue."}),Nt&&e.jsxs("div",{className:"mt-2 p-2 rounded-lg bg-rose-700/30 border border-rose-600/40 text-rose-200 text-sm font-semibold flex items-center gap-2",children:[e.jsx("span",{className:"material-icons text-rose-300",children:"error_outline"}),Nt]}),us&&e.jsxs("div",{className:"mt-2 p-2 rounded-lg bg-indigo-700/30 border border-indigo-600/40 text-indigo-100 text-sm flex items-center justify-between gap-2",children:[e.jsx("div",{children:"That room is full or no longer available. Create a new clean room with the same settings?"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{className:"btn px-3 py-1 text-sm",onClick:()=>{const{game:f,mode:j,value:C,startingScore:P}=us,Q=t?.username?Xs(t.username):0;i?(i.send({type:"create-match",game:f,mode:j,value:C,startingScore:P||501,creatorAvg:Q}),i.send({type:"list-matches"})):(N.current?.send(JSON.stringify({type:"create-match",game:f,mode:j,value:C,startingScore:P||501,creatorAvg:Q})),N.current?.send(JSON.stringify({type:"list-matches"}))),ls(null)},children:"Create New Match"}),e.jsx("button",{className:"btn bg-slate-700 hover:bg-slate-800 px-3 py-1 text-sm",onClick:()=>ls(null),children:"Dismiss"})]})]}),l&&e.jsxs("div",{className:"mt-4 p-3 rounded-xl border border-indigo-500/40 bg-indigo-500/10 flex-1 overflow-auto",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("div",{className:"font-semibold",children:"World Lobby"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"text-xs opacity-80",children:["Matches: ",Kt.length]}),e.jsx("button",{className:"btn px-3 py-1 text-sm",onClick:()=>i?i.send({type:"list-matches"}):N.current?.send(JSON.stringify({type:"list-matches"})),children:"Refresh"}),e.jsx("button",{className:"btn px-3 py-1 text-sm",title:l?Jt?"Weekly free games used":"Create a new match":"Connect to the lobby first",disabled:!l||Jt,onClick:()=>{!l||Jt||(os(!0),i?i.send({type:"list-matches"}):N.current?.send(JSON.stringify({type:"list-matches"})))},children:"Create Match +"})]})]}),e.jsxs("div",{className:"space-y-3 mb-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs opacity-70 mb-1",children:"Mode"}),e.jsx(pa,{tabs:[{key:"all",label:"All"},{key:"bestof",label:"Best of"},{key:"firstto",label:"First to"}],active:fs,onChange:f=>ct(f)})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-2",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs opacity-70 mb-1",children:"Game"}),e.jsxs("select",{className:"input w-full",value:Zt,onChange:f=>Ds(f.target.value),children:[e.jsx("option",{value:"all",children:"All"}),Nn.map(f=>e.jsx("option",{value:f,children:f},f))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs opacity-70 mb-1",children:"Starting Score"}),e.jsxs("select",{className:"input w-full",value:Wt,onChange:f=>{const j=f.target.value;xs(j==="all"?"all":Number(j))},disabled:Zt!=="all"&&Zt!=="X01",children:[e.jsx("option",{value:"all",children:"All"}),e.jsx("option",{value:"301",children:"301"}),e.jsx("option",{value:"501",children:"501"}),e.jsx("option",{value:"701",children:"701"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs opacity-70 mb-1",children:"Opponent near my avg"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{id:"nearavg",type:"checkbox",className:"accent-purple-500",checked:ts,onChange:f=>Ls(f.target.checked),disabled:!un}),e.jsx("label",{htmlFor:"nearavg",className:"cursor-pointer text-sm",children:"Near my average"}),e.jsx("input",{className:"input w-24",type:"number",min:5,max:40,step:1,value:Dt,onChange:f=>ss(parseInt(f.target.value||"10")),disabled:!ts})]})]})]}),e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsxs("div",{className:"flex-1 max-w-sm",children:[e.jsx("label",{className:`block text-xs opacity-70 mb-1 ${ts?"":"opacity-40"}`,children:"Avg tolerance (±)"}),e.jsx("input",{className:"w-full",type:"range",min:1,max:50,value:Dt,onChange:f=>ss(parseInt(f.target.value||"10")),disabled:!ts}),e.jsxs("div",{className:"text-xs opacity-70 mt-1",children:["± ",Dt]})]}),e.jsx("button",{className:"btn px-3 py-1 text-sm",onClick:()=>{ct("all"),Ds("all"),xs("all"),Ls(!1),ss(10)},children:"Reset"})]})]}),Kt.length===0?e.jsx("div",{className:"text-sm text-slate-300",children:"No games waiting. Create one!"}):e.jsx("div",{className:"space-y-2",children:Kt.map(f=>e.jsxs("div",{className:"p-3 rounded-lg bg-black/20 flex items-center justify-between relative",children:[e.jsxs("div",{className:"text-sm",children:[e.jsxs("div",{children:[f.game||"X01"," ",f.game==="X01"?` ${f.startingScore}`:""," - ",f.mode==="bestof"?`Best Of ${f.value}`:`First To ${f.value}`," - Created by ",f.creatorName]}),f.requireCalibration&&e.jsx("div",{className:"text-[11px] inline-flex items-center gap-1 px-1.5 py-0.5 rounded bg-emerald-500/20 text-emerald-300 border border-emerald-600/30 mt-1",children:"Calibration required"}),f.creatorAvg?e.jsxs("div",{className:"text-xs opacity-70",children:["Creator avg: ",Number(f.creatorAvg).toFixed(1)]}):null,e.jsxs("div",{className:"text-xs opacity-70",children:["ID: ",f.id]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{className:"btn px-3 py-1 text-sm bg-green-600 hover:bg-green-700",disabled:Jt||!t?.fullAccess&&Vs.includes(f.game)||!!f.requireCalibration&&!ps,title:!t?.fullAccess&&Vs.includes(f.game)?"PREMIUM game":Jt?"Weekly free games used":f.requireCalibration&&!ps?"Calibration required":"",onClick:async()=>{Is({game:f.game,mode:f.mode,value:f.value,startingScore:f.startingScore});const j=!!ps,C=await xn();try{i?i.send({type:"join-match",matchId:f.id,calibrated:j,boardPreview:C}):N.current?.send(JSON.stringify({type:"join-match",matchId:f.id,calibrated:j,boardPreview:C}))}catch(P){It(P?.message||"Failed to create Stripe checkout session. Please try again later.")}},children:"Join Now!"}),D&&f.creatorId===D&&e.jsx("button",{className:"w-6 h-6 rounded-full bg-rose-600 hover:bg-rose-700 text-white text-xs flex items-center justify-center shadow",title:"Close this match",onClick:()=>{i?i.send({type:"cancel-match",matchId:f.id}):N.current?.send(JSON.stringify({type:"cancel-match",matchId:f.id}))},"aria-label":"Close match",children:"×"})]})]},f.id))})]}),!t?.fullAccess&&hs!==1/0&&hs<=0&&e.jsxs("div",{className:"absolute inset-0 z-40 flex items-center justify-center",children:[e.jsx("div",{className:"absolute inset-0 backdrop-blur-sm bg-slate-900/40"}),e.jsxs("div",{className:"relative z-10 p-4 rounded-xl bg-black/60 border border-slate-700 text-center",children:[e.jsx("div",{className:"text-3xl mb-2",children:"­ƒöÆ"}),e.jsx("div",{className:"font-semibold",children:"Online play locked"}),e.jsx("div",{className:"text-sm text-slate-200/80",children:"YouÔÇÖve used your 3 free online games this week. Upgrade to PREMIUM to play all modes."}),e.jsxs("button",{onClick:async()=>{try{const j=await(await fetch(`${a}/api/stripe/create-checkout-session`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:t?.email})})).json();j.ok&&j.url?window.location.href=j.url:alert("Failed to create payment session: "+(j.error||"Unknown error"))}catch{alert("Network error")}},className:"btn mt-3 bg-gradient-to-r from-indigo-500 to-fuchsia-600 text-white font-bold",children:["Upgrade to PREMIUM = ",Io(Mo(),5)]})]})]}),Ge&&e.jsxs("div",{className:"fixed inset-0 z-50",children:[e.jsx("div",{className:"absolute inset-0 bg-black/50 backdrop-blur-sm"}),e.jsxs("div",{className:"absolute inset-0 flex flex-col",children:[e.jsxs("div",{className:"p-2 md:p-3 flex items-center justify-between",children:[e.jsx("div",{children:e.jsx("h3",{className:"text-xl md:text-2xl font-bold",children:"Online Match"})}),e.jsx("button",{className:"btn px-3 py-1",onClick:()=>Re(!1),children:"Close"})]}),e.jsx("div",{className:"relative flex-1 overflow-hidden p-2 md:p-3",children:e.jsxs("div",{className:"card w-full h-full overflow-hidden relative p-2.5 md:p-3",children:[it&&e.jsxs("div",{className:"absolute inset-0 pointer-events-none flex items-start justify-center pt-8 z-20",children:[e.jsxs("div",{className:`px-4 py-2 rounded-full text-lg font-bold shadow ${it.kind==="leg"?"bg-indigo-500/20 border border-indigo-400/40 text-indigo-100":"bg-emerald-500/20 border border-emerald-400/40 text-emerald-100"}`,children:[it.kind==="leg"?"­ƒÅü LEG WON ÔÇö ":"­ƒÄ» ONE HUNDRED AND EIGHTY! ÔÇö ",it.by]}),it.kind==="leg"&&e.jsxs(e.Fragment,{children:[e.jsx("style",{children:"@keyframes ndn-confetti-fall{0%{transform:translateY(-10%) rotate(0deg);opacity:1}100%{transform:translateY(120%) rotate(360deg);opacity:0}}"}),e.jsx("div",{className:"absolute inset-0 pointer-events-none",children:[...Array(24)].map((f,j)=>{const C=Math.random()*100,P=Math.random()*.2,Q=1.2+Math.random()*.8,re=6+Math.random()*6,oe=Math.floor(Math.random()*360);return e.jsx("span",{style:{position:"absolute",top:0,left:C+"%",width:re,height:re,background:`hsl(${oe} 90% 60%)`,borderRadius:2,animation:`ndn-confetti-fall ${Q}s ease-out ${P}s forwards`}},j)})})]})]}),e.jsxs("div",{className:"mb-1.5 text-xs md:text-sm flex items-center justify-between gap-2",children:[e.jsxs("span",{children:["Participants: ",te.length||1]}),e.jsx("button",{className:"text-[11px] px-2 py-0.5 rounded-full bg-slate-700/50 hover:bg-slate-700 border border-slate-600",onClick:()=>Bt(f=>!f),title:$e?"Switch to full multi-player view":"Switch to compact player-by-player view",children:$e?"Full view":"Compact view"})]}),$e?e.jsxs("div",{className:"mb-3",children:[(()=>{const f=b.currentPlayerIdx,j=b.players[f];if(!j)return null;const C=j.legs[j.legs.length-1],P=C?C.totalScoreRemaining:b.startingScore,Q=t?.username&&j.name===t.username,re=C&&C.visits.length?C.visits[C.visits.length-1].score:0,oe=C?C.dartsThrown:0,W=oe>0?((C?.totalScoreStart??b.startingScore)-P)/oe*3:0;return ve==="X01"?e.jsxs("div",{className:`p-4 rounded-xl bg-brand-50 text-black ${f===b.currentPlayerIdx?"ring-2 ring-brand-400":""}`,children:[e.jsxs("div",{className:"text-xs text-slate-600 flex items-center justify-between",children:[e.jsx("span",{className:"font-semibold",children:j.name}),e.jsx("span",{className:`px-2 py-0.5 rounded-full ${f===b.currentPlayerIdx?"bg-emerald-500/20 text-emerald-300":"bg-slate-500/20 text-slate-300"} text-xs font-bold`,children:f===b.currentPlayerIdx?"THROWING":"WAITING TO THROW"})]}),e.jsx("div",{className:"text-4xl font-extrabold",children:P}),e.jsxs("div",{className:"text-sm mt-1",children:["Last score: ",e.jsx("span",{className:"font-semibold",children:re})]}),e.jsxs("div",{className:"text-sm",children:["3-Dart Avg: ",e.jsx("span",{className:"font-semibold",children:W.toFixed(1)})]}),Q&&f===b.currentPlayerIdx&&P<=170&&P>0&&e.jsxs("div",{className:"mt-2 p-2 rounded-lg bg-indigo-50 border border-indigo-200 text-indigo-900 text-sm",children:["Checkout suggestions (fav ",z,"): ",la(P,z).join("  ÔÇó  ")||"ÔÇö"]})]}):e.jsxs("div",{className:`p-4 rounded-xl bg-brand-50 text-black ${f===b.currentPlayerIdx?"ring-2 ring-brand-400":""}`,children:[e.jsxs("div",{className:"text-xs text-slate-600 flex items-center justify-between",children:[e.jsx("span",{className:"font-semibold",children:j.name}),e.jsx("span",{className:`px-2 py-0.5 rounded-full ${f===b.currentPlayerIdx?"bg-emerald-500/20 text-emerald-300":"bg-slate-500/20 text-slate-300"} text-xs font-bold`,children:f===b.currentPlayerIdx?"THROWING":"WAITING TO THROW"})]}),e.jsx("div",{className:"text-sm opacity-80",children:ve}),ve==="Double Practice"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"mt-1 text-xs flex items-center justify-between",children:[e.jsx("span",{children:"Current target"}),e.jsx("span",{className:"px-2 py-0.5 rounded-full bg-emerald-500/20 text-emerald-200 border border-emerald-400/30 text-xs font-semibold",children:ys[rt]?.label||"ÔÇö"})]}),e.jsxs("div",{className:"text-3xl font-extrabold",children:[mt," / ",ys.length]})]}),ve==="Around the Clock"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"mt-1 text-xs flex items-center justify-between",children:[e.jsx("span",{children:"Current target"}),e.jsx("span",{className:"px-2 py-0.5 rounded-full bg-emerald-500/20 text-emerald-200 border border-emerald-400/30 text-xs font-semibold",children:Ut[ge]===25?"25 (Outer Bull)":Ut[ge]===50?"50 (Inner Bull)":Ut[ge]||"ÔÇö"})]}),e.jsxs("div",{className:"text-3xl font-extrabold",children:[ze," / ",Ut.length]})]})]})})(),b.players.length>1&&e.jsxs("div",{className:"mt-2 text-xs text-slate-400",children:["Next up: ",b.players[(b.currentPlayerIdx+1)%b.players.length]?.name]})]}):e.jsx(e.Fragment,{children:e.jsx("div",{className:"mb-3 flex flex-wrap items-center gap-2",children:b.players.map((f,j)=>{const C=f.legs[f.legs.length-1],P=C?C.totalScoreRemaining:b.startingScore;return e.jsxs("div",{className:`px-2 py-1 rounded bg-black/20 border border-slate-700/40 text-xs ${j===b.currentPlayerIdx?"ring-1 ring-brand-400":""}`,children:[e.jsx("span",{className:"font-semibold",children:f.name}),ve==="X01"?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"opacity-70",children:" = "}),e.jsx("span",{className:"font-mono",children:P})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"opacity-70",children:" = "}),e.jsx("span",{className:"font-mono",children:ve==="Double Practice"?`${mt}/${ys.length}`:ve==="Around the Clock"?`${ze}/${Ut.length}`:ve==="Cricket"?`${Oe[f.id]?.points||0} pts`:ve==="Shanghai"?`${Et[f.id]?.score||0} pts = R${Et[f.id]?.round||1}`:ve==="Halve It"?`${ht[f.id]?.score||0} pts = S${(ht[f.id]?.stage||0)+1}`:ve==="High-Low"?`${jt[f.id]?.score||0} pts = ${jt[f.id]?.target||"HIGH"}`:ve==="Killer"?(()=>{const Q=H[f.id];return Q?`#${Q.number} = ${Q.lives}ÔØñ ${Q.isKiller?"= K":""}`:"ÔÇö"})():ve==="American Cricket"?`${Ye[f.id]?.points||0} pts`:ve==="Baseball"?(()=>{const Q=Ot[f.id];return Q?`R${Q.score} = I${Q.inning}`:"ÔÇö"})():ve==="Golf"?(()=>{const Q=J[f.id];return Q?`S${Q.strokes} = H${Q.hole}`:"ÔÇö"})():ve==="Tic Tac Toe"?(()=>{const Q=(le.board||[]).filter(oe=>oe==="X").length,re=(le.board||[]).filter(oe=>oe==="O").length;return`X${Q}-O${re}`})():ve})]})]},`strip-${f.id}`)})})}),$e?e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("button",{className:`btn ${ye}`,onClick:()=>{try{window.dispatchEvent(new Event("ndn:open-autoscore"))}catch{}},children:"Autoscore"}),e.jsx("button",{className:`btn ${ye}`,onClick:()=>{try{window.dispatchEvent(new Event("ndn:open-scoring"))}catch{}},children:"Scoring"}),e.jsx("button",{className:`btn ${ye}`,onClick:En,children:"Manual Correction"}),!Te&&e.jsx("button",{className:`btn ${ye}`,onClick:()=>{console.log("Sending cam-create"),i?i.send({type:"cam-create"}):N.current&&N.current.readyState===WebSocket.OPEN?N.current.send(JSON.stringify({type:"cam-create"})):s("Not connected to server",{type:"error"})},children:"Pair Phone"}),!Te&&k&&e.jsxs("div",{className:"ml-2 text-sm bg-blue-900/50 p-2 rounded",children:[e.jsxs("div",{children:[e.jsx("span",{className:"opacity-70",children:"Mobile pairing code: "}),e.jsx("span",{className:"font-mono font-bold text-lg",children:k})]}),e.jsxs("div",{className:"text-xs opacity-70 mt-1",children:["On your phone, go to: ",e.jsxs("a",{href:`/mobile-cam.html?code=${k}`,target:"_blank",className:"underline",children:[window.location.origin,"/mobile-cam.html?code=",k]})]})]}),!Te&&e.jsxs("div",{className:"ml-auto flex items-center gap-1 text-[11px]",children:[e.jsx("span",{className:"opacity-70",children:"Cam size"}),e.jsx("button",{className:`btn ${ye}`,onClick:()=>Z(Math.max(.5,Math.round((R-.05)*100)/100)),children:"−"}),e.jsxs("span",{className:`btn ${ye} min-w-[2.5rem] text-center`,children:[Math.round(R*100),"%"]}),e.jsx("button",{className:`btn ${ye}`,onClick:()=>Z(Math.min(1.25,Math.round((R+.05)*100)/100)),children:"+"})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-2 mt-2 items-start",children:[e.jsx("div",{className:"order-1",children:e.jsx(qe,{})}),e.jsx("div",{className:"order-2",children:ae?e.jsxs("div",{className:"min-w-[260px] relative z-10 overflow-hidden",style:{maxHeight:"min(50vh, 400px)"},children:[e.jsx(ca,{label:"Your Board",autoStart:t?.username&&b.players[b.currentPlayerIdx]?.name===t.username}),At&&e.jsxs("div",{className:"mt-2",children:[e.jsx("video",{ref:Mt,autoPlay:!0,playsInline:!0,muted:!0,className:"w-full h-auto max-h-32 object-cover rounded border"}),e.jsx("div",{className:"text-xs opacity-70 mt-1",children:"Mobile Camera"})]})]}):e.jsx("div",{className:"text-xs opacity-60",children:"Camera disabled in settings"})})]}),e.jsxs("div",{className:"font-semibold",children:["Current: ",b.players[b.currentPlayerIdx]?.name||"ÔÇö"]}),ve==="X01"&&ae&&t?.username&&b.players[b.currentPlayerIdx]?.name===t.username?e.jsxs(e.Fragment,{children:[e.jsx(Ze,{hideInlinePanels:!0,showToolbar:!1,onVisitCommitted:(f,j,C)=>{if(T){const Q=b.players[b.currentPlayerIdx],re=Q?.legs[Q.legs.length-1],oe=re?re.totalScoreRemaining:b.startingScore;ia(t?.username||"Player",f,Math.max(0,oe),U,{volume:w,checkoutOnly:_})}const P=b.players[b.currentPlayerIdx];t?.username&&P?.name===t.username&&rn(t.username,j,f);try{f===180&&Vt("180",P?.name||"Player"),C&&Vt("leg",P?.name||"Player")}catch{}C||b.nextPlayer(),xe()}}),e.jsxs("div",{className:"flex items-center gap-1.5 mb-2",children:[e.jsx("input",{className:"input w-24 text-sm",type:"number",min:0,value:he,onChange:f=>ce(parseInt(f.target.value||"0"))}),e.jsx("button",{className:"btn px-2 py-0.5 text-xs",onClick:()=>zs(he),children:"Submit Visit"}),e.jsx("button",{className:"btn px-2 py-0.5 text-xs bg-slate-700 hover:bg-slate-800",onClick:()=>{b.undoVisit(),xe()},children:"Undo"})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-1.5 mt-1.5 text-xs",children:[e.jsx("span",{className:"opacity-70",children:"Quick:"}),[180,140,100,60].map(f=>e.jsx("button",{className:"btn px-2 py-0.5 text-xs",onClick:()=>zs(f),children:f},f))]}),e.jsxs("div",{className:"mt-2 flex items-center gap-1.5 mb-2",children:[e.jsx("button",{className:"btn px-2 py-0.5 text-xs",onClick:()=>x(!0),children:"Quick Chat"}),e.jsx("button",{className:"btn px-2 py-0.5 text-xs",onClick:()=>g(!0),children:"Messages"})]})]}):ve==="Double Practice"&&t?.username&&b.players[b.currentPlayerIdx]?.name===t.username?e.jsxs("div",{className:"p-3 rounded-xl bg-black/20",children:[e.jsx("div",{className:"text-xs mb-1.5",children:"Double Practice ÔÇö Hit doubles D1ÔåÆD20ÔåÆDBULL"}),e.jsxs("div",{className:"mb-1 text-sm flex items-center justify-between",children:[e.jsx("span",{children:"Current target"}),e.jsx("span",{className:"px-2 py-0.5 rounded-full bg-emerald-500/20 text-emerald-200 border border-emerald-400/30 text-xs font-semibold",children:ys[rt]?.label||"ÔÇö"})]}),e.jsxs("div",{className:"text-2xl font-extrabold mb-2",children:[mt," / ",ys.length]}),e.jsx("div",{className:"rounded-2xl overflow-hidden bg-black/60 border border-white/10 mb-2",children:e.jsx(Ze,{showToolbar:!1,immediateAutoCommit:!0,onAutoDart:(f,j)=>{(j==="DOUBLE"||j==="INNER_BULL")&&bt(f)}})}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("input",{className:"input w-24 text-sm",type:"number",min:0,value:he,onChange:f=>ce(parseInt(f.target.value||"0")),onKeyDown:f=>{f.key==="Enter"&&xt()}}),e.jsx("button",{className:"btn px-2 py-0.5 text-xs",onClick:xt,children:"Add Dart"})]}),e.jsxs("div",{className:"flex items-center gap-1.5 mt-1.5",children:[e.jsx("input",{className:"input w-40 text-sm",placeholder:"Manual (D16, 50, 25, T20)",value:ne,onChange:f=>de(f.target.value),onKeyDown:f=>{f.key==="Enter"&&gt()}}),e.jsx("button",{className:"btn px-2 py-0.5 text-xs",onClick:gt,children:"Add"})]})]}):ve==="Around the Clock"&&t?.username&&b.players[b.currentPlayerIdx]?.name===t.username?e.jsxs("div",{className:"p-3 rounded-xl bg-black/20",children:[e.jsx("div",{className:"text-xs mb-1.5",children:"Around the Clock ÔÇö Hit 1ÔåÆ20 then 25 (outer) and 50 (inner)"}),e.jsxs("div",{className:"mb-1 text-sm flex items-center justify-between",children:[e.jsx("span",{children:"Current target"}),e.jsx("span",{className:"px-2 py-0.5 rounded-full bg-emerald-500/20 text-emerald-200 border border-emerald-400/30 text-xs font-semibold",children:Ut[ge]===25?"25 (Outer Bull)":Ut[ge]===50?"50 (Inner Bull)":Ut[ge]||"ÔÇö"})]}),e.jsxs("div",{className:"text-2xl font-extrabold mb-2",children:[ze," / ",Ut.length]}),e.jsx("div",{className:"rounded-2xl overflow-hidden bg-black/60 border border-white/10 mb-2",children:e.jsx(Ze,{scoringMode:"custom",showToolbar:!1,immediateAutoCommit:!0,onAutoDart:(f,j,C)=>{St(f,j,C?.sector??null)}})}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("input",{className:"input w-24 text-sm",type:"number",min:0,value:he,onChange:f=>ce(parseInt(f.target.value||"0")),onKeyDown:f=>{f.key==="Enter"&&ds()}}),e.jsx("button",{className:"btn px-2 py-0.5 text-xs",onClick:ds,children:"Add Dart"})]}),e.jsxs("div",{className:"flex items-center gap-1.5 mt-1.5",children:[e.jsx("input",{className:"input w-40 text-sm",placeholder:"Manual (T20, D5, 25, 50)",value:lt,onChange:f=>yt(f.target.value),onKeyDown:f=>{f.key==="Enter"&&_s()}}),e.jsx("button",{className:"btn px-2 py-0.5 text-xs",onClick:_s,children:"Add"})]})]}):ve==="Cricket"&&t?.username&&b.players[b.currentPlayerIdx]?.name===t.username?e.jsxs("div",{className:"p-3 rounded-xl bg-black/20",children:[e.jsx("div",{className:"text-xs mb-1.5",children:"Cricket ÔÇö Close 15-20 and Bull; overflow scores points"}),(()=>{const f=Je();Os(f);const j=Oe[f]||on();return e.jsx("div",{className:"mb-2 grid grid-cols-7 gap-1 text-center text-[11px]",children:qn.map(C=>e.jsxs("div",{className:"p-1 rounded bg-slate-800/50 border border-slate-700/50",children:[e.jsx("div",{className:"opacity-70",children:C===25?"Bull":C}),e.jsxs("div",{className:"font-semibold",children:[Math.min(3,j.marks?.[C]||0)," / 3"]})]},C))})})(),e.jsxs("div",{className:"text-sm mb-2",children:["Points: ",e.jsx("span",{className:"font-semibold",children:Oe[Je()]?.points||0})]}),e.jsx("div",{className:"rounded-2xl overflow-hidden bg-black/60 border border-white/10 mb-2",children:e.jsx(Ze,{scoringMode:"custom",showToolbar:!1,immediateAutoCommit:!0,onAutoDart:(f,j,C)=>{ns(f,j==="MISS"?void 0:j,C?.sector??null)}})}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("input",{className:"input w-24 text-sm",type:"number",min:0,value:he,onChange:f=>ce(parseInt(f.target.value||"0")),onKeyDown:f=>{f.key==="Enter"&&(ns(Math.max(0,he|0)),ce(0))}}),e.jsx("button",{className:"btn px-2 py-0.5 text-xs",onClick:()=>{ns(Math.max(0,he|0)),ce(0)},children:"Add Dart"})]})]}):ve==="Shanghai"&&t?.username&&b.players[b.currentPlayerIdx]?.name===t.username?e.jsxs("div",{className:"p-3 rounded-xl bg-black/20",children:[(()=>{const f=Je();en(f);const j=Et[f]||Js();return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"text-xs mb-1.5",children:"Shanghai ÔÇö Hit only the round's number; Single/Double/Triple score"}),e.jsxs("div",{className:"mb-1 text-sm flex items-center justify-between",children:[e.jsx("span",{children:"Round"}),e.jsx("span",{className:"px-2 py-0.5 rounded-full bg-emerald-500/20 text-emerald-200 border border-emerald-400/30 text-xs font-semibold",children:j.round})]}),e.jsxs("div",{className:"text-2xl font-extrabold mb-2",children:["Score: ",j.score]})]})})(),e.jsx("div",{className:"rounded-2xl overflow-hidden bg-black/60 border border-white/10 mb-2",children:e.jsx(Ze,{scoringMode:"custom",showToolbar:!1,immediateAutoCommit:!0,onAutoDart:(f,j,C)=>{bs(f,j==="MISS"?void 0:j,C?.sector??null)}})}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("input",{className:"input w-24 text-sm",type:"number",min:0,value:he,onChange:f=>ce(parseInt(f.target.value||"0")),onKeyDown:f=>{f.key==="Enter"&&(bs(Math.max(0,he|0)),ce(0))}}),e.jsx("button",{className:"btn px-2 py-0.5 text-xs",onClick:()=>{bs(Math.max(0,he|0)),ce(0)},children:"Add Dart"})]})]}):ve==="Halve It"&&t?.username&&b.players[b.currentPlayerIdx]?.name===t.username?e.jsxs("div",{className:"p-3 rounded-xl bg-black/20",children:[(()=>{const f=Je();Ns(f);const j=ht[f]||Ks(),C=da(j);return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"text-xs mb-1.5",children:"Halve It ÔÇö Hit the target each round or your score halves"}),e.jsxs("div",{className:"mb-1 text-sm flex items-center justify-between",children:[e.jsx("span",{children:"Stage"}),e.jsxs("span",{className:"px-2 py-0.5 rounded-full bg-emerald-500/20 text-emerald-200 border border-emerald-400/30 text-xs font-semibold",children:[j.stage+1,"/",j.targets.length]})]}),e.jsxs("div",{className:"text-sm",children:["Target: ",e.jsx("span",{className:"font-semibold",children:(()=>{const P=C;return P?P.kind==="ANY_NUMBER"?"Any":P.kind==="BULL"?"Bull":P.kind==="DOUBLE"||P.kind==="TRIPLE"||P.kind==="NUMBER"?`${P.kind} ${P.num}`:"ÔÇö":"ÔÇö"})()})]}),e.jsxs("div",{className:"text-2xl font-extrabold mb-2",children:["Score: ",j.score]})]})})(),e.jsx("div",{className:"rounded-2xl overflow-hidden bg-black/60 border border-white/10 mb-2",children:e.jsx(Ze,{scoringMode:"custom",showToolbar:!1,immediateAutoCommit:!0,onAutoDart:(f,j,C)=>{Bs(f,j==="MISS"?void 0:j,C?.sector??null)}})}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("input",{className:"input w-24 text-sm",type:"number",min:0,value:he,onChange:f=>ce(parseInt(f.target.value||"0")),onKeyDown:f=>{f.key==="Enter"&&(Bs(Math.max(0,he|0)),ce(0))}}),e.jsx("button",{className:"btn px-2 py-0.5 text-xs",onClick:()=>{Bs(Math.max(0,he|0)),ce(0)},children:"Add Dart"})]})]}):ve==="High-Low"&&t?.username&&b.players[b.currentPlayerIdx]?.name===t.username?e.jsxs("div",{className:"p-3 rounded-xl bg-black/20",children:[(()=>{const f=Je();Hs(f);const j=jt[f]||Ys();return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"text-xs mb-1.5",children:"High-Low ÔÇö Alternate aiming for high then low segments"}),e.jsxs("div",{className:"mb-1 text-sm flex items-center justify-between",children:[e.jsx("span",{children:"Round"}),e.jsx("span",{className:"px-2 py-0.5 rounded-full bg-emerald-500/20 text-emerald-200 border border-emerald-400/30 text-xs font-semibold",children:j.round})]}),e.jsxs("div",{className:"text-sm",children:["Target: ",e.jsx("span",{className:"font-semibold",children:j.target})]}),e.jsxs("div",{className:"text-2xl font-extrabold mb-2",children:["Score: ",j.score]})]})})(),e.jsx("div",{className:"rounded-2xl overflow-hidden bg-black/60 border border-white/10 mb-2",children:e.jsx(Ze,{scoringMode:"custom",showToolbar:!1,immediateAutoCommit:!0,onAutoDart:(f,j,C)=>{Ss(f,j==="MISS"?void 0:j,C?.sector??null)}})}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("input",{className:"input w-24 text-sm",type:"number",min:0,value:he,onChange:f=>ce(parseInt(f.target.value||"0")),onKeyDown:f=>{f.key==="Enter"&&(Ss(Math.max(0,he|0)),ce(0))}}),e.jsx("button",{className:"btn px-2 py-0.5 text-xs",onClick:()=>{Ss(Math.max(0,he|0)),ce(0)},children:"Add Dart"})]})]}):ve==="American Cricket"&&t?.username&&b.players[b.currentPlayerIdx]?.name===t.username?e.jsxs("div",{className:"p-3 rounded-xl bg-black/20",children:[e.jsx("div",{className:"text-xs mb-1.5",children:"American Cricket ÔÇö Close 12-20 and Bull; overflow scores"}),(()=>{const f=Je();ws(f);const j=Ye[f]||_n();return e.jsx("div",{className:"mb-2 grid grid-cols-5 gap-1 text-center text-[11px]",children:xa.map(C=>e.jsxs("div",{className:"p-1 rounded bg-slate-800/50 border border-slate-700/50",children:[e.jsx("div",{className:"opacity-70",children:C===25?"Bull":C}),e.jsxs("div",{className:"font-semibold",children:[Math.min(3,j.marks?.[C]||0)," / 3"]})]},C))})})(),e.jsxs("div",{className:"text-sm mb-2",children:["Points: ",e.jsx("span",{className:"font-semibold",children:Ye[Je()]?.points||0})]}),e.jsx("div",{className:"rounded-2xl overflow-hidden bg-black/60 border border-white/10 mb-2",children:e.jsx(Ze,{scoringMode:"custom",showToolbar:!1,immediateAutoCommit:!0,onAutoDart:(f,j,C)=>{Cn(f,j==="MISS"?void 0:j,C?.sector??null)}})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{className:"input w-28",type:"number",min:0,value:he,onChange:f=>ce(parseInt(f.target.value||"0"))}),e.jsx("button",{className:"btn",onClick:()=>{Cn(Math.max(0,he|0)),ce(0)},children:"Add Dart"})]})]}):ve==="Baseball"&&t?.username&&b.players[b.currentPlayerIdx]?.name===t.username?e.jsxs("div",{className:"p-3 rounded-xl bg-black/20",children:[(()=>{const f=Je();hn(f);const j=Ot[f]||Un();return e.jsxs("div",{className:"text-xs mb-1.5",children:["Baseball ÔÇö Inning ",j.inning," ÔÇó Runs ",j.score]})})(),e.jsx("div",{className:"rounded-2xl overflow-hidden bg-black/60 border border-white/10 mb-2",children:e.jsx(Ze,{scoringMode:"custom",showToolbar:!1,immediateAutoCommit:!0,onAutoDart:(f,j,C)=>{fn(f,j==="MISS"?void 0:j,C?.sector??null)}})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{className:"input w-28",type:"number",min:0,value:he,onChange:f=>ce(parseInt(f.target.value||"0"))}),e.jsx("button",{className:"btn",onClick:()=>{fn(Math.max(0,he|0)),ce(0)},children:"Add Dart"})]})]}):ve==="Golf"&&t?.username&&b.players[b.currentPlayerIdx]?.name===t.username?e.jsxs("div",{className:"p-3 rounded-xl bg-black/20",children:[(()=>{const f=Je();tn(f);const j=J[f]||$n();return e.jsxs("div",{className:"text-xs mb-1.5",children:["Golf ÔÇö Hole ",j.hole," (target ",al[j.hole],") ÔÇó Strokes ",j.strokes]})})(),e.jsx("div",{className:"rounded-2xl overflow-hidden bg-black/60 border border-white/10 mb-2",children:e.jsx(Ze,{scoringMode:"custom",showToolbar:!1,immediateAutoCommit:!0,onAutoDart:(f,j,C)=>{kn(f,j==="MISS"?void 0:j,C?.sector??null)}})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{className:"input w-28",type:"number",min:0,value:he,onChange:f=>ce(parseInt(f.target.value||"0"))}),e.jsx("button",{className:"btn",onClick:()=>{kn(Math.max(0,he|0)),ce(0)},children:"Add Dart"})]})]}):ve==="Tic Tac Toe"&&t?.username&&b.players[b.currentPlayerIdx]?.name===t.username?e.jsxs("div",{className:"p-3 rounded-xl bg-black/20",children:[e.jsx("div",{className:"text-xs mb-1.5",children:"Tic Tac Toe ÔÇö Tap a cell to claim by hitting its target"}),e.jsx("div",{className:"grid grid-cols-3 gap-1 mb-2",children:Array.from({length:9},(f,j)=>j).map(f=>e.jsx("button",{className:`h-12 rounded-xl border ${le.board[f]?"bg-emerald-500/20 border-emerald-400/30":"bg-slate-800/50 border-slate-700/50"}`,onClick:()=>{if(le.finished||le.board[f])return;const j=Fn[f],C=Number(Rt||0),P=C%3===0?"TRIPLE":C%2===0?"DOUBLE":"SINGLE",Q=j.type==="BULL"?null:j.num||null;sn(f,C,P,Q),Pt("")},children:le.board[f]||""},f))}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{className:"input w-40 text-sm",placeholder:"Enter dart score (e.g. 20, 40, 60, 25, 50)",value:Rt,onChange:f=>Pt(f.target.value),onKeyDown:f=>{if(f.key==="Enter"){const j=Array.from({length:9},(C,P)=>P).find(C=>!le.board[C]&&!le.finished);if(j!==void 0){const C=Fn[j],P=Number(Rt||0),Q=P%3===0?"TRIPLE":P%2===0?"DOUBLE":"SINGLE",re=C.type==="BULL"?null:C.num||null;sn(j,P,Q,re),Pt("")}}}}),e.jsx("button",{className:"btn",onClick:()=>{const f=Array.from({length:9},(j,C)=>C).find(j=>!le.board[j]&&!le.finished);if(f!==void 0){const j=Fn[f],C=Number(Rt||0),P=C%3===0?"TRIPLE":C%2===0?"DOUBLE":"SINGLE",Q=j.type==="BULL"?null:j.num||null;sn(f,C,P,Q),Pt("")}},children:"Claim Cell"})]}),e.jsx("div",{className:"rounded-2xl overflow-hidden bg-black/60 border border-white/10 mb-2",children:e.jsx(Ze,{scoringMode:"custom",showToolbar:!1,immediateAutoCommit:!0,onAutoDart:(f,j,C)=>{}})})]}):ve==="Killer"&&t?.username&&b.players[b.currentPlayerIdx]?.name===t.username?e.jsxs("div",{className:"p-3 rounded-xl bg-black/20",children:[e.jsx("div",{className:"text-xs mb-1.5",children:"Killer ÔÇö Hit your own double to become Killer; then remove othersÔÇÖ lives by hitting their doubles/triples."}),e.jsxs("div",{className:"mb-1 text-sm flex items-center justify-between",children:[e.jsx("span",{children:"Your number"}),e.jsx("span",{className:"px-2 py-0.5 rounded-full bg-emerald-500/20 text-emerald-200 border border-emerald-400/30 text-xs font-semibold",children:(()=>{const f=Je();return b.players.forEach(j=>Ws(j.id)),H[f]?.number||"ÔÇö"})()})]}),e.jsxs("div",{className:"text-sm",children:["Lives: ",e.jsx("span",{className:"font-semibold",children:(()=>{const f=Je();return H[f]?.lives??"ÔÇö"})()})," ",(()=>{const f=Je();return H[f]?.isKiller?e.jsx("span",{className:"ml-2 text-emerald-300",children:"KILLER"}):null})()]}),e.jsx("div",{className:"rounded-2xl overflow-hidden bg-black/60 border border-white/10 mb-2",children:e.jsx(Ze,{scoringMode:"custom",showToolbar:!1,immediateAutoCommit:!0,onAutoDart:(f,j,C)=>{Us(j==="MISS"?void 0:j,C?.sector??null)}})}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("input",{className:"input w-24 text-sm",type:"number",min:0,value:he,onChange:f=>ce(parseInt(f.target.value||"0")),onKeyDown:f=>{f.key==="Enter"&&(Us("SINGLE",Math.max(0,he|0)),ce(0))}}),e.jsx("button",{className:"btn px-2 py-0.5 text-xs",onClick:()=>{Us("SINGLE",Math.max(0,he|0)),ce(0)},children:"Add Dart"})]})]}):t?.username&&b.players[b.currentPlayerIdx]?.name===t.username?e.jsxs("div",{className:"p-3 rounded-xl bg-black/20",children:[e.jsxs("div",{className:"text-xs mb-1.5",children:[ve," (online) ÔÇö manual turn entry"]}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("input",{className:"input w-24 text-sm",type:"number",min:0,value:he,onChange:f=>ce(parseInt(f.target.value||"0"))}),e.jsx("button",{className:"btn",onClick:()=>{const f=Math.max(0,he|0);b.addVisit(f,3),ce(0),b.nextPlayer(),xe()},children:"Submit"}),e.jsx("button",{className:"btn px-2 py-0.5 text-xs bg-slate-700 hover:bg-slate-800",onClick:()=>{b.undoVisit(),xe()},children:"Undo"})]})]}):e.jsx("div",{className:"p-4 rounded-xl bg-slate-800/30 border border-slate-700/40 text-center text-slate-300 font-semibold",children:"WAITING TO THROW"}),e.jsxs("div",{className:"mt-2 flex items-center gap-1.5",children:[e.jsx("button",{className:"btn px-2 py-0.5 text-xs",onClick:()=>x(!0),children:"Quick Chat"}),e.jsx("button",{className:"btn px-2 py-0.5 text-xs",onClick:()=>g(!0),children:"Messages"})]})]}):e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-2",children:[e.jsx("div",{className:"space-y-1.5",children:e.jsx(qe,{})}),e.jsxs("div",{className:`md:col-span-${We} space-y-1.5 relative`,children:[e.jsxs("div",{className:"flex items-center gap-1.5 mt-2",children:[e.jsx("button",{className:`btn ${ye}`,onClick:()=>{try{window.dispatchEvent(new Event("ndn:open-autoscore"))}catch{}},children:"Autoscore"}),e.jsx("button",{className:`btn ${ye}`,onClick:()=>{try{window.dispatchEvent(new Event("ndn:open-scoring"))}catch{}},children:"Scoring"}),e.jsx("button",{className:`btn ${ye}`,onClick:En,children:"Manual Correction"}),e.jsxs("div",{className:"ml-auto flex items-center gap-1",children:[e.jsx("span",{className:"text-xs opacity-70",children:"Cam"}),e.jsx("button",{className:`btn ${ye}`,onClick:()=>Z(Math.max(.5,Math.round((R-.05)*100)/100)),children:"−"}),e.jsxs("span",{className:`btn ${ye} bg-transparent border-slate-600 text-center min-w-[3rem]`,children:[Math.round(R*100),"%"]}),e.jsx("button",{className:`btn ${ye}`,onClick:()=>Z(Math.min(1.25,Math.round((R+.05)*100)/100)),children:"+"}),e.jsx("button",{className:`btn ${ye}`,onClick:()=>Ve(We===2?3:2),title:We===2?"Expand camera":"Shrink camera",children:We===2?"↔":"↙"})]})]}),e.jsxs("div",{className:"mt-2 relative",children:[e.jsx("div",{className:"w-full max-w-full",children:e.jsx(ca,{label:"Your Board",autoStart:t?.username&&b.players[b.currentPlayerIdx]?.name===t.username})}),We<3&&e.jsx("div",{className:"absolute right-0 top-0 bottom-0 w-2 cursor-ew-resize bg-slate-600/20 hover:bg-slate-600/40 transition-colors flex items-center justify-center group",onMouseDown:f=>{f.preventDefault();const j=f.clientX,C=We,P=re=>{re.clientX-j>50&&C===2&&Ve(3)},Q=()=>{document.removeEventListener("mousemove",P),document.removeEventListener("mouseup",Q)};document.addEventListener("mousemove",P),document.addEventListener("mouseup",Q)},children:e.jsx("div",{className:"w-0.5 h-8 bg-slate-400 group-hover:bg-slate-300 transition-colors"})})]}),e.jsxs("div",{className:"font-semibold text-sm md:text-base",children:["Current: ",b.players[b.currentPlayerIdx]?.name||"ÔÇö"]}),ve==="X01"&&t?.username&&b.players[b.currentPlayerIdx]?.name===t.username?e.jsxs(e.Fragment,{children:[e.jsx(Ze,{hideInlinePanels:!0,showToolbar:!1,onVisitCommitted:(f,j,C)=>{if(T){const Q=b.players[b.currentPlayerIdx],re=Q?.legs[Q.legs.length-1],oe=re?re.totalScoreRemaining:b.startingScore;ia(t?.username||"Player",f,Math.max(0,oe),U,{volume:w,checkoutOnly:_})}const P=b.players[b.currentPlayerIdx];t?.username&&P?.name===t.username&&rn(t.username,j,f);try{f===180&&Vt("180",P?.name||"Player"),C&&Vt("leg",P?.name||"Player")}catch{}C||b.nextPlayer(),xe()}}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{className:"input w-28",type:"number",min:0,value:he,onChange:f=>ce(parseInt(f.target.value||"0"))}),e.jsx("button",{className:"btn",onClick:()=>zs(he),children:"Submit Visit (Manual)"}),e.jsx("button",{className:"btn bg-slate-700 hover:bg-slate-800",onClick:()=>{b.undoVisit(),xe()},children:"Undo"})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2 mt-2 text-sm",children:[e.jsx("span",{className:"opacity-70",children:"Quick:"}),[180,140,100,60].map(f=>e.jsx("button",{className:"btn px-3 py-1 text-sm",onClick:()=>zs(f),children:f},f))]}),(()=>{const f=b.players[b.currentPlayerIdx],j=f?.legs?.[f.legs?.length-1],C=j?j.totalScoreRemaining:b.startingScore;return C>0&&C<=170?e.jsxs("div",{className:"mt-2 p-2 rounded-lg bg-indigo-50 border border-indigo-200 text-indigo-900 text-sm",children:["Checkout suggestions (fav ",z,"): ",la(C,z).join("  ÔÇó  ")||"ÔÇö"]}):null})()]}):ve==="Double Practice"&&t?.username&&b.players[b.currentPlayerIdx]?.name===t.username?e.jsxs("div",{className:"p-3 rounded-xl bg-black/20",children:[e.jsx("div",{className:"text-sm mb-2",children:"Double Practice ÔÇö Hit doubles D1ÔåÆD20ÔåÆDBULL"}),e.jsxs("div",{className:"mb-1 text-sm flex items-center justify-between",children:[e.jsx("span",{children:"Current target"}),e.jsx("span",{className:"px-2 py-0.5 rounded-full bg-emerald-500/20 text-emerald-200 border border-emerald-400/30 text-xs font-semibold",children:ys[rt]?.label||"ÔÇö"})]}),e.jsxs("div",{className:"text-2xl font-extrabold mb-2",children:[mt," / ",ys.length]}),e.jsx("div",{className:"rounded-2xl overflow-hidden bg-black/60 border border-white/10 mb-2",children:e.jsx(Ze,{scoringMode:"custom",showToolbar:!1,immediateAutoCommit:!0,onAutoDart:(f,j)=>{(j==="DOUBLE"||j==="INNER_BULL")&&bt(f)}})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{className:"input w-28",type:"number",min:0,value:he,onChange:f=>ce(parseInt(f.target.value||"0")),onKeyDown:f=>{f.key==="Enter"&&xt()}}),e.jsx("button",{className:"btn",onClick:xt,children:"Add Dart"})]}),e.jsxs("div",{className:"flex items-center gap-2 mt-1.5",children:[e.jsx("input",{className:"input w-44",placeholder:"Manual (D16, 50, 25, T20)",value:ne,onChange:f=>de(f.target.value),onKeyDown:f=>{f.key==="Enter"&&gt()}}),e.jsx("button",{className:"btn",onClick:gt,children:"Add"})]})]}):ve==="Cricket"&&t?.username&&b.players[b.currentPlayerIdx]?.name===t.username?e.jsxs("div",{className:"p-3 rounded-xl bg-black/20",children:[e.jsx("div",{className:"text-sm mb-2",children:"Cricket ÔÇö Close 15-20 and Bull; overflow scores points"}),(()=>{const f=Je();Os(f);const j=Oe[f]||on();return e.jsx("div",{className:"mb-2 grid grid-cols-7 gap-1 text-center text-[11px]",children:qn.map(C=>e.jsxs("div",{className:"p-1 rounded bg-slate-800/50 border border-slate-700/50",children:[e.jsx("div",{className:"opacity-70",children:C===25?"Bull":C}),e.jsxs("div",{className:"font-semibold",children:[Math.min(3,j.marks?.[C]||0)," / 3"]})]},C))})})(),e.jsxs("div",{className:"text-sm mb-2",children:["Points: ",e.jsx("span",{className:"font-semibold",children:Oe[Je()]?.points||0})]}),e.jsx("div",{className:"rounded-2xl overflow-hidden bg-black/60 border border-white/10 mb-2",children:e.jsx(Ze,{scoringMode:"custom",showToolbar:!1,immediateAutoCommit:!0,onAutoDart:(f,j,C)=>{ns(f,j==="MISS"?void 0:j,C?.sector??null)}})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{className:"input w-28",type:"number",min:0,value:he,onChange:f=>ce(parseInt(f.target.value||"0"))}),e.jsx("button",{className:"btn",onClick:()=>{ns(Math.max(0,he|0)),ce(0)},children:"Add Dart"})]})]}):ve==="Shanghai"&&t?.username&&b.players[b.currentPlayerIdx]?.name===t.username?e.jsxs("div",{className:"p-3 rounded-xl bg-black/20",children:[(()=>{const f=Je();en(f);const j=Et[f]||Js();return e.jsx(e.Fragment,{children:e.jsxs("div",{className:"text-sm mb-2",children:["Shanghai ÔÇö Round ",j.round," ÔÇó Score ",j.score]})})})(),e.jsx("div",{className:"rounded-2xl overflow-hidden bg-black/60 border border-white/10 mb-2",children:e.jsx(Ze,{scoringMode:"custom",showToolbar:!1,immediateAutoCommit:!0,onAutoDart:(f,j,C)=>{bs(f,j==="MISS"?void 0:j,C?.sector??null)}})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{className:"input w-28",type:"number",min:0,value:he,onChange:f=>ce(parseInt(f.target.value||"0"))}),e.jsx("button",{className:"btn",onClick:()=>{bs(Math.max(0,he|0)),ce(0)},children:"Add Dart"})]})]}):ve==="Halve It"&&t?.username&&b.players[b.currentPlayerIdx]?.name===t.username?e.jsxs("div",{className:"p-3 rounded-xl bg-black/20",children:[(()=>{const f=Je();Ns(f);const j=ht[f]||Ks(),C=da(j);return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"text-sm mb-2",children:["Halve It ÔÇö Stage ",j.stage+1,"/",j.targets.length," ÔÇó Score ",j.score]}),e.jsxs("div",{className:"text-sm",children:["Target: ",e.jsx("span",{className:"font-semibold",children:(()=>{const P=C;return P?P.kind==="ANY_NUMBER"?"Any":P.kind==="BULL"?"Bull":P.kind==="DOUBLE"||P.kind==="TRIPLE"||P.kind==="NUMBER"?`${P.kind} ${P.num}`:"ÔÇö":"ÔÇö"})()})]})]})})(),e.jsx("div",{className:"rounded-2xl overflow-hidden bg-black/60 border border-white/10 mb-2",children:e.jsx(Ze,{scoringMode:"custom",showToolbar:!1,immediateAutoCommit:!0,onAutoDart:(f,j,C)=>{Bs(f,j==="MISS"?void 0:j,C?.sector??null)}})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{className:"input w-28",type:"number",min:0,value:he,onChange:f=>ce(parseInt(f.target.value||"0"))}),e.jsx("button",{className:"btn",onClick:()=>{Bs(Math.max(0,he|0)),ce(0)},children:"Add Dart"})]})]}):ve==="High-Low"&&t?.username&&b.players[b.currentPlayerIdx]?.name===t.username?e.jsxs("div",{className:"p-3 rounded-xl bg-black/20",children:[(()=>{const f=Je();Hs(f);const j=jt[f]||Ys();return e.jsx(e.Fragment,{children:e.jsxs("div",{className:"text-sm mb-2",children:["High-Low ÔÇö Round ",j.round," ÔÇó Target ",j.target," ÔÇó Score ",j.score]})})})(),e.jsx("div",{className:"rounded-2xl overflow-hidden bg-black/60 border border-white/10 mb-2",children:e.jsx(Ze,{scoringMode:"custom",showToolbar:!1,immediateAutoCommit:!0,onAutoDart:(f,j,C)=>{Ss(f,j==="MISS"?void 0:j,C?.sector??null)}})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{className:"input w-28",type:"number",min:0,value:he,onChange:f=>ce(parseInt(f.target.value||"0"))}),e.jsx("button",{className:"btn",onClick:()=>{Ss(Math.max(0,he|0)),ce(0)},children:"Add Dart"})]})]}):ve==="Killer"&&t?.username&&b.players[b.currentPlayerIdx]?.name===t.username?e.jsxs("div",{className:"p-3 rounded-xl bg-black/20",children:[(()=>{const f=Je();b.players.forEach(C=>Ws(C.id));const j=H[f];return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"text-xs mb-1.5",children:"Killer ÔÇö Hit your own double to become Killer; then remove othersÔÇÖ lives by hitting their doubles/triples."}),e.jsxs("div",{className:"mb-1 text-sm flex items-center justify-between",children:[e.jsx("span",{children:"Your number"}),e.jsx("span",{className:"px-2 py-0.5 rounded-full bg-emerald-500/20 text-emerald-200 border border-emerald-400/30 text-xs font-semibold",children:j?.number||"ÔÇö"})]}),e.jsxs("div",{className:"text-sm",children:["Lives: ",e.jsx("span",{className:"font-semibold",children:j?.lives??"ÔÇö"})," ",j?.isKiller?e.jsx("span",{className:"ml-2 text-emerald-300",children:"KILLER"}):null]}),e.jsx("div",{className:"mt-2 grid grid-cols-2 md:grid-cols-3 gap-1 text-[11px]",children:b.players.map(C=>{const P=H[C.id];return e.jsxs("div",{className:"p-1 rounded bg-slate-800/50 border border-slate-700/50 flex items-center justify-between",children:[e.jsx("span",{className:"opacity-80 truncate",children:C.name}),e.jsx("span",{className:"font-mono",children:P?`#${P.number} = ${P.lives}ÔØñ${P.isKiller?" = K":""}`:"ÔÇö"})]},C.id)})})]})})(),e.jsx("div",{className:"rounded-2xl overflow-hidden bg-black/60 border border-white/10 my-2",children:e.jsx(Ze,{scoringMode:"custom",showToolbar:!1,immediateAutoCommit:!0,onAutoDart:(f,j,C)=>{Us(j==="MISS"?void 0:j,C?.sector??null)}})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{className:"input w-28",type:"number",min:0,value:he,onChange:f=>ce(parseInt(f.target.value||"0"))}),e.jsx("button",{className:"btn",onClick:()=>{Us("SINGLE",Math.max(0,he|0)),ce(0)},children:"Add Dart"})]}),e.jsx("div",{className:"text-xs opacity-70",children:"Tip: Only doubles/triples on the opponentsÔÇÖ numbers remove lives. To become Killer, hit your own double."})]}):t?.username&&b.players[b.currentPlayerIdx]?.name===t.username?e.jsxs("div",{className:"p-3 rounded-xl bg-black/20",children:[e.jsxs("div",{className:"text-sm mb-2",children:[ve," (online) ÔÇö manual turn entry"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{className:"input w-28",type:"number",min:0,value:he,onChange:f=>ce(parseInt(f.target.value||"0"))}),e.jsx("button",{className:"btn",onClick:()=>{const f=Math.max(0,he|0);b.addVisit(f,3),ce(0),b.nextPlayer(),xe()},children:"Submit"}),e.jsx("button",{className:"btn bg-slate-700 hover:bg-slate-800",onClick:()=>{b.undoVisit(),xe()},children:"Undo"})]})]}):e.jsx("div",{className:"p-4 rounded-xl bg-slate-800/30 border border-slate-700/40 text-center text-slate-300 font-semibold",children:"WAITING TO THROW"})]}),e.jsx("div",{className:"md:col-span-1",children:e.jsxs("div",{className:"flex flex-wrap items-center gap-1.5",children:[e.jsx("button",{className:"btn px-2 py-0.5 text-xs",onClick:()=>x(!0),children:"Quick Chat"}),e.jsx("button",{className:"btn px-2 py-0.5 text-xs",onClick:()=>g(!0),children:"Messages"})]})})]})]})})]})]}),mn&&e.jsx("div",{className:"fixed inset-0 bg-black/70 z-50",children:e.jsx("div",{className:"w-full h-full flex items-stretch justify-stretch p-0",children:e.jsxs(Qs,{storageKey:"ndn:modal:create-match",className:"w-full h-full rounded-none !border-0 !shadow-none relative",fullScreen:!0,children:[e.jsx("div",{className:"flex items-center justify-between mb-3 sticky top-0 bg-slate-900/80 backdrop-blur border-b border-slate-700 z-10 px-2 py-2",children:e.jsx("h3",{className:"text-xl font-bold",children:"Create Match"})}),e.jsxs("div",{className:"space-y-3 md:space-y-0 md:grid md:grid-cols-2 md:gap-4 overflow-auto px-2",style:{maxHeight:"calc(100vh - 120px)"},children:[e.jsxs("div",{className:"col-span-1",children:[e.jsx("label",{className:"block text-sm text-slate-300 mb-1",children:"Game"}),e.jsx("select",{className:"input w-full",value:ft,onChange:f=>Ms(f.target.value),children:Nn.map(f=>e.jsxs("option",{value:f,disabled:!t?.fullAccess&&Vs.includes(f),children:[f," ",!t?.fullAccess&&Vs.includes(f)?"(PREMIUM)":""]},f))})]}),e.jsxs("div",{className:"col-span-1",children:[e.jsx("label",{className:"block text-sm text-slate-300 mb-1",children:"Mode"}),e.jsxs("select",{className:"input w-full",value:K,onChange:f=>q(f.target.value),children:[e.jsx("option",{value:"bestof",children:"Best Of"}),e.jsx("option",{value:"firstto",children:"First To"})]})]}),e.jsxs("div",{className:"col-span-1",children:[e.jsx("label",{className:"block text-sm text-slate-300 mb-1",children:"Value"}),ft==="X01"?e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"flex flex-wrap gap-1",children:[101,201,301,401,501].map(f=>e.jsx("button",{className:`btn px-2 py-1 text-xs ${V===f?"bg-purple-600 hover:bg-purple-700":""}`,onClick:()=>Ce(f),children:f},f))}),e.jsx("input",{className:"input w-full",type:"number",min:1,value:V,onChange:f=>Ce(parseInt(f.target.value||"1")),placeholder:"Or enter custom value"})]}):e.jsx("input",{className:"input w-full",type:"number",min:1,value:V,onChange:f=>Ce(parseInt(f.target.value||"1"))}),e.jsx("div",{className:"text-xs opacity-70 mt-1",children:"Example: Best Of 5 — first to 3"})]}),e.jsxs("div",{className:"col-span-1",children:[e.jsx("label",{className:"block text-sm text-slate-300 mb-1",children:"Starting Score"}),ft==="X01"?e.jsx("select",{className:"input w-full",value:pe,onChange:f=>Fe(parseInt(f.target.value||"501")),children:[301,501,701].map(f=>e.jsx("option",{value:f,children:f},f))}):e.jsx("div",{className:"text-xs opacity-70 mt-1",children:"Starting score applies to X01 only"})]}),e.jsxs("div",{className:"col-span-1",children:[e.jsx("label",{className:"block text-sm text-slate-300 mb-1",children:"Require Calibration"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{id:"calibreq",type:"checkbox",className:"accent-purple-500",checked:Xt,onChange:f=>Gt(f.target.checked)}),e.jsx("label",{htmlFor:"calibreq",className:"text-sm opacity-80",children:"Players must be calibrated"})]})]}),e.jsx("div",{className:"col-span-1",children:e.jsxs("div",{className:"p-3 rounded-lg bg-black/20 border border-slate-700/40",children:[e.jsx("div",{className:"text-xs text-slate-300 uppercase tracking-wide mb-1",children:"Summary"}),e.jsxs("div",{className:"text-sm font-semibold",children:[ft," — ",K==="bestof"?`Best Of ${V}`:`First To ${V}`," ",ft==="X01"?`— ${pe}`:""]}),!t?.fullAccess&&Vs.includes(ft)&&e.jsx("div",{className:"text-xs text-rose-300 mt-1",children:"PREMIUM required"})]})})]}),e.jsxs("div",{className:"sticky bottom-0 bg-slate-900/80 backdrop-blur border-t border-slate-700 z-10 px-2 py-2",children:[e.jsx("button",{className:"btn w-full",disabled:!t?.fullAccess&&Vs.includes(ft),title:!t?.fullAccess&&Vs.includes(ft)?"PREMIUM game":"",onClick:()=>{const f=t?.username?Xs(t.username):0;i?(i.send({type:"create-match",game:ft,mode:K,value:V,startingScore:pe,creatorAvg:f,requireCalibration:Xt}),os(!1),i.send({type:"list-matches"})):(N.current?.send(JSON.stringify({type:"create-match",game:ft,mode:K,value:V,startingScore:pe,creatorAvg:f,requireCalibration:Xt})),os(!1),N.current?.send(JSON.stringify({type:"list-matches"})))},children:"START GAME!"}),e.jsx("div",{className:"flex justify-center mt-2",children:e.jsx("button",{className:"btn px-2 py-1",onClick:()=>os(!1),children:"Close"})})]})]})})}),be&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50",children:e.jsxs(Qs,{storageKey:"ndn:modal:invite",className:"w-full relative",defaultWidth:620,defaultHeight:420,minWidth:520,minHeight:320,maxWidth:1e3,maxHeight:800,children:[e.jsx("h3",{className:"text-xl font-bold mb-1",children:"Incoming Match Request"}),e.jsxs("div",{className:"text-sm mb-2",children:[e.jsx("span",{className:"font-semibold",children:be.fromName})," wants to join your match.",e.jsx("span",{className:`ml-2 text-xs px-2 py-0.5 rounded ${be.calibrated?"bg-emerald-500/20 text-emerald-300 border border-emerald-600/30":"bg-amber-500/20 text-amber-200 border border-amber-600/30"}`,children:be.calibrated?"Calibrated":"Not calibrated"})]}),(be.game||be.mode)&&e.jsxs("div",{className:"text-xs opacity-80 mb-3",children:[be.game||"X01"," ÔÇó ",be.mode==="firstto"?`First To ${be.value}`:`Best Of ${be.value}`," ",be.game==="X01"&&be.startingScore?`ÔÇó ${be.startingScore}`:""]}),be.boardPreview?e.jsx("div",{className:"mb-3",children:e.jsx("img",{src:be.boardPreview,alt:"Board preview",className:"rounded-lg w-full max-h-64 object-contain bg-black/40 border border-slate-700"})}):e.jsx("div",{className:"mb-3 text-xs opacity-60",children:"No camera preview provided."}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{className:"btn bg-emerald-600 hover:bg-emerald-700",onClick:()=>{i?i.send({type:"invite-response",matchId:be.matchId,accept:!0,toId:be.fromId}):N.current?.send(JSON.stringify({type:"invite-response",matchId:be.matchId,accept:!0,toId:be.fromId})),ot(null)},children:"Accept"}),e.jsx("button",{className:"btn bg-rose-600 hover:bg-rose-700",onClick:()=>{i?i.send({type:"invite-response",matchId:be.matchId,accept:!1,toId:be.fromId}):N.current?.send(JSON.stringify({type:"invite-response",matchId:be.matchId,accept:!1,toId:be.fromId})),ot(null)},children:"Decline"})]})]})}),h&&e.jsx("div",{className:"fixed inset-0 bg-black/60 z-50 flex items-center justify-center",children:e.jsxs(Qs,{storageKey:"ndn:modal:quick-chat",className:"w-full relative",defaultWidth:520,defaultHeight:280,minWidth:360,minHeight:220,maxWidth:900,maxHeight:700,children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Quick Chat"}),e.jsx("button",{className:"btn px-2 py-1 text-sm",onClick:()=>x(!1),children:"Close"})]}),e.jsx("div",{className:"flex flex-wrap gap-1.5",children:["Good luck!","Good game!","Nice darts!","Well played!","Ready?"].map(f=>e.jsx("button",{className:"btn px-2 py-0.5 text-xs",onClick:()=>{Be(f),x(!1)},disabled:!l,children:f},f))})]})}),p&&e.jsx("div",{className:"fixed inset-0 bg-black/60 z-50 flex items-center justify-center",children:e.jsxs(Qs,{storageKey:"ndn:modal:messages",className:"w-full relative",defaultWidth:560,defaultHeight:360,minWidth:380,minHeight:260,maxWidth:1e3,maxHeight:800,children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Messages"}),e.jsx("button",{className:"btn px-2 py-1 text-sm",onClick:()=>g(!1),children:"Close"})]}),e.jsx(Mm,{items:c.slice(-30).filter(f=>!n.isBlocked(String(f.fromId||""))).map((f,j)=>({key:String(j),from:f.from,id:String(f.fromId||f.from),text:f.message})),onDelete:f=>u(j=>j.filter((C,P)=>P!==f)),onReport:f=>{const C=c.slice(-30).filter(P=>!n.isBlocked(String(P.fromId||"")))[f];C&&Vn(null,C.message)},onBlock:f=>{const C=c.slice(-30).filter(P=>!n.isBlocked(String(P.fromId||"")))[f];if(C){try{n.block(String(C.fromId||C.from))}catch{}u(P=>P.filter(Q=>String(Q.fromId||Q.from)!==String(C.fromId||C.from)));try{s(`${C.from} blocked`,{type:"info"})}catch{}}}})]})})]})}function Mm({items:t,onDelete:a,onReport:s,onBlock:i}){const n=(()=>{try{const c=navigator.userAgent||"";return/Android|iPhone|iPad|iPod|Mobile/i.test(c)}catch{return!1}})(),[r,o]=m.useState(null),[l,d]=m.useState(null);return e.jsx("div",{className:"h-24 overflow-auto text-sm divide-y divide-slate-700/40",children:t.length===0?e.jsx("div",{className:"opacity-60 py-1",children:"No messages yet."}):t.map((c,u)=>{const h=ml(c.text),x=hm(c.text);return e.jsxs("div",{className:"relative group px-1 py-1 flex items-start gap-2",onTouchStart:n?p=>{const g=p.touches[0];o({x:g.clientX,y:g.clientY,i:u,t:Date.now()})}:void 0,onTouchMove:n?p=>{if(!r||r.i!==u)return;p.touches[0].clientX-r.x<-40&&d(u)}:void 0,onTouchEnd:n?()=>{const p=r?Date.now()-r.t:0;(l===u||p>600)&&(a(u),d(null)),o(null)}:void 0,children:[e.jsxs("span",{className:"text-slate-400 shrink-0",children:["[",c.from,"]"]}),e.jsx("span",{className:"text-white break-words whitespace-pre-wrap flex-1",children:h}),!n&&e.jsxs("div",{className:"opacity-0 group-hover:opacity-100 transition-opacity flex items-center gap-1 ml-2",children:[e.jsx("button",{className:"w-5 h-5 rounded-full bg-rose-600 hover:bg-rose-700 text-white text-xs flex items-center justify-center",title:"Delete message","aria-label":"Delete message",onClick:()=>a(u),children:"├ù"}),i&&e.jsx("button",{className:"px-1.5 py-0.5 rounded bg-slate-700 hover:bg-slate-800 text-slate-100 text-[11px]",onClick:()=>i(u),title:"Block sender",children:"Block"}),e.jsx("button",{className:"px-1.5 py-0.5 rounded bg-amber-600/40 hover:bg-amber-600/60 text-amber-100 text-[11px]",onClick:()=>s(u),title:"Report message",children:"Report"})]}),x&&e.jsx("span",{className:"ml-2 text-[10px] px-1 rounded bg-rose-600/30 text-rose-200 border border-rose-600/40",children:"Filtered"})]},c.key)})})}function Dm({user:t}){const{players:a,inProgress:s,startingScore:i,newMatch:n}=Bn(),[r,o]=m.useState("x01"),[l,d]=m.useState("Player 1, Player 2"),[c,u]=m.useState(501),[h,x]=m.useState([]),[p,g]=m.useState(""),[S,D]=m.useState(!1),[I,N]=m.useState(""),[E,A]=m.useState([]),[O,M]=m.useState(!1),v=String(t?.email||"").toLowerCase();m.useEffect(()=>{let T=!1;async function U(){try{if(!v)return;const ie=await(await fetch(`/api/friends/list?email=${encodeURIComponent(v)}`)).json().catch(()=>({friends:[]}));T||x(ie.friends||[])}catch{}}U();const w=setInterval(U,2e4);return()=>{T=!0,clearInterval(w)}},[v]),m.useEffect(()=>{try{const T=v?`ndn:stats:opponent:${v}`:"ndn:stats:opponent",U=localStorage.getItem(T);U&&g(U)}catch{}},[v]),m.useEffect(()=>{try{const T=v?`ndn:stats:opponent:${v}`:"ndn:stats:opponent";p?localStorage.setItem(T,p):localStorage.removeItem(T)}catch{}},[p,v]);async function b(T){if(N(T),!T.trim()){A([]);return}M(!0);try{const w=await(await fetch(`/api/friends/search?q=${encodeURIComponent(T)}`)).json().catch(()=>({results:[]}));A(w.results||[])}finally{M(!1)}}const F=m.useMemo(()=>{const T=new Map;if(r==="x01")for(const w of a)for(const _ of w.legs)for(const ie of _.visits){const R=Math.max(0,Math.min(180,ie.score));T.set(R,(T.get(R)??0)+1)}const U=Array.from(T.entries()).sort((w,_)=>w[0]-_[0]);return U.length===0&&r==="x01"?([0,26,41,60,81,100,120,140,160,180].forEach(w=>T.set(w,0)),Array.from(T.entries()).sort((w,_)=>w[0]-_[0]).map(([w,_])=>({label:w,value:_}))):U.map(([w,_])=>({label:w,value:_}))},[a,r]),z=m.useMemo(()=>{const T=Mr(Nn);return Nn.map(U=>{const w=T[U]||{played:0,won:0};return{label:U,value:w.played,extra:w.won}})},[r]);return m.useEffect(()=>{const T=()=>o(U=>U);return window.addEventListener("ndn:stats-updated",T),()=>window.removeEventListener("ndn:stats-updated",T)},[]),e.jsxs("div",{className:"card",children:[e.jsxs("div",{className:"mb-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h2",{className:"text-xl font-semibold",children:"Match Stats"}),e.jsx("span",{className:"text-xs opacity-70",children:"View"})]}),e.jsx(pa,{tabs:[{key:"x01",label:"X01"},{key:"other",label:"Other Modes"}],active:r,onChange:T=>o(T)})]}),a.length===0&&e.jsxs("div",{className:"mb-4 p-3 rounded-xl border border-indigo-500/40 bg-indigo-500/10",children:[e.jsx("div",{className:"font-semibold mb-2",children:"No match data yet"}),e.jsx("div",{className:"text-sm opacity-80 mb-2",children:"Start a quick X01 match to generate stats. Stats like Best/Worst 3-dart are finalized when you end the game."}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-2 items-end",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-slate-300 mb-1",children:"Players (comma separated)"}),e.jsx("input",{className:"input w-full",value:l,onChange:T=>d(T.target.value)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-slate-300 mb-1",children:"Starting Score"}),e.jsx("input",{className:"input w-full",type:"number",value:c,onChange:T=>u(parseInt(T.target.value||"501"))})]}),e.jsx("div",{children:e.jsx("button",{className:"btn w-full",onClick:()=>{const T=l.split(",").map(U=>U.trim()).filter(Boolean);if(!T.length)return alert("Enter at least one player");n(T,c)},children:"Start Match"})})]})]}),s&&e.jsx("div",{className:"mb-3 p-2 rounded-lg text-sm border border-amber-500/40 bg-amber-500/10 text-amber-200",children:"Note: Detailed leg stats are finalized at the end of the game."}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[a.map((T,U)=>e.jsxs("div",{className:"p-3 rounded-xl border border-indigo-500/40 bg-indigo-500/10",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("div",{className:"font-semibold",children:U===1&&!p?T.name||"Opponent":U===1&&p?p:T.name}),U===1&&e.jsxs("div",{className:"flex flex-wrap gap-2 items-center",children:[e.jsx("button",{className:"text-[11px] px-3 py-1 rounded-full bg-white/5 border border-white/10 hover:bg-white/10",onClick:()=>D(w=>!w),title:"Search user to compare",children:"Select Friend"}),h.slice(0,6).map(w=>{const _=w.username||w.email,ie=p===_;return e.jsx("button",{className:`text-[11px] px-3 py-1 rounded-full border ${ie?"bg-indigo-500/30 border-indigo-400/50":"bg-white/5 border-white/10 hover:bg-white/10"}`,onClick:()=>g(_),title:`Compare vs ${_}`,children:_},w.email)}),h.length===0&&e.jsx("button",{className:"text-[11px] px-3 py-1 rounded-full bg-white/5 border border-white/10",disabled:!0,children:"Find friends to compare"})]})]}),U===1&&S&&e.jsxs("div",{className:"mb-2 p-2 rounded-lg bg-black/20 border border-white/10",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("input",{className:"input flex-1 py-1",placeholder:"Search by name or email",value:I,onChange:w=>b(w.target.value)}),e.jsx("button",{className:"btn px-3 py-1 text-sm",onClick:()=>b(I),disabled:O,children:"Search"})]}),e.jsxs("ul",{className:"max-h-40 overflow-auto space-y-1",children:[E.map(w=>{const _=w.username||w.email;return e.jsx("li",{children:e.jsx("button",{className:"w-full text-left px-2 py-1 rounded bg-white/5 hover:bg-white/10 border border-white/10 text-sm",onClick:()=>{g(_),D(!1)},children:_})},w.email)}),!E.length&&e.jsx("li",{className:"text-xs opacity-70",children:I.trim()?"No results":"Type to search…"})]})]}),U===1&&p?e.jsxs("div",{className:"grid grid-cols-2 gap-2 text-sm",children:[e.jsxs("div",{className:"p-2 rounded-lg bg-white/5 border border-white/10",children:[e.jsx("div",{className:"text-slate-300",children:"Best 3-Dart"}),e.jsx("div",{className:"font-semibold",children:ut(ms(p).best3||0)})]}),e.jsxs("div",{className:"p-2 rounded-lg bg-white/5 border border-white/10",children:[e.jsx("div",{className:"text-slate-300",children:"Worst 3-Dart"}),e.jsx("div",{className:"font-semibold",children:ut(ms(p).worst3||0)})]}),e.jsxs("div",{className:"p-2 rounded-lg bg-white/5 border border-white/10",children:[e.jsx("div",{className:"text-slate-300",children:"Best 9-Dart (fewest darts)"}),e.jsx("div",{className:"font-semibold",children:(()=>{const w=ms(p);return w.bestLegDarts?`${w.bestLegDarts} darts`:"—"})()})]}),e.jsxs("div",{className:"p-2 rounded-lg bg-white/5 border border-white/10",children:[e.jsx("div",{className:"text-slate-300",children:"Best Checkout"}),e.jsx("div",{className:"font-semibold",children:ms(p).bestCheckout||"—"})]}),e.jsxs("div",{className:"p-2 rounded-lg bg-white/5 border border-white/10 col-span-2",children:[e.jsx("div",{className:"text-slate-300",children:"Averages (All-time vs Monthly)"}),e.jsxs("div",{className:"font-semibold flex flex-wrap gap-3 text-[13px]",children:[e.jsxs("span",{children:["3-dart: ",ut(Xs(p))," · ",ut(La(p))]}),e.jsxs("span",{children:["First 9: ",ut(Pa(p))," · ",ut(Oa(p))]})]})]}),e.jsxs("div",{className:"p-2 rounded-lg bg-white/5 border border-white/10 col-span-2",children:[e.jsx("div",{className:"text-slate-300",children:"All-time snapshot"}),(()=>{const w=ms(p);return e.jsxs("div",{className:"font-semibold flex flex-wrap gap-3 text-[13px]",children:[e.jsxs("span",{children:["Best 3-dart: ",ut(w.best3||0)]}),e.jsxs("span",{children:["Worst 3-dart: ",ut(w.worst3||0)]}),e.jsxs("span",{children:["Best leg: ",w.bestLegDarts||0," darts"]}),e.jsxs("span",{children:["Best checkout: ",w.bestCheckout||0]})]})})()]})]}):e.jsxs("div",{className:"grid grid-cols-2 gap-2 text-sm",children:[e.jsxs("div",{className:"p-2 rounded-lg bg-white/5 border border-white/10",children:[e.jsx("div",{className:"text-slate-300",children:"Best 3-Dart"}),e.jsx("div",{className:"font-semibold",children:ut(T.bestThreeDartAvg)})]}),e.jsxs("div",{className:"p-2 rounded-lg bg-white/5 border border-white/10",children:[e.jsx("div",{className:"text-slate-300",children:"Worst 3-Dart"}),e.jsx("div",{className:"font-semibold",children:ut(T.worstThreeDartAvg)})]}),e.jsxs("div",{className:"p-2 rounded-lg bg-white/5 border border-white/10",children:[e.jsx("div",{className:"text-slate-300",children:"Best 9-Dart (fewest darts)"}),e.jsx("div",{className:"font-semibold",children:T.bestNineDart?`${T.bestNineDart.darts} darts`:"—"})]}),e.jsxs("div",{className:"p-2 rounded-lg bg-white/5 border border-white/10",children:[e.jsx("div",{className:"text-slate-300",children:"Best Checkout"}),e.jsx("div",{className:"font-semibold",children:T.bestCheckout??"—"})]}),e.jsxs("div",{className:"p-2 rounded-lg bg-white/5 border border-white/10 col-span-2",children:[e.jsx("div",{className:"text-slate-300",children:"Averages (All-time vs Monthly)"}),e.jsxs("div",{className:"font-semibold flex flex-wrap gap-3 text-[13px]",children:[e.jsxs("span",{children:["3-dart: ",ut(Xs(T.name))," · ",ut(La(T.name))]}),e.jsxs("span",{children:["First 9: ",ut(Pa(T.name))," · ",ut(Oa(T.name))]})]})]}),e.jsxs("div",{className:"p-2 rounded-lg bg-white/5 border border-white/10 col-span-2",children:[e.jsx("div",{className:"text-slate-300",children:"All-time snapshot"}),(()=>{const w=ms(T.name);return e.jsxs("div",{className:"font-semibold flex flex-wrap gap-3 text-[13px]",children:[e.jsxs("span",{children:["Best 3-dart: ",ut(w.best3||0)]}),e.jsxs("span",{children:["Worst 3-dart: ",ut(w.worst3||0)]}),e.jsxs("span",{children:["Best leg: ",w.bestLegDarts||0," darts"]}),e.jsxs("span",{children:["Best checkout: ",w.bestCheckout||0]})]})})()]})]})]},T.id)),a.length<=1&&e.jsxs("div",{className:"p-3 rounded-xl border border-indigo-500/40 bg-indigo-500/10",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("div",{className:"font-semibold",children:"Opponent"}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[h.slice(0,6).map(T=>{const U=T.username||T.email,w=p===(T.username||T.email);return e.jsx("button",{className:`text-[11px] px-3 py-1 rounded-full border ${w?"bg-indigo-500/30 border-indigo-400/50":"bg-white/5 border-white/10 hover:bg-white/10"}`,onClick:()=>g(U),title:`Compare vs ${U}`,children:U},T.email)}),h.length===0&&e.jsx("span",{className:"text-xs opacity-70",children:"Add friends to compare stats."})]})]}),p?e.jsxs("div",{className:"grid grid-cols-2 gap-2 text-sm",children:[e.jsxs("div",{className:"p-2 rounded-lg bg-white/5 border border-white/10 col-span-2",children:[e.jsx("div",{className:"text-slate-300",children:"Comparing to"}),e.jsx("div",{className:"font-semibold",children:p})]}),e.jsxs("div",{className:"p-2 rounded-lg bg-white/5 border border-white/10",children:[e.jsx("div",{className:"text-slate-300",children:"Best 3-Dart"}),e.jsx("div",{className:"font-semibold",children:ut(Xs(p))})]}),e.jsxs("div",{className:"p-2 rounded-lg bg-white/5 border border-white/10",children:[e.jsx("div",{className:"text-slate-300",children:"Worst 3-Dart"}),e.jsx("div",{className:"font-semibold",children:ut(ms(p).worst3||0)})]}),e.jsxs("div",{className:"p-2 rounded-lg bg-white/5 border border-white/10",children:[e.jsx("div",{className:"text-slate-300",children:"Best 9-Dart (fewest darts)"}),e.jsx("div",{className:"font-semibold",children:(()=>{const T=ms(p);return T.bestLegDarts?`${T.bestLegDarts} darts`:"—"})()})]}),e.jsxs("div",{className:"p-2 rounded-lg bg-white/5 border border-white/10",children:[e.jsx("div",{className:"text-slate-300",children:"Best Checkout"}),e.jsx("div",{className:"font-semibold",children:ms(p).bestCheckout||"—"})]}),e.jsxs("div",{className:"p-2 rounded-lg bg-white/5 border border-white/10 col-span-2",children:[e.jsx("div",{className:"text-slate-300",children:"Averages (All-time vs Monthly)"}),e.jsxs("div",{className:"font-semibold flex flex-wrap gap-3 text-[13px]",children:[e.jsxs("span",{children:["3-dart: ",ut(Xs(p))," · ",ut(La(p))]}),e.jsxs("span",{children:["First 9: ",ut(Pa(p))," · ",ut(Oa(p))]})]})]}),e.jsxs("div",{className:"p-2 rounded-lg bg-white/5 border border-white/10 col-span-2",children:[e.jsx("div",{className:"text-slate-300",children:"All-time snapshot"}),(()=>{const T=ms(p);return e.jsxs("div",{className:"font-semibold flex flex-wrap gap-3 text-[13px]",children:[e.jsxs("span",{children:["Best 3-dart: ",ut(T.best3||0)]}),e.jsxs("span",{children:["Worst 3-dart: ",ut(T.worst3||0)]}),e.jsxs("span",{children:["Best leg: ",T.bestLegDarts||0," darts"]}),e.jsxs("span",{children:["Best checkout: ",T.bestCheckout||0]})]})})()]})]}):e.jsx("div",{className:"text-sm opacity-70",children:"Select a friend above to compare."})]})]}),e.jsxs("div",{className:"mt-6",children:[e.jsxs("div",{className:"mb-2 text-sm opacity-80",children:["Score Distribution (",r.toUpperCase(),"): Visits by scored points"]}),e.jsx("div",{className:"rounded-xl border border-indigo-500/40 bg-indigo-500/10 p-3",children:e.jsx(Tr,{data:F,showValues:!1})})]}),e.jsxs("div",{className:"mt-6",children:[e.jsx("div",{className:"mb-2 text-sm opacity-80",children:"Other Modes: games played (bar height) with wins shown beneath each label"}),e.jsxs("div",{className:"rounded-xl border border-indigo-500/40 bg-indigo-500/10 p-3",children:[e.jsx(Tr,{data:z.map(T=>({label:T.label,value:T.value})),showValues:!1}),e.jsx("div",{className:"mt-2 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-2 text-[11px] opacity-80",children:z.map((T,U)=>e.jsxs("div",{className:"flex items-center justify-between px-2 py-1 rounded-md bg-white/5 border border-white/10",children:[e.jsx("span",{className:"truncate mr-2",children:T.label}),e.jsxs("span",{className:"whitespace-nowrap",children:["Played ",T.value," · Won ",T.extra]})]},U))})]})]})]})}function Am({user:t}){const a=wn(),s=(()=>{try{return Lr()}catch{return null}})(),[i,n]=m.useState([]),[r,o]=m.useState(!1),[l,d]=m.useState(""),[c,u]=m.useState(null),[h,x]=m.useState(!1),[p,g]=m.useState({open:!1,t:null}),[S,D]=m.useState({open:!1,t:null}),[I,N]=m.useState({title:"Community X01 Tournament",game:"X01",mode:"bestof",value:3,description:"",startAt:new Date(Date.now()+7200*1e3).toISOString().slice(0,16),checkinMinutes:15,capacity:8,startingScore:501}),E=(()=>{try{return"ontouchstart"in window||(navigator.maxTouchPoints||0)>0}catch{return!1}})();async function A(){try{const Z=await(await kt("/api/tournaments")).json();n(Array.isArray(Z.tournaments)?Z.tournaments:[])}catch{}}m.useEffect(()=>{A()},[]),m.useEffect(()=>{if(!s)return;const R=s.addListener(Z=>{try{Z.type==="tournaments"&&n(Z.tournaments||[]),Z.type==="tournament-win"&&Z.message&&a(Z.message,{type:"success",timeout:1e4})}catch{}});return()=>{R()}},[s?.connected]);const O=String(t?.email||"").toLowerCase();m.useEffect(()=>{let R=!1;async function Z(){if(!O){u(null);return}try{const Me=await(await kt(`/api/subscription?email=${encodeURIComponent(O)}`)).json();R||(Me?.source==="tournament"&&typeof Me.expiresAt=="number"&&Me.expiresAt>Date.now()?u(Me.expiresAt):u(null))}catch{R||u(null)}}return Z(),()=>{R=!0}},[O]);function M(R){return!!R.participants?.some(Z=>Z.email===O)}async function v(R){O&&D({open:!0,t:R})}async function b(){const R=S.t;if(!(!R||!O)){D({open:!1,t:null}),o(!0);try{let Z=await kt("/api/tournaments/delete",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({tournamentId:R.id,requesterEmail:O})});if(!Z.ok&&Z.status===403&&String(O)==="daviesfamily108@gmail.com"&&(Z=await kt("/api/admin/tournaments/delete",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({tournamentId:R.id,requesterEmail:O})})),!Z.ok){let ae="Delete failed";try{const Me=await Z.json();Me?.error&&(ae=`Delete failed: ${String(Me.error)}`)}catch{}a(ae,{type:"error"});return}a("Tournament deleted",{type:"success"}),await A()}finally{o(!1)}}}async function F(R){if(O){o(!0);try{const Z=await kt("/api/tournaments/join",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({tournamentId:R.id,email:O,username:t?.username})});if(!Z.ok){let ae={};try{ae=await Z.json()}catch{}ae?.error==="WINNER_COOLDOWN"&&typeof ae.until=="number"?(d(`You're a recent NDN tournament winner. You can re-enter after ${ie(ae.until)}.`),setTimeout(()=>d(""),6e3),a("Join blocked: winner cooldown active",{type:"error"})):ae?.error==="ALREADY_IN_TOURNAMENT"?(d(String(ae.message||"You can only join one tournament at a time.")),setTimeout(()=>d(""),6e3),a("Join blocked: already in another tournament",{type:"error"})):ae?.error&&(d(String(ae.error)),setTimeout(()=>d(""),3500),a(`Join failed: ${String(ae.error)}`,{type:"error"}));return}a("Joined tournament",{type:"success"}),await A()}finally{o(!1)}}}async function z(R){if(O){o(!0);try{const Z=await kt("/api/tournaments/leave",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({tournamentId:R.id,email:O})});if(!Z.ok){let ae={};try{ae=await Z.json()}catch{}ae?.error?a(`Leave failed: ${String(ae.error)}`,{type:"error"}):Z.status===404?a("Leave failed (endpoint not found). Restart the server to enable /api/tournaments/leave.",{type:"error"}):a("Leave failed. Please try again.",{type:"error"});return}a("Left tournament",{type:"success"}),n(ae=>ae.map(Me=>Me.id===R.id?{...Me,participants:(Me.participants||[]).filter(st=>st.email!==O)}:Me)),await A()}finally{o(!1)}}}async function T(){o(!0);try{const R=new Date(I.startAt).getTime();await kt("/api/tournaments/create",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:I.title,game:I.game,mode:I.mode,value:Number(I.value),description:I.description,startAt:R,checkinMinutes:Number(I.checkinMinutes),capacity:Number(I.capacity),startingScore:I.game==="X01"?Number(I.startingScore||501):void 0,creatorEmail:t?.email,creatorName:t?.username})}),x(!1),a("Tournament created",{type:"success"}),await A()}finally{o(!1)}}m.useEffect(()=>{if(!h)return;const R=Z=>{Z.key==="Escape"&&x(!1)};return document.addEventListener("keydown",R),()=>document.removeEventListener("keydown",R)},[h]);const U=m.useMemo(()=>i.filter(R=>R.official),[i]),w=m.useMemo(()=>i.filter(R=>!R.official),[i]),_=m.useMemo(()=>U.filter(Z=>Z.status==="scheduled").sort((Z,ae)=>Z.startAt-ae.startAt)[0]||null,[U]);function ie(R){return new Date(R).toLocaleString()}return e.jsxs("div",{className:"card",children:[e.jsx("div",{className:"flex items-center justify-between mb-3",children:e.jsx("h2",{className:"text-2xl font-bold",children:"Tournaments"})}),e.jsx("div",{className:"mb-3 p-3 rounded-xl bg-indigo-500/10 border border-indigo-500/40 flex items-center justify-end",children:e.jsx("button",{className:"btn",onClick:()=>x(!0),children:"Create Tournament +"})}),e.jsx("div",{className:"mb-2 text-sm font-semibold text-slate-300",children:"World Lobby"}),_&&e.jsx("div",{className:"mb-4 p-3 rounded-xl border border-indigo-500/40 bg-indigo-500/10",children:e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center md:justify-between gap-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm uppercase tracking-wide text-indigo-300 font-semibold",children:"Weekly Official Tournament"}),e.jsx("div",{className:"font-bold",children:_.title}),e.jsxs("div",{className:"text-sm opacity-80",children:[_.game,_.game==="X01"&&_.startingScore?`/${_.startingScore}`:""," · ",_.mode==="firstto"?"First to":"Best of"," ",_.value," · Starts ",ie(_.startAt)," · Cap ",_.capacity," · Joined ",_.participants.length]}),_.prize&&e.jsxs("div",{className:"text-xs mt-1",children:["Prize: ",_.prizeType==="cash"&&_.prizeAmount?`${_.currency||"USD"} ${_.prizeAmount}`:"3 months PREMIUM"]}),_.status!=="scheduled"&&e.jsxs("div",{className:"text-xs",children:["Status: ",_.status]}),c&&c>Date.now()&&e.jsxs("div",{className:"text-xs text-rose-300",children:["Recent winners can re-enter after ",ie(c),"."]})]}),e.jsx("div",{className:"shrink-0",children:e.jsx("button",{className:`btn ${M(_)?"bg-emerald-600 hover:bg-emerald-600":""}`,title:M(_)?"Double-click to leave this tournament":_.official&&c&&c>Date.now()?`Recent winners can re-enter after ${ie(c)}`:"",disabled:r||_.status!=="scheduled"||!M(_)&&(_.participants.length>=_.capacity||!!c&&c>Date.now()),onClick:()=>{M(_)?E&&g({open:!0,t:_}):F(_)},onDoubleClick:()=>{!E&&M(_)&&g({open:!0,t:_})},"aria-label":M(_)?"Already Joined":"Join Now",children:M(_)?"Already Joined!":"Join Now"})})]})}),l&&e.jsx("div",{className:"mb-3 p-2 rounded-lg bg-amber-700/30 border border-amber-600/40 text-amber-200 text-sm",children:l}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("section",{children:[e.jsx("div",{className:"font-semibold mb-1",children:"Official"}),e.jsx("div",{className:"text-xs opacity-70 mb-2",children:c&&c>Date.now()?e.jsxs(e.Fragment,{children:["You’re a recent NDN tournament winner — to keep it fair, you can re-enter after ",ie(c),"."]}):e.jsx(e.Fragment,{children:"Note: Weekly winners can re-enter once their 3 months of PREMIUM ends."})}),e.jsxs("ul",{className:"space-y-2",children:[U.map(R=>e.jsxs("li",{className:"p-3 rounded bg-black/10 flex items-center justify-between relative",children:[e.jsxs("div",{className:"space-y-0.5",children:[e.jsxs("div",{className:"font-semibold",children:[R.title," ",R.prize&&e.jsxs("span",{className:"inline-flex items-center gap-1 ml-2 align-middle",children:[e.jsx("span",{className:"text-xs px-2 py-0.5 rounded bg-amber-500 text-black",children:"Prize"}),e.jsx("span",{className:"inline-flex items-center justify-center w-4 h-4 rounded-full bg-slate-600 text-white text-[10px] leading-none cursor-help",title:R.prizeType==="cash"?"Official cash prize tournament — payout handled by admin.":"Weekly winners get 3 months of PREMIUM and can re-enter once their prize period ends.","aria-label":"Prize info",children:"i"})]})]}),e.jsxs("div",{className:"text-sm opacity-80",children:[R.game,R.game==="X01"&&R.startingScore?`/${R.startingScore}`:""," · ",R.mode==="firstto"?"First to":"Best of"," ",R.value," · ",ie(R.startAt)," · Cap ",R.capacity," · Joined ",R.participants.length]}),R.prize&&e.jsxs("div",{className:"text-xs",children:["Prize: ",R.prizeType==="cash"&&R.prizeAmount?`${R.currency||"USD"} ${R.prizeAmount}`:"3 months PREMIUM",R.status==="completed"&&R.prizeType==="cash"&&R.payoutStatus&&e.jsx("span",{className:`ml-2 px-2 py-0.5 rounded ${R.payoutStatus==="paid"?"bg-emerald-600":"bg-amber-600"}`,children:R.payoutStatus==="paid"?"Paid":"Pending"})]}),R.status!=="scheduled"&&e.jsxs("div",{className:"text-xs",children:["Status: ",R.status]}),M(R)&&e.jsx("div",{className:"text-xs text-emerald-400 font-semibold",children:"Already Joined"}),R.official&&c&&c>Date.now()&&e.jsxs("div",{className:"text-xs text-rose-300",children:["Cooldown active until ",ie(c),"."]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{className:`btn ${M(R)?"bg-emerald-600 hover:bg-emerald-600":""}`,title:M(R)?"Double-click to leave this tournament":R.official&&c&&c>Date.now()?`Recent winners can re-enter after ${ie(c)}`:"",disabled:r||R.status!=="scheduled"||!M(R)&&(R.participants.length>=R.capacity||R.official&&!!c&&c>Date.now()),onClick:()=>{M(R)?E&&g({open:!0,t:R}):F(R)},onDoubleClick:()=>{!E&&M(R)&&g({open:!0,t:R})},"aria-label":M(R)?"Already Joined":"Join Now",children:M(R)?"Already Joined!":"Join Now"}),R.status==="scheduled"&&O&&R.creatorEmail&&String(R.creatorEmail).toLowerCase()===O&&e.jsx("button",{className:"w-6 h-6 rounded-full bg-rose-600 hover:bg-rose-700 text-white text-xs flex items-center justify-center shadow",title:"Delete this tournament",onClick:()=>v(R),"aria-label":"Delete tournament",children:"×"})]})]},R.id)),U.length===0&&e.jsx("li",{className:"text-sm opacity-60",children:"No official tournaments yet."})]})]}),e.jsxs("section",{children:[e.jsx("div",{className:"font-semibold mb-1",children:"Community"}),e.jsxs("ul",{className:"space-y-2",children:[w.map(R=>e.jsxs("li",{className:"p-3 rounded bg-black/10 flex items-center justify-between relative",children:[e.jsxs("div",{className:"space-y-0.5",children:[e.jsx("div",{className:"font-semibold",children:R.title}),e.jsxs("div",{className:"text-sm opacity-80",children:[R.game,R.game==="X01"&&R.startingScore?`/${R.startingScore}`:""," · ",R.mode==="firstto"?"First to":"Best of"," ",R.value," · ",ie(R.startAt)," · Cap ",R.capacity," · Joined ",R.participants.length]}),R.description&&e.jsx("div",{className:"text-xs opacity-80",children:R.description}),M(R)&&e.jsx("div",{className:"text-xs text-emerald-400 font-semibold",children:"Already Joined"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{className:"btn",title:M(R)?"Double-click to leave this tournament":"",disabled:r||R.status!=="scheduled"||!M(R)&&R.participants.length>=R.capacity,onClick:()=>{M(R)?E&&g({open:!0,t:R}):F(R)},onDoubleClick:()=>{!E&&M(R)&&g({open:!0,t:R})},children:M(R)?"Already Joined":"Join Now"}),R.status==="scheduled"&&O&&R.creatorEmail&&String(R.creatorEmail).toLowerCase()===O&&e.jsx("button",{className:"w-6 h-6 rounded-full bg-rose-600 hover:bg-rose-700 text-white text-xs flex items-center justify-center shadow",title:"Delete this tournament",onClick:()=>v(R),"aria-label":"Delete tournament",children:"×"})]})]},R.id)),w.length===0&&e.jsx("li",{className:"text-sm opacity-60",children:"No community tournaments yet."})]})]})]}),h&&e.jsx("div",{className:"mb-4",children:e.jsxs("div",{className:"card relative",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h3",{className:"text-xl font-semibold",children:"Create Tournament"}),e.jsx("button",{className:"btn",onClick:()=>x(!1),children:"Close"})]}),e.jsxs("div",{className:"space-y-3 md:space-y-0 md:grid md:grid-cols-2 md:gap-4 pr-1",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-semibold mb-1",children:"Title"}),e.jsx("input",{className:"input w-full",value:I.title,onChange:R=>N(Z=>({...Z,title:R.target.value}))})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-2",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-semibold mb-1",children:"Game"}),e.jsx("select",{className:"input w-full",value:I.game,onChange:R=>N(Z=>({...Z,game:R.target.value})),children:["X01","Around the Clock","Cricket","Halve It","Shanghai","High-Low","Killer"].map(R=>e.jsx("option",{value:R,children:R},R))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-semibold mb-1",children:"Mode"}),e.jsxs("select",{className:"input w-full",value:I.mode,onChange:R=>N(Z=>({...Z,mode:R.target.value})),children:[e.jsx("option",{value:"bestof",children:"Best of"}),e.jsx("option",{value:"firstto",children:"First to"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-semibold mb-1",children:"Number"}),e.jsx("input",{className:"input w-full",type:"number",min:1,value:I.value,onChange:R=>N(Z=>({...Z,value:Number(R.target.value)}))})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-semibold mb-1",children:"Description"}),e.jsx("textarea",{className:"input w-full",rows:5,value:I.description,onChange:R=>N(Z=>({...Z,description:R.target.value}))})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-2",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-semibold mb-1",children:"Start time"}),e.jsx("input",{className:"input w-full",type:"datetime-local",value:I.startAt,onChange:R=>N(Z=>({...Z,startAt:R.target.value}))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-semibold mb-1",children:"Check-in reminder (min)"}),e.jsx("input",{className:"input w-full",type:"number",min:0,value:I.checkinMinutes,onChange:R=>N(Z=>({...Z,checkinMinutes:Number(R.target.value)}))})]})]}),I.game==="X01"&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-semibold mb-1",children:"X01 Starting Score"}),e.jsx("select",{className:"input w-full",value:String(I.startingScore),onChange:R=>N(Z=>({...Z,startingScore:Number(R.target.value)})),children:[301,501,701].map(R=>e.jsx("option",{value:R,children:R},R))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-semibold mb-1",children:"Capacity"}),e.jsx("input",{className:"input w-full",type:"number",min:6,max:64,value:I.capacity,onChange:R=>N(Z=>({...Z,capacity:Number(R.target.value)}))})]}),e.jsx("div",{className:"text-xs opacity-70",children:"Note: community tournaments do not award prizes."}),e.jsx("div",{className:"flex justify-end",children:e.jsx("button",{className:"btn",disabled:r,onClick:T,children:"Create"})})]})]})}),p.open&&p.t&&e.jsxs("div",{className:"fixed inset-0 z-50 flex items-center justify-center",children:[e.jsx("div",{className:"absolute inset-0 bg-black/40",onClick:()=>g({open:!1,t:null})}),e.jsxs("div",{className:"relative card p-4 w-[360px] max-w-[90vw]",children:[e.jsx("div",{className:"text-lg font-semibold mb-2",children:"Leave tournament?"}),e.jsxs("div",{className:"text-sm opacity-80 mb-4",children:["Are you sure you want to remove yourself from “",p.t.title,"”?"]}),e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx("button",{className:"btn bg-rose-600 hover:bg-rose-700",onClick:()=>g({open:!1,t:null}),children:"Decline"}),e.jsx("button",{className:"btn bg-emerald-600 hover:bg-emerald-700",onClick:async()=>{const R=p.t;g({open:!1,t:null}),await z(R)},children:"Accept"})]})]})]}),S.open&&S.t&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50",children:e.jsx("div",{className:"bg-slate-800 border border-slate-600 rounded-lg p-6 max-w-md w-full mx-4 shadow-xl",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-xl font-semibold mb-4 text-white",children:"Delete Tournament"}),e.jsxs("div",{className:"text-slate-300 mb-6",children:["Are you sure you want to delete ",e.jsxs("span",{className:"font-semibold text-white",children:['"',S.t.title,'"']}),"?",e.jsx("br",{}),e.jsx("span",{className:"text-sm text-slate-400",children:"This action cannot be undone."})]}),e.jsxs("div",{className:"flex gap-3 justify-center",children:[e.jsx("button",{className:"px-6 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium transition-colors",onClick:()=>D({open:!1,t:null}),children:"Decline"}),e.jsx("button",{className:"px-6 py-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg font-medium transition-colors",onClick:b,children:"Continue"})]})]})})}),e.jsx(Pr,{})]})}function Rm({user:t}){const[a,s]=m.useState(null),[i,n]=m.useState(!0),[r,o]=m.useState(null),l="http://localhost:8787",d=wn();if(m.useEffect(()=>{(async()=>{try{const h=t?.email?`?email=${encodeURIComponent(t.email)}`:"",x=await fetch(`${l}/api/subscription`+h);if(!x.ok)throw new Error("Failed to fetch subscription");const p=await x.json();s(p)}catch(h){o(h instanceof Error?h.message:"Something went wrong")}finally{n(!1)}})()},[t?.email]),i)return e.jsx("div",{className:"card",children:e.jsxs("div",{className:"text-center py-8",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-500 mx-auto mb-4"}),e.jsx("p",{children:"Loading subscription..."})]})});if(r)return e.jsxs("div",{className:"card",children:[e.jsx("h2",{className:"text-2xl font-bold text-red-300 mb-2",children:"Subscription Error"}),e.jsx("p",{className:"mb-4 text-red-200",children:r}),e.jsx("button",{onClick:()=>window.location.reload(),className:"btn bg-red-600 hover:bg-red-700",children:"Retry"})]});const c=a?.fullAccess;return e.jsxs("div",{className:"card",children:[e.jsx("h2",{className:"text-2xl font-bold text-indigo-300 mb-2",children:c?"PREMIUM Active":"PREMIUM"}),c?e.jsxs("div",{className:"mb-4",children:[e.jsxs("div",{className:"bg-green-500/20 border border-green-500/40 rounded-lg p-4 mb-4",children:[e.jsx("div",{className:"flex items-center gap-2 text-green-300 font-semibold mb-2",children:"✅ PREMIUM Access Active"}),e.jsx("p",{className:"text-green-200 text-sm",children:"You have full access to all premium features!"}),a?.source&&e.jsxs("p",{className:"text-green-200 text-xs mt-1",children:["Source: ",a.source,a?.expiresAt&&` (expires: ${new Date(a.expiresAt).toLocaleDateString()})`]})]}),e.jsx("h3",{className:"text-lg font-semibold mb-2 text-indigo-200",children:"Your Benefits:"})]}):e.jsx("p",{className:"mb-2 text-indigo-200",children:"Unlock every game mode known to darts, advanced stats, and premium features."}),e.jsxs("ul",{className:"mb-4",children:[e.jsx("li",{children:"All game modes (including paid/advanced)"}),e.jsx("li",{children:"Online play with all rules and variations"}),e.jsx("li",{children:"Advanced analytics and leaderboards"}),e.jsx("li",{children:"Premium camera modes and autoscoring"})]}),!c&&e.jsx("button",{onClick:async()=>{try{const h=await(await fetch(`${l}/api/stripe/create-checkout-session`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:t.email})})).json();h.ok&&h.url?window.location.href=h.url:h.error==="STRIPE_NOT_CONFIGURED"?d("Premium purchases are not available. Payment link not configured.",{type:"error",timeout:4e3}):d("Failed to get payment link. Please try again.",{type:"error",timeout:4e3})}catch{d("Error creating checkout. Please try again.",{type:"error",timeout:4e3})}},className:"btn bg-gradient-to-r from-indigo-500 to-fuchsia-600 text-white font-bold shadow-lg hover:scale-105 transition",children:"Subscribe to PREMIUM"})]})}function Pm({open:t,onClose:a,width:s=700,title:i,footer:n,children:r,side:o="right"}){return m.useEffect(()=>{function l(d){d.key==="Escape"&&a()}return t&&document.addEventListener("keydown",l),()=>document.removeEventListener("keydown",l)},[t,a]),e.jsxs("div",{className:`fixed inset-0 z-50 ${t?"":"pointer-events-none"}`,"aria-hidden":!t,children:[e.jsx("div",{className:`absolute inset-0 bg-black/60 transition-opacity ${t?"opacity-100":"opacity-0"}`,onClick:a}),e.jsxs("div",{className:`absolute top-0 ${o==="right"?"right-0 border-l":"left-0 border-r"} h-full bg-slate-900 border-slate-700 shadow-2xl w-full sm:w-auto flex flex-col transition-transform duration-200 ${t?"translate-x-0":o==="right"?"translate-x-full":"-translate-x-full"}`,style:{width:typeof s=="number"?`${s}px`:s},role:"dialog","aria-modal":"true",children:[e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b border-slate-700 sticky top-0 bg-slate-900 z-10",children:[e.jsx("div",{className:"text-lg font-semibold",children:i}),e.jsx("button",{className:"btn px-3 py-1 text-sm",onClick:a,children:"Close"})]}),e.jsx("div",{className:"flex-1 overflow-auto p-4",children:r}),n&&e.jsx("div",{className:"px-4 py-3 border-t border-slate-700 sticky bottom-0 bg-slate-900 z-10",children:n})]})]})}function Lm({user:t}){const a=To(t?.email),[s,i]=m.useState(null),[n,r]=m.useState(""),[o,l]=m.useState("");async function d(){try{const h=await kt("/readyz");i(await h.json())}catch{}}if(m.useEffect(()=>{d();const h=setInterval(d,5e3);return()=>clearInterval(h)},[]),!a)return e.jsxs("div",{className:"card",children:[e.jsx("h2",{className:"text-2xl font-bold text-brand-700 mb-2",children:"Ops"}),e.jsx("div",{children:"Restricted"})]});async function c(h){l("");try{const x=await kt("/api/admin/maintenance",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({enabled:h,requesterEmail:t?.email})}),p=await x.json();!x.ok||!p?.ok?l(p?.error||"Failed"):l(`Maintenance ${h?"enabled":"disabled"}`)}catch{l("Network error")}}async function u(){l("");const h=n.trim();if(h)try{const x=await kt("/api/admin/announce",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:h,requesterEmail:t?.email})}),p=await x.json();!x.ok||!p?.ok?l(p?.error||"Failed"):l("Announcement broadcasted"),r("")}catch{l("Network error")}}return e.jsxs("div",{className:"card",children:[e.jsx("h2",{className:"text-2xl font-bold text-brand-700 mb-2",children:"Ops"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-3",children:[e.jsxs("div",{className:"p-3 rounded-xl border border-indigo-500/40 bg-indigo-500/10",children:[e.jsx("div",{className:"font-semibold mb-1",children:"Readiness"}),e.jsxs("div",{className:"text-sm",children:["HTTP: ",e.jsx("span",{className:`font-semibold ${s?.ok?"text-emerald-300":"text-rose-300"}`,children:String(!!s?.ok)})]}),e.jsxs("div",{className:"text-sm",children:["WS: ",e.jsx("span",{className:`font-semibold ${s?.ws?"text-emerald-300":"text-rose-300"}`,children:String(!!s?.ws)})]}),e.jsxs("div",{className:"text-sm",children:["Clients: ",e.jsx("span",{className:"font-semibold",children:s?.clients??0})]}),e.jsxs("div",{className:"text-sm",children:["Rooms: ",e.jsx("span",{className:"font-semibold",children:s?.rooms??0})]}),e.jsxs("div",{className:"text-sm",children:["Heap Used: ",e.jsxs("span",{className:"font-semibold",children:[s?.mem?Math.round(s.mem.heapUsed/1024/1024):0," MB"]})]})]}),e.jsxs("div",{className:"p-3 rounded-xl border border-indigo-500/40 bg-indigo-500/10",children:[e.jsx("div",{className:"font-semibold mb-1",children:"Maintenance"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{className:"btn",onClick:()=>c(!0),children:"Enable"}),e.jsx("button",{className:"btn bg-slate-700 hover:bg-slate-800",onClick:()=>c(!1),children:"Disable"})]})]}),e.jsxs("div",{className:"p-3 rounded-xl border border-indigo-500/40 bg-indigo-500/10",children:[e.jsx("div",{className:"font-semibold mb-1",children:"Announcement"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{className:"input flex-1",placeholder:"Message to broadcast",value:n,onChange:h=>r(h.target.value)}),e.jsx("button",{className:"btn",onClick:u,children:"Send"})]})]})]}),o&&e.jsx("div",{className:"text-xs mt-2",children:o}),e.jsx("div",{className:"text-xs opacity-70 mt-2",children:"✅ Clustering enabled! For 1.5k+ concurrent users, deploy behind a reverse proxy (NGINX/Cloudflare) with sticky sessions for WebSockets. Set NODE_WORKERS environment variable to control worker count."})]})}function Om({}){const[t,a]=m.useState(!1),[s,i]=m.useState([{text:"Hi! I'm your Nine Dart Nation assistant. How can I help you today?",isUser:!1}]),[n,r]=m.useState(""),o=c=>{try{window.dispatchEvent(new CustomEvent("ndn:change-tab",{detail:{tab:c}})),a(!1)}catch(u){console.error("Navigation failed:",u)}},l=c=>{const u=c.toLowerCase();return u.includes("username")||u.includes("change name")?{text:"You can change your username once for free.",links:[{text:"Go to Settings > Account",tab:"settings"}]}:u.includes("premium")||u.includes("upgrade")||u.includes("subscription")?{text:"Premium unlocks all game modes and features.",links:[{text:"Go to Online Play",tab:"online"}]}:u.includes("calibrat")||u.includes("camera")||u.includes("vision")?{text:"Set up your camera properly in Settings.",links:[{text:"Go to Settings > Camera & Vision",tab:"settings"}]}:u.includes("voice")||u.includes("caller")||u.includes("audio")?{text:"Enable voice calling in Settings.",links:[{text:"Go to Settings > Audio & Voice",tab:"settings"}]}:u.includes("friend")||u.includes("play together")?{text:"Add friends to play together.",links:[{text:"Go to Friends",tab:"friends"}]}:u.includes("stat")||u.includes("score")||u.includes("performance")?{text:"View your statistics and performance.",links:[{text:"Go to Stats",tab:"stats"}]}:u.includes("setting")||u.includes("customiz")||u.includes("configur")?{text:"Customize your experience.",links:[{text:"Go to Settings",tab:"settings"}]}:u.includes("tournament")||u.includes("competition")?{text:"Check out tournaments and competitions.",links:[{text:"Go to Tournaments",tab:"tournaments"}]}:u.includes("help")||u.includes("support")||u.includes("faq")?{text:"You're already in the help section! Check Settings for more resources.",links:[{text:"Go to Settings > Support",tab:"settings"}]}:u.includes("how to play")||u.includes("game")||u.includes("start")?{text:"To play darts, select a game mode from the menu. For online play, join a match. For offline, start a local game.",links:[{text:"Play Online",tab:"online"},{text:"Play Offline",tab:"offline"}]}:{text:"I'm not sure about that. Try asking about playing, calibration, premium, username changes, voice settings, friends, stats, or settings."}},d=()=>{if(!n.trim())return;const c=n.toLowerCase();i(h=>[...h,{text:n,isUser:!0}]),r("");const u=l(c);setTimeout(()=>{i(h=>[...h,{text:u,isUser:!1}])},500)};return e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>a(!0),className:"fixed bottom-4 right-4 z-50 bg-blue-600 hover:bg-blue-700 text-white p-4 rounded-full shadow-lg transition-colors",title:"Help Assistant",children:e.jsx(vo,{className:"w-6 h-6"})}),t&&e.jsxs("div",{className:"fixed inset-0 z-50 flex items-end justify-end p-4",children:[e.jsx("div",{className:"absolute inset-0 bg-black/50",onClick:()=>a(!1)}),e.jsxs("div",{className:"relative bg-slate-800 rounded-lg shadow-xl w-full max-w-md h-96 flex flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 border-b border-slate-700",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(an,{className:"w-5 h-5 text-blue-400"}),e.jsx("span",{className:"font-semibold",children:"Help Assistant"})]}),e.jsx("button",{onClick:()=>a(!1),className:"text-slate-400 hover:text-white",children:e.jsx(Zl,{className:"w-5 h-5"})})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-4 space-y-3",children:s.map((c,u)=>e.jsx("div",{className:`flex ${c.isUser?"justify-end":"justify-start"}`,children:e.jsx("div",{className:`max-w-xs px-3 py-2 rounded-lg ${c.isUser?"bg-blue-600 text-white":"bg-slate-700 text-slate-200"}`,children:typeof c.text=="string"?c.text:e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{children:c.text.text}),c.text.links&&e.jsx("div",{className:"space-y-1",children:c.text.links.map((h,x)=>e.jsx("button",{onClick:()=>o(h.tab),className:"block w-full text-left text-blue-300 hover:text-blue-200 underline text-sm",children:h.text},x))})]})})},u))}),e.jsx("div",{className:"p-4 border-t border-slate-700",children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{type:"text",value:n,onChange:c=>r(c.target.value),onKeyPress:c=>c.key==="Enter"&&d(),placeholder:"Ask me anything...",className:"flex-1 input"}),e.jsx("button",{onClick:d,className:"btn bg-blue-600 hover:bg-blue-700",children:e.jsx(jo,{className:"w-4 h-4"})})]})})]})]})]})}function Bm(){const t=zn(),a=m.useRef({}),s=m.useRef({});return m.useEffect(()=>{function i(c="[GlobalCamera]"){try{const u=t.getVideoElementRef(),h=t.getMediaStream(),x=t.getPcRef&&t.getPcRef(),p=t.getWsRef&&t.getWsRef();console.log(c,{isStreaming:t.isStreaming,mode:t.mode,showOverlay:t.showOverlay,hasVideoElement:!!u,video:u?{videoWidth:u.videoWidth,videoHeight:u.videoHeight,srcObject:!!u.srcObject}:null,mediaTracks:h?h.getTracks().map(g=>({kind:g.kind,enabled:g.enabled,id:g.id})):null,pcState:x?x.connectionState||x.iceConnectionState:null,wsState:p?p.readyState||"unknown":null})}catch(u){console.warn("[GlobalCamera] dumpState failed",u)}}i("[GlobalCamera] INIT");let n=!0;const r=setInterval(()=>{if(n)try{const c=t.getVideoElementRef(),u=t.getMediaStream(),h=t.getPcRef&&t.getPcRef(),x={isStreaming:t.isStreaming,mode:t.mode,hasVideo:!!c,videoW:c?c.videoWidth:0,videoH:c?c.videoHeight:0,tracks:u?u.getTracks().length:0,pcState:h?h.connectionState||h.iceConnectionState:null},p=a.current;(x.isStreaming!==p.isStreaming||x.hasVideo!==p.hasVideo||x.videoW!==p.videoW||x.videoH!==p.videoH||x.tracks!==p.tracks||x.pcState!==p.pcState||t.showOverlay!==p.showOverlay)&&(a.current=x,i("[GlobalCamera] CHANGE"))}catch(c){console.warn("[GlobalCamera] poll failed",c)}},750);function o(c){try{const u=s.current.video;if(u&&u.el===c)return;if(u&&u.el){try{u.el.removeEventListener("loadedmetadata",u.loadedmetadata)}catch{}try{u.el.removeEventListener("playing",u.playing)}catch{}}if(s.current.video=null,c){const h=()=>console.log("[GlobalCamera] video loadedmetadata",{videoWidth:c.videoWidth,videoHeight:c.videoHeight}),x=()=>console.log("[GlobalCamera] video playing",{paused:c.paused});c.addEventListener("loadedmetadata",h),c.addEventListener("playing",x),s.current.video={el:c,loadedmetadata:h,playing:x}}}catch(u){console.warn("[GlobalCamera] attachVideoListeners failed",u)}}function l(c){try{const u=s.current.pc;if(u&&u.pc===c)return;if(u&&u.pc)try{u.pc.removeEventListener("connectionstatechange",u.connChange)}catch{}if(s.current.pc=null,c){const h=()=>console.log("[GlobalCamera] pc state change",{connectionState:c.connectionState,iceState:c.iceConnectionState});c.addEventListener("connectionstatechange",h),s.current.pc={pc:c,connChange:h}}}catch(u){console.warn("[GlobalCamera] attachPc failed",u)}}const d=setInterval(()=>{try{o(t.getVideoElementRef()),l(t.getPcRef&&t.getPcRef())}catch{}},1e3);return()=>{n=!1,clearInterval(r),clearInterval(d);try{const c=s.current.video;c&&c.el&&(c.el.removeEventListener("loadedmetadata",c.loadedmetadata),c.el.removeEventListener("playing",c.playing))}catch{}try{const c=s.current.pc;c&&c.pc&&c.pc.removeEventListener("connectionstatechange",c.connChange)}catch{}}},[t]),null}function Um(){const t=zn(),a=m.useRef(null),s=m.useRef(null),i=t.isStreaming&&t.mode==="phone",n=t.getVideoElementRef();m.useEffect(()=>{const o=a.current;if(!o)return;let l=!0;const d=o.getContext("2d");if(!d)return;const c=()=>{if(l){try{if(d.clearRect(0,0,o.width,o.height),i&&n&&n.readyState>=2){const u=n.videoWidth||640,h=n.videoHeight||360,x=o.width,p=o.height,g=u/h,S=x/p;let D=0,I=0,N=u,E=h;if(g>S){const A=h*S;D=(u-A)/2,N=A}else if(g<S){const A=u/S;I=(h-A)/2,E=A}d.drawImage(n,D,I,N,E,0,0,x,p)}else d.fillStyle="rgba(148, 163, 184, 0.25)",d.fillRect(0,0,o.width,o.height),d.fillStyle="rgba(226,232,240,0.8)",d.font="10px system-ui, sans-serif",d.textAlign="center",d.textBaseline="middle",d.fillText("Camera",o.width/2,o.height/2)}catch{}s.current=requestAnimationFrame(c)}};return s.current=requestAnimationFrame(c),()=>{l=!1,s.current&&cancelAnimationFrame(s.current)}},[i,n]);const r=()=>{try{window.dispatchEvent(new CustomEvent("ndn:toggle-phone-overlay"))}catch{}};return e.jsxs("button",{type:"button",onClick:r,className:"relative inline-flex items-center gap-1 rounded-lg border border-white/15 bg-white/5 hover:bg-white/10 transition-colors shadow-sm overflow-hidden",style:{height:36},title:i?"Camera connected – click to toggle overlay":"Camera not connected",children:[e.jsx("canvas",{ref:a,width:64,height:36,className:"block"}),e.jsx("span",{className:"pr-2 text-xs text-slate-100 select-none hidden xs:inline",children:i?"Phone Cam":"No Camera"}),e.jsx("span",{className:"absolute -top-1 -right-1 text-lg pointer-events-none drop-shadow","aria-hidden":"true",children:i?"✅":"⚪"})]})}function $m(){const t=m.useRef(null),[a,s]=m.useState(""),[i,n]=m.useState(!1),[r,o]=m.useState(null),l=(()=>{try{return Lr()}catch{return null}})(),[d,c]=m.useState("score"),[u,h]=m.useState(!1),[x,p]=m.useState(!1),[g,S]=m.useState(null),[D,I]=m.useState(0),{avgMode:N}=is(),{H:E,locked:A,errorPx:O}=ha();m.useEffect(()=>{const b=localStorage.getItem("authToken");b&&fetch("http://localhost:8787/api/auth/me",{headers:{Authorization:`Bearer ${b}`}}).then(z=>z.json()).then(z=>{z?.user?(S(z.user),M(z.user)):localStorage.removeItem("authToken")}).catch(()=>{})},[]),m.useEffect(()=>{const b=()=>{try{localStorage.removeItem("mockUser"),localStorage.removeItem("authToken")}catch{}S(null),c("score")};return window.addEventListener("ndn:logout",b),()=>window.removeEventListener("ndn:logout",b)},[]),m.useEffect(()=>{if(!g?.username)return;const b=()=>I(N==="24h"?Lc(g.username):Xs(g.username));b();const F=()=>b();return window.addEventListener("ndn:stats-updated",F),()=>window.removeEventListener("ndn:stats-updated",F)},[g?.username,N]),m.useEffect(()=>{if(!g?.username){s("");return}const b=localStorage.getItem(`ndn:bio:profilePhoto:${g.username}`);s(b||"")},[g?.username]),m.useEffect(()=>{const b=U=>{U.key?.startsWith("ndn:bio:profilePhoto:")&&g?.username&&U.key.endsWith(g.username)&&s(U.newValue||"")},F=U=>{if(U.detail?.username===g?.username&&s(U.detail?.avatar||""),g?.username){const w=localStorage.getItem(`ndn:bio:profilePhoto:${g.username}`);s(w||"")}},z=()=>{if(!document.hidden&&g?.username){const U=localStorage.getItem(`ndn:bio:profilePhoto:${g.username}`);s(U||"")}},T=setInterval(()=>{if(g?.username){const U=localStorage.getItem(`ndn:bio:profilePhoto:${g.username}`);U&&U!==a&&s(U)}},2e3);return window.addEventListener("storage",b),window.addEventListener("ndn:avatar-updated",F),document.addEventListener("visibilitychange",z),()=>{window.removeEventListener("storage",b),window.removeEventListener("ndn:avatar-updated",F),document.removeEventListener("visibilitychange",z),clearInterval(T)}},[g?.username,a]),m.useEffect(()=>{const b=new URLSearchParams(window.location.search),F=b.get("paid"),z=b.get("username-change");if(F==="1"||F==="username-change"||z==="free"){const T=localStorage.getItem("pendingUsernameChange");T&&g?.email&&fetch("http://localhost:8787/api/change-username",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:g.email,newUsername:T})}).then(w=>w.json()).then(w=>{w.ok?(alert("Username changed successfully!"),localStorage.removeItem("pendingUsernameChange"),w.token&&localStorage.setItem("authToken",w.token),w.user&&S(w.user),window.history.replaceState({},document.title,window.location.pathname)):alert("Failed to change username: "+(w.error||"Unknown error"))}).catch(()=>{alert("Network error while changing username")})}},[g?.email]),m.useEffect(()=>{new URLSearchParams(window.location.search).get("subscription")==="success"&&g?.email&&fetch("http://localhost:8787/api/auth/me",{headers:{Authorization:`Bearer ${localStorage.getItem("authToken")}`}}).then(T=>T.json()).then(T=>{T?.user&&(S(T.user),alert("Premium subscription activated successfully!"),window.history.replaceState({},document.title,window.location.pathname))}).catch(()=>{alert("Subscription activated, but failed to refresh user data. Please refresh the page.")})},[g?.email]),m.useEffect(()=>{const b=()=>{const T=window.innerWidth,U=window.matchMedia("(max-width: 768px)").matches,w=window.matchMedia("(max-width: 1024px) and (min-width: 769px)").matches,_=/Mobi|Android|iPhone|iPad|iPod|Mobile|BlackBerry|IEMobile|Opera Mini|Windows Phone/i.test(navigator.userAgent||""),ie=/iPad|Android(?=.*\bMobile\b)|Tablet|PlayBook|Silk/i.test(navigator.userAgent||""),R="ontouchstart"in window||navigator.maxTouchPoints>0,Z=T<769,ae=w&&R||ie||T>=769&&T<=1024&&R,st=U||_||Z||T<769&&R||ae;h(st)};b(),window.addEventListener("resize",b),window.addEventListener("orientationchange",b);const F=window.matchMedia("(max-width: 768px)"),z=window.matchMedia("(max-width: 1024px) and (min-width: 769px)");try{F.addEventListener("change",b),z.addEventListener("change",b)}catch{}return()=>{window.removeEventListener("resize",b),window.removeEventListener("orientationchange",b);try{F.removeEventListener("change",b),z.removeEventListener("change",b)}catch{}}},[]),m.useEffect(()=>{const b=()=>{try{localStorage.removeItem("ndn:avatar")}catch{}S(null),c("score")};return window.addEventListener("ndn:logout",b),()=>window.removeEventListener("ndn:logout",b)},[]),m.useEffect(()=>{const b=F=>{try{const z=String(F?.detail?.username||"").trim();if(!z)return;S(T=>T&&{...T,username:z});try{const T=(g?.email||"").toLowerCase();l&&z&&T&&l.send({type:"presence",username:z,email:T})}catch{}}catch{}};return window.addEventListener("ndn:username-changed",b),()=>window.removeEventListener("ndn:username-changed",b)},[l,g?.email]),m.useEffect(()=>{const b=F=>{try{const z=String(F?.detail?.tab||"").trim();z&&["score","offline","online","stats","settings","admin","tournaments","friends"].includes(z)&&c(z)}catch{}};return window.addEventListener("ndn:change-tab",b),()=>window.removeEventListener("ndn:change-tab",b)},[]);async function M(b){try{const F=b?.email?`?email=${encodeURIComponent(b.email)}`:"",z=await fetch("/api/subscription"+F);if(!z.ok)return;const T=await z.json();S({...b,fullAccess:!!T?.fullAccess})}catch{}}if(!g)return e.jsx(Nm,{onAuth:b=>{S(b),M(b)}});const v=`https://ui-avatars.com/api/?name=${encodeURIComponent(g.username||"NDN")}&background=8F43EE&color=fff&bold=true&rounded=true&size=64`;return e.jsxs(Sm,{children:[e.jsxs("div",{ref:t,className:`${g?.fullAccess?"premium-body":""} h-screen overflow-hidden p-1 xs:p-2 sm:p-3 md:p-4`,children:[e.jsx(pm,{}),e.jsxs("div",{className:"max-w-[1400px] mx-auto grid grid-cols-1 lg:grid-cols-[auto,1fr] gap-2 xs:gap-3 sm:gap-4 h-full overflow-hidden",children:[!u&&e.jsx("div",{className:"relative hidden lg:block",style:{width:240},children:e.jsx(Do,{active:d,onChange:b=>{c(b)},user:g})}),e.jsxs("div",{className:"flex flex-col h-full overflow-hidden",children:[e.jsx("div",{className:"pt-1 xs:pt-2",children:e.jsxs("header",{id:"ndn-header",className:"header glass flex-col xs:flex-col sm:flex-row gap-2 xs:gap-2 sm:gap-3",children:[e.jsx("div",{className:"flex items-center gap-2 order-1",children:e.jsx("h1",{className:"text-lg xs:text-xl sm:text-xl md:text-2xl font-bold text-brand-700 whitespace-nowrap cursor-pointer select-none",onClick:()=>{u&&c("score")},title:u?"Go Home":void 0,children:"NINE-DART-NATION 🎯"})}),e.jsxs("div",{className:"order-3 xs:order-3 sm:order-2 w-full sm:w-auto flex-1 flex flex-col items-center justify-center text-center sm:text-left !text-black",children:[e.jsxs("span",{className:"text-sm xs:text-base sm:text-base md:text-lg font-semibold flex items-center gap-2 max-w-full truncate !text-black",style:{color:"#000000",WebkitTextFillColor:"#000000"},children:[e.jsx("span",{className:"hidden xs:inline !text-black",children:"Welcome"}),e.jsx("img",{src:a||v,alt:"avatar",className:"w-5 h-5 xs:w-6 xs:h-6 sm:w-6 sm:h-6 md:w-7 md:h-7 rounded-full ring-2 ring-white/20"}),e.jsxs("span",{className:"truncate !text-black",style:{color:"#000000",WebkitTextFillColor:"#000000"},children:[g.username,"🎯"]})]}),e.jsxs("span",{className:"hidden xs:inline text-xs xs:text-xs sm:text-xs md:text-sm !text-black",style:{color:"#000000",WebkitTextFillColor:"#000000"},children:["All-time 3-dart avg: ",e.jsx("span",{className:"font-semibold !text-black",style:{color:"#000000",WebkitTextFillColor:"#000000"},children:D.toFixed(2)})]}),u&&e.jsx("button",{className:"btn px-3 py-1 xs:px-3 xs:py-1 sm:px-3 sm:py-1 mt-1 text-sm xs:text-sm","aria-label":"Open navigation",onClick:()=>p(!0),children:"☰ Menu"})]}),A&&E&&e.jsxs("button",{onClick:()=>c("calibrate"),className:"order-4 sm:order-4 md:order-3 px-3 py-1 text-xs sm:text-sm rounded-full bg-emerald-500/20 hover:bg-emerald-500/30 text-emerald-100 border border-emerald-400/50 transition-colors",title:"Click to adjust calibration",children:["✓ Calibration Active ",O!=null&&`• ${O.toFixed(1)}px`]}),e.jsxs("div",{className:"order-2 md:order-3 ml-0 md:ml-auto flex items-center gap-2 flex-wrap",children:[e.jsx("button",{className:"px-3 py-1 text-sm rounded-full bg-white/5 hover:bg-white/10 border border-white/10",onClick:()=>{const b=t.current;b&&(document.fullscreenElement?document.exitFullscreen().catch(()=>{}):b.requestFullscreen().catch(()=>{}))},title:i?"Exit Full Screen":"Enter Full Screen",children:i?"Exit Full Screen":"Full Screen"}),d==="online"&&e.jsx("button",{className:"text-[10px] md:text-xs px-3 py-1 rounded-full bg-indigo-500/25 text-indigo-100 border border-indigo-400/40 hover:bg-indigo-500/40",title:"Open a simulated online match",onClick:()=>{setTimeout(()=>{try{window.dispatchEvent(new CustomEvent("ndn:online-match-demo",{detail:{game:"X01",start:501}}))}catch{}},40)},children:"ONLINE DEMO"}),e.jsx(Um,{}),l?e.jsx("span",{className:"ml-0 md:ml-2",children:e.jsx(km,{status:l.status})}):null,r?.https?e.jsx("span",{className:"text-[10px] md:text-xs px-3 py-1 rounded-full bg-emerald-500/20 text-emerald-200 border border-emerald-400/40",title:`Phone HTTPS active on :${r.port}`,children:"HTTPS READY"}):e.jsx("span",{className:"text-[10px] md:text-xs px-3 py-1 rounded-full bg-slate-600/30 text-slate-300 border border-slate-400/30",title:"Enable HTTPS for iPhone camera pairing",children:"HTTP ONLY"})]})]})}),u&&e.jsx(Fm,{open:x,onClose:()=>p(!1),active:d,onChange:b=>{c(b),p(!1)},user:g}),e.jsxs("main",{id:"ndn-main-scroll",className:"space-y-4 flex-1 overflow-y-auto pr-1",children:[d==="settings"&&e.jsx(As,{children:e.jsx(vm,{user:g})}),d==="score"&&e.jsx(As,{children:e.jsx(Uc,{user:g})}),d==="online"&&e.jsx(As,{children:e.jsx(Im,{user:g})}),d==="offline"&&e.jsx(As,{children:e.jsx(dm,{user:g})}),e.jsx("div",{className:d==="calibrate"?"":"hidden",children:e.jsx(As,{children:e.jsx(Hd,{})})}),d==="friends"&&e.jsx(As,{children:e.jsx(xm,{user:g})}),d==="stats"&&e.jsx(As,{children:e.jsx(Dm,{user:g})}),d==="tournaments"&&e.jsx(As,{children:e.jsx(Am,{user:g})}),d==="admin"&&e.jsx(As,{children:e.jsxs("div",{className:"space-y-6",children:[e.jsx(ym,{user:g}),e.jsx(Lm,{user:g})]})}),d==="fullaccess"&&e.jsx(As,{children:e.jsx(Rm,{user:g})})]})]})]})]}),e.jsx(Om,{}),e.jsx(Bm,{}),e.jsx(Pr,{})]})}function Fm({open:t,onClose:a,active:s,onChange:i,user:n}){return e.jsx(Pm,{open:t,onClose:a,width:320,side:"left",title:"Navigate",children:e.jsx("div",{className:"mt-2",children:e.jsx(Do,{active:s,onChange:i,user:n,className:"flex relative static max-h-[80vh] w-full"})})})}function _m(t){return t.length>=10&&/\d/.test(t)&&/[^A-Za-z0-9]/.test(t)}function Hm(){const[t,a]=m.useState(""),[s,i]=m.useState(""),[n,r]=m.useState(""),[o,l]=m.useState(""),[d,c]=m.useState("");m.useEffect(()=>{try{const x=new URLSearchParams(window.location.search).get("token")||"";a(x)}catch{}},[]);async function u(h){if(h.preventDefault(),l(""),c(""),!t){l("Missing or invalid reset token.");return}if(!s||s!==n){l("Passwords do not match.");return}if(!_m(s)){l("Password must be at least 10 chars and include a number and symbol.");return}try{const p=await(await fetch("/api/auth/confirm-reset",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({token:t,newPassword:s})})).json();if(!p?.ok)throw new Error(p?.error||"Reset failed");c("Password changed. You can now sign in.")}catch(x){l(x?.message||"Reset failed")}}return e.jsxs("div",{className:"min-h-screen flex items-center justify-center relative overflow-hidden",children:[e.jsx("div",{className:"background-animated"}),e.jsx("div",{className:"relative z-10 w-full max-w-lg mx-auto p-4",children:e.jsxs("form",{className:"card w-full space-y-4",onSubmit:u,children:[e.jsx("div",{className:"flex flex-col items-center justify-center gap-2 mb-2 text-center",children:e.jsx("h1",{className:"logo text-center",children:"Reset your password"})}),!t&&e.jsx("div",{className:"text-red-400",children:"This reset link is missing a token. Please use the link from your email."}),e.jsx("input",{className:"input w-full",type:"password",placeholder:"New password",value:s,onChange:h=>i(h.target.value),required:!0}),e.jsx("input",{className:"input w-full",type:"password",placeholder:"Confirm password",value:n,onChange:h=>r(h.target.value),required:!0}),o&&e.jsx("div",{className:"text-red-400 font-semibold text-sm",children:o}),d&&e.jsx("div",{className:"text-emerald-400 font-semibold text-sm",children:d}),e.jsx("button",{className:"btn w-full",type:"submit",disabled:!t,children:"Change Password"}),e.jsx("a",{className:"underline text-sm text-center",href:"/",children:"Back to sign in"})]})})]})}class Wm extends m.Component{constructor(a){super(a),this.state={hasError:!1}}static getDerivedStateFromError(a){return{hasError:!0,message:String(a?.message||a)}}componentDidCatch(a,s){console.error("[ErrorBoundary]",a,s)}render(){return this.state.hasError?e.jsx("div",{className:"min-h-screen flex items-center justify-center p-6",children:e.jsxs("div",{className:"card max-w-lg w-full text-center",children:[e.jsx("h2",{className:"text-2xl font-bold mb-2",children:"Something went wrong"}),e.jsx("p",{className:"opacity-80 mb-4",children:"Please refresh the page. If this persists, let us know."}),this.state.message&&e.jsx("pre",{className:"text-xs bg-black/40 rounded p-2 overflow-auto text-left",children:this.state.message}),e.jsx("button",{className:"btn mt-4",onClick:()=>window.location.reload(),children:"Reload"})]})}):this.props.children}}try{window.React=window.React||{}}catch{}xc();ac.createRoot(document.getElementById("root")).render(e.jsx(m.StrictMode,{children:e.jsx(Wm,{children:e.jsx(Cm,{children:e.jsx(zm,{})})})}));function zm(){return window.location.pathname==="/reset"?e.jsx(Hm,{}):e.jsx($m,{})}
//# sourceMappingURL=index-B6iJ2otj.js.map
