import{H as Ks,I as Qs,j as t,h as Ls,u as _e,t as ws,l as Js,s as ut,R as Zs,J as ys,B as en,K as tn}from"./index-qEtc2rT9.js";import{r}from"./ui-CuWypN7C.js";import{a as Gt,u as sn}from"./match-DaK2nqvI.js";import{u as Ns}from"./pendingVisit-BbRXmIZs.js";function Cs(d,a){const i=Ks(d,a);return Qs(i)}class nn{width=0;height=0;bg=null;lastAcceptTs=0;cooldownMs=600;roiRadius=0;roiCx=0;roiCy=0;initialized=!1;thresh=28;minArea=90;maxArea=6e3;prevTip=null;prevArea=0;stableCount=0;requireStableN=1;constructor(){}setROI(a,i,x){this.roiCx=a,this.roiCy=i,this.roiRadius=Math.max(0,x|0)}reset(a,i){this.width=a,this.height=i,this.bg=new Float32Array(a*i),this.initialized=!1}updateBackground(a,i=.05){const{width:x,height:o,data:p}=a;(!this.bg||x!==this.width||o!==this.height)&&this.reset(x,o);const M=this.bg,O=x*o;for(let v=0,c=0;v<O;v++,c+=4){const N=p[c],k=p[c+1],I=p[c+2],L=.299*N+.587*k+.114*I;this.initialized?M[v]=(1-i)*M[v]+i*L:M[v]=L}this.initialized=!0}inRoi(a,i){if(this.roiRadius<=0)return!0;const x=a-this.roiCx,o=i-this.roiCy;return x*x+o*o<=this.roiRadius*this.roiRadius}detect(a){const x=Date.now()-this.lastAcceptTs<this.cooldownMs,{width:o,height:p,data:M}=a;(!this.bg||o!==this.width||p!==this.height)&&this.reset(o,p);const O=this.bg;if(!this.initialized)return this.updateBackground(a,1),null;const v=o*p,c=new Uint8Array(v),N=new Float32Array(v);let k=0,I=0,L=0;const Q=new Uint8Array(v);for(let b=0,C=0;b<v;b++,C+=4){const B=M[C],K=M[C+1],ee=M[C+2],R=Math.max(B,K,ee),Fe=Math.min(B,K,ee),He=.299*B+.587*K+.114*ee,te=Math.abs(He-O[b]);N[b]=te;const ft=Math.floor(b/o),q=b-ft*o,xt=R===0?0:(R-Fe)/R,at=R>=250&&xt<=.12;at&&(Q[b]=1),this.inRoi(q,ft)&&!at&&(k+=te,I+=te*te,L++)}const re=L?k/L:0,pe=L?Math.max(0,I/L-re*re):0,De=Math.sqrt(pe),$e=Math.max(this.thresh,re+1.2*De);for(let b=0;b<v;b++){if(Q[b]){c[b]=0;continue}if(N[b]>$e){const C=Math.floor(b/o),B=b-C*o;c[b]=this.inRoi(B,C)?1:0}}this._dilate(c,o,p),this._erode(c,o,p);const j=new Uint8Array(v);let w=0,_=null;for(let b=0;b<v;b++){if(c[b]===0||j[b])continue;const C=[];let B=0,K=0;const ee=[b];for(j[b]=1;K<ee.length;){const R=ee[K++];C.push(R),B++;const Fe=R/o|0,He=[R-1,R+1,R-o,R+o];for(const te of He)te<0||te>=v||j[te]||(te===R-1||te===R+1)&&(te/o|0)!==Fe||c[te]&&(j[te]=1,ee.push(te))}B>w&&(w=B,_=C)}if(!_||w<this.minArea||w>this.maxArea)return x||this.updateBackground(a,.02),null;let ce=o,T=p,G=0,Ve=0,de=0,J=0;for(const b of _){const C=b/o|0,B=b-C*o;de+=B,J+=C,B<ce&&(ce=B),B>G&&(G=B),C<T&&(T=C),C>Ve&&(Ve=C)}de/=w,J/=w;let fe=0,Le=0,E=0;for(const b of _){const C=b/o|0,K=b-C*o-de,ee=C-J;fe+=K*K,Le+=ee*ee,E+=K*ee}fe/=w,Le/=w,E/=w;const ae=fe+Le,It=fe*Le-E*E,dt=Math.sqrt(Math.max(0,ae*ae/4-It)),Z=ae/2+dt;let $=E,ie=Z-fe;Math.hypot($,ie)<1e-6&&($=Z-Le,ie=E);const ze=Math.hypot($,ie)||1;$/=ze,ie/=ze;const mt=de-this.roiCx,st=J-this.roiCy,me=mt*$+st*ie>0?1:-1;$*=me,ie*=me;const he=Math.hypot(mt,st)||1,Tt=mt/he,Xt=st/he,W=Math.max(-1,Math.min(1,$*Tt+ie*Xt));if(Math.acos(W)*180/Math.PI>55)return x||this.updateBackground(a,.02),null;let Ge=-1/0,ue=de,X=J;for(const b of _){const C=b/o|0,B=b-C*o,K=(B-de)*$+(C-J)*ie;K>Ge&&(Ge=K,ue=B,X=C)}const nt=ue-this.roiCx,le=X-this.roiCy,ht=nt*nt+le*le,g=Math.max(1,G-ce+1),V=Math.max(1,Ve-T+1),ve=g*V,z=w/ve,S=Math.sqrt(ht)/Math.max(1,this.roiRadius);let U=.5;z<.45&&(U+=.2),z<.25&&(U+=.15),S<1.1&&(U+=.1);const Xe=ae-Z;return(Z>0?1-Xe/Z:0)>.3&&(U+=.1),U=Math.max(0,Math.min(1,U)),!this._isStable({x:ue+.5,y:X+.5},w)||x?null:{tip:{x:ue+.5,y:X+.5},axis:{x1:de-$*20,y1:J-ie*20,x2:de+$*20,y2:J+ie*20},area:w,bbox:{x:ce,y:T,w:g,h:V},confidence:U}}accept(a,i){if(this.lastAcceptTs=Date.now(),this.prevTip=null,this.prevArea=0,this.stableCount=0,!this.bg)return;const{width:x}=a,o=this.bg,{x:p,y:M,w:O,h:v}=i.bbox,c=.5;for(let N=M;N<M+v;N++)for(let k=p;k<p+O;k++){const I=N*x+k,L=I*4,Q=a.data[L],re=a.data[L+1],pe=a.data[L+2],De=.299*Q+.587*re+.114*pe;o[I]=(1-c)*o[I]+c*De}}_isStable(a,i){const x=(o,p)=>Math.hypot(o.x-p.x,o.y-p.y)<=6;if(!this.prevTip)return this.prevTip={...a},this.prevArea=i,this.stableCount=1,!1;if(x(this.prevTip,a)&&Math.abs(i-this.prevArea)/Math.max(1,i)<.3)this.prevTip={...a},this.prevArea=i,this.stableCount++;else return this.prevTip={...a},this.prevArea=i,this.stableCount=1,!1;return this.stableCount>=this.requireStableN}_dilate(a,i,x){const o=new Uint8Array(a.length);for(let p=0;p<x;p++)for(let M=0;M<i;M++){let O=0;for(let v=-1;v<=1;v++){for(let c=-1;c<=1;c++){const N=p+v,k=M+c;if(!(N<0||N>=x||k<0||k>=i)&&a[N*i+k]){O=1;break}}if(O)break}o[p*i+M]=O}a.set(o)}_erode(a,i,x){const o=new Uint8Array(a.length);for(let p=0;p<x;p++)for(let M=0;M<i;M++){let O=1;for(let v=-1;v<=1;v++){for(let c=-1;c<=1;c++){const N=p+v,k=M+c;if(!(N<0||N>=x||k<0||k>=i)&&!a[N*i+k]){O=0;break}}if(!O)break}o[p*i+M]=O}a.set(o)}}function rn(d){try{if(!d||typeof d!="object")return null;if((d.type==="dart"||d.kind==="dart"||d.event==="dart")&&typeof d.value=="number"){const a=js(d.ring);return Ss(d.value,a)}if(typeof d.value=="number"&&d.ring){const a=js(d.ring);return Ss(d.value,a)}if(typeof d.score=="string"){const a=d.score.trim().toUpperCase();if(a==="50"||a==="DBULL"||a==="INNER_BULL")return{value:50,ring:"INNER_BULL",sector:null,mult:0};if(a==="25"||a==="BULL"||a==="OBULL")return{value:25,ring:"BULL",sector:null,mult:0};const i=a.match(/^(S|D|T)(\d{1,2})$/);if(i){const x=i[1]==="S"?1:i[1]==="D"?2:3,o=parseInt(i[2],10);if(o>=1&&o<=20)return{value:o*x,ring:x===1?"SINGLE":x===2?"DOUBLE":"TRIPLE",sector:o,mult:x}}}if(typeof d.sector=="number"&&typeof d.mult=="number"){const a=Math.max(1,Math.min(20,Math.floor(d.sector))),i=d.mult===1?1:d.mult===2?2:3;return{value:a*i,ring:i===1?"SINGLE":i===2?"DOUBLE":"TRIPLE",sector:a,mult:i}}if(d.bull){const a=String(d.bull).toLowerCase()==="inner"||d.bull===!0;return{value:a?50:25,ring:a?"INNER_BULL":"BULL",sector:null,mult:0}}}catch{}return null}function js(d){const a=String(d||"").toUpperCase();return a.startsWith("TR")?"TRIPLE":a.startsWith("DO")?"DOUBLE":a.startsWith("SI")?"SINGLE":a==="INNER_BULL"||a==="DBULL"||a==="50"||a==="IBULL"?"INNER_BULL":a==="BULL"||a==="25"||a==="OBULL"||a==="OUTER_BULL"?"BULL":a==="MISS"||a==="0"?"MISS":"SINGLE"}function Ss(d,a){const i=Math.max(0,Math.min(60,Math.round(Number(d)||0)));return a==="INNER_BULL"?{value:50,ring:a}:a==="BULL"?{value:25,ring:a}:{value:i,ring:a}}function an(d,a){let i=null,x=!0,o=null,p=0;const M=400,O=[],v=new Set;function c(k,I){const L=typeof k?.id=="string"||typeof k?.id=="number"?String(k.id):null;if(L){if(v.has(L))return;if(v.add(L),O.push(L),O.length>200){const pe=O.shift();pe&&v.delete(pe)}}const Q=`${I.value}|${I.ring}|${I.sector??""}|${I.mult??""}`,re=Date.now();Q===o&&re-p<M||(o=Q,p=re,a(I))}function N(){if(x)try{i=new WebSocket(d),i.onmessage=k=>{try{const I=JSON.parse(k.data),L=rn(I);L&&c(I,L)}catch{}},i.onclose=()=>{i=null,setTimeout(N,1500)},i.onerror=()=>{}}catch{setTimeout(N,2e3)}}return N(),{close:()=>{x=!1;try{i?.close()}catch{}}}}function Es({storageKey:d,children:a,className:i,defaultWidth:x=640,defaultHeight:o=360,minWidth:p=320,minHeight:M=200,maxWidth:O=1600,maxHeight:v=1200,autoFill:c=!1}){const[N,k]=r.useState(()=>{try{const j=localStorage.getItem(d);if(j)return JSON.parse(j)}catch{}return c?{width:x}:{width:x,height:o}}),I=r.useRef(null),L=r.useRef(null);r.useEffect(()=>{function j(){try{localStorage.removeItem(d)}catch{}k({width:x,height:o})}return window.addEventListener("ndn:layout-reset",j),window.addEventListener("ndn:camera-reset",j),()=>{window.removeEventListener("ndn:layout-reset",j),window.removeEventListener("ndn:camera-reset",j)}},[d,x,o]),r.useEffect(()=>{try{localStorage.setItem(d,JSON.stringify(N))}catch{}},[N,d]);function Q(j,w,_){return Math.max(w,Math.min(_,j))}function re(j,w){j.preventDefault();const _=L.current;if(!_)return;const ce=_.getBoundingClientRect();I.current={x:j.clientX,y:j.clientY,w:ce.width,h:ce.height,dir:w},window.addEventListener("mousemove",pe),window.addEventListener("mouseup",De)}function pe(j){const w=I.current;if(!w)return;const _=j.clientX-w.x,ce=j.clientY-w.y;let T=w.w,G=w.h;w.dir.includes("e")&&(T=Q(w.w+_,p,O)),!c&&w.dir.includes("s")&&(G=Q(w.h+ce,M,v)),w.dir.includes("w")&&(T=Q(w.w-_,p,O)),!c&&w.dir.includes("n")&&(G=Q(w.h-ce,M,v)),k({width:Math.round(T),height:Math.round(G)})}function De(){window.removeEventListener("mousemove",pe),window.removeEventListener("mouseup",De),I.current=null}const $e={width:c?"100%":N.width?`${N.width}px`:void 0,height:c?"100%":N.height?`${N.height}px`:void 0,maxWidth:"100%",maxHeight:c?"100%":"80vh",position:"relative",...c?{display:"flex",flexDirection:"column",flex:"1 1 auto"}:{}};return t.jsxs("div",{ref:L,className:`${i||""}`,style:$e,children:[a,t.jsx("div",{className:"resizer resizer-nw",onMouseDown:j=>re(j,"nw")}),t.jsx("div",{className:"resizer resizer-ne",onMouseDown:j=>re(j,"ne")}),t.jsx("div",{className:"resizer resizer-sw",onMouseDown:j=>re(j,"sw")}),t.jsx("div",{className:"resizer resizer-se",onMouseDown:j=>re(j,"se")})]})}const ln=Ls((d,a)=>({samples:[],addSample:i=>d(x=>({samples:[...x.samples,i]})),clear:()=>d({samples:[]}),export:()=>a().samples.slice()})),on=Ls(d=>({paused:!1,pauseEndsAt:null,setPaused:(a,i=null)=>d({paused:a,pauseEndsAt:i??null})})),cn=1,un=120,dn=400,mn=450,hn=5e3,fn=.85,xn=6500;function bn({onVisitCommitted:d,showToolbar:a=!0,onAutoDart:i,immediateAutoCommit:x=!1,hideInlinePanels:o=!1,scoringMode:p="x01",onGenericDart:M,onGenericReplace:O,x01DoubleInOverride:v}){const c=r.useRef(null),{preferredCameraId:N,preferredCameraLabel:k,setPreferredCamera:I,autoscoreProvider:L,autoscoreWsUrl:Q,cameraAspect:re,cameraFitMode:pe,autoCommitMode:De="wait-for-clear",cameraEnabled:$e,setCameraEnabled:j,preferredCameraLocked:w,hideCameraOverlay:_,setHideCameraOverlay:ce}=_e(),T=L==="manual",[G,Ve]=r.useState([]),de=r.useRef(null),J=r.useRef(null),[fe,Le]=r.useState(!1),E=ws(),ae=k==="Phone Camera",It=E.getMediaStream?.()||null,dt=E.isStreaming,Z=ae&&E.mode==="phone"&&dt&&!!It,$=fe||dt,[ie,ze]=r.useState(!1),[mt,st]=r.useState(null),{H:me,imageSize:he,reset:Tt,_hydrated:Xt}=Js();r.useEffect(()=>{w&&!_&&ce(!0)},[w,_,ce]);const[W,Ut]=r.useState(""),[Ge,ue]=r.useState(""),[X,nt]=r.useState(0),[le,ht]=r.useState("MISS"),[g,V]=r.useState(0),[ve,z]=r.useState(0),[S,U]=r.useState([]),[Xe,Ie]=r.useState(0),[rt,b]=r.useState(0),[C,B]=r.useState(!1),K=r.useRef(null),ee=r.useRef(null),R=!x&&De!=="immediate",[Fe,He]=r.useState(0),[te,ft]=r.useState([]),q=r.useRef(null),xt=r.useRef([]),at=r.useRef(0),Ke=r.useRef(0),We=r.useRef(!1),Te=r.useRef(null),it=r.useRef(0),[Ot,Ms]=r.useState([]),[Kt,Rs]=r.useState(!1),bt=r.useCallback(()=>{ee.current&&(clearTimeout(ee.current),ee.current=null)},[]),Qt=r.useCallback(e=>{const s=[...xt.current.slice(-8),e];xt.current=s,Ms(s);try{window.ndnCameraDiagnostics=s}catch{}},[]),Ue=r.useCallback(e=>{const s=K.current;if(s&&(K.current=null,bt(),B(!1),d))try{d(s.score,s.darts,s.finished)}catch{}},[d,bt]),Oe=r.useCallback(e=>{if(d){if(!R){try{d(e.score,e.darts,e.finished)}catch{}return}K.current=e,B(!0),bt(),ee.current=window.setTimeout(()=>Ue("timeout"),xn)}},[d,R,bt,Ue]),gt=r.useCallback(e=>{V(0),z(0),U([]),Ie(0),b(0),Y(!1);try{window.dispatchEvent(new CustomEvent("ndn:clear-visit-request",{detail:{source:"camera-view",reason:e,ts:Date.now()}}))}catch{}},[]);r.useEffect(()=>{if(!R)return;const e=()=>Ue("event");return window.addEventListener("ndn:darts-cleared",e),()=>window.removeEventListener("ndn:darts-cleared",e)},[R,Ue]),r.useEffect(()=>{R||Ue("timeout")},[R,Ue]),r.useEffect(()=>()=>Ue("teardown"),[Ue]);const ks=r.useCallback(()=>{gt("indicator"),He(e=>e+1)},[gt]),As=r.useCallback(()=>{g===0&&ve===0||(gt("toolbar"),He(e=>e+1))},[gt,g,ve]),Ds=r.useCallback(()=>{if(!T)try{window.dispatchEvent(new CustomEvent("ndn:open-camera-manager",{detail:{source:"camera-view",ts:Date.now()}}))}catch(e){console.warn("[CameraView] Failed to request camera manager:",e)}},[T]),Is=_e(e=>e.x01DoubleIn),Qe=typeof v=="boolean"?!!v:!!Is,[Ts,Jt]=r.useState({}),A=Gt(e=>e),pt=A.players[A.currentPlayerIdx]?.id,Je=!!(pt&&Ts[pt]),Zt=e=>{pt&&Jt(s=>({...s,[pt]:e}))},Bt=A?.inProgress,es=Ns(e=>e.setVisit),ts=Ns(e=>e.reset);r.useEffect(()=>{try{es(S,g,ve)}catch{}},[S,g,ve,es]),r.useEffect(()=>()=>{try{ts()}catch{}},[ts]);const Be=Gt(e=>e.addVisit),ss=Gt(e=>e.endLeg),Pt=ln(e=>e.addSample),[vt,Us]=r.useState(""),[wt,Os]=r.useState(""),[Ne,P]=r.useState(0),[Bs,xe]=r.useState(!1),[we,Y]=r.useState(!1),[ns,yt]=r.useState(!1),Ce=r.useRef(null),[rs,Me]=r.useState("auto"),[_t,Re]=r.useState(!1),[Ps,Nt]=r.useState(!1),[_s,as]=r.useState(!1),is=r.useRef(null),lt=_e(e=>e.dartTimerEnabled),$t=_e(e=>e.dartTimerSeconds)||10,[Ze,Vt]=r.useState(null),je=r.useRef(null),Ct=on(e=>e.paused),ot=r.useRef(null),qe=r.useRef(null),[ls,os]=r.useState(0),jt=r.useCallback(()=>{try{window.dispatchEvent(new CustomEvent("ndn:phone-camera-reconnect",{detail:{source:"camera-view",ts:Date.now()}}))}catch(e){console.warn("[CameraView] Phone camera reconnect dispatch failed:",e)}},[]);r.useEffect(()=>{const e=()=>{T||Nt(!0)};return window.addEventListener("ndn:open-autoscore",e),()=>window.removeEventListener("ndn:open-autoscore",e)},[T]),r.useEffect(()=>()=>{try{Ce.current&&clearTimeout(Ce.current)}catch{}},[]),r.useEffect(()=>{const e=()=>as(!0);return window.addEventListener("ndn:open-scoring",e),()=>window.removeEventListener("ndn:open-scoring",e)},[]),r.useEffect(()=>{const e=()=>{He(s=>s+1),V(0),z(0),U([]),Ie(0),b(0),Y(!1)};return window.addEventListener("ndn:darts-cleared",e),()=>window.removeEventListener("ndn:darts-cleared",e)},[]),r.useEffect(()=>{ft(e=>{if(S.length>e.length){const s=S.length-e.length;return[...e,...Array(s).fill(Fe)]}return S.length<e.length?e.slice(0,S.length):e})},[S,Fe]),r.useEffect(()=>{if(Te.current&&(clearTimeout(Te.current),Te.current=null),T){We.current=!1,Ke.current=0,q.current=null;return}return $?(Ke.current=performance.now(),q.current=null,We.current=!1,it.current=0,Te.current=window.setTimeout(()=>{We.current=!0,Te.current=null},hn)):(Ke.current=0,q.current=null,We.current=!1,it.current=0),()=>{Te.current&&(clearTimeout(Te.current),Te.current=null),We.current=!1,it.current=0}},[$,T]),r.useEffect(()=>{let e=!0;async function s(){try{if(!navigator?.mediaDevices?.enumerateDevices)return;const n=await navigator.mediaDevices.enumerateDevices();if(!e)return;Ve(n.filter(l=>l.kind==="videoinput"))}catch(n){console.warn("[CAMERA] enumerateDevices failed:",n)}}s();try{navigator.mediaDevices.addEventListener("devicechange",s)}catch{try{navigator.mediaDevices.ondevicechange=s}catch{}}return()=>{e=!1;try{navigator.mediaDevices.removeEventListener("devicechange",s)}catch{}}},[]),r.useEffect(()=>{const e=()=>{Me("manual"),Re(!0)},s=()=>{Me("auto"),Re(!1)};return window.addEventListener("ndn:open-manual",e),window.addEventListener("ndn:close-manual",s),()=>{window.removeEventListener("ndn:open-manual",e),window.removeEventListener("ndn:close-manual",s)}},[]),r.useEffect(()=>{T&&(Me("manual"),Nt(!1))},[T]),r.useEffect(()=>{try{const e=A.players[A.currentPlayerIdx],s=e?.legs?.[e.legs.length-1];if(!e)return;(!s||s.dartsThrown===0)&&Jt(n=>({...n,[e.id]:!1}))}catch{}},[A.currentPlayerIdx,A.players?.[A.currentPlayerIdx]?.legs?.length]),r.useEffect(()=>{const e=!!lt&&Bt&&!Ct&&g<3;if(je.current&&(clearInterval(je.current),je.current=null),!e){Vt(null);return}return Vt($t),je.current=window.setInterval(()=>{Vt(s=>{const n=(s??$t)-1;if(n<=0){try{Se(0,"MISS 0","MISS")}catch{}return je.current&&(clearInterval(je.current),je.current=null),0}return n})},1e3),()=>{je.current&&(clearInterval(je.current),je.current=null)}},[lt,$t,g,A.currentPlayerIdx,A?.inProgress,Ct]),r.useEffect(()=>{if(!_t)return;const e=setInterval(()=>{try{const s=c.current,n=is.current;if(!s||!n)return;const l=s.videoWidth||0,f=s.videoHeight||0;if(!l||!f)return;const m=n.clientWidth||640,u=n.clientHeight||360;n.width!==m&&(n.width=m),n.height!==u&&(n.height=u);const h=n.getContext("2d");if(!h)return;h.imageSmoothingEnabled=!0;const y=Math.min(m/l,u/f),be=Math.round(l*y),D=Math.round(f*y),F=Math.floor((m-be)/2),H=Math.floor((u-D)/2);h.fillStyle="#000",h.fillRect(0,0,m,u),h.drawImage(s,F,H,be,D)}catch(s){console.warn("Manual preview update error:",s)}},120);return()=>clearInterval(e)},[_t]),r.useEffect(()=>()=>St(),[]);const cs=ae&&!Z;async function ct(){if(!(ie||fe)){if(ae&&Z){console.log("[CAMERA] Phone camera stream active - leaving local camera idle"),ze(!1);return}ze(!0),console.log("[CAMERA] Starting camera...");try{const e=N?{video:{deviceId:{exact:N}},audio:!1}:{video:{facingMode:"environment"},audio:!1};console.log("[CAMERA] Using constraints:",e);let s;try{s=await navigator.mediaDevices.getUserMedia(e),console.log("[CAMERA] Got stream:",!!s)}catch(n){console.warn("[CAMERA] First attempt failed:",n);const l=n&&(n.name||n.code)||"";if(N&&(l==="OverconstrainedError"||l==="NotFoundError"))console.log("[CAMERA] Trying fallback without deviceId"),s=await navigator.mediaDevices.getUserMedia({video:!0,audio:!1});else if(!N&&(l==="OverconstrainedError"||l==="NotFoundError"||l==="NotSupportedError"))console.log("[CAMERA] Trying fallback for facingMode not supported"),s=await navigator.mediaDevices.getUserMedia({video:!0,audio:!1});else throw n}if(c.current){console.log("[CAMERA] Setting stream to video element"),c.current.srcObject=s,console.log("[CAMERA] Stream tracks:",s.getTracks().length,"video tracks:",s.getVideoTracks().length),c.current.addEventListener("loadeddata",()=>console.log("[CAMERA] Video loadeddata")),c.current.addEventListener("canplay",()=>console.log("[CAMERA] Video canplay")),c.current.addEventListener("play",()=>console.log("[CAMERA] Video started playing")),c.current.addEventListener("error",n=>console.error("[CAMERA] Video error:",n));try{c.current.play(),console.log("[CAMERA] Play called successfully")}catch(n){console.error("[CAMERA] Video play failed:",n),setTimeout(()=>{try{c.current?.play(),console.log("[CAMERA] Retry play called")}catch(l){console.error("[CAMERA] Retry play failed:",l)}},100)}try{E.setVideoElementRef?.(c.current),E.setMediaStream?.(s),E.setMode?.("local"),E.setStreaming?.(!0)}catch(n){console.warn("[CAMERA] Failed to sync camera session with local stream:",n)}}else console.error("[CAMERA] Video element not found");Le(!0);try{const n=await navigator.mediaDevices.enumerateDevices();Ve(n.filter(l=>l.kind==="videoinput")),console.log("[CAMERA] Found cameras:",n.filter(l=>l.kind==="videoinput").length)}catch(n){console.warn("[CAMERA] Failed to enumerate devices:",n)}}catch(e){console.error("[CAMERA] Camera start failed:",e),alert("Camera permission denied or not available.")}finally{ze(!1)}}}function St(){c.current&&c.current.srcObject&&(c.current.srcObject.getTracks().forEach(s=>s.stop()),c.current.srcObject=null,Le(!1),ze(!1))}r.useEffect(()=>{const e=c.current;if(!e)return;const s=E.getMediaStream?.()||null,l=(E.getVideoElementRef?.()||null)?.srcObject||null,f=s||l;if(f){e.srcObject!==f&&(e.srcObject=f),e.muted=!0,e.playsInline=!0;try{e.play?.()}catch{}fe||Le(!0)}},[E.mode,E.isStreaming,fe,E]);function us(){try{if(!de.current)return;const e=c.current,s=E.getVideoElementRef?.()||null,n=e&&e.videoWidth>0&&e.videoHeight>0?e:s||e;if(!n)return;const l=n,f=de.current;f.width=l.videoWidth,f.height=l.videoHeight;const m=f.getContext("2d");if(!m)return;m.drawImage(l,0,0,f.width,f.height);const u=f.toDataURL("image/png");st(u)}catch(e){console.warn("Capture error:",e)}}function ds(){return G.length?t.jsxs("div",{className:"absolute top-2 right-2 z-20 flex items-center gap-2 bg-black/40 rounded px-2 py-1 text-xs",children:[t.jsx("span",{children:"Cam:"}),t.jsxs("select",{className:"bg-black/20 rounded px-1 py-0.5",value:N||"",onChange:async e=>{if(ie)return;const s=e.target.value||void 0,n=G.find(l=>l.deviceId===s)?.label;I(s,n||"",!0),St(),await new Promise(l=>setTimeout(l,150));try{await ct()}catch(l){console.warn("Failed to start camera after device switch:",l),setTimeout(async()=>{try{await ct()}catch(f){console.error("Camera switch failed after retry:",f),alert("Failed to switch camera. Please try again or refresh the page.")}},500)}},children:[t.jsx("option",{value:"",children:"Auto"}),G.map(e=>t.jsx("option",{value:e.deviceId,children:e.label||(e.deviceId?`Camera (${e.deviceId.slice(0,6)})`:"Camera")},e.deviceId))]}),t.jsx("button",{className:"btn btn--ghost btn-sm ml-2",onClick:async()=>{try{const e=await navigator.mediaDevices.enumerateDevices();Ve(e.filter(s=>s.kind==="videoinput"))}catch(e){console.warn("Rescan failed:",e),alert("Failed to rescan devices. Ensure camera permissions are granted.")}},title:"Rescan connected cameras",children:"Rescan"})]}):null}r.useEffect(()=>{},[me,he,$,T,ae,w,_]),r.useEffect(()=>{if(T||L!=="built-in")return;const e=ws.getState(),n=_e.getState().preferredCameraLabel==="Phone Camera"?e.getVideoElementRef?.()||null:c.current;if(!n||!me||!he)return;let l=!1;const f=n,m=de.current;if(!m)return;ot.current||(ot.current=new nn);const u=()=>{if(!l){try{const h=f.videoWidth||0,y=f.videoHeight||0;if(!h||!y){qe.current=requestAnimationFrame(u);return}m.width!==h&&(m.width=h),m.height!==y&&(m.height=y);const be=m.getContext("2d",{willReadFrequently:!0});if(!be){qe.current=requestAnimationFrame(u);return}be.drawImage(f,0,0,h,y);const D=be.getImageData(0,0,h,y);it.current++;const F=ys(me,{x:0,y:0}),H=ys(me,{x:en.doubleOuter,y:0}),ke=h/he.w,ye=y/he.h,Ye=F.x*ke,Rt=F.y*ye,Hs=H.x*ke,Ws=H.y*ye,qs=Math.hypot(Hs-Ye,Ws-Rt)*1.08,zt=ot.current;if(ls>=0&&zt.setROI(Ye,Rt,Math.max(24,Math.min(Math.max(h,y),qs))),!Ct&&g<3&&We.current&&it.current>150){const ge=zt.detect(D),Pe=performance.now();if(q.current&&Pe-q.current.firstTs>900&&(q.current=null),ge&&ge.confidence>=fn){const gs=Ke.current>0&&Pe-Ke.current<mn,kt=tn(m,ge.tip,6),Ys={x:kt.x/ke,y:kt.y/ye},At=Cs(me,Ys),Ae=At.ring,Ee=At.base,Dt=`${Ae} ${Ee>0?Ee:""}`.trim(),ps=At.sector??null,vs=Math.max(0,Number(At.mult)||0);let et=!1;Ut(Dt),nt(Ee),ht(Ae);const Gs=oe=>{if(oe.value>0){Y(!0),yt(!0);try{Ce.current&&clearTimeout(Ce.current)}catch{}Ce.current=window.setTimeout(()=>{yt(!1),Ce.current=null},1500);try{Se(oe.value,oe.label,oe.ring)}catch{}}else Y(!1);try{i&&i(oe.value,oe.ring,{sector:oe.sector,mult:oe.mult})}catch{}};if(gs)q.current=null,et=!0;else if(Ae==="MISS"||Ee<=0){q.current=null,Y(!1);try{i&&i(Ee,Ae,{sector:ps,mult:vs})}catch{}et=!0}else{const oe=q.current;!oe||oe.value!==Ee||oe.ring!==Ae?q.current={value:Ee,ring:Ae,label:Dt,sector:ps,mult:vs,firstTs:Pe,frames:1}:q.current={...oe,label:Dt,frames:oe.frames+1};const se=q.current,ne=Pe-se.firstTs,Ft=se.frames>=cn||ne>=un,Ht=Pe-at.current>=dn;Ft&&Ht&&(Gs(se),q.current=null,at.current=Pe,et=!0)}Qt({ts:Pe,label:Dt,value:Ee,ring:Ae,confidence:ge.confidence,ready:et,accepted:et&&Ee>0&&Ae!=="MISS",warmup:gs});try{if(Ee>0&&Ae!=="MISS"){const se=J.current;if(se){const ne=se.getContext("2d");if(ne){const Ft=kt.x/h*se.width,Ht=kt.y/y*se.height;if(ne.save(),ne.beginPath(),ne.strokeStyle="#f59e0b",ne.lineWidth=2,ne.arc(Ft,Ht,6,0,Math.PI*2),ne.stroke(),ge.axis){const tt=ge.axis,Wt=tt.x1/h*se.width,qt=tt.y1/y*se.height,Yt=tt.x2/h*se.width,Xs=tt.y2/y*se.height;ne.beginPath(),ne.moveTo(Wt,qt),ne.lineTo(Yt,Xs),ne.stroke()}if(ge.bbox){const tt=ge.bbox.x/h*se.width,Wt=ge.bbox.y/y*se.height,qt=ge.bbox.w/h*se.width,Yt=ge.bbox.h/y*se.height;ne.strokeStyle="#22d3ee",ne.strokeRect(tt,Wt,qt,Yt)}ne.restore()}}}}catch{}et&&zt.accept(D,ge)}else q.current&&Pe-q.current.firstTs>800&&(q.current=null)}}catch{}qe.current=requestAnimationFrame(u)}};return qe.current=requestAnimationFrame(u),()=>{l=!0,qe.current&&cancelAnimationFrame(qe.current),qe.current=null}},[T,L,$,me,he,Ct,g,ls,Qt]);const Et=r.useCallback(async()=>{try{if(ae){const e=G.find(s=>s.kind==="videoinput");e?I(e.deviceId,e.label||"",!0):I(void 0,"",!0)}await ct()}catch(e){console.warn("[CameraView] Local camera fallback failed:",e)}},[G,ae,I]);r.useEffect(()=>{try{sn.getState().setCalibrationStatus({hasHomography:!!me,imageSize:he})}catch{}},[me,he]),r.useEffect(()=>{if(L!=="external-ws"||!Q)return;const e=an(Q,s=>{if(!(!We.current||performance.now()-Ke.current<5e3))if(i){try{i(s.value,s.ring,{sector:s.sector??null,mult:s.mult??0})}catch{}try{Pt({playerId:A.players[A.currentPlayerIdx]?.id??null,sector:s.sector??null,mult:s.mult??0,ring:s.ring,ts:Date.now()})}catch{}}else{const n=s.ring==="INNER_BULL"?"INNER_BULL 50":s.ring==="BULL"?"BULL 25":`${s.ring[0]}${s.value/(s.mult||1)||s.value} ${s.value}`;Se(s.value,n,s.ring);try{Pt({playerId:A.players[A.currentPlayerIdx]?.id??null,sector:s.sector??null,mult:s.mult??0,ring:s.ring,ts:Date.now()})}catch{}}});return()=>e.close()},[L,Q]);function ms(e){if(!J.current||!me||!he)return;const s=J.current.getBoundingClientRect(),n=e.clientX-s.left,l=e.clientY-s.top,f=J.current.width/he.w,m=J.current.height/he.h,u={x:n/f,y:l/m},h=Cs(me,u),y=`${h.ring} ${h.base>0?h.base:""}`.trim();Ut(y),nt(h.base),ht(h.ring),Y(!0);try{if(x&&i){i(h.base,h.ring,{sector:h.sector,mult:h.mult});try{Pt({playerId:A.players[A.currentPlayerIdx]?.id??null,sector:h.sector??null,mult:h.mult??0,ring:h.ring,ts:Date.now()})}catch{}Y(!1)}}catch{}}function hs(e){const s=e.trim().toUpperCase();if(!s)return null;const n=s==="BULL"||s==="50"||s==="DBULL"||s==="IBULL",l=s==="25"||s==="OBULL";if(n)return{label:"INNER_BULL 50",value:50,ring:"INNER_BULL"};if(l)return{label:"BULL 25",value:25,ring:"BULL"};const f=s.match(/^(S|D|T)?\s*(\d{1,2})$/);if(!f)return null;const m=f[1]||"S",u=parseInt(f[2],10);if(u<1||u>20)return null;const h=m==="S"?1:m==="D"?2:3,y=m==="S"?"SINGLE":m==="D"?"DOUBLE":"TRIPLE";return{label:`${m}${u} ${u*h}`,value:u*h,ring:y}}function fs(){const e=A;if(!e.players.length)return e.startingScore;const s=e.players[e.currentPlayerIdx],n=s.legs[s.legs.length-1];return n?n.totalScoreRemaining:e.startingScore}function Se(e,s,n){if(R&&C){if(!ns){yt(!0);try{Ce.current&&clearTimeout(Ce.current)}catch{}Ce.current=window.setTimeout(()=>{yt(!1),Ce.current=null},1200)}return}if(p==="custom"){if(M)try{M(e,n,{label:s})}catch{}if(g>=3){V(1),z(e),U([{label:s,value:e,ring:n}]);return}const F=g+1;V(F),z(H=>H+e),U(H=>[...H,{label:s,value:e,ring:n}]);return}if(g>=3){const F=ve,H=g;Be(F,H,{preOpenDarts:Xe||0,doubleWindowDarts:rt||0,finishedByDouble:!1,visitTotal:F});try{const Ye=A.players[A.currentPlayerIdx]?.name;Ye&&ut(Ye,H,F)}catch{}const ke=!Qe||Je||n==="DOUBLE"||n==="INNER_BULL",ye=ke?e:0;V(1),z(ye),U([{label:s,value:ye,ring:n}]),Ie(ke?0:1),b(0),Qe&&!Je&&(n==="DOUBLE"||n==="INNER_BULL")&&Zt(!0),Oe({score:F,darts:H,finished:!1});return}const l=g+1,m=!Qe||Je||n==="DOUBLE"||n==="INNER_BULL"?e:0;Qe&&!Je&&(n==="DOUBLE"||n==="INNER_BULL")&&Zt(!0);const u=ve+m,y=fs()-u,be=y===0&&(n==="DOUBLE"||n==="INNER_BULL");if(y<0||y===1||y===0&&!be){const H=(Xe||0)+(Qe&&!Je&&!(n==="DOUBLE"||n==="INNER_BULL")?1:0),ke=y,ye=y+m,Ye=ye>50&&ke<=50||ye<=50?1:0,Rt=(rt||0)+Ye;Be(0,l,{preOpenDarts:H,doubleWindowDarts:Rt,finishedByDouble:!1,visitTotal:0}),V(0),z(0),U([]),Ie(0),b(0),Oe({score:0,darts:l,finished:!1});return}V(l),z(u),U(F=>[...F,{label:s,value:m,ring:n}]),Qe&&!Je&&!(n==="DOUBLE"||n==="INNER_BULL")&&Ie(F=>(F||0)+1);{const F=y,H=y+m;(H>50&&F<=50||H<=50)&&b(ye=>(ye||0)+1)}if(be){Be(u,l,{preOpenDarts:Xe||0,doubleWindowDarts:rt||0,finishedByDouble:!0,visitTotal:u}),ss(u),V(0),z(0),U([]),Ie(0),b(0),Oe({score:u,darts:l,finished:!0});return}l>=3&&(Be(u,l,{preOpenDarts:Xe||0,doubleWindowDarts:rt||0,finishedByDouble:!1,visitTotal:u}),V(0),z(0),U([]),Ie(0),b(0),Oe({score:u,darts:l,finished:!1}))}function xs(){if(!(R&&C)&&W){if(i)try{i(X,le,void 0)}catch{}else Se(X,W,le);P(0),Y(!1)}}function Lt(){if(R&&C)return;const e=hs(Ge);if(!e){alert("Enter like T20, D16, 5, 25, 50");return}if(!we||!W||le==="MISS"||X===0){const s=Ne+1;P(s),s>=5&&xe(!0)}else P(0);Se(e.value,e.label,e.ring),ue(""),Y(!1)}function bs(){if(R&&C)return;const e=hs(Ge);if(!e){alert("Enter like T20, D16, 5, 25, 50");return}if(g===0||S.length===0){Lt();return}if(p==="custom"){if(!we||!W||le==="MISS"||X===0){const D=Ne+1;P(D),D>=5&&xe(!0)}else P(0);if(U(D=>[...D.slice(0,-1),{label:e.label,value:e.value,ring:e.ring}]),O)try{O(e.value,e.ring,{label:e.label})}catch{}ue(""),Y(!1);return}if(!we||!W||le==="MISS"||X===0){const D=Ne+1;P(D),D>=5&&xe(!0)}else P(0);const s=S[S.length-1],n=g-1,l=ve-(s?.value||0),f=fs(),m=l+e.value,u=n+1,h=f-m,y=h===0&&(e.ring==="DOUBLE"||e.ring==="INNER_BULL");if(h<0||h===1||h===0&&!y){Be(0,u);try{const D=A.players[A.currentPlayerIdx]?.name;D&&ut(D,u,0)}catch{}V(0),z(0),U([]),Oe({score:0,darts:u,finished:!1}),ue(""),Y(!1);return}if(V(u),z(m),U(D=>[...D.slice(0,-1),{label:e.label,value:e.value,ring:e.ring}]),y){Be(m,u),ss(m);try{const D=A.players[A.currentPlayerIdx]?.name;D&&ut(D,u,m)}catch{}V(0),z(0),U([]),Oe({score:m,darts:u,finished:!0}),ue(""),Y(!1);return}if(u>=3){Be(m,u);try{const D=A.players[A.currentPlayerIdx]?.name;D&&ut(D,u,m)}catch{}V(0),z(0),U([]),Oe({score:m,darts:u,finished:!1})}ue(""),Y(!1)}function $s(){xe(!1),P(0);try{window.dispatchEvent(new CustomEvent("ndn:request-calibrate"))}catch{}}function Vs(){Tt(),xe(!1),P(0)}r.useEffect(()=>{function e(s){try{const l=document.activeElement?.tagName?.toLowerCase();s.key==="m"&&l!=="input"&&l!=="textarea"&&(Me("manual"),Re(!0))}catch{}}return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[]);function Mt(e,s){if(g>=3||R&&C)return;const n=e*(s==="S"?1:s==="D"?2:3),l=s==="S"?"SINGLE":s==="D"?"DOUBLE":"TRIPLE";if(!we||!W||le==="MISS"||X===0){const f=Ne+1;P(f),f>=5&&xe(!0)}else P(0);Se(n,`${s}${e} ${n}`,l),Y(!1)}function zs(){if(g===0)return;const e=S[S.length-1];V(s=>s-1),z(s=>s-(e?.value||0)),U(s=>s.slice(0,-1))}function Fs(){if(g===0||R&&C)return;if(p==="custom"){V(0),z(0),U([]);return}const e=ve,s=g;Be(e,s);try{const n=A.players[A.currentPlayerIdx]?.name;n&&ut(n,s,e)}catch{}V(0),z(0),U([]),Oe({score:e,darts:s,finished:!1})}return t.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-4",children:[a&&t.jsx("div",{className:"lg:col-span-2",children:t.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[!T&&t.jsx("button",{className:`btn px-3 py-1 text-sm ${rs==="auto"?"tab--active":""}`,onClick:()=>{Me("auto"),Re(!1),Nt(!0)},children:"Autoscore"}),t.jsx("button",{className:`btn px-3 py-1 text-sm ${rs==="manual"?"tab--active":""}`,onClick:()=>{Me("manual"),Re(!0)},title:"Open Manual Correction",children:"Manual Correction"}),T&&t.jsx("span",{className:"text-xs opacity-70",children:"Manual scoring mode active"})]})}),!o&&!T?t.jsxs("div",{className:"card relative camera-fullwidth-card lg:col-span-2",children:[t.jsx("h2",{className:"text-xl font-semibold mb-3",children:"Camera"}),t.jsxs(Es,{storageKey:"ndn:camera:size",className:"relative rounded-2xl overflow-hidden bg-black",defaultWidth:480,defaultHeight:360,minWidth:360,minHeight:270,maxWidth:800,maxHeight:600,autoFill:!0,children:[t.jsx(ds,{}),(()=>{const e=re||_e.getState().cameraAspect||"wide",s=(pe||_e.getState().cameraFitMode||"fit")==="fit",n=e==="square"?"absolute left-0 top-1/2 -translate-y-1/2 min-w-full min-h-full object-cover object-left bg-black":s?"absolute inset-0 w-full h-full object-contain object-center bg-black":"absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 min-w-full min-h-full w-auto h-auto object-cover object-center bg-black",l=e==="square"?"relative w-full mx-auto aspect-square bg-black":"relative w-full aspect-[4/3] bg-black",f=()=>t.jsxs("div",{className:l,children:[t.jsx("video",{ref:c,className:n,playsInline:!0,"webkit-playsinline":"true",muted:!0,autoPlay:!0}),t.jsx("canvas",{ref:J,className:"absolute inset-0 w-full h-full",onClick:ms}),t.jsxs("div",{className:"absolute top-2 left-1/2 -translate-x-1/2 z-20 flex items-center gap-3 cursor-pointer select-none",onDoubleClick:ks,"aria-label":`Visit status: ${S[0]?S[0].value>0?"hit":"miss":"pending"}, ${S[1]?S[1].value>0?"hit":"miss":"pending"}, ${S[2]?S[2].value>0?"hit":"miss":"pending"}`,children:[[0,1,2].map(m=>{const u=S[m],h=te[m],y=!!u&&h===Fe,be=typeof u?.value=="number"?u.value>0:!1,D=(u?.ring&&u.ring!=="MISS")??!1,H=y?y&&(be||D)?"bg-emerald-400":"bg-rose-500":"bg-gray-500/70";return t.jsx("span",{className:`w-3 h-3 rounded-full shadow ${H}`},m)}),lt&&Ze!==null&&t.jsxs("span",{className:"px-2 py-0.5 rounded bg-black/60 text-white text-xs font-semibold",children:[Math.max(0,Ze),"s"]})]}),R&&C?t.jsx("div",{className:"absolute bottom-3 left-1/2 -translate-x-1/2 z-20 bg-black/70 text-amber-200 text-xs font-semibold px-3 py-1 rounded-full shadow",children:"Remove darts to continue"}):null]});return ae?Z?f():t.jsx("div",{className:"w-full h-full flex flex-col items-center justify-center bg-gradient-to-br from-blue-900/50 to-purple-900/50",children:t.jsxs("div",{className:"text-center space-y-3 max-w-xs mx-auto",children:[t.jsx("div",{className:"text-4xl",children:"ðŸ“±"}),t.jsx("div",{className:"text-lg font-semibold text-blue-100",children:"Phone camera selected"}),t.jsx("p",{className:"text-sm text-slate-300",children:"Start streaming from the Calibrator tab or reconnect below."}),t.jsxs("div",{className:"flex items-center justify-center gap-2 flex-wrap",children:[t.jsx("button",{className:"btn bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 text-sm",onClick:jt,children:"Reconnect Phone"}),t.jsx("button",{className:"btn bg-slate-700 hover:bg-slate-800 text-white px-3 py-1 text-sm",onClick:()=>{try{E.setShowOverlay?.(!0)}catch{}},children:"Show Overlay"}),t.jsx("button",{className:"btn bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-1 text-sm",onClick:Et,disabled:!G.length,children:"Use Local Camera"})]})]})}):f()})()]}),t.jsxs("div",{className:"mt-3 flex items-center justify-between gap-2",children:[t.jsxs("button",{className:"btn btn--ghost px-3 py-1 text-xs font-semibold",onClick:()=>Rs(e=>!e),children:[Kt?"Hide":"Show"," detection log"]}),t.jsxs("span",{className:"text-xs text-slate-400",children:["Recent detections: ",Ot.length]})]}),Kt&&t.jsx("div",{className:"mt-2 rounded-2xl border border-white/15 bg-slate-900/80 p-3 text-xs text-white font-mono max-h-36 overflow-y-auto space-y-1",children:Ot.length===0?t.jsx("div",{className:"text-center text-slate-400",children:"No autoscore detections yet."}):Ot.slice().reverse().map(e=>t.jsxs("div",{className:"flex items-center justify-between gap-3",children:[t.jsx("span",{className:"truncate flex-1",title:`Value ${e.value} ${e.ring}`,children:e.label.padEnd(6," ")}),t.jsx("span",{className:"text-slate-400",children:e.confidence.toFixed(2)}),t.jsx("span",{className:`px-2 rounded-full text-[10px] font-semibold ${e.accepted?"bg-emerald-500/80":e.ready?"bg-amber-500/80":"bg-rose-500/80"}`,children:e.accepted?"accepted":e.ready?"queued":"ignored"})]},e.ts))}),Bt?t.jsx("div",{className:"absolute top-3 right-3 z-30",children:(()=>{let e="bg-white/90 text-slate-800",s="Manual Correction (M)";we&&(!!W&&le!=="MISS"&&X>0?(e="bg-emerald-600 text-white",s=`Manual Correction (M) â€” Autoscore: ${W} (confirmed)`):(e="bg-amber-400 text-black",s=`Manual Correction (M) â€” Autoscore ambiguous: ${W||"â€”"}`));const n="px-4 py-2 rounded-full text-base font-semibold shadow-sm hover:opacity-90",l=we&&!!W&&le!=="MISS"&&X>0,f=ns&&l?"ring-4 ring-emerald-400/60 animate-ping":we&&!l?"animate-pulse":"";return t.jsx("button",{className:`${n} ${e} ${f}`,onClick:()=>{Me("manual"),Re(!0)},title:s,children:"Manual"})})()}):null,t.jsxs("div",{className:"flex flex-wrap items-center gap-2 mt-3",children:[ae?t.jsxs(t.Fragment,{children:[t.jsx("div",{className:`text-sm px-3 py-2 rounded border flex-1 min-w-[200px] ${Z?"bg-emerald-500/10 border-emerald-400/40 text-emerald-100":"bg-amber-500/10 border-amber-400/40 text-amber-100"}`,children:Z?"ðŸ“± Phone camera stream active":"ðŸ“± Waiting for phone camera stream"}),t.jsx("button",{className:"btn bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 text-sm",onClick:jt,children:"Reconnect Phone"}),t.jsx("button",{className:"btn bg-slate-700 hover:bg-slate-800 text-white px-3 py-1 text-sm",onClick:()=>{try{E.setShowOverlay?.(!E.showOverlay)}catch{}},children:E.showOverlay?"Hide Overlay":"Show Overlay"}),t.jsx("button",{className:"btn bg-rose-600 hover:bg-rose-700 text-white px-3 py-1 text-sm",disabled:!Z,onClick:()=>{try{E.clearSession?.()}catch{}},children:"Stop Phone Feed"}),cs&&t.jsx("button",{className:"btn bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-1 text-sm",onClick:Et,disabled:!G.length,children:"Use Local Camera"})]}):t.jsx(t.Fragment,{children:fe?t.jsx("button",{className:"btn bg-rose-600 hover:bg-rose-700",onClick:St,children:"Stop Camera"}):t.jsx("button",{className:"btn",onClick:ct,disabled:ie,children:ie?"Connecting Camera...":"Connect Camera"})}),!T&&t.jsx("button",{className:"btn bg-slate-700 hover:bg-slate-800",onClick:Ds,title:"Open phone, WiFi, and USB camera options",children:"Camera Devices"}),t.jsx("button",{className:"btn btn--ghost px-3 py-1 text-sm",onClick:()=>ce(!_),title:"Toggle the board guide overlay",children:_?"Show board guides":"Hide board guides"}),t.jsx("button",{className:`btn ${$e?"bg-rose-600 hover:bg-rose-700 text-white":"bg-emerald-600 hover:bg-emerald-700 text-white"}`,onClick:()=>j(!$e),title:"Toggle whether the camera is used for scoring",children:$e?"Disable camera mode":"Enable camera mode"}),t.jsx("button",{className:"btn",onClick:us,disabled:!$,children:"Capture Still"}),t.jsx("button",{className:"btn bg-slate-700 hover:bg-slate-800",disabled:!$,onClick:()=>{ot.current=null,os(e=>e+1)},children:"Reset Autoscore Background"}),t.jsx("button",{className:"btn bg-slate-700 hover:bg-slate-800",onClick:()=>{try{window.dispatchEvent(new Event("ndn:camera-reset"))}catch{}},children:"Reset Camera Size"})]})]}):null,Bt?t.jsx("div",{className:"fixed bottom-6 right-6 z-50",children:t.jsx("button",{className:"btn btn--primary rounded-full w-12 h-12 flex items-center justify-center shadow-lg",title:"Open Manual Correction (M)",onClick:()=>{Me("manual"),Re(!0)},children:"âœï¸"})}):null,!o&&T&&t.jsxs("div",{className:"card",children:[t.jsx("h2",{className:"text-xl font-semibold mb-3",children:"Manual Scoring"}),t.jsx("p",{className:"text-sm opacity-80 mb-3",children:"Camera-based autoscore is disabled. Use the manual visit input or open the Manual Correction panel to record darts."}),t.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[t.jsx("button",{className:"btn",onClick:()=>{Re(!0),Me("manual")},children:"Open Manual Correction"}),t.jsx("button",{className:"btn btn--ghost",onClick:()=>{try{window.dispatchEvent(new Event("ndn:open-scoring"))}catch{}},children:"Manage Pending Visit"})]})]}),t.jsx("canvas",{ref:de,className:"hidden"}),Ps&&!T&&t.jsx("div",{className:"fixed inset-0 bg-black/60 z-[100]",role:"dialog","aria-modal":"true",children:t.jsx("div",{className:"absolute inset-0 flex items-center justify-center p-4",children:t.jsxs(Zs,{storageKey:"ndn:autoscore:size",className:"w-full max-w-3xl",defaultWidth:720,defaultHeight:520,minWidth:420,minHeight:320,maxWidth:1400,maxHeight:900,initialFitHeight:!0,children:[t.jsxs("div",{className:"flex items-center justify-between mb-3",children:[t.jsx("h2",{className:"text-xl font-semibold",children:"Autoscore"}),t.jsx("div",{className:"flex items-center gap-2",children:t.jsx("button",{className:"btn btn--ghost",onClick:()=>Nt(!1),children:"Close"})})]}),t.jsx("div",{className:"text-sm opacity-80 mb-3",children:"Click the camera overlay to autoscore. Use Manual Correction if the last auto is off."}),t.jsxs("div",{className:"flex items-center gap-2 mb-3 flex-wrap",children:[t.jsx("span",{className:"font-semibold",children:"Last auto:"}),t.jsx("span",{children:W||"â€”"}),t.jsx("button",{className:"btn",onClick:xs,disabled:g>=3,children:"Add Auto Dart"}),Ne>0&&t.jsxs("span",{className:"text-sm opacity-80",children:["No-registers: ",Ne,"/3"]})]}),t.jsxs("div",{className:"mt-2",children:[t.jsx("div",{className:"text-sm font-semibold mb-2",children:"Quick entry"}),t.jsxs("div",{className:"flex flex-wrap gap-2 mb-3",children:[t.jsx("button",{className:"btn",disabled:g>=3,onClick:()=>{if(!we||!W||le==="MISS"||X===0){const e=Ne+1;P(e),e>=5&&xe(!0)}else P(0);Se(25,"BULL 25","BULL"),Y(!1)},children:"25"}),t.jsx("button",{className:"btn",disabled:g>=3,onClick:()=>{if(!we||!W||le==="MISS"||X===0){const e=Ne+1;P(e),e>=5&&xe(!0)}else P(0);Se(50,"INNER_BULL 50","INNER_BULL"),Y(!1)},children:"50"})]}),t.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[t.jsx("input",{className:"input w-full max-w-sm",list:"autoscore-quick-list",placeholder:"Type or select (e.g., D16, T20, S5)",value:vt,onChange:e=>Us(e.target.value.toUpperCase()),onKeyDown:e=>{if(e.key==="Enter"){const s=vt.match(/^(S|D|T)(\d{1,2})$/);s&&Mt(parseInt(s[2],10),s[1])}}}),t.jsx("datalist",{id:"autoscore-quick-list",children:["D","S","T"].map(e=>Array.from({length:20},(s,n)=>n+1).map(s=>t.jsx("option",{value:`${e}${s}`},`${e}${s}`)))}),t.jsx("button",{className:"btn",disabled:!vt||g>=3,onClick:()=>{const e=vt.match(/^(S|D|T)(\d{1,2})$/);if(!e)return;const s=e[1],n=parseInt(e[2],10);Mt(n,s)},children:"Add"})]})]})]})})}),_t&&t.jsx("div",{className:"fixed inset-0 bg-black/60 z-[100]",role:"dialog","aria-modal":"true",children:t.jsxs("div",{className:"absolute inset-0 flex flex-col",children:[t.jsxs("div",{className:"p-3 md:p-4 flex items-center justify-between",children:[t.jsx("h3",{className:"text-xl md:text-2xl font-semibold",children:"Manual Correction"}),t.jsx("div",{className:"flex items-center gap-2",children:t.jsx("button",{className:"btn bg-slate-700 hover:bg-slate-800",onClick:()=>{Re(!1)},children:"Close"})})]}),t.jsx("div",{className:"flex-1 p-3 md:p-4",children:t.jsxs("div",{className:"h-full grid grid-cols-1 lg:grid-cols-2 gap-4",children:[t.jsxs("div",{className:"card relative flex flex-col",children:[t.jsx("div",{className:"text-sm font-semibold mb-2",children:"Live Preview"}),t.jsx("div",{className:"relative flex-1 rounded-2xl overflow-hidden bg-black",children:t.jsx("canvas",{ref:is,className:"absolute inset-0 w-full h-full"})})]}),t.jsxs("div",{className:"card flex flex-col",children:[t.jsx("div",{className:"text-sm opacity-80 mb-2",children:"Type a correction or replace the last dart. The preview updates live."}),t.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[t.jsx("span",{className:"font-semibold",children:"Last auto:"}),t.jsx("span",{children:W||"â€”"}),t.jsx("button",{className:"btn",onClick:xs,disabled:g>=3,children:"Add Auto Dart"})]}),t.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[t.jsx("input",{className:"input flex-[1.2]",placeholder:"Manual (T20, D16, 5, 25, 50)",value:Ge,onChange:e=>ue(e.target.value),onKeyDown:e=>{e.key==="Enter"&&!e.shiftKey&&(e.preventDefault(),Lt()),e.key==="Enter"&&e.shiftKey&&(e.preventDefault(),bs())}}),t.jsx("button",{className:"btn btn--ghost",onClick:bs,disabled:g===0,children:"Replace Last"}),t.jsx("button",{className:"btn",onClick:Lt,disabled:g>=3,children:"Add"})]}),t.jsx("div",{className:"text-xs opacity-70 mb-4",children:"Press Enter to Add Â· Shift+Enter to Replace Last"}),t.jsxs("div",{className:"mb-4",children:[t.jsx("div",{className:"text-sm font-semibold mb-2",children:"Number pad"}),t.jsxs("div",{className:"grid grid-cols-3 gap-2 max-w-sm",children:[["7","8","9","4","5","6","1","2","3","0"].map(e=>t.jsx("button",{className:"btn text-lg",onClick:()=>{ue(s=>/^[SDT]/i.test(s)?s+e:(s||"")+e)},children:e},e)),t.jsx("button",{className:"btn bg-rose-600 hover:bg-rose-700 text-white",onClick:()=>ue(""),children:"Clear"}),t.jsx("button",{className:"btn bg-slate-600 hover:bg-slate-700 text-white",onClick:()=>ue(e=>(e||"").slice(0,-1)),children:"âŒ«"}),t.jsx("button",{className:"btn bg-emerald-600 hover:bg-emerald-700 text-white",onClick:()=>Lt(),disabled:g>=3,children:"Enter"})]}),t.jsx("div",{className:"text-xs opacity-70 mt-2",children:"Tap numbers then press Enter to submit. Use D/T prefixes for doubles/trebles (e.g., D16)."})]}),t.jsxs("div",{className:"mt-auto",children:[t.jsx("div",{className:"text-sm font-semibold mb-2",children:"Quick entry"}),t.jsxs("div",{className:"flex flex-wrap gap-2 mb-3",children:[t.jsx("button",{className:"btn",disabled:g>=3,onClick:()=>{if(!we||!W||le==="MISS"||X===0){const e=Ne+1;P(e),e>=5&&xe(!0)}else P(0);Se(25,"BULL 25","BULL"),Y(!1)},children:"25"}),t.jsx("button",{className:"btn",disabled:g>=3,onClick:()=>{if(!we||!W||le==="MISS"||X===0){const e=Ne+1;P(e),e>=5&&xe(!0)}else P(0);Se(50,"INNER_BULL 50","INNER_BULL"),Y(!1)},children:"50"})]}),t.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[t.jsx("input",{className:"input w-full max-w-sm",list:"manual-quick-list",placeholder:"Type or select (e.g., D16, T20, S5)",value:wt,onChange:e=>Os(e.target.value.toUpperCase()),onKeyDown:e=>{if(e.key==="Enter"){const s=wt.match(/^(S|D|T)(\d{1,2})$/);s&&Mt(parseInt(s[2],10),s[1])}}}),t.jsx("datalist",{id:"manual-quick-list",children:["D","S","T"].map(e=>Array.from({length:20},(s,n)=>n+1).map(s=>t.jsx("option",{value:`${e}${s}`},`${e}${s}`)))}),t.jsx("button",{className:"btn",disabled:!wt||g>=3,onClick:()=>{const e=wt.match(/^(S|D|T)(\d{1,2})$/);if(!e)return;const s=e[1],n=parseInt(e[2],10);Mt(n,s)},children:"Add"})]})]})]})]})})]})}),_s&&t.jsx("div",{className:"fixed inset-0 bg-black/60 z-[100] flex items-center justify-center",children:t.jsxs("div",{className:"card w-full max-w-4xl relative text-left bg-[#2d2250] text-white p-6 rounded-xl shadow-xl",children:[t.jsx("button",{className:"absolute top-2 right-2 btn px-2 py-1 bg-purple-500 text-white font-bold",onClick:()=>as(!1),children:"Close"}),t.jsx("h2",{className:"text-xl font-bold mb-4 flex items-center gap-2 text-white",children:"Scoring"}),t.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[t.jsxs("div",{className:"bg-black/30 rounded-2xl p-4",children:[t.jsx("h2",{className:"text-lg font-semibold mb-3",children:"Camera"}),t.jsxs(Es,{storageKey:"ndn:camera:size:modal",className:"relative rounded-2xl overflow-hidden bg-black",defaultWidth:480,defaultHeight:360,minWidth:360,minHeight:270,maxWidth:800,maxHeight:600,children:[t.jsx(ds,{}),(()=>{const s=(_e.getState().cameraFitMode||"fit")==="fit"?"absolute inset-0 w-full h-full object-contain object-center bg-black":"absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 min-w-full min-h-full w-auto h-auto object-cover object-center bg-black",n=()=>t.jsxs("div",{className:"relative w-full aspect-[4/3] bg-black",children:[t.jsx("video",{ref:c,className:s,playsInline:!0,"webkit-playsinline":"true",muted:!0,autoPlay:!0}),t.jsx("canvas",{ref:J,className:"absolute inset-0 w-full h-full",onClick:ms}),t.jsxs("div",{className:"absolute top-2 left-1/2 -translate-x-1/2 z-20 flex items-center gap-3","aria-label":`Visit status: ${S[0]?S[0].value>0?"hit":"miss":"pending"}, ${S[1]?S[1].value>0?"hit":"miss":"pending"}, ${S[2]?S[2].value>0?"hit":"miss":"pending"}`,children:[[0,1,2].map(l=>{const f=S[l],m=!f,u=!!f&&(typeof f.value=="number"?f.value>0:!0),h=m?"bg-gray-500/70":u?"bg-emerald-400":"bg-rose-500";return t.jsx("span",{className:`w-3 h-3 rounded-full shadow ${h}`},l)}),lt&&Ze!==null&&t.jsxs("span",{className:"px-2 py-0.5 rounded bg-black/60 text-white text-xs font-semibold",children:[Math.max(0,Ze),"s"]})]}),R&&C?t.jsx("div",{className:"absolute bottom-3 left-1/2 -translate-x-1/2 z-20 bg-black/70 text-amber-200 text-xs font-semibold px-3 py-1 rounded-full shadow",children:"Remove darts to continue"}):null]});return ae?Z?n():t.jsx("div",{className:"w-full h-full flex flex-col items-center justify-center bg-gradient-to-br from-blue-900/50 to-purple-900/50",children:t.jsxs("div",{className:"text-center space-y-3 max-w-xs mx-auto",children:[t.jsx("div",{className:"text-4xl",children:"ðŸ“±"}),t.jsx("div",{className:"text-lg font-semibold text-blue-100",children:"Phone camera selected"}),t.jsx("p",{className:"text-sm text-slate-300",children:"Start streaming from the Calibrator tab or reconnect below."}),t.jsxs("div",{className:"flex items-center justify-center gap-2 flex-wrap",children:[t.jsx("button",{className:"btn bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 text-sm",onClick:jt,children:"Reconnect Phone"}),t.jsx("button",{className:"btn bg-slate-700 hover:bg-slate-800 text-white px-3 py-1 text-sm",onClick:()=>{try{E.setShowOverlay?.(!0)}catch{}},children:"Show Overlay"}),t.jsx("button",{className:"btn bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-1 text-sm",onClick:Et,disabled:!G.length,children:"Use Local Camera"})]})]})}):n()})()]}),t.jsxs("div",{className:"flex flex-wrap items-center gap-2 mt-3",children:[ae?t.jsxs(t.Fragment,{children:[t.jsx("div",{className:`text-sm px-3 py-2 rounded border flex-1 min-w-[200px] ${Z?"bg-emerald-500/10 border-emerald-400/40 text-emerald-100":"bg-amber-500/10 border-amber-400/40 text-amber-100"}`,children:Z?"ðŸ“± Phone camera stream active":"ðŸ“± Waiting for phone camera stream"}),t.jsx("button",{className:"btn bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 text-sm",onClick:jt,children:"Reconnect Phone"}),t.jsx("button",{className:"btn bg-slate-700 hover:bg-slate-800 text-white px-3 py-1 text-sm",onClick:()=>{try{E.setShowOverlay?.(!E.showOverlay)}catch{}},children:E.showOverlay?"Hide Overlay":"Show Overlay"}),t.jsx("button",{className:"btn bg-rose-600 hover:bg-rose-700 text-white px-3 py-1 text-sm",disabled:!Z,onClick:()=>{try{E.clearSession?.()}catch{}},children:"Stop Phone Feed"}),cs&&t.jsx("button",{className:"btn bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-1 text-sm",onClick:Et,disabled:!G.length,children:"Use Local Camera"})]}):t.jsx(t.Fragment,{children:fe?t.jsx("button",{className:"btn bg-gradient-to-r from-rose-600 to-rose-700 text-white font-bold",onClick:St,children:"Stop Camera"}):t.jsx("button",{className:"btn bg-gradient-to-r from-purple-500 to-purple-700 text-white font-bold",onClick:ct,children:"Connect Camera"})}),t.jsx("button",{className:"btn bg-gradient-to-r from-indigo-500 to-indigo-700 text-white font-bold",onClick:us,disabled:!$,children:"Capture Still"}),t.jsx("button",{className:"btn bg-gradient-to-r from-slate-600 to-slate-800 text-white font-bold",disabled:!$,onClick:()=>{ot.current=null,os(e=>e+1)},children:"Reset Autoscore Background"}),t.jsx("button",{className:"btn bg-gradient-to-r from-slate-500 to-slate-700 text-white font-bold",onClick:()=>{try{window.dispatchEvent(new Event("ndn:camera-reset"))}catch{}},children:"Reset Camera Size"})]})]}),t.jsxs("div",{className:"bg-black/30 rounded-2xl p-4",children:[t.jsx("h2",{className:"text-lg font-semibold mb-3",children:"Pending Visit"}),t.jsx("div",{className:"text-sm opacity-80 mb-2",children:"Up to 3 darts per visit."}),t.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[[0,1,2].map(e=>{const s=S[e],n=!s,l=!!s&&(typeof s.value=="number"?s.value>0:!0),f=n?"bg-gray-500/70":l?"bg-emerald-400":"bg-rose-500";return t.jsx("span",{className:`w-2.5 h-2.5 rounded-full shadow ${f}`},e)}),lt&&Ze!==null&&t.jsxs("span",{className:"ml-2 px-2 py-0.5 rounded bg-black/40 text-white text-xs font-semibold",children:[Math.max(0,Ze),"s"]})]}),t.jsx("ul",{className:"text-sm mb-2 list-disc pl-5",children:S.length===0?t.jsx("li",{className:"opacity-60",children:"No darts yet"}):S.map((e,s)=>t.jsx("li",{children:e.label},s))}),t.jsxs("div",{className:"flex items-center gap-4 mb-2",children:[t.jsxs("div",{className:"font-semibold",children:["Darts: ",g,"/3"]}),t.jsxs("div",{className:"font-semibold",children:["Total: ",ve]})]}),t.jsxs("div",{className:"flex gap-2",children:[t.jsx("button",{className:"btn bg-gradient-to-r from-purple-500 to-purple-700 text-white font-bold",onClick:zs,disabled:g===0,children:"Undo Dart"}),t.jsx("button",{className:"btn bg-gradient-to-r from-emerald-500 to-emerald-700 text-white font-bold",onClick:Fs,disabled:g===0,children:"Commit Visit"}),t.jsx("button",{className:"btn bg-gradient-to-r from-slate-500 to-slate-700 text-white font-bold",onClick:As,disabled:g===0,children:"Clear"})]})]})]})]})}),Bs&&t.jsx("div",{className:"fixed inset-0 bg-black/60 z-50 flex items-center justify-center",children:t.jsxs("div",{className:"card max-w-md w-full relative text-left bg-[#2d2250] text-white p-6 rounded-xl shadow-xl",children:[t.jsx("button",{className:"absolute top-2 right-2 btn px-2 py-1 bg-purple-500 text-white font-bold",onClick:()=>{xe(!1),P(0)},children:"Close"}),t.jsx("h3",{className:"text-xl font-bold mb-2 flex items-center gap-2 text-white",children:"Recalibration Recommended"}),t.jsx("div",{className:"mb-4 text-lg font-semibold text-indigo-200",children:"We detected 3 incorrect autoscores in a row. You can recalibrate now or reset calibration and try again."}),t.jsxs("div",{className:"flex gap-2",children:[t.jsx("button",{className:"btn bg-gradient-to-r from-purple-500 to-purple-700 text-white font-bold",onClick:$s,children:"Go to Calibrate"}),t.jsx("button",{className:"btn bg-gradient-to-r from-slate-500 to-slate-700 text-white font-bold",onClick:Vs,children:"Reset Calibration"}),t.jsx("button",{className:"btn bg-gradient-to-r from-slate-500 to-slate-700 text-white font-bold",onClick:()=>{xe(!1),P(0)},children:"Dismiss"})]})]})})]})}const yn=Object.freeze(Object.defineProperty({__proto__:null,default:bn},Symbol.toStringTag,{value:"Module"}));export{bn as C,Es as R,on as a,yn as b,ln as u};
//# sourceMappingURL=CameraView-C2UztPqq.js.map
