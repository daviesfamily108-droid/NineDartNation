import{Y as _,Z as Sn,u as et,_ as lo,$ as Nn,a0 as Nt,a1 as ft,a2 as kr,a3 as uo,a4 as fo,a5 as kn,a6 as ut,a7 as Xt,a8 as ho,a as kt,j as c,a9 as Vn,aa as Mt,ab as Pt,ac as mo,i as Et,ad as go,ae as po,af as bo,ag as yo}from"./index-0oBsAK_j.js";import{r as v}from"./ui-Cl5S-Tv0.js";import{g as xo}from"./vendor-D3F3s8fL.js";function wo(e){const n=Array.from({length:7},()=>Array.from({length:7},()=>0)),a=[];for(let o=9;o>=0;o--)a.push(e>>o&1);for(let o=0;o<5;o++){const t=o+1,r=a[2*o]??0,d=a[2*o+1]??0;n[t][2]=r,n[t][4]=d}return n}const Co=e=>!!e&&Number.isFinite(e.x)&&Number.isFinite(e.y),vo=e=>Array.isArray(e)&&e.length===9&&e.every(Number.isFinite);function So(e,n){const a=e.getContext("2d",{willReadFrequently:!0});if(!a)return null;const o=e.width,t=e.height,r=160,d=r/o,s=Math.floor(t*d),p=new OffscreenCanvas(r,s).getContext("2d",{willReadFrequently:!0});if(!p)return null;p.drawImage(e,0,0,r,s);const k=p.getImageData(0,0,r,s).data,P=new Float32Array(r*s),C=8;for(let F=1;F<s-1;F++)for(let $=1;$<r-1;$++){const J=(F*r+$)*4,X=J-4,Z=J+4,oe=J-r*4,U=J+r*4,he=k[X]*.299+k[X+1]*.587+k[X+2]*.114,ie=k[Z]*.299+k[Z+1]*.587+k[Z+2]*.114,ce=k[oe]*.299+k[oe+1]*.587+k[oe+2]*.114,je=k[U]*.299+k[U+1]*.587+k[U+2]*.114,Te=ie-he,Fe=je-ce,qe=Math.sqrt(Te*Te+Fe*Fe);if(qe>C){const ht=Te/qe,mt=Fe/qe,q=r*.03,tt=r*.6;for(let Oe=q;Oe<tt;Oe+=1){const gt=Math.round($+ht*Oe),pt=Math.round(F+mt*Oe);gt>=0&&gt<r&&pt>=0&&pt<s&&P[pt*r+gt]++;const Je=Math.round($-ht*Oe),bt=Math.round(F-mt*Oe);Je>=0&&Je<r&&bt>=0&&bt<s&&P[bt*r+Je]++}}}const T=new Float32Array(r*s),O=2;for(let F=O;F<s-O;F++)for(let $=O;$<r-O;$++){let J=0;for(let X=-O;X<=O;X++)for(let Z=-O;Z<=O;Z++)J+=P[(F+X)*r+($+Z)];T[F*r+$]=J}let L=0,E=r/2,j=s/2;const R=5;for(let F=R;F<s-R;F++)for(let $=R;$<r-R;$++){const J=T[F*r+$];J>L&&(L=J,E=$,j=F)}let N=E/d,D=j/d;n&&Number.isFinite(n.x)&&Number.isFinite(n.y)&&(N=.7*n.x+.3*N,D=.7*n.y+.3*D),console.log(`[findDartboardRings] Voting Peak: (${Math.round(N)}, ${Math.round(D)}) Votes=${L}`);const h=400,b=h/o,g=Math.floor(t*b),I=new OffscreenCanvas(h,g).getContext("2d");if(!I)return null;I.drawImage(e,0,0,h,g);const w=I.getImageData(0,0,h,g).data,A=new Float32Array(h*g),S=new Float32Array(h*g);for(let F=1;F<g-1;F++)for(let $=1;$<h-1;$++){const J=(F*h+$)*4;w[J]*.299+w[J+1]*.587+w[J+2]*.114;const X=J-4,Z=J+4,oe=J-h*4,U=J+h*4,he=w[X]*.299+w[X+1]*.587+w[X+2]*.114,ie=w[Z]*.299+w[Z+1]*.587+w[Z+2]*.114,ce=w[oe]*.299+w[oe+1]*.587+w[oe+2]*.114,je=w[U]*.299+w[U+1]*.587+w[U+2]*.114,Te=ie-he,Fe=je-ce;A[F*h+$]=Te,S[F*h+$]=Fe}const B=a.getImageData(0,0,o,t).data,G=(F,$)=>{const J=Math.max(0,Math.min(o-1,Math.round(F))),Z=(Math.max(0,Math.min(t-1,Math.round($)))*o+J)*4;return .299*B[Z]+.587*B[Z+1]+.114*B[Z+2]},ge=60,te={};for(let F=0;F<ge;F++){const $=F/ge*Math.PI*2,J=Math.cos($),X=Math.sin($),Z=[];for(let U=30;U<Math.min(o,t)/2;U+=1){const he=N+(U-2)*J,ie=D+(U-2)*X,ce=N+(U+2)*J,je=D+(U+2)*X,Te=G(he,ie),Fe=G(ce,je),qe=Math.abs(Fe-Te);qe>2&&U>20&&Z.push({r:U,grad:qe})}const oe=[];for(let U=0;U<Z.length;U++){const he=U>0?Z[U-1].grad:0,ie=Z[U].grad,ce=U<Z.length-1?Z[U+1].grad:0;ie>he&&ie>ce&&ie>2&&oe.push(Z[U].r)}oe.length>0&&oe.forEach(U=>{const he=Object.keys(te).map(ce=>({key:parseInt(ce),median:te[parseInt(ce)][Math.floor(te[parseInt(ce)].length/2)]})).filter(ce=>Math.abs(ce.median-U)<15).sort((ce,je)=>Math.abs(ce.median-U)-Math.abs(je.median-U))[0],ie=he?he.key:Math.max(-1,...Object.keys(te).map(ce=>parseInt(ce)))+1;te[ie]||(te[ie]=[]),te[ie].push(U)})}const xe=Object.keys(te).map(F=>{const $=te[parseInt(F)].sort((X,Z)=>X-Z),J=$[Math.floor($.length/2)];return{tier:parseInt(F),radius:J,samples:$.length}}).sort((F,$)=>F.radius-$.radius);console.log("[findDartboardRings] Detected ring tiers:",xe);const Q=[...xe];if(Q.length>=2){const F=Q[Q.length-1].radius,$=Q[Q.length-2].radius,J=F/$;(J>1.15&&Q.length>=5||J>1.3)&&(console.log(`[findDartboardRings] Ignoring outermost ring (likely light ring/surround): ${F.toFixed(1)}px (ratio ${J.toFixed(2)} to ${$.toFixed(1)}px)`),Q.pop())}const Ce=Q.length>0?Q[Q.length-1].radius:Math.min(o,t)*.3;let Me=50+Q.length*6;return Q.length>=7?Me=98:Q.length===6?Me=96:Q.length===5&&(Me=94),{cx:N,cy:D,r:Ce,confidence:Me,ringCount:Q.length,ringStrength:Q.length>0?Q[Q.length-1].radius:0,detectedRings:Q.map(F=>F.radius)}}function No(e,n,a,o){const t=e.getContext("2d");if(!t)return null;const r=e.width,d=e.height,s=720,f=o,p=new Array(s).fill(0),M=Math.max(2,Math.round(f-8)),k=Math.round(f+8),P=t.getImageData(0,0,r,d).data,C=(h,b)=>{const g=Math.round(h),y=Math.round(b);if(g<0||g>=r||y<0||y>=d)return 127;const I=(y*r+g)*4;return P[I]*.299+P[I+1]*.587+P[I+2]*.114};for(let h=0;h<s;h++){const b=h/s*Math.PI*2;let g=0,y=C(n+M*Math.cos(b),a+M*Math.sin(b));for(let I=M+1;I<=k;I++){const w=C(n+I*Math.cos(b),a+I*Math.sin(b)),A=Math.abs(w-y);A>g&&(g=A),y=w}p[h]=g}const T=[];for(let h=0;h<s;h++){const b=p[(h-1+s)%s],g=p[h],y=p[(h+1)%s];g>b&&g>y&&g>10&&T.push(h)}if(T.length<16){const h=p.map((b,g)=>{let y=0,I=0;for(let w=-2;w<=2;w++)y+=p[(g+w+s)%s],I++;return y/I});for(let b=0;b<s;b++){const g=h[(b-1+s)%s],y=h[b],I=h[(b+1)%s];y>g&&y>I&&y>8&&T.push(b)}}if(T.length===0)return 0;const O=T.map(h=>h/s*Math.PI*2);O.sort((h,b)=>h-b);const L=[];for(let h=0;h<O.length;h++){const b=O[h],y=(O[(h+1)%O.length]-b+Math.PI*2)%(Math.PI*2);L.push((b+y/2)%(Math.PI*2))}const E=20,j=new Array(E).fill(0).map((h,b)=>-Math.PI/2+b*(Math.PI*2/E));let R=0,N=1/0;for(let h=0;h<L.length;h++){let b=0;for(let g=0;g<Math.min(E,L.length);g++){const y=L[(g+h)%L.length],I=j[g],w=Math.abs((y-I+Math.PI)%(Math.PI*2)-Math.PI);b+=w*w}b<N&&(N=b,R=(L[h]-j[0]+Math.PI*2)%(Math.PI*2))}return(R+Math.PI)%(Math.PI*2)-Math.PI}function ko(e,n){const a=e.getContext("2d");if(!a)return n;const o=e.width,t=e.height,d=a.getImageData(0,0,o,t).data,s=(E,j)=>{const R=Math.max(0,Math.min(o-1,Math.round(E))),D=(Math.max(0,Math.min(t-1,Math.round(j)))*o+R)*4;return .299*d[D]+.587*d[D+1]+.114*d[D+2]},f=(E,j)=>{const R=s(E+1,j)-s(E-1,j),N=s(E,j+1)-s(E,j-1);return{gx:R,gy:N}},p=ft(n,{x:0,y:0}),M=E=>{const j=[_.trebleOuter,_.doubleOuter];let R=0;for(const N of j){const D=ut(E,N,180);for(let h=0;h<D.length;h++){const b=D[h],g=f(b.x,b.y),y=b.x-p.x,I=b.y-p.y,w=Math.hypot(y,I)||1,A=y/w,S=I/w;R+=Math.abs(g.gx*A+g.gy*S)}}return R/180/2};let k=n,P=M(n);const C=E=>E*Math.PI/180,T=[-4,-2,-1,-.5,0,.5,1,2,4],O=[-3,-2,-1,0,1,2,3],L=[.98,.99,1,1.01,1.02];for(const E of T){const j=fo(n,C(E));for(const R of O)for(const N of O){const D=kr(j,R,N);for(const h of L){const b=kn(D,h,h),g=M(b);g>P&&(P=g,k=b)}}}return k}function Gn(e,n){try{const a=e.width,o=e.height,t=a/2,r=o/2;let d=e;if(n?.colorAssist)try{const h=((w,A)=>{try{return new OffscreenCanvas(w,A)}catch{const S=document.createElement("canvas");return S.width=w,S.height=A,S}})(a,o),b=h.getContext("2d");if(!b)throw new Error("Could not get 2D context");b.drawImage(e,0,0,a,o);const g=b.getImageData(0,0,a,o),y=g.data,I=(w,A,S)=>{const B=w/255,G=A/255,ge=S/255,te=Math.max(B,G,ge),xe=Math.min(B,G,ge),Q=te-xe;let Ce=0;Q!==0&&(te===B?Ce=(G-ge)/Q%6:te===G?Ce=(ge-B)/Q+2:Ce=(B-G)/Q+4,Ce*=60,Ce<0&&(Ce+=360));const Me=te===0?0:Q/te;return{h:Ce,s:Me,v:te}};for(let w=0;w<y.length;w+=4){const A=y[w],S=y[w+1],B=y[w+2],{h:G,s:ge,v:te}=I(A,S,B),xe=ge>.25&&te>.2&&(G<20||G>340||G>340&&G<=360),Q=ge>.25&&te>.2&&G>=80&&G<=160;xe||Q?(y[w]=Math.min(255,A*1.2),y[w+1]=Math.min(255,S*1.2),y[w+2]=Math.min(255,B*1.2)):y[w]=y[w+1]=y[w+2]=0}b.putImageData(g,0,0),d=h}catch{d=e}const s=So(d,n?.centerHint);if(!s)return{success:!1,cx:t,cy:r,bullInner:0,bullOuter:0,trebleInner:0,trebleOuter:0,doubleInner:0,doubleOuter:0,confidence:0,homography:null,errorPx:null,calibrationPoints:[],message:"No dartboard detected. Ensure board is clearly visible with good contrast between rings and background."};const f=(()=>{const D=s.detectedRings||[];if(D.length>=6)return{cx:s.cx,cy:s.cy,bullInner:D[0],bullOuter:D[1],trebleInner:D[2],trebleOuter:D[3],doubleInner:D[4],doubleOuter:D[5]};{const h=s.r/_.doubleOuter;return{cx:s.cx,cy:s.cy,bullInner:_.bullInner*h,bullOuter:_.bullOuter*h,trebleInner:_.trebleInner*h,trebleOuter:_.trebleOuter*h,doubleInner:_.doubleInner*h,doubleOuter:s.r}}})(),p=No(e,f.cx,f.cy,f.doubleOuter)||0,M=Sn("outer"),k=M.map(D=>{if(D.x===0&&D.y===0)return{x:f.cx,y:f.cy};const h=Math.cos(p),b=Math.sin(p),g=f.doubleOuter/_.doubleOuter,y=D.x*g,I=D.y*g;return{x:f.cx+(y*h-I*b),y:f.cy+(y*b+I*h)}});let P=null,C=null,T=s.confidence,O=1;try{let D=!0;try{D=!!et.getState?.()?.calibrationUseRansac}catch{}if(D){const g=lo(M,k,{thresholdPx:8,maxIter:300});g.H?(P=g.H,C=g.errorPx,O=g.inliers.filter(Boolean).length/k.length,T=Math.max(T,Math.round(T*.6+O*40))):(P=Nn(M,k),C=Nt(P,M,k))}else P=Nn(M,k),C=Nt(P,M,k);if(P&&(P=ko(e,P),C=Nt(P,M,k)),P){const g=ft(P,{x:0,y:0}),y=f.cx-g.x,I=f.cy-g.y;Math.hypot(y,I)>.25&&(P=kr(P,y,I),C=Nt(P,M,k))}const b=uo(typeof C=="number"?C:null);typeof b=="number"?T=b:T=Math.max(O*100,s.confidence)}catch{T=Math.max(65,s.confidence)}const L=k.every(Co),E=vo(P),j=!!E&&L&&T>50,R=s.ringCount??0,N={success:j,cx:f.cx,cy:f.cy,bullInner:f.bullInner,bullOuter:f.bullOuter,trebleInner:f.trebleInner,trebleOuter:f.trebleOuter,doubleInner:f.doubleInner,doubleOuter:f.doubleOuter,confidence:Math.round(T),homography:E?P:null,errorPx:E?C:null,calibrationPoints:L?k:[],theta:typeof p=="number"?p:void 0,message:!L||!E?`âŒ Detection produced unstable calibration data. Adjust camera framing or calibrate manually. (rings: ${R}, r:${Math.round(s.r)})`:T>85?`âœ… Excellent detection (rings: ${R}, r:${Math.round(s.r)})`:`âœ… Board detected - may need angle adjustment (rings: ${R}, r:${Math.round(s.r)})`};return console.log("[detectBoard] Final result:",{success:N.success,confidence:N.confidence,homographyValid:E,pointsValid:L,cx:Math.round(N.cx),cy:Math.round(N.cy),doubleOuter:Math.round(N.doubleOuter),rings:R,errorPx:N.errorPx?N.errorPx.toFixed(2):null,calibrationPoints:k.map(D=>({x:Math.round(D.x),y:Math.round(D.y)}))},N.message),N}catch(a){return{success:!1,cx:e.width/2,cy:e.height/2,bullInner:0,bullOuter:0,trebleInner:0,trebleOuter:0,doubleInner:0,doubleOuter:0,confidence:0,homography:null,errorPx:null,calibrationPoints:[],message:a instanceof Error?a.message:"Board detection failed"}}}async function Mo(){const e=[];try{const n=await Po();for(const a of n){const o=await Io(a,[80,8080,8787,8788,3e3,5e3]);for(const t of o){const r=await To(t.ip,t.port);r&&e.push(r)}}}catch(n){console.error("Network discovery failed:",n)}return e}async function Po(){const e=[];try{const n=new RTCPeerConnection({iceServers:[]});n.createDataChannel("");const a=await n.createOffer();return await n.setLocalDescription(a),new Promise(o=>{const t=setTimeout(()=>{n.close(),o(e)},5e3);n.onicecandidate=r=>{if(r.candidate){const s=r.candidate.candidate.match(/(\d+\.\d+\.\d+\.\d+)/);if(s&&s[1]&&!e.includes(s[1])){const f=s[1];Eo(f)&&e.push(f)}}else clearTimeout(t),n.close(),o(e)}})}catch(n){return console.error("Failed to get local IPs:",n),["192.168.1.0"]}}function Eo(e){const n=e.split(".").map(Number);return n[0]===10||n[0]===172&&n[1]>=16&&n[1]<=31||n[0]===192&&n[1]===168}async function Io(e,n){const a=[],o=e.split(".").slice(0,3).join("."),t=[];for(let d=1;d<=254;d++){const s=`${o}.${d}`;for(const f of n)t.push(Ro(s,f))}return(await Promise.allSettled(t)).forEach((d,s)=>{if(d.status==="fulfilled"&&d.value){const f=s%n.length,p=Math.floor(s/n.length),M=`${o}.${p+1}`;a.push({ip:M,port:n[f]})}}),a}async function Ro(e,n){try{return await fetch(`http://${e}:${n}/`,{method:"HEAD",mode:"no-cors",signal:AbortSignal.timeout(2e3)}),!0}catch{return!1}}async function To(e,n){try{const a=["/","/api/info","/api/status","/camera","/stream"];for(const o of a)try{const t=await fetch(`http://${e}:${n}${o}`,{method:"GET",signal:AbortSignal.timeout(3e3)});if(t.ok){const r=t.headers.get("content-type")||"",d=await t.text();if(d.includes("OMNI")||d.includes("omni")||o.includes("omni"))return{id:`omni-${e}-${n}`,name:`OMNI Camera (${e})`,ip:e,port:n,type:"omni",capabilities:["video","calibration"],status:"online",connectionType:"wifi"};if(d.includes("VERT")||d.includes("vert")||o.includes("vert"))return{id:`vert-${e}-${n}`,name:`VERT Camera (${e})`,ip:e,port:n,type:"vert",capabilities:["video","calibration"],status:"online",connectionType:"wifi"};if(r.includes("video")||d.includes("stream")||o==="/stream")return{id:`generic-${e}-${n}`,name:`Network Camera (${e})`,ip:e,port:n,type:"generic",capabilities:["video"],status:"online",connectionType:"wifi"}}}catch{}}catch(a){console.error(`Failed to probe device ${e}:${n}:`,a)}return null}async function jo(e){try{const n=`http://${e.ip}:${e.port}/stream`,a=document.createElement("video");return a.src=n,a.crossOrigin="anonymous",new Promise((o,t)=>{a.onloadeddata=()=>{const r=document.createElement("canvas"),d=r.getContext("2d");r.width=a.videoWidth,r.height=a.videoHeight;const s=r.captureStream(30),f=()=>{a.readyState>=2&&d.drawImage(a,0,0),requestAnimationFrame(f)};f(),o(s)},a.onerror=()=>t(new Error("Failed to load video stream")),a.load()})}catch(n){return console.error("Failed to connect to network device:",n),null}}var Ze={},Zt,Jn;function Oo(){return Jn||(Jn=1,Zt=function(){return typeof Promise=="function"&&Promise.prototype&&Promise.prototype.then}),Zt}var en={},ze={},Kn;function Ve(){if(Kn)return ze;Kn=1;let e;const n=[0,26,44,70,100,134,172,196,242,292,346,404,466,532,581,655,733,815,901,991,1085,1156,1258,1364,1474,1588,1706,1828,1921,2051,2185,2323,2465,2611,2761,2876,3034,3196,3362,3532,3706];return ze.getSymbolSize=function(o){if(!o)throw new Error('"version" cannot be null or undefined');if(o<1||o>40)throw new Error('"version" should be in range from 1 to 40');return o*4+17},ze.getSymbolTotalCodewords=function(o){return n[o]},ze.getBCHDigit=function(a){let o=0;for(;a!==0;)o++,a>>>=1;return o},ze.setToSJISFunction=function(o){if(typeof o!="function")throw new Error('"toSJISFunc" is not a valid function.');e=o},ze.isKanjiModeEnabled=function(){return typeof e<"u"},ze.toSJIS=function(o){return e(o)},ze}var tn={},Yn;function Mn(){return Yn||(Yn=1,(function(e){e.L={bit:1},e.M={bit:0},e.Q={bit:3},e.H={bit:2};function n(a){if(typeof a!="string")throw new Error("Param is not a string");switch(a.toLowerCase()){case"l":case"low":return e.L;case"m":case"medium":return e.M;case"q":case"quartile":return e.Q;case"h":case"high":return e.H;default:throw new Error("Unknown EC Level: "+a)}}e.isValid=function(o){return o&&typeof o.bit<"u"&&o.bit>=0&&o.bit<4},e.from=function(o,t){if(e.isValid(o))return o;try{return n(o)}catch{return t}}})(tn)),tn}var nn,Qn;function Do(){if(Qn)return nn;Qn=1;function e(){this.buffer=[],this.length=0}return e.prototype={get:function(n){const a=Math.floor(n/8);return(this.buffer[a]>>>7-n%8&1)===1},put:function(n,a){for(let o=0;o<a;o++)this.putBit((n>>>a-o-1&1)===1)},getLengthInBits:function(){return this.length},putBit:function(n){const a=Math.floor(this.length/8);this.buffer.length<=a&&this.buffer.push(0),n&&(this.buffer[a]|=128>>>this.length%8),this.length++}},nn=e,nn}var rn,Xn;function Ao(){if(Xn)return rn;Xn=1;function e(n){if(!n||n<1)throw new Error("BitMatrix size must be defined and greater than 0");this.size=n,this.data=new Uint8Array(n*n),this.reservedBit=new Uint8Array(n*n)}return e.prototype.set=function(n,a,o,t){const r=n*this.size+a;this.data[r]=o,t&&(this.reservedBit[r]=!0)},e.prototype.get=function(n,a){return this.data[n*this.size+a]},e.prototype.xor=function(n,a,o){this.data[n*this.size+a]^=o},e.prototype.isReserved=function(n,a){return this.reservedBit[n*this.size+a]},rn=e,rn}var on={},Zn;function Bo(){return Zn||(Zn=1,(function(e){const n=Ve().getSymbolSize;e.getRowColCoords=function(o){if(o===1)return[];const t=Math.floor(o/7)+2,r=n(o),d=r===145?26:Math.ceil((r-13)/(2*t-2))*2,s=[r-7];for(let f=1;f<t-1;f++)s[f]=s[f-1]-d;return s.push(6),s.reverse()},e.getPositions=function(o){const t=[],r=e.getRowColCoords(o),d=r.length;for(let s=0;s<d;s++)for(let f=0;f<d;f++)s===0&&f===0||s===0&&f===d-1||s===d-1&&f===0||t.push([r[s],r[f]]);return t}})(on)),on}var an={},er;function Lo(){if(er)return an;er=1;const e=Ve().getSymbolSize,n=7;return an.getPositions=function(o){const t=e(o);return[[0,0],[t-n,0],[0,t-n]]},an}var sn={},tr;function Fo(){return tr||(tr=1,(function(e){e.Patterns={PATTERN000:0,PATTERN001:1,PATTERN010:2,PATTERN011:3,PATTERN100:4,PATTERN101:5,PATTERN110:6,PATTERN111:7};const n={N1:3,N2:3,N3:40,N4:10};e.isValid=function(t){return t!=null&&t!==""&&!isNaN(t)&&t>=0&&t<=7},e.from=function(t){return e.isValid(t)?parseInt(t,10):void 0},e.getPenaltyN1=function(t){const r=t.size;let d=0,s=0,f=0,p=null,M=null;for(let k=0;k<r;k++){s=f=0,p=M=null;for(let P=0;P<r;P++){let C=t.get(k,P);C===p?s++:(s>=5&&(d+=n.N1+(s-5)),p=C,s=1),C=t.get(P,k),C===M?f++:(f>=5&&(d+=n.N1+(f-5)),M=C,f=1)}s>=5&&(d+=n.N1+(s-5)),f>=5&&(d+=n.N1+(f-5))}return d},e.getPenaltyN2=function(t){const r=t.size;let d=0;for(let s=0;s<r-1;s++)for(let f=0;f<r-1;f++){const p=t.get(s,f)+t.get(s,f+1)+t.get(s+1,f)+t.get(s+1,f+1);(p===4||p===0)&&d++}return d*n.N2},e.getPenaltyN3=function(t){const r=t.size;let d=0,s=0,f=0;for(let p=0;p<r;p++){s=f=0;for(let M=0;M<r;M++)s=s<<1&2047|t.get(p,M),M>=10&&(s===1488||s===93)&&d++,f=f<<1&2047|t.get(M,p),M>=10&&(f===1488||f===93)&&d++}return d*n.N3},e.getPenaltyN4=function(t){let r=0;const d=t.data.length;for(let f=0;f<d;f++)r+=t.data[f];return Math.abs(Math.ceil(r*100/d/5)-10)*n.N4};function a(o,t,r){switch(o){case e.Patterns.PATTERN000:return(t+r)%2===0;case e.Patterns.PATTERN001:return t%2===0;case e.Patterns.PATTERN010:return r%3===0;case e.Patterns.PATTERN011:return(t+r)%3===0;case e.Patterns.PATTERN100:return(Math.floor(t/2)+Math.floor(r/3))%2===0;case e.Patterns.PATTERN101:return t*r%2+t*r%3===0;case e.Patterns.PATTERN110:return(t*r%2+t*r%3)%2===0;case e.Patterns.PATTERN111:return(t*r%3+(t+r)%2)%2===0;default:throw new Error("bad maskPattern:"+o)}}e.applyMask=function(t,r){const d=r.size;for(let s=0;s<d;s++)for(let f=0;f<d;f++)r.isReserved(f,s)||r.xor(f,s,a(t,f,s))},e.getBestMask=function(t,r){const d=Object.keys(e.Patterns).length;let s=0,f=1/0;for(let p=0;p<d;p++){r(p),e.applyMask(p,t);const M=e.getPenaltyN1(t)+e.getPenaltyN2(t)+e.getPenaltyN3(t)+e.getPenaltyN4(t);e.applyMask(p,t),M<f&&(f=M,s=p)}return s}})(sn)),sn}var It={},nr;function Mr(){if(nr)return It;nr=1;const e=Mn(),n=[1,1,1,1,1,1,1,1,1,1,2,2,1,2,2,4,1,2,4,4,2,4,4,4,2,4,6,5,2,4,6,6,2,5,8,8,4,5,8,8,4,5,8,11,4,8,10,11,4,9,12,16,4,9,16,16,6,10,12,18,6,10,17,16,6,11,16,19,6,13,18,21,7,14,21,25,8,16,20,25,8,17,23,25,9,17,23,34,9,18,25,30,10,20,27,32,12,21,29,35,12,23,34,37,12,25,34,40,13,26,35,42,14,28,38,45,15,29,40,48,16,31,43,51,17,33,45,54,18,35,48,57,19,37,51,60,19,38,53,63,20,40,56,66,21,43,59,70,22,45,62,74,24,47,65,77,25,49,68,81],a=[7,10,13,17,10,16,22,28,15,26,36,44,20,36,52,64,26,48,72,88,36,64,96,112,40,72,108,130,48,88,132,156,60,110,160,192,72,130,192,224,80,150,224,264,96,176,260,308,104,198,288,352,120,216,320,384,132,240,360,432,144,280,408,480,168,308,448,532,180,338,504,588,196,364,546,650,224,416,600,700,224,442,644,750,252,476,690,816,270,504,750,900,300,560,810,960,312,588,870,1050,336,644,952,1110,360,700,1020,1200,390,728,1050,1260,420,784,1140,1350,450,812,1200,1440,480,868,1290,1530,510,924,1350,1620,540,980,1440,1710,570,1036,1530,1800,570,1064,1590,1890,600,1120,1680,1980,630,1204,1770,2100,660,1260,1860,2220,720,1316,1950,2310,750,1372,2040,2430];return It.getBlocksCount=function(t,r){switch(r){case e.L:return n[(t-1)*4+0];case e.M:return n[(t-1)*4+1];case e.Q:return n[(t-1)*4+2];case e.H:return n[(t-1)*4+3];default:return}},It.getTotalCodewordsCount=function(t,r){switch(r){case e.L:return a[(t-1)*4+0];case e.M:return a[(t-1)*4+1];case e.Q:return a[(t-1)*4+2];case e.H:return a[(t-1)*4+3];default:return}},It}var cn={},dt={},rr;function Uo(){if(rr)return dt;rr=1;const e=new Uint8Array(512),n=new Uint8Array(256);return(function(){let o=1;for(let t=0;t<255;t++)e[t]=o,n[o]=t,o<<=1,o&256&&(o^=285);for(let t=255;t<512;t++)e[t]=e[t-255]})(),dt.log=function(o){if(o<1)throw new Error("log("+o+")");return n[o]},dt.exp=function(o){return e[o]},dt.mul=function(o,t){return o===0||t===0?0:e[n[o]+n[t]]},dt}var or;function _o(){return or||(or=1,(function(e){const n=Uo();e.mul=function(o,t){const r=new Uint8Array(o.length+t.length-1);for(let d=0;d<o.length;d++)for(let s=0;s<t.length;s++)r[d+s]^=n.mul(o[d],t[s]);return r},e.mod=function(o,t){let r=new Uint8Array(o);for(;r.length-t.length>=0;){const d=r[0];for(let f=0;f<t.length;f++)r[f]^=n.mul(t[f],d);let s=0;for(;s<r.length&&r[s]===0;)s++;r=r.slice(s)}return r},e.generateECPolynomial=function(o){let t=new Uint8Array([1]);for(let r=0;r<o;r++)t=e.mul(t,new Uint8Array([1,n.exp(r)]));return t}})(cn)),cn}var ln,ar;function $o(){if(ar)return ln;ar=1;const e=_o();function n(a){this.genPoly=void 0,this.degree=a,this.degree&&this.initialize(this.degree)}return n.prototype.initialize=function(o){this.degree=o,this.genPoly=e.generateECPolynomial(this.degree)},n.prototype.encode=function(o){if(!this.genPoly)throw new Error("Encoder not initialized");const t=new Uint8Array(o.length+this.degree);t.set(o);const r=e.mod(t,this.genPoly),d=this.degree-r.length;if(d>0){const s=new Uint8Array(this.degree);return s.set(r,d),s}return r},ln=n,ln}var dn={},un={},fn={},sr;function Pr(){return sr||(sr=1,fn.isValid=function(n){return!isNaN(n)&&n>=1&&n<=40}),fn}var Le={},ir;function Er(){if(ir)return Le;ir=1;const e="[0-9]+",n="[A-Z $%*+\\-./:]+";let a="(?:[u3000-u303F]|[u3040-u309F]|[u30A0-u30FF]|[uFF00-uFFEF]|[u4E00-u9FAF]|[u2605-u2606]|[u2190-u2195]|u203B|[u2010u2015u2018u2019u2025u2026u201Cu201Du2225u2260]|[u0391-u0451]|[u00A7u00A8u00B1u00B4u00D7u00F7])+";a=a.replace(/u/g,"\\u");const o="(?:(?![A-Z0-9 $%*+\\-./:]|"+a+`)(?:.|[\r
]))+`;Le.KANJI=new RegExp(a,"g"),Le.BYTE_KANJI=new RegExp("[^A-Z0-9 $%*+\\-./:]+","g"),Le.BYTE=new RegExp(o,"g"),Le.NUMERIC=new RegExp(e,"g"),Le.ALPHANUMERIC=new RegExp(n,"g");const t=new RegExp("^"+a+"$"),r=new RegExp("^"+e+"$"),d=new RegExp("^[A-Z0-9 $%*+\\-./:]+$");return Le.testKanji=function(f){return t.test(f)},Le.testNumeric=function(f){return r.test(f)},Le.testAlphanumeric=function(f){return d.test(f)},Le}var cr;function Ge(){return cr||(cr=1,(function(e){const n=Pr(),a=Er();e.NUMERIC={id:"Numeric",bit:1,ccBits:[10,12,14]},e.ALPHANUMERIC={id:"Alphanumeric",bit:2,ccBits:[9,11,13]},e.BYTE={id:"Byte",bit:4,ccBits:[8,16,16]},e.KANJI={id:"Kanji",bit:8,ccBits:[8,10,12]},e.MIXED={bit:-1},e.getCharCountIndicator=function(r,d){if(!r.ccBits)throw new Error("Invalid mode: "+r);if(!n.isValid(d))throw new Error("Invalid version: "+d);return d>=1&&d<10?r.ccBits[0]:d<27?r.ccBits[1]:r.ccBits[2]},e.getBestModeForData=function(r){return a.testNumeric(r)?e.NUMERIC:a.testAlphanumeric(r)?e.ALPHANUMERIC:a.testKanji(r)?e.KANJI:e.BYTE},e.toString=function(r){if(r&&r.id)return r.id;throw new Error("Invalid mode")},e.isValid=function(r){return r&&r.bit&&r.ccBits};function o(t){if(typeof t!="string")throw new Error("Param is not a string");switch(t.toLowerCase()){case"numeric":return e.NUMERIC;case"alphanumeric":return e.ALPHANUMERIC;case"kanji":return e.KANJI;case"byte":return e.BYTE;default:throw new Error("Unknown mode: "+t)}}e.from=function(r,d){if(e.isValid(r))return r;try{return o(r)}catch{return d}}})(un)),un}var lr;function qo(){return lr||(lr=1,(function(e){const n=Ve(),a=Mr(),o=Mn(),t=Ge(),r=Pr(),d=7973,s=n.getBCHDigit(d);function f(P,C,T){for(let O=1;O<=40;O++)if(C<=e.getCapacity(O,T,P))return O}function p(P,C){return t.getCharCountIndicator(P,C)+4}function M(P,C){let T=0;return P.forEach(function(O){const L=p(O.mode,C);T+=L+O.getBitsLength()}),T}function k(P,C){for(let T=1;T<=40;T++)if(M(P,T)<=e.getCapacity(T,C,t.MIXED))return T}e.from=function(C,T){return r.isValid(C)?parseInt(C,10):T},e.getCapacity=function(C,T,O){if(!r.isValid(C))throw new Error("Invalid QR Code version");typeof O>"u"&&(O=t.BYTE);const L=n.getSymbolTotalCodewords(C),E=a.getTotalCodewordsCount(C,T),j=(L-E)*8;if(O===t.MIXED)return j;const R=j-p(O,C);switch(O){case t.NUMERIC:return Math.floor(R/10*3);case t.ALPHANUMERIC:return Math.floor(R/11*2);case t.KANJI:return Math.floor(R/13);case t.BYTE:default:return Math.floor(R/8)}},e.getBestVersionForData=function(C,T){let O;const L=o.from(T,o.M);if(Array.isArray(C)){if(C.length>1)return k(C,L);if(C.length===0)return 1;O=C[0]}else O=C;return f(O.mode,O.getLength(),L)},e.getEncodedBits=function(C){if(!r.isValid(C)||C<7)throw new Error("Invalid QR Code version");let T=C<<12;for(;n.getBCHDigit(T)-s>=0;)T^=d<<n.getBCHDigit(T)-s;return C<<12|T}})(dn)),dn}var hn={},dr;function Wo(){if(dr)return hn;dr=1;const e=Ve(),n=1335,a=21522,o=e.getBCHDigit(n);return hn.getEncodedBits=function(r,d){const s=r.bit<<3|d;let f=s<<10;for(;e.getBCHDigit(f)-o>=0;)f^=n<<e.getBCHDigit(f)-o;return(s<<10|f)^a},hn}var mn={},gn,ur;function Ho(){if(ur)return gn;ur=1;const e=Ge();function n(a){this.mode=e.NUMERIC,this.data=a.toString()}return n.getBitsLength=function(o){return 10*Math.floor(o/3)+(o%3?o%3*3+1:0)},n.prototype.getLength=function(){return this.data.length},n.prototype.getBitsLength=function(){return n.getBitsLength(this.data.length)},n.prototype.write=function(o){let t,r,d;for(t=0;t+3<=this.data.length;t+=3)r=this.data.substr(t,3),d=parseInt(r,10),o.put(d,10);const s=this.data.length-t;s>0&&(r=this.data.substr(t),d=parseInt(r,10),o.put(d,s*3+1))},gn=n,gn}var pn,fr;function zo(){if(fr)return pn;fr=1;const e=Ge(),n=["0","1","2","3","4","5","6","7","8","9","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z"," ","$","%","*","+","-",".","/",":"];function a(o){this.mode=e.ALPHANUMERIC,this.data=o}return a.getBitsLength=function(t){return 11*Math.floor(t/2)+6*(t%2)},a.prototype.getLength=function(){return this.data.length},a.prototype.getBitsLength=function(){return a.getBitsLength(this.data.length)},a.prototype.write=function(t){let r;for(r=0;r+2<=this.data.length;r+=2){let d=n.indexOf(this.data[r])*45;d+=n.indexOf(this.data[r+1]),t.put(d,11)}this.data.length%2&&t.put(n.indexOf(this.data[r]),6)},pn=a,pn}var bn,hr;function Vo(){if(hr)return bn;hr=1;const e=Ge();function n(a){this.mode=e.BYTE,typeof a=="string"?this.data=new TextEncoder().encode(a):this.data=new Uint8Array(a)}return n.getBitsLength=function(o){return o*8},n.prototype.getLength=function(){return this.data.length},n.prototype.getBitsLength=function(){return n.getBitsLength(this.data.length)},n.prototype.write=function(a){for(let o=0,t=this.data.length;o<t;o++)a.put(this.data[o],8)},bn=n,bn}var yn,mr;function Go(){if(mr)return yn;mr=1;const e=Ge(),n=Ve();function a(o){this.mode=e.KANJI,this.data=o}return a.getBitsLength=function(t){return t*13},a.prototype.getLength=function(){return this.data.length},a.prototype.getBitsLength=function(){return a.getBitsLength(this.data.length)},a.prototype.write=function(o){let t;for(t=0;t<this.data.length;t++){let r=n.toSJIS(this.data[t]);if(r>=33088&&r<=40956)r-=33088;else if(r>=57408&&r<=60351)r-=49472;else throw new Error("Invalid SJIS character: "+this.data[t]+`
Make sure your charset is UTF-8`);r=(r>>>8&255)*192+(r&255),o.put(r,13)}},yn=a,yn}var xn={exports:{}},gr;function Jo(){return gr||(gr=1,(function(e){var n={single_source_shortest_paths:function(a,o,t){var r={},d={};d[o]=0;var s=n.PriorityQueue.make();s.push(o,0);for(var f,p,M,k,P,C,T,O,L;!s.empty();){f=s.pop(),p=f.value,k=f.cost,P=a[p]||{};for(M in P)P.hasOwnProperty(M)&&(C=P[M],T=k+C,O=d[M],L=typeof d[M]>"u",(L||O>T)&&(d[M]=T,s.push(M,T),r[M]=p))}if(typeof t<"u"&&typeof d[t]>"u"){var E=["Could not find a path from ",o," to ",t,"."].join("");throw new Error(E)}return r},extract_shortest_path_from_predecessor_list:function(a,o){for(var t=[],r=o;r;)t.push(r),a[r],r=a[r];return t.reverse(),t},find_path:function(a,o,t){var r=n.single_source_shortest_paths(a,o,t);return n.extract_shortest_path_from_predecessor_list(r,t)},PriorityQueue:{make:function(a){var o=n.PriorityQueue,t={},r;a=a||{};for(r in o)o.hasOwnProperty(r)&&(t[r]=o[r]);return t.queue=[],t.sorter=a.sorter||o.default_sorter,t},default_sorter:function(a,o){return a.cost-o.cost},push:function(a,o){var t={value:a,cost:o};this.queue.push(t),this.queue.sort(this.sorter)},pop:function(){return this.queue.shift()},empty:function(){return this.queue.length===0}}};e.exports=n})(xn)),xn.exports}var pr;function Ko(){return pr||(pr=1,(function(e){const n=Ge(),a=Ho(),o=zo(),t=Vo(),r=Go(),d=Er(),s=Ve(),f=Jo();function p(E){return unescape(encodeURIComponent(E)).length}function M(E,j,R){const N=[];let D;for(;(D=E.exec(R))!==null;)N.push({data:D[0],index:D.index,mode:j,length:D[0].length});return N}function k(E){const j=M(d.NUMERIC,n.NUMERIC,E),R=M(d.ALPHANUMERIC,n.ALPHANUMERIC,E);let N,D;return s.isKanjiModeEnabled()?(N=M(d.BYTE,n.BYTE,E),D=M(d.KANJI,n.KANJI,E)):(N=M(d.BYTE_KANJI,n.BYTE,E),D=[]),j.concat(R,N,D).sort(function(b,g){return b.index-g.index}).map(function(b){return{data:b.data,mode:b.mode,length:b.length}})}function P(E,j){switch(j){case n.NUMERIC:return a.getBitsLength(E);case n.ALPHANUMERIC:return o.getBitsLength(E);case n.KANJI:return r.getBitsLength(E);case n.BYTE:return t.getBitsLength(E)}}function C(E){return E.reduce(function(j,R){const N=j.length-1>=0?j[j.length-1]:null;return N&&N.mode===R.mode?(j[j.length-1].data+=R.data,j):(j.push(R),j)},[])}function T(E){const j=[];for(let R=0;R<E.length;R++){const N=E[R];switch(N.mode){case n.NUMERIC:j.push([N,{data:N.data,mode:n.ALPHANUMERIC,length:N.length},{data:N.data,mode:n.BYTE,length:N.length}]);break;case n.ALPHANUMERIC:j.push([N,{data:N.data,mode:n.BYTE,length:N.length}]);break;case n.KANJI:j.push([N,{data:N.data,mode:n.BYTE,length:p(N.data)}]);break;case n.BYTE:j.push([{data:N.data,mode:n.BYTE,length:p(N.data)}])}}return j}function O(E,j){const R={},N={start:{}};let D=["start"];for(let h=0;h<E.length;h++){const b=E[h],g=[];for(let y=0;y<b.length;y++){const I=b[y],w=""+h+y;g.push(w),R[w]={node:I,lastCount:0},N[w]={};for(let A=0;A<D.length;A++){const S=D[A];R[S]&&R[S].node.mode===I.mode?(N[S][w]=P(R[S].lastCount+I.length,I.mode)-P(R[S].lastCount,I.mode),R[S].lastCount+=I.length):(R[S]&&(R[S].lastCount=I.length),N[S][w]=P(I.length,I.mode)+4+n.getCharCountIndicator(I.mode,j))}}D=g}for(let h=0;h<D.length;h++)N[D[h]].end=0;return{map:N,table:R}}function L(E,j){let R;const N=n.getBestModeForData(E);if(R=n.from(j,N),R!==n.BYTE&&R.bit<N.bit)throw new Error('"'+E+'" cannot be encoded with mode '+n.toString(R)+`.
 Suggested mode is: `+n.toString(N));switch(R===n.KANJI&&!s.isKanjiModeEnabled()&&(R=n.BYTE),R){case n.NUMERIC:return new a(E);case n.ALPHANUMERIC:return new o(E);case n.KANJI:return new r(E);case n.BYTE:return new t(E)}}e.fromArray=function(j){return j.reduce(function(R,N){return typeof N=="string"?R.push(L(N,null)):N.data&&R.push(L(N.data,N.mode)),R},[])},e.fromString=function(j,R){const N=k(j,s.isKanjiModeEnabled()),D=T(N),h=O(D,R),b=f.find_path(h.map,"start","end"),g=[];for(let y=1;y<b.length-1;y++)g.push(h.table[b[y]].node);return e.fromArray(C(g))},e.rawSplit=function(j){return e.fromArray(k(j,s.isKanjiModeEnabled()))}})(mn)),mn}var br;function Yo(){if(br)return en;br=1;const e=Ve(),n=Mn(),a=Do(),o=Ao(),t=Bo(),r=Lo(),d=Fo(),s=Mr(),f=$o(),p=qo(),M=Wo(),k=Ge(),P=Ko();function C(h,b){const g=h.size,y=r.getPositions(b);for(let I=0;I<y.length;I++){const w=y[I][0],A=y[I][1];for(let S=-1;S<=7;S++)if(!(w+S<=-1||g<=w+S))for(let B=-1;B<=7;B++)A+B<=-1||g<=A+B||(S>=0&&S<=6&&(B===0||B===6)||B>=0&&B<=6&&(S===0||S===6)||S>=2&&S<=4&&B>=2&&B<=4?h.set(w+S,A+B,!0,!0):h.set(w+S,A+B,!1,!0))}}function T(h){const b=h.size;for(let g=8;g<b-8;g++){const y=g%2===0;h.set(g,6,y,!0),h.set(6,g,y,!0)}}function O(h,b){const g=t.getPositions(b);for(let y=0;y<g.length;y++){const I=g[y][0],w=g[y][1];for(let A=-2;A<=2;A++)for(let S=-2;S<=2;S++)A===-2||A===2||S===-2||S===2||A===0&&S===0?h.set(I+A,w+S,!0,!0):h.set(I+A,w+S,!1,!0)}}function L(h,b){const g=h.size,y=p.getEncodedBits(b);let I,w,A;for(let S=0;S<18;S++)I=Math.floor(S/3),w=S%3+g-8-3,A=(y>>S&1)===1,h.set(I,w,A,!0),h.set(w,I,A,!0)}function E(h,b,g){const y=h.size,I=M.getEncodedBits(b,g);let w,A;for(w=0;w<15;w++)A=(I>>w&1)===1,w<6?h.set(w,8,A,!0):w<8?h.set(w+1,8,A,!0):h.set(y-15+w,8,A,!0),w<8?h.set(8,y-w-1,A,!0):w<9?h.set(8,15-w-1+1,A,!0):h.set(8,15-w-1,A,!0);h.set(y-8,8,1,!0)}function j(h,b){const g=h.size;let y=-1,I=g-1,w=7,A=0;for(let S=g-1;S>0;S-=2)for(S===6&&S--;;){for(let B=0;B<2;B++)if(!h.isReserved(I,S-B)){let G=!1;A<b.length&&(G=(b[A]>>>w&1)===1),h.set(I,S-B,G),w--,w===-1&&(A++,w=7)}if(I+=y,I<0||g<=I){I-=y,y=-y;break}}}function R(h,b,g){const y=new a;g.forEach(function(B){y.put(B.mode.bit,4),y.put(B.getLength(),k.getCharCountIndicator(B.mode,h)),B.write(y)});const I=e.getSymbolTotalCodewords(h),w=s.getTotalCodewordsCount(h,b),A=(I-w)*8;for(y.getLengthInBits()+4<=A&&y.put(0,4);y.getLengthInBits()%8!==0;)y.putBit(0);const S=(A-y.getLengthInBits())/8;for(let B=0;B<S;B++)y.put(B%2?17:236,8);return N(y,h,b)}function N(h,b,g){const y=e.getSymbolTotalCodewords(b),I=s.getTotalCodewordsCount(b,g),w=y-I,A=s.getBlocksCount(b,g),S=y%A,B=A-S,G=Math.floor(y/A),ge=Math.floor(w/A),te=ge+1,xe=G-ge,Q=new f(xe);let Ce=0;const Me=new Array(A),F=new Array(A);let $=0;const J=new Uint8Array(h.buffer);for(let he=0;he<A;he++){const ie=he<B?ge:te;Me[he]=J.slice(Ce,Ce+ie),F[he]=Q.encode(Me[he]),Ce+=ie,$=Math.max($,ie)}const X=new Uint8Array(y);let Z=0,oe,U;for(oe=0;oe<$;oe++)for(U=0;U<A;U++)oe<Me[U].length&&(X[Z++]=Me[U][oe]);for(oe=0;oe<xe;oe++)for(U=0;U<A;U++)X[Z++]=F[U][oe];return X}function D(h,b,g,y){let I;if(Array.isArray(h))I=P.fromArray(h);else if(typeof h=="string"){let G=b;if(!G){const ge=P.rawSplit(h);G=p.getBestVersionForData(ge,g)}I=P.fromString(h,G||40)}else throw new Error("Invalid data");const w=p.getBestVersionForData(I,g);if(!w)throw new Error("The amount of data is too big to be stored in a QR Code");if(!b)b=w;else if(b<w)throw new Error(`
The chosen QR Code version cannot contain this amount of data.
Minimum version required to store current data is: `+w+`.
`);const A=R(b,g,I),S=e.getSymbolSize(b),B=new o(S);return C(B,b),T(B),O(B,b),E(B,g,0),b>=7&&L(B,b),j(B,A),isNaN(y)&&(y=d.getBestMask(B,E.bind(null,B,g))),d.applyMask(y,B),E(B,g,y),{modules:B,version:b,errorCorrectionLevel:g,maskPattern:y,segments:I}}return en.create=function(b,g){if(typeof b>"u"||b==="")throw new Error("No input text");let y=n.M,I,w;return typeof g<"u"&&(y=n.from(g.errorCorrectionLevel,n.M),I=p.from(g.version),w=d.from(g.maskPattern),g.toSJISFunc&&e.setToSJISFunction(g.toSJISFunc)),D(b,I,y,w)},en}var wn={},Cn={},yr;function Ir(){return yr||(yr=1,(function(e){function n(a){if(typeof a=="number"&&(a=a.toString()),typeof a!="string")throw new Error("Color should be defined as hex string");let o=a.slice().replace("#","").split("");if(o.length<3||o.length===5||o.length>8)throw new Error("Invalid hex color: "+a);(o.length===3||o.length===4)&&(o=Array.prototype.concat.apply([],o.map(function(r){return[r,r]}))),o.length===6&&o.push("F","F");const t=parseInt(o.join(""),16);return{r:t>>24&255,g:t>>16&255,b:t>>8&255,a:t&255,hex:"#"+o.slice(0,6).join("")}}e.getOptions=function(o){o||(o={}),o.color||(o.color={});const t=typeof o.margin>"u"||o.margin===null||o.margin<0?4:o.margin,r=o.width&&o.width>=21?o.width:void 0,d=o.scale||4;return{width:r,scale:r?4:d,margin:t,color:{dark:n(o.color.dark||"#000000ff"),light:n(o.color.light||"#ffffffff")},type:o.type,rendererOpts:o.rendererOpts||{}}},e.getScale=function(o,t){return t.width&&t.width>=o+t.margin*2?t.width/(o+t.margin*2):t.scale},e.getImageWidth=function(o,t){const r=e.getScale(o,t);return Math.floor((o+t.margin*2)*r)},e.qrToImageData=function(o,t,r){const d=t.modules.size,s=t.modules.data,f=e.getScale(d,r),p=Math.floor((d+r.margin*2)*f),M=r.margin*f,k=[r.color.light,r.color.dark];for(let P=0;P<p;P++)for(let C=0;C<p;C++){let T=(P*p+C)*4,O=r.color.light;if(P>=M&&C>=M&&P<p-M&&C<p-M){const L=Math.floor((P-M)/f),E=Math.floor((C-M)/f);O=k[s[L*d+E]?1:0]}o[T++]=O.r,o[T++]=O.g,o[T++]=O.b,o[T]=O.a}}})(Cn)),Cn}var xr;function Qo(){return xr||(xr=1,(function(e){const n=Ir();function a(t,r,d){t.clearRect(0,0,r.width,r.height),r.style||(r.style={}),r.height=d,r.width=d,r.style.height=d+"px",r.style.width=d+"px"}function o(){try{return document.createElement("canvas")}catch{throw new Error("You need to specify a canvas element")}}e.render=function(r,d,s){let f=s,p=d;typeof f>"u"&&(!d||!d.getContext)&&(f=d,d=void 0),d||(p=o()),f=n.getOptions(f);const M=n.getImageWidth(r.modules.size,f),k=p.getContext("2d"),P=k.createImageData(M,M);return n.qrToImageData(P.data,r,f),a(k,p,M),k.putImageData(P,0,0),p},e.renderToDataURL=function(r,d,s){let f=s;typeof f>"u"&&(!d||!d.getContext)&&(f=d,d=void 0),f||(f={});const p=e.render(r,d,f),M=f.type||"image/png",k=f.rendererOpts||{};return p.toDataURL(M,k.quality)}})(wn)),wn}var vn={},wr;function Xo(){if(wr)return vn;wr=1;const e=Ir();function n(t,r){const d=t.a/255,s=r+'="'+t.hex+'"';return d<1?s+" "+r+'-opacity="'+d.toFixed(2).slice(1)+'"':s}function a(t,r,d){let s=t+r;return typeof d<"u"&&(s+=" "+d),s}function o(t,r,d){let s="",f=0,p=!1,M=0;for(let k=0;k<t.length;k++){const P=Math.floor(k%r),C=Math.floor(k/r);!P&&!p&&(p=!0),t[k]?(M++,k>0&&P>0&&t[k-1]||(s+=p?a("M",P+d,.5+C+d):a("m",f,0),f=0,p=!1),P+1<r&&t[k+1]||(s+=a("h",M),M=0)):f++}return s}return vn.render=function(r,d,s){const f=e.getOptions(d),p=r.modules.size,M=r.modules.data,k=p+f.margin*2,P=f.color.light.a?"<path "+n(f.color.light,"fill")+' d="M0 0h'+k+"v"+k+'H0z"/>':"",C="<path "+n(f.color.dark,"stroke")+' d="'+o(M,p,f.margin)+'"/>',T='viewBox="0 0 '+k+" "+k+'"',L='<svg xmlns="http://www.w3.org/2000/svg" '+(f.width?'width="'+f.width+'" height="'+f.width+'" ':"")+T+' shape-rendering="crispEdges">'+P+C+`</svg>
`;return typeof s=="function"&&s(null,L),L},vn}var Cr;function Zo(){if(Cr)return Ze;Cr=1;const e=Oo(),n=Yo(),a=Qo(),o=Xo();function t(r,d,s,f,p){const M=[].slice.call(arguments,1),k=M.length,P=typeof M[k-1]=="function";if(!P&&!e())throw new Error("Callback required as last argument");if(P){if(k<2)throw new Error("Too few arguments provided");k===2?(p=s,s=d,d=f=void 0):k===3&&(d.getContext&&typeof p>"u"?(p=f,f=void 0):(p=f,f=s,s=d,d=void 0))}else{if(k<1)throw new Error("Too few arguments provided");return k===1?(s=d,d=f=void 0):k===2&&!d.getContext&&(f=s,s=d,d=void 0),new Promise(function(C,T){try{const O=n.create(s,f);C(r(O,d,f))}catch(O){T(O)}})}try{const C=n.create(s,f);p(null,r(C,d,f))}catch(C){p(C)}}return Ze.create=n.create,Ze.toCanvas=t.bind(null,a.render),Ze.toDataURL=t.bind(null,a.renderToDataURL),Ze.toString=t.bind(null,function(r,d,s){return o.render(r,s)}),Ze}var ea=Zo();const ta=xo(ea);async function vr(e){return new Promise((n,a)=>{const o=new Image;o.onload=()=>n(o),o.onerror=t=>a(t),o.src=e})}async function na(e,n){const[a,o]=await Promise.all([vr(e),vr(n.logoUrl)]),t=Math.max(160,a.width||160),r=Math.max(160,a.height||160),d=document.createElement("canvas");d.width=t,d.height=r;const s=d.getContext("2d");s.fillStyle="#ffffff",s.fillRect(0,0,t,r),s.imageSmoothingEnabled=!1,s.drawImage(a,0,0,t,r);const f=t/2,p=r/2,M=Math.max(.14,Math.min(.28,n.logoScale??.2)),k=Math.round(Math.min(t,r)*M),P=Math.round(f-k/2),C=Math.round(p-k/2);if(n.mask!==!1){const T=n.shape||"rounded-rect",O=Math.max(2,Math.round(k*.08)),L=P-O,E=C-O,j=k+O*2,R=k+O*2;if(s.beginPath(),T==="circle"){const N=Math.min(j,R)/2;s.arc(L+j/2,E+R/2,N,0,Math.PI*2)}else if(T==="rect")s.rect(L,E,j,R);else{const N=Math.max(4,n.radiusPx??Math.round(k*.12)),D=Math.min(N,j/2,R/2);s.moveTo(L+D,E),s.arcTo(L+j,E,L+j,E+R,D),s.arcTo(L+j,E+R,L,E+R,D),s.arcTo(L,E+R,L,E,D),s.arcTo(L,E,L+j,E,D),s.closePath()}s.fillStyle="#ffffff",s.fill(),s.lineWidth=1,s.strokeStyle=n.maskStroke||"rgba(0,0,0,0.12)",s.stroke()}if(s.save(),n.shape==="circle"){const T=k/2;s.beginPath(),s.arc(P+T,C+T,T,0,Math.PI*2),s.clip()}return s.imageSmoothingEnabled=!0,s.drawImage(o,P,C,k,k),s.restore(),d.toDataURL("image/png")}async function ra(e,n){const{width:a=256,margin:o=2,errorCorrectionLevel:t="H",color:r={dark:"#000000",light:"#ffffff"},logo:d}=n||{},s=await ta.toDataURL(e,{width:a,margin:o,errorCorrectionLevel:t,color:r});return d?na(s,d):s}const oa=({videoDevices:e,streaming:n,refreshVideoDevices:a,testCamera:o,onSelectPhoneCamera:t,lastDetectedLabel:r,autoCommitTestMode:d,doCommit:s,lastDetectedValue:f,cameraConnected:p})=>{const{preferredCameraId:M,preferredCameraLabel:k,setPreferredCamera:P,cameraEnabled:C,setCameraEnabled:T,preferredCameraLocked:O,setPreferredCameraLocked:L}=et(),[E,j]=v.useState(""),[R,N]=v.useState(!1),D=v.useRef(null),h=v.useCallback(async()=>{j("");try{await a()}catch(S){console.warn("[DevicePicker] refresh failed",S),j("Unable to list cameras. Grant camera permission in your browser.")}},[a]);v.useEffect(()=>{h()},[h]),v.useEffect(()=>{if(!R)return;function S(B){D.current&&!D.current.contains(B.target)&&(console.debug("[DevicePicker] document.mousedown -> closing dropdown (outside both main+portal)",Date.now()),N(!1))}return document.addEventListener("mousedown",S),()=>document.removeEventListener("mousedown",S)},[R]);const b=e.find(S=>S.deviceId===M),g=b?`${b.label||"Camera"}`:M?"Camera (unavailable)":"Auto (browser default)",y=!!(M&&!b),I=v.useCallback((S,B="")=>{try{P(S,B,!0)}catch(G){console.warn("[DevicePicker] setPreferredCamera failed",G)}N(!1)},[P]),w=v.useCallback(()=>{I(void 0,"Phone Camera"),t()},[I,t]),A=v.useCallback(()=>{L(!O)},[O,L]);return c.jsxs("div",{ref:D,className:"mt-3 rounded-lg border border-indigo-500/30 bg-indigo-500/5 p-3","data-testid":"device-picker-root",children:[c.jsx("div",{className:"mb-2 font-semibold",children:"Select camera device"}),E&&c.jsx("div",{className:"mb-2 text-sm text-rose-400",children:E}),e.length===0&&!E&&c.jsx("div",{className:"mb-2 text-xs text-slate-400",children:'Detecting devices... (click "Rescan" if this hangs)'}),y&&c.jsxs("div",{className:"mb-2 text-sm text-amber-400",children:["Selected camera is no longer available.",c.jsx("button",{className:"ml-1 underline",onClick:()=>I(void 0,""),disabled:n,children:"Use auto-selection"})]}),c.jsxs("div",{className:"mb-2 flex items-center gap-2",children:[O?c.jsx("div",{className:"text-xs text-emerald-400",children:"ðŸ”’ Camera selection locked"}):c.jsx("div",{className:"text-xs text-slate-400",children:"Camera selection unlocked"}),c.jsx("button",{"data-testid":"cam-lock-toggle",className:"btn btn--ghost ml-2 px-2 py-0.5 text-xs",onClick:A,children:O?"Unlock":"Lock"})]}),c.jsxs("div",{className:"mb-3 flex items-center gap-3",children:[c.jsx("input",{type:"checkbox",id:"cameraEnabled-calibrator",checked:C,onChange:S=>T(S.target.checked),className:"h-4 w-4",disabled:n}),c.jsx("label",{htmlFor:"cameraEnabled-calibrator",className:"text-sm",children:"Enable camera for scoring"})]}),c.jsxs("div",{className:"grid grid-cols-3 items-center gap-2 text-sm",children:[c.jsxs("div",{className:"relative col-span-2",children:[c.jsxs("button",{className:"input flex w-full items-center justify-between text-left","data-testid":"device-picker-toggle",onClick:()=>N(!0),onPointerDown:S=>S.stopPropagation(),onMouseDown:S=>S.stopPropagation(),children:[c.jsx("span",{children:g}),c.jsx("span",{className:`transition-transform ${R?"rotate-180":""}`,children:"â–¼"})]}),R&&c.jsx("div",{className:"absolute left-0 right-0 top-full z-50 mt-1 rounded border border-slate-600 bg-slate-800 shadow-lg",children:c.jsxs("div",{className:"max-h-48 overflow-y-auto",children:[c.jsx("button",{"data-testid":"device-option-auto",className:"w-full px-3 py-2 text-left text-sm hover:bg-slate-700",onClick:()=>I(void 0,""),onPointerDown:S=>S.stopPropagation(),onMouseDown:S=>S.stopPropagation(),children:"Auto (browser default)"}),e.map(S=>c.jsx("button",{className:"w-full px-3 py-2 text-left text-sm hover:bg-slate-700",onClick:()=>I(S.deviceId,S.label||""),onPointerDown:B=>B.stopPropagation(),onMouseDown:B=>B.stopPropagation(),children:S.label||"Camera"},S.deviceId)),c.jsx("button",{className:"w-full px-3 py-2 text-left text-sm hover:bg-slate-700",onClick:w,onPointerDown:S=>S.stopPropagation(),onMouseDown:S=>S.stopPropagation(),children:"ðŸ“± Remote Device / Pair"})]})})]}),e.length===0&&c.jsxs("div",{className:"col-span-1 flex items-center justify-end gap-2",children:[c.jsx("button",{className:"btn btn--ghost btn-sm",onClick:async()=>{try{await o(),await a()}catch(S){console.warn("[DevicePicker] request camera permission failed",S),j("Camera permission denied. Please allow access in your browser.")}},children:"Enable local camera"}),c.jsx("button",{className:"btn btn--ghost btn-sm",onClick:()=>void h(),children:"Rescan"})]}),c.jsxs("div",{className:"col-span-3 text-right",children:[c.jsx("button",{className:"btn px-2 py-1",onClick:()=>{o(M||void 0)},disabled:n,children:"Test"}),c.jsxs("div",{className:"mt-2 flex items-center justify-end gap-2 text-xs opacity-70",children:[c.jsx("span",{"data-testid":"device-picker-detected",children:r?`Detected: ${r}`:"No recent detection"}),(r!=null||d)&&c.jsx("button",{className:"btn btn--ghost btn-sm",onClick:()=>s(),onPointerDown:()=>s(),disabled:f==null,children:"Commit detected"}),c.jsx("span",{className:`inline-block h-2.5 w-2.5 rounded-full ${p?"bg-emerald-400":"bg-rose-500"}`}),c.jsx("span",{className:"text-xs",children:p?"Camera Connected":"Camera not connected"})]})]})]}),k&&c.jsxs("div",{className:"mt-1 text-xs opacity-70",children:["Selected: ",k]}),c.jsx("div",{className:"mt-1 text-xs opacity-70",children:"Tip: Select a camera here for manual scoring."})]})},Rt=["D20","D6","D3","D11","BULL"],Sr=Rt.length,aa=[{idx:0,label:"D20 (top double)",sector:20,ring:"DOUBLE",toleranceMm:4.5},{idx:1,label:"D6 (right double)",sector:6,ring:"DOUBLE",toleranceMm:4.5},{idx:2,label:"D3 (bottom double)",sector:3,ring:"DOUBLE",toleranceMm:4.5},{idx:3,label:"D11 (left double)",sector:11,ring:"DOUBLE",toleranceMm:4.5},{idx:4,label:"Bull center",sector:25,ring:"INNER_BULL",toleranceMm:3.5}];function Nr(e,n,a){return go(e,[1,0,n,0,1,a,0,0,1])}function sa(){const e=v.useRef(null),n=v.useRef(null),a=v.useRef(null);v.useRef(null);const[o,t]=v.useState("unknown"),[r,d]=v.useState([]),[s,f]=v.useState(null),[p,M]=v.useState(!1),[k,P]=v.useState(!1),[C,T]=v.useState(()=>localStorage.getItem("ndn:cal:mode")||"local"),[O,L]=v.useState([]),[E,j]=v.useState(!1),[R,N]=v.useState("idle"),D=v.useCallback(()=>{T("phone"),N("camera"),M(!1),j(!1);try{et.getState().setPreferredCamera(void 0,"Phone Camera",!0)}catch(i){console.warn("[Camera Connection] Failed to persist phone camera selection",i)}},[T,N,M,j]),[h,b]=v.useState(null),g=et(i=>i.cameraScale)||1,y=et(i=>i.setCameraScale),[I,w]=v.useState(()=>{if(typeof window>"u")return!1;try{return window.localStorage.getItem("ndn:cal:forceDesktop")==="1"}catch{return!1}}),[A,S]=v.useState(()=>typeof navigator>"u"?!1:/Android|iPhone|iPad|iPod|Mobi/i.test(navigator.userAgent)),{H:B,setCalibration:G,reset:ge,errorPx:te,locked:xe,overlaySize:Q,imageSize:Ce,anchors:Me,theta:F,sectorOffset:$}=Xt(),J=6,X=ho(),{calibrationGuide:Z,setCalibrationGuide:oe,preferredCameraId:U,cameraEnabled:he,setCameraEnabled:ie,preferredCameraLocked:ce,setPreferredCameraLocked:je,setPreferredCamera:Te,preserveCalibrationOverlay:Fe,allowAutocommitInOnline:qe,setAllowAutocommitInOnline:ht}=et(),mt=!0,[q,tt]=v.useState(null),[Oe,gt]=v.useState(!1),[pt,Je]=v.useState(0),[bt,Ke]=v.useState(!1),[ia,nt]=v.useState(null),[Rr,ca]=v.useState(!0),[la,Tt]=v.useState(null),[Pn,Tr]=v.useState(!1),[jt,jr]=v.useState(!1),[Or,Dr]=v.useState(!1),[En,da]=v.useState(null),[In,ua]=v.useState(null),[rt,fa]=v.useState(null),[Rn,Ar]=v.useState(!1),Br=v.useRef(null);v.useCallback(i=>{const u=($??0)+i;G({sectorOffset:u})},[$,G]);const Ot=v.useRef(!1),Tn=v.useRef(null),jn=v.useRef(0),On=300,[yt,Lr]=v.useState([]),[Dt,ha]=v.useState({type:null,until:0}),[De,Dn]=v.useState(1),[Ye,Fr]=v.useState(0),[Qe,Ur]=v.useState(0),[An,_r]=v.useState(!1),[At,ot]=v.useState(!1),[Bt,Lt]=v.useState(1),[Ft,Ut]=v.useState(1),[We,_t]=v.useState(null);function $r(){Lt(1.02),Ut(1),Dn(1),Fr(0),Ur(0),ot(!1),_t(null)}v.useCallback((i,u=480)=>{if(typeof document>"u")throw new Error("Marker rendering only available in browser context");const x=wo(i),m=document.createElement("canvas");m.width=u,m.height=u;const l=m.getContext("2d");if(!l)return"";l.fillStyle="#ffffff",l.fillRect(0,0,u,u);const z=x.length,K=x[0]?.length||z,re=u/K,me=u/z;for(let ae=0;ae<z;ae++)for(let Y=0;Y<K;Y++)x[ae][Y]&&(l.fillStyle="#000000",l.fillRect(Math.round(Y*re),Math.round(ae*me),Math.ceil(re),Math.ceil(me)));return m.toDataURL("image/png")},[]);const[Bn,$t]=v.useState(null),[Pe,qr]=v.useState(null),xt=v.useRef(null),[Ee,Wr]=v.useState(null),Ue=v.useRef(null),wt=v.useRef([]),[at,qt]=v.useState(null),[Ln,Hr]=v.useState(Date.now()),[Fn,Wt]=v.useState(!1);function Ct(i){try{qr(i),xt.current=i}catch{}}const[Un,zr]=v.useState(null),[Xe,Vr]=v.useState(null),[Gr,Jr]=v.useState(!0),[_n,vt]=v.useState([]),[Kr,$n]=v.useState(!1),[Ht,zt]=v.useState(null),st=v.useRef(null);v.useEffect(()=>()=>{Br.current=null},[mt,Pn,p,q]),v.useEffect(()=>{const i=window.location.hostname;(i==="localhost"||i==="127.0.0.1")&&kt("/api/hosts").then(u=>u.json()).then(u=>{const x=Array.isArray(u?.hosts)&&u.hosts.find(m=>m);x&&zr(x)}).catch(()=>{}),kt("/api/https-info").then(u=>u.json()).then(u=>{u&&typeof u.https=="boolean"&&Vr({https:!!u.https,port:Number(u.port)||8788})}).catch(()=>{})},[]);const _e=v.useMemo(()=>{const i=Pe||"____",u="ws://localhost:8787";if(u.length>0)try{const K=new URL(u);return`${`${K.protocol==="wss:"?"https":"http"}://${K.host}${K.pathname.endsWith("/ws")?"":K.pathname}`.replace(/\/?ws$/i,"")}/mobile-cam.html?code=${i}`}catch{}const x=Un||window.location.hostname,m=!!Xe?.https,l=m?Xe?.port||8788:8787;return`${m?"https":"http"}://${x}:${l}/mobile-cam.html?code=${i}`},[Pe,Un,Xe]),Yr=v.useMemo(()=>{if(!_e)return null;try{const i=new URL(_e);return i.searchParams.delete("code"),i.toString().replace(/\?$/,"")}catch{return typeof window<"u"?`${window.location.origin.replace(/\/$/,"")}/mobile-cam.html`:"/mobile-cam.html"}},[_e]);v.useEffect(()=>{if(!_e||!Pe){$t(null);return}let i=!1;return ra(_e,{width:256,margin:2,errorCorrectionLevel:"H",color:{dark:"#000000",light:"#ffffff"},logo:!1}).then(u=>{i||$t(u)}).catch(()=>{i||$t(null)}),()=>{i=!0}},[_e,Pe]),v.useEffect(()=>{localStorage.setItem("ndn:cal:mode",C)},[C]),v.useEffect(()=>{if(!(typeof window>"u"))try{I?window.localStorage.setItem("ndn:cal:forceDesktop","1"):window.localStorage.removeItem("ndn:cal:forceDesktop")}catch{}},[I]),v.useEffect(()=>{if(typeof window>"u")return;const i=window.matchMedia("(pointer: coarse)"),u=()=>{const x=typeof navigator<"u"&&/Android|iPhone|iPad|iPod|Mobi/i.test(navigator.userAgent),m=typeof i.matches=="boolean"?i.matches:!1,l=window.innerWidth<=820;S(x||m||l)};u();try{typeof i.addEventListener=="function"?i.addEventListener("change",u):typeof i.addListener=="function"&&i.addListener(u)}catch{}return window.addEventListener("resize",u),()=>{try{typeof i.removeEventListener=="function"?i.removeEventListener("change",u):typeof i.removeListener=="function"&&i.removeListener(u)}catch{}window.removeEventListener("resize",u)}},[]),v.useEffect(()=>{if(typeof navigator>"u"||!navigator.permissions){t("unsupported");return}let i=!0;return(async()=>{try{const u=await navigator.permissions.query({name:"camera"});if(!i)return;t(u.state||"unknown"),u.onchange=()=>{i&&t(u.state)}}catch{i&&t("unknown")}})(),()=>{i=!1}},[]);async function it(){if(!(typeof navigator>"u"||!navigator.mediaDevices||!navigator.mediaDevices.enumerateDevices))try{const u=(await navigator.mediaDevices.enumerateDevices()).filter(x=>x.kind==="videoinput").map(x=>({deviceId:x.deviceId,label:x.label||"Camera"}));d(u),u.length&&!s&&f(u[0].deviceId)}catch{}}v.useEffect(()=>((async()=>{try{await it()}catch{}try{navigator?.mediaDevices?.addEventListener?navigator.mediaDevices.addEventListener("devicechange",it):navigator.mediaDevices.ondevicechange=it}catch{}})(),()=>{try{navigator?.mediaDevices?.removeEventListener&&navigator.mediaDevices.removeEventListener("devicechange",it)}catch{}}),[]);async function Qr(i){if(typeof navigator>"u"||!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia){alert("getUserMedia is not available in this browser");return}const u={video:i?{deviceId:{exact:i}}:{facingMode:"environment"}};let x=null;try{x=await navigator.mediaDevices.getUserMedia(u),x.getTracks().forEach(m=>m.stop()),t("granted");try{i&&typeof Te=="function"&&Te(i)}catch{}alert("Camera access granted â€” your webcam is available and set as preferred.")}catch(m){console.error("[Camera Connection] testCamera failed",m),m&&(m.name==="NotAllowedError"||m.name==="PermissionDeniedError")?(t("denied"),alert("Camera permission denied. Please allow camera access in your browser settings and try again.")):m&&(m.name==="NotFoundError"||m.name==="DevicesNotFoundError")?alert("No camera devices found. Ensure your USB webcam is connected and not in use by another app."):alert("Unable to access the camera: "+(m?.message||m))}finally{x&&x.getTracks().forEach(m=>m.stop())}}v.useEffect(()=>{if(!at)return;const i=setInterval(()=>Hr(Date.now()),1e3);return()=>clearInterval(i)},[at]);const qn=v.useMemo(()=>at?Math.max(0,Math.ceil((at-Ln)/1e3)):null,[at,Ln]);v.useEffect(()=>()=>{st.current&&window.clearTimeout(st.current)},[]);const Vt=v.useCallback(async(i,u)=>{if(i)try{if(navigator.clipboard&&navigator.clipboard.writeText)await navigator.clipboard.writeText(i);else{const x=document.createElement("textarea");x.value=i,x.style.position="fixed",x.style.opacity="0",document.body.appendChild(x),x.focus(),x.select(),document.execCommand("copy");try{document.body.removeChild(x)}catch{}}zt(u),st.current&&window.clearTimeout(st.current),st.current=window.setTimeout(()=>zt(null),1500)}catch(x){console.warn("[Camera Connection] Copy failed:",x),zt(null)}},[]);v.useEffect(()=>()=>{},[]),v.useEffect(()=>{const i=u=>{console.log("[Camera Connection] Received reconnect request from PhoneCameraOverlay"),C==="phone"&&Fn&&(Ae(!1),setTimeout(()=>{Gt()},500))};return window.addEventListener("ndn:phone-camera-reconnect",i),()=>{window.removeEventListener("ndn:phone-camera-reconnect",i)}},[C,Fn]),v.useEffect(()=>{console.log("[Camera Connection] ðŸ”„ STREAMING CHANGED:",{streaming:p,videoRefAvailable:!!e.current}),e.current?(console.log("[Camera Connection] âœ… Syncing videoElementRef on streaming change"),X.setVideoElementRef(e.current),e.current.srcObject instanceof MediaStream&&(console.log("[Camera Connection] âœ… Setting mediaStream from video element"),X.setMediaStream(e.current.srcObject))):console.warn("[Camera Connection] âš ï¸ videoRef.current is null on streaming change!")},[p]),v.useEffect(()=>(console.log("[Camera Connection] ðŸš€ MOUNT: Initial mount - syncing videoRef"),console.log("[Camera Connection] videoRef.current available:",!!e.current),console.log("[Camera Connection] videoRef.current type:",e.current?.constructor?.name),e.current?(console.log("[Camera Connection] âœ… Setting videoElementRef on mount"),console.log("[Camera Connection] Video element:",{tagName:e.current.tagName,srcObject:!!e.current.srcObject,videoWidth:e.current.videoWidth,videoHeight:e.current.videoHeight}),X.setVideoElementRef(e.current),console.log("[Camera Connection] âœ… videoElementRef set successfully")):console.error("[Camera Connection] âŒ CRITICAL: videoRef.current is NULL at mount!"),()=>{}),[]);function Xr(){if(Ee&&(Ee.readyState===WebSocket.OPEN||Ee.readyState===WebSocket.CONNECTING))return console.log("[Camera Connection] ensureWS: Reusing existing WebSocket (state:",Ee.readyState,")"),Ee;const i="ws://localhost:8787",u=i.length>0?i.endsWith("/ws")?i:i.replace(/\/$/,"")+"/ws":void 0,m=`${window.location.protocol==="https:"?"wss":"ws"}://${window.location.host}/ws`,l=window.location.hostname,K=u||(l.endsWith("onrender.com")?m:"wss://ninedartnation.onrender.com/ws");console.log("[Camera Connection] ensureWS: Creating new WebSocket to:",K);const re=new WebSocket(K);return re.onerror=me=>{console.error("[Camera Connection] WebSocket connection error:",me),alert("Failed to connect to camera pairing service. Please check your internet connection and try again.")},re.onclose=me=>{if(console.log("[Camera Connection] WebSocket closed:",me.code,me.reason),Ue.current){try{Ue.current.close()}catch{}Ue.current=null}Ct(null),qt(null),Wt(!1),me.code!==1e3&&(alert("Camera pairing connection lost. Please try pairing again."),C==="phone"&&T("local"))},Wr(re),re}async function Gt(){T("phone"),Ae(!1),Wn();try{ie(!0)}catch{}const i=Xr();i.readyState===WebSocket.OPEN?(console.log("[Camera Connection] WebSocket open, sending cam-create"),i.send(JSON.stringify({type:"cam-create"}))):(console.log("[Camera Connection] WebSocket connecting, will send cam-create on open"),i.addEventListener("open",()=>{console.log("[Camera Connection] WebSocket now open, sending cam-create"),i.send(JSON.stringify({type:"cam-create"}))},{once:!0})),i.onmessage=async u=>{const x=JSON.parse(u.data);if(x.type==="cam-code")Ct(x.code),x.expiresAt&&qt(x.expiresAt);else if(x.type==="cam-peer-joined"){!xt.current&&x.code&&Ct(x.code),Wt(!0);const m=xt.current||x.code||null;m&&(xt.current=m);try{if(xe&&m){const z=n.current?{w:n.current.width,h:n.current.height}:null,K={H:B,imageSize:z,errorPx:te??null,createdAt:Date.now()};i.send(JSON.stringify({type:"cam-calibration",code:m,payload:K})),console.log("[Camera Connection] Sent calibration to joined phone for code",m)}}catch(z){console.warn("[Camera Connection] Failed to send calibration on peer join",z)}const l=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}],iceCandidatePoolSize:10});Ue.current=l,l.onconnectionstatechange=()=>{console.log("WebRTC connection state:",l.connectionState),l.connectionState==="failed"||l.connectionState==="disconnected"?(console.error("WebRTC connection failed"),alert("Camera connection lost. Please try pairing again."),Ae(!1)):l.connectionState==="connected"&&console.log("WebRTC connection established")},l.onicecandidate=z=>{z.candidate&&m&&i.send(JSON.stringify({type:"cam-ice",code:m,payload:z.candidate}))},l.ontrack=z=>{if(console.log("[Camera Connection] WebRTC ontrack received:",z.streams?.length,"streams, track kind:",z.track?.kind),e.current){const K=z.streams?.[0];K?(console.log("[Camera Connection] Assigning video stream (tracks:",K.getTracks().length,") to video element"),j(!1),setTimeout(()=>{e.current&&(console.log("[Camera Connection] Setting srcObject and attempting play"),e.current.srcObject&&e.current.srcObject.getTracks().forEach(me=>me.stop()),e.current.srcObject=K,e.current.muted=!0,e.current.playsInline=!0,e.current.play().then(()=>{console.log("[Camera Connection] Video playback started successfully"),M(!0),N("capture"),X.setStreaming(!0),X.setMode("phone"),X.setMediaStream(K);try{Te(void 0,"Phone Camera",!0)}catch{}if(!ce)try{je(!0)}catch{}try{ie(!0)}catch{}P(!1)}).catch(re=>{console.error("[Camera Connection] Video play failed:",re),P(!0),console.warn("[Camera Connection] video play blocked â€” prompting user interaction")}))},100)):console.error("[Camera Connection] No inbound stream received in ontrack")}else console.error("[Camera Connection] Video element not available")};try{l.addTransceiver("video",{direction:"recvonly"});const z=await l.createOffer({offerToReceiveAudio:!1,offerToReceiveVideo:!0});await l.setLocalDescription(z),console.log("[Camera Connection] Sending cam-offer for code:",m),m?i.send(JSON.stringify({type:"cam-offer",code:m,payload:z})):console.warn("[Camera Connection] Missing pairing code when sending offer")}catch(z){console.error("Failed to create WebRTC offer:",z),alert("Failed to establish camera connection. Please try again."),Ae(!1)}}else if(x.type==="cam-answer"){console.log("[Camera Connection] Received cam-answer");const m=Ue.current;if(m)try{await m.setRemoteDescription(new RTCSessionDescription(x.payload)),console.log("[Camera Connection] Remote description set (answer)");const l=wt.current;console.log(`[Camera Connection] Processing ${l.length} pending ICE candidates`);for(const z of l)try{await m.addIceCandidate(z),console.log("[Camera Connection] Queued ICE candidate added")}catch(K){console.error("Failed to add queued ICE candidate:",K)}wt.current=[]}catch(l){console.error("Failed to set remote description:",l),alert("Camera pairing failed. Please try again."),Ae(!1)}else console.warn("[Camera Connection] Received cam-answer but no peer connection exists")}else if(x.type==="cam-ice"){console.log("[Camera Connection] Received cam-ice");const m=Ue.current;if(m)if(m.remoteDescription)try{await m.addIceCandidate(x.payload),console.log("[Camera Connection] ICE candidate added")}catch(l){console.error("Failed to add ICE candidate:",l)}else console.log("[Camera Connection] Remote description not set yet, queuing ICE candidate"),wt.current.push(x.payload);else console.warn("[Camera Connection] Received ICE candidate but no peer connection exists")}else if(x.type==="cam-error")console.error("Camera pairing error:",x.code),alert(x.code==="EXPIRED"?"Code expired. Generate a new code.":`Camera error: ${x.code||"Unknown error"}`),Ae(!1);else if(x.type==="cam-calibration"){console.log("[Camera Connection] Received calibration from peer:",x.payload);try{if(x.payload){let m=Array.isArray(x.payload.H)?x.payload.H:null;if(!m&&Array.isArray(x.payload.calibrationPoints)&&x.payload.calibrationPoints.length>=4)try{const l=[{x:0,y:-_.doubleOuter},{x:_.doubleOuter,y:0},{x:0,y:_.doubleOuter},{x:-_.doubleOuter,y:0}];m=Nn(l,x.payload.calibrationPoints.slice(0,4))}catch(l){console.warn("[Camera Connection] Failed to compute homography from received connection points",l)}if(m){const l=a?.current?{w:a.current.width,h:a.current.height}:e?.current?{w:e.current.clientWidth,h:e.current.clientHeight}:x.payload.imageSize??null;G({H:m,createdAt:x.payload.createdAt||Date.now(),errorPx:x.payload.errorPx,imageSize:x.payload.imageSize,overlaySize:l,locked:!0}),console.log("[Camera Connection] Applied received calibration")}}}catch(m){console.error("[Camera Connection] Failed to apply received calibration",m)}}}}async function St(){$n(!0);try{const i=await Mo();vt(i),i.length===0&&alert("No wifi scoring devices found on your network. Make sure devices are powered on and connected to the same network.")}catch(i){console.error("Wifi device discovery failed:",i),alert("Failed to discover wifi devices. Please check your network connection.")}finally{$n(!1)}N("camera")}async function Zr(i){try{vt(x=>x.map(m=>m.id===i.id?{...m,status:"connecting"}:m));const u=await jo(i);if(u&&e.current)e.current.srcObject&&e.current.srcObject.getTracks().forEach(m=>m.stop()),e.current.srcObject=u,await e.current.play(),M(!0),N("capture"),vt(x=>x.map(m=>m.id===i.id?{...m,status:"online"}:m));else throw new Error("Failed to get video stream")}catch(u){console.error("Failed to connect to wifi device:",u),alert(`Failed to connect to ${i.name}. Please check the device and try again.`),vt(x=>x.map(m=>m.id===i.id?{...m,status:"offline"}:m))}}async function eo(){if(C==="phone")return Gt();if(C==="wifi")return St();console.log("[Camera Connection] ðŸŽ¬ START_CAMERA: mode=",C,"preferredCameraId=",U);try{let i=null;if(U)try{console.log("[Camera Connection] ðŸ“¹ Attempt 1: Using preferred camera ID:",U),i=await navigator.mediaDevices.getUserMedia({video:{deviceId:{exact:U}},audio:!1}),console.log("[Camera Connection] âœ… SUCCESS with preferred camera:",i.getTracks().length,"tracks")}catch(u){console.warn("[Camera Connection] âš ï¸ Preferred camera failed:",u?.name,u?.message)}if(!i)try{console.log("[Camera Connection] ðŸ“¹ Attempt 2: Using ANY available camera"),i=await navigator.mediaDevices.getUserMedia({video:!0,audio:!1}),console.log("[Camera Connection] âœ… SUCCESS with fallback camera:",i.getTracks().length,"tracks")}catch(u){throw console.error("[Camera Connection] âŒ BOTH attempts failed:",u?.name,u?.message),u}if(!i)throw new Error("No stream obtained");if(!e.current)throw new Error("Video element ref is null");console.log("[Camera Connection] ðŸ“º Assigning stream to video element"),e.current.srcObject=i,console.log("[Camera Connection] â–¶ï¸ Calling play()");try{await e.current.play(),console.log("[Camera Connection] âœ… Play succeeded")}catch(u){console.warn("[Camera Connection] âš ï¸ Play failed, retrying in 100ms:",u?.message),await new Promise(x=>setTimeout(x,100)),await e.current.play(),console.log("[Camera Connection] âœ… Play succeeded on retry")}console.log("[Camera Connection] ðŸŸ¢ Setting streaming = true"),M(!0),N("capture"),console.log("[Camera Connection] ðŸŸ¢ State updated")}catch(i){console.error("[Camera Connection] ðŸ”´ FATAL:",i?.message||i),alert(`Camera failed: ${i?.message||"Unknown error"}`),e.current?.srcObject&&(e.current.srcObject.getTracks().forEach(u=>u.stop()),e.current.srcObject=null)}}function Ae(i=!1){if(e.current&&e.current.srcObject&&(e.current.srcObject.getTracks().forEach(x=>x.stop()),e.current.srcObject=null,M(!1)),Ue.current){try{Ue.current.close()}catch{}Ue.current=null}wt.current=[],Ct(null),qt(null),Wt(!1),Tt(null),X.setStreaming(!1),X.setMediaStream(null),i&&(C==="phone"||C==="wifi")&&T("local")}function to(){Ee&&Ee.readyState===WebSocket.OPEN?Ee.send(JSON.stringify({type:"cam-create"})):Gt(),Wn()}function Wn(){try{ce||je(!0)}catch{}}function no(){if(!e.current||!n.current)return;const i=e.current,u=n.current;if(u.width=i.videoWidth,u.height=i.videoHeight,u.getContext("2d").drawImage(i,0,0,u.width,u.height),j(!0),b({w:u.width,h:u.height}),N("select"),console.log("[Camera Connection] captureFrame: resetting dstPoints to []"),L([]),tt(null),ot(!1),Tt(null),a.current){const m=a.current;m.width=u.width,m.height=u.height;const l=m.getContext("2d");l&&l.clearRect(0,0,m.width,m.height)}Oe&&setTimeout(()=>{oo()},0)}function Jt(i=O,u=null){if(!n.current||!a.current)return;const x=n.current,m=a.current;m.width=x.width,m.height=x.height;const l=m.getContext("2d");l.clearRect(0,0,m.width,m.height),a.current&&(a.current.onclick=W=>co(W));const z=u||(i.length>=Sr?B:null),K=De,re=Ye,me=Qe;let ae=z;ae&&K!==1&&(ae=kn(ae,K,1)),ae&&(re!==0||me!==0)&&(ae=Nr(ae,re,me));const Y=q?q.cx+Ye:0,pe=q?q.cy+Qe:0,He=1,we={};q&&(we[_.bullInner]=q.bullInner*He,we[_.bullOuter]=q.bullOuter*He,we[_.trebleInner]=q.trebleInner*He,we[_.trebleOuter]=q.trebleOuter*He,we[_.doubleInner]=q.doubleInner*He,we[_.doubleOuter]=q.doubleOuter*He);const ct={};ct[_.doubleOuter]=Bt,ct[_.trebleOuter]=Ft;function io(){if(!q)return 0;let W=0;try{const H="rgba(52,211,153,0.08)",Ie="rgba(253,224,71,0.06)",ue="rgba(34,211,238,0.06)",ee=(be,V,se,fe)=>{const de=we[be],ne=we[V];if(!de||!ne)return!1;l.save(),l.shadowColor="rgba(0,0,0,0.45)",l.shadowBlur=6,l.beginPath();const ve=ne*(ct[V]||1),Se=de*(ct[be]||1);return l.arc(Y,pe,ve,0,Math.PI*2),l.arc(Y,pe,Se,0,Math.PI*2,!0),l.closePath(),l.fillStyle=se,l.fill(),l.restore(),!0};ee(_.bullInner,_.bullOuter,H),W++,ee(_.trebleInner,_.trebleOuter,Ie),W++,ee(_.doubleInner,_.doubleOuter,ue),W++;const le=360,Ne=[{r:_.bullInner,color:"#00ff66"},{r:_.bullOuter,color:"#ffffff"},{r:_.trebleInner,color:"#fde047"},{r:_.trebleOuter,color:"#fde047"},{r:_.doubleInner,color:"#22d3ee"},{r:_.doubleOuter,color:"#22d3ee"}];for(const be of Ne){const V=we[be.r];if(!V)continue;const se=[];for(let fe=0;fe<le;fe++){const de=fe/le*Math.PI*2,ne=V*De*(ct[be.r]||1);se.push({x:Y+ne*Math.cos(de),y:pe+ne*Math.sin(de)})}Pt(l,se,"rgba(0,0,0,0.45)",3),Pt(l,se,be.color,1.5)}}catch{return 0}return 3}function co(W){if(!We||!a.current||!q)return;const H=a.current.getBoundingClientRect(),Ie=(W.clientX-H.left)*(a.current.width/H.width),ue=(W.clientY-H.top)*(a.current.height/H.height),ee=Ie-Y,le=ue-pe,Ne=Math.hypot(ee,le);let be;We==="double"?be=_.doubleOuter:We==="treble"?be=_.trebleOuter:be=_.bullOuter;const V=we[be];if(!V||V<=0)return;const se=Ne/(V*De);We==="double"&&Lt(se),We==="treble"&&Ut(se),We==="bull"&&Dn(fe=>fe*(se/fe)),_t(null),console.log("[Camera Connection] Aligned ",We," adjust=",se.toFixed(4))}const Be=ae;if(u&&console.log("[drawOverlay] Using passed homography:",{HH:u.slice(0,6),currentPointsCount:i.length,canvasSize:{w:m.width,h:m.height}}),At&&q){const W=io();console.log("[drawOverlay] Forced detected-only drawing, rings drawn:",W);try{const H=a.current?.getContext("2d");if(!!H&&a.current&&q){H.save(),H.font="12px Sans-Serif",H.fillStyle="#ffffff",H.strokeStyle="#000000",H.lineWidth=3;const ue=Vn,ee=Y,le=pe,Ne=(q.doubleInner+q.doubleOuter)/2+14,be=typeof F=="number"?F:0;for(let V=0;V<ue.length;V++){const se=V/ue.length*Math.PI*2-Math.PI/2-be,fe=ee+Ne*Math.cos(se),de=le+Ne*Math.sin(se),ne=String(ue[V]),ve=H.measureText(ne).width;H.strokeText(ne,fe-ve/2,de+4),H.fillText(ne,fe-ve/2,de+4)}H.restore()}}catch{}return}if(z){const W=typeof te=="number"?te:null,H=yt&&yt.length>0,Ie=H?yt.every(V=>V.match):null,ue=typeof W=="number"?W<=1.5:null,ee=Ie===!0||ue===!0,le=H?yt.some(V=>!V.match):ue===!1;console.log("[drawOverlay] Drawing via homography transform");let Ne=0;const be=(V,se,fe,de,ne)=>{try{const Se=we[se],$e=we[fe];if(q&&Se&&$e)return l.save(),l.shadowColor="rgba(0,0,0,0.45)",l.shadowBlur=6,l.beginPath(),l.ellipse?(l.ellipse(Y,pe,$e*De,$e,0,0,Math.PI*2),l.ellipse(Y,pe,Se*De,Se,0,0,Math.PI*2,!0)):(l.arc(Y,pe,$e,0,Math.PI*2),l.arc(Y,pe,Se,0,Math.PI*2,!0)),l.closePath(),l.fillStyle=de,l.fill(),ne&&(l.strokeStyle=ne,l.lineWidth=2,l.stroke()),l.restore(),!0;const ke=ut(V,fe,720),Re=ut(V,se,720).reverse();if(!ke.length||!Re.length)return!1;l.save(),l.shadowColor="rgba(0,0,0,0.45)",l.shadowBlur=6,l.beginPath(),l.moveTo(ke[0].x,ke[0].y);for(let ye=1;ye<ke.length;ye++)l.lineTo(ke[ye].x,ke[ye].y);for(let ye=0;ye<Re.length;ye++)l.lineTo(Re[ye].x,Re[ye].y);return l.closePath(),l.fillStyle=de,l.fill(),ne&&(l.strokeStyle=ne,l.lineWidth=2,l.stroke()),l.restore(),!0}catch{return!1}};if(Be){const V=ee?"rgba(0,255,102,0.12)":le?"rgba(255,45,45,0.12)":"rgba(52,211,153,0.08)",se=ee?"rgba(0,255,102,0.08)":le?"rgba(255,45,45,0.08)":"rgba(253,224,71,0.06)",fe=ee?"rgba(0,255,102,0.06)":le?"rgba(255,45,45,0.06)":"rgba(34,211,238,0.06)";be(Be,_.bullInner,_.bullOuter,V,"rgba(255,255,255,0.06)"),Ne++;const de=q?.trebleInner||Mt.trebleInner,ne=q?.trebleOuter||Mt.trebleOuter;be(Be,de,ne,se,"rgba(255,255,255,0.06)"),Ne++;const ve=q?.doubleInner||Mt.doubleInner,Se=q?.doubleOuter||Mt.doubleOuter;be(Be,ve,Se,fe,"rgba(255,255,255,0.06)"),Ne++;try{const ke=[{r:_.bullInner,color:ee?"#00ff66":le?"#ff2d2d":"#ffffff",key:"bullInner"},{r:_.bullOuter,color:"#ffffff",key:"bullOuter"},{r:de,color:ee?"#00ff66":le?"#ff2d2d":"#fde047",key:"trebleInner"},{r:ne,color:"#fde047",key:"trebleOuter"},{r:ve,color:ee?"#00ff66":le?"#ff2d2d":"#22d3ee",key:"doubleInner"},{r:Se,color:"#22d3ee",key:"doubleOuter"}];for(const Re of ke){const ye=we[Re.r];let lt;if(q&&ye){lt=[];for(let Qt=0;Qt<720;Qt++){const zn=Qt/720*Math.PI*2;lt.push({x:Y+ye*Math.cos(zn),y:pe+ye*Math.sin(zn)})}}else lt=ut(Be,Re.r,720);Pt(l,lt,"rgba(0,0,0,0.45)",3),Pt(l,lt,Re.color,1.5)}}catch{}}console.log("[drawOverlay] Drew",Ne,"rings via homography");try{const V=a.current?.getContext("2d");if(!!V&&a.current){const fe=ft(Be||u,{x:0,y:0}),de=(_.doubleInner+_.doubleOuter)/2+14,ne=Vn;V.save(),V.font="12px Sans-Serif",V.fillStyle="#ffffff",V.strokeStyle="#000000",V.lineWidth=3;const ve=typeof F=="number"?F:0;for(let Se=0;Se<ne.length;Se++){const $e=Se/ne.length*Math.PI*2-Math.PI/2-ve,ke=ft(Be||u,{x:(de-14)*Math.cos($e),y:(de-14)*Math.sin($e)}),Re=String(ne[Se]),ye=V.measureText(Re).width;V.strokeText(Re,ke.x-ye/2,ke.y+4),V.fillText(Re,ke.x-ye/2,ke.y+4)}V.restore()}}catch{}if(Dt.type&&Date.now()<Dt.until){const V=Dt.type==="pass",se=V?"rgba(0,255,102,0.9)":"rgba(255,45,45,0.9)",fe=V?"CALIBRATION PASS":"CALIBRATION FAIL";l.save();const de=12,ne=m.width-240-de,ve=de;l.fillStyle=se,l.strokeStyle="rgba(0,0,0,0.25)",l.lineWidth=2,l.beginPath(),l.roundRect(ne,ve,240,34,8),l.fill(),l.stroke(),l.fillStyle="#00110a",l.font="bold 14px system-ui, sans-serif",l.textBaseline="middle",l.fillText(fe,ne+12,ve+17),l.restore()}}if(q&&An){console.log("[drawOverlay] Drawing detected circles overlay:",{adjustedCx:Math.round(Y),adjustedCy:Math.round(pe),doubleOuter:Math.round(q.doubleOuter),trebleOuter:Math.round(q.trebleOuter),bullOuter:Math.round(q.bullOuter)});const W=(H,Ie,ue=2)=>{if(!Number.isFinite(H)||H<=0)return;l.save(),l.strokeStyle=Ie,l.lineWidth=ue,l.setLineDash([5,5]),l.beginPath();const ee=De,le=H*ee,Ne=H*ee;l.ellipse?l.ellipse(Y,pe,le,Ne,0,0,Math.PI*2):l.arc(Y,pe,H,0,Math.PI*2),l.stroke(),l.restore()};if(W(q.doubleOuter,"#ff6b6b",3),W(q.doubleInner,"#ff6b6b",2),W(q.trebleOuter,"#ffd93d",2),W(q.trebleInner,"#ffd93d",2),W(q.bullOuter,"#6bcf7f",2),W(q.bullInner,"#6bcf7f",3),Be&&!At){const H=(Ie,ue)=>{const ee=ut(Be,Ie,180);if(ee.length){l.save(),l.setLineDash([6,4]),l.strokeStyle=ue,l.lineWidth=2,l.beginPath(),l.moveTo(ee[0].x,ee[0].y);for(let le=1;le<ee.length;le++)l.lineTo(ee[le].x,ee[le].y);l.closePath(),l.stroke(),l.restore()}};H(_.doubleOuter,"#00ffff"),H(_.trebleOuter,"#ffff00")}}q&&(l.save(),l.fillStyle="rgba(0,0,0,0.65)",l.fillRect(8,8,260,72),l.fillStyle="#fff",l.font="12px system-ui, sans-serif",l.fillText(`Detected cx:${Math.round(q.cx)} cy:${Math.round(q.cy)}`,16,28),l.fillText(`Double: ${Math.round(q.doubleOuter)} Treble: ${Math.round(q.trebleOuter)}`,16,48),l.fillText(`Adjusts: Sx:${De.toFixed(3)} Tx:${Ye} Ty:${Qe}`,16,68),l.restore());const Yt=Sn("outer");if(i.length>=4&&i.length<Yt.length&&u){l.save(),l.strokeStyle="rgba(255,193,7,0.4)",l.lineWidth=2,l.setLineDash([4,4]);for(let W=i.length;W<Yt.length;W++)try{const H=ft(Be||u,Yt[W]);l.beginPath(),l.arc(H.x,H.y,12,0,Math.PI*2),l.stroke(),l.save(),l.fillStyle="rgba(255,255,255,0.65)",l.font="12px sans-serif",l.fillText(Rt[W]??String(W+1),H.x+10,H.y-10),l.restore()}catch{}l.restore()}if(i.length<Sr&&(l.save(),l.fillStyle="rgba(0,0,0,0.7)",l.fillRect(10,10,200,40),l.fillStyle="#fbbf24",l.font="bold 16px sans-serif",l.fillText(`Click on ${Rt[i.length]}`,20,36),l.restore()),i.forEach((W,H)=>{mo(l,W,"#f472b6"),l.save(),l.fillStyle="#f472b6",l.font="14px sans-serif",l.fillText(Rt[H]??String(H+1),W.x+6,W.y-6),l.restore()}),Z&&!xe){l.save(),l.fillStyle="rgba(59,130,246,0.10)";const W=Math.round(Math.min(m.width,m.height)*.08),H=m.width-W*2,Ie=m.height-W*2;l.fillRect(W,W,H,Ie),l.strokeStyle="rgba(34,197,94,0.9)",l.lineWidth=2,l.beginPath(),l.moveTo(W,m.height/2),l.lineTo(m.width-W,m.height/2),l.stroke(),l.beginPath(),l.moveTo(m.width/2,W),l.lineTo(m.width/2,m.height-W),l.stroke(),l.strokeStyle="rgba(234,179,8,0.9)",l.setLineDash([6,4]);const ue=W+30,ee=W+30;l.beginPath(),l.moveTo(ue,ee+30),l.lineTo(ue+60,ee),l.stroke(),l.beginPath(),l.moveTo(m.width-ue,ee+30),l.lineTo(m.width-ue-60,ee),l.stroke(),l.restore(),l.save(),l.scale(1/g,1/g),l.fillStyle="rgba(255,255,255,0.85)",l.font="12px sans-serif",l.fillText("Tip: Frame board centered, edges parallel; slight top-down is okay. Keep bull near center.",W*g,(W+18)*g),l.restore()}}const ro=i=>{if(!i)return;Ke(!1),tt(null),ot(!1),i.anchors?.dst&&i.anchors.dst.length>0&&(L(i.anchors.dst),Jt(i.anchors.dst,i.H));let u=i.H;De!==1&&(u=kn(u,De,1)),(Ye!==0||Qe!==0)&&(u=Nr(u,Ye,Qe)),G({H:u,createdAt:Date.now(),errorPx:i.errorPx,imageSize:i.imageSize,overlaySize:i.overlaySize,anchors:i.anchors,locked:i.locked}),N(i.phase??"computed"),Je(i.confidence??100),nt("Test auto-detect applied"),delete globalThis.__TEST_AUTO_DETECT_RESULT};function Kt(i){try{const u=typeof i=="number"?i:En;console.debug("[Camera Connection] doCommit invoked",{v:u,inProgress:Et.getState().inProgress});const x=Xt.getState?Xt.getState():void 0,m=!!x?.H&&!!x?.imageSize&&(x.locked||typeof x.errorPx=="number"&&x.errorPx<=J);if(u!=null&&Et.getState().inProgress&&m){const l=`${u}|3`,z=performance.now();if(!Ot.current&&!(l===Tn.current&&z-jn.current<On)){Tn.current=l,jn.current=z,Ot.current=!0,console.debug("[Camera Connection] doCommit: committing visit",u,{calState:x,curCalValid:m});try{Et.getState().addVisit(u,3,{visitTotal:u})}catch{}try{window.setTimeout(()=>{Ot.current=!1},Math.max(120,On))}catch{}}else console.debug("[Camera Connection] doCommit: deduped commit skipped",{v:u,curCalValid:m,sig:l})}else console.debug("[Camera Connection] doCommit: NOT committing (invalid cal or no match)",{v:u,inProgress:Et.getState().inProgress,curCalValid:m,calState:x})}catch{}}async function oo(){try{if(console.debug("[Camera Connection] autoDetectRings invoked"),!n.current){alert("Load a photo or capture a frame first."),Ke(!1);return}const i=globalThis.__TEST_AUTO_DETECT_RESULT;if(i){console.debug("[Camera Connection] testAutoDetectResult detected (legacy)"),ro(i);return}Ke(!0),nt("Using advanced detection algorithm..."),Tt(null);const u=Gn(n.current,rt?{centerHint:rt,colorAssist:!0}:{colorAssist:!0});if(console.log("[Camera Connection] detectBoard returned:",{success:u.success,confidence:u.confidence,hasHomography:!!u.homography,numPoints:u.calibrationPoints.length},u.message),!u.success||!u.homography||u.confidence<40){console.warn("[Camera Connection] Auto-detect failed, result:",{success:u.success,confidence:u.confidence,hasHomography:!!u.homography}),nt(u.message||"âŒ Detection failed. Try better lighting or different angle."),Ke(!1);return}tt({cx:u.cx,cy:u.cy,bullInner:u.bullInner,bullOuter:u.bullOuter,trebleInner:u.trebleInner,trebleOuter:u.trebleOuter,doubleInner:u.doubleInner,doubleOuter:u.doubleOuter}),ot(!0),L(u.calibrationPoints),Jt(u.calibrationPoints,u.homography);const x=a?.current?{w:a.current.width,h:a.current.height}:e?.current?{w:e.current.clientWidth,h:e.current.clientHeight}:{w:n.current.width,h:n.current.height},m=e.current?{w:e.current.videoWidth,h:e.current.videoHeight}:{w:n.current.width,h:n.current.height},l=po(u.homography,"outer");G({H:u.homography,createdAt:Date.now(),errorPx:u.errorPx??null,imageSize:m,overlaySize:x,anchors:{src:Sn("outer").slice(0,4),dst:u.calibrationPoints},theta:typeof u.theta=="number"?u.theta:null,sectorOffset:l});const z=ao(u.homography,u.calibrationPoints);Lr(z),N("verify"),Je(Rr?100:Math.round(u.confidence)),nt("âœ… Detected rings â€” Please verify alignment by looking at the overlay"),Ke(!1);try{let re=1;for(let ae=1;ae<3;ae++){const Y=document.createElement("canvas");Y.width=Math.max(1,Math.round(n.current.width*.9)),Y.height=Math.max(1,Math.round(n.current.height*.9)),Y.getContext("2d").drawImage(n.current,0,0,Y.width,Y.height);const He=rt?{centerHint:{x:rt.x*.9,y:rt.y*.9},colorAssist:!0}:{colorAssist:!0},we=Gn(Y,He);so(u,we)&&re++}re>=Math.ceil(3*.66)&&console.log("[Camera Connection] Detection is stable")}catch(K){console.warn("[Camera Connection] Legacy stability check failed:",K)}}catch(i){console.error("[Camera Connection] autoDetectRings failed:",i),nt(`âŒ Auto-detect failed: ${i instanceof Error?i.message:String(i)}`),Ke(!1)}}function ao(i,u){const x=[];if(!i||!u||u.length===0)return x;for(const m of aa){if(m.idx>=u.length)continue;const l=u[m.idx];let z=null;try{z=bo(i,l)}catch(Y){console.warn("[Camera Connection] Failed to convert image point to board space:",Y)}let K=null,re=null,me=null,ae=!1;if(z)try{if(K=yo(z,typeof F=="number"?F:0,$??0),K.ring===m.ring&&K.sector===m.sector)ae=!0,re=0;else{const Y=_[m.ring==="DOUBLE"?"doubleOuter":m.ring==="INNER_BULL"?"bullInner":m.ring==="BULL"?"bullOuter":"doubleOuter"],pe=Math.hypot(z.x,z.y);re=Math.abs(pe-Y),me=Math.hypot(l.x-(q?.cx??0),l.y-(q?.cy??0)),ae=re<=m.toleranceMm}}catch(Y){console.warn("[Camera Connection] Failed to score detected point:",Y)}x.push({label:m.label,expected:{ring:m.ring,sector:m.sector},detected:K,deltaMm:re,deltaPx:me,match:ae,note:ae?"âœ… OK":`âŒ Off by ${re?.toFixed(1)}mm`})}return x}function so(i,u,x=.03){if(!i||!u)return!1;const m=Math.abs((i.cx-u.cx)/(i.cx||1)),l=Math.abs((i.cy-u.cy)/(i.cy||1)),z=Math.abs((i.doubleOuter-u.doubleOuter)/(i.doubleOuter||1));return m<=x&&l<=x&&z<=x}const Hn=v.useRef(null);if(v.useEffect(()=>{let i=null;try{i=new Worker(new URL("/assets/boardDetection.worker-ByHWv7sG.js",import.meta.url),{type:"module"}),Hn.current=i,console.log("[Camera Connection] Board detection worker created")}catch(u){console.warn("[Camera Connection] Failed to create board detection worker, will fallback to main thread: ",u),Hn.current=null}return()=>{try{i?.terminate()}catch{}}},[]),v.useEffect(()=>{Jt()},[E,B,De,Ye,Qe]),v.useEffect(()=>{if(!Oe||!p)return;let i=0;const u=()=>{try{no()}catch{}i=requestAnimationFrame(u)};return i=requestAnimationFrame(u),()=>cancelAnimationFrame(i)},[Oe,p]),v.useEffect(()=>{(async()=>{try{if(!xe||!Pe)return;const i=n.current?{w:n.current.width,h:n.current.height}:null,u=JSON.stringify({H:B,anchors:null,imageSize:i,errorPx:te??null});try{await kt(`/cam/calibration/${Pe}`,{method:"POST",headers:{"Content-Type":"application/json"},body:u}),console.log("[Camera Connection] Posted connection for code",Pe)}catch(x){console.warn("[Camera Connection] Upload connection failed",x)}try{const x=localStorage.getItem("authToken");x&&(await kt("/api/user/calibration",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${x}`},body:u}),console.log("[Camera Connection] Synced connection to user account"))}catch(x){console.warn("[Camera Connection] User connection sync failed",x)}}catch{}})()},[xe,Pe]),A&&!I){const i=Yr??(typeof window<"u"?`${window.location.origin.replace(/\/$/,"")}/mobile-cam.html`:"/mobile-cam.html");return c.jsxs("div",{className:"mx-auto flex min-h-[calc(100vh-140px)] w-full max-w-xl flex-col justify-center gap-6 p-6",children:[c.jsxs("div",{className:"space-y-5 rounded-3xl border border-indigo-400/30 bg-slate-900/70 p-6 text-slate-100 shadow-xl",children:[c.jsxs("div",{className:"space-y-2",children:[c.jsx("p",{className:"text-xs font-semibold uppercase tracking-wide text-indigo-300",children:"Choose Mode"}),c.jsx("h2",{className:"text-2xl font-semibold leading-tight text-white",children:"How do you want to use this device?"}),c.jsx("p",{className:"text-sm text-slate-200/80",children:"You can stream this camera to another device (Remote Camera) or\\n play and calibrate directly on this screen."})]}),c.jsxs("div",{className:"space-y-2",children:[c.jsx("a",{href:i,className:"btn w-full justify-center px-4 py-2 text-base",children:"Open mobile camera"}),c.jsx("button",{type:"button",className:"btn btn--ghost w-full justify-center px-4 py-2 text-sm",onClick:()=>Vt(i,"link"),children:Ht==="link"?"Link copied!":"Copy link"})]}),c.jsxs("p",{className:"text-xs text-slate-300/70",children:["On a desktop, open Camera Connection and generate a pairing code. Then tap ",c.jsx("span",{className:"font-semibold",children:"Pair with Desktop"})," ","from the mobile camera page to connect this device."]})]}),c.jsx("button",{type:"button",className:"self-center text-xs font-medium text-indigo-200 underline decoration-dotted decoration-indigo-300/70 transition hover:text-indigo-100",onClick:()=>w(!0),children:"Continue to desktop connection"})]})}return c.jsxs("div",{className:"space-y-6",children:[A&&I&&c.jsx("div",{className:"rounded-2xl border border-indigo-400/30 bg-indigo-500/10 p-4 text-sm text-indigo-100",children:c.jsxs("div",{className:"flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between",children:[c.jsx("p",{className:"leading-relaxed",children:"Using a phone? Switch back to the streamlined mobile camera interface for an easier pairing flow."}),c.jsx("button",{type:"button",className:"btn btn--ghost px-3 py-1 text-xs",onClick:()=>w(!1),children:"Open mobile camera mode"})]})}),c.jsxs("div",{className:"card space-y-6 p-6",children:[c.jsxs("header",{className:"flex flex-wrap items-start justify-between gap-4",children:[c.jsxs("div",{className:"space-y-2",children:[c.jsx("p",{className:"text-xs font-semibold uppercase tracking-wide text-indigo-300",children:"Camera alignment"}),c.jsx("h2",{className:"text-2xl font-semibold leading-tight text-white",children:"Camera connection"}),c.jsx("p",{className:"max-w-2xl text-sm opacity-80",children:"Select and test your camera. Manual scoring mode does not require calibration."})]}),c.jsxs("div",{className:"flex flex-col items-end gap-2 text-xs font-medium",children:[c.jsxs("span",{className:"inline-flex items-center gap-2 rounded-full border border-indigo-400/50 bg-indigo-500/10 px-3 py-1",children:[c.jsx("span",{className:"opacity-60",children:"Mode"}),c.jsx("span",{children:C==="local"?"Desktop camera":C==="phone"?"Phone camera":"Wifi device"})]}),c.jsxs("span",{className:`inline-flex items-center gap-2 rounded-full border px-3 py-1 ${p?"border-emerald-400/60 bg-emerald-500/10 text-emerald-100":"border-white/20 bg-white/5 text-slate-200"}`,children:[c.jsx("span",{className:`h-2 w-2 rounded-full ${p?"bg-emerald-400":"bg-slate-400"}`}),p?"Live stream active":"Stream idle"]}),xe?c.jsxs("div",{className:"space-y-3 rounded-2xl border border-emerald-400/40 bg-emerald-500/10 p-4 text-sm",children:[c.jsxs("div",{className:"flex items-center justify-between gap-2",children:[c.jsxs("div",{className:"flex items-center gap-3",children:[c.jsx("div",{className:"flex h-10 w-10 items-center justify-center rounded-full bg-emerald-500/20",children:c.jsx("span",{className:"text-lg",children:"âœ“"})}),c.jsxs("div",{children:[c.jsx("h4",{className:"font-semibold text-emerald-100",children:"Connection locked"}),c.jsx("p",{className:"text-xs opacity-80",children:"Your camera connection is saved and active across all game modes. It will be used in Online, Offline, and Tournaments."})]})]}),c.jsx("button",{className:"btn btn--ghost px-2 py-1 text-xs whitespace-nowrap",onClick:()=>G({locked:!1}),title:"Unlock to realign",children:"Unlock"})]}),te!=null&&c.jsxs("div",{className:"text-xs opacity-75",children:["Precision: ",te.toFixed(2)," px RMS error"]})]}):null]})]}),c.jsxs("div",{className:"grid gap-6 xl:grid-cols-[minmax(0,2fr)_minmax(320px,1fr)]",children:[c.jsx("section",{className:"space-y-4",children:c.jsxs("div",{className:"space-y-4 rounded-2xl border border-white/10 bg-black/40 p-4",children:[c.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-4 text-xs",children:[c.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[c.jsx("span",{className:"uppercase tracking-wide opacity-60",children:"Video source"}),c.jsxs("div",{className:"flex items-center gap-1",children:[c.jsx("button",{className:`btn px-3 py-1 ${C==="local"?"bg-emerald-600 hover:bg-emerald-700":"bg-slate-700 hover:bg-slate-600"}`,"data-testid":"mode-local",onClick:()=>{T("local"),typeof DROPDOWN_DEBUG<"u"&&DROPDOWN_DEBUG&&console.debug("[Camera Connection] setMode(local)",Date.now()),Ae(!1)},title:"Use local camera",children:"Local"}),c.jsx("button",{className:`btn px-3 py-1 ${C==="phone"?"bg-emerald-600 hover:bg-emerald-700":"bg-slate-700 hover:bg-slate-600"}`,"data-testid":"mode-phone",onClick:()=>{T("phone"),typeof DROPDOWN_DEBUG<"u"&&DROPDOWN_DEBUG&&console.debug("[Camera Connection] setMode(phone)",Date.now()),Ae(!1)},title:"Enable camera on this device",children:"Phone"}),c.jsx("button",{className:`btn px-3 py-1 ${C==="wifi"?"bg-emerald-600 hover:bg-emerald-700":"bg-slate-700 hover:bg-slate-600"}`,"data-testid":"mode-wifi",onClick:()=>{T("wifi"),typeof DROPDOWN_DEBUG<"u"&&DROPDOWN_DEBUG&&console.debug("[Camera Connection] setMode(wifi)",Date.now()),Ae(!1);try{St()}catch(i){console.debug("[Camera Connection] startWifiConnection failed",i)}},title:"Discover wifi/USB autoscoring devices",children:"Wifi"})]})]}),c.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[c.jsxs("div",{className:"flex items-center gap-2",children:[c.jsx("span",{className:"opacity-70",children:"Zoom"}),c.jsx("input",{type:"range",min:50,max:200,step:5,value:Math.round(g*100),onChange:i=>y(Math.max(.5,Math.min(2,Number(i.target.value)/100)))}),c.jsxs("span",{className:"w-12 text-right",children:[Math.round(g*100),"%"]})]}),c.jsx("button",{className:"btn px-3 py-1",onClick:()=>y(1),children:"Actual"})]})]}),c.jsxs("div",{className:"ml-3 relative",children:[c.jsxs("button",{className:"inline-flex items-center gap-2 rounded-full border border-indigo-400/30 bg-indigo-400/10 px-3 py-1 text-sm",onClick:()=>Ar(!Rn),"data-testid":"cal-tools-popper-button",children:[c.jsx("span",{className:"font-semibold",children:"Cam Tools"}),Fe&&c.jsx("span",{className:"ml-2 text-xs opacity-70",children:"(overlay preserved)"})]}),Rn&&c.jsxs("div",{className:"absolute right-0 mt-2 w-64 rounded-lg border bg-gray-900/80 p-3 shadow-lg z-50","data-testid":"cal-tools-popover",role:"dialog",children:[c.jsx("div",{className:"text-xs mb-2",children:"Camera connection quick tools"}),c.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[c.jsx("input",{id:"hdr-show-darts",type:"checkbox",checked:Pn,onChange:i=>Tr(i.target.checked)}),c.jsx("label",{htmlFor:"hdr-show-darts",className:"text-sm",children:"Show darts overlay"})]}),c.jsx("div",{className:"flex items-center gap-2 mb-2",children:c.jsx("button",{className:"btn btn--ghost btn-sm",onClick:()=>$r(),children:"Reset visual adjustments"})}),c.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[c.jsx("input",{id:"hdr-autocommit",type:"checkbox",checked:jt,onChange:i=>jr(i.target.checked)}),c.jsx("label",{htmlFor:"hdr-autocommit",className:"text-sm",children:"Enable autocommit test"})]}),c.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[c.jsx("input",{id:"hdr-autocommit-online",type:"checkbox",checked:qe,onChange:i=>ht(i.target.checked),disabled:!jt}),c.jsx("label",{htmlFor:"hdr-autocommit-online",className:"text-sm",children:"Allow autocommit in Online/Tournament matches (dangerous)"})]}),c.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[c.jsx("input",{id:"hdr-autocommit-immediate",type:"checkbox",checked:Or,onChange:i=>Dr(i.target.checked)}),c.jsx("label",{htmlFor:"hdr-autocommit-immediate",className:"text-sm",children:"Autocommit immediate when detected"})]}),c.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[c.jsx("input",{id:"hdr-show-detected",type:"checkbox",checked:An,onChange:i=>_r(i.target.checked)}),c.jsx("label",{htmlFor:"hdr-show-detected",className:"text-sm",children:"Show detected rings overlay"})]}),c.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[c.jsx("input",{id:"hdr-force-detected",type:"checkbox",checked:At,onChange:i=>ot(i.target.checked)}),c.jsx("label",{htmlFor:"hdr-force-detected",className:"text-sm",children:"Force detected-only overlay (bypass homography)"})]}),c.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[c.jsx("label",{htmlFor:"hdr-double-adjust",className:"text-sm mr-2",children:"Double adj"}),c.jsx("input",{id:"hdr-double-adjust",type:"range",min:.95,max:1.1,step:.005,value:Bt,onChange:i=>Lt(parseFloat(i.target.value))}),c.jsxs("span",{className:"text-xs ml-2",children:[(Bt*100).toFixed(1),"%"]})]}),c.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[c.jsx("label",{htmlFor:"hdr-treble-adjust",className:"text-sm mr-2",children:"Treble adj"}),c.jsx("input",{id:"hdr-treble-adjust",type:"range",min:.95,max:1.1,step:.005,value:Ft,onChange:i=>Ut(parseFloat(i.target.value))}),c.jsxs("span",{className:"text-xs ml-2",children:[(Ft*100).toFixed(1),"%"]})]}),c.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[c.jsxs("select",{id:"hdr-align-select",className:"input",value:We||"",onChange:i=>_t(i.target.value?i.target.value:null),children:[c.jsx("option",{value:"",children:"-- Align ring --"}),c.jsx("option",{value:"double",children:"Double Outer"}),c.jsx("option",{value:"treble",children:"Treble Outer"}),c.jsx("option",{value:"bull",children:"Bull Outer"})]}),c.jsx("div",{className:"text-xs opacity-70 ml-2",children:"Click on the physical ring to align"})]}),c.jsxs("div",{className:"flex items-center justify-between mt-2",children:[c.jsx("div",{className:"text-xs opacity-70",children:In||"No recent detection"}),c.jsx("div",{children:c.jsx("button",{className:"btn btn--small",onClick:()=>{console.debug("[Camera Connection] popover Commit click (onClick)"),Kt()},onPointerDown:()=>{console.debug("[Camera Connection] popover Commit click (onPointerDown)"),Kt()},children:"Commit"})})]})]})]}),c.jsxs("div",{className:"relative w-full overflow-hidden rounded-2xl border border-indigo-400/30 bg-black",style:{aspectRatio:h?`${h.w} / ${h.h}`:"16 / 9"},children:[c.jsxs("div",{className:"absolute top-2 right-2 z-40 flex items-center gap-2 rounded-full bg-black/40 px-2 py-1 text-[11px] text-white backdrop-blur",children:[c.jsx("span",{className:`inline-block h-2 w-2 rounded-full ${p?"bg-emerald-400":"bg-rose-500"}`,"aria-hidden":"true"}),c.jsx("span",{children:p?"Connected":"Disconnected"})]}),c.jsxs("div",{className:"absolute inset-0",style:{transform:`scale(${g})`,transformOrigin:"center center"},children:[c.jsx("video",{ref:e,onLoadedMetadata:i=>{try{const u=i.currentTarget;u.videoWidth&&u.videoHeight&&b({w:u.videoWidth,h:u.videoHeight})}catch{}},className:`absolute inset-0 h-full w-full object-cover transition-opacity duration-300 ${E?"opacity-0 -z-10":"opacity-100 z-10"}`,autoPlay:!0,playsInline:!0,muted:!0,controls:!1}),k&&c.jsx("div",{className:"absolute inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur",children:c.jsx("button",{className:"rounded-lg bg-white px-4 py-2 font-semibold text-slate-900 shadow-lg",onClick:async()=>{try{await e.current?.play(),P(!1),M(!0),N("capture")}catch(i){console.warn("Tap-to-play retry failed",i),alert("Tap to enable video failed. Please check browser settings or reload the page.")}},children:"Tap to allow video"})}),c.jsx("canvas",{ref:n,className:`absolute inset-0 h-full w-full transition-opacity duration-300 ${E?"opacity-100 z-10":"opacity-0 -z-10"}`})]})]}),c.jsxs("div",{className:"mt-4 flex flex-wrap items-center gap-2",children:[p?c.jsx("button",{className:"btn",onClick:()=>Ae(!0),children:"Disconnect"}):c.jsx("button",{className:"btn",onClick:eo,children:"Connect"}),c.jsx("span",{className:"text-xs opacity-70",children:p?"Camera connected":"Camera not connected"})]})]})}),c.jsxs("aside",{className:"space-y-4",children:[c.jsx(oa,{videoDevices:r,streaming:p,refreshVideoDevices:it,testCamera:Qr,onSelectPhoneCamera:D,lastDetectedLabel:In,autoCommitTestMode:jt,doCommit:Kt,lastDetectedValue:En,cameraConnected:p}),C==="phone"&&c.jsxs("section",{className:"space-y-3 rounded-2xl border border-indigo-400/30 bg-black/40 p-4 text-xs text-white",children:[c.jsx("div",{className:"font-semibold",children:"Phone pairing"}),Bn&&Pe&&c.jsxs("div",{className:"flex flex-col items-center gap-2 rounded-xl bg-white p-3",children:[c.jsx("img",{src:Bn,alt:"Scan to pair mobile camera",className:"w-48 h-48",draggable:!1}),c.jsx("div",{className:"text-[11px] text-slate-700 text-center font-medium",children:"Scan with your phone to pair"})]}),c.jsxs("button",{type:"button",className:"w-full text-left px-3 py-2 rounded-lg border border-white/10 bg-white/5 hover:bg-white/10 transition flex items-center gap-2",onClick:()=>Vt(_e,"link"),title:"Copy mobile camera link",children:[c.jsx("span",{className:"flex-1 min-w-0 font-mono break-all text-[11px]",children:_e}),c.jsx("span",{className:"text-[10px] uppercase tracking-wide whitespace-nowrap text-emerald-200",children:Ht==="link"?"Copied!":"Copy link"})]}),c.jsx("div",{className:"flex items-center gap-2 text-[11px]",children:c.jsx("a",{href:_e,target:"_blank",rel:"noreferrer",className:"underline decoration-dotted text-indigo-200 hover:text-indigo-100 transition",children:"Open link in new tab"})}),c.jsxs("div",{className:"opacity-80",children:["WS:"," ",Ee?Ee.readyState===1?"open":Ee.readyState===0?"connecting":Ee.readyState===2?"closing":"closed":"not started"," ","Â· ",Xe?.https?"HTTPS on":"HTTP only"]}),Pe&&c.jsxs("button",{type:"button",className:"w-full text-left px-3 py-2 rounded-lg border border-white/10 bg-white/5 hover:bg-white/10 transition flex items-center justify-between gap-2",onClick:()=>Vt(Pe,"code"),title:"Copy pairing code",children:[c.jsx("span",{className:"font-mono tracking-[0.3em] text-sm",children:Pe}),c.jsx("span",{className:"text-[10px] uppercase tracking-wide whitespace-nowrap text-emerald-200",children:Ht==="code"?"Copied!":"Copy code"})]}),c.jsxs("div",{className:"flex items-center gap-2",children:[qn!==null&&c.jsxs("span",{children:["Expires in ",qn,"s"]}),c.jsx("button",{className:"btn px-2 py-1 text-xs",onClick:to,children:"Regenerate"})]}),Gr&&c.jsxs("div",{className:"space-y-2 rounded-lg border border-slate-700/50 bg-slate-900/60 p-3 text-slate-200",children:[c.jsx("div",{className:"font-semibold",children:"Troubleshooting"}),c.jsxs("ul",{className:"list-disc space-y-1 pl-4",children:[c.jsx("li",{children:"Phone and desktop must be on the same Wiâ€‘Fi network."}),c.jsxs("li",{children:["Allow the server through your firewall (ports 8787 and"," ",Xe?.https?Xe.port:8788,")."]}),c.jsx("li",{children:"On iPhone, use HTTPS links (QR will prefer HTTPS when enabled)."})]}),c.jsx("div",{className:"text-right",children:c.jsx("button",{className:"btn btn--ghost px-2 py-1 text-xs",onClick:()=>Jr(!1),children:"Hide tips"})})]})]})]})]}),C==="wifi"&&!p&&c.jsxs("section",{className:"space-y-3 rounded-2xl border border-indigo-400/30 bg-black/40 p-4 text-xs text-white",children:[c.jsx("div",{className:"font-semibold",children:"Wifi scoring devices"}),Kr?c.jsxs("div",{className:"flex items-center gap-2",children:[c.jsx("div",{className:"h-4 w-4 animate-spin rounded-full border-b-2 border-white"}),c.jsx("span",{children:"Scanning network for devicesâ€¦"})]}):_n.length>0?c.jsxs("div",{className:"space-y-2",children:[_n.map(i=>c.jsxs("div",{className:"flex items-center justify-between rounded border border-slate-700/50 bg-slate-900/60 p-2",children:[c.jsxs("div",{children:[c.jsx("div",{className:"font-medium",children:i.name}),c.jsxs("div",{className:"opacity-70",children:[i.ip,":",i.port," Â· ",i.type.toUpperCase()]}),c.jsxs("div",{className:"opacity-70 text-xs",children:["Capabilities: ",i.capabilities.join(", ")]})]}),c.jsx("button",{className:`btn px-2 py-1 text-xs ${i.status==="connecting"?"bg-yellow-600":i.status==="online"?"bg-green-600":"bg-blue-600"}`,onClick:()=>Zr(i),disabled:i.status==="connecting",children:i.status==="connecting"?"Connectingâ€¦":"Connect"})]},i.id)),c.jsx("div",{className:"text-center",children:c.jsx("button",{className:"btn px-2 py-1 text-xs",onClick:St,children:"Rescan network"})})]}):c.jsxs("div",{className:"space-y-2 text-center",children:[c.jsx("div",{children:"No wifi scoring devices found."}),c.jsx("div",{className:"opacity-70",children:"Ensure your wifi cameras are powered on and on the same network."}),c.jsx("button",{className:"btn px-2 py-1 text-xs",onClick:St,children:"Scan again"})]})]})]})]})}function xa(){return c.jsxs("div",{className:"card ndn-game-shell relative overflow-hidden",children:[c.jsx("h2",{className:"text-3xl font-bold text-brand-700 mb-4",children:"Camera Setup"}),c.jsx("div",{className:"ndn-shell-body",children:c.jsx(sa,{})})]})}export{xa as default};
//# sourceMappingURL=CameraSetup-Baui8tEU.js.map
