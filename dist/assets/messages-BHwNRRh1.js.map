{"version":3,"file":"messages-BHwNRRh1.js","sources":["../../src/store/messages.ts"],"sourcesContent":["import { create } from 'zustand'\r\n\r\nexport type DM = { id: string; from: string; message: string; ts: number }\r\n\r\ntype MessagesState = {\r\n  inbox: DM[]\r\n  unread: number\r\n  inGame: boolean\r\n  setInGame: (v: boolean) => void\r\n  add: (m: DM) => void\r\n  load: (arr: DM[]) => void\r\n  markAllRead: () => void\r\n  remove: (id: string) => void\r\n}\r\n\r\nconst LS_INBOX = 'ndn:messages:inbox'\r\nconst LS_UNREAD = 'ndn:messages:unread'\r\n\r\nfunction loadInitial() {\r\n  try {\r\n    const raw = localStorage.getItem(LS_INBOX)\r\n    const arr = raw ? JSON.parse(raw) as DM[] : []\r\n    const unread = Number(localStorage.getItem(LS_UNREAD) || '0') || 0\r\n    // sanitize\r\n    const inbox = Array.isArray(arr) ? arr.filter(m => m && typeof m.id==='string').slice(0,200) : []\r\n    return { inbox, unread }\r\n  } catch { return { inbox: [], unread: 0 } }\r\n}\r\n\r\nfunction save(inbox: DM[], unread: number) {\r\n  try { localStorage.setItem(LS_INBOX, JSON.stringify(inbox)) } catch {}\r\n  try { localStorage.setItem(LS_UNREAD, String(unread)) } catch {}\r\n}\r\n\r\nconst initial = loadInitial()\r\n\r\nexport const useMessages = create<MessagesState>((set, get) => ({\r\n  inbox: initial.inbox,\r\n  unread: initial.unread,\r\n  inGame: false,\r\n  setInGame: (v) => set({ inGame: v }),\r\n  add: (m) => set((s) => {\r\n    const exists = s.inbox.some(x => x.id === m.id && x.ts === m.ts)\r\n    const list = exists ? s.inbox : [m, ...s.inbox].slice(0, 200)\r\n    const unread = s.unread + (exists ? 0 : 1)\r\n    save(list, unread)\r\n    return { inbox: list, unread }\r\n  }),\r\n  load: (arr) => set((s) => {\r\n    const sorted = [...arr].sort((a,b)=>b.ts-a.ts).slice(0,200)\r\n    save(sorted, s.unread)\r\n    return { inbox: sorted, unread: s.unread }\r\n  }),\r\n  markAllRead: () => { const s = get(); save(s.inbox, 0); set({ unread: 0 }) },\r\n  remove: (id) => set((s) => {\r\n    const list = s.inbox.filter(m => m.id !== id)\r\n    const unread = s.unread // keep unread count stable on deletion from history\r\n    save(list, unread)\r\n    return { inbox: list, unread }\r\n  }),\r\n}))\r\n"],"names":["LS_INBOX","LS_UNREAD","loadInitial","raw","arr","unread","m","save","inbox","initial","useMessages","create","set","get","v","s","exists","x","list","sorted","a","b","id"],"mappings":"wCAeA,MAAMA,EAAW,qBACXC,EAAY,sBAElB,SAASC,GAAc,CACrB,GAAI,CACF,MAAMC,EAAM,aAAa,QAAQH,CAAQ,EACnCI,EAAMD,EAAM,KAAK,MAAMA,CAAG,EAAY,CAAA,EACtCE,EAAS,OAAO,aAAa,QAAQJ,CAAS,GAAK,GAAG,GAAK,EAGjE,MAAO,CAAE,MADK,MAAM,QAAQG,CAAG,EAAIA,EAAI,OAAOE,GAAKA,GAAK,OAAOA,EAAE,IAAK,QAAQ,EAAE,MAAM,EAAE,GAAG,EAAI,CAAA,EAC/E,OAAAD,CAAA,CAClB,MAAQ,CAAE,MAAO,CAAE,MAAO,GAAI,OAAQ,CAAA,CAAI,CAC5C,CAEA,SAASE,EAAKC,EAAaH,EAAgB,CACzC,GAAI,CAAE,aAAa,QAAQL,EAAU,KAAK,UAAUQ,CAAK,CAAC,CAAE,MAAQ,CAAC,CACrE,GAAI,CAAE,aAAa,QAAQP,EAAW,OAAOI,CAAM,CAAC,CAAE,MAAQ,CAAC,CACjE,CAEA,MAAMI,EAAUP,EAAA,EAEHQ,EAAcC,EAAsB,CAACC,EAAKC,KAAS,CAC9D,MAAOJ,EAAQ,MACf,OAAQA,EAAQ,OAChB,OAAQ,GACR,UAAYK,GAAMF,EAAI,CAAE,OAAQE,EAAG,EACnC,IAAMR,GAAMM,EAAKG,GAAM,CACrB,MAAMC,EAASD,EAAE,MAAM,KAAKE,GAAKA,EAAE,KAAOX,EAAE,IAAMW,EAAE,KAAOX,EAAE,EAAE,EACzDY,EAAOF,EAASD,EAAE,MAAQ,CAACT,EAAG,GAAGS,EAAE,KAAK,EAAE,MAAM,EAAG,GAAG,EACtDV,EAASU,EAAE,QAAUC,EAAS,EAAI,GACxC,OAAAT,EAAKW,EAAMb,CAAM,EACV,CAAE,MAAOa,EAAM,OAAAb,CAAA,CACxB,CAAC,EACD,KAAOD,GAAQQ,EAAKG,GAAM,CACxB,MAAMI,EAAS,CAAC,GAAGf,CAAG,EAAE,KAAK,CAACgB,EAAEC,IAAIA,EAAE,GAAGD,EAAE,EAAE,EAAE,MAAM,EAAE,GAAG,EAC1D,OAAAb,EAAKY,EAAQJ,EAAE,MAAM,EACd,CAAE,MAAOI,EAAQ,OAAQJ,EAAE,MAAA,CACpC,CAAC,EACD,YAAa,IAAM,CAAE,MAAMA,EAAIF,EAAA,EAAON,EAAKQ,EAAE,MAAO,CAAC,EAAGH,EAAI,CAAE,OAAQ,EAAG,CAAE,EAC3E,OAASU,GAAOV,EAAKG,GAAM,CACzB,MAAMG,EAAOH,EAAE,MAAM,OAAOT,GAAKA,EAAE,KAAOgB,CAAE,EACtCjB,EAASU,EAAE,OACjB,OAAAR,EAAKW,EAAMb,CAAM,EACV,CAAE,MAAOa,EAAM,OAAAb,CAAA,CACxB,CAAC,CACH,EAAE"}