import{r as mi,a as Zo,g as hi}from"./vendor-D3F3s8fL.js";import{r as u,S as Sa,L as fc,M as _n,a as xc,U as Zr,T as Ha,C as el,P as pc,R as bc,X as tl,b as fi,c as dr,d as Gi,e as gc,f as yc,G as vc,V as jc,E as sl,g as Nc,h as nl,i as wc,j as Sc,k as kc}from"./ui-ChVmDhx9.js";(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))i(a);new MutationObserver(a=>{for(const r of a)if(r.type==="childList")for(const l of r.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&i(l)}).observe(document,{childList:!0,subtree:!0});function t(a){const r={};return a.integrity&&(r.integrity=a.integrity),a.referrerPolicy&&(r.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?r.credentials="include":a.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function i(a){if(a.ep)return;a.ep=!0;const r=t(a);fetch(a.href,r)}})();var ur={exports:{}},va={};/**
 * @license React
 * react-jsx-runtime.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var Ji;function Cc(){if(Ji)return va;Ji=1;var s=mi(),n=Symbol.for("react.element"),t=Symbol.for("react.fragment"),i=Object.prototype.hasOwnProperty,a=s.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,r={key:!0,ref:!0,__self:!0,__source:!0};function l(o,d,c){var h,m={},x=null,p=null;c!==void 0&&(x=""+c),d.key!==void 0&&(x=""+d.key),d.ref!==void 0&&(p=d.ref);for(h in d)i.call(d,h)&&!r.hasOwnProperty(h)&&(m[h]=d[h]);if(o&&o.defaultProps)for(h in d=o.defaultProps,d)m[h]===void 0&&(m[h]=d[h]);return{$$typeof:n,type:o,key:x,ref:p,props:m,_owner:a.current}}return va.Fragment=t,va.jsx=l,va.jsxs=l,va}var Ki;function Tc(){return Ki||(Ki=1,ur.exports=Cc()),ur.exports}var e=Tc(),$a={},Yi;function Dc(){if(Yi)return $a;Yi=1;var s=Zo();return $a.createRoot=s.createRoot,$a.hydrateRoot=s.hydrateRoot,$a}var Ec=Dc();const Mc=hi(Ec);var Xi=Zo();const al=s=>`ndn_online_quota_${s}`;function Wa(s=new Date){const n=new Date(Date.UTC(s.getFullYear(),s.getMonth(),s.getDate())),t=n.getUTCDay()||7;n.setUTCDate(n.getUTCDate()+4-t);const i=new Date(Date.UTC(n.getUTCFullYear(),0,1)),a=Math.ceil(((n.getTime()-i.getTime())/864e5+1)/7),r=String(a).padStart(2,"0");return`${n.getUTCFullYear()}-${r}`}function rl(s){try{const n=localStorage.getItem(al(s));if(!n)return{week:Wa(),used:0};const t=JSON.parse(n),i=Wa();return!t.week||t.week!==i?{week:i,used:0}:{week:String(t.week),used:Number(t.used)||0}}catch{return{week:Wa(),used:0}}}function Ic(s,n){try{localStorage.setItem(al(s),JSON.stringify(n))}catch{}}function Qi(s,n=3){const t=Wa(),i=rl(s),a={week:t,used:(i.week===t?i.used:0)+1};return Ic(s,a),a}function il(s,n=3){const t=rl(s);return Math.max(0,n-(t.used||0))}const ol={BASE_URL:"/",DEV:!1,MODE:"production",PROD:!0,SSR:!1,VITE_API_URL:"http://localhost:8787",VITE_WS_URL:"ws://localhost:8787"},ll="ndn:isAdmin:v1";function cl(){try{const s=localStorage.getItem(ll);return s?JSON.parse(s):{}}catch{return{}}}function Ac(s,n){try{const t=cl();t[(s||"").toLowerCase()]={v:n,ts:Date.now()},localStorage.setItem(ll,JSON.stringify(t))}catch{}}async function Rc(s){const n=String(s||"").toLowerCase();if(!n)return!1;try{const a=String(ol?.VITE_OWNER_EMAIL||"").toLowerCase();if(a&&n===a)return!0}catch{}if(n==="daviesfamily108@gmail.com")return!0;try{const a=localStorage.getItem("ndn:forceAdmin");if(a==="1"||a==="true")return!0}catch{}const i=cl()[n];if(i&&Date.now()-i.ts<300*1e3)return!!i.v;try{const l=!!(await(await fetch(`/api/admins/check?email=${encodeURIComponent(n)}`)).json().catch(()=>({})))?.isAdmin;return Ac(n,l),l}catch{return!!i?.v}}function dl(s){const n=String(s||"").toLowerCase(),[t,i]=u.useState(!1);return u.useEffect(()=>{let a=!0;if(!n){i(!1);return}try{const r=String(ol?.VITE_OWNER_EMAIL||"").toLowerCase(),l=(()=>{try{const o=localStorage.getItem("ndn:forceAdmin");return o==="1"||o==="true"}catch{return!1}})();if(r&&n===r){i(!0);return}if(l){i(!0);return}}catch{}if(n==="daviesfamily108@gmail.com"){i(!0);return}return Rc(n).then(r=>{a&&i(!!r)}),()=>{a=!1}},[n]),t}const Pc={},Lc=5,Oc={GBP:1,EUR:1.16,USD:1.26,AUD:1.92,NZD:2.08,CAD:1.73};function ul(s,n=Lc){const t=(s||"GBP").toUpperCase(),i=Oc[t]??1,a=n*i;try{return new Intl.NumberFormat(void 0,{style:"currency",currency:t}).format(a)}catch{return`${t} ${a.toFixed(2)}`}}function ml(){try{const s=new Intl.NumberFormat().resolvedOptions(),n=String(s.locale).toLowerCase();return n.includes("-gb")?"GBP":n.includes("-ie")||n.includes("-de")||n.includes("-fr")||n.includes("-es")||n.includes("-it")||n.includes("-nl")?"EUR":n.includes("-us")?"USD":n.includes("-au")?"AUD":n.includes("-nz")?"NZD":n.includes("-ca")?"CAD":"GBP"}catch{return"GBP"}}const Bc=Pc?.VITE_DISCORD_INVITE_URL||"https://discord.gg/nCfT4hJz";let ln=null;function Uc(){if(ln)return ln;const s="http://localhost:8787".trim();if(s)return ln=s.replace(/\/$/,""),ln;if(typeof window<"u"){const{protocol:n,host:t,hostname:i}=window.location,a=`${n}//${t}`;return i.endsWith("onrender.com")||i==="localhost"||i==="127.0.0.1"?ln=a.replace(/\/$/,""):ln="https://ninedartnation.onrender.com",ln}return ln="https://ninedartnation.onrender.com",ln}function $c(s){if(/^https?:\/\//i.test(s))return s;const n=Uc(),t=s.startsWith("/")?s:`/${s}`;return`${n}${t}`}function za(s){return $c(s)}function Pt(s,n){const t=za(s);return fetch(t,n)}function _c(){if(typeof window>"u"||typeof window.fetch!="function")return;const s=window;if(s.__ndnApiPatched)return;const n=window.fetch.bind(window);window.fetch=(t,i)=>{try{if(typeof t=="string")return t.startsWith("/")?n(za(t),i):n(t,i);if(t instanceof Request){const a=t.url.startsWith("/")?za(t.url):t.url;if(a===t.url)return n(t,i);const r=new Request(a,t);return n(r,i)}if(t instanceof URL){const a=t.href.startsWith("/")?za(t.href):t.href;return n(a,i)}}catch(a){console.warn("[API] Interceptor failed, falling back to original fetch",a)}return n(t,i)},s.__ndnApiPatched=!0}function Fc(s){const n=[{key:"score",label:"Home",icon:xc},{key:"online",label:"Online",icon:Zr},{key:"offline",label:"Offline",icon:Ha},{key:"tournaments",label:"Tournaments",icon:Ha},{key:"friends",label:"Friends",icon:Zr},{key:"stats",label:"Stats",icon:Ha},{key:"calibrate",label:"Calibrate",icon:el},{key:"settings",label:"Settings",icon:Sa}];return s?.fullAccess||n.push({key:"fullaccess",label:"PREMIUM Â£â‚¬$",icon:pc}),n}function hl({active:s,onChange:n,user:t,className:i}){const a=Fc(t),r=dl(t?.email);if(r&&!a.some(p=>p.key==="admin")){const p=a.findIndex(w=>w.key==="settings"),g={key:"admin",label:"Admin",icon:Sa};p>=0?a.splice(p,0,g):a.push(g)}const[l,o]=u.useState(!1),[d,c]=u.useState(!1),h=t?.username&&!t?.fullAccess?il(t.username):1/0,[m,x]=u.useState({friendRequests:0,messages:0,tournaments:0});return u.useEffect(()=>{if(!t?.email)return;const p=async()=>{try{const[w,T]=await Promise.all([Pt(`/api/friends/requests?email=${encodeURIComponent(t.email)}`),Pt(`/api/friends/messages?email=${encodeURIComponent(t.email)}`)]),S=w.ok?await w.json():{requests:[]},I=(T.ok?await T.json():{messages:[]}).messages?.filter(M=>!M.read).length||0;x({friendRequests:S.requests?.length||0,messages:I,tournaments:0})}catch(w){console.error("Failed to fetch notifications:",w)}};p();const g=setInterval(p,3e4);return()=>clearInterval(g)},[t?.email]),u.useEffect(()=>{if(!l)return;const p=g=>{(g.key==="Escape"||g.key==="Enter")&&o(!1)};return document.addEventListener("keydown",p),()=>document.removeEventListener("keydown",p)},[l]),e.jsxs("aside",{className:`${t?.fullAccess?"premium-sidebar":""} sidebar glass ${i?"":"w-60"} p-2 sm:p-4 rounded-2xl ${i??"hidden sm:flex"} flex-col gap-2 overflow-y-auto overflow-x-hidden ${i?"":"fixed top-2 bottom-2 sm:top-4 sm:bottom-4"}`,children:[a.map(({key:p,label:g,icon:w})=>p==="admin"&&!r?null:e.jsxs("button",{className:`tab whitespace-nowrap flex items-center justify-start gap-3 ${s===p?"tab--active":"tab--inactive"} `,onClick:()=>n(p),title:g,style:{fontWeight:700,fontSize:"1.1rem",color:s===p?"#fff":"#E5E7EB",letterSpacing:"0.02em"},children:[e.jsx(w,{className:"w-6 h-6"}),e.jsxs("span",{className:"flex items-center gap-2",children:[g,p==="online"&&!t?.fullAccess&&h<=0&&e.jsxs("span",{title:"Weekly free games used",className:"inline-flex items-center gap-1 text-[0.65rem] px-2 py-0.5 rounded-full bg-rose-600 text-white",children:[e.jsx(fc,{className:"w-3 h-3"}),"Locked"]}),p==="friends"&&m.friendRequests>0&&e.jsx("span",{className:"inline-flex items-center justify-center w-5 h-5 text-xs font-bold text-white bg-orange-500 rounded-full",children:m.friendRequests>9?"9+":m.friendRequests}),p==="score"&&(m.messages>0||m.tournaments>0)&&e.jsx("span",{className:"inline-flex items-center justify-center w-5 h-5 text-xs font-bold text-white bg-orange-500 rounded-full",children:m.messages+m.tournaments>9?"9+":m.messages+m.tournaments})]})]},p)),e.jsxs("button",{className:"tab tab--compact whitespace-nowrap flex items-center justify-start gap-3 bg-[#5865F2] text-white mt-2",onClick:()=>o(!0),title:"BullseyeDartsLeague",style:{fontWeight:700,fontSize:"1.1rem",letterSpacing:"0.02em"},children:[e.jsx(_n,{className:"w-6 h-6"}),e.jsx("span",{className:"truncate",children:"BullseyeDartsLeague"})]}),e.jsxs("button",{className:"tab tab--compact whitespace-nowrap flex items-center justify-start gap-3 bg-[#5865F2] text-white mt-1",onClick:()=>c(!0),title:"NineDartNation",style:{fontWeight:700,fontSize:"1.1rem",letterSpacing:"0.02em"},children:[e.jsx(_n,{className:"w-6 h-6"}),e.jsx("span",{className:"truncate",children:"NineDartNation"})]}),l&&Xi.createPortal(e.jsxs("div",{className:"fixed inset-0 z-[1000]",children:[e.jsx("div",{className:"absolute inset-0 bg-black/50",onClick:()=>o(!1),onTouchStart:()=>o(!1)}),e.jsx("div",{className:"absolute inset-0 flex items-center justify-center p-4",children:e.jsxs("div",{role:"dialog","aria-modal":"true",className:"card max-w-md w-full relative text-left p-6 rounded-xl",children:[e.jsx("button",{className:"absolute -top-3 -right-3 btn px-3 py-1","aria-label":"Close",onClick:()=>o(!1),children:"âœ•"}),e.jsxs("h3",{className:"text-xl font-bold mb-2 flex items-center gap-2 text-[#8ea1e1]",children:[e.jsx(_n,{className:"w-6 h-6"})," BullseyeDartsLeague"]}),e.jsx("div",{className:"mb-4 text-lg font-semibold",children:"Join this fantastic Online Darts League with divisions and other cool stuff included"}),e.jsx("a",{href:Bc,target:"_blank",rel:"noopener noreferrer nofollow",className:"btn bg-[#5865F2] text-white w-full font-bold text-lg",children:"Join Discord"})]})})]}),document.body),d&&Xi.createPortal(e.jsxs("div",{className:"fixed inset-0 z-[1000]",children:[e.jsx("div",{className:"absolute inset-0 bg-black/50",onClick:()=>c(!1),onTouchStart:()=>c(!1)}),e.jsx("div",{className:"absolute inset-0 flex items-center justify-center p-4",children:e.jsxs("div",{role:"dialog","aria-modal":"true",className:"card max-w-md w-full relative text-left p-6 rounded-xl",children:[e.jsx("button",{className:"absolute -top-3 -right-3 btn px-3 py-1","aria-label":"Close",onClick:()=>c(!1),children:"âœ•"}),e.jsxs("h3",{className:"text-xl font-bold mb-2 flex items-center gap-2 text-[#8ea1e1]",children:[e.jsx(_n,{className:"w-6 h-6"})," NineDartNation"]}),e.jsx("div",{className:"mb-4 text-lg font-semibold",children:"Join the NineDartNation Discord community"}),e.jsx("a",{href:"https://discord.gg/Q33J5FTVve",target:"_blank",rel:"noopener noreferrer nofollow",className:"btn bg-[#5865F2] text-white w-full font-bold text-lg",children:"Join Discord"})]})})]}),document.body)]})}const Hc={},Zi=s=>{let n;const t=new Set,i=(h,m)=>{const x=typeof h=="function"?h(n):h;if(!Object.is(x,n)){const p=n;n=m??(typeof x!="object"||x===null)?x:Object.assign({},n,x),t.forEach(g=>g(n,p))}},a=()=>n,d={setState:i,getState:a,getInitialState:()=>c,subscribe:h=>(t.add(h),()=>t.delete(h)),destroy:()=>{(Hc?"production":void 0)!=="production"&&console.warn("[DEPRECATED] The `destroy` method will be unsupported in a future version. Instead use unsubscribe function returned by subscribe. Everything will be garbage-collected if store is garbage-collected."),t.clear()}},c=n=s(i,a,d);return d},Wc=s=>s?Zi(s):Zi;var mr={exports:{}},hr={},fr={exports:{}},xr={};/**
 * @license React
 * use-sync-external-store-shim.production.js
 *
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var eo;function zc(){if(eo)return xr;eo=1;var s=mi();function n(m,x){return m===x&&(m!==0||1/m===1/x)||m!==m&&x!==x}var t=typeof Object.is=="function"?Object.is:n,i=s.useState,a=s.useEffect,r=s.useLayoutEffect,l=s.useDebugValue;function o(m,x){var p=x(),g=i({inst:{value:p,getSnapshot:x}}),w=g[0].inst,T=g[1];return r(function(){w.value=p,w.getSnapshot=x,d(w)&&T({inst:w})},[m,p,x]),a(function(){return d(w)&&T({inst:w}),m(function(){d(w)&&T({inst:w})})},[m]),l(p),p}function d(m){var x=m.getSnapshot;m=m.value;try{var p=x();return!t(m,p)}catch{return!0}}function c(m,x){return x()}var h=typeof window>"u"||typeof window.document>"u"||typeof window.document.createElement>"u"?c:o;return xr.useSyncExternalStore=s.useSyncExternalStore!==void 0?s.useSyncExternalStore:h,xr}var to;function qc(){return to||(to=1,fr.exports=zc()),fr.exports}/**
 * @license React
 * use-sync-external-store-shim/with-selector.production.js
 *
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var so;function Vc(){if(so)return hr;so=1;var s=mi(),n=qc();function t(c,h){return c===h&&(c!==0||1/c===1/h)||c!==c&&h!==h}var i=typeof Object.is=="function"?Object.is:t,a=n.useSyncExternalStore,r=s.useRef,l=s.useEffect,o=s.useMemo,d=s.useDebugValue;return hr.useSyncExternalStoreWithSelector=function(c,h,m,x,p){var g=r(null);if(g.current===null){var w={hasValue:!1,value:null};g.current=w}else w=g.current;g=o(function(){function S(A){if(!E){if(E=!0,I=A,A=x(A),p!==void 0&&w.hasValue){var v=w.value;if(p(v,A))return M=v}return M=A}if(v=M,i(I,A))return v;var b=x(A);return p!==void 0&&p(v,b)?(I=A,v):(I=A,M=b)}var E=!1,I,M,P=m===void 0?null:m;return[function(){return S(h())},P===null?void 0:function(){return S(P())}]},[h,m,x,p]);var T=a(c,g[0],g[1]);return l(function(){w.hasValue=!0,w.value=T},[T]),d(T),T},hr}var no;function Gc(){return no||(no=1,mr.exports=Vc()),mr.exports}var Jc=Gc();const Kc=hi(Jc),fl={},{useDebugValue:Yc}=bc,{useSyncExternalStoreWithSelector:Xc}=Kc;let ao=!1;const Qc=s=>s;function Zc(s,n=Qc,t){(fl?"production":void 0)!=="production"&&t&&!ao&&(console.warn("[DEPRECATED] Use `createWithEqualityFn` instead of `create` or use `useStoreWithEqualityFn` instead of `useStore`. They can be imported from 'zustand/traditional'. https://github.com/pmndrs/zustand/discussions/1937"),ao=!0);const i=Xc(s.subscribe,s.getState,s.getServerState||s.getInitialState,n,t);return Yc(i),i}const ro=s=>{(fl?"production":void 0)!=="production"&&typeof s!="function"&&console.warn("[DEPRECATED] Passing a vanilla store will be unsupported in a future version. Instead use `import { useStore } from 'zustand'`.");const n=typeof s=="function"?Wc(s):s,t=(i,a)=>Zc(n,i,a);return Object.assign(t,n),t},Js=s=>s?ro(s):ro;let ed=1;const ei=Js(s=>({toasts:[],push:(n,t)=>s(i=>{const a=ed++,r={id:a,message:n,type:t?.type||"info",timeout:t?.timeout??3e3};return r.timeout&&r.timeout>0&&setTimeout(()=>{s(l=>({toasts:l.toasts.filter(o=>o.id!==a)}))},r.timeout),{toasts:[...i.toasts,r]}}),remove:n=>s(t=>({toasts:t.toasts.filter(i=>i.id!==n)})),clear:()=>s({toasts:[]})}));function zn(){return ei(n=>n.push)}function At(s){return(s??0).toFixed(2)}const td=s=>`ndn_stats_${s}`,xl=s=>`ndn_stats_ts_${s}`;function Bs(s){try{const n=localStorage.getItem(td(s));if(!n)return{darts:0,scored:0};const t=JSON.parse(n);return{darts:Number(t.darts)||0,scored:Number(t.scored)||0,fnDarts:Number(t.fnDarts)||0,fnScored:Number(t.fnScored)||0,best3:typeof t.best3=="number"?t.best3:0,worst3:typeof t.worst3=="number"?t.worst3:0,bestLegDarts:typeof t.bestLegDarts=="number"?t.bestLegDarts:0,bestCheckout:typeof t.bestCheckout=="number"?t.bestCheckout:0,worstLegDarts:typeof t.worstLegDarts=="number"?t.worstLegDarts:0,bestFNAvg:typeof t.bestFNAvg=="number"?t.bestFNAvg:0,worstFNAvg:typeof t.worstFNAvg=="number"?t.worstFNAvg:0}}catch{return{darts:0,scored:0}}}function wn(s){const{darts:n,scored:t}=Bs(s);return n?t/n*3:0}function pr(s){const{fnDarts:n=0,fnScored:t=0}=Bs(s);return n?t/n*3:0}const pl="ndn_game_mode_stats";function xi(s){let n={};try{const t=localStorage.getItem(pl);t&&(n=JSON.parse(t))}catch{}if(Array.isArray(s))for(const t of s)n[t]||(n[t]={played:0,won:0});return n}function sd(s){try{localStorage.setItem(pl,JSON.stringify(s)),window.dispatchEvent(new CustomEvent("ndn:stats-updated",{detail:{gameModes:!0}}))}catch{}}function nd(s,n){const t=xi(),i=t[s]||{played:0,won:0};i.played+=1,n&&(i.won+=1),t[s]=i,sd(t)}function Ja(s){try{const n=localStorage.getItem(xl(s));if(!n)return[];const t=JSON.parse(n);return Array.isArray(t)?t.map(i=>({t:Number(i.t)||0,darts:Number(i.darts)||0,scored:Number(i.scored)||0,fnDarts:Number(i.fnDarts)||0,fnScored:Number(i.fnScored)||0})).filter(i=>i.t>0):[]}catch{return[]}}function ad(s,n){try{localStorage.setItem(xl(s),JSON.stringify(n)),window.dispatchEvent(new CustomEvent("ndn:stats-updated",{detail:{name:s}}))}catch{}}function rd(s,n){const t=Date.now();return s.filter(i=>t-i.t<=n)}function gn(s,n,t,i=Date.now(),a,r){if(n<=0)return;const l=Ja(s),o=rd([...l,{t:i,darts:n,scored:t,fnDarts:a,fnScored:r}],1e3*60*60*24*30);ad(s,o)}function id(s,n=1e3*60*60*24){const t=Ja(s);if(!t.length)return 0;const i=Date.now();let a=0,r=0;for(const l of t)i-l.t<=n&&(a+=l.darts,r+=l.scored);return a<=0?0:r/a*3}function od(s,n=1e3*60*60*24*30){const t=Ja(s);if(!t.length)return 0;const i=Date.now();let a=0,r=0;for(const l of t)i-l.t<=n&&(a+=l.fnDarts||0,r+=l.fnScored||0);return a<=0?0:r/a*3}function br(s){const t=Ja(s);if(!t.length)return 0;const i=Date.now(),a=t.filter(c=>i-c.t<=2592e6),r=a.filter(c=>typeof c.fnDarts=="number"),l=r.length?r:a;let o=0,d=0;for(const c of l)o+=c.darts,d+=c.scored;return o<=0?0:d/o*3}function gr(s){return od(s,2592e6)}const bl="ndn_user_settings";function ti(){try{const s=localStorage.getItem(bl);if(!s)return{favoriteDouble:"D16",callerEnabled:!0,callerVoice:"",callerVolume:1,speakCheckoutOnly:!1,avgMode:"all-time",autoStartOffline:!1,rememberLastOffline:!0,lastOffline:{mode:"X01",x01Start:501,firstTo:1,aiLevel:"None"},reducedMotion:!1,compactHeader:!1,allowSpectate:!0,cameraScale:1,cameraAspect:"wide",cameraFitMode:"fit",calibrationGuide:!0,preferredCameraId:void 0,preferredCameraLabel:void 0,cameraEnabled:!0,offlineLayout:"modern",autoscoreProvider:"built-in",autoscoreWsUrl:"",textSize:"medium",boxSize:"medium",matchType:"singles",teamAName:"Team A",teamBName:"Team B",dartTimerEnabled:!1,dartTimerSeconds:10,x01DoubleIn:!1};const n=JSON.parse(s);return{favoriteDouble:n.favoriteDouble||"D16",callerEnabled:typeof n.callerEnabled=="boolean"?n.callerEnabled:!0,callerVoice:n.callerVoice||"",callerVolume:typeof n.callerVolume=="number"?Math.max(0,Math.min(1,n.callerVolume)):1,speakCheckoutOnly:!!n.speakCheckoutOnly,avgMode:n.avgMode==="24h"?"24h":"all-time",autoStartOffline:!!n.autoStartOffline,rememberLastOffline:typeof n.rememberLastOffline=="boolean"?n.rememberLastOffline:!0,lastOffline:n.lastOffline&&typeof n.lastOffline=="object"?{mode:n.lastOffline.mode||"X01",x01Start:Number(n.lastOffline.x01Start)||501,firstTo:Number(n.lastOffline.firstTo)||1,aiLevel:n.lastOffline.aiLevel||"None"}:{mode:"X01",x01Start:501,firstTo:1,aiLevel:"None"},reducedMotion:!!n.reducedMotion,compactHeader:!!n.compactHeader,allowSpectate:typeof n.allowSpectate=="boolean"?n.allowSpectate:!0,cameraScale:typeof n.cameraScale=="number"&&isFinite(n.cameraScale)?Math.max(.5,Math.min(1.25,n.cameraScale)):1,cameraAspect:n.cameraAspect==="square"?"square":"wide",cameraFitMode:n.cameraFitMode==="fit"||n.cameraFitMode==="fill"?n.cameraFitMode:"fit",autoscoreProvider:n.autoscoreProvider==="external-ws"?"external-ws":n.autoscoreProvider==="manual"?"manual":"built-in",autoscoreWsUrl:typeof n.autoscoreWsUrl=="string"?n.autoscoreWsUrl:"",calibrationGuide:typeof n.calibrationGuide=="boolean"?n.calibrationGuide:!0,preferredCameraId:typeof n.preferredCameraId=="string"?n.preferredCameraId:void 0,preferredCameraLabel:typeof n.preferredCameraLabel=="string"?n.preferredCameraLabel:void 0,preferredCameraLocked:typeof n.preferredCameraLocked=="boolean"?n.preferredCameraLocked:!1,cameraEnabled:typeof n.cameraEnabled=="boolean"?n.cameraEnabled:!0,offlineLayout:n.offlineLayout==="classic"?"classic":"modern",textSize:n.textSize==="small"||n.textSize==="large"?n.textSize:"medium",boxSize:n.boxSize==="small"||n.boxSize==="large"?n.boxSize:"medium",matchType:n.matchType==="doubles"?"doubles":"singles",teamAName:typeof n.teamAName=="string"?n.teamAName:"Team A",teamBName:typeof n.teamBName=="string"?n.teamBName:"Team B",dartTimerEnabled:typeof n.dartTimerEnabled=="boolean"?n.dartTimerEnabled:!1,dartTimerSeconds:typeof n.dartTimerSeconds=="number"&&isFinite(n.dartTimerSeconds)?Math.max(3,Math.min(60,n.dartTimerSeconds)):10,x01DoubleIn:typeof n.x01DoubleIn=="boolean"?n.x01DoubleIn:!1}}catch{return{favoriteDouble:"D16",callerEnabled:!0,callerVoice:"",callerVolume:1,speakCheckoutOnly:!1,avgMode:"all-time",autoStartOffline:!1,rememberLastOffline:!0,lastOffline:{mode:"X01",x01Start:501,firstTo:1,aiLevel:"None"},reducedMotion:!1,compactHeader:!1,allowSpectate:!0,cameraScale:1,cameraAspect:"wide",cameraFitMode:"fit",calibrationGuide:!0,preferredCameraId:void 0,preferredCameraLabel:void 0,preferredCameraLocked:!1,cameraEnabled:!0,offlineLayout:"modern",autoscoreProvider:"built-in",autoscoreWsUrl:"",textSize:"medium",boxSize:"medium",matchType:"singles",teamAName:"Team A",teamBName:"Team B",dartTimerEnabled:!1,dartTimerSeconds:10,x01DoubleIn:!1}}}function Ct(s){try{const n=ti();localStorage.setItem(bl,JSON.stringify({...n,...s}))}catch{}}const Ft=Js((s,n)=>({...ti(),setFavoriteDouble:t=>{Ct({favoriteDouble:t}),s({favoriteDouble:t})},setCallerEnabled:t=>{Ct({callerEnabled:t}),s({callerEnabled:t})},setCallerVoice:t=>{Ct({callerVoice:t}),s({callerVoice:t})},setAvgMode:t=>{Ct({avgMode:t}),s({avgMode:t})},setCallerVolume:t=>{const i=Math.max(0,Math.min(1,t));Ct({callerVolume:i}),s({callerVolume:i})},setSpeakCheckoutOnly:t=>{Ct({speakCheckoutOnly:t}),s({speakCheckoutOnly:t})},setAutoStartOffline:t=>{Ct({autoStartOffline:t}),s({autoStartOffline:t})},setRememberLastOffline:t=>{Ct({rememberLastOffline:t}),s({rememberLastOffline:t})},setLastOffline:t=>{const a={...ti().lastOffline,...t};Ct({lastOffline:a}),s({lastOffline:a})},setReducedMotion:t=>{Ct({reducedMotion:t}),s({reducedMotion:t})},setCompactHeader:t=>{Ct({compactHeader:t}),s({compactHeader:t})},setAllowSpectate:t=>{Ct({allowSpectate:t}),s({allowSpectate:t})},ignorePreferredCameraSync:!1,setIgnorePreferredCameraSync:t=>{Ct({}),s({ignorePreferredCameraSync:t})},setCameraScale:t=>{const i=Math.max(.5,Math.min(1.25,t));Ct({cameraScale:i}),s({cameraScale:i})},setCameraAspect:t=>{const i=t==="square"?"square":"wide";Ct({cameraAspect:i}),s({cameraAspect:i})},setCameraFitMode:t=>{const i=t==="fit"?"fit":"fill";Ct({cameraFitMode:i}),s({cameraFitMode:i})},setAutoscoreProvider:t=>{Ct({autoscoreProvider:t}),s({autoscoreProvider:t})},setAutoscoreWsUrl:t=>{Ct({autoscoreWsUrl:t}),s({autoscoreWsUrl:t})},setCalibrationGuide:t=>{Ct({calibrationGuide:t}),s({calibrationGuide:t})},setPreferredCamera:(t,i,a=!1)=>{try{const r=n();if(console.log("[USERSETTINGS] setPreferredCamera called:",{id:t,label:i,force:a,locked:r.preferredCameraLocked}),r.preferredCameraLocked&&!a){console.log("[USERSETTINGS] Camera selection locked and force=false, ignoring update");return}}catch{}console.log("[USERSETTINGS] Saving preferred camera:",{id:t,label:i}),Ct({preferredCameraId:t,preferredCameraLabel:i}),s({preferredCameraId:t,preferredCameraLabel:i})},setPreferredCameraLocked:t=>{Ct({preferredCameraLocked:t}),s({preferredCameraLocked:t})},setCameraEnabled:t=>{Ct({cameraEnabled:t}),s({cameraEnabled:t})},setOfflineLayout:t=>{Ct({offlineLayout:t}),s({offlineLayout:t})},setTextSize:t=>{Ct({textSize:t}),s({textSize:t})},setBoxSize:t=>{Ct({boxSize:t}),s({boxSize:t})},setMatchType:t=>{const i=t==="doubles"?"doubles":"singles";Ct({matchType:i}),s({matchType:i})},setTeamAName:t=>{const i=t?.trim()||"Team A";Ct({teamAName:i}),s({teamAName:i})},setTeamBName:t=>{const i=t?.trim()||"Team B";Ct({teamBName:i}),s({teamBName:i})},setDartTimerEnabled:t=>{Ct({dartTimerEnabled:t}),s({dartTimerEnabled:t})},setDartTimerSeconds:t=>{const i=Math.max(3,Math.min(60,Math.round(t)));Ct({dartTimerSeconds:i}),s({dartTimerSeconds:i})},setX01DoubleIn:t=>{Ct({x01DoubleIn:t}),s({x01DoubleIn:t})}})),Is=Js((s,n)=>({recent:[],totals:{visits:0,darts:0,points:0,finishes:0,busts:0,byMode:{}},calibration:{hasHomography:!1,imageSize:null,lastUpdated:void 0},recordVisit:(t,i,a,r)=>s(l=>{const d={ts:Date.now(),mode:t,darts:i,visitTotal:a,preOpenDarts:r?.preOpenDarts,preRemaining:r?.preRemaining,postRemaining:r?.postRemaining,bust:r?.bust,finish:r?.finish},c=[...l.recent,d].slice(-50),h={...l.totals};h.visits+=1,h.darts+=i,h.points+=a,d.finish&&(h.finishes+=1),d.bust&&(h.busts+=1);const m=h.byMode[t]||{visits:0,darts:0,points:0};m.visits+=1,m.darts+=i,m.points+=a,h.byMode[t]=m;try{const x=d.finish?"FINISH":d.bust?"BUST":"VISIT";console.info(`[Audit:${x}]`,{mode:t,darts:i,visitTotal:a,preOpenDarts:d.preOpenDarts??0,preRemaining:d.preRemaining,postRemaining:d.postRemaining})}catch{}try{localStorage.setItem("ndn_audit_recent",JSON.stringify(c))}catch{}return{...l,recent:c,totals:h}}),setCalibrationStatus:t=>s(i=>{const a={hasHomography:t.hasHomography??i.calibration.hasHomography,imageSize:t.imageSize===void 0?i.calibration.imageSize:t.imageSize,lastUpdated:Date.now()};try{console.info("[Audit:Calibration]",a)}catch{}return{...i,calibration:a}}),reset:()=>s({recent:[],totals:{visits:0,darts:0,points:0,finishes:0,busts:0,byMode:{}},calibration:{hasHomography:!1,imageSize:null,lastUpdated:void 0}})}));try{typeof window<"u"&&(window.__NDN_AUDIT__={get:()=>Is.getState(),subscribe:Is.subscribe,reset:()=>Is.getState().reset()})}catch{}try{if(typeof window<"u"){const s=localStorage.getItem("ndn_audit_recent");if(s){const n=JSON.parse(s);Array.isArray(n)&&n.length&&Is.setState(t=>({...t,recent:n.slice(-50)}))}}}catch{}function ja(s){try{window.dispatchEvent(new CustomEvent("ndn:change-tab",{detail:{tab:s}}))}catch{}}const ld="http://localhost:8787";function cd({user:s}){const[n,t]=u.useState(!1),[i,a]=u.useState(!1),[r,l]=u.useState(""),{lastOffline:o}=Ft(),d=zn(),c=Is(),h=c.recent&&c.recent.length?c.recent[c.recent.length-1]:null,[m,x]=u.useState(null);return u.useEffect(()=>{try{const p=localStorage.getItem("ndn_last_match");p&&x(JSON.parse(p))}catch{}},[]),u.useEffect(()=>{const p=["The fastest televised 9-darter took roughly 25 seconds!","A perfect leg (501) can be finished in nine darts.","The inner bull is worth 50; the outer bull is 25.","Standard dartboards are made from compressed sisal fibers.","Doubles and trebles are the thin outer and middle rings.","Professional oche (throw line) distance is 7 ft 9Â¼ in (2.37 m).","â€œDartitisâ€ is a real condition affecting a playerâ€™s throwing motion.","Phil Taylor holds a record number of World Championship titles.","Checkout routes often end on a doubleâ€”classic â€œdouble-outâ€.","The highest 3-dart score is 180 (triple 20, triple 20, triple 20)."],g=Math.floor(Math.random()*p.length);l(p[g])},[]),e.jsxs("div",{className:`${s?.fullAccess?"premium-main":""} relative min-h-[600px] flex flex-col items-center justify-center overflow-hidden`,children:[e.jsxs("div",{className:"absolute inset-0 z-0",children:[e.jsx("div",{className:"w-full h-full bg-gradient-to-br from-purple-700 via-indigo-500 to-blue-600 opacity-60 blur-2xl"}),e.jsx("div",{className:"absolute top-20 left-1/4 w-40 h-40 bg-pink-400 rounded-full opacity-30 blur-2xl animate-pulse"}),e.jsx("div",{className:"absolute bottom-10 right-1/4 w-32 h-32 bg-blue-400 rounded-full opacity-30 blur-2xl animate-pulse"})]}),e.jsxs("div",{className:"relative z-10 w-full max-w-6xl mx-auto bg-white/10 backdrop-blur-lg rounded-2xl sm:rounded-3xl shadow-2xl p-4 sm:p-6 md:p-8 lg:p-10 flex flex-col items-center",children:[e.jsx("h2",{className:"text-2xl sm:text-4xl md:text-5xl lg:text-6xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-indigo-300 via-purple-400 to-blue-400 mb-2 sm:mb-3 md:mb-4 drop-shadow-xl text-center leading-tight",children:"Welcome to Nine Dart Nation"}),e.jsx("p",{className:"text-base sm:text-lg md:text-xl lg:text-2xl text-white/80 mb-2 font-semibold text-center px-2",children:"Your home for competitive darts, stats, and online play."}),e.jsx("p",{className:"text-xs sm:text-sm md:text-base lg:text-lg text-white/60 mb-3 sm:mb-4 italic text-center px-2",children:'"Where every dart counts and every player matters."'}),r&&e.jsx("div",{className:"w-full mb-4 sm:mb-6 px-2 sm:px-0",children:e.jsxs("div",{className:"mx-auto max-w-xs sm:max-w-xl rounded-full px-3 sm:px-5 py-2 text-center text-indigo-100 bg-gradient-to-r from-indigo-600/80 to-fuchsia-600/80 shadow-md",children:[e.jsx("span",{className:"font-semibold text-sm sm:text-base",children:"Did you know?"})," ",e.jsx("span",{className:"opacity-90 text-sm sm:text-base",children:r})]})}),h&&e.jsx("div",{className:"w-full mb-4 sm:mb-6 px-2 sm:px-0",children:e.jsx("div",{className:"mx-auto max-w-2xl rounded-xl p-3 bg-white/5 border border-white/10",children:e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm opacity-70",children:"Recent Game"}),e.jsx("div",{className:"font-semibold text-lg",children:h.mode}),e.jsx("div",{className:"text-xs opacity-70",children:new Date(h.ts).toLocaleString()}),e.jsxs("div",{className:"mt-2 text-sm",children:["Last visit: ",e.jsx("span",{className:"font-semibold",children:h.visitTotal})," points Â· Darts: ",e.jsx("span",{className:"font-semibold",children:h.darts})]}),h.finish&&e.jsx("div",{className:"text-xs text-emerald-400 mt-1",children:"Finished a leg"}),h.bust&&e.jsx("div",{className:"text-xs text-rose-400 mt-1",children:"Last visit was a bust"})]}),e.jsxs("div",{className:"shrink-0 flex flex-col items-end gap-2",children:[e.jsx("button",{className:"btn",onClick:()=>{try{window.dispatchEvent(new CustomEvent("ndn:change-tab",{detail:{tab:"offline"}}))}catch{}try{window.dispatchEvent(new CustomEvent("ndn:offline-format",{detail:{formatType:"first",formatCount:1,startScore:h.mode?.includes("X01")?501:void 0}}))}catch{}try{window.dispatchEvent(new CustomEvent("ndn:auto-start",{detail:{mode:h.mode}}))}catch{}},children:"Resume"}),e.jsx("button",{className:"btn bg-rose-600 hover:bg-rose-700",onClick:()=>{Is.getState().reset(),d("Recent game cleared")},children:"Clear"})]})]})})}),m&&e.jsx("div",{className:"w-full mb-4 sm:mb-6 px-2 sm:px-0",children:e.jsx("div",{className:"mx-auto max-w-2xl rounded-xl p-3 bg-white/5 border border-white/10",children:e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm opacity-70",children:"Last Finished Match"}),e.jsxs("div",{className:"font-semibold text-lg",children:["Winner: ",m.winner]}),e.jsx("div",{className:"text-xs opacity-70",children:new Date(m.ts).toLocaleString()}),e.jsx("div",{className:"mt-2 text-sm",children:"Players:"}),e.jsx("div",{className:"mt-1 text-sm",children:m.players.map(p=>e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"text-sm",children:p.name}),e.jsxs("div",{className:"text-xs opacity-70",children:["Legs: ",p.legsWon," Â· Darts: ",p.dartsThrown," Â· Avg: ",p.avg]})]},p.id))})]}),e.jsxs("div",{className:"shrink-0 flex flex-col items-end gap-2",children:[e.jsx("button",{className:"btn",onClick:()=>{ja("stats")},children:"View Stats"}),e.jsx("button",{className:"btn bg-rose-600 hover:bg-rose-700",onClick:()=>{try{localStorage.removeItem("ndn_last_match")}catch{}x(null),d("Last match cleared")},children:"Clear"})]})]})})}),e.jsxs("div",{className:"flex flex-wrap gap-3 sm:gap-4 md:gap-6 justify-center mb-6 md:mb-8 w-full max-w-4xl mx-auto",children:[e.jsxs("button",{onClick:()=>{ja("offline");try{window.dispatchEvent(new CustomEvent("ndn:offline-format",{detail:{formatType:"first",formatCount:Number(o?.firstTo)||1,startScore:Number(o?.x01Start)||501}}))}catch{}try{setTimeout(()=>{window.dispatchEvent(new CustomEvent("ndn:auto-start",{detail:{mode:o?.mode||"X01"}}))},50)}catch{}},className:"flex-1 min-w-[200px] sm:flex-none px-4 sm:px-6 md:px-8 py-3 md:py-4 rounded-full bg-gradient-to-r from-purple-500 to-indigo-500 text-white font-bold shadow-xl hover:scale-105 active:scale-95 transition-transform duration-150 flex items-center justify-center gap-2 text-base sm:text-lg md:text-xl touch-manipulation",children:[e.jsx("span",{"aria-hidden":!0,children:"ðŸŽ¯"})," Start New Match"]}),e.jsxs("button",{onClick:()=>ja("stats"),className:"flex-1 min-w-[200px] sm:flex-none px-4 sm:px-6 md:px-8 py-3 md:py-4 rounded-full bg-gradient-to-r from-blue-500 to-purple-500 text-white font-bold shadow-xl hover:scale-105 active:scale-95 transition-transform duration-150 flex items-center justify-center gap-2 text-base sm:text-lg md:text-xl touch-manipulation",children:[e.jsx("span",{"aria-hidden":!0,children:"ðŸ“Š"})," View Stats"]}),e.jsxs("button",{onClick:()=>ja("online"),className:"flex-1 min-w-[200px] sm:flex-none px-4 sm:px-6 md:px-8 py-3 md:py-4 rounded-full bg-gradient-to-r from-green-500 to-blue-400 text-white font-bold shadow-xl hover:scale-105 active:scale-95 transition-transform duration-150 flex items-center justify-center gap-2 text-base sm:text-lg md:text-xl touch-manipulation",children:[e.jsx("span",{"aria-hidden":!0,children:"ðŸ†"})," Join Online Match"]}),e.jsxs("button",{onClick:()=>{ja("offline");try{window.dispatchEvent(new CustomEvent("ndn:auto-start",{detail:{mode:"Double Practice"}}))}catch{}},className:"flex-1 min-w-[200px] sm:flex-none px-4 sm:px-6 md:px-8 py-3 md:py-4 rounded-full bg-gradient-to-r from-pink-500 to-indigo-500 text-white font-bold shadow-xl hover:scale-105 active:scale-95 transition-transform duration-150 flex items-center justify-center gap-2 text-base sm:text-lg md:text-xl touch-manipulation",children:[e.jsx("span",{"aria-hidden":!0,children:"ðŸ’¡"})," Practice Doubles"]})]}),(()=>{const p=s?.username||"Player 1",g=Bs(p),w=!!s?.fullAccess,T="grid grid-cols-[120px,1fr,1fr] sm:grid-cols-[160px,1fr,1fr]",S=({label:E,left:I,right:M,lock:P})=>e.jsxs("div",{className:`relative ${T} gap-2 items-center p-2 rounded-lg ${P?"bg-white/5 border border-white/10 overflow-hidden":"bg-indigo-500/10 border border-indigo-500/40"} mb-2`,children:[e.jsx("div",{className:"text-[12px] opacity-80 pl-2 text-left",children:E}),e.jsx("div",{className:`text-sm font-semibold text-center ${P?"opacity-50 blur-[0.5px]":""}`,children:I}),e.jsx("div",{className:`text-sm font-semibold text-center ${P?"opacity-50 blur-[0.5px]":""}`,children:M}),P&&e.jsx("button",{className:"absolute inset-0 flex items-center justify-center rounded-lg bg-slate-900/35 hover:bg-slate-900/45 transition",onClick:async()=>{try{const v=await(await fetch(`${ld}/api/stripe/create-checkout-session`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:s.email})})).json();v.ok&&v.url?window.location.href=v.url:v.error==="STRIPE_NOT_CONFIGURED"?d("Premium purchases are not available in this development environment. Please visit the production site to upgrade.",{type:"error",timeout:4e3}):d("Failed to create checkout session. Please try again.",{type:"error",timeout:4e3})}catch{d("Error creating checkout. Please try again.",{type:"error",timeout:4e3})}},title:"Unlock with PREMIUM",children:e.jsx("span",{className:"text-[12px] font-semibold",children:"Unlock PREMIUM"})})]});return e.jsxs("div",{className:"w-full mt-2 rounded-2xl p-2 sm:p-3 bg-white/5 border border-white/10 overflow-x-auto",children:[e.jsxs("div",{className:`${T} gap-2 mb-2 px-1 items-center min-w-[280px] sm:min-w-0`,children:[e.jsx("div",{className:"text-[12px] opacity-0 select-none",children:"label"}),e.jsx("div",{className:"text-[12px] font-semibold text-center",children:"BEST"}),e.jsx("div",{className:"text-[12px] font-semibold text-center",children:"WORST"})]}),e.jsx(S,{label:"3-dart avg",left:At(g.best3||0),right:At(g.worst3||0)}),e.jsx(S,{label:"9-dart avg",left:At(g.bestFNAvg||0),right:At(g.worstFNAvg||0),lock:!w}),e.jsx(S,{label:"Leg (darts)",left:String(g.bestLegDarts||0),right:String(g.worstLegDarts||0),lock:!w}),e.jsx(S,{label:"Checkout",left:String(g.bestCheckout||0),right:"â€”",lock:!w})]})})(),e.jsx("button",{className:"mt-6 sm:mt-8 md:mt-10 px-6 sm:px-8 md:px-10 py-3 md:py-4 rounded-full bg-gradient-to-r from-purple-500 to-indigo-500 text-white font-bold shadow-xl hover:scale-105 active:scale-95 transition-transform duration-150 text-base sm:text-lg md:text-xl touch-manipulation",onClick:()=>a(!0),children:"How to Play / Getting Started"})]}),e.jsx("footer",{className:"w-full py-2 md:py-2 text-center text-white/80 text-xs md:text-sm font-medium absolute bottom-0 left-0 z-20 flex items-center justify-center gap-1 md:gap-2",children:e.jsxs("button",{className:"flex items-center gap-1 md:gap-2 hover:text-white transition",onClick:()=>t(!0),children:[e.jsx("span",{children:"Â©"}),e.jsx("span",{style:{letterSpacing:"0.05em"},children:"NINEDARTNATION"})]})}),n&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50",children:e.jsxs("div",{className:"card max-w-lg w-full relative text-left bg-[#2d2250] text-white p-6 rounded-xl shadow-xl",children:[e.jsx("button",{className:"absolute top-2 right-2 btn px-2 py-1 bg-purple-500 text-white font-bold",onClick:()=>t(!1),children:"Close"}),e.jsx("h3",{className:"text-xl font-bold mb-2",children:"Legal Information"}),e.jsxs("ul",{className:"list-disc pl-5 mb-2",children:[e.jsx("li",{children:"Terms & Conditions: All users must follow fair play and site rules."}),e.jsx("li",{children:"Privacy Policy: Your data is protected and never shared without consent."}),e.jsxs("li",{children:["Copyright Â© ",new Date().getFullYear()," NINEDARTNATION. All rights reserved."]}),e.jsx("li",{children:"Contact: support@ninedartnation.com"})]}),e.jsx("p",{className:"text-sm text-purple-200",children:"For full legal details, please contact us or visit our legal page."})]})}),i&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50",children:e.jsxs("div",{className:"card max-w-lg w-full relative text-left bg-[#2d2250] text-white p-6 rounded-xl shadow-xl",children:[e.jsx("button",{className:"absolute top-2 right-2 btn px-2 py-1 bg-purple-500 text-white font-bold",onClick:()=>a(!1),children:"Close"}),e.jsx("h3",{className:"text-xl font-bold mb-2",children:"Getting Started"}),e.jsxs("ul",{className:"list-disc pl-5 mb-2",children:[e.jsx("li",{children:"Choose a game mode and invite friends or play solo."}),e.jsx("li",{children:"Track your stats and progress in the Stats tab."}),e.jsx("li",{children:"Join the BullseyeDartsLeague for online competition."}),e.jsx("li",{children:"Upgrade to PREMIUM for advanced features and modes."}),e.jsx("li",{children:"Need help? Visit the Settings tab for support and tips."})]}),e.jsx("p",{className:"text-sm text-purple-200",children:'Ready to play? Hit "Start New Match" and let the darts fly!'})]})})]})}function en({children:s,className:n,style:t}){const i=u.useRef(null);return u.useEffect(()=>{let a=0;const r=()=>{const d=i.current;if(!d)return;const c=document.getElementById("ndn-header");if(!c){d.style.clipPath="";return}const h=document.getElementById("ndn-main-scroll"),m=h?h.scrollTop:window.scrollY||0,x=c.getBoundingClientRect().height,p=m>0?x:0;try{let g=d.querySelector("[data-ndn-top-mask]");g||(g=document.createElement("div"),g.setAttribute("data-ndn-top-mask","1"),Object.assign(g.style,{position:"absolute",left:"0px",right:"0px",top:"0px",height:"0px",pointerEvents:"none",zIndex:"20",background:"linear-gradient(to bottom, rgba(17,24,39,1), rgba(17,24,39,0))"}),d.style.position=d.style.position||"relative",d.insertBefore(g,d.firstChild)),p>0?(g.style.height=`${p}px`,g.style.display=""):(g.style.height="0px",g.style.display="none"),d.style.marginTop="0px"}catch{d.style.marginTop="0px"}};r();const l=()=>{a&&cancelAnimationFrame(a),a=requestAnimationFrame(r)},o=document.getElementById("ndn-main-scroll");return o?.addEventListener("scroll",l,{passive:!0}),window.addEventListener("scroll",l,{passive:!0}),window.addEventListener("resize",l),()=>{o?.removeEventListener("scroll",l),window.removeEventListener("scroll",l),window.removeEventListener("resize",l),a&&cancelAnimationFrame(a)}},[]),e.jsx("div",{ref:i,className:n,style:t,children:s})}const dd=({calibrationComplete:s})=>{const[n,t]=u.useState(!1),[i,a]=u.useState(!1);return u.useEffect(()=>{s?(t(!0),setTimeout(()=>a(!0),1200)):(t(!1),a(!1))},[s]),e.jsxs("div",{className:`flex flex-col items-center justify-center w-full h-full transition-opacity duration-700 ${i?"opacity-0":"opacity-100"}`,style:{pointerEvents:"none",position:"absolute",inset:0,zIndex:10},children:[e.jsxs("div",{className:"flex items-center justify-center",children:[e.jsx("svg",{width:"80",height:"80",viewBox:"0 0 80 80",className:`animate-spin-slow ${n?"opacity-0":"opacity-100"} transition-opacity duration-500`,style:{transition:"opacity 0.5s"},children:e.jsxs("g",{children:[e.jsx("rect",{x:"36",y:"10",width:"8",height:"40",rx:"3",fill:"#a78bfa"}),e.jsx("polygon",{points:"40,10 44,22 36,22",fill:"#f472b6"}),e.jsx("rect",{x:"36",y:"50",width:"8",height:"18",rx:"2",fill:"#22d3ee"}),e.jsx("polygon",{points:"36,68 44,68 40,78",fill:"#10b981"})]})}),n&&e.jsxs("svg",{width:"80",height:"80",viewBox:"0 0 80 80",className:"absolute",style:{left:0,top:0},children:[e.jsx("circle",{cx:"40",cy:"40",r:"32",fill:"none",stroke:"#10b981",strokeWidth:"6"}),e.jsx("polyline",{points:"28,44 38,54 54,30",fill:"none",stroke:"#10b981",strokeWidth:"6",strokeLinecap:"round",strokeLinejoin:"round"})]})]}),e.jsx("div",{className:"mt-4 text-lg font-semibold text-indigo-200",children:n?"Calibration Complete!":"Initializing Camera..."})]})};var ua={},yr,io;function ud(){return io||(io=1,yr=function(){return typeof Promise=="function"&&Promise.prototype&&Promise.prototype.then}),yr}var vr={},pn={},oo;function qn(){if(oo)return pn;oo=1;let s;const n=[0,26,44,70,100,134,172,196,242,292,346,404,466,532,581,655,733,815,901,991,1085,1156,1258,1364,1474,1588,1706,1828,1921,2051,2185,2323,2465,2611,2761,2876,3034,3196,3362,3532,3706];return pn.getSymbolSize=function(i){if(!i)throw new Error('"version" cannot be null or undefined');if(i<1||i>40)throw new Error('"version" should be in range from 1 to 40');return i*4+17},pn.getSymbolTotalCodewords=function(i){return n[i]},pn.getBCHDigit=function(t){let i=0;for(;t!==0;)i++,t>>>=1;return i},pn.setToSJISFunction=function(i){if(typeof i!="function")throw new Error('"toSJISFunc" is not a valid function.');s=i},pn.isKanjiModeEnabled=function(){return typeof s<"u"},pn.toSJIS=function(i){return s(i)},pn}var jr={},lo;function pi(){return lo||(lo=1,(function(s){s.L={bit:1},s.M={bit:0},s.Q={bit:3},s.H={bit:2};function n(t){if(typeof t!="string")throw new Error("Param is not a string");switch(t.toLowerCase()){case"l":case"low":return s.L;case"m":case"medium":return s.M;case"q":case"quartile":return s.Q;case"h":case"high":return s.H;default:throw new Error("Unknown EC Level: "+t)}}s.isValid=function(i){return i&&typeof i.bit<"u"&&i.bit>=0&&i.bit<4},s.from=function(i,a){if(s.isValid(i))return i;try{return n(i)}catch{return a}}})(jr)),jr}var Nr,co;function md(){if(co)return Nr;co=1;function s(){this.buffer=[],this.length=0}return s.prototype={get:function(n){const t=Math.floor(n/8);return(this.buffer[t]>>>7-n%8&1)===1},put:function(n,t){for(let i=0;i<t;i++)this.putBit((n>>>t-i-1&1)===1)},getLengthInBits:function(){return this.length},putBit:function(n){const t=Math.floor(this.length/8);this.buffer.length<=t&&this.buffer.push(0),n&&(this.buffer[t]|=128>>>this.length%8),this.length++}},Nr=s,Nr}var wr,uo;function hd(){if(uo)return wr;uo=1;function s(n){if(!n||n<1)throw new Error("BitMatrix size must be defined and greater than 0");this.size=n,this.data=new Uint8Array(n*n),this.reservedBit=new Uint8Array(n*n)}return s.prototype.set=function(n,t,i,a){const r=n*this.size+t;this.data[r]=i,a&&(this.reservedBit[r]=!0)},s.prototype.get=function(n,t){return this.data[n*this.size+t]},s.prototype.xor=function(n,t,i){this.data[n*this.size+t]^=i},s.prototype.isReserved=function(n,t){return this.reservedBit[n*this.size+t]},wr=s,wr}var Sr={},mo;function fd(){return mo||(mo=1,(function(s){const n=qn().getSymbolSize;s.getRowColCoords=function(i){if(i===1)return[];const a=Math.floor(i/7)+2,r=n(i),l=r===145?26:Math.ceil((r-13)/(2*a-2))*2,o=[r-7];for(let d=1;d<a-1;d++)o[d]=o[d-1]-l;return o.push(6),o.reverse()},s.getPositions=function(i){const a=[],r=s.getRowColCoords(i),l=r.length;for(let o=0;o<l;o++)for(let d=0;d<l;d++)o===0&&d===0||o===0&&d===l-1||o===l-1&&d===0||a.push([r[o],r[d]]);return a}})(Sr)),Sr}var kr={},ho;function xd(){if(ho)return kr;ho=1;const s=qn().getSymbolSize,n=7;return kr.getPositions=function(i){const a=s(i);return[[0,0],[a-n,0],[0,a-n]]},kr}var Cr={},fo;function pd(){return fo||(fo=1,(function(s){s.Patterns={PATTERN000:0,PATTERN001:1,PATTERN010:2,PATTERN011:3,PATTERN100:4,PATTERN101:5,PATTERN110:6,PATTERN111:7};const n={N1:3,N2:3,N3:40,N4:10};s.isValid=function(a){return a!=null&&a!==""&&!isNaN(a)&&a>=0&&a<=7},s.from=function(a){return s.isValid(a)?parseInt(a,10):void 0},s.getPenaltyN1=function(a){const r=a.size;let l=0,o=0,d=0,c=null,h=null;for(let m=0;m<r;m++){o=d=0,c=h=null;for(let x=0;x<r;x++){let p=a.get(m,x);p===c?o++:(o>=5&&(l+=n.N1+(o-5)),c=p,o=1),p=a.get(x,m),p===h?d++:(d>=5&&(l+=n.N1+(d-5)),h=p,d=1)}o>=5&&(l+=n.N1+(o-5)),d>=5&&(l+=n.N1+(d-5))}return l},s.getPenaltyN2=function(a){const r=a.size;let l=0;for(let o=0;o<r-1;o++)for(let d=0;d<r-1;d++){const c=a.get(o,d)+a.get(o,d+1)+a.get(o+1,d)+a.get(o+1,d+1);(c===4||c===0)&&l++}return l*n.N2},s.getPenaltyN3=function(a){const r=a.size;let l=0,o=0,d=0;for(let c=0;c<r;c++){o=d=0;for(let h=0;h<r;h++)o=o<<1&2047|a.get(c,h),h>=10&&(o===1488||o===93)&&l++,d=d<<1&2047|a.get(h,c),h>=10&&(d===1488||d===93)&&l++}return l*n.N3},s.getPenaltyN4=function(a){let r=0;const l=a.data.length;for(let d=0;d<l;d++)r+=a.data[d];return Math.abs(Math.ceil(r*100/l/5)-10)*n.N4};function t(i,a,r){switch(i){case s.Patterns.PATTERN000:return(a+r)%2===0;case s.Patterns.PATTERN001:return a%2===0;case s.Patterns.PATTERN010:return r%3===0;case s.Patterns.PATTERN011:return(a+r)%3===0;case s.Patterns.PATTERN100:return(Math.floor(a/2)+Math.floor(r/3))%2===0;case s.Patterns.PATTERN101:return a*r%2+a*r%3===0;case s.Patterns.PATTERN110:return(a*r%2+a*r%3)%2===0;case s.Patterns.PATTERN111:return(a*r%3+(a+r)%2)%2===0;default:throw new Error("bad maskPattern:"+i)}}s.applyMask=function(a,r){const l=r.size;for(let o=0;o<l;o++)for(let d=0;d<l;d++)r.isReserved(d,o)||r.xor(d,o,t(a,d,o))},s.getBestMask=function(a,r){const l=Object.keys(s.Patterns).length;let o=0,d=1/0;for(let c=0;c<l;c++){r(c),s.applyMask(c,a);const h=s.getPenaltyN1(a)+s.getPenaltyN2(a)+s.getPenaltyN3(a)+s.getPenaltyN4(a);s.applyMask(c,a),h<d&&(d=h,o=c)}return o}})(Cr)),Cr}var _a={},xo;function gl(){if(xo)return _a;xo=1;const s=pi(),n=[1,1,1,1,1,1,1,1,1,1,2,2,1,2,2,4,1,2,4,4,2,4,4,4,2,4,6,5,2,4,6,6,2,5,8,8,4,5,8,8,4,5,8,11,4,8,10,11,4,9,12,16,4,9,16,16,6,10,12,18,6,10,17,16,6,11,16,19,6,13,18,21,7,14,21,25,8,16,20,25,8,17,23,25,9,17,23,34,9,18,25,30,10,20,27,32,12,21,29,35,12,23,34,37,12,25,34,40,13,26,35,42,14,28,38,45,15,29,40,48,16,31,43,51,17,33,45,54,18,35,48,57,19,37,51,60,19,38,53,63,20,40,56,66,21,43,59,70,22,45,62,74,24,47,65,77,25,49,68,81],t=[7,10,13,17,10,16,22,28,15,26,36,44,20,36,52,64,26,48,72,88,36,64,96,112,40,72,108,130,48,88,132,156,60,110,160,192,72,130,192,224,80,150,224,264,96,176,260,308,104,198,288,352,120,216,320,384,132,240,360,432,144,280,408,480,168,308,448,532,180,338,504,588,196,364,546,650,224,416,600,700,224,442,644,750,252,476,690,816,270,504,750,900,300,560,810,960,312,588,870,1050,336,644,952,1110,360,700,1020,1200,390,728,1050,1260,420,784,1140,1350,450,812,1200,1440,480,868,1290,1530,510,924,1350,1620,540,980,1440,1710,570,1036,1530,1800,570,1064,1590,1890,600,1120,1680,1980,630,1204,1770,2100,660,1260,1860,2220,720,1316,1950,2310,750,1372,2040,2430];return _a.getBlocksCount=function(a,r){switch(r){case s.L:return n[(a-1)*4+0];case s.M:return n[(a-1)*4+1];case s.Q:return n[(a-1)*4+2];case s.H:return n[(a-1)*4+3];default:return}},_a.getTotalCodewordsCount=function(a,r){switch(r){case s.L:return t[(a-1)*4+0];case s.M:return t[(a-1)*4+1];case s.Q:return t[(a-1)*4+2];case s.H:return t[(a-1)*4+3];default:return}},_a}var Tr={},Na={},po;function bd(){if(po)return Na;po=1;const s=new Uint8Array(512),n=new Uint8Array(256);return(function(){let i=1;for(let a=0;a<255;a++)s[a]=i,n[i]=a,i<<=1,i&256&&(i^=285);for(let a=255;a<512;a++)s[a]=s[a-255]})(),Na.log=function(i){if(i<1)throw new Error("log("+i+")");return n[i]},Na.exp=function(i){return s[i]},Na.mul=function(i,a){return i===0||a===0?0:s[n[i]+n[a]]},Na}var bo;function gd(){return bo||(bo=1,(function(s){const n=bd();s.mul=function(i,a){const r=new Uint8Array(i.length+a.length-1);for(let l=0;l<i.length;l++)for(let o=0;o<a.length;o++)r[l+o]^=n.mul(i[l],a[o]);return r},s.mod=function(i,a){let r=new Uint8Array(i);for(;r.length-a.length>=0;){const l=r[0];for(let d=0;d<a.length;d++)r[d]^=n.mul(a[d],l);let o=0;for(;o<r.length&&r[o]===0;)o++;r=r.slice(o)}return r},s.generateECPolynomial=function(i){let a=new Uint8Array([1]);for(let r=0;r<i;r++)a=s.mul(a,new Uint8Array([1,n.exp(r)]));return a}})(Tr)),Tr}var Dr,go;function yd(){if(go)return Dr;go=1;const s=gd();function n(t){this.genPoly=void 0,this.degree=t,this.degree&&this.initialize(this.degree)}return n.prototype.initialize=function(i){this.degree=i,this.genPoly=s.generateECPolynomial(this.degree)},n.prototype.encode=function(i){if(!this.genPoly)throw new Error("Encoder not initialized");const a=new Uint8Array(i.length+this.degree);a.set(i);const r=s.mod(a,this.genPoly),l=this.degree-r.length;if(l>0){const o=new Uint8Array(this.degree);return o.set(r,l),o}return r},Dr=n,Dr}var Er={},Mr={},Ir={},yo;function yl(){return yo||(yo=1,Ir.isValid=function(n){return!isNaN(n)&&n>=1&&n<=40}),Ir}var tn={},vo;function vl(){if(vo)return tn;vo=1;const s="[0-9]+",n="[A-Z $%*+\\-./:]+";let t="(?:[u3000-u303F]|[u3040-u309F]|[u30A0-u30FF]|[uFF00-uFFEF]|[u4E00-u9FAF]|[u2605-u2606]|[u2190-u2195]|u203B|[u2010u2015u2018u2019u2025u2026u201Cu201Du2225u2260]|[u0391-u0451]|[u00A7u00A8u00B1u00B4u00D7u00F7])+";t=t.replace(/u/g,"\\u");const i="(?:(?![A-Z0-9 $%*+\\-./:]|"+t+`)(?:.|[\r
]))+`;tn.KANJI=new RegExp(t,"g"),tn.BYTE_KANJI=new RegExp("[^A-Z0-9 $%*+\\-./:]+","g"),tn.BYTE=new RegExp(i,"g"),tn.NUMERIC=new RegExp(s,"g"),tn.ALPHANUMERIC=new RegExp(n,"g");const a=new RegExp("^"+t+"$"),r=new RegExp("^"+s+"$"),l=new RegExp("^[A-Z0-9 $%*+\\-./:]+$");return tn.testKanji=function(d){return a.test(d)},tn.testNumeric=function(d){return r.test(d)},tn.testAlphanumeric=function(d){return l.test(d)},tn}var jo;function Vn(){return jo||(jo=1,(function(s){const n=yl(),t=vl();s.NUMERIC={id:"Numeric",bit:1,ccBits:[10,12,14]},s.ALPHANUMERIC={id:"Alphanumeric",bit:2,ccBits:[9,11,13]},s.BYTE={id:"Byte",bit:4,ccBits:[8,16,16]},s.KANJI={id:"Kanji",bit:8,ccBits:[8,10,12]},s.MIXED={bit:-1},s.getCharCountIndicator=function(r,l){if(!r.ccBits)throw new Error("Invalid mode: "+r);if(!n.isValid(l))throw new Error("Invalid version: "+l);return l>=1&&l<10?r.ccBits[0]:l<27?r.ccBits[1]:r.ccBits[2]},s.getBestModeForData=function(r){return t.testNumeric(r)?s.NUMERIC:t.testAlphanumeric(r)?s.ALPHANUMERIC:t.testKanji(r)?s.KANJI:s.BYTE},s.toString=function(r){if(r&&r.id)return r.id;throw new Error("Invalid mode")},s.isValid=function(r){return r&&r.bit&&r.ccBits};function i(a){if(typeof a!="string")throw new Error("Param is not a string");switch(a.toLowerCase()){case"numeric":return s.NUMERIC;case"alphanumeric":return s.ALPHANUMERIC;case"kanji":return s.KANJI;case"byte":return s.BYTE;default:throw new Error("Unknown mode: "+a)}}s.from=function(r,l){if(s.isValid(r))return r;try{return i(r)}catch{return l}}})(Mr)),Mr}var No;function vd(){return No||(No=1,(function(s){const n=qn(),t=gl(),i=pi(),a=Vn(),r=yl(),l=7973,o=n.getBCHDigit(l);function d(x,p,g){for(let w=1;w<=40;w++)if(p<=s.getCapacity(w,g,x))return w}function c(x,p){return a.getCharCountIndicator(x,p)+4}function h(x,p){let g=0;return x.forEach(function(w){const T=c(w.mode,p);g+=T+w.getBitsLength()}),g}function m(x,p){for(let g=1;g<=40;g++)if(h(x,g)<=s.getCapacity(g,p,a.MIXED))return g}s.from=function(p,g){return r.isValid(p)?parseInt(p,10):g},s.getCapacity=function(p,g,w){if(!r.isValid(p))throw new Error("Invalid QR Code version");typeof w>"u"&&(w=a.BYTE);const T=n.getSymbolTotalCodewords(p),S=t.getTotalCodewordsCount(p,g),E=(T-S)*8;if(w===a.MIXED)return E;const I=E-c(w,p);switch(w){case a.NUMERIC:return Math.floor(I/10*3);case a.ALPHANUMERIC:return Math.floor(I/11*2);case a.KANJI:return Math.floor(I/13);case a.BYTE:default:return Math.floor(I/8)}},s.getBestVersionForData=function(p,g){let w;const T=i.from(g,i.M);if(Array.isArray(p)){if(p.length>1)return m(p,T);if(p.length===0)return 1;w=p[0]}else w=p;return d(w.mode,w.getLength(),T)},s.getEncodedBits=function(p){if(!r.isValid(p)||p<7)throw new Error("Invalid QR Code version");let g=p<<12;for(;n.getBCHDigit(g)-o>=0;)g^=l<<n.getBCHDigit(g)-o;return p<<12|g}})(Er)),Er}var Ar={},wo;function jd(){if(wo)return Ar;wo=1;const s=qn(),n=1335,t=21522,i=s.getBCHDigit(n);return Ar.getEncodedBits=function(r,l){const o=r.bit<<3|l;let d=o<<10;for(;s.getBCHDigit(d)-i>=0;)d^=n<<s.getBCHDigit(d)-i;return(o<<10|d)^t},Ar}var Rr={},Pr,So;function Nd(){if(So)return Pr;So=1;const s=Vn();function n(t){this.mode=s.NUMERIC,this.data=t.toString()}return n.getBitsLength=function(i){return 10*Math.floor(i/3)+(i%3?i%3*3+1:0)},n.prototype.getLength=function(){return this.data.length},n.prototype.getBitsLength=function(){return n.getBitsLength(this.data.length)},n.prototype.write=function(i){let a,r,l;for(a=0;a+3<=this.data.length;a+=3)r=this.data.substr(a,3),l=parseInt(r,10),i.put(l,10);const o=this.data.length-a;o>0&&(r=this.data.substr(a),l=parseInt(r,10),i.put(l,o*3+1))},Pr=n,Pr}var Lr,ko;function wd(){if(ko)return Lr;ko=1;const s=Vn(),n=["0","1","2","3","4","5","6","7","8","9","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z"," ","$","%","*","+","-",".","/",":"];function t(i){this.mode=s.ALPHANUMERIC,this.data=i}return t.getBitsLength=function(a){return 11*Math.floor(a/2)+6*(a%2)},t.prototype.getLength=function(){return this.data.length},t.prototype.getBitsLength=function(){return t.getBitsLength(this.data.length)},t.prototype.write=function(a){let r;for(r=0;r+2<=this.data.length;r+=2){let l=n.indexOf(this.data[r])*45;l+=n.indexOf(this.data[r+1]),a.put(l,11)}this.data.length%2&&a.put(n.indexOf(this.data[r]),6)},Lr=t,Lr}var Or,Co;function Sd(){if(Co)return Or;Co=1;const s=Vn();function n(t){this.mode=s.BYTE,typeof t=="string"?this.data=new TextEncoder().encode(t):this.data=new Uint8Array(t)}return n.getBitsLength=function(i){return i*8},n.prototype.getLength=function(){return this.data.length},n.prototype.getBitsLength=function(){return n.getBitsLength(this.data.length)},n.prototype.write=function(t){for(let i=0,a=this.data.length;i<a;i++)t.put(this.data[i],8)},Or=n,Or}var Br,To;function kd(){if(To)return Br;To=1;const s=Vn(),n=qn();function t(i){this.mode=s.KANJI,this.data=i}return t.getBitsLength=function(a){return a*13},t.prototype.getLength=function(){return this.data.length},t.prototype.getBitsLength=function(){return t.getBitsLength(this.data.length)},t.prototype.write=function(i){let a;for(a=0;a<this.data.length;a++){let r=n.toSJIS(this.data[a]);if(r>=33088&&r<=40956)r-=33088;else if(r>=57408&&r<=60351)r-=49472;else throw new Error("Invalid SJIS character: "+this.data[a]+`
Make sure your charset is UTF-8`);r=(r>>>8&255)*192+(r&255),i.put(r,13)}},Br=t,Br}var Ur={exports:{}},Do;function Cd(){return Do||(Do=1,(function(s){var n={single_source_shortest_paths:function(t,i,a){var r={},l={};l[i]=0;var o=n.PriorityQueue.make();o.push(i,0);for(var d,c,h,m,x,p,g,w,T;!o.empty();){d=o.pop(),c=d.value,m=d.cost,x=t[c]||{};for(h in x)x.hasOwnProperty(h)&&(p=x[h],g=m+p,w=l[h],T=typeof l[h]>"u",(T||w>g)&&(l[h]=g,o.push(h,g),r[h]=c))}if(typeof a<"u"&&typeof l[a]>"u"){var S=["Could not find a path from ",i," to ",a,"."].join("");throw new Error(S)}return r},extract_shortest_path_from_predecessor_list:function(t,i){for(var a=[],r=i;r;)a.push(r),t[r],r=t[r];return a.reverse(),a},find_path:function(t,i,a){var r=n.single_source_shortest_paths(t,i,a);return n.extract_shortest_path_from_predecessor_list(r,a)},PriorityQueue:{make:function(t){var i=n.PriorityQueue,a={},r;t=t||{};for(r in i)i.hasOwnProperty(r)&&(a[r]=i[r]);return a.queue=[],a.sorter=t.sorter||i.default_sorter,a},default_sorter:function(t,i){return t.cost-i.cost},push:function(t,i){var a={value:t,cost:i};this.queue.push(a),this.queue.sort(this.sorter)},pop:function(){return this.queue.shift()},empty:function(){return this.queue.length===0}}};s.exports=n})(Ur)),Ur.exports}var Eo;function Td(){return Eo||(Eo=1,(function(s){const n=Vn(),t=Nd(),i=wd(),a=Sd(),r=kd(),l=vl(),o=qn(),d=Cd();function c(S){return unescape(encodeURIComponent(S)).length}function h(S,E,I){const M=[];let P;for(;(P=S.exec(I))!==null;)M.push({data:P[0],index:P.index,mode:E,length:P[0].length});return M}function m(S){const E=h(l.NUMERIC,n.NUMERIC,S),I=h(l.ALPHANUMERIC,n.ALPHANUMERIC,S);let M,P;return o.isKanjiModeEnabled()?(M=h(l.BYTE,n.BYTE,S),P=h(l.KANJI,n.KANJI,S)):(M=h(l.BYTE_KANJI,n.BYTE,S),P=[]),E.concat(I,M,P).sort(function(v,b){return v.index-b.index}).map(function(v){return{data:v.data,mode:v.mode,length:v.length}})}function x(S,E){switch(E){case n.NUMERIC:return t.getBitsLength(S);case n.ALPHANUMERIC:return i.getBitsLength(S);case n.KANJI:return r.getBitsLength(S);case n.BYTE:return a.getBitsLength(S)}}function p(S){return S.reduce(function(E,I){const M=E.length-1>=0?E[E.length-1]:null;return M&&M.mode===I.mode?(E[E.length-1].data+=I.data,E):(E.push(I),E)},[])}function g(S){const E=[];for(let I=0;I<S.length;I++){const M=S[I];switch(M.mode){case n.NUMERIC:E.push([M,{data:M.data,mode:n.ALPHANUMERIC,length:M.length},{data:M.data,mode:n.BYTE,length:M.length}]);break;case n.ALPHANUMERIC:E.push([M,{data:M.data,mode:n.BYTE,length:M.length}]);break;case n.KANJI:E.push([M,{data:M.data,mode:n.BYTE,length:c(M.data)}]);break;case n.BYTE:E.push([{data:M.data,mode:n.BYTE,length:c(M.data)}])}}return E}function w(S,E){const I={},M={start:{}};let P=["start"];for(let A=0;A<S.length;A++){const v=S[A],b=[];for(let H=0;H<v.length;H++){const W=v[H],R=""+A+H;b.push(R),I[R]={node:W,lastCount:0},M[R]={};for(let F=0;F<P.length;F++){const D=P[F];I[D]&&I[D].node.mode===W.mode?(M[D][R]=x(I[D].lastCount+W.length,W.mode)-x(I[D].lastCount,W.mode),I[D].lastCount+=W.length):(I[D]&&(I[D].lastCount=W.length),M[D][R]=x(W.length,W.mode)+4+n.getCharCountIndicator(W.mode,E))}}P=b}for(let A=0;A<P.length;A++)M[P[A]].end=0;return{map:M,table:I}}function T(S,E){let I;const M=n.getBestModeForData(S);if(I=n.from(E,M),I!==n.BYTE&&I.bit<M.bit)throw new Error('"'+S+'" cannot be encoded with mode '+n.toString(I)+`.
 Suggested mode is: `+n.toString(M));switch(I===n.KANJI&&!o.isKanjiModeEnabled()&&(I=n.BYTE),I){case n.NUMERIC:return new t(S);case n.ALPHANUMERIC:return new i(S);case n.KANJI:return new r(S);case n.BYTE:return new a(S)}}s.fromArray=function(E){return E.reduce(function(I,M){return typeof M=="string"?I.push(T(M,null)):M.data&&I.push(T(M.data,M.mode)),I},[])},s.fromString=function(E,I){const M=m(E,o.isKanjiModeEnabled()),P=g(M),A=w(P,I),v=d.find_path(A.map,"start","end"),b=[];for(let H=1;H<v.length-1;H++)b.push(A.table[v[H]].node);return s.fromArray(p(b))},s.rawSplit=function(E){return s.fromArray(m(E,o.isKanjiModeEnabled()))}})(Rr)),Rr}var Mo;function Dd(){if(Mo)return vr;Mo=1;const s=qn(),n=pi(),t=md(),i=hd(),a=fd(),r=xd(),l=pd(),o=gl(),d=yd(),c=vd(),h=jd(),m=Vn(),x=Td();function p(A,v){const b=A.size,H=r.getPositions(v);for(let W=0;W<H.length;W++){const R=H[W][0],F=H[W][1];for(let D=-1;D<=7;D++)if(!(R+D<=-1||b<=R+D))for(let Q=-1;Q<=7;Q++)F+Q<=-1||b<=F+Q||(D>=0&&D<=6&&(Q===0||Q===6)||Q>=0&&Q<=6&&(D===0||D===6)||D>=2&&D<=4&&Q>=2&&Q<=4?A.set(R+D,F+Q,!0,!0):A.set(R+D,F+Q,!1,!0))}}function g(A){const v=A.size;for(let b=8;b<v-8;b++){const H=b%2===0;A.set(b,6,H,!0),A.set(6,b,H,!0)}}function w(A,v){const b=a.getPositions(v);for(let H=0;H<b.length;H++){const W=b[H][0],R=b[H][1];for(let F=-2;F<=2;F++)for(let D=-2;D<=2;D++)F===-2||F===2||D===-2||D===2||F===0&&D===0?A.set(W+F,R+D,!0,!0):A.set(W+F,R+D,!1,!0)}}function T(A,v){const b=A.size,H=c.getEncodedBits(v);let W,R,F;for(let D=0;D<18;D++)W=Math.floor(D/3),R=D%3+b-8-3,F=(H>>D&1)===1,A.set(W,R,F,!0),A.set(R,W,F,!0)}function S(A,v,b){const H=A.size,W=h.getEncodedBits(v,b);let R,F;for(R=0;R<15;R++)F=(W>>R&1)===1,R<6?A.set(R,8,F,!0):R<8?A.set(R+1,8,F,!0):A.set(H-15+R,8,F,!0),R<8?A.set(8,H-R-1,F,!0):R<9?A.set(8,15-R-1+1,F,!0):A.set(8,15-R-1,F,!0);A.set(H-8,8,1,!0)}function E(A,v){const b=A.size;let H=-1,W=b-1,R=7,F=0;for(let D=b-1;D>0;D-=2)for(D===6&&D--;;){for(let Q=0;Q<2;Q++)if(!A.isReserved(W,D-Q)){let me=!1;F<v.length&&(me=(v[F]>>>R&1)===1),A.set(W,D-Q,me),R--,R===-1&&(F++,R=7)}if(W+=H,W<0||b<=W){W-=H,H=-H;break}}}function I(A,v,b){const H=new t;b.forEach(function(Q){H.put(Q.mode.bit,4),H.put(Q.getLength(),m.getCharCountIndicator(Q.mode,A)),Q.write(H)});const W=s.getSymbolTotalCodewords(A),R=o.getTotalCodewordsCount(A,v),F=(W-R)*8;for(H.getLengthInBits()+4<=F&&H.put(0,4);H.getLengthInBits()%8!==0;)H.putBit(0);const D=(F-H.getLengthInBits())/8;for(let Q=0;Q<D;Q++)H.put(Q%2?17:236,8);return M(H,A,v)}function M(A,v,b){const H=s.getSymbolTotalCodewords(v),W=o.getTotalCodewordsCount(v,b),R=H-W,F=o.getBlocksCount(v,b),D=H%F,Q=F-D,me=Math.floor(H/F),ue=Math.floor(R/F),ke=ue+1,_e=me-ue,Pe=new d(_e);let Le=0;const ve=new Array(F),Ee=new Array(F);let $=0;const te=new Uint8Array(A.buffer);for(let Ie=0;Ie<F;Ie++){const lt=Ie<Q?ue:ke;ve[Ie]=te.slice(Le,Le+lt),Ee[Ie]=Pe.encode(ve[Ie]),Le+=lt,$=Math.max($,lt)}const oe=new Uint8Array(H);let He=0,We,we;for(We=0;We<$;We++)for(we=0;we<F;we++)We<ve[we].length&&(oe[He++]=ve[we][We]);for(We=0;We<_e;We++)for(we=0;we<F;we++)oe[He++]=Ee[we][We];return oe}function P(A,v,b,H){let W;if(Array.isArray(A))W=x.fromArray(A);else if(typeof A=="string"){let me=v;if(!me){const ue=x.rawSplit(A);me=c.getBestVersionForData(ue,b)}W=x.fromString(A,me||40)}else throw new Error("Invalid data");const R=c.getBestVersionForData(W,b);if(!R)throw new Error("The amount of data is too big to be stored in a QR Code");if(!v)v=R;else if(v<R)throw new Error(`
The chosen QR Code version cannot contain this amount of data.
Minimum version required to store current data is: `+R+`.
`);const F=I(v,b,W),D=s.getSymbolSize(v),Q=new i(D);return p(Q,v),g(Q),w(Q,v),S(Q,b,0),v>=7&&T(Q,v),E(Q,F),isNaN(H)&&(H=l.getBestMask(Q,S.bind(null,Q,b))),l.applyMask(H,Q),S(Q,b,H),{modules:Q,version:v,errorCorrectionLevel:b,maskPattern:H,segments:W}}return vr.create=function(v,b){if(typeof v>"u"||v==="")throw new Error("No input text");let H=n.M,W,R;return typeof b<"u"&&(H=n.from(b.errorCorrectionLevel,n.M),W=c.from(b.version),R=l.from(b.maskPattern),b.toSJISFunc&&s.setToSJISFunction(b.toSJISFunc)),P(v,W,H,R)},vr}var $r={},_r={},Io;function jl(){return Io||(Io=1,(function(s){function n(t){if(typeof t=="number"&&(t=t.toString()),typeof t!="string")throw new Error("Color should be defined as hex string");let i=t.slice().replace("#","").split("");if(i.length<3||i.length===5||i.length>8)throw new Error("Invalid hex color: "+t);(i.length===3||i.length===4)&&(i=Array.prototype.concat.apply([],i.map(function(r){return[r,r]}))),i.length===6&&i.push("F","F");const a=parseInt(i.join(""),16);return{r:a>>24&255,g:a>>16&255,b:a>>8&255,a:a&255,hex:"#"+i.slice(0,6).join("")}}s.getOptions=function(i){i||(i={}),i.color||(i.color={});const a=typeof i.margin>"u"||i.margin===null||i.margin<0?4:i.margin,r=i.width&&i.width>=21?i.width:void 0,l=i.scale||4;return{width:r,scale:r?4:l,margin:a,color:{dark:n(i.color.dark||"#000000ff"),light:n(i.color.light||"#ffffffff")},type:i.type,rendererOpts:i.rendererOpts||{}}},s.getScale=function(i,a){return a.width&&a.width>=i+a.margin*2?a.width/(i+a.margin*2):a.scale},s.getImageWidth=function(i,a){const r=s.getScale(i,a);return Math.floor((i+a.margin*2)*r)},s.qrToImageData=function(i,a,r){const l=a.modules.size,o=a.modules.data,d=s.getScale(l,r),c=Math.floor((l+r.margin*2)*d),h=r.margin*d,m=[r.color.light,r.color.dark];for(let x=0;x<c;x++)for(let p=0;p<c;p++){let g=(x*c+p)*4,w=r.color.light;if(x>=h&&p>=h&&x<c-h&&p<c-h){const T=Math.floor((x-h)/d),S=Math.floor((p-h)/d);w=m[o[T*l+S]?1:0]}i[g++]=w.r,i[g++]=w.g,i[g++]=w.b,i[g]=w.a}}})(_r)),_r}var Ao;function Ed(){return Ao||(Ao=1,(function(s){const n=jl();function t(a,r,l){a.clearRect(0,0,r.width,r.height),r.style||(r.style={}),r.height=l,r.width=l,r.style.height=l+"px",r.style.width=l+"px"}function i(){try{return document.createElement("canvas")}catch{throw new Error("You need to specify a canvas element")}}s.render=function(r,l,o){let d=o,c=l;typeof d>"u"&&(!l||!l.getContext)&&(d=l,l=void 0),l||(c=i()),d=n.getOptions(d);const h=n.getImageWidth(r.modules.size,d),m=c.getContext("2d"),x=m.createImageData(h,h);return n.qrToImageData(x.data,r,d),t(m,c,h),m.putImageData(x,0,0),c},s.renderToDataURL=function(r,l,o){let d=o;typeof d>"u"&&(!l||!l.getContext)&&(d=l,l=void 0),d||(d={});const c=s.render(r,l,d),h=d.type||"image/png",m=d.rendererOpts||{};return c.toDataURL(h,m.quality)}})($r)),$r}var Fr={},Ro;function Md(){if(Ro)return Fr;Ro=1;const s=jl();function n(a,r){const l=a.a/255,o=r+'="'+a.hex+'"';return l<1?o+" "+r+'-opacity="'+l.toFixed(2).slice(1)+'"':o}function t(a,r,l){let o=a+r;return typeof l<"u"&&(o+=" "+l),o}function i(a,r,l){let o="",d=0,c=!1,h=0;for(let m=0;m<a.length;m++){const x=Math.floor(m%r),p=Math.floor(m/r);!x&&!c&&(c=!0),a[m]?(h++,m>0&&x>0&&a[m-1]||(o+=c?t("M",x+l,.5+p+l):t("m",d,0),d=0,c=!1),x+1<r&&a[m+1]||(o+=t("h",h),h=0)):d++}return o}return Fr.render=function(r,l,o){const d=s.getOptions(l),c=r.modules.size,h=r.modules.data,m=c+d.margin*2,x=d.color.light.a?"<path "+n(d.color.light,"fill")+' d="M0 0h'+m+"v"+m+'H0z"/>':"",p="<path "+n(d.color.dark,"stroke")+' d="'+i(h,c,d.margin)+'"/>',g='viewBox="0 0 '+m+" "+m+'"',T='<svg xmlns="http://www.w3.org/2000/svg" '+(d.width?'width="'+d.width+'" height="'+d.width+'" ':"")+g+' shape-rendering="crispEdges">'+x+p+`</svg>
`;return typeof o=="function"&&o(null,T),T},Fr}var Po;function Id(){if(Po)return ua;Po=1;const s=ud(),n=Dd(),t=Ed(),i=Md();function a(r,l,o,d,c){const h=[].slice.call(arguments,1),m=h.length,x=typeof h[m-1]=="function";if(!x&&!s())throw new Error("Callback required as last argument");if(x){if(m<2)throw new Error("Too few arguments provided");m===2?(c=o,o=l,l=d=void 0):m===3&&(l.getContext&&typeof c>"u"?(c=d,d=void 0):(c=d,d=o,o=l,l=void 0))}else{if(m<1)throw new Error("Too few arguments provided");return m===1?(o=l,l=d=void 0):m===2&&!l.getContext&&(d=o,o=l,l=void 0),new Promise(function(p,g){try{const w=n.create(o,d);p(r(w,l,d))}catch(w){g(w)}})}try{const p=n.create(o,d);c(null,r(p,l,d))}catch(p){c(p)}}return ua.create=n.create,ua.toCanvas=a.bind(null,t.render),ua.toDataURL=a.bind(null,t.renderToDataURL),ua.toString=a.bind(null,function(r,l,o){return i.render(r,o)}),ua}var Ad=Id();const Rd=hi(Ad);async function Lo(s){return new Promise((n,t)=>{const i=new Image;i.onload=()=>n(i),i.onerror=a=>t(a),i.src=s})}async function Pd(s,n){const[t,i]=await Promise.all([Lo(s),Lo(n.logoUrl)]),a=Math.max(160,t.width||160),r=Math.max(160,t.height||160),l=document.createElement("canvas");l.width=a,l.height=r;const o=l.getContext("2d");o.fillStyle="#ffffff",o.fillRect(0,0,a,r),o.imageSmoothingEnabled=!1,o.drawImage(t,0,0,a,r);const d=a/2,c=r/2,h=Math.max(.14,Math.min(.28,n.logoScale??.2)),m=Math.round(Math.min(a,r)*h),x=Math.round(d-m/2),p=Math.round(c-m/2);if(n.mask!==!1){const g=n.shape||"rounded-rect",w=Math.max(2,Math.round(m*.08)),T=x-w,S=p-w,E=m+w*2,I=m+w*2;if(o.beginPath(),g==="circle"){const M=Math.min(E,I)/2;o.arc(T+E/2,S+I/2,M,0,Math.PI*2)}else if(g==="rect")o.rect(T,S,E,I);else{const M=Math.max(4,n.radiusPx??Math.round(m*.12)),P=Math.min(M,E/2,I/2);o.moveTo(T+P,S),o.arcTo(T+E,S,T+E,S+I,P),o.arcTo(T+E,S+I,T,S+I,P),o.arcTo(T,S+I,T,S,P),o.arcTo(T,S,T+E,S,P),o.closePath()}o.fillStyle="#ffffff",o.fill(),o.lineWidth=1,o.strokeStyle=n.maskStroke||"rgba(0,0,0,0.12)",o.stroke()}if(o.save(),n.shape==="circle"){const g=m/2;o.beginPath(),o.arc(x+g,p+g,g,0,Math.PI*2),o.clip()}return o.imageSmoothingEnabled=!0,o.drawImage(i,x,p,m,m),o.restore(),l.toDataURL("image/png")}async function Nl(s,n){const{width:t=256,margin:i=2,errorCorrectionLevel:a="H",color:r={dark:"#000000",light:"#ffffff"},logo:l}=n||{},o=await Rd.toDataURL(s,{width:t,margin:i,errorCorrectionLevel:a,color:r});return l?Pd(o,l):o}const Ld={};function bi(s,n){let t;try{t=s()}catch{return}return{getItem:a=>{var r;const l=d=>d===null?null:JSON.parse(d,void 0),o=(r=t.getItem(a))!=null?r:null;return o instanceof Promise?o.then(l):l(o)},setItem:(a,r)=>t.setItem(a,JSON.stringify(r,void 0)),removeItem:a=>t.removeItem(a)}}const Ea=s=>n=>{try{const t=s(n);return t instanceof Promise?t:{then(i){return Ea(i)(t)},catch(i){return this}}}catch(t){return{then(i){return this},catch(i){return Ea(i)(t)}}}},Od=(s,n)=>(t,i,a)=>{let r={getStorage:()=>localStorage,serialize:JSON.stringify,deserialize:JSON.parse,partialize:T=>T,version:0,merge:(T,S)=>({...S,...T}),...n},l=!1;const o=new Set,d=new Set;let c;try{c=r.getStorage()}catch{}if(!c)return s((...T)=>{console.warn(`[zustand persist middleware] Unable to update item '${r.name}', the given storage is currently unavailable.`),t(...T)},i,a);const h=Ea(r.serialize),m=()=>{const T=r.partialize({...i()});let S;const E=h({state:T,version:r.version}).then(I=>c.setItem(r.name,I)).catch(I=>{S=I});if(S)throw S;return E},x=a.setState;a.setState=(T,S)=>{x(T,S),m()};const p=s((...T)=>{t(...T),m()},i,a);let g;const w=()=>{var T;if(!c)return;l=!1,o.forEach(E=>E(i()));const S=((T=r.onRehydrateStorage)==null?void 0:T.call(r,i()))||void 0;return Ea(c.getItem.bind(c))(r.name).then(E=>{if(E)return r.deserialize(E)}).then(E=>{if(E)if(typeof E.version=="number"&&E.version!==r.version){if(r.migrate)return r.migrate(E.state,E.version);console.error("State loaded from storage couldn't be migrated since no migrate function was provided")}else return E.state}).then(E=>{var I;return g=r.merge(E,(I=i())!=null?I:p),t(g,!0),m()}).then(()=>{S?.(g,void 0),l=!0,d.forEach(E=>E(g))}).catch(E=>{S?.(void 0,E)})};return a.persist={setOptions:T=>{r={...r,...T},T.getStorage&&(c=T.getStorage())},clearStorage:()=>{c?.removeItem(r.name)},getOptions:()=>r,rehydrate:()=>w(),hasHydrated:()=>l,onHydrate:T=>(o.add(T),()=>{o.delete(T)}),onFinishHydration:T=>(d.add(T),()=>{d.delete(T)})},w(),g||p},Bd=(s,n)=>(t,i,a)=>{let r={storage:bi(()=>localStorage),partialize:w=>w,version:0,merge:(w,T)=>({...T,...w}),...n},l=!1;const o=new Set,d=new Set;let c=r.storage;if(!c)return s((...w)=>{console.warn(`[zustand persist middleware] Unable to update item '${r.name}', the given storage is currently unavailable.`),t(...w)},i,a);const h=()=>{const w=r.partialize({...i()});return c.setItem(r.name,{state:w,version:r.version})},m=a.setState;a.setState=(w,T)=>{m(w,T),h()};const x=s((...w)=>{t(...w),h()},i,a);a.getInitialState=()=>x;let p;const g=()=>{var w,T;if(!c)return;l=!1,o.forEach(E=>{var I;return E((I=i())!=null?I:x)});const S=((T=r.onRehydrateStorage)==null?void 0:T.call(r,(w=i())!=null?w:x))||void 0;return Ea(c.getItem.bind(c))(r.name).then(E=>{if(E)if(typeof E.version=="number"&&E.version!==r.version){if(r.migrate)return[!0,r.migrate(E.state,E.version)];console.error("State loaded from storage couldn't be migrated since no migrate function was provided")}else return[!1,E.state];return[!1,void 0]}).then(E=>{var I;const[M,P]=E;if(p=r.merge(P,(I=i())!=null?I:x),t(p,!0),M)return h()}).then(()=>{S?.(p,void 0),p=i(),l=!0,d.forEach(E=>E(p))}).catch(E=>{S?.(void 0,E)})};return a.persist={setOptions:w=>{r={...r,...w},w.storage&&(c=w.storage)},clearStorage:()=>{c?.removeItem(r.name)},getOptions:()=>r,rehydrate:()=>g(),hasHydrated:()=>l,onHydrate:w=>(o.add(w),()=>{o.delete(w)}),onFinishHydration:w=>(d.add(w),()=>{d.delete(w)})},r.skipHydration||g(),p||x},Ud=(s,n)=>"getStorage"in n||"serialize"in n||"deserialize"in n?((Ld?"production":void 0)!=="production"&&console.warn("[DEPRECATED] `getStorage`, `serialize` and `deserialize` options are deprecated. Use `storage` option instead."),Od(s,n)):Bd(s,n),wl=Ud,Ka=Js()(wl((s,n)=>({H:null,createdAt:null,errorPx:null,imageSize:null,anchors:null,locked:!1,_hydrated:!1,setCalibration:t=>s(i=>({...i,...t})),reset:()=>s({H:null,createdAt:null,errorPx:null,imageSize:null,anchors:null,locked:!1})}),{name:"ndn-calibration-v1",storage:bi(()=>localStorage),onRehydrateStorage:()=>(s,n)=>{if(!(n||!s))try{if(s&&!s.H){const t=localStorage.getItem("ndn:calibration:v1");if(t){const i=JSON.parse(t);i&&(i.H||i.imageSize)&&s.setCalibration({H:i.H??null,createdAt:i.createdAt??null,errorPx:i.errorPx??null,imageSize:i.imageSize??null,anchors:i.anchors??null,locked:!!i.locked})}}s._hydrated=!0}catch{}}}));let Hr=null,Wr=null,zr=null,qr=null;const Gn=Js()(wl((s,n)=>({isStreaming:!1,mode:"local",pairingCode:null,expiresAt:null,isPaired:!1,mobileUrl:null,showOverlay:!0,setStreaming:t=>{console.log("[CAMERA_SESSION] setStreaming:",t),s({isStreaming:t})},setMode:t=>{console.log("[CAMERA_SESSION] setMode:",t),s({mode:t})},setPairingCode:t=>s({pairingCode:t}),setExpiresAt:t=>s({expiresAt:t}),setPaired:t=>s({isPaired:t}),setMobileUrl:t=>s({mobileUrl:t}),setShowOverlay:t=>s({showOverlay:!!t}),setMediaStream:t=>{Wr=t},getMediaStream:()=>Wr,setPcRef:t=>{zr=t},getPcRef:()=>zr,setWsRef:t=>{qr=t},getWsRef:()=>qr,getVideoElementRef:()=>{const t=Hr;return t||console.warn("[cameraSession] âš ï¸ getVideoElementRef called but ref is NULL"),t},setVideoElementRef:t=>{t?console.log("[cameraSession] âœ… setVideoElementRef called - storing HTMLVideoElement",{tagName:t.tagName,hasStream:!!t.srcObject}):console.log("[cameraSession] ðŸ›‘ setVideoElementRef called - clearing ref"),Hr=t},clearSession:()=>{Hr=null,Wr=null,zr=null,qr=null,s({isStreaming:!1,pairingCode:null,expiresAt:null,isPaired:!1,mobileUrl:null})}}),{name:"ndn-camera-session",storage:bi(()=>localStorage),partialize:s=>({isStreaming:s.isStreaming,mode:s.mode,pairingCode:s.pairingCode,expiresAt:s.expiresAt,isPaired:s.isPaired,mobileUrl:s.mobileUrl,showOverlay:s.showOverlay})})),Ge={bullInner:6.35,bullOuter:15.9,trebleInner:99,trebleOuter:107,doubleInner:162,doubleOuter:170},$d=[20,1,18,4,13,6,10,15,2,17,3,19,7,16,8,11,14,9,12,5];function Wn(s,n){const t=n.x,i=n.y,a=s[6]*t+s[7]*i+s[8],r=(s[0]*t+s[1]*i+s[2])/a,l=(s[3]*t+s[4]*i+s[5])/a;return{x:r,y:l}}function _d(s,n,t){return[n*s[0],n*s[1],n*s[2],t*s[3],t*s[4],t*s[5],s[6],s[7],s[8]]}function Fd(s){const n=s,t=n[0],i=n[1],a=n[2],r=n[3],l=n[4],o=n[5],d=n[6],c=n[7],h=n[8],m=l*h-o*c,x=a*c-i*h,p=i*o-a*l,g=o*d-r*h,w=t*h-a*d,T=a*r-t*o,S=r*c-l*d,E=i*d-t*c,I=t*l-i*r,M=t*m+i*g+a*S;if(Math.abs(M)<1e-12)throw new Error("Singular homography");return[m/M,x/M,p/M,g/M,w/M,T/M,S/M,E/M,I/M]}function si(s,n){if(s.length<4||n.length<4)throw new Error("Need at least 4 correspondences");if(s.length!==n.length)throw new Error("Correspondences must have equal length");const t=[],i=[];for(let l=0;l<s.length;l++){const{x:o,y:d}=s[l],{x:c,y:h}=n[l];t.push([o,d,1,0,0,0,-c*o,-c*d]),i.push(c),t.push([0,0,0,o,d,1,-h*o,-h*d]),i.push(h)}const a=Hd(t,i);return[a[0],a[1],a[2],a[3],a[4],a[5],a[6],a[7],1]}function Hd(s,n){const t=s.length,i=s[0].length,a=Array.from({length:i},()=>new Array(i).fill(0)),r=new Array(i).fill(0);for(let l=0;l<t;l++)for(let o=0;o<i;o++){r[o]+=s[l][o]*n[l];for(let d=0;d<i;d++)a[o][d]+=s[l][o]*s[l][d]}return Wd(a,r)}function Wd(s,n){const t=n.length,i=s.map((r,l)=>r.concat([n[l]]));for(let r=0;r<t;r++){let l=r;for(let o=r+1;o<t;o++)Math.abs(i[o][r])>Math.abs(i[l][r])&&(l=o);if(Math.abs(i[l][r])<1e-12)throw new Error("Singular matrix");if(l!==r){const o=i[r];i[r]=i[l],i[l]=o}for(let o=r+1;o<t;o++){const d=i[o][r]/i[r][r];for(let c=r;c<=t;c++)i[o][c]-=d*i[r][c]}}const a=new Array(t).fill(0);for(let r=t-1;r>=0;r--){let l=i[r][t];for(let o=r+1;o<t;o++)l-=i[r][o]*a[o];a[r]=l/i[r][r]}return a}function wa(){const s=Ge.doubleOuter;return[{x:0,y:-s},{x:s,y:0},{x:0,y:s},{x:-s,y:0},{x:0,y:0},{x:0,y:-15.9}]}function Sl(s,n,t=256){const i=[];for(let a=0;a<t;a++){const r=a/t*Math.PI*2,l=Wn(s,{x:n*Math.cos(r),y:n*Math.sin(r)});i.push(l)}return i}function ni(s,n,t){let i=0;for(let a=0;a<n.length;a++){const r=Wn(s,n[a]),l=r.x-t[a].x,o=r.y-t[a].y;i+=l*l+o*o}return Math.sqrt(i/n.length)}function kl(s,n){const t=Fd(s);return Wn(t,n)}function ai(s){const n=Math.hypot(s.x,s.y);let i=Math.atan2(s.y,s.x)*180/Math.PI;i=(i+360+90)%360;const a=$d[Math.floor((360-i)%360/18)];return n<=Ge.bullInner?{base:50,ring:"INNER_BULL",sector:25,mult:2}:n<=Ge.bullOuter?{base:25,ring:"BULL",sector:25,mult:1}:n>=Ge.doubleOuter?{base:0,ring:"MISS",sector:null,mult:0}:n>=Ge.doubleInner?{base:a*2,ring:"DOUBLE",sector:a,mult:2}:n>=Ge.trebleOuter?{base:a,ring:"SINGLE",sector:a,mult:1}:n>=Ge.trebleInner?{base:a*3,ring:"TRIPLE",sector:a,mult:3}:{base:a,ring:"SINGLE",sector:a,mult:1}}function Cl(s,n,t="#10b981",i=2){if(n.length){s.save(),s.strokeStyle=t,s.lineWidth=i,s.beginPath(),s.moveTo(n[0].x,n[0].y);for(let a=1;a<n.length;a++)s.lineTo(n[a].x,n[a].y);s.closePath(),s.stroke(),s.restore()}}function Oo(s,n,t="#f59e0b"){s.save(),s.strokeStyle=t,s.lineWidth=2,s.beginPath(),s.moveTo(n.x-8,n.y),s.lineTo(n.x+8,n.y),s.moveTo(n.x,n.y-8),s.lineTo(n.x,n.y+8),s.stroke(),s.restore()}function qa(s,n,t){return Math.max(n,Math.min(t,s))}function zd(s,n,t){const{width:i,data:a}=s,r=[[-1,0,1],[-2,0,2],[-1,0,1]],l=[[-1,-2,-1],[0,0,0],[1,2,1]];let o=0,d=0;for(let c=-1;c<=1;c++)for(let h=-1;h<=1;h++){const m=qa(n+h,0,i-1),p=(qa(t+c,0,s.height-1)*i+m)*4,g=a[p],w=a[p+1],T=a[p+2],S=.299*g+.587*w+.114*T;o+=S*r[c+1][h+1],d+=S*l[c+1][h+1]}return Math.hypot(o,d)}function qd(s,n,t=6){const a=s.getContext("2d").getImageData(0,0,s.width,s.height),r=qa(Math.round(n.x),1,s.width-2),l=qa(Math.round(n.y),1,s.height-2);let o={x:r,y:l,mag:-1};for(let d=l-t;d<=l+t;d++)for(let c=r-t;c<=r+t;c++){if(c<=0||d<=0||c>=s.width-1||d>=s.height-1)continue;const h=zd(a,c,d);h>o.mag&&(o={x:c,y:d,mag:h})}return{x:o.x,y:o.y}}var Vr,Bo;function Tl(){if(Bo)return Vr;Bo=1;var s=s||{};return s.Image=function(n,t,i){this.width=n||0,this.height=t||0,this.data=i||[]},s.grayscale=function(n,t){for(var i=n.data,a=t.data,r=i.length,l=0,o=0;l<r;l+=4)a[o++]=i[l]*.299+i[l+1]*.587+i[l+2]*.114+.5&255;return t.width=n.width,t.height=n.height,t},s.threshold=function(n,t,i){var a=n.data,r=t.data,l=a.length,o=[],d;for(d=0;d<256;++d)o[d]=d<=i?0:255;for(d=0;d<l;++d)r[d]=o[a[d]];return t.width=n.width,t.height=n.height,t},s.adaptiveThreshold=function(n,t,i,a){var r=n.data,l=t.data,o=r.length,d=[],c;for(s.stackBoxBlur(n,t,i),c=0;c<768;++c)d[c]=c-255<=-a?255:0;for(c=0;c<o;++c)l[c]=d[r[c]-l[c]+255];return t.width=n.width,t.height=n.height,t},s.otsu=function(n){var t=n.data,i=t.length,a=[],r=0,l=0,o=0,d=0,c=0,h=0,m,x,p;for(p=0;p<256;++p)a[p]=0;for(p=0;p<i;++p)a[t[p]]++;for(p=0;p<256;++p)l+=a[p]*p;for(p=0;p<256;++p)if(d+=a[p],d!==0){if(c=i-d,c===0)break;o+=a[p]*p,m=o/d-(l-o)/c,x=d*c*m*m,x>h&&(h=x,r=p)}return r},s.stackBoxBlurMult=[1,171,205,293,57,373,79,137,241,27,391,357,41,19,283,265],s.stackBoxBlurShift=[0,9,10,11,9,12,10,11,12,9,13,13,10,9,13,13],s.BlurStack=function(){this.color=0,this.next=null},s.stackBoxBlur=function(n,t,i){var a=n.data,r=t.data,l=n.height,o=n.width,d=l-1,c=o-1,h=i+i+1,m=i+1,x=s.stackBoxBlurMult[i],p=s.stackBoxBlurShift[i],g,w,T,S,E,I,M,P,A,v;for(g=w=new s.BlurStack,v=1;v<h;++v)g=g.next=new s.BlurStack;for(g.next=w,E=0,A=0;A<l;++A){for(I=E,T=a[E],S=m*T,g=w,v=0;v<m;++v)g.color=T,g=g.next;for(v=1;v<m;++v)g.color=a[E+v],S+=g.color,g=g.next;for(g=w,P=0;P<o;++P)r[E++]=S*x>>>p,M=P+m,M=I+(M<c?M:c),S-=g.color-a[M],g.color=a[M],g=g.next}for(P=0;P<o;++P){for(E=P,I=E+o,T=r[E],S=m*T,g=w,v=0;v<m;++v)g.color=T,g=g.next;for(v=1;v<m;++v)g.color=r[I],S+=g.color,g=g.next,I+=o;for(g=w,A=0;A<l;++A)r[E]=S*x>>>p,M=A+m,M=P+(M<d?M:d)*o,S-=g.color-r[M],g.color=r[M],g=g.next,E+=o}return t},s.gaussianBlur=function(n,t,i,a){var r=s.gaussianKernel(a);return t.width=n.width,t.height=n.height,i.width=n.width,i.height=n.height,s.gaussianBlurFilter(n,i,r,!0),s.gaussianBlurFilter(i,t,r,!1),t},s.gaussianBlurFilter=function(n,t,i,a){var r=n.data,l=t.data,o=n.height,d=n.width,c=0,h=i.length>>1,m,x,p,g,w;for(p=0;p<o;++p)for(g=0;g<d;++g){for(x=0,w=-h;w<=h;++w)a?(m=c+w,(g+w<0||g+w>=d)&&(m=c)):(m=c+w*d,(p+w<0||p+w>=o)&&(m=c)),x+=i[h+w]*r[m];l[c++]=a?x:x+.5&255}return t},s.gaussianKernel=function(n){var t=[[1],[.25,.5,.25],[.0625,.25,.375,.25,.0625],[.03125,.109375,.21875,.28125,.21875,.109375,.03125]],i=[],a,r,l,o,d,c;if(n<=7&&n%2===1)i=t[n>>1];else{for(a=(n-1)*.5,r=.8+.3*(a-1),l=-.5/(r*r),o=0,c=0;c<n;++c)d=c-a,o+=i[c]=Math.exp(l*d*d);for(o=1/o,c=0;c<n;++c)i[c]*=o}return i},s.findContours=function(n,t){var i=n.width,a=n.height,r=[],l,o,d,c,h,m,x,p,g;for(l=s.binaryBorder(n,t),o=s.neighborhoodDeltas(i+2),d=i+3,h=1,p=0;p<a;++p,d+=2)for(g=0;g<i;++g,++d)c=l[d],c!==0&&(m=x=!1,c===1&&l[d-1]===0?m=!0:c>=1&&l[d+1]===0&&(x=!0),(m||x)&&(++h,r.push(s.borderFollowing(l,d,h,{x:g,y:p},x,o))));return r},s.borderFollowing=function(n,t,i,a,r,l){var o=[],d,c,h,m,x;o.hole=r,m=x=r?0:4;do if(m=m-1&7,d=t+l[m],n[d]!==0)break;while(m!==x);if(m===x)n[t]=-i,o.push({x:a.x,y:a.y});else for(c=t;;){x=m;do h=c+l[++m];while(n[h]===0);if(m&=7,m-1>>>0<x>>>0?n[c]=-i:n[c]===1&&(n[c]=i),o.push({x:a.x,y:a.y}),a.x+=s.neighborhood[m][0],a.y+=s.neighborhood[m][1],h===t&&c===d)break;c=h,m=m+4&7}return o},s.neighborhood=[[1,0],[1,-1],[0,-1],[-1,-1],[-1,0],[-1,1],[0,1],[1,1]],s.neighborhoodDeltas=function(n){for(var t=[],i=s.neighborhood.length,a=0;a<i;++a)t[a]=s.neighborhood[a][0]+s.neighborhood[a][1]*n;return t.concat(t)},s.approxPolyDP=function(n,t){var i={start_index:0,end_index:0},a={start_index:0,end_index:0},r=[],l=[],o=n.length,d,c,h,m,x,p,g,w,T,S,E;for(t*=t,E=0,T=0;T<3;++T)for(x=0,E=(E+a.start_index)%o,c=n[E],++E===o&&(E=0),S=1;S<o;++S)d=n[E],++E===o&&(E=0),g=d.x-c.x,w=d.y-c.y,m=g*g+w*w,m>x&&(x=m,a.start_index=S);for(x<=t?r.push({x:c.x,y:c.y}):(i.start_index=E,i.end_index=a.start_index+=i.start_index,a.start_index-=a.start_index>=o?o:0,a.end_index=i.start_index,a.end_index<a.start_index&&(a.end_index+=o),l.push({start_index:a.start_index,end_index:a.end_index}),l.push({start_index:i.start_index,end_index:i.end_index}));l.length!==0;){if(i=l.pop(),h=n[i.end_index%o],c=n[E=i.start_index%o],++E===o&&(E=0),i.end_index<=i.start_index+1)p=!0;else{for(x=0,g=h.x-c.x,w=h.y-c.y,T=i.start_index+1;T<i.end_index;++T)d=n[E],++E===o&&(E=0),m=Math.abs((d.y-c.y)*g-(d.x-c.x)*w),m>x&&(x=m,a.start_index=T);p=x*x<=t*(g*g+w*w)}p?r.push({x:c.x,y:c.y}):(a.end_index=i.end_index,i.end_index=a.start_index,l.push({start_index:a.start_index,end_index:a.end_index}),l.push({start_index:i.start_index,end_index:i.end_index}))}return r},s.warp=function(n,t,i,a){var r=n.data,l=t.data,o=n.width,d=n.height,c=0,h,m,x,p,g,w,T,S,E,I,M,P,A,v,b,H,W,R,F,D,Q,me,ue;for(A=s.getPerspectiveTransform(i,a-1),v=A[8],b=A[2],H=A[5],me=0;me<a;++me)for(v+=A[7],b+=A[1],H+=A[4],W=v,R=b,F=H,ue=0;ue<a;++ue)W+=A[6],R+=A[0],F+=A[3],D=R/W,Q=F/W,h=D>>>0,m=h===o-1?h:h+1,x=D-h,p=1-x,g=Q>>>0,w=g===d-1?g:g+1,T=Q-g,S=1-T,E=I=g*o,M=P=w*o,l[c++]=S*(p*r[E+h]+x*r[I+m])+T*(p*r[M+h]+x*r[P+m])&255;return t.width=a,t.height=a,t},s.getPerspectiveTransform=function(n,t){var i=s.square2quad(n);return i[0]/=t,i[1]/=t,i[3]/=t,i[4]/=t,i[6]/=t,i[7]/=t,i},s.square2quad=function(n){var t=[],i,a,r,l,o,d,c;return i=n[0].x-n[1].x+n[2].x-n[3].x,a=n[0].y-n[1].y+n[2].y-n[3].y,i===0&&a===0?(t[0]=n[1].x-n[0].x,t[1]=n[2].x-n[1].x,t[2]=n[0].x,t[3]=n[1].y-n[0].y,t[4]=n[2].y-n[1].y,t[5]=n[0].y,t[6]=0,t[7]=0,t[8]=1):(r=n[1].x-n[2].x,l=n[3].x-n[2].x,o=n[1].y-n[2].y,d=n[3].y-n[2].y,c=r*d-l*o,t[6]=(i*d-l*a)/c,t[7]=(r*a-i*o)/c,t[8]=1,t[0]=n[1].x-n[0].x+t[6]*n[1].x,t[1]=n[3].x-n[0].x+t[7]*n[3].x,t[2]=n[0].x,t[3]=n[1].y-n[0].y+t[6]*n[1].y,t[4]=n[3].y-n[0].y+t[7]*n[3].y,t[5]=n[0].y),t},s.isContourConvex=function(n){var t=0,i=!0,a=n.length,r=0,l=0,o,d,c,h,m,x,p,g;for(d=n[a-1],o=n[0],m=o.x-d.x,x=o.y-d.y;r<a;++r){if(++l===a&&(l=0),d=o,o=n[l],p=o.x-d.x,g=o.y-d.y,c=p*x,h=g*m,t|=h>c?1:h<c?2:3,t===3){i=!1;break}m=p,x=g}return i},s.perimeter=function(n){for(var t=n.length,i=0,a=t-1,r=0,l,o;i<t;a=i++)l=n[i].x-n[a].x,o=n[i].y-n[a].y,r+=Math.sqrt(l*l+o*o);return r},s.minEdgeLength=function(n){for(var t=n.length,i=0,a=t-1,r=1/0,l,o,d;i<t;a=i++)o=n[i].x-n[a].x,d=n[i].y-n[a].y,l=o*o+d*d,l<r&&(r=l);return Math.sqrt(r)},s.countNonZero=function(n,t){var i=n.data,a=t.height,r=t.width,l=t.x+t.y*n.width,o=n.width-r,d=0,c,h;for(c=0;c<a;++c){for(h=0;h<r;++h)i[l++]!==0&&++d;l+=o}return d},s.binaryBorder=function(n,t){var i=n.data,a=n.height,r=n.width,l=0,o=0,d,c;for(c=-2;c<r;++c)t[o++]=0;for(d=0;d<a;++d){for(t[o++]=0,c=0;c<r;++c)t[o++]=i[l++]===0?0:1;t[o++]=0}for(c=-2;c<r;++c)t[o++]=0;return t},Vr=s,Vr}var Gr,Uo;function Vd(){if(Uo)return Gr;Uo=1;var s=Tl(),n=n||{};return n.Marker=function(t,i){this.id=t,this.corners=i},n.Detector=function(){this.grey=new s.Image,this.thres=new s.Image,this.homography=new s.Image,this.binary=[],this.contours=[],this.polys=[],this.candidates=[]},n.Detector.prototype.detect=function(t){return s.grayscale(t,this.grey),s.adaptiveThreshold(this.grey,this.thres,2,7),this.contours=s.findContours(this.thres,this.binary),this.candidates=this.findCandidates(this.contours,t.width*.2,.05,10),this.candidates=this.clockwiseCorners(this.candidates),this.candidates=this.notTooNear(this.candidates,10),this.findMarkers(this.grey,this.candidates,49)},n.Detector.prototype.findCandidates=function(t,i,a,r){var l=[],o=t.length,d,c,h;for(this.polys=[],h=0;h<o;++h)d=t[h],d.length>=i&&(c=s.approxPolyDP(d,d.length*a),this.polys.push(c),c.length===4&&s.isContourConvex(c)&&s.minEdgeLength(c)>=r&&l.push(c));return l},n.Detector.prototype.clockwiseCorners=function(t){var i=t.length,a,r,l,o,d,c;for(c=0;c<i;++c)a=t[c][1].x-t[c][0].x,l=t[c][1].y-t[c][0].y,r=t[c][2].x-t[c][0].x,o=t[c][2].y-t[c][0].y,a*o-l*r<0&&(d=t[c][1],t[c][1]=t[c][3],t[c][3]=d);return t},n.Detector.prototype.notTooNear=function(t,i){var a=[],r=t.length,l,o,d,c,h,m;for(c=0;c<r;++c)for(h=c+1;h<r;++h){for(l=0,m=0;m<4;++m)o=t[c][m].x-t[h][m].x,d=t[c][m].y-t[h][m].y,l+=o*o+d*d;l/4<i*i&&(s.perimeter(t[c])<s.perimeter(t[h])?t[c].tooNear=!0:t[h].tooNear=!0)}for(c=0;c<r;++c)t[c].tooNear||a.push(t[c]);return a},n.Detector.prototype.findMarkers=function(t,i,a){var r=[],l=i.length,o,d,c;for(c=0;c<l;++c)o=i[c],s.warp(t,this.homography,o,a),s.threshold(this.homography,this.homography,s.otsu(this.homography)),d=this.getMarker(this.homography,o),d&&r.push(d);return r},n.Detector.prototype.getMarker=function(t,i){var a=t.width/7>>>0,r=a*a>>1,l=[],o=[],d=[],c,h,m,x,p;for(x=0;x<7;++x)for(m=x===0||x===6?1:6,p=0;p<7;p+=m)if(c={x:p*a,y:x*a,width:a,height:a},s.countNonZero(t,c)>r)return null;for(x=0;x<5;++x)for(l[x]=[],p=0;p<5;++p)c={x:(p+1)*a,y:(x+1)*a,width:a,height:a},l[x][p]=s.countNonZero(t,c)>r?1:0;for(o[0]=l,d[0]=this.hammingDistance(o[0]),h={first:d[0],second:0},x=1;x<4;++x)o[x]=this.rotate(o[x-1]),d[x]=this.hammingDistance(o[x]),d[x]<h.first&&(h.first=d[x],h.second=x);return h.first!==0?null:new n.Marker(this.mat2id(o[h.second]),this.rotate2(i,4-h.second))},n.Detector.prototype.hammingDistance=function(t){var i=[[1,0,0,0,0],[1,0,1,1,1],[0,1,0,0,1],[0,1,1,1,0]],a=0,r,l,o,d,c;for(o=0;o<5;++o){for(l=1/0,d=0;d<4;++d){for(r=0,c=0;c<5;++c)r+=t[o][c]===i[d][c]?0:1;r<l&&(l=r)}a+=l}return a},n.Detector.prototype.mat2id=function(t){var i=0,a;for(a=0;a<5;++a)i<<=1,i|=t[a][1],i<<=1,i|=t[a][3];return i},n.Detector.prototype.rotate=function(t){var i=[],a=t.length,r,l;for(r=0;r<a;++r)for(i[r]=[],l=0;l<t[r].length;++l)i[r][l]=t[t[r].length-l-1][r];return i},n.Detector.prototype.rotate2=function(t,i){var a=[],r=t.length,l;for(l=0;l<r;++l)a[l]=t[(i+l)%r];return a},Gr=n,Gr}var Jr,$o;function gi(){if($o)return Jr;$o=1;var s=s||{};return s.svdcmp=function(n,t,i,a,r){var l,o,d,c,h,m,x,p,g=0,w,T,S=0,E,I,M=0,P,A,v,b=[];for(o=0;o<i;++o){if(x=o+1,b[o]=M*S,S=I=M=0,o<t){for(m=o;m<t;++m)M+=Math.abs(n[m][o]);if(M!==0){for(m=o;m<t;++m)n[m][o]/=M,I+=n[m][o]*n[m][o];for(T=n[o][o],S=-s.sign(Math.sqrt(I),T),E=T*S-I,n[o][o]=T-S,c=x;c<i;++c){for(I=0,m=o;m<t;++m)I+=n[m][o]*n[m][c];for(T=I/E,m=o;m<t;++m)n[m][c]+=T*n[m][o]}for(m=o;m<t;++m)n[m][o]*=M}}if(a[o]=M*S,S=I=M=0,o<t&&o!==i-1){for(m=x;m<i;++m)M+=Math.abs(n[o][m]);if(M!==0){for(m=x;m<i;++m)n[o][m]/=M,I+=n[o][m]*n[o][m];for(T=n[o][x],S=-s.sign(Math.sqrt(I),T),E=T*S-I,n[o][x]=T-S,m=x;m<i;++m)b[m]=n[o][m]/E;for(c=x;c<t;++c){for(I=0,m=x;m<i;++m)I+=n[c][m]*n[o][m];for(m=x;m<i;++m)n[c][m]+=I*b[m]}for(m=x;m<i;++m)n[o][m]*=M}}g=Math.max(g,Math.abs(a[o])+Math.abs(b[o]))}for(o=i-1;o>=0;--o){if(o<i-1){if(S!==0){for(c=x;c<i;++c)r[c][o]=n[o][c]/n[o][x]/S;for(c=x;c<i;++c){for(I=0,m=x;m<i;++m)I+=n[o][m]*r[m][c];for(m=x;m<i;++m)r[m][c]+=I*r[m][o]}}for(c=x;c<i;++c)r[o][c]=r[c][o]=0}r[o][o]=1,S=b[o],x=o}for(o=Math.min(i,t)-1;o>=0;--o){for(x=o+1,S=a[o],c=x;c<i;++c)n[o][c]=0;if(S!==0){for(S=1/S,c=x;c<i;++c){for(I=0,m=x;m<t;++m)I+=n[m][o]*n[m][c];for(T=I/n[o][o]*S,m=o;m<t;++m)n[m][c]+=T*n[m][o]}for(c=o;c<t;++c)n[c][o]*=S}else for(c=o;c<t;++c)n[c][o]=0;++n[o][o]}for(m=i-1;m>=0;--m)for(d=1;d<=30;++d){for(l=!0,x=m;x>=0;--x){if(p=x-1,Math.abs(b[x])+g===g){l=!1;break}if(Math.abs(a[p])+g===g)break}if(l)for(w=0,I=1,o=x;o<=m&&(T=I*b[o],Math.abs(T)+g!==g);++o)for(S=a[o],E=s.pythag(T,S),a[o]=E,E=1/E,w=S*E,I=-T*E,c=1;c<=t;++c)A=n[c][p],v=n[c][o],n[c][p]=A*w+v*I,n[c][o]=v*w-A*I;if(v=a[m],x===m){if(v<0)for(a[m]=-v,c=0;c<i;++c)r[c][m]=-r[c][m];break}if(d===30)return!1;for(P=a[x],p=m-1,A=a[p],S=b[p],E=b[m],T=((A-v)*(A+v)+(S-E)*(S+E))/(2*E*A),S=s.pythag(T,1),T=((P-v)*(P+v)+E*(A/(T+s.sign(S,T))-E))/P,w=I=1,c=x;c<=p;++c){for(o=c+1,S=b[o],A=a[o],E=I*S,S=w*S,v=s.pythag(T,E),b[c]=v,w=T/v,I=E/v,T=P*w+S*I,S=S*w-P*I,E=A*I,A*=w,h=0;h<i;++h)P=r[h][c],v=r[h][o],r[h][c]=P*w+v*I,r[h][o]=v*w-P*I;for(v=s.pythag(T,E),a[c]=v,v!==0&&(v=1/v,w=T*v,I=E*v),T=w*S+I*A,P=w*A-I*S,h=0;h<t;++h)A=n[h][c],v=n[h][o],n[h][c]=A*w+v*I,n[h][o]=v*w-A*I}b[x]=0,b[m]=T,a[m]=P}return!0},s.pythag=function(n,t){var i=Math.abs(n),a=Math.abs(t),r;return i>a?(r=a/i,i*Math.sqrt(1+r*r)):a===0?0:(r=i/a,a*Math.sqrt(1+r*r))},s.sign=function(n,t){return t>=0?Math.abs(n):-Math.abs(n)},Jr=s,Jr}var Kr,_o;function Gd(){if(_o)return Kr;_o=1;var s=gi(),n=n||{};return n.Posit=function(t,i){this.objectPoints=this.buildModel(t),this.focalLength=i,this.objectVectors=[],this.objectNormal=[],this.objectMatrix=[[],[],[]],this.init()},n.Posit.prototype.buildModel=function(t){var i=t/2;return[[-i,i,0],[i,i,0],[i,-i,0],[-i,-i,0]]},n.Posit.prototype.init=function(){var t=this.objectPoints.length,i=[],a=[],r=0,l=2,o;for(o=0;o<t;++o)this.objectVectors[o]=[this.objectPoints[o][0]-this.objectPoints[0][0],this.objectPoints[o][1]-this.objectPoints[0][1],this.objectPoints[o][2]-this.objectPoints[0][2]],i[o]=[this.objectVectors[o][0],this.objectVectors[o][1],this.objectVectors[o][2]];for(;r===0;)a[0]=this.objectVectors[1][1]*this.objectVectors[l][2]-this.objectVectors[1][2]*this.objectVectors[l][1],a[1]=this.objectVectors[1][2]*this.objectVectors[l][0]-this.objectVectors[1][0]*this.objectVectors[l][2],a[2]=this.objectVectors[1][0]*this.objectVectors[l][1]-this.objectVectors[1][1]*this.objectVectors[l][0],r=Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]),++l;for(o=0;o<3;++o)this.objectNormal[o]=a[o]/r;n.pseudoInverse(i,t,this.objectMatrix)},n.Posit.prototype.pose=function(t){var i=[[],[],[]],a=[[],[],[]],r=[],l=[[],[],[]],o=[[],[],[]],d=[],c=[],h,m,x,p,g,w;for(this.pos(t,i,a,r),x=this.isValid(i,r),x?h=this.iterate(t,i,r,l,d):h={euclidean:-1,pixels:-1,maximum:-1},p=this.isValid(a,r),p?m=this.iterate(t,a,r,o,c):m={euclidean:-1,pixels:-1,maximum:-1},g=0;g<3;++g)for(w=0;w<3;++w)x&&(d[g]-=l[g][w]*this.objectPoints[0][w]),p&&(c[g]-=o[g][w]*this.objectPoints[0][w]);return h.euclidean<m.euclidean?new n.Pose(h.pixels,l,d,m.pixels,o,c):new n.Pose(m.pixels,o,c,h.pixels,l,d)},n.Posit.prototype.pos=function(t,i,a,r){var l=this.objectPoints.length,o=[],d=[],c=[],h=[],m=[],x=[],p=[],g=[],w,T,S,E,I,M,P,A,v,b;for(v=0;v<l;++v)o[v]=[t[v].x-t[0].x,t[v].y-t[0].y];for(v=0;v<3;++v)for(d[v]=0,c[v]=0,b=0;b<l;++b)d[v]+=this.objectMatrix[v][b]*o[b][0],c[v]+=this.objectMatrix[v][b]*o[b][1];for(w=d[0]*d[0]+d[1]*d[1]+d[2]*d[2],T=c[0]*c[0]+c[1]*c[1]+c[2]*c[2],S=d[0]*c[0]+d[1]*c[1]+d[2]*c[2],E=(T-w)*(T-w)+4*(S*S),T-w>=0?I=(T-w+Math.sqrt(E))/2:I=(T-w-Math.sqrt(E))/2,I>=0?(M=Math.sqrt(I),M===0?P=0:P=-S/M):(M=Math.sqrt(-(S*S)/I),M===0?P=Math.sqrt(w-T):P=-S/M),v=0;v<3;++v)h[v]=d[v]+M*this.objectNormal[v],m[v]=c[v]+P*this.objectNormal[v];for(A=Math.sqrt(h[0]*h[0]+h[1]*h[1]+h[2]*h[2]),v=0;v<3;++v)x[v]=h[v]/A,p[v]=m[v]/A;for(g[0]=x[1]*p[2]-x[2]*p[1],g[1]=x[2]*p[0]-x[0]*p[2],g[2]=x[0]*p[1]-x[1]*p[0],v=0;v<3;++v)i[0][v]=x[v],i[1][v]=p[v],i[2][v]=g[v];for(v=0;v<3;++v)h[v]=d[v]-M*this.objectNormal[v],m[v]=c[v]-P*this.objectNormal[v];for(v=0;v<3;++v)x[v]=h[v]/A,p[v]=m[v]/A;for(g[0]=x[1]*p[2]-x[2]*p[1],g[1]=x[2]*p[0]-x[0]*p[2],g[2]=x[0]*p[1]-x[1]*p[0],v=0;v<3;++v)a[0][v]=x[v],a[1][v]=p[v],a[2][v]=g[v];r[0]=t[0].x/A,r[1]=t[0].y/A,r[2]=this.focalLength/A},n.Posit.prototype.isValid=function(t,i){for(var a=this.objectPoints.length,r=1/0,l=0,o;l<a;++l)o=i[2]+(t[2][0]*this.objectVectors[l][0]+t[2][1]*this.objectVectors[l][1]+t[2][2]*this.objectVectors[l][2]),o<r&&(r=o);return r>=0},n.Posit.prototype.iterate=function(t,i,a,r,l){var o=this.objectPoints.length,d=[],c=[],h=[[],[],[]],m=[[],[],[]],x=[],p=[],g=!1,w=0,T,S,E,I,M,P,A,v,b;for(v=0;v<o;++v)d[v]={x:t[v].x,y:t[v].y};for(v=0;v<3;++v){for(b=0;b<3;++b)r[v][b]=i[v][b];l[v]=a[v]}for(v=0;v<o;++v){for(E=0,b=0;b<3;++b)E+=this.objectVectors[v][b]*r[2][b]/l[2];c[v]={x:(1+E)*t[v].x,y:(1+E)*t[v].y}}for(S=0,v=0;v<o;++v)S+=Math.abs(c[v].x-d[v].x),S+=Math.abs(c[v].y-d[v].y);for(v=0;v<3;++v)x[v]=l[v]-(r[v][0]*this.objectPoints[0][0]+r[v][1]*this.objectPoints[0][1]+r[v][2]*this.objectPoints[0][2]);for(I=M=this.error(t,r,x),g=M.pixels===0||S<.01;w++<100&&!g;){for(v=0;v<o;++v)d[v].x=c[v].x,d[v].y=c[v].y;for(this.pos(c,h,m,l),v=0;v<3;++v)x[v]=l[v]-(h[v][0]*this.objectPoints[0][0]+h[v][1]*this.objectPoints[0][1]+h[v][2]*this.objectPoints[0][2]),p[v]=l[v]-(m[v][0]*this.objectPoints[0][0]+m[v][1]*this.objectPoints[0][1]+m[v][2]*this.objectPoints[0][2]);if(M=this.error(t,h,x),P=this.error(t,m,p),M.euclidean>=0&&P.euclidean>=0)if(P.euclidean<M.euclidean)for(I=P,v=0;v<3;++v)for(b=0;b<3;++b)r[v][b]=m[v][b];else for(I=M,v=0;v<3;++v)for(b=0;b<3;++b)r[v][b]=h[v][b];if(M.euclidean<0&&P.euclidean>=0)for(I=P,v=0;v<3;++v)for(b=0;b<3;++b)r[v][b]=m[v][b];if(P.euclidean<0&&M.euclidean>=0)for(I=M,v=0;v<3;++v)for(b=0;b<3;++b)r[v][b]=h[v][b];for(v=0;v<o;++v){for(E=0,b=0;b<3;++b)E+=this.objectVectors[v][b]*r[2][b]/l[2];c[v].x=(1+E)*t[v].x,c[v].y=(1+E)*t[v].y}for(T=S,S=0,v=0;v<o;++v)S+=Math.abs(c[v].x-d[v].x),S+=Math.abs(c[v].y-d[v].y);A=Math.abs(S-T),g=I.pixels===0||A<.01}return I},n.Posit.prototype.error=function(t,i,a){var r=this.objectPoints.length,l=[],o=[],d=[],c=0,h=0,m=0,x,p,g;if(!this.isValid(i,a))return{euclidean:-1,pixels:-1,maximum:-1};for(x=0;x<r;++x)for(l[x]=[],p=0;p<3;++p)l[x][p]=a[p];for(x=0;x<r;++x)for(p=0;p<3;++p)for(g=0;g<3;++g)l[x][p]+=i[p][g]*this.objectPoints[x][g];for(x=0;x<r;++x)for(o[x]=[],p=0;p<2;++p)o[x][p]=this.focalLength*l[x][p]/l[x][2];for(x=0;x<r;++x)d[x]=[o[x][0]-t[x].x,o[x][1]-t[x].y];for(x=0;x<r;++x)c+=Math.sqrt(d[x][0]*d[x][0]+d[x][1]*d[x][1]),h+=Math.abs(Math.round(o[x][0])-Math.round(t[x].x))+Math.abs(Math.round(o[x][1])-Math.round(t[x].y)),Math.abs(d[x][0])>m&&(m=Math.abs(d[x][0])),Math.abs(d[x][1])>m&&(m=Math.abs(d[x][1]));return{euclidean:c/r,pixels:h,maximum:m}},n.pseudoInverse=function(t,i,a){var r=[],l=[[],[],[]],o=[[],[],[]],d=0,c=0,h,m,x;for(s.svdcmp(t,i,3,r,l),h=0;h<3;++h)r[h]>d&&(d=r[h]);for(d*=.01,h=0;h<3;++h)r[h]<d&&(r[h]=0);for(m=0;m<3;++m)if(r[m]===0)for(++c,x=m;x<2;++x){for(h=0;h<i;++h)t[h][x]=t[h][x+1];for(h=0;h<3;++h)l[h][x]=l[h][x+1]}for(m=0;m<2;++m)r[m]===0&&(r[m]=r[m+1]);for(h=0;h<3;++h)for(m=0;m<3-c;++m)o[h][m]=l[h][m]/r[m];for(h=0;h<3;++h)for(m=0;m<i;++m)for(a[h][m]=0,x=0;x<3-c;++x)a[h][m]+=o[h][x]*t[m][x]},n.Pose=function(t,i,a,r,l,o){this.bestError=t,this.bestRotation=i,this.bestTranslation=a,this.alternativeError=r,this.alternativeRotation=l,this.alternativeTranslation=o},Kr=n,Kr}var Yr,Fo;function Jd(){if(Fo)return Yr;Fo=1;var s=gi(),n=n||{};n.Posit=function(a,r){this.model=this.buildModel(a),this.focalLength=r,this.init()},n.Posit.prototype.buildModel=function(a){var r=a/2;return[new t(-r,r,0),new t(r,r,0),new t(r,-r,0),new t(-r,-r,0)]},n.Posit.prototype.init=function(){var a=new t,r=new i,l;this.modelVectors=i.fromRows(t.sub(this.model[1],this.model[0]),t.sub(this.model[2],this.model[0]),t.sub(this.model[3],this.model[0])),l=i.clone(this.modelVectors),s.svdcmp(l.m,3,3,a.v,r.m),this.modelPseudoInverse=i.mult(i.mult(r,i.fromDiagonal(t.inverse(a))),i.transpose(l)),this.modelNormal=r.column(a.minIndex())},n.Posit.prototype.pose=function(a){var r=new t(1,1,1),l=new i,o=new i,d=new t,c=new t,h,m;return this.pos(a,r,l,o,d,c),h=this.iterate(a,l,d),m=this.iterate(a,o,c),h<m?new n.Pose(h,l.m,d.v,m,o.m,c.v):new n.Pose(m,o.m,c.v,h,l.m,d.v)},n.Posit.prototype.pos=function(a,r,l,o,d,c){var h=new t(a[1].x,a[2].x,a[3].x),m=new t(a[1].y,a[2].y,a[3].y),x=t.addScalar(t.mult(h,r),-a[0].x),p=t.addScalar(t.mult(m,r),-a[0].y),g=i.multVector(this.modelPseudoInverse,x),w=i.multVector(this.modelPseudoInverse,p),T=w.square()-g.square(),S=t.dot(g,w),E=0,I=0,M,P,A,v,b,H,W,R,F;T===0?(E=Math.sqrt(Math.abs(2*S)),I=-Math.PI/2*(S<0?-1:S>0?1:0)):(E=Math.sqrt(Math.sqrt(T*T+4*S*S)),I=Math.atan(-2*S/T),T<0&&(I+=Math.PI),I/=2),R=E*Math.cos(I),F=E*Math.sin(I),M=t.add(g,t.multScalar(this.modelNormal,R)),P=t.add(w,t.multScalar(this.modelNormal,F)),v=M.normalize(),b=P.normalize(),A=t.cross(M,P),l.copy(i.fromRows(M,P,A)),H=(v+b)/2,W=i.multVector(l,this.model[0]),d.v=[a[0].x/H-W.v[0],a[0].y/H-W.v[1],this.focalLength/H],M=t.sub(g,t.multScalar(this.modelNormal,R)),P=t.sub(w,t.multScalar(this.modelNormal,F)),v=M.normalize(),b=P.normalize(),A=t.cross(M,P),o.copy(i.fromRows(M,P,A)),H=(v+b)/2,W=i.multVector(o,this.model[0]),c.v=[a[0].x/H-W.v[0],a[0].y/H-W.v[1],this.focalLength/H]},n.Posit.prototype.iterate=function(a,r,l){for(var o=1/0,d=new i,c=new i,h=new t,m=new t,x=0,p,g,w,T;x<100&&(p=t.addScalar(t.multScalar(i.multVector(this.modelVectors,r.row(2)),1/l.v[2]),1),this.pos(a,p,d,c,h,m),w=this.getError(a,d,h),T=this.getError(a,c,m),w<T?(r.copy(d),l.copy(h),g=w):(r.copy(c),l.copy(m),g=T),!(g<=2||g>o));++x)o=g;return g},n.Posit.prototype.getError=function(a,r,l){var o=t.add(i.multVector(r,this.model[0]),l),d=t.add(i.multVector(r,this.model[1]),l),c=t.add(i.multVector(r,this.model[2]),l),h=t.add(i.multVector(r,this.model[3]),l),m,x,p,g,w,T,S,E,I;return o=o.v,d=d.v,c=c.v,h=h.v,o[0]*=this.focalLength/o[2],o[1]*=this.focalLength/o[2],d[0]*=this.focalLength/d[2],d[1]*=this.focalLength/d[2],c[0]*=this.focalLength/c[2],c[1]*=this.focalLength/c[2],h[0]*=this.focalLength/h[2],h[1]*=this.focalLength/h[2],m=[{x:o[0],y:o[1]},{x:d[0],y:d[1]},{x:c[0],y:c[1]},{x:h[0],y:h[1]}],x=this.angle(a[0],a[1],a[3]),p=this.angle(a[1],a[2],a[0]),g=this.angle(a[2],a[3],a[1]),w=this.angle(a[3],a[0],a[2]),T=this.angle(m[0],m[1],m[3]),S=this.angle(m[1],m[2],m[0]),E=this.angle(m[2],m[3],m[1]),I=this.angle(m[3],m[0],m[2]),(Math.abs(x-T)+Math.abs(p-S)+Math.abs(g-E)+Math.abs(w-I))/4},n.Posit.prototype.angle=function(a,r,l){var o=r.x-a.x,d=r.y-a.y,c=l.x-a.x,h=l.y-a.y;return Math.acos((o*c+d*h)/(Math.sqrt(o*o+d*d)*Math.sqrt(c*c+h*h)))*180/Math.PI},n.Pose=function(a,r,l,o,d,c){this.bestError=a,this.bestRotation=r,this.bestTranslation=l,this.alternativeError=o,this.alternativeRotation=d,this.alternativeTranslation=c};var t=function(a,r,l){this.v=[a||0,r||0,l||0]};t.prototype.copy=function(a){var r=this.v;return a=a.v,r[0]=a[0],r[1]=a[1],r[2]=a[2],this},t.add=function(a,r){var l=new t,o=l.v;return a=a.v,r=r.v,o[0]=a[0]+r[0],o[1]=a[1]+r[1],o[2]=a[2]+r[2],l},t.sub=function(a,r){var l=new t,o=l.v;return a=a.v,r=r.v,o[0]=a[0]-r[0],o[1]=a[1]-r[1],o[2]=a[2]-r[2],l},t.mult=function(a,r){var l=new t,o=l.v;return a=a.v,r=r.v,o[0]=a[0]*r[0],o[1]=a[1]*r[1],o[2]=a[2]*r[2],l},t.addScalar=function(a,r){var l=new t,o=l.v;return a=a.v,o[0]=a[0]+r,o[1]=a[1]+r,o[2]=a[2]+r,l},t.multScalar=function(a,r){var l=new t,o=l.v;return a=a.v,o[0]=a[0]*r,o[1]=a[1]*r,o[2]=a[2]*r,l},t.dot=function(a,r){return a=a.v,r=r.v,a[0]*r[0]+a[1]*r[1]+a[2]*r[2]},t.cross=function(a,r){return a=a.v,r=r.v,new t(a[1]*r[2]-a[2]*r[1],a[2]*r[0]-a[0]*r[2],a[0]*r[1]-a[1]*r[0])},t.prototype.normalize=function(){var a=this.v,r=Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]);return r>0&&(a[0]/=r,a[1]/=r,a[2]/=r),r},t.inverse=function(a){var r=new t,l=r.v;return a=a.v,a[0]!==0&&(l[0]=1/a[0]),a[1]!==0&&(l[1]=1/a[1]),a[2]!==0&&(l[2]=1/a[2]),r},t.prototype.square=function(){var a=this.v;return a[0]*a[0]+a[1]*a[1]+a[2]*a[2]},t.prototype.minIndex=function(){var a=this.v;return a[0]<a[1]?a[0]<a[2]?0:2:a[1]<a[2]?1:2};var i=function(){this.m=[[0,0,0],[0,0,0],[0,0,0]]};return i.clone=function(a){var r=new i,l=r.m;return a=a.m,l[0][0]=a[0][0],l[0][1]=a[0][1],l[0][2]=a[0][2],l[1][0]=a[1][0],l[1][1]=a[1][1],l[1][2]=a[1][2],l[2][0]=a[2][0],l[2][1]=a[2][1],l[2][2]=a[2][2],r},i.prototype.copy=function(a){var r=this.m;return a=a.m,r[0][0]=a[0][0],r[0][1]=a[0][1],r[0][2]=a[0][2],r[1][0]=a[1][0],r[1][1]=a[1][1],r[1][2]=a[1][2],r[2][0]=a[2][0],r[2][1]=a[2][1],r[2][2]=a[2][2],this},i.fromRows=function(a,r,l){var o=new i,d=o.m;return a=a.v,r=r.v,l=l.v,d[0][0]=a[0],d[0][1]=a[1],d[0][2]=a[2],d[1][0]=r[0],d[1][1]=r[1],d[1][2]=r[2],d[2][0]=l[0],d[2][1]=l[1],d[2][2]=l[2],o},i.fromDiagonal=function(a){var r=new i,l=r.m;return a=a.v,l[0][0]=a[0],l[1][1]=a[1],l[2][2]=a[2],r},i.transpose=function(a){var r=new i,l=r.m;return a=a.m,l[0][0]=a[0][0],l[0][1]=a[1][0],l[0][2]=a[2][0],l[1][0]=a[0][1],l[1][1]=a[1][1],l[1][2]=a[2][1],l[2][0]=a[0][2],l[2][1]=a[1][2],l[2][2]=a[2][2],r},i.mult=function(a,r){var l=new i,o=l.m;return a=a.m,r=r.m,o[0][0]=a[0][0]*r[0][0]+a[0][1]*r[1][0]+a[0][2]*r[2][0],o[0][1]=a[0][0]*r[0][1]+a[0][1]*r[1][1]+a[0][2]*r[2][1],o[0][2]=a[0][0]*r[0][2]+a[0][1]*r[1][2]+a[0][2]*r[2][2],o[1][0]=a[1][0]*r[0][0]+a[1][1]*r[1][0]+a[1][2]*r[2][0],o[1][1]=a[1][0]*r[0][1]+a[1][1]*r[1][1]+a[1][2]*r[2][1],o[1][2]=a[1][0]*r[0][2]+a[1][1]*r[1][2]+a[1][2]*r[2][2],o[2][0]=a[2][0]*r[0][0]+a[2][1]*r[1][0]+a[2][2]*r[2][0],o[2][1]=a[2][0]*r[0][1]+a[2][1]*r[1][1]+a[2][2]*r[2][1],o[2][2]=a[2][0]*r[0][2]+a[2][1]*r[1][2]+a[2][2]*r[2][2],l},i.multVector=function(a,r){return a=a.m,r=r.v,new t(a[0][0]*r[0]+a[0][1]*r[1]+a[0][2]*r[2],a[1][0]*r[0]+a[1][1]*r[1]+a[1][2]*r[2],a[2][0]*r[0]+a[2][1]*r[1]+a[2][2]*r[2])},i.prototype.column=function(a){var r=this.m;return new t(r[0][a],r[1][a],r[2][a])},i.prototype.row=function(a){var r=this.m;return new t(r[a][0],r[a][1],r[a][2])},Yr=n,Yr}var Xr,Ho;function Kd(){return Ho||(Ho=1,Xr={CV:Tl(),AR:Vd(),SVD:gi(),POS1:Gd(),POS2:Jd()}),Xr}var Yd=Kd();const Fn={top:0,right:1,bottom:2,left:3};let Qr=null;function Xd(){return Qr||(Qr=new Yd.AR.Detector),Qr}function Qd(s){const n=s.reduce((i,a)=>({x:i.x+a.x,y:i.y+a.y}),{x:0,y:0}),t=s.length||1;return{x:n.x/t,y:n.y/t}}function Zd(s){try{const t=Xd().detect(s)||[],i={},a=[];for(const m of t){const x=Qd(m.corners);a.push({id:m.id,center:x});const p=Object.keys(Fn).find(g=>Fn[g]===m.id);p&&(i[p]={id:m.id,center:x})}const r=Object.keys(Fn).filter(m=>!i[m]);if(r.length>0)return{success:!1,points:[],missing:r,markersFound:a,assignments:i,homography:null,errorPx:null,message:"Not all calibration markers were detected."};const l=[i.top.center,i.right.center,i.bottom.center,i.left.center],d=wa().slice(0,4),c=si(d,l),h=ni(c,d,l);return{success:!0,points:l,missing:[],markersFound:a,assignments:i,homography:c,errorPx:h}}catch(n){return{success:!1,points:[],missing:Object.keys(Fn),markersFound:[],assignments:{},homography:null,errorPx:null,message:n instanceof Error?n.message:"Marker detection failed"}}}function eu(s){const n=s.getContext("2d");if(!n)return{success:!1,points:[],missing:Object.keys(Fn),markersFound:[],assignments:{},homography:null,errorPx:null,message:"Canvas context unavailable for marker detection."};const t=r=>Zd(r);let i=n.getImageData(0,0,s.width,s.height),a=t(i);if(a.success||(a.markersFound?.length||0)>0)return a;try{const l=document.createElement("canvas");l.width=Math.round(s.width*1.75),l.height=Math.round(s.height*1.75);const o=l.getContext("2d");if(o.imageSmoothingEnabled=!1,o.drawImage(s,0,0,l.width,l.height),i=o.getImageData(0,0,l.width,l.height),a=t(i),a.success||(a.markersFound?.length||0)>0)return a}catch{}try{const r=s.width,l=s.height,o=n.getImageData(0,0,r,l),d=o.data;let c=255,h=0;for(let x=0;x<d.length;x+=4){const p=.2126*d[x]+.7152*d[x+1]+.0722*d[x+2];p<c&&(c=p),p>h&&(h=p)}const m=Math.max(1,h-c);for(let x=0;x<d.length;x+=4){const p=.2126*d[x]+.7152*d[x+1]+.0722*d[x+2],g=Math.max(0,Math.min(255,(p-c)*255/m));d[x]=d[x+1]=d[x+2]=g}if(a=t(o),a.success||(a.markersFound?.length||0)>0)return a}catch{}return{success:!1,points:[],missing:Object.keys(Fn),markersFound:[],assignments:{},homography:null,errorPx:null,message:a.message||"No calibration markers detected. Ensure you are using the provided TOP/RIGHT/BOTTOM/LEFT ArUco markers printed at 100% on white paper."}}const tu={"0,0":[1,0,0,0,0],"0,1":[1,0,1,1,1],"1,0":[0,1,0,0,1],"1,1":[0,1,1,1,0]};function su(s){const n=new Array(5);let t=s>>>0;for(let a=4;a>=0;a--){const r=t&1;t>>=1;const l=t&1;t>>=1;const o=tu[`${l},${r}`];if(!o)throw new Error(`Unsupported marker id pattern for row ${a}`);n[a]=o.slice()}const i=Array.from({length:7},()=>new Array(7).fill(0));for(let a=0;a<5;a++)for(let r=0;r<5;r++)i[a+1][r+1]=n[a][r];return i}async function Dl(){const s=[];try{const n=await nu();for(const t of n){const i=await ru(t,[80,8080,8787,8788,3e3,5e3]);for(const a of i){const r=await ou(a.ip,a.port);r&&s.push(r)}}}catch(n){console.error("Network discovery failed:",n)}return s}async function nu(){const s=[];try{const n=new RTCPeerConnection({iceServers:[]});n.createDataChannel("");const t=await n.createOffer();return await n.setLocalDescription(t),new Promise(i=>{const a=setTimeout(()=>{n.close(),i(s)},5e3);n.onicecandidate=r=>{if(r.candidate){const o=r.candidate.candidate.match(/(\d+\.\d+\.\d+\.\d+)/);if(o&&o[1]&&!s.includes(o[1])){const d=o[1];au(d)&&s.push(d)}}else clearTimeout(a),n.close(),i(s)}})}catch(n){return console.error("Failed to get local IPs:",n),["192.168.1.0"]}}function au(s){const n=s.split(".").map(Number);return n[0]===10||n[0]===172&&n[1]>=16&&n[1]<=31||n[0]===192&&n[1]===168}async function ru(s,n){const t=[],i=s.split(".").slice(0,3).join("."),a=[];for(let l=1;l<=254;l++){const o=`${i}.${l}`;for(const d of n)a.push(iu(o,d))}return(await Promise.allSettled(a)).forEach((l,o)=>{if(l.status==="fulfilled"&&l.value){const d=o%n.length,c=Math.floor(o/n.length),h=`${i}.${c+1}`;t.push({ip:h,port:n[d]})}}),t}async function iu(s,n){try{const t=await fetch(`http://${s}:${n}/`,{method:"HEAD",mode:"no-cors",signal:AbortSignal.timeout(2e3)});return!0}catch{return!1}}async function ou(s,n){try{const t=["/","/api/info","/api/status","/camera","/stream"];for(const i of t)try{const a=await fetch(`http://${s}:${n}${i}`,{method:"GET",signal:AbortSignal.timeout(3e3)});if(a.ok){const r=a.headers.get("content-type")||"",l=await a.text();if(l.includes("OMNI")||l.includes("omni")||i.includes("omni"))return{id:`omni-${s}-${n}`,name:`OMNI Camera (${s})`,ip:s,port:n,type:"omni",capabilities:["video","calibration"],status:"online",connectionType:"wifi"};if(l.includes("VERT")||l.includes("vert")||i.includes("vert"))return{id:`vert-${s}-${n}`,name:`VERT Camera (${s})`,ip:s,port:n,type:"vert",capabilities:["video","calibration"],status:"online",connectionType:"wifi"};if(r.includes("video")||l.includes("stream")||i==="/stream")return{id:`generic-${s}-${n}`,name:`Network Camera (${s})`,ip:s,port:n,type:"generic",capabilities:["video"],status:"online",connectionType:"wifi"}}}catch{}}catch(t){console.error(`Failed to probe device ${s}:${n}:`,t)}return null}async function lu(){const s=[];try{if(!("serial"in navigator))return console.warn("Web Serial API not supported in this browser"),s;const n=await navigator.serial.getPorts();for(const t of n){const i=await El(t);i&&s.push(i)}}catch(n){console.error("USB device discovery failed:",n)}return s}async function cu(){try{if(!("serial"in navigator))return alert("Web Serial API not supported in this browser. Please use a compatible browser like Chrome or Edge."),null;const s=await navigator.serial.requestPort();return await El(s)}catch(s){return s.name!=="NotFoundError"&&console.error("USB device request failed:",s),null}}async function El(s){try{await s.open({baudRate:9600,dataBits:8,stopBits:1,parity:"none"});const n=s.readable?.getReader();if(n)try{const t=setTimeout(()=>n.cancel(),2e3),{value:i,done:a}=await n.read();if(clearTimeout(t),!a&&i){const r=new TextDecoder().decode(i);if(r.includes("OMNI")||r.includes("omni"))return n.releaseLock(),{id:`usb-omni-${Date.now()}`,name:"OMNI Camera (USB)",type:"omni",capabilities:["video","calibration"],status:"online",port:s};if(r.includes("VERT")||r.includes("vert"))return n.releaseLock(),{id:`usb-vert-${Date.now()}`,name:"VERT Camera (USB)",type:"vert",capabilities:["video","calibration"],status:"online",port:s}}}catch{}finally{try{n.releaseLock()}catch{}}return{id:`usb-generic-${Date.now()}`,name:"USB Scoring Device",type:"generic",capabilities:["video"],status:"online",port:s}}catch(n){return console.error("Failed to probe USB device:",n),null}}async function Ml(s){try{const n=`http://${s.ip}:${s.port}/stream`,t=document.createElement("video");return t.src=n,t.crossOrigin="anonymous",new Promise((i,a)=>{t.onloadeddata=()=>{const r=document.createElement("canvas"),l=r.getContext("2d");r.width=t.videoWidth,r.height=t.videoHeight;const o=r.captureStream(30),d=()=>{t.readyState>=2&&l.drawImage(t,0,0),requestAnimationFrame(d)};d(),i(o)},t.onerror=()=>a(new Error("Failed to load video stream")),t.load()})}catch(n){return console.error("Failed to connect to network device:",n),null}}async function du(s){try{if(!s.port)throw new Error("No serial port available");return console.log("USB device connection not fully implemented yet"),null}catch(n){return console.error("Failed to connect to USB device:",n),null}}const uu={};function mu(){const s=u.useRef(null),n=u.useRef(null),t=u.useRef(null),i=u.useRef(null),[a,r]=u.useState("unknown"),[l,o]=u.useState([]),[d,c]=u.useState(null),[h,m]=u.useState(!1),[x,p]=u.useState(!1),[g,w]=u.useState("camera"),[T,S]=u.useState(()=>localStorage.getItem("ndn:cal:mode")||"local"),[E,I]=u.useState([]),[M,P]=u.useState(!1),[A,v]=u.useState(null),[b,H]=u.useState(1),[W,R]=u.useState(()=>{if(typeof window>"u")return!1;try{return window.localStorage.getItem("ndn:cal:forceDesktop")==="1"}catch{return!1}}),[F,D]=u.useState(()=>typeof navigator>"u"?!1:/Android|iPhone|iPad|iPod|Mobi/i.test(navigator.userAgent)),{H:Q,setCalibration:me,reset:ue,errorPx:ke,locked:_e}=Ka(),Pe=Gn(),{calibrationGuide:Le,setCalibrationGuide:ve,preferredCameraId:Ee,cameraEnabled:$,setCameraEnabled:te,preferredCameraLocked:oe,setPreferredCameraLocked:He,setPreferredCamera:We}=Ft(),[we,Ie]=u.useState(null),[lt,pe]=u.useState(!1),[he,Oe]=u.useState(0),[xt,Rt]=u.useState(null),[hs,jt]=u.useState([]);u.useCallback((U,K=480)=>{if(typeof document>"u")throw new Error("Marker rendering only available in browser context");const ee=su(U),G=document.createElement("canvas");G.width=K,G.height=K;const N=G.getContext("2d");if(!N)return"";N.fillStyle="#ffffff",N.fillRect(0,0,K,K);const L=ee.length,_=ee[0]?.length||L,Y=K/_,ae=K/L;for(let ce=0;ce<L;ce++)for(let xe=0;xe<_;xe++)ee[ce][xe]&&(N.fillStyle="#000000",N.fillRect(Math.round(xe*Y),Math.round(ce*ae),Math.ceil(Y),Math.ceil(ae)));return G.toDataURL("image/png")},[]);const[Ne,Ht]=u.useState(null),ie=u.useRef(null),[fe,se]=u.useState(null),Z=u.useRef(null),[$e,ye]=u.useState(null),[Se,Qe]=u.useState(Date.now()),[Ke,mt]=u.useState(!1);function Be(U){try{Ht(U),ie.current=U}catch{}}const[ht,Ye]=u.useState(""),[Nt,it]=u.useState(null),[yt,C]=u.useState(null),[ne,Ae]=u.useState(!0),[Ce,ze]=u.useState([]),[pt,ns]=u.useState(!1),[Bt,Dt]=u.useState(null),as=u.useRef(null);u.useEffect(()=>{console.log("[Calibrator] ðŸ”„ STREAMING STATE CHANGED:",{streaming:h,phase:g,videoRefExists:!!s.current})},[h,g]),u.useEffect(()=>{const U=window.location.hostname;(U==="localhost"||U==="127.0.0.1")&&Pt("/api/hosts").then(K=>K.json()).then(K=>{const ee=Array.isArray(K?.hosts)&&K.hosts.find(G=>G);ee&&it(ee)}).catch(()=>{}),Pt("/api/https-info").then(K=>K.json()).then(K=>{K&&typeof K.https=="boolean"&&C({https:!!K.https,port:Number(K.port)||8788})}).catch(()=>{})},[]);const Et=u.useMemo(()=>{const U=Ne||"____",K="ws://localhost:8787";if(K.length>0)try{const _=new URL(K);return`${`${_.protocol==="wss:"?"https":"http"}://${_.host}${_.pathname.endsWith("/ws")?"":_.pathname}`.replace(/\/?ws$/i,"")}/mobile-cam.html?code=${U}`}catch{}const ee=Nt||window.location.hostname,G=!!yt?.https,N=G?yt?.port||8788:8787;return`${G?"https":"http"}://${ee}:${N}/mobile-cam.html?code=${U}`},[Ne,Nt,yt]),qs=u.useMemo(()=>{if(!Et)return null;try{const U=new URL(Et);return U.searchParams.delete("code"),U.toString().replace(/\?$/,"")}catch{return typeof window<"u"?`${window.location.origin.replace(/\/$/,"")}/mobile-cam.html`:"/mobile-cam.html"}},[Et]);u.useEffect(()=>{localStorage.setItem("ndn:cal:mode",T)},[T]),u.useEffect(()=>{if(!(typeof window>"u"))try{W?window.localStorage.setItem("ndn:cal:forceDesktop","1"):window.localStorage.removeItem("ndn:cal:forceDesktop")}catch{}},[W]),u.useEffect(()=>{if(typeof window>"u")return;const U=window.matchMedia("(pointer: coarse)"),K=()=>{const ee=typeof navigator<"u"&&/Android|iPhone|iPad|iPod|Mobi/i.test(navigator.userAgent),G=typeof U.matches=="boolean"?U.matches:!1,N=window.innerWidth<=820;D(ee||G||N)};K();try{typeof U.addEventListener=="function"?U.addEventListener("change",K):typeof U.addListener=="function"&&U.addListener(K)}catch{}return window.addEventListener("resize",K),()=>{try{typeof U.removeEventListener=="function"?U.removeEventListener("change",K):typeof U.removeListener=="function"&&U.removeListener(K)}catch{}window.removeEventListener("resize",K)}},[]),u.useEffect(()=>{if(!Ne){Ye("");return}const U=uu?.VITE_QR_LOGO_URL||"/dart-thrower.svg";Nl(Et,{width:256,margin:2,errorCorrectionLevel:"H",color:{dark:"#000000",light:"#ffffff"},logo:{logoUrl:U,logoScale:.2,mask:!0,shape:"circle"}}).then(Ye).catch(()=>Ye(""))},[Et,Ne]),u.useEffect(()=>{if(typeof navigator>"u"||!navigator.permissions){r("unsupported");return}let U=!0;return(async()=>{try{const K=await navigator.permissions.query({name:"camera"});if(!U)return;r(K.state||"unknown"),K.onchange=()=>{U&&r(K.state)}}catch{U&&r("unknown")}})(),()=>{U=!1}},[]);async function vs(){if(!(typeof navigator>"u"||!navigator.mediaDevices||!navigator.mediaDevices.enumerateDevices))try{const K=(await navigator.mediaDevices.enumerateDevices()).filter(ee=>ee.kind==="videoinput").map(ee=>({deviceId:ee.deviceId,label:ee.label||"Camera"}));o(K),K.length&&!d&&c(K[0].deviceId)}catch{}}async function fs(U){if(typeof navigator>"u"||!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia){alert("getUserMedia is not available in this browser");return}const K={video:U?{deviceId:{exact:U}}:{facingMode:"environment"}};let ee=null;try{ee=await navigator.mediaDevices.getUserMedia(K),ee.getTracks().forEach(G=>G.stop()),r("granted");try{U&&typeof We=="function"&&We(U)}catch{}alert("Camera access granted â€” your webcam is available and set as preferred.")}catch(G){console.error("[Calibrator] testCamera failed",G),G&&(G.name==="NotAllowedError"||G.name==="PermissionDeniedError")?(r("denied"),alert("Camera permission denied. Please allow camera access in your browser settings and try again.")):G&&(G.name==="NotFoundError"||G.name==="DevicesNotFoundError")?alert("No camera devices found. Ensure your USB webcam is connected and not in use by another app."):alert("Unable to access the camera: "+(G?.message||G))}finally{ee&&ee.getTracks().forEach(G=>G.stop())}}function Kt(){if(typeof window>"u")return;const U=navigator.userAgent||"";let K=null;/Edg\//.test(U)||/Chrome\//.test(U)||/Chromium\//.test(U)?K="chrome://settings/content/camera":/Firefox\//.test(U)?K="about:preferences#privacy":/Safari\//.test(U)&&!/Chrome\//.test(U)&&(K=null),K?window.open(K,"_blank")||alert('Unable to open browser settings automatically. Please open your browser settings and search for "Camera" permissions for this site.'):alert("Please open your browser settings and locate Site Settings â†’ Camera (or Permissions) and allow camera access for this site. In Safari, use Preferences â†’ Websites â†’ Camera.")}u.useEffect(()=>{if(!$e)return;const U=setInterval(()=>Qe(Date.now()),1e3);return()=>clearInterval(U)},[$e]);const xs=u.useMemo(()=>$e?Math.max(0,Math.ceil(($e-Se)/1e3)):null,[$e,Se]);u.useEffect(()=>()=>{as.current&&window.clearTimeout(as.current)},[]);const z=u.useCallback(async(U,K)=>{if(U)try{if(navigator.clipboard&&navigator.clipboard.writeText)await navigator.clipboard.writeText(U);else{const ee=document.createElement("textarea");ee.value=U,ee.style.position="fixed",ee.style.opacity="0",document.body.appendChild(ee),ee.focus(),ee.select(),document.execCommand("copy"),document.body.removeChild(ee)}Dt(K),as.current&&window.clearTimeout(as.current),as.current=window.setTimeout(()=>Dt(null),1500)}catch(ee){console.warn("[Calibrator] Copy failed:",ee),Dt(null)}},[]);u.useEffect(()=>()=>{},[]),u.useEffect(()=>{const U=K=>{console.log("[Calibrator] Received reconnect request from PhoneCameraOverlay"),T==="phone"&&Ke&&(ls(!1),setTimeout(()=>{wt()},500))};return window.addEventListener("ndn:phone-camera-reconnect",U),()=>{window.removeEventListener("ndn:phone-camera-reconnect",U)}},[T,Ke]),u.useEffect(()=>{console.log("[Calibrator] ðŸ”„ STREAMING CHANGED:",{streaming:h,videoRefAvailable:!!s.current}),s.current?(console.log("[Calibrator] âœ… Syncing videoElementRef on streaming change"),Pe.setVideoElementRef(s.current),s.current.srcObject instanceof MediaStream&&(console.log("[Calibrator] âœ… Setting mediaStream from video element"),Pe.setMediaStream(s.current.srcObject))):console.warn("[Calibrator] âš ï¸ videoRef.current is null on streaming change!")},[h]),u.useEffect(()=>(console.log("[Calibrator] ðŸš€ MOUNT: Initial mount - syncing videoRef"),console.log("[Calibrator] videoRef.current available:",!!s.current),console.log("[Calibrator] videoRef.current type:",s.current?.constructor?.name),s.current?(console.log("[Calibrator] âœ… Setting videoElementRef on mount"),console.log("[Calibrator] Video element:",{tagName:s.current.tagName,srcObject:!!s.current.srcObject,videoWidth:s.current.videoWidth,videoHeight:s.current.videoHeight}),Pe.setVideoElementRef(s.current),console.log("[Calibrator] âœ… videoElementRef set successfully")):console.error("[Calibrator] âŒ CRITICAL: videoRef.current is NULL at mount!"),()=>{}),[]);function be(){if(fe&&(fe.readyState===WebSocket.OPEN||fe.readyState===WebSocket.CONNECTING))return console.log("[Calibrator] ensureWS: Reusing existing WebSocket (state:",fe.readyState,")"),fe;const U="ws://localhost:8787",K=U.length>0?U.endsWith("/ws")?U:U.replace(/\/$/,"")+"/ws":void 0,G=`${window.location.protocol==="https:"?"wss":"ws"}://${window.location.host}/ws`,N=window.location.hostname,_=K||(N.endsWith("onrender.com")?G:"wss://ninedartnation.onrender.com/ws");console.log("[Calibrator] ensureWS: Creating new WebSocket to:",_);let Y=new WebSocket(_);return Y.onerror=ae=>{console.error("[Calibrator] WebSocket connection error:",ae),alert("Failed to connect to camera pairing service. Please check your internet connection and try again.")},Y.onclose=ae=>{if(console.log("[Calibrator] WebSocket closed:",ae.code,ae.reason),Z.current){try{Z.current.close()}catch{}Z.current=null}Be(null),ye(null),mt(!1),ae.code!==1e3&&(alert("Camera pairing connection lost. Please try pairing again."),T==="phone"&&S("local"))},se(Y),Y}async function wt(){S("phone"),ls(!1),js();try{te(!0)}catch{}const U=be();U.readyState===WebSocket.OPEN?(console.log("[Calibrator] WebSocket open, sending cam-create"),U.send(JSON.stringify({type:"cam-create"}))):(console.log("[Calibrator] WebSocket connecting, will send cam-create on open"),U.onopen=()=>{console.log("[Calibrator] WebSocket now open, sending cam-create"),U.send(JSON.stringify({type:"cam-create"}))}),U.onmessage=async K=>{const ee=JSON.parse(K.data);if(ee.type==="cam-code")Be(ee.code),ee.expiresAt&&ye(ee.expiresAt);else if(ee.type==="cam-peer-joined"){!ie.current&&ee.code&&Be(ee.code),mt(!0);const G=ie.current||ee.code||null;G&&(ie.current=G);try{if(_e&&G){const L=n.current?{w:n.current.width,h:n.current.height}:null,_={H:Q,imageSize:L,errorPx:ke??null,createdAt:Date.now()};U.send(JSON.stringify({type:"cam-calibration",code:G,payload:_})),console.log("[Calibrator] Sent calibration to joined phone for code",G)}}catch(L){console.warn("[Calibrator] Failed to send calibration on peer join",L)}const N=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}],iceCandidatePoolSize:10});Z.current=N,N.onconnectionstatechange=()=>{console.log("WebRTC connection state:",N.connectionState),N.connectionState==="failed"||N.connectionState==="disconnected"?(console.error("WebRTC connection failed"),alert("Camera connection lost. Please try pairing again."),ls(!1)):N.connectionState==="connected"&&console.log("WebRTC connection established")},N.onicecandidate=L=>{L.candidate&&G&&U.send(JSON.stringify({type:"cam-ice",code:G,payload:L.candidate}))},N.ontrack=L=>{if(console.log("[Calibrator] WebRTC ontrack received:",L.streams?.length,"streams, track kind:",L.track?.kind),s.current){const _=L.streams?.[0];_?(console.log("[Calibrator] Assigning video stream (tracks:",_.getTracks().length,") to video element"),P(!1),setTimeout(()=>{s.current&&(console.log("[Calibrator] Setting srcObject and attempting play"),s.current.srcObject&&s.current.srcObject.getTracks().forEach(ae=>ae.stop()),s.current.srcObject=_,s.current.muted=!0,s.current.playsInline=!0,s.current.play().then(()=>{console.log("[Calibrator] Video playback started successfully"),m(!0),w("capture"),Pe.setStreaming(!0),Pe.setMode("phone"),Pe.setMediaStream(_);try{We(void 0,"Phone Camera",!0)}catch{}if(!oe)try{He(!0)}catch{}try{te(!0)}catch{}p(!1)}).catch(Y=>{console.error("[Calibrator] Video play failed:",Y),p(!0),console.warn("[Calibrator] video play blocked â€” prompting user interaction")}))},100)):console.error("[Calibrator] No inbound stream received in ontrack")}else console.error("[Calibrator] Video element not available")};try{const L=await N.createOffer({offerToReceiveAudio:!1,offerToReceiveVideo:!0});await N.setLocalDescription(L),console.log("[Calibrator] Sending cam-offer for code:",G),G?U.send(JSON.stringify({type:"cam-offer",code:G,payload:L})):console.warn("[Calibrator] Missing pairing code when sending offer")}catch(L){console.error("Failed to create WebRTC offer:",L),alert("Failed to establish camera connection. Please try again."),ls(!1)}}else if(ee.type==="cam-answer"){console.log("[Calibrator] Received cam-answer");const G=Z.current;if(G)try{await G.setRemoteDescription(new RTCSessionDescription(ee.payload)),console.log("[Calibrator] Remote description set (answer)");const N=pendingIceCandidatesRef.current;console.log(`[Calibrator] Processing ${N.length} pending ICE candidates`);for(const L of N)try{await G.addIceCandidate(L),console.log("[Calibrator] Queued ICE candidate added")}catch(_){console.error("Failed to add queued ICE candidate:",_)}pendingIceCandidatesRef.current=[]}catch(N){console.error("Failed to set remote description:",N),alert("Camera pairing failed. Please try again."),ls(!1)}else console.warn("[Calibrator] Received cam-answer but no peer connection exists")}else if(ee.type==="cam-ice"){console.log("[Calibrator] Received cam-ice");const G=Z.current;if(G)if(G.remoteDescription)try{await G.addIceCandidate(ee.payload),console.log("[Calibrator] ICE candidate added")}catch(N){console.error("Failed to add ICE candidate:",N)}else console.log("[Calibrator] Remote description not set yet, queuing ICE candidate"),pendingIceCandidatesRef.current.push(ee.payload);else console.warn("[Calibrator] Received ICE candidate but no peer connection exists")}else if(ee.type==="cam-error")console.error("Camera pairing error:",ee.code),alert(ee.code==="EXPIRED"?"Code expired. Generate a new code.":`Camera error: ${ee.code||"Unknown error"}`),ls(!1);else if(ee.type==="cam-calibration"){console.log("[Calibrator] Received calibration from peer:",ee.payload);try{ee.payload&&ee.payload.H&&Array.isArray(ee.payload.H)&&(me({H:ee.payload.H,createdAt:ee.payload.createdAt||Date.now(),errorPx:ee.payload.errorPx,imageSize:ee.payload.imageSize,locked:!0}),console.log("[Calibrator] Applied received calibration"))}catch(G){console.error("[Calibrator] Failed to apply received calibration",G)}}}}async function Ut(){ns(!0);try{const U=await Dl();ze(U),U.length===0&&alert("No wifi scoring devices found on your network. Make sure devices are powered on and connected to the same network.")}catch(U){console.error("Wifi device discovery failed:",U),alert("Failed to discover wifi devices. Please check your network connection.")}finally{ns(!1)}w("camera")}async function ps(U){try{ze(ee=>ee.map(G=>G.id===U.id?{...G,status:"connecting"}:G));const K=await Ml(U);if(K&&s.current)s.current.srcObject&&s.current.srcObject.getTracks().forEach(G=>G.stop()),s.current.srcObject=K,await s.current.play(),m(!0),w("capture"),ze(ee=>ee.map(G=>G.id===U.id?{...G,status:"online"}:G));else throw new Error("Failed to get video stream")}catch(K){console.error("Failed to connect to wifi device:",K),alert(`Failed to connect to ${U.name}. Please check the device and try again.`),ze(ee=>ee.map(G=>G.id===U.id?{...G,status:"offline"}:G))}}async function Us(){if(T==="phone")return wt();if(T==="wifi")return Ut();console.log("[Calibrator] ðŸŽ¬ START_CAMERA: mode=",T,"preferredCameraId=",Ee);try{let U=null;if(Ee)try{console.log("[Calibrator] ðŸ“¹ Attempt 1: Using preferred camera ID:",Ee),U=await navigator.mediaDevices.getUserMedia({video:{deviceId:{exact:Ee}},audio:!1}),console.log("[Calibrator] âœ… SUCCESS with preferred camera:",U.getTracks().length,"tracks")}catch(K){console.warn("[Calibrator] âš ï¸ Preferred camera failed:",K?.name,K?.message)}if(!U)try{console.log("[Calibrator] ðŸ“¹ Attempt 2: Using ANY available camera"),U=await navigator.mediaDevices.getUserMedia({video:!0,audio:!1}),console.log("[Calibrator] âœ… SUCCESS with fallback camera:",U.getTracks().length,"tracks")}catch(K){throw console.error("[Calibrator] âŒ BOTH attempts failed:",K?.name,K?.message),K}if(!U)throw new Error("No stream obtained");if(!s.current)throw new Error("Video element ref is null");console.log("[Calibrator] ðŸ“º Assigning stream to video element"),s.current.srcObject=U,console.log("[Calibrator] â–¶ï¸ Calling play()");try{await s.current.play(),console.log("[Calibrator] âœ… Play succeeded")}catch(K){console.warn("[Calibrator] âš ï¸ Play failed, retrying in 100ms:",K?.message),await new Promise(ee=>setTimeout(ee,100)),await s.current.play(),console.log("[Calibrator] âœ… Play succeeded on retry")}console.log("[Calibrator] ðŸŸ¢ Setting streaming = true"),m(!0),w("capture"),console.log("[Calibrator] ðŸŸ¢ State updated")}catch(U){console.error("[Calibrator] ðŸ”´ FATAL:",U?.message||U),alert(`Camera failed: ${U?.message||"Unknown error"}`),s.current?.srcObject&&(s.current.srcObject.getTracks().forEach(K=>K.stop()),s.current.srcObject=null)}}function ls(U=!1){if(s.current&&s.current.srcObject&&(s.current.srcObject.getTracks().forEach(ee=>ee.stop()),s.current.srcObject=null,m(!1)),Z.current){try{Z.current.close()}catch{}Z.current=null}pendingIceCandidatesRef.current=[],Be(null),ye(null),mt(!1),Rt(null),Pe.setStreaming(!1),Pe.setMediaStream(null),U&&(T==="phone"||T==="wifi")&&S("local")}function $s(){fe&&fe.readyState===WebSocket.OPEN?fe.send(JSON.stringify({type:"cam-create"})):wt(),js()}function js(){try{oe||He(!0)}catch{}}function gs(){try{i.current?.click()}catch{}}function As(){const U=`${window.location.origin}/marker-sheet.html`;window.open(U,"_blank")}function ys(){if(!s.current||!n.current)return;const U=s.current,K=n.current;K.width=U.videoWidth,K.height=U.videoHeight,K.getContext("2d").drawImage(U,0,0,K.width,K.height),P(!0),v({w:K.width,h:K.height}),w("select"),I([]),Rt(null),lt&&setTimeout(()=>{ks()},0)}function rs(U=E,K=null){if(!n.current||!t.current)return;const ee=n.current,G=t.current;G.width=ee.width,G.height=ee.height;const N=G.getContext("2d");N.clearRect(0,0,G.width,G.height);const L=K||Q;if(L){const _=[Ge.bullInner,Ge.bullOuter,Ge.trebleInner,Ge.trebleOuter,Ge.doubleInner,Ge.doubleOuter];for(const Y of _){const ae=_e?"#10b981":Y===Ge.doubleOuter?"#22d3ee":"#a78bfa",ce=_e||Y===Ge.doubleOuter?3:2,xe=Sl(L,Y,360);Cl(N,xe,ae,ce)}}if(!L&&we){const _=(Y,ae,ce=2)=>{N.save(),N.strokeStyle=ae,N.lineWidth=ce,N.beginPath(),N.arc(we.cx,we.cy,Y,0,Math.PI*2),N.stroke(),N.restore()};_(we.doubleOuter,"#22d3ee",3),_(we.doubleInner,"#22d3ee",2),_(we.trebleOuter,"#fde047",2),_(we.trebleInner,"#fde047",2),_(we.bullOuter,"#34d399",2),_(we.bullInner,"#10b981",3)}if(U.length<6&&L){N.save(),N.strokeStyle="rgba(255,193,7,0.4)",N.lineWidth=2,N.setLineDash([4,4]);const _=wa();for(let Y=U.length;Y<6&&Y<_.length;Y++)try{const ae=Wn(L,_[Y]);N.beginPath(),N.arc(ae.x,ae.y,12,0,Math.PI*2),N.stroke()}catch{}N.restore()}if(U.forEach((_,Y)=>{Oo(N,_,"#f472b6"),N.save(),N.fillStyle="#f472b6",N.font="14px sans-serif",N.fillText(String(Y+1),_.x+6,_.y-6),N.restore()}),Le&&!_e){N.save(),N.fillStyle="rgba(59,130,246,0.10)";const _=Math.round(Math.min(G.width,G.height)*.08),Y=G.width-_*2,ae=G.height-_*2;N.fillRect(_,_,Y,ae),N.strokeStyle="rgba(34,197,94,0.9)",N.lineWidth=2,N.beginPath(),N.moveTo(_,G.height/2),N.lineTo(G.width-_,G.height/2),N.stroke(),N.beginPath(),N.moveTo(G.width/2,_),N.lineTo(G.width/2,G.height-_),N.stroke(),N.strokeStyle="rgba(234,179,8,0.9)",N.setLineDash([6,4]);const ce=_+30,xe=_+30;N.beginPath(),N.moveTo(ce,xe+30),N.lineTo(ce+60,xe),N.stroke(),N.beginPath(),N.moveTo(G.width-ce,xe+30),N.lineTo(G.width-ce-60,xe),N.stroke(),N.restore(),N.save(),N.scale(1/b,1/b),N.fillStyle="rgba(255,255,255,0.85)",N.font="12px sans-serif",N.fillText("Tip: Frame board centered, edges parallel; slight top-down is okay. Keep bull near center.",_*b,(_+18)*b),N.restore()}}function Ns(U){if(g!=="select")return;const K=U.target,ee=K.getBoundingClientRect(),G=U.clientX-ee.left,N=U.clientY-ee.top,L=K.width>0?K.width/ee.width:1,_=K.height>0?K.height/ee.height:1,Y=G*L,ae=N*_,ce=[...E,{x:Y,y:ae}];ce.length<=6&&(I(ce),rs(ce))}function Rs(){if(!n.current)return;if(E.length<4)return alert("Please click at least 4 points on the board.");if(E.length<6)return alert("For best accuracy, click all 6 calibration points: TOP, RIGHT, BOTTOM, LEFT of double rim, plus BULLSEYE center and OUTER BULL top.");const U=wa(),K=si(U,E);rs(E,K);const ee=ni(K,U,E);me({H:K,createdAt:Date.now(),errorPx:ee,imageSize:{w:n.current.width,h:n.current.height},anchors:{src:U,dst:E}}),w("computed")}function Vt(){if(!Q||!t.current)return alert("Please compute calibration first (lock) before running verification.");try{const U=[{label:"Bull (50)",p:{x:0,y:0}},{label:"Outer Bull (25)",p:{x:0,y:-Ge.bullOuter}},{label:"Triple 20",p:{x:0,y:-((Ge.trebleInner+Ge.trebleOuter)/2)}},{label:"Single 5 (near 5 sector)",p:{x:(Ge.trebleInner+Ge.trebleOuter)/2*Math.cos(Math.PI*.1),y:(Ge.trebleInner+Ge.trebleOuter)/2*Math.sin(Math.PI*.1)}}],K=t.current.getContext("2d");rs(E,Q);const ee=[];for(const G of U){const N=Wn(Q,{x:G.p.x,y:G.p.y}),L=kl(Q,N),_=ai(L),Y=ai(G.p),ae=Y.base===_.base&&Y.mult===_.mult||Y.base===_.base;ee.push({label:G.label,expected:Y,detected:_,match:ae}),Oo(K,N,ae?"#10b981":"#ef4444"),K.fillStyle=ae?"#10b981":"#ef4444",K.font="12px sans-serif",K.fillText(G.label,N.x+6,N.y-6)}jt(ee)}catch(U){console.error("Verification failed",U),alert("Verification failed: "+U?.message)}}async function ks(){if(!n.current)return alert("Load a photo or capture a frame first.");Rt(null);const U=n.current,ee=Math.min(1,800/U.width),G=Math.max(1,Math.round(U.width*ee)),N=Math.max(1,Math.round(U.height*ee)),L=document.createElement("canvas");L.width=G,L.height=N;const _=L.getContext("2d");_.drawImage(U,0,0,G,N);const Y=_.getImageData(0,0,G,N),ae=new Float32Array(G*N);for(let Xe=0,ot=0;Xe<Y.data.length;Xe+=4,ot++){const nt=Y.data[Xe],_t=Y.data[Xe+1],Je=Y.data[Xe+2];ae[ot]=.299*nt+.587*_t+.114*Je}const ce=new Float32Array(G*N),xe=new Float32Array(G*N);for(let Xe=1;Xe<N-1;Xe++)for(let ot=1;ot<G-1;ot++){const nt=Xe*G+ot,_t=ae[nt-G-1],Je=ae[nt-G],kt=ae[nt-G+1],vt=ae[nt-1],zt=ae[nt+1],es=ae[nt+G-1],Xt=ae[nt+G],sn=ae[nt+G+1];ce[nt]=-_t-2*vt-es+(kt+2*zt+sn),xe[nt]=-_t-2*Je-kt+(es+2*Xt+sn)}const je=new Float32Array(G*N);let Te=1;for(let Xe=0;Xe<je.length;Xe++){const ot=Math.hypot(ce[Xe],xe[Xe]);je[Xe]=ot,ot>Te&&(Te=ot)}const Mt=Math.floor(G/2),st=Math.floor(N/2),ft=Math.floor(Math.min(G,N)*.35),ct=Math.floor(Math.min(G,N)*.52);let bt={score:-1,cx:Mt,cy:st,r:Math.floor((ft+ct)/2)};const is=Math.max(2,Math.floor(Math.min(G,N)*.01)),cs=Math.max(2,Math.floor(Math.min(G,N)*.01));for(let Xe=st-Math.floor(N*.08);Xe<=st+Math.floor(N*.08);Xe+=is)for(let ot=Mt-Math.floor(G*.08);ot<=Mt+Math.floor(G*.08);ot+=is)for(let nt=ft;nt<=ct;nt+=cs){let _t=0;const Je=360;for(let kt=0;kt<Je;kt++){const vt=kt*Math.PI/180,zt=Math.round(ot+nt*Math.cos(vt)),es=Math.round(Xe+nt*Math.sin(vt));zt<=0||zt>=G-1||es<=0||es>=N-1||(_t+=je[es*G+zt])}_t>bt.score&&(bt={score:_t,cx:ot,cy:Xe,r:nt})}const Wt=1/ee,ds=bt.cx*Wt,us=bt.cy*Wt,Ks=bt.r*Wt;function St(Xe){let ot=0;const nt=Xe*ee,_t=360;for(let Je=0;Je<_t;Je++){const kt=Je*Math.PI/180,vt=Math.round(bt.cx+nt*Math.cos(kt)),zt=Math.round(bt.cy+nt*Math.sin(kt));vt<=0||vt>=G-1||zt<=0||zt>=N-1||(ot+=je[zt*G+vt])}return ot}const Ot={bullInner:Ge.bullInner/Ge.doubleOuter,bullOuter:Ge.bullOuter/Ge.doubleOuter,trebleInner:Ge.trebleInner/Ge.doubleOuter,trebleOuter:Ge.trebleOuter/Ge.doubleOuter,doubleInner:Ge.doubleInner/Ge.doubleOuter};function Ze(Xe,ot=.08){const nt=Math.max(1,Math.floor(Xe*(1-ot))),_t=Math.max(nt+1,Math.floor(Xe*(1+ot)));let Je=nt,kt=-1;for(let vt=nt;vt<=_t;vt++){const zt=St(vt);zt>kt&&(kt=zt,Je=vt)}return Je}const dt=Ks,ut=Ze(dt*Ot.doubleInner),Yt=Ze(dt*Ot.trebleOuter),$t=Ze(dt*Ot.trebleInner),Tt=Ze(dt*Ot.bullOuter),bs=Ze(dt*Ot.bullInner);Ie({cx:ds,cy:us,bullInner:bs,bullOuter:Tt,trebleInner:$t,trebleOuter:Yt,doubleInner:ut,doubleOuter:dt});const gt=Xe=>{let nt=0;for(let _t=0;_t<180;_t++){const Je=_t*Math.PI/90,kt=Math.round(bt.cx+Xe*ee*Math.cos(Je)),vt=Math.round(bt.cy+Xe*ee*Math.sin(Je));kt<=0||kt>=G-1||vt<=0||vt>=N-1||(nt+=je[vt*G+kt])}return nt/180},Gt=(gt(bt.r)+gt(Yt)+gt($t)+gt(ut)+gt(Tt)+gt(bs))/(Te*6),Ts=Math.max(0,Math.min(1,Gt)),ws=Math.min(Ts,Math.min(gt(bt.r)/Te,gt(Yt)/Te,gt($t)/Te,gt(ut)/Te,gt(Tt)/Te,gt(bs)/Te));Oe(Math.round(ws*100));const Ds=[{x:ds,y:us-dt},{x:ds+dt,y:us},{x:ds,y:us+dt},{x:ds-dt,y:us},{x:ds,y:us},{x:ds,y:us-Tt}];I(Ds),rs(Ds);try{const Xe=wa(),ot=si(Xe,Ds);rs(Ds,ot);const nt=ni(ot,Xe,Ds);me({H:ot,createdAt:Date.now(),errorPx:nt,imageSize:{w:n.current.width,h:n.current.height},anchors:{src:Xe,dst:Ds}}),w("computed")}catch(Xe){console.error("[Calibrator] Auto-detect compute failed:",Xe)}const Es=ws>=.95;me({locked:Es})}function Zt(){if(!n.current)return alert("Capture a frame or upload a photo first.");const U=eu(n.current);if(Rt(U),!U.success||!U.homography){const N=U.missing.length?` Missing markers: ${U.missing.map(L=>`${L.toUpperCase()} (ID ${Fn[L]})`).join(", ")}`:"";alert(U.message?`${U.message}${N}`:`Marker detection failed.${N}`);return}Ie(null),I(U.points),rs(U.points,U.homography);const K=wa(),ee={w:n.current.width,h:n.current.height},G=(U.errorPx??Number.POSITIVE_INFINITY)<=1.2;me({H:U.homography,createdAt:Date.now(),errorPx:U.errorPx??null,imageSize:ee,anchors:{src:K,dst:U.points},locked:G?!0:_e}),w("computed")}u.useEffect(()=>{rs()},[M,Q]),u.useEffect(()=>{if(!lt||!h)return;let U=0;const K=()=>{try{ys()}catch{}U=requestAnimationFrame(K)};return U=requestAnimationFrame(K),()=>cancelAnimationFrame(U)},[lt,h]),u.useEffect(()=>{(async()=>{try{if(!_e||!Ne)return;const U=n.current?{w:n.current.width,h:n.current.height}:null,K=JSON.stringify({H:Q,anchors:null,imageSize:U,errorPx:ke??null});try{await Pt(`/cam/calibration/${Ne}`,{method:"POST",headers:{"Content-Type":"application/json"},body:K}),console.log("[Calibrator] Posted calibration for code",Ne)}catch(ee){console.warn("[Calibrator] Upload calibration failed",ee)}try{const ee=localStorage.getItem("authToken");ee&&(await Pt("/api/user/calibration",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${ee}`},body:K}),console.log("[Calibrator] Synced calibration to user account"))}catch(ee){console.warn("[Calibrator] User calibration sync failed",ee)}}catch{}})()},[_e,Ne]);function Ps(){const{preferredCameraId:K,preferredCameraLabel:ee,setPreferredCamera:G,cameraEnabled:N,setCameraEnabled:L,preferredCameraLocked:_,setPreferredCameraLocked:Y}=Ft(),[ae,ce]=u.useState([]),[xe,je]=u.useState(null),[Te,Mt]=u.useState(""),[st,ft]=u.useState(!1),ct=u.useRef(null),bt=u.useRef(0),is=u.useRef(!1),cs=document.getElementById("dropdown-portal-root")||(()=>{const Ze=document.createElement("div");return Ze.id="dropdown-portal-root",document.body.appendChild(Ze),Ze})();async function Wt(){console.debug("[DevicePicker] enumerate start",Date.now()),Mt("");try{try{(await navigator.mediaDevices.getUserMedia({video:!0})).getTracks().forEach(Yt=>Yt.stop())}catch{}const dt=(await navigator.mediaDevices.enumerateDevices()).filter(ut=>ut.kind==="videoinput");ce(dt),ct.current&&ct.current.dataset?.open==="true"&&je(dt),console.debug("[DevicePicker] enumerate -> devices",dt.map(ut=>ut.deviceId),"snapshot?",!!(ct.current&&ct.current.dataset?.open==="true"))}catch{Mt("Unable to list cameras. Grant camera permission in your browser.")}}u.useEffect(()=>{Wt()},[]),u.useEffect(()=>{function Ze(dt){try{if(console.debug("[DevicePicker] document.mousedown",{target:(dt&&dt.target)?.tagName||String(dt.target),time:Date.now(),ignoreUntil:bt.current}),is.current){console.debug("[DevicePicker] document.mousedown ignored because suspendDocHandlerRef is true",Date.now());return}if(Date.now()<(bt.current||0))return;const ut=dt.target,Yt=ct.current&&ct.current.contains(ut),$t=cs&&cs.contains&&cs.contains(ut);!Yt&&!$t&&(console.debug("[DevicePicker] document.mousedown -> closing dropdown (outside both main+portal)",Date.now()),ft(!1))}catch{}}return document.addEventListener("mousedown",Ze),()=>document.removeEventListener("mousedown",Ze)},[]);const ds=ae.find(Ze=>Ze.deviceId===K),us=ds?`${ds.label||"Camera"}`:K?"Camera (unavailable)":"Auto (browser default)",[Ks,St]=u.useState(us),Ot=K&&!ds;return e.jsxs("div",{className:"mt-3 p-3 rounded-lg border border-indigo-500/30 bg-indigo-500/5",children:[e.jsx("div",{className:"font-semibold mb-2",children:"Select camera device"}),Te&&e.jsx("div",{className:"text-rose-400 text-sm mb-2",children:Te}),Ot&&e.jsxs("div",{className:"text-amber-400 text-sm mb-2",children:["Selected camera is no longer available.",e.jsx("button",{className:"underline ml-1",onClick:()=>G(void 0,"",!0),disabled:h,children:"Use auto-selection"})]}),e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[_?e.jsx("div",{className:"text-xs text-emerald-400",children:"ðŸ”’ Camera selection locked"}):e.jsx("div",{className:"text-xs text-slate-400",children:"Camera selection unlocked"}),e.jsx("button",{className:"btn btn--ghost px-2 py-0.5 text-xs ml-2",onClick:()=>{Y(!_)},children:_?"Unlock":"Lock"})]}),e.jsxs("div",{className:"flex items-center gap-3 mb-3",children:[e.jsx("input",{type:"checkbox",id:"cameraEnabled-calibrator",checked:N,onChange:Ze=>L(Ze.target.checked),className:"w-4 h-4",disabled:h}),e.jsx("label",{htmlFor:"cameraEnabled-calibrator",className:"text-sm",children:"Enable camera for scoring"})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-2 items-center text-sm",children:[e.jsxs("select",{className:"input col-span-2",value:K||"auto",onChange:Ze=>{const dt=Ze.target.value;if(console.debug("[DevicePicker] select onChange",dt,Date.now()),dt==="auto")try{G(void 0,"",!0)}catch{}else if(dt==="phone"){try{G(void 0,"Phone Camera",!0)}catch{}try{S("phone"),w("camera"),m(!1),P(!1)}catch{}}else{const ut=ae.find(Yt=>Yt.deviceId===dt);if(ut)try{G(ut.deviceId,ut.label||"",!0)}catch{}}},children:[e.jsx("option",{value:"auto",children:"Auto (browser default)"}),ae.map(Ze=>e.jsx("option",{value:Ze.deviceId,children:Ze.label||"Camera"},Ze.deviceId)),e.jsx("option",{value:"phone",children:"ðŸ“± Phone Camera"})]}),e.jsx("div",{className:"text-right",children:e.jsx("button",{className:"btn px-2 py-1",onClick:()=>{fs(K||void 0)},disabled:h,children:"Test"})})]}),ee&&e.jsxs("div",{className:"text-xs opacity-70 mt-1",children:["Selected: ",ee]}),e.jsx("div",{className:"text-xs opacity-70 mt-1",children:"Tip: All camera technology is supported for autoscoring needsâ€”select your camera here and then open Calibrator to align."})]})}if(F&&!W){const U=qs??(typeof window<"u"?`${window.location.origin.replace(/\/$/,"")}/mobile-cam.html`:"/mobile-cam.html");return e.jsxs("div",{className:"mx-auto flex min-h-[calc(100vh-140px)] w-full max-w-xl flex-col justify-center gap-6 p-6",children:[e.jsxs("div",{className:"space-y-5 rounded-3xl border border-indigo-400/30 bg-slate-900/70 p-6 text-slate-100 shadow-xl",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-xs font-semibold uppercase tracking-wide text-indigo-300",children:"Mobile camera"}),e.jsx("h2",{className:"text-2xl font-semibold leading-tight text-white",children:"This device is ready to stream as your dartboard camera"}),e.jsx("p",{className:"text-sm text-slate-200/80",children:"Open the lightweight mobile camera page to stream video to your desktop calibrator. You can still come back here if you need the full desktop tools."})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("a",{href:U,className:"btn w-full justify-center px-4 py-2 text-base",children:"Open mobile camera"}),e.jsx("button",{type:"button",className:"btn btn--ghost w-full justify-center px-4 py-2 text-sm",onClick:()=>z(U,"link"),children:Bt==="link"?"Link copied!":"Copy link"})]}),e.jsxs("p",{className:"text-xs text-slate-300/70",children:["On a desktop, open Calibrator and generate a pairing code. Then tap ",e.jsx("span",{className:"font-semibold",children:"Pair with Desktop"})," from the mobile camera page to connect this device."]})]}),e.jsx("button",{type:"button",className:"self-center text-xs font-medium text-indigo-200 underline decoration-dotted decoration-indigo-300/70 transition hover:text-indigo-100",onClick:()=>R(!0),children:"Continue to desktop calibrator"})]})}return e.jsxs("div",{className:"space-y-6",children:[F&&W&&e.jsx("div",{className:"rounded-2xl border border-indigo-400/30 bg-indigo-500/10 p-4 text-sm text-indigo-100",children:e.jsxs("div",{className:"flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between",children:[e.jsx("p",{className:"leading-relaxed",children:"Using a phone? Switch back to the streamlined mobile camera interface for an easier pairing flow."}),e.jsx("button",{type:"button",className:"btn btn--ghost px-3 py-1 text-xs",onClick:()=>R(!1),children:"Open mobile camera mode"})]})}),e.jsxs("div",{className:"card space-y-6 p-6",children:[e.jsxs("header",{className:"flex flex-wrap items-start justify-between gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-xs font-semibold uppercase tracking-wide text-indigo-300",children:"Marker calibration"}),e.jsx("h2",{className:"text-2xl font-semibold leading-tight text-white",children:"Align your board with the autoscoring overlay"}),e.jsx("p",{className:"max-w-2xl text-sm opacity-80",children:"Place the printable fiducial markers around the double ring, capture a clear frame, and let the calibrator compute a precise homography."})]}),e.jsxs("div",{className:"flex flex-col items-end gap-2 text-xs font-medium",children:[e.jsxs("span",{className:"inline-flex items-center gap-2 rounded-full border border-indigo-400/50 bg-indigo-500/10 px-3 py-1",children:[e.jsx("span",{className:"opacity-60",children:"Mode"}),e.jsx("span",{children:T==="local"?"Desktop camera":T==="phone"?"Phone camera":"Wifi device"})]}),e.jsxs("span",{className:`inline-flex items-center gap-2 rounded-full border px-3 py-1 ${h?"border-emerald-400/60 bg-emerald-500/10 text-emerald-100":"border-white/20 bg-white/5 text-slate-200"}`,children:[e.jsx("span",{className:`h-2 w-2 rounded-full ${h?"bg-emerald-400":"bg-slate-400"}`}),h?"Live stream active":"Stream idle"]}),_e?e.jsxs("div",{className:"space-y-3 rounded-2xl border border-emerald-400/40 bg-emerald-500/10 p-4 text-sm",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"flex h-10 w-10 items-center justify-center rounded-full bg-emerald-500/20",children:e.jsx("span",{className:"text-lg",children:"âœ“"})}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold text-emerald-100",children:"Calibration active"}),e.jsx("p",{className:"text-xs opacity-80",children:"Your calibration is saved and active across all game modes. It will be used in Online, Offline, and Tournaments."})]})]}),e.jsx("button",{className:"btn btn--ghost px-2 py-1 text-xs whitespace-nowrap",onClick:()=>me({locked:!1}),title:"Unlock to recalibrate",children:"Unlock"})]}),ke!=null&&e.jsxs("div",{className:"text-xs opacity-75",children:["Precision: ",ke.toFixed(2)," px RMS error"]})]}):null]})]}),e.jsxs("div",{className:"grid gap-6 xl:grid-cols-[minmax(0,2fr)_minmax(320px,1fr)]",children:[e.jsxs("section",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-4 rounded-2xl border border-white/10 bg-black/40 p-4",children:[e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-4 text-xs",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[e.jsx("span",{className:"uppercase tracking-wide opacity-60",children:"Video source"}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{className:`btn px-3 py-1 ${T==="local"?"bg-emerald-600 hover:bg-emerald-700":"bg-slate-700 hover:bg-slate-600"}`,onClick:()=>{S("local"),ls(!1)},title:"Use local camera",children:"Local"}),e.jsx("button",{className:`btn px-3 py-1 ${T==="phone"?"bg-emerald-600 hover:bg-emerald-700":"bg-slate-700 hover:bg-slate-600"}`,onClick:()=>{S("phone"),ls(!1)},title:"Pair phone camera",children:"Phone"}),e.jsx("button",{className:`btn px-3 py-1 ${T==="wifi"?"bg-emerald-600 hover:bg-emerald-700":"bg-slate-700 hover:bg-slate-600"}`,onClick:()=>{S("wifi"),ls(!1),Ut()},title:"Discover wifi/USB autoscoring devices",children:"Wifi"})]})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"opacity-70",children:"Zoom"}),e.jsx("input",{type:"range",min:50,max:200,step:5,value:Math.round((b||1)*100),onChange:U=>H(Math.max(.5,Math.min(2,Number(U.target.value)/100)))}),e.jsxs("span",{className:"w-12 text-right",children:[Math.round((b||1)*100),"%"]})]}),e.jsx("button",{className:"btn px-3 py-1",onClick:()=>H(1),children:"Actual"})]})]}),e.jsxs("div",{className:"relative w-full overflow-hidden rounded-2xl border border-indigo-400/30 bg-black",style:{aspectRatio:A?`${A.w} / ${A.h}`:"16 / 9"},children:[(T==="phone"?!h||!Ke:!h)&&e.jsx("div",{className:"absolute inset-0 z-20 flex items-center justify-center bg-gradient-to-br from-black/40 to-black/10",children:e.jsx(dd,{calibrationComplete:g==="computed"})}),e.jsxs("div",{className:"absolute inset-0",style:{transform:`scale(${b||1})`,transformOrigin:"center center"},children:[e.jsx("video",{ref:s,onLoadedMetadata:U=>{try{const K=U.currentTarget;K.videoWidth&&K.videoHeight&&v({w:K.videoWidth,h:K.videoHeight})}catch{}},className:`absolute inset-0 h-full w-full object-cover transition-opacity duration-300 ${M?"opacity-0 -z-10":"opacity-100 z-10"}`,autoPlay:!0,playsInline:!0,muted:!0,controls:!1}),x&&e.jsx("div",{className:"absolute inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur",children:e.jsx("button",{className:"rounded-lg bg-white px-4 py-2 font-semibold text-slate-900 shadow-lg",onClick:async()=>{try{await s.current?.play(),p(!1),m(!0),w("capture")}catch(U){console.warn("Tap-to-play retry failed",U),alert("Tap to enable video failed. Please check browser settings or reload the page.")}},children:"Tap to allow video"})}),e.jsx("canvas",{ref:n,className:`absolute inset-0 h-full w-full transition-opacity duration-300 ${M?"opacity-100 z-10":"opacity-0 -z-10"}`}),e.jsx("canvas",{ref:t,onClick:Ns,className:"absolute inset-0 z-30 h-full w-full cursor-crosshair"})]})]}),e.jsxs("label",{className:"flex items-center gap-2 text-xs",children:[e.jsx("input",{type:"checkbox",className:"accent-indigo-600",checked:Le,onChange:U=>ve(U.target.checked)}),"Show preferred-view guide overlay"]}),e.jsxs("div",{className:"mt-4 grid grid-cols-1 gap-3 sm:grid-cols-3",children:[e.jsxs("div",{className:"rounded-2xl border border-white/10 bg-white/5 p-4",children:[e.jsx("h3",{className:"text-sm font-semibold",children:"Stage 1 Â· Capture"}),e.jsx("p",{className:"text-xs opacity-70",children:"Start your camera or upload a photo to capture the board."}),e.jsxs("div",{className:"mt-3 flex flex-col gap-2",children:[T==="local"&&e.jsx("button",{className:"btn",onClick:Us,children:"Enable camera"}),T==="phone"&&e.jsx("button",{className:"btn",onClick:wt,children:"Pair phone camera"}),T==="wifi"&&e.jsx("button",{className:"btn",onClick:Ut,children:"Connect wifi camera"}),e.jsx("button",{className:"btn",onClick:ys,disabled:!h,children:"Capture frame"}),e.jsx("button",{className:"btn",onClick:gs,children:"Upload photo"})]}),e.jsxs("div",{className:"mt-3 rounded-lg border border-white/10 bg-white/3 p-3 text-sm",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("div",{className:"font-medium",children:"Camera status"}),e.jsx("div",{className:"text-xs opacity-70",children:a})]}),e.jsxs("div",{className:"flex gap-2 items-center mb-2",children:[e.jsxs("select",{className:"input text-sm",value:d||"",onChange:U=>c(U.target.value),children:[e.jsx("option",{value:"",children:"Default camera"}),l.map(U=>e.jsx("option",{value:U.deviceId,children:U.label||U.deviceId},U.deviceId))]}),e.jsx("button",{className:"btn btn--ghost text-sm",onClick:()=>vs(),children:"Refresh devices"}),e.jsx("button",{className:"btn btn--ghost text-sm",onClick:()=>Kt(),children:"Open site settings"}),e.jsx("button",{className:"btn text-sm",onClick:()=>fs(d||void 0),children:"Test camera"})]}),l.length>0&&e.jsx("div",{className:"flex gap-2 flex-wrap mb-2",children:l.map(U=>e.jsx("button",{onClick:()=>c(U.deviceId),className:`px-3 py-2 rounded-lg text-xs font-medium transition-colors whitespace-normal break-words max-w-full ${d===U.deviceId?"bg-purple-600 text-white":"bg-purple-900/40 text-purple-200 hover:bg-purple-800/60"}`,title:U.label||U.deviceId,children:U.label||"Camera"},U.deviceId))}),e.jsx("div",{className:"text-xs opacity-75",children:"If access is denied, check your browser site permissions and Windows Privacy â†’ Camera settings. Also ensure no other app (Zoom/Teams) is using the camera."})]})]}),e.jsxs("div",{className:"rounded-2xl border border-white/10 bg-white/5 p-4",children:[e.jsx("h3",{className:"text-sm font-semibold",children:"Stage 2 Â· Detect"}),e.jsx("p",{className:"text-xs opacity-70",children:"Auto-detect the rim or use fiducial markers to seed calibration points."}),e.jsxs("div",{className:"mt-3 flex flex-col gap-2",children:[e.jsx("button",{className:"btn",disabled:!M,onClick:ks,children:"Auto detect"}),e.jsx("button",{className:"btn",disabled:!M,onClick:Zt,children:"Detect markers"}),e.jsx("button",{className:"btn btn--ghost",onClick:As,children:"Print markers"})]}),e.jsxs("div",{className:"mt-2 text-xs opacity-70",children:["Confidence: ",he,"%"]})]}),e.jsxs("div",{className:"rounded-2xl border border-white/10 bg-white/5 p-4",children:[e.jsx("h3",{className:"text-sm font-semibold",children:"Stage 3 Â· Align & lock"}),e.jsx("p",{className:"text-xs opacity-70",children:"Click the board points, refine edges and lock calibration when satisfied."}),e.jsxs("div",{className:"mt-3 flex flex-col gap-2",children:[e.jsx("button",{className:"btn",disabled:E.length<4,onClick:Rs,children:"Compute"}),e.jsx("button",{className:`btn ${_e?"bg-emerald-600 hover:bg-emerald-700":""}`,onClick:()=>me({locked:!_e}),children:_e?"Unlock":"Lock in"}),e.jsx("button",{className:"btn",onClick:()=>Vt(),children:"Verify"})]})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-3 text-xs sm:grid-cols-3",children:[e.jsxs("div",{className:"rounded-xl border border-white/10 bg-white/5 px-3 py-2",children:[e.jsx("div",{className:"uppercase tracking-wide opacity-60",children:"Phase"}),e.jsx("div",{className:"text-sm font-semibold capitalize",children:g})]}),e.jsxs("div",{className:"rounded-xl border border-white/10 bg-white/5 px-3 py-2",children:[e.jsx("div",{className:"uppercase tracking-wide opacity-60",children:"Points selected"}),e.jsxs("div",{className:"text-sm font-semibold",children:[E.length," / 6"]})]}),e.jsxs("div",{className:"rounded-xl border border-white/10 bg-white/5 px-3 py-2",children:[e.jsx("div",{className:"uppercase tracking-wide opacity-60",children:"Fit error"}),e.jsx("div",{className:"text-sm font-semibold",children:ke!=null?`${ke.toFixed(2)} px`:"â€”"})]})]})]}),e.jsxs("aside",{className:"space-y-4",children:[e.jsx(Ps,{}),T==="phone"&&e.jsxs("section",{className:"space-y-3 rounded-2xl border border-indigo-400/30 bg-black/40 p-4 text-xs text-white",children:[e.jsx("div",{className:"font-semibold",children:"Phone pairing"}),e.jsxs("button",{type:"button",className:"w-full text-left px-3 py-2 rounded-lg border border-white/10 bg-white/5 hover:bg-white/10 transition flex items-center gap-2",onClick:()=>z(Et,"link"),title:"Copy mobile camera link",children:[e.jsx("span",{className:"flex-1 min-w-0 font-mono break-all text-[11px]",children:Et}),e.jsx("span",{className:"text-[10px] uppercase tracking-wide whitespace-nowrap text-emerald-200",children:Bt==="link"?"Copied!":"Copy link"})]}),e.jsx("div",{className:"flex items-center gap-2 text-[11px]",children:e.jsx("a",{href:Et,target:"_blank",rel:"noreferrer",className:"underline decoration-dotted text-indigo-200 hover:text-indigo-100 transition",children:"Open link in new tab"})}),e.jsxs("div",{className:"opacity-80",children:["WS: ",fe?fe.readyState===1?"open":fe.readyState===0?"connecting":fe.readyState===2?"closing":"closed":"not started"," Â· ",yt?.https?"HTTPS on":"HTTP only"]}),Ne&&e.jsxs("button",{type:"button",className:"w-full text-left px-3 py-2 rounded-lg border border-white/10 bg-white/5 hover:bg-white/10 transition flex items-center justify-between gap-2",onClick:()=>z(Ne,"code"),title:"Copy pairing code",children:[e.jsx("span",{className:"font-mono tracking-[0.3em] text-sm",children:Ne}),e.jsx("span",{className:"text-[10px] uppercase tracking-wide whitespace-nowrap text-emerald-200",children:Bt==="code"?"Copied!":"Copy code"})]}),ht&&e.jsx("img",{className:"mt-1 h-40 w-40 bg-white",alt:"Scan to open",src:ht}),e.jsxs("div",{className:"flex items-center gap-2",children:[xs!==null&&e.jsxs("span",{children:["Expires in ",xs,"s"]}),e.jsx("button",{className:"btn px-2 py-1 text-xs",onClick:$s,children:"Regenerate"})]}),ne&&e.jsxs("div",{className:"space-y-2 rounded-lg border border-slate-700/50 bg-slate-900/60 p-3 text-slate-200",children:[e.jsx("div",{className:"font-semibold",children:"Troubleshooting"}),e.jsxs("ul",{className:"list-disc space-y-1 pl-4",children:[e.jsx("li",{children:"Phone and desktop must be on the same Wiâ€‘Fi network."}),e.jsxs("li",{children:["Allow the server through your firewall (ports 8787 and ",yt?.https?yt.port:8788,")."]}),e.jsx("li",{children:"On iPhone, use HTTPS links (QR will prefer HTTPS when enabled)."})]}),e.jsx("div",{className:"text-right",children:e.jsx("button",{className:"btn btn--ghost px-2 py-1 text-xs",onClick:()=>Ae(!1),children:"Hide tips"})})]})]})]})]}),T==="wifi"&&!h&&e.jsxs("div",{className:"space-y-3 rounded-2xl border border-indigo-400/30 bg-black/40 p-4 text-xs text-white",children:[e.jsx("div",{className:"font-semibold",children:"Wifi scoring devices"}),pt?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"h-4 w-4 animate-spin rounded-full border-b-2 border-white"}),e.jsx("span",{children:"Scanning network for devicesâ€¦"})]}):Ce.length>0?e.jsxs("div",{className:"space-y-2",children:[Ce.map(U=>e.jsxs("div",{className:"flex items-center justify-between rounded border border-slate-700/50 bg-slate-900/60 p-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:U.name}),e.jsxs("div",{className:"opacity-70",children:[U.ip,":",U.port," Â· ",U.type.toUpperCase()]}),e.jsxs("div",{className:"opacity-70 text-xs",children:["Capabilities: ",U.capabilities.join(", ")]})]}),e.jsx("button",{className:`btn px-2 py-1 text-xs ${U.status==="connecting"?"bg-yellow-600":U.status==="online"?"bg-green-600":"bg-blue-600"}`,onClick:()=>ps(U),disabled:U.status==="connecting",children:U.status==="connecting"?"Connectingâ€¦":"Connect"})]},U.id)),e.jsx("div",{className:"text-center",children:e.jsx("button",{className:"btn px-2 py-1 text-xs",onClick:Ut,children:"Rescan network"})})]}):e.jsxs("div",{className:"space-y-2 text-center",children:[e.jsx("div",{children:"No wifi scoring devices found."}),e.jsx("div",{className:"opacity-70",children:"Ensure your wifi cameras are powered on and on the same network."}),e.jsx("button",{className:"btn px-2 py-1 text-xs",onClick:Ut,children:"Scan again"})]})]})]})]})}const hu=["D1","D2","D3","D4","D5","D6","D7","D8","D9","D10","D11","D12","D13","D14","D15","D16","D17","D18","D19","D20","DB"];function fu(s){return s==="DB"?50:Number(s.slice(1))*2}function xu(s){return hu.includes(s)?fu(s):32}function ri(s,n="D16"){if(s>170||s<=1)return[];const t={170:["T20 T20 DB"],167:["T20 T19 DB"],164:["T20 T18 DB"],161:["T20 T17 DB"],160:["T20 T20 D20"],158:["T20 T20 D19"],157:["T20 T19 D20"],156:["T20 T20 D18"],155:["T20 T19 D19"],154:["T20 T18 D20"],153:["T20 T19 D18"],152:["T20 T20 D16"],151:["T20 T17 D20"],150:["T20 T18 D18"],149:["T20 T19 D16"],148:["T20 T16 D20"],147:["T20 T17 D18"],146:["T20 T18 D16"],145:["T20 T15 D20"],144:["T20 T20 D12"],141:["T20 T19 D12"],140:["T20 T20 D10"],137:["T20 T19 D10"],136:["T20 T20 D8"],132:["BULL T14 D20","T20 T12 D8"],130:["T20 T20 D5","T20 T18 D8"],129:["T19 T16 D12"],128:["T18 T14 D16"],127:["T20 T17 D8"],126:["T19 T19 D6"],121:["T20 11 D20","T20 T15 D8"],120:["T20 20 D20","T20 S20 D20"],110:["T20 10 D20"],100:["T20 D20"],99:["T19 10 D16","T19 S10 D16"],97:["T19 D20"],96:["T20 D18"],95:["T19 D19"],94:["T18 D20"],92:["T20 D16"],90:["T18 D18","T20 D15"],86:["T18 D16"],84:["T20 D12","T16 D18"],82:["BULL D16","T14 D20"],81:["T19 D12"],80:["T20 D10","D20 D20"],78:["T18 D12"],76:["T20 D8","T16 D14"],74:["T14 D16","T18 D10"],72:["T16 D12","T20 D6"],70:["T18 D8","S20 BULL"],68:["T20 D4","T16 D10"],66:["T10 D18","T14 D12"],64:["T16 D8","D16 D16"],62:["T10 D16","T12 D13"],60:["20 D20","S20 D20"],58:["18 D20","S18 D20"],56:["16 D20","S16 D20"],54:["14 D20","S14 D20"],52:["20 D16","S20 D16"],50:["BULL","10 D20"],48:["16 D16","S16 D16"],46:["14 D16"],44:["12 D16"],42:["10 D16"],40:["D20"],38:["D19"],36:["D18"],34:["D17"],32:["D16"],30:["D15"],28:["D14"],26:["D13"],24:["D12"],22:["D11"],20:["D10"],18:["D9"],16:["D8"],14:["D7"],12:["D6"],10:["D5"],8:["D4"],6:["D3"],4:["D2"],2:["D1"]};if(t[s])return t[s];const i=xu(n),a=[];for(const r of[60,57,54,51,48])if(s-r===i){a.push(`T${r/3} ${n}`);break}if(!a.length){for(const r of[20,19,18,17,16,15])if(s-r===i){a.push(`${r} ${n}`);break}}return a}function yn(s,n,t,i,a){try{const r=window.speechSynthesis;if(!r)return;const l=new SpeechSynthesisUtterance,o=t<=170&&t>0;if(a?.checkoutOnly&&!o)return;if(l.text=o?`${s}, you have ${t} remaining.`:`${n}`,i){const d=r.getVoices().find(c=>c.name===i);d&&(l.voice=d)}typeof a?.volume=="number"&&(l.volume=Math.max(0,Math.min(1,a.volume))),l.rate=1,l.pitch=1,r.speak(l)}catch{}}const pu={};function Va({label:s,autoStart:n=!1,scale:t,className:i,aspect:a="inherit",style:r,fill:l=!1}){const o=u.useRef(null),d=Gn(),[c,h]=u.useState(!1),[m,x]=u.useState(null),[p,g]=u.useState(null),[w,T]=u.useState(null),S=Ft(ie=>ie.preferredCameraLabel),[E,I]=u.useState(()=>{if(S==="Phone Camera")return console.log("[CAMERATILE] Initializing mode to phone (from preferred camera selection)"),"phone";const ie=localStorage.getItem("ndn:camera:mode");return console.log("[CAMERATILE] Initializing mode to",ie||"local","(from localStorage)"),ie||"local"}),[M,P]=u.useState(null),[A,v]=u.useState(Date.now()),[b,H]=u.useState(!1),[W,R]=u.useState(null),[F,D]=u.useState(null),[Q,me]=u.useState(!0),[ue,ke]=u.useState([]),[_e,Pe]=u.useState(!1),[Le,ve]=u.useState([]),[Ee,$]=u.useState(!1),te=Ft(ie=>ie.autoscoreProvider),oe=Ft(ie=>ie.setPreferredCameraLocked);if(te==="manual"){const fe=[l?"rounded-2xl overflow-hidden bg-black w-full flex flex-col":"rounded-2xl overflow-hidden bg-black w-full mx-auto",i].filter(Boolean).join(" ").trim(),se={...r||{}};return!l&&se.aspectRatio===void 0&&se.height===void 0&&se.minHeight===void 0&&(se.aspectRatio="4 / 3"),e.jsx("div",{className:fe,style:se,children:e.jsx("div",{className:"flex-1 w-full h-full flex items-center justify-center bg-slate-900 text-slate-200 text-xs p-4 text-center",children:"Manual scoring mode active â€” camera feeds are disabled."})})}u.useEffect(()=>{const ie=window.location.hostname;(ie==="localhost"||ie==="127.0.0.1")&&Pt("/api/hosts").then(fe=>fe.json()).then(fe=>{const se=Array.isArray(fe?.hosts)&&fe.hosts.find(Z=>Z);se&&R(se)}).catch(()=>{}),Pt("/api/https-info").then(fe=>fe.json()).then(fe=>{fe&&typeof fe.https=="boolean"&&D({https:!!fe.https,port:Number(fe.port)||8788})}).catch(()=>{})},[]);const He=u.useMemo(()=>{const ie=p||"____",fe="ws://localhost:8787";if(fe.length>0)try{const Se=new URL(fe);return`${`${Se.protocol==="wss:"?"https":"http"}://${Se.host}${Se.pathname.endsWith("/ws")?"":Se.pathname}`.replace(/\/?ws$/i,"")}/mobile-cam.html?code=${ie}`}catch{}const se=W||window.location.hostname,Z=!!F?.https,$e=Z?F?.port||8788:8787;return`${Z?"https":"http"}://${se}:${$e}/mobile-cam.html?code=${ie}`},[p,W,F]);u.useEffect(()=>{console.log("[CAMERATILE] Mode changed to:",E,"- persisting to localStorage"),localStorage.setItem("ndn:camera:mode",E)},[E]),u.useEffect(()=>{const ie=Ft.getState().ignorePreferredCameraSync;console.log("[CAMERATILE] Checking camera selection sync: preferredCameraLabel=",S,"mode=",E,"ignoreSync=",ie),!ie&&S==="Phone Camera"&&E!=="phone"&&(console.log("[CAMERATILE] Syncing mode to phone from Calibrator selection"),I("phone"))},[S,E]);const[We,we]=u.useState("");u.useEffect(()=>{if(!p){we("");return}const ie=pu?.VITE_QR_LOGO_URL||"/dart-thrower.svg";Nl(He,{width:160,margin:1,errorCorrectionLevel:"H",color:{dark:"#000000",light:"#ffffff"},logo:{logoUrl:ie,logoScale:.2,mask:!0,shape:"circle"}}).then(we).catch(()=>we(""))},[He,p]),u.useEffect(()=>{if(!M)return;const ie=setInterval(()=>v(Date.now()),1e3);return()=>clearInterval(ie)},[M]);const Ie=u.useMemo(()=>M?Math.max(0,Math.ceil((M-A)/1e3)):null,[M,A]);u.useEffect(()=>{n?lt().catch(()=>{}):pe()},[n,S]),u.useEffect(()=>{const ie=async()=>{try{if(S!=="Phone Camera"&&E!=="phone")return;const se=d.getMediaStream(),Z=o.current;if(!Z||!se)return;Z.srcObject!==se&&(Z.srcObject=se),Z.muted=!0,Z.playsInline=!0;try{await Z.play()}catch{}h(!0)}catch{}};ie();const fe=setInterval(ie,800);return()=>clearInterval(fe)},[S,E,d,d.isStreaming]);async function lt(){if(E==="wifi")return he();if(S==="Phone Camera"||E==="phone"){const ie=d.getMediaStream();if(ie&&o.current)try{o.current.srcObject=ie,await o.current.play(),h(!0);return}catch{}}try{const{preferredCameraId:ie,setPreferredCamera:fe}=Ft.getState(),se=ie?{video:{deviceId:{exact:ie}},audio:!1}:{video:!0,audio:!1};let Z;try{Z=await navigator.mediaDevices.getUserMedia(se)}catch($e){const ye=$e&&($e.name||$e.code)||"";if(ie&&(ye==="OverconstrainedError"||ye==="NotFoundError"))Z=await navigator.mediaDevices.getUserMedia({video:!0,audio:!1});else throw $e}o.current&&(o.current.srcObject=Z,await o.current.play(),h(!0))}catch{}}function pe(){o.current&&o.current.srcObject&&(o.current.srcObject.getTracks().forEach(fe=>fe.stop()),o.current.srcObject=null,h(!1))}async function he(){Pe(!0);try{const ie=await Dl();ke(ie),ie.length===0&&alert("No wifi scoring devices found on your network. Make sure devices are powered on and connected to the same network.")}catch(ie){console.error("Wifi device discovery failed:",ie),alert("Failed to discover wifi devices. Please check your network connection.")}finally{Pe(!1)}}async function Oe(ie){try{ke(se=>se.map(Z=>Z.id===ie.id?{...Z,status:"connecting"}:Z));const fe=await Ml(ie);if(fe&&o.current)o.current.srcObject=fe,await o.current.play(),h(!0),ke(se=>se.map(Z=>Z.id===ie.id?{...Z,status:"online"}:Z));else throw new Error("Failed to get video stream")}catch(fe){console.error("Failed to connect to wifi device:",fe),alert(`Failed to connect to ${ie.name}. Please check the device and try again.`),ke(se=>se.map(Z=>Z.id===ie.id?{...Z,status:"offline"}:Z))}}async function xt(){$(!0);try{const ie=await lu();ve(ie);const fe=await cu();fe&&ve(se=>[...se,fe]),ie.length===0&&!fe&&alert("No USB scoring devices found. Please connect a device and try again.")}catch(ie){console.error("USB device discovery failed:",ie),alert("Failed to discover USB devices. Please check device connections.")}finally{$(!1)}}async function Rt(ie){try{ve(se=>se.map(Z=>Z.id===ie.id?{...Z,status:"connecting"}:Z));const fe=await du(ie);if(fe&&o.current)o.current.srcObject=fe,await o.current.play(),h(!0),I("wifi"),ve(se=>se.map(Z=>Z.id===ie.id?{...Z,status:"online"}:Z));else throw new Error("Failed to get video stream")}catch(fe){console.error("Failed to connect to USB device:",fe),alert(`Failed to connect to ${ie.name}. Please check the device and try again.`),ve(se=>se.map(Z=>Z.id===ie.id?{...Z,status:"offline"}:Z))}}function hs(){if(m&&m.readyState===WebSocket.OPEN)return m;const ie="ws://localhost:8787",fe=ie.length>0?ie.endsWith("/ws")?ie:ie.replace(/\/$/,"")+"/ws":void 0,se=window.location.protocol==="https:"?"wss":"ws",Z=`${se}://${window.location.host}/ws`,$e=window.location.hostname,ye=$e==="localhost"||$e==="127.0.0.1",Se=$e.endsWith("onrender.com"),Qe="wss://ninedartnation.onrender.com/ws";let Ke=fe;Ke||(ye?Ke=`${se}://${$e}:8787/ws`:Se?Ke=Z:Ke=Qe),Ke||(Ke=Z);const mt=new WebSocket(Ke);return x(mt),mt}async function jt(){I("phone"),H(!1);const ie=hs();ie.readyState===WebSocket.OPEN?ie.send(JSON.stringify({type:"cam-create"})):ie.onopen=()=>ie.send(JSON.stringify({type:"cam-create"})),ie.onmessage=async fe=>{const se=JSON.parse(fe.data);if(se.type==="cam-code")g(se.code),se.expiresAt&&P(se.expiresAt);else if(se.type==="cam-peer-joined"){H(!0);const Z=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}]});T(Z),Z.onicecandidate=ye=>{ye.candidate&&p&&ie.send(JSON.stringify({type:"cam-ice",code:p,payload:ye.candidate}))},Z.ontrack=ye=>{if(o.current){const Se=ye.streams?.[0];Se&&(o.current.srcObject=Se,o.current.play().catch(()=>{}),h(!0))}};const $e=await Z.createOffer({offerToReceiveAudio:!1,offerToReceiveVideo:!0});await Z.setLocalDescription($e),p&&ie.send(JSON.stringify({type:"cam-offer",code:p,payload:$e}))}else if(se.type==="cam-answer")w&&await w.setRemoteDescription(new RTCSessionDescription(se.payload));else if(se.type==="cam-ice"&&w)try{await w.addIceCandidate(se.payload)}catch{}}}function Ne(){g(null),P(null),H(!1),m&&m.readyState===WebSocket.OPEN?m.send(JSON.stringify({type:"cam-create"})):jt();try{oe(!0)}catch{}}function Ht(){if(pe(),g(null),H(!1),P(null),w){try{w.close()}catch{}T(null)}}return e.jsx(bu,{label:s,autoStart:n,start:lt,stopAll:Ht,startPhonePairing:jt,startWifiConnection:he,startUsbConnection:xt,connectToWifiDevice:Oe,connectToUsbDevice:Rt,videoRef:o,streaming:c,mode:E,setMode:I,pairCode:p,mobileUrl:He,ttl:Ie,qrDataUrl:We,regenerateCode:Ne,httpsInfo:F,showTips:Q,setShowTips:me,wifiDevices:ue,usbDevices:Le,discoveringWifi:_e,discoveringUsb:Ee,scaleOverride:t,className:i,aspect:a,style:r,fill:l})}function bu(s){const n=Gn(),{cameraScale:t,cameraAspect:i}=Ft(),{label:a,start:r,stopAll:l,startPhonePairing:o,startWifiConnection:d,startUsbConnection:c,connectToWifiDevice:h,connectToUsbDevice:m,videoRef:x,streaming:p,mode:g,setMode:w,pairCode:T,mobileUrl:S,ttl:E,qrDataUrl:I,regenerateCode:M,httpsInfo:P,showTips:A,setShowTips:v,wifiDevices:b,usbDevices:H,discoveringWifi:W,discoveringUsb:R,className:F,aspect:D,style:Q,fill:me}=s,[ue,ke]=u.useState(null),_e=u.useRef(null);u.useEffect(()=>()=>{_e.current&&window.clearTimeout(_e.current)},[]);const{cameraFitMode:Pe}=Ft(),Le=me?"fill":Pe||"fill",ve=(()=>{const he=Number(s.scaleOverride??t??1),Oe=Math.max(.5,Math.min(1.25,he));return Le==="fill"?Math.max(1,Oe):Oe})(),Ee=me&&Le==="fill"?"free":D&&D!=="inherit"?D:i||"wide",$=Ee!=="free",te=$?Ee==="square"?"aspect-square":Ee==="portrait"?"aspect-[3/4]":Ee==="classic"?"aspect-[4/3]":"aspect-video":"",He=[me?"rounded-2xl overflow-hidden bg-transparent w-full flex flex-col":"rounded-2xl overflow-hidden bg-transparent w-full mx-auto flex flex-col",F].filter(Boolean).join(" ").trim(),We={...Q||{}},we=me?"relative flex-1 min-h-[220px] bg-black":"relative w-full bg-black",Ie={style:{transform:`scale(${ve})`,transformOrigin:"center"}},lt=(()=>{const Oe=Le==="fit"?"absolute inset-0 w-full h-full object-contain object-center bg-transparent":"absolute inset-0 w-full h-full object-cover object-center bg-transparent";return me?$?e.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:e.jsx("div",{className:`relative w-full max-w-full max-h-full ${te}`,children:e.jsx("video",{ref:x,className:Oe,...Ie})})}):e.jsx("video",{ref:x,className:Oe,...Ie}):$?e.jsx("div",{className:`relative w-full ${te}`,children:e.jsx("video",{ref:x,className:Oe,...Ie})}):e.jsx("video",{ref:x,className:Oe,...Ie})})();async function pe(he,Oe){if(he)try{if(navigator.clipboard&&navigator.clipboard.writeText)await navigator.clipboard.writeText(he);else{const xt=document.createElement("textarea");xt.value=he,xt.style.position="fixed",xt.style.opacity="0",document.body.appendChild(xt),xt.focus(),xt.select(),document.execCommand("copy"),document.body.removeChild(xt)}ke(Oe),_e.current&&window.clearTimeout(_e.current),_e.current=window.setTimeout(()=>ke(null),1500)}catch(xt){console.warn("Copy to clipboard failed:",xt),ke(null)}}return e.jsxs("div",{className:He,style:We,children:[e.jsxs("div",{className:we,children:[lt,n.isStreaming&&g==="phone"&&e.jsxs("div",{className:"absolute top-2 left-2 z-10 flex items-center gap-1 px-2 py-0.5 rounded-full bg-black/60 border border-rose-500/50 text-[10px] text-rose-200",children:[e.jsx("span",{className:"inline-block w-2 h-2 rounded-full bg-rose-500 animate-pulse"}),e.jsx("span",{className:"font-semibold",children:"REC"})]})]}),e.jsxs("div",{className:"p-1 flex items-center justify-between bg-black/60 text-white text-[10px] gap-1",children:[e.jsx("span",{className:"truncate",children:a||(p?g==="phone"?"PHONE LIVE":g==="wifi"?"WIFI LIVE":"LIVE":"Camera")}),e.jsxs("div",{className:"flex items-center gap-1",children:[!p&&e.jsxs(e.Fragment,{children:[e.jsx("button",{className:`px-1 py-0.5 rounded ${g==="local"?"bg-emerald-600":"bg-slate-700"}`,onClick:()=>{w("local"),r()},children:"Local"}),e.jsx("button",{className:`px-1 py-0.5 rounded ${g==="phone"?"bg-emerald-600":"bg-slate-700"}`,onClick:o,children:"Phone"}),e.jsx("button",{className:`px-1 py-0.5 rounded ${g==="wifi"?"bg-emerald-600":"bg-slate-700"}`,onClick:()=>{w("wifi"),d()},children:"Wifi"}),e.jsx("button",{className:`px-1 py-0.5 rounded ${g==="wifi"?"bg-emerald-600":"bg-slate-700"}`,onClick:()=>{w("wifi"),c()},children:"USB"})]}),p?e.jsx("button",{className:"px-1 py-0.5 rounded bg-rose-600",onClick:l,children:"Stop"}):null]})]}),g==="phone"&&T&&!p&&e.jsxs("div",{className:"p-2 text-white text-[10px] bg-black/50",children:[e.jsx("div",{className:"text-xs opacity-80",children:"Launch on your mobile:"}),e.jsxs("button",{type:"button",className:"mt-1 w-full text-left px-2 py-1 rounded bg-white/5 border border-white/10 hover:bg-white/10 transition flex items-center gap-2",onClick:()=>pe(S,"link"),title:"Copy mobile camera link",children:[e.jsx("span",{className:"flex-1 min-w-0 font-mono break-all",children:S}),e.jsx("span",{className:"text-[9px] uppercase tracking-wide whitespace-nowrap text-emerald-200",children:ue==="link"?"Copied!":"Copy"})]}),e.jsxs("div",{className:"mt-1 flex items-center gap-2",children:[e.jsx("a",{href:S,target:"_blank",rel:"noreferrer",className:"px-2 py-1 rounded border border-indigo-500/30 text-indigo-100 hover:bg-indigo-500/20 transition",children:"Open link"}),e.jsxs("button",{type:"button",className:"flex-1 text-left px-2 py-1 rounded bg-white/5 border border-white/10 hover:bg-white/10 transition flex items-center justify-between gap-2",onClick:()=>pe(T,"code"),title:"Copy pairing code",children:[e.jsx("span",{className:"font-mono tracking-[0.3em] text-sm",children:T}),e.jsx("span",{className:"text-[9px] uppercase tracking-wide whitespace-nowrap text-emerald-200",children:ue==="code"?"Copied!":"Copy"})]})]}),I&&e.jsx("img",{className:"mt-1 w-[160px] h-[160px] bg-white rounded",alt:"Scan to open",src:I}),e.jsxs("div",{className:"mt-1 flex items-center gap-2",children:[E!==null&&e.jsxs("span",{children:["Expires in ",E,"s"]}),e.jsx("button",{className:"px-1 py-0.5 rounded bg-slate-700",onClick:M,children:"Regenerate"})]}),A&&e.jsxs("div",{className:"mt-2 p-2 rounded bg-slate-900/60 border border-slate-700/50 text-slate-200",children:[e.jsx("div",{className:"font-semibold mb-1",children:"Troubleshooting"}),e.jsxs("ul",{className:"list-disc pl-4 space-y-1",children:[e.jsx("li",{children:"Phone and desktop must be on the same Wiâ€‘Fi network."}),e.jsxs("li",{children:["Allow the server through your firewall (ports 8787 and ",P?.https?P.port:8788,")."]}),e.jsx("li",{children:"On iPhone, use HTTPS links (QR will prefer https when enabled)."})]}),e.jsx("div",{className:"mt-2 text-right",children:e.jsx("button",{className:"btn btn--ghost px-2 py-1 text-xs",onClick:()=>v(!1),children:"Hide tips"})})]})]}),g==="wifi"&&!p&&e.jsxs("div",{className:"p-2 text-white text-[10px] bg-black/50",children:[e.jsx("div",{className:"font-semibold mb-2",children:"Scoring Devices"}),e.jsxs("div",{className:"mb-3",children:[e.jsx("div",{className:"font-medium mb-1",children:"WiFi Devices"}),W?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"animate-spin rounded-full h-3 w-3 border-b-2 border-white"}),e.jsx("span",{children:"Scanning network..."})]}):b.length>0?e.jsxs("div",{className:"space-y-1",children:[b.map(he=>e.jsxs("div",{className:"flex items-center justify-between p-1 rounded bg-slate-900/60",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"font-medium truncate",children:he.name}),e.jsxs("div",{className:"opacity-70 text-[9px]",children:[he.ip,":",he.port]})]}),e.jsx("button",{className:`px-1 py-0.5 rounded text-[9px] ${he.status==="connecting"?"bg-yellow-600":he.status==="online"?"bg-green-600":"bg-blue-600"}`,onClick:()=>h(he),disabled:he.status==="connecting",children:he.status==="connecting"?"...":"Connect"})]},he.id)),e.jsx("div",{className:"text-center mt-2",children:e.jsx("button",{className:"px-1 py-0.5 rounded bg-slate-700 text-[9px]",onClick:d,children:"Rescan WiFi"})})]}):e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"mb-1 opacity-70",children:"No WiFi devices found"}),e.jsx("button",{className:"px-1 py-0.5 rounded bg-slate-700 text-[9px]",onClick:d,children:"Scan WiFi"})]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium mb-1",children:"USB Devices"}),R?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"animate-spin rounded-full h-3 w-3 border-b-2 border-white"}),e.jsx("span",{children:"Scanning USB..."})]}):H.length>0?e.jsxs("div",{className:"space-y-1",children:[H.map(he=>e.jsxs("div",{className:"flex items-center justify-between p-1 rounded bg-slate-900/60",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"font-medium truncate",children:he.name}),e.jsx("div",{className:"opacity-70 text-[9px]",children:he.type.toUpperCase()})]}),e.jsx("button",{className:`px-1 py-0.5 rounded text-[9px] ${he.status==="connecting"?"bg-yellow-600":he.status==="online"?"bg-green-600":"bg-blue-600"}`,onClick:()=>m(he),disabled:he.status==="connecting",children:he.status==="connecting"?"...":"Connect"})]},he.id)),e.jsx("div",{className:"text-center mt-2",children:e.jsx("button",{className:"px-1 py-0.5 rounded bg-slate-700 text-[9px]",onClick:c,children:"Rescan USB"})})]}):e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"mb-1 opacity-70",children:"No USB devices found"}),e.jsx("button",{className:"px-1 py-0.5 rounded bg-slate-700 text-[9px]",onClick:c,children:"Scan USB"})]})]})]})]})}function gu(s){return s.dartsThrown===0?0:(s.totalScoreStart-s.totalScoreRemaining)/s.dartsThrown*3}function yu(s){const n=gu(s),t=s.finished;return{avg:n,isCompleted:t,darts:s.dartsThrown,checkout:s.checkoutScore??0}}function vu(s){if(s.legs.length===0)return;const n=[];let t,i=s.bestCheckout??0;for(const a of s.legs){if(!a.finished)continue;const r=yu(a);n.push(r.avg),(!t||r.darts<t.darts||r.darts===t.darts&&(a.endTime??0)<t.timestamp)&&(t={darts:r.darts,timestamp:a.endTime??Date.now()}),r.checkout>i&&(i=r.checkout)}n.length&&(s.bestThreeDartAvg=Math.max(...n),s.worstThreeDartAvg=Math.min(...n)),t&&(s.bestNineDart=t),s.bestCheckout=i}const ha=Js((s,n)=>({roomId:"",players:[],currentPlayerIdx:0,startingScore:501,inProgress:!1,newMatch:(t,i,a="")=>s(()=>({players:t.map((l,o)=>({id:`${o}`,name:l,legsWon:0,legs:[]})),currentPlayerIdx:0,startingScore:i,inProgress:!0,roomId:a,bestLegThisMatch:void 0})),addVisit:(t,i,a)=>s(r=>{if(!r.inProgress)return r;const l=r.players[r.currentPlayerIdx];let o=l.legs[l.legs.length-1];(!o||o.finished)&&(o={visits:[],totalScoreStart:r.startingScore,totalScoreRemaining:r.startingScore,dartsThrown:0,finished:!1,checkoutScore:null,startTime:Date.now()},l.legs.push(o));const d=o.totalScoreRemaining,c=Math.max(0,d-t);o.visits.push({darts:i,score:t,preOpenDarts:a?.preOpenDarts,doubleWindowDarts:a?.doubleWindowDarts,finishedByDouble:a?.finishedByDouble,visitTotal:a?.visitTotal??t}),o.dartsThrown+=i,o.totalScoreRemaining=c;try{const h=t===0&&i>0&&c===d,m=c===0;Is.getState().recordVisit("x01-match",i,t,{preOpenDarts:a?.preOpenDarts??0,preRemaining:d,postRemaining:c,bust:h,finish:m})}catch{}return{...r}}),undoVisit:()=>s(t=>{const i=t.players[t.currentPlayerIdx],a=i.legs[i.legs.length-1];if(!a||a.finished||a.visits.length===0)return t;const r=a.visits.pop();return a.dartsThrown-=r.darts,a.totalScoreRemaining+=r.score,{...t}}),endLeg:t=>s(i=>{const a=i.players[i.currentPlayerIdx],r=a.legs[a.legs.length-1];if(!r||r.finished)return i;if(r.finished=!0,r.checkoutScore=t,r.endTime=Date.now(),r.totalScoreRemaining===0){a.legsWon+=1;const l=i.bestLegThisMatch;(!l||r.dartsThrown<l.darts)&&(i.bestLegThisMatch={playerId:a.id,darts:r.dartsThrown,timestamp:r.endTime})}return{...i}}),nextPlayer:()=>s(t=>({...t,currentPlayerIdx:(t.currentPlayerIdx+1)%t.players.length})),endGame:()=>s(t=>{for(const i of t.players)vu(i);return{...t,inProgress:!1}}),importState:t=>s(()=>({...t}))}));function Wo(s,n){const t=kl(s,n);return ai(t)}class ju{width=0;height=0;bg=null;lastAcceptTs=0;cooldownMs=600;roiRadius=0;roiCx=0;roiCy=0;initialized=!1;thresh=28;minArea=90;maxArea=6e3;prevTip=null;prevArea=0;stableCount=0;requireStableN=2;constructor(){}setROI(n,t,i){this.roiCx=n,this.roiCy=t,this.roiRadius=Math.max(0,i|0)}reset(n,t){this.width=n,this.height=t,this.bg=new Float32Array(n*t),this.initialized=!1}updateBackground(n,t=.05){const{width:i,height:a,data:r}=n;(!this.bg||i!==this.width||a!==this.height)&&this.reset(i,a);const l=this.bg,o=i*a;for(let d=0,c=0;d<o;d++,c+=4){const h=r[c],m=r[c+1],x=r[c+2],p=.299*h+.587*m+.114*x;this.initialized?l[d]=(1-t)*l[d]+t*p:l[d]=p}this.initialized=!0}inRoi(n,t){if(this.roiRadius<=0)return!0;const i=n-this.roiCx,a=t-this.roiCy;return i*i+a*a<=this.roiRadius*this.roiRadius}detect(n){const i=Date.now()-this.lastAcceptTs<this.cooldownMs,{width:a,height:r,data:l}=n;(!this.bg||a!==this.width||r!==this.height)&&this.reset(a,r);const o=this.bg;if(!this.initialized)return this.updateBackground(n,1),null;const d=a*r,c=new Uint8Array(d),h=new Float32Array(d);let m=0,x=0,p=0;const g=new Uint8Array(d);for(let ye=0,Se=0;ye<d;ye++,Se+=4){const Qe=l[Se],Ke=l[Se+1],mt=l[Se+2],Be=Math.max(Qe,Ke,mt),ht=Math.min(Qe,Ke,mt),Ye=.299*Qe+.587*Ke+.114*mt,Nt=Math.abs(Ye-o[ye]);h[ye]=Nt;const it=Math.floor(ye/a),yt=ye-it*a,C=Be===0?0:(Be-ht)/Be,ne=Be>=250&&C<=.12;ne&&(g[ye]=1),this.inRoi(yt,it)&&!ne&&(m+=Nt,x+=Nt*Nt,p++)}const w=p?m/p:0,T=p?Math.max(0,x/p-w*w):0,S=Math.sqrt(T),E=Math.max(this.thresh,w+1.2*S);for(let ye=0;ye<d;ye++){if(g[ye]){c[ye]=0;continue}if(h[ye]>E){const Se=Math.floor(ye/a),Qe=ye-Se*a;c[ye]=this.inRoi(Qe,Se)?1:0}}this._dilate(c,a,r),this._erode(c,a,r);const I=new Uint8Array(d);let M=0,P=null;for(let ye=0;ye<d;ye++){if(c[ye]===0||I[ye])continue;const Se=[];let Qe=0,Ke=0;const mt=[ye];for(I[ye]=1;Ke<mt.length;){const Be=mt[Ke++];Se.push(Be),Qe++;const ht=Be/a|0,Ye=[Be-1,Be+1,Be-a,Be+a];for(const Nt of Ye)Nt<0||Nt>=d||I[Nt]||(Nt===Be-1||Nt===Be+1)&&(Nt/a|0)!==ht||c[Nt]&&(I[Nt]=1,mt.push(Nt))}Qe>M&&(M=Qe,P=Se)}if(!P||M<this.minArea||M>this.maxArea)return i||this.updateBackground(n,.02),null;let A=a,v=r,b=0,H=0,W=0,R=0;for(const ye of P){const Se=ye/a|0,Qe=ye-Se*a;W+=Qe,R+=Se,Qe<A&&(A=Qe),Qe>b&&(b=Qe),Se<v&&(v=Se),Se>H&&(H=Se)}W/=M,R/=M;let F=0,D=0,Q=0;for(const ye of P){const Se=ye/a|0,Ke=ye-Se*a-W,mt=Se-R;F+=Ke*Ke,D+=mt*mt,Q+=Ke*mt}F/=M,D/=M,Q/=M;const me=F+D,ue=F*D-Q*Q,ke=Math.sqrt(Math.max(0,me*me/4-ue)),_e=me/2+ke;let Pe=Q,Le=_e-F;Math.hypot(Pe,Le)<1e-6&&(Pe=_e-D,Le=Q);const ve=Math.hypot(Pe,Le)||1;Pe/=ve,Le/=ve;const Ee=W-this.roiCx,$=R-this.roiCy,te=Ee*Pe+$*Le>0?1:-1;Pe*=te,Le*=te;const oe=Math.hypot(Ee,$)||1,He=Ee/oe,We=$/oe,we=Math.max(-1,Math.min(1,Pe*He+Le*We));if(Math.acos(we)*180/Math.PI>55)return i||this.updateBackground(n,.02),null;let lt=-1/0,pe=W,he=R;for(const ye of P){const Se=ye/a|0,Qe=ye-Se*a,Ke=(Qe-W)*Pe+(Se-R)*Le;Ke>lt&&(lt=Ke,pe=Qe,he=Se)}const Oe=pe-this.roiCx,xt=he-this.roiCy,Rt=Oe*Oe+xt*xt,hs=Math.max(1,b-A+1),jt=Math.max(1,H-v+1),Ne=hs*jt,Ht=M/Ne,ie=Math.sqrt(Rt)/Math.max(1,this.roiRadius);let fe=.5;Ht<.45&&(fe+=.2),Ht<.25&&(fe+=.15),ie<1.1&&(fe+=.1);const se=me-_e;return(_e>0?1-se/_e:0)>.3&&(fe+=.1),fe=Math.max(0,Math.min(1,fe)),!this._isStable({x:pe+.5,y:he+.5},M)||i?null:{tip:{x:pe+.5,y:he+.5},axis:{x1:W-Pe*20,y1:R-Le*20,x2:W+Pe*20,y2:R+Le*20},area:M,bbox:{x:A,y:v,w:hs,h:jt},confidence:fe}}accept(n,t){if(this.lastAcceptTs=Date.now(),this.prevTip=null,this.prevArea=0,this.stableCount=0,!this.bg)return;const{width:i}=n,a=this.bg,{x:r,y:l,w:o,h:d}=t.bbox,c=.5;for(let h=l;h<l+d;h++)for(let m=r;m<r+o;m++){const x=h*i+m,p=x*4,g=n.data[p],w=n.data[p+1],T=n.data[p+2],S=.299*g+.587*w+.114*T;a[x]=(1-c)*a[x]+c*S}}_isStable(n,t){const i=(a,r)=>Math.hypot(a.x-r.x,a.y-r.y)<=6;if(!this.prevTip)return this.prevTip={...n},this.prevArea=t,this.stableCount=1,!1;if(i(this.prevTip,n)&&Math.abs(t-this.prevArea)/Math.max(1,t)<.3)this.prevTip={...n},this.prevArea=t,this.stableCount++;else return this.prevTip={...n},this.prevArea=t,this.stableCount=1,!1;return this.stableCount>=this.requireStableN}_dilate(n,t,i){const a=new Uint8Array(n.length);for(let r=0;r<i;r++)for(let l=0;l<t;l++){let o=0;for(let d=-1;d<=1;d++){for(let c=-1;c<=1;c++){const h=r+d,m=l+c;if(!(h<0||h>=i||m<0||m>=t)&&n[h*t+m]){o=1;break}}if(o)break}a[r*t+l]=o}n.set(a)}_erode(n,t,i){const a=new Uint8Array(n.length);for(let r=0;r<i;r++)for(let l=0;l<t;l++){let o=1;for(let d=-1;d<=1;d++){for(let c=-1;c<=1;c++){const h=r+d,m=l+c;if(!(h<0||h>=i||m<0||m>=t)&&!n[h*t+m]){o=0;break}}if(!o)break}a[r*t+l]=o}n.set(a)}}function Nu(s){try{if(!s||typeof s!="object")return null;if((s.type==="dart"||s.kind==="dart"||s.event==="dart")&&typeof s.value=="number"){const n=zo(s.ring);return qo(s.value,n)}if(typeof s.value=="number"&&s.ring){const n=zo(s.ring);return qo(s.value,n)}if(typeof s.score=="string"){const n=s.score.trim().toUpperCase();if(n==="50"||n==="DBULL"||n==="INNER_BULL")return{value:50,ring:"INNER_BULL",sector:null,mult:0};if(n==="25"||n==="BULL"||n==="OBULL")return{value:25,ring:"BULL",sector:null,mult:0};const t=n.match(/^(S|D|T)(\d{1,2})$/);if(t){const i=t[1]==="S"?1:t[1]==="D"?2:3,a=parseInt(t[2],10);if(a>=1&&a<=20)return{value:a*i,ring:i===1?"SINGLE":i===2?"DOUBLE":"TRIPLE",sector:a,mult:i}}}if(typeof s.sector=="number"&&typeof s.mult=="number"){const n=Math.max(1,Math.min(20,Math.floor(s.sector))),t=s.mult===1?1:s.mult===2?2:3;return{value:n*t,ring:t===1?"SINGLE":t===2?"DOUBLE":"TRIPLE",sector:n,mult:t}}if(s.bull){const n=String(s.bull).toLowerCase()==="inner"||s.bull===!0;return{value:n?50:25,ring:n?"INNER_BULL":"BULL",sector:null,mult:0}}}catch{}return null}function zo(s){const n=String(s||"").toUpperCase();return n.startsWith("TR")?"TRIPLE":n.startsWith("DO")?"DOUBLE":n.startsWith("SI")?"SINGLE":n==="INNER_BULL"||n==="DBULL"||n==="50"||n==="IBULL"?"INNER_BULL":n==="BULL"||n==="25"||n==="OBULL"||n==="OUTER_BULL"?"BULL":n==="MISS"||n==="0"?"MISS":"SINGLE"}function qo(s,n){const t=Math.max(0,Math.min(60,Math.round(Number(s)||0)));return n==="INNER_BULL"?{value:50,ring:n}:n==="BULL"?{value:25,ring:n}:{value:t,ring:n}}function wu(s,n){let t=null,i=!0,a=null,r=0;const l=400,o=[],d=new Set;function c(m,x){const p=typeof m?.id=="string"||typeof m?.id=="number"?String(m.id):null;if(p){if(d.has(p))return;if(d.add(p),o.push(p),o.length>200){const T=o.shift();T&&d.delete(T)}}const g=`${x.value}|${x.ring}|${x.sector??""}|${x.mult??""}`,w=Date.now();g===a&&w-r<l||(a=g,r=w,n(x))}function h(){if(i)try{t=new WebSocket(s),t.onmessage=m=>{try{const x=JSON.parse(m.data),p=Nu(x);p&&c(x,p)}catch{}},t.onclose=()=>{t=null,setTimeout(h,1500)},t.onerror=()=>{}}catch{setTimeout(h,2e3)}}return h(),{close:()=>{i=!1;try{t?.close()}catch{}}}}function fa({storageKey:s,children:n,className:t,defaultWidth:i=640,defaultHeight:a=360,minWidth:r=320,minHeight:l=200,maxWidth:o=1600,maxHeight:d=1200,autoFill:c=!1}){const[h,m]=u.useState(()=>{try{const I=localStorage.getItem(s);if(I)return JSON.parse(I)}catch{}return c?{width:i}:{width:i,height:a}}),x=u.useRef(null),p=u.useRef(null);u.useEffect(()=>{function I(){try{localStorage.removeItem(s)}catch{}m({width:i,height:a})}return window.addEventListener("ndn:layout-reset",I),window.addEventListener("ndn:camera-reset",I),()=>{window.removeEventListener("ndn:layout-reset",I),window.removeEventListener("ndn:camera-reset",I)}},[s,i,a]),u.useEffect(()=>{try{localStorage.setItem(s,JSON.stringify(h))}catch{}},[h,s]);function g(I,M,P){return Math.max(M,Math.min(P,I))}function w(I,M){I.preventDefault();const P=p.current;if(!P)return;const A=P.getBoundingClientRect();x.current={x:I.clientX,y:I.clientY,w:A.width,h:A.height,dir:M},window.addEventListener("mousemove",T),window.addEventListener("mouseup",S)}function T(I){const M=x.current;if(!M)return;const P=I.clientX-M.x,A=I.clientY-M.y;let v=M.w,b=M.h;M.dir.includes("e")&&(v=g(M.w+P,r,o)),!c&&M.dir.includes("s")&&(b=g(M.h+A,l,d)),M.dir.includes("w")&&(v=g(M.w-P,r,o)),!c&&M.dir.includes("n")&&(b=g(M.h-A,l,d)),m({width:Math.round(v),height:Math.round(b)})}function S(){window.removeEventListener("mousemove",T),window.removeEventListener("mouseup",S),x.current=null}const E={width:h.width?`${h.width}px`:void 0,height:c?"100%":h.height?`${h.height}px`:void 0,maxWidth:"100%",maxHeight:c?"100%":"80vh",position:"relative",...c?{display:"flex",flexDirection:"column",flex:"1 1 auto"}:{}};return e.jsxs("div",{ref:p,className:`${t||""}`,style:E,children:[n,e.jsx("div",{className:"resizer resizer-nw",onMouseDown:I=>w(I,"nw")}),e.jsx("div",{className:"resizer resizer-ne",onMouseDown:I=>w(I,"ne")}),e.jsx("div",{className:"resizer resizer-sw",onMouseDown:I=>w(I,"sw")}),e.jsx("div",{className:"resizer resizer-se",onMouseDown:I=>w(I,"se")})]})}function zs({storageKey:s,children:n,className:t,defaultWidth:i=520,defaultHeight:a,minWidth:r=360,minHeight:l=200,maxWidth:o=1100,maxHeight:d=900,fullScreen:c=!1,initialFitHeight:h=!1}){const[m,x]=u.useState(()=>{if(!c){try{const P=localStorage.getItem(s);if(P)return JSON.parse(P)}catch{}return{width:i,height:a}}return{}}),p=u.useRef(null);u.useEffect(()=>{if(c)return;function P(){try{localStorage.removeItem(s)}catch{}if(h&&E.current?.parentElement){const A=E.current.parentElement,v=window.getComputedStyle(A),b=parseFloat(v.paddingTop||"0")||0,H=parseFloat(v.paddingBottom||"0")||0,W=Math.max(0,A.clientHeight-b-H),R=Math.max(l,Math.min(d,Math.round(W)));x({width:i,height:R});return}x({width:i,height:a})}return window.addEventListener("ndn:layout-reset",P),()=>window.removeEventListener("ndn:layout-reset",P)},[s,i,a,c]),u.useEffect(()=>{if(!c)try{localStorage.setItem(s,JSON.stringify(m))}catch{}},[m,s,c]),u.useEffect(()=>{if(c||!h)return;const P=E.current?.parentElement;if(!P)return;const A=window.getComputedStyle(P),v=parseFloat(A.paddingTop||"0")||0,b=parseFloat(A.paddingBottom||"0")||0,H=Math.max(0,P.clientHeight-v-b),W=Math.max(l,Math.min(d,Math.round(H)));try{const R=localStorage.getItem(s);if(R){const D=JSON.parse(R)?.height||0;(!D||D<W)&&x(Q=>({...Q,height:W}));return}}catch{}x(R=>({...R,height:W}))},[h,c,s,l,d]);function g(P,A,v){return Math.max(A,Math.min(v,P))}function w(P,A){P.preventDefault();const v=E.current;if(!v)return;const b=v.getBoundingClientRect();p.current={x:P.clientX,y:P.clientY,w:b.width,h:b.height,dir:A},window.addEventListener("mousemove",T),window.addEventListener("mouseup",S)}function T(P){const A=p.current;if(!A)return;const v=P.clientX-A.x,b=P.clientY-A.y,H=A.dir;let W=A.w,R=A.h,F=1/0;const D=E.current?.parentElement;if(D){const me=window.getComputedStyle(D),ue=parseFloat(me.paddingTop||"0")||0,ke=parseFloat(me.paddingBottom||"0")||0;F=Math.max(0,D.clientHeight-ue-ke)}const Q=Math.min(d,isFinite(F)?F:d);H.includes("e")&&(W=g(A.w+v,r,o)),H.includes("s")&&(R=g(A.h+b,l,Q)),H.includes("w")&&(W=g(A.w-v,r,o)),H.includes("n")&&(R=g(A.h-b,l,Q)),x({width:Math.round(W),height:Math.round(R)})}function S(){window.removeEventListener("mousemove",T),window.removeEventListener("mouseup",S),p.current=null}const E=u.useRef(null),I=c?{width:"100%",height:"100%",maxWidth:"100%",maxHeight:"100%"}:{width:m.width?`${m.width}px`:void 0,height:m.height?`${m.height}px`:void 0,maxWidth:`${o}px`,maxHeight:"100%"},M=c?"card relative ndn-modal-full":"card relative";return e.jsxs("div",{ref:E,className:`${M} ${t||""}`,style:I,children:[n,!c&&e.jsx("div",{className:"resizer resizer-nw",onMouseDown:P=>w(P,"nw")}),!c&&e.jsx("div",{className:"resizer resizer-ne",onMouseDown:P=>w(P,"ne")}),!c&&e.jsx("div",{className:"resizer resizer-sw",onMouseDown:P=>w(P,"sw")}),!c&&e.jsx("div",{className:"resizer resizer-se",onMouseDown:P=>w(P,"se")}),!c&&e.jsx("div",{className:"resizer-edge resizer-s",onMouseDown:P=>w(P,"s")})]})}const Il=Js((s,n)=>({samples:[],addSample:t=>s(i=>({samples:[...i.samples,t]})),clear:()=>s({samples:[]}),export:()=>n().samples.slice()})),Vo=Js(s=>({darts:0,total:0,entries:[],setVisit:(n,t,i)=>s({entries:n,darts:t,total:i}),reset:()=>s({darts:0,total:0,entries:[]})})),Al=Js(s=>({paused:!1,pauseEndsAt:null,setPaused:(n,t=null)=>s({paused:n,pauseEndsAt:t??null})}));function rt({onVisitCommitted:s,showToolbar:n=!0,onAutoDart:t,immediateAutoCommit:i=!1,hideInlinePanels:a=!1,scoringMode:r="x01",onGenericDart:l,onGenericReplace:o,x01DoubleInOverride:d}){const c=u.useRef(null),{preferredCameraId:h,preferredCameraLabel:m,setPreferredCamera:x,autoscoreProvider:p,autoscoreWsUrl:g,cameraAspect:w,cameraFitMode:T}=Ft(),S=p==="manual",[E,I]=u.useState([]),M=u.useRef(null),P=u.useRef(null),[A,v]=u.useState(!1),[b,H]=u.useState(!1),[W,R]=u.useState(null),{H:F,imageSize:D,reset:Q,_hydrated:me}=Ka(),[ue,ke]=u.useState(""),[_e,Pe]=u.useState(""),[Le,ve]=u.useState(0),[Ee,$]=u.useState("MISS"),[te,oe]=u.useState(0),[He,We]=u.useState(0),[we,Ie]=u.useState([]),[lt,pe]=u.useState(0),[he,Oe]=u.useState(0),xt=Ft(N=>N.x01DoubleIn),Rt=typeof d=="boolean"?!!d:!!xt,[hs,jt]=u.useState({}),Ne=ha(N=>N),Ht=Ne.players[Ne.currentPlayerIdx]?.id,ie=!!(Ht&&hs[Ht]),fe=N=>{Ht&&jt(L=>({...L,[Ht]:N}))},se=Vo(N=>N.setVisit),Z=Vo(N=>N.reset);u.useEffect(()=>{try{se(we,te,He)}catch{}},[we,te,He,se]),u.useEffect(()=>()=>{try{Z()}catch{}},[Z]);const $e=ha(N=>N.addVisit),ye=ha(N=>N.endLeg),Se=Il(N=>N.addSample),[Qe,Ke]=u.useState(""),[mt,Be]=u.useState(""),[ht,Ye]=u.useState(0),[Nt,it]=u.useState(!1),[yt,C]=u.useState(!1),[ne,Ae]=u.useState(!1),Ce=u.useRef(null),[ze,pt]=u.useState("auto"),[ns,Bt]=u.useState(!1),[Dt,as]=u.useState(!1),[Et,qs]=u.useState(!1),vs=u.useRef(null),fs=Ft(N=>N.dartTimerEnabled),Kt=Ft(N=>N.dartTimerSeconds)||10,[xs,z]=u.useState(null),be=u.useRef(null),wt=Al(N=>N.paused),Ut=u.useRef(null),ps=u.useRef(null),[Us,ls]=u.useState(0);u.useEffect(()=>{const N=()=>{S||as(!0)};return window.addEventListener("ndn:open-autoscore",N),()=>window.removeEventListener("ndn:open-autoscore",N)},[S]),u.useEffect(()=>()=>{try{Ce.current&&clearTimeout(Ce.current)}catch{}},[]),u.useEffect(()=>{const N=()=>qs(!0);return window.addEventListener("ndn:open-scoring",N),()=>window.removeEventListener("ndn:open-scoring",N)},[]),u.useEffect(()=>{let N=!0;async function L(){try{if(!navigator?.mediaDevices?.enumerateDevices)return;const _=await navigator.mediaDevices.enumerateDevices();if(!N)return;I(_.filter(Y=>Y.kind==="videoinput"))}catch(_){console.warn("[CAMERA] enumerateDevices failed:",_)}}L();try{navigator.mediaDevices.addEventListener("devicechange",L)}catch{try{navigator.mediaDevices.ondevicechange=L}catch{}}return()=>{N=!1;try{navigator.mediaDevices.removeEventListener("devicechange",L)}catch{}}},[]),u.useEffect(()=>{const N=()=>{pt("manual"),Bt(!0)},L=()=>{pt("auto"),Bt(!1)};return window.addEventListener("ndn:open-manual",N),window.addEventListener("ndn:close-manual",L),()=>{window.removeEventListener("ndn:open-manual",N),window.removeEventListener("ndn:close-manual",L)}},[]),u.useEffect(()=>{S&&(pt("manual"),as(!1))},[S]),u.useEffect(()=>{try{const N=Ne.players[Ne.currentPlayerIdx],L=N?.legs?.[N.legs.length-1];if(!N)return;(!L||L.dartsThrown===0)&&jt(_=>({..._,[N.id]:!1}))}catch{}},[Ne.currentPlayerIdx,Ne.players?.[Ne.currentPlayerIdx]?.legs?.length]),u.useEffect(()=>{const N=Ne?.inProgress,L=!!fs&&N&&!wt&&te<3;if(be.current&&(clearInterval(be.current),be.current=null),!L){z(null);return}return z(Kt),be.current=window.setInterval(()=>{z(_=>{const Y=(_??Kt)-1;if(Y<=0){try{Vt(0,"MISS 0","MISS")}catch{}return be.current&&(clearInterval(be.current),be.current=null),0}return Y})},1e3),()=>{be.current&&(clearInterval(be.current),be.current=null)}},[fs,Kt,te,Ne.currentPlayerIdx,Ne?.inProgress,wt]),u.useEffect(()=>{if(!ns)return;const N=setInterval(()=>{try{const L=c.current,_=vs.current;if(!L||!_)return;const Y=L.videoWidth||0,ae=L.videoHeight||0;if(!Y||!ae)return;const ce=_.clientWidth||640,xe=_.clientHeight||360;_.width!==ce&&(_.width=ce),_.height!==xe&&(_.height=xe);const je=_.getContext("2d");if(!je)return;je.imageSmoothingEnabled=!0;const Te=Math.min(ce/Y,xe/ae),Mt=Math.round(Y*Te),st=Math.round(ae*Te),ft=Math.floor((ce-Mt)/2),ct=Math.floor((xe-st)/2);je.fillStyle="#000",je.fillRect(0,0,ce,xe),je.drawImage(L,ft,ct,Mt,st)}catch(L){console.warn("Manual preview update error:",L)}},120);return()=>clearInterval(N)},[ns]),u.useEffect(()=>()=>js(),[]);async function $s(){if(!(b||A)){if(m==="Phone Camera"){console.log("[CAMERA] Phone camera is selected - skipping local camera startup"),console.log("[CAMERA] Phone camera feed shown via overlay in game tabs"),H(!1);return}H(!0),console.log("[CAMERA] Starting camera...");try{const N=h?{video:{deviceId:{exact:h}},audio:!1}:{video:{facingMode:"environment"},audio:!1};console.log("[CAMERA] Using constraints:",N);let L;try{L=await navigator.mediaDevices.getUserMedia(N),console.log("[CAMERA] Got stream:",!!L)}catch(_){console.warn("[CAMERA] First attempt failed:",_);const Y=_&&(_.name||_.code)||"";if(h&&(Y==="OverconstrainedError"||Y==="NotFoundError"))console.log("[CAMERA] Trying fallback without deviceId"),L=await navigator.mediaDevices.getUserMedia({video:!0,audio:!1});else if(!h&&(Y==="OverconstrainedError"||Y==="NotFoundError"||Y==="NotSupportedError"))console.log("[CAMERA] Trying fallback for facingMode not supported"),L=await navigator.mediaDevices.getUserMedia({video:!0,audio:!1});else throw _}if(c.current){console.log("[CAMERA] Setting stream to video element"),c.current.srcObject=L,console.log("[CAMERA] Stream tracks:",L.getTracks().length,"video tracks:",L.getVideoTracks().length),c.current.addEventListener("loadeddata",()=>console.log("[CAMERA] Video loadeddata")),c.current.addEventListener("canplay",()=>console.log("[CAMERA] Video canplay")),c.current.addEventListener("play",()=>console.log("[CAMERA] Video started playing")),c.current.addEventListener("error",_=>console.error("[CAMERA] Video error:",_));try{c.current.play(),console.log("[CAMERA] Play called successfully")}catch(_){console.error("[CAMERA] Video play failed:",_),setTimeout(()=>{try{c.current?.play(),console.log("[CAMERA] Retry play called")}catch(Y){console.error("[CAMERA] Retry play failed:",Y)}},100)}}else console.error("[CAMERA] Video element not found");v(!0);try{const _=await navigator.mediaDevices.enumerateDevices();I(_.filter(Y=>Y.kind==="videoinput")),console.log("[CAMERA] Found cameras:",_.filter(Y=>Y.kind==="videoinput").length)}catch(_){console.warn("[CAMERA] Failed to enumerate devices:",_)}}catch(N){console.error("[CAMERA] Camera start failed:",N),alert("Camera permission denied or not available.")}finally{H(!1)}}}function js(){c.current&&c.current.srcObject&&(c.current.srcObject.getTracks().forEach(L=>L.stop()),c.current.srcObject=null,v(!1),H(!1))}function gs(){try{if(!c.current||!M.current)return;const N=c.current,L=M.current;L.width=N.videoWidth,L.height=N.videoHeight;const _=L.getContext("2d");if(!_)return;_.drawImage(N,0,0,L.width,L.height);const Y=L.toDataURL("image/png");R(Y)}catch(N){console.warn("Capture error:",N)}}function As(){return E.length?e.jsxs("div",{className:"absolute top-2 right-2 z-20 flex items-center gap-2 bg-black/40 rounded px-2 py-1 text-xs",children:[e.jsx("span",{children:"Cam:"}),e.jsxs("select",{className:"bg-black/20 rounded px-1 py-0.5",value:h||"",onChange:async N=>{if(b)return;const L=N.target.value||void 0,_=E.find(Y=>Y.deviceId===L)?.label;x(L,_||"",!0),js(),await new Promise(Y=>setTimeout(Y,150));try{await $s()}catch(Y){console.warn("Failed to start camera after device switch:",Y),setTimeout(async()=>{try{await $s()}catch(ae){console.error("Camera switch failed after retry:",ae),alert("Failed to switch camera. Please try again or refresh the page.")}},500)}},children:[e.jsx("option",{value:"",children:"Auto"}),E.map(N=>e.jsx("option",{value:N.deviceId,children:N.label||(N.deviceId?`Camera (${N.deviceId.slice(0,6)})`:"Camera")},N.deviceId))]}),e.jsx("button",{className:"btn btn--ghost btn-sm ml-2",onClick:async()=>{try{const N=await navigator.mediaDevices.enumerateDevices();I(N.filter(L=>L.kind==="videoinput"))}catch(N){console.warn("Rescan failed:",N),alert("Failed to rescan devices. Ensure camera permissions are granted.")}},title:"Rescan connected cameras",children:"Rescan"})]}):null}function ys(){try{if(!P.current||!c.current||!F||!D)return;const N=P.current,L=c.current,_=L.clientWidth,Y=L.clientHeight;N.width=_,N.height=Y;const ae=N.getContext("2d");if(!ae)return;ae.clearRect(0,0,_,Y);const ce=_/D.w,xe=Y/D.h,je=_d(F,ce,xe),Te=[Ge.bullInner,Ge.bullOuter,Ge.trebleInner,Ge.trebleOuter,Ge.doubleInner,Ge.doubleOuter];for(const Mt of Te){const st=Sl(je,Mt,360);Cl(ae,st,Mt===Ge.doubleOuter?"#22d3ee":"#a78bfa",Mt===Ge.doubleOuter?3:2)}}catch(N){console.warn("Overlay drawing error:",N)}}u.useEffect(()=>{if(S)return;const N=setInterval(ys,250);return()=>clearInterval(N)},[F,D,A,S]),u.useEffect(()=>{if(S||p!=="built-in")return;const N=Gn.getState(),_=Ft.getState().preferredCameraLabel==="Phone Camera"?N.getVideoElementRef?.()||null:c.current;if(!_||!F||!D)return;let Y=!1;const ae=_,ce=M.current;if(!ce)return;Ut.current||(Ut.current=new ju);const xe=()=>{if(!Y){try{const je=ae.videoWidth||0,Te=ae.videoHeight||0;if(!je||!Te){ps.current=requestAnimationFrame(xe);return}ce.width!==je&&(ce.width=je),ce.height!==Te&&(ce.height=Te);const Mt=ce.getContext("2d");if(!Mt){ps.current=requestAnimationFrame(xe);return}Mt.drawImage(ae,0,0,je,Te);const st=Mt.getImageData(0,0,je,Te),ft=Wn(F,{x:0,y:0}),ct=Wn(F,{x:Ge.doubleOuter,y:0}),bt=je/D.w,is=Te/D.h,cs=ft.x*bt,Wt=ft.y*is,ds=ct.x*bt,us=ct.y*is,Ks=Math.hypot(ds-cs,us-Wt)*1.08,St=Ut.current;if(Us>=0&&St.setROI(cs,Wt,Math.max(24,Math.min(Math.max(je,Te),Ks))),!wt&&te<3){const Ot=St.detect(st);if(Ot&&Ot.confidence>=.6){const Ze=qd(ce,Ot.tip,6),dt={x:Ze.x/bt,y:Ze.y/is},ut=Wo(F,dt),Yt=`${ut.ring} ${ut.base>0?ut.base:""}`.trim();ke(Yt),ve(ut.base),$(ut.ring),C(!0);try{if(!!ut&&ut.ring!=="MISS"&&(ut.base||0)>0){Ae(!0);try{Ce.current&&clearTimeout(Ce.current)}catch{}Ce.current=window.setTimeout(()=>{Ae(!1),Ce.current=null},1500)}}catch{}try{const $t=P.current;if($t){const Tt=$t.getContext("2d");if(Tt){const bs=Ze.x/je*$t.width,gt=Ze.y/Te*$t.height;if(Tt.save(),Tt.beginPath(),Tt.strokeStyle="#f59e0b",Tt.lineWidth=2,Tt.arc(bs,gt,6,0,Math.PI*2),Tt.stroke(),Ot.axis){const Ys=Ot.axis,Gt=Ys.x1/je*$t.width,Ts=Ys.y1/Te*$t.height,ws=Ys.x2/je*$t.width,Ds=Ys.y2/Te*$t.height;Tt.beginPath(),Tt.moveTo(Gt,Ts),Tt.lineTo(ws,Ds),Tt.stroke()}if(Ot.bbox){const Ys=Ot.bbox.x/je*$t.width,Gt=Ot.bbox.y/Te*$t.height,Ts=Ot.bbox.w/je*$t.width,ws=Ot.bbox.h/Te*$t.height;Tt.strokeStyle="#22d3ee",Tt.strokeRect(Ys,Gt,Ts,ws)}Tt.restore()}}}catch{}try{t&&t(ut.base,ut.ring,{sector:ut.sector??null,mult:ut.mult??0})}catch{}St.accept(st,Ot)}}}catch{}ps.current=requestAnimationFrame(xe)}};return ps.current=requestAnimationFrame(xe),()=>{Y=!0,ps.current&&cancelAnimationFrame(ps.current),ps.current=null}},[S,p,A,F,D,wt,te,Us]),u.useEffect(()=>{try{Is.getState().setCalibrationStatus({hasHomography:!!F,imageSize:D})}catch{}},[F,D]),u.useEffect(()=>{if(p!=="external-ws"||!g)return;const N=wu(g,L=>{if(t){try{t(L.value,L.ring,{sector:L.sector??null,mult:L.mult??0})}catch{}try{Se({playerId:Ne.players[Ne.currentPlayerIdx]?.id??null,sector:L.sector??null,mult:L.mult??0,ring:L.ring,ts:Date.now()})}catch{}}else{const _=L.ring==="INNER_BULL"?"INNER_BULL 50":L.ring==="BULL"?"BULL 25":`${L.ring[0]}${L.value/(L.mult||1)||L.value} ${L.value}`;Vt(L.value,_,L.ring);try{Se({playerId:Ne.players[Ne.currentPlayerIdx]?.id??null,sector:L.sector??null,mult:L.mult??0,ring:L.ring,ts:Date.now()})}catch{}}});return()=>N.close()},[p,g]);function rs(N){if(!P.current||!F||!D)return;const L=P.current.getBoundingClientRect(),_=N.clientX-L.left,Y=N.clientY-L.top,ae=P.current.width/D.w,ce=P.current.height/D.h,xe={x:_/ae,y:Y/ce},je=Wo(F,xe),Te=`${je.ring} ${je.base>0?je.base:""}`.trim();ke(Te),ve(je.base),$(je.ring),C(!0);try{if(i&&t){t(je.base,je.ring,{sector:je.sector,mult:je.mult});try{Se({playerId:Ne.players[Ne.currentPlayerIdx]?.id??null,sector:je.sector??null,mult:je.mult??0,ring:je.ring,ts:Date.now()})}catch{}C(!1)}}catch{}}function Ns(N){const L=N.trim().toUpperCase();if(!L)return null;const _=L==="BULL"||L==="50"||L==="DBULL"||L==="IBULL",Y=L==="25"||L==="OBULL";if(_)return{label:"INNER_BULL 50",value:50,ring:"INNER_BULL"};if(Y)return{label:"BULL 25",value:25,ring:"BULL"};const ae=L.match(/^(S|D|T)?\s*(\d{1,2})$/);if(!ae)return null;const ce=ae[1]||"S",xe=parseInt(ae[2],10);if(xe<1||xe>20)return null;const je=ce==="S"?1:ce==="D"?2:3,Te=ce==="S"?"SINGLE":ce==="D"?"DOUBLE":"TRIPLE";return{label:`${ce}${xe} ${xe*je}`,value:xe*je,ring:Te}}function Rs(){const N=Ne;if(!N.players.length)return N.startingScore;const L=N.players[N.currentPlayerIdx],_=L.legs[L.legs.length-1];return _?_.totalScoreRemaining:N.startingScore}function Vt(N,L,_){if(r==="custom"){if(l)try{l(N,_,{label:L})}catch{}if(te>=3){oe(1),We(N),Ie([{label:L,value:N,ring:_}]);return}const ft=te+1;oe(ft),We(ct=>ct+N),Ie(ct=>[...ct,{label:L,value:N,ring:_}]);return}if(te>=3){$e(He,te,{preOpenDarts:lt||0,doubleWindowDarts:he||0,finishedByDouble:!1,visitTotal:He});try{const bt=Ne.players[Ne.currentPlayerIdx]?.name;bt&&gn(bt,te,He)}catch{}const ft=!Rt||ie||_==="DOUBLE"||_==="INNER_BULL",ct=ft?N:0;oe(1),We(ct),Ie([{label:L,value:ct,ring:_}]),pe(ft?0:1),Oe(0),Rt&&!ie&&(_==="DOUBLE"||_==="INNER_BULL")&&fe(!0),s&&s(He,te,!1);return}const Y=te+1,ce=!Rt||ie||_==="DOUBLE"||_==="INNER_BULL"?N:0;Rt&&!ie&&(_==="DOUBLE"||_==="INNER_BULL")&&fe(!0);const xe=He+ce,Te=Rs()-xe,Mt=Te===0&&(_==="DOUBLE"||_==="INNER_BULL");if(Te<0||Te===1||Te===0&&!Mt){const ct=(lt||0)+(Rt&&!ie&&!(_==="DOUBLE"||_==="INNER_BULL")?1:0),bt=Te,is=Te+ce,cs=is>50&&bt<=50||is<=50?1:0,Wt=(he||0)+cs;$e(0,Y,{preOpenDarts:ct,doubleWindowDarts:Wt,finishedByDouble:!1,visitTotal:0}),oe(0),We(0),Ie([]),pe(0),Oe(0),s&&s(0,Y,!1);return}oe(Y),We(xe),Ie(ft=>[...ft,{label:L,value:ce,ring:_}]),Rt&&!ie&&!(_==="DOUBLE"||_==="INNER_BULL")&&pe(ft=>(ft||0)+1);{const ft=Te,ct=Te+ce;(ct>50&&ft<=50||ct<=50)&&Oe(is=>(is||0)+1)}if(Mt){$e(xe,Y,{preOpenDarts:lt||0,doubleWindowDarts:he||0,finishedByDouble:!0,visitTotal:xe}),ye(xe),oe(0),We(0),Ie([]),pe(0),Oe(0),s&&s(xe,Y,!0);return}Y>=3&&($e(xe,Y,{preOpenDarts:lt||0,doubleWindowDarts:he||0,finishedByDouble:!1,visitTotal:xe}),oe(0),We(0),Ie([]),pe(0),Oe(0),s&&s(xe,Y,!1))}function ks(){if(ue){if(t)try{t(Le,Ee,void 0)}catch{}else Vt(Le,ue,Ee);Ye(0),C(!1)}}function Zt(){const N=Ns(_e);if(!N){alert("Enter like T20, D16, 5, 25, 50");return}if(!yt||!ue||Ee==="MISS"||Le===0){const L=ht+1;Ye(L),L>=5&&it(!0)}else Ye(0);Vt(N.value,N.label,N.ring),Pe(""),C(!1)}function Ps(){const N=Ns(_e);if(!N){alert("Enter like T20, D16, 5, 25, 50");return}if(te===0||we.length===0){Zt();return}if(r==="custom"){if(!yt||!ue||Ee==="MISS"||Le===0){const st=ht+1;Ye(st),st>=5&&it(!0)}else Ye(0);if(Ie(st=>[...st.slice(0,-1),{label:N.label,value:N.value,ring:N.ring}]),o)try{o(N.value,N.ring,{label:N.label})}catch{}Pe(""),C(!1);return}if(!yt||!ue||Ee==="MISS"||Le===0){const st=ht+1;Ye(st),st>=5&&it(!0)}else Ye(0);const L=we[we.length-1],_=te-1,Y=He-(L?.value||0),ae=Rs(),ce=Y+N.value,xe=_+1,je=ae-ce,Te=je===0&&(N.ring==="DOUBLE"||N.ring==="INNER_BULL");if(je<0||je===1||je===0&&!Te){$e(0,xe);try{const st=Ne.players[Ne.currentPlayerIdx]?.name;st&&gn(st,xe,0)}catch{}oe(0),We(0),Ie([]),s&&s(0,xe,!1),Pe(""),C(!1);return}if(oe(xe),We(ce),Ie(st=>[...st.slice(0,-1),{label:N.label,value:N.value,ring:N.ring}]),Te){$e(ce,xe),ye(ce);try{const st=Ne.players[Ne.currentPlayerIdx]?.name;st&&gn(st,xe,ce)}catch{}oe(0),We(0),Ie([]),s&&s(ce,xe,!0),Pe(""),C(!1);return}if(xe>=3){$e(ce,xe);try{const st=Ne.players[Ne.currentPlayerIdx]?.name;st&&gn(st,xe,ce)}catch{}oe(0),We(0),Ie([]),s&&s(ce,xe,!1)}Pe(""),C(!1)}function Cs(){it(!1),Ye(0);try{window.dispatchEvent(new CustomEvent("ndn:request-calibrate"))}catch{}}function U(){Q(),it(!1),Ye(0)}React.useEffect(()=>{function N(L){try{const Y=document.activeElement?.tagName?.toLowerCase();L.key==="m"&&Y!=="input"&&Y!=="textarea"&&(pt("manual"),Bt(!0))}catch{}}return window.addEventListener("keydown",N),()=>window.removeEventListener("keydown",N)},[]);function K(N,L){if(te>=3)return;const _=N*(L==="S"?1:L==="D"?2:3),Y=L==="S"?"SINGLE":L==="D"?"DOUBLE":"TRIPLE";if(!yt||!ue||Ee==="MISS"||Le===0){const ae=ht+1;Ye(ae),ae>=5&&it(!0)}else Ye(0);Vt(_,`${L}${N} ${_}`,Y),C(!1)}function ee(){if(te===0)return;const N=we[we.length-1];oe(L=>L-1),We(L=>L-(N?.value||0)),Ie(L=>L.slice(0,-1))}function G(){if(te!==0){if(r==="custom"){oe(0),We(0),Ie([]);return}$e(He,te);try{const N=Ne.players[Ne.currentPlayerIdx]?.name;N&&gn(N,te,He)}catch{}oe(0),We(0),Ie([]),s&&s(He,te,!1)}}return e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-4",children:[n&&e.jsx("div",{className:"lg:col-span-2",children:e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[!S&&e.jsx("button",{className:`btn px-3 py-1 text-sm ${ze==="auto"?"tab--active":""}`,onClick:()=>{pt("auto"),Bt(!1),as(!0)},children:"Autoscore"}),e.jsx("button",{className:`btn px-3 py-1 text-sm ${ze==="manual"?"tab--active":""}`,onClick:()=>{pt("manual"),Bt(!0)},title:"Open Manual Correction",children:"Manual Correction"}),S&&e.jsx("span",{className:"text-xs opacity-70",children:"Manual scoring mode active"})]})}),!a&&!S?e.jsxs("div",{className:"card relative",children:[e.jsx("h2",{className:"text-xl font-semibold mb-3",children:"Camera"}),e.jsxs(fa,{storageKey:"ndn:camera:size",className:"relative rounded-2xl overflow-hidden bg-black",defaultWidth:480,defaultHeight:360,minWidth:320,minHeight:240,maxWidth:1600,maxHeight:900,autoFill:!0,children:[e.jsx(As,{}),m==="Phone Camera"?e.jsx("div",{className:"w-full h-full flex flex-col items-center justify-center bg-gradient-to-br from-blue-900/50 to-purple-900/50",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-4xl mb-4",children:"ðŸ“±"}),e.jsx("div",{className:"text-lg font-semibold text-blue-100 mb-2",children:"Phone Camera Active"}),e.jsx("div",{className:"text-sm text-slate-300 mb-4",children:"Your phone camera feed is shown in the floating overlay"}),e.jsx("div",{className:"text-xs text-slate-400",children:"Camera controls available in Calibrator tab"})]})}):(()=>{const N=w||Ft.getState().cameraAspect||"wide",L=(T||Ft.getState().cameraFitMode||"fit")==="fit",_=N==="square"?"absolute left-0 top-1/2 -translate-y-1/2 min-w-full min-h-full object-cover object-left bg-black":L?"absolute inset-0 w-full h-full object-contain object-center bg-black":"absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 min-w-full min-h-full w-auto h-auto object-cover object-center bg-black",Y=N==="square"?"relative w-full max-w-[640px] mx-auto aspect-square bg-black":"relative w-full aspect-[4/3] bg-black";return e.jsxs("div",{className:Y,children:[e.jsx("video",{ref:c,className:_,playsInline:!0,"webkit-playsinline":"true",muted:!0,autoPlay:!0}),e.jsx("canvas",{ref:P,className:"absolute inset-0 w-full h-full",onClick:rs}),e.jsxs("div",{className:"absolute top-2 left-1/2 -translate-x-1/2 z-20 flex items-center gap-3","aria-label":`Visit status: ${we[0]?we[0].value>0?"hit":"miss":"pending"}, ${we[1]?we[1].value>0?"hit":"miss":"pending"}, ${we[2]?we[2].value>0?"hit":"miss":"pending"}`,children:[[0,1,2].map(ae=>{const ce=we[ae],xe=!ce,je=!!ce&&(typeof ce.value=="number"?ce.value>0:!0),Te=xe?"bg-gray-500/70":je?"bg-emerald-400":"bg-rose-500";return e.jsx("span",{className:`w-3 h-3 rounded-full shadow ${Te}`},ae)}),fs&&xs!==null&&e.jsxs("span",{className:"px-2 py-0.5 rounded bg-black/60 text-white text-xs font-semibold",children:[Math.max(0,xs),"s"]})]})]})})()]}),inProgress?e.jsx("div",{className:"absolute top-3 right-3 z-30",children:(()=>{let N="bg-white/90 text-slate-800",L="Manual Correction (M)";yt&&(!!ue&&Ee!=="MISS"&&Le>0?(N="bg-emerald-600 text-white",L=`Manual Correction (M) â€” Autoscore: ${ue} (confirmed)`):(N="bg-amber-400 text-black",L=`Manual Correction (M) â€” Autoscore ambiguous: ${ue||"â€”"}`));const _="px-4 py-2 rounded-full text-base font-semibold shadow-sm hover:opacity-90",Y=yt&&!!ue&&Ee!=="MISS"&&Le>0,ae=ne&&Y?"ring-4 ring-emerald-400/60 animate-ping":yt&&!Y?"animate-pulse":"";return e.jsx("button",{className:`${_} ${N} ${ae}`,onClick:()=>{pt("manual"),Bt(!0)},title:L,children:"Manual"})})()}):null,e.jsxs("div",{className:"flex gap-2 mt-3",children:[m==="Phone Camera"?e.jsx("div",{className:"text-sm text-blue-200 px-3 py-2 rounded bg-blue-900/30 flex-1",children:"ðŸ“± Using phone camera from overlay"}):e.jsxs(e.Fragment,{children:[A?e.jsx("button",{className:"btn bg-rose-600 hover:bg-rose-700",onClick:js,children:"Stop Camera"}):e.jsx("button",{className:"btn",onClick:$s,disabled:b,children:b?"Connecting Camera...":"Connect Camera"}),e.jsx("button",{className:"btn",onClick:gs,disabled:!A,children:"Capture Still"}),e.jsx("button",{className:"btn bg-slate-700 hover:bg-slate-800",disabled:!A,onClick:()=>{Ut.current=null,ls(N=>N+1)},children:"Reset Autoscore Background"})]}),e.jsx("button",{className:"btn bg-slate-700 hover:bg-slate-800",onClick:()=>{try{window.dispatchEvent(new Event("ndn:camera-reset"))}catch{}},children:"Reset Camera Size"})]})]}):null,inProgress?e.jsx("div",{className:"fixed bottom-6 right-6 z-50",children:e.jsx("button",{className:"btn btn--primary rounded-full w-12 h-12 flex items-center justify-center shadow-lg",title:"Open Manual Correction (M)",onClick:()=>{pt("manual"),Bt(!0)},children:"âœï¸"})}):null,!a&&S&&e.jsxs("div",{className:"card",children:[e.jsx("h2",{className:"text-xl font-semibold mb-3",children:"Manual Scoring"}),e.jsx("p",{className:"text-sm opacity-80 mb-3",children:"Camera-based autoscore is disabled. Use the manual visit input or open the Manual Correction panel to record darts."}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsx("button",{className:"btn",onClick:()=>{Bt(!0),pt("manual")},children:"Open Manual Correction"}),e.jsx("button",{className:"btn btn--ghost",onClick:()=>{try{window.dispatchEvent(new Event("ndn:open-scoring"))}catch{}},children:"Manage Pending Visit"})]})]}),e.jsx("canvas",{ref:M,className:"hidden"}),Dt&&!S&&e.jsx("div",{className:"fixed inset-0 bg-black/60 z-[100]",role:"dialog","aria-modal":"true",children:e.jsx("div",{className:"absolute inset-0 flex items-center justify-center p-4",children:e.jsxs(zs,{storageKey:"ndn:autoscore:size",className:"w-full max-w-3xl",defaultWidth:720,defaultHeight:520,minWidth:420,minHeight:320,maxWidth:1400,maxHeight:900,initialFitHeight:!0,children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h2",{className:"text-xl font-semibold",children:"Autoscore"}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("button",{className:"btn btn--ghost",onClick:()=>as(!1),children:"Close"})})]}),e.jsx("div",{className:"text-sm opacity-80 mb-3",children:"Click the camera overlay to autoscore. Use Manual Correction if the last auto is off."}),e.jsxs("div",{className:"flex items-center gap-2 mb-3 flex-wrap",children:[e.jsx("span",{className:"font-semibold",children:"Last auto:"}),e.jsx("span",{children:ue||"â€”"}),e.jsx("button",{className:"btn",onClick:ks,disabled:te>=3,children:"Add Auto Dart"}),ht>0&&e.jsxs("span",{className:"text-sm opacity-80",children:["No-registers: ",ht,"/3"]})]}),e.jsxs("div",{className:"mt-2",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"Quick entry"}),e.jsxs("div",{className:"flex flex-wrap gap-2 mb-3",children:[e.jsx("button",{className:"btn",disabled:te>=3,onClick:()=>{if(!yt||!ue||Ee==="MISS"||Le===0){const N=ht+1;Ye(N),N>=5&&it(!0)}else Ye(0);Vt(25,"BULL 25","BULL"),C(!1)},children:"25"}),e.jsx("button",{className:"btn",disabled:te>=3,onClick:()=>{if(!yt||!ue||Ee==="MISS"||Le===0){const N=ht+1;Ye(N),N>=5&&it(!0)}else Ye(0);Vt(50,"INNER_BULL 50","INNER_BULL"),C(!1)},children:"50"})]}),e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx("input",{className:"input w-full max-w-sm",list:"autoscore-quick-list",placeholder:"Type or select (e.g., D16, T20, S5)",value:Qe,onChange:N=>Ke(N.target.value.toUpperCase()),onKeyDown:N=>{if(N.key==="Enter"){const L=Qe.match(/^(S|D|T)(\d{1,2})$/);L&&K(parseInt(L[2],10),L[1])}}}),e.jsx("datalist",{id:"autoscore-quick-list",children:["D","S","T"].map(N=>Array.from({length:20},(L,_)=>_+1).map(L=>e.jsx("option",{value:`${N}${L}`},`${N}${L}`)))}),e.jsx("button",{className:"btn",disabled:!Qe||te>=3,onClick:()=>{const N=Qe.match(/^(S|D|T)(\d{1,2})$/);if(!N)return;const L=N[1],_=parseInt(N[2],10);K(_,L)},children:"Add"})]})]})]})})}),ns&&e.jsx("div",{className:"fixed inset-0 bg-black/60 z-[100]",role:"dialog","aria-modal":"true",children:e.jsxs("div",{className:"absolute inset-0 flex flex-col",children:[e.jsxs("div",{className:"p-3 md:p-4 flex items-center justify-between",children:[e.jsx("h3",{className:"text-xl md:text-2xl font-semibold",children:"Manual Correction"}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("button",{className:"btn bg-slate-700 hover:bg-slate-800",onClick:()=>{Bt(!1)},children:"Close"})})]}),e.jsx("div",{className:"flex-1 p-3 md:p-4",children:e.jsxs("div",{className:"h-full grid grid-cols-1 lg:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"card relative flex flex-col",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"Live Preview"}),e.jsx("div",{className:"relative flex-1 rounded-2xl overflow-hidden bg-black",children:e.jsx("canvas",{ref:vs,className:"absolute inset-0 w-full h-full"})})]}),e.jsxs("div",{className:"card flex flex-col",children:[e.jsx("div",{className:"text-sm opacity-80 mb-2",children:"Type a correction or replace the last dart. The preview updates live."}),e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("span",{className:"font-semibold",children:"Last auto:"}),e.jsx("span",{children:ue||"â€”"}),e.jsx("button",{className:"btn",onClick:ks,disabled:te>=3,children:"Add Auto Dart"})]}),e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("input",{className:"input flex-1",placeholder:"Manual (T20, D16, 5, 25, 50)",value:_e,onChange:N=>Pe(N.target.value),onKeyDown:N=>{N.key==="Enter"&&!N.shiftKey&&(N.preventDefault(),Zt()),N.key==="Enter"&&N.shiftKey&&(N.preventDefault(),Ps())}}),e.jsx("button",{className:"btn btn--ghost",onClick:Ps,disabled:te===0,children:"Replace Last"}),e.jsx("button",{className:"btn",onClick:Zt,disabled:te>=3,children:"Add"})]}),e.jsx("div",{className:"text-xs opacity-70 mb-4",children:"Press Enter to Add Â· Shift+Enter to Replace Last"}),e.jsxs("div",{className:"mb-4",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"Number pad"}),e.jsxs("div",{className:"grid grid-cols-3 gap-2 max-w-sm",children:[["7","8","9","4","5","6","1","2","3","0"].map(N=>e.jsx("button",{className:"btn text-lg",onClick:()=>{Pe(L=>/^[SDT]/i.test(L)?L+N:(L||"")+N)},children:N},N)),e.jsx("button",{className:"btn bg-rose-600 hover:bg-rose-700 text-white",onClick:()=>Pe(""),children:"Clear"}),e.jsx("button",{className:"btn bg-slate-600 hover:bg-slate-700 text-white",onClick:()=>Pe(N=>(N||"").slice(0,-1)),children:"âŒ«"}),e.jsx("button",{className:"btn bg-emerald-600 hover:bg-emerald-700 text-white",onClick:()=>Zt(),disabled:te>=3,children:"Enter"})]}),e.jsx("div",{className:"text-xs opacity-70 mt-2",children:"Tap numbers then press Enter to submit. Use D/T prefixes for doubles/trebles (e.g., D16)."})]}),e.jsxs("div",{className:"mt-auto",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"Quick entry"}),e.jsxs("div",{className:"flex flex-wrap gap-2 mb-3",children:[e.jsx("button",{className:"btn",disabled:te>=3,onClick:()=>{if(!yt||!ue||Ee==="MISS"||Le===0){const N=ht+1;Ye(N),N>=5&&it(!0)}else Ye(0);Vt(25,"BULL 25","BULL"),C(!1)},children:"25"}),e.jsx("button",{className:"btn",disabled:te>=3,onClick:()=>{if(!yt||!ue||Ee==="MISS"||Le===0){const N=ht+1;Ye(N),N>=5&&it(!0)}else Ye(0);Vt(50,"INNER_BULL 50","INNER_BULL"),C(!1)},children:"50"})]}),e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx("input",{className:"input w-full max-w-sm",list:"manual-quick-list",placeholder:"Type or select (e.g., D16, T20, S5)",value:mt,onChange:N=>Be(N.target.value.toUpperCase()),onKeyDown:N=>{if(N.key==="Enter"){const L=mt.match(/^(S|D|T)(\d{1,2})$/);L&&K(parseInt(L[2],10),L[1])}}}),e.jsx("datalist",{id:"manual-quick-list",children:["D","S","T"].map(N=>Array.from({length:20},(L,_)=>_+1).map(L=>e.jsx("option",{value:`${N}${L}`},`${N}${L}`)))}),e.jsx("button",{className:"btn",disabled:!mt||te>=3,onClick:()=>{const N=mt.match(/^(S|D|T)(\d{1,2})$/);if(!N)return;const L=N[1],_=parseInt(N[2],10);K(_,L)},children:"Add"})]})]})]})]})})]})}),Et&&e.jsx("div",{className:"fixed inset-0 bg-black/60 z-[100] flex items-center justify-center",children:e.jsxs("div",{className:"card w-full max-w-4xl relative text-left bg-[#2d2250] text-white p-6 rounded-xl shadow-xl",children:[e.jsx("button",{className:"absolute top-2 right-2 btn px-2 py-1 bg-purple-500 text-white font-bold",onClick:()=>qs(!1),children:"Close"}),e.jsx("h2",{className:"text-xl font-bold mb-4 flex items-center gap-2 text-white",children:"Scoring"}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"bg-black/30 rounded-2xl p-4",children:[e.jsx("h2",{className:"text-lg font-semibold mb-3",children:"Camera"}),e.jsxs(fa,{storageKey:"ndn:camera:size:modal",className:"relative rounded-2xl overflow-hidden bg-black",defaultWidth:480,defaultHeight:360,minWidth:320,minHeight:240,maxWidth:1600,maxHeight:900,children:[e.jsx(As,{}),m==="Phone Camera"?e.jsx("div",{className:"w-full h-full flex flex-col items-center justify-center bg-gradient-to-br from-blue-900/50 to-purple-900/50",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-4xl mb-4",children:"ðŸ“±"}),e.jsx("div",{className:"text-lg font-semibold text-blue-100 mb-2",children:"Phone Camera Active"}),e.jsx("div",{className:"text-sm text-slate-300 mb-4",children:"Your phone camera feed is shown in the floating overlay"}),e.jsx("div",{className:"text-xs text-slate-400",children:"Camera controls available in Calibrator tab"})]})}):(()=>{const L=(Ft.getState().cameraFitMode||"fit")==="fit"?"absolute inset-0 w-full h-full object-contain object-center bg-black":"absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 min-w-full min-h-full w-auto h-auto object-cover object-center bg-black";return e.jsxs("div",{className:"relative w-full aspect-[4/3] bg-black",children:[e.jsx("video",{ref:c,className:L,playsInline:!0,"webkit-playsinline":"true",muted:!0,autoPlay:!0}),e.jsx("canvas",{ref:P,className:"absolute inset-0 w-full h-full",onClick:rs}),e.jsxs("div",{className:"absolute top-2 left-1/2 -translate-x-1/2 z-20 flex items-center gap-3","aria-label":`Visit status: ${we[0]?we[0].value>0?"hit":"miss":"pending"}, ${we[1]?we[1].value>0?"hit":"miss":"pending"}, ${we[2]?we[2].value>0?"hit":"miss":"pending"}`,children:[[0,1,2].map(_=>{const Y=we[_],ae=!Y,ce=!!Y&&(typeof Y.value=="number"?Y.value>0:!0),xe=ae?"bg-gray-500/70":ce?"bg-emerald-400":"bg-rose-500";return e.jsx("span",{className:`w-3 h-3 rounded-full shadow ${xe}`},_)}),fs&&xs!==null&&e.jsxs("span",{className:"px-2 py-0.5 rounded bg-black/60 text-white text-xs font-semibold",children:[Math.max(0,xs),"s"]})]})]})})()]}),e.jsxs("div",{className:"flex gap-2 mt-3",children:[m==="Phone Camera"?e.jsx("div",{className:"text-sm text-blue-200 px-3 py-2 rounded bg-blue-900/30 flex-1",children:"ðŸ“± Using phone camera from overlay"}):e.jsxs(e.Fragment,{children:[A?e.jsx("button",{className:"btn bg-gradient-to-r from-rose-600 to-rose-700 text-white font-bold",onClick:js,children:"Stop Camera"}):e.jsx("button",{className:"btn bg-gradient-to-r from-purple-500 to-purple-700 text-white font-bold",onClick:$s,children:"Connect Camera"}),e.jsx("button",{className:"btn bg-gradient-to-r from-indigo-500 to-indigo-700 text-white font-bold",onClick:gs,disabled:!A,children:"Capture Still"}),e.jsx("button",{className:"btn bg-gradient-to-r from-slate-600 to-slate-800 text-white font-bold",disabled:!A,onClick:()=>{Ut.current=null,ls(N=>N+1)},children:"Reset Autoscore Background"})]}),e.jsx("button",{className:"btn bg-gradient-to-r from-slate-500 to-slate-700 text-white font-bold",onClick:()=>{try{window.dispatchEvent(new Event("ndn:camera-reset"))}catch{}},children:"Reset Camera Size"})]})]}),e.jsxs("div",{className:"bg-black/30 rounded-2xl p-4",children:[e.jsx("h2",{className:"text-lg font-semibold mb-3",children:"Pending Visit"}),e.jsx("div",{className:"text-sm opacity-80 mb-2",children:"Up to 3 darts per visit."}),e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[[0,1,2].map(N=>{const L=we[N],_=!L,Y=!!L&&(typeof L.value=="number"?L.value>0:!0),ae=_?"bg-gray-500/70":Y?"bg-emerald-400":"bg-rose-500";return e.jsx("span",{className:`w-2.5 h-2.5 rounded-full shadow ${ae}`},N)}),fs&&xs!==null&&e.jsxs("span",{className:"ml-2 px-2 py-0.5 rounded bg-black/40 text-white text-xs font-semibold",children:[Math.max(0,xs),"s"]})]}),e.jsx("ul",{className:"text-sm mb-2 list-disc pl-5",children:we.length===0?e.jsx("li",{className:"opacity-60",children:"No darts yet"}):we.map((N,L)=>e.jsx("li",{children:N.label},L))}),e.jsxs("div",{className:"flex items-center gap-4 mb-2",children:[e.jsxs("div",{className:"font-semibold",children:["Darts: ",te,"/3"]}),e.jsxs("div",{className:"font-semibold",children:["Total: ",He]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{className:"btn bg-gradient-to-r from-purple-500 to-purple-700 text-white font-bold",onClick:ee,disabled:te===0,children:"Undo Dart"}),e.jsx("button",{className:"btn bg-gradient-to-r from-emerald-500 to-emerald-700 text-white font-bold",onClick:G,disabled:te===0,children:"Commit Visit"}),e.jsx("button",{className:"btn bg-gradient-to-r from-slate-500 to-slate-700 text-white font-bold",onClick:()=>{oe(0),We(0),Ie([])},disabled:te===0,children:"Clear"})]})]})]})]})}),Nt&&e.jsx("div",{className:"fixed inset-0 bg-black/60 z-50 flex items-center justify-center",children:e.jsxs("div",{className:"card max-w-md w-full relative text-left bg-[#2d2250] text-white p-6 rounded-xl shadow-xl",children:[e.jsx("button",{className:"absolute top-2 right-2 btn px-2 py-1 bg-purple-500 text-white font-bold",onClick:()=>{it(!1),Ye(0)},children:"Close"}),e.jsx("h3",{className:"text-xl font-bold mb-2 flex items-center gap-2 text-white",children:"Recalibration Recommended"}),e.jsx("div",{className:"mb-4 text-lg font-semibold text-indigo-200",children:"We detected 3 incorrect autoscores in a row. You can recalibrate now or reset calibration and try again."}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{className:"btn bg-gradient-to-r from-purple-500 to-purple-700 text-white font-bold",onClick:Cs,children:"Go to Calibrate"}),e.jsx("button",{className:"btn bg-gradient-to-r from-slate-500 to-slate-700 text-white font-bold",onClick:U,children:"Reset Calibration"}),e.jsx("button",{className:"btn bg-gradient-to-r from-slate-500 to-slate-700 text-white font-bold",onClick:()=>{it(!1),Ye(0)},children:"Dismiss"})]})]})})]})}function Go(s,n,t,i){const a=(i-90)*Math.PI/180;return{x:s+t*Math.cos(a),y:n+t*Math.sin(a)}}function Jo(s){return[20,1,18,4,13,6,10,15,2,17,3,19,7,16,8,11,14,9,12,5].indexOf(s)*18+9}function Su({width:s=320,height:n=320}){const t=Il(a=>a.samples),i=u.useRef(null);return u.useEffect(()=>{const a=i.current;if(!a)return;const r=a.getContext("2d");if(!r)return;a.width=s,a.height=n,r.clearRect(0,0,s,n);const l=s/2,o=n/2,d=Math.min(s,n)/(Ge.doubleOuter*2+20),c={bullInner:Ge.bullInner*d,bullOuter:Ge.bullOuter*d,trebleInner:Ge.trebleInner*d,trebleOuter:Ge.trebleOuter*d,doubleInner:Ge.doubleInner*d,doubleOuter:Ge.doubleOuter*d};r.strokeStyle="rgba(255,255,255,0.06)",r.lineWidth=1;const h=["doubleOuter","doubleInner","trebleOuter","trebleInner","bullOuter","bullInner"];for(const p of h)r.beginPath(),r.arc(l,o,c[p],0,Math.PI*2),r.stroke();const m=[];for(const p of t){let g=Math.random()*360,w=Math.random()*c.doubleOuter;typeof p.sector=="number"&&p.sector>=1&&p.sector<=20&&(g=Jo(p.sector),p.ring==="DOUBLE"?w=(c.doubleInner+c.doubleOuter)/2:p.ring==="TRIPLE"?w=(c.trebleInner+c.trebleOuter)/2:p.ring==="INNER_BULL"?w=c.bullInner*.5:p.ring==="BULL"?w=c.bullOuter*.8:w=(c.trebleOuter+c.doubleInner)/2*(.6+Math.random()*.4));const T=Go(l,o,w,g);m.push({x:T.x,y:T.y,w:1})}for(const p of m){const g=r.createRadialGradient(p.x,p.y,1,p.x,p.y,60);g.addColorStop(0,"rgba(255,0,0,0.9)"),g.addColorStop(.3,"rgba(255,100,0,0.5)"),g.addColorStop(1,"rgba(255,100,0,0)"),r.fillStyle=g,r.beginPath(),r.arc(p.x,p.y,60,0,Math.PI*2),r.fill()}r.fillStyle="rgba(255,255,255,0.85)",r.font="12px ui-sans-serif";const x={};for(const p of t)p.sector&&(x[p.sector]=(x[p.sector]||0)+1);for(const p of Object.keys(x)){const g=Number(p),w=Jo(g),T=Go(l,o,c.trebleOuter+18,w);r.fillText(String(x[g]),T.x-6,T.y+4)}},[t,s,n]),e.jsx("canvas",{ref:i,style:{width:"100%",height:"auto",borderRadius:8,background:"#081018"}})}const Ws=[...Array.from({length:20},(s,n)=>({label:`D${n+1}`,score:(n+1)*2})),{label:"DBULL",score:50,isBull:!0}];function ii(s,n){const t=Ws[n];return!!t&&s===t.score}function cn(s){const n=s.trim().toUpperCase();if(!n)return null;if(n==="50"||n==="BULL"||n==="DBULL"||n==="IBULL")return 50;if(n==="25"||n==="OBULL")return 25;const t=n.match(/^(S|D|T)?\s*(\d{1,2})$/);if(!t)return null;const i=t[1]||"S",a=parseInt(t[2],10);return a<1||a>20?null:a*(i==="S"?1:i==="D"?2:3)}const ss=[...Array.from({length:20},(s,n)=>n+1),25,50],Ma=[20,19,18,17,16,15,25];function Hn(){const s={};return Ma.forEach(n=>{s[n]=0}),{marks:s,points:0}}function Rl(s,n,t,i,a=()=>!1){let r=null,l=0;if(t==="BULL"||t==="INNER_BULL"||n===25||n===50)r=25,l=t==="INNER_BULL"||n===50?2:1;else if(typeof i=="number"&&i>=15&&i<=20)r=i,t==="TRIPLE"?l=3:t==="DOUBLE"?l=2:l=1;else if(n){const p=[20,19,18,17,16,15];for(const g of p){if(n===g){r=g,l=1;break}if(n===g*2){r=g,l=2;break}if(n===g*3){r=g,l=3;break}}!r&&(n===25||n===50)&&(r=25,l=n===50?2:1)}if(!r)return 0;const o=s.marks[r];let d=Math.max(0,3-o);const c=Math.min(d,l),h=Math.max(0,l-c),m=o+c;s.marks[r]=m>3?3:m;let x=0;return h>0&&!a(r)&&(r===25?t==="INNER_BULL"?x+=50*h:x+=25*h:x+=r*h),s.points+=x,x}function ku(s){return Ma.every(n=>(s.marks[n]||0)>=3)}function vn(){return{round:1,score:0,finished:!1,shanghaiAchieved:!1,turnHits:{singles:0,doubles:0,triples:0}}}function Cu(s){return s.round}function Pl(s,n,t,i){if(s.finished)return 0;const a=Cu(s);let r=0;return typeof i=="number"&&i===a?t==="TRIPLE"?(r=a*3,s.turnHits.triples++):t==="DOUBLE"?(r=a*2,s.turnHits.doubles++):t==="SINGLE"&&(r=a*1,s.turnHits.singles++):!i&&(n===a||n===a*2||n===a*3)&&(n===a*3?(r=a*3,s.turnHits.triples++):n===a*2?(r=a*2,s.turnHits.doubles++):n===a&&(r=a,s.turnHits.singles++)),s.score+=r,r}function Ll(s){if(!s.finished){if(s.turnHits.singles>0&&s.turnHits.doubles>0&&s.turnHits.triples>0){s.shanghaiAchieved=!0,s.finished=!0;return}const n=s.round+1;n>20?s.finished=!0:s.round=n}s.turnHits={singles:0,doubles:0,triples:0}}function jn(){return{stage:0,targets:[{kind:"NUMBER",num:20},{kind:"DOUBLE",num:16},{kind:"TRIPLE",num:14},{kind:"NUMBER",num:19},{kind:"BULL"},{kind:"ANY_NUMBER"}],score:0,finished:!1,hitThisRound:!1}}function Ga(s){return s.targets[s.stage]||null}function Ol(s,n,t,i){if(s.finished)return 0;const a=Ga(s);if(!a)return 0;let r=0;switch(a.kind){case"NUMBER":{typeof i=="number"&&i===a.num?t==="TRIPLE"?r=a.num*3:t==="DOUBLE"?r=a.num*2:t==="SINGLE"&&(r=a.num):!i&&(n===a.num||n===a.num*2||n===a.num*3)&&(r=n),r>0&&(s.hitThisRound=!0);break}case"DOUBLE":{(t==="DOUBLE"&&i===a.num||n===a.num*2)&&(r=a.num*2,s.hitThisRound=!0);break}case"TRIPLE":{(t==="TRIPLE"&&i===a.num||n===a.num*3)&&(r=a.num*3,s.hitThisRound=!0);break}case"BULL":{(t==="BULL"||t==="INNER_BULL"||n===25||n===50)&&(r=t==="INNER_BULL"||n===50?50:25,s.hitThisRound=!0);break}case"ANY_NUMBER":{n>0&&(r=n,s.hitThisRound=!0);break}}return s.score+=r,r}function Bl(s){s.finished||(s.hitThisRound||(s.score=Math.floor(s.score/2)),s.hitThisRound=!1,s.stage+=1,s.stage>=s.targets.length&&(s.finished=!0))}function Nn(){return{round:1,score:0,target:"HIGH",finished:!1}}function Ul(s,n,t,i){if(s.finished)return 0;let a=0;if(s.target==="HIGH")if(t==="INNER_BULL")a=50;else if(typeof i=="number"){const l=i*(t==="TRIPLE"?3:t==="DOUBLE"?2:1);i>=20&&(a=l)}else n>=40&&(a=n);else if(typeof i=="number"){const l=i*(t==="TRIPLE"?3:t==="DOUBLE"?2:1);i<=10&&(a=l)}else n>0&&n<=30&&(a=n);return s.score+=a,a}function $l(s){if(!s.finished){if(s.round+=1,s.round>10){s.finished=!0;return}s.target=s.target==="HIGH"?"LOW":"HIGH"}}function _l(s,n=3){return{number:s,lives:n,isKiller:!1,eliminated:!1}}function Tu(s){const n=Array.from({length:20},(i,a)=>a+1),t={};for(const i of s){const a=Math.floor(Math.random()*n.length),r=n.splice(a,1)[0];t[i]=r}return t}function oi(s,n,t,i){const a=n[s];if(!a||!i||!t)return{becameKiller:!1};if(!a.isKiller&&t==="DOUBLE"&&i===a.number)return a.isKiller=!0,{becameKiller:!0};if(a.isKiller&&(t==="DOUBLE"||t==="TRIPLE")){const r=Object.keys(n).find(l=>l!==s&&!n[l].eliminated&&n[l].number===i);if(r){const l=n[r],o=t==="TRIPLE"?2:1;return l.lives=Math.max(0,l.lives-o),l.lives===0&&(l.eliminated=!0),{becameKiller:!1,victimId:r,livesRemoved:o}}}return{becameKiller:!1}}function li(s){const n=Object.entries(s).filter(([,t])=>!t.eliminated&&t.lives>0);return n.length===1?n[0][0]:null}function ka(){return{inning:1,score:0,dartsThisInning:0,finished:!1}}function Fl(s,n,t,i){if(s.finished)return 0;let a=0;if(typeof i=="number"&&i===s.inning?t==="TRIPLE"?a=3:t==="DOUBLE"?a=2:a=1:!i&&(n===s.inning||n===s.inning*2||n===s.inning*3)&&(a=n===s.inning*3?3:n===s.inning*2?2:1),s.score+=a,s.dartsThisInning+=1,s.dartsThisInning>=3){const r=s.inning+1;r>9?s.finished=!0:(s.inning=r,s.dartsThisInning=0)}return a}const Hl={1:5,2:20,3:1,4:18,5:4,6:13,7:6,8:10,9:15,10:2,11:17,12:3,13:19,14:7,15:16,16:8,17:11,18:14};function Ca(){return{hole:1,strokes:0,dartsThisHole:0,finished:!1}}function Wl(s,n,t,i){if(s.finished)return!1;const a=Hl[s.hole];if(s.dartsThisHole+=1,typeof i=="number"&&i===a&&(t==="SINGLE"||t==="DOUBLE"||t==="TRIPLE")||!i&&(n===a||n===a*2||n===a*3)){s.strokes+=s.dartsThisHole;const l=s.hole+1;return l>18?s.finished=!0:(s.hole=l,s.dartsThisHole=0),!0}if(s.dartsThisHole>=3){s.strokes+=3;const l=s.hole+1;l>18?s.finished=!0:(s.hole=l,s.dartsThisHole=0)}return!1}const Ta={0:{type:"NUM",num:20},1:{type:"NUM",num:19},2:{type:"NUM",num:18},3:{type:"NUM",num:17},4:{type:"BULL"},5:{type:"NUM",num:16},6:{type:"NUM",num:15},7:{type:"NUM",num:14},8:{type:"NUM",num:13}};function ci(){return{board:Array(9).fill(null),turn:"X",finished:!1,winner:null}}function Du(s){const n=[[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];for(const[t,i,a]of n)if(s[t]&&s[t]===s[i]&&s[t]===s[a])return s[t];return s.every(t=>t)?"Draw":null}function zl(s,n,t,i,a){if(s.finished||s.board[n])return!1;const r=Ta[n];let l=!1;if(r.type==="BULL"?l=i==="BULL"||i==="INNER_BULL"||t===25||t===50:r.type==="NUM"&&typeof r.num=="number"&&(typeof a=="number"&&a===r.num||!a&&(t===r.num||t===r.num*2||t===r.num*3))&&(l=!0),!l)return!1;s.board[n]=s.turn;const o=Du(s.board);return o?(s.finished=!0,s.winner=o,!0):(s.turn=s.turn==="X"?"O":"X",!0)}const Ya=[20,19,18,17,16,15,14,13,12,25];function Da(){const s={};return Ya.forEach(n=>{s[n]=0}),{marks:s,points:0}}function ql(s,n,t,i,a=()=>!1){let r=null,l=0;if(t==="BULL"||t==="INNER_BULL"||n===25||n===50)r=25,l=t==="INNER_BULL"||n===50?2:1;else if(typeof i=="number"&&i>=12&&i<=20)r=i,t==="TRIPLE"?l=3:t==="DOUBLE"?l=2:l=1;else if(n){for(const p of[20,19,18,17,16,15,14,13,12]){if(n===p){r=p,l=1;break}if(n===p*2){r=p,l=2;break}if(n===p*3){r=p,l=3;break}}!r&&(n===25||n===50)&&(r=25,l=n===50?2:1)}if(!r)return 0;const o=s.marks[r],d=Math.max(0,3-o),c=Math.min(d,l),h=Math.max(0,l-c),m=o+c;s.marks[r]=m>3?3:m;let x=0;return h>0&&!a(r)&&(r===25?t==="INNER_BULL"?x+=50*h:x+=25*h:x+=r*h),s.points+=x,x}function Eu(s){return Ya.every(n=>(s.marks[n]||0)>=3)}function Vl({left:s,right:n,className:t="",sticky:i=!0}){return e.jsxs("div",{className:`${i?"sticky top-0":""} relative overflow-hidden flex items-center justify-between gap-2 mb-2 px-2 sm:px-3 py-2 rounded-xl bg-white/10 border border-white/10 z-10 backdrop-blur-sm ${t}`,children:[e.jsx("div",{className:"pointer-events-none absolute inset-0 bg-gradient-to-b from-slate-900/30 via-slate-900/10 to-transparent"}),e.jsx("div",{className:"flex items-center gap-2 text-xs sm:text-sm leading-none flex-wrap",children:s}),e.jsx("div",{className:"flex items-center gap-1 flex-wrap justify-end",children:n})]})}const Ko=["X01","Double Practice"],Mu=["Around the Clock","Cricket","Halve It","Shanghai","High-Low","Killer","Bob's 27","Count-Up","High Score","Low Score","Checkout 170","Checkout 121","Treble Practice"],Iu=["Easy","Medium","Hardened"];function ma(s,n,t){return Math.max(n,Math.min(t,s))}function Au(s,n){let t=0;if(n==="Easy"){const i=[22,26,41,45,60];t=i[Math.floor(Math.random()*i.length)]}else n==="Medium"?t=Math.round(ma(60+(Math.random()*30-15),30,100)):t=Math.round(ma(80+(Math.random()*20-10),50,120));return s<=0?0:t>s?[100,85,81,60,57,45,41,26,22,20,1].find(a=>a<=s)??0:t}function Ru({onClose:s}){return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50",children:e.jsxs("div",{className:"card max-w-lg w-full relative",children:[e.jsx("button",{className:"absolute top-2 right-2 btn px-2 py-1",onClick:s,children:"Close"}),e.jsx("h3",{className:"text-xl font-bold mb-2",children:"X01 Rules & Regulations"}),e.jsxs("ul",{className:"list-disc pl-5 text-left mb-2",children:[e.jsx("li",{children:"Double In: Start scoring only after hitting a double."}),e.jsx("li",{children:"Double Out: Finish the game by hitting a double to reach exactly zero."}),e.jsx("li",{children:"Best Of: Play a set number of legs, winner is first to reach majority."}),e.jsx("li",{children:"First To: Play until a player reaches a set number of legs."}),e.jsx("li",{children:"No Cheating: All scores must be valid, no manual score changes mid-leg."}),e.jsx("li",{children:"Competitive Standard: Follow latest WDF/PDC rules for match play."})]}),e.jsx("p",{className:"text-sm text-slate-600",children:"For full details, see official darts governing body rules."})]})})}const Pu="http://localhost:8787";function Lu({user:s}){const{offlineLayout:n}=Ft(),[t,i]=u.useState("X01"),[a,r]=u.useState(501),[l,o]=u.useState("None"),[d,c]=u.useState(!1),[h,m]=u.useState(!1),[x,p]=u.useState(a),[g,w]=u.useState(a),[T,S]=u.useState(!1),[E,I]=u.useState(!1),[M,P]=u.useState(1),[A,v]=u.useState(0),[b,H]=u.useState(0),[W,R]=u.useState(null),[F,D]=u.useState(1),[Q,me]=u.useState(1),[ue,ke]=u.useState([]),[_e,Pe]=u.useState(2e3),Le=zn(),[ve,Ee]=u.useState(!1),[$,te]=u.useState(n==="modern"),[oe,He]=u.useState(n==="modern");u.useEffect(()=>{te(n==="modern"),He(n==="modern")},[n]);const[We,we]=u.useState(1),[Ie,lt]=u.useState(!0),[pe,he]=u.useState(0),[Oe,xt]=u.useState(0),[Rt,hs]=u.useState(0),[jt,Ne]=u.useState(0),[Ht,ie]=u.useState(0),[fe,se]=u.useState(Hn()),[Z,$e]=u.useState(vn()),[ye,Se]=u.useState(jn()),[Qe,Ke]=u.useState(Nn()),[mt,Be]=u.useState(0),[ht,Ye]=u.useState(1),[Nt,it]=u.useState(27),[yt,C]=u.useState(0),[ne,Ae]=u.useState(0),[Ce,ze]=u.useState(!1),[pt,ns]=u.useState(1),[Bt,Dt]=u.useState(0),[as,Et]=u.useState(0),qs=8,[vs,fs]=u.useState(1),[Kt,xs]=u.useState(0),[z,be]=u.useState(0),wt=10,[Ut,ps]=u.useState(1),[Us,ls]=u.useState(0),[$s,js]=u.useState(0),gs=10,[As,ys]=u.useState(170),[rs,Ns]=u.useState(0),[Rs,Vt]=u.useState(0),[ks,Zt]=u.useState(0),[Ps,Cs]=u.useState(121),[U,K]=u.useState(0),[ee,G]=u.useState(0),[N,L]=u.useState(0),[_,Y]=u.useState(20),[ae,ce]=u.useState(0),[xe,je]=u.useState(0),[Te,Mt]=u.useState(30),[st,ft]=u.useState(!1),[ct,bt]=u.useState(ka()),[is,cs]=u.useState(Ca()),[Wt,ds]=u.useState(ci()),[us,Ks]=u.useState(Da()),[St,Ot]=u.useState([{id:"p1",name:"Player 1"},{id:"p2",name:"Player 2"}]),[Ze,dt]=u.useState({}),[ut,Yt]=u.useState({}),[$t,Tt]=u.useState(!1),[bs,gt]=u.useState(0),[Ys,Gt]=u.useState(0),[Ts,ws]=u.useState(null),[Ds,Es]=u.useState(""),[Xe,ot]=u.useState(0),[nt,_t]=u.useState(0),[Je,kt]=u.useState(0),[vt,zt]=u.useState(a),[es,Xt]=u.useState(0),[sn,_s]=u.useState(0),[nn,Jt]=u.useState(0);u.useRef(null);const[Jn,qe]=u.useState(0),[Kn,Yn]=u.useState(0),[an,Ls]=u.useState(0),[Sn,Xs]=u.useState(0),[Xn,Os]=u.useState(0),[Ms,kn]=u.useState(0),[Cn,Qn]=u.useState(0),[Zn,dn]=u.useState(0),[Tn,Qs]=u.useState(0),[Dn,En]=u.useState(0),[ea,ta]=u.useState(0),[sa,na]=u.useState(0),[pa,un]=u.useState(0),[Qa,et]=u.useState(0),[yi,rn]=u.useState(0),[aa,mn]=u.useState(0),[vi,Mn]=u.useState(0),[Za,ra]=u.useState(0),[Aa,ia]=u.useState(0),[er,ba]=u.useState(0),[It,In]=u.useState(!1),[os,ts]=u.useState(""),[oa,An]=u.useState(""),{favoriteDouble:Ra,callerEnabled:hn,callerVoice:fn,callerVolume:Rn,speakCheckoutOnly:Vs,rememberLastOffline:Pn,setLastOffline:Ln,autoStartOffline:xn,cameraScale:Fs,setCameraScale:On,cameraAspect:ga="wide",setCameraAspect:Pa,cameraFitMode:la="fill",setCameraFitMode:La,cameraEnabled:qt,textSize:ya,boxSize:Oa,autoscoreProvider:tr,matchType:f="singles",setMatchType:j,teamAName:k="Team A",setTeamAName:O,teamBName:X="Team B",setTeamBName:le}=Ft(),de=tr==="manual",Ue=(y=>{switch(y){case"small":return"px-1.5 py-0.5 text-xs";case"large":return"px-3 py-1 text-sm";default:return"px-2 py-0.5 text-sm"}})(ya),Lt=u.useRef(null),Qt=u.useRef(null),Ss=u.useRef(null),[Re,Bn]=u.useState("first"),[on,ms]=u.useState(1),ca=u.useRef(null);u.useEffect(()=>{const y=Math.max(1,Math.floor(Number(on)||1)),B=Re==="first"?y:Math.max(1,Math.ceil(y/2));P(B)},[Re,on]),u.useEffect(()=>{if(!oe){we(1);return}const y=()=>{const J=Lt.current,re=Qt.current;if(!J||!re)return;const Fe=Ss.current?Ss.current.getBoundingClientRect().height:0,tt=Math.max(0,J.clientHeight-Fe-6),De=Math.max(0,J.clientWidth-8),ge=re.getBoundingClientRect(),Me=We||1,Ve=ge.height/Me,at=ge.width/Me,Hs=tt>0?tt/Ve:1,$n=De>0?De/at:1,Gs=Math.min(1,Math.max(.5,Math.min(Hs,$n)));we(Gs)};y();const B=window.ResizeObserver,V=B?new B(()=>y()):null;return V&&Lt.current&&V.observe(Lt.current),V&&Qt.current&&V.observe(Qt.current),window.addEventListener("resize",y),()=>{window.removeEventListener("resize",y);try{V&&Lt.current&&V.unobserve(Lt.current)}catch{}try{V&&Qt.current&&V.unobserve(Qt.current)}catch{}}},[oe,We]),u.useEffect(()=>{const y=B=>{const V=B?.detail?.mode;V&&(i(V),Zs())};return window.addEventListener("ndn:auto-start",y),()=>window.removeEventListener("ndn:auto-start",y)},[]),u.useEffect(()=>{const y=B=>{const V=B?.detail?.formatType,J=B?.detail?.formatCount,re=B?.detail?.startScore;(V==="first"||V==="best")&&Bn(V),typeof J=="number"&&isFinite(J)&&ms(Math.max(1,Math.floor(J))),typeof re=="number"&&isFinite(re)&&r(Math.max(1,Math.floor(re)))};return window.addEventListener("ndn:offline-format",y),()=>window.removeEventListener("ndn:offline-format",y)},[]),u.useEffect(()=>{if(!xn)return;const y=setTimeout(()=>Zs(),50);return()=>clearTimeout(y)},[xn]),u.useEffect(()=>{if(!ve||Ie||l==="None"||nn<=0)return;let y,B=performance.now();const V=J=>{const re=J-B;B=J,Jt(Fe=>{const tt=Fe-re;if(tt<=0){let De=0,ge=g;for(;De<3&&ge>0;){const Me=Au(ge,l),Ve=ma(Me-De*20,0,Math.min(60,ge)),at=ge-Ve;if(Yn(Ve),qe(Gs=>Gs+1),En(Gs=>Gs+1),at<0){ge=g,Ls(0),Xs(0);break}Ls(Gs=>Gs+Ve),na(Gs=>Gs+Ve);const Hs=ge,$n=at;if(Hs>50&&$n<=50?Xs(1):Hs<=50&&Xs(Gs=>Gs+1),ge=at,De+=1,ge===0)break}if(w(ge),ge===0){an===180?mn(Ve=>Ve+1):an>=140?Mn(Ve=>Ve+1):an>=100&&ra(Ve=>Ve+1);const Me=g;Me<=170&&ba(Ve=>Math.max(Ve,Me)),g<=50&&(Qn(Ve=>Ve+(Sn>0?Sn:1)),dn(Ve=>Ve+1)),Ls(0),Xs(0),R("ai"),I(!0)}return ge>0&&De>=3&&(an===180?mn(Me=>Me+1):an>=140?Mn(Me=>Me+1):an>=100&&ra(Me=>Me+1),Ls(0),Xs(0)),lt(!0),0}return tt}),nn>0&&(y=requestAnimationFrame(V))};return y=requestAnimationFrame(V),()=>cancelAnimationFrame(y)},[ve,Ie,l,nn,g]);function Zs(){m(!0),p(a),w(a),S(!1),Ee(!0),lt(!0),he(0),ot(0),_t(0),kt(0),zt(a),Xt(0),_s(0),Jt(0),qe(0),Yn(0),Ls(0),R(null),v(0),H(0),ke([]),ce(0),je(0),ft(!1),Qs(0),En(0),ta(0),na(0),un(0),et(0),rn(0),mn(0),Mn(0),ra(0),ia(0),ba(0),Os(0),kn(0),Qn(0),dn(0);const y=Math.max(1,Math.floor(Number(on)||1));if(P(Re==="first"?y:Math.max(1,Math.ceil(y/2))),Pn)try{Ln({mode:t,x01Start:a,firstTo:M,aiLevel:l})}catch{}}function sr(){p(a),w(a),S(!1),Ee(!0),lt(!0),he(0),ot(0),_t(0),kt(0),zt(a),Xt(0),_s(0),Jt(0),qe(0),Yn(0),Ls(0),R(null)}function da(y){kt(0),zt(y===0?a:x),_s(0),l!=="None"?(lt(!1),Jt(_e)):lt(!1)}function Un(y){const B=x-y,V=Je+1;if(_t(y),ot(De=>De+1),Qs(De=>De+1),B<0){try{const ge=x,Me=vt;Is.getState().recordVisit("offline-x01",V,0,{preRemaining:ge,postRemaining:Me,bust:!0,finish:!1})}catch{}if(p(vt),x<=50){const ge=(sn||0)+1;Os(Me=>Me+ge)}if(hn)try{yn(s?.username||"Player",0,Math.max(vt,0),fn,{volume:Rn,checkoutOnly:Vs})}catch{}da(vt),he(0),Xt(0),_s(0);return}p(B),kt(V),Xt(De=>De+y),ta(De=>De+y),he(0);const J=x,re=B,Fe=J>50&&re<=50,tt=J<=50;if(Fe?_s(1):tt&&_s(De=>De+1),B===0){try{const ge=es+y,Me=x;Is.getState().recordVisit("offline-x01",V,ge,{preRemaining:Me,postRemaining:0,finish:!0,bust:!1})}catch{}es+y===180?un(ge=>ge+1):es+y>=140?et(ge=>ge+1):es+y>=100&&rn(ge=>ge+1);const De=vt;if(De<=170&&ia(ge=>Math.max(ge,De)),J<=50){const ge=(sn||0)+1;Os(Me=>Me+ge),kn(Me=>Me+1)}if(hn){const ge=es+y;try{yn(s?.username||"Player",ge,0,fn,{volume:Rn,checkoutOnly:Vs})}catch{}}R("player"),I(!0);return}if(V>=3){try{const De=es+y,ge=x,Me=B;Is.getState().recordVisit("offline-x01",V,De,{preRemaining:ge,postRemaining:Me,finish:!1,bust:!1})}catch{}if(es+y===180?un(De=>De+1):es+y>=140?et(De=>De+1):es+y>=100&&rn(De=>De+1),J<=50){const De=(sn||0)+1;Os(ge=>ge+De)}if(hn){const De=es+y;try{yn(s?.username||"Player",De,Math.max(B,0),fn,{volume:Rn,checkoutOnly:Vs})}catch{}}da(B),Xt(0),_s(0)}}function ji(){const y=ma(Math.round(Number(pe)||0),0,60);Un(y)}const[Ni,Ba]=u.useState("");function wi(){const y=Math.round(Number(Ni)||0),B=ma(y,0,180);if(B===0&&y!==0){alert("Enter a number 0â€“180 for visit total");return}const V=x-B;if(ot(J=>J+3),Qs(J=>J+3),kt(3),Xt(B),B===180?un(J=>J+1):B>=140?et(J=>J+1):B>=100&&rn(J=>J+1),V<0){if(hn)try{yn(s?.username||"Player",0,Math.max(vt,0),fn,{volume:Rn,checkoutOnly:Vs})}catch{}try{const J=x,re=vt;Is.getState().recordVisit("offline-x01",3,0,{preRemaining:J,postRemaining:re,bust:!0,finish:!1})}catch{}p(vt),da(vt),Xt(0),kt(0),_s(0),Ba("");return}if(p(V),hn)try{yn(s?.username||"Player",B,Math.max(V,0),fn,{volume:Rn,checkoutOnly:Vs})}catch{}if(vt<=50&&(Os(J=>J+3),V===0&&kn(J=>J+1)),V===0){const J=vt;J<=170&&ia(re=>Math.max(re,J));try{const re=x;Is.getState().recordVisit("offline-x01",3,B,{preRemaining:re,postRemaining:0,finish:!0,bust:!1})}catch{}R("player"),I(!0),Ba("");return}try{const J=x,re=V;Is.getState().recordVisit("offline-x01",3,B,{preRemaining:J,postRemaining:re,finish:!1,bust:!1})}catch{}da(V),Xt(0),kt(0),_s(0),Ba("")}function Si(y){const B=ma(Math.round(y||0),0,60);if(_t(B),ot(V=>V+1),Qs(V=>V+1),ii(B,Oe)){const V=Rt+1;hs(V),xt(J=>Math.min(20,J+1)),V>=21&&(R("player"),I(!0))}he(0)}function ki(){Si(Number(pe))}function Ci(){const y=cn(os);if(y==null){alert("Enter like D16, 50, 25, T20");return}Si(y),ts("")}function Ti(y,B,V){if(Ce)return;const J=ht,re=B==="DOUBLE"&&V===J||!B&&y===J*2;re&&Ae(Fe=>Fe+1),C(Fe=>{const tt=Fe+1;if(tt>=3){const De=ne+(re?1:0);De>0?it(Me=>Me+De*J*2):it(Me=>Me-J*2);const ge=J+1;return Ye(ge),Ae(0),ge>20&&ze(!0),0}return tt})}function Di(){Ti(Math.max(0,pe|0)),he(0)}function Ei(){Ye(1),it(27),C(0),Ae(0),ze(!1)}function nr(y){Dt(B=>B+Math.max(0,y|0)),Et(B=>{const V=B+1;return V>=3?(ns(J=>J+1),0):V})}function ar(y){xs(B=>B+Math.max(0,y|0)),be(B=>{const V=B+1;return V>=3?(fs(J=>J+1),0):V})}function rr(y){ls(B=>B+Math.max(0,y|0)),js(B=>{const V=B+1;return V>=3?(ps(J=>J+1),0):V})}function Mi(y,B,V,J,re,Fe,tt,De){const ge=y-tt;if(!(ge<0))if(ge===0){if(De==="DOUBLE"||De==="INNER_BULL"){Fe(Me=>Me+1),re(Me=>Me+1),J(()=>0),B(y);return}}else B(ge);J(Me=>{const Ve=Me+1;return Ve>=3?(re(at=>at+1),0):Ve})}function Ii(y,B){Mi(As,ys,rs,Ns,Vt,Zt,y,B),rs+1>=3&&ys(170)}function Ai(y,B){Mi(Ps,Cs,U,K,G,L,y,B),U+1>=3&&Cs(121)}function Ua(y){const B=cn(os);if(B==null){alert("Enter like T20, D16, 25, 50");return}const V=os.trim().toUpperCase(),J=V.startsWith("D")||V==="50"||V==="BULL"||V==="DBULL"||V==="IBULL"||V.includes("INNER");y?Ii(B,J?"DOUBLE":void 0):Ai(B,J?"DOUBLE":void 0),ts("")}function sc(){ys(170),Ns(0),Vt(0),Zt(0)}function nc(){Cs(121),K(0),G(0),L(0)}function ir(y,B,V){if(st)return;(B==="TRIPLE"&&V===_||!B&&y===_*3)&&ce(re=>re+1),je(re=>{const Fe=re+1;if(Fe%3===0&&[20,19,18].includes(_)){const tt=[20,19,18],De=tt.indexOf(_),ge=tt[(De+1)%tt.length];Y(ge)}return Te>0&&Fe>=Te&&ft(!0),Fe})}function Ri(){ce(0),je(0),ft(!1)}function ac(y,B,V){bt(J=>{const re={...J};return Fl(re,y,B,V),re})}function rc(){bt(ka())}function ic(y,B,V){cs(J=>{const re={...J};return Wl(re,y,B,V),re})}function oc(){cs(Ca())}function lc(y,B,V,J){ds(re=>{const Fe={...re,board:[...re.board]};return zl(Fe,y,B,V,J),Fe})}function cc(){ds(ci())}function dc(y,B,V){Ks(J=>{const re={...J,marks:{...J.marks}};return ql(re,y,B,V,()=>!1),re})}function Pi(){Ks(Da())}function or(y,B,V){const J=ss[jt];let re=!1;if(typeof V=="number"&&V===J&&(B==="SINGLE"||B==="DOUBLE"||B==="TRIPLE")&&(re=!0),J===25&&(B==="BULL"||y===25)&&(re=!0),J===50&&(B==="INNER_BULL"||y===50)&&(re=!0),re||(y===J||y===J*2||y===J*3)&&(re=!0),re){const Fe=Ht+1;ie(Fe),Ne(tt=>tt+1)}}function Li(){or(Math.max(0,pe|0)),he(0)}function Oi(){const y=cn(os);if(y==null){alert("Enter like T20, D5, 25, 50");return}or(y),ts("")}function Bi(y,B,V){se(J=>{const re={...J,marks:{...J.marks}};return Rl(re,y,B,V,()=>!1),re}),Be(J=>{const re=J+1;return re>=3?0:re})}function Ui(){Bi(Math.max(0,pe|0)),he(0)}function $i(y,B,V){$e(J=>{const re={...J,turnHits:{...J.turnHits}};return Pl(re,y,B,V),re}),Be(J=>{const re=J+1;return re>=3?($e(Fe=>{const tt={...Fe,turnHits:{...Fe.turnHits}};return Ll(tt),tt}),0):re})}function _i(){$i(Math.max(0,pe|0)),he(0)}function Fi(y,B,V){Se(J=>{const re={...J,targets:[...J.targets]};return Ol(re,y,B,V),re}),Be(J=>{const re=J+1;return re>=3?(Se(Fe=>{const tt={...Fe,targets:[...Fe.targets]};return Bl(tt),tt}),0):re})}function Hi(){Fi(Math.max(0,pe|0)),he(0)}function Wi(y,B,V){Ke(J=>{const re={...J};return Ul(re,y,B,V),re}),Be(J=>{const re=J+1;return re>=3?(Ke(Fe=>{const tt={...Fe};return $l(tt),tt}),0):re})}function zi(){Wi(Math.max(0,pe|0)),he(0)}function qi(){const y=os.trim().toUpperCase();if(!y)return null;if(y==="50"||y==="BULL"||y==="DBULL"||y==="IBULL")return 50;if(y==="25"||y==="OBULL")return 25;const B=y.match(/^(S|D|T)?\s*(\d{1,2})$/);if(!B)return null;const V=B[1]||"S",J=parseInt(B[2],10);return J<1||J>20?null:J*(V==="S"?1:V==="D"?2:3)}function lr(){const y=qi();if(y==null){alert("Enter like T20, D16, 5, 25, 50");return}Un(y),ts("")}function uc(){const y=oa.trim().split(`
`).map(B=>B.trim()).filter(B=>B);if(y.length!==0){for(const B of y){const V=cn(B);if(V==null){alert(`Invalid score: ${B}`);return}Un(V)}An("")}}function mc(){Je!==0&&(p(y=>y+nt),kt(y=>Math.max(0,y-1)))}function Vi(){const y=qi();if(y==null){alert("Enter like T20, D16, 5, 25, 50");return}if(Je===0){lr();return}const B=nt;p(V=>V+B),kt(V=>Math.max(0,V-1)),setTimeout(()=>Un(y),0),ts("")}function hc(){const y=W??"player",B=y==="player"?sn||void 0:Sn||void 0,V=1,J=y==="player"?Xe:Jn;ke([...ue,{winner:y,doubleDarts:F,checkoutDarts:Q,winnerDarts:J,doublesAtt:B,doublesHit:V}]),I(!1);let re=A,Fe=b;if(W==="player"?re+=1:W==="ai"&&(Fe+=1),v(re),H(Fe),R(null),re>=M||Fe>=M){try{nd(t,y==="player")}catch{}Ee(!1),m(!1),p(a),w(a),In(!0);return}sr()}const cr=!Ko.includes(t)&&!(s?.fullAccess||s?.admin);return e.jsxs("div",{className:"card ndn-game-shell relative overflow-hidden",children:[e.jsxs("h2",{className:"text-2xl font-bold text-brand-700 mb-4",children:["Offline Game Modes ",n==="classic"?e.jsx("span",{className:"ml-2 text-xs px-2 py-0.5 rounded-full bg-white/10 border border-white/10 align-middle",children:"Classic layout"}):e.jsx("span",{className:"ml-2 text-xs px-2 py-0.5 rounded-full bg-emerald-500/20 border border-emerald-400/30 text-emerald-200 align-middle",children:"Modern layout"})]}),e.jsxs("div",{className:"ndn-shell-body",children:[e.jsxs("div",{className:"mb-4 flex flex-col gap-3",children:[e.jsx("label",{className:"font-semibold",children:"Select game mode:"}),e.jsxs("select",{className:"input w-full",value:t,onChange:y=>i(y.target.value),children:[Ko.map(y=>e.jsx("option",{value:y,children:y},y)),Mu.map(y=>e.jsxs("option",{value:y,disabled:!(s?.fullAccess||s?.admin),children:[y," ",s?.fullAccess||s?.admin?"":"(Premium)"]},y))]}),t==="Treble Practice"&&e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-2 items-end",children:[e.jsxs("div",{className:"sm:col-span-1",children:[e.jsx("label",{className:"font-semibold",children:"Throws per game"}),e.jsx("input",{className:"input w-full",type:"number",min:3,step:3,value:Te,onChange:y=>Mt(Math.max(3,Math.floor(Number(y.target.value)||30)))})]}),e.jsx("div",{className:"sm:col-span-2 text-xs text-slate-300",children:"Target cycles T20â†’T19â†’T18 every 3 darts. Game ends after the selected number of throws."})]}),!s?.fullAccess&&e.jsxs("div",{className:"mt-2 p-2 rounded-lg bg-slate-800/40 border border-slate-700/40 text-slate-200 text-sm flex items-center gap-2",children:[e.jsx("span",{children:"ðŸ”’"}),e.jsx("span",{children:"Only X01 and Double Practice are free. Advanced modes (Killer, Cricket, Shanghai, etc.) require PREMIUM."})]}),t==="X01"&&e.jsxs(e.Fragment,{children:[e.jsx("label",{className:"font-semibold mt-2",children:"Enter starting score (1-1001):"}),e.jsx("input",{className:"input w-full",type:"number",min:1,max:1001,value:a,onChange:y=>r(Number(y.target.value))}),e.jsx("label",{className:"font-semibold mt-2",children:"Play against AI bot?"}),e.jsxs("select",{className:"input w-full",value:l,onChange:y=>o(y.target.value),children:[e.jsx("option",{value:"None",children:"None"}),Iu.map(y=>e.jsx("option",{value:y,children:y},y))]}),l!=="None"&&e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-2 items-end mt-2",children:[e.jsxs("div",{className:"sm:col-span-2",children:[e.jsx("label",{className:"font-semibold",children:"AI throw delay (seconds)"}),e.jsx("input",{className:"input w-full",type:"number",min:.5,max:10,step:.5,value:_e/1e3,onChange:y=>Pe(Math.round(Number(y.target.value)*1e3))})]}),e.jsx("div",{className:"text-sm text-slate-300",children:"Controls how long the AI waits before its visit."})]}),e.jsx("button",{className:"btn mt-2",onClick:()=>c(!0),children:"X01 Rules & Regulations!"})]}),t==="Double Practice"&&e.jsx("div",{className:"mt-2 text-brand-600",children:"Hit doubles D1 â†’ D20 â†’ DBULL in as few darts as possible. AI and X01 settings donâ€™t apply."})]}),!h&&e.jsx("button",{className:"btn",disabled:cr,title:cr?"PREMIUM required for this mode":"",onClick:Zs,children:"Start Match"}),ve&&e.jsx("div",{className:`absolute inset-0 z-[1000] ${$?"":"flex items-center justify-center p-3 sm:p-4"}`,children:e.jsx(zs,{storageKey:"ndn:modal:offline-match",className:`${$?"w-full h-full ndn-modal-tight":""} relative flex flex-col overflow-hidden`,fullScreen:$,defaultWidth:1100,defaultHeight:720,minWidth:720,minHeight:480,maxWidth:1600,maxHeight:1200,initialFitHeight:!0,children:e.jsxs("div",{className:"flex-1 min-h-0 overflow-x-hidden pr-1 pt-2 pb-2",style:{overflowY:oe?"hidden":"auto"},ref:y=>{Lt.current=y},children:[e.jsx("div",{ref:y=>{Ss.current=y},children:e.jsx(Vl,{left:e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"hidden xs:inline px-2 py-0.5 rounded-full bg-indigo-500/20 text-indigo-200 border border-indigo-400/30 text-[10px] sm:text-xs",children:"Game Mode"}),e.jsxs("span",{className:"font-medium whitespace-nowrap",children:[t,t==="X01"?` / ${a}`:""]}),e.jsxs("span",{className:"opacity-80 whitespace-nowrap",children:["First to ",M," Â· Legs ",A,"-",b]}),e.jsx("span",{className:`ml-2 px-2 py-0.5 rounded-full border text-[10px] sm:text-xs ${n==="modern"?"bg-emerald-500/15 text-emerald-200 border-emerald-400/30":"bg-white/10 text-white/70 border-white/20"}`,children:n==="modern"?"Modern layout":"Classic layout"})]}),right:e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"hidden items-center gap-2 mr-2 text-xs",children:[e.jsx("span",{className:"opacity-80",children:"Cam"}),e.jsx("button",{className:"btn btn--ghost px-2 py-1",onClick:()=>On(Math.max(.5,Math.round((Fs-.05)*100)/100)),title:"Decrease camera size",children:"âˆ’"}),e.jsxs("span",{className:"w-9 text-center",children:[Math.round(Fs*100),"%"]}),e.jsx("button",{className:"btn btn--ghost px-2 py-1",onClick:()=>On(Math.min(1.25,Math.round((Fs+.05)*100)/100)),title:"Increase camera size",children:"+"})]}),e.jsx("button",{className:"btn btn--ghost px-3 py-1 text-sm",title:oe?"Actual Size":"Fit All",onClick:()=>He(y=>!y),children:oe?"Actual Size":"Fit All"}),e.jsx("button",{className:"btn btn--ghost px-3 py-1 text-sm",title:$?"Restore":"Maximize",onClick:()=>te(y=>!y),children:$?"Restore":"Maximize"}),e.jsx("button",{className:"btn bg-slate-700 hover:bg-slate-800 px-3 py-1 text-sm",onClick:()=>{Zs()},children:"Restart"}),e.jsx("button",{className:"btn bg-rose-600 hover:bg-rose-700 px-3 py-1 text-sm",onClick:()=>{Ee(!1),m(!1)},children:"Quit"})]})})}),e.jsxs("div",{ref:y=>{Qt.current=y},className:"will-change-transform",style:oe?{transform:`scale(${We})`,transformOrigin:"top left",width:"100%",fontSize:`${Math.max(.8,Math.min(1,We))}em`}:void 0,children:[e.jsx("h3",{className:"text-xl font-bold mb-2 mt-1 leading-tight",children:t==="X01"?"X01 Match":t}),e.jsxs("div",{className:"flex items-center gap-2 mb-2 text-xs flex-wrap",children:[e.jsxs("span",{className:"px-2 py-0.5 rounded-full bg-white/10 border border-white/10",children:["Mode: ",t]}),e.jsxs("span",{className:"px-2 py-0.5 rounded-full bg-white/10 border border-white/10",children:["Start: ",a]}),e.jsxs("div",{ref:ca,className:"inline-flex items-center gap-2 px-2 py-0.5 rounded-full bg-white/10 border border-white/10",children:[e.jsx("span",{children:"Format:"}),(()=>{const y=x!==a||g!==a||Je>0,B=`px-2 py-0.5 rounded border text-xs ${y?"opacity-50 cursor-not-allowed":"cursor-pointer"} `;return e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{type:"button",className:`${B} ${Re==="first"?"bg-indigo-500/20 text-indigo-100 border-indigo-400/30":"bg-white/10 text-white/80 border-white/20"}`,onClick:()=>{y||Bn("first")},title:"First to N",children:"First to"}),e.jsx("button",{type:"button",className:`${B} ${Re==="best"?"bg-indigo-500/20 text-indigo-100 border-indigo-400/30":"bg-white/10 text-white/80 border-white/20"}`,onClick:()=>{y||Bn("best")},title:"Best of N (wins = ceil(N/2)",children:"Best of"})]}),e.jsx("input",{className:`input w-16 text-center ${y?"opacity-50":""}`,type:"number",min:1,step:1,value:on,onChange:V=>ms(Math.max(1,Math.floor(Number(V.target.value)||1))),disabled:y,title:Re==="first"?"First to N":"Best of N (wins = ceil(N/2))"})]})})()]}),e.jsxs("span",{className:"px-2 py-0.5 rounded-full bg-white/10 border border-white/10",children:["Legs: ",A,"â€“",b]}),e.jsxs("div",{className:"ml-auto flex items-center gap-1 text-[10px] flex-wrap",children:[e.jsx("span",{className:"opacity-70",children:"Match"}),e.jsxs("select",{className:`btn ${Ue}`,value:f,onChange:y=>j(y.target.value),children:[e.jsx("option",{value:"singles",children:"Singles"}),e.jsx("option",{value:"doubles",children:"Doubles"})]}),e.jsx("input",{className:`input ${Ue} w-[7.5rem]`,value:k,onChange:y=>O(y.target.value),placeholder:"Team A"}),e.jsx("span",{className:"opacity-50",children:"vs"}),e.jsx("input",{className:`input ${Ue} w-[7.5rem]`,value:X,onChange:y=>le(y.target.value),placeholder:"Team B"})]})]}),t!=="X01"?e.jsxs("div",{className:"p-3 rounded-2xl glass text-white border border-white/10 min-w-0 flex flex-col h-full mb-2",children:[t==="Double Practice"&&e.jsx(e.Fragment,{children:e.jsxs("div",{className:"text-xs text-slate-600 flex items-center justify-between",children:[e.jsx("span",{className:"opacity-80",children:"Current Target"}),e.jsx("span",{className:"px-2 py-0.5 rounded-full bg-emerald-500/20 text-emerald-200 text-xs font-bold",children:Ws[Oe]?.label||"â€”"})]})}),t==="Around the Clock"&&e.jsx(e.Fragment,{children:e.jsxs("div",{className:"text-xs text-slate-600 flex items-center justify-between",children:[e.jsx("span",{className:"opacity-80",children:"Current Target"}),e.jsx("span",{className:"px-2 py-0.5 rounded-full bg-emerald-500/20 text-emerald-200 text-xs font-bold",children:ss[jt]===25?"25 (Outer Bull)":ss[jt]===50?"50 (Inner Bull)":ss[jt]||"â€”"})]})}),t==="Cricket"&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"text-xs text-slate-600 mb-1",children:"Cricket â€” Close 20â€“15 and Bull; overflow scores points"}),e.jsx("div",{className:"grid grid-cols-7 gap-1 text-center text-[11px] mb-2",children:Ma.map(y=>e.jsxs("div",{className:"p-1 rounded bg-slate-800/50 border border-slate-700/50",children:[e.jsx("div",{className:"opacity-70",children:y===25?"Bull":y}),e.jsxs("div",{className:"font-semibold",children:[Math.min(3,fe.marks?.[y]||0)," / 3"]})]},y))}),e.jsxs("div",{className:"text-sm",children:["Points: ",e.jsx("span",{className:"font-semibold",children:fe.points})]}),ku(fe)&&e.jsxs("div",{className:"mt-2 text-xs px-2 py-1 rounded bg-emerald-500/20 text-emerald-200 border border-emerald-400/30 inline-block",children:["Completed! ",e.jsx("button",{className:"ml-2 underline",onClick:()=>{se(Hn()),Be(0)},children:"Reset"})]})]}),t==="Shanghai"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"text-xs text-slate-600 flex items-center justify-between",children:[e.jsx("span",{children:"Round"}),e.jsx("span",{className:"px-2 py-0.5 rounded-full bg-emerald-500/20 text-emerald-200 border border-emerald-400/30 text-xs font-semibold",children:Z.round})]}),e.jsxs("div",{className:"text-3xl font-extrabold tracking-tight",children:["Score: ",Z.score]}),Z.finished&&e.jsxs("div",{className:"mt-2 text-xs px-2 py-1 rounded bg-emerald-500/20 text-emerald-200 border border-emerald-400/30 inline-block",children:["Completed! ",e.jsx("button",{className:"ml-2 underline",onClick:()=>{$e(vn()),Be(0)},children:"Reset"})]})]}),t==="Halve It"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"text-xs text-slate-600 flex items-center justify-between",children:[e.jsx("span",{children:"Stage"}),e.jsxs("span",{className:"px-2 py-0.5 rounded-full bg-emerald-500/20 text-emerald-200 border border-emerald-400/30 text-xs font-semibold",children:[ye.stage+1,"/",ye.targets.length]})]}),e.jsxs("div",{className:"text-sm",children:["Target: ",e.jsx("span",{className:"font-semibold",children:(()=>{const y=Ga(ye);return y?y.kind==="ANY_NUMBER"?"Any":y.kind==="BULL"?"Bull":y.kind==="DOUBLE"||y.kind==="TRIPLE"||y.kind==="NUMBER"?`${y.kind} ${y.num}`:"â€”":"â€”"})()})]}),e.jsxs("div",{className:"text-3xl font-extrabold tracking-tight",children:["Score: ",ye.score]}),ye.finished&&e.jsxs("div",{className:"mt-2 text-xs px-2 py-1 rounded bg-emerald-500/20 text-emerald-200 border border-emerald-400/30 inline-block",children:["Completed! ",e.jsx("button",{className:"ml-2 underline",onClick:()=>{Se(jn()),Be(0)},children:"Reset"})]})]}),t==="High-Low"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"text-xs text-slate-600",children:["Round ",Qe.round," Â· Target ",Qe.target]}),e.jsxs("div",{className:"text-3xl font-extrabold tracking-tight",children:["Score: ",Qe.score]}),Qe.finished&&e.jsxs("div",{className:"mt-2 text-xs px-2 py-1 rounded bg-emerald-500/20 text-emerald-200 border border-emerald-400/30 inline-block",children:["Completed! ",e.jsx("button",{className:"ml-2 underline",onClick:()=>{Ke(Nn()),Be(0)},children:"Reset"})]})]}),t==="Bob's 27"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"text-xs text-slate-600 flex items-center justify-between",children:[e.jsx("span",{children:"Target"}),e.jsxs("span",{className:"px-2 py-0.5 rounded-full bg-emerald-500/20 text-emerald-200 text-xs font-semibold",children:["D",ht]})]}),e.jsxs("div",{className:"text-3xl font-extrabold tracking-tight",children:["Score: ",Nt]}),Ce&&e.jsxs("div",{className:"mt-2 text-xs px-2 py-1 rounded bg-emerald-500/20 text-emerald-200 border border-emerald-400/30 inline-block",children:["Completed! ",e.jsx("button",{className:"ml-2 underline",onClick:Ei,children:"Reset"})]})]}),t==="Count-Up"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"text-xs text-slate-600",children:["Round ",pt,"/8"]}),e.jsxs("div",{className:"text-3xl font-extrabold tracking-tight",children:["Score: ",Bt]})]}),t==="High Score"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"text-xs text-slate-600",children:["Round ",vs,"/10"]}),e.jsxs("div",{className:"text-3xl font-extrabold tracking-tight",children:["Score: ",Kt]})]}),t==="Low Score"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"text-xs text-slate-600",children:["Round ",Ut,"/10"]}),e.jsxs("div",{className:"text-3xl font-extrabold tracking-tight",children:["Score: ",Us]})]}),t==="Checkout 170"&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"text-xs text-slate-600",children:"Remaining"}),e.jsx("div",{className:"text-3xl font-extrabold tracking-tight",children:As}),e.jsxs("div",{className:"text-xs text-slate-400 mt-1",children:["Attempts: ",Rs," Â· Successes: ",ks]})]}),t==="Checkout 121"&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"text-xs text-slate-600",children:"Remaining"}),e.jsx("div",{className:"text-3xl font-extrabold tracking-tight",children:Ps}),e.jsxs("div",{className:"text-xs text-slate-400 mt-1",children:["Attempts: ",ee," Â· Successes: ",N]})]}),t==="Treble Practice"&&e.jsx(e.Fragment,{children:e.jsxs("div",{className:"flex items-center justify-between gap-4",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"text-xs text-slate-600",children:["Treble Target: T",_]}),e.jsxs("div",{className:"text-3xl font-extrabold tracking-tight",children:["Hits: ",ae]})]}),e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx("label",{className:"text-sm",children:"Target"}),e.jsx("div",{className:"inline-flex items-center gap-1",children:[20,19,18].map(y=>e.jsxs("button",{className:`btn px-2 py-0.5 text-xs ${_===y?"bg-emerald-600/30 border border-emerald-400/30":""}`,onClick:()=>Y(y),children:["T",y]},`tpick-header-${y}`))}),e.jsx("span",{className:"opacity-60 text-xs",children:"or"}),e.jsx("select",{className:"input w-24",value:_,onChange:y=>Y(parseInt(y.target.value,10)),children:Array.from({length:20},(y,B)=>B+1).map(y=>e.jsx("option",{value:y,children:y},y))}),e.jsx("button",{className:"btn px-3 py-1 text-sm",onClick:Ri,children:"Reset"})]})]})}),t==="Baseball"&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"text-xs text-slate-600",children:"Inning"}),e.jsx("div",{className:"text-3xl font-extrabold tracking-tight",children:ct.inning}),e.jsxs("div",{className:"text-sm",children:["Score: ",e.jsx("span",{className:"font-semibold",children:ct.score})]})]}),t==="Golf"&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"text-xs text-slate-600",children:"Hole"}),e.jsx("div",{className:"text-3xl font-extrabold tracking-tight",children:is.hole}),e.jsxs("div",{className:"text-sm",children:["Strokes: ",e.jsx("span",{className:"font-semibold",children:is.strokes})]})]}),t==="Tic Tac Toe"&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"text-xs text-slate-600",children:"Turn"}),e.jsx("div",{className:"text-3xl font-extrabold tracking-tight",children:Wt.turn}),Wt.finished&&e.jsxs("div",{className:"mt-1 text-xs",children:["Winner: ",Wt.winner||"â€”"]})]}),t==="American Cricket"&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"text-xs text-slate-600 mb-1",children:"Close 20â€“12 and Bull; overflow scores points"}),e.jsx("div",{className:"grid grid-cols-10 gap-1 text-center text-[11px] mb-2",children:Ya.map(y=>e.jsxs("div",{className:"p-1 rounded bg-slate-800/50 border border-slate-700/50",children:[e.jsx("div",{className:"opacity-70",children:y===25?"Bull":y}),e.jsxs("div",{className:"font-semibold",children:[Math.min(3,us.marks?.[y]||0)," / 3"]})]},y))}),e.jsxs("div",{className:"text-sm",children:["Points: ",e.jsx("span",{className:"font-semibold",children:us.points})]}),Eu(us)&&e.jsxs("div",{className:"mt-2 text-xs px-2 py-1 rounded bg-emerald-500/20 text-emerald-200 border border-emerald-400/30 inline-block",children:["Completed! ",e.jsx("button",{className:"ml-2 underline",onClick:Pi,children:"Reset"})]})]}),t==="Killer"&&e.jsx(e.Fragment,{children:$t?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"text-xs text-slate-600 flex items-center justify-between",children:[e.jsx("span",{children:"Turn"}),e.jsx("span",{className:"px-2 py-0.5 rounded-full bg-emerald-500/20 text-emerald-200 text-xs font-bold",children:St[bs]?.name||"â€”"})]}),e.jsx("div",{className:"text-3xl font-extrabold tracking-tight",children:Ts?`${St.find(y=>y.id===Ts)?.name||"Winner"} Wins`:Ds||"Ready"})]}):e.jsx("div",{className:"text-xs text-slate-600",children:"Setup players and assign numbers"})})]}):n==="modern"?e.jsx("div",{className:"grid grid-cols-1 gap-2 mb-2 items-stretch",children:e.jsx("div",{className:"min-w-0 space-y-2 flex flex-col justify-between",children:de?e.jsxs("div",{className:"card",children:[e.jsx("div",{className:"text-sm font-semibold mb-1",children:"Manual scoring active"}),e.jsx("div",{className:"text-xs opacity-70",children:"Camera previews are disabled. Use the manual entry controls below to record your turn."})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"flex items-center flex-wrap gap-1.5 mt-1",children:e.jsxs("div",{className:"ml-auto flex items-center gap-1 text-[10px]",children:[e.jsx("span",{className:"opacity-70",children:"Cam"}),e.jsx("button",{className:`btn ${Ue}`,onClick:()=>On(Math.max(.5,Math.round((Fs-.05)*100)/100)),children:"âˆ’"}),e.jsxs("span",{className:`btn ${Ue} min-w-[2.5rem] text-center`,children:[Math.round(Fs*100),"%"]}),e.jsx("button",{className:`btn ${Ue}`,onClick:()=>On(Math.min(1.25,Math.round((Fs+.05)*100)/100)),children:"+"}),e.jsx("span",{className:"opacity-50",children:"|"}),e.jsx("button",{className:`btn ${Ue}`,title:"Toggle fit/fill",onClick:()=>La(la==="fill"?"fit":"fill"),children:la==="fill"?"Fill":"Fit"}),e.jsx("span",{className:"opacity-50",children:"|"}),e.jsx("button",{className:`btn ${Ue}`,title:"Toggle camera aspect",onClick:()=>Pa(ga==="square"?"wide":"square"),children:ga==="square"?"Square":"Wide"})]})}),e.jsxs("div",{className:"flex items-stretch justify-end min-w-0 flex-1 min-h-0 ndn-camera-tall",children:[t==="Double Practice"&&e.jsxs("div",{className:"w-full text-center mb-3",children:[e.jsx("div",{className:"text-xs text-slate-600",children:"Current Target"}),e.jsxs("div",{className:"text-3xl font-extrabold tracking-tight",children:[Rt," / 21"]})]}),t==="Around the Clock"&&e.jsxs("div",{className:"w-full text-center mb-3",children:[e.jsx("div",{className:"text-xs text-slate-600",children:"Current Target"}),e.jsxs("div",{className:"text-3xl font-extrabold tracking-tight",children:[Ht," / ",ss.length]})]}),e.jsx(fa,{storageKey:"ndn:camera:tile:offline:primary",className:"relative rounded-2xl overflow-hidden bg-black",defaultWidth:720,defaultHeight:420,minWidth:320,minHeight:220,maxWidth:1600,maxHeight:900,autoFill:!0,children:e.jsx(Va,{label:"Your Board",autoStart:!0,className:"min-w-0 h-full",aspect:"classic"})})]})]})})}):e.jsx("div",{className:"grid grid-cols-1 md:[grid-template-columns:1fr_1.2fr_1fr] gap-2 mb-2 items-stretch min-w-0",children:e.jsxs("div",{className:"flex items-stretch justify-center md:px-3 min-w-0",children:[e.jsxs("div",{className:"p-3 rounded-2xl glass text-white border border-white/10 min-w-0 flex flex-col h-full",children:[e.jsxs("div",{className:"text-xs text-slate-600 flex items-center justify-between",children:[e.jsx("span",{className:"opacity-80",children:"You Remain"}),Ie?e.jsx("span",{className:"px-2 py-0.5 rounded-full bg-emerald-500/20 text-emerald-200 text-xs font-bold",children:"THROWING"}):e.jsx("span",{className:"px-2 py-0.5 rounded-full bg-slate-500/20 text-slate-200 text-xs font-bold",children:"WAITING TO THROW"})]}),e.jsx("div",{className:"text-3xl font-extrabold tracking-tight",children:x}),e.jsx("div",{className:"h-1.5 w-full bg-white/10 rounded-full mt-2 overflow-hidden",children:e.jsx("div",{className:"h-full bg-emerald-400/70",style:{width:`${Math.max(0,Math.min(100,(1-x/a)*100))}%`}})}),e.jsxs("div",{className:"text-sm mt-1 opacity-90",children:["Last dart: ",e.jsx("span",{className:"font-semibold",children:nt})]}),e.jsxs("div",{className:"text-sm opacity-90",children:["3-Dart Avg: ",e.jsx("span",{className:"font-semibold",children:Tn>0?(ea/Tn*3).toFixed(1):"0.0"})]}),e.jsxs("div",{className:"text-xs opacity-70 flex items-center gap-2",children:[e.jsxs("span",{children:["Darts thrown: ",Xe]}),e.jsx("span",{className:"inline-flex items-center gap-1","aria-label":"Visit darts",children:[0,1,2].map(y=>e.jsx("span",{className:`w-2 h-2 rounded-full ${y<Je?"bg-emerald-400":"bg-white/20"}`},y))})]}),e.jsxs("div",{className:"text-xs opacity-80 mt-1",children:["Doubles: ",e.jsxs("span",{className:"font-semibold",children:["Att ",Xn," Â· Hit ",Ms]})]}),x<=170&&x>0&&(()=>{const B=ri(x,Ra)[0]||"â€”";return e.jsxs("div",{className:"mt-2 inline-flex items-center gap-2 px-3 py-1 rounded-full bg-white/10 border border-white/10 text-white text-sm",children:[e.jsx("span",{className:"opacity-70",children:"Checkout"}),e.jsx("span",{className:"font-semibold",children:B})]})})()]}),e.jsx("div",{className:"flex items-stretch justify-end md:px-3 min-w-0 flex-1 min-h-0 ndn-camera-tall",children:e.jsx(fa,{storageKey:"ndn:camera:tile:offline:center",className:"relative rounded-2xl overflow-hidden bg-black",defaultWidth:720,defaultHeight:420,minWidth:320,minHeight:220,maxWidth:1600,maxHeight:900,autoFill:!0,children:e.jsx(Va,{label:"Your Board",autoStart:!0,className:"min-w-0 h-full",aspect:"classic",fill:!0})})}),e.jsxs("div",{className:`mt-2 ${Oa==="small"?"p-2":Oa==="large"?"p-4":"p-3"} rounded-2xl bg-slate-900/40 border border-white/10 text-white ${ya==="small"?"text-xs":ya==="large"?"text-base":"text-sm"}`,children:[e.jsx("div",{className:"font-semibold mb-2",children:"Match Summary"}),(()=>{const y=Ie?s?.username||"You":l==="None"?"â€”":`${l} AI`,B=Ie?x:l==="None"?0:g,V=Ie?nt:Kn,J=Ie?es:an,re=Ie?Xe:Jn,Fe=a-(Ie?x:l==="None"?a:g),tt=re>0?Fe/re*3:0,De=`${A}-${b}`,ge=ue.length>0?`${Math.min(...ue.map(Me=>Me.doubleDarts+(Me.checkoutDarts||0)))||0} darts`:"â€”";return e.jsxs("div",{className:"grid grid-cols-2 gap-y-1",children:[e.jsx("div",{className:"opacity-80",children:"Current score"}),e.jsx("div",{className:"font-mono text-right",children:De}),e.jsx("div",{className:"opacity-80",children:"Current thrower"}),e.jsx("div",{className:"text-right font-semibold text-lg",children:y}),e.jsx("div",{className:"opacity-80",children:"Score remaining"}),e.jsx("div",{className:"text-right font-mono font-bold text-xl",children:B}),e.jsx("div",{className:"opacity-80",children:"3-dart avg"}),e.jsx("div",{className:"text-right font-mono",children:tt.toFixed(1)}),e.jsx("div",{className:"opacity-80",children:"Last score"}),e.jsx("div",{className:"text-right font-mono",children:J||V}),e.jsx("div",{className:"opacity-80",children:"Best leg"}),e.jsx("div",{className:"text-right",children:ge})]})})()]}),e.jsxs("div",{className:"p-3 rounded-2xl glass text-white border border-white/10 min-w-0 flex flex-col h-full",children:[e.jsxs("div",{className:"text-xs flex items-center justify-between opacity-80",children:[e.jsxs("span",{children:[l==="None"?"Opponent":`${l} AI`," Remain"]}),Ie?e.jsx("span",{className:"px-2 py-0.5 rounded-full bg-slate-500/20 text-slate-200 text-xs font-bold",children:"WAITING TO THROW"}):e.jsx("span",{className:"px-2 py-0.5 rounded-full bg-emerald-500/20 text-emerald-200 text-xs font-bold",children:"THROWING"})]}),e.jsx("div",{className:"text-3xl font-extrabold tracking-tight",children:l!=="None"?g:"N/A"}),l!=="None"&&e.jsx("div",{className:"h-1.5 w-full bg-white/10 rounded-full mt-2 overflow-hidden",children:e.jsx("div",{className:"h-full bg-fuchsia-400/70",style:{width:`${Math.max(0,Math.min(100,(1-g/a)*100))}%`}})}),e.jsxs("div",{className:"text-sm mt-1 opacity-90",children:["Last dart: ",e.jsx("span",{className:"font-semibold",children:l==="None"?0:Kn})]}),e.jsxs("div",{className:"text-sm opacity-90",children:["3-Dart Avg: ",e.jsx("span",{className:"font-semibold",children:l!=="None"?Dn>0?(sa/Dn*3).toFixed(1):"0.0":"â€”"})]}),l!=="None"&&e.jsxs("div",{className:"text-xs opacity-70",children:["Darts thrown: ",Jn]}),l!=="None"&&e.jsxs("div",{className:"text-xs opacity-80 mt-1",children:["Doubles: ",e.jsxs("span",{className:"font-semibold",children:["Att ",Cn," Â· Hit ",Zn]})]})]})]})}),t!=="X01"?e.jsxs("div",{className:"space-y-2",children:[t==="Double Practice"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"font-semibold",children:["Target: ",e.jsx("span",{className:"px-2 py-0.5 rounded-full bg-white/10 border border-white/10",children:Ws[Oe]?.label||"â€”"})]}),qt&&e.jsx("div",{className:"rounded-2xl overflow-hidden bg-black",children:e.jsx(rt,{scoringMode:"custom",showToolbar:!1,onAutoDart:(y,B)=>{if((B==="DOUBLE"||B==="INNER_BULL")&&ii(y,Oe)){const J=Rt+1,re=Oe+1;hs(J),xt(re),J>=Ws.length&&setTimeout(()=>{hs(0),xt(0)},250)}},immediateAutoCommit:!0})}),e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{className:"input w-24",type:"number",min:0,max:60,value:pe,onChange:y=>he(Number(y.target.value||0)),onKeyDown:y=>{y.key==="Enter"&&ki()}}),e.jsx("button",{className:"btn px-3 py-1 text-sm",onClick:ki,children:"Add Dart"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{className:"input w-44",placeholder:"Manual (D16, 50, 25, T20)",value:os,onChange:y=>ts(y.target.value),onKeyDown:y=>{y.key==="Enter"&&Ci()}}),e.jsx("button",{className:"btn px-3 py-1 text-sm",onClick:Ci,children:"Add"})]})]}),e.jsxs("div",{className:"text-xs text-slate-300",children:["Progress: ",Rt," of 21"]})]}),t==="Around the Clock"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"font-semibold",children:["Target: ",e.jsx("span",{className:"px-2 py-0.5 rounded-full bg-white/10 border border-white/10",children:ss[jt]===25?"25 (Outer Bull)":ss[jt]===50?"50 (Inner Bull)":ss[jt]||"â€”"})]}),qt&&e.jsx("div",{className:"rounded-2xl overflow-hidden bg-black",children:e.jsx(rt,{scoringMode:"custom",showToolbar:!1,immediateAutoCommit:!0,onAutoDart:(y,B,V)=>{or(y,B==="MISS"?void 0:B,V?.sector??null)}})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{className:"input w-24",type:"number",min:0,value:pe,onChange:y=>he(Number(y.target.value||0)),onKeyDown:y=>{y.key==="Enter"&&Li()}}),e.jsx("button",{className:"btn px-3 py-1 text-sm",onClick:Li,children:"Add Dart"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{className:"input w-44",placeholder:"Manual (T20, D5, 25, 50)",value:os,onChange:y=>ts(y.target.value),onKeyDown:y=>{y.key==="Enter"&&Oi()}}),e.jsx("button",{className:"btn px-3 py-1 text-sm",onClick:Oi,children:"Add"})]}),Ht>=ss.length&&e.jsxs("div",{className:"mt-2 text-xs px-2 py-1 rounded bg-emerald-500/20 text-emerald-200 border border-emerald-400/30 inline-block",children:["Completed! ",e.jsx("button",{className:"ml-2 underline",onClick:()=>{ie(0),Ne(0)},children:"Reset"})]})]}),t==="Cricket"&&e.jsxs(e.Fragment,{children:[qt&&e.jsx("div",{className:"rounded-2xl overflow-hidden bg-black",children:e.jsx(rt,{scoringMode:"custom",showToolbar:!1,immediateAutoCommit:!0,onAutoDart:(y,B,V)=>{Bi(y,B==="MISS"?void 0:B,V?.sector??null)}})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{className:"input w-24",type:"number",min:0,value:pe,onChange:y=>he(Number(y.target.value||0)),onKeyDown:y=>{y.key==="Enter"&&Ui()}}),e.jsx("button",{className:"btn px-3 py-1 text-sm",onClick:Ui,children:"Add Dart"}),e.jsx("button",{className:"btn bg-slate-700 hover:bg-slate-800 px-3 py-1 text-sm",onClick:()=>{se(Hn()),Be(0)},children:"Reset"})]})]}),t==="Shanghai"&&e.jsxs(e.Fragment,{children:[qt&&e.jsx("div",{className:"rounded-2xl overflow-hidden bg-black",children:e.jsx(rt,{scoringMode:"custom",showToolbar:!1,immediateAutoCommit:!0,onAutoDart:(y,B,V)=>{$i(y,B==="MISS"?void 0:B,V?.sector??null)}})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{className:"input w-24",type:"number",min:0,value:pe,onChange:y=>he(Number(y.target.value||0)),onKeyDown:y=>{y.key==="Enter"&&_i()}}),e.jsx("button",{className:"btn px-3 py-1 text-sm",onClick:_i,children:"Add Dart"}),e.jsx("button",{className:"btn bg-slate-700 hover:bg-slate-800 px-3 py-1 text-sm",onClick:()=>{$e(vn()),Be(0)},children:"Reset"})]})]}),t==="Halve It"&&e.jsxs(e.Fragment,{children:[qt&&e.jsx("div",{className:"rounded-2xl overflow-hidden bg-black",children:e.jsx(rt,{scoringMode:"custom",showToolbar:!1,immediateAutoCommit:!0,onAutoDart:(y,B,V)=>{Fi(y,B==="MISS"?void 0:B,V?.sector??null)}})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{className:"input w-24",type:"number",min:0,value:pe,onChange:y=>he(Number(y.target.value||0)),onKeyDown:y=>{y.key==="Enter"&&Hi()}}),e.jsx("button",{className:"btn px-3 py-1 text-sm",onClick:Hi,children:"Add Dart"}),e.jsx("button",{className:"btn bg-slate-700 hover:bg-slate-800 px-3 py-1 text-sm",onClick:()=>{Se(jn()),Be(0)},children:"Reset"})]})]}),t==="High-Low"&&e.jsxs(e.Fragment,{children:[qt&&e.jsx("div",{className:"rounded-2xl overflow-hidden bg-black",children:e.jsx(rt,{scoringMode:"custom",showToolbar:!1,immediateAutoCommit:!0,onAutoDart:(y,B,V)=>{Wi(y,B==="MISS"?void 0:B,V?.sector??null)}})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{className:"input w-24",type:"number",min:0,value:pe,onChange:y=>he(Number(y.target.value||0)),onKeyDown:y=>{y.key==="Enter"&&zi()}}),e.jsx("button",{className:"btn px-3 py-1 text-sm",onClick:zi,children:"Add Dart"}),e.jsx("button",{className:"btn bg-slate-700 hover:bg-slate-800 px-3 py-1 text-sm",onClick:()=>{Ke(Nn()),Be(0)},children:"Reset"})]})]}),t==="Bob's 27"&&e.jsxs(e.Fragment,{children:[qt&&e.jsx("div",{className:"rounded-2xl overflow-hidden bg-black",children:e.jsx(rt,{scoringMode:"custom",showToolbar:!1,immediateAutoCommit:!0,onAutoDart:(y,B,V)=>{Ti(y,B==="MISS"?void 0:B,V?.sector??null)}})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{className:"input w-24",type:"number",min:0,value:pe,onChange:y=>he(Number(y.target.value||0)),onKeyDown:y=>{y.key==="Enter"&&Di()}}),e.jsx("button",{className:"btn px-3 py-1 text-sm",onClick:Di,children:"Add Dart"}),e.jsx("button",{className:"btn bg-slate-700 hover:bg-slate-800 px-3 py-1 text-sm",onClick:Ei,children:"Reset"})]})]}),t==="Count-Up"&&e.jsxs(e.Fragment,{children:[qt&&e.jsx("div",{className:"rounded-2xl overflow-hidden bg-black",children:e.jsx(rt,{scoringMode:"custom",showToolbar:!1,immediateAutoCommit:!0,onAutoDart:y=>nr(y)})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{className:"input w-24",type:"number",min:0,value:pe,onChange:y=>he(Number(y.target.value||0)),onKeyDown:y=>{y.key==="Enter"&&(nr(pe),he(0))}}),e.jsx("button",{className:"btn px-3 py-1 text-sm",onClick:()=>{nr(pe),he(0)},children:"Add Dart"}),e.jsx("button",{className:"btn bg-slate-700 hover:bg-slate-800 px-3 py-1 text-sm",onClick:()=>{ns(1),Dt(0),Et(0)},children:"Reset"})]}),e.jsxs("div",{className:"text-xs text-slate-400",children:["Round ",pt,"/",qs]})]}),t==="High Score"&&e.jsxs(e.Fragment,{children:[qt&&e.jsx("div",{className:"rounded-2xl overflow-hidden bg-black",children:e.jsx(rt,{scoringMode:"custom",showToolbar:!1,immediateAutoCommit:!0,onAutoDart:y=>ar(y)})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{className:"input w-24",type:"number",min:0,value:pe,onChange:y=>he(Number(y.target.value||0)),onKeyDown:y=>{y.key==="Enter"&&(ar(pe),he(0))}}),e.jsx("button",{className:"btn px-3 py-1 text-sm",onClick:()=>{ar(pe),he(0)},children:"Add Dart"}),e.jsx("button",{className:"btn bg-slate-700 hover:bg-slate-800 px-3 py-1 text-sm",onClick:()=>{fs(1),xs(0),be(0)},children:"Reset"})]}),e.jsxs("div",{className:"text-xs text-slate-400",children:["Round ",vs,"/",wt]})]}),t==="Low Score"&&e.jsxs(e.Fragment,{children:[qt&&e.jsx("div",{className:"rounded-2xl overflow-hidden bg-black",children:e.jsx(rt,{scoringMode:"custom",showToolbar:!1,immediateAutoCommit:!0,onAutoDart:y=>rr(y)})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{className:"input w-24",type:"number",min:0,value:pe,onChange:y=>he(Number(y.target.value||0)),onKeyDown:y=>{y.key==="Enter"&&(rr(pe),he(0))}}),e.jsx("button",{className:"btn px-3 py-1 text-sm",onClick:()=>{rr(pe),he(0)},children:"Add Dart"}),e.jsx("button",{className:"btn bg-slate-700 hover:bg-slate-800 px-3 py-1 text-sm",onClick:()=>{ps(1),ls(0),js(0)},children:"Reset"})]}),e.jsxs("div",{className:"text-xs text-slate-400",children:["Round ",Ut,"/",gs]})]}),t==="Checkout 170"&&e.jsxs(e.Fragment,{children:[qt&&e.jsx("div",{className:"rounded-2xl overflow-hidden bg-black",children:e.jsx(rt,{scoringMode:"custom",showToolbar:!1,immediateAutoCommit:!0,onAutoDart:(y,B)=>Ii(y,B==="MISS"?void 0:B)})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{className:"input w-24",type:"text",placeholder:"Manual (D16, T20)",value:os,onChange:y=>ts(y.target.value),onKeyDown:y=>{y.key==="Enter"&&Ua(!0)}}),e.jsx("button",{className:"btn px-3 py-1 text-sm",onClick:()=>Ua(!0),children:"Add Dart"}),e.jsx("button",{className:"btn bg-slate-700 hover:bg-slate-800 px-3 py-1 text-sm",onClick:sc,children:"Reset"})]}),e.jsxs("div",{className:"text-xs text-slate-400",children:["Remaining: ",As," Â· Attempts: ",Rs," Â· Successes: ",ks]})]}),t==="Checkout 121"&&e.jsxs(e.Fragment,{children:[qt&&e.jsx("div",{className:"rounded-2xl overflow-hidden bg-black",children:e.jsx(rt,{scoringMode:"custom",showToolbar:!1,immediateAutoCommit:!0,onAutoDart:(y,B)=>Ai(y,B==="MISS"?void 0:B)})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{className:"input w-24",type:"text",placeholder:"Manual (D16, T20)",value:os,onChange:y=>ts(y.target.value),onKeyDown:y=>{y.key==="Enter"&&Ua(!1)}}),e.jsx("button",{className:"btn px-3 py-1 text-sm",onClick:()=>Ua(!1),children:"Add Dart"}),e.jsx("button",{className:"btn bg-slate-700 hover:bg-slate-800 px-3 py-1 text-sm",onClick:nc,children:"Reset"})]}),e.jsxs("div",{className:"text-xs text-slate-400",children:["Remaining: ",Ps," Â· Attempts: ",ee," Â· Successes: ",N]})]}),t==="Treble Practice"&&e.jsxs(e.Fragment,{children:[qt&&e.jsx("div",{className:"rounded-2xl overflow-hidden bg-black",children:e.jsx(rt,{scoringMode:"custom",showToolbar:!1,immediateAutoCommit:!0,onAutoDart:(y,B,V)=>{ir(y,B==="MISS"?void 0:B,V?.sector??null)}})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{className:"input w-24",type:"text",placeholder:"Manual (T20)",value:os,onChange:y=>ts(y.target.value),onKeyDown:y=>{if(y.key==="Enter"){const B=cn(os);B!=null&&ir(B,void 0,void 0),ts("")}}}),e.jsx("button",{className:"btn px-3 py-1 text-sm",onClick:()=>{const y=cn(os);y!=null&&ir(y,void 0,void 0),ts("")},children:"Add Dart"})]}),e.jsxs("div",{className:"text-xs text-slate-400",children:["Hits: ",ae," Â· Misses: ",Math.max(0,xe-ae)," Â· Darts: ",xe,Te>0?`/${Te}`:""]}),st&&e.jsxs("div",{className:"mt-2 text-xs px-2 py-1 rounded bg-emerald-500/20 text-emerald-200 border border-emerald-400/30 inline-block",children:["Completed! ",e.jsx("button",{className:"ml-2 underline",onClick:Ri,children:"Reset"})]})]}),t==="Baseball"&&e.jsxs(e.Fragment,{children:[qt&&e.jsx("div",{className:"rounded-2xl overflow-hidden bg-black",children:e.jsx(rt,{scoringMode:"custom",showToolbar:!1,immediateAutoCommit:!0,onAutoDart:(y,B,V)=>{ac(y,B==="MISS"?void 0:B,V?.sector??null)}})}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("button",{className:"btn bg-slate-700 hover:bg-slate-800 px-3 py-1 text-sm",onClick:rc,children:"Reset"})})]}),t==="Golf"&&e.jsxs(e.Fragment,{children:[qt&&e.jsx("div",{className:"rounded-2xl overflow-hidden bg-black",children:e.jsx(rt,{scoringMode:"custom",showToolbar:!1,immediateAutoCommit:!0,onAutoDart:(y,B,V)=>{ic(y,B==="MISS"?void 0:B,V?.sector??null)}})}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("button",{className:"btn bg-slate-700 hover:bg-slate-800 px-3 py-1 text-sm",onClick:oc,children:"Reset"})})]}),t==="Tic Tac Toe"&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"grid grid-cols-3 gap-1 mb-2",children:Array.from({length:9},(y,B)=>B).map(y=>e.jsx("button",{className:`h-16 rounded-xl border ${Wt.board[y]?"bg-emerald-500/20 border-emerald-400/30":"bg-slate-800/50 border-slate-700/50"}`,onClick:()=>{if(Wt.finished||Wt.board[y])return;const B=Number(prompt("Enter dart score for this cell (e.g., 20, 40, 60; 25 or 50 for center)")||0),V=B%3===0?"TRIPLE":B%2===0?"DOUBLE":"SINGLE",J=y,re=Ta[J],Fe=re.type==="BULL"?null:re.num||null;lc(J,B,V,Fe)},children:Wt.board[y]||""},y))}),qt&&e.jsx("div",{className:"rounded-2xl overflow-hidden bg-black",children:e.jsx(rt,{scoringMode:"custom",showToolbar:!1,immediateAutoCommit:!0,onAutoDart:(y,B,V)=>{}})}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("button",{className:"btn bg-slate-700 hover:bg-slate-800 px-3 py-1 text-sm",onClick:cc,children:"Reset"})})]}),t==="American Cricket"&&e.jsxs(e.Fragment,{children:[qt&&e.jsx("div",{className:"rounded-2xl overflow-hidden bg-black",children:e.jsx(rt,{scoringMode:"custom",showToolbar:!1,immediateAutoCommit:!0,onAutoDart:(y,B,V)=>{dc(y,B==="MISS"?void 0:B,V?.sector??null)}})}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("button",{className:"btn bg-slate-700 hover:bg-slate-800 px-3 py-1 text-sm",onClick:Pi,children:"Reset"})})]}),t==="Killer"&&e.jsx(e.Fragment,{children:$t?e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-2",children:St.map(y=>{const B=Ze[y.id],V=ut[y.id];return e.jsxs("div",{className:`p-2 rounded-xl border ${B?.eliminated?"opacity-50 border-red-500/40 bg-red-500/10":"border-slate-700/50 bg-slate-800/50"}`,children:[e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsx("div",{className:"font-semibold",children:y.name}),e.jsx("div",{className:`text-[10px] px-1.5 py-0.5 rounded ${B?.isKiller?"bg-purple-500/20 text-purple-200 border border-purple-400/30":"bg-slate-600/30 text-slate-300"}`,children:B?.isKiller?"Killer":"Not Killer"})]}),e.jsxs("div",{className:"mt-1 text-sm",children:["Number: ",e.jsx("span",{className:"font-semibold",children:V})]}),e.jsxs("div",{className:"text-sm",children:["Lives: ",e.jsx("span",{className:"font-semibold",children:B?.lives??0})]})]},y.id)})}),qt&&e.jsx("div",{className:"rounded-2xl overflow-hidden bg-black",children:e.jsx(rt,{scoringMode:"custom",showToolbar:!1,immediateAutoCommit:!0,onAutoDart:(y,B,V)=>{if(Ts)return;const J=B==="MISS"?void 0:B,re=V?.sector??null,Fe=St[bs];Fe&&(dt(tt=>{const De={};Object.keys(tt).forEach(Ve=>De[Ve]={...tt[Ve]});const ge=oi(Fe.id,De,J,re);if(ge.becameKiller)Es(`${Fe.name} became a Killer`);else if(ge.victimId){const Ve=St.find(at=>at.id===ge.victimId);Es(`${Fe.name} hit ${Ve?.name}'s ${ut[ge.victimId]} (${ge.livesRemoved} life${(ge.livesRemoved||0)>1?"s":""})`)}else Es("No effect");const Me=li(De);return Me&&ws(Me),De}),Gt(tt=>{const De=tt+1;if(De>=3){let ge=bs;for(let Me=1;Me<=St.length;Me++){const Ve=(bs+Me)%St.length,at=St[Ve].id,Hs=Ze[at];if(Hs&&!Hs.eliminated&&Hs.lives>0){ge=Ve;break}}return gt(ge),0}return De}))}})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{className:"input w-40",placeholder:"Manual (D16, T5)",value:os,onChange:y=>ts(y.target.value),onKeyDown:y=>{if(y.key==="Enter"){if(Ts)return;const V=os.trim().toUpperCase().match(/^(S|D|T)?\s*(\d{1,2})$/);if(!V){ts("");return}const J=V[1]||"S",re=parseInt(V[2],10),Fe=J==="D"?"DOUBLE":J==="T"?"TRIPLE":"SINGLE",tt=St[bs];dt(De=>{const ge={};Object.keys(De).forEach(at=>ge[at]={...De[at]});const Me=oi(tt.id,ge,Fe,re);if(Me.becameKiller)Es(`${tt.name} became a Killer`);else if(Me.victimId){const at=St.find(Hs=>Hs.id===Me.victimId);Es(`${tt.name} hit ${at?.name}'s ${ut[Me.victimId]} (${Me.livesRemoved} life${(Me.livesRemoved||0)>1?"s":""})`)}else Es("No effect");const Ve=li(ge);return Ve&&ws(Ve),ge}),ts(""),Gt(De=>{const ge=De+1;if(ge>=3){let Me=bs;for(let Ve=1;Ve<=St.length;Ve++){const at=(bs+Ve)%St.length,Hs=St[at].id,$n=Ze[Hs];if($n&&!$n.eliminated&&$n.lives>0){Me=at;break}}return gt(Me),0}return ge})}}}),e.jsx("button",{className:"btn px-3 py-1 text-sm",onClick:()=>{let y=bs;for(let B=1;B<=St.length;B++){const V=(bs+B)%St.length,J=St[V].id,re=Ze[J];if(re&&!re.eliminated&&re.lives>0){y=V;break}}gt(y),Gt(0)},children:"Next Player"}),e.jsx("button",{className:"btn bg-slate-700 hover:bg-slate-800 px-3 py-1 text-sm",onClick:()=>{dt({}),Yt({}),Tt(!1),gt(0),Gt(0),ws(null),Es("")},children:"Reset"})]}),Ts&&e.jsxs("div",{className:"mt-2 text-xs px-2 py-1 rounded bg-emerald-500/20 text-emerald-200 border border-emerald-400/30 inline-block",children:["Winner: ",St.find(y=>y.id===Ts)?.name," ",e.jsx("button",{className:"ml-2 underline",onClick:()=>{dt({}),Yt({}),Tt(!1),gt(0),Gt(0),ws(null),Es("")},children:"Play Again"})]})]}):e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"font-semibold",children:"Players"}),e.jsx("div",{className:"space-y-1",children:St.map((y,B)=>e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{className:"input",value:y.name,onChange:V=>{const J=V.target.value;Ot(re=>re.map((Fe,tt)=>tt===B?{...Fe,name:J}:Fe))}}),e.jsx("button",{className:"btn px-2 py-1",onClick:()=>Ot(V=>V.filter((J,re)=>re!==B)),disabled:St.length<=2,children:"Remove"})]},y.id))}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{className:"btn px-2 py-1",onClick:()=>Ot(y=>{const B=`p${y.length+1}`;return[...y,{id:B,name:`Player ${y.length+1}`}]}),children:"Add Player"}),e.jsx("button",{className:"btn bg-emerald-600 hover:bg-emerald-700 px-3 py-1",onClick:()=>{if(St.length<2){alert("Need at least 2 players");return}const y=St.map(J=>J.id),B=Tu(y),V={};y.forEach(J=>{V[J]=_l(B[J])}),Yt(B),dt(V),gt(0),Gt(0),ws(null),Es("Assigned numbers"),Tt(!0)},children:"Assign Numbers & Start"})]})]})})]}):Ie?e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"font-semibold",children:"Your Turn"}),e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{className:"input w-24",type:"number",min:0,max:60,value:pe,onChange:y=>he(Number(y.target.value||0)),onKeyDown:y=>{y.key==="Enter"&&(y.shiftKey?mc():ji())}}),e.jsx("button",{className:"btn px-3 py-1 text-sm",onClick:ji,title:"Add a single dart (0â€“60)",children:"Add Dart"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{className:"input w-28",type:"number",min:0,max:180,placeholder:"Visit total (0â€“180)",value:Ni,onChange:y=>Ba(y.target.value),onKeyDown:y=>{y.key==="Enter"&&wi()}}),e.jsx("button",{className:"btn px-3 py-1 text-sm",onClick:wi,title:"Commit a full 3-dart total like 93",children:"Commit Visit"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{className:"input w-44",placeholder:"Manual (T20, D16, 5, 25, 50)",value:os,onChange:y=>ts(y.target.value),onKeyDown:y=>{y.key==="Enter"&&(y.shiftKey?Vi():lr())}}),e.jsx("button",{className:"btn btn--ghost px-3 py-1 text-sm",onClick:Vi,disabled:Je===0,children:"Replace Last"}),e.jsx("button",{className:"btn px-3 py-1 text-sm",onClick:lr,children:"Add"})]}),e.jsxs("div",{children:[e.jsx("textarea",{className:"input w-full h-24 resize-none",placeholder:`Type scores manually (one per line, e.g. T20
D16
5
25
50) - No camera needed!`,value:oa,onChange:y=>An(y.target.value)}),e.jsxs("div",{className:"flex gap-2 mt-1",children:[e.jsx("button",{className:"btn px-3 py-1 text-sm",onClick:uc,children:"Add All Scores"}),e.jsx("button",{className:"btn btn--ghost px-3 py-1 text-sm",onClick:()=>An(""),children:"Clear"})]})]})]}),e.jsx("div",{className:"text-xs text-slate-300",children:"Tip: Enter to Add Â· Shift+Enter to Replace Last"})]}):e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"font-semibold",children:[l==="None"?"Opponent":`${l} AI`," Turn"]}),l!=="None"?e.jsxs("div",{className:"text-sm text-slate-300",children:["Throwing in ",Math.ceil(nn/1e3),"s..."]}):e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("button",{className:"btn",onClick:()=>lt(!0),children:"Switch Back to You"})})]}),e.jsx("div",{className:"h-1"})]})]})})}),d&&e.jsx(Ru,{onClose:()=>c(!1)}),cr&&e.jsxs("div",{className:"absolute inset-0 z-40 flex items-center justify-center",children:[e.jsx("div",{className:"absolute inset-0 backdrop-blur-sm bg-slate-900/40"}),e.jsxs("div",{className:"relative z-10 p-4 rounded-xl bg-black/60 border border-slate-700 text-center",children:[e.jsx("div",{className:"text-3xl mb-2",children:"ðŸ”’"}),e.jsx("div",{className:"font-semibold",children:"Premium mode locked"}),e.jsx("div",{className:"text-sm text-slate-200/80",children:"Upgrade to PREMIUM to play modes like Killer, Cricket, Shanghai, and more."}),e.jsxs("button",{onClick:async()=>{try{const B=await(await fetch(`${Pu}/api/stripe/create-checkout-session`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:s?.email})})).json();B.ok&&B.url?(window.location.href=B.url,B.development&&Le("Opened Stripe test checkout (development mode)",{type:"info",timeout:3e3})):B.error==="STRIPE_NOT_CONFIGURED"?Le("Premium purchases are not available in this development environment. Please visit the production site to upgrade.",{type:"error",timeout:4e3}):Le("Failed to create checkout session. Please try again.",{type:"error",timeout:4e3})}catch{Le("Error creating checkout. Please try again.",{type:"error",timeout:4e3})}},className:"btn mt-3 bg-gradient-to-r from-indigo-500 to-fuchsia-600 text-white font-bold",children:["Upgrade to PREMIUM Â· ",ul(ml(),5)]})]})]}),E&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50",children:e.jsxs(zs,{storageKey:"ndn:modal:offline-win",className:"w-full relative",defaultWidth:420,defaultHeight:360,minWidth:360,minHeight:300,maxWidth:800,maxHeight:700,initialFitHeight:!0,children:[e.jsx("h3",{className:"text-lg font-bold mb-2",children:"Leg Won!"}),e.jsx("label",{className:"block mb-1",children:"Darts to hit double:"}),e.jsx("div",{className:"flex gap-2 mb-2",children:[1,2,3].map(y=>e.jsx("button",{className:`btn ${F===y?"bg-brand-600":""}`,onClick:()=>D(y),children:y},y))}),e.jsx("label",{className:"block mb-1",children:"Darts for checkout:"}),e.jsx("div",{className:"flex gap-2 mb-2",children:[1,2,3].map(y=>e.jsx("button",{className:`btn ${Q===y?"bg-brand-600":""}`,onClick:()=>me(y),children:y},y))}),e.jsxs("div",{className:"grid grid-cols-1 gap-2 mt-2",children:[e.jsx("button",{className:"btn w-full",onClick:hc,children:"Submit"}),e.jsx("button",{className:"btn bg-emerald-600 hover:bg-emerald-700 w-full",onClick:()=>{I(!1),Zs()},children:"Rematch"}),e.jsx("button",{className:"btn bg-slate-700 hover:bg-slate-800 w-full",onClick:()=>{I(!1),Ee(!1),m(!1)},children:"Back to Menu"})]})]})}),It&&e.jsx("div",{className:"fixed inset-0 bg-black/60 flex items-center justify-center z-[60]",children:e.jsxs(zs,{storageKey:"ndn:modal:offline-summary",className:"w-full relative",defaultWidth:820,defaultHeight:520,minWidth:600,minHeight:400,maxWidth:1400,maxHeight:1e3,initialFitHeight:!0,children:[e.jsx("h3",{className:"text-xl font-extrabold mb-2",children:"Match Summary"}),e.jsxs("div",{className:"text-xs opacity-80 mb-3",children:[t," Â· ",a," start Â· First to ",M]}),(()=>{const y=Tn>0?ea/Tn*3:0,B=y*3,V=(()=>{const Ve=ue.filter(at=>at.winner==="player"&&typeof at.winnerDarts=="number").map(at=>at.winnerDarts);return Ve.length?`${Math.min(...Ve)} darts`:"â€”"})(),J=(()=>{const Ve=ue.filter(at=>at.winner==="player"&&typeof at.winnerDarts=="number").map(at=>at.winnerDarts);return Ve.length?`${Math.max(...Ve)} darts`:"â€”"})(),re=Xn>0?Math.round(Ms/Xn*100):0,Fe=Dn>0?sa/Dn*3:0,tt=Fe*3,De=(()=>{const Ve=ue.filter(at=>at.winner==="ai"&&typeof at.winnerDarts=="number").map(at=>at.winnerDarts);return Ve.length?`${Math.min(...Ve)} darts`:"â€”"})(),ge=(()=>{const Ve=ue.filter(at=>at.winner==="ai"&&typeof at.winnerDarts=="number").map(at=>at.winnerDarts);return Ve.length?`${Math.max(...Ve)} darts`:"â€”"})(),Me=Cn>0?Math.round(Zn/Cn*100):0;return e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-3",children:[e.jsxs("div",{className:"p-3 rounded-2xl glass border border-white/10",children:[e.jsx("div",{className:"text-sm font-semibold mb-1",children:s?.username||"You"}),e.jsx("div",{className:"text-3xl font-extrabold",children:A}),e.jsx("div",{className:"text-xs opacity-80",children:"Legs Won"}),e.jsxs("div",{className:"mt-3 grid grid-cols-2 gap-2 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"opacity-70",children:"Final 3DA"}),e.jsx("div",{className:"font-semibold",children:y.toFixed(1)})]}),e.jsxs("div",{children:[e.jsx("span",{className:"opacity-70",children:"Final 9DA"}),e.jsx("div",{className:"font-semibold",children:B.toFixed(1)})]}),e.jsxs("div",{children:[e.jsx("span",{className:"opacity-70",children:"Darts At Double"}),e.jsx("div",{className:"font-semibold",children:Xn})]}),e.jsxs("div",{children:[e.jsx("span",{className:"opacity-70",children:"Double %"}),e.jsxs("div",{className:"font-semibold",children:[re,"%"]})]}),e.jsxs("div",{children:[e.jsx("span",{className:"opacity-70",children:"Best Dart Leg"}),e.jsx("div",{className:"font-semibold",children:V})]}),e.jsxs("div",{children:[e.jsx("span",{className:"opacity-70",children:"Worst Dart Leg"}),e.jsx("div",{className:"font-semibold",children:J})]}),e.jsxs("div",{children:[e.jsx("span",{className:"opacity-70",children:"180's Hit"}),e.jsx("div",{className:"font-semibold",children:pa})]})]})]}),e.jsx("div",{className:"hidden md:flex items-center justify-center",children:e.jsxs("div",{className:"text-4xl font-black",children:[A," â€“ ",b]})}),e.jsxs("div",{className:"p-3 rounded-2xl glass border border-white/10",children:[e.jsx("div",{className:"text-sm font-semibold mb-1",children:l==="None"?"Opponent":`${l} AI`}),e.jsx("div",{className:"text-3xl font-extrabold",children:b}),e.jsx("div",{className:"text-xs opacity-80",children:"Legs Won"}),e.jsxs("div",{className:"mt-3 grid grid-cols-2 gap-2 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"opacity-70",children:"Final 3DA"}),e.jsx("div",{className:"font-semibold",children:Fe.toFixed(1)})]}),e.jsxs("div",{children:[e.jsx("span",{className:"opacity-70",children:"Final 9DA"}),e.jsx("div",{className:"font-semibold",children:tt.toFixed(1)})]}),e.jsxs("div",{children:[e.jsx("span",{className:"opacity-70",children:"Darts At Double"}),e.jsx("div",{className:"font-semibold",children:Cn})]}),e.jsxs("div",{children:[e.jsx("span",{className:"opacity-70",children:"Double %"}),e.jsxs("div",{className:"font-semibold",children:[Me,"%"]})]}),e.jsxs("div",{children:[e.jsx("span",{className:"opacity-70",children:"Best Dart Leg"}),e.jsx("div",{className:"font-semibold",children:De})]}),e.jsxs("div",{children:[e.jsx("span",{className:"opacity-70",children:"Worst Dart Leg"}),e.jsx("div",{className:"font-semibold",children:ge})]}),e.jsxs("div",{children:[e.jsx("span",{className:"opacity-70",children:"180's Hit"}),e.jsx("div",{className:"font-semibold",children:aa})]})]})]})]})})(),e.jsxs("div",{className:"mt-4",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"Legs Timeline"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:ue.map((y,B)=>e.jsxs("div",{className:`px-3 py-1 rounded-full border text-xs ${y.winner==="player"?"bg-emerald-500/15 border-emerald-400/30":"bg-fuchsia-500/15 border-fuchsia-400/30"}`,children:["Leg ",B+1,": ",y.winner==="player"?"You":l==="None"?"Opp":"AI"," Â· Dbl ",y.doubleDarts," Â· CO ",y.checkoutDarts]},B))})]}),e.jsxs("div",{className:"mt-4",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"Shot Heat Map"}),e.jsx("div",{className:"rounded-2xl overflow-hidden bg-black p-3",children:e.jsx(Su,{})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 mt-4",children:[e.jsx("button",{className:"btn bg-slate-700 hover:bg-slate-800",onClick:()=>In(!1),children:"Close"}),e.jsx("button",{className:"btn bg-emerald-600 hover:bg-emerald-700",onClick:()=>{In(!1),Zs()},children:"Rematch"})]})]})}),ue.length>0&&e.jsxs("div",{className:"mt-4",children:[e.jsx("h4",{className:"font-semibold mb-2",children:"Leg Stats"}),e.jsx("ul",{children:ue.map((y,B)=>e.jsxs("li",{children:["Leg ",B+1,": Double darts: ",y.doubleDarts,", Checkout darts: ",y.checkoutDarts]},B))})]})]})]})}const Gl="ndn:messages:inbox",Jl="ndn:messages:unread";function Ou(){try{const s=localStorage.getItem(Gl),n=s?JSON.parse(s):[],t=Number(localStorage.getItem(Jl)||"0")||0;return{inbox:Array.isArray(n)?n.filter(a=>a&&typeof a.id=="string").slice(0,200):[],unread:t}}catch{return{inbox:[],unread:0}}}function Fa(s,n){try{localStorage.setItem(Gl,JSON.stringify(s))}catch{}try{localStorage.setItem(Jl,String(n))}catch{}}const Yo=Ou(),di=Js((s,n)=>({inbox:Yo.inbox,unread:Yo.unread,inGame:!1,setInGame:t=>s({inGame:t}),add:t=>s(i=>{const a=i.inbox.some(o=>o.id===t.id&&o.ts===t.ts),r=a?i.inbox:[t,...i.inbox].slice(0,200),l=i.unread+(a?0:1);return Fa(r,l),{inbox:r,unread:l}}),load:t=>s(i=>{const a=[...t].sort((r,l)=>l.ts-r.ts).slice(0,200);return Fa(a,i.unread),{inbox:a,unread:i.unread}}),markAllRead:()=>{const t=n();Fa(t.inbox,0),s({unread:0})},remove:t=>s(i=>{const a=i.inbox.filter(l=>l.id!==t),r=i.unread;return Fa(a,r),{inbox:a,unread:r}})})),Kl=[/\b(f+[\W_]*u+[\W_]*c+[\W_]*k+)\b/gi,/\b(s+[\W_]*h+[\W_]*i+[\W_]*t+)\b/gi,/\b(b+[\W_]*i+[\W_]*t+[\W_]*c+[\W_]*h+)\b/gi,/\b(a+[\W_]*s+[\W_]*s+[\W_]*h+[\W_]*o+[\W_]*l+[\W_]*e+)\b/gi,/\b(d+[\W_]*a+[\W_]*m+[\W_]*n+)\b/gi,/\b(c+[\W_]*r+[\W_]*a+[\W_]*p+)\b/gi,/\b(p+[\W_]*i+[\W_]*s+[\W_]*s+)\b/gi];function Bu(s){return s.replace(/[\p{L}\p{N}]/gu,"*")}function Yl(s){if(!s)return s;let n=s;for(const t of Kl)n=n.replace(t,i=>Bu(i));return n}function Uu(s){return s?Kl.some(n=>n.test(s)):!1}function Xa({tabs:s,active:n,onChange:t,className:i}){return e.jsxs("div",{className:`relative ${i||""}`,children:[e.jsx("div",{className:"absolute inset-0 rounded-xl bg-white/5 backdrop-blur-md border border-white/10 pointer-events-none"}),e.jsx("div",{className:"relative overflow-x-auto no-scrollbar py-1 px-1",children:e.jsx("div",{className:"flex items-center gap-2 min-w-max",children:s.map(a=>{const r=a.key===n;return e.jsx("button",{type:"button",onClick:()=>t(a.key),className:`transition-all select-none whitespace-nowrap rounded-full px-4 py-2 text-sm font-semibold shadow-sm focus:outline-none focus-visible:ring-2 focus-visible:ring-white/60 active:scale-[0.98]
                  ${r?"bg-gradient-to-r from-indigo-500 to-fuchsia-500 text-white shadow-indigo-500/30":"bg-white/10 text-slate-100 hover:bg-white/15"}
                `,"aria-pressed":r,children:a.label},a.key)})})}),e.jsx("style",{children:`
        /* Hide scrollbars on WebKit/Firefox for a cleaner pill row */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
      `})]})}function $u(s){if(!s)return"";const n=Math.floor((Date.now()-s)/1e3);if(n<60)return`${n}s ago`;const t=Math.floor(n/60);if(t<60)return`${t}m ago`;const i=Math.floor(t/60);return i<24?`${i}h ago`:`${Math.floor(i/24)}d ago`}function _u({user:s}){const n=zn(),t=String(s?.email||"").toLowerCase(),[i,a]=u.useState([]),[r,l]=u.useState([]),[o,d]=u.useState([]),[c,h]=u.useState(""),[m,x]=u.useState("all"),[p,g]=u.useState(!1),w=di(),[T,S]=u.useState([]),[E,I]=u.useState([]),[M,P]=u.useState({show:!1});async function A(){if(t)try{const[D,Q,me,ue]=await Promise.all([fetch(`/api/friends/list?email=${encodeURIComponent(t)}`).then(ke=>ke.json()),fetch(`/api/friends/suggested?email=${encodeURIComponent(t)}`).then(ke=>ke.json()),fetch(`/api/friends/requests?email=${encodeURIComponent(t)}`).then(ke=>ke.json()),fetch(`/api/friends/outgoing?email=${encodeURIComponent(t)}`).then(ke=>ke.json())]);a(D.friends||[]),l(Q.suggestions||[]),S(me.requests||[]),I(ue.requests||[])}catch{}}u.useEffect(()=>{A()},[t]);async function v(D){if(h(D),!D){d([]);return}try{const me=await(await fetch(`/api/friends/search?q=${encodeURIComponent(D)}`)).json();d(me.results||[])}catch{}}async function b(D){if(!(!t||!D)){g(!0);try{await fetch("/api/friends/add",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:t,friend:D})}),await A(),h(""),d([]),n("Friend added",{type:"success"})}finally{g(!1)}}}async function H(D){if(!(!t||!D)){g(!0);try{await fetch("/api/friends/remove",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:t,friend:D})}),await A(),n("Friend removed",{type:"info"})}finally{g(!1)}}}const W=u.useMemo(()=>m==="all"?i:i.filter(D=>(D.status||"offline")===m),[i,m]);async function R(D){if(!D){n("Room unavailable",{type:"error"});return}try{const Q=new CustomEvent("ndn:spectate-request",{detail:{roomId:D}});window.dispatchEvent(Q),n("Opening spectator viewâ€¦",{type:"info"})}catch{}}const F=T.length+E.length;return e.jsxs("div",{className:"card ndn-game-shell",children:[e.jsx("h2",{className:"text-2xl font-bold text-brand-700 mb-2",children:"Friends"}),e.jsx("p",{className:"mb-2 text-brand-600",children:"Manage your friends. See whoâ€™s online, in-game, or offline; find new teammates; and invite people to play."}),e.jsxs("div",{className:"text-xs opacity-70 mb-3",children:["Online: ",i.filter(D=>D.status==="online").length," Â· In-game: ",i.filter(D=>D.status==="ingame").length," Â· Offline: ",i.filter(D=>!D.status||D.status==="offline").length]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-3 mb-4",children:[e.jsxs("div",{className:"md:col-span-2 p-3 rounded-2xl bg-black/30 border border-white/10",children:[e.jsx("div",{className:"flex items-center justify-between mb-2",children:e.jsx("div",{className:"font-semibold text-white/90",children:"Your Friends"})}),e.jsx(Xa,{tabs:[{key:"all",label:"All"},{key:"online",label:"Online"},{key:"ingame",label:"In-Game"},{key:"offline",label:"Offline"},{key:"requests",label:`Requests ${F>0?"("+F+")":""}`}],active:m,onChange:D=>x(D),className:"mb-3"}),m==="requests"?e.jsx("ul",{className:"space-y-2",children:F>0?e.jsxs(e.Fragment,{children:[T.length>0&&T.map(D=>e.jsxs("li",{className:"p-3 rounded bg-black/20 flex flex-col gap-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-semibold text-lg",children:D.fromUsername||D.fromEmail||"Unknown User"}),e.jsx("span",{className:"text-xs bg-blue-600/20 text-blue-400 px-2 py-1 rounded",children:"Incoming"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{className:"btn bg-emerald-600 hover:bg-emerald-700",onClick:async()=>{g(!0);try{if((await fetch("/api/friends/accept",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:t,requester:D.fromEmail})})).ok){S(ue=>ue.filter(ke=>ke.id!==D.id));const me={email:D.fromEmail,username:D.fromUsername,status:"offline"};a(ue=>[...ue,me]),I(ue=>ue.filter(ke=>ke.toEmail!==D.fromEmail)),n("Friend request accepted",{type:"success"}),setTimeout(()=>A(),100)}else n("Failed to accept request",{type:"error"})}catch{n("Error accepting request",{type:"error"})}finally{g(!1)}},children:"Accept"}),e.jsx("button",{className:"btn bg-rose-600 hover:bg-rose-700",onClick:async()=>{g(!0);try{(await fetch("/api/friends/decline",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:t,requester:D.fromEmail})})).ok?(S(me=>me.filter(ue=>ue.id!==D.id)),I(me=>me.filter(ue=>ue.toEmail!==D.fromEmail)),n("Friend request declined",{type:"info"}),setTimeout(()=>A(),100)):n("Failed to decline request",{type:"error"})}finally{g(!1)}},children:"Decline"})]})]},`incoming-${D.id||D.fromEmail}`)),E.length>0&&E.map(D=>e.jsxs("li",{className:"p-3 rounded bg-black/20 flex flex-col gap-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-semibold text-lg",children:D.toUsername||D.toEmail||"Unknown User"}),e.jsx("span",{className:"text-xs bg-amber-600/20 text-amber-400 px-2 py-1 rounded",children:"Pending"})]}),e.jsx("button",{className:"btn bg-slate-600 hover:bg-slate-700 self-start",onClick:async()=>{g(!0);try{(await fetch("/api/friends/cancel",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:t,friend:D.toEmail})})).ok?(I(me=>me.filter(ue=>ue.id!==D.id)),n("Friend request cancelled",{type:"info"}),setTimeout(()=>A(),100)):n("Failed to cancel request",{type:"error"})}finally{g(!1)}},children:"Cancel"})]},`outgoing-${D.id||D.toEmail}`))]}):e.jsx("li",{className:"text-sm opacity-70",children:"No friend requests yet."})}):e.jsxs("ul",{className:"space-y-2",children:[W.map(D=>e.jsxs("li",{className:"p-2 rounded bg-black/20 flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:`inline-block w-2 h-2 rounded-full ${D.status==="online"?"bg-emerald-400":D.status==="ingame"?"bg-amber-400":"bg-slate-400"}`}),e.jsx("span",{className:"font-semibold",children:D.username||D.email}),e.jsxs("span",{className:"text-xs opacity-70",children:[D.status||"offline",D.status!=="online"&&D.lastSeen?` Â· ${$u(D.lastSeen)}`:""]}),D.status==="ingame"&&D.match&&e.jsxs("span",{className:"text-[10px] opacity-70 px-2 py-0.5 rounded bg-indigo-500/20 border border-indigo-600/30",children:[D.match.game," ",D.match.mode==="firstto"?"FT":"BO"," ",D.match.value,D.match.game==="X01"&&D.match.startingScore?` Â· ${D.match.startingScore}`:""]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[D.status==="ingame"&&D.roomId&&e.jsx("button",{className:"btn",onClick:()=>R(D.roomId),children:"Spectate"}),e.jsx("button",{className:"btn",disabled:p||D.status!=="online"&&D.status!=="ingame",onClick:async()=>{g(!0);try{(await(await fetch("/api/friends/invite",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({fromEmail:t,toEmail:D.email,game:"X01",mode:"bestof",value:3,startingScore:501})})).json().catch(()=>({})))?.delivered?n("Invite sent",{type:"success"}):n("Friend is offline; invite queued",{type:"info"})}finally{g(!1)}},children:"Invite"}),e.jsx("button",{className:"btn",disabled:p,onClick:()=>P({show:!0,toUser:D.username||D.email,toEmail:D.email}),children:"Message"}),e.jsx("button",{className:"btn bg-rose-600 hover:bg-rose-700",disabled:p,onClick:()=>H(D.email),children:"Remove"})]})]},D.email)),W.length===0&&e.jsxs("li",{className:"text-sm opacity-70",children:["No friends ",m!=="all"?`in ${m}`:""," yet."]})]})]}),e.jsxs("div",{className:"p-3 rounded-2xl bg-black/20 border border-white/10",children:[e.jsx("div",{className:"font-semibold mb-2 text-white/90",children:"Find Friends"}),e.jsx("input",{className:"input w-full mb-2",placeholder:"Search by name or email",value:c,onChange:D=>v(D.target.value)}),e.jsxs("ul",{className:"space-y-1 mb-3 max-h-48 overflow-auto",children:[o.map(D=>e.jsxs("li",{className:"flex items-center justify-between p-2 rounded bg-black/10",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:`inline-block w-2 h-2 rounded-full ${D.status==="online"?"bg-emerald-400":D.status==="ingame"?"bg-amber-400":"bg-slate-400"}`}),e.jsx("span",{children:D.username||D.email})]}),e.jsx("button",{className:"btn",disabled:p,onClick:()=>b(D.email),children:"Add"})]},D.email)),o.length===0&&e.jsx("li",{className:"text-xs opacity-60",children:"Type to searchâ€¦"})]}),e.jsx("div",{className:"font-semibold mb-1 text-white/90",children:"Suggested"}),e.jsxs("ul",{className:"space-y-1 max-h-48 overflow-auto",children:[r.map(D=>e.jsxs("li",{className:"flex items-center justify-between p-2 rounded bg-black/10",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:`inline-block w-2 h-2 rounded-full ${D.status==="online"?"bg-emerald-400":D.status==="ingame"?"bg-amber-400":"bg-slate-400"}`}),e.jsx("span",{children:D.username||D.email})]}),e.jsx("button",{className:"btn",disabled:p,onClick:()=>b(D.email),children:"Add"})]},D.email)),r.length===0&&e.jsx("li",{className:"text-xs opacity-60",children:"No suggestions right now."})]})]})]}),e.jsxs("div",{className:"p-3 rounded-xl bg-indigo-500/10 border border-indigo-500/40",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("div",{className:"font-semibold",children:"Messages"}),e.jsx("button",{className:"btn px-3 py-1 text-sm",onClick:()=>w.markAllRead(),children:"Mark all read"})]}),w.inbox.length===0?e.jsx("div",{className:"text-sm opacity-70",children:"No messages yet."}):e.jsx("ul",{className:"space-y-2 max-h-72 overflow-auto",children:w.inbox.map(D=>e.jsxs("li",{className:"p-2 rounded bg-black/20 text-sm",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-semibold",children:D.from})," ",e.jsxs("span",{className:"opacity-70 text-xs",children:["Â· ",new Date(D.ts).toLocaleString()]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{className:"btn px-2 py-1 text-xs",onClick:()=>P({show:!0,toUser:D.from,toEmail:D.from,replyTo:D.from}),children:"Reply"}),e.jsx("button",{className:"btn bg-slate-700 hover:bg-slate-800 px-2 py-1 text-xs",title:"Delete this message",onClick:()=>w.remove(D.id),children:"Delete"}),e.jsx("button",{className:"btn bg-rose-600 hover:bg-rose-700 px-2 py-1 text-xs",onClick:async()=>{const Q=prompt("Report reason (what happened)?");if(Q)try{await fetch("/api/friends/report",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({reporterEmail:t,offenderEmail:D.from,reason:Q,messageId:D.id})}),n("Report sent to admin",{type:"info"})}catch{}},children:"Report"})]})]}),e.jsx("div",{className:"mt-1 whitespace-pre-wrap break-words",children:Yl(D.message)})]},D.id))})]}),M.show&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-slate-800 border border-slate-600 rounded-lg p-6 max-w-md w-full mx-4",children:[e.jsx("div",{className:"text-center mb-4",children:e.jsxs("h3",{className:"text-lg font-semibold text-white",children:["Type Message To ",M.toUser]})}),e.jsx("textarea",{className:"w-full h-32 bg-slate-700 border border-slate-600 rounded p-3 text-white placeholder-slate-400 resize-none",placeholder:"Type your message here...",id:"message-input",autoFocus:!0}),e.jsxs("div",{className:"flex gap-3 mt-4",children:[e.jsx("button",{className:"flex-1 btn bg-emerald-600 hover:bg-emerald-700",onClick:async()=>{const Q=document.getElementById("message-input")?.value?.trim();if(Q){g(!0);try{await fetch("/api/friends/message",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({fromEmail:t,toEmail:M.toEmail,message:Q})}),n("Message sent",{type:"success"}),P({show:!1})}catch{n("Failed to send message",{type:"error"})}finally{g(!1)}}},disabled:p,children:"Send"}),e.jsx("button",{className:"flex-1 btn bg-slate-600 hover:bg-slate-700",onClick:()=>P({show:!1}),children:"Cancel"})]})]})})]})}function Fu(){const s=ei(t=>t.toasts),n=ei(t=>t.remove);return s.length?e.jsxs(e.Fragment,{children:[s.filter(t=>t.type==="success").map(t=>e.jsx("div",{className:"fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-50",children:e.jsx("div",{className:"p-4 rounded-lg shadow-lg border text-sm bg-emerald-700/90 border-emerald-500/60 text-white max-w-sm text-center",children:e.jsx("div",{className:"flex items-center justify-center gap-2",children:e.jsx("span",{className:"flex-1 font-semibold",children:t.message})})})},t.id)),s.filter(t=>t.type!=="success").length>0&&e.jsx("div",{className:"fixed bottom-4 right-4 z-50 space-y-2 sm:right-4 sm:left-auto left-1/2 -translate-x-1/2 sm:translate-x-0 w-[calc(100%-1.5rem)] sm:w-auto max-w-sm",children:s.filter(t=>t.type!=="success").map(t=>e.jsx("div",{className:`p-3 rounded-lg shadow-lg border text-sm ${t.type==="error"?"bg-rose-700/80 border-rose-500/60 text-white":"bg-black/70 border-slate-700 text-slate-100"}`,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"flex-1",children:t.message}),e.jsx("button",{className:"btn btn--ghost px-2 py-1 text-xs",onClick:()=>n(t.id),children:"Dismiss"})]})},t.id))})]}):null}function ui({data:s,height:n=220,barWidth:t=28,gap:i=6,showValues:a=!1}){const r=Math.max(1,...s.map(o=>o.value)),l=s.length*(t+i);return e.jsx("div",{className:"w-full overflow-x-auto",children:e.jsx("div",{className:"relative",style:{height:n,width:Math.max(600,l)},children:e.jsx("div",{className:"absolute inset-0 flex items-end",children:s.map((o,d)=>{const c=Math.round(o.value/r*(n-40));return e.jsxs("div",{className:"flex flex-col items-center justify-end",style:{width:t,marginRight:i},children:[e.jsx("div",{className:"w-full rounded-t-md bg-gradient-to-b from-indigo-400 to-fuchsia-500 shadow-sm",style:{height:c},title:`${o.label}: ${o.value}`}),a&&e.jsx("div",{className:"text-[10px] mt-1 opacity-80",children:o.value}),e.jsx("div",{className:"text-[10px] mt-1 opacity-70 select-none",children:o.label})]},d)})})})})}const Hu=["X01","Double Practice"],bn=["Around the Clock","Cricket","Halve It","Shanghai","High-Low","Killer","Bob's 27","Count-Up","High Score","Low Score","Checkout 170","Checkout 121","Treble Practice","Baseball","Golf","Tic Tac Toe","American Cricket"],Ia=[...Hu,...bn],Xl=u.createContext(null);function Wu({children:s}){const[n,t]=u.useState(!1),[i,a]=u.useState("connecting"),r=u.useRef(null),l=u.useRef(new Set),o=u.useRef(!0),d=u.useRef(0),c=u.useRef(null),h=u.useRef(null),m=u.useRef(null),x=u.useRef(0),p=()=>{if(m.current)return m.current;const P="ws://localhost:8787";if(P.length>0){const W=P.endsWith("/ws")?P:P.replace(/\/$/,"")+"/ws";return m.current=[W],m.current}const A=window.location.protocol==="https:"?"wss":"ws",v=window.location.hostname,H=[`${A}://${window.location.host}`+"/ws",`${A}://${v}/ws`,`${A}://${v}:8787/ws`,`${A}://${v}:3000/ws`];return m.current=Array.from(new Set(H)),m.current},g=()=>{const P=p();return x.current=(x.current+1)%P.length,P[x.current]},w=()=>{const P=p();return P[x.current]||P[0]},T=u.useCallback(()=>{if(r.current&&(r.current.readyState===WebSocket.OPEN||r.current.readyState===WebSocket.CONNECTING))return;a("connecting");const A=`${w()}`,v=new WebSocket(A);r.current=v,v.onopen=()=>{t(!0),a("connected"),d.current=0,h.current&&clearInterval(h.current),h.current=setInterval(()=>{try{r.current?.readyState===WebSocket.OPEN&&r.current?.send(JSON.stringify({type:"ping",t:Date.now()}))}catch{}},2e4)},v.onmessage=b=>{try{const H=JSON.parse(b.data);l.current.forEach(W=>{try{W(H)}catch{}})}catch{}},v.onerror=()=>{},v.onclose=()=>{if(t(!1),a("disconnected"),h.current&&(clearInterval(h.current),h.current=null),!o.current)return;const b=(d.current||0)+1;d.current=b,b%2===0&&g();const H=1e3*Math.pow(2,b-1),W=Math.floor(Math.random()*1e3);let R=Math.min(3e4,H+W);b===1&&(R=0),c.current&&clearTimeout(c.current),R===0?T():c.current=setTimeout(T,R)}},[]),S=u.useCallback(()=>{try{o.current=!1,c.current&&(clearTimeout(c.current),c.current=null),h.current&&(clearInterval(h.current),h.current=null);try{r.current?.close()}catch{}r.current=null}catch{}d.current=0,o.current=!0,a("connecting"),t(!1),T()},[T]);u.useEffect(()=>{o.current=!0,T();const P=()=>{o.current=!1;try{r.current?.close()}catch{}};window.addEventListener("beforeunload",P);const A=()=>{document.visibilityState==="visible"&&(n||T())};return document.addEventListener("visibilitychange",A),window.addEventListener("online",T),()=>{o.current=!1,c.current&&clearTimeout(c.current),h.current&&clearInterval(h.current);try{r.current?.close()}catch{}document.removeEventListener("visibilitychange",A),window.removeEventListener("online",T),window.removeEventListener("beforeunload",P)}},[T]);const E=u.useCallback(P=>{try{r.current&&r.current.readyState===WebSocket.OPEN&&r.current.send(typeof P=="string"?P:JSON.stringify(P))}catch{}},[]),I=u.useCallback(P=>(l.current.add(P),()=>{l.current.delete(P)}),[]),M=u.useMemo(()=>({connected:n,status:i,send:E,addListener:I,reconnect:S}),[n,i,E,I,S]);return e.jsx(Xl.Provider,{value:M,children:s})}function xa(){const s=u.useContext(Xl);if(!s)throw new Error("useWS must be used within WSProvider");return s}function Ql({status:s,title:n,size:t=12}){const i=t;return s==="connecting"?e.jsx("span",{role:"img","aria-label":"Connecting",title:n||"Connectingâ€¦",className:"inline-flex items-center justify-center",style:{width:i,height:i},children:e.jsxs("svg",{width:i,height:i,viewBox:"0 0 24 24",className:"animate-spin","aria-hidden":"true",children:[e.jsx("circle",{cx:"12",cy:"12",r:"10",stroke:"#A7F3D0",strokeWidth:"3",fill:"none",opacity:"0.35"}),e.jsx("path",{d:"M22 12a10 10 0 0 0-10-10",stroke:"#34D399",strokeWidth:"3",strokeLinecap:"round",fill:"none"})]})}):s==="connected"?e.jsx("span",{role:"img","aria-label":"Connected",title:n||"Connected",className:"inline-flex items-center justify-center",style:{width:i,height:i},children:e.jsx("svg",{width:i,height:i,viewBox:"0 0 24 24","aria-hidden":"true",children:e.jsx("circle",{cx:"12",cy:"12",r:"10",fill:"#34D399"})})}):e.jsx("span",{role:"img","aria-label":"Disconnected",title:n||"Not connected",className:"inline-flex items-center justify-center",style:{width:i,height:i},children:e.jsxs("svg",{width:i,height:i,viewBox:"0 0 24 24","aria-hidden":"true",children:[e.jsx("circle",{cx:"12",cy:"12",r:"10",fill:"#F87171",opacity:"0.15"}),e.jsx("circle",{cx:"12",cy:"12",r:"9",stroke:"#F87171",strokeWidth:"2",fill:"none"}),e.jsx("rect",{x:"6",y:"11",width:"12",height:"2",rx:"1",fill:"#F87171"})]})})}function Zl(){const s=Gn(),n=u.useRef(null),t=u.useRef(null),i=s.isStreaming&&s.mode==="phone",a=s.getVideoElementRef();u.useEffect(()=>{const l=n.current;if(!l)return;let o=!0;const d=l.getContext("2d");if(!d)return;const c=()=>{if(o){try{if(d.clearRect(0,0,l.width,l.height),i&&a&&a.readyState>=2){const h=a.videoWidth||640,m=a.videoHeight||360,x=l.width,p=l.height,g=h/m,w=x/p;let T=0,S=0,E=h,I=m;if(g>w){const M=m*w;T=(h-M)/2,E=M}else if(g<w){const M=h/w;S=(m-M)/2,I=M}d.drawImage(a,T,S,E,I,0,0,x,p)}else d.fillStyle="rgba(148, 163, 184, 0.25)",d.fillRect(0,0,l.width,l.height),d.fillStyle="rgba(226,232,240,0.8)",d.font="10px system-ui, sans-serif",d.textAlign="center",d.textBaseline="middle",d.fillText("Camera",l.width/2,l.height/2)}catch{}t.current=requestAnimationFrame(c)}};return t.current=requestAnimationFrame(c),()=>{o=!1,t.current&&cancelAnimationFrame(t.current)}},[i,a]);const r=()=>{try{window.dispatchEvent(new CustomEvent("ndn:toggle-phone-overlay"))}catch{}};return e.jsxs("button",{type:"button",onClick:r,className:"relative inline-flex items-center gap-1 rounded-lg border border-white/15 bg-white/5 hover:bg-white/10 transition-colors shadow-sm overflow-hidden",style:{height:36},title:i?"Camera connected â€“ click to toggle overlay":"Camera not connected",children:[e.jsx("canvas",{ref:n,width:64,height:36,className:"block"}),e.jsx("span",{className:"pr-2 text-xs text-slate-100 select-none hidden xs:inline",children:i?"Phone Cam":"No Camera"}),e.jsx("span",{className:"absolute -top-1 -right-1 text-lg pointer-events-none drop-shadow","aria-hidden":"true",children:i?"âœ…":"âšª"})]})}function ec({request:s,user:n,onClose:t}){const i=(()=>{try{return xa()}catch{return null}})(),[a,r]=u.useState(s?.messages||[]),[l,o]=u.useState(""),[d,c]=u.useState({}),h=u.useRef(null),m=u.useRef(null);u.useEffect(()=>{if(!i)return;const p=i.addListener(g=>{try{if(g?.type==="help-message"&&String(g.requestId)===String(s.id)&&r(w=>[...w,g.message]),g?.type==="help-request-updated"&&g.request?.id===s.id&&r(g.request.messages||[]),g?.type==="help-typing"&&String(g.requestId)===String(s.id)){const w=g.fromName||g.fromEmail||(g.admin?"admin":"user");c(T=>({...T,[w]:Date.now()}))}}catch{}});return()=>{p()}},[i,s?.id]);const x=()=>{if(!l.trim())return;const p={type:"help-message",requestId:s.id,message:l};try{i?.send(p)}catch{}const g={fromEmail:n?.email||null,fromName:n?.username||null,message:l,ts:Date.now(),admin:!!(n?.email&&n?.isAdmin)};r(w=>[...w,g]),o("")};return u.useEffect(()=>{if(h.current)try{h.current.scrollTop=h.current.scrollHeight}catch{}},[a]),u.useCallback(()=>{try{i?.send({type:"help-typing",requestId:s.id,fromName:n?.username,fromEmail:n?.email,admin:!!n?.isAdmin})}catch{}m.current&&clearTimeout(m.current),m.current=window.setTimeout(()=>{c(p=>{const g={...p};return delete g[n?.username||n?.email||"me"],g})},3e3)},[i,s.id,n]),u.useEffect(()=>()=>{m.current&&clearTimeout(m.current)},[]),e.jsxs("div",{className:"fixed inset-0 z-50 flex items-end justify-center p-4",children:[e.jsx("div",{className:"absolute inset-0 bg-black/40",onClick:t}),e.jsxs("div",{className:"relative w-full max-w-xl bg-slate-900 rounded-lg shadow-xl overflow-hidden",children:[e.jsxs("div",{className:"flex items-center justify-between p-3 border-b border-slate-700",children:[e.jsxs("div",{className:"font-semibold",children:["Helpdesk â€” ",s.username||"Anonymous"]}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("button",{className:"px-2 py-1 rounded bg-neutral-700 text-sm",onClick:t,children:e.jsx(tl,{className:"w-4 h-4"})})})]}),e.jsxs("div",{ref:h,className:"h-72 overflow-y-auto p-3 space-y-2 bg-black/20",children:[a.map((p,g)=>e.jsxs("div",{className:`max-w-[80%] px-3 py-2 rounded ${p.admin?"bg-emerald-600 text-white ml-auto":"bg-slate-700 text-slate-100"}`,children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"text-xs opacity-70 mb-1",children:p.fromName||p.fromEmail||(p.admin?"Admin":"User")}),e.jsx("div",{className:"text-xs opacity-50 ml-2",children:p.ts?new Date(p.ts).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):""})]}),e.jsx("div",{className:"whitespace-pre-wrap break-words",children:p.message})]},g)),Object.keys(d).length>0&&e.jsxs("div",{className:"text-xs text-slate-300 opacity-80",children:[Object.keys(d).join(", ")," typing..."]})]}),e.jsxs("div",{className:"p-3 border-t border-slate-700 flex gap-2",children:[e.jsx("input",{className:"input flex-1",value:l,onChange:p=>o(p.target.value),onKeyDown:p=>{p.key==="Enter"&&x()},placeholder:"Write a message..."}),e.jsx("button",{className:"btn bg-blue-600 hover:bg-blue-700",onClick:x,children:e.jsx(fi,{className:"w-4 h-4"})})]})]})]})}const zu="daviesfamily108@gmail.com";function qu({user:s}){const n=(()=>{try{return xa()}catch{return null}})(),[t,i]=u.useState([]),[a,r]=u.useState(""),[l,o]=u.useState(null),[d,c]=u.useState(""),[h,m]=u.useState(!1),[x,p]=u.useState([]),[g,w]=u.useState([]),[T,S]=u.useState(""),[E,I]=u.useState([]),[M,P]=u.useState({title:"Official Tournament",game:"X01",mode:"bestof",value:3,description:"",startAt:new Date(Date.now()+7200*1e3).toISOString().slice(0,16),checkinMinutes:30,capacity:16,prizeType:"premium",prizeAmount:3,currency:"GBP",prizeNotes:""}),[A,v]=u.useState({reset:{},reminder:{},confirmEmail:{},changed:{}}),[b,H]=u.useState({open:!1}),[W,R]=u.useState("general"),F=s?.email?.toLowerCase()===zu,[D,Q]=u.useState([]),[me,ue]=u.useState([]),[ke,_e]=u.useState([]),[Pe,Le]=u.useState({}),[ve,Ee]=u.useState(null),[$,te]=u.useState([]),[oe,He]=u.useState(null),[We,we]=u.useState(0);u.useEffect(()=>{const C=()=>we(ne=>ne+1);return window.addEventListener("ndn:stats-updated",C),()=>window.removeEventListener("ndn:stats-updated",C)},[]);const Ie=u.useMemo(()=>xi(Ia),[We]);u.useEffect(()=>{if(!b.open)return;function C(ne){ne.key==="Escape"&&H({open:!1})}return document.addEventListener("keydown",C),()=>document.removeEventListener("keydown",C)},[b.open]);const lt=u.useMemo(()=>(Array.isArray(Ie)?Ie:Ie?Object.values(Ie):[]).map(ne=>({label:ne?.label||ne?.mode||"mode",value:ne?.played||ne?.plays||0,won:ne?.won||0})),[Ie]);async function pe(){try{const C={Authorization:`Bearer ${localStorage.getItem("authToken")}`},[ne,Ae,Ce]=await Promise.all([fetch("/api/admin/help-requests",{headers:C}),fetch("/api/admins",{headers:C}),fetch("/api/tournaments",{headers:C})]);if(ne.ok){const ze=await ne.json();_e(Array.isArray(ze)?ze:ze.requests||[])}if(Ae.ok){const ze=await Ae.json();i(Array.isArray(ze)?ze:ze.admins||[])}if(Ce.ok){const ze=await Ce.json();p(Array.isArray(ze)?ze:ze.tournaments||ze)}}catch(C){console.error("refresh failed",C)}}async function he(C){try{await fetch("/api/admins/revoke",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("authToken")}`},body:JSON.stringify({email:C})}),await pe()}catch{}}async function Oe(C,ne){if(C)try{await fetch("/api/admin/premium/grant",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("authToken")}`},body:JSON.stringify({email:C,days:ne})}),await pe()}catch{}}async function xt(C){try{await fetch("/api/admin/premium/revoke",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("authToken")}`},body:JSON.stringify({email:C})}),await pe()}catch{}}async function Rt(){if(d.trim())try{await fetch("/api/admin/announce",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("authToken")}`},body:JSON.stringify({message:d})}),c(""),await pe()}catch{}}async function hs(C){try{await fetch("/api/admin/maintenance",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("authToken")}`},body:JSON.stringify({maintenance:C})}),await pe()}catch{}}u.useEffect(()=>{if(!n)return;const C=n.addListener(Ae=>{try{if(Ae?.type==="help-typing"){const Ce=String(Ae.requestId||"");if(!Ce)return;Le(ze=>({...ze,[Ce]:{who:Ae.fromName||"someone",ts:Date.now()}}));return}if(Ae?.type==="help-request"){const Ce=Ae.request;if(!Ce||!Ce.id)return;_e(ze=>{const pt=(ze||[]).filter(ns=>String(ns.id)!==String(Ce.id));return[Ce,...pt]});return}Ae?.type==="help-request-updated"&&pe()}catch{}}),ne=setInterval(()=>{const Ae=Date.now();let Ce=!1;const ze={...Pe};for(const pt of Object.keys(ze))Ae-ze[pt].ts>3500&&(delete ze[pt],Ce=!0);Ce&&Le(ze)},1500);return()=>{try{C()}catch{}clearInterval(ne)}},[n]);async function jt(C){try{const ne={"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("authToken")}`};(await fetch(`/api/admin/help-requests/${encodeURIComponent(C)}/claim`,{method:"POST",headers:ne,body:JSON.stringify({})})).ok&&await pe()}catch{}}async function Ne(C){try{const ne={"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("authToken")}`};(await fetch(`/api/admin/help-requests/${encodeURIComponent(C)}/resolve`,{method:"POST",headers:ne,body:JSON.stringify({})})).ok&&await pe()}catch{}}async function Ht(){a&&(await fetch("/api/admins/grant",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("authToken")}`},body:JSON.stringify({email:a})}),r(""))}async function ie(){if(T.trim())try{const C={Authorization:`Bearer ${localStorage.getItem("authToken")}`},ne=await fetch(`/api/admin/users/search?q=${encodeURIComponent(T)}`,{headers:C});if(ne.ok){const Ae=await ne.json();I(Array.isArray(Ae.users)?Ae.users:[])}}catch(C){console.error("Search failed:",C)}}async function fe(C){try{await fetch("/api/admin/users/ban",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("authToken")}`},body:JSON.stringify({email:C})}),await ie()}catch(ne){console.error("Ban failed:",ne)}}async function se(C){try{await fetch("/api/admin/users/unban",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("authToken")}`},body:JSON.stringify({email:C})}),await ie()}catch(ne){console.error("Unban failed:",ne)}}async function Z(){m(!0);try{const C=new Date(M.startAt).getTime(),ne=await fetch("/api/tournaments/create",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:M.title,game:M.game,mode:M.mode,value:Number(M.value),description:M.description,startAt:C,checkinMinutes:Number(M.checkinMinutes),capacity:Number(M.capacity),requireCalibration:!!M.requireCalibration,creatorEmail:s?.email,creatorName:s?.username,requesterEmail:s?.email,official:!0,prizeType:M.prizeType,prizeAmount:Number(M.prizeAmount||0),currency:M.currency,prizeNotes:M.prizeNotes})});await pe();try{const Ae=await ne.json();Ae&&Ae.tournament&&Ae.tournament.id&&window.dispatchEvent(new CustomEvent("ndn:change-tab",{detail:{tab:"tournaments"}}))}catch{}}finally{m(!1)}}async function $e(C,ne){m(!0);try{await fetch("/api/admin/tournaments/winner",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("authToken")}`},body:JSON.stringify({tournamentId:C,winnerEmail:ne})}),await pe()}finally{m(!1)}}async function ye(C){m(!0);try{await fetch("/api/admin/tournaments/mark-paid",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("authToken")}`},body:JSON.stringify({tournamentId:C})}),await pe()}finally{m(!1)}}async function Se(C){m(!0);try{await fetch("/api/admin/tournaments/delete",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("authToken")}`},body:JSON.stringify({tournamentId:C})}),await pe()}finally{m(!1)}}async function Qe(){m(!0);try{await fetch("/api/admin/tournaments/reseed-weekly",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("authToken")}`},body:JSON.stringify({})}),await pe()}finally{m(!1)}}async function Ke(C,ne){m(!0);try{await fetch("/api/admin/wallet/withdrawals/decide",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("authToken")}`},body:JSON.stringify({id:C,approve:ne})}),await pe()}finally{m(!1)}}async function mt(C){m(!0);try{await fetch("/api/admin/matches/delete",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("authToken")}`},body:JSON.stringify({matchId:C})}),await pe()}finally{m(!1)}}async function Be(){try{const C={Authorization:`Bearer ${localStorage.getItem("authToken")}`},ne=await fetch("/api/admin/logs",{headers:C});if(ne.ok){const Ae=await ne.json();Ae?.ok&&te(Ae.logs||[])}}catch(C){console.error("Failed to fetch logs:",C)}}async function ht(){try{const C={Authorization:`Bearer ${localStorage.getItem("authToken")}`},ne=await fetch("/api/admin/system-health",{headers:C});if(ne.ok){const Ae=await ne.json();Ae?.ok&&He(Ae.health)}}catch(C){console.error("Failed to fetch system health:",C)}}async function Ye(){try{const C={Authorization:`Bearer ${localStorage.getItem("authToken")}`},ne=await fetch("/api/admin/email-copy",{headers:C});if(ne.ok){const Ae=await ne.json();Ae?.ok&&v(Ae.copy||A)}}catch{}}u.useEffect(()=>{F&&Ye()},[F]),u.useEffect(()=>{F&&(W==="general"||W==="maintenance")&&(Be(),ht())},[F,W]);async function Nt(C,ne){await fetch("/api/admin/email-copy",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("authToken")}`},body:JSON.stringify({kind:C,...ne})}),await Ye()}async function it(C,ne){try{const Ae={Authorization:`Bearer ${localStorage.getItem("authToken")}`},ze=await(await fetch(`/api/email/preview?kind=${encodeURIComponent(C)}`,{headers:Ae})).text();if(ne){const pt=window.open();if(pt){pt.document.open(),pt.document.write(ze),pt.document.close();return}}H({open:!0,kind:C,html:ze})}catch{H({open:!0,kind:C,html:'<!doctype html><html><body style="font-family:sans-serif;padding:16px">Failed to load preview.</body></html>'})}}u.useEffect(()=>{if(!b.open)return;function C(ne){ne.key==="Escape"&&H({open:!1})}return document.addEventListener("keydown",C),()=>document.removeEventListener("keydown",C)},[b.open]);function yt({kind:C,label:ne}){const Ce=A?.[C==="confirm-email"?"confirmEmail":C==="changed"?"changed":C]||{title:"",intro:"",buttonLabel:""},[ze,pt]=u.useState(Ce.title||""),[ns,Bt]=u.useState(Ce.intro||""),[Dt,as]=u.useState(Ce.buttonLabel||"");return u.useEffect(()=>{pt(Ce.title||""),Bt(Ce.intro||""),as(Ce.buttonLabel||"")},[Ce.title,Ce.intro,Ce.buttonLabel]),e.jsxs("div",{className:"p-2 rounded bg-black/20 space-y-2",children:[e.jsx("div",{className:"font-semibold",children:ne}),e.jsx("input",{className:"input w-full",placeholder:"Title (optional)",value:ze,onChange:Et=>pt(Et.target.value)}),e.jsx("textarea",{className:"input w-full",rows:2,placeholder:"Intro line (optional)",value:ns,onChange:Et=>Bt(Et.target.value)}),e.jsx("input",{className:"input w-full",placeholder:"Button label (optional)",value:Dt,onChange:Et=>as(Et.target.value)}),e.jsxs("div",{className:"flex gap-2 justify-end",children:[e.jsx("button",{className:"btn",type:"button",onClick:()=>it(C,!0),children:"Preview"}),e.jsx("button",{className:"btn",type:"button",onClick:()=>it(C),children:"Popup"}),e.jsx("button",{className:"btn",onClick:()=>Nt(C,{title:ze,intro:ns,buttonLabel:Dt}),children:"Save"})]})]})}return F?(ke.length>0&&(ke.length,ke.slice(0,6).map(C=>e.jsxs("div",{className:"p-2 rounded bg-black/10 border border-white/10 min-w-[220px]",children:[e.jsx("div",{className:"font-medium",children:C.username||"Anonymous"}),e.jsx("div",{className:"text-xs opacity-70",children:new Date(C.ts||0).toLocaleTimeString()}),e.jsx("div",{className:"text-sm truncate mt-1",children:C.message}),e.jsxs("div",{className:"mt-2 flex gap-2",children:[C.status==="open"?e.jsx("button",{className:"btn",onClick:()=>jt(C.id),children:"Claim"}):e.jsxs("span",{className:"text-xs opacity-70",children:[C.status," by ",C.claimedBy||"â€”"]}),e.jsx("button",{className:"btn",onClick:()=>Ee(C),children:"Chat"})]})]},C.id))),e.jsxs("div",{className:"space-y-4 ndn-game-shell",children:[e.jsxs("div",{className:"p-2 rounded-xl bg-white/10 border border-white/10 flex items-center justify-between gap-2 flex-wrap",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx("span",{className:"font-semibold",children:"Connection Status"}),n?e.jsxs("span",{className:"inline-flex items-center gap-2",children:[e.jsx(Ql,{status:n.status,title:`WebSocket: ${n.status}`}),e.jsxs("span",{className:"text-xs opacity-80",children:["WS: ",n.status]})]}):e.jsx("span",{className:"text-xs opacity-70",children:"WS: unavailable"})]}),e.jsxs("div",{className:"shrink-0 flex items-center gap-2",children:[e.jsx(Zl,{}),n&&n.reconnect&&e.jsx("button",{onClick:()=>n.reconnect(),className:"ml-1 rounded-md bg-neutral-700/60 hover:bg-neutral-600/70 px-2.5 py-1 text-xs border border-white/10",title:"Force close and recreate the WebSocket connection",children:"Recreate WS"})]})]}),F&&e.jsx(Xa,{tabs:[{key:"general",label:"General"},{key:"maintenance",label:"Maintenance"},{key:"premium",label:"Premium"},{key:"helpdesk",label:"Help Desk"}],active:W,onChange:C=>R(C),className:"mb-4"}),W==="general"&&e.jsxs(e.Fragment,{children:[F&&e.jsxs("div",{className:"card",children:[e.jsx("h3",{className:"text-xl font-semibold mb-2",children:"Game Usage"}),e.jsx("div",{className:"text-sm opacity-80 mb-2",children:"Bar height shows total plays per mode. Wins are listed under each label. This helps decide which modes to keep or iterate on."}),e.jsxs("div",{className:"rounded-xl border border-indigo-500/40 bg-indigo-500/10 p-3",children:[e.jsx(ui,{data:lt.map(C=>({label:C.label,value:C.value}))}),e.jsx("div",{className:"mt-2 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-2 text-[11px] opacity-80",children:lt.map((C,ne)=>e.jsxs("div",{className:"flex items-center justify-between px-2 py-1 rounded-md bg-white/5 border border-white/10",children:[e.jsx("span",{className:"truncate mr-2",children:C.label}),e.jsxs("span",{className:"whitespace-nowrap",children:["Played ",C.value," Â· Won ",C.won]})]},ne))})]})]}),e.jsxs("div",{className:"card",children:[e.jsx("h2",{className:"text-2xl font-bold mb-2",children:"Admin Control"}),e.jsx("div",{className:"text-sm opacity-80 mb-3",children:"Grant or revoke Admin to trusted users. Only the owner can perform these actions."}),e.jsxs("div",{className:"flex gap-2 mb-3",children:[e.jsx("input",{className:"input flex-1",placeholder:"user@example.com",value:a,onChange:C=>r(C.target.value)}),e.jsx("button",{className:"btn",disabled:h,onClick:Ht,children:"Grant"}),e.jsx("button",{className:"btn bg-rose-600 hover:bg-rose-700",disabled:h,onClick:()=>he(a),children:"Revoke"})]}),e.jsx("div",{className:"text-sm opacity-80 mb-2",children:"Current Admins:"}),e.jsx("div",{className:"flex flex-wrap gap-2 mb-4",children:t.map(C=>e.jsx("div",{className:"px-2 py-1 rounded bg-indigo-600/20 border border-indigo-500/40 text-sm",children:C},C))}),e.jsx("hr",{className:"border-indigo-500/20 my-4"}),e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"Premium Access Control"}),e.jsx("div",{className:"text-sm opacity-80 mb-3",children:"Grant or revoke Premium subscription access to users (grants 30 days)."}),e.jsxs("div",{className:"flex gap-2 mb-3",children:[e.jsx("input",{className:"input flex-1",placeholder:"user@example.com",value:a,onChange:C=>r(C.target.value)}),e.jsx("button",{className:"btn bg-emerald-600 hover:bg-emerald-700",disabled:h||!a.trim(),onClick:()=>Oe(a,30),children:"Grant Premium"}),e.jsx("button",{className:"btn bg-rose-600 hover:bg-rose-700",disabled:h,onClick:()=>xt(a),children:"Revoke Premium"})]}),e.jsx("div",{className:"text-sm opacity-80",children:"Premium grants provide 30 days of unlimited access to all features."})]}),e.jsxs("div",{className:"card",children:[e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"Tournament Premium Winners"}),e.jsx("div",{className:"text-sm opacity-80 mb-3",children:"Users who have won premium prizes in tournaments and need access granted."}),e.jsxs("div",{className:"space-y-2",children:[x.filter(C=>C.status==="completed"&&C.winnerEmail&&C.prizeType==="premium").map(C=>{const ne=D.find(Ce=>Ce.email===C.winnerEmail),Ae=ne&&!ne.expired;return e.jsxs("div",{className:"p-3 rounded bg-black/20 text-sm",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("div",{className:"font-semibold",children:C.title}),e.jsx("div",{className:"text-xs opacity-70",children:new Date(C.startAt).toLocaleDateString()})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:C.winnerEmail}),e.jsxs("div",{className:"text-xs opacity-70",children:["Prize: ",C.prizeAmount," month",C.prizeAmount>1?"s":""," PREMIUM"]})]}),e.jsx("div",{className:"flex items-center gap-2",children:Ae?e.jsx("span",{className:"px-2 py-1 rounded bg-emerald-600 text-xs",children:"Access Granted"}):e.jsx("button",{className:"btn bg-emerald-600 hover:bg-emerald-700 text-xs",disabled:h,onClick:()=>Oe(C.winnerEmail,C.prizeAmount*30*24*60*60*1e3),children:"Grant Access"})})]}),e.jsxs("div",{className:"card",children:[e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"Help Desk"}),e.jsx("div",{className:"text-sm opacity-80 mb-3",children:"Incoming requests from users who asked to speak with an admin. Claim to take over the chat."}),ke.length===0?e.jsx("div",{className:"text-sm opacity-70",children:"No open requests."}):e.jsx("div",{className:"space-y-2",children:ke.map(Ce=>e.jsxs("div",{className:"p-2 rounded bg-black/10 border border-white/10 flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:Ce.username||"Anonymous"}),e.jsx("div",{className:"text-xs opacity-70",children:new Date(Ce.ts||0).toLocaleString()}),e.jsx("div",{className:"text-sm mt-1",children:Ce.message}),Pe[Ce.id]&&e.jsxs("div",{className:"text-xs text-amber-300 mt-1",children:[Pe[Ce.id].who," typing..."]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[Ce.status==="open"?e.jsx("button",{className:"btn",onClick:()=>jt(Ce.id),children:"Claim"}):e.jsxs("span",{className:"text-xs opacity-70",children:[Ce.status," by ",Ce.claimedBy||"â€”"]}),e.jsx("button",{className:"btn btn-ghost",onClick:()=>Ne(Ce.id),children:"Resolve"}),e.jsx("button",{className:"btn",onClick:()=>Ee(Ce),children:"Chat"})]})]},Ce.id))})]})]},C.id)}),x.filter(C=>C.status==="completed"&&C.winnerEmail&&C.prizeType==="premium").length===0&&e.jsx("div",{className:"text-center py-4 text-sm opacity-60",children:"No completed premium tournaments."})]})]}),e.jsxs("div",{className:"card",children:[e.jsx("h3",{className:"text-xl font-semibold mb-2",children:"Announcements"}),e.jsx("div",{className:"text-sm opacity-80 mb-2",children:"Send a message to all users. This will appear as a toast notification."}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{className:"input flex-1",placeholder:"Announcement message...",value:d,onChange:C=>c(C.target.value)}),e.jsx("button",{className:"btn",disabled:h||!d.trim(),onClick:Rt,children:"Send"})]})]}),e.jsxs("div",{className:"card",children:[e.jsx("h3",{className:"text-xl font-semibold mb-2",children:"User Search"}),e.jsx("div",{className:"text-sm opacity-80 mb-2",children:"Search for users by email or name."}),e.jsxs("div",{className:"flex gap-2 mb-3",children:[e.jsx("input",{className:"input flex-1",placeholder:"Search users...",value:T,onChange:C=>S(C.target.value)}),e.jsx("button",{className:"btn",disabled:h,onClick:ie,children:"Search"})]}),E.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-sm opacity-80 mb-2",children:"Results:"}),E.map(C=>e.jsx("div",{className:"p-2 rounded bg-black/20 text-sm flex items-center justify-between",children:e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold",children:C.name||"No name"}),e.jsx("div",{className:"opacity-70",children:C.email}),e.jsxs("div",{className:"opacity-60 text-xs",children:["Joined ",new Date(C.createdAt).toLocaleDateString()]})]})},C.email))]})]}),F&&e.jsxs("div",{className:"card",children:[e.jsx("h3",{className:"text-xl font-semibold mb-3",children:"Tournaments Management"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold mb-2",children:"Create Official"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("input",{className:"input w-full",placeholder:"Title",value:M.title,onChange:C=>P(ne=>({...ne,title:C.target.value}))}),e.jsxs("div",{className:"grid grid-cols-3 gap-2",children:[e.jsx("select",{className:"input",value:M.game,onChange:C=>P(ne=>({...ne,game:C.target.value})),children:["X01","Around the Clock","Cricket","Halve It","Shanghai","High-Low"].map(C=>e.jsx("option",{value:C,children:C},C))}),e.jsxs("select",{className:"input",value:M.mode,onChange:C=>P(ne=>({...ne,mode:C.target.value})),children:[e.jsx("option",{value:"bestof",children:"Best of"}),e.jsx("option",{value:"firstto",children:"First to"})]}),e.jsx("input",{className:"input",type:"number",min:1,value:M.value,onChange:C=>P(ne=>({...ne,value:Number(C.target.value)}))})]}),e.jsx("textarea",{className:"input w-full",rows:2,placeholder:"Description",value:M.description,onChange:C=>P(ne=>({...ne,description:C.target.value}))}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx("input",{className:"input",type:"datetime-local",value:M.startAt,onChange:C=>P(ne=>({...ne,startAt:C.target.value}))}),e.jsx("input",{className:"input",type:"number",min:0,value:M.checkinMinutes,onChange:C=>P(ne=>({...ne,checkinMinutes:Number(C.target.value)}))})]}),e.jsx("input",{className:"input w-full",type:"number",min:6,max:64,value:M.capacity,onChange:C=>P(ne=>({...ne,capacity:Number(C.target.value)}))}),e.jsxs("div",{className:"grid grid-cols-3 gap-2 items-center",children:[e.jsxs("select",{className:"input",value:M.prizeType,onChange:C=>{const ne=C.target.value;P(Ae=>({...Ae,prizeType:ne,prizeAmount:ne==="premium"?3:0}))},children:[e.jsx("option",{value:"premium",children:"PREMIUM"}),e.jsx("option",{value:"cash",children:"Cash"})]}),M.prizeType==="premium"?e.jsxs("select",{className:"input",value:M.prizeAmount,onChange:C=>P(ne=>({...ne,prizeAmount:Number(C.target.value)})),children:[e.jsx("option",{value:1,children:"1 month"}),e.jsx("option",{value:3,children:"3 months"})]}):e.jsx("input",{className:"input",type:"number",min:0,value:M.prizeAmount,onChange:C=>P(ne=>({...ne,prizeAmount:Number(C.target.value)}))}),e.jsxs("select",{className:"input",disabled:M.prizeType!=="cash",value:M.currency,onChange:C=>P(ne=>({...ne,currency:C.target.value})),children:[e.jsx("option",{value:"GBP",children:"GBP"}),e.jsx("option",{value:"USD",children:"USD"}),e.jsx("option",{value:"EUR",children:"EUR"}),e.jsx("option",{value:"CAD",children:"CAD"}),e.jsx("option",{value:"AUD",children:"AUD"})]})]}),e.jsx("input",{className:"input w-full",placeholder:"Prize notes (optional)",value:M.prizeNotes,onChange:C=>P(ne=>({...ne,prizeNotes:C.target.value}))}),e.jsx("div",{className:"flex justify-end",children:e.jsx("button",{className:"btn",disabled:h,onClick:Z,children:"Create"})})]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold mb-2",children:"Existing"}),e.jsxs("ul",{className:"space-y-2",children:[x.map(C=>e.jsxs("li",{className:"p-2 rounded bg-black/20 text-sm",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"font-semibold",children:C.title}),e.jsx("div",{className:"opacity-70",children:C.status})]}),e.jsxs("div",{className:"opacity-80",children:[C.game," Â· ",C.mode==="firstto"?"FT":"BO"," ",C.value," Â· ",new Date(C.startAt).toLocaleString()," Â· ",C.capacity," cap"]}),C.prize&&e.jsxs("div",{className:"text-xs mt-1",children:["Prize: ",C.prizeType==="cash"&&C.prizeAmount?`${C.currency||"USD"} ${C.prizeAmount}`:`${C.prizeAmount||3} month${(C.prizeAmount||3)>1?"s":""} PREMIUM`," ",C.prizeType==="cash"&&C.status==="completed"&&C.payoutStatus&&e.jsx("span",{className:`ml-2 px-1.5 py-0.5 rounded ${C.payoutStatus==="paid"?"bg-emerald-600":"bg-amber-600"}`,children:C.payoutStatus})]}),e.jsxs("div",{className:"mt-2 flex flex-wrap gap-2",children:[e.jsx("button",{className:"btn",disabled:h||C.status!=="scheduled",onClick:()=>$e(C.id,prompt("Winner email?")||""),children:"Set Winner"}),C.prizeType==="cash"&&C.status==="completed"&&C.payoutStatus!=="paid"&&e.jsx("button",{className:"btn",disabled:h,onClick:()=>ye(C.id),children:"Mark Paid"})]})]},C.id)),x.length===0&&e.jsx("li",{className:"opacity-60",children:"No tournaments."})]}),e.jsx("div",{className:"mt-3 flex justify-end",children:e.jsx("button",{className:"btn",disabled:h,onClick:Qe,children:"Reseed Weekly Giveaway"})})]})]})]}),F&&e.jsxs("div",{className:"card",children:[e.jsx("h3",{className:"text-xl font-semibold mb-3",children:"Email Templates"}),e.jsx("div",{className:"text-sm opacity-80 mb-2",children:"Customize titles, intro lines, and button text. Previews open in a new tab or as a popup."}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[e.jsx(yt,{kind:"reset",label:"Password reset"}),e.jsx(yt,{kind:"reminder",label:"Password reset reminder"}),e.jsx(yt,{kind:"confirm-email",label:"Confirm new email"}),e.jsx(yt,{kind:"changed",label:"Password changed notice"})]})]})]}),W==="maintenance"&&F&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"card",children:[e.jsx("h3",{className:"text-xl font-semibold mb-2",children:"User Management"}),e.jsx("div",{className:"text-sm opacity-80 mb-2",children:"Ban or unban users. Use with caution."}),e.jsxs("div",{className:"flex gap-2 mb-3",children:[e.jsx("input",{className:"input flex-1",placeholder:"user@example.com",value:T,onChange:C=>S(C.target.value)}),e.jsx("button",{className:"btn",disabled:h,onClick:ie,children:"Search"})]}),E.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-sm opacity-80 mb-2",children:"Results:"}),E.map(C=>e.jsxs("div",{className:"p-2 rounded bg-black/20 text-sm flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold",children:C.name||"No name"}),e.jsx("div",{className:"opacity-70",children:C.email}),e.jsxs("div",{className:"opacity-60 text-xs",children:["Joined ",new Date(C.createdAt).toLocaleDateString()]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{className:"btn bg-red-600 hover:bg-red-700 text-xs",onClick:()=>fe(C.email),children:"Ban"}),e.jsx("button",{className:"btn bg-green-600 hover:bg-green-700 text-xs",onClick:()=>se(C.email),children:"Unban"})]})]},C.email))]})]}),e.jsxs("div",{className:"card",children:[e.jsx("h3",{className:"text-xl font-semibold mb-3",children:"Withdrawals"}),e.jsxs("ul",{className:"space-y-2",children:[g.map(C=>e.jsxs("li",{className:"p-2 rounded bg-black/20 text-sm flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-mono text-xs",children:C.id}),e.jsxs("div",{children:[C.email," Â· ",C.currency," ",(C.amountCents/100).toFixed(2)]}),e.jsxs("div",{className:"opacity-70",children:[C.status," Â· ",new Date(C.requestedAt).toLocaleString()]})]}),e.jsx("div",{className:"flex gap-2",children:C.status==="pending"&&e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"btn bg-emerald-600 hover:bg-emerald-700",disabled:h,onClick:()=>Ke(C.id,!0),children:"Approve"}),e.jsx("button",{className:"btn bg-rose-600 hover:bg-rose-700",disabled:h,onClick:()=>Ke(C.id,!1),children:"Reject"})]})})]},C.id)),g.length===0&&e.jsx("li",{className:"opacity-60",children:"No withdrawal requests."})]})]}),e.jsxs("div",{className:"card",children:[e.jsx("h3",{className:"text-xl font-semibold mb-3",children:"System Health"}),e.jsx("div",{className:"text-sm opacity-80 mb-3",children:"Current status of system components and services."}),oe?e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{children:"Database"}),e.jsx("span",{className:`px-2 py-1 rounded text-xs ${oe.database?"bg-emerald-600":"bg-red-600"}`,children:oe.database?"Ready":"Down"})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{children:"WebSocket"}),e.jsx("span",{className:`px-2 py-1 rounded text-xs ${oe.websocket?"bg-emerald-600":"bg-red-600"}`,children:oe.websocket?"Ready":"Down"})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{children:"HTTPS"}),e.jsx("span",{className:`px-2 py-1 rounded text-xs ${oe.https?"bg-emerald-600":"bg-amber-600"}`,children:oe.https?"Enabled":"HTTP Only"})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{children:"Maintenance Mode"}),e.jsx("span",{className:`px-2 py-1 rounded text-xs ${oe.maintenance?"bg-red-600":"bg-emerald-600"}`,children:oe.maintenance?"Active":"Normal"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"text-sm",children:[e.jsx("span",{className:"font-semibold",children:"Uptime:"})," ",Math.floor(oe.uptime/3600),"h ",Math.floor(oe.uptime%3600/60),"m"]}),e.jsxs("div",{className:"text-sm",children:[e.jsx("span",{className:"font-semibold",children:"Memory:"})," ",Math.round(oe.memory.heapUsed/1024/1024),"MB used"]}),e.jsxs("div",{className:"text-sm",children:[e.jsx("span",{className:"font-semibold",children:"Version:"})," ",oe.version]}),e.jsx("div",{className:"flex gap-2 mt-3",children:e.jsx("button",{className:"btn",onClick:ht,children:"Refresh"})})]})]}):e.jsxs("div",{className:"text-center py-4",children:[e.jsx("div",{className:"text-sm opacity-60 mb-2",children:"Loading system health..."}),e.jsx("button",{className:"btn",onClick:ht,children:"Load Health Status"})]})]}),e.jsxs("div",{className:"card",children:[e.jsx("h3",{className:"text-xl font-semibold mb-3",children:"User Reports"}),e.jsxs("ul",{className:"space-y-2",children:[me.map(C=>e.jsx("li",{className:"p-2 rounded bg-black/20 text-sm",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-mono text-xs",children:C.id}),e.jsxs("div",{children:[e.jsx("span",{className:"font-semibold",children:C.reporter})," â†’ ",e.jsx("span",{className:"font-semibold",children:C.offender})," Â· ",new Date(C.ts).toLocaleString()]}),e.jsxs("div",{className:"opacity-80",children:["Reason: ",C.reason]}),C.messageId&&e.jsxs("div",{className:"opacity-60 text-xs",children:["Message ID: ",C.messageId]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("span",{className:`px-2 py-0.5 rounded text-xs ${C.status==="open"?"bg-amber-600":"bg-emerald-600"}`,children:C.status}),C.status==="open"&&e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"btn bg-emerald-600 hover:bg-emerald-700",disabled:h,onClick:async()=>{await fetch("/api/admin/reports/resolve",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("authToken")}`},body:JSON.stringify({id:C.id,action:"resolved"})}),await pe()},children:"Resolve"}),e.jsx("button",{className:"btn bg-rose-600 hover:bg-rose-700",disabled:h,onClick:async()=>{const ne=prompt("Enter notes for action taken (e.g., warning, block):")||"";await fetch("/api/admin/reports/resolve",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("authToken")}`},body:JSON.stringify({id:C.id,action:"actioned",notes:ne})}),await pe()},children:"Action"})]})]})]})},C.id)),me.length===0&&e.jsx("li",{className:"opacity-60",children:"No reports."})]})]}),e.jsxs("div",{className:"card",children:[e.jsx("h3",{className:"text-xl font-semibold mb-3",children:"System Health"}),e.jsx("div",{className:"text-sm opacity-80 mb-3",children:"Current status of system components and services."}),oe?e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{children:"Database"}),e.jsx("span",{className:`px-2 py-1 rounded text-xs ${oe.database?"bg-emerald-600":"bg-red-600"}`,children:oe.database?"Ready":"Down"})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{children:"WebSocket"}),e.jsx("span",{className:`px-2 py-1 rounded text-xs ${oe.websocket?"bg-emerald-600":"bg-red-600"}`,children:oe.websocket?"Ready":"Down"})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{children:"HTTPS"}),e.jsx("span",{className:`px-2 py-1 rounded text-xs ${oe.https?"bg-emerald-600":"bg-amber-600"}`,children:oe.https?"Enabled":"HTTP Only"})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{children:"Maintenance Mode"}),e.jsx("span",{className:`px-2 py-1 rounded text-xs ${oe.maintenance?"bg-red-600":"bg-emerald-600"}`,children:oe.maintenance?"Active":"Normal"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"text-sm",children:[e.jsx("span",{className:"font-semibold",children:"Uptime:"})," ",Math.floor(oe.uptime/3600),"h ",Math.floor(oe.uptime%3600/60),"m"]}),e.jsxs("div",{className:"text-sm",children:[e.jsx("span",{className:"font-semibold",children:"Memory:"})," ",Math.round(oe.memory.heapUsed/1024/1024),"MB used"]}),e.jsxs("div",{className:"text-sm",children:[e.jsx("span",{className:"font-semibold",children:"Version:"})," ",oe.version]}),e.jsx("div",{className:"flex gap-2 mt-3",children:e.jsx("button",{className:"btn",onClick:ht,children:"Refresh"})})]})]}):e.jsxs("div",{className:"text-center py-4",children:[e.jsx("div",{className:"text-sm opacity-60 mb-2",children:"Loading system health..."}),e.jsx("button",{className:"btn",onClick:ht,children:"Load Health Status"})]})]}),e.jsxs("div",{className:"card",children:[e.jsx("h3",{className:"text-xl font-semibold mb-3",children:"Open Matches"}),e.jsxs("ul",{className:"space-y-1",children:[(l?.matches||[]).map(C=>e.jsxs("li",{className:"flex items-center justify-between p-2 rounded bg-black/20 text-sm",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"font-mono text-xs",children:C.id}),e.jsx("span",{className:"opacity-80",children:C.creatorName}),e.jsxs("span",{className:"opacity-60",children:[C.game," ",C.mode==="firstto"?"FT":"BO"," ",C.value," ",C.game==="X01"?`/${C.startingScore}`:""]})]}),e.jsx("button",{className:"btn bg-rose-600 hover:bg-rose-700",disabled:h,onClick:()=>mt(C.id),children:"Remove"})]},C.id)),(!l?.matches||l.matches.length===0)&&e.jsx("li",{className:"text-sm opacity-60",children:"No open matches."})]})]}),e.jsxs("div",{className:"card",children:[e.jsx("h3",{className:"text-xl font-semibold mb-3",children:"Dangerous Operations"}),e.jsx("div",{className:"text-sm opacity-80 mb-3 text-red-400",children:"âš ï¸ These operations can cause data loss or service disruption. Use with extreme caution."}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold mb-2 text-red-400",children:"Tournament Deletion"}),e.jsxs("ul",{className:"space-y-2",children:[x.map(C=>e.jsxs("li",{className:"p-2 rounded bg-red-900/20 border border-red-500/40 text-sm",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"font-semibold",children:C.title}),e.jsx("div",{className:"opacity-70",children:C.status})]}),e.jsxs("div",{className:"opacity-80",children:[C.game," Â· ",C.mode==="firstto"?"FT":"BO"," ",C.value]}),e.jsx("div",{className:"mt-2",children:e.jsx("button",{className:"btn bg-red-600 hover:bg-red-700 text-xs",disabled:h,onClick:()=>Se(C.id),children:"Delete Tournament"})})]},C.id)),x.length===0&&e.jsx("li",{className:"opacity-60",children:"No tournaments."})]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold mb-2 text-red-400",children:"System Maintenance"}),e.jsx("div",{className:"space-y-2",children:e.jsxs("div",{className:"p-3 rounded bg-red-900/20 border border-red-500/40",children:[e.jsx("div",{className:"font-semibold text-red-400 mb-2",children:"Maintenance Mode"}),e.jsx("div",{className:"text-sm opacity-80 mb-3",children:"Put the entire site into maintenance mode. Users won't be able to access games or create matches."}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:`px-2 py-1 rounded text-xs ${l?.maintenance?"bg-red-600":"bg-green-600"}`,children:l?.maintenance?"MAINTENANCE ACTIVE":"NORMAL OPERATION"}),e.jsx("button",{className:`btn ${l?.maintenance?"bg-green-600 hover:bg-green-700":"bg-red-600 hover:bg-red-700"}`,disabled:h,onClick:()=>hs(!l?.maintenance),children:l?.maintenance?"Disable":"Enable"})]})]})})]})]})]}),ve&&e.jsx(ec,{request:ve,user:{email:s?.email,username:s?.username,isAdmin:!0},onClose:()=>Ee(null)})]}),W==="premium"&&F&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"card",children:[e.jsx("h3",{className:"text-xl font-semibold mb-2",children:"Premium Subscription Grants"}),e.jsx("div",{className:"text-sm opacity-80 mb-3",children:"Grant or revoke premium subscriptions for users (grants 30 days)."}),e.jsxs("div",{className:"flex gap-2 mb-3",children:[e.jsx("input",{className:"input flex-1",placeholder:"user@example.com",value:a,onChange:C=>r(C.target.value)}),e.jsx("button",{className:"btn",disabled:h||!a.trim(),onClick:()=>Oe(a,30),children:"Grant"}),e.jsx("button",{className:"btn bg-rose-600 hover:bg-rose-700",disabled:h,onClick:()=>xt(a),children:"Revoke"})]}),e.jsx("div",{className:"text-sm opacity-80 mb-2",children:"Premium users get 30 days of access to all features."})]}),e.jsxs("div",{className:"card",children:[e.jsx("h3",{className:"text-xl font-semibold mb-2",children:"Premium Winners"}),e.jsx("div",{className:"text-sm opacity-80 mb-2",children:"Users who have won premium through tournaments."}),e.jsxs("div",{className:"space-y-2",children:[D.map(C=>e.jsxs("div",{className:"p-2 rounded bg-black/20 text-sm flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold",children:C.name||"No name"}),e.jsx("div",{className:"opacity-70",children:C.email}),e.jsxs("div",{className:"opacity-60 text-xs",children:["Expires ",new Date(C.expiresAt).toLocaleDateString()]})]}),e.jsx("div",{className:"flex gap-2",children:C.expired?e.jsx("span",{className:"px-2 py-1 rounded bg-amber-600 text-xs",children:"Premium Expired"}):e.jsx("span",{className:"px-2 py-1 rounded bg-emerald-600 text-xs",children:"Premium Active"})})]},C.email)),D.length===0&&e.jsx("div",{className:"opacity-60",children:"No premium winners."})]})]})]}),W==="helpdesk"&&F&&e.jsx(e.Fragment,{children:e.jsxs("div",{className:"card",children:[e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"Helpdesk Requests"}),e.jsx("div",{className:"text-sm opacity-80 mb-3",children:"Incoming requests from users who asked to speak with an admin. Claim to take over the chat."}),ke.length===0?e.jsx("div",{className:"text-sm opacity-70",children:"No open requests."}):e.jsx("div",{className:"space-y-2",children:ke.map(C=>e.jsxs("div",{className:"p-2 rounded bg-black/10 border border-white/10 flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:C.username||"Anonymous"}),e.jsx("div",{className:"text-xs opacity-70",children:new Date(C.ts||0).toLocaleString()}),e.jsx("div",{className:"text-sm mt-1",children:C.message}),Pe[C.id]&&e.jsxs("div",{className:"text-xs text-amber-300 mt-1",children:[Pe[C.id].who," typing..."]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[C.status==="open"?e.jsx("button",{className:"btn",onClick:()=>jt(C.id),children:"Claim"}):e.jsxs("span",{className:"text-xs opacity-70",children:[C.status," by ",C.claimedBy||"â€”"]}),e.jsx("button",{className:"btn btn-ghost",onClick:()=>Ne(C.id),children:"Resolve"}),e.jsx("button",{className:"btn",onClick:()=>Ee(C),children:"Chat"})]})]},C.id))})]})}),b.open&&e.jsxs("div",{className:"fixed inset-0 z-[1000]",onClick:()=>H({open:!1}),children:[e.jsx("div",{className:"absolute inset-0 bg-black/70 backdrop-blur-sm"}),e.jsx("div",{className:"absolute inset-0 p-4 md:p-8 overflow-auto flex items-start md:items-center justify-center",children:e.jsxs("div",{className:"w-full max-w-3xl bg-[#0b1020] rounded-2xl border border-indigo-500/40 shadow-2xl",onClick:C=>C.stopPropagation(),children:[e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b border-indigo-500/20",children:[e.jsxs("div",{className:"font-semibold",children:["Preview: ",b.kind]}),e.jsx("button",{className:"btn",onClick:()=>H({open:!1}),children:"Close"})]}),e.jsx("div",{className:"p-0 bg-black/30",children:e.jsx("iframe",{title:"Email Preview",style:{width:"100%",height:"70vh",border:"0",background:"transparent"},srcDoc:b.html||""})}),e.jsx("div",{className:"px-4 py-3 border-t border-indigo-500/20 text-xs opacity-70",children:"Click outside this panel or press Esc to close."})]})})]})]})):e.jsxs("div",{className:"card",children:[e.jsx("h2",{className:"text-2xl font-bold mb-2",children:"Admin"}),e.jsx("div",{className:"text-sm opacity-80",children:"You donâ€™t have permission to manage admins."})]})}function Vu({onClose:s}){const[n,t]=u.useState([]),[i,a]=u.useState(!1),r=zn();async function l(){a(!0);try{const c=localStorage.getItem("authToken");if(!c){r?.("You must be signed in to view highlights",{type:"error"}),a(!1);return}const h=await Pt("/api/user/highlights",{method:"GET",headers:{Authorization:`Bearer ${c}`}});if(!h.ok){const x=await h.json().catch(()=>({}));r?.(`Failed to fetch highlights: ${x.error||h.statusText}`,{type:"error"}),a(!1);return}const m=await h.json();t(m.highlights||[])}catch{r?.("Failed to fetch highlights",{type:"error"})}finally{a(!1)}}u.useEffect(()=>{l()},[]);function o(c){try{const h=new Blob([JSON.stringify(c.data||c,null,2)],{type:"application/json"}),m=URL.createObjectURL(h),x=document.createElement("a"),p=`ndn-highlight-${c.data&&c.data.player||"player"}-${c.ts||Date.now()}.json`;x.href=m,x.download=p,document.body.appendChild(x),x.click(),x.remove(),URL.revokeObjectURL(m),r?.("Downloaded highlight",{type:"success"})}catch{r?.("Download failed",{type:"error"})}}async function d(c){try{const h=localStorage.getItem("authToken");if(!h){r?.("You must be signed in to delete highlights",{type:"error"});return}const m=await Pt(`/api/user/highlights/${c.id}`,{method:"DELETE",headers:{Authorization:`Bearer ${h}`}});if(!m.ok){const x=await m.json().catch(()=>({}));r?.(`Delete failed: ${x.error||m.statusText}`,{type:"error"});return}r?.("Highlight deleted",{type:"success"}),t(x=>x.filter(p=>String(p.id)!==String(c.id)))}catch{r?.("Delete failed",{type:"error"})}}return e.jsx(zs,{storageKey:"ndn:modal:highlights",className:"w-[640px]",defaultWidth:640,defaultHeight:420,minWidth:420,minHeight:220,initialFitHeight:!0,children:e.jsxs("div",{className:"p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("div",{className:"text-lg font-semibold",children:"Saved Highlights"}),e.jsx("div",{children:e.jsx("button",{className:"btn btn-ghost",onClick:()=>{s?.()},children:"Close"})})]}),i?e.jsx("div",{className:"text-sm",children:"Loading..."}):n.length===0?e.jsx("div",{className:"text-sm opacity-70",children:"No highlights saved to your account."}):e.jsx("div",{className:"space-y-2 max-h-[48vh] overflow-y:auto",children:n.map(c=>e.jsxs("div",{className:"p-2 rounded border bg-black/5 flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"text-sm",children:[e.jsx("strong",{children:c.data&&c.data.player||"Player"})," â€” Score: ",c.data&&c.data.score||"N/A"," â€” Darts: ",c.data&&c.data.darts||"N/A"]}),e.jsx("div",{className:"text-xs opacity-70",children:new Date(c.ts||0).toLocaleString()})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{className:"btn px-2 py-0.5 text-sm",onClick:()=>o(c),children:"Download"}),e.jsx("button",{className:"btn btn-error px-2 py-0.5 text-sm",onClick:()=>d(c),children:"Delete"})]})]},c.id))})]})})}function Gu({user:s}){const{favoriteDouble:n,callerEnabled:t,callerVoice:i,callerVolume:a,speakCheckoutOnly:r,avgMode:l,autoStartOffline:o,rememberLastOffline:d,reducedMotion:c,compactHeader:h,allowSpectate:m,cameraScale:x,cameraAspect:p,cameraFitMode:g,autoscoreProvider:w,autoscoreWsUrl:T,calibrationGuide:S,preferredCameraId:E,preferredCameraLabel:I,cameraEnabled:M,offlineLayout:P,textSize:A,boxSize:v,setFavoriteDouble:b,setCallerEnabled:H,setCallerVoice:W,setCallerVolume:R,setSpeakCheckoutOnly:F,setAvgMode:D,setAutoStartOffline:Q,setRememberLastOffline:me,setReducedMotion:ue,setCompactHeader:ke,setAllowSpectate:_e,setCameraScale:Pe,setCameraAspect:Le,setCameraFitMode:ve,setAutoscoreProvider:Ee,setAutoscoreWsUrl:$,setCalibrationGuide:te,setPreferredCamera:oe,setCameraEnabled:He,setOfflineLayout:We,setTextSize:we,setBoxSize:Ie,dartTimerEnabled:lt,dartTimerSeconds:pe,setDartTimerEnabled:he,setDartTimerSeconds:Oe,x01DoubleIn:xt,setX01DoubleIn:Rt}=Ft(),[hs,jt]=u.useState([{key:"first180",label:"First 180",unlocked:!1,icon:"ðŸŽ¯",desc:"Score 180 in a match."},{key:"hundredGames",label:"100 Games Played",unlocked:!1,icon:"ðŸ…",desc:"Play 100 games."},{key:"tournamentWin",label:"Tournament Winner",unlocked:!1,icon:"ðŸ¥‡",desc:"Win a tournament."},{key:"bestLeg",label:"Best Leg",unlocked:!1,icon:"âš¡",desc:"Finish a leg in 12 darts or less."},{key:"comeback",label:"Comeback",unlocked:!1,icon:"ðŸ”¥",desc:"Win after trailing by 3 legs."}]);u.useEffect(()=>{const z=s?.username||"";z&&jt(be=>be.map(wt=>({...wt,unlocked:!!localStorage.getItem(`ndn:achieve:${wt.key}:${z}`)})))},[s?.username]);const[Ne,Ht]=u.useState(!1),[ie,fe]=u.useState(!1),[se,Z]=u.useState(""),[$e,ye]=u.useState(""),[Se,Qe]=u.useState(""),[Ke,mt]=u.useState(""),[Be,ht]=u.useState(""),[Ye,Nt]=u.useState(!0),[it,yt]=u.useState(null),[C,ne]=u.useState([{text:"Hi! I'm your Nine Dart Nation assistant. How can I help you today?",isUser:!1}]),[Ae,Ce]=u.useState("");u.useEffect(()=>{const z=s?.username||"";if(z)try{Z(localStorage.getItem(`ndn:bio:favPlayer:${z}`)||""),ye(localStorage.getItem(`ndn:bio:favTeam:${z}`)||""),Qe(localStorage.getItem(`ndn:bio:favDarts:${z}`)||""),mt(localStorage.getItem(`ndn:bio:bio:${z}`)||""),ht(localStorage.getItem(`ndn:bio:profilePhoto:${z}`)||""),Nt(localStorage.getItem(`ndn:settings:allowAnalytics:${z}`)!=="false")}catch{}},[s?.username]),u.useEffect(()=>{s?.email&&Pt(`/api/subscription?email=${encodeURIComponent(s.email)}`).then(z=>z.json()).then(yt).catch(()=>{})},[s?.email]);const ze=()=>{const z=s?.username||"";if(z)try{localStorage.setItem(`ndn:bio:favPlayer:${z}`,se),localStorage.setItem(`ndn:bio:favTeam:${z}`,$e),localStorage.setItem(`ndn:bio:favDarts:${z}`,Se),localStorage.setItem(`ndn:bio:bio:${z}`,Ke),localStorage.setItem(`ndn:bio:profilePhoto:${z}`,Be);try{window.dispatchEvent(new CustomEvent("ndn:avatar-updated",{detail:{username:z,avatar:Be}}))}catch{}localStorage.setItem(`ndn:settings:allowAnalytics:${z}`,Ye.toString()),Ht(!1)}catch{}},pt=z=>{try{window.dispatchEvent(new CustomEvent("ndn:change-tab",{detail:{tab:z}}))}catch(be){console.error("Navigation failed:",be)}},ns=z=>{const be=z.toLowerCase();return be.includes("username")||be.includes("change name")?{text:"You can change your username once for free.",links:[{text:"Go to Settings > Account",tab:"settings"}]}:be.includes("premium")||be.includes("upgrade")||be.includes("subscription")?{text:"Premium unlocks all game modes and features.",links:[{text:"Go to Online Play",tab:"online"}]}:be.includes("calibrat")||be.includes("camera")||be.includes("vision")?{text:"Set up your camera properly in Settings.",links:[{text:"Go to Settings > Camera & Vision",tab:"settings"}]}:be.includes("voice")||be.includes("caller")||be.includes("audio")?{text:"Enable voice calling in Settings.",links:[{text:"Go to Settings > Audio & Voice",tab:"settings"}]}:be.includes("friend")||be.includes("play together")?{text:"Add friends to play together.",links:[{text:"Go to Friends",tab:"friends"}]}:be.includes("stat")||be.includes("score")||be.includes("performance")?{text:"View your statistics and performance.",links:[{text:"Go to Stats",tab:"stats"}]}:be.includes("setting")||be.includes("customiz")||be.includes("configur")?{text:"Customize your experience.",links:[{text:"Go to Settings",tab:"settings"}]}:be.includes("tournament")||be.includes("competition")?{text:"Check out tournaments and competitions.",links:[{text:"Go to Tournaments",tab:"tournaments"}]}:be.includes("help")||be.includes("support")||be.includes("faq")?{text:"You're already in the help section! Check the Support section above for more resources.",links:[{text:"Scroll to Support",tab:"settings"}]}:be.includes("how to play")||be.includes("game")||be.includes("start")?{text:"To play darts, select a game mode from the menu. For online play, join a match. For offline, start a local game.",links:[{text:"Play Online",tab:"online"},{text:"Play Offline",tab:"offline"}]}:{text:"I'm not sure about that. Try asking about playing, calibration, premium, username changes, voice settings, friends, stats, or settings."}},Bt=()=>{if(!Ae.trim())return;const z=Ae.toLowerCase();ne(wt=>[...wt,{text:Ae,isUser:!0}]),Ce("");const be=ns(z);setTimeout(()=>{ne(wt=>[...wt,{text:be,isUser:!1}])},500)},[Dt,as]=u.useState(""),[Et,qs]=u.useState(!1),[vs,fs]=u.useState(""),[Kt,xs]=u.useState([]);return u.useEffect(()=>{const z=()=>{const be=speechSynthesis.getVoices();xs(be.filter(wt=>wt.lang.startsWith("en")))};z(),speechSynthesis.onvoiceschanged=z},[]),e.jsxs("div",{className:"space-y-6",children:[ie?e.jsx(Vu,{onClose:()=>fe(!1)}):null,e.jsx("div",{className:"card",children:e.jsxs("div",{className:"p-3 rounded-xl border border-red-500/40 bg-red-500/10",children:[e.jsxs("div",{className:"font-semibold mb-4 flex items-center gap-2 text-black",children:[e.jsx(dr,{className:"w-5 h-5"})," Account"]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex justify-center gap-2",children:[e.jsx("button",{onClick:()=>window.dispatchEvent(new CustomEvent("ndn:logout")),className:"px-6 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium transition-colors",children:"Logout"}),e.jsx("button",{onClick:()=>fe(!0),className:"px-4 py-2 bg-slate-700 hover:bg-slate-800 text-white rounded-lg font-medium transition-colors",children:"Highlights"})]}),e.jsxs("div",{className:"border-t border-red-500/20 pt-3",children:[e.jsxs("div",{className:"font-medium mb-2 text-black",children:["Change Username (",(()=>{const z=s?.usernameChangeCount||0;return z<2?`${2-z} free changes remaining`:"Â£2 per change"})(),")"]}),e.jsx("div",{className:"text-sm text-black mb-2",children:"You can change your username up to 2 times for free. Additional changes cost Â£2 each."}),s?.usernameChangeCount>=2&&!Dt.trim()?e.jsx("div",{className:"text-amber-400 text-sm mb-2",children:"âš ï¸ Additional username changes cost Â£2"}):null,e.jsx("input",{className:"input w-full mb-2",type:"text",placeholder:"New username",value:Dt,onChange:z=>as(z.target.value),disabled:Et}),vs&&e.jsx("div",{className:"text-red-400 text-sm mb-2",children:vs}),e.jsx("button",{onClick:async()=>{if(fs(""),!Dt.trim()){fs("Username required");return}if(Dt.length<3||Dt.length>20){fs("Username must be 3-20 characters");return}(s?.usernameChangeCount||0)<2?(localStorage.setItem("pendingUsernameChange",Dt.trim()),window.location.href="/?username-change=free"):window.location.href="https://buy.stripe.com/eVq4gB3XqeNS0iw6vAfnO02"},disabled:Et||!Dt.trim(),className:"w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-600 text-white rounded-lg font-medium transition-colors",children:Et?"Processing...":(s?.usernameChangeCount||0)<2?"Change Username (FREE)":"Change Username (Â£2)"})]})]})]})}),it&&e.jsx("div",{className:"card",children:e.jsxs("div",{className:"p-3 rounded-xl border border-green-500/40 bg-green-500/10",children:[e.jsxs("div",{className:"font-semibold mb-4 flex items-center gap-2 text-black",children:[e.jsx(Gi,{className:"w-5 h-5"})," Premium"]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"text-sm",children:[e.jsxs("div",{className:"font-medium",children:["Status: ",it.fullAccess?"Active":"Inactive"]}),it.source&&e.jsxs("div",{className:"text-xs opacity-80",children:["Source: ",it.source]}),it.expiresAt&&e.jsxs("div",{className:"text-xs opacity-80",children:["Expires: ",new Date(it.expiresAt).toLocaleDateString()]}),it.renewalWarning&&e.jsxs("div",{className:"text-amber-600 text-xs mt-2 p-2 bg-amber-100 rounded",children:["âš ï¸ ",it.renewalWarning]})]}),it.source==="tournament"&&e.jsx("div",{className:"flex justify-center",children:e.jsx("button",{onClick:async()=>{if(confirm("Are you sure you want to cancel your premium subscription? You will lose access to premium features."))try{await Pt("/api/admin/premium/revoke",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:s.email,requesterEmail:s.email})});const z=await Pt(`/api/subscription?email=${encodeURIComponent(s.email)}`);yt(await z.json())}catch{alert("Failed to cancel premium. Please try again.")}},className:"px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium transition-colors",children:"Cancel Premium"})})]})]})}),e.jsx("div",{className:"card",children:e.jsxs("div",{className:"p-3 rounded-xl border border-indigo-500/40 bg-indigo-500/10",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{className:"font-semibold flex items-center gap-2",children:[e.jsx(dr,{className:"w-5 h-5 text-brand-400"})," Profile Bio"]}),Ne?e.jsxs("button",{onClick:ze,className:"flex items-center gap-2 px-3 py-1 bg-green-500/20 hover:bg-green-500/30 rounded-lg text-green-400 text-sm transition-colors",children:[e.jsx(yc,{className:"w-4 h-4"})," Save"]}):e.jsxs("button",{onClick:()=>Ht(!0),className:"flex items-center gap-2 px-3 py-1 bg-blue-500/20 hover:bg-blue-500/30 rounded-lg text-blue-400 text-sm transition-colors",children:[e.jsx(gc,{className:"w-4 h-4"})," Edit"]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block mb-1 text-sm font-medium",children:"Favourite Player:"}),Ne?e.jsx("input",{className:"input w-full",type:"text",value:se,onChange:z=>Z(z.target.value),placeholder:"e.g. Michael van Gerwen"}):e.jsx("div",{className:"px-3 py-2 bg-slate-800/50 rounded-lg text-slate-300 min-h-[2.5rem] flex items-center",children:se||"Not set"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block mb-1 text-sm font-medium",children:"Favourite Football Team:"}),Ne?e.jsx("input",{className:"input w-full",type:"text",value:$e,onChange:z=>ye(z.target.value),placeholder:"e.g. Manchester United"}):e.jsx("div",{className:"px-3 py-2 bg-slate-800/50 rounded-lg text-slate-300 min-h-[2.5rem] flex items-center",children:$e||"Not set"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block mb-1 text-sm font-medium",children:"Favourite Darts:"}),Ne?e.jsx("input",{className:"input w-full",type:"text",value:Se,onChange:z=>Qe(z.target.value),placeholder:"e.g. Unicorn Phase 5, 24g"}):e.jsx("div",{className:"px-3 py-2 bg-slate-800/50 rounded-lg text-slate-300 min-h-[2.5rem] flex items-center",children:Se||"Not set"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block mb-1 text-sm font-medium",children:"Short Bio / Quote:"}),Ne?e.jsx("textarea",{className:"input w-full",value:Ke,onChange:z=>mt(z.target.value),placeholder:"Write something about yourself...",rows:3}):e.jsx("div",{className:"px-3 py-2 bg-slate-800/50 rounded-lg text-slate-300 min-h-[4rem] flex items-start",children:Ke||"No bio set"})]})]})]})}),e.jsx("div",{className:"card",children:e.jsxs("div",{className:"p-3 rounded-xl border border-cyan-500/40 bg-cyan-500/10",children:[e.jsxs("div",{className:"font-semibold mb-2 flex items-center gap-2",children:[e.jsx(dr,{className:"w-5 h-5 text-cyan-400"})," Profile Photo"]}),e.jsxs("div",{children:[Be&&e.jsx("div",{className:"mb-2",children:e.jsx("img",{src:Be,alt:"Profile",className:"w-16 h-16 rounded-full object-cover"})}),e.jsx("input",{type:"file",accept:"image/*",onChange:z=>{const be=z.target.files?.[0];if(be){const wt=new FileReader;wt.onload=Ut=>{const ps=Ut.target?.result;ht(ps);const Us=s?.username||"";Us&&localStorage.setItem(`ndn:bio:profilePhoto:${Us}`,ps);try{window.dispatchEvent(new CustomEvent("ndn:avatar-updated",{detail:{username:Us,avatar:ps}}))}catch{}},wt.readAsDataURL(be)}},className:"hidden",id:"profile-photo-upload"}),e.jsx("label",{htmlFor:"profile-photo-upload",className:"btn bg-cyan-600 hover:bg-cyan-700 cursor-pointer",children:Be?"Change Photo":"Upload Photo"})]})]})}),e.jsx("div",{className:"card",children:e.jsxs("div",{className:"p-3 rounded-xl border border-green-500/40 bg-green-500/10",children:[e.jsxs("div",{className:"font-semibold mb-4 flex items-center gap-2",children:[e.jsx(vc,{className:"w-5 h-5 text-green-400"})," Game Preferences"]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{type:"checkbox",id:"dartTimerEnabled",checked:!!lt,onChange:z=>he(z.target.checked),className:"w-4 h-4"}),e.jsx("label",{htmlFor:"dartTimerEnabled",className:"text-sm",children:"Enable per-dart throw timer"})]}),lt&&e.jsxs("div",{children:[e.jsxs("label",{className:"block mb-2 text-sm font-medium",children:["Time per throw: ",pe?Math.round(pe):0,"s"]}),e.jsx("input",{type:"range",min:"3",max:"60",step:"1",value:pe||10,onChange:z=>Oe(parseInt(z.target.value)),className:"w-full"}),e.jsx("div",{className:"text-xs opacity-70 mt-1",children:"When the timer reaches zero, the dart is recorded as a miss and advances to the next throw."})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block mb-2 text-sm font-medium",children:"Favourite Double:"}),e.jsxs("select",{className:"input w-full",value:n,onChange:z=>b(z.target.value),children:[e.jsx("option",{value:"any",children:"Any Double"}),e.jsx("option",{value:"D20",children:"Double 20"}),e.jsx("option",{value:"D19",children:"Double 19"}),e.jsx("option",{value:"D18",children:"Double 18"}),e.jsx("option",{value:"D17",children:"Double 17"}),e.jsx("option",{value:"D16",children:"Double 16"}),e.jsx("option",{value:"D15",children:"Double 15"}),e.jsx("option",{value:"D14",children:"Double 14"}),e.jsx("option",{value:"D13",children:"Double 13"}),e.jsx("option",{value:"D12",children:"Double 12"}),e.jsx("option",{value:"D11",children:"Double 11"}),e.jsx("option",{value:"D10",children:"Double 10"}),e.jsx("option",{value:"D9",children:"Double 9"}),e.jsx("option",{value:"D8",children:"Double 8"}),e.jsx("option",{value:"D7",children:"Double 7"}),e.jsx("option",{value:"D6",children:"Double 6"}),e.jsx("option",{value:"D5",children:"Double 5"}),e.jsx("option",{value:"D4",children:"Double 4"}),e.jsx("option",{value:"D3",children:"Double 3"}),e.jsx("option",{value:"D2",children:"Double 2"}),e.jsx("option",{value:"D1",children:"Double 1"}),e.jsx("option",{value:"DB",children:"Bullseye"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block mb-2 text-sm font-medium",children:"Average Display Mode:"}),e.jsxs("select",{className:"input w-full",value:l,onChange:z=>D(z.target.value),children:[e.jsx("option",{value:"all-time",children:"All Time Average"}),e.jsx("option",{value:"24h",children:"24 Hour Average"})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{type:"checkbox",id:"x01DoubleIn",checked:!!xt,onChange:z=>Rt(z.target.checked),className:"w-4 h-4"}),e.jsx("label",{htmlFor:"x01DoubleIn",className:"text-sm",children:"Require Double-In for X01"})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{type:"checkbox",id:"autoStartOffline",checked:o,onChange:z=>Q(z.target.checked),className:"w-4 h-4"}),e.jsx("label",{htmlFor:"autoStartOffline",className:"text-sm",children:"Auto-start offline games"})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{type:"checkbox",id:"rememberLastOffline",checked:d,onChange:z=>me(z.target.checked),className:"w-4 h-4"}),e.jsx("label",{htmlFor:"rememberLastOffline",className:"text-sm",children:"Remember last offline game settings"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block mb-2 text-sm font-medium",children:"Offline Game Layout:"}),e.jsxs("select",{className:"input w-full",value:P||"classic",onChange:z=>We(z.target.value),children:[e.jsx("option",{value:"classic",children:"Classic Layout"}),e.jsx("option",{value:"modern",children:"Modern Layout"})]})]})]})]})}),e.jsx("div",{className:"card",children:e.jsxs("div",{className:"p-3 rounded-xl border border-purple-500/40 bg-purple-500/10",children:[e.jsxs("div",{className:"font-semibold mb-4 flex items-center gap-2",children:[e.jsx(jc,{className:"w-5 h-5 text-purple-400"})," Audio & Voice"]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{type:"checkbox",id:"callerEnabled",checked:t,onChange:z=>H(z.target.checked),className:"w-4 h-4"}),e.jsx("label",{htmlFor:"callerEnabled",className:"text-sm font-medium",children:"Enable Voice Caller"})]}),t&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx("label",{className:"block mb-2 text-sm font-medium",children:"Caller mode:"}),e.jsxs("select",{className:"input w-full",value:t?r?"checkout":"visit":"off",onChange:z=>{const be=z.target.value;be==="off"?H(!1):be==="checkout"?(H(!0),F(!0)):(H(!0),F(!1))},children:[e.jsx("option",{value:"visit",children:"Visit totals only"}),e.jsx("option",{value:"checkout",children:"Checkouts only"}),e.jsx("option",{value:"off",children:"Off"})]}),e.jsx("div",{className:"text-xs opacity-70 mt-1",children:"Choose when the caller speaks: at the end of each 3-dart visit, only on finishes, or disable entirely."})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block mb-2 text-sm font-medium",children:"Voice:"}),e.jsx("select",{className:"input w-full",value:i,onChange:z=>W(z.target.value),children:Kt.map(z=>e.jsxs("option",{value:z.name,children:[z.name," (",z.lang,")"]},z.name))}),e.jsx("button",{onClick:()=>{const z=new SpeechSynthesisUtterance("Test voice: 180 scored!");z.voice=Kt.find(be=>be.name===i)||null,z.volume=a,speechSynthesis.speak(z)},className:"btn bg-blue-600 hover:bg-blue-700 mt-2",children:"Test Voice"})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block mb-2 text-sm font-medium",children:["Volume: ",Math.round(a*100),"%"]}),e.jsx("input",{type:"range",min:"0",max:"1",step:"0.1",value:a,onChange:z=>R(parseFloat(z.target.value)),className:"w-full"})]}),!1]})]})]})}),e.jsx("div",{className:"card",children:e.jsxs("div",{className:"p-3 rounded-xl border border-blue-500/40 bg-blue-500/10",children:[e.jsxs("div",{className:"font-semibold mb-4 flex items-center gap-2",children:[e.jsx(el,{className:"w-5 h-5 text-blue-400"})," Camera & Vision"]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{type:"checkbox",id:"cameraEnabled",checked:M,onChange:z=>He(z.target.checked),className:"w-4 h-4"}),e.jsx("label",{htmlFor:"cameraEnabled",className:"text-sm",children:"Enable camera for scoring"})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block mb-2 text-sm font-medium",children:["Camera Scale: ",x.toFixed(2),"x"]}),e.jsx("input",{type:"range",min:"0.5",max:"1.25",step:"0.05",value:x,onChange:z=>Pe(parseFloat(z.target.value)),className:"w-full"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block mb-2 text-sm font-medium",children:"Camera Aspect Ratio:"}),e.jsxs("select",{className:"input w-full",value:p||"wide",onChange:z=>Le(z.target.value),children:[e.jsx("option",{value:"wide",children:"Wide (16:9)"}),e.jsx("option",{value:"square",children:"Square (1:1)"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block mb-2 text-sm font-medium",children:"Camera Display:"}),e.jsxs("select",{className:"input w-full",value:g||"fill",onChange:z=>ve(z.target.value),children:[e.jsx("option",{value:"fit",children:"Fit (show entire frame)"}),e.jsx("option",{value:"fill",children:"Fill (full-bleed)"})]}),e.jsx("div",{className:"text-xs opacity-70 mt-1",children:"Fit shows the whole camera with possible letterboxing. Fill covers the panel edge-to-edge and may crop."})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block mb-2 text-sm font-medium",children:"Text Size:"}),e.jsxs("select",{className:"input w-full",value:A,onChange:z=>we(z.target.value),children:[e.jsx("option",{value:"small",children:"Small"}),e.jsx("option",{value:"medium",children:"Medium"}),e.jsx("option",{value:"large",children:"Large"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block mb-2 text-sm font-medium",children:"Box Size:"}),e.jsxs("select",{className:"input w-full",value:v,onChange:z=>Ie(z.target.value),children:[e.jsx("option",{value:"small",children:"Small"}),e.jsx("option",{value:"medium",children:"Medium"}),e.jsx("option",{value:"large",children:"Large"})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{type:"checkbox",id:"calibrationGuide",checked:S,onChange:z=>te(z.target.checked),className:"w-4 h-4"}),e.jsx("label",{htmlFor:"calibrationGuide",className:"text-sm",children:"Show calibration guide"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block mb-2 text-sm font-medium",children:"Autoscore Provider:"}),e.jsxs("select",{className:"input w-full",value:w||"built-in",onChange:z=>Ee(z.target.value),children:[e.jsx("option",{value:"built-in",children:"Built-in Vision"}),e.jsx("option",{value:"manual",children:"Manual scoring only"}),e.jsx("option",{value:"external-ws",children:"External WebSocket"})]})]}),w==="manual"&&e.jsx("div",{className:"text-xs opacity-70",children:"Camera previews and autoscore overlays are hidden while manual scoring is selected. Use the score inputs or keyboard shortcuts to record each visit."}),w==="external-ws"&&e.jsxs("div",{children:[e.jsx("label",{className:"block mb-2 text-sm font-medium",children:"External WebSocket URL:"}),e.jsx("input",{className:"input w-full",type:"url",value:T||"",onChange:z=>$(z.target.value),placeholder:"ws://localhost:8080"})]})]})]})}),e.jsx("div",{className:"card",children:e.jsxs("div",{className:"p-3 rounded-xl border border-orange-500/40 bg-orange-500/10",children:[e.jsxs("div",{className:"font-semibold mb-4 flex items-center gap-2",children:[e.jsx(sl,{className:"w-5 h-5 text-orange-400"})," UI & Accessibility"]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{type:"checkbox",id:"reducedMotion",checked:c,onChange:z=>ue(z.target.checked),className:"w-4 h-4"}),e.jsx("label",{htmlFor:"reducedMotion",className:"text-sm",children:"Reduce motion/animations"})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{type:"checkbox",id:"compactHeader",checked:h,onChange:z=>ke(z.target.checked),className:"w-4 h-4"}),e.jsx("label",{htmlFor:"compactHeader",className:"text-sm",children:"Compact header layout"})]})]})]})}),e.jsx("div",{className:"card",children:e.jsxs("div",{className:"p-3 rounded-xl border border-pink-500/40 bg-pink-500/10",children:[e.jsxs("div",{className:"font-semibold mb-4 flex items-center gap-2",children:[e.jsx(Nc,{className:"w-5 h-5 text-pink-400"})," Online & Social"]}),e.jsx("div",{className:"space-y-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{type:"checkbox",id:"allowSpectate",checked:m,onChange:z=>_e(z.target.checked),className:"w-4 h-4"}),e.jsx("label",{htmlFor:"allowSpectate",className:"text-sm",children:"Allow others to spectate my games"})]})})]})}),e.jsx("div",{className:"card",children:e.jsxs("div",{className:"p-3 rounded-xl border border-yellow-500/40 bg-yellow-500/10",children:[e.jsxs("div",{className:"font-semibold mb-4 flex items-center gap-2 text-yellow-700",children:[e.jsx(Sa,{className:"w-5 h-5"})," Achievements & Badges"]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:hs.map(z=>e.jsxs("div",{className:`flex flex-col items-center p-3 rounded-xl border ${z.unlocked?"border-emerald-400 bg-emerald-500/10":"border-slate-400 bg-slate-700/10"}`,children:[e.jsx("div",{className:"text-3xl mb-2",children:z.icon}),e.jsx("div",{className:`font-bold mb-1 text-center ${z.unlocked?"text-emerald-400":"text-slate-400"}`,children:z.label}),e.jsx("div",{className:"text-xs text-slate-300 text-center mb-2",children:z.desc}),!z.unlocked&&e.jsx("div",{className:"text-xs text-amber-400 font-medium",children:"ðŸ”’ Locked"}),z.unlocked&&e.jsx("div",{className:"text-xs text-emerald-400 font-medium",children:"âœ… Unlocked!"})]},z.key))})]})}),e.jsx("div",{className:"card",children:e.jsxs("div",{className:"p-3 rounded-xl border border-gray-500/40 bg-gray-500/10",children:[e.jsxs("div",{className:"font-semibold mb-4 flex items-center gap-2",children:[e.jsx(Sa,{className:"w-5 h-5 text-gray-400"})," Data & Privacy"]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{type:"checkbox",id:"allowAnalytics",checked:Ye,onChange:z=>Nt(z.target.checked),className:"w-4 h-4"}),e.jsx("label",{htmlFor:"allowAnalytics",className:"text-sm",children:"Allow anonymous usage analytics"})]}),e.jsx("div",{children:e.jsx("button",{onClick:()=>{const z={username:s?.username,email:s?.email,favPlayer:se,favTeam:$e,favDarts:Se,bio:Ke,profilePhoto:Be,settings:{favoriteDouble:n,avgMode:l,autoStartOffline:o,rememberLastOffline:d,reducedMotion:c,compactHeader:h,allowSpectate:m,cameraScale:x,cameraAspect:p,autoscoreProvider:w,autoscoreWsUrl:T,calibrationGuide:S,cameraFitMode:g,callerEnabled:t,callerVoice:i,callerVolume:a,speakCheckoutOnly:r,textSize:A}},be=new Blob([JSON.stringify(z,null,2)],{type:"application/json"}),wt=URL.createObjectURL(be),Ut=document.createElement("a");Ut.href=wt,Ut.download="ninedartnation-data.json",Ut.click(),URL.revokeObjectURL(wt)},className:"btn bg-blue-600 hover:bg-blue-700",children:"Export My Data"})}),e.jsx("div",{children:e.jsx("button",{onClick:()=>{confirm("Are you sure you want to delete your account? This action cannot be undone.")&&alert("Account deletion not yet implemented. Please contact support.")},className:"btn bg-red-600 hover:bg-red-700",children:"Delete Account"})})]})]})}),e.jsx("div",{className:"card",children:e.jsxs("div",{className:"p-3 rounded-xl border border-red-500/40 bg-red-500/10",children:[e.jsxs("div",{className:"font-semibold mb-4 flex items-center gap-2",children:[e.jsx(Gi,{className:"w-5 h-5 text-red-400"})," Privacy & Copyright Notice"]}),e.jsx("div",{className:"space-y-3 text-sm text-slate-300",children:e.jsxs("div",{className:"bg-red-500/20 border border-red-500/30 rounded-lg p-3",children:[e.jsx("p",{className:"font-semibold text-red-300 mb-2",children:"âš ï¸ IMPORTANT LEGAL NOTICE"}),e.jsxs("p",{className:"mb-2",children:[e.jsx("strong",{children:"Copyright Protection:"})," All code, assets, and intellectual property in Nine Dart Nation are protected by copyright law. Unauthorized copying, modification, or distribution of this software is strictly prohibited."]}),e.jsxs("p",{className:"mb-2",children:[e.jsx("strong",{children:"Legal Consequences:"})," Any attempt to edit, reverse-engineer, or redistribute this code will result in immediate legal action, including but not limited to copyright infringement lawsuits and potential criminal charges."]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Privacy:"})," Your personal data and gameplay information are protected. Any unauthorized access or data collection violates privacy laws and will be prosecuted to the full extent of the law."]})]})})]})}),e.jsx("div",{className:"card",children:e.jsxs("div",{className:"p-3 rounded-xl border border-teal-500/40 bg-teal-500/10",children:[e.jsxs("div",{className:"font-semibold mb-4 flex items-center gap-2",children:[e.jsx(Sa,{className:"w-5 h-5 text-teal-400"})," Support & Help"]}),e.jsx("div",{className:"space-y-4",children:e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-slate-300 mb-2",children:"Need help? Contact us:"}),e.jsx("a",{href:"mailto:support@ninedartnation.com",className:"btn bg-teal-600 hover:bg-teal-700",children:"Email Support"})]})})]})}),e.jsx("div",{className:"card",children:e.jsxs("div",{className:"p-3 rounded-xl border border-blue-500/40 bg-blue-500/10",children:[e.jsxs("div",{className:"font-semibold mb-4 flex items-center gap-2",children:[e.jsx(nl,{className:"w-5 h-5 text-blue-400"})," Help Assistant"]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"bg-slate-800 rounded-lg p-4 max-h-96 overflow-y-auto space-y-3",children:C.map((z,be)=>e.jsx("div",{className:`flex ${z.isUser?"justify-end":"justify-start"}`,children:e.jsx("div",{className:`max-w-xs px-3 py-2 rounded-lg ${z.isUser?"bg-blue-600 text-white":"bg-slate-700 text-slate-200"}`,children:typeof z.text=="string"?z.text:e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{children:z.text.text}),z.text.links&&e.jsx("div",{className:"space-y-1",children:z.text.links.map((wt,Ut)=>e.jsx("button",{onClick:()=>pt(wt.tab),className:"block w-full text-left text-blue-300 hover:text-blue-200 underline text-sm",children:wt.text},Ut))})]})})},be))}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{type:"text",value:Ae,onChange:z=>Ce(z.target.value),onKeyPress:z=>z.key==="Enter"&&Bt(),placeholder:"Ask me anything...",className:"flex-1 input"}),e.jsx("button",{onClick:Bt,className:"btn bg-blue-600 hover:bg-blue-700",children:e.jsx(fi,{className:"w-4 h-4"})})]})]})]})})]})}const Ju={};function Ku({onAuth:s}){const[n,t]=u.useState("signin"),[i,a]=u.useState(""),[r,l]=u.useState(""),[o,d]=u.useState(""),[c,h]=u.useState(""),[m,x]=u.useState(""),[p,g]=u.useState(!1),[w,T]=u.useState(!1),S="http://localhost:8787";async function E(A){if(A.preventDefault(),x(""),T(!0),!r||!o){x("Username and password required."),T(!1);return}try{const v=await fetch(`${S}/api/auth/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r.includes("@")?{email:r,password:o}:{username:r,password:o})}),b=await v.json();v.ok&&b?.user&&b?.token?(localStorage.setItem("authToken",b.token),s(b.user)):x(b?.error||"Invalid username or password.")}catch{x("Network error.")}finally{T(!1)}}async function I(A){if(A.preventDefault(),x(""),T(!0),!i||!r||!o){x("Email, username, and password required."),T(!1);return}try{const v=await fetch(`${S}/api/auth/signup`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:i,username:r,password:o})}),b=await v.json();v.ok&&b?.user&&b?.token?(localStorage.setItem("authToken",b.token),s(b.user)):x(b?.error||"Signup failed.")}catch{x("Network error.")}finally{T(!1)}}async function M(A){if(A.preventDefault(),x(""),T(!0),!i||!i.includes("@")){x("Enter your email address."),T(!1);return}try{const b=await(await fetch(`${S}/api/auth/send-reset`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:i})})).json();if(!b?.ok)throw new Error(b?.error||"Failed to send reset email");x("Password reset link sent to your email.")}catch(v){x(v?.message||"Failed to send reset email")}finally{T(!1)}}async function P(A){if(A.preventDefault(),x(""),T(!0),!i||!i.includes("@")){x("Enter your email address."),T(!1);return}try{const b=await(await fetch(`${S}/api/auth/send-username`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:i})})).json();if(!b?.ok)throw new Error(b?.error||"Failed to send username email");x("Your username has been emailed to you.")}catch(v){x(v?.message||"Failed to send username email")}finally{T(!1)}}return e.jsxs("div",{className:"min-h-screen flex items-center justify-center relative overflow-hidden",children:[e.jsx("div",{className:"background-animated"}),e.jsxs("div",{className:"relative z-10 w-full max-w-5xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-6 p-4",children:[e.jsxs("form",{className:"card w-full space-y-4",onSubmit:n==="signin"?E:n==="signup"?I:M,children:[e.jsxs("div",{className:"flex flex-col items-center justify-center gap-2 mb-2 text-center",children:[e.jsx("h1",{className:"logo text-center",children:"NINE-DART-NATION ðŸŽ¯"}),e.jsx("span",{className:"badge",children:"Welcome"})]}),e.jsx("h2",{className:"text-2xl font-bold",children:n==="signin"?"Sign In":n==="signup"?"Create Account":"Reset Password"}),(n==="signup"||n==="reset")&&e.jsx("input",{className:"input w-full",type:"email",placeholder:"Email",value:i,onChange:A=>a(A.target.value),required:!0}),n!=="reset"&&e.jsx("input",{className:"input w-full",type:"text",placeholder:"Username or Email",value:r,onChange:A=>l(A.target.value),required:!0}),n!=="reset"&&e.jsxs("div",{className:"relative",children:[e.jsx("input",{className:"input w-full pr-10",type:p?"text":"password",placeholder:"Password",value:o,onChange:A=>d(A.target.value),autoComplete:"current-password",required:!0,onFocus:()=>g(!1),onBlur:()=>g(!1)}),e.jsx("button",{type:"button",className:"absolute right-2 top-1/2 -translate-y-1/2 text-slate-300 hover:text-white",tabIndex:-1,onMouseDown:A=>{A.preventDefault(),g(!0)},onMouseUp:A=>{A.preventDefault(),g(!1)},onMouseLeave:()=>g(!1),onTouchStart:A=>{A.preventDefault(),g(!0)},onTouchEnd:A=>{A.preventDefault(),g(!1)},"aria-label":"Toggle password visibility",children:p?e.jsx(wc,{className:"w-5 h-5"}):e.jsx(sl,{className:"w-5 h-5"})})]}),n==="signup"&&e.jsx("input",{className:"input w-full",type:"text",placeholder:"Password Reminder (optional)",value:c,onChange:A=>h(A.target.value)}),m&&e.jsx("div",{className:"text-red-400 font-semibold text-sm",children:m}),e.jsx("button",{className:"btn w-full",type:"submit",disabled:w,children:w?"Signing In...":n==="signin"?"Sign In":n==="signup"?"Sign Up":"Send Reset Link"}),n==="reset"&&e.jsx("button",{className:"btn w-full mt-2 bg-white/10 hover:bg-white/20",type:"button",onClick:P,disabled:w,children:"Email me my username"}),e.jsxs("div",{className:"flex justify-between text-sm mt-2",children:[e.jsx("button",{type:"button",className:"underline",onClick:()=>t(n==="signin"?"signup":"signin"),disabled:w,children:n==="signin"?"Need an account? Sign Up":"Already have an account? Sign In"}),e.jsx("button",{type:"button",className:"underline",onClick:()=>t("reset"),disabled:w,children:"Forgot password?"})]})]}),e.jsxs("aside",{className:"card w-full",children:[e.jsx("h3",{className:"text-xl font-bold mb-3",children:"Whatâ€™s inside"}),e.jsxs("ul",{className:"space-y-3",children:[e.jsxs("li",{className:"flex items-start gap-3",children:[e.jsx(Zr,{className:"w-5 h-5 text-indigo-300 mt-1"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold",children:"Online & Friends"}),e.jsx("div",{className:"text-sm text-slate-200/90",children:"Challenge friends, chat, and join leagues."})]})]}),e.jsxs("li",{className:"flex items-start gap-3",children:[e.jsx(Sc,{className:"w-5 h-5 text-indigo-300 mt-1"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold",children:"Deep Stats"}),e.jsx("div",{className:"text-sm text-slate-200/90",children:"Track 3-dart averages, best legs, and more."})]})]}),e.jsxs("li",{className:"flex items-start gap-3",children:[e.jsx(Ha,{className:"w-5 h-5 text-indigo-300 mt-1"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold",children:"Game Modes"}),e.jsx("div",{className:"text-sm text-slate-200/90",children:"Start with 3 free online games upon signup. After that, PREMIUM is required to play all games."})]})]}),e.jsxs("li",{className:"flex items-start gap-3",children:[e.jsx(kc,{className:"w-5 h-5 text-indigo-300 mt-1"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold",children:"Premium Perks"}),e.jsx("div",{className:"text-sm text-slate-200/90",children:"Polished UI, upcoming features, and early access."})]})]})]}),e.jsxs("a",{href:Ju?.VITE_DISCORD_INVITE_URL||"https://discord.gg/8GtbZ6RU",target:"_blank",rel:"noopener noreferrer",className:"btn mt-4 flex items-center justify-center gap-2",children:[e.jsx(_n,{className:"w-5 h-5"})," Join BullseyeDartsLeague"]}),e.jsxs("a",{href:"https://discord.gg/NineDartNation",target:"_blank",rel:"noopener noreferrer",className:"btn mt-2 flex items-center justify-center gap-2 bg-white/10 hover:bg-white/20",children:[e.jsx(_n,{className:"w-5 h-5"})," Join NineDartNation"]})]})]})]})}const Yu=u.createContext({theme:"default",setTheme:s=>{}}),Xo="ndn_theme";function Xu({children:s}){const[n,t]=u.useState("default");return u.useEffect(()=>{try{const i=localStorage.getItem(Xo);i&&t(i)}catch{}},[]),u.useEffect(()=>{try{localStorage.setItem(Xo,n)}catch{}},[n]),e.jsx(Yu.Provider,{value:{theme:n,setTheme:t},children:e.jsx("div",{className:`theme-${n}`,children:s})})}function Qu(s){let n=0,t=0,i=null,a=null,r=0;for(const d of s.legs||[]){n+=d.totalScoreStart-d.totalScoreRemaining;const c=(d.visits||[]).reduce((h,m)=>h+(m.darts||0)-(m.preOpenDarts||0),0);t+=c,d.finished&&((i===null||d.dartsThrown<i)&&(i=d.dartsThrown),(a===null||d.dartsThrown>a)&&(a=d.dartsThrown));for(const h of d.visits||[])(h?.score||0)===180&&(r+=1)}const l=t>0?n/t*3:0,o=l*3;return{points:n,darts:t,threeDA:l,nineDA:o,bestLeg:i,worstLeg:a,oneEighties:r}}function Zu({open:s,onClose:n,title:t="Match Summary",players:i,centerScore:a,doublesStats:r,allowRematch:l,onRematch:o}){if(!s)return null;const d=i.map(c=>{const h=Qu(c),m=r?.[c.id]||{},x=Math.max(0,Number(m.dartsAtDouble||0)),p=Math.max(0,Number(m.doublesHit||0)),g=x>0?Math.round(p/x*100):null;return{id:c.id,name:c.name,legsWon:c.legsWon,...h,dartsAtDouble:x,doublesHit:p,doublePct:g}});return e.jsx("div",{className:"fixed inset-0 bg-black/60 flex items-center justify-center z-[120]",children:e.jsxs(zs,{storageKey:"ndn:modal:match-summary",className:"w-full relative",defaultWidth:860,defaultHeight:540,minWidth:640,minHeight:420,maxWidth:1400,maxHeight:1e3,initialFitHeight:!0,children:[e.jsx("h3",{className:"text-xl font-extrabold mb-2",children:t}),e.jsxs("div",{className:"text-xs opacity-80 mb-3",children:["Players: ",i.map(c=>c.name).join(" vs ")]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-3",children:[d[0]&&e.jsxs("div",{className:"p-3 rounded-2xl glass border border-white/10",children:[e.jsx("div",{className:"text-sm font-semibold mb-1",children:d[0].name}),e.jsx("div",{className:"text-3xl font-extrabold",children:d[0].legsWon}),e.jsx("div",{className:"text-xs opacity-80",children:"Legs Won"}),e.jsxs("div",{className:"mt-3 grid grid-cols-2 gap-2 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"opacity-70",children:"Final 3DA"}),e.jsx("div",{className:"font-semibold",children:d[0].threeDA.toFixed(1)})]}),e.jsxs("div",{children:[e.jsx("span",{className:"opacity-70",children:"Final 9DA"}),e.jsx("div",{className:"font-semibold",children:d[0].nineDA.toFixed(1)})]}),e.jsxs("div",{children:[e.jsx("span",{className:"opacity-70",children:"Darts At Double"}),e.jsx("div",{className:"font-semibold",children:d[0].dartsAtDouble??"â€”"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"opacity-70",children:"Double %"}),e.jsx("div",{className:"font-semibold",children:d[0].doublePct!==null&&d[0].doublePct!==void 0?`${d[0].doublePct}%`:"â€”"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"opacity-70",children:"Best Dart Leg"}),e.jsx("div",{className:"font-semibold",children:d[0].bestLeg?`${d[0].bestLeg} darts`:"â€”"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"opacity-70",children:"Worst Dart Leg"}),e.jsx("div",{className:"font-semibold",children:d[0].worstLeg?`${d[0].worstLeg} darts`:"â€”"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"opacity-70",children:"180's Hit"}),e.jsx("div",{className:"font-semibold",children:d[0].oneEighties})]})]})]}),e.jsx("div",{className:"hidden md:flex items-center justify-center",children:e.jsx("div",{className:"text-4xl font-black",children:a||(i.length===2?`${d[0]?.legsWon??0} â€“ ${d[1]?.legsWon??0}`:"")})}),d[1]&&e.jsxs("div",{className:"p-3 rounded-2xl glass border border-white/10",children:[e.jsx("div",{className:"text-sm font-semibold mb-1",children:d[1].name}),e.jsx("div",{className:"text-3xl font-extrabold",children:d[1].legsWon}),e.jsx("div",{className:"text-xs opacity-80",children:"Legs Won"}),e.jsxs("div",{className:"mt-3 grid grid-cols-2 gap-2 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"opacity-70",children:"Final 3DA"}),e.jsx("div",{className:"font-semibold",children:d[1].threeDA.toFixed(1)})]}),e.jsxs("div",{children:[e.jsx("span",{className:"opacity-70",children:"Final 9DA"}),e.jsx("div",{className:"font-semibold",children:d[1].nineDA.toFixed(1)})]}),e.jsxs("div",{children:[e.jsx("span",{className:"opacity-70",children:"Darts At Double"}),e.jsx("div",{className:"font-semibold",children:d[1].dartsAtDouble??"â€”"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"opacity-70",children:"Double %"}),e.jsx("div",{className:"font-semibold",children:d[1].doublePct!==null&&d[1].doublePct!==void 0?`${d[1].doublePct}%`:"â€”"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"opacity-70",children:"Best Dart Leg"}),e.jsx("div",{className:"font-semibold",children:d[1].bestLeg?`${d[1].bestLeg} darts`:"â€”"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"opacity-70",children:"Worst Dart Leg"}),e.jsx("div",{className:"font-semibold",children:d[1].worstLeg?`${d[1].worstLeg} darts`:"â€”"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"opacity-70",children:"180's Hit"}),e.jsx("div",{className:"font-semibold",children:d[1].oneEighties})]})]})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 mt-4",children:[e.jsx("button",{className:"btn bg-slate-700 hover:bg-slate-800",onClick:n,children:"Close"}),l&&e.jsx("button",{className:"btn bg-emerald-600 hover:bg-emerald-700",onClick:o,children:"Rematch"})]})]})})}const tc="ndn:blocked:v1";function em(){try{const s=localStorage.getItem(tc);return s?JSON.parse(s):{}}catch{return{}}}function Qo(s){try{localStorage.setItem(tc,JSON.stringify(s))}catch{}}const tm=Js((s,n)=>({blocked:em(),isBlocked:t=>!!n().blocked[(t||"").toLowerCase()],block:t=>s(i=>{const a={...i.blocked};return a[(t||"").toLowerCase()]=Date.now(),Qo(a),{blocked:a}}),unblock:t=>s(i=>{const a={...i.blocked};return delete a[(t||"").toLowerCase()],Qo(a),{blocked:a}}),all:()=>Object.keys(n().blocked)}));function sm({user:s}){const n="http://localhost:8787",t=zn(),i=(()=>{try{return xa()}catch{return null}})(),a=tm(),[r,l]=u.useState("room-1"),[o,d]=u.useState(!1),[c,h]=u.useState([]),[m,x]=u.useState(!1),[p,g]=u.useState(!1),w=u.useRef(null),[T,S]=u.useState(null),E=u.useRef(null),I=u.useRef(0),M=u.useRef(null),P=u.useRef(!0),A=u.useRef(0),v=u.useRef(!1),b=ha(),H=di(),{favoriteDouble:W,callerEnabled:R,callerVoice:F,callerVolume:D,speakCheckoutOnly:Q,allowSpectate:me,cameraScale:ue,setCameraScale:ke,cameraFitMode:_e="fill",setCameraFitMode:Pe,cameraEnabled:Le,textSize:ve,boxSize:Ee,autoscoreProvider:$,matchType:te="singles",setMatchType:oe,teamAName:He="Team A",setTeamAName:We,teamBName:we="Team B",setTeamBName:Ie,x01DoubleIn:lt}=Ft(),pe=$==="manual",Oe=(f=>{switch(f){case"small":return"px-1.5 py-0.5 text-xs";case"large":return"px-3 py-1 text-sm";default:return"px-2 py-0.5 text-sm"}})(ve),[xt,Rt]=u.useState(2),[hs,jt]=u.useState(!1),[Ne,Ht]=u.useState([]),[ie,fe]=u.useState(0),[se,Z]=u.useState(0),[$e,ye]=u.useState(0),[Se,Qe]=u.useState(0),[Ke,mt]=u.useState(""),[Be,ht]=u.useState(0),[Ye,Nt]=u.useState(0),[it,yt]=u.useState(""),[C,ne]=u.useState(20),[Ae,Ce]=u.useState(0),[ze,pt]=u.useState(0),[ns,Bt]=u.useState(""),[Dt,as]=u.useState(30),[Et,qs]=u.useState(!1),[vs,fs]=u.useState(null),[Kt,xs]=u.useState(null),[z,be]=u.useState(!1);function wt(){if(Kt)try{const f=new Blob([JSON.stringify(Kt,null,2)],{type:"application/json"}),j=URL.createObjectURL(f),k=document.createElement("a"),O=`ndn-highlight-${Kt.player||"player"}-${Kt.ts||Date.now()}.json`;k.href=j,k.download=O,document.body.appendChild(k),k.click(),k.remove(),URL.revokeObjectURL(j),t?.("Downloaded highlight to device",{type:"success"}),be(!1)}catch{t?.("Download failed",{type:"error"})}}async function Ut(){if(!Kt)return;const f=localStorage.getItem("authToken");if(!f){t?.("You must be signed in to save to account",{type:"error"});return}try{const j=await Pt("/api/user/highlights",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${f}`},body:JSON.stringify(Kt)});if(!j.ok){const O=await j.json().catch(()=>({}));t?.(`Save failed: ${O.error||j.statusText}`,{type:"error"});return}const k=await j.json();t?.("Saved highlight to your account",{type:"success"}),be(!1)}catch{t?.("Save failed",{type:"error"})}}const[ps,Us]=u.useState(null),ls=u.useRef(null),[$s,js]=u.useState(""),[gs,As]=u.useState({}),[ys,rs]=u.useState({}),[Ns,Rs]=u.useState({}),[Vt,ks]=u.useState({}),[Zt,Ps]=u.useState({}),[Cs,U]=u.useState({}),[K,ee]=u.useState({}),[G,N]=u.useState({}),[L,_]=u.useState(()=>ci()),[Y,ae]=u.useState(0),[ce,xe]=u.useState(!1),[je,Te]=u.useState(null),[Mt,st]=u.useState({}),[ft,ct]=u.useState(null),[bt,is]=u.useState(300),cs=Al(f=>f.setPaused),[Wt,ds]=u.useState(()=>{try{const f=navigator.userAgent||"";return/Android|iPhone|iPad|iPod|Mobile/i.test(f)}catch{return!1}}),[us,Ks]=u.useState(!1),St=u.useRef(!!ha.getState().inProgress);u.useEffect(()=>{const f=St.current,j=!!b.inProgress;f&&!j&&(b.players||[]).some(O=>(O.legs||[]).some(X=>X.finished))&&Ks(!0),St.current=j},[b.inProgress,b.players]),u.useEffect(()=>{try{return}catch{}},[]);const Ot=(()=>{const f={};for(const j of b.players||[]){let k=0,O=0;for(const X of j.legs||[])for(const le of X.visits||[])k+=Math.max(0,Number(le.doubleWindowDarts||0)),le.finishedByDouble&&(O+=1);f[j.id]={dartsAtDouble:k,doublesHit:O}}return f})(),[Ze,dt]=u.useState(null),ut=u.useRef(null),Yt=u.useRef(null);u.useEffect(()=>{if(!ce||!ft)return;const f=setInterval(()=>{Date.now()>=(ft||0)&&(xe(!1),Te(null),st({}),ct(null),cs(!1,null),et())},1e3);return()=>clearInterval(f)},[ce,ft]);function $t(){try{if(!Yt.current){const f=window.AudioContext||window.webkitAudioContext;f&&(Yt.current=new f)}Yt.current?.resume?.().catch(()=>{})}catch{}}function Tt(f,j,k=0,O=.05){const X=Yt.current;if(!X)return;const le=X.createOscillator(),de=X.createGain();le.type="square",le.frequency.value=f,de.gain.value=O,le.connect(de),de.connect(X.destination);const q=X.currentTime+k;le.start(q),le.stop(q+j/1e3)}function bs(f){$t(),Yt.current&&(f==="180"?(Tt(880,110,0,.06),Tt(1175,110,.06,.06),Tt(1568,140,.12,.06)):(Tt(659,140,0,.07),Tt(784,140,.08,.07),Tt(987,200,.16,.07)))}function gt(f,j){const k=Date.now(),O=ut.current;O&&O.kind===f&&O.by===j&&k-O.ts<500||(ut.current={kind:f,by:j,ts:k},dt({kind:f,by:j,turnIdx:b.currentPlayerIdx,ts:k}),bs(f))}const[Ys,Gt]=u.useState(!1),[Ts,ws]=u.useState([]),[Ds,Es]=u.useState("bestof"),[Xe,ot]=u.useState(5),[nt,_t]=u.useState(501),[Je,kt]=u.useState(null),[vt,zt]=u.useState("");function es(f){zt(f),setTimeout(()=>zt(""),4e3);try{t(f||"Stripe checkout failed",{type:"error"})}catch{}}const[Xt,sn]=u.useState(null),[_s,nn]=u.useState(null),[Jt,Jn]=u.useState("X01"),[qe,Kn]=u.useState("X01"),[Yn,an]=u.useState(!1),[Ls,Sn]=u.useState(30),[Xs,Xn]=u.useState(!!lt),Os=s?.username&&!s?.fullAccess?il(s.username):1/0,Ms=!s?.fullAccess&&Os<=0,[kn,Cn]=u.useState("all"),[Qn,Zn]=u.useState("all"),[dn,Tn]=u.useState("all"),[Qs,Dn]=u.useState(!1),[En,ea]=u.useState(10),{H:ta}=Ka(),sa=s?.username?wn(s.username):0,na=di(f=>f.unread),pa=(Ts||[]).filter(f=>!(kn!=="all"&&f.mode!==kn||Qn!=="all"&&Number(f.startingScore)!==Number(Qn)||dn!=="all"&&f.game!==dn||Qs&&(!sa||!f.creatorAvg||Math.abs(Number(f.creatorAvg)-Number(sa))>En)));u.useEffect(()=>{const f=j=>{const k=j?.detail||{};k.game&&Jn(k.game),(k.mode==="bestof"||k.mode==="firstto")&&Es(k.mode),typeof k.value=="number"&&isFinite(k.value)&&ot(Math.max(1,Math.floor(k.value))),typeof k.start=="number"&&isFinite(k.start)&&_t(Math.max(1,Math.floor(k.start))),Gt(!0)};return window.addEventListener("ndn:online-demo",f),()=>window.removeEventListener("ndn:online-demo",f)},[]),u.useEffect(()=>{const f=String(s?.email||"").toLowerCase();f&&Pt(`/api/friends/messages?email=${encodeURIComponent(f)}`).then(j=>j.json()).then(j=>{j?.ok&&Array.isArray(j.messages)&&H.load(j.messages)}).catch(()=>{})},[s?.email]),u.useEffect(()=>{const f=j=>{try{const k=j?.detail||{},O=Number(k.start||501);b.newMatch([s?.username||"You","Opponent"],O,r),b.addVisit(60,3),b.nextPlayer(),b.addVisit(85,3),b.nextPlayer(),b.addVisit(100,3),Kn("X01"),jt(!0)}catch{}};return window.addEventListener("ndn:online-match-demo",f),()=>window.removeEventListener("ndn:online-match-demo",f)},[]),u.useEffect(()=>(P.current=!0,un(),()=>{P.current=!1,M.current&&clearTimeout(M.current);try{E.current?.close()}catch{}}),[]),u.useEffect(()=>{H.setInGame(b.inProgress)},[b.inProgress]),u.useEffect(()=>{Ze&&b.currentPlayerIdx!==Ze.turnIdx&&dt(null)},[b.currentPlayerIdx,Ze?.turnIdx]),u.useEffect(()=>{try{i&&i.connected?i.send({type:"presence",username:s?.username||"guest",email:(s?.email||"").toLowerCase(),allowSpectate:me}):E.current&&E.current.readyState===WebSocket.OPEN&&E.current.send(JSON.stringify({type:"presence",username:s?.username||"guest",email:(s?.email||"").toLowerCase(),allowSpectate:me}))}catch{}},[me,i?.connected]),u.useEffect(()=>{const f=j=>{const k=j?.detail?.roomId;k&&(l(k),i?i.send({type:"spectate",roomId:k}):E.current?.send(JSON.stringify({type:"spectate",roomId:k})),jt(!0),Gt(!1))};return window.addEventListener("ndn:spectate-room",f),()=>window.removeEventListener("ndn:spectate-room",f)},[i]);function un(){if(i){i.connected&&(i.send({type:"join",roomId:r}),i.send({type:"presence",username:s?.username||"guest",email:(s?.email||"").toLowerCase(),allowSpectate:me}),i.send({type:"list-matches"}),d(!0));return}try{if(E.current&&(E.current.readyState===WebSocket.OPEN||E.current.readyState===WebSocket.CONNECTING))return}catch{}const f="ws://localhost:8787",j=window.location.protocol==="https:"?"wss":"ws",k=window.location.hostname,O=`${j}://${k}${window.location.port?"":":8787"}`,X=f.length>0?f:O,le=new WebSocket(X);E.current=le,le.onopen=()=>{d(!0),I.current=0,v.current?t("Reconnected to lobby",{type:"success"}):(t("Connected to lobby",{type:"success"}),v.current=!0),le.send(JSON.stringify({type:"join",roomId:r})),le.send(JSON.stringify({type:"presence",username:s?.username||"guest",email:(s?.email||"").toLowerCase(),allowSpectate:me})),le.send(JSON.stringify({type:"list-matches"}))},le.onmessage=de=>{const q=JSON.parse(de.data);if(q.type==="state"){b.importState(q.payload);const Ue=Number(q.payload._dpIndex),Lt=Number(q.payload._dpHits);Number.isFinite(Ue)&&ye(Math.max(0,Ue)),Number.isFinite(Lt)&&Qe(Math.max(0,Lt));const Qt=Number(q.payload._atcIndex),Ss=Number(q.payload._atcHits);Number.isFinite(Qt)&&ht(Math.max(0,Qt)),Number.isFinite(Ss)&&Nt(Math.max(0,Ss));try{const Re=Number(q.payload._trebleTarget),Bn=Number(q.payload._trebleHits),on=Number(q.payload._trebleDarts),ms=Number(q.payload._trebleMaxDarts);Number.isFinite(Re)&&ne(Math.max(1,Math.min(20,Re))),Number.isFinite(Bn)&&Ce(Math.max(0,Bn)),Number.isFinite(on)&&pt(Math.max(0,on)),Number.isFinite(ms)&&as(Math.max(0,ms))}catch{}try{const Re=q.payload._cricketById;Re&&typeof Re=="object"&&As(Re)}catch{}try{const Re=q.payload._shanghaiById;Re&&typeof Re=="object"&&rs(Re)}catch{}try{const Re=q.payload._halveById;Re&&typeof Re=="object"&&Rs(Re)}catch{}try{const Re=q.payload._highlowById;Re&&typeof Re=="object"&&ks(Re)}catch{}try{const Re=q.payload._killerById;Re&&typeof Re=="object"&&Ps(Re)}catch{}try{const Re=q.payload._amCricketById;Re&&typeof Re=="object"&&U(Re)}catch{}try{const Re=q.payload._baseballById;Re&&typeof Re=="object"&&ee(Re)}catch{}try{const Re=q.payload._golfById;Re&&typeof Re=="object"&&N(Re)}catch{}try{const Re=q.payload._tttState;Re&&typeof Re=="object"&&_(Re)}catch{}try{const Re=Number(q.payload._turnDarts);Number.isFinite(Re)&&ae(Math.max(0,Re))}catch{}try{const Re=q.payload._x01DoubleIn;typeof Re=="boolean"&&qs(Re)}catch{}}else if(q.type==="joined")q.id&&S(q.id);else if(q.type==="presence"||q.type==="peer-joined")Ht(Ue=>{const Lt=new Set(Ue);return q.id&&Lt.add(q.id),Array.from(Lt)});else if(q.type==="chat"){const Ue=!!(q.from&&T&&q.from===T),Lt=Ue?s?.username||"me":q.from||"peer",Qt=String(q.from||"");if(!Ue&&Qt&&a.isBlocked(Qt))return;if(Ue&&w.current&&String(q.message||"")===w.current.text){w.current=null;return}h(Ss=>[...Ss,{from:Lt,message:q.message,fromId:Qt||void 0}])}else if(q.type==="matches")ws(Array.isArray(q.matches)?q.matches:[]);else if(q.type==="invite")kt({matchId:q.matchId,fromId:q.fromId,fromName:q.fromName,calibrated:!!q.calibrated,boardPreview:q.boardPreview||null,game:q.game,mode:q.mode,value:q.value,startingScore:q.startingScore});else if(q.type==="match-start")l(q.roomId),le.send(JSON.stringify({type:"join",roomId:q.roomId})),jt(!0),Gt(!1),q.match?.game&&Kn(q.match.game),s?.username&&!s?.fullAccess&&Qi(s.username);else if(q.type==="declined")t("Invite declined",{type:"info"});else if(q.type==="error"){const Ue=typeof q.message=="string"?q.message:"Action not allowed";if(zt(Ue),q.code==="SPECTATE_NOT_ALLOWED")try{t("This player has spectating turned off.",{type:"error"})}catch{}q.code==="NOT_FOUND"&&Xt&&nn({game:Xt.game,mode:Xt.mode,value:Xt.value,startingScore:Xt.startingScore}),setTimeout(()=>zt(""),3500)}else if(q.type==="friend-invite")confirm(`${q.fromName||q.fromEmail} invited you to play ${q.game||"X01"} (${q.mode==="firstto"?"First To":"Best Of"} ${q.value||1}). Accept?`)?le.send(JSON.stringify({type:"start-friend-match",toEmail:q.fromEmail,game:q.game,mode:q.mode,value:q.value,startingScore:q.startingScore})):t("Invite declined",{type:"info"});else if(q.type==="friend-message")H.add({id:q.id||`${q.ts}-${q.from}`,from:q.from,message:q.message,ts:q.ts||Date.now()}),b.inProgress||t(`${q.from}: ${q.message}`,{type:"info"});else if(q.type==="celebration"){const Ue=q.by||"Player",Lt=q.kind==="leg"?"leg":"180";gt(Lt,Ue)}else if(q.type==="cam-code")console.log("Received cam-code:",q.code),fs(q.code),t(`Pairing code: ${q.code}`,{type:"info"});else if(q.type==="cam-peer-joined")console.log("Mobile peer joined for code:",q.code),tr(q.code);else if(q.type==="cam-answer"){console.log("Received cam-answer");const Ue=window.mobilePC;Ue&&Ue.setRemoteDescription(new RTCSessionDescription(q.payload))}else if(q.type==="cam-ice"){console.log("Received cam-ice");const Ue=window.mobilePC;Ue&&Ue.addIceCandidate(q.payload)}},le.onclose=()=>{if(d(!1),!P.current)return;const de=(I.current||0)+1;I.current=de;const q=Math.min(3e4,1e3*Math.pow(2,de-1)),Ue=Date.now();Ue-A.current>4e3&&(t(`Disconnected. Reconnecting in ${Math.round(q/1e3)}s...`,{type:"error"}),A.current=Ue),M.current&&clearTimeout(M.current),M.current=setTimeout(()=>{un()},q)}}function Qa(){const f=b.players||[],j=b.currentPlayerIdx||0,k=f[j],O=k?.legs?.[k?.legs?.length-1],X=O?O.totalScoreRemaining:b.startingScore,le=(()=>{let ms=0,ca=0;if(k?.legs)for(const Zs of k.legs){ms+=Zs.totalScoreStart-Zs.totalScoreRemaining;const sr=(Zs.visits||[]).reduce((da,Un)=>da+(Un.darts||0)-(Un.preOpenDarts||0),0);ca+=sr}return{pts:ms,darts:ca}})(),de=le.darts>0?le.pts/le.darts*3:0,q=O?.visits?.[O.visits.length-1]?.score??0;let Ue="Ã”Ã‡Ã¶";f.length===2?Ue=`${f[0]?.legsWon||0}-${f[1]?.legsWon||0}`:f.length>2&&(Ue=f.map(ms=>`${ms.name}:${ms.legsWon||0}`).join(" = "));const Lt=b.bestLegThisMatch,Qt=Lt?`${Lt.darts} darts${(()=>{const ms=f.find(ca=>ca.id===Lt.playerId);return ms?` (${ms.name})`:""})()}`:"-",Re=(ms=>{switch(ms){case"small":return"text-xs";case"large":return"text-base";default:return"text-sm"}})(ve),on=(ms=>{switch(ms){case"small":return"p-2";case"large":return"p-4";default:return"p-3"}})(Ee);return e.jsxs("div",{className:`${on} rounded-2xl bg-slate-900/40 border border-white/10 text-white ${Re}`,children:[e.jsx("div",{className:"font-semibold mb-2",children:"Match Summary"}),e.jsxs("div",{className:"grid grid-cols-2 gap-y-1",children:[e.jsx("div",{className:"opacity-80",children:"Current score"}),e.jsx("div",{className:"font-mono text-right",children:Ue}),e.jsx("div",{className:"opacity-80",children:"Current thrower"}),e.jsx("div",{className:"text-right font-semibold",children:k?.name||"Ã”Ã‡Ã¶"}),e.jsx("div",{className:"opacity-80",children:"Score remaining"}),e.jsx("div",{className:"text-right font-mono font-bold text-lg",children:X}),e.jsx("div",{className:"opacity-80",children:"3-dart avg"}),e.jsx("div",{className:"text-right font-mono",children:de.toFixed(1)}),e.jsx("div",{className:"opacity-80",children:"Last score"}),e.jsx("div",{className:"text-right font-mono",children:q}),e.jsx("div",{className:"opacity-80",children:"Best leg"}),e.jsx("div",{className:"text-right",children:Qt})]})]})}u.useEffect(()=>{if(!i)return;d(i.connected);const f=i.addListener(j=>{try{if(j.type==="state"){b.importState(j.payload);try{const k=Number(j.payload._dpIndex),O=Number(j.payload._dpHits);Number.isFinite(k)&&ye(Math.max(0,k)),Number.isFinite(O)&&Qe(Math.max(0,O))}catch{}try{const k=Number(j.payload._atcIndex),O=Number(j.payload._atcHits);Number.isFinite(k)&&ht(Math.max(0,k)),Number.isFinite(O)&&Nt(Math.max(0,O))}catch{}try{const k=j.payload._cricketById;k&&typeof k=="object"&&As(k)}catch{}try{const k=j.payload._shanghaiById;k&&typeof k=="object"&&rs(k)}catch{}try{const k=j.payload._halveById;k&&typeof k=="object"&&Rs(k)}catch{}try{const k=j.payload._highlowById;k&&typeof k=="object"&&ks(k)}catch{}try{const k=j.payload._killerById;k&&typeof k=="object"&&Ps(k)}catch{}try{const k=j.payload._amCricketById;k&&typeof k=="object"&&U(k)}catch{}try{const k=j.payload._baseballById;k&&typeof k=="object"&&ee(k)}catch{}try{const k=j.payload._golfById;k&&typeof k=="object"&&N(k)}catch{}try{const k=j.payload._tttState;k&&typeof k=="object"&&_(k)}catch{}try{const k=Number(j.payload._turnDarts);Number.isFinite(k)&&ae(Math.max(0,k))}catch{}try{const k=!!j.payload._paused;xe(k)}catch{}try{const k=Number(j.payload._pauseEndsAt);ct(Number.isFinite(k)?k:null)}catch{}try{const k=j.payload._pauseRequestedBy;Te(typeof k=="string"?k:null)}catch{}try{const k=j.payload._pauseAcceptedBy;k&&typeof k=="object"&&st(k)}catch{}try{const k=Number(j.payload._pauseDurationSec);Number.isFinite(k)&&is(Math.max(60,Math.min(600,k)))}catch{}try{const k=j.payload._x01DoubleIn;typeof k=="boolean"&&qs(k)}catch{}cs(!!j.payload._paused,Number(j.payload._pauseEndsAt)||null)}else if(j.type==="joined")j.id&&S(j.id);else if(j.type==="presence"||j.type==="peer-joined")Ht(k=>Array.from(new Set([...k||[],j.id].filter(Boolean))));else if(j.type==="chat"){const k=!!(j.from&&T&&j.from===T),O=k?s?.username||"me":j.from||"peer",X=String(j.from||"");if(!k&&X&&a.isBlocked(X))return;h(le=>[...le,{from:O,message:j.message,fromId:X||void 0}])}else if(j.type==="matches")ws(Array.isArray(j.matches)?j.matches:[]);else if(j.type==="invite")kt({matchId:j.matchId,fromId:j.fromId,fromName:j.fromName,calibrated:!!j.calibrated,boardPreview:j.boardPreview||null,game:j.game,mode:j.mode,value:j.value,startingScore:j.startingScore});else if(j.type==="match-start")l(j.roomId),i.send({type:"join",roomId:j.roomId}),jt(!0),Gt(!1),j.match?.game&&Kn(j.match.game),s?.username&&!s?.fullAccess&&Qi(s.username);else if(j.type==="declined")t("Invite declined",{type:"info"});else if(j.type==="error"){const k=typeof j.message=="string"?j.message:"Action not allowed";if(zt(k),j.code==="SPECTATE_NOT_ALLOWED")try{t("This player has spectating turned off.",{type:"error"})}catch{}j.code==="NOT_FOUND"&&Xt&&nn({game:Xt.game,mode:Xt.mode,value:Xt.value,startingScore:Xt.startingScore}),setTimeout(()=>zt(""),3500)}else if(j.type==="friend-invite")confirm(`${j.fromName||j.fromEmail} invited you to play ${j.game||"X01"} (${j.mode==="firstto"?"First To":"Best Of"} ${j.value||1}). Accept?`)?i.send({type:"start-friend-match",toEmail:j.fromEmail,game:j.game,mode:j.mode,value:j.value,startingScore:j.startingScore}):t("Invite declined",{type:"info"});else if(j.type==="friend-message")H.add({id:j.id||`${j.ts}-${j.from}`,from:j.from,message:j.message,ts:j.ts||Date.now()}),b.inProgress||t(`${j.from}: ${j.message}`,{type:"info"});else if(j.type==="celebration"){const k=j.by||"Player",O=j.kind==="leg"?"leg":"180";gt(O,k)}}catch{}});return i.connected&&(i.send({type:"join",roomId:r}),i.send({type:"presence",username:s?.username||"guest",email:(s?.email||"").toLowerCase(),allowSpectate:me}),i.send({type:"list-matches"})),()=>{f()}},[i?.connected]);function et(){if(i){i.send({type:"state",payload:{...b,_turnIdx:ie,_participants:Ne,_dpIndex:$e,_dpHits:Se,_atcIndex:Be,_atcHits:Ye,_trebleTarget:C,_trebleHits:Ae,_trebleDarts:ze,_trebleMaxDarts:Dt,_x01DoubleIn:Et,_cricketById:gs,_shanghaiById:ys,_halveById:Ns,_highlowById:Vt,_killerById:Zt,_amCricketById:Cs,_baseballById:K,_golfById:G,_tttState:L,_turnDarts:Y,_paused:ce,_pauseEndsAt:ft,_pauseRequestedBy:je,_pauseAcceptedBy:Mt,_pauseDurationSec:bt}});return}const f=E.current;!f||f.readyState!==WebSocket.OPEN||f.send(JSON.stringify({type:"state",payload:{...b,_turnIdx:ie,_participants:Ne,_dpIndex:$e,_dpHits:Se,_atcIndex:Be,_atcHits:Ye,_trebleTarget:C,_trebleHits:Ae,_trebleDarts:ze,_trebleMaxDarts:Dt,_x01DoubleIn:Et,_cricketById:gs,_shanghaiById:ys,_halveById:Ns,_highlowById:Vt,_killerById:Zt,_amCricketById:Cs,_baseballById:K,_golfById:G,_tttState:L,_turnDarts:Y,_paused:ce,_pauseEndsAt:ft,_pauseRequestedBy:je,_pauseAcceptedBy:Mt,_pauseDurationSec:bt}}))}function yi(f){const j=s?.username||"me";if(h(O=>[...O,{from:j,message:f,fromId:T||"self"}]),w.current={text:f,ts:Date.now()},i){i.send({type:"chat",message:f});return}const k=E.current;!k||k.readyState!==WebSocket.OPEN||k.send(JSON.stringify({type:"chat",message:f}))}function rn(f){if(ii(f,$e)){const k=Se+1,O=$e+1;Qe(k),ye(O);try{if(k>=Ws.length){const X=b.players[b.currentPlayerIdx]?.name||"Player";gt("leg",X),Qe(0),ye(0)}}catch{}}et()}function aa(){const f=Math.max(0,Math.floor(se|0));rn(f),Z(0)}function mn(){const f=cn(Ke);f!=null&&(rn(f),mt(""))}function vi(f,j,k){const O=ss[Be];return O==null?!1:typeof k=="number"&&k>=1&&k<=20&&k===O&&(j==="SINGLE"||j==="DOUBLE"||j==="TRIPLE")?!0:O===25?j==="BULL"||f===25:O===50?j==="INNER_BULL"||f===50:f===O||f===O*2||f===O*3}function Mn(f,j,k){if(vi(f,j,k)){const O=Ye+1,X=Be+1;Nt(O),ht(X);try{if(O>=ss.length){const le=b.players[b.currentPlayerIdx]?.name||"Player";gt("leg",le),Nt(0),ht(0)}}catch{}}et()}function Za(){const f=Math.max(0,Math.floor(se|0));Mn(f),Z(0)}function ra(){const f=cn(it);f!=null&&(Mn(f),yt(""))}function Aa(f,j,k){if(Dt>0&&ze>=Dt)return;(j==="TRIPLE"&&k===C||!j&&f===C*3)&&Ce(X=>X+1),pt(X=>{const le=X+1;if(le%3===0&&[20,19,18].includes(C)){const de=[20,19,18],q=de.indexOf(C),Ue=de[(q+1)%de.length];ne(Ue)}return le}),et()}function ia(){const f=Math.max(0,Math.floor(se|0));Aa(f),Z(0)}function er(){const f=cn(ns);f!=null&&(Aa(f),Bt(""))}function ba(){Ce(0),pt(0)}function It(){return b.players[b.currentPlayerIdx]?.id??String(b.currentPlayerIdx)}function In(f){gs[f]||As(j=>({...j,[f]:Hn()}))}function os(f){ys[f]||rs(j=>({...j,[f]:vn()}))}function ts(f){Ns[f]||Rs(j=>({...j,[f]:jn()}))}function oa(f){Vt[f]||ks(j=>({...j,[f]:Nn()}))}function An(f){if(!Zt[f]){const j=new Set(Object.values(Zt||{}).map(X=>X.number)),k=[];for(let X=1;X<=20;X++)j.has(X)||k.push(X);const O=k.length>0?k[Math.floor(Math.random()*k.length)]:20;Ps(X=>({...X,[f]:_l(O,3)}))}}function Ra(f){Cs[f]||U(j=>({...j,[f]:Da()}))}function hn(f){K[f]||ee(j=>({...j,[f]:ka()}))}function fn(f){G[f]||N(j=>({...j,[f]:Ca()}))}u.useEffect(()=>{ae(0)},[b.currentPlayerIdx,qe]);function Rn(f,j){const k=b.players.filter(O=>O.id!==j);return k.length===0?!1:k.every(O=>(gs[O.id]?.marks?.[f]||0)>=3)}function Vs(f,j,k){const O=It();In(O),As(le=>{const de={...le},q={...de[O]||Hn()};return Rl(q,f,j,k,Ue=>Rn(Ue,O)),de[O]=q,de});const X=Y+1;ae(X),X>=3&&(ae(0),b.nextPlayer()),et()}function Pn(f,j,k){const O=It();os(O),rs(le=>{const de={...le},q={...de[O]||vn()};return Pl(q,f,j,k),de[O]=q,de});const X=Y+1;ae(X),X>=3&&(rs(le=>{const de={...le},q={...de[O]||vn()};return Ll(q),de[O]=q,de}),ae(0),b.nextPlayer()),et()}function Ln(f,j,k){const O=It();ts(O),Rs(le=>{const de={...le},q={...de[O]||jn()};return Ol(q,f,j,k),de[O]=q,de});const X=Y+1;ae(X),X>=3&&(Rs(le=>{const de={...le},q={...de[O]||jn()};return Bl(q),de[O]=q,de}),ae(0),b.nextPlayer()),et()}function xn(f,j,k){const O=It();oa(O),ks(le=>{const de={...le},q={...de[O]||Nn()};return Ul(q,f,j,k),de[O]=q,de});const X=Y+1;ae(X),X>=3&&(ks(le=>{const de={...le},q={...de[O]||Nn()};return $l(q),de[O]=q,de}),ae(0),b.nextPlayer()),et()}function Fs(f,j){const k=It();b.players.forEach(X=>An(X.id)),Ps(X=>{const le={};for(const[q,Ue]of Object.entries(X))le[q]={...Ue};oi(k,le,f,j);const de=li(le);if(de)try{gt("leg",b.players.find(q=>q.id===de)?.name||"Player")}catch{}return le});const O=Y+1;ae(O),O>=3&&(ae(0),b.nextPlayer()),et()}function On(f,j,k){const O=It();Ra(O),U(le=>{const de={...le},Ue={...de[O]||Da()};return ql(Ue,f,j,k,Qt=>b.players.filter(Ss=>Ss.id!==O).every(Ss=>(Cs[Ss.id]?.marks?.[Qt]||0)>=3)),de[O]=Ue,de});const X=Y+1;ae(X),X>=3&&(ae(0),b.nextPlayer()),et()}function ga(f,j,k){const O=It();hn(O),ee(le=>{const de={...le},q={...de[O]||ka()};return Fl(q,f,j,k),de[O]=q,de});const X=Y+1;ae(X),X>=3&&(ae(0),b.nextPlayer()),et()}function Pa(f,j,k){const O=It();fn(O),N(le=>{const de={...le},q={...de[O]||Ca()};return Wl(q,f,j,k),de[O]=q,de});const X=Y+1;ae(X),X>=3&&(ae(0),b.nextPlayer()),et()}function la(f,j,k,O){_(le=>{const de={...le,board:[...le.board]};return zl(de,f,j,k,O),de});const X=Y+1;ae(X),X>=3&&(ae(0),b.nextPlayer()),et()}function La(){try{window.dispatchEvent(new Event("ndn:open-manual"))}catch{}}function qt(f){const j=Math.max(0,f|0);try{const X=b.players[b.currentPlayerIdx],le=X?.legs?.[X.legs.length-1],de=le?le.totalScoreRemaining:b.startingScore,q=Math.max(0,de-j),Ue=de<=50?3:q<=50?1:0,Lt=q===0;b.addVisit(j,3,{preOpenDarts:0,doubleWindowDarts:Ue,finishedByDouble:Lt,visitTotal:j})}catch{b.addVisit(j,3)}Z(0);const k=b.players[b.currentPlayerIdx],O=k.legs[k.legs.length-1];try{j===180&&gt("180",k?.name||"Player"),O&&O.totalScoreRemaining===0&&gt("leg",k?.name||"Player")}catch{}if(O&&O.totalScoreRemaining===0?b.endLeg(j):b.nextPlayer(),R){const X=O?O.totalScoreRemaining:b.startingScore;yn(s?.username||"Player",j,Math.max(0,X),F,{volume:D,checkoutOnly:Q})}s?.username&&k?.name===s.username&&gn(s.username,3,j),et()}function ya(f,j){const k={type:"report",offenderId:f,reason:"Inappropriate language",message:j};try{i?i.send(k):E.current?.send(JSON.stringify(k))}catch{}try{t("Report submitted",{type:"info"})}catch{}}async function Oa(){try{const f=await navigator.mediaDevices.getUserMedia({video:!0,audio:!1}),j=f.getVideoTracks?.()[0],k=document.createElement("video");k.srcObject=f,await k.play().catch(()=>{}),await new Promise(Ue=>setTimeout(Ue,120));const O=Math.min(320,k.videoWidth||320),X=Math.max(1,Math.floor((k.videoHeight||180)*(O/Math.max(1,k.videoWidth||320)))),le=document.createElement("canvas");le.width=O,le.height=X,le.getContext("2d").drawImage(k,0,0,O,X);const q=le.toDataURL("image/jpeg",.7);try{j&&j.stop()}catch{}try{f.getTracks?.().forEach(Ue=>Ue.stop())}catch{}return q}catch{return null}}const tr=async f=>{console.log("Starting WebRTC for code:",f);try{const j=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}]});j.ontrack=O=>{console.log("Received track:",O.streams[0]),Us(O.streams[0]),ls.current&&(ls.current.srcObject=O.streams[0],console.log("Set video srcObject"))},j.onicecandidate=O=>{O.candidate&&(console.log("Sending ICE candidate"),i?i.send({type:"cam-ice",code:f,payload:O.candidate}):E.current&&E.current.readyState===WebSocket.OPEN&&E.current.send(JSON.stringify({type:"cam-ice",code:f,payload:O.candidate})))},j.onconnectionstatechange=()=>console.log("Connection state:",j.connectionState);const k=await j.createOffer();if(await j.setLocalDescription(k),console.log("Sending offer"),i)console.log("Sending offer via wsGlobal"),i.send({type:"cam-offer",code:f,payload:k});else if(E.current&&E.current.readyState===WebSocket.OPEN)console.log("Sending offer via wsRef"),E.current.send(JSON.stringify({type:"cam-offer",code:f,payload:k}));else{console.log("WS not available, POSTing offer to /cam/signal");try{await Pt(`/cam/signal/${f}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({type:"cam-offer",payload:k,source:"desktop"})})}catch(O){console.warn("REST offer failed",O)}}window.mobilePC=j}catch(j){console.error("WebRTC error:",j),t("Failed to start mobile camera",{type:"error"})}};return e.jsxs("div",{className:"card ndn-game-shell relative overflow-hidden",children:[e.jsx("h2",{className:"text-xl font-semibold mb-1",children:"Online Play"}),e.jsxs("div",{className:"ndn-shell-body",children:[ce&&e.jsxs("div",{className:"absolute inset-0 z-40 bg-black/60 backdrop-blur-sm flex flex-col items-center justify-center text-center p-4",children:[e.jsx("div",{className:"text-2xl font-bold mb-2",children:"Game Paused"}),e.jsxs("div",{className:"text-sm opacity-80 mb-4",children:["Resumes ",ft?`in ${Math.max(0,Math.ceil((ft-Date.now())/1e3))}s`:"soon"]}),e.jsx("div",{className:"text-xs opacity-60",children:"Both players can see this pause screen."})]}),na>0&&!b.inProgress&&e.jsxs("div",{className:"mb-3 text-sm px-3 py-2 rounded bg-amber-600/30 border border-amber-500/40",children:["You have ",na," unread message",na>1?"s":"",". Check the Friends tab."]}),e.jsx("div",{className:"relative",children:e.jsxs("div",{className:"rounded-2xl bg-white/5 backdrop-blur border border-white/10 p-2 flex items-center gap-2 overflow-x-auto no-scrollbar",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"text-xs opacity-70 shrink-0",children:"Room"}),e.jsx("input",{className:"input w-28",value:r,onChange:f=>l(f.target.value),placeholder:"room-1"})]}),o?e.jsx("span",{className:"text-[11px] px-2 py-1 rounded-full bg-emerald-600/20 text-emerald-200 border border-emerald-400/40 shrink-0",children:"Connected"}):e.jsx("button",{className:"btn bg-rose-600 hover:bg-rose-700 shrink-0",onClick:un,children:"Connect"}),e.jsx("button",{className:"btn shrink-0",onClick:et,disabled:!o,children:"Sync"}),!ce&&!je&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"text-xs opacity-70",children:"Pause (max 10m)"}),e.jsxs("select",{className:"input w-28",value:bt,onChange:f=>is(Math.max(60,Math.min(600,parseInt(f.target.value)||300))),children:[e.jsx("option",{value:120,children:"2 min"}),e.jsx("option",{value:300,children:"5 min"}),e.jsx("option",{value:600,children:"10 min"})]}),e.jsx("button",{className:"btn",disabled:!o,onClick:()=>{const f=s?.username||"player";Te(f),st({[f]:!0}),xe(!1),ct(null),et()},children:"Request Pause"})]}),!ce&&je&&!Mt[s?.username||""]&&e.jsxs("div",{className:"flex items-center gap-2 text-xs",children:[e.jsxs("span",{className:"opacity-80",children:[je," requested a ",Math.round((bt||300)/60),"m pause"]}),e.jsx("button",{className:"btn bg-emerald-600 hover:bg-emerald-700",onClick:()=>{const f=s?.username||"",j={...Mt,[f]:!0};st(j);const k=Object.keys(j).filter(X=>!!j[X]).length,O=Math.max(2,Ne?.length||2);if(k>=2||k>=O){const X=Date.now()+Math.min(600,Math.max(60,bt||300))*1e3;xe(!0),ct(X),cs(!0,X)}et()},children:"Accept"}),e.jsx("button",{className:"btn bg-rose-600 hover:bg-rose-700",onClick:()=>{Te(null),st({}),xe(!1),ct(null),cs(!1,null),et()},children:"Decline"})]}),ce&&e.jsxs("span",{className:"text-[11px] px-2 py-1 rounded-full bg-yellow-500/25 text-yellow-100 border border-yellow-400/40 shrink-0",children:["Paused Â· ",Math.max(0,Math.ceil(((ft||Date.now())-Date.now())/1e3)),"s"]}),e.jsx("button",{className:"text-[11px] px-3 py-1 rounded-full bg-indigo-500/25 text-indigo-100 border border-indigo-400/40 hover:bg-indigo-500/40 shrink-0",title:"Open a simulated online match demo",onClick:()=>{try{window.dispatchEvent(new CustomEvent("ndn:online-match-demo",{detail:{game:"X01",start:501}}))}catch{}},children:"DEMO"}),o&&e.jsx("button",{className:"btn shrink-0",onClick:()=>jt(!0),disabled:Ms,title:Ms?"Weekly free games used":"",children:"Open Match"})]})}),e.jsx("div",{className:`mt-3 p-3 rounded-xl bg-indigo-500/10 border border-indigo-500/40 flex items-center justify-end ${!o||Ms?"opacity-60 cursor-not-allowed":"cursor-pointer"}`,role:"button",title:o?Ms?"Weekly free games used":"Create a new match":"Connect to the lobby first",onClick:()=>{!o||Ms||(Gt(!0),i?i.send({type:"list-matches"}):E.current?.send(JSON.stringify({type:"list-matches"})))},children:e.jsx("button",{className:"btn",disabled:!o||Ms,children:"Create Match +"})}),e.jsx("p",{className:"text-sm text-slate-600 mt-3",children:"Open this app on another device and join the same Room ID to sync scores."}),!s?.fullAccess&&e.jsxs("div",{className:"text-xs text-slate-400 mt-1",children:["Weekly free online games remaining: ",Os===1/0?"Ã”Ã‡Ã¶":Os]}),!s?.fullAccess&&Os!==1/0&&Os<=0&&e.jsx("div",{className:"mt-2 p-2 rounded-lg bg-rose-700/30 border border-rose-600/40 text-rose-200 text-sm",children:"You've used your 3 free online games this week. PREMIUM required to continue."}),vt&&e.jsxs("div",{className:"mt-2 p-2 rounded-lg bg-rose-700/30 border border-rose-600/40 text-rose-200 text-sm font-semibold flex items-center gap-2",children:[e.jsx("span",{className:"material-icons text-rose-300",children:"error_outline"}),vt]}),_s&&e.jsxs("div",{className:"mt-2 p-2 rounded-lg bg-indigo-700/30 border border-indigo-600/40 text-indigo-100 text-sm flex items-center justify-between gap-2",children:[e.jsx("div",{children:"That room is full or no longer available. Create a new clean room with the same settings?"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{className:"btn px-3 py-1 text-sm",onClick:()=>{const{game:f,mode:j,value:k,startingScore:O}=_s,X=s?.username?wn(s.username):0;i?(i.send({type:"create-match",game:f,mode:j,value:k,startingScore:O||501,creatorAvg:X}),i.send({type:"list-matches"})):(E.current?.send(JSON.stringify({type:"create-match",game:f,mode:j,value:k,startingScore:O||501,creatorAvg:X})),E.current?.send(JSON.stringify({type:"list-matches"}))),nn(null)},children:"Create New Match"}),e.jsx("button",{className:"btn bg-slate-700 hover:bg-slate-800 px-3 py-1 text-sm",onClick:()=>nn(null),children:"Dismiss"})]})]}),o&&e.jsxs("div",{className:"mt-4 p-3 rounded-xl border border-indigo-500/40 bg-indigo-500/10 flex-1 overflow-auto",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("div",{className:"font-semibold",children:"World Lobby"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"text-xs opacity-80",children:["Matches: ",pa.length]}),e.jsx("button",{className:"btn px-3 py-1 text-sm",onClick:()=>i?i.send({type:"list-matches"}):E.current?.send(JSON.stringify({type:"list-matches"})),children:"Refresh"}),e.jsx("button",{className:"btn px-3 py-1 text-sm",title:o?Ms?"Weekly free games used":"Create a new match":"Connect to the lobby first",disabled:!o||Ms,onClick:()=>{!o||Ms||(Gt(!0),i?i.send({type:"list-matches"}):E.current?.send(JSON.stringify({type:"list-matches"})))},children:"Create Match +"})]})]}),e.jsxs("div",{className:"space-y-3 mb-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs opacity-70 mb-1",children:"Mode"}),e.jsx(Xa,{tabs:[{key:"all",label:"All"},{key:"bestof",label:"Best of"},{key:"firstto",label:"First to"}],active:kn,onChange:f=>Cn(f)})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-2",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs opacity-70 mb-1",children:"Game"}),e.jsxs("select",{className:"input w-full",value:dn,onChange:f=>Tn(f.target.value),children:[e.jsx("option",{value:"all",children:"All"}),Ia.map(f=>e.jsx("option",{value:f,children:f},f))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs opacity-70 mb-1",children:"Starting Score"}),e.jsxs("select",{className:"input w-full",value:Qn,onChange:f=>{const j=f.target.value;Zn(j==="all"?"all":Number(j))},disabled:dn!=="all"&&dn!=="X01",children:[e.jsx("option",{value:"all",children:"All"}),e.jsx("option",{value:"301",children:"301"}),e.jsx("option",{value:"501",children:"501"}),e.jsx("option",{value:"701",children:"701"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs opacity-70 mb-1",children:"Opponent near my avg"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{id:"nearavg",type:"checkbox",className:"accent-purple-500",checked:Qs,onChange:f=>Dn(f.target.checked),disabled:!sa}),e.jsx("label",{htmlFor:"nearavg",className:"cursor-pointer text-sm",children:"Near my average"}),e.jsx("input",{className:"input w-24",type:"number",min:5,max:40,step:1,value:En,onChange:f=>ea(parseInt(f.target.value||"10")),disabled:!Qs})]})]})]}),e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsxs("div",{className:"flex-1 max-w-sm",children:[e.jsx("label",{className:`block text-xs opacity-70 mb-1 ${Qs?"":"opacity-40"}`,children:"Avg tolerance (Â±)"}),e.jsx("input",{className:"w-full",type:"range",min:1,max:50,value:En,onChange:f=>ea(parseInt(f.target.value||"10")),disabled:!Qs}),e.jsxs("div",{className:"text-xs opacity-70 mt-1",children:["Â± ",En]})]}),e.jsx("button",{className:"btn px-3 py-1 text-sm",onClick:()=>{Cn("all"),Tn("all"),Zn("all"),Dn(!1),ea(10)},children:"Reset"})]})]}),pa.length===0?e.jsx("div",{className:"text-sm text-slate-300",children:"No games waiting. Create one!"}):e.jsx("div",{className:"space-y-2",children:pa.map(f=>e.jsxs("div",{className:"p-3 rounded-lg bg-black/20 flex items-center justify-between relative",children:[e.jsxs("div",{className:"text-sm",children:[e.jsxs("div",{children:[f.game||"X01"," ",f.game==="X01"?` ${f.startingScore}`:""," - ",f.mode==="bestof"?`Best Of ${f.value}`:`First To ${f.value}`," - Created by ",f.creatorName]}),f.requireCalibration&&e.jsx("div",{className:"text-[11px] inline-flex items-center gap-1 px-1.5 py-0.5 rounded bg-emerald-500/20 text-emerald-300 border border-emerald-600/30 mt-1",children:"Calibration required"}),f.creatorAvg?e.jsxs("div",{className:"text-xs opacity-70",children:["Creator avg: ",Number(f.creatorAvg).toFixed(1)]}):null,e.jsxs("div",{className:"text-xs opacity-70",children:["ID: ",f.id]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{className:"btn px-3 py-1 text-sm bg-green-600 hover:bg-green-700",disabled:Ms||!s?.fullAccess&&bn.includes(f.game)||!!f.requireCalibration&&!ta,title:!s?.fullAccess&&bn.includes(f.game)?"PREMIUM game":Ms?"Weekly free games used":f.requireCalibration&&!ta?"Calibration required":"",onClick:async()=>{sn({game:f.game,mode:f.mode,value:f.value,startingScore:f.startingScore});const j=!!ta,k=await Oa();try{i?i.send({type:"join-match",matchId:f.id,calibrated:j,boardPreview:k}):E.current?.send(JSON.stringify({type:"join-match",matchId:f.id,calibrated:j,boardPreview:k}))}catch(O){es(O?.message||"Failed to create Stripe checkout session. Please try again later.")}},children:"Join Now!"}),T&&f.creatorId===T&&e.jsx("button",{className:"w-6 h-6 rounded-full bg-rose-600 hover:bg-rose-700 text-white text-xs flex items-center justify-center shadow",title:"Close this match",onClick:()=>{i?i.send({type:"cancel-match",matchId:f.id}):E.current?.send(JSON.stringify({type:"cancel-match",matchId:f.id}))},"aria-label":"Close match",children:"Ã—"})]})]},f.id))})]}),!s?.fullAccess&&Os!==1/0&&Os<=0&&e.jsxs("div",{className:"absolute inset-0 z-40 flex items-center justify-center",children:[e.jsx("div",{className:"absolute inset-0 backdrop-blur-sm bg-slate-900/40"}),e.jsxs("div",{className:"relative z-10 p-4 rounded-xl bg-black/60 border border-slate-700 text-center",children:[e.jsx("div",{className:"text-3xl mb-2",children:"Â­Æ’Ã¶Ã†"}),e.jsx("div",{className:"font-semibold",children:"Online play locked"}),e.jsx("div",{className:"text-sm text-slate-200/80",children:"YouÃ”Ã‡Ã–ve used your 3 free online games this week. Upgrade to PREMIUM to play all modes."}),e.jsxs("button",{onClick:async()=>{try{const j=await(await fetch(`${n}/api/stripe/create-checkout-session`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:s?.email})})).json();j.ok&&j.url?window.location.href=j.url:alert("Failed to create payment session: "+(j.error||"Unknown error"))}catch{alert("Network error")}},className:"btn mt-3 bg-gradient-to-r from-indigo-500 to-fuchsia-600 text-white font-bold",children:["Upgrade to PREMIUM = ",ul(ml(),5)]})]})]}),hs&&e.jsxs("div",{className:"fixed inset-0 z-50",children:[e.jsx("div",{className:"absolute inset-0 bg-black/50 backdrop-blur-sm"}),e.jsxs("div",{className:"absolute inset-0 flex flex-col",children:[e.jsxs("div",{className:"p-2 md:p-3 flex items-center justify-between",children:[e.jsx("div",{children:e.jsx("h3",{className:"text-xl md:text-2xl font-bold",children:"Online Match"})}),e.jsx("button",{className:"btn px-3 py-1",onClick:()=>jt(!1),children:"Close"})]}),e.jsx("div",{className:"relative flex-1 overflow-hidden p-2 md:p-3",children:e.jsxs("div",{className:"card w-full h-full overflow-hidden relative p-2.5 md:p-3",children:[Ze&&e.jsxs("div",{className:"absolute inset-0 pointer-events-none flex items-start justify-center pt-8 z-20",children:[e.jsxs("div",{className:`px-4 py-2 rounded-full text-lg font-bold shadow ${Ze.kind==="leg"?"bg-indigo-500/20 border border-indigo-400/40 text-indigo-100":"bg-emerald-500/20 border border-emerald-400/40 text-emerald-100"}`,children:[Ze.kind==="leg"?"Â­Æ’Ã…Ã¼ LEG WON Ã”Ã‡Ã¶ ":"Â­Æ’Ã„Â» ONE HUNDRED AND EIGHTY! Ã”Ã‡Ã¶ ",Ze.by]}),Ze.kind==="leg"&&e.jsxs(e.Fragment,{children:[e.jsx("style",{children:"@keyframes ndn-confetti-fall{0%{transform:translateY(-10%) rotate(0deg);opacity:1}100%{transform:translateY(120%) rotate(360deg);opacity:0}}"}),e.jsx("div",{className:"absolute inset-0 pointer-events-none",children:[...Array(24)].map((f,j)=>{const k=Math.random()*100,O=Math.random()*.2,X=1.2+Math.random()*.8,le=6+Math.random()*6,de=Math.floor(Math.random()*360);return e.jsx("span",{style:{position:"absolute",top:0,left:k+"%",width:le,height:le,background:`hsl(${de} 90% 60%)`,borderRadius:2,animation:`ndn-confetti-fall ${X}s ease-out ${O}s forwards`}},j)})})]})]}),e.jsxs("div",{className:"mb-1.5 text-xs md:text-sm flex items-center justify-between gap-2",children:[e.jsxs("span",{children:["Participants: ",Ne.length||1]}),e.jsx("button",{className:"text-[11px] px-2 py-0.5 rounded-full bg-slate-700/50 hover:bg-slate-700 border border-slate-600",onClick:()=>ds(f=>!f),title:Wt?"Switch to full multi-player view":"Switch to compact player-by-player view",children:Wt?"Full view":"Compact view"})]}),(()=>{const f=b.players?.[0]?.legsWon||0,j=b.players?.[1]?.legsWon||0;return e.jsx(Vl,{left:e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"hidden xs:inline px-2 py-0.5 rounded-full bg-indigo-500/20 text-indigo-200 border border-indigo-400/30 text-[10px] sm:text-xs",children:"Game Mode"}),e.jsxs("span",{className:"font-medium whitespace-nowrap",children:[qe,qe==="X01"?` / ${b.startingScore}`:""]}),e.jsxs("span",{className:"opacity-80 whitespace-nowrap",children:["Legs ",f,"â€“",j]})]}),right:e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"opacity-70 text-[10px]",children:"Match"}),e.jsxs("select",{className:`btn ${Oe}`,value:te,onChange:k=>oe(k.target.value),children:[e.jsx("option",{value:"singles",children:"Singles"}),e.jsx("option",{value:"doubles",children:"Doubles"})]}),e.jsx("input",{className:`input ${Oe} w-[7.5rem]`,value:He,onChange:k=>We(k.target.value),placeholder:"Team A"}),e.jsx("span",{className:"opacity-50",children:"vs"}),e.jsx("input",{className:`input ${Oe} w-[7.5rem]`,value:we,onChange:k=>Ie(k.target.value),placeholder:"Team B"})]})})})(),Wt?e.jsxs("div",{className:"mb-3",children:[(()=>{const f=b.currentPlayerIdx,j=b.players[f];if(!j)return null;const k=j.legs[j.legs.length-1],O=k?k.totalScoreRemaining:b.startingScore,X=s?.username&&j.name===s.username,le=k&&k.visits.length?k.visits[k.visits.length-1].score:0,de=(()=>{let Ue=0,Lt=0;for(const Qt of j?.legs||[])Ue+=Qt.totalScoreStart-Qt.totalScoreRemaining,Lt+=(Qt.visits||[]).reduce((Ss,Re)=>Ss+(Re.darts||0)-(Re.preOpenDarts||0),0);return{pts:Ue,d:Lt}})(),q=de.d>0?de.pts/de.d*3:0;return qe==="X01"?e.jsxs("div",{className:`p-4 rounded-xl bg-brand-50 text-black ${f===b.currentPlayerIdx?"ring-2 ring-brand-400":""}`,children:[e.jsxs("div",{className:"text-xs text-slate-600 flex items-center justify-between",children:[e.jsx("span",{className:"font-semibold",children:j.name}),e.jsx("span",{className:`px-2 py-0.5 rounded-full ${f===b.currentPlayerIdx?"bg-emerald-500/20 text-emerald-300":"bg-slate-500/20 text-slate-300"} text-xs font-bold`,children:f===b.currentPlayerIdx?"THROWING":"WAITING TO THROW"})]}),e.jsx("div",{className:"text-4xl font-extrabold",children:O}),e.jsxs("div",{className:"text-sm mt-1",children:["Last score: ",e.jsx("span",{className:"font-semibold",children:le})]}),e.jsxs("div",{className:"text-sm",children:["3-Dart Avg: ",e.jsx("span",{className:"font-semibold",children:q.toFixed(1)})]}),X&&f===b.currentPlayerIdx&&O<=170&&O>0&&e.jsxs("div",{className:"mt-2 p-2 rounded-lg bg-indigo-50 border border-indigo-200 text-indigo-900 text-sm",children:["Checkout suggestions (fav ",W,"): ",ri(O,W).join("  Ã”Ã‡Ã³  ")||"Ã”Ã‡Ã¶"]})]}):e.jsxs("div",{className:`p-4 rounded-xl bg-brand-50 text-black ${f===b.currentPlayerIdx?"ring-2 ring-brand-400":""}`,children:[e.jsxs("div",{className:"text-xs text-slate-600 flex items-center justify-between",children:[e.jsx("span",{className:"font-semibold",children:j.name}),e.jsx("span",{className:`px-2 py-0.5 rounded-full ${f===b.currentPlayerIdx?"bg-emerald-500/20 text-emerald-300":"bg-slate-500/20 text-slate-300"} text-xs font-bold`,children:f===b.currentPlayerIdx?"THROWING":"WAITING TO THROW"})]}),e.jsx("div",{className:"text-sm opacity-80",children:qe}),qe==="Double Practice"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"mt-1 text-xs flex items-center justify-between",children:[e.jsx("span",{children:"Current target"}),e.jsx("span",{className:"px-2 py-0.5 rounded-full bg-emerald-500/20 text-emerald-200 border border-emerald-400/30 text-xs font-semibold",children:Ws[$e]?.label||"Ã”Ã‡Ã¶"})]}),e.jsxs("div",{className:"text-3xl font-extrabold",children:[Se," / ",Ws.length]})]}),qe==="Around the Clock"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"mt-1 text-xs flex items-center justify-between",children:[e.jsx("span",{children:"Current target"}),e.jsx("span",{className:"px-2 py-0.5 rounded-full bg-emerald-500/20 text-emerald-200 border border-emerald-400/30 text-xs font-semibold",children:ss[Be]===25?"25 (Outer Bull)":ss[Be]===50?"50 (Inner Bull)":ss[Be]||"Ã”Ã‡Ã¶"})]}),e.jsxs("div",{className:"text-3xl font-extrabold",children:[Ye," / ",ss.length]})]}),qe==="Treble Practice"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"mt-1 text-xs flex items-center justify-between",children:[e.jsx("span",{children:"Treble Target"}),e.jsxs("span",{className:"px-2 py-0.5 rounded-full bg-emerald-500/20 text-emerald-200 border border-emerald-400/30 text-xs font-semibold",children:["T",C]})]}),e.jsxs("div",{className:"text-3xl font-extrabold",children:[Ae," / ",ze]})]})]})})(),b.players.length>1&&e.jsxs("div",{className:"mt-2 text-xs text-slate-400",children:["Next up: ",b.players[(b.currentPlayerIdx+1)%b.players.length]?.name]})]}):e.jsx(e.Fragment,{children:e.jsx("div",{className:"mb-3 flex flex-wrap items-center gap-2",children:b.players.map((f,j)=>{const k=f.legs[f.legs.length-1],O=k?k.totalScoreRemaining:b.startingScore;return e.jsxs("div",{className:`px-2 py-1 rounded bg-black/20 border border-slate-700/40 text-xs ${j===b.currentPlayerIdx?"ring-1 ring-brand-400":""}`,children:[e.jsx("span",{className:"font-semibold",children:f.name}),qe==="X01"?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"opacity-70",children:" = "}),e.jsx("span",{className:"font-mono",children:O})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"opacity-70",children:" = "}),e.jsx("span",{className:"font-mono",children:qe==="Double Practice"?`${Se}/${Ws.length}`:qe==="Around the Clock"?`${Ye}/${ss.length}`:qe==="Treble Practice"?`${Ae}/${ze}`:qe==="Cricket"?`${gs[f.id]?.points||0} pts`:qe==="Shanghai"?`${ys[f.id]?.score||0} pts = R${ys[f.id]?.round||1}`:qe==="Halve It"?`${Ns[f.id]?.score||0} pts = S${(Ns[f.id]?.stage||0)+1}`:qe==="High-Low"?`${Vt[f.id]?.score||0} pts = ${Vt[f.id]?.target||"HIGH"}`:qe==="Killer"?(()=>{const X=Zt[f.id];return X?`#${X.number} = ${X.lives}Ã”Ã˜Ã± ${X.isKiller?"= K":""}`:"Ã”Ã‡Ã¶"})():qe==="American Cricket"?`${Cs[f.id]?.points||0} pts`:qe==="Baseball"?(()=>{const X=K[f.id];return X?`R${X.score} = I${X.inning}`:"Ã”Ã‡Ã¶"})():qe==="Golf"?(()=>{const X=G[f.id];return X?`S${X.strokes} = H${X.hole}`:"Ã”Ã‡Ã¶"})():qe==="Tic Tac Toe"?(()=>{const X=(L.board||[]).filter(de=>de==="X").length,le=(L.board||[]).filter(de=>de==="O").length;return`X${X}-O${le}`})():qe})]})]},`strip-${f.id}`)})})}),Wt?e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"flex flex-col gap-2 mb-2",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{className:`btn ${Oe}`,onClick:()=>{try{window.dispatchEvent(new Event("ndn:open-autoscore"))}catch{}},children:"Autoscore"}),e.jsx("button",{className:`btn ${Oe}`,onClick:()=>{try{window.dispatchEvent(new Event("ndn:open-scoring"))}catch{}},children:"Scoring"}),e.jsx("button",{className:`btn ${Oe}`,onClick:La,children:"Manual Correction"}),!pe&&e.jsx("button",{className:`btn ${Oe}`,onClick:()=>{console.log("Sending cam-create"),i?i.send({type:"cam-create"}):E.current&&E.current.readyState===WebSocket.OPEN?E.current.send(JSON.stringify({type:"cam-create"})):t("Not connected to server",{type:"error"})},children:"Pair Phone"}),!pe&&vs&&e.jsxs("div",{className:"ml-2 text-sm bg-blue-900/50 p-2 rounded",children:[e.jsxs("div",{children:[e.jsx("span",{className:"opacity-70",children:"Mobile pairing code: "}),e.jsx("span",{className:"font-mono font-bold text-lg",children:vs})]}),e.jsxs("div",{className:"text-xs opacity-70 mt-1",children:["On your phone, go to: ",e.jsxs("a",{href:`/mobile-cam.html?code=${vs}`,target:"_blank",className:"underline",children:[window.location.origin,"/mobile-cam.html?code=",vs]})]})]}),!pe&&e.jsxs("div",{className:"ml-auto flex items-center gap-1 text-[11px]",children:[e.jsx("span",{className:"opacity-70",children:"Cam size"}),e.jsx("button",{className:`btn ${Oe}`,onClick:()=>ke(Math.max(.5,Math.round((ue-.05)*100)/100)),children:"âˆ’"}),e.jsxs("span",{className:`btn ${Oe} min-w-[2.5rem] text-center`,children:[Math.round(ue*100),"%"]}),e.jsx("button",{className:`btn ${Oe}`,onClick:()=>ke(Math.min(1.25,Math.round((ue+.05)*100)/100)),children:"+"}),e.jsx("span",{className:"opacity-50",children:"|"}),e.jsx("button",{className:`btn ${Oe}`,title:"Toggle fit/fill",onClick:()=>Pe(_e==="fill"?"fit":"fill"),children:_e==="fill"?"Fill":"Fit"})]})]})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-2 mt-2 items-start h-full",children:[e.jsx("div",{className:"order-1",children:e.jsx(Qa,{})}),e.jsx("div",{className:"order-2 flex-1 min-h-0",children:Le?e.jsx("div",{className:"min-w-0 relative z-10 flex-1 min-h-0 ndn-camera-tall",children:e.jsx(fa,{storageKey:"ndn:camera:tile:online:top",className:"relative rounded-2xl overflow-hidden bg-black",defaultWidth:520,defaultHeight:320,minWidth:280,minHeight:200,maxWidth:1600,maxHeight:900,autoFill:!0,children:e.jsx(Va,{label:"Your Board",autoStart:s?.username&&b.players[b.currentPlayerIdx]?.name===s.username,aspect:"classic",fill:!0})})}):null})]}),e.jsxs("div",{className:"font-semibold",children:["Current: ",b.players[b.currentPlayerIdx]?.name||"Ã”Ã‡Ã¶"]}),qe==="X01"&&Le&&s?.username&&b.players[b.currentPlayerIdx]?.name===s.username?e.jsxs(e.Fragment,{children:[e.jsx(rt,{x01DoubleInOverride:Et,hideInlinePanels:!0,showToolbar:!1,onVisitCommitted:(f,j,k)=>{if(R){const X=b.players[b.currentPlayerIdx],le=X?.legs[X.legs.length-1],de=le?le.totalScoreRemaining:b.startingScore;yn(s?.username||"Player",f,Math.max(0,de),F,{volume:D,checkoutOnly:Q})}const O=b.players[b.currentPlayerIdx];s?.username&&O?.name===s.username&&gn(s.username,j,f);try{f===180&&gt("180",O?.name||"Player"),k&&gt("leg",O?.name||"Player")}catch{}k||(Ne?.length||0)>=2&&b.nextPlayer(),et();try{if(k&&f>50||f>100){const X=b.players[b.currentPlayerIdx],le=X?.legs?.[X.legs.length-1]?.totalScoreRemaining??b.startingScore,de={player:X?.name||s?.username||"Player",score:f,darts:j,finished:k,remainingBefore:Math.max(0,le+f),ts:Date.now()};xs(de),be(!0)}}catch{}}}),z&&Kt?e.jsx(zs,{storageKey:"ndn:modal:highlight",className:"w-[420px]",defaultWidth:420,defaultHeight:220,minWidth:320,minHeight:160,initialFitHeight:!0,children:e.jsxs("div",{className:"p-4",children:[e.jsx("div",{className:"text-lg font-semibold mb-2",children:"Save highlight"}),e.jsxs("div",{className:"text-sm mb-3",children:["Player: ",e.jsx("strong",{children:Kt.player})," â€” Score: ",e.jsx("strong",{children:Kt.score})," â€” Darts: ",e.jsx("strong",{children:Kt.darts})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{className:"btn",onClick:()=>wt(),children:"Download to device"}),e.jsx("button",{className:"btn",onClick:()=>Ut(),children:"Save to account"}),e.jsx("button",{className:"btn btn-ghost ml-auto",onClick:()=>{be(!1),xs(null)},children:"Close"})]}),e.jsx("div",{className:"text-xs opacity-70 mt-3",children:"You can download this JSON to keep a copy, or save it to your account for later access."})]})}):null,e.jsxs("div",{className:"flex items-center gap-1.5 mb-2",children:[e.jsx("input",{className:"input w-24 text-sm",type:"number",min:0,value:se,onChange:f=>Z(parseInt(f.target.value||"0"))}),e.jsx("button",{className:"btn px-2 py-0.5 text-xs",onClick:()=>qt(se),children:"Submit Visit"}),e.jsx("button",{className:"btn px-2 py-0.5 text-xs bg-slate-700 hover:bg-slate-800",onClick:()=>{b.undoVisit(),et()},children:"Undo"})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-1.5 mt-1.5 text-xs",children:[e.jsx("span",{className:"opacity-70",children:"Quick:"}),[180,140,100,60].map(f=>e.jsx("button",{className:"btn px-2 py-0.5 text-xs",onClick:()=>qt(f),children:f},f))]}),e.jsxs("div",{className:"mt-2 flex items-center gap-1.5 mb-2",children:[e.jsx("button",{className:"btn px-2 py-0.5 text-xs",onClick:()=>x(!0),children:"Quick Chat"}),e.jsx("button",{className:"btn px-2 py-0.5 text-xs",onClick:()=>g(!0),children:"Messages"})]})]}):qe==="Double Practice"&&s?.username&&b.players[b.currentPlayerIdx]?.name===s.username?e.jsxs("div",{className:"p-3 rounded-xl bg-black/20",children:[e.jsx("div",{className:"text-xs mb-1.5",children:"Double Practice Ã”Ã‡Ã¶ Hit doubles D1Ã”Ã¥Ã†D20Ã”Ã¥Ã†DBULL"}),e.jsxs("div",{className:"mb-1 text-sm flex items-center justify-between",children:[e.jsx("span",{children:"Current target"}),e.jsx("span",{className:"px-2 py-0.5 rounded-full bg-emerald-500/20 text-emerald-200 border border-emerald-400/30 text-xs font-semibold",children:Ws[$e]?.label||"Ã”Ã‡Ã¶"})]}),e.jsxs("div",{className:"text-2xl font-extrabold mb-2",children:[Se," / ",Ws.length]}),e.jsx("div",{className:"rounded-2xl overflow-hidden bg-black/60 border border-white/10 mb-2",children:e.jsx(rt,{showToolbar:!1,immediateAutoCommit:!0,onAutoDart:(f,j)=>{(j==="DOUBLE"||j==="INNER_BULL")&&rn(f)}})}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("input",{className:"input w-24 text-sm",type:"number",min:0,value:se,onChange:f=>Z(parseInt(f.target.value||"0")),onKeyDown:f=>{f.key==="Enter"&&aa()}}),e.jsx("button",{className:"btn px-2 py-0.5 text-xs",onClick:aa,children:"Add Dart"})]}),e.jsxs("div",{className:"flex items-center gap-1.5 mt-1.5",children:[e.jsx("input",{className:"input w-40 text-sm",placeholder:"Manual (D16, 50, 25, T20)",value:Ke,onChange:f=>mt(f.target.value),onKeyDown:f=>{f.key==="Enter"&&mn()}}),e.jsx("button",{className:"btn px-2 py-0.5 text-xs",onClick:mn,children:"Add"})]})]}):qe==="Around the Clock"&&s?.username&&b.players[b.currentPlayerIdx]?.name===s.username?e.jsxs("div",{className:"p-3 rounded-xl bg-black/20",children:[e.jsx("div",{className:"text-xs mb-1.5",children:"Around the Clock Ã”Ã‡Ã¶ Hit 1Ã”Ã¥Ã†20 then 25 (outer) and 50 (inner)"}),e.jsxs("div",{className:"mb-1 text-sm flex items-center justify-between",children:[e.jsx("span",{children:"Current target"}),e.jsx("span",{className:"px-2 py-0.5 rounded-full bg-emerald-500/20 text-emerald-200 border border-emerald-400/30 text-xs font-semibold",children:ss[Be]===25?"25 (Outer Bull)":ss[Be]===50?"50 (Inner Bull)":ss[Be]||"Ã”Ã‡Ã¶"})]}),e.jsxs("div",{className:"text-2xl font-extrabold mb-2",children:[Ye," / ",ss.length]}),e.jsx("div",{className:"rounded-2xl overflow-hidden bg-black/60 border border-white/10 mb-2",children:e.jsx(rt,{scoringMode:"custom",showToolbar:!1,immediateAutoCommit:!0,onAutoDart:(f,j,k)=>{Mn(f,j,k?.sector??null)}})}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("input",{className:"input w-24 text-sm",type:"number",min:0,value:se,onChange:f=>Z(parseInt(f.target.value||"0")),onKeyDown:f=>{f.key==="Enter"&&Za()}}),e.jsx("button",{className:"btn px-2 py-0.5 text-xs",onClick:Za,children:"Add Dart"})]}),e.jsxs("div",{className:"flex items-center gap-1.5 mt-1.5",children:[e.jsx("input",{className:"input w-40 text-sm",placeholder:"Manual (T20, D5, 25, 50)",value:it,onChange:f=>yt(f.target.value),onKeyDown:f=>{f.key==="Enter"&&ra()}}),e.jsx("button",{className:"btn px-2 py-0.5 text-xs",onClick:ra,children:"Add"})]})]}):qe==="Treble Practice"&&s?.username&&b.players[b.currentPlayerIdx]?.name===s.username?e.jsxs("div",{className:"p-3 rounded-xl bg-black/20",children:[e.jsx("div",{className:"text-xs mb-1.5",children:"Treble Practice â€” Aim for triples only; count hits vs total darts"}),e.jsxs("div",{className:"mb-1 text-sm flex items-center justify-between",children:[e.jsx("span",{children:"Treble target"}),e.jsxs("span",{className:"px-2 py-0.5 rounded-full bg-emerald-500/20 text-emerald-200 border border-emerald-400/30 text-xs font-semibold",children:["T",C]})]}),e.jsxs("div",{className:"text-2xl font-extrabold mb-2",children:[Ae," / ",Dt>0?Dt:ze]}),Dt>0&&ze>=Dt&&e.jsxs("div",{className:"mt-1 text-xs px-2 py-1 rounded bg-emerald-500/20 text-emerald-200 border border-emerald-400/30 inline-block",children:["Completed! ",e.jsx("button",{className:"ml-2 underline",onClick:ba,children:"Reset"})]}),e.jsxs("div",{className:"flex items-center gap-1.5 mb-2",children:[e.jsx("span",{className:"opacity-70 text-xs",children:"Quick:"}),[20,19,18].map(f=>e.jsxs("button",{className:`btn px-2 py-0.5 text-xs ${C===f?"bg-emerald-600/30 border border-emerald-400/30":""}`,onClick:()=>ne(f),children:["T",f]},`tquick-${f}`)),e.jsx("span",{className:"opacity-50",children:"|"}),e.jsx("select",{className:"input w-24 text-sm",value:C,onChange:f=>ne(parseInt(f.target.value,10)),children:Array.from({length:20},(f,j)=>j+1).map(f=>e.jsx("option",{value:f,children:f},f))}),e.jsx("button",{className:"btn px-2 py-0.5 text-xs bg-slate-700 hover:bg-slate-800",onClick:ba,children:"Reset"})]}),e.jsx("div",{className:"rounded-2xl overflow-hidden bg-black/60 border border-white/10 mb-2",children:e.jsx(rt,{scoringMode:"custom",showToolbar:!1,immediateAutoCommit:!0,onAutoDart:(f,j,k)=>{Aa(f,j==="MISS"?void 0:j,k?.sector??null)}})}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("input",{className:"input w-24 text-sm",type:"number",min:0,value:se,onChange:f=>Z(parseInt(f.target.value||"0")),onKeyDown:f=>{f.key==="Enter"&&ia()}}),e.jsx("button",{className:"btn px-2 py-0.5 text-xs",onClick:ia,children:"Add Dart"})]}),e.jsxs("div",{className:"flex items-center gap-1.5 mt-1.5",children:[e.jsx("input",{className:"input w-40 text-sm",placeholder:"Manual (T20)",value:ns,onChange:f=>Bt(f.target.value),onKeyDown:f=>{f.key==="Enter"&&er()}}),e.jsx("button",{className:"btn px-2 py-0.5 text-xs",onClick:er,children:"Add"})]})]}):qe==="Cricket"&&s?.username&&b.players[b.currentPlayerIdx]?.name===s.username?e.jsxs("div",{className:"p-3 rounded-xl bg-black/20",children:[e.jsx("div",{className:"text-xs mb-1.5",children:"Cricket Ã”Ã‡Ã¶ Close 15-20 and Bull; overflow scores points"}),(()=>{const f=It();In(f);const j=gs[f]||Hn();return e.jsx("div",{className:"mb-2 grid grid-cols-7 gap-1 text-center text-[11px]",children:Ma.map(k=>e.jsxs("div",{className:"p-1 rounded bg-slate-800/50 border border-slate-700/50",children:[e.jsx("div",{className:"opacity-70",children:k===25?"Bull":k}),e.jsxs("div",{className:"font-semibold",children:[Math.min(3,j.marks?.[k]||0)," / 3"]})]},k))})})(),e.jsxs("div",{className:"text-sm mb-2",children:["Points: ",e.jsx("span",{className:"font-semibold",children:gs[It()]?.points||0})]}),e.jsx("div",{className:"rounded-2xl overflow-hidden bg-black/60 border border-white/10 mb-2",children:e.jsx(rt,{scoringMode:"custom",showToolbar:!1,immediateAutoCommit:!0,onAutoDart:(f,j,k)=>{Vs(f,j==="MISS"?void 0:j,k?.sector??null)}})}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("input",{className:"input w-24 text-sm",type:"number",min:0,value:se,onChange:f=>Z(parseInt(f.target.value||"0")),onKeyDown:f=>{f.key==="Enter"&&(Vs(Math.max(0,se|0)),Z(0))}}),e.jsx("button",{className:"btn px-2 py-0.5 text-xs",onClick:()=>{Vs(Math.max(0,se|0)),Z(0)},children:"Add Dart"})]})]}):qe==="Shanghai"&&s?.username&&b.players[b.currentPlayerIdx]?.name===s.username?e.jsxs("div",{className:"p-3 rounded-xl bg-black/20",children:[(()=>{const f=It();os(f);const j=ys[f]||vn();return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"text-xs mb-1.5",children:"Shanghai Ã”Ã‡Ã¶ Hit only the round's number; Single/Double/Triple score"}),e.jsxs("div",{className:"mb-1 text-sm flex items-center justify-between",children:[e.jsx("span",{children:"Round"}),e.jsx("span",{className:"px-2 py-0.5 rounded-full bg-emerald-500/20 text-emerald-200 border border-emerald-400/30 text-xs font-semibold",children:j.round})]}),e.jsxs("div",{className:"text-2xl font-extrabold mb-2",children:["Score: ",j.score]})]})})(),e.jsx("div",{className:"rounded-2xl overflow-hidden bg-black/60 border border-white/10 mb-2",children:e.jsx(rt,{scoringMode:"custom",showToolbar:!1,immediateAutoCommit:!0,onAutoDart:(f,j,k)=>{Pn(f,j==="MISS"?void 0:j,k?.sector??null)}})}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("input",{className:"input w-24 text-sm",type:"number",min:0,value:se,onChange:f=>Z(parseInt(f.target.value||"0")),onKeyDown:f=>{f.key==="Enter"&&(Pn(Math.max(0,se|0)),Z(0))}}),e.jsx("button",{className:"btn px-2 py-0.5 text-xs",onClick:()=>{Pn(Math.max(0,se|0)),Z(0)},children:"Add Dart"})]})]}):qe==="Halve It"&&s?.username&&b.players[b.currentPlayerIdx]?.name===s.username?e.jsxs("div",{className:"p-3 rounded-xl bg-black/20",children:[(()=>{const f=It();ts(f);const j=Ns[f]||jn(),k=Ga(j);return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"text-xs mb-1.5",children:"Halve It Ã”Ã‡Ã¶ Hit the target each round or your score halves"}),e.jsxs("div",{className:"mb-1 text-sm flex items-center justify-between",children:[e.jsx("span",{children:"Stage"}),e.jsxs("span",{className:"px-2 py-0.5 rounded-full bg-emerald-500/20 text-emerald-200 border border-emerald-400/30 text-xs font-semibold",children:[j.stage+1,"/",j.targets.length]})]}),e.jsxs("div",{className:"text-sm",children:["Target: ",e.jsx("span",{className:"font-semibold",children:(()=>{const O=k;return O?O.kind==="ANY_NUMBER"?"Any":O.kind==="BULL"?"Bull":O.kind==="DOUBLE"||O.kind==="TRIPLE"||O.kind==="NUMBER"?`${O.kind} ${O.num}`:"Ã”Ã‡Ã¶":"Ã”Ã‡Ã¶"})()})]}),e.jsxs("div",{className:"text-2xl font-extrabold mb-2",children:["Score: ",j.score]})]})})(),e.jsx("div",{className:"rounded-2xl overflow-hidden bg-black/60 border border-white/10 mb-2",children:e.jsx(rt,{scoringMode:"custom",showToolbar:!1,immediateAutoCommit:!0,onAutoDart:(f,j,k)=>{Ln(f,j==="MISS"?void 0:j,k?.sector??null)}})}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("input",{className:"input w-24 text-sm",type:"number",min:0,value:se,onChange:f=>Z(parseInt(f.target.value||"0")),onKeyDown:f=>{f.key==="Enter"&&(Ln(Math.max(0,se|0)),Z(0))}}),e.jsx("button",{className:"btn px-2 py-0.5 text-xs",onClick:()=>{Ln(Math.max(0,se|0)),Z(0)},children:"Add Dart"})]})]}):qe==="High-Low"&&s?.username&&b.players[b.currentPlayerIdx]?.name===s.username?e.jsxs("div",{className:"p-3 rounded-xl bg-black/20",children:[(()=>{const f=It();oa(f);const j=Vt[f]||Nn();return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"text-xs mb-1.5",children:"High-Low Ã”Ã‡Ã¶ Alternate aiming for high then low segments"}),e.jsxs("div",{className:"mb-1 text-sm flex items-center justify-between",children:[e.jsx("span",{children:"Round"}),e.jsx("span",{className:"px-2 py-0.5 rounded-full bg-emerald-500/20 text-emerald-200 border border-emerald-400/30 text-xs font-semibold",children:j.round})]}),e.jsxs("div",{className:"text-sm",children:["Target: ",e.jsx("span",{className:"font-semibold",children:j.target})]}),e.jsxs("div",{className:"text-2xl font-extrabold mb-2",children:["Score: ",j.score]})]})})(),e.jsx("div",{className:"rounded-2xl overflow-hidden bg-black/60 border border-white/10 mb-2",children:e.jsx(rt,{scoringMode:"custom",showToolbar:!1,immediateAutoCommit:!0,onAutoDart:(f,j,k)=>{xn(f,j==="MISS"?void 0:j,k?.sector??null)}})}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("input",{className:"input w-24 text-sm",type:"number",min:0,value:se,onChange:f=>Z(parseInt(f.target.value||"0")),onKeyDown:f=>{f.key==="Enter"&&(xn(Math.max(0,se|0)),Z(0))}}),e.jsx("button",{className:"btn px-2 py-0.5 text-xs",onClick:()=>{xn(Math.max(0,se|0)),Z(0)},children:"Add Dart"})]})]}):qe==="American Cricket"&&s?.username&&b.players[b.currentPlayerIdx]?.name===s.username?e.jsxs("div",{className:"p-3 rounded-xl bg-black/20",children:[e.jsx("div",{className:"text-xs mb-1.5",children:"American Cricket Ã”Ã‡Ã¶ Close 12-20 and Bull; overflow scores"}),(()=>{const f=It();Ra(f);const j=Cs[f]||Da();return e.jsx("div",{className:"mb-2 grid grid-cols-5 gap-1 text-center text-[11px]",children:Ya.map(k=>e.jsxs("div",{className:"p-1 rounded bg-slate-800/50 border border-slate-700/50",children:[e.jsx("div",{className:"opacity-70",children:k===25?"Bull":k}),e.jsxs("div",{className:"font-semibold",children:[Math.min(3,j.marks?.[k]||0)," / 3"]})]},k))})})(),e.jsxs("div",{className:"text-sm mb-2",children:["Points: ",e.jsx("span",{className:"font-semibold",children:Cs[It()]?.points||0})]}),e.jsx("div",{className:"rounded-2xl overflow-hidden bg-black/60 border border-white/10 mb-2",children:e.jsx(rt,{scoringMode:"custom",showToolbar:!1,immediateAutoCommit:!0,onAutoDart:(f,j,k)=>{On(f,j==="MISS"?void 0:j,k?.sector??null)}})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{className:"input w-28",type:"number",min:0,value:se,onChange:f=>Z(parseInt(f.target.value||"0"))}),e.jsx("button",{className:"btn",onClick:()=>{On(Math.max(0,se|0)),Z(0)},children:"Add Dart"})]})]}):qe==="Baseball"&&s?.username&&b.players[b.currentPlayerIdx]?.name===s.username?e.jsxs("div",{className:"p-3 rounded-xl bg-black/20",children:[(()=>{const f=It();hn(f);const j=K[f]||ka();return e.jsxs("div",{className:"text-xs mb-1.5",children:["Baseball Ã”Ã‡Ã¶ Inning ",j.inning," Ã”Ã‡Ã³ Runs ",j.score]})})(),e.jsx("div",{className:"rounded-2xl overflow-hidden bg-black/60 border border-white/10 mb-2",children:e.jsx(rt,{scoringMode:"custom",showToolbar:!1,immediateAutoCommit:!0,onAutoDart:(f,j,k)=>{ga(f,j==="MISS"?void 0:j,k?.sector??null)}})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{className:"input w-28",type:"number",min:0,value:se,onChange:f=>Z(parseInt(f.target.value||"0"))}),e.jsx("button",{className:"btn",onClick:()=>{ga(Math.max(0,se|0)),Z(0)},children:"Add Dart"})]})]}):qe==="Golf"&&s?.username&&b.players[b.currentPlayerIdx]?.name===s.username?e.jsxs("div",{className:"p-3 rounded-xl bg-black/20",children:[(()=>{const f=It();fn(f);const j=G[f]||Ca();return e.jsxs("div",{className:"text-xs mb-1.5",children:["Golf Ã”Ã‡Ã¶ Hole ",j.hole," (target ",Hl[j.hole],") Ã”Ã‡Ã³ Strokes ",j.strokes]})})(),e.jsx("div",{className:"rounded-2xl overflow-hidden bg-black/60 border border-white/10 mb-2",children:e.jsx(rt,{scoringMode:"custom",showToolbar:!1,immediateAutoCommit:!0,onAutoDart:(f,j,k)=>{Pa(f,j==="MISS"?void 0:j,k?.sector??null)}})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{className:"input w-28",type:"number",min:0,value:se,onChange:f=>Z(parseInt(f.target.value||"0"))}),e.jsx("button",{className:"btn",onClick:()=>{Pa(Math.max(0,se|0)),Z(0)},children:"Add Dart"})]})]}):qe==="Tic Tac Toe"&&s?.username&&b.players[b.currentPlayerIdx]?.name===s.username?e.jsxs("div",{className:"p-3 rounded-xl bg-black/20",children:[e.jsx("div",{className:"text-xs mb-1.5",children:"Tic Tac Toe Ã”Ã‡Ã¶ Tap a cell to claim by hitting its target"}),e.jsx("div",{className:"grid grid-cols-3 gap-1 mb-2",children:Array.from({length:9},(f,j)=>j).map(f=>e.jsx("button",{className:`h-12 rounded-xl border ${L.board[f]?"bg-emerald-500/20 border-emerald-400/30":"bg-slate-800/50 border-slate-700/50"}`,onClick:()=>{if(L.finished||L.board[f])return;const j=Ta[f],k=Number($s||0),O=k%3===0?"TRIPLE":k%2===0?"DOUBLE":"SINGLE",X=j.type==="BULL"?null:j.num||null;la(f,k,O,X),js("")},children:L.board[f]||""},f))}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{className:"input w-40 text-sm",placeholder:"Enter dart score (e.g. 20, 40, 60, 25, 50)",value:$s,onChange:f=>js(f.target.value),onKeyDown:f=>{if(f.key==="Enter"){const j=Array.from({length:9},(k,O)=>O).find(k=>!L.board[k]&&!L.finished);if(j!==void 0){const k=Ta[j],O=Number($s||0),X=O%3===0?"TRIPLE":O%2===0?"DOUBLE":"SINGLE",le=k.type==="BULL"?null:k.num||null;la(j,O,X,le),js("")}}}}),e.jsx("button",{className:"btn",onClick:()=>{const f=Array.from({length:9},(j,k)=>k).find(j=>!L.board[j]&&!L.finished);if(f!==void 0){const j=Ta[f],k=Number($s||0),O=k%3===0?"TRIPLE":k%2===0?"DOUBLE":"SINGLE",X=j.type==="BULL"?null:j.num||null;la(f,k,O,X),js("")}},children:"Claim Cell"})]}),e.jsx("div",{className:"rounded-2xl overflow-hidden bg-black/60 border border-white/10 mb-2",children:e.jsx(rt,{scoringMode:"custom",showToolbar:!1,immediateAutoCommit:!0,onAutoDart:(f,j,k)=>{}})})]}):qe==="Killer"&&s?.username&&b.players[b.currentPlayerIdx]?.name===s.username?e.jsxs("div",{className:"p-3 rounded-xl bg-black/20",children:[e.jsx("div",{className:"text-xs mb-1.5",children:"Killer Ã”Ã‡Ã¶ Hit your own double to become Killer; then remove othersÃ”Ã‡Ã– lives by hitting their doubles/triples."}),e.jsxs("div",{className:"mb-1 text-sm flex items-center justify-between",children:[e.jsx("span",{children:"Your number"}),e.jsx("span",{className:"px-2 py-0.5 rounded-full bg-emerald-500/20 text-emerald-200 border border-emerald-400/30 text-xs font-semibold",children:(()=>{const f=It();return b.players.forEach(j=>An(j.id)),Zt[f]?.number||"Ã”Ã‡Ã¶"})()})]}),e.jsxs("div",{className:"text-sm",children:["Lives: ",e.jsx("span",{className:"font-semibold",children:(()=>{const f=It();return Zt[f]?.lives??"Ã”Ã‡Ã¶"})()})," ",(()=>{const f=It();return Zt[f]?.isKiller?e.jsx("span",{className:"ml-2 text-emerald-300",children:"KILLER"}):null})()]}),e.jsx("div",{className:"rounded-2xl overflow-hidden bg-black/60 border border-white/10 mb-2",children:e.jsx(rt,{scoringMode:"custom",showToolbar:!1,immediateAutoCommit:!0,onAutoDart:(f,j,k)=>{Fs(j==="MISS"?void 0:j,k?.sector??null)}})}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("input",{className:"input w-24 text-sm",type:"number",min:0,value:se,onChange:f=>Z(parseInt(f.target.value||"0")),onKeyDown:f=>{f.key==="Enter"&&(Fs("SINGLE",Math.max(0,se|0)),Z(0))}}),e.jsx("button",{className:"btn px-2 py-0.5 text-xs",onClick:()=>{Fs("SINGLE",Math.max(0,se|0)),Z(0)},children:"Add Dart"})]})]}):s?.username&&b.players[b.currentPlayerIdx]?.name===s.username?e.jsxs("div",{className:"p-3 rounded-xl bg-black/20",children:[e.jsxs("div",{className:"text-xs mb-1.5",children:[qe," (online) Ã”Ã‡Ã¶ manual turn entry"]}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("input",{className:"input w-24 text-sm",type:"number",min:0,value:se,onChange:f=>Z(parseInt(f.target.value||"0"))}),e.jsx("button",{className:"btn",onClick:()=>{const f=Math.max(0,se|0);b.addVisit(f,3),Z(0),b.nextPlayer(),et()},children:"Submit"}),e.jsx("button",{className:"btn px-2 py-0.5 text-xs bg-slate-700 hover:bg-slate-800",onClick:()=>{b.undoVisit(),et()},children:"Undo"})]})]}):e.jsx("div",{className:"p-4 rounded-xl bg-slate-800/30 border border-slate-700/40 text-center text-slate-300 font-semibold",children:"WAITING TO THROW"}),e.jsxs("div",{className:"mt-2 flex items-center gap-1.5",children:[e.jsx("button",{className:"btn px-2 py-0.5 text-xs",onClick:()=>x(!0),children:"Quick Chat"}),e.jsx("button",{className:"btn px-2 py-0.5 text-xs",onClick:()=>g(!0),children:"Messages"})]})]}):e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-2",children:[e.jsx("div",{className:"space-y-1.5",children:e.jsx(Qa,{})}),e.jsxs("div",{className:`md:col-span-${xt} space-y-1.5 relative`,children:[e.jsxs("div",{className:"flex items-center gap-1.5 mt-2",children:[e.jsx("button",{className:`btn ${Oe}`,onClick:()=>{try{window.dispatchEvent(new Event("ndn:open-autoscore"))}catch{}},children:"Autoscore"}),e.jsx("button",{className:`btn ${Oe}`,onClick:()=>{try{window.dispatchEvent(new Event("ndn:open-scoring"))}catch{}},children:"Scoring"}),e.jsx("button",{className:`btn ${Oe}`,onClick:La,children:"Manual Correction"}),e.jsxs("div",{className:"ml-auto flex items-center gap-1",children:[e.jsx("span",{className:"text-xs opacity-70",children:"Cam"}),e.jsx("button",{className:`btn ${Oe}`,onClick:()=>ke(Math.max(.5,Math.round((ue-.05)*100)/100)),children:"âˆ’"}),e.jsxs("span",{className:`btn ${Oe} bg-transparent border-slate-600 text-center min-w-[3rem]`,children:[Math.round(ue*100),"%"]}),e.jsx("button",{className:`btn ${Oe}`,onClick:()=>ke(Math.min(1.25,Math.round((ue+.05)*100)/100)),children:"+"}),e.jsx("button",{className:`btn ${Oe}`,onClick:()=>Rt(xt===2?3:2),title:xt===2?"Expand camera":"Shrink camera",children:xt===2?"â†”":"â†™"}),e.jsx("span",{className:"opacity-50",children:"|"}),e.jsx("button",{className:`btn ${Oe}`,title:"Toggle fit/fill",onClick:()=>Pe(_e==="fill"?"fit":"fill"),children:_e==="fill"?"Fill":"Fit"})]})]}),e.jsxs("div",{className:"mt-2 relative flex-1 min-h-0 ndn-camera-tall",children:[e.jsx(fa,{storageKey:"ndn:camera:tile:online:row",className:"relative rounded-2xl overflow-hidden bg-black w-full",defaultWidth:720,defaultHeight:400,minWidth:320,minHeight:220,maxWidth:1600,maxHeight:900,autoFill:!0,children:e.jsx(Va,{label:"Your Board",autoStart:s?.username&&b.players[b.currentPlayerIdx]?.name===s.username,aspect:"classic",fill:!0})}),xt<3&&e.jsx("div",{className:"absolute right-0 top-0 bottom-0 w-2 cursor-ew-resize bg-slate-600/20 hover:bg-slate-600/40 transition-colors flex items-center justify-center group",onMouseDown:f=>{f.preventDefault();const j=f.clientX,k=xt,O=le=>{le.clientX-j>50&&k===2&&Rt(3)},X=()=>{document.removeEventListener("mousemove",O),document.removeEventListener("mouseup",X)};document.addEventListener("mousemove",O),document.addEventListener("mouseup",X)},children:e.jsx("div",{className:"w-0.5 h-8 bg-slate-400 group-hover:bg-slate-300 transition-colors"})})]}),e.jsxs("div",{className:"font-semibold text-sm md:text-base",children:["Current: ",b.players[b.currentPlayerIdx]?.name||"Ã”Ã‡Ã¶"]}),qe==="X01"&&s?.username&&b.players[b.currentPlayerIdx]?.name===s.username?e.jsxs(e.Fragment,{children:[e.jsx(rt,{x01DoubleInOverride:Et,hideInlinePanels:!0,showToolbar:!1,onVisitCommitted:(f,j,k)=>{if(R){const X=b.players[b.currentPlayerIdx],le=X?.legs[X.legs.length-1],de=le?le.totalScoreRemaining:b.startingScore;yn(s?.username||"Player",f,Math.max(0,de),F,{volume:D,checkoutOnly:Q})}const O=b.players[b.currentPlayerIdx];s?.username&&O?.name===s.username&&gn(s.username,j,f);try{f===180&&gt("180",O?.name||"Player"),k&&gt("leg",O?.name||"Player")}catch{}k?et():(Ne?.length||0)>=2?setTimeout(()=>{try{b.nextPlayer(),et()}catch{}},750):et()}}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{className:"input w-28",type:"number",min:0,value:se,onChange:f=>Z(parseInt(f.target.value||"0"))}),e.jsx("button",{className:"btn",onClick:()=>qt(se),children:"Submit Visit (Manual)"}),e.jsx("button",{className:"btn bg-slate-700 hover:bg-slate-800",onClick:()=>{b.undoVisit(),et()},children:"Undo"})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2 mt-2 text-sm",children:[e.jsx("span",{className:"opacity-70",children:"Quick:"}),[180,140,100,60].map(f=>e.jsx("button",{className:"btn px-3 py-1 text-sm",onClick:()=>qt(f),children:f},f))]}),(()=>{const f=b.players[b.currentPlayerIdx],j=f?.legs?.[f.legs?.length-1],k=j?j.totalScoreRemaining:b.startingScore;return k>0&&k<=170?e.jsxs("div",{className:"mt-2 p-2 rounded-lg bg-indigo-50 border border-indigo-200 text-indigo-900 text-sm",children:["Checkout suggestions (fav ",W,"): ",ri(k,W).join("  Ã”Ã‡Ã³  ")||"Ã”Ã‡Ã¶"]}):null})()]}):qe==="Double Practice"&&s?.username&&b.players[b.currentPlayerIdx]?.name===s.username?e.jsxs("div",{className:"p-3 rounded-xl bg-black/20",children:[e.jsx("div",{className:"text-sm mb-2",children:"Double Practice Ã”Ã‡Ã¶ Hit doubles D1Ã”Ã¥Ã†D20Ã”Ã¥Ã†DBULL"}),e.jsxs("div",{className:"mb-1 text-sm flex items-center justify-between",children:[e.jsx("span",{children:"Current target"}),e.jsx("span",{className:"px-2 py-0.5 rounded-full bg-emerald-500/20 text-emerald-200 border border-emerald-400/30 text-xs font-semibold",children:Ws[$e]?.label||"Ã”Ã‡Ã¶"})]}),e.jsxs("div",{className:"text-2xl font-extrabold mb-2",children:[Se," / ",Ws.length]}),e.jsx("div",{className:"rounded-2xl overflow-hidden bg-black/60 border border-white/10 mb-2",children:e.jsx(rt,{scoringMode:"custom",showToolbar:!1,immediateAutoCommit:!0,onAutoDart:(f,j)=>{(j==="DOUBLE"||j==="INNER_BULL")&&rn(f)}})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{className:"input w-28",type:"number",min:0,value:se,onChange:f=>Z(parseInt(f.target.value||"0")),onKeyDown:f=>{f.key==="Enter"&&aa()}}),e.jsx("button",{className:"btn",onClick:aa,children:"Add Dart"})]}),e.jsxs("div",{className:"flex items-center gap-2 mt-1.5",children:[e.jsx("input",{className:"input w-44",placeholder:"Manual (D16, 50, 25, T20)",value:Ke,onChange:f=>mt(f.target.value),onKeyDown:f=>{f.key==="Enter"&&mn()}}),e.jsx("button",{className:"btn",onClick:mn,children:"Add"})]})]}):qe==="Cricket"&&s?.username&&b.players[b.currentPlayerIdx]?.name===s.username?e.jsxs("div",{className:"p-3 rounded-xl bg-black/20",children:[e.jsx("div",{className:"text-sm mb-2",children:"Cricket Ã”Ã‡Ã¶ Close 15-20 and Bull; overflow scores points"}),(()=>{const f=It();In(f);const j=gs[f]||Hn();return e.jsx("div",{className:"mb-2 grid grid-cols-7 gap-1 text-center text-[11px]",children:Ma.map(k=>e.jsxs("div",{className:"p-1 rounded bg-slate-800/50 border border-slate-700/50",children:[e.jsx("div",{className:"opacity-70",children:k===25?"Bull":k}),e.jsxs("div",{className:"font-semibold",children:[Math.min(3,j.marks?.[k]||0)," / 3"]})]},k))})})(),e.jsxs("div",{className:"text-sm mb-2",children:["Points: ",e.jsx("span",{className:"font-semibold",children:gs[It()]?.points||0})]}),e.jsx("div",{className:"rounded-2xl overflow-hidden bg-black/60 border border-white/10 mb-2",children:e.jsx(rt,{scoringMode:"custom",showToolbar:!1,immediateAutoCommit:!0,onAutoDart:(f,j,k)=>{Vs(f,j==="MISS"?void 0:j,k?.sector??null)}})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{className:"input w-28",type:"number",min:0,value:se,onChange:f=>Z(parseInt(f.target.value||"0"))}),e.jsx("button",{className:"btn",onClick:()=>{Vs(Math.max(0,se|0)),Z(0)},children:"Add Dart"})]})]}):qe==="Shanghai"&&s?.username&&b.players[b.currentPlayerIdx]?.name===s.username?e.jsxs("div",{className:"p-3 rounded-xl bg-black/20",children:[(()=>{const f=It();os(f);const j=ys[f]||vn();return e.jsx(e.Fragment,{children:e.jsxs("div",{className:"text-sm mb-2",children:["Shanghai Ã”Ã‡Ã¶ Round ",j.round," Ã”Ã‡Ã³ Score ",j.score]})})})(),e.jsx("div",{className:"rounded-2xl overflow-hidden bg-black/60 border border-white/10 mb-2",children:e.jsx(rt,{scoringMode:"custom",showToolbar:!1,immediateAutoCommit:!0,onAutoDart:(f,j,k)=>{Pn(f,j==="MISS"?void 0:j,k?.sector??null)}})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{className:"input w-28",type:"number",min:0,value:se,onChange:f=>Z(parseInt(f.target.value||"0"))}),e.jsx("button",{className:"btn",onClick:()=>{Pn(Math.max(0,se|0)),Z(0)},children:"Add Dart"})]})]}):qe==="Halve It"&&s?.username&&b.players[b.currentPlayerIdx]?.name===s.username?e.jsxs("div",{className:"p-3 rounded-xl bg-black/20",children:[(()=>{const f=It();ts(f);const j=Ns[f]||jn(),k=Ga(j);return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"text-sm mb-2",children:["Halve It Ã”Ã‡Ã¶ Stage ",j.stage+1,"/",j.targets.length," Ã”Ã‡Ã³ Score ",j.score]}),e.jsxs("div",{className:"text-sm",children:["Target: ",e.jsx("span",{className:"font-semibold",children:(()=>{const O=k;return O?O.kind==="ANY_NUMBER"?"Any":O.kind==="BULL"?"Bull":O.kind==="DOUBLE"||O.kind==="TRIPLE"||O.kind==="NUMBER"?`${O.kind} ${O.num}`:"Ã”Ã‡Ã¶":"Ã”Ã‡Ã¶"})()})]})]})})(),e.jsx("div",{className:"rounded-2xl overflow-hidden bg-black/60 border border-white/10 mb-2",children:e.jsx(rt,{scoringMode:"custom",showToolbar:!1,immediateAutoCommit:!0,onAutoDart:(f,j,k)=>{Ln(f,j==="MISS"?void 0:j,k?.sector??null)}})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{className:"input w-28",type:"number",min:0,value:se,onChange:f=>Z(parseInt(f.target.value||"0"))}),e.jsx("button",{className:"btn",onClick:()=>{Ln(Math.max(0,se|0)),Z(0)},children:"Add Dart"})]})]}):qe==="High-Low"&&s?.username&&b.players[b.currentPlayerIdx]?.name===s.username?e.jsxs("div",{className:"p-3 rounded-xl bg-black/20",children:[(()=>{const f=It();oa(f);const j=Vt[f]||Nn();return e.jsx(e.Fragment,{children:e.jsxs("div",{className:"text-sm mb-2",children:["High-Low Ã”Ã‡Ã¶ Round ",j.round," Ã”Ã‡Ã³ Target ",j.target," Ã”Ã‡Ã³ Score ",j.score]})})})(),e.jsx("div",{className:"rounded-2xl overflow-hidden bg-black/60 border border-white/10 mb-2",children:e.jsx(rt,{scoringMode:"custom",showToolbar:!1,immediateAutoCommit:!0,onAutoDart:(f,j,k)=>{xn(f,j==="MISS"?void 0:j,k?.sector??null)}})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{className:"input w-28",type:"number",min:0,value:se,onChange:f=>Z(parseInt(f.target.value||"0"))}),e.jsx("button",{className:"btn",onClick:()=>{xn(Math.max(0,se|0)),Z(0)},children:"Add Dart"})]})]}):qe==="Killer"&&s?.username&&b.players[b.currentPlayerIdx]?.name===s.username?e.jsxs("div",{className:"p-3 rounded-xl bg-black/20",children:[(()=>{const f=It();b.players.forEach(k=>An(k.id));const j=Zt[f];return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"text-xs mb-1.5",children:"Killer Ã”Ã‡Ã¶ Hit your own double to become Killer; then remove othersÃ”Ã‡Ã– lives by hitting their doubles/triples."}),e.jsxs("div",{className:"mb-1 text-sm flex items-center justify-between",children:[e.jsx("span",{children:"Your number"}),e.jsx("span",{className:"px-2 py-0.5 rounded-full bg-emerald-500/20 text-emerald-200 border border-emerald-400/30 text-xs font-semibold",children:j?.number||"Ã”Ã‡Ã¶"})]}),e.jsxs("div",{className:"text-sm",children:["Lives: ",e.jsx("span",{className:"font-semibold",children:j?.lives??"Ã”Ã‡Ã¶"})," ",j?.isKiller?e.jsx("span",{className:"ml-2 text-emerald-300",children:"KILLER"}):null]}),e.jsx("div",{className:"mt-2 grid grid-cols-2 md:grid-cols-3 gap-1 text-[11px]",children:b.players.map(k=>{const O=Zt[k.id];return e.jsxs("div",{className:"p-1 rounded bg-slate-800/50 border border-slate-700/50 flex items-center justify-between",children:[e.jsx("span",{className:"opacity-80 truncate",children:k.name}),e.jsx("span",{className:"font-mono",children:O?`#${O.number} = ${O.lives}Ã”Ã˜Ã±${O.isKiller?" = K":""}`:"Ã”Ã‡Ã¶"})]},k.id)})})]})})(),e.jsx("div",{className:"rounded-2xl overflow-hidden bg-black/60 border border-white/10 my-2",children:e.jsx(rt,{scoringMode:"custom",showToolbar:!1,immediateAutoCommit:!0,onAutoDart:(f,j,k)=>{Fs(j==="MISS"?void 0:j,k?.sector??null)}})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{className:"input w-28",type:"number",min:0,value:se,onChange:f=>Z(parseInt(f.target.value||"0"))}),e.jsx("button",{className:"btn",onClick:()=>{Fs("SINGLE",Math.max(0,se|0)),Z(0)},children:"Add Dart"})]}),e.jsx("div",{className:"text-xs opacity-70",children:"Tip: Only doubles/triples on the opponentsÃ”Ã‡Ã– numbers remove lives. To become Killer, hit your own double."})]}):s?.username&&b.players[b.currentPlayerIdx]?.name===s.username?e.jsxs("div",{className:"p-3 rounded-xl bg-black/20",children:[e.jsxs("div",{className:"text-sm mb-2",children:[qe," (online) Ã”Ã‡Ã¶ manual turn entry"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{className:"input w-28",type:"number",min:0,value:se,onChange:f=>Z(parseInt(f.target.value||"0"))}),e.jsx("button",{className:"btn",onClick:()=>{const f=Math.max(0,se|0);b.addVisit(f,3),Z(0),b.nextPlayer(),et()},children:"Submit"}),e.jsx("button",{className:"btn bg-slate-700 hover:bg-slate-800",onClick:()=>{b.undoVisit(),et()},children:"Undo"})]})]}):e.jsx("div",{className:"p-4 rounded-xl bg-slate-800/30 border border-slate-700/40 text-center text-slate-300 font-semibold",children:"WAITING TO THROW"})]}),e.jsx("div",{className:"md:col-span-1",children:e.jsxs("div",{className:"flex flex-wrap items-center gap-1.5",children:[e.jsx("button",{className:"btn px-2 py-0.5 text-xs",onClick:()=>x(!0),children:"Quick Chat"}),e.jsx("button",{className:"btn px-2 py-0.5 text-xs",onClick:()=>g(!0),children:"Messages"})]})})]})]})})]})]}),Ys&&e.jsx("div",{className:"fixed inset-0 bg-black/70 z-50",children:e.jsx("div",{className:"w-full h-full flex items-stretch justify-stretch p-0",children:e.jsxs(zs,{storageKey:"ndn:modal:create-match",className:"w-full h-full rounded-none !border-0 !shadow-none relative",fullScreen:!0,children:[e.jsx("div",{className:"flex items-center justify-between mb-3 sticky top-0 bg-slate-900/80 backdrop-blur border-b border-slate-700 z-10 px-2 py-2",children:e.jsx("h3",{className:"text-xl font-bold",children:"Create Match"})}),e.jsxs("div",{className:"space-y-3 md:space-y-0 md:grid md:grid-cols-2 md:gap-4 overflow-auto px-2",style:{maxHeight:"calc(100vh - 120px)"},children:[e.jsxs("div",{className:"col-span-1",children:[e.jsx("label",{className:"block text-sm text-slate-300 mb-1",children:"Game"}),e.jsx("select",{className:"input w-full",value:Jt,onChange:f=>Jn(f.target.value),children:Ia.map(f=>e.jsxs("option",{value:f,disabled:!s?.fullAccess&&bn.includes(f),children:[f," ",!s?.fullAccess&&bn.includes(f)?"(PREMIUM)":""]},f))})]}),e.jsxs("div",{className:"col-span-1",children:[e.jsx("label",{className:"block text-sm text-slate-300 mb-1",children:"Mode"}),e.jsxs("select",{className:"input w-full",value:Ds,onChange:f=>Es(f.target.value),children:[e.jsx("option",{value:"bestof",children:"Best Of"}),e.jsx("option",{value:"firstto",children:"First To"})]})]}),e.jsxs("div",{className:"col-span-1",children:[e.jsx("label",{className:"block text-sm text-slate-300 mb-1",children:"Value"}),Jt==="X01"?e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"flex flex-wrap gap-1",children:[101,201,301,401,501].map(f=>e.jsx("button",{className:`btn px-2 py-1 text-xs ${Xe===f?"bg-purple-600 hover:bg-purple-700":""}`,onClick:()=>ot(f),children:f},f))}),e.jsx("input",{className:"input w-full",type:"number",min:1,value:Xe,onChange:f=>ot(parseInt(f.target.value||"1")),placeholder:"Or enter custom value"})]}):e.jsx("input",{className:"input w-full",type:"number",min:1,value:Xe,onChange:f=>ot(parseInt(f.target.value||"1"))}),e.jsx("div",{className:"text-xs opacity-70 mt-1",children:"Example: Best Of 5 â€” first to 3"})]}),e.jsxs("div",{className:"col-span-1",children:[e.jsx("label",{className:"block text-sm text-slate-300 mb-1",children:"Starting Score"}),Jt==="X01"?e.jsx("select",{className:"input w-full",value:nt,onChange:f=>_t(parseInt(f.target.value||"501")),children:[301,501,701].map(f=>e.jsx("option",{value:f,children:f},f))}):e.jsx("div",{className:"text-xs opacity-70 mt-1",children:"Starting score applies to X01 only"})]}),Jt==="X01"&&e.jsxs("div",{className:"col-span-1",children:[e.jsx("label",{className:"block text-sm text-slate-300 mb-1",children:"X01 Rules"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{id:"create-x01di",type:"checkbox",className:"accent-purple-500",checked:!!Xs,onChange:f=>Xn(f.target.checked)}),e.jsx("label",{htmlFor:"create-x01di",className:"text-sm opacity-80",children:"Require Double-In"})]})]}),Jt==="Treble Practice"&&e.jsxs("div",{className:"col-span-1",children:[e.jsx("label",{className:"block text-sm text-slate-300 mb-1",children:"Throws per game"}),e.jsxs("div",{className:"space-y-1.5",children:[e.jsxs("div",{className:"flex flex-wrap gap-1",children:[[9,12,18,30,60].map(f=>e.jsx("button",{className:`btn px-2 py-1 text-xs ${Ls===f?"bg-purple-600 hover:bg-purple-700":""}`,onClick:()=>Sn(f),children:f},f)),e.jsx("button",{className:`btn px-2 py-1 text-xs ${Ls===0?"bg-purple-600 hover:bg-purple-700":""}`,onClick:()=>Sn(0),title:"Unlimited",children:"âˆž"})]}),e.jsx("input",{className:"input w-full",type:"number",min:0,placeholder:"0 = unlimited",value:Ls,onChange:f=>Sn(Math.max(0,parseInt(f.target.value||"0")))})]})]}),e.jsxs("div",{className:"col-span-1",children:[e.jsx("label",{className:"block text-sm text-slate-300 mb-1",children:"Require Calibration"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{id:"calibreq",type:"checkbox",className:"accent-purple-500",checked:Yn,onChange:f=>an(f.target.checked)}),e.jsx("label",{htmlFor:"calibreq",className:"text-sm opacity-80",children:"Players must be calibrated"})]})]}),e.jsx("div",{className:"col-span-1",children:e.jsxs("div",{className:"p-3 rounded-lg bg-black/20 border border-slate-700/40",children:[e.jsx("div",{className:"text-xs text-slate-300 uppercase tracking-wide mb-1",children:"Summary"}),e.jsxs("div",{className:"text-sm font-semibold",children:[Jt," â€” ",Ds==="bestof"?`Best Of ${Xe}`:`First To ${Xe}`," ",Jt==="X01"?`â€” ${nt}`:""]}),Jt==="X01"&&e.jsxs("div",{className:"text-xs opacity-80 mt-1",children:["Double-In: ",Xs?"On":"Off"]}),Jt==="Treble Practice"&&e.jsxs("div",{className:"text-xs opacity-80 mt-1",children:["Throws per game: ",Ls||"Unlimited"]}),!s?.fullAccess&&bn.includes(Jt)&&e.jsx("div",{className:"text-xs text-rose-300 mt-1",children:"PREMIUM required"})]})})]}),e.jsxs("div",{className:"sticky bottom-0 bg-slate-900/80 backdrop-blur border-t border-slate-700 z-10 px-2 py-2",children:[e.jsx("button",{className:"btn w-full",disabled:!s?.fullAccess&&bn.includes(Jt),title:!s?.fullAccess&&bn.includes(Jt)?"PREMIUM game":"",onClick:()=>{const f=s?.username?wn(s.username):0;Jt==="Treble Practice"&&as(Math.max(0,Ls|0)),Jt==="X01"&&qs(!!Xs);const j={type:"create-match",game:Jt,mode:Ds,value:Xe,startingScore:nt,creatorAvg:f,requireCalibration:Yn};Jt==="Treble Practice"&&(j.trebleMaxDarts=Math.max(0,Ls|0)),Jt==="X01"&&(j.x01DoubleIn=!!Xs),i?(i.send(j),Gt(!1),i.send({type:"list-matches"})):(E.current?.send(JSON.stringify(j)),Gt(!1),E.current?.send(JSON.stringify({type:"list-matches"})))},children:"START GAME!"}),e.jsx("div",{className:"flex justify-center mt-2",children:e.jsx("button",{className:"btn px-2 py-1",onClick:()=>Gt(!1),children:"Close"})})]})]})})}),Je&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50",children:e.jsxs(zs,{storageKey:"ndn:modal:invite",className:"w-full relative",defaultWidth:620,defaultHeight:420,minWidth:520,minHeight:320,maxWidth:1e3,maxHeight:800,initialFitHeight:!0,children:[e.jsx("h3",{className:"text-xl font-bold mb-1",children:"Incoming Match Request"}),e.jsxs("div",{className:"text-sm mb-2",children:[e.jsx("span",{className:"font-semibold",children:Je.fromName})," wants to join your match.",e.jsx("span",{className:`ml-2 text-xs px-2 py-0.5 rounded ${Je.calibrated?"bg-emerald-500/20 text-emerald-300 border border-emerald-600/30":"bg-amber-500/20 text-amber-200 border border-amber-600/30"}`,children:Je.calibrated?"Calibrated":"Not calibrated"})]}),(Je.game||Je.mode)&&e.jsxs("div",{className:"text-xs opacity-80 mb-3",children:[Je.game||"X01"," Ã”Ã‡Ã³ ",Je.mode==="firstto"?`First To ${Je.value}`:`Best Of ${Je.value}`," ",Je.game==="X01"&&Je.startingScore?`Ã”Ã‡Ã³ ${Je.startingScore}`:""]}),us&&e.jsx(Zu,{open:us,onClose:()=>Ks(!1),title:"Match Summary",players:b.players||[],doublesStats:Ot,centerScore:(()=>{const f=b.players||[];return f.length===2?`${f[0]?.legsWon||0} â€“ ${f[1]?.legsWon||0}`:""})()}),Je.boardPreview?e.jsx("div",{className:"mb-3",children:e.jsx("img",{src:Je.boardPreview,alt:"Board preview",className:"rounded-lg w-full max-h-64 object-contain bg-black/40 border border-slate-700"})}):e.jsx("div",{className:"mb-3 text-xs opacity-60",children:"No camera preview provided."}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{className:"btn bg-emerald-600 hover:bg-emerald-700",onClick:()=>{i?i.send({type:"invite-response",matchId:Je.matchId,accept:!0,toId:Je.fromId}):E.current?.send(JSON.stringify({type:"invite-response",matchId:Je.matchId,accept:!0,toId:Je.fromId})),kt(null)},children:"Accept"}),e.jsx("button",{className:"btn bg-rose-600 hover:bg-rose-700",onClick:()=>{i?i.send({type:"invite-response",matchId:Je.matchId,accept:!1,toId:Je.fromId}):E.current?.send(JSON.stringify({type:"invite-response",matchId:Je.matchId,accept:!1,toId:Je.fromId})),kt(null)},children:"Decline"})]})]})}),m&&e.jsx("div",{className:"fixed inset-0 bg-black/60 z-50 flex items-center justify-center",children:e.jsxs(zs,{storageKey:"ndn:modal:quick-chat",className:"w-full relative",defaultWidth:520,defaultHeight:280,minWidth:360,minHeight:220,maxWidth:900,maxHeight:700,children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Quick Chat"}),e.jsx("button",{className:"btn px-2 py-1 text-sm",onClick:()=>x(!1),children:"Close"})]}),e.jsx("div",{className:"flex flex-wrap gap-1.5",children:["Good luck!","Good game!","Nice darts!","Well played!","Ready?"].map(f=>e.jsx("button",{className:"btn px-2 py-0.5 text-xs",onClick:()=>{yi(f),x(!1)},disabled:!o,children:f},f))})]})}),p&&e.jsx("div",{className:"fixed inset-0 bg-black/60 z-50 flex items-center justify-center",children:e.jsxs(zs,{storageKey:"ndn:modal:messages",className:"w-full relative",defaultWidth:560,defaultHeight:360,minWidth:380,minHeight:260,maxWidth:1e3,maxHeight:800,children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Messages"}),e.jsx("button",{className:"btn px-2 py-1 text-sm",onClick:()=>g(!1),children:"Close"})]}),e.jsx(nm,{items:c.slice(-30).filter(f=>!a.isBlocked(String(f.fromId||""))).map((f,j)=>({key:String(j),from:f.from,id:String(f.fromId||f.from),text:f.message})),onDelete:f=>h(j=>j.filter((k,O)=>O!==f)),onReport:f=>{const k=c.slice(-30).filter(O=>!a.isBlocked(String(O.fromId||"")))[f];k&&ya(null,k.message)},onBlock:f=>{const k=c.slice(-30).filter(O=>!a.isBlocked(String(O.fromId||"")))[f];if(k){try{a.block(String(k.fromId||k.from))}catch{}h(O=>O.filter(X=>String(X.fromId||X.from)!==String(k.fromId||k.from)));try{t(`${k.from} blocked`,{type:"info"})}catch{}}}})]})})]})]})}function nm({items:s,onDelete:n,onReport:t,onBlock:i}){const a=(()=>{try{const c=navigator.userAgent||"";return/Android|iPhone|iPad|iPod|Mobile/i.test(c)}catch{return!1}})(),[r,l]=u.useState(null),[o,d]=u.useState(null);return e.jsx("div",{className:"h-24 overflow-auto text-sm divide-y divide-slate-700/40",children:s.length===0?e.jsx("div",{className:"opacity-60 py-1",children:"No messages yet."}):s.map((c,h)=>{const m=Yl(c.text),x=Uu(c.text);return e.jsxs("div",{className:"relative group px-1 py-1 flex items-start gap-2",onTouchStart:a?p=>{const g=p.touches[0];l({x:g.clientX,y:g.clientY,i:h,t:Date.now()})}:void 0,onTouchMove:a?p=>{if(!r||r.i!==h)return;p.touches[0].clientX-r.x<-40&&d(h)}:void 0,onTouchEnd:a?()=>{const p=r?Date.now()-r.t:0;(o===h||p>600)&&(n(h),d(null)),l(null)}:void 0,children:[e.jsxs("span",{className:"text-slate-400 shrink-0",children:["[",c.from,"]"]}),e.jsx("span",{className:"text-white break-words whitespace-pre-wrap flex-1",children:m}),!a&&e.jsxs("div",{className:"opacity-0 group-hover:opacity-100 transition-opacity flex items-center gap-1 ml-2",children:[e.jsx("button",{className:"w-5 h-5 rounded-full bg-rose-600 hover:bg-rose-700 text-white text-xs flex items-center justify-center",title:"Delete message","aria-label":"Delete message",onClick:()=>n(h),children:"â”œÃ¹"}),i&&e.jsx("button",{className:"px-1.5 py-0.5 rounded bg-slate-700 hover:bg-slate-800 text-slate-100 text-[11px]",onClick:()=>i(h),title:"Block sender",children:"Block"}),e.jsx("button",{className:"px-1.5 py-0.5 rounded bg-amber-600/40 hover:bg-amber-600/60 text-amber-100 text-[11px]",onClick:()=>t(h),title:"Report message",children:"Report"})]}),x&&e.jsx("span",{className:"ml-2 text-[10px] px-1 rounded bg-rose-600/30 text-rose-200 border border-rose-600/40",children:"Filtered"})]},c.key)})})}function am({user:s}){const{players:n,inProgress:t,startingScore:i,newMatch:a}=ha(),[r,l]=u.useState("x01"),[o,d]=u.useState("Player 1, Player 2"),[c,h]=u.useState(501),[m,x]=u.useState([]),[p,g]=u.useState(""),[w,T]=u.useState(!1),[S,E]=u.useState(""),[I,M]=u.useState([]),[P,A]=u.useState(!1),v=String(s?.email||"").toLowerCase();u.useEffect(()=>{let R=!1;async function F(){try{if(!v)return;const me=await(await fetch(`/api/friends/list?email=${encodeURIComponent(v)}`)).json().catch(()=>({friends:[]}));R||x(me.friends||[])}catch{}}F();const D=setInterval(F,2e4);return()=>{R=!0,clearInterval(D)}},[v]),u.useEffect(()=>{try{const R=v?`ndn:stats:opponent:${v}`:"ndn:stats:opponent",F=localStorage.getItem(R);F&&g(F)}catch{}},[v]),u.useEffect(()=>{try{const R=v?`ndn:stats:opponent:${v}`:"ndn:stats:opponent";p?localStorage.setItem(R,p):localStorage.removeItem(R)}catch{}},[p,v]);async function b(R){if(E(R),!R.trim()){M([]);return}A(!0);try{const D=await(await fetch(`/api/friends/search?q=${encodeURIComponent(R)}`)).json().catch(()=>({results:[]}));M(D.results||[])}finally{A(!1)}}const H=u.useMemo(()=>{const R=new Map;if(r==="x01")for(const D of n)for(const Q of D.legs)for(const me of Q.visits){const ue=Math.max(0,Math.min(180,me.score));R.set(ue,(R.get(ue)??0)+1)}const F=Array.from(R.entries()).sort((D,Q)=>D[0]-Q[0]);return F.length===0&&r==="x01"?([0,26,41,60,81,100,120,140,160,180].forEach(D=>R.set(D,0)),Array.from(R.entries()).sort((D,Q)=>D[0]-Q[0]).map(([D,Q])=>({label:D,value:Q}))):F.map(([D,Q])=>({label:D,value:Q}))},[n,r]),W=u.useMemo(()=>{const R=xi(Ia);return Ia.map(F=>{const D=R[F]||{played:0,won:0};return{label:F,value:D.played,extra:D.won}})},[r]);return u.useEffect(()=>{const R=()=>l(F=>F);return window.addEventListener("ndn:stats-updated",R),()=>window.removeEventListener("ndn:stats-updated",R)},[]),e.jsxs("div",{className:"card ndn-game-shell",children:[e.jsxs("div",{className:"mb-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h2",{className:"text-2xl font-extrabold text-white",children:"Match Stats"}),e.jsx("span",{className:"text-xs opacity-70",children:"View"})]}),e.jsx(Xa,{tabs:[{key:"x01",label:"X01"},{key:"other",label:"Other Modes"}],active:r,onChange:R=>l(R)})]}),n.length===0&&e.jsxs("div",{className:"mb-4 p-4 rounded-2xl border border-indigo-500/20 bg-gradient-to-r from-purple-800/6 to-indigo-800/6 shadow-sm",children:[e.jsx("div",{className:"font-semibold mb-2 text-lg",children:"No match data yet"}),e.jsx("div",{className:"text-sm opacity-80 mb-4",children:"Start a quick X01 match to generate stats. Stats like Best/Worst 3-dart are finalized when you end the game."}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-3 items-end",children:[e.jsxs("div",{className:"transition-transform duration-200 hover:-translate-y-1",children:[e.jsx("label",{className:"block text-xs text-slate-300 mb-1",children:"Players (comma separated)"}),e.jsx("input",{className:"input w-full rounded-lg bg-white/5",value:o,onChange:R=>d(R.target.value)})]}),e.jsxs("div",{className:"transition-transform duration-200 hover:-translate-y-1",children:[e.jsx("label",{className:"block text-xs text-slate-300 mb-1",children:"Starting Score"}),e.jsx("input",{className:"input w-full rounded-lg bg-white/5",type:"number",value:c,onChange:R=>h(parseInt(R.target.value||"501"))})]}),e.jsx("div",{className:"transition-transform duration-200 hover:-translate-y-1",children:e.jsx("button",{className:"btn w-full bg-gradient-to-r from-purple-500 to-pink-500 text-white shadow-md hover:from-purple-600 hover:to-pink-600 transform transition-transform duration-200 hover:-translate-y-1 hover:shadow-lg",onClick:()=>{const R=o.split(",").map(F=>F.trim()).filter(Boolean);if(!R.length)return alert("Enter at least one player");a(R,c)},children:"Start Match"})})]})]}),t&&e.jsx("div",{className:"mb-3 p-2 rounded-lg text-sm border border-amber-500/40 bg-amber-500/10 text-amber-200",children:"Note: Detailed leg stats are finalized at the end of the game."}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[n.map((R,F)=>e.jsxs("div",{className:"p-4 rounded-2xl border border-indigo-500/20 bg-gradient-to-br from-indigo-700/6 to-indigo-900/6 shadow-sm transform transition-transform duration-200 hover:-translate-y-1 hover:shadow-lg",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("div",{className:"font-semibold",children:F===1&&!p?R.name||"Opponent":F===1&&p?p:R.name}),F===1&&e.jsxs("div",{className:"flex gap-2 items-center overflow-x-auto py-1",children:[e.jsx("button",{className:"text-[11px] px-3 py-1 rounded-full bg-white/5 border border-white/10 hover:bg-white/10",onClick:()=>T(D=>!D),title:"Search user to compare",children:"Select Friend"}),m.slice(0,6).map(D=>{const Q=D.username||D.email,me=p===Q;return e.jsx("button",{className:`text-[11px] px-3 py-1 rounded-full border ${me?"bg-indigo-500/30 border-indigo-400/50":"bg-white/6 border-white/8 hover:bg-white/10 transform hover:-translate-y-0.5 transition-all duration-150"}`,onClick:()=>g(Q),title:`Compare vs ${Q}`,children:Q},D.email)}),m.length===0&&e.jsx("button",{className:"text-[11px] px-3 py-1 rounded-full bg-white/5 border border-white/10",disabled:!0,children:"Find friends to compare"})]})]}),F===1&&w&&e.jsxs("div",{className:"mb-2 p-2 rounded-lg bg-black/20 border border-white/10",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("input",{className:"input flex-1 py-1",placeholder:"Search by name or email",value:S,onChange:D=>b(D.target.value)}),e.jsx("button",{className:"btn px-3 py-1 text-sm",onClick:()=>b(S),disabled:P,children:"Search"})]}),e.jsxs("ul",{className:"max-h-40 overflow-auto space-y-1",children:[I.map(D=>{const Q=D.username||D.email;return e.jsx("li",{children:e.jsx("button",{className:"w-full text-left px-2 py-1 rounded bg-white/5 hover:bg-white/10 border border-white/10 text-sm",onClick:()=>{g(Q),T(!1)},children:Q})},D.email)}),!I.length&&e.jsx("li",{className:"text-xs opacity-70",children:S.trim()?"No results":"Type to searchâ€¦"})]})]}),F===1&&p?e.jsxs("div",{className:"grid grid-cols-2 gap-2 text-sm",children:[e.jsxs("div",{className:"p-2 rounded-lg bg-white/5 border border-white/10",children:[e.jsx("div",{className:"text-slate-300",children:"Best 3-Dart"}),e.jsx("div",{className:"font-semibold",children:At(Bs(p).best3||0)})]}),e.jsxs("div",{className:"p-2 rounded-lg bg-white/5 border border-white/10",children:[e.jsx("div",{className:"text-slate-300",children:"Worst 3-Dart"}),e.jsx("div",{className:"font-semibold",children:At(Bs(p).worst3||0)})]}),e.jsxs("div",{className:"p-2 rounded-lg bg-white/5 border border-white/10",children:[e.jsx("div",{className:"text-slate-300",children:"Best 9-Dart (fewest darts)"}),e.jsx("div",{className:"font-semibold",children:(()=>{const D=Bs(p);return D.bestLegDarts?`${D.bestLegDarts} darts`:"â€”"})()})]}),e.jsxs("div",{className:"p-2 rounded-lg bg-white/5 border border-white/10",children:[e.jsx("div",{className:"text-slate-300",children:"Best Checkout"}),e.jsx("div",{className:"font-semibold",children:Bs(p).bestCheckout||"â€”"})]}),e.jsxs("div",{className:"p-2 rounded-lg bg-white/5 border border-white/10 col-span-2",children:[e.jsx("div",{className:"text-slate-300",children:"Averages (All-time vs Monthly)"}),e.jsxs("div",{className:"font-semibold flex flex-wrap gap-3 text-[13px]",children:[e.jsxs("span",{children:["3-dart: ",At(wn(p))," Â· ",At(br(p))]}),e.jsxs("span",{children:["First 9: ",At(pr(p))," Â· ",At(gr(p))]})]})]}),e.jsxs("div",{className:"p-2 rounded-lg bg-white/5 border border-white/10 col-span-2",children:[e.jsx("div",{className:"text-slate-300",children:"All-time snapshot"}),(()=>{const D=Bs(p);return e.jsxs("div",{className:"font-semibold flex flex-wrap gap-3 text-[13px]",children:[e.jsxs("span",{children:["Best 3-dart: ",At(D.best3||0)]}),e.jsxs("span",{children:["Worst 3-dart: ",At(D.worst3||0)]}),e.jsxs("span",{children:["Best leg: ",D.bestLegDarts||0," darts"]}),e.jsxs("span",{children:["Best checkout: ",D.bestCheckout||0]})]})})()]})]}):e.jsxs("div",{className:"grid grid-cols-2 gap-2 text-sm",children:[e.jsxs("div",{className:"p-2 rounded-lg bg-white/5 border border-white/10",children:[e.jsx("div",{className:"text-slate-300",children:"Best 3-Dart"}),e.jsx("div",{className:"font-semibold",children:At(R.bestThreeDartAvg)})]}),e.jsxs("div",{className:"p-2 rounded-lg bg-white/5 border border-white/10",children:[e.jsx("div",{className:"text-slate-300",children:"Worst 3-Dart"}),e.jsx("div",{className:"font-semibold",children:At(R.worstThreeDartAvg)})]}),e.jsxs("div",{className:"p-2 rounded-lg bg-white/5 border border-white/10",children:[e.jsx("div",{className:"text-slate-300",children:"Best 9-Dart (fewest darts)"}),e.jsx("div",{className:"font-semibold",children:R.bestNineDart?`${R.bestNineDart.darts} darts`:"â€”"})]}),e.jsxs("div",{className:"p-2 rounded-lg bg-white/5 border border-white/10",children:[e.jsx("div",{className:"text-slate-300",children:"Best Checkout"}),e.jsx("div",{className:"font-semibold",children:R.bestCheckout??"â€”"})]}),e.jsxs("div",{className:"p-2 rounded-lg bg-white/5 border border-white/10 col-span-2",children:[e.jsx("div",{className:"text-slate-300",children:"Averages (All-time vs Monthly)"}),e.jsxs("div",{className:"font-semibold flex flex-wrap gap-3 text-[13px]",children:[e.jsxs("span",{children:["3-dart: ",At(wn(R.name))," Â· ",At(br(R.name))]}),e.jsxs("span",{children:["First 9: ",At(pr(R.name))," Â· ",At(gr(R.name))]})]})]}),e.jsxs("div",{className:"p-2 rounded-lg bg-white/5 border border-white/10 col-span-2",children:[e.jsx("div",{className:"text-slate-300",children:"All-time snapshot"}),(()=>{const D=Bs(R.name);return e.jsxs("div",{className:"font-semibold flex flex-wrap gap-3 text-[13px]",children:[e.jsxs("span",{children:["Best 3-dart: ",At(D.best3||0)]}),e.jsxs("span",{children:["Worst 3-dart: ",At(D.worst3||0)]}),e.jsxs("span",{children:["Best leg: ",D.bestLegDarts||0," darts"]}),e.jsxs("span",{children:["Best checkout: ",D.bestCheckout||0]})]})})()]})]})]},R.id)),n.length<=1&&e.jsxs("div",{className:"p-3 rounded-2xl border border-purple-500/20 bg-gradient-to-r from-purple-800/6 to-pink-800/6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("div",{className:"font-semibold",children:"Opponent"}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[m.slice(0,6).map(R=>{const F=R.username||R.email,D=p===(R.username||R.email);return e.jsx("button",{className:`text-[11px] px-3 py-1 rounded-full border ${D?"bg-gradient-to-r from-purple-500 to-pink-500 text-white border-transparent shadow-sm":"bg-gradient-to-r from-purple-500/8 to-pink-500/8 border-white/10 hover:from-purple-500/12 hover:to-pink-500/12"}`,onClick:()=>g(F),title:`Compare vs ${F}`,children:F},R.email)}),m.length===0&&e.jsx("span",{className:"text-xs opacity-70",children:"Add friends to compare stats."})]})]}),p?e.jsxs("div",{className:"grid grid-cols-2 gap-2 text-sm",children:[e.jsxs("div",{className:"p-2 rounded-lg bg-white/5 border border-white/10 col-span-2",children:[e.jsx("div",{className:"text-slate-300",children:"Comparing to"}),e.jsx("div",{className:"font-semibold",children:p})]}),e.jsxs("div",{className:"p-2 rounded-lg bg-white/5 border border-white/10",children:[e.jsx("div",{className:"text-slate-300",children:"Best 3-Dart"}),e.jsx("div",{className:"font-semibold",children:At(wn(p))})]}),e.jsxs("div",{className:"p-2 rounded-lg bg-white/5 border border-white/10",children:[e.jsx("div",{className:"text-slate-300",children:"Worst 3-Dart"}),e.jsx("div",{className:"font-semibold",children:At(Bs(p).worst3||0)})]}),e.jsxs("div",{className:"p-2 rounded-lg bg-white/5 border border-white/10",children:[e.jsx("div",{className:"text-slate-300",children:"Best 9-Dart (fewest darts)"}),e.jsx("div",{className:"font-semibold",children:(()=>{const R=Bs(p);return R.bestLegDarts?`${R.bestLegDarts} darts`:"â€”"})()})]}),e.jsxs("div",{className:"p-2 rounded-lg bg-white/5 border border-white/10",children:[e.jsx("div",{className:"text-slate-300",children:"Best Checkout"}),e.jsx("div",{className:"font-semibold",children:Bs(p).bestCheckout||"â€”"})]}),e.jsxs("div",{className:"p-2 rounded-lg bg-white/5 border border-white/10 col-span-2",children:[e.jsx("div",{className:"text-slate-300",children:"Averages (All-time vs Monthly)"}),e.jsxs("div",{className:"font-semibold flex flex-wrap gap-3 text-[13px]",children:[e.jsxs("span",{children:["3-dart: ",At(wn(p))," Â· ",At(br(p))]}),e.jsxs("span",{children:["First 9: ",At(pr(p))," Â· ",At(gr(p))]})]})]}),e.jsxs("div",{className:"p-2 rounded-lg bg-white/5 border border-white/10 col-span-2",children:[e.jsx("div",{className:"text-slate-300",children:"All-time snapshot"}),(()=>{const R=Bs(p);return e.jsxs("div",{className:"font-semibold flex flex-wrap gap-3 text-[13px]",children:[e.jsxs("span",{children:["Best 3-dart: ",At(R.best3||0)]}),e.jsxs("span",{children:["Worst 3-dart: ",At(R.worst3||0)]}),e.jsxs("span",{children:["Best leg: ",R.bestLegDarts||0," darts"]}),e.jsxs("span",{children:["Best checkout: ",R.bestCheckout||0]})]})})()]})]}):e.jsx("div",{className:"text-sm opacity-70",children:"Select a friend above to compare."})]})]}),e.jsxs("div",{className:"mt-6",children:[e.jsxs("div",{className:"mb-2 text-sm opacity-80",children:["Score Distribution (",r.toUpperCase(),"): Visits by scored points"]}),e.jsx("div",{className:"rounded-xl border border-indigo-500/20 bg-gradient-to-br from-indigo-800/6 to-indigo-700/6 p-3 min-h-[220px] transform transition-shadow duration-200 hover:shadow-lg",children:e.jsx(ui,{data:H,showValues:!1})})]}),e.jsxs("div",{className:"mt-6",children:[e.jsx("div",{className:"mb-2 text-sm opacity-80",children:"Other Modes: games played (bar height) with wins shown beneath each label"}),e.jsxs("div",{className:"rounded-xl border border-indigo-500/20 bg-gradient-to-br from-indigo-800/6 to-indigo-700/6 p-3",children:[e.jsx("div",{className:"min-h-[180px]",children:e.jsx(ui,{data:W.map(R=>({label:R.label,value:R.value})),showValues:!1})}),e.jsx("div",{className:"mt-3 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-3 text-[12px] opacity-95",children:W.map((R,F)=>e.jsxs("div",{className:"flex items-center justify-between px-3 py-2 rounded-lg bg-gradient-to-r from-purple-700/6 to-pink-700/6 border border-purple-500/12 shadow-sm transform transition-transform duration-200 hover:-translate-y-1 hover:shadow-md",children:[e.jsx("span",{className:"truncate mr-2",children:R.label}),e.jsxs("span",{className:"whitespace-nowrap",children:["Played ",R.value," Â· Won ",R.extra]})]},F))})]})]})]})}function rm({user:s}){const n=zn(),t=(()=>{try{return xa()}catch{return null}})(),{matchType:i="singles",setMatchType:a,teamAName:r="Team A",setTeamAName:l,teamBName:o="Team B",setTeamBName:d}=Ft(),[c,h]=u.useState([]),[m,x]=u.useState(!1),[p,g]=u.useState(""),[w,T]=u.useState(null),[S,E]=u.useState(!1),[I,M]=u.useState({open:!1,t:null}),[P,A]=u.useState({open:!1,t:null}),[v,b]=u.useState({title:"Community X01 Tournament",game:"X01",mode:"bestof",value:3,description:"",startAt:new Date(Date.now()+7200*1e3).toISOString().slice(0,16),checkinMinutes:15,capacity:8,startingScore:501,requireCalibration:!1}),H=(()=>{try{return"ontouchstart"in window||(navigator.maxTouchPoints||0)>0}catch{return!1}})();async function W(){try{const te=await(await Pt("/api/tournaments")).json();h(Array.isArray(te.tournaments)?te.tournaments:[])}catch{}}u.useEffect(()=>{W()},[]),u.useEffect(()=>{if(!t)return;const $=t.addListener(te=>{try{te.type==="tournaments"&&h(te.tournaments||[]),te.type==="tournament-win"&&te.message&&n(te.message,{type:"success",timeout:1e4})}catch{}});return()=>{$()}},[t?.connected]);const R=String(s?.email||"").toLowerCase(),F=()=>e.jsxs("div",{className:"mb-3 p-2 rounded-lg bg-slate-900/40 border border-white/10 text-white text-xs flex items-center gap-2 flex-wrap",children:[e.jsx("span",{className:"opacity-70",children:"Default match"}),e.jsxs("select",{className:"btn py-1 px-2",value:i,onChange:$=>a($.target.value),children:[e.jsx("option",{value:"singles",children:"Singles"}),e.jsx("option",{value:"doubles",children:"Doubles"})]}),e.jsx("input",{className:"input py-1 px-2 w-[8rem]",value:r,onChange:$=>l($.target.value),placeholder:"Team A"}),e.jsx("span",{className:"opacity-50",children:"vs"}),e.jsx("input",{className:"input py-1 px-2 w-[8rem]",value:o,onChange:$=>d($.target.value),placeholder:"Team B"})]});u.useEffect(()=>{let $=!1;async function te(){if(!R){T(null);return}try{const He=await(await Pt(`/api/subscription?email=${encodeURIComponent(R)}`)).json();$||(He?.source==="tournament"&&typeof He.expiresAt=="number"&&He.expiresAt>Date.now()?T(He.expiresAt):T(null))}catch{$||T(null)}}return te(),()=>{$=!0}},[R]);function D($){return!!$.participants?.some(te=>te.email===R)}async function Q($){R&&A({open:!0,t:$})}async function me(){const $=P.t;if(!(!$||!R)){A({open:!1,t:null}),x(!0);try{let te=await Pt("/api/tournaments/delete",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({tournamentId:$.id,requesterEmail:R})});if(!te.ok&&te.status===403&&String(R)==="daviesfamily108@gmail.com"&&(te=await Pt("/api/admin/tournaments/delete",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({tournamentId:$.id,requesterEmail:R})})),!te.ok){let oe="Delete failed";try{const He=await te.json();He?.error&&(oe=`Delete failed: ${String(He.error)}`)}catch{}n(oe,{type:"error"});return}n("Tournament deleted",{type:"success"}),await W()}finally{x(!1)}}}async function ue($){if(R){x(!0);try{const te=await Pt("/api/tournaments/join",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({tournamentId:$.id,email:R,username:s?.username})});if(!te.ok){let oe={};try{oe=await te.json()}catch{}oe?.error==="WINNER_COOLDOWN"&&typeof oe.until=="number"?(g(`You're a recent NDN tournament winner. You can re-enter after ${Ee(oe.until)}.`),setTimeout(()=>g(""),6e3),n("Join blocked: winner cooldown active",{type:"error"})):oe?.error==="ALREADY_IN_TOURNAMENT"?(g(String(oe.message||"You can only join one tournament at a time.")),setTimeout(()=>g(""),6e3),n("Join blocked: already in another tournament",{type:"error"})):oe?.error&&(g(String(oe.error)),setTimeout(()=>g(""),3500),n(`Join failed: ${String(oe.error)}`,{type:"error"}));return}n("Joined tournament",{type:"success"}),await W()}finally{x(!1)}}}async function ke($){if(R){x(!0);try{const te=await Pt("/api/tournaments/leave",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({tournamentId:$.id,email:R})});if(!te.ok){let oe={};try{oe=await te.json()}catch{}oe?.error?n(`Leave failed: ${String(oe.error)}`,{type:"error"}):te.status===404?n("Leave failed (endpoint not found). Restart the server to enable /api/tournaments/leave.",{type:"error"}):n("Leave failed. Please try again.",{type:"error"});return}n("Left tournament",{type:"success"}),h(oe=>oe.map(He=>He.id===$.id?{...He,participants:(He.participants||[]).filter(We=>We.email!==R)}:He)),await W()}finally{x(!1)}}}async function _e(){x(!0);try{const $=new Date(v.startAt).getTime();await Pt("/api/tournaments/create",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:v.title,game:v.game,mode:v.mode,value:Number(v.value),description:v.description,startAt:$,checkinMinutes:Number(v.checkinMinutes),capacity:Number(v.capacity),startingScore:v.game==="X01"?Number(v.startingScore||501):void 0,requireCalibration:!!v.requireCalibration,creatorEmail:s?.email,creatorName:s?.username})}),E(!1),n("Tournament created",{type:"success"}),await W()}finally{x(!1)}}u.useEffect(()=>{if(!S)return;const $=te=>{te.key==="Escape"&&E(!1)};return document.addEventListener("keydown",$),()=>document.removeEventListener("keydown",$)},[S]);const Pe=u.useMemo(()=>c.filter($=>$.official),[c]),Le=u.useMemo(()=>c.filter($=>!$.official),[c]),ve=u.useMemo(()=>Pe.filter(te=>te.status==="scheduled").sort((te,oe)=>te.startAt-oe.startAt)[0]||null,[Pe]);function Ee($){return new Date($).toLocaleString()}return e.jsxs("div",{className:"card ndn-game-shell",children:[e.jsx("div",{className:"flex items-center justify-between mb-3",children:e.jsx("h2",{className:"text-2xl font-bold",children:"Tournaments"})}),e.jsxs("div",{className:"ndn-shell-body",children:[e.jsxs("div",{className:"mb-3 p-3 rounded-xl bg-indigo-500/10 border border-indigo-500/40 flex items-center justify-between gap-2 flex-wrap",children:[e.jsx("div",{className:"min-w-0",children:e.jsx(F,{})}),e.jsx("div",{className:"shrink-0",children:e.jsx("button",{className:"btn",onClick:()=>E(!0),children:"Create Tournament +"})})]}),e.jsx("div",{className:"mb-2 text-sm font-semibold text-slate-300",children:"World Lobby"}),ve&&e.jsx("div",{className:"mb-4 p-3 rounded-xl border border-indigo-500/40 bg-indigo-500/10",children:e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center md:justify-between gap-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm uppercase tracking-wide text-indigo-300 font-semibold",children:"Weekly Official Tournament"}),e.jsx("div",{className:"font-bold",children:ve.title}),e.jsxs("div",{className:"text-sm opacity-80",children:[ve.game,ve.game==="X01"&&ve.startingScore?`/${ve.startingScore}`:""," Â· ",ve.mode==="firstto"?"First to":"Best of"," ",ve.value," Â· Starts ",Ee(ve.startAt)," Â· Cap ",ve.capacity," Â· Joined ",ve.participants.length]}),ve.prize&&e.jsxs("div",{className:"text-xs mt-1",children:["Prize: ",ve.prizeType==="cash"&&ve.prizeAmount?`${ve.currency||"USD"} ${ve.prizeAmount}`:"3 months PREMIUM"]}),ve.status!=="scheduled"&&e.jsxs("div",{className:"text-xs",children:["Status: ",ve.status]}),w&&w>Date.now()&&e.jsxs("div",{className:"text-xs text-rose-300",children:["Recent winners can re-enter after ",Ee(w),"."]})]}),e.jsx("div",{className:"shrink-0",children:e.jsx("button",{className:`btn ${D(ve)?"bg-emerald-600 hover:bg-emerald-600":""}`,title:D(ve)?"Double-click to leave this tournament":ve.official&&w&&w>Date.now()?`Recent winners can re-enter after ${Ee(w)}`:"",disabled:m||ve.status!=="scheduled"||!D(ve)&&(ve.participants.length>=ve.capacity||!!w&&w>Date.now()),onClick:()=>{D(ve)?H&&M({open:!0,t:ve}):ue(ve)},onDoubleClick:()=>{!H&&D(ve)&&M({open:!0,t:ve})},"aria-label":D(ve)?"Already Joined":"Join Now",children:D(ve)?"Already Joined!":"Join Now"})})]})}),p&&e.jsx("div",{className:"mb-3 p-2 rounded-lg bg-amber-700/30 border border-amber-600/40 text-amber-200 text-sm",children:p}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("section",{children:[e.jsx("div",{className:"font-semibold mb-1",children:"Official"}),e.jsx("div",{className:"text-xs opacity-70 mb-2",children:w&&w>Date.now()?e.jsxs(e.Fragment,{children:["Youâ€™re a recent NDN tournament winner â€” to keep it fair, you can re-enter after ",Ee(w),"."]}):e.jsx(e.Fragment,{children:"Note: Weekly winners can re-enter once their 3 months of PREMIUM ends."})}),e.jsxs("ul",{className:"space-y-2",children:[Pe.map($=>e.jsxs("li",{className:"p-3 rounded bg-black/10 flex items-center justify-between relative",children:[e.jsxs("div",{className:"space-y-0.5",children:[e.jsxs("div",{className:"font-semibold",children:[$.title," ",$.prize&&e.jsxs("span",{className:"inline-flex items-center gap-1 ml-2 align-middle",children:[e.jsx("span",{className:"text-xs px-2 py-0.5 rounded bg-amber-500 text-black",children:"Prize"}),e.jsx("span",{className:"inline-flex items-center justify-center w-4 h-4 rounded-full bg-slate-600 text-white text-[10px] leading-none cursor-help",title:$.prizeType==="cash"?"Official cash prize tournament â€” payout handled by admin.":"Weekly winners get 3 months of PREMIUM and can re-enter once their prize period ends.","aria-label":"Prize info",children:"i"})]}),$.requireCalibration&&e.jsx("span",{className:"ml-2 inline-block text-xs px-2 py-0.5 rounded bg-purple-700 text-white",children:"Requires calibration"})]}),e.jsxs("div",{className:"text-sm opacity-80",children:[$.game,$.game==="X01"&&$.startingScore?`/${$.startingScore}`:""," Â· ",$.mode==="firstto"?"First to":"Best of"," ",$.value," Â· ",Ee($.startAt)," Â· Cap ",$.capacity," Â· Joined ",$.participants.length]}),$.prize&&e.jsxs("div",{className:"text-xs",children:["Prize: ",$.prizeType==="cash"&&$.prizeAmount?`${$.currency||"USD"} ${$.prizeAmount}`:"3 months PREMIUM",$.status==="completed"&&$.prizeType==="cash"&&$.payoutStatus&&e.jsx("span",{className:`ml-2 px-2 py-0.5 rounded ${$.payoutStatus==="paid"?"bg-emerald-600":"bg-amber-600"}`,children:$.payoutStatus==="paid"?"Paid":"Pending"})]}),$.status!=="scheduled"&&e.jsxs("div",{className:"text-xs",children:["Status: ",$.status]}),D($)&&e.jsx("div",{className:"text-xs text-emerald-400 font-semibold",children:"Already Joined"}),$.official&&w&&w>Date.now()&&e.jsxs("div",{className:"text-xs text-rose-300",children:["Cooldown active until ",Ee(w),"."]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{className:`btn ${D($)?"bg-emerald-600 hover:bg-emerald-600":""}`,title:D($)?"Double-click to leave this tournament":$.official&&w&&w>Date.now()?`Recent winners can re-enter after ${Ee(w)}`:"",disabled:m||$.status!=="scheduled"||!D($)&&($.participants.length>=$.capacity||$.official&&!!w&&w>Date.now()),onClick:()=>{D($)?H&&M({open:!0,t:$}):ue($)},onDoubleClick:()=>{!H&&D($)&&M({open:!0,t:$})},"aria-label":D($)?"Already Joined":"Join Now",children:D($)?"Already Joined!":"Join Now"}),$.status==="scheduled"&&R&&$.creatorEmail&&String($.creatorEmail).toLowerCase()===R&&e.jsx("button",{className:"w-6 h-6 rounded-full bg-rose-600 hover:bg-rose-700 text-white text-xs flex items-center justify-center shadow",title:"Delete this tournament",onClick:()=>Q($),"aria-label":"Delete tournament",children:"Ã—"})]})]},$.id)),Pe.length===0&&e.jsx("li",{className:"text-sm opacity-60",children:"No official tournaments yet."})]})]}),e.jsxs("section",{children:[e.jsx("div",{className:"font-semibold mb-1",children:"Community"}),e.jsxs("ul",{className:"space-y-2",children:[Le.map($=>e.jsxs("li",{className:"p-3 rounded bg-black/10 flex items-center justify-between relative",children:[e.jsxs("div",{className:"space-y-0.5",children:[e.jsx("div",{className:"font-semibold",children:$.title}),e.jsxs("div",{className:"text-sm opacity-80",children:[$.game,$.game==="X01"&&$.startingScore?`/${$.startingScore}`:""," Â· ",$.mode==="firstto"?"First to":"Best of"," ",$.value," Â· ",Ee($.startAt)," Â· Cap ",$.capacity," Â· Joined ",$.participants.length]}),$.description&&e.jsx("div",{className:"text-xs opacity-80",children:$.description}),D($)&&e.jsx("div",{className:"text-xs text-emerald-400 font-semibold",children:"Already Joined"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{className:"btn",title:D($)?"Double-click to leave this tournament":"",disabled:m||$.status!=="scheduled"||!D($)&&$.participants.length>=$.capacity,onClick:()=>{D($)?H&&M({open:!0,t:$}):ue($)},onDoubleClick:()=>{!H&&D($)&&M({open:!0,t:$})},children:D($)?"Already Joined":"Join Now"}),$.status==="scheduled"&&R&&$.creatorEmail&&String($.creatorEmail).toLowerCase()===R&&e.jsx("button",{className:"w-6 h-6 rounded-full bg-rose-600 hover:bg-rose-700 text-white text-xs flex items-center justify-center shadow",title:"Delete this tournament",onClick:()=>Q($),"aria-label":"Delete tournament",children:"Ã—"})]})]},$.id)),Le.length===0&&e.jsx("li",{className:"text-sm opacity-60",children:"No community tournaments yet."})]})]})]}),S&&e.jsx("div",{className:"mb-4",children:e.jsxs("div",{className:"card relative",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h3",{className:"text-xl font-semibold",children:"Create Tournament"}),e.jsx("button",{className:"btn",onClick:()=>E(!1),children:"Close"})]}),e.jsxs("div",{className:"space-y-3 md:space-y-0 md:grid md:grid-cols-2 md:gap-4 pr-1",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-semibold mb-1",children:"Title"}),e.jsx("input",{className:"input w-full",value:v.title,onChange:$=>b(te=>({...te,title:$.target.value}))})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-2",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-semibold mb-1",children:"Game"}),e.jsx("select",{className:"input w-full",value:v.game,onChange:$=>b(te=>({...te,game:$.target.value})),children:["X01","Around the Clock","Cricket","Halve It","Shanghai","High-Low","Killer"].map($=>e.jsx("option",{value:$,children:$},$))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-semibold mb-1",children:"Mode"}),e.jsxs("select",{className:"input w-full",value:v.mode,onChange:$=>b(te=>({...te,mode:$.target.value})),children:[e.jsx("option",{value:"bestof",children:"Best of"}),e.jsx("option",{value:"firstto",children:"First to"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-semibold mb-1",children:"Number"}),e.jsx("input",{className:"input w-full",type:"number",min:1,value:v.value,onChange:$=>b(te=>({...te,value:Number($.target.value)}))})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-semibold mb-1",children:"Description"}),e.jsx("textarea",{className:"input w-full",rows:5,value:v.description,onChange:$=>b(te=>({...te,description:$.target.value}))})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-2",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-semibold mb-1",children:"Start time"}),e.jsx("input",{className:"input w-full",type:"datetime-local",value:v.startAt,onChange:$=>b(te=>({...te,startAt:$.target.value}))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-semibold mb-1",children:"Check-in reminder (min)"}),e.jsx("input",{className:"input w-full",type:"number",min:0,value:v.checkinMinutes,onChange:$=>b(te=>({...te,checkinMinutes:Number($.target.value)}))})]})]}),v.game==="X01"&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-semibold mb-1",children:"X01 Starting Score"}),e.jsx("select",{className:"input w-full",value:String(v.startingScore),onChange:$=>b(te=>({...te,startingScore:Number($.target.value)})),children:[301,501,701].map($=>e.jsx("option",{value:$,children:$},$))})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"inline-flex items-center gap-2 text-sm",children:[e.jsx("input",{type:"checkbox",className:"accent-purple-500",checked:!!v.requireCalibration,onChange:$=>b(te=>({...te,requireCalibration:!!$.target.checked}))}),e.jsx("span",{className:"font-semibold",children:"Require calibration"})]}),e.jsx("div",{className:"text-xs opacity-70 mt-1",children:"If checked, players must have a calibrated board to join matches spawned from this tournament."})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-semibold mb-1",children:"Capacity"}),e.jsx("input",{className:"input w-full",type:"number",min:6,max:64,value:v.capacity,onChange:$=>b(te=>({...te,capacity:Number($.target.value)}))})]}),e.jsx("div",{className:"text-xs opacity-70",children:"Note: community tournaments do not award prizes."}),e.jsx("div",{className:"flex justify-end",children:e.jsx("button",{className:"btn",disabled:m,onClick:_e,children:"Create"})})]})]})}),I.open&&I.t&&e.jsxs("div",{className:"fixed inset-0 z-50 flex items-center justify-center",children:[e.jsx("div",{className:"absolute inset-0 bg-black/40",onClick:()=>M({open:!1,t:null})}),e.jsxs("div",{className:"relative card p-4 w-[360px] max-w-[90vw]",children:[e.jsx("div",{className:"text-lg font-semibold mb-2",children:"Leave tournament?"}),e.jsxs("div",{className:"text-sm opacity-80 mb-4",children:["Are you sure you want to remove yourself from â€œ",I.t.title,"â€?"]}),e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx("button",{className:"btn bg-rose-600 hover:bg-rose-700",onClick:()=>M({open:!1,t:null}),children:"Decline"}),e.jsx("button",{className:"btn bg-emerald-600 hover:bg-emerald-700",onClick:async()=>{const $=I.t;M({open:!1,t:null}),await ke($)},children:"Accept"})]})]})]}),P.open&&P.t&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50",children:e.jsx("div",{className:"bg-slate-800 border border-slate-600 rounded-lg p-6 max-w-md w-full mx-4 shadow-xl",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-xl font-semibold mb-4 text-white",children:"Delete Tournament"}),e.jsxs("div",{className:"text-slate-300 mb-6",children:["Are you sure you want to delete ",e.jsxs("span",{className:"font-semibold text-white",children:['"',P.t.title,'"']}),"?",e.jsx("br",{}),e.jsx("span",{className:"text-sm text-slate-400",children:"This action cannot be undone."})]}),e.jsxs("div",{className:"flex gap-3 justify-center",children:[e.jsx("button",{className:"px-6 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium transition-colors",onClick:()=>A({open:!1,t:null}),children:"Decline"}),e.jsx("button",{className:"px-6 py-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg font-medium transition-colors",onClick:me,children:"Continue"})]})]})})})]})]})}function im({user:s}){const[n,t]=u.useState(null),[i,a]=u.useState(!0),[r,l]=u.useState(null),o="http://localhost:8787",d=zn();if(u.useEffect(()=>{(async()=>{try{const m=s?.email?`?email=${encodeURIComponent(s.email)}`:"",x=await fetch(`${o}/api/subscription`+m);if(!x.ok)throw new Error("Failed to fetch subscription");const p=await x.json();t(p)}catch(m){l(m instanceof Error?m.message:"Something went wrong")}finally{a(!1)}})()},[s?.email]),i)return e.jsx("div",{className:"card",children:e.jsxs("div",{className:"text-center py-8",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-500 mx-auto mb-4"}),e.jsx("p",{children:"Loading subscription..."})]})});if(r)return e.jsxs("div",{className:"card",children:[e.jsx("h2",{className:"text-2xl font-bold text-red-300 mb-2",children:"Subscription Error"}),e.jsx("p",{className:"mb-4 text-red-200",children:r}),e.jsx("button",{onClick:()=>window.location.reload(),className:"btn bg-red-600 hover:bg-red-700",children:"Retry"})]});const c=n?.fullAccess;return e.jsxs("div",{className:"card",children:[e.jsx("h2",{className:"text-2xl font-bold text-indigo-300 mb-2",children:c?"PREMIUM Active":"PREMIUM"}),c?e.jsxs("div",{className:"mb-4",children:[e.jsxs("div",{className:"bg-green-500/20 border border-green-500/40 rounded-lg p-4 mb-4",children:[e.jsx("div",{className:"flex items-center gap-2 text-green-300 font-semibold mb-2",children:"âœ… PREMIUM Access Active"}),e.jsx("p",{className:"text-green-200 text-sm",children:"You have full access to all premium features!"}),n?.source&&e.jsxs("p",{className:"text-green-200 text-xs mt-1",children:["Source: ",n.source,n?.expiresAt&&` (expires: ${new Date(n.expiresAt).toLocaleDateString()})`]})]}),e.jsx("h3",{className:"text-lg font-semibold mb-2 text-indigo-200",children:"Your Benefits:"})]}):e.jsx("p",{className:"mb-2 text-indigo-200",children:"Unlock every game mode known to darts, advanced stats, and premium features."}),e.jsxs("ul",{className:"mb-4",children:[e.jsx("li",{children:"All game modes (including paid/advanced)"}),e.jsx("li",{children:"Online play with all rules and variations"}),e.jsx("li",{children:"Advanced analytics and leaderboards"}),e.jsx("li",{children:"Premium camera modes and autoscoring"})]}),!c&&e.jsx("button",{onClick:async()=>{try{const m=await(await fetch(`${o}/api/stripe/create-checkout-session`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:s.email})})).json();m.ok&&m.url?window.location.href=m.url:m.error==="STRIPE_NOT_CONFIGURED"?d("Premium purchases are not available. Payment link not configured.",{type:"error",timeout:4e3}):d("Failed to get payment link. Please try again.",{type:"error",timeout:4e3})}catch{d("Error creating checkout. Please try again.",{type:"error",timeout:4e3})}},className:"btn bg-gradient-to-r from-indigo-500 to-fuchsia-600 text-white font-bold shadow-lg hover:scale-105 transition",children:"Subscribe to PREMIUM"})]})}function om({open:s,onClose:n,width:t=700,title:i,footer:a,children:r,side:l="right"}){return u.useEffect(()=>{function o(d){d.key==="Escape"&&n()}return s&&document.addEventListener("keydown",o),()=>document.removeEventListener("keydown",o)},[s,n]),e.jsxs("div",{className:`fixed inset-0 z-50 ${s?"":"pointer-events-none"}`,"aria-hidden":!s,children:[e.jsx("div",{className:`absolute inset-0 bg-black/60 transition-opacity ${s?"opacity-100":"opacity-0"}`,onClick:n}),e.jsxs("div",{className:`absolute top-0 ${l==="right"?"right-0 border-l":"left-0 border-r"} h-full bg-slate-900 border-slate-700 shadow-2xl w-full sm:w-auto flex flex-col transition-transform duration-200 ${s?"translate-x-0":l==="right"?"translate-x-full":"-translate-x-full"}`,style:{width:typeof t=="number"?`${t}px`:t},role:"dialog","aria-modal":"true",children:[e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b border-slate-700 sticky top-0 bg-slate-900 z-10",children:[e.jsx("div",{className:"text-lg font-semibold",children:i}),e.jsx("button",{className:"btn px-3 py-1 text-sm",onClick:n,children:"Close"})]}),e.jsx("div",{className:"flex-1 overflow-auto p-4",children:r}),a&&e.jsx("div",{className:"px-4 py-3 border-t border-slate-700 sticky bottom-0 bg-slate-900 z-10",children:a})]})]})}function lm({user:s}){const n=dl(s?.email),[t,i]=u.useState(null),[a,r]=u.useState(""),[l,o]=u.useState("");async function d(){try{const m=await Pt("/readyz");i(await m.json())}catch{}}if(u.useEffect(()=>{d();const m=setInterval(d,5e3);return()=>clearInterval(m)},[]),!n)return e.jsxs("div",{className:"card",children:[e.jsx("h2",{className:"text-2xl font-bold text-brand-700 mb-2",children:"Ops"}),e.jsx("div",{children:"Restricted"})]});async function c(m){o("");try{const x=await Pt("/api/admin/maintenance",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({enabled:m,requesterEmail:s?.email})}),p=await x.json();!x.ok||!p?.ok?o(p?.error||"Failed"):o(`Maintenance ${m?"enabled":"disabled"}`)}catch{o("Network error")}}async function h(){o("");const m=a.trim();if(m)try{const x=await Pt("/api/admin/announce",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:m,requesterEmail:s?.email})}),p=await x.json();!x.ok||!p?.ok?o(p?.error||"Failed"):o("Announcement broadcasted"),r("")}catch{o("Network error")}}return e.jsxs("div",{className:"card",children:[e.jsx("h2",{className:"text-2xl font-bold text-brand-700 mb-2",children:"Ops"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-3",children:[e.jsxs("div",{className:"p-3 rounded-xl border border-indigo-500/40 bg-indigo-500/10",children:[e.jsx("div",{className:"font-semibold mb-1",children:"Readiness"}),e.jsxs("div",{className:"text-sm",children:["HTTP: ",e.jsx("span",{className:`font-semibold ${t?.ok?"text-emerald-300":"text-rose-300"}`,children:String(!!t?.ok)})]}),e.jsxs("div",{className:"text-sm",children:["WS: ",e.jsx("span",{className:`font-semibold ${t?.ws?"text-emerald-300":"text-rose-300"}`,children:String(!!t?.ws)})]}),e.jsxs("div",{className:"text-sm",children:["Clients: ",e.jsx("span",{className:"font-semibold",children:t?.clients??0})]}),e.jsxs("div",{className:"text-sm",children:["Rooms: ",e.jsx("span",{className:"font-semibold",children:t?.rooms??0})]}),e.jsxs("div",{className:"text-sm",children:["Heap Used: ",e.jsxs("span",{className:"font-semibold",children:[t?.mem?Math.round(t.mem.heapUsed/1024/1024):0," MB"]})]})]}),e.jsxs("div",{className:"p-3 rounded-xl border border-indigo-500/40 bg-indigo-500/10",children:[e.jsx("div",{className:"font-semibold mb-1",children:"Maintenance"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{className:"btn",onClick:()=>c(!0),children:"Enable"}),e.jsx("button",{className:"btn bg-slate-700 hover:bg-slate-800",onClick:()=>c(!1),children:"Disable"})]})]}),e.jsxs("div",{className:"p-3 rounded-xl border border-indigo-500/40 bg-indigo-500/10",children:[e.jsx("div",{className:"font-semibold mb-1",children:"Announcement"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{className:"input flex-1",placeholder:"Message to broadcast",value:a,onChange:m=>r(m.target.value)}),e.jsx("button",{className:"btn",onClick:h,children:"Send"})]})]})]}),l&&e.jsx("div",{className:"text-xs mt-2",children:l}),e.jsx("div",{className:"text-xs opacity-70 mt-2",children:"âœ… Clustering enabled! For 1.5k+ concurrent users, deploy behind a reverse proxy (NGINX/Cloudflare) with sticky sessions for WebSockets. Set NODE_WORKERS environment variable to control worker count."})]})}function cm({}){const[s,n]=u.useState(!1),[t,i]=u.useState([{text:"Hi! I'm your Nine Dart Nation assistant. How can I help you today?",isUser:!1}]),[a,r]=u.useState(""),[l,o]=u.useState(!1),[d,c]=u.useState(""),[h,m]=u.useState(null),x=(()=>{try{return xa()}catch{return null}})();u.useEffect(()=>{if(!x)return;const T=x.addListener(S=>{try{S?.type==="help-message"&&h&&(String(S.requestId),String(h.id)),S?.type==="help-request-updated"&&h&&S.request?.id===h.id&&m(S.request)}catch{}});return()=>T()},[x,h]);const p=T=>{try{window.dispatchEvent(new CustomEvent("ndn:change-tab",{detail:{tab:T}})),n(!1)}catch(S){console.error("Navigation failed:",S)}},g=T=>{const S=T.toLowerCase();return S.includes("username")||S.includes("change name")?{text:"You can change your username once for free.",links:[{text:"Go to Settings > Account",tab:"settings"}]}:S.includes("premium")||S.includes("upgrade")||S.includes("subscription")?{text:"Premium unlocks all game modes and features.",links:[{text:"Go to Online Play",tab:"online"}]}:S.includes("calibrat")||S.includes("camera")||S.includes("vision")?{text:"Set up your camera properly in Settings.",links:[{text:"Go to Settings > Camera & Vision",tab:"settings"}]}:S.includes("voice")||S.includes("caller")||S.includes("audio")?{text:"Enable voice calling in Settings.",links:[{text:"Go to Settings > Audio & Voice",tab:"settings"}]}:S.includes("friend")||S.includes("play together")?{text:"Add friends to play together.",links:[{text:"Go to Friends",tab:"friends"}]}:S.includes("stat")||S.includes("score")||S.includes("performance")?{text:"View your statistics and performance.",links:[{text:"Go to Stats",tab:"stats"}]}:S.includes("setting")||S.includes("customiz")||S.includes("configur")?{text:"Customize your experience.",links:[{text:"Go to Settings",tab:"settings"}]}:S.includes("tournament")||S.includes("competition")?{text:"Check out tournaments and competitions.",links:[{text:"Go to Tournaments",tab:"tournaments"}]}:S.includes("score")||S.includes("scoring")||S.includes("autoscore")?{text:"Auto-scoring assigns darts to board segments automatically. You can review and adjust placements in the Match Summary screen.",links:[{text:"Go to Match Summary",tab:"matchsummary"}]}:S.includes("pair")||S.includes("pairing")||S.includes("phone")||S.includes("camera pairing")?{text:"Use the Pairing flow to connect phones and cameras. Make sure devices are on the same Wiâ€‘Fi and scan the QR code shown.",links:[{text:"Open Pairing",tab:"pairing"}]}:S.includes("highlight")||S.includes("download")||S.includes("save")?{text:"Highlights can be downloaded or saved to your account from the Highlights section. We keep a record when you hit milestone checkouts or visits.",links:[{text:"Open Highlights",tab:"highlights"}]}:S.includes("privacy")||S.includes("copyright")||S.includes("legal")?{text:"Our Legal Notice and Privacy information are available in the footer. You can view privacy, copyright, and contact details there.",links:[{text:"View Legal Notice",tab:"footer"}]}:S.includes("help")||S.includes("support")||S.includes("faq")?{text:"You're already in the help section! Check Settings for more resources.",links:[{text:"Go to Settings > Support",tab:"settings"}]}:S.includes("how to play")||S.includes("game")||S.includes("start")?{text:"To play darts, select a game mode from the menu. For online play, join a match. For offline, start a local game.",links:[{text:"Play Online",tab:"online"},{text:"Play Offline",tab:"offline"}]}:{text:"I'm not sure about that. Try asking about playing, calibration, premium, username changes, voice settings, friends, stats, or settings."}},w=()=>{if(!a.trim())return;const T=a.trim(),S=T.toLowerCase();if(i(I=>[...I,{text:T,isUser:!0}]),r(""),l)if(S.startsWith("y")){i(I=>[...I,{text:"Okay â€” I will notify an admin. Please wait for them to join the chat.",isUser:!1}]),o(!1),(async()=>{try{const P=await(await Pt("/api/help/requests",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:d||T})})).json().catch(()=>null);P&&P.request?(m(P.request),i(A=>[...A,{text:"Okay â€” I will notify an admin. Please wait for them to join the chat.",isUser:!1}])):i(A=>[...A,{text:"Okay â€” I will notify an admin. Please wait for them to join the chat.",isUser:!1}])}catch{i(M=>[...M,{text:"Failed to contact admins. Please try again later.",isUser:!1}])}})();return}else{i(I=>[...I,{text:"Okay â€” I won't notify an admin. If you change your mind, just ask.",isUser:!1}]),o(!1);return}const E=g(S);if(typeof E.text=="string"&&E.text.includes("I'm not sure about that")){c(T),o(!0),setTimeout(()=>{i(I=>[...I,{text:{text:"I can connect you to a member of our admin team â€” would you like that? Type YES or NO.",links:[]},isUser:!1}])},350);return}setTimeout(()=>{i(I=>[...I,{text:E,isUser:!1}])},500)};return e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>n(!0),className:"fixed bottom-4 right-4 z-50 bg-blue-600 hover:bg-blue-700 text-white p-4 rounded-full shadow-lg transition-colors",title:"Help Assistant",children:e.jsx(nl,{className:"w-6 h-6"})}),s&&e.jsxs("div",{className:"fixed inset-0 z-50 flex items-end justify-end p-4",children:[e.jsx("div",{className:"absolute inset-0 bg-black/50",onClick:()=>n(!1)}),e.jsxs("div",{className:"relative bg-slate-800 rounded-lg shadow-xl w-full max-w-md h-96 flex flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 border-b border-slate-700",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(_n,{className:"w-5 h-5 text-blue-400"}),e.jsx("span",{className:"font-semibold",children:"Help Assistant"})]}),e.jsx("button",{onClick:()=>n(!1),className:"text-slate-400 hover:text-white",children:e.jsx(tl,{className:"w-5 h-5"})})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-4 space-y-3",children:t.map((T,S)=>e.jsx("div",{className:`flex ${T.isUser?"justify-end":"justify-start"}`,children:e.jsx("div",{className:`max-w-xs px-3 py-2 rounded-lg ${T.isUser?"bg-blue-600 text-white":"bg-slate-700 text-slate-200"}`,children:typeof T.text=="string"?T.text:e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{children:T.text.text}),T.text.links&&e.jsx("div",{className:"space-y-1",children:T.text.links.map((E,I)=>e.jsx("button",{onClick:()=>p(E.tab),className:"block w-full text-left text-blue-300 hover:text-blue-200 underline text-sm",children:E.text},I))})]})})},S))}),e.jsx("div",{className:"p-4 border-t border-slate-700",children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{type:"text",value:a,onChange:T=>r(T.target.value),onKeyPress:T=>T.key==="Enter"&&w(),placeholder:"Ask me anything...",className:"flex-1 input"}),e.jsx("button",{onClick:w,className:"btn bg-blue-600 hover:bg-blue-700",children:e.jsx(fi,{className:"w-4 h-4"})})]})})]})]}),h&&e.jsx(ec,{request:h,user:{email:null,username:null,isAdmin:!1},onClose:()=>m(null)})]})}function dm(){const s=Gn(),n=u.useRef({}),t=u.useRef({});return u.useEffect(()=>{function i(c="[GlobalCamera]"){try{const h=s.getVideoElementRef(),m=s.getMediaStream(),x=s.getPcRef&&s.getPcRef(),p=s.getWsRef&&s.getWsRef();console.log(c,{isStreaming:s.isStreaming,mode:s.mode,showOverlay:s.showOverlay,hasVideoElement:!!h,video:h?{videoWidth:h.videoWidth,videoHeight:h.videoHeight,srcObject:!!h.srcObject}:null,mediaTracks:m?m.getTracks().map(g=>({kind:g.kind,enabled:g.enabled,id:g.id})):null,pcState:x?x.connectionState||x.iceConnectionState:null,wsState:p?p.readyState||"unknown":null})}catch(h){console.warn("[GlobalCamera] dumpState failed",h)}}i("[GlobalCamera] INIT");let a=!0;const r=setInterval(()=>{if(a)try{const c=s.getVideoElementRef(),h=s.getMediaStream(),m=s.getPcRef&&s.getPcRef(),x={isStreaming:s.isStreaming,mode:s.mode,hasVideo:!!c,videoW:c?c.videoWidth:0,videoH:c?c.videoHeight:0,tracks:h?h.getTracks().length:0,pcState:m?m.connectionState||m.iceConnectionState:null},p=n.current;(x.isStreaming!==p.isStreaming||x.hasVideo!==p.hasVideo||x.videoW!==p.videoW||x.videoH!==p.videoH||x.tracks!==p.tracks||x.pcState!==p.pcState||s.showOverlay!==p.showOverlay)&&(n.current=x,i("[GlobalCamera] CHANGE"))}catch(c){console.warn("[GlobalCamera] poll failed",c)}},750);function l(c){try{const h=t.current.video;if(h&&h.el===c)return;if(h&&h.el){try{h.el.removeEventListener("loadedmetadata",h.loadedmetadata)}catch{}try{h.el.removeEventListener("playing",h.playing)}catch{}try{h.el.removeEventListener("pause",h.pause)}catch{}try{h.el.removeEventListener("ended",h.ended)}catch{}}if(t.current.video=null,c){const m=()=>console.log("[GlobalCamera] video loadedmetadata",{videoWidth:c.videoWidth,videoHeight:c.videoHeight}),x=()=>{console.log("[GlobalCamera] video playing",{paused:c.paused});try{s.setStreaming(!0)}catch{}},p=()=>{console.log("[GlobalCamera] video pause");try{s.setStreaming(!1)}catch{}},g=()=>{console.log("[GlobalCamera] video ended");try{s.setStreaming(!1)}catch{}};c.addEventListener("loadedmetadata",m),c.addEventListener("playing",x),c.addEventListener("pause",p),c.addEventListener("ended",g),t.current.video={el:c,loadedmetadata:m,playing:x,pause:p,ended:g}}}catch(h){console.warn("[GlobalCamera] attachVideoListeners failed",h)}}function o(c){try{const h=t.current.pc;if(h&&h.pc===c)return;if(h&&h.pc)try{h.pc.removeEventListener("connectionstatechange",h.connChange)}catch{}if(t.current.pc=null,c){const m=()=>console.log("[GlobalCamera] pc state change",{connectionState:c.connectionState,iceState:c.iceConnectionState});c.addEventListener("connectionstatechange",m),t.current.pc={pc:c,connChange:m}}}catch(h){console.warn("[GlobalCamera] attachPc failed",h)}}const d=setInterval(()=>{try{l(s.getVideoElementRef()),o(s.getPcRef&&s.getPcRef())}catch{}},1e3);return()=>{a=!1,clearInterval(r),clearInterval(d);try{const c=t.current.video;c&&c.el&&(c.el.removeEventListener("loadedmetadata",c.loadedmetadata),c.el.removeEventListener("playing",c.playing))}catch{}try{const c=t.current.pc;c&&c.pc&&c.pc.removeEventListener("connectionstatechange",c.connChange)}catch{}}},[s]),null}function um(){const s=Gn(),n=u.useRef(null),t=u.useRef(null),i=u.useRef(0),a=u.useRef(0),r=u.useRef(0),l=u.useRef(0);return u.useEffect(()=>{n.current&&s.setVideoElementRef(n.current)},[s]),u.useEffect(()=>{let o=!0;const d=async()=>{if(o)try{const h=s.getMediaStream(),m=n.current;if(!m||!h)return;(t.current!==h||m.srcObject!==h)&&(m.srcObject=h,t.current=h),m.muted=!0,m.playsInline=!0;try{await m.play()}catch{}}catch{}};d();const c=setInterval(d,750);return()=>{o=!1,clearInterval(c)}},[s]),u.useEffect(()=>{const d=setInterval(()=>{const c=n.current,h=Date.now();if(!c||!s.isStreaming||s.mode!=="phone"||!c.srcObject){a.current=0;return}const m=c.currentTime||0;if(Number.isFinite(m))if(m===i.current?a.current+=1:a.current=0,i.current=m,a.current>=3){const x=[3e3,6e3,1e4][Math.min(l.current,2)];if(h-r.current>=x){r.current=h,l.current=Math.min(l.current+1,3);try{window.dispatchEvent(new CustomEvent("ndn:phone-camera-reconnect",{detail:{reason:"stall",ts:h}})),c.play().catch(()=>{})}catch{}}}else a.current===0&&(l.current=0)},1e3);return()=>clearInterval(d)},[s]),e.jsx("video",{ref:n,style:{position:"fixed",width:1,height:1,left:-9999,top:-9999,opacity:0},muted:!0,playsInline:!0,"aria-hidden":!0})}function mm(){const[s,n]=u.useState(!1),t=new Date().getFullYear();return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"w-full text-center text-xs text-gray-500 py-2 select-none",children:["Â© ",t," Nine Dart Nation â€” ",e.jsx("button",{className:"underline",onClick:()=>n(!0),children:"Legal Notice"})]}),s?e.jsx(zs,{storageKey:"ndn:modal:legal",className:"w-[640px]",defaultWidth:640,defaultHeight:420,minWidth:420,minHeight:220,initialFitHeight:!0,children:e.jsxs("div",{className:"p-4 space-y-3",children:[e.jsx("div",{className:"text-lg font-semibold",children:"Privacy & Copyright Notice"}),e.jsx("div",{className:"text-sm",children:"âš ï¸ IMPORTANT LEGAL NOTICE"}),e.jsx("div",{className:"text-sm",children:"Copyright Protection: All code, assets, and intellectual property in Nine Dart Nation are protected by copyright law. Unauthorized copying, modification, or distribution of this software is strictly prohibited."}),e.jsx("div",{className:"text-sm",children:"Legal Consequences: Any attempt to edit, reverse-engineer, or redistribute this code will result in immediate legal action, including but not limited to copyright infringement lawsuits and potential criminal charges."}),e.jsx("div",{className:"text-sm",children:"Privacy: Your personal data and gameplay information are protected. Any unauthorized access or data collection violates privacy laws and will be prosecuted to the full extent of the law."}),e.jsx("div",{className:"flex items-center gap-2 mt-3",children:e.jsx("button",{className:"btn",onClick:()=>n(!1),children:"Close"})})]})}):null]})}function hm(){const s=u.useRef(null),[n,t]=u.useState(""),[i,a]=u.useState(!1),[r,l]=u.useState(null),o=(()=>{try{return xa()}catch{return null}})(),[d,c]=u.useState("score"),[h,m]=u.useState(!1),[x,p]=u.useState(!1),[g,w]=u.useState(null),[T,S]=u.useState(0),{avgMode:E}=Ft(),{H:I,locked:M,errorPx:P}=Ka();u.useEffect(()=>{const b=localStorage.getItem("authToken");b&&fetch("http://localhost:8787/api/auth/me",{headers:{Authorization:`Bearer ${b}`}}).then(W=>W.json()).then(W=>{W?.user?(w(W.user),A(W.user)):localStorage.removeItem("authToken")}).catch(()=>{})},[]),u.useEffect(()=>{const b=()=>{try{localStorage.removeItem("mockUser"),localStorage.removeItem("authToken")}catch{}w(null),c("score")};return window.addEventListener("ndn:logout",b),()=>window.removeEventListener("ndn:logout",b)},[]),u.useEffect(()=>{if(!g?.username)return;const b=()=>S(E==="24h"?id(g.username):wn(g.username));b();const H=()=>b();return window.addEventListener("ndn:stats-updated",H),()=>window.removeEventListener("ndn:stats-updated",H)},[g?.username,E]),u.useEffect(()=>{if(!g?.username){t("");return}const b=localStorage.getItem(`ndn:bio:profilePhoto:${g.username}`);t(b||"")},[g?.username]),u.useEffect(()=>{const b=F=>{F.key?.startsWith("ndn:bio:profilePhoto:")&&g?.username&&F.key.endsWith(g.username)&&t(F.newValue||"")},H=F=>{if(F.detail?.username===g?.username&&t(F.detail?.avatar||""),g?.username){const D=localStorage.getItem(`ndn:bio:profilePhoto:${g.username}`);t(D||"")}},W=()=>{if(!document.hidden&&g?.username){const F=localStorage.getItem(`ndn:bio:profilePhoto:${g.username}`);t(F||"")}},R=setInterval(()=>{if(g?.username){const F=localStorage.getItem(`ndn:bio:profilePhoto:${g.username}`);F&&F!==n&&t(F)}},2e3);return window.addEventListener("storage",b),window.addEventListener("ndn:avatar-updated",H),document.addEventListener("visibilitychange",W),()=>{window.removeEventListener("storage",b),window.removeEventListener("ndn:avatar-updated",H),document.removeEventListener("visibilitychange",W),clearInterval(R)}},[g?.username,n]),u.useEffect(()=>{const b=new URLSearchParams(window.location.search),H=b.get("paid"),W=b.get("username-change");if(H==="1"||H==="username-change"||W==="free"){const R=localStorage.getItem("pendingUsernameChange");R&&g?.email&&fetch("http://localhost:8787/api/change-username",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:g.email,newUsername:R})}).then(D=>D.json()).then(D=>{D.ok?(alert("Username changed successfully!"),localStorage.removeItem("pendingUsernameChange"),D.token&&localStorage.setItem("authToken",D.token),D.user&&w(D.user),window.history.replaceState({},document.title,window.location.pathname)):alert("Failed to change username: "+(D.error||"Unknown error"))}).catch(()=>{alert("Network error while changing username")})}},[g?.email]),u.useEffect(()=>{new URLSearchParams(window.location.search).get("subscription")==="success"&&g?.email&&fetch("http://localhost:8787/api/auth/me",{headers:{Authorization:`Bearer ${localStorage.getItem("authToken")}`}}).then(R=>R.json()).then(R=>{R?.user&&(w(R.user),alert("Premium subscription activated successfully!"),window.history.replaceState({},document.title,window.location.pathname))}).catch(()=>{alert("Subscription activated, but failed to refresh user data. Please refresh the page.")})},[g?.email]),u.useEffect(()=>{const b=()=>{const R=window.innerWidth,F=window.matchMedia("(max-width: 768px)").matches,D=window.matchMedia("(max-width: 1024px) and (min-width: 769px)").matches,Q=/Mobi|Android|iPhone|iPad|iPod|Mobile|BlackBerry|IEMobile|Opera Mini|Windows Phone/i.test(navigator.userAgent||""),me=/iPad|Android(?=.*\bMobile\b)|Tablet|PlayBook|Silk/i.test(navigator.userAgent||""),ue="ontouchstart"in window||navigator.maxTouchPoints>0,ke=R<769,_e=D&&ue||me||R>=769&&R<=1024&&ue,Le=F||Q||ke||R<769&&ue||_e;m(Le)};b(),window.addEventListener("resize",b),window.addEventListener("orientationchange",b);const H=window.matchMedia("(max-width: 768px)"),W=window.matchMedia("(max-width: 1024px) and (min-width: 769px)");try{H.addEventListener("change",b),W.addEventListener("change",b)}catch{}return()=>{window.removeEventListener("resize",b),window.removeEventListener("orientationchange",b);try{H.removeEventListener("change",b),W.removeEventListener("change",b)}catch{}}},[]),u.useEffect(()=>{const b=()=>{try{localStorage.removeItem("ndn:avatar")}catch{}w(null),c("score")};return window.addEventListener("ndn:logout",b),()=>window.removeEventListener("ndn:logout",b)},[]),u.useEffect(()=>{const b=H=>{try{const W=String(H?.detail?.username||"").trim();if(!W)return;w(R=>R&&{...R,username:W});try{const R=(g?.email||"").toLowerCase();o&&W&&R&&o.send({type:"presence",username:W,email:R})}catch{}}catch{}};return window.addEventListener("ndn:username-changed",b),()=>window.removeEventListener("ndn:username-changed",b)},[o,g?.email]),u.useEffect(()=>{const b=H=>{try{const W=String(H?.detail?.tab||"").trim();W&&["score","offline","online","stats","settings","admin","tournaments","friends"].includes(W)&&c(W)}catch{}};return window.addEventListener("ndn:change-tab",b),()=>window.removeEventListener("ndn:change-tab",b)},[]);async function A(b){try{const H=b?.email?`?email=${encodeURIComponent(b.email)}`:"",W=await fetch("/api/subscription"+H);if(!W.ok)return;const R=await W.json();w({...b,fullAccess:!!R?.fullAccess})}catch{}}if(!g)return e.jsx(Ku,{onAuth:b=>{w(b),A(b)}});const v=`https://ui-avatars.com/api/?name=${encodeURIComponent(g.username||"NDN")}&background=8F43EE&color=fff&bold=true&rounded=true&size=64`;return e.jsxs(Xu,{children:[e.jsxs("div",{ref:s,className:`${g?.fullAccess?"premium-body":""} h-screen overflow-hidden pt-1 pb-0 px-1 xs:pt-2 xs:pb-0 xs:px-2 sm:pt-3 sm:pb-0 sm:px-3 md:pt-4 md:pb-0 md:px-4`,children:[e.jsx(Fu,{}),e.jsxs("div",{className:"max-w-[1400px] mx-auto grid grid-cols-1 lg:grid-cols-[auto,1fr] gap-2 xs:gap-3 sm:gap-4 h-full overflow-hidden",children:[!h&&e.jsx("div",{className:"relative hidden lg:block",style:{width:240},children:e.jsx(hl,{active:d,onChange:b=>{c(b)},user:g})}),e.jsxs("div",{className:"flex flex-col h-full overflow-hidden",children:[e.jsx("div",{className:"pt-1 xs:pt-2",children:e.jsxs("header",{id:"ndn-header",className:"header glass flex-col xs:flex-col sm:flex-row gap-2 xs:gap-2 sm:gap-3",children:[e.jsx("div",{className:"flex items-center gap-2 order-1",children:e.jsx("h1",{className:"text-lg xs:text-xl sm:text-xl md:text-2xl font-bold text-brand-700 whitespace-nowrap cursor-pointer select-none",onClick:()=>{c("score")},title:"Go Home",children:"NINE-DART-NATION ðŸŽ¯"})}),e.jsxs("div",{className:"order-3 xs:order-3 sm:order-2 w-full sm:w-auto flex-1 flex flex-col items-center justify-center text-center sm:text-left !text-black",children:[e.jsxs("span",{className:"text-sm xs:text-base sm:text-base md:text-lg font-semibold flex items-center gap-2 max-w-full truncate !text-black",style:{color:"#000000",WebkitTextFillColor:"#000000"},children:[e.jsx("span",{className:"hidden xs:inline !text-black",children:"Welcome"}),e.jsx("img",{src:n||v,alt:"avatar",className:"w-5 h-5 xs:w-6 xs:h-6 sm:w-6 sm:h-6 md:w-7 md:h-7 rounded-full ring-2 ring-white/20"}),e.jsxs("span",{className:"truncate !text-black",style:{color:"#000000",WebkitTextFillColor:"#000000"},children:[g.username,"ðŸŽ¯"]})]}),e.jsxs("span",{className:"hidden xs:inline text-xs xs:text-xs sm:text-xs md:text-sm !text-black",style:{color:"#000000",WebkitTextFillColor:"#000000"},children:["All-time 3-dart avg: ",e.jsx("span",{className:"font-semibold !text-black",style:{color:"#000000",WebkitTextFillColor:"#000000"},children:T.toFixed(2)})]}),h&&e.jsx("button",{className:"btn px-3 py-1 xs:px-3 xs:py-1 sm:px-3 sm:py-1 mt-1 text-sm xs:text-sm","aria-label":"Open navigation",onClick:()=>p(!0),children:"â˜° Menu"})]}),M&&I&&e.jsxs("button",{onClick:()=>c("calibrate"),className:"order-4 sm:order-4 md:order-3 px-3 py-1 text-xs sm:text-sm rounded-full bg-emerald-500/20 hover:bg-emerald-500/30 text-emerald-100 border border-emerald-400/50 transition-colors",title:"Click to adjust calibration",children:["âœ“ Calibration Active ",P!=null&&`â€¢ ${P.toFixed(1)}px`]}),e.jsxs("div",{className:"order-2 md:order-3 ml-0 md:ml-auto flex items-center gap-2 flex-wrap",children:[e.jsx("button",{className:"px-3 py-1 text-sm rounded-full bg-white/5 hover:bg-white/10 border border-white/10",onClick:()=>{const b=s.current;b&&(document.fullscreenElement?document.exitFullscreen().catch(()=>{}):b.requestFullscreen().catch(()=>{}))},title:i?"Exit Full Screen":"Enter Full Screen",children:i?"Exit Full Screen":"Full Screen"}),d==="online"&&e.jsx("button",{className:"text-[10px] md:text-xs px-3 py-1 rounded-full bg-indigo-500/25 text-indigo-100 border border-indigo-400/40 hover:bg-indigo-500/40",title:"Open a simulated online match",onClick:()=>{setTimeout(()=>{try{window.dispatchEvent(new CustomEvent("ndn:online-match-demo",{detail:{game:"X01",start:501}}))}catch{}},40)},children:"ONLINE DEMO"}),e.jsx(Zl,{}),o?e.jsx("span",{className:"ml-0 md:ml-2",children:e.jsx(Ql,{status:o.status})}):null]})]})}),h&&e.jsx(fm,{open:x,onClose:()=>p(!1),active:d,onChange:b=>{c(b),p(!1)},user:g}),e.jsxs("main",{id:"ndn-main-scroll",className:"space-y-4 flex-1 overflow-y-auto pr-1 flex flex-col",children:[d==="settings"&&e.jsx(en,{className:"flex-1 min-h-0",children:e.jsx(Gu,{user:g})}),d==="score"&&e.jsx(en,{className:"flex-1 min-h-0",children:e.jsx(cd,{user:g})}),d==="online"&&e.jsx(en,{className:"flex-1 min-h-0",children:e.jsx(sm,{user:g})}),d==="offline"&&e.jsx(en,{className:"flex-1 min-h-0",children:e.jsx(Lu,{user:g})}),e.jsx("div",{className:d==="calibrate"?"":"hidden",children:e.jsx(en,{children:e.jsx(mu,{})})}),d==="friends"&&e.jsx(en,{className:"flex-1 min-h-0",children:e.jsx(_u,{user:g})}),d==="stats"&&e.jsx(en,{className:"flex-1 min-h-0",children:e.jsx(am,{user:g})}),d==="tournaments"&&e.jsx(en,{className:"flex-1 min-h-0",children:e.jsx(rm,{user:g})}),d==="admin"&&e.jsx(en,{className:"flex-1 min-h-0",children:e.jsxs("div",{className:"flex-1 min-h-0 space-y-6",children:[e.jsx(qu,{user:g}),e.jsx(lm,{user:g})]})}),d==="fullaccess"&&e.jsx(en,{className:"flex-1 min-h-0",children:e.jsx(im,{user:g})})]})]})]})]}),e.jsx(cm,{}),e.jsx(mm,{}),e.jsx(dm,{}),e.jsx(um,{})]})}function fm({open:s,onClose:n,active:t,onChange:i,user:a}){return e.jsx(om,{open:s,onClose:n,width:320,side:"left",title:"Navigate",children:e.jsx("div",{className:"mt-2",children:e.jsx(hl,{active:t,onChange:i,user:a,className:"flex relative static max-h-[80vh] w-full"})})})}function xm(s){return s.length>=10&&/\d/.test(s)&&/[^A-Za-z0-9]/.test(s)}function pm(){const[s,n]=u.useState(""),[t,i]=u.useState(""),[a,r]=u.useState(""),[l,o]=u.useState(""),[d,c]=u.useState("");u.useEffect(()=>{try{const x=new URLSearchParams(window.location.search).get("token")||"";n(x)}catch{}},[]);async function h(m){if(m.preventDefault(),o(""),c(""),!s){o("Missing or invalid reset token.");return}if(!t||t!==a){o("Passwords do not match.");return}if(!xm(t)){o("Password must be at least 10 chars and include a number and symbol.");return}try{const p=await(await fetch("/api/auth/confirm-reset",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({token:s,newPassword:t})})).json();if(!p?.ok)throw new Error(p?.error||"Reset failed");c("Password changed. You can now sign in.")}catch(x){o(x?.message||"Reset failed")}}return e.jsxs("div",{className:"min-h-screen flex items-center justify-center relative overflow-hidden",children:[e.jsx("div",{className:"background-animated"}),e.jsx("div",{className:"relative z-10 w-full max-w-lg mx-auto p-4",children:e.jsxs("form",{className:"card w-full space-y-4",onSubmit:h,children:[e.jsx("div",{className:"flex flex-col items-center justify-center gap-2 mb-2 text-center",children:e.jsx("h1",{className:"logo text-center",children:"Reset your password"})}),!s&&e.jsx("div",{className:"text-red-400",children:"This reset link is missing a token. Please use the link from your email."}),e.jsx("input",{className:"input w-full",type:"password",placeholder:"New password",value:t,onChange:m=>i(m.target.value),required:!0}),e.jsx("input",{className:"input w-full",type:"password",placeholder:"Confirm password",value:a,onChange:m=>r(m.target.value),required:!0}),l&&e.jsx("div",{className:"text-red-400 font-semibold text-sm",children:l}),d&&e.jsx("div",{className:"text-emerald-400 font-semibold text-sm",children:d}),e.jsx("button",{className:"btn w-full",type:"submit",disabled:!s,children:"Change Password"}),e.jsx("a",{className:"underline text-sm text-center",href:"/",children:"Back to sign in"})]})})]})}class bm extends u.Component{constructor(n){super(n),this.state={hasError:!1}}static getDerivedStateFromError(n){return{hasError:!0,message:String(n?.message||n)}}componentDidCatch(n,t){console.error("[ErrorBoundary]",n,t)}render(){return this.state.hasError?e.jsx("div",{className:"min-h-screen flex items-center justify-center p-6",children:e.jsxs("div",{className:"card max-w-lg w-full text-center",children:[e.jsx("h2",{className:"text-2xl font-bold mb-2",children:"Something went wrong"}),e.jsx("p",{className:"opacity-80 mb-4",children:"Please refresh the page. If this persists, let us know."}),this.state.message&&e.jsx("pre",{className:"text-xs bg-black/40 rounded p-2 overflow-auto text-left",children:this.state.message}),e.jsx("button",{className:"btn mt-4",onClick:()=>window.location.reload(),children:"Reload"})]})}):this.props.children}}try{window.React=window.React||{}}catch{}_c();Mc.createRoot(document.getElementById("root")).render(e.jsx(u.StrictMode,{children:e.jsx(bm,{children:e.jsx(Wu,{children:e.jsx(gm,{})})})}));function gm(){return window.location.pathname==="/reset"?e.jsx(pm,{}):e.jsx(hm,{})}
//# sourceMappingURL=index-h8TfJKNC.js.map
