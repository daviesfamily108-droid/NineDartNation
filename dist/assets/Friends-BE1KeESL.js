import{z as X,e as Y,j as s}from"./index-D4VcQ7ed.js";import{r as i}from"./ui-DygUIHRq.js";import"./vendor-D3F3s8fL.js";const L="ndn:messages:inbox",U="ndn:messages:unread",P="ndn:messages:threads";function V(){try{const l=localStorage.getItem(L),d=l?JSON.parse(l):[],t=Number(localStorage.getItem(U)||"0")||0,a=localStorage.getItem(P),r=a?JSON.parse(a):{};return{inbox:Array.isArray(d)?d.filter(x=>x&&typeof x.id=="string").slice(0,200):[],unread:t,threads:r&&typeof r=="object"?r:{}}}catch{return{inbox:[],unread:0,threads:{}}}}function y(l,d,t){try{localStorage.setItem(L,JSON.stringify(l))}catch{}try{localStorage.setItem(U,String(d))}catch{}if(t)try{localStorage.setItem(P,JSON.stringify(t))}catch{}}const W=V(),Z=X((l,d)=>({inbox:W.inbox,unread:W.unread,threads:W.threads,inGame:!1,setInGame:t=>l({inGame:t}),add:t=>l(a=>{const r=a.inbox.some(x=>x.id===t.id&&x.ts===t.ts),c=r?a.inbox:[t,...a.inbox].slice(0,200),u=a.unread+(r?0:1);return y(c,u,a.threads),{inbox:c,unread:u}}),load:t=>l(a=>{const r=[...t].sort((c,u)=>u.ts-c.ts).slice(0,200);return y(r,a.unread,a.threads),{inbox:r,unread:a.unread}}),loadThread:(t,a)=>l(r=>{const c=String(t||"").toLowerCase();if(!c)return r;const u=[...a].sort((p,j)=>p.ts-j.ts).slice(-400),x={...r.threads,[c]:{other:c,messages:u}};return y(r.inbox,r.unread,x),{threads:x}}),markAllRead:()=>{const t=d();y(t.inbox,0,t.threads),l({unread:0})},pushThread:(t,a)=>l(r=>{const c=String(t||"").toLowerCase();if(!c)return r;const x=[...r.threads[c]?.messages||[],a].sort((j,N)=>j.ts-N.ts).slice(-400),p={...r.threads,[c]:{other:c,messages:x}};return y(r.inbox,r.unread,p),{threads:p}}),remove:t=>l(a=>{const r=a.inbox.filter(u=>u.id!==t),c=a.unread;return y(r,c,a.threads),{inbox:r,unread:c}})})),ee=[/\b(f+[\W_]*u+[\W_]*c+[\W_]*k+)\b/gi,/\b(s+[\W_]*h+[\W_]*i+[\W_]*t+)\b/gi,/\b(b+[\W_]*i+[\W_]*t+[\W_]*c+[\W_]*h+)\b/gi,/\b(a+[\W_]*s+[\W_]*s+[\W_]*h+[\W_]*o+[\W_]*l+[\W_]*e+)\b/gi,/\b(d+[\W_]*a+[\W_]*m+[\W_]*n+)\b/gi,/\b(c+[\W_]*r+[\W_]*a+[\W_]*p+)\b/gi,/\b(p+[\W_]*i+[\W_]*s+[\W_]*s+)\b/gi];function se(l){return l.replace(/[\p{L}\p{N}]/gu,"*")}function te(l){if(!l)return l;let d=l;for(const t of ee)d=d.replace(t,a=>se(a));return d}function oe({user:l}){const d=Y(),t=String(l?.email||"").toLowerCase(),[a,r]=i.useState([]),[c,u]=i.useState([]),[x,p]=i.useState([]),[j,N]=i.useState(""),[v,ne]=i.useState("all"),[b,R]=i.useState(!1),h=Z(),[o,D]=i.useState(null),[E,M]=i.useState(""),O=i.useRef(null),[S,J]=i.useState([]),[C,z]=i.useState([]),[k,I]=i.useState({show:!1}),$=i.useCallback(async e=>{const n=String(e||"").toLowerCase();if(!(!t||!n||n===t))try{const g=await(await fetch(`/api/friends/thread?email=${encodeURIComponent(t)}&other=${encodeURIComponent(n)}`)).json();g?.ok&&Array.isArray(g.thread)&&h.loadThread(n,g.thread)}catch{}},[t,h]),T=i.useMemo(()=>{if(!o?.email)return[];const e=o.email.toLowerCase(),n=h.threads?.[e]?.messages;return Array.isArray(n)&&n.length?n:h.inbox.filter(m=>String(m.from||"").toLowerCase()===e).slice().sort((m,g)=>m.ts-g.ts)},[o?.email,h.inbox,h.threads]);i.useMemo(()=>{const e=new Map;for(const n of h.inbox){const m=String(n.from||"").toLowerCase(),g=e.get(m);(!g||n.ts>g.ts)&&e.set(m,{ts:n.ts,message:n.message})}return e},[h.inbox]),i.useMemo(()=>{const e=new Map,n=1e3*60*60*24*3,m=Date.now()-n;for(const g of h.inbox){if((g.ts||0)<m)continue;const f=String(g.from||"").toLowerCase();e.set(f,(e.get(f)||0)+1)}return e},[h.inbox]);async function w(){if(t)try{const[e,n,m,g]=await Promise.all([fetch(`/api/friends/list?email=${encodeURIComponent(t)}`).then(f=>f.json()),fetch(`/api/friends/suggested?email=${encodeURIComponent(t)}`).then(f=>f.json()),fetch(`/api/friends/requests?email=${encodeURIComponent(t)}`).then(f=>f.json()),fetch(`/api/friends/outgoing?email=${encodeURIComponent(t)}`).then(f=>f.json())]);r(e.friends||[]),u(n.suggestions||[]),J(m.requests||[]),z(g.requests||[])}catch{}}i.useEffect(()=>{w()},[t]),i.useEffect(()=>{t&&fetch(`/api/friends/messages?email=${encodeURIComponent(t)}`).then(e=>e.json()).then(e=>{e?.ok&&Array.isArray(e.messages)&&h.load(e.messages)}).catch(()=>{})},[t]),i.useEffect(()=>{o?.email&&$(o.email)},[o?.email,$]),i.useEffect(()=>{if(!o)return;const e=O.current;e&&(e.scrollTop=e.scrollHeight)},[o?.email,T.length]);async function B(e){if(N(e),!e){p([]);return}try{const m=await(await fetch(`/api/friends/search?q=${encodeURIComponent(e)}`)).json();p(m.results||[])}catch{}}async function q(e){if(!(!t||!e)){R(!0);try{await fetch("/api/friends/add",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:t,friend:e})}),await w(),N(""),p([]),d("Friend added",{type:"success"})}finally{R(!1)}}}async function G(e){try{await fetch("/api/friends/accept",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:t,requestId:e})}),await w(),d("Friend request accepted",{type:"success"})}catch{}}async function H(e){try{await fetch("/api/friends/decline",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:t,requestId:e})}),await w(),d("Friend request declined",{type:"info"})}catch{}}async function K(e){try{await fetch("/api/friends/cancel",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:t,requestId:e})}),await w(),d("Friend request cancelled",{type:"info"})}catch{}}async function Q(){const n=document.getElementById("message-input")?.value;if(!(!n||!k.toEmail))try{await fetch("/api/friends/message",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({fromEmail:t,toEmail:k.toEmail,message:n})}),I({show:!1}),d("Message sent",{type:"success"})}catch{}}async function A(){if(!t||!o?.email)return;const e=E.trim();if(e)try{await fetch("/api/friends/message",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({fromEmail:t,toEmail:o.email,message:e})});const n=Date.now(),m=`${n}-${Math.random().toString(36).slice(2,8)}`;h.pushThread(o.email,{id:m,from:t,to:String(o.email).toLowerCase(),message:e,ts:n,readBy:[t]}),M(""),d("Message sent",{type:"success"})}catch{d("Failed to send message",{type:"error"})}}i.useMemo(()=>v==="all"?a:a.filter(e=>(e.status||"offline")===v),[a,v]);const _=i.useMemo(()=>{const e={online:0,ingame:0,offline:0};for(const n of a)n.status==="online"?e.online+=1:n.status==="ingame"?e.ingame+=1:e.offline+=1;return e},[a]),F=S.length+C.length;return s.jsxs("div",{className:"card ndn-game-shell ndn-page",children:[s.jsx("h2",{className:"text-2xl font-bold text-brand-700 mb-2 ndn-section-title",children:"Friends ðŸ‘¥"}),s.jsx("p",{className:"mb-2 text-brand-600",children:"Manage your friends. See who's online, in-game, or offline; find new teammates; and invite people to play."}),s.jsx("div",{className:"grid gap-3 mb-4 grid-cols-2 sm:grid-cols-4",children:[{label:"Online",value:_.online,accent:"bg-emerald-500/10 border-emerald-500/40"},{label:"In-Game",value:_.ingame,accent:"bg-amber-500/10 border-amber-500/40"},{label:"Offline",value:_.offline,accent:"bg-slate-500/10 border-slate-500/40"},{label:"Requests",value:F,accent:"bg-indigo-500/10 border-indigo-500/40"}].map(e=>s.jsxs("div",{className:`rounded-2xl border px-3 py-2 text-center ${e.accent}`,children:[s.jsx("div",{className:"text-xs uppercase tracking-[0.3em] text-slate-400",children:e.label}),s.jsx("div",{className:"text-2xl font-semibold text-white",children:e.value})]},e.label))}),s.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-5 gap-3 mb-4",children:[s.jsxs("div",{className:`${o?"hidden lg:block":"block"} lg:col-span-2 p-4 rounded-[28px] bg-gradient-to-br from-slate-900/80 to-indigo-900/60 border border-white/10 shadow-2xl`,children:[s.jsx("div",{className:"flex items-center justify-between mb-2",children:s.jsx("div",{className:"font-semibold text-white/90",children:"Friend Requests"})}),s.jsx("ul",{className:"space-y-3 mt-3",children:F>0?s.jsxs(s.Fragment,{children:[S.length>0&&S.map(e=>s.jsxs("li",{className:"p-3 rounded-2xl border border-white/10 bg-slate-900/40 flex flex-col gap-3",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("span",{className:"font-semibold text-lg",children:e.fromUsername||e.fromEmail||"Unknown User"}),s.jsx("span",{className:"text-xs bg-blue-600/20 text-blue-400 px-2 py-1 rounded",children:"Incoming"})]}),s.jsxs("div",{className:"flex gap-2",children:[s.jsx("button",{onClick:()=>G(e.id),className:"px-3 py-1 rounded-lg bg-emerald-500/20 text-emerald-400 text-xs font-bold hover:bg-emerald-500/30 transition-colors",children:"Accept âœ…"}),s.jsx("button",{onClick:()=>H(e.id),className:"px-3 py-1 rounded-lg bg-rose-500/20 text-rose-400 text-xs font-bold hover:bg-rose-500/30 transition-colors",children:"Decline âŒ"})]})]},`incoming-${e.id||e.fromEmail}`)),C.length>0&&C.map(e=>s.jsxs("li",{className:"p-3 rounded-2xl border border-white/10 bg-slate-900/40 flex flex-col gap-3",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("span",{className:"font-semibold text-lg",children:e.toUsername||e.toEmail||"Unknown User"}),s.jsx("div",{className:"px-3 py-1 rounded-lg bg-white/5 text-white/40 text-xs font-bold",children:"Pending â³"})]}),s.jsx("button",{onClick:()=>K(e.id),className:"px-3 py-1 rounded-lg bg-rose-500/20 text-rose-400 text-xs font-bold hover:bg-rose-500/30 transition-colors",children:"Cancel âœ–ï¸"})]},`outgoing-${e.id||e.toEmail}`))]}):s.jsx("li",{className:"text-sm opacity-70",children:"No friend requests yet."})})]}),s.jsx("div",{className:`${o?"block":"hidden lg:block"} lg:col-span-3 p-4 rounded-[28px] bg-slate-950/70 border border-white/10 shadow-2xl`,children:o?s.jsxs("div",{className:"flex flex-col h-full",children:[s.jsxs("div",{className:"flex items-center justify-between gap-2 mb-3",children:[s.jsxs("div",{className:"flex items-center gap-2 min-w-0",children:[s.jsx("button",{className:"lg:hidden px-3 py-2 rounded-xl bg-white/5 hover:bg-white/10 text-white/80 text-xs font-bold",onClick:()=>D(null),children:"â† Back"}),s.jsxs("div",{className:"min-w-0",children:[s.jsx("div",{className:"font-semibold text-white truncate",children:o.username||o.email}),s.jsx("div",{className:"text-xs text-slate-400 truncate",children:o.email})]})]}),s.jsx("div",{className:"flex items-center gap-2",children:s.jsx("button",{onClick:()=>h.markAllRead(),className:"text-xs text-indigo-400 font-bold hover:text-indigo-300 transition-colors",title:"This clears the global unread counter",children:"Mark all read âœ…"})})]}),s.jsx("div",{ref:O,className:"flex-1 min-h-[260px] max-h-[55vh] overflow-auto rounded-2xl border border-white/10 bg-black/20 p-3",children:T.length===0?s.jsx("div",{className:"text-sm text-slate-400 p-3",children:"No messages from this friend yet. Say hi ðŸ‘‹"}):s.jsx("ul",{className:"space-y-2",children:T.map(e=>{const n=String(e.from||"").toLowerCase()===t;return s.jsx("li",{className:n?"flex justify-end":"flex",children:s.jsxs("div",{className:n?"max-w-[95%] rounded-2xl bg-indigo-600/80 border border-indigo-300/20 px-3 py-2":"max-w-[95%] rounded-2xl bg-slate-900/60 border border-white/10 px-3 py-2",children:[s.jsxs("div",{className:"text-[10px] text-slate-300/80 mb-1 flex items-center justify-between gap-2",children:[s.jsx("span",{className:"font-bold",children:n?"You":o.username||o.email}),s.jsx("span",{className:"shrink-0",children:new Date(e.ts).toLocaleString()})]}),s.jsx("div",{className:"text-sm whitespace-pre-wrap break-words text-white/90",children:te(e.message)}),!n&&s.jsxs("div",{className:"mt-2 flex gap-2",children:[s.jsx("button",{onClick:()=>h.remove(e.id),className:"px-3 py-1 rounded-lg bg-rose-500/15 text-rose-300 text-[11px] font-bold hover:bg-rose-500/25 transition-colors",children:"Delete ðŸ—‘ï¸"}),s.jsx("button",{className:"px-3 py-1 rounded-lg bg-rose-500/15 text-rose-300 text-[11px] font-bold hover:bg-rose-500/25 transition-colors",onClick:async()=>{const m=prompt("Report reason (what happened)?");if(m)try{await fetch("/api/friends/report",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({reporterEmail:t,offenderEmail:e.from,reason:m,messageId:e.id})}),d("Report sent to admin",{type:"info"})}catch{}},children:"Report"})]})]})},e.id)})})}),s.jsxs("div",{className:"mt-3 rounded-2xl border border-white/10 bg-slate-900/30 p-3",children:[s.jsxs("div",{className:"flex flex-col sm:flex-row gap-2",children:[s.jsx("textarea",{className:"w-full min-h-[44px] max-h-40 bg-slate-700/60 border border-slate-600 rounded-xl px-3 py-2 text-white placeholder-slate-400 resize-y",placeholder:`Message ${o.username||"friend"}...`,value:E,onChange:e=>M(e.target.value),onKeyDown:e=>{e.key==="Enter"&&!e.shiftKey&&(e.preventDefault(),A())}}),s.jsx("button",{onClick:A,className:"px-5 py-3 rounded-xl bg-indigo-600 text-white font-bold hover:bg-indigo-500 transition-colors",children:"Send"})]}),s.jsx("div",{className:"mt-2 text-[11px] text-slate-400",children:"Tip: Press Enter to send, Shift+Enter for a new line."})]})]}):s.jsxs("div",{className:"h-full min-h-[240px] flex flex-col items-center justify-center text-center gap-2",children:[s.jsx("div",{className:"text-lg font-semibold text-white/90",children:"Messages ðŸ’¬"}),s.jsx("div",{className:"text-sm text-slate-400 max-w-sm",children:"Pick a friend to see your conversation. New messages will show up here."}),h.inbox.length>0&&s.jsx("button",{onClick:()=>h.markAllRead(),className:"mt-2 text-xs text-indigo-400 font-bold hover:text-indigo-300 transition-colors",children:"Mark all read âœ…"})]})}),s.jsxs("div",{className:"lg:col-span-2 p-4 rounded-[28px] bg-slate-950/70 border border-white/10 shadow-xl",children:[s.jsx("div",{className:"font-semibold mb-2 text-white/90",children:"Find Friends"}),s.jsx("input",{className:"input w-full mb-2",placeholder:"Search by name or email",value:j,onChange:e=>B(e.target.value)}),s.jsxs("ul",{className:"space-y-2 mb-3 max-h-48 overflow-auto",children:[x.map(e=>s.jsxs("li",{className:"flex items-center justify-between gap-2 p-3 rounded-2xl border border-white/10 bg-slate-900/40",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("span",{className:`inline-block w-2 h-2 rounded-full ${e.status==="online"?"bg-emerald-400":e.status==="ingame"?"bg-amber-400":"bg-slate-400"}`}),s.jsx("span",{children:e.username||e.email})]}),s.jsx("button",{onClick:()=>q(e.email),disabled:b,className:`px-4 py-2 rounded-xl text-white text-sm font-bold transition-colors ${b?"bg-indigo-900/40 cursor-not-allowed":"bg-indigo-600 hover:bg-indigo-500"}`,children:b?"Workingâ€¦":"Add âž•"})]},e.email)),x.length===0&&s.jsx("li",{className:"text-xs opacity-60",children:"Type to search..."})]}),s.jsx("div",{className:"font-semibold mb-1 text-white/90",children:"Suggested"}),s.jsxs("ul",{className:"space-y-2 max-h-48 overflow-auto",children:[c.map(e=>s.jsxs("li",{className:"flex items-center justify-between gap-2 p-3 rounded-2xl border border-white/10 bg-slate-900/40",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("span",{className:`inline-block w-2 h-2 rounded-full ${e.status==="online"?"bg-emerald-400":e.status==="ingame"?"bg-amber-400":"bg-slate-400"}`}),s.jsx("span",{children:e.username||e.email})]}),s.jsx("button",{onClick:()=>q(e.email),disabled:b,className:`px-4 py-2 rounded-xl text-white text-sm font-bold transition-colors ${b?"bg-indigo-900/40 cursor-not-allowed":"bg-indigo-600 hover:bg-indigo-500"}`,children:b?"Workingâ€¦":"Add âž•"})]},e.email)),c.length===0&&s.jsx("li",{className:"text-xs opacity-60",children:"No suggestions right now."})]})]})]}),k.show&&s.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50",children:s.jsxs("div",{className:"bg-slate-800 border border-slate-600 rounded-lg p-6 max-w-md w-full mx-4",children:[s.jsx("div",{className:"text-center mb-4",children:s.jsx("h3",{className:"text-lg font-semibold text-white",children:"Send Message âœ‰ï¸"})}),s.jsx("textarea",{className:"w-full h-32 bg-slate-700 border border-slate-600 rounded p-3 text-white placeholder-slate-400 resize-none",placeholder:"Type your message here...",id:"message-input",autoFocus:!0}),s.jsxs("div",{className:"flex gap-3 mt-4",children:[s.jsx("button",{onClick:Q,className:"px-6 py-2 rounded-xl bg-indigo-600 text-white font-bold hover:bg-indigo-500 transition-colors",children:"Send Message ðŸ“¤"}),s.jsx("button",{className:"btn bg-slate-600 hover:bg-slate-700",onClick:()=>I({show:!1}),children:"Cancel"})]})]})})]})}export{oe as default};
//# sourceMappingURL=Friends-BE1KeESL.js.map
