const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/Home-CDvKPAND.js","assets/ui-DygUIHRq.js","assets/vendor-D3F3s8fL.js","assets/stats-X3jz_E9o.js","assets/OnlinePlay.clean-BQQoK3el.js","assets/inPlayDemo-DOV463qQ.js","assets/OfflinePlay-BeFzG4SF.js","assets/MatchControls-DiJXZFTT.js","assets/Scoreboard-Dtydx77g.js","assets/StatsPanel-CTb8ZBr4.js","assets/Friends-YIPYeovv.js","assets/Tournaments-CZavMlRR.js","assets/AdminAccess-D2TY36xp.js","assets/OpsDashboard-zvS7Ohm7.js"])))=>i.map(i=>d[i]);
import{r as Oa,a as Qo,g as Zo}from"./vendor-D3F3s8fL.js";import{r as i,R as Nt,M as Tn,S as ss,L as vc,a as yc,U as $s,T as dr,C as as,P as wc,Z as bo,X as Pa,b as Ls,c as Ra,d as Kr,E as xa,V as Nc,e as jc,f as Sc,G as ei,g as va,h as Cc,i as kc,j as Ec,k as Tc,A as Dc,l as Ic,B as xo,m as Ac,H as Mc,n as Oc,o as Pc,p as Rc}from"./ui-DygUIHRq.js";(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))s(a);new MutationObserver(a=>{for(const o of a)if(o.type==="childList")for(const c of o.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&s(c)}).observe(document,{childList:!0,subtree:!0});function r(a){const o={};return a.integrity&&(o.integrity=a.integrity),a.referrerPolicy&&(o.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?o.credentials="include":a.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(a){if(a.ep)return;a.ep=!0;const o=r(a);fetch(a.href,o)}})();var Qs={exports:{}},Xr={};/**
 * @license React
 * react-jsx-runtime.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var vo;function Lc(){if(vo)return Xr;vo=1;var t=Oa(),n=Symbol.for("react.element"),r=Symbol.for("react.fragment"),s=Object.prototype.hasOwnProperty,a=t.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,o={key:!0,ref:!0,__self:!0,__source:!0};function c(l,b,u){var f,g={},m=null,A=null;u!==void 0&&(m=""+u),b.key!==void 0&&(m=""+b.key),b.ref!==void 0&&(A=b.ref);for(f in b)s.call(b,f)&&!o.hasOwnProperty(f)&&(g[f]=b[f]);if(l&&l.defaultProps)for(f in b=l.defaultProps,b)g[f]===void 0&&(g[f]=b[f]);return{$$typeof:n,type:l,key:m,ref:A,props:g,_owner:a.current}}return Xr.Fragment=r,Xr.jsx=c,Xr.jsxs=c,Xr}var yo;function _c(){return yo||(yo=1,Qs.exports=Lc()),Qs.exports}var e=_c(),ks={},wo;function Fc(){if(wo)return ks;wo=1;var t=Qo();return ks.createRoot=t.createRoot,ks.hydrateRoot=t.hydrateRoot,ks}var Uc=Fc();const $c=Zo(Uc),Bc="modulepreload",Vc=function(t){return"/"+t},No={},un=function(n,r,s){let a=Promise.resolve();if(r&&r.length>0){let b=function(u){return Promise.all(u.map(f=>Promise.resolve(f).then(g=>({status:"fulfilled",value:g}),g=>({status:"rejected",reason:g}))))};document.getElementsByTagName("link");const c=document.querySelector("meta[property=csp-nonce]"),l=c?.nonce||c?.getAttribute("nonce");a=b(r.map(u=>{if(u=Vc(u),u in No)return;No[u]=!0;const f=u.endsWith(".css"),g=f?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${u}"]${g}`))return;const m=document.createElement("link");if(m.rel=f?"stylesheet":Bc,f||(m.as="script"),m.crossOrigin="",m.href=u,l&&m.setAttribute("nonce",l),document.head.appendChild(m),f)return new Promise((A,k)=>{m.addEventListener("load",A),m.addEventListener("error",()=>k(new Error(`Unable to preload CSS for ${u}`)))})}))}function o(c){const l=new Event("vite:preloadError",{cancelable:!0});if(l.payload=c,window.dispatchEvent(l),!l.defaultPrevented)throw c}return a.then(c=>{for(const l of c||[])l.status==="rejected"&&o(l.reason);return n().catch(o)})};function Wc(t,n){if(t==null)return{};var r={};for(var s in t)if({}.hasOwnProperty.call(t,s)){if(n.indexOf(s)!==-1)continue;r[s]=t[s]}return r}function os(){return os=Object.assign?Object.assign.bind():function(t){for(var n=1;n<arguments.length;n++){var r=arguments[n];for(var s in r)({}).hasOwnProperty.call(r,s)&&(t[s]=r[s])}return t},os.apply(null,arguments)}var ya="data-focus-lock",ti="data-focus-lock-disabled",zc="data-no-focus-lock",Hc="data-autofocus-inside",qc="data-no-autofocus";function Zs(t,n){return typeof t=="function"?t(n):t&&(t.current=n),t}function Gc(t,n){var r=i.useState(function(){return{value:t,callback:n,facade:{get current(){return r.value},set current(s){var a=r.value;a!==s&&(r.value=s,r.callback(s,a))}}}})[0];return r.callback=n,r.facade}var Jc=typeof window<"u"?i.useLayoutEffect:i.useEffect,jo=new WeakMap;function Yc(t,n){var r=Gc(null,function(s){return t.forEach(function(a){return Zs(a,s)})});return Jc(function(){var s=jo.get(r);if(s){var a=new Set(s),o=new Set(t),c=r.current;a.forEach(function(l){o.has(l)||Zs(l,null)}),o.forEach(function(l){a.has(l)||Zs(l,c)})}jo.set(r,t)},[t]),r}var ea={width:"1px",height:"0px",padding:0,overflow:"hidden",position:"fixed",top:"1px",left:"1px"},wa=function(){return wa=Object.assign||function(n){for(var r,s=1,a=arguments.length;s<a;s++){r=arguments[s];for(var o in r)Object.prototype.hasOwnProperty.call(r,o)&&(n[o]=r[o])}return n},wa.apply(this,arguments)};function ni(t){return t}function ri(t,n){n===void 0&&(n=ni);var r=[],s=!1,a={read:function(){if(s)throw new Error("Sidecar: could not `read` from an `assigned` medium. `read` could be used only with `useMedium`.");return r.length?r[r.length-1]:t},useMedium:function(o){var c=n(o,s);return r.push(c),function(){r=r.filter(function(l){return l!==c})}},assignSyncMedium:function(o){for(s=!0;r.length;){var c=r;r=[],c.forEach(o)}r={push:function(l){return o(l)},filter:function(){return r}}},assignMedium:function(o){s=!0;var c=[];if(r.length){var l=r;r=[],l.forEach(o),c=r}var b=function(){var f=c;c=[],f.forEach(o)},u=function(){return Promise.resolve().then(b)};u(),r={push:function(f){c.push(f),u()},filter:function(f){return c=c.filter(f),r}}}};return a}function La(t,n){return n===void 0&&(n=ni),ri(t,n)}function Kc(t){t===void 0&&(t={});var n=ri(null);return n.options=wa({async:!0,ssr:!1},t),n}var si=La({},function(t){var n=t.target,r=t.currentTarget;return{target:n,currentTarget:r}}),ai=La(),Xc=La(),Qc=Kc({async:!0,ssr:typeof document<"u"}),Zc=i.createContext(void 0),el=[],_a=i.forwardRef(function(n,r){var s,a=i.useState(),o=a[0],c=a[1],l=i.useRef(),b=i.useRef(!1),u=i.useRef(null),f=i.useState({}),g=f[1],m=n.children,A=n.disabled,k=A===void 0?!1:A,S=n.noFocusGuards,x=S===void 0?!1:S,w=n.persistentFocus,C=w===void 0?!1:w,$=n.crossFrame,j=$===void 0?!0:$,T=n.autoFocus,M=T===void 0?!0:T;n.allowTextSelection;var N=n.group,P=n.className,L=n.whiteList,V=n.hasPositiveIndices,U=n.shards,te=U===void 0?el:U,ie=n.as,ae=ie===void 0?"div":ie,q=n.lockProps,G=q===void 0?{}:q,ge=n.sideCar,Pe=n.returnFocus,ne=Pe===void 0?!1:Pe,Ae=n.focusOptions,ce=n.onActivation,H=n.onDeactivation,I=i.useState({}),B=I[0],de=i.useCallback(function(z){var oe=z.captureFocusRestore;if(!u.current){var je,se=(je=document)==null?void 0:je.activeElement;u.current=se,se!==document.body&&(u.current=oe(se))}l.current&&ce&&ce(l.current),b.current=!0,g()},[ce]),K=i.useCallback(function(){b.current=!1,H&&H(l.current),g()},[H]),le=i.useCallback(function(z){var oe=u.current;if(oe){var je=(typeof oe=="function"?oe():oe)||document.body,se=typeof ne=="function"?ne(je):ne;if(se){var $e=typeof se=="object"?se:void 0;u.current=null,z?Promise.resolve().then(function(){return je.focus($e)}):je.focus($e)}}},[ne]),we=i.useCallback(function(z){b.current&&si.useMedium(z)},[]),He=ai.useMedium,Qe=i.useCallback(function(z){l.current!==z&&(l.current=z,c(z))},[]),tt=os((s={},s[ti]=k&&"disabled",s[ya]=N,s),G),pt=x!==!0,st=pt&&x!=="tail",E=Yc([r,Qe]),J=i.useMemo(function(){return{observed:l,shards:te,enabled:!k,active:b.current}},[k,b.current,te,o]);return Nt.createElement(i.Fragment,null,pt&&[Nt.createElement("div",{key:"guard-first","data-focus-guard":!0,tabIndex:k?-1:0,style:ea}),V?Nt.createElement("div",{key:"guard-nearest","data-focus-guard":!0,tabIndex:k?-1:1,style:ea}):null],!k&&Nt.createElement(ge,{id:B,sideCar:Qc,observed:o,disabled:k,persistentFocus:C,crossFrame:j,autoFocus:M,whiteList:L,shards:te,onActivation:de,onDeactivation:K,returnFocus:le,focusOptions:Ae,noFocusGuards:x}),Nt.createElement(ae,os({ref:E},tt,{className:P,onBlur:He,onFocus:we}),Nt.createElement(Zc.Provider,{value:J},m)),st&&Nt.createElement("div",{"data-focus-guard":!0,tabIndex:k?-1:0,style:ea}))});_a.propTypes={};function Na(t,n){return Na=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(r,s){return r.__proto__=s,r},Na(t,n)}function tl(t,n){t.prototype=Object.create(n.prototype),t.prototype.constructor=t,Na(t,n)}function is(t){"@babel/helpers - typeof";return is=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(n){return typeof n}:function(n){return n&&typeof Symbol=="function"&&n.constructor===Symbol&&n!==Symbol.prototype?"symbol":typeof n},is(t)}function nl(t,n){if(is(t)!="object"||!t)return t;var r=t[Symbol.toPrimitive];if(r!==void 0){var s=r.call(t,n);if(is(s)!="object")return s;throw new TypeError("@@toPrimitive must return a primitive value.")}return(n==="string"?String:Number)(t)}function rl(t){var n=nl(t,"string");return is(n)=="symbol"?n:n+""}function sl(t,n,r){return(n=rl(n))in t?Object.defineProperty(t,n,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[n]=r,t}function al(t,n){function r(s){return s.displayName||s.name||"Component"}return function(a){var o=[],c;function l(){c=t(o.map(function(u){return u.props})),n(c)}var b=(function(u){tl(f,u);function f(){return u.apply(this,arguments)||this}f.peek=function(){return c};var g=f.prototype;return g.componentDidMount=function(){o.push(this),l()},g.componentDidUpdate=function(){l()},g.componentWillUnmount=function(){var A=o.indexOf(this);o.splice(A,1),l()},g.render=function(){return Nt.createElement(a,this.props)},f})(i.PureComponent);return sl(b,"displayName","SideEffect("+r(a)+")"),b}}var Jn=function(t){for(var n=Array(t.length),r=0;r<t.length;++r)n[r]=t[r];return n},Sr=function(t){return Array.isArray(t)?t:[t]},oi=function(t){return Array.isArray(t)?t[0]:t},ol=function(t){if(t.nodeType!==Node.ELEMENT_NODE)return!1;var n=window.getComputedStyle(t,null);return!n||!n.getPropertyValue?!1:n.getPropertyValue("display")==="none"||n.getPropertyValue("visibility")==="hidden"},ii=function(t){return t.parentNode&&t.parentNode.nodeType===Node.DOCUMENT_FRAGMENT_NODE?t.parentNode.host:t.parentNode},ci=function(t){return t===document||t&&t.nodeType===Node.DOCUMENT_NODE},il=function(t){return t.hasAttribute("inert")},cl=function(t,n){return!t||ci(t)||!ol(t)&&!il(t)&&n(ii(t))},li=function(t,n){var r=t.get(n);if(r!==void 0)return r;var s=cl(n,li.bind(void 0,t));return t.set(n,s),s},ll=function(t,n){return t&&!ci(t)?ml(t)?n(ii(t)):!1:!0},di=function(t,n){var r=t.get(n);if(r!==void 0)return r;var s=ll(n,di.bind(void 0,t));return t.set(n,s),s},ui=function(t){return t.dataset},dl=function(t){return t.tagName==="BUTTON"},mi=function(t){return t.tagName==="INPUT"},hi=function(t){return mi(t)&&t.type==="radio"},ul=function(t){return!((mi(t)||dl(t))&&(t.type==="hidden"||t.disabled))},ml=function(t){var n=t.getAttribute(qc);return![!0,"true",""].includes(n)},Fa=function(t){var n;return!!(t&&(!((n=ui(t))===null||n===void 0)&&n.focusGuard))},ja=function(t){return!Fa(t)},hl=function(t){return!!t},fl=function(t,n){var r=Math.max(0,t.tabIndex),s=Math.max(0,n.tabIndex),a=r-s,o=t.index-n.index;if(a){if(!r)return 1;if(!s)return-1}return a||o},pl=function(t){return t.tabIndex<0&&!t.hasAttribute("tabindex")?0:t.tabIndex},Ua=function(t,n,r){return Jn(t).map(function(s,a){var o=pl(s);return{node:s,index:a,tabIndex:r&&o===-1?(s.dataset||{}).focusGuard?0:-1:o}}).filter(function(s){return!n||s.tabIndex>=0}).sort(fl)},gl=["button:enabled","select:enabled","textarea:enabled","input:enabled","a[href]","area[href]","summary","iframe","object","embed","audio[controls]","video[controls]","[tabindex]","[contenteditable]","[autofocus]"],$a=gl.join(","),bl="".concat($a,", [data-focus-guard]"),fi=function(t,n){return Jn((t.shadowRoot||t).children).reduce(function(r,s){return r.concat(s.matches(n?bl:$a)?[s]:[],fi(s))},[])},xl=function(t,n){var r;return t instanceof HTMLIFrameElement&&(!((r=t.contentDocument)===null||r===void 0)&&r.body)?Br([t.contentDocument.body],n):[t]},Br=function(t,n){return t.reduce(function(r,s){var a,o=fi(s,n),c=(a=[]).concat.apply(a,o.map(function(l){return xl(l,n)}));return r.concat(c,s.parentNode?Jn(s.parentNode.querySelectorAll($a)).filter(function(l){return l===s}):[])},[])},vl=function(t){var n=t.querySelectorAll("[".concat(Hc,"]"));return Jn(n).map(function(r){return Br([r])}).reduce(function(r,s){return r.concat(s)},[])},Ba=function(t,n){return Jn(t).filter(function(r){return li(n,r)}).filter(function(r){return ul(r)})},So=function(t,n){return n===void 0&&(n=new Map),Jn(t).filter(function(r){return di(n,r)})},Va=function(t,n,r){return Ua(Ba(Br(t,r),n),!0,r)},cs=function(t,n){return Ua(Ba(Br(t),n),!1)},yl=function(t,n){return Ba(vl(t),n)},jr=function(t,n){return t.shadowRoot?jr(t.shadowRoot,n):Object.getPrototypeOf(t).contains!==void 0&&Object.getPrototypeOf(t).contains.call(t,n)?!0:Jn(t.children).some(function(r){var s;if(r instanceof HTMLIFrameElement){var a=(s=r.contentDocument)===null||s===void 0?void 0:s.body;return a?jr(a,n):!1}return jr(r,n)})},wl=function(t){for(var n=new Set,r=t.length,s=0;s<r;s+=1)for(var a=s+1;a<r;a+=1){var o=t[s].compareDocumentPosition(t[a]);(o&Node.DOCUMENT_POSITION_CONTAINED_BY)>0&&n.add(a),(o&Node.DOCUMENT_POSITION_CONTAINS)>0&&n.add(s)}return t.filter(function(c,l){return!n.has(l)})},pi=function(t){return t.parentNode?pi(t.parentNode):t},Wa=function(t){var n=Sr(t);return n.filter(Boolean).reduce(function(r,s){var a=s.getAttribute(ya);return r.push.apply(r,a?wl(Jn(pi(s).querySelectorAll("[".concat(ya,'="').concat(a,'"]:not([').concat(ti,'="disabled"])')))):[s]),r},[])},Nl=function(t){try{return t()}catch{return}},ls=function(t){if(t===void 0&&(t=document),!(!t||!t.activeElement)){var n=t.activeElement;return n.shadowRoot?ls(n.shadowRoot):n instanceof HTMLIFrameElement&&Nl(function(){return n.contentWindow.document})?ls(n.contentWindow.document):n}},jl=function(t,n){return t===n},Sl=function(t,n){return!!Jn(t.querySelectorAll("iframe")).some(function(r){return jl(r,n)})},gi=function(t,n){return n===void 0&&(n=ls(oi(t).ownerDocument)),!n||n.dataset&&n.dataset.focusGuard?!1:Wa(t).some(function(r){return jr(r,n)||Sl(r,n)})},Cl=function(t){t===void 0&&(t=document);var n=ls(t);return n?Jn(t.querySelectorAll("[".concat(zc,"]"))).some(function(r){return jr(r,n)}):!1},kl=function(t,n){return n.filter(hi).filter(function(r){return r.name===t.name}).filter(function(r){return r.checked})[0]||t},za=function(t,n){return hi(t)&&t.name?kl(t,n):t},El=function(t){var n=new Set;return t.forEach(function(r){return n.add(za(r,t))}),t.filter(function(r){return n.has(r)})},Co=function(t){return t[0]&&t.length>1?za(t[0],t):t[0]},ko=function(t,n){return t.indexOf(za(n,t))},Sa="NEW_FOCUS",Tl=function(t,n,r,s,a){var o=t.length,c=t[0],l=t[o-1],b=Fa(s);if(!(s&&t.indexOf(s)>=0)){var u=s!==void 0?r.indexOf(s):-1,f=a?r.indexOf(a):u,g=a?t.indexOf(a):-1;if(u===-1)return g!==-1?g:Sa;if(g===-1)return Sa;var m=u-f,A=r.indexOf(c),k=r.indexOf(l),S=El(r),x=s!==void 0?S.indexOf(s):-1,w=a?S.indexOf(a):x,C=S.filter(function(P){return P.tabIndex>=0}),$=s!==void 0?C.indexOf(s):-1,j=a?C.indexOf(a):$,T=$>=0&&j>=0?j-$:w-x;if(!m&&g>=0||n.length===0)return g;var M=ko(t,n[0]),N=ko(t,n[n.length-1]);if(u<=A&&b&&Math.abs(m)>1)return N;if(u>=k&&b&&Math.abs(m)>1)return M;if(m&&Math.abs(T)>1)return g;if(u<=A)return N;if(u>k)return M;if(m)return Math.abs(m)>1?g:(o+g+m)%o}},Dl=function(t){return function(n){var r,s=(r=ui(n))===null||r===void 0?void 0:r.autofocus;return n.autofocus||s!==void 0&&s!=="false"||t.indexOf(n)>=0}},Eo=function(t,n,r){var s=t.map(function(o){var c=o.node;return c}),a=So(s.filter(Dl(r)));return a&&a.length?Co(a):Co(So(n))},Ca=function(t,n){return n===void 0&&(n=[]),n.push(t),t.parentNode&&Ca(t.parentNode.host||t.parentNode,n),n},ta=function(t,n){for(var r=Ca(t),s=Ca(n),a=0;a<r.length;a+=1){var o=r[a];if(s.indexOf(o)>=0)return o}return!1},bi=function(t,n,r){var s=Sr(t),a=Sr(n),o=s[0],c=!1;return a.filter(Boolean).forEach(function(l){c=ta(c||l,l)||c,r.filter(Boolean).forEach(function(b){var u=ta(o,b);u&&(!c||jr(u,c)?c=u:c=ta(u,c))})}),c},To=function(t,n){return t.reduce(function(r,s){return r.concat(yl(s,n))},[])},Il=function(t,n){var r=new Map;return n.forEach(function(s){return r.set(s.node,s)}),t.map(function(s){return r.get(s)}).filter(hl)},Al=function(t,n){var r=ls(Sr(t).length>0?document:oi(t).ownerDocument),s=Wa(t).filter(ja),a=bi(r||t,t,s),o=new Map,c=cs(s,o),l=c.filter(function(k){var S=k.node;return ja(S)});if(l[0]){var b=cs([a],o).map(function(k){var S=k.node;return S}),u=Il(b,l),f=u.map(function(k){var S=k.node;return S}),g=u.filter(function(k){var S=k.tabIndex;return S>=0}).map(function(k){var S=k.node;return S}),m=Tl(f,g,b,r,n);if(m===Sa){var A=Eo(c,g,To(s,o))||Eo(c,f,To(s,o));if(A)return{node:A};console.warn("focus-lock: cannot find any node to move focus into");return}return m===void 0?m:u[m]}},Ml=function(t){var n=Wa(t).filter(ja),r=bi(t,t,n),s=Ua(Br([r],!0),!0,!0),a=Br(n,!1);return s.map(function(o){var c=o.node,l=o.index;return{node:c,index:l,lockItem:a.indexOf(c)>=0,guard:Fa(c)}})},Ha=function(t,n){t&&("focus"in t&&t.focus(n),"contentWindow"in t&&t.contentWindow&&t.contentWindow.focus())},na=0,ra=!1,xi=function(t,n,r){r===void 0&&(r={});var s=Al(t,n);if(!ra&&s){if(na>2){console.error("FocusLock: focus-fighting detected. Only one focus management system could be active. See https://github.com/theKashey/focus-lock/#focus-fighting"),ra=!0,setTimeout(function(){ra=!1},1);return}na++,Ha(s.node,r.focusOptions),na--}};function Qr(t){if(!t)return null;if(typeof WeakRef>"u")return function(){return t||null};var n=t?new WeakRef(t):null;return function(){return n?.deref()||null}}var Ol=function(t){if(!t)return null;for(var n=[],r=t;r&&r!==document.body;)n.push({current:Qr(r),parent:Qr(r.parentElement),left:Qr(r.previousElementSibling),right:Qr(r.nextElementSibling)}),r=r.parentElement;return{element:Qr(t),stack:n,ownerDocument:t.ownerDocument}},Pl=function(t){var n,r,s,a,o;if(t)for(var c=t.stack,l=t.ownerDocument,b=new Map,u=0,f=c;u<f.length;u++){var g=f[u],m=(n=g.parent)===null||n===void 0?void 0:n.call(g);if(m&&l.contains(m)){for(var A=(r=g.left)===null||r===void 0?void 0:r.call(g),k=g.current(),S=m.contains(k)?k:void 0,x=(s=g.right)===null||s===void 0?void 0:s.call(g),w=Va([m],b),C=(o=(a=S??A?.nextElementSibling)!==null&&a!==void 0?a:x)!==null&&o!==void 0?o:A;C;){for(var $=0,j=w;$<j.length;$++){var T=j[$];if(C?.contains(T.node))return T.node}C=C.nextElementSibling}if(w.length)return w[0].node}}},vi=function(t){var n=Ol(t);return function(){return Pl(n)}},Rl=function(t,n,r){if(!t||!n)return console.error("no element or scope given"),{};var s=Sr(n);if(s.every(function(c){return!jr(c,t)}))return console.error("Active element is not contained in the scope"),{};var a=r?Va(s,new Map):cs(s,new Map),o=a.findIndex(function(c){var l=c.node;return l===t});if(o!==-1)return{prev:a[o-1],next:a[o+1],first:a[0],last:a[a.length-1]}},Ll=function(t,n){var r=n?Va(Sr(t),new Map):cs(Sr(t),new Map);return{first:r[0],last:r[r.length-1]}},_l=function(t){return Object.assign({scope:document.body,cycle:!0,onlyTabbable:!0},t)},yi=function(t,n,r){n===void 0&&(n={});var s=_l(n),a=Rl(t,s.scope,s.onlyTabbable);if(a){var o=r(a,s.cycle);o&&Ha(o.node,s.focusOptions)}},Fl=function(t,n){n===void 0&&(n={}),yi(t,n,function(r,s){var a=r.next,o=r.first;return a||s&&o})},Ul=function(t,n){n===void 0&&(n={}),yi(t,n,function(r,s){var a=r.prev,o=r.last;return a||s&&o})},wi=function(t,n,r){var s,a=Ll(t,(s=n.onlyTabbable)!==null&&s!==void 0?s:!0),o=a[r];o&&Ha(o.node,n.focusOptions)},$l=function(t,n){n===void 0&&(n={}),wi(t,n,"first")},Bl=function(t,n){n===void 0&&(n={}),wi(t,n,"last")};function qa(t){setTimeout(t,1)}var Vl=function(n){return n&&"current"in n?n.current:n},Ni=function(){return document&&document.activeElement===document.body},Wl=function(){return Ni()||Cl()},Fr=null,bn=null,Do=function(){return null},Ur=null,ds=!1,Ga=!1,zl=function(){return!0},Hl=function(n){return(Fr.whiteList||zl)(n)},ql=function(n,r){Ur={observerNode:n,portaledElement:r}},Gl=function(n){return Ur&&Ur.portaledElement===n};function Io(t,n,r,s){var a=null,o=t;do{var c=s[o];if(c.guard)c.node.dataset.focusAutoGuard&&(a=c);else if(c.lockItem){if(o!==t)return;a=null}else break}while((o+=r)!==n);a&&(a.node.tabIndex=0)}var Jl=function(n){return n?!!ds:ds==="meanwhile"},Yl=function t(n,r,s){return r&&(r.host===n&&(!r.activeElement||s.contains(r.activeElement))||r.parentNode&&t(n,r.parentNode,s))},Kl=function(n,r){return r.some(function(s){return Yl(n,s,s)})},ji=function(n){return cs(n,new Map)},Xl=function(n){return!ji([n.parentNode]).some(function(r){return r.node===n})},Bs=function(){var n=!1;if(Fr){var r=Fr,s=r.observed,a=r.persistentFocus,o=r.autoFocus,c=r.shards,l=r.crossFrame,b=r.focusOptions,u=r.noFocusGuards,f=s||Ur&&Ur.portaledElement;if(Ni()&&bn&&bn!==document.body&&(!document.body.contains(bn)||Xl(bn))){var g=Do();g&&g.focus()}var m=document&&document.activeElement;if(f){var A=[f].concat(c.map(Vl).filter(Boolean)),k=function(){if(!Jl(l)||!u||!bn||Ga)return!1;var $=ji(A),j=$.findIndex(function(T){var M=T.node;return M===bn});return j===0||j===$.length-1};if((!m||Hl(m))&&(a||k()||!Wl()||!bn&&o)&&(f&&!(gi(A)||m&&Kl(m,A)||Gl(m))&&(document&&!bn&&m&&!o?(m.blur&&m.blur(),document.body.focus()):(n=xi(A,bn,{focusOptions:b}),Ur={})),bn=document&&document.activeElement,bn!==document.body&&(Do=vi(bn)),ds=!1),document&&m!==document.activeElement&&document.querySelector("[data-focus-auto-guard]")){var S=document&&document.activeElement,x=Ml(A),w=x.map(function(C){var $=C.node;return $}).indexOf(S);w>-1&&(x.filter(function(C){var $=C.guard,j=C.node;return $&&j.dataset.focusAutoGuard}).forEach(function(C){var $=C.node;return $.removeAttribute("tabIndex")}),Io(w,x.length,1,x),Io(w,-1,-1,x))}}}return n},Si=function(n){Bs()&&n&&(n.stopPropagation(),n.preventDefault())},Ja=function(){return qa(Bs)},Ql=function(n){var r=n.target,s=n.currentTarget;s.contains(r)||ql(s,r)},Zl=function(){return null},Ci=function(){Ga=!0},ki=function(){Ga=!1,ds="just",qa(function(){ds="meanwhile"})},ed=function(){document.addEventListener("focusin",Si),document.addEventListener("focusout",Ja),window.addEventListener("focus",Ci),window.addEventListener("blur",ki)},td=function(){document.removeEventListener("focusin",Si),document.removeEventListener("focusout",Ja),window.removeEventListener("focus",Ci),window.removeEventListener("blur",ki)};function nd(t){return t.filter(function(n){var r=n.disabled;return!r})}var Ei={moveFocusInside:xi,focusInside:gi,focusNextElement:Fl,focusPrevElement:Ul,focusFirstElement:$l,focusLastElement:Bl,captureFocusRestore:vi};function rd(t){var n=t.slice(-1)[0];n&&!Fr&&ed();var r=Fr,s=r&&n&&n.id===r.id;Fr=n,r&&!s&&(r.onDeactivation(),t.filter(function(a){var o=a.id;return o===r.id}).length||r.returnFocus(!n)),n?(bn=null,(!s||r.observed!==n.observed)&&n.onActivation(Ei),Bs(),qa(Bs)):(td(),bn=null)}si.assignSyncMedium(Ql);ai.assignMedium(Ja);Xc.assignMedium(function(t){return t(Ei)});const sd=al(nd,rd)(Zl);var ur=i.forwardRef(function(n,r){return Nt.createElement(_a,os({sideCar:sd,ref:r},n))}),Ti=_a.propTypes||{};Ti.sideCar;Wc(Ti,["sideCar"]);ur.propTypes={};var ka=Qo();const ad=t=>`ndn_online_quota_${t}`;function sa(t=new Date){const n=new Date(Date.UTC(t.getFullYear(),t.getMonth(),t.getDate())),r=n.getUTCDay()||7;n.setUTCDate(n.getUTCDate()+4-r);const s=new Date(Date.UTC(n.getUTCFullYear(),0,1)),a=Math.ceil(((n.getTime()-s.getTime())/864e5+1)/7),o=String(a).padStart(2,"0");return`${n.getUTCFullYear()}-${o}`}function od(t){try{const n=localStorage.getItem(ad(t));if(!n)return{week:sa(),used:0};const r=JSON.parse(n),s=sa();return!r.week||r.week!==s?{week:s,used:0}:{week:String(r.week),used:Number(r.used)||0}}catch{return{week:sa(),used:0}}}function id(t,n=3){const r=od(t);return Math.max(0,n-(r.used||0))}const Di={BASE_URL:"/",DEV:!1,MODE:"production",PROD:!0,SSR:!1,VITE_API_URL:"http://localhost:8787",VITE_WS_URL:"ws://localhost:8787"},Ii="ndn:isAdmin:v1";function Ai(){try{const t=localStorage.getItem(Ii);return t?JSON.parse(t):{}}catch{return{}}}function cd(t,n){try{const r=Ai();r[(t||"").toLowerCase()]={v:n,ts:Date.now()},localStorage.setItem(Ii,JSON.stringify(r))}catch{}}async function ld(t){const n=String(t||"").toLowerCase();if(!n)return!1;try{const a=String(Di?.VITE_OWNER_EMAIL||"").toLowerCase();if(a&&n===a)return!0}catch{}if(n==="daviesfamily108@gmail.com")return!0;try{const a=localStorage.getItem("ndn:forceAdmin");if(a==="1"||a==="true")return!0}catch{}const s=Ai()[n];if(s&&Date.now()-s.ts<300*1e3)return!!s.v;try{const c=!!(await(await fetch(`/api/admins/check?email=${encodeURIComponent(n)}`)).json().catch(()=>({})))?.isAdmin;return cd(n,c),c}catch{return!!s?.v}}function Mi(t){const n=String(t||"").toLowerCase(),[r,s]=i.useState(!1);return i.useEffect(()=>{let a=!0;if(!n){s(!1);return}try{const o=String(Di?.VITE_OWNER_EMAIL||"").toLowerCase(),c=(()=>{try{const l=localStorage.getItem("ndn:forceAdmin");return l==="1"||l==="true"}catch{return!1}})();if(o&&n===o){s(!0);return}if(c){s(!0);return}}catch{}if(n==="daviesfamily108@gmail.com"){s(!0);return}return ld(n).then(o=>{a&&s(!!o)}),()=>{a=!1}},[n]),r}const dd={},ud=5,md={GBP:1,EUR:1.16,USD:1.26,AUD:1.92,NZD:2.08,CAD:1.73};function uh(t,n=ud){const r=(t||"GBP").toUpperCase(),s=md[r]??1,a=n*s;try{return new Intl.NumberFormat(void 0,{style:"currency",currency:r}).format(a)}catch{return`${r} ${a.toFixed(2)}`}}function mh(){try{const t=new Intl.NumberFormat().resolvedOptions(),n=String(t.locale).toLowerCase();return n.includes("-gb")?"GBP":n.includes("-ie")||n.includes("-de")||n.includes("-fr")||n.includes("-es")||n.includes("-it")||n.includes("-nl")?"EUR":n.includes("-us")?"USD":n.includes("-au")?"AUD":n.includes("-nz")?"NZD":n.includes("-ca")?"CAD":"GBP"}catch{return"GBP"}}const Oi=dd?.VITE_DISCORD_INVITE_URL||"https://discord.gg/nCfT4hJz",hd={};let Ln=null;const fd=hd?.VITE_REMOTE_API_FALLBACK||"",aa=(fd.trim()||"https://ninedartnation-1.onrender.com").replace(/\/$/,""),pd=new Set(["localhost","127.0.0.1"]);function Pi(){if(Ln)return Ln;const t="http://localhost:8787".trim();if(t){const n=t.replace(/\/$/,"");return typeof window<"u"&&/https?:\/\/(localhost|127\.0\.0\.1)(:\\d+)?/i.test(n)&&!pd.has(window.location.hostname)?(Ln=aa,Ln):(Ln=n,Ln)}if(typeof window<"u"){const{protocol:n,host:r,hostname:s}=window.location,a=`${n}//${r}`;return s.endsWith("onrender.com")||s==="localhost"||s==="127.0.0.1"?Ln=a.replace(/\/$/,""):Ln=aa,Ln}return Ln=aa,Ln}function gd(t){if(/^https?:\/\//i.test(t))return t;const n=Pi(),r=t.startsWith("/")?t:`/${t}`;return`${n}${r}`}function _s(t){return gd(t)}function Ri(){return Pi()}function xn(t,n){const r=_s(t);try{if(window.__ndnApiDisabled)return Promise.resolve({ok:!1,status:503,json:async()=>({})})}catch{}return fetch(r,n).catch(s=>{try{window.__ndnApiDisabled=!0}catch{}return{ok:!1,status:503,json:async()=>({})}}).then(s=>{try{const a=new URL(String(r)).hostname;s&&s.status===404&&a!==window.location.hostname&&(window.__ndnApiDisabled=!0)}catch{}return s})}function bd(){if(typeof window>"u"||typeof window.fetch!="function")return;const t=window;if(t.__ndnApiPatched)return;const n=window.fetch.bind(window);window.fetch=(r,s)=>{try{if(typeof r=="string")return r.startsWith("/")?n(_s(r),s):n(r,s);if(r instanceof Request){const a=r.url.startsWith("/")?_s(r.url):r.url;if(a===r.url)return n(r,s);const o=new Request(a,r);return n(o,s)}if(r instanceof URL){const a=r.href.startsWith("/")?_s(r.href):r.href;return n(a,s)}}catch(a){console.warn("[API] Interceptor failed, falling back to original fetch",a)}return n(r,s)},t.__ndnApiPatched=!0}function xd(t){const n=[{key:"score",label:"Home ðŸ ",icon:yc},{key:"online",label:"Online Play ðŸŒ",icon:$s},{key:"offline",label:"Offline ðŸ†",icon:dr},{key:"tournaments",label:"Tournaments ðŸŸï¸",icon:dr},{key:"friends",label:"Friends ðŸ‘¥",icon:$s},{key:"stats",label:"Stats ðŸ“Š",icon:dr},{key:"calibrate",label:"Camera Connection ï¿½",icon:as},{key:"settings",label:"Settings âš™ï¸",icon:ss}];function r(s){if(!s)return!1;const a=s.subscription;if(!a)return!!s.fullAccess;if(a.fullAccess){if(a.expiresAt){const o=typeof a.expiresAt=="string"?Date.parse(a.expiresAt):Number(a.expiresAt);if(!isNaN(o))return o>Date.now()}return a.status?a.status==="active":!0}return!1}return r(t)||n.push({key:"fullaccess",label:"PREMIUM Â£â‚¬$ âœ¨",icon:wc}),n}function vd(t){let n=t;if(!t?.subscription&&t?.email)try{const r=localStorage?.getItem;if(typeof r=="function"){const s=r.call(localStorage,`ndn:subscription:${t.email}`);if(s){const a=JSON.parse(s);n={...t,subscription:a,fullAccess:a.fullAccess||t.fullAccess}}}}catch{}return n}function Li(t,n){const r=[...xd(t)];if(n&&!r.some(s=>s.key==="admin")){const s={key:"admin",label:"Admin ðŸ›¡ï¸",icon:ss},a=r.findIndex(o=>o.key==="settings");a>=0?r.splice(a,0,s):r.push(s)}return r}function yd({active:t,onChange:n,user:r,className:s}){const a=Nt.useRef(null),o=Nt.useRef(!1),c=Nt.useRef(0),l=Nt.useRef(0),b=V=>{o.current=!0,a.current&&(c.current=V.pageY-a.current.offsetTop,l.current=a.current.scrollTop,a.current.style.cursor="grabbing")},u=()=>{o.current=!1,a.current&&(a.current.style.cursor="grab")},f=()=>{o.current=!1,a.current&&(a.current.style.cursor="grab")},g=V=>{if(!o.current||!a.current)return;V.preventDefault();const te=(V.pageY-a.current.offsetTop-c.current)*2;a.current.scrollTop=l.current-te},m=vd(r),A=Mi(r?.email),k=Li(m,A),[S,x]=i.useState(!1),[w,C]=i.useState(!1),$=r?.username&&!r?.fullAccess?id(r.username):1/0,[j,T]=i.useState({friendRequests:0,messages:0,tournaments:0});i.useEffect(()=>{if(!r?.email)return;let V=!0;const U={count:0};let te=null;const ie=async()=>{try{if(!V||window.__ndnApiDisabled||te&&Date.now()<te)return;const[G,ge]=await Promise.all([xn(`/api/friends/requests?email=${encodeURIComponent(r.email)}`),xn(`/api/friends/messages?email=${encodeURIComponent(r.email)}`)]),Pe=G&&G.ok?await G.json():{requests:[]},Ae=(ge&&ge.ok?await ge.json():{messages:[]}).messages?.filter(ce=>!ce.read).length||0;T({friendRequests:Pe.requests?.length||0,messages:Ae,tournaments:0}),U.count=0,te=null}catch(q){console.error("Failed to fetch notifications:",q),U.count+=1,U.count>=3&&(te=Date.now()+300*1e3,console.warn("Sidebar notifications polling paused for 5m due to repeated failures"))}};ie();const ae=setInterval(ie,3e4);return()=>{V=!1,clearInterval(ae)}},[r?.email]),i.useEffect(()=>{if(!S)return;const V=U=>{(U.key==="Escape"||U.key==="Enter")&&x(!1)};return document.addEventListener("keydown",V),()=>document.removeEventListener("keydown",V)},[S]);const M=k.filter(V=>["score","online","offline","tournaments"].includes(V.key)),N=k.filter(V=>["friends"].includes(V.key)),P=k.filter(V=>["stats","calibrate","settings","admin","fullaccess"].includes(V.key)),L=V=>{const{key:U,label:te,icon:ie}=V,ae=t===U;let q=0;return U==="friends"&&(q=j.friendRequests),U==="score"&&(q=j.messages+j.tournaments),e.jsxs("button",{className:`tab whitespace-nowrap flex items-center justify-between gap-3 ${ae?"tab--active":"tab--inactive"} ${U==="fullaccess"?"tab--premium":""}`,onClick:()=>n(U),title:te,children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(ie,{className:`w-5 h-5 ${ae?"text-white":"text-slate-400"}`}),e.jsx("span",{className:`font-semibold text-[1rem] ${ae?"text-white":"text-slate-300"}`,children:te})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[U==="online"&&!r?.fullAccess&&$<=0&&e.jsx(vc,{className:"w-3 h-3 text-rose-500"}),q>0&&e.jsx("span",{className:"notification-badge animate-pulse",children:q>9?"9+":q})]})]},U)};return e.jsxs("aside",{ref:a,onMouseDown:b,onMouseLeave:u,onMouseUp:f,onMouseMove:g,className:`${r?.fullAccess?"premium-sidebar":""} sidebar glass ${s?"":"w-72"} p-5 rounded-2xl ${s??"hidden sm:flex"} flex-col gap-8 overflow-y-auto overflow-x-hidden ${s?"":"fixed top-4 bottom-4 left-4"}`,children:[e.jsx("div",{className:"px-2 mb-2",children:e.jsxs("h1",{className:"text-2xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-purple-400 tracking-tight",children:["NINE DART",e.jsx("br",{}),"NATION"]})}),e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx("h3",{className:"text-xs font-bold text-slate-500 uppercase tracking-wider px-3 mb-2",children:"Play"}),M.map(L)]}),e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx("h3",{className:"text-xs font-bold text-slate-500 uppercase tracking-wider px-3 mb-2",children:"Social"}),N.map(L)]}),e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx("h3",{className:"text-xs font-bold text-slate-500 uppercase tracking-wider px-3 mb-2",children:"System"}),P.map(V=>{const U=L(V);return V.key==="settings"?e.jsxs(Nt.Fragment,{children:[U,e.jsxs("button",{className:"tab tab--compact whitespace-nowrap flex items-center justify-start gap-3 bg-[#5865F2]/10 hover:bg-[#5865F2]/20 text-[#5865F2] transition-colors ml-4 border-l-2 border-[#5865F2]/30",onClick:()=>x(!0),title:"BullseyeDartsLeague",children:[e.jsx(Tn,{className:"w-4 h-4"}),e.jsx("span",{className:"truncate text-sm font-semibold",children:"Bullseye League"})]}),e.jsxs("button",{className:"tab tab--compact whitespace-nowrap flex items-center justify-start gap-3 bg-[#5865F2]/10 hover:bg-[#5865F2]/20 text-[#5865F2] transition-colors ml-4 border-l-2 border-[#5865F2]/30",onClick:()=>C(!0),title:"NineDartNation",children:[e.jsx(Tn,{className:"w-4 h-4"}),e.jsx("span",{className:"truncate text-sm font-semibold",children:"NDN Community"})]})]},V.key):U})]}),S&&ka.createPortal(e.jsxs("div",{className:"fixed inset-0 z-[1000]",children:[e.jsx("button",{className:"absolute inset-0 bg-black/50",onClick:()=>x(!1),onTouchStart:()=>x(!1),"aria-label":"Close Discord dialog"}),e.jsx("div",{className:"absolute inset-0 flex items-center justify-center p-4",children:e.jsx(ur,{returnFocus:!0,children:e.jsxs("div",{role:"dialog","aria-modal":"true",className:"card max-w-md w-full relative text-left p-6 rounded-xl",children:[e.jsx("button",{className:"absolute -top-3 -right-3 btn px-3 py-1","aria-label":"Close",onClick:()=>x(!1),children:"âœ•"}),e.jsxs("h3",{className:"text-xl font-bold mb-2 flex items-center gap-2 text-[#8ea1e1]",children:[e.jsx(Tn,{className:"w-6 h-6"})," BullseyeDartsLeague ðŸŽ¯"]}),e.jsx("div",{className:"mb-4 text-lg font-semibold",children:"Join this fantastic Online Darts League with divisions and other cool stuff included"}),e.jsx("a",{href:Oi,target:"_blank",rel:"noopener noreferrer nofollow",className:"btn bg-[#5865F2] text-white w-full font-bold text-lg",children:"Join Discord ðŸ’¬"})]})})})]}),document.body),w&&ka.createPortal(e.jsxs("div",{className:"fixed inset-0 z-[1000]",children:[e.jsx("button",{className:"absolute inset-0 bg-black/50",onClick:()=>C(!1),onTouchStart:()=>C(!1),"aria-label":"Close NineDartNation dialog"}),e.jsx("div",{className:"absolute inset-0 flex items-center justify-center p-4",children:e.jsx(ur,{returnFocus:!0,children:e.jsxs("div",{role:"dialog","aria-modal":"true",className:"card max-w-md w-full relative text-left p-6 rounded-xl",children:[e.jsx("button",{className:"absolute -top-3 -right-3 btn px-3 py-1","aria-label":"Close",onClick:()=>C(!1),children:"âœ•"}),e.jsxs("h3",{className:"text-xl font-bold mb-2 flex items-center gap-2 text-[#8ea1e1]",children:[e.jsx(Tn,{className:"w-6 h-6"})," NineDartNation ðŸŽ¯"]}),e.jsx("div",{className:"mb-4 text-lg font-semibold",children:"Join the NineDartNation ðŸŽ¯ Discord community"}),e.jsx("a",{href:"https://discord.gg/Q33J5FTVve",target:"_blank",rel:"noopener noreferrer nofollow",className:"btn bg-[#5865F2] text-white w-full font-bold text-lg",children:"Join Discord ðŸ’¬"})]})})})]}),document.body)]})}function Hn({children:t,className:n,style:r}){const s=i.useRef(null),[a,o]=i.useState(0);return i.useEffect(()=>{let c=0,l=0;const b=()=>{const g=document.getElementById("ndn-header");if(!g){l!==0&&(l=0,o(0));return}const m=document.getElementById("ndn-main-scroll"),A=m?m.scrollTop:window.scrollY||0,k=g.getBoundingClientRect().height,S=A>0?k:0;Math.abs(S-l)>1&&(l=S,o(S))};b();const u=()=>{c&&cancelAnimationFrame(c),c=requestAnimationFrame(b)},f=document.getElementById("ndn-main-scroll");return f?.addEventListener("scroll",u,{passive:!0}),window.addEventListener("scroll",u,{passive:!0}),window.addEventListener("resize",u,{passive:!0}),()=>{f?.removeEventListener("scroll",u),window.removeEventListener("scroll",u),window.removeEventListener("resize",u),c&&cancelAnimationFrame(c)}},[]),e.jsxs("div",{ref:s,className:n,style:{...r,position:"relative",willChange:"transform",transform:"translateZ(0)"},children:[a>0&&e.jsx("div",{style:{position:"absolute",left:0,right:0,top:0,height:a,pointerEvents:"none",zIndex:20,background:"linear-gradient(to bottom, rgba(17,24,39,1), rgba(17,24,39,0))",willChange:"height",transform:"translateZ(0)"}}),t]})}const wd=({calibrationComplete:t})=>{const[n,r]=i.useState(!1),[s,a]=i.useState(!1);return i.useEffect(()=>{t?(r(!0),setTimeout(()=>a(!0),1200)):(r(!1),a(!1))},[t]),e.jsxs("div",{className:`flex flex-col items-center justify-center w-full h-full transition-opacity duration-700 ${s?"opacity-0":"opacity-100"}`,style:{pointerEvents:"none",position:"absolute",inset:0,zIndex:10},children:[e.jsxs("div",{className:"flex items-center justify-center",children:[e.jsx("svg",{width:"80",height:"80",viewBox:"0 0 80 80",className:`animate-spin-slow ${n?"opacity-0":"opacity-100"} transition-opacity duration-500`,style:{transition:"opacity 0.5s"},children:e.jsxs("g",{children:[e.jsx("rect",{x:"36",y:"10",width:"8",height:"40",rx:"3",fill:"#a78bfa"}),e.jsx("polygon",{points:"40,10 44,22 36,22",fill:"#f472b6"}),e.jsx("rect",{x:"36",y:"50",width:"8",height:"18",rx:"2",fill:"#22d3ee"}),e.jsx("polygon",{points:"36,68 44,68 40,78",fill:"#10b981"})]})}),n&&e.jsxs("svg",{width:"80",height:"80",viewBox:"0 0 80 80",className:"absolute",style:{left:0,top:0},children:[e.jsx("circle",{cx:"40",cy:"40",r:"32",fill:"none",stroke:"#10b981",strokeWidth:"6"}),e.jsx("polyline",{points:"28,44 38,54 54,30",fill:"none",stroke:"#10b981",strokeWidth:"6",strokeLinecap:"round",strokeLinejoin:"round"})]})]}),e.jsx("div",{className:"mt-4 text-lg font-semibold text-indigo-200",children:n?"Calibration Complete!":"Initializing Camera..."})]})};function nt(...t){}function Vs(...t){}class Nd{width=0;height=0;bg=null;lastAcceptTs=0;cooldownMs=600;roiRadius=0;roiCx=0;roiCy=0;initialized=!1;thresh=18;minArea=60;maxArea=6e3;angMaxDeg=70;prevTip=null;prevArea=0;stableCount=0;requireStableN=2;tempOverrides=null;constructor(n){n?.thresh!==void 0&&(this.thresh=n.thresh),n?.minArea!==void 0&&(this.minArea=n.minArea),n?.maxArea!==void 0&&(this.maxArea=n.maxArea),n?.requireStableN!==void 0&&(this.requireStableN=n.requireStableN),n?.angMaxDeg!==void 0&&(this.angMaxDeg=n.angMaxDeg)}setTemporaryOverrides(n,r){const s=Math.max(0,Number(r)||0);if(s<=0){this.tempOverrides=null;return}this.tempOverrides={...n,untilTs:Date.now()+s}}_effectiveTuning(){const n=Date.now(),r=this.tempOverrides;return!r||n>=r.untilTs?(r&&n>=r.untilTs&&(this.tempOverrides=null),{thresh:this.thresh,minArea:this.minArea,maxArea:this.maxArea,requireStableN:this.requireStableN,angMaxDeg:this.angMaxDeg,inGrace:!1}):{thresh:r.thresh??this.thresh,minArea:r.minArea??this.minArea,maxArea:this.maxArea,requireStableN:r.requireStableN??this.requireStableN,angMaxDeg:r.angMaxDeg??this.angMaxDeg,inGrace:!0}}setROI(n,r,s){this.roiCx=n,this.roiCy=r,this.roiRadius=Math.max(0,s|0)}reset(n,r){this.width=n,this.height=r,this.bg=new Float32Array(n*r),this.initialized=!1}updateBackground(n,r=.05){const{width:s,height:a,data:o}=n;(!this.bg||s!==this.width||a!==this.height)&&this.reset(s,a);const c=this.bg,l=s*a;for(let b=0,u=0;b<l;b++,u+=4){const f=o[u],g=o[u+1],m=o[u+2],A=.299*f+.587*g+.114*m;this.initialized?c[b]=(1-r)*c[b]+r*A:c[b]=A}this.initialized=!0}inRoi(n,r){if(this.roiRadius<=0)return!0;const s=n-this.roiCx,a=r-this.roiCy;return s*s+a*a<=this.roiRadius*this.roiRadius}detect(n){const s=Date.now()-this.lastAcceptTs<this.cooldownMs,a=this._effectiveTuning(),{width:o,height:c,data:l}=n;(!this.bg||o!==this.width||c!==this.height)&&this.reset(o,c);const b=this.bg;if(!this.initialized)return this.updateBackground(n,1),null;const u=o*c,f=new Uint8Array(u),g=new Float32Array(u);let m=0,A=0,k=0;const S=new Uint8Array(u);for(let _e=0,Te=0;_e<u;_e++,Te+=4){const Ge=l[Te],it=l[Te+1],Ft=l[Te+2],ct=Math.max(Ge,it,Ft),$n=Math.min(Ge,it,Ft),Ut=.299*Ge+.587*it+.114*Ft,at=Math.abs(Ut-b[_e]);g[_e]=at;const p=Math.floor(_e/o),Z=_e-p*o,ye=ct===0?0:(ct-$n)/ct,Ze=ct>=250&&ye<=.12;Ze&&(S[_e]=1),this.inRoi(Z,p)&&!Ze&&(m+=at,A+=at*at,k++)}const x=k?m/k:0,w=k?Math.max(0,A/k-x*x):0,C=Math.sqrt(w),$=Math.max(a.thresh,x+1.2*C);for(let _e=0;_e<u;_e++){if(S[_e]){f[_e]=0;continue}if(g[_e]>$){const Te=Math.floor(_e/o),Ge=_e-Te*o;f[_e]=this.inRoi(Ge,Te)?1:0}}this._dilate(f,o,c),this._erode(f,o,c);const j=new Uint8Array(u);let T=0,M=null;for(let _e=0;_e<u;_e++){if(f[_e]===0||j[_e])continue;const Te=[];let Ge=0,it=0;const Ft=[_e];for(j[_e]=1;it<Ft.length;){const ct=Ft[it++];Te.push(ct),Ge++;const $n=ct/o|0,Ut=[ct-1,ct+1,ct-o,ct+o];for(const at of Ut)at<0||at>=u||j[at]||(at===ct-1||at===ct+1)&&(at/o|0)!==$n||f[at]&&(j[at]=1,Ft.push(at))}Ge>T&&(T=Ge,M=Te)}if(!M||T<a.minArea||T>a.maxArea)return s||this.updateBackground(n,.02),Math.random()<.02&&nt("[DETECTOR] No valid blob:",{bestArea:T,minArea:a.minArea,maxArea:a.maxArea,hasBlob:!!M,inGrace:a.inGrace}),null;let N=o,P=c,L=0,V=0,U=0,te=0;for(const _e of M){const Te=_e/o|0,Ge=_e-Te*o;U+=Ge,te+=Te,Ge<N&&(N=Ge),Ge>L&&(L=Ge),Te<P&&(P=Te),Te>V&&(V=Te)}U/=T,te/=T;let ie=0,ae=0,q=0;for(const _e of M){const Te=_e/o|0,it=_e-Te*o-U,Ft=Te-te;ie+=it*it,ae+=Ft*Ft,q+=it*Ft}ie/=T,ae/=T,q/=T;const G=ie+ae,ge=ie*ae-q*q,Pe=Math.sqrt(Math.max(0,G*G/4-ge)),ne=G/2+Pe;let Ae=q,ce=ne-ie;Math.hypot(Ae,ce)<1e-6&&(Ae=ne-ae,ce=q);const H=Math.hypot(Ae,ce)||1;Ae/=H,ce/=H;const I=U-this.roiCx,B=te-this.roiCy,de=Math.hypot(I,B),K=Math.max(8,this.roiRadius*.05);if(de>=K){const _e=I/de,Te=B/de,Ge=Math.max(-1,Math.min(1,Math.abs(Ae*_e+ce*Te))),it=Math.acos(Ge)*180/Math.PI;if(it>a.angMaxDeg)return s||this.updateBackground(n,.02),nt("[DETECTOR] Rejected - angle too large:",{angDeg:it,maxAllowed:a.angMaxDeg,inGrace:a.inGrace}),null}let le=-1/0,we=1/0,He=U,Qe=te,tt=U,pt=te;for(const _e of M){const Te=_e/o|0,Ge=_e-Te*o,it=(Ge-U)*Ae+(Te-te)*ce;it>le&&(le=it,He=Ge,Qe=Te),it<we&&(we=it,tt=Ge,pt=Te)}const st=(_e,Te)=>{const Ge=_e-this.roiCx,it=Te-this.roiCy;return Ge*Ge+it*it},E=st(He,Qe),J=st(tt,pt);let z,oe;J<=E?(z=tt,oe=pt,le-we!==0&&(z-U)*Ae+(oe-te)*ce>0&&(Ae=-Ae,ce=-ce)):(z=He,oe=Qe,(z-U)*Ae+(oe-te)*ce>0&&(Ae=-Ae,ce=-ce));const je=z-this.roiCx,se=oe-this.roiCy,$e=je*je+se*se,jt=Math.max(1,L-N+1),Mt=Math.max(1,V-P+1),Et=jt*Mt,fe=T/Et,Qt=Math.sqrt($e)/Math.max(1,this.roiRadius);let Be=.5;fe<.45&&(Be+=.2),fe<.25&&(Be+=.15),Qt<1.1&&(Be+=.1);const vn=G-ne;return(ne>0?1-vn/ne:0)>.3&&(Be+=.1),Be=Math.max(0,Math.min(1,Be)),this._isStable({x:z+.5,y:oe+.5},T,a.requireStableN)?s?null:{tip:{x:z+.5,y:oe+.5},axis:{x1:U-Ae*20,y1:te-ce*20,x2:U+Ae*20,y2:te+ce*20},area:T,bbox:{x:N,y:P,w:jt,h:Mt},confidence:Be}:(nt("[DETECTOR] Waiting for stability:",{stableCount:this.stableCount,needFrames:a.requireStableN,inGrace:a.inGrace}),null)}accept(n,r){if(this.lastAcceptTs=Date.now(),this.prevTip=null,this.prevArea=0,this.stableCount=0,!this.bg)return;const{width:s}=n,a=this.bg,{x:o,y:c,w:l,h:b}=r.bbox,u=.5;for(let f=c;f<c+b;f++)for(let g=o;g<o+l;g++){const m=f*s+g,A=m*4,k=n.data[A],S=n.data[A+1],x=n.data[A+2],w=.299*k+.587*S+.114*x;a[m]=(1-u)*a[m]+u*w}}_isStable(n,r,s){const a=(c,l)=>Math.hypot(c.x-l.x,c.y-l.y)<=6;if(!this.prevTip)return this.prevTip={...n},this.prevArea=r,this.stableCount=1,!1;if(a(this.prevTip,n)&&Math.abs(r-this.prevArea)/Math.max(1,r)<.3)this.prevTip={...n},this.prevArea=r,this.stableCount++;else return this.prevTip={...n},this.prevArea=r,this.stableCount=1,!1;const o=Math.max(1,s??this.requireStableN);return this.stableCount>=o}_dilate(n,r,s){const a=new Uint8Array(n.length);for(let o=0;o<s;o++)for(let c=0;c<r;c++){let l=0;for(let b=-1;b<=1;b++){for(let u=-1;u<=1;u++){const f=o+b,g=c+u;if(!(f<0||f>=s||g<0||g>=r)&&n[f*r+g]){l=1;break}}if(l)break}a[o*r+c]=l}n.set(a)}_erode(n,r,s){const a=new Uint8Array(n.length);for(let o=0;o<s;o++)for(let c=0;c<r;c++){let l=1;for(let b=-1;b<=1;b++){for(let u=-1;u<=1;u++){const f=o+b,g=c+u;if(!(f<0||f>=s||g<0||g>=r)&&!n[f*r+g]){l=0;break}}if(!l)break}a[o*r+c]=l}n.set(a)}}const jd={},Ao=t=>{let n;const r=new Set,s=(f,g)=>{const m=typeof f=="function"?f(n):f;if(!Object.is(m,n)){const A=n;n=g??(typeof m!="object"||m===null)?m:Object.assign({},n,m),r.forEach(k=>k(n,A))}},a=()=>n,b={setState:s,getState:a,getInitialState:()=>u,subscribe:f=>(r.add(f),()=>r.delete(f)),destroy:()=>{(jd?"production":void 0)!=="production"&&console.warn("[DEPRECATED] The `destroy` method will be unsupported in a future version. Instead use unsubscribe function returned by subscribe. Everything will be garbage-collected if store is garbage-collected."),r.clear()}},u=n=t(s,a,b);return b},Sd=t=>t?Ao(t):Ao;var oa={exports:{}},ia={},ca={exports:{}},la={};/**
 * @license React
 * use-sync-external-store-shim.production.js
 *
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var Mo;function Cd(){if(Mo)return la;Mo=1;var t=Oa();function n(g,m){return g===m&&(g!==0||1/g===1/m)||g!==g&&m!==m}var r=typeof Object.is=="function"?Object.is:n,s=t.useState,a=t.useEffect,o=t.useLayoutEffect,c=t.useDebugValue;function l(g,m){var A=m(),k=s({inst:{value:A,getSnapshot:m}}),S=k[0].inst,x=k[1];return o(function(){S.value=A,S.getSnapshot=m,b(S)&&x({inst:S})},[g,A,m]),a(function(){return b(S)&&x({inst:S}),g(function(){b(S)&&x({inst:S})})},[g]),c(A),A}function b(g){var m=g.getSnapshot;g=g.value;try{var A=m();return!r(g,A)}catch{return!0}}function u(g,m){return m()}var f=typeof window>"u"||typeof window.document>"u"||typeof window.document.createElement>"u"?u:l;return la.useSyncExternalStore=t.useSyncExternalStore!==void 0?t.useSyncExternalStore:f,la}var Oo;function kd(){return Oo||(Oo=1,ca.exports=Cd()),ca.exports}/**
 * @license React
 * use-sync-external-store-shim/with-selector.production.js
 *
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var Po;function Ed(){if(Po)return ia;Po=1;var t=Oa(),n=kd();function r(u,f){return u===f&&(u!==0||1/u===1/f)||u!==u&&f!==f}var s=typeof Object.is=="function"?Object.is:r,a=n.useSyncExternalStore,o=t.useRef,c=t.useEffect,l=t.useMemo,b=t.useDebugValue;return ia.useSyncExternalStoreWithSelector=function(u,f,g,m,A){var k=o(null);if(k.current===null){var S={hasValue:!1,value:null};k.current=S}else S=k.current;k=l(function(){function w(M){if(!C){if(C=!0,$=M,M=m(M),A!==void 0&&S.hasValue){var N=S.value;if(A(N,M))return j=N}return j=M}if(N=j,s($,M))return N;var P=m(M);return A!==void 0&&A(N,P)?($=M,N):($=M,j=P)}var C=!1,$,j,T=g===void 0?null:g;return[function(){return w(f())},T===null?void 0:function(){return w(T())}]},[f,g,m,A]);var x=a(u,k[0],k[1]);return c(function(){S.hasValue=!0,S.value=x},[x]),b(x),x},ia}var Ro;function Td(){return Ro||(Ro=1,oa.exports=Ed()),oa.exports}var Dd=Td();const Id=Zo(Dd),_i={},{useDebugValue:Ad}=Nt,{useSyncExternalStoreWithSelector:Md}=Id;let Lo=!1;const Od=t=>t;function Pd(t,n=Od,r){(_i?"production":void 0)!=="production"&&r&&!Lo&&(console.warn("[DEPRECATED] Use `createWithEqualityFn` instead of `create` or use `useStoreWithEqualityFn` instead of `useStore`. They can be imported from 'zustand/traditional'. https://github.com/pmndrs/zustand/discussions/1937"),Lo=!0);const s=Md(t.subscribe,t.getState,t.getServerState||t.getInitialState,n,r);return Ad(s),s}const _o=t=>{(_i?"production":void 0)!=="production"&&typeof t!="function"&&console.warn("[DEPRECATED] Passing a vanilla store will be unsupported in a future version. Instead use `import { useStore } from 'zustand'`.");const n=typeof t=="function"?Sd(t):t,r=(s,a)=>Pd(n,s,a);return Object.assign(r,n),r},mr=t=>t?_o(t):_o,Ea="ndn_user_settings";function Ta(){try{const t=localStorage.getItem(Ea);if(!t)return{favoriteDouble:"D16",callerEnabled:!0,callerVoice:"",callerVolume:1,speakCheckoutOnly:!1,avgMode:"all-time",autoStartOffline:!1,rememberLastOffline:!0,lastOffline:{mode:"X01",x01Start:501,firstTo:1,aiLevel:"None"},reducedMotion:!1,compactHeader:!1,allowSpectate:!0,cameraScale:1,cameraAspect:"wide",cameraFitMode:"fit",cameraRecordDarts:!0,cameraShowLabels:!1,cameraLowLatency:!1,cameraProcessingFps:15,calibrationGuide:!0,preferredCameraId:void 0,preferredCameraLabel:void 0,preserveCalibrationOverlay:!0,preserveCalibrationOnCameraChange:!0,cameraEnabled:!0,hideCameraOverlay:!1,offlineLayout:"modern",hideInGameSidebar:!0,autoscoreProvider:"manual",autoscoreWsUrl:"",autoCommitMode:"immediate",confirmUncertainDarts:!1,autoScoreConfidenceThreshold:.82,autoscoreDetectorMinArea:30,autoscoreDetectorThresh:15,autoscoreDetectorRequireStableN:2,harshLightingMode:!1,enhanceBigTrebles:!1,allowAutocommitInOnline:!1,textSize:"medium",boxSize:"medium",matchType:"singles",teamAName:"Team A",teamBName:"Team B",dartTimerEnabled:!1,dartTimerSeconds:10,x01DoubleIn:!1};const n=JSON.parse(t);if(Number(n?.__version||0)<2){const s={...n,autoCommitMode:"immediate",confirmUncertainDarts:!1,cameraRecordDarts:!0,autoScoreConfidenceThreshold:.82,__version:2};try{localStorage.setItem(Ea,JSON.stringify(s))}catch{}}return{favoriteDouble:n.favoriteDouble||"D16",callerEnabled:typeof n.callerEnabled=="boolean"?n.callerEnabled:!0,callerVoice:n.callerVoice||"",callerVolume:typeof n.callerVolume=="number"?Math.max(0,Math.min(1,n.callerVolume)):1,speakCheckoutOnly:!!n.speakCheckoutOnly,avgMode:n.avgMode==="24h"?"24h":"all-time",autoStartOffline:!!n.autoStartOffline,rememberLastOffline:typeof n.rememberLastOffline=="boolean"?n.rememberLastOffline:!0,lastOffline:n.lastOffline&&typeof n.lastOffline=="object"?{mode:n.lastOffline.mode||"X01",x01Start:Number(n.lastOffline.x01Start)||501,firstTo:Number(n.lastOffline.firstTo)||1,aiLevel:n.lastOffline.aiLevel||"None"}:{mode:"X01",x01Start:501,firstTo:1,aiLevel:"None"},reducedMotion:!!n.reducedMotion,compactHeader:!!n.compactHeader,allowSpectate:typeof n.allowSpectate=="boolean"?n.allowSpectate:!0,cameraScale:typeof n.cameraScale=="number"&&isFinite(n.cameraScale)?Math.max(.5,Math.min(1.25,n.cameraScale)):1,cameraAspect:n.cameraAspect==="square"?"square":"wide",cameraFitMode:n.cameraFitMode==="fit"||n.cameraFitMode==="fill"?n.cameraFitMode:"fit",calibrationUseRansac:typeof n.calibrationUseRansac=="boolean"?n.calibrationUseRansac:!0,autoscoreProvider:(()=>{const s=n.autoscoreProvider==="external-ws"?"external-ws":n.autoscoreProvider==="manual"?"manual":n.autoscoreProvider==="built-in-v2"?"built-in-v2":"built-in";return"manual"})(),autoscoreWsUrl:typeof n.autoscoreWsUrl=="string"?n.autoscoreWsUrl:"",autoCommitMode:n.autoCommitMode==="immediate"?"immediate":"wait-for-clear",confirmUncertainDarts:typeof n.confirmUncertainDarts=="boolean"?n.confirmUncertainDarts:!1,autoScoreConfidenceThreshold:typeof n.autoScoreConfidenceThreshold=="number"&&isFinite(n.autoScoreConfidenceThreshold)?Math.max(.5,Math.min(.99,n.autoScoreConfidenceThreshold)):.82,autoscoreDetectorMinArea:typeof n.autoscoreDetectorMinArea=="number"&&isFinite(n.autoscoreDetectorMinArea)?Math.max(5,Math.min(500,Math.round(n.autoscoreDetectorMinArea))):30,autoscoreDetectorThresh:typeof n.autoscoreDetectorThresh=="number"&&isFinite(n.autoscoreDetectorThresh)?Math.max(5,Math.min(60,Math.round(n.autoscoreDetectorThresh))):15,autoscoreDetectorRequireStableN:typeof n.autoscoreDetectorRequireStableN=="number"&&isFinite(n.autoscoreDetectorRequireStableN)?Math.max(1,Math.min(10,Math.round(n.autoscoreDetectorRequireStableN))):2,harshLightingMode:typeof n.harshLightingMode=="boolean"?n.harshLightingMode:!1,enhanceBigTrebles:typeof n.enhanceBigTrebles=="boolean"?n.enhanceBigTrebles:!1,allowAutocommitInOnline:!!n.allowAutocommitInOnline,calibrationGuide:typeof n.calibrationGuide=="boolean"?n.calibrationGuide:!0,preferredCameraId:typeof n.preferredCameraId=="string"?n.preferredCameraId:void 0,preserveCalibrationOverlay:typeof n.preserveCalibrationOverlay=="boolean"?n.preserveCalibrationOverlay:!0,preserveCalibrationOnCameraChange:typeof n.preserveCalibrationOnCameraChange=="boolean"?n.preserveCalibrationOnCameraChange:!0,preferredCameraLabel:typeof n.preferredCameraLabel=="string"?n.preferredCameraLabel:void 0,preferredCameraLocked:typeof n.preferredCameraLocked=="boolean"?n.preferredCameraLocked:!1,cameraEnabled:typeof n.cameraEnabled=="boolean"?n.cameraEnabled:!0,hideCameraOverlay:typeof n.hideCameraOverlay=="boolean"?n.hideCameraOverlay:!1,offlineLayout:n.offlineLayout==="classic"?"classic":"modern",hideInGameSidebar:typeof n.hideInGameSidebar=="boolean"?n.hideInGameSidebar:!0,textSize:n.textSize==="small"||n.textSize==="large"?n.textSize:"medium",boxSize:n.boxSize==="small"||n.boxSize==="large"?n.boxSize:"medium",matchType:n.matchType==="doubles"?"doubles":"singles",teamAName:typeof n.teamAName=="string"?n.teamAName:"Team A",teamBName:typeof n.teamBName=="string"?n.teamBName:"Team B",dartTimerEnabled:typeof n.dartTimerEnabled=="boolean"?n.dartTimerEnabled:!1,dartTimerSeconds:typeof n.dartTimerSeconds=="number"&&isFinite(n.dartTimerSeconds)?Math.max(3,Math.min(60,n.dartTimerSeconds)):10,x01DoubleIn:typeof n.x01DoubleIn=="boolean"?n.x01DoubleIn:!1,cameraRecordDarts:typeof n.cameraRecordDarts=="boolean"?n.cameraRecordDarts:!0,cameraShowLabels:typeof n.cameraShowLabels=="boolean"?n.cameraShowLabels:!1}}catch{return{favoriteDouble:"D16",callerEnabled:!0,callerVoice:"",callerVolume:1,speakCheckoutOnly:!1,avgMode:"all-time",autoStartOffline:!1,rememberLastOffline:!0,lastOffline:{mode:"X01",x01Start:501,firstTo:1,aiLevel:"None"},reducedMotion:!1,compactHeader:!1,allowSpectate:!0,cameraScale:1,cameraAspect:"wide",cameraFitMode:"fit",calibrationGuide:!0,calibrationUseRansac:!0,preferredCameraId:void 0,preferredCameraLabel:void 0,preferredCameraLocked:!1,preserveCalibrationOverlay:!0,preserveCalibrationOnCameraChange:!0,cameraEnabled:!0,hideCameraOverlay:!1,offlineLayout:"modern",hideInGameSidebar:!0,autoscoreProvider:"built-in",autoscoreWsUrl:"",autoCommitMode:"immediate",confirmUncertainDarts:!1,autoScoreConfidenceThreshold:.82,harshLightingMode:!1,enhanceBigTrebles:!1,textSize:"medium",boxSize:"medium",matchType:"singles",teamAName:"Team A",teamBName:"Team B",dartTimerEnabled:!1,dartTimerSeconds:10,x01DoubleIn:!1}}}function ze(t){try{const n=Ta();localStorage.setItem(Ea,JSON.stringify({...n,...t}))}catch{}}const ve=mr((t,n)=>({...Ta(),setFavoriteDouble:r=>{ze({favoriteDouble:r}),t({favoriteDouble:r})},setCallerEnabled:r=>{ze({callerEnabled:r}),t({callerEnabled:r})},setCallerVoice:r=>{ze({callerVoice:r}),t({callerVoice:r})},setAvgMode:r=>{ze({avgMode:r}),t({avgMode:r})},setCallerVolume:r=>{const s=Math.max(0,Math.min(1,r));ze({callerVolume:s}),t({callerVolume:s})},setSpeakCheckoutOnly:r=>{ze({speakCheckoutOnly:r}),t({speakCheckoutOnly:r})},setAutoStartOffline:r=>{ze({autoStartOffline:r}),t({autoStartOffline:r})},setRememberLastOffline:r=>{ze({rememberLastOffline:r}),t({rememberLastOffline:r})},setLastOffline:r=>{const a={...Ta().lastOffline,...r};ze({lastOffline:a}),t({lastOffline:a})},setReducedMotion:r=>{ze({reducedMotion:r}),t({reducedMotion:r})},setCompactHeader:r=>{ze({compactHeader:r}),t({compactHeader:r})},setAllowSpectate:r=>{ze({allowSpectate:r}),t({allowSpectate:r})},ignorePreferredCameraSync:!1,setIgnorePreferredCameraSync:r=>{ze({}),t({ignorePreferredCameraSync:r})},setCameraScale:r=>{const s=Math.max(.5,Math.min(2,r));ze({cameraScale:s}),t({cameraScale:s})},setCameraAspect:r=>{const s=r==="square"?"square":"wide";ze({cameraAspect:s}),t({cameraAspect:s})},setCameraFitMode:r=>{const s=r==="fit"?"fit":"fill";ze({cameraFitMode:s}),t({cameraFitMode:s})},setAutoscoreProvider:r=>{const s="manual";ze({autoscoreProvider:s}),t({autoscoreProvider:s})},setAutoscoreWsUrl:r=>{ze({autoscoreWsUrl:r}),t({autoscoreWsUrl:r})},setAutoCommitMode:r=>{const s=r==="immediate"?"immediate":"wait-for-clear";ze({autoCommitMode:s}),t({autoCommitMode:s})},setConfirmUncertainDarts:r=>{const s=!!r;ze({confirmUncertainDarts:s}),t({confirmUncertainDarts:s})},setAutoScoreConfidenceThreshold:r=>{const s=typeof r=="number"&&isFinite(r)?Math.max(.5,Math.min(.99,r)):.85;ze({autoScoreConfidenceThreshold:s}),t({autoScoreConfidenceThreshold:s})},setAutoscoreDetectorMinArea:r=>{const s=typeof r=="number"&&isFinite(r)?Math.max(5,Math.min(500,Math.round(r))):30;ze({autoscoreDetectorMinArea:s}),t({autoscoreDetectorMinArea:s})},setAutoscoreDetectorThresh:r=>{const s=typeof r=="number"&&isFinite(r)?Math.max(5,Math.min(60,Math.round(r))):15;ze({autoscoreDetectorThresh:s}),t({autoscoreDetectorThresh:s})},setAutoscoreDetectorRequireStableN:r=>{const s=typeof r=="number"&&isFinite(r)?Math.max(1,Math.min(10,Math.round(r))):2;ze({autoscoreDetectorRequireStableN:s}),t({autoscoreDetectorRequireStableN:s})},setHarshLightingMode:r=>{const s=!!r;ze({harshLightingMode:s}),t({harshLightingMode:s})},setEnhanceBigTrebles:r=>{const s=!!r;ze({enhanceBigTrebles:s}),t({enhanceBigTrebles:s})},setAllowAutocommitInOnline:r=>{ze({allowAutocommitInOnline:r}),t({allowAutocommitInOnline:r})},setCalibrationGuide:r=>{ze({calibrationGuide:r}),t({calibrationGuide:r})},setCalibrationUseRansac:r=>{ze({calibrationUseRansac:r}),t({calibrationUseRansac:r})},setPreserveCalibrationOverlay:r=>{ze({preserveCalibrationOverlay:r}),t({preserveCalibrationOverlay:r})},setPreserveCalibrationOnCameraChange:r=>{ze({preserveCalibrationOnCameraChange:r}),t({preserveCalibrationOnCameraChange:!!r})},setPreferredCamera:(r,s,a=!1)=>{try{if(n().preferredCameraLocked&&!a){console.log("[USERSETTINGS] Camera selection locked and force=false, ignoring update");return}}catch{}try{const o=n();if(o.preferredCameraId===r&&o.preferredCameraLabel===s)return}catch{}ze({preferredCameraId:r,preferredCameraLabel:s}),t({preferredCameraId:r,preferredCameraLabel:s})},setPreferredCameraLocked:r=>{try{if(n().ignorePreferredCameraSync&&r===!0){console.debug("[USERSETTINGS] Ignoring auto-lock due to ignorePreferredCameraSync");return}}catch{}ze({preferredCameraLocked:r}),t({preferredCameraLocked:r})},setCameraEnabled:r=>{ze({cameraEnabled:r}),t({cameraEnabled:r})},setHideCameraOverlay:r=>{ze({hideCameraOverlay:r}),t({hideCameraOverlay:r})},setCameraShowLabels:r=>{ze({cameraShowLabels:r}),t({cameraShowLabels:!!r})},setCameraRecordDarts:r=>{const s=!!r;ze({cameraRecordDarts:s}),t({cameraRecordDarts:s})},setCameraLowLatency:r=>{const s=!!r;ze({cameraLowLatency:s}),t({cameraLowLatency:s})},setCameraProcessingFps:r=>{const s=Math.max(5,Math.min(30,Math.round(r)));ze({cameraProcessingFps:s}),t({cameraProcessingFps:s})},setOfflineLayout:r=>{ze({offlineLayout:r}),t({offlineLayout:r})},setHideInGameSidebar:r=>{ze({hideInGameSidebar:r}),t({hideInGameSidebar:r})},setTextSize:r=>{ze({textSize:r}),t({textSize:r})},setBoxSize:r=>{ze({boxSize:r}),t({boxSize:r})},setMatchType:r=>{const s=r==="doubles"?"doubles":"singles";ze({matchType:s}),t({matchType:s})},setTeamAName:r=>{const s=r?.trim()||"Team A";ze({teamAName:s}),t({teamAName:s})},setTeamBName:r=>{const s=r?.trim()||"Team B";ze({teamBName:s}),t({teamBName:s})},setDartTimerEnabled:r=>{ze({dartTimerEnabled:r}),t({dartTimerEnabled:r})},setDartTimerSeconds:r=>{const s=Math.max(3,Math.min(60,Math.round(r)));ze({dartTimerSeconds:s}),t({dartTimerSeconds:s})},setX01DoubleIn:r=>{ze({x01DoubleIn:r}),t({x01DoubleIn:r})}}));function Ya(t){if(t==null||Number.isNaN(t)||t<0)return null;let n;t<=.25?n=99.5+(.25-t)*2:t<=1?n=98+(1-t)*2:t<=2?n=95+(2-t)*3:t<=5?n=90+(5-t)*1.66:n=Math.max(0,90-(t-5)*5);const r=Math.max(0,Math.min(100,n));return Number(r.toFixed(1))}const Rd={X01:{tolerancePx:10,requiredTargets:["SINGLE","DOUBLE","TREBLE","BULL","OUTER_BULL"],criticalZones:["D20","D1","BULLSEYE","T20","SINGLE_20"],minConfidence:80},"Double Practice":{tolerancePx:12,requiredTargets:["DOUBLE","BULL"],criticalZones:["D20","D1","D6","D17"],minConfidence:75},"Treble Practice":{tolerancePx:8,requiredTargets:["TREBLE"],criticalZones:["T20","T1","T5"],minConfidence:85},"Checkout 170":{tolerancePx:9,requiredTargets:["DOUBLE"],criticalZones:["D25","D20","D8"],minConfidence:82},"Checkout 121":{tolerancePx:9,requiredTargets:["DOUBLE"],criticalZones:["D20","D5","D1"],minConfidence:82},Cricket:{tolerancePx:15,requiredTargets:["20","19","18","17","16","15","BULL"],criticalZones:["20","15","BULL"],minConfidence:70},"American Cricket":{tolerancePx:15,requiredTargets:["20","19","18","17","16","15","BULL"],criticalZones:["20","15","BULL"],minConfidence:70},"Around the Clock":{tolerancePx:12,requiredTargets:["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20"],criticalZones:["1","20","6","15"],minConfidence:78},Shanghai:{tolerancePx:13,requiredTargets:["1","2","3","4","5","6","7","SINGLE","DOUBLE","TREBLE"],criticalZones:["1","7","S1","D1","T1"],minConfidence:75},"High Score":{tolerancePx:14,requiredTargets:["TREBLE","DOUBLE","BULL"],criticalZones:["T20","BULL","D20"],minConfidence:72},"Low Score":{tolerancePx:11,requiredTargets:["SINGLE"],criticalZones:["1","2","3"],minConfidence:76},"Count-Up":{tolerancePx:13,requiredTargets:["SINGLE","DOUBLE","TREBLE"],criticalZones:["20","DOUBLE","TREBLE"],minConfidence:74},"Halve It":{tolerancePx:12,requiredTargets:["TREBLE","SINGLE"],criticalZones:["T20","T5","SINGLE"],minConfidence:73},"High-Low":{tolerancePx:13,requiredTargets:["SINGLE","DOUBLE","BULL"],criticalZones:["HIGH (>10)","LOW (<5)","BULL"],minConfidence:72},Killer:{tolerancePx:12,requiredTargets:["ALL_NUMBERS"],criticalZones:["RANDOM_TARGETS"],minConfidence:74},Baseball:{tolerancePx:14,requiredTargets:["1-9","SINGLE","DOUBLE","TREBLE"],criticalZones:["1","9","TRIPLE"],minConfidence:71},Golf:{tolerancePx:14,requiredTargets:["1-18","TREBLE"],criticalZones:["T1","T18"],minConfidence:71},"Tic Tac Toe":{tolerancePx:16,requiredTargets:["1-9","SINGLE"],criticalZones:["CENTER","CORNERS"],minConfidence:68},"Bob's 27":{tolerancePx:13,requiredTargets:["SINGLE","DOUBLE"],criticalZones:["1-20","BULL"],minConfidence:73},Scam:{tolerancePx:14,requiredTargets:["ALL_NUMBERS","OUTER_BULL"],criticalZones:["TARGET_NUMBER","OUTER_BULL"],minConfidence:70},Fives:{tolerancePx:14,requiredTargets:["ALL_NUMBERS","OUTER_BULL"],criticalZones:["5","10","15","20"],minConfidence:70},Sevens:{tolerancePx:14,requiredTargets:["ALL_NUMBERS","OUTER_BULL"],criticalZones:["7","14"],minConfidence:70}};function Fi(t,n){if(n==null||Number.isNaN(n)||n<0)return 0;const s=Rd[t]?.tolerancePx??12;if(n<=.25)return 99.5+(.25-n)*2;if(n<=1)return 98+(1-n)*2;if(n<=2)return 95+(2-n)*3;if(n<=5)return 90+(5-n)*1.66;if(n<=s){const a=s-5;return a<=0?85:85+(s-n)/a*5}else{const a=s*3;return n>=a?0:85*(1-(n-s)/(a-s))}}function Ld(t,n){if(n==null||Number.isNaN(n)||n<0)return{quality:"none",text:"Camera not connected"};const r=Fi(t,n);return r>=99.5?{quality:"perfect",text:`Perfect (${r.toFixed(1)}%)`}:r>=90?{quality:"excellent",text:`Excellent (${Math.round(r)}%)`}:r>=75?{quality:"good",text:`Good (${Math.round(r)}%)`}:r>=50?{quality:"fair",text:`Fair (${Math.round(r)}%)`}:{quality:"poor",text:`Poor (${Math.round(r)}%)`}}const En=mr()((t,n)=>({H:null,createdAt:null,errorPx:null,confidence:null,imageSize:null,overlaySize:null,anchors:null,theta:null,rotationOffsetRad:0,sectorOffset:0,cameraId:null,locked:!1,_hydrated:!0,setCalibration:r=>t(s=>{try{if(ve.getState().preserveCalibrationOnCameraChange&&s.locked&&r.cameraId&&r.cameraId!==s.cameraId)return console.info("[CALIBRATION] preserveCalibrationOnCameraChange enabled and camera change detected; ignoring auto-update"),s}catch{}const a={...s,...r};if(typeof r.errorPx=="number"&&(typeof r.confidence!="number"||r.confidence==null))try{a.confidence=Ya(r.errorPx)}catch{}return a}),reset:()=>t({H:null,createdAt:null,errorPx:null,confidence:null,imageSize:null,overlaySize:null,anchors:null,theta:null,rotationOffsetRad:0,sectorOffset:0,cameraId:null,locked:!1})})),_d={};function Ui(t,n){let r;try{r=t()}catch{return}return{getItem:a=>{var o;const c=b=>b===null?null:JSON.parse(b,void 0),l=(o=r.getItem(a))!=null?o:null;return l instanceof Promise?l.then(c):c(l)},setItem:(a,o)=>r.setItem(a,JSON.stringify(o,void 0)),removeItem:a=>r.removeItem(a)}}const us=t=>n=>{try{const r=t(n);return r instanceof Promise?r:{then(s){return us(s)(r)},catch(s){return this}}}catch(r){return{then(s){return this},catch(s){return us(s)(r)}}}},Fd=(t,n)=>(r,s,a)=>{let o={getStorage:()=>localStorage,serialize:JSON.stringify,deserialize:JSON.parse,partialize:x=>x,version:0,merge:(x,w)=>({...w,...x}),...n},c=!1;const l=new Set,b=new Set;let u;try{u=o.getStorage()}catch{}if(!u)return t((...x)=>{console.warn(`[zustand persist middleware] Unable to update item '${o.name}', the given storage is currently unavailable.`),r(...x)},s,a);const f=us(o.serialize),g=()=>{const x=o.partialize({...s()});let w;const C=f({state:x,version:o.version}).then($=>u.setItem(o.name,$)).catch($=>{w=$});if(w)throw w;return C},m=a.setState;a.setState=(x,w)=>{m(x,w),g()};const A=t((...x)=>{r(...x),g()},s,a);let k;const S=()=>{var x;if(!u)return;c=!1,l.forEach(C=>C(s()));const w=((x=o.onRehydrateStorage)==null?void 0:x.call(o,s()))||void 0;return us(u.getItem.bind(u))(o.name).then(C=>{if(C)return o.deserialize(C)}).then(C=>{if(C)if(typeof C.version=="number"&&C.version!==o.version){if(o.migrate)return o.migrate(C.state,C.version);console.error("State loaded from storage couldn't be migrated since no migrate function was provided")}else return C.state}).then(C=>{var $;return k=o.merge(C,($=s())!=null?$:A),r(k,!0),g()}).then(()=>{w?.(k,void 0),c=!0,b.forEach(C=>C(k))}).catch(C=>{w?.(void 0,C)})};return a.persist={setOptions:x=>{o={...o,...x},x.getStorage&&(u=x.getStorage())},clearStorage:()=>{u?.removeItem(o.name)},getOptions:()=>o,rehydrate:()=>S(),hasHydrated:()=>c,onHydrate:x=>(l.add(x),()=>{l.delete(x)}),onFinishHydration:x=>(b.add(x),()=>{b.delete(x)})},S(),k||A},Ud=(t,n)=>(r,s,a)=>{let o={storage:Ui(()=>localStorage),partialize:S=>S,version:0,merge:(S,x)=>({...x,...S}),...n},c=!1;const l=new Set,b=new Set;let u=o.storage;if(!u)return t((...S)=>{console.warn(`[zustand persist middleware] Unable to update item '${o.name}', the given storage is currently unavailable.`),r(...S)},s,a);const f=()=>{const S=o.partialize({...s()});return u.setItem(o.name,{state:S,version:o.version})},g=a.setState;a.setState=(S,x)=>{g(S,x),f()};const m=t((...S)=>{r(...S),f()},s,a);a.getInitialState=()=>m;let A;const k=()=>{var S,x;if(!u)return;c=!1,l.forEach(C=>{var $;return C(($=s())!=null?$:m)});const w=((x=o.onRehydrateStorage)==null?void 0:x.call(o,(S=s())!=null?S:m))||void 0;return us(u.getItem.bind(u))(o.name).then(C=>{if(C)if(typeof C.version=="number"&&C.version!==o.version){if(o.migrate)return[!0,o.migrate(C.state,C.version)];console.error("State loaded from storage couldn't be migrated since no migrate function was provided")}else return[!1,C.state];return[!1,void 0]}).then(C=>{var $;const[j,T]=C;if(A=o.merge(T,($=s())!=null?$:m),r(A,!0),j)return f()}).then(()=>{w?.(A,void 0),A=s(),c=!0,b.forEach(C=>C(A))}).catch(C=>{w?.(void 0,C)})};return a.persist={setOptions:S=>{o={...o,...S},S.storage&&(u=S.storage)},clearStorage:()=>{u?.removeItem(o.name)},getOptions:()=>o,rehydrate:()=>k(),hasHydrated:()=>c,onHydrate:S=>(l.add(S),()=>{l.delete(S)}),onFinishHydration:S=>(b.add(S),()=>{b.delete(S)})},o.skipHydration||k(),A||m},$d=(t,n)=>"getStorage"in n||"serialize"in n||"deserialize"in n?((_d?"production":void 0)!=="production"&&console.warn("[DEPRECATED] `getStorage`, `serialize` and `deserialize` options are deprecated. Use `storage` option instead."),Fd(t,n)):Ud(t,n),Bd=$d;let or=null,Es=null,da=null,ua=null,Zr=0,Lr=null,ir=null;const Vd=200,er=mr()(Bd(t=>({isStreaming:!1,mode:"local",pairingCode:null,expiresAt:null,isPaired:!1,mobileUrl:null,showOverlay:!0,isStarting:!1,setStreaming:n=>{t({isStreaming:n}),n&&t({isStarting:!1})},setStarting:n=>{t({isStarting:n})},setMode:n=>{t({mode:n})},setPairingCode:n=>t({pairingCode:n}),setExpiresAt:n=>t({expiresAt:n}),setPaired:n=>t({isPaired:n}),setMobileUrl:n=>t({mobileUrl:n}),setShowOverlay:n=>t({showOverlay:!!n}),setMediaStream:n=>{!n&&Zr>0||(Es=n)},getMediaStream:()=>{if(Es)return Es;try{const r=or?.srcObject||null;if(r)return r}catch{}return null},setPcRef:n=>{da=n},getPcRef:()=>da,setWsRef:n=>{ua=n},getWsRef:()=>ua,getVideoElementRef:()=>or,setVideoElementRef:n=>{try{if(n===null){ir&&(clearTimeout(ir),ir=null,Lr=null),nt("[cameraSession] ðŸ›‘ setVideoElementRef called - clearing ref"),or=null;return}if(!or){nt("[cameraSession] âœ“ setVideoElementRef called - storing HTMLVideoElement",{tagName:n.tagName,hasStream:!!n.srcObject}),or=n;return}if(or===n)return;ir&&(clearTimeout(ir),ir=null),Lr=n,ir=window.setTimeout(()=>{try{nt("[cameraSession] (deferred) setVideoElementRef applying pending ref",{tagName:Lr?.tagName,hasStream:!!Lr?.srcObject}),or=Lr}catch(r){nt("[cameraSession] Failed to apply pending video ref:",r)}finally{Lr=null,ir=null}},Vd)}catch{}},acquireKeepAlive:n=>{Zr+=1},releaseKeepAlive:n=>{Zr=Math.max(0,Zr-1)},clearSession:()=>{Zr===0&&(or=null,Es=null),da=null,ua=null,t({isStreaming:!1,pairingCode:null,expiresAt:null,isPaired:!1,mobileUrl:null})}}),{name:"ndn-camera-session",storage:Ui(()=>localStorage),partialize:t=>({isStreaming:t.isStreaming,mode:t.mode,pairingCode:t.pairingCode,expiresAt:t.expiresAt,isPaired:t.isPaired,mobileUrl:t.mobileUrl,showOverlay:t.showOverlay})})),Ne={bullInner:6.35,bullOuter:15.9,trebleInner:99,trebleOuter:107,doubleInner:162,doubleOuter:170},Ts=Ne,lr=[20,1,18,4,13,6,10,15,2,17,3,19,7,16,8,11,14,9,12,5];function Ka(t,n){const r=new Array(9).fill(0);for(let s=0;s<3;s++)for(let a=0;a<3;a++)for(let o=0;o<3;o++)r[s*3+a]+=t[s*3+o]*n[o*3+a];return r}function Cn(t,n){const r=n.x,s=n.y,a=t[6]*r+t[7]*s+t[8],o=(t[0]*r+t[1]*s+t[2])/a,c=(t[3]*r+t[4]*s+t[5])/a;return{x:o,y:c}}function Fs(t,n,r){return[n*t[0],n*t[1],n*t[2],r*t[3],r*t[4],r*t[5],t[6],t[7],t[8]]}function Wd(t,n){const r=Math.cos(n),s=Math.sin(n),a=[r,-s,0,s,r,0,0,0,1];return Ka(t,a)}function $i(t,n,r){return Ka([1,0,n,0,1,r,0,0,1],t)}function zd(t){const n=t,r=n[0],s=n[1],a=n[2],o=n[3],c=n[4],l=n[5],b=n[6],u=n[7],f=n[8],g=c*f-l*u,m=a*u-s*f,A=s*l-a*c,k=l*b-o*f,S=r*f-a*b,x=a*o-r*l,w=o*u-c*b,C=s*b-r*u,$=r*c-s*o,j=r*g+s*k+a*w;if(Math.abs(j)<1e-12)throw new Error("Singular homography");return[g/j,m/j,A/j,k/j,S/j,x/j,w/j,C/j,$/j]}function qn(t,n){if(t.length<4||n.length<4)throw new Error("Need at least 4 correspondences");if(t.length!==n.length)throw new Error("Correspondences must have equal length");const r=[],s=[];for(let c=0;c<t.length;c++){const{x:l,y:b}=t[c],{x:u,y:f}=n[c];r.push([l,b,1,0,0,0,-u*l,-u*b]),s.push(u),r.push([0,0,0,l,b,1,-f*l,-f*b]),s.push(f)}const a=Hd(r,s);return[a[0],a[1],a[2],a[3],a[4],a[5],a[6],a[7],1]}function Hd(t,n){const r=t.length,s=t[0].length,a=Array.from({length:s},()=>new Array(s).fill(0)),o=new Array(s).fill(0);for(let c=0;c<r;c++)for(let l=0;l<s;l++){o[l]+=t[c][l]*n[c];for(let b=0;b<s;b++)a[l][b]+=t[c][l]*t[c][b]}return qd(a,o)}function qd(t,n){const r=n.length,s=t.map((o,c)=>o.concat([n[c]]));for(let o=0;o<r;o++){let c=o;for(let l=o+1;l<r;l++)Math.abs(s[l][o])>Math.abs(s[c][o])&&(c=l);if(Math.abs(s[c][o])<1e-12)throw new Error("Singular matrix");if(c!==o){const l=s[o];s[o]=s[c],s[c]=l}for(let l=o+1;l<r;l++){const b=s[l][o]/s[o][o];for(let u=o;u<=r;u++)s[l][u]-=b*s[o][u]}}const a=new Array(r).fill(0);for(let o=r-1;o>=0;o--){let c=s[o][r];for(let l=o+1;l<r;l++)c-=s[o][l]*a[l];a[o]=c/s[o][o]}return a}function _n(t="center"){const n=(Ne.doubleInner+Ne.doubleOuter)/2,s=[20,6,3,11].map(a=>{const c=lr.indexOf(a)/lr.length*Math.PI*2-Math.PI/2,l=n*Math.cos(c),b=n*Math.sin(c);return{x:Math.abs(l)<1e-9?0:l,y:Math.abs(b)<1e-9?0:b}});return s.push({x:0,y:0}),s}function es(t,n,r=256){const s=[];for(let a=0;a<r;a++){const o=a/r*Math.PI*2,c=Cn(t,{x:n*Math.cos(o),y:n*Math.sin(o)});s.push(c)}return s}function Fo(t,n="outer"){const r=Cn(t,{x:0,y:0}),a={x:0,y:-(n==="outer"?Ne.doubleOuter:(Ne.doubleInner+Ne.doubleOuter)/2)},o=Cn(t,a),c=o.x-r.x,l=o.y-r.y;let b=Math.atan2(l,c)*180/Math.PI;b=(b+360)%360;let f=b-270;return f=(f+180)%360-180,(Math.round(f/18)%20+20)%20}function Gn(t,n,r){let s=0;for(let a=0;a<n.length;a++){const o=Cn(t,n[a]),c=o.x-r[a].x,l=o.y-r[a].y;s+=c*c+l*l}return Math.sqrt(s/n.length)}function Gd(t,n,r={}){const s=t.length;if(s<4||n.length<4)throw new Error("Need at least 4 correspondences");const a=r.thresholdPx??8,o=r.maxIter??500,c=r.minInliers??4,l=r.rng??Math.random;let b=null,u=new Array(s).fill(!1),f=0,g=1/0;for(let S=0;S<o;S++){const x=new Set;for(;x.size<4;)x.add(Math.floor(l()*s));const w=Array.from(x),C=[],$=[];for(const U of w)C.push(t[U]),$.push(n[U]);let j;try{j=qn(C,$)}catch{continue}const T=new Array(s).fill(!1);let M=0;for(let U=0;U<s;U++){const te=Cn(j,t[U]),ie=te.x-n[U].x,ae=te.y-n[U].y;Math.hypot(ie,ae)<=a&&(T[U]=!0,M++)}if(M<c)continue;const N=[],P=[];for(let U=0;U<s;U++)T[U]&&(N.push(t[U]),P.push(n[U]));let L;try{L=qn(N,P)}catch{continue}const V=Gn(L,N,P);(M>f||M===f&&V<g)&&(f=M,g=V,b=L,u=T.slice())}if(!b||f<c)return{H:null,inliers:new Array(s).fill(!1),errorPx:null};const m=[],A=[];for(let S=0;S<s;S++)u[S]&&(m.push(t[S]),A.push(n[S]));const k=m.length>0?Gn(b,m,A):null;return{H:b,inliers:u,errorPx:k}}function Zn(t,n){try{const r=zd(t),s=Cn(r,n);return!isFinite(s.x)||!isFinite(s.y)?null:s}catch{return null}}function Jd(t){const n=Math.hypot(t.x,t.y);let s=Math.atan2(t.y,t.x)*180/Math.PI;s=(s+360+90)%360;const a=Math.floor((s+9)%360/18),o=lr[a],{bullInner:c,bullOuter:l,trebleInner:b,trebleOuter:u,doubleInner:f,doubleOuter:g}=Ne,m=.75;return n>g+m?{base:0,ring:"MISS",sector:null,mult:0}:n>=f-m?{base:o*2,ring:"DOUBLE",sector:o,mult:2}:n>u+m?{base:o,ring:"SINGLE",sector:o,mult:1}:n>=b-m?{base:o*3,ring:"TRIPLE",sector:o,mult:3}:n>l+m?{base:o,ring:"SINGLE",sector:o,mult:1}:n>c+.5?{base:25,ring:"BULL",sector:25,mult:1}:{base:50,ring:"INNER_BULL",sector:25,mult:2}}function wr(t,n,r=0,s=0){const a=Math.hypot(t.x,t.y);let c=(Math.atan2(t.y,t.x)+(Number.isFinite(n)?n:0)+(Number.isFinite(s)?s:0))*180/Math.PI;c=(c+360+90)%360;const b=((Math.floor((c+9)%360/18)+(Number.isFinite(r)?r:0))%20+20)%20,u=lr[b],{bullInner:f,bullOuter:g,trebleInner:m,trebleOuter:A,doubleInner:k,doubleOuter:S}=Ne,x=.75;return a>S+x?{base:0,ring:"MISS",sector:null,mult:0}:a>=k-x?{base:u*2,ring:"DOUBLE",sector:u,mult:2}:a>A+x?{base:u,ring:"SINGLE",sector:u,mult:1}:a>=m-x?{base:u*3,ring:"TRIPLE",sector:u,mult:3}:a>g+x?{base:u,ring:"SINGLE",sector:u,mult:1}:a>f+.5?{base:25,ring:"BULL",sector:25,mult:1}:{base:50,ring:"INNER_BULL",sector:25,mult:2}}function Ds(t,n,r="#10b981",s=2){if(n.length){t.save(),t.strokeStyle=r,t.lineWidth=s,t.beginPath(),t.moveTo(n[0].x,n[0].y);for(let a=1;a<n.length;a++)t.lineTo(n[a].x,n[a].y);t.closePath(),t.stroke(),t.restore()}}function Uo(t,n,r="#f59e0b"){t.save(),t.strokeStyle=r,t.lineWidth=2,t.beginPath(),t.moveTo(n.x-8,n.y),t.lineTo(n.x+8,n.y),t.moveTo(n.x,n.y-8),t.lineTo(n.x,n.y+8),t.stroke(),t.restore()}const Yd={top:99,right:154,bottom:241,left:85,bull:0};function Kd(t){const n=Array.from({length:7},()=>Array.from({length:7},()=>0)),r=[];for(let s=9;s>=0;s--)r.push(t>>s&1);for(let s=0;s<5;s++){const a=s+1,o=r[2*s]??0,c=r[2*s+1]??0;n[a][2]=o,n[a][4]=c}return n}function Xd(t){return{success:!1,homography:null}}const Qd=t=>!!t&&Number.isFinite(t.x)&&Number.isFinite(t.y),Zd=t=>Array.isArray(t)&&t.length===9&&t.every(Number.isFinite);function eu(t,n){const r=t.getContext("2d",{willReadFrequently:!0});if(!r)return null;const s=t.width,a=t.height,o=160,c=o/s,l=Math.floor(a*c),u=new OffscreenCanvas(o,l).getContext("2d",{willReadFrequently:!0});if(!u)return null;u.drawImage(t,0,0,o,l);const g=u.getImageData(0,0,o,l).data,m=new Float32Array(o*l),A=8;for(let H=1;H<l-1;H++)for(let I=1;I<o-1;I++){const B=(H*o+I)*4,de=B-4,K=B+4,le=B-o*4,we=B+o*4,He=g[de]*.299+g[de+1]*.587+g[de+2]*.114,Qe=g[K]*.299+g[K+1]*.587+g[K+2]*.114,tt=g[le]*.299+g[le+1]*.587+g[le+2]*.114,pt=g[we]*.299+g[we+1]*.587+g[we+2]*.114,st=Qe-He,E=pt-tt,J=Math.sqrt(st*st+E*E);if(J>A){const z=st/J,oe=E/J,je=o*.03,se=o*.6;for(let $e=je;$e<se;$e+=1){const jt=Math.round(I+z*$e),Mt=Math.round(H+oe*$e);jt>=0&&jt<o&&Mt>=0&&Mt<l&&m[Mt*o+jt]++;const Et=Math.round(I-z*$e),fe=Math.round(H-oe*$e);Et>=0&&Et<o&&fe>=0&&fe<l&&m[fe*o+Et]++}}}const k=new Float32Array(o*l),S=2;for(let H=S;H<l-S;H++)for(let I=S;I<o-S;I++){let B=0;for(let de=-S;de<=S;de++)for(let K=-S;K<=S;K++)B+=m[(H+de)*o+(I+K)];k[H*o+I]=B}let x=0,w=o/2,C=l/2;const $=5;for(let H=$;H<l-$;H++)for(let I=$;I<o-$;I++){const B=k[H*o+I];B>x&&(x=B,w=I,C=H)}let j=w/c,T=C/c;n&&Number.isFinite(n.x)&&Number.isFinite(n.y)&&(j=.7*n.x+.3*j,T=.7*n.y+.3*T),console.log(`[findDartboardRings] Voting Peak: (${Math.round(j)}, ${Math.round(T)}) Votes=${x}`);const M=400,N=M/s,P=Math.floor(a*N),V=new OffscreenCanvas(M,P).getContext("2d");if(!V)return null;V.drawImage(t,0,0,M,P);const U=V.getImageData(0,0,M,P).data,te=new Float32Array(M*P),ie=new Float32Array(M*P);for(let H=1;H<P-1;H++)for(let I=1;I<M-1;I++){const B=(H*M+I)*4;U[B]*.299+U[B+1]*.587+U[B+2]*.114;const de=B-4,K=B+4,le=B-M*4,we=B+M*4,He=U[de]*.299+U[de+1]*.587+U[de+2]*.114,Qe=U[K]*.299+U[K+1]*.587+U[K+2]*.114,tt=U[le]*.299+U[le+1]*.587+U[le+2]*.114,pt=U[we]*.299+U[we+1]*.587+U[we+2]*.114,st=Qe-He,E=pt-tt;te[H*M+I]=st,ie[H*M+I]=E}const ae=r.getImageData(0,0,s,a).data,q=(H,I)=>{const B=Math.max(0,Math.min(s-1,Math.round(H))),K=(Math.max(0,Math.min(a-1,Math.round(I)))*s+B)*4;return .299*ae[K]+.587*ae[K+1]+.114*ae[K+2]},G=60,ge={};for(let H=0;H<G;H++){const I=H/G*Math.PI*2,B=Math.cos(I),de=Math.sin(I),K=[];for(let we=30;we<Math.min(s,a)/2;we+=1){const He=j+(we-2)*B,Qe=T+(we-2)*de,tt=j+(we+2)*B,pt=T+(we+2)*de,st=q(He,Qe),E=q(tt,pt),J=Math.abs(E-st);J>2&&we>20&&K.push({r:we,grad:J})}const le=[];for(let we=0;we<K.length;we++){const He=we>0?K[we-1].grad:0,Qe=K[we].grad,tt=we<K.length-1?K[we+1].grad:0;Qe>He&&Qe>tt&&Qe>2&&le.push(K[we].r)}le.length>0&&le.forEach(we=>{const He=Object.keys(ge).map(tt=>({key:parseInt(tt),median:ge[parseInt(tt)][Math.floor(ge[parseInt(tt)].length/2)]})).filter(tt=>Math.abs(tt.median-we)<15).sort((tt,pt)=>Math.abs(tt.median-we)-Math.abs(pt.median-we))[0],Qe=He?He.key:Math.max(-1,...Object.keys(ge).map(tt=>parseInt(tt)))+1;ge[Qe]||(ge[Qe]=[]),ge[Qe].push(we)})}const Pe=Object.keys(ge).map(H=>{const I=ge[parseInt(H)].sort((de,K)=>de-K),B=I[Math.floor(I.length/2)];return{tier:parseInt(H),radius:B,samples:I.length}}).sort((H,I)=>H.radius-I.radius);console.log("[findDartboardRings] Detected ring tiers:",Pe);const ne=[...Pe];if(ne.length>=2){const H=ne[ne.length-1].radius,I=ne[ne.length-2].radius,B=H/I;(B>1.15&&ne.length>=5||B>1.3)&&(console.log(`[findDartboardRings] Ignoring outermost ring (likely light ring/surround): ${H.toFixed(1)}px (ratio ${B.toFixed(2)} to ${I.toFixed(1)}px)`),ne.pop())}const Ae=ne.length>0?ne[ne.length-1].radius:Math.min(s,a)*.3;let ce=50+ne.length*6;return ne.length>=7?ce=98:ne.length===6?ce=96:ne.length===5&&(ce=94),{cx:j,cy:T,r:Ae,confidence:ce,ringCount:ne.length,ringStrength:ne.length>0?ne[ne.length-1].radius:0,detectedRings:ne.map(H=>H.radius)}}function tu(t,n,r,s){const a=t.getContext("2d");if(!a)return null;const o=t.width,c=t.height,l=720,b=s,u=new Array(l).fill(0),f=Math.max(2,Math.round(b-8)),g=Math.round(b+8),m=a.getImageData(0,0,o,c).data,A=(M,N)=>{const P=Math.round(M),L=Math.round(N);if(P<0||P>=o||L<0||L>=c)return 127;const V=(L*o+P)*4;return m[V]*.299+m[V+1]*.587+m[V+2]*.114};for(let M=0;M<l;M++){const N=M/l*Math.PI*2;let P=0,L=A(n+f*Math.cos(N),r+f*Math.sin(N));for(let V=f+1;V<=g;V++){const U=A(n+V*Math.cos(N),r+V*Math.sin(N)),te=Math.abs(U-L);te>P&&(P=te),L=U}u[M]=P}const k=[];for(let M=0;M<l;M++){const N=u[(M-1+l)%l],P=u[M],L=u[(M+1)%l];P>N&&P>L&&P>10&&k.push(M)}if(k.length<16){const M=u.map((N,P)=>{let L=0,V=0;for(let U=-2;U<=2;U++)L+=u[(P+U+l)%l],V++;return L/V});for(let N=0;N<l;N++){const P=M[(N-1+l)%l],L=M[N],V=M[(N+1)%l];L>P&&L>V&&L>8&&k.push(N)}}if(k.length===0)return 0;const S=k.map(M=>M/l*Math.PI*2);S.sort((M,N)=>M-N);const x=[];for(let M=0;M<S.length;M++){const N=S[M],L=(S[(M+1)%S.length]-N+Math.PI*2)%(Math.PI*2);x.push((N+L/2)%(Math.PI*2))}const w=20,C=new Array(w).fill(0).map((M,N)=>-Math.PI/2+N*(Math.PI*2/w));let $=0,j=1/0;for(let M=0;M<x.length;M++){let N=0;for(let P=0;P<Math.min(w,x.length);P++){const L=x[(P+M)%x.length],V=C[P],U=Math.abs((L-V+Math.PI)%(Math.PI*2)-Math.PI);N+=U*U}N<j&&(j=N,$=(x[M]-C[0]+Math.PI*2)%(Math.PI*2))}return($+Math.PI)%(Math.PI*2)-Math.PI}function nu(t,n){const r=t.getContext("2d");if(!r)return n;const s=t.width,a=t.height,c=r.getImageData(0,0,s,a).data,l=(w,C)=>{const $=Math.max(0,Math.min(s-1,Math.round(w))),T=(Math.max(0,Math.min(a-1,Math.round(C)))*s+$)*4;return .299*c[T]+.587*c[T+1]+.114*c[T+2]},b=(w,C)=>{const $=l(w+1,C)-l(w-1,C),j=l(w,C+1)-l(w,C-1);return{gx:$,gy:j}},u=Cn(n,{x:0,y:0}),f=w=>{const C=[Ne.trebleOuter,Ne.doubleOuter];let $=0;for(const j of C){const T=es(w,j,180);for(let M=0;M<T.length;M++){const N=T[M],P=b(N.x,N.y),L=N.x-u.x,V=N.y-u.y,U=Math.hypot(L,V)||1,te=L/U,ie=V/U;$+=Math.abs(P.gx*te+P.gy*ie)}}return $/180/2};let g=n,m=f(n);const A=w=>w*Math.PI/180,k=[-4,-2,-1,-.5,0,.5,1,2,4],S=[-3,-2,-1,0,1,2,3],x=[.98,.99,1,1.01,1.02];for(const w of k){const C=Wd(n,A(w));for(const $ of S)for(const j of S){const T=$i(C,$,j);for(const M of x){const N=Fs(T,M,M),P=f(N);P>m&&(m=P,g=N)}}}return g}function _r(t,n){try{const r=t.width,s=t.height,a=r/2,o=s/2;let c=t;if(n?.colorAssist)try{const M=((U,te)=>{try{return new OffscreenCanvas(U,te)}catch{const ie=document.createElement("canvas");return ie.width=U,ie.height=te,ie}})(r,s),N=M.getContext("2d");if(!N)throw new Error("Could not get 2D context");N.drawImage(t,0,0,r,s);const P=N.getImageData(0,0,r,s),L=P.data,V=(U,te,ie)=>{const ae=U/255,q=te/255,G=ie/255,ge=Math.max(ae,q,G),Pe=Math.min(ae,q,G),ne=ge-Pe;let Ae=0;ne!==0&&(ge===ae?Ae=(q-G)/ne%6:ge===q?Ae=(G-ae)/ne+2:Ae=(ae-q)/ne+4,Ae*=60,Ae<0&&(Ae+=360));const ce=ge===0?0:ne/ge;return{h:Ae,s:ce,v:ge}};for(let U=0;U<L.length;U+=4){const te=L[U],ie=L[U+1],ae=L[U+2],{h:q,s:G,v:ge}=V(te,ie,ae),Pe=G>.25&&ge>.2&&(q<20||q>340||q>340&&q<=360),ne=G>.25&&ge>.2&&q>=80&&q<=160;Pe||ne?(L[U]=Math.min(255,te*1.2),L[U+1]=Math.min(255,ie*1.2),L[U+2]=Math.min(255,ae*1.2)):L[U]=L[U+1]=L[U+2]=0}N.putImageData(P,0,0),c=M}catch{c=t}const l=eu(c,n?.centerHint);if(!l)return{success:!1,cx:a,cy:o,bullInner:0,bullOuter:0,trebleInner:0,trebleOuter:0,doubleInner:0,doubleOuter:0,confidence:0,homography:null,errorPx:null,calibrationPoints:[],message:"No dartboard detected. Ensure board is clearly visible with good contrast between rings and background."};const b=(()=>{const T=l.detectedRings||[];if(T.length>=6)return{cx:l.cx,cy:l.cy,bullInner:T[0],bullOuter:T[1],trebleInner:T[2],trebleOuter:T[3],doubleInner:T[4],doubleOuter:T[5]};{const M=l.r/Ne.doubleOuter;return{cx:l.cx,cy:l.cy,bullInner:Ne.bullInner*M,bullOuter:Ne.bullOuter*M,trebleInner:Ne.trebleInner*M,trebleOuter:Ne.trebleOuter*M,doubleInner:Ne.doubleInner*M,doubleOuter:l.r}}})(),u=tu(t,b.cx,b.cy,b.doubleOuter)||0,f=_n("outer"),g=f.map(T=>{if(T.x===0&&T.y===0)return{x:b.cx,y:b.cy};const M=Math.cos(u),N=Math.sin(u),P=b.doubleOuter/Ne.doubleOuter,L=T.x*P,V=T.y*P;return{x:b.cx+(L*M-V*N),y:b.cy+(L*N+V*M)}});let m=null,A=null,k=l.confidence,S=1;try{let T=!0;try{T=!!ve.getState?.()?.calibrationUseRansac}catch{}if(T){const P=Gd(f,g,{thresholdPx:8,maxIter:300});P.H?(m=P.H,A=P.errorPx,S=P.inliers.filter(Boolean).length/g.length,k=Math.max(k,Math.round(k*.6+S*40))):(m=qn(f,g),A=Gn(m,f,g))}else m=qn(f,g),A=Gn(m,f,g);if(m&&(m=nu(t,m),A=Gn(m,f,g)),m){const P=Cn(m,{x:0,y:0}),L=b.cx-P.x,V=b.cy-P.y;Math.hypot(L,V)>.25&&(m=$i(m,L,V),A=Gn(m,f,g))}const N=Ya(typeof A=="number"?A:null);typeof N=="number"?k=N:k=Math.max(S*100,l.confidence)}catch{k=Math.max(65,l.confidence)}const x=g.every(Qd),w=Zd(m),C=!!w&&x&&k>50,$=l.ringCount??0,j={success:C,cx:b.cx,cy:b.cy,bullInner:b.bullInner,bullOuter:b.bullOuter,trebleInner:b.trebleInner,trebleOuter:b.trebleOuter,doubleInner:b.doubleInner,doubleOuter:b.doubleOuter,confidence:Math.round(k),homography:w?m:null,errorPx:w?A:null,calibrationPoints:x?g:[],theta:typeof u=="number"?u:void 0,message:!x||!w?`âŒ Detection produced unstable calibration data. Adjust camera framing or calibrate manually. (rings: ${$}, r:${Math.round(l.r)})`:k>85?`âœ… Excellent detection (rings: ${$}, r:${Math.round(l.r)})`:`âœ… Board detected - may need angle adjustment (rings: ${$}, r:${Math.round(l.r)})`};return console.log("[detectBoard] Final result:",{success:j.success,confidence:j.confidence,homographyValid:w,pointsValid:x,cx:Math.round(j.cx),cy:Math.round(j.cy),doubleOuter:Math.round(j.doubleOuter),rings:$,errorPx:j.errorPx?j.errorPx.toFixed(2):null,calibrationPoints:g.map(T=>({x:Math.round(T.x),y:Math.round(T.y)}))},j.message),j}catch(r){return{success:!1,cx:t.width/2,cy:t.height/2,bullInner:0,bullOuter:0,trebleInner:0,trebleOuter:0,doubleInner:0,doubleOuter:0,confidence:0,homography:null,errorPx:null,calibrationPoints:[],message:r instanceof Error?r.message:"Board detection failed"}}}async function ru(){const t=[];try{const n=await su();for(const r of n){const s=await ou(r,[80,8080,8787,8788,3e3,5e3]);for(const a of s){const o=await cu(a.ip,a.port);o&&t.push(o)}}}catch(n){console.error("Network discovery failed:",n)}return t}async function su(){const t=[];try{const n=new RTCPeerConnection({iceServers:[]});n.createDataChannel("");const r=await n.createOffer();return await n.setLocalDescription(r),new Promise(s=>{const a=setTimeout(()=>{n.close(),s(t)},5e3);n.onicecandidate=o=>{if(o.candidate){const l=o.candidate.candidate.match(/(\d+\.\d+\.\d+\.\d+)/);if(l&&l[1]&&!t.includes(l[1])){const b=l[1];au(b)&&t.push(b)}}else clearTimeout(a),n.close(),s(t)}})}catch(n){return console.error("Failed to get local IPs:",n),["192.168.1.0"]}}function au(t){const n=t.split(".").map(Number);return n[0]===10||n[0]===172&&n[1]>=16&&n[1]<=31||n[0]===192&&n[1]===168}async function ou(t,n){const r=[],s=t.split(".").slice(0,3).join("."),a=[];for(let c=1;c<=254;c++){const l=`${s}.${c}`;for(const b of n)a.push(iu(l,b))}return(await Promise.allSettled(a)).forEach((c,l)=>{if(c.status==="fulfilled"&&c.value){const b=l%n.length,u=Math.floor(l/n.length),f=`${s}.${u+1}`;r.push({ip:f,port:n[b]})}}),r}async function iu(t,n){try{return await fetch(`http://${t}:${n}/`,{method:"HEAD",mode:"no-cors",signal:AbortSignal.timeout(2e3)}),!0}catch{return!1}}async function cu(t,n){try{const r=["/","/api/info","/api/status","/camera","/stream"];for(const s of r)try{const a=await fetch(`http://${t}:${n}${s}`,{method:"GET",signal:AbortSignal.timeout(3e3)});if(a.ok){const o=a.headers.get("content-type")||"",c=await a.text();if(c.includes("OMNI")||c.includes("omni")||s.includes("omni"))return{id:`omni-${t}-${n}`,name:`OMNI Camera (${t})`,ip:t,port:n,type:"omni",capabilities:["video","calibration"],status:"online",connectionType:"wifi"};if(c.includes("VERT")||c.includes("vert")||s.includes("vert"))return{id:`vert-${t}-${n}`,name:`VERT Camera (${t})`,ip:t,port:n,type:"vert",capabilities:["video","calibration"],status:"online",connectionType:"wifi"};if(o.includes("video")||c.includes("stream")||s==="/stream")return{id:`generic-${t}-${n}`,name:`Network Camera (${t})`,ip:t,port:n,type:"generic",capabilities:["video"],status:"online",connectionType:"wifi"}}}catch{}}catch(r){console.error(`Failed to probe device ${t}:${n}:`,r)}return null}async function lu(t){try{const n=`http://${t.ip}:${t.port}/stream`,r=document.createElement("video");return r.src=n,r.crossOrigin="anonymous",new Promise((s,a)=>{r.onloadeddata=()=>{const o=document.createElement("canvas"),c=o.getContext("2d");o.width=r.videoWidth,o.height=r.videoHeight;const l=o.captureStream(30),b=()=>{r.readyState>=2&&c.drawImage(r,0,0),requestAnimationFrame(b)};b(),s(l)},r.onerror=()=>a(new Error("Failed to load video stream")),r.load()})}catch(n){return console.error("Failed to connect to network device:",n),null}}const $r=mr(t=>({recent:[],totals:{visits:0,darts:0,points:0,finishes:0,busts:0,byMode:{}},calibration:{hasHomography:!1,imageSize:null,lastUpdated:void 0},recordVisit:(n,r,s,a)=>t(o=>{const l={ts:Date.now(),mode:n,darts:r,visitTotal:s,preOpenDarts:a?.preOpenDarts,preRemaining:a?.preRemaining,postRemaining:a?.postRemaining,bust:a?.bust,finish:a?.finish,threeDartAvg:a?.threeDartAvg},b=[...o.recent,l].slice(-50),u={...o.totals};u.visits+=1,u.darts+=r,u.points+=s,l.finish&&(u.finishes+=1),l.bust&&(u.busts+=1);const f=u.byMode[n]||{visits:0,darts:0,points:0};f.visits+=1,f.darts+=r,f.points+=s,u.byMode[n]=f;try{const g=l.finish?"FINISH":l.bust?"BUST":"VISIT",m={mode:n,darts:r,visitTotal:s,preOpenDarts:l.preOpenDarts??0,preRemaining:l.preRemaining,postRemaining:l.postRemaining,threeDartAvg:l.threeDartAvg};Vs(`[Audit:${g}]`,m)}catch{}try{localStorage.setItem("ndn_audit_recent",JSON.stringify(b))}catch{}return{...o,recent:b,totals:u}}),setCalibrationStatus:n=>t(r=>{const s={hasHomography:n.hasHomography??r.calibration.hasHomography,imageSize:n.imageSize===void 0?r.calibration.imageSize:n.imageSize,lastUpdated:Date.now()};try{Vs("[Audit:Calibration]",s)}catch{}return{...r,calibration:s}}),reset:()=>t({recent:[],totals:{visits:0,darts:0,points:0,finishes:0,busts:0,byMode:{}},calibration:{hasHomography:!1,imageSize:null,lastUpdated:void 0}})}));try{typeof window<"u"&&(window.__NDN_AUDIT__={get:()=>$r.getState(),subscribe:$r.subscribe,reset:()=>$r.getState().reset()})}catch{}try{if(typeof window<"u"){const t=localStorage.getItem("ndn_audit_recent");if(t){const n=JSON.parse(t);Array.isArray(n)&&n.length&&$r.setState(r=>({...r,recent:n.slice(-50)}))}}}catch{}const Us="ndn:match-sync",Bi="ndn-match-sync";function Un(t){try{const n=typeof window<"u"&&window.BroadcastChannel?window.BroadcastChannel:null;let r=!1;if(n&&typeof n=="function"&&(r=!0),r){const s=n;try{const a=new s(Bi);try{a.postMessage(t)}finally{try{a.close()}catch{}}return}catch{}}}catch{try{localStorage.setItem(`${Us}:lastmsg`,JSON.stringify({msg:t,ts:Date.now()}));try{const n=new StorageEvent("storage",{key:`${Us}:lastmsg`,newValue:localStorage.getItem(`${Us}:lastmsg`)});window.dispatchEvent(n)}catch{try{window.dispatchEvent(new Event("storage"))}catch{}}try{window.dispatchEvent(new CustomEvent("ndn:match-sync",{detail:{msg:t}}))}catch{}}catch{}}}function du(t){let n=null;try{const r=typeof window<"u"&&window.BroadcastChannel?window.BroadcastChannel:null;let s=!1;if(r&&typeof r=="function"&&(s=!0),s)try{const a=r;n=new a(Bi)}catch{throw new Error("no-bc")}else throw new Error("no-bc");n&&(n.onmessage=a=>{try{t(a.data)}catch{}})}catch{const r=()=>{try{const a=localStorage.getItem(`${Us}:lastmsg`);if(!a)return;const o=JSON.parse(a);t(o.msg)}catch{}},s=a=>{try{if(!a?.detail)return;t(a.detail.msg)}catch{}};return window.addEventListener("storage",r),window.addEventListener("ndn:match-sync",s),()=>{window.removeEventListener("storage",r),window.removeEventListener("ndn:match-sync",s)}}return()=>{try{n&&n.close()}catch{}}}function Vi(t){const n=(t.visits||[]).reduce((a,o)=>a+(o.preOpenDarts||0),0),r=Math.max(0,t.dartsThrown-n);return r===0?0:(t.totalScoreStart-t.totalScoreRemaining)/r*3}function uu(t){const n=Vi(t),r=t.finished;return{avg:n,isCompleted:r,darts:t.dartsThrown,checkout:t.checkoutScore??0}}function mu(t){if(t.legs.length===0)return;const n=[];let r,s=t.bestCheckout??0;for(const a of t.legs){if(!a.finished)continue;const o=uu(a);n.push(o.avg),(!r||o.darts<r.darts||o.darts===r.darts&&(a.endTime??0)<r.timestamp)&&(r={darts:o.darts,timestamp:a.endTime??Date.now()}),o.checkout>s&&(s=o.checkout)}n.length&&(t.bestThreeDartAvg=Math.max(...n),t.worstThreeDartAvg=Math.min(...n)),r&&(t.bestNineDart=r),t.bestCheckout=s}const mt=mr(t=>({roomId:"",players:[],currentPlayerIdx:0,startingScore:501,inProgress:!1,newMatch:(n,r,s="")=>t(()=>{const a=n.map((o,c)=>({id:`${c}`,name:o,legsWon:0,legs:[]}));return console.debug("[useMatch] newMatch",n,r,s),{players:a,currentPlayerIdx:0,startingScore:r,inProgress:!0,roomId:s,bestLegThisMatch:void 0}}),addVisit:(n,r,s)=>t(a=>{if(console.debug("[useMatch] addVisit",{score:n,darts:r,inProgress:a.inProgress,currentPlayerIdx:a.currentPlayerIdx,players:a.players.length}),!a.inProgress)return a;const o=a.currentPlayerIdx,c=a.players[o],l=c.legs[c.legs.length-1];let b,u;!l||l.finished?(b={visits:[],totalScoreStart:a.startingScore,totalScoreRemaining:a.startingScore,dartsThrown:0,finished:!1,checkoutScore:null,startTime:Date.now()},u=[...c.legs,b]):(b={...l,visits:[...l.visits]},u=[...c.legs.slice(0,-1),b]);const f=b.totalScoreRemaining,g=Number(s?.visitTotal??n),m=Math.max(0,f-g);b.visits.push({darts:r,score:n,preOpenDarts:s?.preOpenDarts,doubleWindowDarts:s?.doubleWindowDarts,finishedByDouble:s?.finishedByDouble,visitTotal:g,entries:Array.isArray(s?.entries)?s.entries.map(S=>({label:String(S.label??""),value:Number(S.value??0),ring:String(S.ring??"")})):void 0}),b.dartsThrown+=r,b.totalScoreRemaining=m;const A={...c,legs:u};try{const S=n===0&&r>0&&m===f,x=m===0,w={},C=(b.visits||[]).reduce((j,T)=>j+(T.preOpenDarts||0),0),$=Math.max(0,b.dartsThrown-C);if($>0&&($%3===0||x)){const j=Vi(b);Math.abs((A.currentThreeDartAvg??0)-j)>1e-4&&(A.currentThreeDartAvg=j),w.threeDartAvg=j}$r.getState().recordVisit("x01-match",r,g,{preOpenDarts:s?.preOpenDarts??0,preRemaining:f,postRemaining:m,...w,bust:S,finish:x})}catch{}try{Un({type:"visit",score:g,darts:r,playerIdx:a.currentPlayerIdx,ts:Date.now()})}catch{}const k=a.players.map((S,x)=>x===o?A:S);return{...a,players:k}}),undoVisit:()=>t(n=>{const r=n.currentPlayerIdx,s=n.players[r],a=s.legs[s.legs.length-1];if(!a||a.finished||a.visits.length===0)return n;const o=a.visits.slice(0,-1),c=a.visits[a.visits.length-1],l=Number(c.visitTotal??c.score),b={...a,visits:o,dartsThrown:a.dartsThrown-c.darts,totalScoreRemaining:a.totalScoreRemaining+l},u=[...s.legs.slice(0,-1),b],f={...s,legs:u},g=n.players.map((m,A)=>A===r?f:m);return{...n,players:g}}),endLeg:n=>t(r=>{const s=r.currentPlayerIdx,a=r.players[s],o=a.legs[a.legs.length-1];if(!o||o.finished)return r;const c=Date.now(),l={...o,finished:!0,checkoutScore:n,endTime:c},b=[...a.legs.slice(0,-1),l];let u=a.legsWon,f=r.bestLegThisMatch;l.totalScoreRemaining===0&&(u+=1,(!f||l.dartsThrown<f.darts)&&(f={playerId:a.id,darts:l.dartsThrown,timestamp:c}));const g={...a,legs:b,legsWon:u},m=r.players.map((A,k)=>k===s?g:A);try{Un({type:"endLeg",checkoutScore:n,playerIdx:r.currentPlayerIdx,ts:Date.now()})}catch{}return{...r,players:m,bestLegThisMatch:f}}),nextPlayer:()=>t(n=>{const r=(n.currentPlayerIdx+1)%n.players.length;try{Un({type:"nextPlayer",currentPlayerIdx:r,ts:Date.now()})}catch{}return{...n,currentPlayerIdx:r}}),endGame:()=>t(n=>{if(!n.inProgress)return n;const r=n.players.map(s=>{const a={...s,currentThreeDartAvg:0};return mu(a),a});try{un(()=>Promise.resolve().then(()=>Uu),void 0).then(s=>{try{s.addMatchToAllTime(r,{recordSeries:!0})}catch{}})}catch{}try{Un({type:"endGame",ts:Date.now()})}catch{}return{...n,players:r,inProgress:!1}}),importState:n=>t(()=>({...n})),setPlayerCurrentAverage:(n,r)=>t(s=>{const a=s.players[n];if(!a)return s;if(Math.abs((a.currentThreeDartAvg??0)-r)>1e-4){const o={...a,currentThreeDartAvg:r},c=s.players.map((l,b)=>b===n?o:l);return{...s,players:c}}return s})})),hu={},fu=hu?.VITE_REMOTE_WS_FALLBACK||"",pu="wss://ninedartnation-1.onrender.com/ws",ts=zi(fu.trim()||pu),gu=new Set(["localhost","127.0.0.1"]),Wi=8787,bu=3e3;function zi(t){const n=t.trim();return n?/\/ws$/i.test(n)?n:`${n.replace(/\/$/,"")}/ws`:""}function xu(t){if(!t)return null;try{return new URL(t).hostname.toLowerCase()}catch{return null}}function ma(t){return!!t&&gu.has(t)}let Sn=null;function vu(){if(Sn)return Sn;const t="ws://localhost:8787".trim();if(t){const n=zi(t);if(typeof window<"u"){const r=xu(n),s=window.location.hostname;if(ma(r)&&!ma(s))return Sn=ts,Sn}return Sn=n,Sn}if(typeof window<"u"){const n=window.location.protocol==="https:"?"wss":"ws",r=window.location.hostname,s=`${n}://${window.location.host}/ws`;return ma(r)?Sn=`${n}://${r}:${Wi}/ws`:r.endsWith("onrender.com")?Sn=s:(r.endsWith("netlify.app"),Sn=ts),Sn}return Sn=ts,Sn}function Da(){return vu()}function yu(){if(typeof window>"u")return[Da()];const t=window.location.protocol==="https:"?"wss":"ws",n=window.location.hostname,r=window.location.host,s=Da(),a=new Set([s,`${t}://${r}/ws`,`${t}://${n}/ws`,`${t}://${n}:${Wi}/ws`,`${t}://${n}:${bu}/ws`,ts]);return Array.from(a).filter(Boolean)}const Hi=i.createContext(null);function wu({children:t}){const[n,r]=i.useState(!1),[s,a]=i.useState("connecting"),o=i.useRef(null),c=i.useRef(new Set),l=i.useRef(!0),b=i.useRef(0),u=i.useRef(null),f=i.useRef(null),g=i.useRef(null),m=i.useRef(0),A=()=>(g.current||(g.current=yu()),g.current),k=()=>{const T=A();return m.current=(m.current+1)%T.length,T[m.current]},S=()=>{const T=A();return T[m.current]||T[0]},x=i.useCallback(()=>{if(o.current&&(o.current.readyState===WebSocket.OPEN||o.current.readyState===WebSocket.CONNECTING))return;a("connecting");const M=`${S()}`,N=new WebSocket(M);o.current=N,N.onopen=()=>{r(!0),a("connected"),b.current=0,f.current&&clearInterval(f.current),f.current=setInterval(()=>{try{o.current?.readyState===WebSocket.OPEN&&o.current?.send(JSON.stringify({type:"ping",t:Date.now()}))}catch{}},2e4)},N.onmessage=P=>{try{const L=JSON.parse(P.data);c.current.forEach(V=>{try{V(L)}catch{}})}catch{}},N.onerror=()=>{},N.onclose=()=>{if(r(!1),a("disconnected"),f.current&&(clearInterval(f.current),f.current=null),!l.current)return;const P=(b.current||0)+1;b.current=P,P%2===0&&k();const L=1e3*Math.pow(2,P-1),V=Math.floor(Math.random()*1e3);let U=Math.min(3e4,L+V);P===1&&(U=0),u.current&&clearTimeout(u.current),U===0?x():u.current=setTimeout(x,U)}},[]),w=i.useCallback(()=>{try{l.current=!1,u.current&&(clearTimeout(u.current),u.current=null),f.current&&(clearInterval(f.current),f.current=null);try{o.current?.close()}catch{}o.current=null}catch{}b.current=0,l.current=!0,a("connecting"),r(!1),x()},[x]);i.useEffect(()=>{l.current=!0,x();const T=()=>{l.current=!1;try{o.current?.close()}catch{}};window.addEventListener("beforeunload",T);const M=()=>{document.visibilityState==="visible"&&(n||x())};return document.addEventListener("visibilitychange",M),window.addEventListener("online",x),()=>{l.current=!1,u.current&&clearTimeout(u.current),f.current&&clearInterval(f.current);try{o.current?.close()}catch{}document.removeEventListener("visibilitychange",M),window.removeEventListener("online",x),window.removeEventListener("beforeunload",T)}},[x]);const C=i.useCallback(T=>{try{o.current&&o.current.readyState===WebSocket.OPEN&&o.current.send(typeof T=="string"?T:JSON.stringify(T))}catch{}},[]),$=i.useCallback(T=>(c.current.add(T),()=>{c.current.delete(T)}),[]),j=i.useMemo(()=>({connected:n,status:s,send:C,addListener:$,reconnect:w}),[n,s,C,$,w]);return e.jsx(Hi.Provider,{value:j,children:t})}function Cr(){const t=i.useContext(Hi);if(!t)throw new Error("useWS must be used within WSProvider");return t}const Nu=({videoDevices:t,streaming:n,refreshVideoDevices:r,testCamera:s,onSelectPhoneCamera:a,lastDetectedLabel:o,autoCommitTestMode:c,doCommit:l,lastDetectedValue:b,calibrationValid:u,sectorOffset:f,onNudgeSectorOffset:g,onResetSectorOffset:m})=>{const{preferredCameraId:A,preferredCameraLabel:k,setPreferredCamera:S,cameraEnabled:x,setCameraEnabled:w,preferredCameraLocked:C,setPreferredCameraLocked:$}=ve(),[j,T]=i.useState(""),[M,N]=i.useState(!1),P=i.useRef(null),L=i.useCallback(async()=>{T("");try{await r()}catch(G){console.warn("[DevicePicker] refresh failed",G),T("Unable to list cameras. Grant camera permission in your browser.")}},[r]);i.useEffect(()=>{L()},[L]),i.useEffect(()=>{if(!M)return;function G(ge){P.current&&!P.current.contains(ge.target)&&(console.debug("[DevicePicker] document.mousedown -> closing dropdown (outside both main+portal)",Date.now()),N(!1))}return document.addEventListener("mousedown",G),()=>document.removeEventListener("mousedown",G)},[M]);const V=t.find(G=>G.deviceId===A),U=V?`${V.label||"Camera"}`:A?"Camera (unavailable)":"Auto (browser default)",te=!!(A&&!V),ie=i.useCallback((G,ge="")=>{try{S(G,ge,!0)}catch(Pe){console.warn("[DevicePicker] setPreferredCamera failed",Pe)}N(!1)},[S]),ae=i.useCallback(()=>{ie(void 0,"Phone Camera"),a()},[ie,a]),q=i.useCallback(()=>{$(!C)},[C,$]);return e.jsxs("div",{ref:P,className:"mt-3 rounded-lg border border-indigo-500/30 bg-indigo-500/5 p-3","data-testid":"device-picker-root",children:[e.jsx("div",{className:"mb-2 font-semibold",children:"Select camera device"}),j&&e.jsx("div",{className:"mb-2 text-sm text-rose-400",children:j}),t.length===0&&!j&&e.jsx("div",{className:"mb-2 text-xs text-slate-400",children:'Detecting devices... (click "Rescan" if this hangs)'}),te&&e.jsxs("div",{className:"mb-2 text-sm text-amber-400",children:["Selected camera is no longer available.",e.jsx("button",{className:"ml-1 underline",onClick:()=>ie(void 0,""),disabled:n,children:"Use auto-selection"})]}),e.jsxs("div",{className:"mb-2 flex items-center gap-2",children:[C?e.jsx("div",{className:"text-xs text-emerald-400",children:"ðŸ”’ Camera selection locked"}):e.jsx("div",{className:"text-xs text-slate-400",children:"Camera selection unlocked"}),e.jsx("button",{"data-testid":"cam-lock-toggle",className:"btn btn--ghost ml-2 px-2 py-0.5 text-xs",onClick:q,children:C?"Unlock":"Lock"})]}),e.jsxs("div",{className:"mb-3 flex items-center gap-3",children:[e.jsx("input",{type:"checkbox",id:"cameraEnabled-calibrator",checked:x,onChange:G=>w(G.target.checked),className:"h-4 w-4",disabled:n}),e.jsx("label",{htmlFor:"cameraEnabled-calibrator",className:"text-sm",children:"Enable camera for scoring"})]}),e.jsxs("div",{className:"grid grid-cols-3 items-center gap-2 text-sm",children:[e.jsxs("div",{className:"relative col-span-2",children:[e.jsxs("button",{className:"input flex w-full items-center justify-between text-left","data-testid":"device-picker-toggle",onClick:()=>N(!0),onPointerDown:G=>G.stopPropagation(),onMouseDown:G=>G.stopPropagation(),children:[e.jsx("span",{children:U}),e.jsx("span",{className:`transition-transform ${M?"rotate-180":""}`,children:"â–¼"})]}),M&&e.jsx("div",{className:"absolute left-0 right-0 top-full z-50 mt-1 rounded border border-slate-600 bg-slate-800 shadow-lg",children:e.jsxs("div",{className:"max-h-48 overflow-y-auto",children:[e.jsx("button",{"data-testid":"device-option-auto",className:"w-full px-3 py-2 text-left text-sm hover:bg-slate-700",onClick:()=>ie(void 0,""),onPointerDown:G=>G.stopPropagation(),onMouseDown:G=>G.stopPropagation(),children:"Auto (browser default)"}),t.map(G=>e.jsx("button",{className:"w-full px-3 py-2 text-left text-sm hover:bg-slate-700",onClick:()=>ie(G.deviceId,G.label||""),onPointerDown:ge=>ge.stopPropagation(),onMouseDown:ge=>ge.stopPropagation(),children:G.label||"Camera"},G.deviceId)),e.jsx("button",{className:"w-full px-3 py-2 text-left text-sm hover:bg-slate-700",onClick:ae,onPointerDown:G=>G.stopPropagation(),onMouseDown:G=>G.stopPropagation(),children:"ðŸ“± Phone Camera"})]})})]}),t.length===0&&e.jsxs("div",{className:"col-span-1 flex items-center justify-end gap-2",children:[e.jsx("button",{className:"btn btn--ghost btn-sm",onClick:async()=>{try{await s(),await r()}catch(G){console.warn("[DevicePicker] request camera permission failed",G),T("Camera permission denied. Please allow access in your browser.")}},children:"Enable local camera"}),e.jsx("button",{className:"btn btn--ghost btn-sm",onClick:()=>void L(),children:"Rescan"})]}),e.jsxs("div",{className:"col-span-3 text-right",children:[e.jsx("button",{className:"btn px-2 py-1",onClick:()=>{s(A||void 0)},disabled:n,children:"Test"}),e.jsxs("div",{className:"mt-2 flex items-center justify-end gap-2 text-xs",children:[e.jsxs("span",{children:["Sector offset: ",f??0]}),e.jsx("button",{className:"btn btn--ghost btn-sm",onClick:()=>g(-1),children:"-1"}),e.jsx("button",{className:"btn btn--ghost btn-sm",onClick:()=>g(1),children:"+1"}),e.jsx("button",{className:"btn btn--ghost btn-sm",onClick:()=>m(),children:"Reset"})]}),e.jsxs("div",{className:"mt-2 flex items-center justify-end gap-2 text-xs opacity-70",children:[e.jsx("span",{"data-testid":"device-picker-detected",children:o?`Detected: ${o}`:"No recent detection"}),(o!=null||c)&&e.jsx("button",{className:"btn btn--ghost btn-sm",onClick:()=>l(),onPointerDown:()=>l(),disabled:b==null,children:"Commit detected"}),e.jsx("span",{className:`inline-block h-2.5 w-2.5 rounded-full ${u?"bg-emerald-400":"bg-rose-500"}`}),e.jsx("span",{className:"text-xs",children:u?"Cal OK":"Cal invalid"})]})]})]}),k&&e.jsxs("div",{className:"mt-1 text-xs opacity-70",children:["Selected: ",k]}),e.jsx("div",{className:"mt-1 text-xs opacity-70",children:"Tip: All camera technology is supported for autoscoring needsâ€”select your camera here and then open Calibrator to align."})]})},ns=["D20","D6","D3","D11","BULL"],cr=ns.length,Is=[{idx:0,label:"D20 (top double)",sector:20,ring:"DOUBLE",toleranceMm:4.5},{idx:1,label:"D6 (right double)",sector:6,ring:"DOUBLE",toleranceMm:4.5},{idx:2,label:"D3 (bottom double)",sector:3,ring:"DOUBLE",toleranceMm:4.5},{idx:3,label:"D11 (left double)",sector:11,ring:"DOUBLE",toleranceMm:4.5},{idx:4,label:"Bull center",sector:25,ring:"INNER_BULL",toleranceMm:3.5}];function qi(t,n){return t==="INNER_BULL"?"Inner Bull (50)":t==="BULL"?"Outer Bull (25)":t==="MISS"||n==null?t==="MISS"?"Miss":t:`${t==="DOUBLE"?"Double":t==="TRIPLE"?"Triple":"Single"} ${n}`}function ju(t){return t?qi(t.ring,t.sector):"â€”"}function ha(t,n,r){return Ka(t,[1,0,n,0,1,r,0,0,1])}function Su(){const t=i.useRef(null),n=i.useRef(null),r=i.useRef(null),s=i.useRef(null),[a,o]=i.useState("unknown"),[c,l]=i.useState([]),[b,u]=i.useState(null),[f,g]=i.useState(!1),[m,A]=i.useState(!1),[k,S]=i.useState(()=>localStorage.getItem("ndn:cal:mode")||"local"),[x,w]=i.useState([]),[C,$]=i.useState(!1),[j,T]=i.useState("idle"),M=i.useCallback(()=>{S("phone"),T("camera"),g(!1),$(!1);try{ve.getState().setPreferredCamera(void 0,"Phone Camera",!0)}catch(h){console.warn("[Calibrator] Failed to persist phone camera selection",h)}},[S,T,g,$]),[N,P]=i.useState(null),L=ve(h=>h.cameraScale)||1,V=ve(h=>h.setCameraScale),[U,te]=i.useState(()=>{if(typeof window>"u")return!1;try{return window.localStorage.getItem("ndn:cal:forceDesktop")==="1"}catch{return!1}}),[ie,ae]=i.useState(()=>typeof navigator>"u"?!1:/Android|iPhone|iPad|iPod|Mobi/i.test(navigator.userAgent)),{H:q,setCalibration:G,reset:ge,errorPx:Pe,locked:ne,overlaySize:Ae,imageSize:ce,anchors:H,theta:I,sectorOffset:B}=En(),de=6,K=!!q&&!!ce&&(ne||typeof Pe=="number"&&Pe<=de),le=er(),{calibrationGuide:we,setCalibrationGuide:He,preferredCameraId:Qe,cameraEnabled:tt,setCameraEnabled:pt,preferredCameraLocked:st,setPreferredCameraLocked:E,setPreferredCamera:J,preserveCalibrationOverlay:z,allowAutocommitInOnline:oe,setAllowAutocommitInOnline:je}=ve(),[se,$e]=i.useState(null),[jt,Mt]=i.useState(!1),[Et,fe]=i.useState(0),[Qt,Be]=i.useState(!1),[vn,Gt]=i.useState(null),[ht,_e]=i.useState(!0),[Te,Ge]=i.useState(null),[it,Ft]=i.useState(!1),[ct,$n]=i.useState(!1),[Ut,at]=i.useState(!1),[p,Z]=i.useState(null),[ye,Ze]=i.useState(null),[Fe,Yt]=i.useState(null),[Dn,Bn]=i.useState(!1),et=i.useRef(null),In=i.useCallback(h=>{const D=(B??0)+h;G({sectorOffset:D})},[B,G]),Wt=i.useRef(!1),yn=i.useRef(null),wn=i.useRef(0),mn=300,[rn,zt]=i.useState([]),[tr,nr]=i.useState({type:null,until:0}),[xt,sn]=i.useState(1),[Zt,$t]=i.useState(0),[an,lt]=i.useState(0),[Lt,vt]=i.useState(!1),[en,It]=i.useState(!1),[Je,Ot]=i.useState(1),[hr,An]=i.useState(1),[tn,kr]=i.useState(null);function Kn(){Ot(1.02),An(1),sn(1),$t(0),lt(0),It(!1),kr(null)}function fr(h,D=1500){nr({type:h?"pass":"fail",until:Date.now()+D})}i.useCallback((h,D=480)=>{if(typeof document>"u")throw new Error("Marker rendering only available in browser context");const R=Kd(h),_=document.createElement("canvas");_.width=D,_.height=D;const v=_.getContext("2d");if(!v)return"";v.fillStyle="#ffffff",v.fillRect(0,0,D,D);const re=R.length,ee=R[0]?.length||re,X=D/ee,be=D/re;for(let me=0;me<re;me++)for(let Y=0;Y<ee;Y++)R[me][Y]&&(v.fillStyle="#000000",v.fillRect(Math.round(Y*X),Math.round(me*be),Math.ceil(X),Math.ceil(be)));return _.toDataURL("image/png")},[]);const[Ht,Vn]=i.useState(null),hn=i.useRef(null),[Pt,Wr]=i.useState(null),cn=i.useRef(null),fn=i.useRef([]),[St,Nn]=i.useState(null),[O,De]=i.useState(Date.now()),[dt,ln]=i.useState(!1);function nn(h){try{Vn(h),hn.current=h}catch{}}const[zr,ps]=i.useState(null),[Wn,Er]=i.useState(null),[ao,gs]=i.useState(!0),[zs,Tr]=i.useState([]),[oo,bs]=i.useState(!1),[xs,Xn]=i.useState(null),Dr=i.useRef(null);i.useEffect(()=>{let h=null;if(it&&f&&t.current&&r.current)try{const D=t.current,R=new Nd({requireStableN:2,thresh:18,minArea:40}),_=D.videoWidth||t.current.clientWidth||640,v=D.videoHeight||t.current.clientHeight||480;if(R.reset(_,v),se){const re=Math.max(se.doubleOuter*1.1,se.trebleOuter*1.1);R.setROI(se.cx,se.cy,Math.round(re))}et.current=R,h=window.setInterval(()=>{try{const re=document.createElement("canvas");re.width=_,re.height=v;const ee=re.getContext("2d");if(!ee)return;ee.drawImage(D,0,0,_,v);const X=ee.getImageData(0,0,_,v);R.updateBackground(X);const be=R.detect(X),me=r.current,Y=me.getContext("2d");if(!Y)return;if(Y.clearRect(0,0,me.width,me.height),be){try{if(q&&ce){const he={x:be.tip.x,y:be.tip.y},Ve=r.current&&r.current.width||ce.w||1,qe=r.current&&r.current.height||ce.h||1,xe={x:he.x/(Ve/ce.w),y:he.y/(qe/ce.h)},ke=Zn(q,xe),Ee=ke?wr(ke,typeof I=="number"?I:0,B??0):{base:0,ring:"MISS",sector:null,mult:0},Re=Ee.base,Xe=`${Ee.ring} ${Re}`.trim(),gn=6,Me=3,We=3,Tt=!!q&&!!ce&&(ne||typeof Pe=="number"&&Pe<=gn),bt=be.tip.x>=-Me&&be.tip.x<=Ve+Me&&be.tip.y>=-Me&&be.tip.y<=qe+Me,Ye=xe.x>=-We&&xe.x<=ce.w+We&&xe.y>=-We&&xe.y<=ce.h+We;let Ct=!1;const Bt=Zn(q,xe);if(Bt&&(Ct=Math.hypot(Bt.x,Bt.y)<=Ne.doubleOuter+3),!Tt||!bt||!Ye||!Ct)console.debug("Calibrator: ignoring ghost preview detection",Tt,bt,Ye);else{Z(Re),Ze(Xe);try{if(ct&&Ut&&mt.getState().inProgress&&mt.getState().roomId===""){const ft=`${Re}|3`,Le=performance.now();if(!Wt.current&&!(ft===yn.current&&Le-wn.current<mn)){yn.current=ft,wn.current=Le,Wt.current=!0;try{mt.getState().addVisit(Re,3,{visitTotal:Re})}catch{}try{window.setTimeout(()=>{Wt.current=!1},Math.max(120,mn))}catch{}}}}catch{}try{const ft=mt.getState().roomId!=="";if(ct&&Ut&&mt.getState().inProgress&&ft&&oe){const Le=Zn(q,xe);Le&&Cr().send({type:"auto-visit",roomId:mt.getState().roomId,value:Re,darts:3,ring:Ee.ring,sector:Ee.sector,pBoard:Le,calibrationValid:!0})}}catch{}}}}catch{}Y.fillStyle="rgba(0,255,0,0.9)",Y.beginPath(),Y.arc(be.tip.x,be.tip.y,6,0,Math.PI*2),Y.fill(),Y.strokeStyle="rgba(0,255,0,0.8)",Y.lineWidth=2,be.axis&&(Y.beginPath(),Y.moveTo(be.axis.x1,be.axis.y1),Y.lineTo(be.axis.x2,be.axis.y2),Y.stroke())}}catch{}},300)}catch(D){console.warn("[Calibrator] failed to start dart preview",D)}return()=>{h&&clearInterval(h),et.current=null}},[it,f,se]),i.useEffect(()=>{const h=window.location.hostname;(h==="localhost"||h==="127.0.0.1")&&xn("/api/hosts").then(D=>D.json()).then(D=>{const R=Array.isArray(D?.hosts)&&D.hosts.find(_=>_);R&&ps(R)}).catch(()=>{}),xn("/api/https-info").then(D=>D.json()).then(D=>{D&&typeof D.https=="boolean"&&Er({https:!!D.https,port:Number(D.port)||8788})}).catch(()=>{})},[]);const Mn=i.useMemo(()=>{const h=Ht||"____",D="ws://localhost:8787";if(D.length>0)try{const ee=new URL(D);return`${`${ee.protocol==="wss:"?"https":"http"}://${ee.host}${ee.pathname.endsWith("/ws")?"":ee.pathname}`.replace(/\/?ws$/i,"")}/mobile-cam.html?code=${h}`}catch{}const R=zr||window.location.hostname,_=!!Wn?.https,v=_?Wn?.port||8788:8787;return`${_?"https":"http"}://${R}:${v}/mobile-cam.html?code=${h}`},[Ht,zr,Wn]),vs=i.useMemo(()=>{if(!Mn)return null;try{const h=new URL(Mn);return h.searchParams.delete("code"),h.toString().replace(/\?$/,"")}catch{return typeof window<"u"?`${window.location.origin.replace(/\/$/,"")}/mobile-cam.html`:"/mobile-cam.html"}},[Mn]);i.useEffect(()=>{localStorage.setItem("ndn:cal:mode",k)},[k]),i.useEffect(()=>{if(!(typeof window>"u"))try{U?window.localStorage.setItem("ndn:cal:forceDesktop","1"):window.localStorage.removeItem("ndn:cal:forceDesktop")}catch{}},[U]),i.useEffect(()=>{if(typeof window>"u")return;const h=window.matchMedia("(pointer: coarse)"),D=()=>{const R=typeof navigator<"u"&&/Android|iPhone|iPad|iPod|Mobi/i.test(navigator.userAgent),_=typeof h.matches=="boolean"?h.matches:!1,v=window.innerWidth<=820;ae(R||_||v)};D();try{typeof h.addEventListener=="function"?h.addEventListener("change",D):typeof h.addListener=="function"&&h.addListener(D)}catch{}return window.addEventListener("resize",D),()=>{try{typeof h.removeEventListener=="function"?h.removeEventListener("change",D):typeof h.removeListener=="function"&&h.removeListener(D)}catch{}window.removeEventListener("resize",D)}},[]),i.useEffect(()=>{if(typeof navigator>"u"||!navigator.permissions){o("unsupported");return}let h=!0;return(async()=>{try{const D=await navigator.permissions.query({name:"camera"});if(!h)return;o(D.state||"unknown"),D.onchange=()=>{h&&o(D.state)}}catch{h&&o("unknown")}})(),()=>{h=!1}},[]);async function pr(){if(!(typeof navigator>"u"||!navigator.mediaDevices||!navigator.mediaDevices.enumerateDevices))try{const D=(await navigator.mediaDevices.enumerateDevices()).filter(R=>R.kind==="videoinput").map(R=>({deviceId:R.deviceId,label:R.label||"Camera"}));l(D),D.length&&!b&&u(D[0].deviceId)}catch{}}i.useEffect(()=>((async()=>{try{await pr()}catch{}try{navigator?.mediaDevices?.addEventListener?navigator.mediaDevices.addEventListener("devicechange",pr):navigator.mediaDevices.ondevicechange=pr}catch{}})(),()=>{try{navigator?.mediaDevices?.removeEventListener&&navigator.mediaDevices.removeEventListener("devicechange",pr)}catch{}}),[]);async function Ir(h){if(typeof navigator>"u"||!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia){alert("getUserMedia is not available in this browser");return}const D={video:h?{deviceId:{exact:h}}:{facingMode:"environment"}};let R=null;try{R=await navigator.mediaDevices.getUserMedia(D),R.getTracks().forEach(_=>_.stop()),o("granted");try{h&&typeof J=="function"&&J(h)}catch{}alert("Camera access granted â€” your webcam is available and set as preferred.")}catch(_){console.error("[Calibrator] testCamera failed",_),_&&(_.name==="NotAllowedError"||_.name==="PermissionDeniedError")?(o("denied"),alert("Camera permission denied. Please allow camera access in your browser settings and try again.")):_&&(_.name==="NotFoundError"||_.name==="DevicesNotFoundError")?alert("No camera devices found. Ensure your USB webcam is connected and not in use by another app."):alert("Unable to access the camera: "+(_?.message||_))}finally{R&&R.getTracks().forEach(_=>_.stop())}}i.useEffect(()=>{if(!St)return;const h=setInterval(()=>De(Date.now()),1e3);return()=>clearInterval(h)},[St]);const ys=i.useMemo(()=>St?Math.max(0,Math.ceil((St-O)/1e3)):null,[St,O]);i.useEffect(()=>()=>{Dr.current&&window.clearTimeout(Dr.current)},[]);const Ar=i.useCallback(async(h,D)=>{if(h)try{if(navigator.clipboard&&navigator.clipboard.writeText)await navigator.clipboard.writeText(h);else{const R=document.createElement("textarea");R.value=h,R.style.position="fixed",R.style.opacity="0",document.body.appendChild(R),R.focus(),R.select(),document.execCommand("copy");try{document.body.removeChild(R)}catch{}}Xn(D),Dr.current&&window.clearTimeout(Dr.current),Dr.current=window.setTimeout(()=>Xn(null),1500)}catch(R){console.warn("[Calibrator] Copy failed:",R),Xn(null)}},[]);i.useEffect(()=>()=>{},[]),i.useEffect(()=>{const h=D=>{console.log("[Calibrator] Received reconnect request from PhoneCameraOverlay"),k==="phone"&&dt&&(_t(!1),setTimeout(()=>{Pn()},500))};return window.addEventListener("ndn:phone-camera-reconnect",h),()=>{window.removeEventListener("ndn:phone-camera-reconnect",h)}},[k,dt]),i.useEffect(()=>{console.log("[Calibrator] ðŸ”„ STREAMING CHANGED:",{streaming:f,videoRefAvailable:!!t.current}),t.current?(console.log("[Calibrator] âœ… Syncing videoElementRef on streaming change"),le.setVideoElementRef(t.current),t.current.srcObject instanceof MediaStream&&(console.log("[Calibrator] âœ… Setting mediaStream from video element"),le.setMediaStream(t.current.srcObject))):console.warn("[Calibrator] âš ï¸ videoRef.current is null on streaming change!")},[f]),i.useEffect(()=>(console.log("[Calibrator] ðŸš€ MOUNT: Initial mount - syncing videoRef"),console.log("[Calibrator] videoRef.current available:",!!t.current),console.log("[Calibrator] videoRef.current type:",t.current?.constructor?.name),t.current?(console.log("[Calibrator] âœ… Setting videoElementRef on mount"),console.log("[Calibrator] Video element:",{tagName:t.current.tagName,srcObject:!!t.current.srcObject,videoWidth:t.current.videoWidth,videoHeight:t.current.videoHeight}),le.setVideoElementRef(t.current),console.log("[Calibrator] âœ… videoElementRef set successfully")):console.error("[Calibrator] âŒ CRITICAL: videoRef.current is NULL at mount!"),()=>{}),[]);function On(){if(Pt&&(Pt.readyState===WebSocket.OPEN||Pt.readyState===WebSocket.CONNECTING))return console.log("[Calibrator] ensureWS: Reusing existing WebSocket (state:",Pt.readyState,")"),Pt;const h="ws://localhost:8787",D=h.length>0?h.endsWith("/ws")?h:h.replace(/\/$/,"")+"/ws":void 0,_=`${window.location.protocol==="https:"?"wss":"ws"}://${window.location.host}/ws`,v=window.location.hostname,ee=D||(v.endsWith("onrender.com")?_:"wss://ninedartnation.onrender.com/ws");console.log("[Calibrator] ensureWS: Creating new WebSocket to:",ee);const X=new WebSocket(ee);return X.onerror=be=>{console.error("[Calibrator] WebSocket connection error:",be),alert("Failed to connect to camera pairing service. Please check your internet connection and try again.")},X.onclose=be=>{if(console.log("[Calibrator] WebSocket closed:",be.code,be.reason),cn.current){try{cn.current.close()}catch{}cn.current=null}nn(null),Nn(null),ln(!1),be.code!==1e3&&(alert("Camera pairing connection lost. Please try pairing again."),k==="phone"&&S("local"))},Wr(X),X}async function Pn(){S("phone"),_t(!1),ws();try{pt(!0)}catch{}const h=On();h.readyState===WebSocket.OPEN?(console.log("[Calibrator] WebSocket open, sending cam-create"),h.send(JSON.stringify({type:"cam-create"}))):(console.log("[Calibrator] WebSocket connecting, will send cam-create on open"),h.onopen=()=>{console.log("[Calibrator] WebSocket now open, sending cam-create"),h.send(JSON.stringify({type:"cam-create"}))}),h.onmessage=async D=>{const R=JSON.parse(D.data);if(R.type==="cam-code")nn(R.code),R.expiresAt&&Nn(R.expiresAt);else if(R.type==="cam-peer-joined"){!hn.current&&R.code&&nn(R.code),ln(!0);const _=hn.current||R.code||null;_&&(hn.current=_);try{if(ne&&_){const re=n.current?{w:n.current.width,h:n.current.height}:null,ee={H:q,imageSize:re,errorPx:Pe??null,createdAt:Date.now()};h.send(JSON.stringify({type:"cam-calibration",code:_,payload:ee})),console.log("[Calibrator] Sent calibration to joined phone for code",_)}}catch(re){console.warn("[Calibrator] Failed to send calibration on peer join",re)}const v=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}],iceCandidatePoolSize:10});cn.current=v,v.onconnectionstatechange=()=>{console.log("WebRTC connection state:",v.connectionState),v.connectionState==="failed"||v.connectionState==="disconnected"?(console.error("WebRTC connection failed"),alert("Camera connection lost. Please try pairing again."),_t(!1)):v.connectionState==="connected"&&console.log("WebRTC connection established")},v.onicecandidate=re=>{re.candidate&&_&&h.send(JSON.stringify({type:"cam-ice",code:_,payload:re.candidate}))},v.ontrack=re=>{if(console.log("[Calibrator] WebRTC ontrack received:",re.streams?.length,"streams, track kind:",re.track?.kind),t.current){const ee=re.streams?.[0];ee?(console.log("[Calibrator] Assigning video stream (tracks:",ee.getTracks().length,") to video element"),$(!1),setTimeout(()=>{t.current&&(console.log("[Calibrator] Setting srcObject and attempting play"),t.current.srcObject&&t.current.srcObject.getTracks().forEach(be=>be.stop()),t.current.srcObject=ee,t.current.muted=!0,t.current.playsInline=!0,t.current.play().then(()=>{console.log("[Calibrator] Video playback started successfully"),g(!0),T("capture"),le.setStreaming(!0),le.setMode("phone"),le.setMediaStream(ee);try{J(void 0,"Phone Camera",!0)}catch{}if(!st)try{E(!0)}catch{}try{pt(!0)}catch{}A(!1)}).catch(X=>{console.error("[Calibrator] Video play failed:",X),A(!0),console.warn("[Calibrator] video play blocked â€” prompting user interaction")}))},100)):console.error("[Calibrator] No inbound stream received in ontrack")}else console.error("[Calibrator] Video element not available")};try{const re=await v.createOffer({offerToReceiveAudio:!1,offerToReceiveVideo:!0});await v.setLocalDescription(re),console.log("[Calibrator] Sending cam-offer for code:",_),_?h.send(JSON.stringify({type:"cam-offer",code:_,payload:re})):console.warn("[Calibrator] Missing pairing code when sending offer")}catch(re){console.error("Failed to create WebRTC offer:",re),alert("Failed to establish camera connection. Please try again."),_t(!1)}}else if(R.type==="cam-answer"){console.log("[Calibrator] Received cam-answer");const _=cn.current;if(_)try{await _.setRemoteDescription(new RTCSessionDescription(R.payload)),console.log("[Calibrator] Remote description set (answer)");const v=fn.current;console.log(`[Calibrator] Processing ${v.length} pending ICE candidates`);for(const re of v)try{await _.addIceCandidate(re),console.log("[Calibrator] Queued ICE candidate added")}catch(ee){console.error("Failed to add queued ICE candidate:",ee)}fn.current=[]}catch(v){console.error("Failed to set remote description:",v),alert("Camera pairing failed. Please try again."),_t(!1)}else console.warn("[Calibrator] Received cam-answer but no peer connection exists")}else if(R.type==="cam-ice"){console.log("[Calibrator] Received cam-ice");const _=cn.current;if(_)if(_.remoteDescription)try{await _.addIceCandidate(R.payload),console.log("[Calibrator] ICE candidate added")}catch(v){console.error("Failed to add ICE candidate:",v)}else console.log("[Calibrator] Remote description not set yet, queuing ICE candidate"),fn.current.push(R.payload);else console.warn("[Calibrator] Received ICE candidate but no peer connection exists")}else if(R.type==="cam-error")console.error("Camera pairing error:",R.code),alert(R.code==="EXPIRED"?"Code expired. Generate a new code.":`Camera error: ${R.code||"Unknown error"}`),_t(!1);else if(R.type==="cam-calibration"){console.log("[Calibrator] Received calibration from peer:",R.payload);try{if(R.payload){let _=Array.isArray(R.payload.H)?R.payload.H:null;if(!_&&Array.isArray(R.payload.calibrationPoints)&&R.payload.calibrationPoints.length>=4)try{const v=[{x:0,y:-Ne.doubleOuter},{x:Ne.doubleOuter,y:0},{x:0,y:Ne.doubleOuter},{x:-Ne.doubleOuter,y:0}];_=qn(v,R.payload.calibrationPoints.slice(0,4))}catch(v){console.warn("[Calibrator] Failed to compute homography from received calibration points",v)}if(_){const v=r?.current?{w:r.current.width,h:r.current.height}:t?.current?{w:t.current.clientWidth,h:t.current.clientHeight}:R.payload.imageSize??null;G({H:_,createdAt:R.payload.createdAt||Date.now(),errorPx:R.payload.errorPx,imageSize:R.payload.imageSize,overlaySize:v,locked:!0}),console.log("[Calibrator] Applied received calibration")}}}catch(_){console.error("[Calibrator] Failed to apply received calibration",_)}}}}async function gr(){bs(!0);try{const h=await ru();Tr(h),h.length===0&&alert("No wifi scoring devices found on your network. Make sure devices are powered on and connected to the same network.")}catch(h){console.error("Wifi device discovery failed:",h),alert("Failed to discover wifi devices. Please check your network connection.")}finally{bs(!1)}T("camera")}async function Hs(h){try{Tr(R=>R.map(_=>_.id===h.id?{..._,status:"connecting"}:_));const D=await lu(h);if(D&&t.current)t.current.srcObject&&t.current.srcObject.getTracks().forEach(_=>_.stop()),t.current.srcObject=D,await t.current.play(),g(!0),T("capture"),Tr(R=>R.map(_=>_.id===h.id?{..._,status:"online"}:_));else throw new Error("Failed to get video stream")}catch(D){console.error("Failed to connect to wifi device:",D),alert(`Failed to connect to ${h.name}. Please check the device and try again.`),Tr(R=>R.map(_=>_.id===h.id?{..._,status:"offline"}:_))}}async function io(){if(k==="phone")return Pn();if(k==="wifi")return gr();console.log("[Calibrator] ðŸŽ¬ START_CAMERA: mode=",k,"preferredCameraId=",Qe);try{let h=null;if(Qe)try{console.log("[Calibrator] ðŸ“¹ Attempt 1: Using preferred camera ID:",Qe),h=await navigator.mediaDevices.getUserMedia({video:{deviceId:{exact:Qe}},audio:!1}),console.log("[Calibrator] âœ… SUCCESS with preferred camera:",h.getTracks().length,"tracks")}catch(D){console.warn("[Calibrator] âš ï¸ Preferred camera failed:",D?.name,D?.message)}if(!h)try{console.log("[Calibrator] ðŸ“¹ Attempt 2: Using ANY available camera"),h=await navigator.mediaDevices.getUserMedia({video:!0,audio:!1}),console.log("[Calibrator] âœ… SUCCESS with fallback camera:",h.getTracks().length,"tracks")}catch(D){throw console.error("[Calibrator] âŒ BOTH attempts failed:",D?.name,D?.message),D}if(!h)throw new Error("No stream obtained");if(!t.current)throw new Error("Video element ref is null");console.log("[Calibrator] ðŸ“º Assigning stream to video element"),t.current.srcObject=h,console.log("[Calibrator] â–¶ï¸ Calling play()");try{await t.current.play(),console.log("[Calibrator] âœ… Play succeeded")}catch(D){console.warn("[Calibrator] âš ï¸ Play failed, retrying in 100ms:",D?.message),await new Promise(R=>setTimeout(R,100)),await t.current.play(),console.log("[Calibrator] âœ… Play succeeded on retry")}console.log("[Calibrator] ðŸŸ¢ Setting streaming = true"),g(!0),T("capture"),console.log("[Calibrator] ðŸŸ¢ State updated")}catch(h){console.error("[Calibrator] ðŸ”´ FATAL:",h?.message||h),alert(`Camera failed: ${h?.message||"Unknown error"}`),t.current?.srcObject&&(t.current.srcObject.getTracks().forEach(D=>D.stop()),t.current.srcObject=null)}}function _t(h=!1){if(t.current&&t.current.srcObject&&(t.current.srcObject.getTracks().forEach(R=>R.stop()),t.current.srcObject=null,g(!1)),cn.current){try{cn.current.close()}catch{}cn.current=null}fn.current=[],nn(null),Nn(null),ln(!1),Ge(null),le.setStreaming(!1),le.setMediaStream(null),h&&(k==="phone"||k==="wifi")&&S("local")}function qs(){Pt&&Pt.readyState===WebSocket.OPEN?Pt.send(JSON.stringify({type:"cam-create"})):Pn(),ws()}function ws(){try{st||E(!0)}catch{}}function Ns(){try{s.current?.click()}catch{}}function Hr(){const h=`${window.location.origin}/marker-sheet.html`;window.open(h,"_blank")}function br(){if(!t.current||!n.current)return;const h=t.current,D=n.current;if(D.width=h.videoWidth,D.height=h.videoHeight,D.getContext("2d").drawImage(h,0,0,D.width,D.height),$(!0),P({w:D.width,h:D.height}),T("select"),console.log("[Calibrator] captureFrame: resetting dstPoints to []"),w([]),$e(null),It(!1),Ge(null),r.current){const _=r.current;_.width=D.width,_.height=D.height;const v=_.getContext("2d");v&&v.clearRect(0,0,_.width,_.height)}jt&&setTimeout(()=>{Rn()},0)}function pn(h=x,D=null){if(!n.current||!r.current)return;const R=n.current,_=r.current;_.width=R.width,_.height=R.height;const v=_.getContext("2d");v.clearRect(0,0,_.width,_.height),r.current&&(r.current.onclick=Me=>Ee(Me));const re=D||(h.length>=cr?q:null),ee=xt,X=Zt,be=an;let me=re;me&&ee!==1&&(me=Fs(me,ee,1)),me&&(X!==0||be!==0)&&(me=ha(me,X,be));const Y=se?se.cx+Zt:0,he=se?se.cy+an:0,Ve=1,qe={};se&&(qe[Ne.bullInner]=se.bullInner*Ve,qe[Ne.bullOuter]=se.bullOuter*Ve,qe[Ne.trebleInner]=se.trebleInner*Ve,qe[Ne.trebleOuter]=se.trebleOuter*Ve,qe[Ne.doubleInner]=se.doubleInner*Ve,qe[Ne.doubleOuter]=se.doubleOuter*Ve);const xe={};xe[Ne.doubleOuter]=Je,xe[Ne.trebleOuter]=hr;function ke(){if(!se)return 0;let Me=0;try{const We="rgba(52,211,153,0.08)",Tt="rgba(253,224,71,0.06)",bt="rgba(34,211,238,0.06)",Ye=(ft,Le,ot,Rt)=>{const kt=qe[ft],yt=qe[Le];if(!kt||!yt)return!1;v.save(),v.shadowColor="rgba(0,0,0,0.45)",v.shadowBlur=6,v.beginPath();const Dt=yt*(xe[Le]||1),Kt=kt*(xe[ft]||1);return v.arc(Y,he,Dt,0,Math.PI*2),v.arc(Y,he,Kt,0,Math.PI*2,!0),v.closePath(),v.fillStyle=ot,v.fill(),v.restore(),!0};Ye(Ne.bullInner,Ne.bullOuter,We),Me++,Ye(Ne.trebleInner,Ne.trebleOuter,Tt),Me++,Ye(Ne.doubleInner,Ne.doubleOuter,bt),Me++;const Ct=360,Bt=[{r:Ne.bullInner,color:"#00ff66"},{r:Ne.bullOuter,color:"#ffffff"},{r:Ne.trebleInner,color:"#fde047"},{r:Ne.trebleOuter,color:"#fde047"},{r:Ne.doubleInner,color:"#22d3ee"},{r:Ne.doubleOuter,color:"#22d3ee"}];for(const ft of Bt){const Le=qe[ft.r];if(!Le)continue;const ot=[];for(let Rt=0;Rt<Ct;Rt++){const kt=Rt/Ct*Math.PI*2,yt=Le*xt*(xe[ft.r]||1);ot.push({x:Y+yt*Math.cos(kt),y:he+yt*Math.sin(kt)})}Ds(v,ot,"rgba(0,0,0,0.45)",3),Ds(v,ot,ft.color,1.5)}}catch{return 0}return 3}function Ee(Me){if(!tn||!r.current||!se)return;const We=r.current.getBoundingClientRect(),Tt=(Me.clientX-We.left)*(r.current.width/We.width),bt=(Me.clientY-We.top)*(r.current.height/We.height),Ye=Tt-Y,Ct=bt-he,Bt=Math.hypot(Ye,Ct);let ft;tn==="double"?ft=Ne.doubleOuter:tn==="treble"?ft=Ne.trebleOuter:ft=Ne.bullOuter;const Le=qe[ft];if(!Le||Le<=0)return;const ot=Bt/(Le*xt);tn==="double"&&Ot(ot),tn==="treble"&&An(ot),tn==="bull"&&sn(Rt=>Rt*(ot/Rt)),kr(null),console.log("[Calibrator] Aligned ",tn," adjust=",ot.toFixed(4))}const Re=me;if(D&&console.log("[drawOverlay] Using passed homography:",{HH:D.slice(0,6),currentPointsCount:h.length,canvasSize:{w:_.width,h:_.height}}),en&&se){const Me=ke();console.log("[drawOverlay] Forced detected-only drawing, rings drawn:",Me);try{const We=r.current?.getContext("2d");if(!!We&&r.current&&se){We.save(),We.font="12px Sans-Serif",We.fillStyle="#ffffff",We.strokeStyle="#000000",We.lineWidth=3;const bt=lr,Ye=Y,Ct=he,Bt=(se.doubleInner+se.doubleOuter)/2+14,ft=typeof I=="number"?I:0;for(let Le=0;Le<bt.length;Le++){const ot=Le/bt.length*Math.PI*2-Math.PI/2-ft,Rt=Ye+Bt*Math.cos(ot),kt=Ct+Bt*Math.sin(ot),yt=String(bt[Le]),Dt=We.measureText(yt).width;We.strokeText(yt,Rt-Dt/2,kt+4),We.fillText(yt,Rt-Dt/2,kt+4)}We.restore()}}catch{}return}if(re){const Me=typeof Pe=="number"?Pe:null,We=rn&&rn.length>0,Tt=We?rn.every(Le=>Le.match):null,bt=typeof Me=="number"?Me<=1.5:null,Ye=Tt===!0||bt===!0,Ct=We?rn.some(Le=>!Le.match):bt===!1;console.log("[drawOverlay] Drawing via homography transform");let Bt=0;const ft=(Le,ot,Rt,kt,yt)=>{try{const Kt=qe[ot],kn=qe[Rt];if(se&&Kt&&kn)return v.save(),v.shadowColor="rgba(0,0,0,0.45)",v.shadowBlur=6,v.beginPath(),v.ellipse?(v.ellipse(Y,he,kn*xt,kn,0,0,Math.PI*2),v.ellipse(Y,he,Kt*xt,Kt,0,0,Math.PI*2,!0)):(v.arc(Y,he,kn,0,Math.PI*2),v.arc(Y,he,Kt,0,Math.PI*2,!0)),v.closePath(),v.fillStyle=kt,v.fill(),yt&&(v.strokeStyle=yt,v.lineWidth=2,v.stroke()),v.restore(),!0;const dn=es(Le,Rt,720),Xt=es(Le,ot,720).reverse();if(!dn.length||!Xt.length)return!1;v.save(),v.shadowColor="rgba(0,0,0,0.45)",v.shadowBlur=6,v.beginPath(),v.moveTo(dn[0].x,dn[0].y);for(let Jt=1;Jt<dn.length;Jt++)v.lineTo(dn[Jt].x,dn[Jt].y);for(let Jt=0;Jt<Xt.length;Jt++)v.lineTo(Xt[Jt].x,Xt[Jt].y);return v.closePath(),v.fillStyle=kt,v.fill(),yt&&(v.strokeStyle=yt,v.lineWidth=2,v.stroke()),v.restore(),!0}catch{return!1}};if(Re){const Le=Ye?"rgba(0,255,102,0.12)":Ct?"rgba(255,45,45,0.12)":"rgba(52,211,153,0.08)",ot=Ye?"rgba(0,255,102,0.08)":Ct?"rgba(255,45,45,0.08)":"rgba(253,224,71,0.06)",Rt=Ye?"rgba(0,255,102,0.06)":Ct?"rgba(255,45,45,0.06)":"rgba(34,211,238,0.06)";ft(Re,Ne.bullInner,Ne.bullOuter,Le,"rgba(255,255,255,0.06)"),Bt++;const kt=se?.trebleInner||Ts.trebleInner,yt=se?.trebleOuter||Ts.trebleOuter;ft(Re,kt,yt,ot,"rgba(255,255,255,0.06)"),Bt++;const Dt=se?.doubleInner||Ts.doubleInner,Kt=se?.doubleOuter||Ts.doubleOuter;ft(Re,Dt,Kt,Rt,"rgba(255,255,255,0.06)"),Bt++;try{const dn=[{r:Ne.bullInner,color:Ye?"#00ff66":Ct?"#ff2d2d":"#ffffff",key:"bullInner"},{r:Ne.bullOuter,color:"#ffffff",key:"bullOuter"},{r:kt,color:Ye?"#00ff66":Ct?"#ff2d2d":"#fde047",key:"trebleInner"},{r:yt,color:"#fde047",key:"trebleOuter"},{r:Dt,color:Ye?"#00ff66":Ct?"#ff2d2d":"#22d3ee",key:"doubleInner"},{r:Kt,color:"#22d3ee",key:"doubleOuter"}];for(const Xt of dn){const Jt=qe[Xt.r];let qt;if(se&&Jt){qt=[];for(let Qn=0;Qn<720;Qn++){const Jr=Qn/720*Math.PI*2;qt.push({x:Y+Jt*Math.cos(Jr),y:he+Jt*Math.sin(Jr)})}}else qt=es(Re,Xt.r,720);Ds(v,qt,"rgba(0,0,0,0.45)",3),Ds(v,qt,Xt.color,1.5)}}catch{}}console.log("[drawOverlay] Drew",Bt,"rings via homography");try{const Le=r.current?.getContext("2d");if(!!Le&&r.current){const Rt=Cn(Re||D,{x:0,y:0}),kt=(Ne.doubleInner+Ne.doubleOuter)/2+14,yt=lr;Le.save(),Le.font="12px Sans-Serif",Le.fillStyle="#ffffff",Le.strokeStyle="#000000",Le.lineWidth=3;const Dt=typeof I=="number"?I:0;for(let Kt=0;Kt<yt.length;Kt++){const kn=Kt/yt.length*Math.PI*2-Math.PI/2-Dt,dn=Cn(Re||D,{x:(kt-14)*Math.cos(kn),y:(kt-14)*Math.sin(kn)}),Xt=String(yt[Kt]),Jt=Le.measureText(Xt).width;Le.strokeText(Xt,dn.x-Jt/2,dn.y+4),Le.fillText(Xt,dn.x-Jt/2,dn.y+4)}Le.restore()}}catch{}if(tr.type&&Date.now()<tr.until){const Le=tr.type==="pass",ot=Le?"rgba(0,255,102,0.9)":"rgba(255,45,45,0.9)",Rt=Le?"CALIBRATION PASS":"CALIBRATION FAIL";v.save();const kt=12,yt=_.width-240-kt,Dt=kt;v.fillStyle=ot,v.strokeStyle="rgba(0,0,0,0.25)",v.lineWidth=2,v.beginPath(),v.roundRect(yt,Dt,240,34,8),v.fill(),v.stroke(),v.fillStyle="#00110a",v.font="bold 14px system-ui, sans-serif",v.textBaseline="middle",v.fillText(Rt,yt+12,Dt+17),v.restore()}}if(se&&Lt){console.log("[drawOverlay] Drawing detected circles overlay:",{adjustedCx:Math.round(Y),adjustedCy:Math.round(he),doubleOuter:Math.round(se.doubleOuter),trebleOuter:Math.round(se.trebleOuter),bullOuter:Math.round(se.bullOuter)});const Me=(We,Tt,bt=2)=>{if(!Number.isFinite(We)||We<=0)return;v.save(),v.strokeStyle=Tt,v.lineWidth=bt,v.setLineDash([5,5]),v.beginPath();const Ye=xt,Ct=We*Ye,Bt=We*Ye;v.ellipse?v.ellipse(Y,he,Ct,Bt,0,0,Math.PI*2):v.arc(Y,he,We,0,Math.PI*2),v.stroke(),v.restore()};if(Me(se.doubleOuter,"#ff6b6b",3),Me(se.doubleInner,"#ff6b6b",2),Me(se.trebleOuter,"#ffd93d",2),Me(se.trebleInner,"#ffd93d",2),Me(se.bullOuter,"#6bcf7f",2),Me(se.bullInner,"#6bcf7f",3),Re&&!en){const We=(Tt,bt)=>{const Ye=es(Re,Tt,180);if(Ye.length){v.save(),v.setLineDash([6,4]),v.strokeStyle=bt,v.lineWidth=2,v.beginPath(),v.moveTo(Ye[0].x,Ye[0].y);for(let Ct=1;Ct<Ye.length;Ct++)v.lineTo(Ye[Ct].x,Ye[Ct].y);v.closePath(),v.stroke(),v.restore()}};We(Ne.doubleOuter,"#00ffff"),We(Ne.trebleOuter,"#ffff00")}}se&&(v.save(),v.fillStyle="rgba(0,0,0,0.65)",v.fillRect(8,8,260,72),v.fillStyle="#fff",v.font="12px system-ui, sans-serif",v.fillText(`Detected cx:${Math.round(se.cx)} cy:${Math.round(se.cy)}`,16,28),v.fillText(`Double: ${Math.round(se.doubleOuter)} Treble: ${Math.round(se.trebleOuter)}`,16,48),v.fillText(`Adjusts: Sx:${xt.toFixed(3)} Tx:${Zt} Ty:${an}`,16,68),v.restore());const Xe=_n("outer");if(h.length>=4&&h.length<Xe.length&&D){v.save(),v.strokeStyle="rgba(255,193,7,0.4)",v.lineWidth=2,v.setLineDash([4,4]);for(let Me=h.length;Me<Xe.length;Me++)try{const We=Cn(Re||D,Xe[Me]);v.beginPath(),v.arc(We.x,We.y,12,0,Math.PI*2),v.stroke(),v.save(),v.fillStyle="rgba(255,255,255,0.65)",v.font="12px sans-serif",v.fillText(ns[Me]??String(Me+1),We.x+10,We.y-10),v.restore()}catch{}v.restore()}if(h.length<cr&&(v.save(),v.fillStyle="rgba(0,0,0,0.7)",v.fillRect(10,10,200,40),v.fillStyle="#fbbf24",v.font="bold 16px sans-serif",v.fillText(`Click on ${ns[h.length]}`,20,36),v.restore()),h.forEach((Me,We)=>{Uo(v,Me,"#f472b6"),v.save(),v.fillStyle="#f472b6",v.font="14px sans-serif",v.fillText(ns[We]??String(We+1),Me.x+6,Me.y-6),v.restore()}),we&&!ne){v.save(),v.fillStyle="rgba(59,130,246,0.10)";const Me=Math.round(Math.min(_.width,_.height)*.08),We=_.width-Me*2,Tt=_.height-Me*2;v.fillRect(Me,Me,We,Tt),v.strokeStyle="rgba(34,197,94,0.9)",v.lineWidth=2,v.beginPath(),v.moveTo(Me,_.height/2),v.lineTo(_.width-Me,_.height/2),v.stroke(),v.beginPath(),v.moveTo(_.width/2,Me),v.lineTo(_.width/2,_.height-Me),v.stroke(),v.strokeStyle="rgba(234,179,8,0.9)",v.setLineDash([6,4]);const bt=Me+30,Ye=Me+30;v.beginPath(),v.moveTo(bt,Ye+30),v.lineTo(bt+60,Ye),v.stroke(),v.beginPath(),v.moveTo(_.width-bt,Ye+30),v.lineTo(_.width-bt-60,Ye),v.stroke(),v.restore(),v.save(),v.scale(1/L,1/L),v.fillStyle="rgba(255,255,255,0.85)",v.font="12px sans-serif",v.fillText("Tip: Frame board centered, edges parallel; slight top-down is okay. Keep bull near center.",Me*L,(Me+18)*L),v.restore()}}const qr=h=>{if(!h)return;Be(!1),$e(null),It(!1),h.anchors?.dst&&h.anchors.dst.length>0&&(w(h.anchors.dst),pn(h.anchors.dst,h.H));let D=h.H;xt!==1&&(D=Fs(D,xt,1)),(Zt!==0||an!==0)&&(D=ha(D,Zt,an)),G({H:D,createdAt:Date.now(),errorPx:h.errorPx,imageSize:h.imageSize,overlaySize:h.overlaySize,anchors:h.anchors,locked:h.locked}),T(h.phase??"computed"),fe(h.confidence??100),Gt("Test auto-detect applied"),delete globalThis.__TEST_AUTO_DETECT_RESULT};function Gs(h){if(console.debug("[Calibrator] onClickOverlay entry",j,h.type),h.stopPropagation(),h.preventDefault(),j!=="select"&&j!=="computed"&&!((j==="camera"||j==="capture")&&ct))return;const R=h.target,_=R.getBoundingClientRect(),v=h.clientX-_.left,re=h.clientY-_.top,ee=R.width>0?R.width/(_.width||n.current?.clientWidth||_.width):1,X=R.height>0?R.height/(_.height||n.current?.clientHeight||_.height):1,be=v*ee,me=re*X;if(console.debug("[Calibrator] onClickOverlay css/x/y",{cssX:v,cssY:re,scaleX:ee,scaleY:X,x:be,y:me}),j==="select"){console.log("[Calibrator] Adding point. Current dstPoints.length:",x.length,"New point:",{x:be,y:me});const xe=[...x,{x:be,y:me}];if(console.log("[Calibrator] After add, pts.length:",xe.length,"REQUIRED:",cr),xe.length<=cr)if(w(xe),xe.length>=4){const ke=_n("outer"),Ee=qn(ke.slice(0,4),xe.slice(0,4));pn(xe,Ee)}else pn(xe);return}const Y=globalThis.__TEST_CALIBRATION_CLICK_VALUE;let he=null,Ve="",qe=null;try{if(typeof Y=="number")he=Y,Ve=`TEST ${he}`,qe={scoreObj:{base:he,mult:1,ring:"SINGLE",sector:null},pBoard:{x:0,y:0}},delete globalThis.__TEST_CALIBRATION_CLICK_VALUE;else{const xe=En.getState?En.getState():void 0,ke=xe?.H??q,Ee=xe?.imageSize??ce;if(console.debug("[Calibrator] onClickOverlay state",{Hcur:ke,imgSize:Ee}),!ke||!r.current||!Ee)return;const Re=r.current,Xe=Re.getBoundingClientRect(),gn=n.current&&n.current.width?n.current.width:Xe.width,Me=n.current&&n.current.height?n.current.height:Xe.height,We=Re.width&&Ee.w?Re.width/Ee.w:gn/Ee.w,Tt=Re.height&&Ee.h?Re.height/Ee.h:Me/Ee.h;console.debug("[Calibrator] onClickOverlay dims",{oWidth:Re.width,oHeight:Re.height,rectWidth:Xe.width,rectHeight:Xe.height,fallbackWidth:gn,fallbackHeight:Me,sx:We,sy:Tt});const bt=Xe.width||gn,Ye=Xe.height||Me,Ct=bt?v/bt:0,Bt=Ye?re/Ye:0,ft={x:Ct*Ee.w,y:Bt*Ee.h},Le=Zn(ke,ft);if(console.debug("[Calibrator] onClickOverlay pCal/pBoard",ft,Le),!Le){console.warn("[Calibrator] Failed to map point to board - homography inversion failed");return}const ot=wr(Le,typeof I=="number"?I:0,B??0);qe={scoreObj:ot,pBoard:Le},he=ot.base,(ot.ring==="BULL"||ot.ring==="INNER_BULL")&&Yt(ft),console.debug("[Calibrator] autoCommitTestMode",ct),ct&&he===0&&(he=25),Ve=`${ot.ring} ${he}`.trim()}if(he==null)return;Z(he),console.debug("[Calibrator] onClickOverlay detected",he,Ve),Ze(Ve);try{const xe=En.getState?En.getState():void 0,ke=!!xe?.H&&!!xe?.imageSize&&(xe.locked||typeof xe.errorPx=="number"&&xe.errorPx<=de);ct&&!Ut&&ke&&mt.getState().inProgress&&Mr(he)}catch{}if(ct&&Ut&&mt.getState().inProgress){const xe=En.getState?En.getState():void 0,ke=!!xe?.H&&!!xe?.imageSize&&(xe.locked||typeof xe.errorPx=="number"&&xe.errorPx<=de);if(!ke)console.debug("[Calibrator] immediate autocommit skipped due to invalid calibration",{calibrationValidSt2:ke});else{const Ee=mt.getState().roomId!=="";if(console.debug("[Calibrator] immediate-branch conditions",{autoCommitTestMode:ct,autoCommitImmediate:Ut,inProgress:mt.getState().inProgress,isOnline:Ee}),Ee){if(oe)if(!qe)console.debug("[Calibrator] immediate autocommit skipped, detection metadata missing");else{const{pBoard:Re,scoreObj:Xe}=qe;try{console.debug("[Calibrator] sending auto-visit",{roomId:mt.getState().roomId,allowAutocommitInOnline:oe}),Cr().send({type:"auto-visit",roomId:mt.getState().roomId,value:he,darts:3,ring:Xe.ring,sector:Xe.sector,pBoard:Re,calibrationValid:!0})}catch(gn){console.debug("[Calibrator] immediate autocommit remote send failed",gn)}}}else{const Re=`${he}|3`,Xe=performance.now();if(!Wt.current&&!(Re===yn.current&&Xe-wn.current<mn)){yn.current=Re,wn.current=Xe,Wt.current=!0,mt.getState().addVisit(he,3,{visitTotal:he});try{window.setTimeout(()=>{Wt.current=!1},Math.max(120,mn))}catch{}}}}}}catch{}}function Mr(h){try{const D=typeof h=="number"?h:p;console.debug("[Calibrator] doCommit invoked",{v:D,inProgress:mt.getState().inProgress});const R=En.getState?En.getState():void 0,_=!!R?.H&&!!R?.imageSize&&(R.locked||typeof R.errorPx=="number"&&R.errorPx<=de);if(D!=null&&mt.getState().inProgress&&_){const v=`${D}|3`,re=performance.now();if(!Wt.current&&!(v===yn.current&&re-wn.current<mn)){yn.current=v,wn.current=re,Wt.current=!0,console.debug("[Calibrator] doCommit: committing visit",D,{calState:R,curCalValid:_});try{mt.getState().addVisit(D,3,{visitTotal:D})}catch{}try{window.setTimeout(()=>{Wt.current=!1},Math.max(120,mn))}catch{}}else console.debug("[Calibrator] doCommit: deduped commit skipped",{v:D,curCalValid:_,sig:v})}else console.debug("[Calibrator] doCommit: NOT committing (invalid cal or no match)",{v:D,inProgress:mt.getState().inProgress,curCalValid:_,calState:R})}catch{}}function js(){if(!n.current)return!1;if(x.length<cr)return alert("Please click all 5 calibration points: D20, D6, D3, D11, and Bullseye (center)."),!1;try{const h=_n("outer"),D=x.slice(0,5),R=qn(h,D);pn(x,R);const _=Gn(R,h,D),v=r?.current?{w:r.current.width,h:r.current.height}:t?.current?{w:t.current.clientWidth,h:t.current.clientHeight}:{w:n.current.width,h:n.current.height},re=t.current?{w:t.current.videoWidth,h:t.current.videoHeight}:{w:n.current.width,h:n.current.height};return G({H:R,createdAt:Date.now(),errorPx:_,imageSize:re,overlaySize:v,anchors:{src:h,dst:x}}),fe(100),T("computed"),!0}catch(h){return console.error("[Calibrator] Compute failed:",h),alert("Calibration computation failed. Please try resetting points."),!1}}function xr(){if(!q||!r.current){alert("Please compute calibration first (lock) before running verification.");return}const h=H?.dst&&H.dst.length>=4?H.dst:x;if(h.length<4){alert("Select at least the four double-ring anchors before running verification.");return}const R=r.current.getContext("2d");if(!R){console.warn("[Calibrator] Overlay context missing for verification");return}pn(h,q);const _=_n("outer"),v=Is.map(ee=>{const X=h[ee.idx],be=_[ee.idx];if(!X||!be)return{label:ee.label,expected:{ring:ee.ring,sector:ee.sector},detected:null,deltaMm:null,deltaPx:null,match:!1,note:"Point missing â€” click this anchor to verify"};const me=Cn(q,be),Y=Zn(q,X);if(!Y)return{label:ee.label,expected:{ring:ee.ring,sector:ee.sector},detected:null,deltaMm:null,deltaPx:null,match:!1,note:"Homography inversion failed - recalibrate"};const he=wr(Y,typeof I=="number"?I:0,B??0),Ve=Math.hypot(Y.x-be.x,Y.y-be.y),qe=Math.hypot(X.x-me.x,X.y-me.y),xe=ee.ring==="INNER_BULL"?he.ring==="INNER_BULL"||he.ring==="BULL":he.ring===ee.ring,ke=ee.sector==null||he.sector===ee.sector,Ee=Ve<=ee.toleranceMm,Re=xe&&ke&&Ee;console.log(`[Verification] ${ee.label}:`,{anchor:ee,actualPoint:{x:X.x.toFixed(1),y:X.y.toFixed(1)},expectedBoard:{x:be.x.toFixed(2),y:be.y.toFixed(2)},projectedImage:{x:me.x.toFixed(1),y:me.y.toFixed(1)},boardFromActual:{x:Y.x.toFixed(2),y:Y.y.toFixed(2)},detectedScore:he,deltaMm:Ve.toFixed(2),deltaPx:qe.toFixed(1),toleranceMm:ee.toleranceMm,ringMatch:xe,sectorMatch:ke,withinTolerance:Ee,match:Re}),Uo(R,X,Re?"#10b981":"#ef4444"),R.save(),R.fillStyle=Re?"#10b981":"#ef4444",R.font="12px sans-serif",R.fillText(`${ee.label} Â· ${Ve.toFixed(1)}mm`,X.x+6,X.y-6),R.restore();let Xe;return!xe||!ke?Xe="Sector/ring mismatch":Ee||(Xe=`Off by ${Ve.toFixed(1)}mm (limit Â±${ee.toleranceMm}mm)`),{label:ee.label,expected:{ring:ee.ring,sector:ee.sector},detected:he,deltaMm:Ve,deltaPx:qe,match:Re,note:Xe}});zt(v),console.log("[Calibrator] Verification complete:",v);const re=v.every(ee=>ee.match);fr(re,1500)}async function Js(){if(!q){alert("Please save the calibration first (click Save).");return}rn.length===0&&(console.log("[Calibrator] Verification not run yet, running now before resize..."),xr(),await new Promise(v=>setTimeout(v,100)));const h=_n("outer"),D=H?.dst&&H.dst.length>=4?H.dst:x;if(D.length<5){alert("Need at least 5 calibration points to resize.");return}console.log("[Calibrator] Starting AGGRESSIVE resize: Recomputing homography from all 5 points");const R=h.slice(0,5),_=D.slice(0,5);try{const v=qn(R,_);console.log("[Calibrator] Recomputed homography from 5 points");const re=Is.map(he=>{const Ve=D[he.idx],qe=h[he.idx];if(!Ve||!qe)return{match:!1,deltaMm:null,ringMatch:!1,sectorMatch:!1};const xe=Zn(v,Ve);if(!xe)return{match:!1,deltaMm:null,ringMatch:!1,sectorMatch:!1};const ke=wr(xe,typeof I=="number"?I:0,B??0),Ee=Math.hypot(xe.x-qe.x,xe.y-qe.y),Re=he.ring==="INNER_BULL"?ke.ring==="INNER_BULL"||ke.ring==="BULL":ke.ring===he.ring,Xe=he.sector==null||ke.sector===he.sector,gn=Ee<=he.toleranceMm,Me=Re&&Xe&&gn;return console.log(`  Anchor ${he.label}: ring=${Re}, sector=${Xe}, deltaMm=${Ee.toFixed(2)}`),{match:Me,deltaMm:Ee,ringMatch:Re,sectorMatch:Xe,detectedScore:ke,expectedBoard:qe}}),ee=re.filter(he=>he.match).length,X=re.length;console.log(`[Calibrator] Result: ${ee}/${X} anchors pass`);const be=r?.current?{w:r.current.width,h:r.current.height}:t?.current?{w:t.current.clientWidth,h:t.current.clientHeight}:{w:n.current.width,h:n.current.height},me=t.current?{w:t.current.videoWidth,h:t.current.videoHeight}:{w:n.current.width,h:n.current.height},Y=Gn(v,R,_);G({H:v,createdAt:Date.now(),errorPx:Y,imageSize:me,overlaySize:be,anchors:{src:R,dst:_}}),pn(D,v),Gr(v),ee===X?(console.log("[Calibrator] âœ… PERFECT! All 5 anchors pass!"),alert(`âœ… PERFECT CALIBRATION!

All 5 anchors pass! Your dartboard is perfectly calibrated.`)):(console.warn(`[Calibrator] Only ${ee}/5 anchors pass. Anchors may be clicked incorrectly.`),alert(`âš ï¸ Resize Result: ${ee}/5 anchors pass.

The anchors showing red "Adjust" may have been clicked on the wrong ring.

Please re-click those anchors more carefully, then try Resize again.`))}catch(v){console.error("[Calibrator] Error recomputing homography:",v),alert(`âŒ Error: Could not recompute calibration.

Your anchor clicks may be invalid.

Please recalibrate from scratch.`)}}function Gr(h){const D=_n("outer"),R=H?.dst&&H.dst.length>=4?H.dst:x;if(R.length<4)return;const _=Is.map(v=>{const re=R[v.idx],ee=D[v.idx];if(!re||!ee)return{label:v.label,expected:{ring:v.ring,sector:v.sector},detected:null,deltaMm:null,deltaPx:null,match:!1,note:"Point missing â€” click this anchor to verify"};const X=Cn(h,ee),be=Zn(h,re);if(!be)return{label:v.label,expected:{ring:v.ring,sector:v.sector},detected:null,deltaMm:null,deltaPx:null,match:!1,note:"Homography inversion failed - recalibrate"};const me=wr(be,typeof I=="number"?I:0,B??0),Y=Math.hypot(be.x-ee.x,be.y-ee.y),he=Math.hypot(re.x-X.x,re.y-X.y),Ve=v.ring==="INNER_BULL"?me.ring==="INNER_BULL"||me.ring==="BULL":me.ring===v.ring,qe=v.sector==null||me.sector===v.sector,xe=Y<=v.toleranceMm,ke=Ve&&qe&&xe;let Ee;return!Ve||!qe?Ee="Sector/ring mismatch":xe||(Ee=`Off by ${Y.toFixed(1)}mm (limit Â±${v.toleranceMm}mm)`),{label:v.label,expected:{ring:v.ring,sector:v.sector},detected:me,deltaMm:Y,deltaPx:he,match:ke,note:Ee}});try{const v=[];for(const re of _)if(re.expected.ring==="DOUBLE"&&re.expected.sector!=null&&re.detected?.sector!=null){const ee=re.expected.sector,X=re.detected.sector,be=lr.indexOf(ee),me=lr.indexOf(X);if(be>=0&&me>=0){let Y=me-be;Y>10&&(Y-=20),Y<-10&&(Y+=20),v.push(Y)}}if(v.length>=3){const re=new Map;for(const me of v)re.set(me,(re.get(me)??0)+1);let ee=0,X=0;for(const[me,Y]of re.entries())Y>X&&(X=Y,ee=me);const be=B??0;X>=2&&ee!==be&&G({sectorOffset:ee})}}catch{}zt(_)}async function Rn(){try{if(console.debug("[Calibrator] autoDetectRings invoked"),!n.current){alert("Load a photo or capture a frame first."),Be(!1);return}const h=globalThis.__TEST_AUTO_DETECT_RESULT;if(h){console.debug("[Calibrator] testAutoDetectResult detected (legacy)"),qr(h);return}Be(!0),Gt("Using advanced detection algorithm..."),Ge(null);const D=_r(n.current,Fe?{centerHint:Fe,colorAssist:!0}:{colorAssist:!0});if(console.log("[Calibrator] detectBoard returned:",{success:D.success,confidence:D.confidence,hasHomography:!!D.homography,numPoints:D.calibrationPoints.length},D.message),!D.success||!D.homography||D.confidence<40){console.warn("[Calibrator] Auto-detect failed, result:",{success:D.success,confidence:D.confidence,hasHomography:!!D.homography}),Gt(D.message||"âŒ Detection failed. Try better lighting or different angle."),Be(!1);return}$e({cx:D.cx,cy:D.cy,bullInner:D.bullInner,bullOuter:D.bullOuter,trebleInner:D.trebleInner,trebleOuter:D.trebleOuter,doubleInner:D.doubleInner,doubleOuter:D.doubleOuter}),It(!0),w(D.calibrationPoints),pn(D.calibrationPoints,D.homography);const R=r?.current?{w:r.current.width,h:r.current.height}:t?.current?{w:t.current.clientWidth,h:t.current.clientHeight}:{w:n.current.width,h:n.current.height},_=t.current?{w:t.current.videoWidth,h:t.current.videoHeight}:{w:n.current.width,h:n.current.height},v=Fo(D.homography,"outer");G({H:D.homography,createdAt:Date.now(),errorPx:D.errorPx??null,imageSize:_,overlaySize:R,anchors:{src:_n("outer").slice(0,4),dst:D.calibrationPoints},theta:typeof D.theta=="number"?D.theta:null,sectorOffset:v});const re=zn(D.homography,D.calibrationPoints);zt(re),T("verify"),fe(ht?100:Math.round(D.confidence)),Gt("âœ… Detected rings â€” Please verify alignment by looking at the overlay"),Be(!1);try{let X=1;for(let me=1;me<3;me++){const Y=document.createElement("canvas");Y.width=Math.max(1,Math.round(n.current.width*.9)),Y.height=Math.max(1,Math.round(n.current.height*.9)),Y.getContext("2d").drawImage(n.current,0,0,Y.width,Y.height);const Ve=Fe?{centerHint:{x:Fe.x*.9,y:Fe.y*.9},colorAssist:!0}:{colorAssist:!0},qe=_r(Y,Ve);rr(D,qe)&&X++}X>=Math.ceil(3*.66)&&console.log("[Calibrator] Detection is stable")}catch(ee){console.warn("[Calibrator] Legacy stability check failed:",ee)}}catch(h){console.error("[Calibrator] autoDetectRings failed:",h),Gt(`âŒ Auto-detect failed: ${h instanceof Error?h.message:String(h)}`),Be(!1)}}function zn(h,D){const R=[];if(!h||!D||D.length===0)return R;for(const _ of Is){if(_.idx>=D.length)continue;const v=D[_.idx];let re=null;try{re=Zn(h,v)}catch(Y){console.warn("[Calibrator] Failed to convert image point to board space:",Y)}let ee=null,X=null,be=null,me=!1;if(re)try{if(ee=wr(re,typeof I=="number"?I:0,B??0),ee.ring===_.ring&&ee.sector===_.sector)me=!0,X=0;else{const Y=Ne[_.ring==="DOUBLE"?"doubleOuter":_.ring==="INNER_BULL"?"bullInner":_.ring==="BULL"?"bullOuter":"doubleOuter"],he=Math.hypot(re.x,re.y);X=Math.abs(he-Y),be=Math.hypot(v.x-(se?.cx??0),v.y-(se?.cy??0)),me=X<=_.toleranceMm}}catch(Y){console.warn("[Calibrator] Failed to score detected point:",Y)}R.push({label:_.label,expected:{ring:_.ring,sector:_.sector},detected:ee,deltaMm:X,deltaPx:be,match:me,note:me?"âœ… OK":`âŒ Off by ${X?.toFixed(1)}mm`})}return R}function rr(h,D,R=.03){if(!h||!D)return!1;const _=Math.abs((h.cx-D.cx)/(h.cx||1)),v=Math.abs((h.cy-D.cy)/(h.cy||1)),re=Math.abs((h.doubleOuter-D.doubleOuter)/(h.doubleOuter||1));return _<=R&&v<=R&&re<=R}const Or=i.useRef(null);i.useEffect(()=>{let h=null;try{h=new Worker(new URL("/assets/boardDetection.worker-WM04hdAk.js",import.meta.url),{type:"module"}),Or.current=h,console.log("[Calibrator] Board detection worker created")}catch(D){console.warn("[Calibrator] Failed to create board detection worker, will fallback to main thread: ",D),Or.current=null}return()=>{try{h?.terminate()}catch{}}},[]);async function Ss(){if(!n.current){alert("Capture a frame or upload a photo first.");return}const h=globalThis.__TEST_AUTO_DETECT_RESULT;if(h){qr(h);return}if(Or.current){Be(!0);let D=null;try{D=await createImageBitmap(n.current)}catch(R){console.warn("[Calibrator] createImageBitmap failed; falling back to main thread detection",R),D=null}if(!D)return Be(!1),vr();try{const R=Or.current;return R?new Promise(_=>{let v;const re=async ee=>{try{if(ee.data&&ee.data.error){const X=ee.data.error||"Auto-calibration failed";alert(`Auto-calibration failed: ${X}`),Gt(X),Be(!1),v&&clearTimeout(v),R.removeEventListener("message",re),_();return}if(ee.data&&ee.data.type==="result"){const X=ee.data.detection;if(ht&&(X.confidence=100),!X.homography||!Array.isArray(X.calibrationPoints)||X.calibrationPoints.length<4){const Y=X.calibrationPoints||[];if(Y.length>=4){const he=[{x:0,y:-Ne.doubleOuter},{x:Ne.doubleOuter,y:0},{x:0,y:Ne.doubleOuter},{x:-Ne.doubleOuter,y:0}];try{const Ve=qn(he,Y.slice(0,4));X.homography=Ve,X.errorPx=Gn(Ve,he,Y.slice(0,4))}catch(Ve){console.warn("[Calibrator] Worker homography compute failed",Ve)}}}if(!X.success||!X.homography||!ht&&X.confidence<40){alert(`âŒ Board Detection Failed

Confidence: ${Math.round(X.confidence)}%

${X.message}

Try:
â€¢ Better lighting
â€¢ Closer camera angle
â€¢ Make sure entire board is visible
â€¢ Use manual calibration instead (click the 4 double-ring points: D20, D6, D3, D11)`),Be(!1),v&&clearTimeout(v),R.removeEventListener("message",re),_();return}$e({cx:X.cx,cy:X.cy,bullInner:X.bullInner,bullOuter:X.bullOuter,trebleInner:X.trebleInner,trebleOuter:X.trebleOuter,doubleInner:X.doubleInner,doubleOuter:X.doubleOuter}),w(X.calibrationPoints),console.log("[Calibrator] Auto-detect: Drawing overlay at detected center (",Math.round(X.cx),",",Math.round(X.cy),") with calibration points:",X.calibrationPoints.map(Y=>`(${Math.round(Y.x)},${Math.round(Y.y)})`).join(" ")),pn(X.calibrationPoints,X.homography);let be=(X.errorPx??Number.POSITIVE_INFINITY)<=2;try{let Y=1;const he=3;for(let qe=1;qe<he;qe++){await new Promise(gn=>setTimeout(gn,0));const xe=document.createElement("canvas");xe.width=Math.max(1,Math.round(n.current.width*.8)),xe.height=Math.max(1,Math.round(n.current.height*.8)),xe.getContext("2d").drawImage(n.current,0,0,xe.width,xe.height);const Ee=xe.width/n.current.width,Re=Fe?{centerHint:{x:Fe.x*Ee,y:Fe.y*Ee}}:void 0,Xe=_r(xe,Re);rr(X,Xe)&&Y++}const Ve=Y>=Math.ceil(he*.66);be=be&&Ve}catch{}const me=r?.current?{w:r.current.width,h:r.current.height}:t?.current?{w:t.current.clientWidth,h:t.current.clientHeight}:{w:n.current?.width??0,h:n.current?.height??0};G({H:X.homography,createdAt:Date.now(),errorPx:X.errorPx??null,imageSize:{w:n.current?.width??0,h:n.current?.height??0},overlaySize:me,anchors:{src:_n("outer").slice(0,4),dst:X.calibrationPoints},locked:be?!0:ne}),Gt(X.message??`Auto-calibration success (confidence ${Math.round(X.confidence)}%)`),T("computed"),fe(ht?100:Math.round(X.confidence)),G({errorPx:X.errorPx??null}),Be(!1),R.removeEventListener("message",re),_();return}}catch(X){console.warn("[Calibrator] Worker message processing failed",X),Be(!1),R.removeEventListener("message",re),_();return}};R.addEventListener("message",re),R.postMessage({type:"detect",bitmap:D},[D]),v=setTimeout(()=>{Qt&&(console.warn("[Calibrator] Worker timed out, attempting sync fallback"),Be(!1),v&&clearTimeout(v),R.removeEventListener("message",re),vr().catch(ee=>console.error("[Calibrator] Fallback sync detection failed:",ee)))},8e3)}):vr()}catch(R){return console.warn("[Calibrator] AutoCalibrate worker payload failed",R),Be(!1),await vr()}}else return await vr()}async function vr(){try{Be(!0),await new Promise(me=>setTimeout(me,0));let h=_r(n.current,Fe?{centerHint:Fe,colorAssist:!0}:{colorAssist:!0});if(h=h,ht&&(h.confidence=100),await new Promise(me=>setTimeout(me,0)),!h.homography||!Array.isArray(h.calibrationPoints)||h.calibrationPoints.length<4)try{const me=h.calibrationPoints||[];if(me.length>=4){const Y=[{x:0,y:-Ne.doubleOuter},{x:Ne.doubleOuter,y:0},{x:0,y:Ne.doubleOuter},{x:-Ne.doubleOuter,y:0}],he=qn(Y,me.slice(0,4));h.homography=he,h.errorPx=Gn(he,Y,me.slice(0,4))}}catch(me){console.warn("[Calibrator] sync forced homography compute failed",me)}if(!h.success||!h.homography||!ht&&h.confidence<50){const me=[.9,.8,1.1,1.2];for(const Y of me)try{await new Promise(Ee=>setTimeout(Ee,0));const he=n.current,Ve=document.createElement("canvas");Ve.width=Math.max(1,Math.round(he.width*Y)),Ve.height=Math.max(1,Math.round(he.height*Y));const qe=Ve.getContext("2d");if(!qe)continue;qe.drawImage(he,0,0,Ve.width,Ve.height);const xe=Fe?{centerHint:{x:Fe.x*Y,y:Fe.y*Y},colorAssist:!0}:{colorAssist:!0};let ke=_r(Ve,xe);if(ke=ke,ke.success&&ke.homography){const Ee=1/Y;ke.cx*=Ee,ke.cy*=Ee,ke.bullInner*=Ee,ke.bullOuter*=Ee,ke.trebleInner*=Ee,ke.trebleOuter*=Ee,ke.doubleInner*=Ee,ke.doubleOuter*=Ee,ke.calibrationPoints=ke.calibrationPoints.map(Re=>({x:Re.x*Ee,y:Re.y*Ee})),h=ke;break}}catch{}}if(!h.success||!h.homography||!ht&&h.confidence<50){alert(`âŒ Board Detection Failed

Confidence: ${Math.round(h.confidence)}%

${h.message}

Try:
â€¢ Better lighting
â€¢ Closer camera angle
â€¢ Make sure entire board is visible
â€¢ Use manual calibration instead (click the 4 double-ring points: D20, D6, D3, D11)`),Gt(h.message??null),Be(!1);return}await new Promise(me=>setTimeout(me,0)),$e({cx:h.cx,cy:h.cy,bullInner:h.bullInner,bullOuter:h.bullOuter,trebleInner:h.trebleInner,trebleOuter:h.trebleOuter,doubleInner:h.doubleInner,doubleOuter:h.doubleOuter}),w(h.calibrationPoints),pn(h.calibrationPoints,h.homography);const D=(h.errorPx??Number.POSITIVE_INFINITY)<=2;let R=1;const _=3;for(let me=1;me<_;me++)try{await new Promise(xe=>setTimeout(xe,0));const Y=document.createElement("canvas");Y.width=Math.max(1,Math.round(n.current.width*.9)),Y.height=Math.max(1,Math.round(n.current.height*.9)),Y.getContext("2d").drawImage(n.current,0,0,Y.width,Y.height);const Ve=Fe?{centerHint:{x:Fe.x*.9,y:Fe.y*.9},colorAssist:!0}:{colorAssist:!0},qe=_r(Y,Ve);rr(h,qe)&&R++}catch{}const v=R>=Math.ceil(_*.66),re=D&&v,ee=r?.current?{w:r.current.width,h:r.current.height}:t?.current?{w:t.current.clientWidth,h:t.current.clientHeight}:{w:n.current.width,h:n.current.height},X=t.current?{w:t.current.videoWidth,h:t.current.videoHeight}:{w:n.current.width,h:n.current.height},be=Fo(h.homography,"outer");G({H:h.homography,createdAt:Date.now(),errorPx:h.errorPx??null,imageSize:X,overlaySize:ee,anchors:{src:_n("outer").slice(0,4),dst:h.calibrationPoints},locked:re?!0:ne,theta:h.theta,sectorOffset:be}),T("computed"),fe(ht?100:Math.round(h.confidence)),G({errorPx:h.errorPx??null}),Gt(h.message??null),Be(!1)}catch(h){console.error("[Calibrator] autoCalibrateSync failed:",h);const D=h instanceof Error?h.message:String(h);Gt(`âŒ Auto-calibration failed: ${D}`),Be(!1)}}function sr(){if(!n.current)return alert("Capture a frame or upload a photo first.");const h=Xd(n.current);if(Ge(h),!h.success||!h.homography){const re=h.missing.length?` Missing markers: ${h.missing.map(be=>`${be.toUpperCase()} (ID ${Yd[be]})`).join(", ")}`:"",ee=h.markersFound.length>0?`

Detected ${h.markersFound.length} markers with IDs: ${h.markersFound.map(be=>be.id).join(", ")}`:`

No markers detected. Make sure markers are on white paper, fully visible, and well-lit.`,X=`${h.message}${re}${ee}

You can still use manual calibration: click the 4 double-ring points (D20, D6, D3, D11).`;alert(X);return}$e(null),w(h.points),pn(h.points,h.homography);const D=_n("outer"),R={w:n.current.width,h:n.current.height},_=r?.current?{w:r.current.width,h:r.current.height}:t?.current?{w:t.current.clientWidth,h:t.current.clientHeight}:{w:n.current.width,h:n.current.height},v=(h.errorPx??Number.POSITIVE_INFINITY)<=1.2;G({H:h.homography,createdAt:Date.now(),errorPx:h.errorPx??null,imageSize:R,overlaySize:_,anchors:{src:D,dst:h.points},locked:v?!0:ne}),T("computed")}if(i.useEffect(()=>{pn()},[C,q,xt,Zt,an]),i.useEffect(()=>{if(!jt||!f)return;let h=0;const D=()=>{try{br()}catch{}h=requestAnimationFrame(D)};return h=requestAnimationFrame(D),()=>cancelAnimationFrame(h)},[jt,f]),i.useEffect(()=>{(async()=>{try{if(!ne||!Ht)return;const h=n.current?{w:n.current.width,h:n.current.height}:null,D=JSON.stringify({H:q,anchors:null,imageSize:h,errorPx:Pe??null});try{await xn(`/cam/calibration/${Ht}`,{method:"POST",headers:{"Content-Type":"application/json"},body:D}),console.log("[Calibrator] Posted calibration for code",Ht)}catch(R){console.warn("[Calibrator] Upload calibration failed",R)}try{const R=localStorage.getItem("authToken");R&&(await xn("/api/user/calibration",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${R}`},body:D}),console.log("[Calibrator] Synced calibration to user account"))}catch(R){console.warn("[Calibrator] User calibration sync failed",R)}}catch{}})()},[ne,Ht]),ie&&!U){const h=vs??(typeof window<"u"?`${window.location.origin.replace(/\/$/,"")}/mobile-cam.html`:"/mobile-cam.html");return e.jsxs("div",{className:"mx-auto flex min-h-[calc(100vh-140px)] w-full max-w-xl flex-col justify-center gap-6 p-6",children:[e.jsxs("div",{className:"space-y-5 rounded-3xl border border-indigo-400/30 bg-slate-900/70 p-6 text-slate-100 shadow-xl",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-xs font-semibold uppercase tracking-wide text-indigo-300",children:"Mobile camera"}),e.jsx("h2",{className:"text-2xl font-semibold leading-tight text-white",children:"This device is ready to stream as your dartboard camera"}),e.jsx("p",{className:"text-sm text-slate-200/80",children:"Open the lightweight mobile camera page to stream video to your desktop calibrator. You can still come back here if you need the full desktop tools."})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("a",{href:h,className:"btn w-full justify-center px-4 py-2 text-base",children:"Open mobile camera"}),e.jsx("button",{type:"button",className:"btn btn--ghost w-full justify-center px-4 py-2 text-sm",onClick:()=>Ar(h,"link"),children:xs==="link"?"Link copied!":"Copy link"})]}),e.jsxs("p",{className:"text-xs text-slate-300/70",children:["On a desktop, open Calibrator and generate a pairing code. Then tap"," ",e.jsx("span",{className:"font-semibold",children:"Pair with Desktop"})," from the mobile camera page to connect this device."]})]}),e.jsx("button",{type:"button",className:"self-center text-xs font-medium text-indigo-200 underline decoration-dotted decoration-indigo-300/70 transition hover:text-indigo-100",onClick:()=>te(!0),children:"Continue to desktop calibrator"})]})}return e.jsxs("div",{className:"space-y-6",children:[ie&&U&&e.jsx("div",{className:"rounded-2xl border border-indigo-400/30 bg-indigo-500/10 p-4 text-sm text-indigo-100",children:e.jsxs("div",{className:"flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between",children:[e.jsx("p",{className:"leading-relaxed",children:"Using a phone? Switch back to the streamlined mobile camera interface for an easier pairing flow."}),e.jsx("button",{type:"button",className:"btn btn--ghost px-3 py-1 text-xs",onClick:()=>te(!1),children:"Open mobile camera mode"})]})}),e.jsxs("div",{className:"card space-y-6 p-6",children:[e.jsxs("header",{className:"flex flex-wrap items-start justify-between gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-xs font-semibold uppercase tracking-wide text-indigo-300",children:"Marker calibration"}),e.jsx("h2",{className:"text-2xl font-semibold leading-tight text-white",children:"Align your board with the autoscoring overlay"}),e.jsx("p",{className:"max-w-2xl text-sm opacity-80",children:"Place the printable fiducial markers around the double ring, capture a clear frame, and let the calibrator compute a precise homography."})]}),e.jsxs("div",{className:"flex flex-col items-end gap-2 text-xs font-medium",children:[e.jsxs("span",{className:"inline-flex items-center gap-2 rounded-full border border-indigo-400/50 bg-indigo-500/10 px-3 py-1",children:[e.jsx("span",{className:"opacity-60",children:"Mode"}),e.jsx("span",{children:k==="local"?"Desktop camera":k==="phone"?"Phone camera":"Wifi device"})]}),e.jsxs("span",{className:`inline-flex items-center gap-2 rounded-full border px-3 py-1 ${f?"border-emerald-400/60 bg-emerald-500/10 text-emerald-100":"border-white/20 bg-white/5 text-slate-200"}`,children:[e.jsx("span",{className:`h-2 w-2 rounded-full ${f?"bg-emerald-400":"bg-slate-400"}`}),f?"Live stream active":"Stream idle"]}),ne?e.jsxs("div",{className:"space-y-3 rounded-2xl border border-emerald-400/40 bg-emerald-500/10 p-4 text-sm",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"flex h-10 w-10 items-center justify-center rounded-full bg-emerald-500/20",children:e.jsx("span",{className:"text-lg",children:"âœ“"})}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold text-emerald-100",children:"Calibration active"}),e.jsx("p",{className:"text-xs opacity-80",children:"Your calibration is saved and active across all game modes. It will be used in Online, Offline, and Tournaments."})]})]}),e.jsx("button",{className:"btn btn--ghost px-2 py-1 text-xs whitespace-nowrap",onClick:()=>G({locked:!1}),title:"Unlock to recalibrate",children:"Unlock"})]}),Pe!=null&&e.jsxs("div",{className:"text-xs opacity-75",children:["Precision: ",Pe.toFixed(2)," px RMS error"]})]}):null]})]}),e.jsxs("div",{className:"grid gap-6 xl:grid-cols-[minmax(0,2fr)_minmax(320px,1fr)]",children:[e.jsxs("section",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-4 rounded-2xl border border-white/10 bg-black/40 p-4",children:[e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-4 text-xs",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[e.jsx("span",{className:"uppercase tracking-wide opacity-60",children:"Video source"}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{className:`btn px-3 py-1 ${k==="local"?"bg-emerald-600 hover:bg-emerald-700":"bg-slate-700 hover:bg-slate-600"}`,"data-testid":"mode-local",onClick:()=>{S("local"),typeof DROPDOWN_DEBUG<"u"&&DROPDOWN_DEBUG&&console.debug("[Calibrator] setMode(local)",Date.now()),_t(!1)},title:"Use local camera",children:"Local"}),e.jsx("button",{className:`btn px-3 py-1 ${k==="phone"?"bg-emerald-600 hover:bg-emerald-700":"bg-slate-700 hover:bg-slate-600"}`,"data-testid":"mode-phone",onClick:()=>{S("phone"),typeof DROPDOWN_DEBUG<"u"&&DROPDOWN_DEBUG&&console.debug("[Calibrator] setMode(phone)",Date.now()),_t(!1)},title:"Enable camera on this device",children:"Phone"}),e.jsx("button",{className:`btn px-3 py-1 ${k==="wifi"?"bg-emerald-600 hover:bg-emerald-700":"bg-slate-700 hover:bg-slate-600"}`,"data-testid":"mode-wifi",onClick:()=>{S("wifi"),typeof DROPDOWN_DEBUG<"u"&&DROPDOWN_DEBUG&&console.debug("[Calibrator] setMode(wifi)",Date.now()),_t(!1);try{gr()}catch(h){console.debug("[Calibrator] startWifiConnection failed",h)}},title:"Discover wifi/USB autoscoring devices",children:"Wifi"})]})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"opacity-70",children:"Zoom"}),e.jsx("input",{type:"range",min:50,max:200,step:5,value:Math.round(L*100),onChange:h=>V(Math.max(.5,Math.min(2,Number(h.target.value)/100)))}),e.jsxs("span",{className:"w-12 text-right",children:[Math.round(L*100),"%"]})]}),e.jsx("button",{className:"btn px-3 py-1",onClick:()=>V(1),children:"Actual"})]})]}),e.jsxs("div",{className:"ml-3 relative",children:[e.jsxs("button",{className:"inline-flex items-center gap-2 rounded-full border border-indigo-400/30 bg-indigo-400/10 px-3 py-1 text-sm",onClick:()=>Bn(!Dn),"data-testid":"cal-tools-popper-button",children:[e.jsx("span",{className:"font-semibold",children:"Cal. Tools"}),z&&e.jsx("span",{className:"ml-2 text-xs opacity-70",children:"(overlay preserved)"})]}),Dn&&e.jsxs("div",{className:"absolute right-0 mt-2 w-64 rounded-lg border bg-gray-900/80 p-3 shadow-lg z-50","data-testid":"cal-tools-popover",role:"dialog",children:[e.jsx("div",{className:"text-xs mb-2",children:"Calibrator quick tools"}),e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("input",{id:"hdr-show-darts",type:"checkbox",checked:it,onChange:h=>Ft(h.target.checked)}),e.jsx("label",{htmlFor:"hdr-show-darts",className:"text-sm",children:"Show darts overlay"})]}),e.jsx("div",{className:"flex items-center gap-2 mb-2",children:e.jsx("button",{className:"btn btn--ghost btn-sm",onClick:()=>Kn(),children:"Reset visual adjustments"})}),e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("input",{id:"hdr-autocommit",type:"checkbox",checked:ct,onChange:h=>$n(h.target.checked)}),e.jsx("label",{htmlFor:"hdr-autocommit",className:"text-sm",children:"Enable autocommit test"})]}),e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("input",{id:"hdr-autocommit-online",type:"checkbox",checked:oe,onChange:h=>je(h.target.checked),disabled:!ct}),e.jsx("label",{htmlFor:"hdr-autocommit-online",className:"text-sm",children:"Allow autocommit in Online/Tournament matches (dangerous)"})]}),e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("input",{id:"hdr-autocommit-immediate",type:"checkbox",checked:Ut,onChange:h=>at(h.target.checked)}),e.jsx("label",{htmlFor:"hdr-autocommit-immediate",className:"text-sm",children:"Autocommit immediate when detected"})]}),e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("input",{id:"hdr-show-detected",type:"checkbox",checked:Lt,onChange:h=>vt(h.target.checked)}),e.jsx("label",{htmlFor:"hdr-show-detected",className:"text-sm",children:"Show detected rings overlay"})]}),e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("input",{id:"hdr-force-detected",type:"checkbox",checked:en,onChange:h=>It(h.target.checked)}),e.jsx("label",{htmlFor:"hdr-force-detected",className:"text-sm",children:"Force detected-only overlay (bypass homography)"})]}),e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("label",{htmlFor:"hdr-double-adjust",className:"text-sm mr-2",children:"Double adj"}),e.jsx("input",{id:"hdr-double-adjust",type:"range",min:.95,max:1.1,step:.005,value:Je,onChange:h=>Ot(parseFloat(h.target.value))}),e.jsxs("span",{className:"text-xs ml-2",children:[(Je*100).toFixed(1),"%"]})]}),e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("label",{htmlFor:"hdr-treble-adjust",className:"text-sm mr-2",children:"Treble adj"}),e.jsx("input",{id:"hdr-treble-adjust",type:"range",min:.95,max:1.1,step:.005,value:hr,onChange:h=>An(parseFloat(h.target.value))}),e.jsxs("span",{className:"text-xs ml-2",children:[(hr*100).toFixed(1),"%"]})]}),e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsxs("select",{id:"hdr-align-select",className:"input",value:tn||"",onChange:h=>kr(h.target.value?h.target.value:null),children:[e.jsx("option",{value:"",children:"-- Align ring --"}),e.jsx("option",{value:"double",children:"Double Outer"}),e.jsx("option",{value:"treble",children:"Treble Outer"}),e.jsx("option",{value:"bull",children:"Bull Outer"})]}),e.jsx("div",{className:"text-xs opacity-70 ml-2",children:"Click on the physical ring to align"})]}),e.jsxs("div",{className:"flex items-center justify-between mt-2",children:[e.jsx("div",{className:"text-xs opacity-70",children:ye||"No recent detection"}),e.jsx("div",{children:e.jsx("button",{className:"btn btn--small",onClick:()=>{console.debug("[Calibrator] popover Commit click (onClick)"),Mr()},onPointerDown:()=>{console.debug("[Calibrator] popover Commit click (onPointerDown)"),Mr()},children:"Commit"})})]})]})]}),e.jsxs("div",{className:"relative w-full overflow-hidden rounded-2xl border border-indigo-400/30 bg-black",style:{aspectRatio:N?`${N.w} / ${N.h}`:"16 / 9"},children:[(k==="phone"?!f||!dt:!f)&&e.jsx("div",{className:"absolute inset-0 z-20 flex items-center justify-center bg-gradient-to-br from-black/40 to-black/10",children:e.jsx(wd,{calibrationComplete:j==="computed"})}),e.jsxs("div",{className:"absolute inset-0",style:{transform:`scale(${L})`,transformOrigin:"center center"},children:[e.jsx("video",{ref:t,onLoadedMetadata:h=>{try{const D=h.currentTarget;D.videoWidth&&D.videoHeight&&P({w:D.videoWidth,h:D.videoHeight})}catch{}},className:`absolute inset-0 h-full w-full object-cover transition-opacity duration-300 ${C?"opacity-0 -z-10":"opacity-100 z-10"}`,autoPlay:!0,playsInline:!0,muted:!0,controls:!1}),m&&e.jsx("div",{className:"absolute inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur",children:e.jsx("button",{className:"rounded-lg bg-white px-4 py-2 font-semibold text-slate-900 shadow-lg",onClick:async()=>{try{await t.current?.play(),A(!1),g(!0),T("capture")}catch(h){console.warn("Tap-to-play retry failed",h),alert("Tap to enable video failed. Please check browser settings or reload the page.")}},children:"Tap to allow video"})}),e.jsx("canvas",{ref:n,className:`absolute inset-0 h-full w-full transition-opacity duration-300 ${C?"opacity-100 z-10":"opacity-0 -z-10"}`}),e.jsx("canvas",{ref:r,"data-testid":"calibrator-overlay",onPointerDown:Gs,className:"absolute inset-0 z-30 h-full w-full cursor-crosshair"})]})]}),e.jsxs("label",{className:"flex items-center gap-2 text-xs",children:[e.jsx("input",{type:"checkbox",className:"accent-indigo-600",checked:we,onChange:h=>He(h.target.checked)}),"Show preferred-view guide overlay"]}),e.jsxs("div",{className:"mt-4 grid grid-cols-1 gap-3 sm:grid-cols-3 overflow-visible",children:[e.jsxs("div",{className:"rounded-2xl border border-white/10 bg-white/5 p-4 overflow-visible",children:[e.jsx("h3",{className:"text-sm font-semibold",children:"Stage 1 Â· Capture"}),e.jsx("p",{className:"text-xs opacity-70",children:"Start your camera or upload a photo to capture the board."}),e.jsxs("div",{className:"mt-3 flex flex-col gap-2",children:[k==="local"&&e.jsx("button",{className:"btn",onClick:io,children:"Enable camera"}),k==="phone"&&e.jsx("button",{className:"btn",title:"Enable camera on this device",onClick:()=>{try{window.dispatchEvent(new CustomEvent("ndn:start-camera",{detail:{mode:"phone"}}))}catch{Pn()}},children:"Enable camera"}),k==="wifi"&&e.jsx("button",{className:"btn",onClick:gr,children:"Connect wifi camera"}),e.jsx("button",{className:"btn",onClick:br,disabled:!f,children:"Capture frame"}),e.jsx("button",{className:"btn",onClick:Ns,children:"Upload photo"})]})]}),e.jsxs("div",{className:"rounded-2xl border border-white/10 bg-white/5 p-4",children:[e.jsx("h3",{className:"text-sm font-semibold",children:"Stage 2 Â· Calibration Methods"}),e.jsxs("div",{className:"mt-4",children:[e.jsx("h4",{className:"text-xs font-semibold text-blue-300 mb-2",children:"Method 1: Marker Calibration (Recommended)"}),e.jsx("p",{className:"text-xs opacity-70 mb-2",children:"Print ArUco markers and position around your double ring"}),e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx("button",{className:"btn bg-blue-600 hover:bg-blue-700 font-semibold text-sm",onClick:Hr,"data-testid":"open-marker-sheet",children:"ðŸ“‹ Download Markers"}),e.jsx("button",{className:"btn bg-indigo-600 hover:bg-indigo-700 font-semibold text-sm",disabled:!C,onClick:sr,"data-testid":"detect-markers",children:"ðŸ” Detect Markers"})]}),Te&&e.jsx("div",{className:`mt-2 p-2 rounded text-xs ${Te.success?"bg-green-500/20 border border-green-500/30":"bg-red-500/20 border border-red-500/30"}`,children:Te.success?e.jsxs(e.Fragment,{children:[e.jsx("strong",{className:"text-green-300",children:"âœ… Markers detected!"}),e.jsxs("div",{className:"mt-1",children:["Error: ",Te.errorPx?.toFixed(2)," px"]})]}):e.jsxs(e.Fragment,{children:[e.jsxs("strong",{className:"text-red-300",children:["âŒ ",Te.message||"No markers detected"]}),Te.missing?.length>0&&e.jsxs("div",{className:"mt-1",children:["Missing:"," ",Te.missing.join(", ").toUpperCase()]})]})})]}),e.jsxs("div",{className:"mt-4 border-t border-white/10 pt-4",children:[e.jsx("h4",{className:"text-xs font-semibold text-emerald-300 mb-2",children:"Method 2: Auto-Calibrate (Fallback)"}),e.jsx("p",{className:"text-xs opacity-70 mb-2",children:"Automatically detect dartboard rings (no markers needed)"}),e.jsx("div",{className:"flex flex-col gap-2",children:e.jsx("button",{className:"btn bg-emerald-600 hover:bg-emerald-700 font-semibold text-sm",disabled:!C||Qt,onClick:Ss,"data-testid":"autocalibrate-advanced",children:Qt?"Auto-calibratingâ€¦":"ðŸŽ¯ Auto-Calibrate"})})]}),e.jsxs("div",{className:"mt-4 border-t border-white/10 pt-4",children:[e.jsxs("div",{className:"text-xs opacity-70",children:["Confidence: ",ht?100:Et,"%"]}),e.jsxs("div",{className:"mt-2 text-xs opacity-70",children:["Scoring image size:"," ",ce?`${ce.w} x ${ce.h}`:"â€”"]}),e.jsxs("div",{className:"mt-2 text-xs opacity-70",children:["Overlay display size:"," ",Ae?`${Ae.w} x ${Ae.h}`:"â€”"]}),se&&e.jsxs("div",{className:"mt-2 text-xs opacity-70 bg-black/30 rounded p-2",children:[e.jsx("div",{className:"font-semibold mb-1",children:"Detected Ring Sizes:"}),e.jsxs("div",{children:["Double: ",Math.round(se.doubleInner)," -"," ",Math.round(se.doubleOuter)," px"]}),e.jsxs("div",{children:["Treble: ",Math.round(se.trebleInner)," -"," ",Math.round(se.trebleOuter)," px"]}),e.jsxs("div",{children:["Bull: ",Math.round(se.bullInner)," -"," ",Math.round(se.bullOuter)," px"]}),e.jsxs("div",{children:["Center: (",Math.round(se.cx+Zt),","," ",Math.round(se.cy+an),")"]})]}),e.jsx("div",{className:"mt-2",children:e.jsx("button",{className:"btn btn-secondary text-xs",onClick:()=>{Qt||Ss()},disabled:!C||Qt,children:"Re-run Auto-Calibrate"})}),vn&&e.jsx("div",{className:"mt-2 text-xs text-yellow-300",children:vn})]}),j==="verify"&&e.jsxs("div",{className:"mt-4 rounded-lg border-2 border-yellow-500/50 bg-yellow-500/10 p-3",children:[e.jsx("div",{className:"text-sm font-bold text-yellow-300 mb-2",children:"âš ï¸ VERIFY RING ALIGNMENT"}),e.jsx("div",{className:"text-xs text-yellow-200 mb-3",children:"Look at the overlay on your dartboard. Do the colored rings match exactly with the treble and double rings?"}),rn.length>0&&e.jsxs("div",{className:"mb-3 text-xs bg-black/30 rounded p-2",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-1 mb-2 font-semibold border-b border-white/10 pb-1",children:[e.jsx("div",{children:"Location"}),e.jsx("div",{children:"Status"})]}),rn.map((h,D)=>e.jsxs("div",{className:"grid grid-cols-2 gap-1 py-1 border-b border-white/10 last:border-0",children:[e.jsx("div",{className:"text-[10px]",children:h.label}),e.jsx("div",{className:`text-[10px] font-bold ${h.match?"text-emerald-400":"text-rose-400"}`,children:h.note})]},D))]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{className:"btn bg-emerald-600 hover:bg-emerald-700 text-sm flex-1",onClick:()=>{T("computed"),G({locked:!0}),Gt("âœ… Calibration accepted and locked!")},children:"âœ… Accept & Lock"}),e.jsx("button",{className:"btn bg-orange-600 hover:bg-orange-700 text-sm flex-1",onClick:()=>{T("capture"),Gt(null),zt([]),Be(!1)},children:"ðŸ”„ Retry"})]})]}),e.jsxs("div",{className:"mt-2 text-xs opacity-70 flex items-center gap-2",children:[e.jsxs("label",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",className:"accent-indigo-600",checked:ht,onChange:h=>_e(h.target.checked)}),e.jsx("span",{className:"text-xs",children:"Force 100% Confidence"})]}),ht&&e.jsx("span",{className:"text-xs text-yellow-300",children:"âš ï¸ For testing only â€” may produce mis-registrations"})]})]}),e.jsxs("div",{className:"rounded-2xl border border-white/10 bg-white/5 p-4",children:[e.jsx("h3",{className:"text-sm font-semibold",children:"Stage 3 Â· Align & lock"}),e.jsx("p",{className:"text-xs opacity-70",children:"Click the board points, refine edges and lock calibration when satisfied."}),e.jsxs("div",{className:"mt-3 flex flex-col gap-2",children:[e.jsx("button",{className:"btn",disabled:x.length<cr,onClick:js,children:"Compute"}),e.jsx("button",{className:`btn ${ne?"bg-emerald-600 hover:bg-emerald-700":""}`,onClick:()=>{if(!!ne)G({locked:!1});else{if(j!=="computed"&&!js())return;const D=r?.current?{w:r.current.width,h:r.current.height}:t?.current?{w:t.current.clientWidth,h:t.current.clientHeight}:n?.current?{w:n.current.width,h:n.current.height}:null;let R=q;R&&xt!==1&&(R=Fs(R,xt,1)),R&&(Zt!==0||an!==0)&&(R=ha(R,Zt,an)),G({H:R,locked:!0,overlaySize:D})}},children:ne?"Unlock":"Lock in"}),z?e.jsxs("div",{className:"text-xs opacity-70 mt-1",children:["Overlay preservation"," ",e.jsx("span",{className:"font-semibold",children:"enabled"})," â€” locked calibration will preserve display size"]}):e.jsxs("div",{className:"text-xs opacity-70 mt-1",children:["Overlay preservation"," ",e.jsx("span",{className:"font-semibold",children:"disabled"})," â€” locked calibration uses current canvas size"]}),ne&&z&&Ae&&e.jsxs("div",{className:"text-xs opacity-60 mt-1",children:["Overlay display size preserved: ",Ae.w," x"," ",Ae.h]}),e.jsxs("div",{className:"mt-4 border-t border-white/10 pt-3",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h4",{className:"text-xs font-semibold",children:"Fine-tune Corrections"}),e.jsxs("div",{className:"text-xs opacity-70",children:["Applied: Sx:",xt.toFixed(3)," Tx:",Zt.toFixed(1)," Ty:",an.toFixed(1)]})]}),e.jsx("div",{className:"flex items-center justify-between mb-2",children:e.jsx("button",{className:"btn btn--ghost btn-sm text-xs",onClick:()=>{sn(1),$t(0),lt(0)},children:"Reset to 1.0, 0, 0"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"text-xs",children:["Scale X: ",xt.toFixed(3)]}),e.jsx("input",{type:"range",min:"0.9",max:"1.1",step:"0.001",value:xt,onChange:h=>sn(Number(h.target.value)),className:"w-full"})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"text-xs",children:["Translate X: ",Zt.toFixed(1)]}),e.jsx("input",{type:"range",min:"-200",max:"200",step:"0.1",value:Zt,onChange:h=>$t(Number(h.target.value)),className:"w-full"})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"text-xs",children:["Translate Y: ",an.toFixed(1)]}),e.jsx("input",{type:"range",min:"-200",max:"200",step:"0.1",value:an,onChange:h=>lt(Number(h.target.value)),className:"w-full"})]})]})]}),e.jsx("button",{className:"btn",onClick:()=>xr(),children:"Verify"})]})]})]})]}),rn.length>0&&e.jsxs("div",{className:"mt-4 rounded-2xl border border-emerald-400/30 bg-emerald-500/5 p-4",children:[e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-semibold text-emerald-100",children:"Verification measurements"}),e.jsx("p",{className:"text-xs text-emerald-100/70",children:"Anchors must land within a few millimeters of the canonical board targets. Anything highlighted in red should be adjusted before relying on autoscoring."})]}),e.jsxs("div",{className:"flex gap-2",children:[rn.some(h=>!h.match)&&e.jsx("button",{className:"btn btn-sm bg-orange-500/20 text-orange-200 hover:bg-orange-500/30 border border-orange-500/50",onClick:()=>Js(),children:"ðŸ”§ Resize"}),e.jsx("button",{className:"btn btn--ghost btn-sm",onClick:()=>zt([]),children:"Clear"})]})]}),e.jsx("div",{className:"mt-3 overflow-x-auto",children:e.jsxs("table",{className:"w-full text-xs",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left text-emerald-100/70",children:[e.jsx("th",{className:"py-2 pr-3 font-semibold",children:"Anchor"}),e.jsx("th",{className:"py-2 pr-3 font-semibold",children:"Expected"}),e.jsx("th",{className:"py-2 pr-3 font-semibold",children:"Detected"}),e.jsx("th",{className:"py-2 pr-3 font-semibold",children:"Î” mm"}),e.jsx("th",{className:"py-2 pr-3 font-semibold",children:"Î” px"}),e.jsx("th",{className:"py-2 pr-3 font-semibold",children:"Status"})]})}),e.jsx("tbody",{children:rn.map(h=>e.jsxs("tr",{className:"border-t border-white/10",children:[e.jsx("td",{className:"py-2 pr-3 font-medium text-white",children:h.label}),e.jsx("td",{className:"py-2 pr-3 text-emerald-100/80",children:qi(h.expected.ring,h.expected.sector)}),e.jsx("td",{className:"py-2 pr-3",children:ju(h.detected)}),e.jsx("td",{className:"py-2 pr-3",children:typeof h.deltaMm=="number"?`${h.deltaMm.toFixed(1)} mm`:"â€”"}),e.jsx("td",{className:"py-2 pr-3",children:typeof h.deltaPx=="number"?`${h.deltaPx.toFixed(1)} px`:"â€”"}),e.jsxs("td",{className:"py-2 pr-3",children:[e.jsx("span",{className:`inline-flex items-center rounded-full px-2 py-0.5 text-[11px] font-semibold ${h.match?"bg-emerald-500/20 text-emerald-200":"bg-rose-500/30 text-rose-100"}`,children:h.match?"Pass":"Adjust"}),h.note&&e.jsx("div",{className:"mt-1 text-[11px] text-white/70",children:h.note})]})]},h.label))})]})})]}),e.jsxs("div",{className:"mt-4 rounded-lg border border-blue-500/30 bg-blue-500/10 p-3",children:[e.jsx("div",{className:"text-xs font-semibold text-blue-300 mb-1",children:"ðŸ’¡ Pro Tip for Perfect Calibration"}),e.jsxs("div",{className:"text-xs opacity-80",children:["Click the 4 corners of the double ring at"," ",e.jsx("span",{className:"font-semibold",children:"D20, D6, D3, and D11"}),". These evenly-spaced doubles lock the board orientation and yield a perfect (100%) confidence score."]})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-3 text-xs sm:grid-cols-3",children:[e.jsxs("div",{className:"rounded-xl border border-white/10 bg-white/5 px-3 py-2",children:[e.jsx("div",{className:"uppercase tracking-wide opacity-60",children:"Phase"}),e.jsx("div",{className:"text-sm font-semibold capitalize",children:j})]}),e.jsxs("div",{className:"rounded-xl border border-white/10 bg-white/5 px-3 py-2",children:[e.jsx("div",{className:"uppercase tracking-wide opacity-60",children:"Points selected"}),e.jsxs("div",{className:"text-sm font-semibold",children:[x.length," / ",cr]}),j==="select"&&x.length<cr&&e.jsxs("div",{className:"mt-1 text-yellow-400 font-bold",children:["â†’ Click on ",ns[x.length]," ","next"]})]}),e.jsxs("div",{className:"rounded-xl border border-white/10 bg-white/5 px-3 py-2",children:[e.jsx("div",{className:"uppercase tracking-wide opacity-60",children:"Fit error"}),e.jsx("div",{className:"text-sm font-semibold",children:Pe!=null?`${Pe.toFixed(2)} px`:"â€”"}),!K&&e.jsxs("div",{className:"mt-2 flex items-center justify-between gap-2 text-xs",children:[e.jsxs("span",{className:"opacity-70",children:["Calibration not valid (max ",de,"px). You can still force-lock to proceed."]}),e.jsx("button",{className:"btn btn--ghost btn-sm",onClick:()=>G({locked:!0}),title:"Force accept calibration",children:"Force lock"})]})]})]})]}),e.jsxs("aside",{className:"space-y-4",children:[e.jsx(Nu,{videoDevices:c,streaming:f,refreshVideoDevices:pr,testCamera:Ir,onSelectPhoneCamera:M,lastDetectedLabel:ye,autoCommitTestMode:ct,doCommit:Mr,lastDetectedValue:p,calibrationValid:K,sectorOffset:B??0,onNudgeSectorOffset:h=>In(h),onResetSectorOffset:()=>G({sectorOffset:0})}),k==="phone"&&e.jsxs("section",{className:"space-y-3 rounded-2xl border border-indigo-400/30 bg-black/40 p-4 text-xs text-white",children:[e.jsx("div",{className:"font-semibold",children:"Phone pairing"}),e.jsxs("button",{type:"button",className:"w-full text-left px-3 py-2 rounded-lg border border-white/10 bg-white/5 hover:bg-white/10 transition flex items-center gap-2",onClick:()=>Ar(Mn,"link"),title:"Copy mobile camera link",children:[e.jsx("span",{className:"flex-1 min-w-0 font-mono break-all text-[11px]",children:Mn}),e.jsx("span",{className:"text-[10px] uppercase tracking-wide whitespace-nowrap text-emerald-200",children:xs==="link"?"Copied!":"Copy link"})]}),e.jsx("div",{className:"flex items-center gap-2 text-[11px]",children:e.jsx("a",{href:Mn,target:"_blank",rel:"noreferrer",className:"underline decoration-dotted text-indigo-200 hover:text-indigo-100 transition",children:"Open link in new tab"})}),e.jsxs("div",{className:"opacity-80",children:["WS:"," ",Pt?Pt.readyState===1?"open":Pt.readyState===0?"connecting":Pt.readyState===2?"closing":"closed":"not started"," ","Â· ",Wn?.https?"HTTPS on":"HTTP only"]}),Ht&&e.jsxs("button",{type:"button",className:"w-full text-left px-3 py-2 rounded-lg border border-white/10 bg-white/5 hover:bg-white/10 transition flex items-center justify-between gap-2",onClick:()=>Ar(Ht,"code"),title:"Copy pairing code",children:[e.jsx("span",{className:"font-mono tracking-[0.3em] text-sm",children:Ht}),e.jsx("span",{className:"text-[10px] uppercase tracking-wide whitespace-nowrap text-emerald-200",children:xs==="code"?"Copied!":"Copy code"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[ys!==null&&e.jsxs("span",{children:["Expires in ",ys,"s"]}),e.jsx("button",{className:"btn px-2 py-1 text-xs",onClick:qs,children:"Regenerate"})]}),ao&&e.jsxs("div",{className:"space-y-2 rounded-lg border border-slate-700/50 bg-slate-900/60 p-3 text-slate-200",children:[e.jsx("div",{className:"font-semibold",children:"Troubleshooting"}),e.jsxs("ul",{className:"list-disc space-y-1 pl-4",children:[e.jsx("li",{children:"Phone and desktop must be on the same Wiâ€‘Fi network."}),e.jsxs("li",{children:["Allow the server through your firewall (ports 8787 and"," ",Wn?.https?Wn.port:8788,")."]}),e.jsx("li",{children:"On iPhone, use HTTPS links (QR will prefer HTTPS when enabled)."})]}),e.jsx("div",{className:"text-right",children:e.jsx("button",{className:"btn btn--ghost px-2 py-1 text-xs",onClick:()=>gs(!1),children:"Hide tips"})})]})]})]})]}),k==="wifi"&&!f&&e.jsxs("div",{className:"space-y-3 rounded-2xl border border-indigo-400/30 bg-black/40 p-4 text-xs text-white",children:[e.jsx("div",{className:"font-semibold",children:"Wifi scoring devices"}),oo?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"h-4 w-4 animate-spin rounded-full border-b-2 border-white"}),e.jsx("span",{children:"Scanning network for devicesâ€¦"})]}):zs.length>0?e.jsxs("div",{className:"space-y-2",children:[zs.map(h=>e.jsxs("div",{className:"flex items-center justify-between rounded border border-slate-700/50 bg-slate-900/60 p-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:h.name}),e.jsxs("div",{className:"opacity-70",children:[h.ip,":",h.port," Â· ",h.type.toUpperCase()]}),e.jsxs("div",{className:"opacity-70 text-xs",children:["Capabilities: ",h.capabilities.join(", ")]})]}),e.jsx("button",{className:`btn px-2 py-1 text-xs ${h.status==="connecting"?"bg-yellow-600":h.status==="online"?"bg-green-600":"bg-blue-600"}`,onClick:()=>Hs(h),disabled:h.status==="connecting",children:h.status==="connecting"?"Connectingâ€¦":"Connect"})]},h.id)),e.jsx("div",{className:"text-center",children:e.jsx("button",{className:"btn px-2 py-1 text-xs",onClick:gr,children:"Rescan network"})})]}):e.jsxs("div",{className:"space-y-2 text-center",children:[e.jsx("div",{children:"No wifi scoring devices found."}),e.jsx("div",{className:"opacity-70",children:"Ensure your wifi cameras are powered on and on the same network."}),e.jsx("button",{className:"btn px-2 py-1 text-xs",onClick:gr,children:"Scan again"})]})]})]})]})}let Cu=1;const Ia=mr(t=>({toasts:[],push:(n,r)=>t(s=>{const a=Cu++,o={id:a,message:n,type:r?.type||"info",timeout:r?.timeout??3e3,actionLabel:r?.actionLabel,onAction:r?.onAction};return o.timeout&&o.timeout>0&&setTimeout(()=>{t(c=>({toasts:c.toasts.filter(l=>l.id!==a)}))},o.timeout),{toasts:[...s.toasts,o]}}),remove:n=>t(r=>({toasts:r.toasts.filter(s=>s.id!==n)})),clear:()=>t({toasts:[]})}));function Xa(){return Ia(n=>n.push)}function ku(){const t=Ia(r=>r.toasts),n=Ia(r=>r.remove);return t.length?e.jsxs(e.Fragment,{children:[t.filter(r=>r.type==="success").map(r=>e.jsx("div",{className:"fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-50",children:e.jsx("div",{className:"p-4 rounded-lg shadow-lg border text-sm bg-emerald-700/90 border-emerald-500/60 text-white max-w-sm text-center",children:e.jsx("div",{className:"flex items-center justify-center gap-2",children:e.jsx("span",{className:"flex-1 font-semibold",children:r.message})})})},r.id)),t.filter(r=>r.type!=="success").length>0&&e.jsx("div",{className:"fixed bottom-4 right-4 z-50 space-y-2 sm:right-4 sm:left-auto left-1/2 -translate-x-1/2 sm:translate-x-0 w-[calc(100%-1.5rem)] sm:w-auto max-w-sm",children:t.filter(r=>r.type!=="success").map(r=>e.jsx("div",{className:`p-3 rounded-lg shadow-lg border text-sm ${r.type==="error"?"bg-rose-700/80 border-rose-500/60 text-white":"bg-black/70 border-slate-700 text-slate-100"}`,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"flex-1",children:r.message}),r.actionLabel&&typeof r.onAction=="function"?e.jsx("button",{className:"btn px-2 py-1 text-xs bg-slate-200/10 hover:bg-slate-200/20",onClick:()=>{try{r.onAction?.()}catch{}n(r.id)},children:r.actionLabel}):null,e.jsx("button",{className:"btn btn--ghost px-2 py-1 text-xs",onClick:()=>n(r.id),children:"Dismiss"})]})},r.id))})]}):null}function Eu({data:t,height:n=220,barWidth:r=28,gap:s=6,showValues:a=!1}){const o=Math.max(1,...t.map(l=>l.value)),c=t.length*(r+s);return e.jsx("div",{className:"w-full overflow-x-auto",children:e.jsx("div",{className:"relative",style:{height:n,width:Math.max(600,c)},children:e.jsx("div",{className:"absolute inset-0 flex items-end",children:t.map((l,b)=>{const u=Math.round(l.value/o*(n-40));return e.jsxs("div",{className:"flex flex-col items-center justify-end",style:{width:r,marginRight:s},children:[e.jsx("div",{className:"w-full rounded-t-md bg-gradient-to-b from-indigo-400 to-fuchsia-500 shadow-sm",style:{height:u},title:`${l.label}: ${l.value}`}),a&&e.jsx("div",{className:"text-sm mt-1 text-indigo-200 font-semibold",children:l.value}),e.jsx("div",{className:"text-sm mt-1 text-slate-200 font-medium select-none",children:l.label})]},b)})})})})}function Tu({tabs:t,active:n,onChange:r,className:s}){return e.jsxs("div",{className:`relative ${s||""}`,children:[e.jsx("div",{className:"absolute inset-0 rounded-xl bg-white/5 backdrop-blur-md border border-white/10 pointer-events-none"}),e.jsx("div",{className:"relative overflow-x-auto no-scrollbar py-1 px-1",children:e.jsx("div",{className:"flex items-center gap-2 min-w-max",children:t.map(a=>{const o=a.key===n;return e.jsx("button",{type:"button",onPointerDown:c=>{c.stopPropagation()},onMouseDown:c=>{c.stopPropagation()},onTouchStart:c=>{c.stopPropagation?.()},onClick:()=>r(a.key),className:`transition-all select-none whitespace-nowrap rounded-full px-4 py-2 text-sm font-semibold shadow-sm focus:outline-none focus-visible:ring-2 focus-visible:ring-white/60 active:scale-[0.98]
                  ${o?"bg-gradient-to-r from-indigo-500 to-fuchsia-500 text-white shadow-indigo-500/30":"bg-white/10 text-slate-100 hover:bg-white/15"}
                `,"aria-pressed":o,children:a.label.includes("ðŸŽ¯")?a.label:`${a.label} ðŸŽ¯`},a.key)})})}),e.jsx("style",{children:`
        /* Hide scrollbars on WebKit/Firefox for a cleaner pill row */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
      `})]})}const Qa=t=>`ndn_stats_${t}`,Za=t=>`ndn_stats_ts_${t}`,eo=t=>`ndn_stats_daily_${t}`,Gi=t=>`ndn_stats_meta_${t}`,fa=new Map,pa=new Set;function Ji(){try{return localStorage.getItem("authToken")}catch{return null}}function Yi(t){try{const n=localStorage.getItem(Gi(t));if(!n)return{updatedAt:0};const r=JSON.parse(n||"{}");return{updatedAt:Number(r.updatedAt)||0}}catch{return{updatedAt:0}}}function hs(t,n){try{localStorage.setItem(Gi(t),JSON.stringify(n))}catch{}}function Du(t){return{updatedAt:Yi(t).updatedAt||Date.now(),allTime:Yn(t),series:rc(t),daily:oc(t),gameModes:Ws()}}async function Iu(t){const n=Ji();if(!(!n||!t)&&!pa.has(t)){pa.add(t);try{const r=Du(t);await xn("/api/user/stats",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${n}`},body:JSON.stringify({stats:r})})}catch{}pa.delete(t)}}function fs(t){if(!t)return;const n=fa.get(t);n&&window.clearTimeout(n);const r=window.setTimeout(()=>{fa.delete(t),Iu(t)},2500);fa.set(t,r)}async function Ki(t){const n=Ji();if(!(!n||!t))try{const r=await xn("/api/user/stats",{headers:{Authorization:`Bearer ${n}`}});if(!r?.ok)return;const a=(await r.json().catch(()=>({})))?.stats;if(!a||!a.updatedAt)return;const o=Yi(t);a.updatedAt>(o.updatedAt||0)?(to(t,a.allTime||{darts:0,scored:0},{skipSync:!0}),nc(t,a.series||[],{skipSync:!0}),a.daily&&ic(t,a.daily,{skipSync:!0}),a.gameModes&&ro(a.gameModes,{skipSync:!0}),hs(t,{updatedAt:a.updatedAt})):o.updatedAt>a.updatedAt&&fs(t)}catch{}}function Yn(t){try{const n=localStorage.getItem(Qa(t));if(!n)return{darts:0,scored:0};const r=JSON.parse(n);return{darts:Number(r.darts)||0,scored:Number(r.scored)||0,fnDarts:Number(r.fnDarts)||0,fnScored:Number(r.fnScored)||0,best3:typeof r.best3=="number"?r.best3:0,worst3:typeof r.worst3=="number"?r.worst3:0,bestLegDarts:typeof r.bestLegDarts=="number"?r.bestLegDarts:0,bestCheckout:typeof r.bestCheckout=="number"?r.bestCheckout:0,worstLegDarts:typeof r.worstLegDarts=="number"?r.worstLegDarts:0,bestFNAvg:typeof r.bestFNAvg=="number"?r.bestFNAvg:0,worstFNAvg:typeof r.worstFNAvg=="number"?r.worstFNAvg:0,num180s:typeof r.num180s=="number"?r.num180s:0}}catch{return{darts:0,scored:0}}}function to(t,n,r){try{localStorage.setItem(Qa(t),JSON.stringify(n)),window.dispatchEvent(new CustomEvent("ndn:stats-updated",{detail:{name:t,totals:n}}));try{Un({type:"statsUpdated",name:t,totals:n})}catch{}}catch{}r?.skipSync||(hs(t,{updatedAt:Date.now()}),fs(t))}function Au(t){try{localStorage.removeItem(Qa(t)),localStorage.removeItem(Za(t)),localStorage.removeItem(eo(t))}catch{}try{window.dispatchEvent(new CustomEvent("ndn:stats-updated",{detail:{name:t,cleared:!0}}))}catch{}}function no(t){const{darts:n,scored:r}=Yn(t);return n?r/n*3:0}function Xi(t){const{fnDarts:n=0,fnScored:r=0}=Yn(t);return n?r/n*3:0}function Mu(t){const{best3:n=0,worst3:r=0}=Yn(t);return{best3:n,worst3:r}}function Qi(t){const{bestLegDarts:n=0}=Yn(t);return n||0}function Zi(t){const{bestCheckout:n=0}=Yn(t);return n||0}function ec(t){const{num180s:n=0}=Yn(t);return Number(n||0)}const tc="ndn_game_mode_stats";function Ws(t){let n={};try{const r=localStorage.getItem(tc);r&&(n=JSON.parse(r))}catch{}if(Array.isArray(t))for(const r of t)n[r]||(n[r]={played:0,won:0});return n}function ro(t,n){try{localStorage.setItem(tc,JSON.stringify(t)),window.dispatchEvent(new CustomEvent("ndn:stats-updated",{detail:{gameModes:!0}}))}catch{}if(!n?.skipSync){const r=localStorage.getItem("ndn:currentUser")||"";r&&(hs(r,{updatedAt:Date.now()}),fs(r))}}function Ou(t,n){const r=Ws(),s=r[t]||{played:0,won:0};s.played+=1,n&&(s.won+=1),r[t]=s,ro(r)}function Vr(t){try{const n=localStorage.getItem(Za(t));if(!n)return[];const r=JSON.parse(n);return Array.isArray(r)?r.map(s=>({t:Number(s.t)||0,darts:Number(s.darts)||0,scored:Number(s.scored)||0,fnDarts:Number(s.fnDarts)||0,fnScored:Number(s.fnScored)||0})).filter(s=>s.t>0):[]}catch{return[]}}function nc(t,n,r){try{localStorage.setItem(Za(t),JSON.stringify(n)),window.dispatchEvent(new CustomEvent("ndn:stats-updated",{detail:{name:t}}))}catch{}r?.skipSync||(hs(t,{updatedAt:Date.now()}),fs(t))}function rc(t){return Vr(t)}function Pu(t,n){const r=Date.now();return t.filter(s=>r-s.t<=n)}function Nr(t,n,r,s=Date.now(),a,o){if(n<=0)return;const c=Vr(t),l=Pu([...c,{t:s,darts:n,scored:r,fnDarts:a,fnScored:o}],1e3*60*60*24*30);nc(t,l)}function sc(t,n=1e3*60*60*24){const r=Vr(t);if(!r.length)return 0;const s=Date.now();let a=0,o=0;for(const c of r)s-c.t<=n&&(a+=c.darts,o+=c.scored);return a<=0?0:o/a*3}function ac(t,n=1e3*60*60*24*30){const r=Vr(t);if(!r.length)return 0;const s=Date.now();let a=0,o=0;for(const c of r)s-c.t<=n&&(a+=c.fnDarts||0,o+=c.fnScored||0);return a<=0?0:o/a*3}function oc(t){try{const n=localStorage.getItem(eo(t));if(!n)return null;const r=JSON.parse(n);return{avg:Number(r.avg)||0,ts:Number(r.ts)||0}}catch{return null}}function ic(t,n,r){try{localStorage.setItem(eo(t),JSON.stringify(n)),window.dispatchEvent(new CustomEvent("ndn:stats-updated",{detail:{name:t}}))}catch{}r?.skipSync||(hs(t,{updatedAt:Date.now()}),fs(t))}function Ru(t){const n=oc(t),r=Date.now(),s=1e3*60*60*24;if(n&&r-n.ts<s)return n.avg;const a=sc(t,s);return ic(t,{avg:a,ts:r}),a}function cc(t){const r=Vr(t);if(!r.length)return 0;const s=Date.now(),a=r.filter(u=>s-u.t<=2592e6),o=a.filter(u=>typeof u.fnDarts=="number"),c=o.length?o:a;let l=0,b=0;for(const u of c)l+=u.darts,b+=u.scored;return l<=0?0:b/l*3}function Lu(t){return ac(t,2592e6)}function _u(t,n){const r=n?.recordSeries!==!1;let s=null;try{const a=localStorage.getItem("ndn:currentUser");a?s=a:typeof window?.ndnCurrentUser=="string"&&(s=window.ndnCurrentUser)}catch{}for(const a of t){const o={...a};if(s){const j=(o.name||"").trim();(!j||j.toLowerCase()==="you")&&(o.name=s)}let c=0,l=0,b=0,u=0,f=Number.POSITIVE_INFINITY,g=0,m=0,A=0,k=0,S=0,x=0,w=0,C=0,$=0;for(const j of o.legs){if(!j.finished)continue;c+=j.dartsThrown,l+=Math.max(0,j.totalScoreStart-j.totalScoreRemaining);const{d:T,s:M}=Fu(j);b+=T,u+=M;const N=Math.max(0,j.dartsThrown),P=Math.max(0,j.totalScoreStart-j.totalScoreRemaining),L=N>0?P/N*3:0,V=T>0?M/T*3:0;if(L>0&&(m=Math.max(m,L),A=A===0?L:Math.min(A,L)),V>0&&(w=Math.max(w,V),C=C===0?V:Math.min(C,V)),j.totalScoreRemaining===0){(k===0||N<k)&&(k=N),(x===0||N>x)&&(x=N);const ae=typeof j.checkoutScore=="number"?j.checkoutScore:0;ae>S&&(S=ae)}const te=Number(j.startTime||0),ie=Number(j.endTime||0)||te||Date.now();te>0&&(f=Math.min(f,te)),ie>0&&(g=Math.max(g,ie));try{for(const ae of j.visits||[])Number(ae.score||0)===180&&($+=1)}catch{}}if(c>0){const j=Yn(o.name),T={darts:j.darts+c,scored:j.scored+l,fnDarts:(j.fnDarts||0)+b,fnScored:(j.fnScored||0)+u,best3:Math.max(j.best3||0,m||0),worst3:(()=>{const M=j.worst3||0;return M===0?A||0:A===0?M:Math.min(M,A)})(),bestLegDarts:(()=>{const M=j.bestLegDarts||0;return M===0?k||0:k===0?M:Math.min(M,k)})(),bestCheckout:Math.max(j.bestCheckout||0,S||0),worstLegDarts:(()=>{const M=j.worstLegDarts||0;return M===0?x||0:x===0?M:Math.max(M,x)})(),bestFNAvg:Math.max(j.bestFNAvg||0,w||0),worstFNAvg:(()=>{const M=j.worstFNAvg||0;return M===0?C||0:C===0?M:Math.min(M,C)})(),num180s:(j.num180s||0)+($||0)};if(to(o.name,T),r){const M=Vr(o.name),N=Number.isFinite(f)?f:Date.now(),P=g>0?g:N,L=5e3;M.some(U=>U.t>=N-L&&U.t<=P+L)||Nr(o.name,c,l,P,b,u)}}}}function Fu(t){let n=Math.min(9,t.dartsThrown);if(n<=0)return{d:0,s:0};let r=0;for(const a of t.visits){if(n<=0)break;const o=Math.min(n,a.darts);o===a.darts?r+=a.score:r+=Math.round(a.score/a.darts*o),n-=o}return{d:Math.min(9,t.dartsThrown),s:r}}const Uu=Object.freeze(Object.defineProperty({__proto__:null,addMatchToAllTime:_u,addSample:Nr,bumpGameMode:Ou,clearAllStats:Au,getAllTime:Yn,getAllTime180s:ec,getAllTimeAvg:no,getAllTimeBestCheckout:Zi,getAllTimeBestLeg:Qi,getAllTimeBestWorst:Mu,getAllTimeFirstNineAvg:Xi,getDailyAdjustedAvg:Ru,getGameModeStats:Ws,getMonthlyAvg3:cc,getMonthlyFirstNineAvg:Lu,getRollingAvg:sc,getRollingFirstNineAvg:ac,getStatSeries:rc,setAllTime:to,setGameModeStats:ro,syncStatsFromServer:Ki},Symbol.toStringTag,{value:"Module"})),$u=["X01","Double Practice"],Bu=["Around the Clock","Cricket","Halve It","Shanghai","High-Low","Killer","Bob's 27","Count-Up","High Score","Low Score","Checkout 170","Checkout 121","Treble Practice","Baseball","Golf","Tic Tac Toe","American Cricket","Scam","Fives","Sevens"],$o=[...$u,...Bu],so={X01:{startOptions:[301,501,701],modeOptions:["bestof","firstto"],modeValueOptions:{bestof:[1,3,5,7],firstto:[1,2,3,4,5,6]}},"Double Practice":{startOptions:[],modeOptions:["practice"],modeValueOptions:{practice:[30,60,120]}},"Around the Clock":{startOptions:[],modeOptions:["bestof","firstto"],modeValueOptions:{bestof:[1,3,5],firstto:[1,2,3,4]}},Cricket:{startOptions:[],modeOptions:["bestof","firstto","rounds"],modeValueOptions:{bestof:[1,3,5],firstto:[1,2,3,4],rounds:[1,3,5]}},"Halve It":{startOptions:[],modeOptions:["bestof","firstto"],modeValueOptions:{bestof:[1,3,5],firstto:[1,2,3,4]}},Shanghai:{startOptions:[],modeOptions:["bestof","firstto"],modeValueOptions:{bestof:[1,3,5],firstto:[1,2,3,4]}},"High-Low":{startOptions:[],modeOptions:["bestof","firstto"],modeValueOptions:{bestof:[1,3,5],firstto:[1,2,3,4]}},Killer:{startOptions:[],modeOptions:["bestof","firstto"],modeValueOptions:{bestof:[1,3,5],firstto:[1,2,3,4]}},"Bob's 27":{startOptions:[],modeOptions:["bestof","firstto"],modeValueOptions:{bestof:[1,3,5],firstto:[1,2,3,4]}},"Count-Up":{startOptions:[],modeOptions:["bestof","firstto"],modeValueOptions:{bestof:[1,3,5],firstto:[1,2,3,4]}},"High Score":{startOptions:[],modeOptions:["bestof","firstto"],modeValueOptions:{bestof:[1,3,5],firstto:[1,2,3,4]}},"Low Score":{startOptions:[],modeOptions:["bestof","firstto"],modeValueOptions:{bestof:[1,3,5],firstto:[1,2,3,4]}},"Checkout 170":{startOptions:[],modeOptions:["bestof","firstto"],modeValueOptions:{bestof:[1,3,5],firstto:[1,2,3,4]}},"Checkout 121":{startOptions:[],modeOptions:["bestof","firstto"],modeValueOptions:{bestof:[1,3,5],firstto:[1,2,3,4]}},"Treble Practice":{startOptions:[],modeOptions:["practice"],modeValueOptions:{practice:[30,60,120]}},Baseball:{startOptions:[],modeOptions:["bestof","innings"],modeValueOptions:{bestof:[1,3,5],innings:[1,3,5,9]}},Golf:{startOptions:[],modeOptions:["holes","bestof"],modeValueOptions:{holes:[9,18],bestof:[1,3,5]}},"Tic Tac Toe":{startOptions:[],modeOptions:["bestof","firstto"],modeValueOptions:{bestof:[1,3,5],firstto:[1,2,3,4]}},"American Cricket":{startOptions:[],modeOptions:["bestof","firstto"],modeValueOptions:{bestof:[1,3,5],firstto:[1,2,3,4]}},Scam:{startOptions:[],modeOptions:["bestof","firstto"],modeValueOptions:{bestof:[1,3,5],firstto:[1,2,3,4]}},Fives:{startOptions:[],modeOptions:["bestof","firstto"],modeValueOptions:{bestof:[1,3,5],firstto:[1,2,3,4]}},Sevens:{startOptions:[],modeOptions:["bestof","firstto"],modeValueOptions:{bestof:[1,3,5],firstto:[1,2,3,4]}}};function hh(t){return t==="all"?[301,501,701]:so[t]?.startOptions??[]}function Vu(t){if(t==="all")return["all","bestof","firstto"];const n=so[t];return n?["all",...n.modeOptions]:["all","bestof","firstto"]}function Wu(t,n){return t==="all"||n==="all"?[]:so[t]?.modeValueOptions?.[n]??[]}function As(t){if(!t)return"";switch(t){case"all":return"All Modes";case"bestof":return"Best of";case"firstto":return"First to";case"innings":return"Innings";case"holes":return"Holes";case"rounds":return"Rounds";case"practice":return"Practice";case"none":return"Mode";default:return String(t).replace(/[-_]/g," ").replace(/\b\w/g,n=>n.toUpperCase())}}const zu={dash:"â€”",bullet:"â€¢",middot:"Â·",ellipsis:"â€¦",ok:"âœ“",no:"âœ—",warn:"!",info:"i",lock:"LOCK",refresh:"â†»",camera:"CAM",target:"â—Ž",spinner:"â€¦"};function Hu(t){return zu[t]}function qu(){const t=er(),n=t.getMediaStream?.(),r=t.getVideoElementRef(),s=!!(n||r?.srcObject),a=t.isStreaming&&s,o=a?"Camera Active":"Camera Offline";i.useEffect(()=>{},[a]);const c=()=>{try{window.dispatchEvent(new CustomEvent("ndn:toggle-phone-overlay"))}catch{}};return e.jsxs("button",{type:"button",onClick:c,className:"relative inline-flex items-center gap-2 rounded-lg border border-white/15 bg-white/5 hover:bg-white/10 transition-colors shadow-sm px-3 py-1 text-xs",title:a?"Camera connected âœ… â€“ click to toggle overlay":"Camera not connected âŒ",children:[e.jsx("span",{className:"font-mono text-[0.75rem]",children:Hu("camera")}),e.jsx("span",{className:"hidden xs:inline text-slate-100 select-none",children:o}),e.jsx("span",{className:`ml-2 w-2 h-2 rounded-full shrink-0 ${a?"bg-emerald-400":"bg-rose-400"}`,"aria-hidden":!0})]})}const Bo={calibration:{keywords:["calibration","calibrate","camera","score","accuracy","aim","setup"],title:"How Calibration Works",explanation:`Calibration helps our AI precisely detect where your darts land on the board. Here's how it works:

1. **D20**: Click on the 20 segment to calibrate that area
2. **D6**: Click on the 6 segment to calibrate that area
3. **D3**: Click on the 3 segment to calibrate that area
4. **D11**: Click on the 11 segment to calibrate that area
5. **Bullseye**: Click on the bullseye to calibrate the center

Each click teaches the system about your board's position and angle. After calibrating all areas, your scoring will be much more accurate!`,actions:[{id:"D20",label:"ðŸ“ Click D20",color:"bg-blue-600"},{id:"D6",label:"ðŸ“ Click D6",color:"bg-purple-600"},{id:"D3",label:"ðŸ“ Click D3",color:"bg-pink-600"},{id:"D11",label:"ðŸ“ Click D11",color:"bg-cyan-600"},{id:"Bullseye",label:"ðŸŽ¯ Click Bullseye",color:"bg-yellow-600"}]},scoring:{keywords:["score","points","counting","how do i score","scoring system"],title:"Dart Scoring",explanation:`In darts, each segment on the board has a value:
- Single areas: Face value (1-20)
- Double ring (outer): 2Ã— the segment number
- Triple ring (inner): 3Ã— the segment number
- Bullseye: 50 points
- Bull (outer bull): 25 points

For example: hitting Triple 20 = 60 points, Double 10 = 20 points`},gameplay:{keywords:["game","how to play","rules","x01","cricket","match","round"],title:"How to Play",explanation:`Nine Dart Nation supports multiple game modes:

**X01** (501, 301, 701): Start from the set score and count down to exactly 0. Final dart must be on a double.

**Cricket**: Players try to "close" numbers 15-20 and bullseye by hitting them. First to close all and have the highest score wins.

**Killer**: Players mark their "number" and try to knock out other players' lives.

Select your game mode when creating a match, and follow the on-screen instructions!`},premium:{keywords:["premium","subscription","features","upgrade","cost","paid"],title:"Premium Features",explanation:`Our Premium subscription gives you:
- Tournament creation and entry
- Advanced statistics and replays
- Priority matchmaking
- Custom profiles and themes
- Ad-free experience

Premium grants are often awarded as tournament prizes!`},connection:{keywords:["connection","disconnect","lag","latency","websocket","error","offline"],title:"Connection Issues",explanation:`If you're experiencing connection issues:
1. Check your internet connection
2. Refresh the page (Ctrl+R or Cmd+R)
3. Clear browser cache
4. Try a different browser
5. Check if the site status page shows any issues

Most connection issues resolve in seconds. Contact admin if problems persist.`},camera:{keywords:["camera","phone camera","mobile","video","pairing","connect"],title:"Camera Setup",explanation:`To use our phone camera feature:
1. Open Nine Dart Nation on your phone
2. Go to Settings > Camera Pairing
3. Scan the QR code or enter the pairing code
4. Position your phone to capture the dartboard
5. Run calibration (see calibration help for details)

Your phone will now act as a live dartboard camera!`},tournament:{keywords:["tournament","compete","bracket","prize","winner","playoffs"],title:"Tournaments",explanation:`Tournaments are competitive events where you can:
- Play against other skilled players
- Win prizes (Premium subscriptions)
- Climb leaderboards
- Compete in structured brackets

Check the Tournaments tab to see upcoming events. Registration typically opens 30 minutes before start time.`}};function Gu(t){const n=t.toLowerCase();for(const[,r]of Object.entries(Bo))for(const s of r.keywords)if(n.includes(s))return{type:"explanation",title:r.title,message:r.explanation,actions:r.actions,followUp:"Do you need further assistance? I can connect you with an admin if needed."};return{type:"suggestion",title:"Need More Help?",message:`I couldn't find a specific answer to your question. Common topics I can help with:

${Object.values(Bo).map(r=>`Â· ${r.title}`).join(`
`)}

Or I can connect you with an admin who can help further.`,followUp:"Would you like to speak with an admin?"}}function Ju(){const t=new Date().getHours();return t>=20||t<7?"20-30 minutes (off-peak hours)":t>=12&&t<14?"10-15 minutes (moderate traffic)":t>=18&&t<20?"15-20 minutes (peak hours)":"5-10 minutes"}function lc({request:t,user:n,onClose:r}){const s=(()=>{try{return Cr()}catch{return null}})(),[a,o]=i.useState(t?.messages||[]),[c,l]=i.useState(""),[b,u]=i.useState({}),[f,g]=i.useState(!1),[m,A]=i.useState(""),k=i.useRef(null),S=i.useRef(null),x=i.useRef([]);i.useEffect(()=>{if(!s)return;const j=s.addListener(T=>{try{if(T?.type==="help-message"&&String(T.requestId)===String(t.id)&&o(M=>[...M,T.message]),T?.type==="help-request-updated"&&T.request?.id===t.id&&(o(T.request.messages||[]),g(!!T.request.claimedBy)),T?.type==="help-typing"&&String(T.requestId)===String(t.id)){const M=T.fromName||T.fromEmail||(T.admin?"admin":"user");u(N=>({...N,[M]:Date.now()}))}}catch{}});return()=>{j()}},[s,t?.id]);const w=()=>{if(!c.trim())return;const j=c,T={type:"help-message",requestId:t.id,message:j};try{s?.send(T)}catch{}const M={fromEmail:n?.email||null,fromName:n?.username||null,message:j,ts:Date.now(),admin:!1};if(o(N=>[...N,M]),l(""),!f){const N=window.setTimeout(()=>{const P=Gu(j);if(P){const L={fromName:"AI Assistant",message:`${P.title}

${P.message}`,ts:Date.now(),admin:!0,actions:P.actions,followUp:P.followUp};o(V=>[...V,L])}},500);x.current.push(N)}},C=j=>{if(!j){const N={fromName:"You",message:"No, I think I have it now. Thanks!",ts:Date.now(),admin:!1};o(L=>[...L,N]);const P=window.setTimeout(()=>{const L={fromName:"AI Assistant",message:"âœ“ Great! Glad I could help. Feel free to reach out anytime you need assistance.",ts:Date.now(),admin:!0};o(V=>[...V,L])},300);x.current.push(P);return}const T={fromName:"You",message:"Yes, I need to speak with an admin",ts:Date.now(),admin:!1};o(N=>[...N,T]);try{s?.send({type:"help-escalate",requestId:t.id})}catch{}A(Ju());const M=window.setTimeout(()=>{const N={fromName:"System",message:`â³ Connecting you with an admin...

ðŸ“Š Estimated wait time: ${m}

An admin will be with you shortly. Please stay on this chat.`,ts:Date.now(),admin:!0};o(P=>[...P,N])},500);x.current.push(M)};i.useEffect(()=>{if(k.current)try{k.current.scrollTop=k.current.scrollHeight}catch{}},[a]);const $=i.useCallback(()=>{try{s?.send({type:"help-typing",requestId:t.id,fromName:n?.username,fromEmail:n?.email,admin:!!n?.isAdmin})}catch{}S.current&&clearTimeout(S.current),S.current=window.setTimeout(()=>{u(j=>{const T={...j};return delete T[n?.username||n?.email||"me"],T})},3e3)},[s,t.id,n]);return i.useEffect(()=>()=>{S.current&&clearTimeout(S.current);for(const j of x.current)clearTimeout(j);x.current=[]},[]),e.jsxs("div",{className:"fixed inset-0 z-50 flex items-end justify-center p-4",children:[e.jsx("div",{className:"absolute inset-0 bg-black/40",onClick:r}),e.jsxs("div",{className:"relative w-full max-w-2xl bg-slate-900 rounded-lg shadow-xl overflow-hidden flex flex-col max-h-[80vh]",children:[e.jsxs("div",{className:"flex items-center justify-between p-3 border-b border-slate-700 bg-slate-800",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"font-semibold flex items-center gap-2",children:[e.jsx(bo,{className:"w-4 h-4 text-yellow-400"}),"Help Desk â€” ",t.username||"Anonymous"]}),f&&e.jsx("span",{className:"text-xs px-2 py-1 rounded bg-emerald-600",children:"Admin Connected"})]}),e.jsx("button",{"aria-label":"Close",className:"px-2 py-1 rounded bg-neutral-700 hover:bg-neutral-600 text-sm",onClick:r,children:e.jsx(Pa,{className:"w-4 h-4"})})]}),e.jsxs("div",{ref:k,className:"flex-1 overflow-y-auto p-3 space-y-3 bg-black/20",children:[a.map((j,T)=>e.jsx("div",{children:e.jsxs("div",{className:`max-w-[85%] px-3 py-2 rounded ${j.admin?"bg-emerald-600/20 border border-emerald-500/40 text-emerald-100 ml-auto":"bg-slate-700 text-slate-100"}`,children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsxs("div",{className:"text-xs opacity-70 font-semibold flex items-center gap-1",children:[j.admin?e.jsx(bo,{className:"w-3 h-3"}):e.jsx(Ls,{className:"w-3 h-3"}),j.fromName||j.fromEmail||(j.admin?"AI Assistant":"You")]}),e.jsx("div",{className:"text-xs opacity-50 ml-2",children:j.ts?new Date(j.ts).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):""})]}),e.jsx("div",{className:"whitespace-pre-wrap break-words text-sm",children:j.message}),j.actions&&j.actions.length>0&&e.jsxs("div",{className:"mt-3 space-y-2",children:[e.jsx("div",{className:"text-xs font-semibold opacity-80",children:"ðŸ“ Try these calibration points:"}),e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-5 gap-2",children:j.actions.map(M=>e.jsx("button",{className:`${M.color} text-white text-xs py-2 px-2 rounded font-medium hover:opacity-90 transition-opacity`,onClick:()=>{const N={fromName:"You",message:`Clicked: ${M.label}`,ts:Date.now(),admin:!1};o(P=>[...P,N]);try{s?.send({type:"help-message",requestId:t.id,message:`User clicked: ${M.id}`})}catch{}},children:M.label},M.id))})]}),j.followUp&&!f&&e.jsxs("div",{className:"mt-3 space-y-2",children:[e.jsx("div",{className:"text-xs opacity-80",children:j.followUp}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{className:"flex-1 bg-emerald-600 hover:bg-emerald-700 text-white text-xs py-2 px-3 rounded font-medium transition-colors",onClick:()=>C(!0),children:"âœ… Yes, connect me"}),e.jsx("button",{className:"flex-1 bg-slate-600 hover:bg-slate-700 text-white text-xs py-2 px-3 rounded font-medium transition-colors",onClick:()=>C(!1),children:"âŒ No thanks"})]})]})]})},T)),Object.keys(b).length>0&&e.jsxs("div",{className:"text-xs text-slate-300 opacity-80 flex items-center gap-2",children:[e.jsxs("span",{children:[Object.keys(b).join(", ")," typing"]}),e.jsxs("span",{className:"flex gap-1",children:[e.jsx("span",{className:"w-1 h-1 bg-slate-300 rounded-full animate-bounce"}),e.jsx("span",{className:"w-1 h-1 bg-slate-300 rounded-full animate-bounce delay-100"}),e.jsx("span",{className:"w-1 h-1 bg-slate-300 rounded-full animate-bounce delay-200"})]})]})]}),e.jsxs("div",{className:"p-3 border-t border-slate-700 bg-slate-800 flex gap-2",children:[e.jsx("input",{className:"input flex-1 text-sm",value:c,onChange:j=>{l(j.target.value),$()},onKeyDown:j=>{j.key==="Enter"&&!j.shiftKey&&(j.preventDefault(),w())},placeholder:"Ask a question (e.g., 'How does calibration work?')..."}),e.jsx("button",{"aria-label":"Send message",className:"btn bg-blue-600 hover:bg-blue-700 text-white",onClick:w,children:e.jsx(Ra,{className:"w-4 h-4"})})]})]})]})}const Yu="daviesfamily108@gmail.com";function Ku({user:t}){const n=(()=>{try{return Cr()}catch{return null}})(),[r,s]=i.useState([]),[a,o]=i.useState(""),[c]=i.useState(null),[l,b]=i.useState(""),[u,f]=i.useState(!1),[g,m]=i.useState([]),[A,k]=i.useState(""),[S,x]=i.useState([]),[w,C]=i.useState({title:"Official Tournament",game:"X01",mode:"bestof",value:3,description:"",startAt:new Date(Date.now()+7200*1e3).toISOString().slice(0,16),checkinMinutes:30,capacity:16,prizeType:"premium",prizeAmount:3,prizeNotes:""}),[$,j]=i.useState({reset:{},reminder:{},confirmEmail:{},changed:{}}),[T,M]=i.useState({open:!1}),[N,P]=i.useState("general"),L=t?.email?.toLowerCase()===Yu,[V]=i.useState([]),[U]=i.useState([]),[te,ie]=i.useState([]),[ae,q]=i.useState({}),[G,ge]=i.useState(null),[,Pe]=i.useState([]),[ne,Ae]=i.useState(null),[ce,H]=i.useState(!1),[I,B]=i.useState(1500),[,de]=i.useState(!1),K=async()=>{f(!0);try{const p={"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("authToken")}`};(await fetch("/api/admin/tournaments/broadcast",{method:"POST",headers:p})).ok?tt("Tournaments broadcast triggered",{type:"success"}):tt("Broadcast failed",{type:"error"})}catch{tt("Broadcast request failed",{type:"error"})}finally{f(!1)}},[le,we]=i.useState(0);i.useEffect(()=>{const p=()=>we(Z=>Z+1);return window.addEventListener("ndn:stats-updated",p),()=>window.removeEventListener("ndn:stats-updated",p)},[]);const He=i.useMemo(()=>Ws($o),[le]),Qe=En(),tt=Xa();i.useEffect(()=>{if(!T.open)return;function p(Z){Z.key==="Escape"&&M({open:!1})}return document.addEventListener("keydown",p),()=>document.removeEventListener("keydown",p)},[T.open]);const pt=i.useMemo(()=>{const p=Qe.errorPx??null,Z=[];for(const ye of $o){const Ze=Fi(ye,p),Fe=Ld(ye,p);Z.push({game:ye,confidence:Ze,qualityInfo:Fe})}return Z},[Qe.errorPx]),st=i.useMemo(()=>{const p=[];if(He&&typeof He=="object")for(const[Z,ye]of Object.entries(He)){const Ze=ye;p.push({label:Z,value:Ze?.played||0,won:Ze?.won||0})}return p},[He]);async function E(){try{const p={Authorization:`Bearer ${localStorage.getItem("authToken")}`},[Z,ye,Ze]=await Promise.all([fetch("/api/admin/help-requests",{headers:p}),fetch("/api/admins",{headers:p}),fetch("/api/tournaments",{headers:p})]);if(Z.ok){const Fe=await Z.json();ie(Array.isArray(Fe)?Fe:Fe.requests||[])}if(ye.ok){const Fe=await ye.json();s(Array.isArray(Fe)?Fe:Fe.admins||[])}if(Ze.ok){const Fe=await Ze.json();m(Array.isArray(Fe)?Fe:Fe.tournaments||Fe)}}catch(p){console.error("refresh failed",p)}}async function J(p){try{await fetch("/api/admins/revoke",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("authToken")}`},body:JSON.stringify({email:p})}),await E()}catch{}}async function z(p,Z){if(p)try{await fetch("/api/admin/premium/grant",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("authToken")}`},body:JSON.stringify({email:p,days:Z})}),await E()}catch{}}async function oe(p){try{await fetch("/api/admin/premium/revoke",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("authToken")}`},body:JSON.stringify({email:p})}),await E()}catch{}}async function je(){if(l.trim())try{await fetch("/api/admin/announce",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("authToken")}`},body:JSON.stringify({message:l})}),b(""),await E()}catch{}}async function se(p){try{await fetch("/api/admin/maintenance",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("authToken")}`},body:JSON.stringify({maintenance:p})}),await E()}catch{}}i.useEffect(()=>{if(!n)return;const p=n.addListener(ye=>{try{if(ye?.type==="help-typing"){const Ze=String(ye.requestId||"");if(!Ze)return;q(Fe=>({...Fe,[Ze]:{who:ye.fromName||"someone",ts:Date.now()}}));return}if(ye?.type==="help-request"){const Ze=ye.request;if(!Ze||!Ze.id)return;ie(Fe=>{const Yt=(Fe||[]).filter(Dn=>String(Dn.id)!==String(Ze.id));return[Ze,...Yt]});return}ye?.type==="help-request-updated"&&E()}catch{}}),Z=setInterval(()=>{const ye=Date.now();let Ze=!1;const Fe={...ae};for(const Yt of Object.keys(Fe))ye-Fe[Yt].ts>3500&&(delete Fe[Yt],Ze=!0);Ze&&q(Fe)},1500);return()=>{try{p()}catch{}clearInterval(Z)}},[n]);async function $e(p){try{const Z={"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("authToken")}`};(await fetch(`/api/admin/help-requests/${encodeURIComponent(p)}/claim`,{method:"POST",headers:Z,body:JSON.stringify({})})).ok&&await E()}catch{}}async function jt(p){try{const Z={"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("authToken")}`};(await fetch(`/api/admin/help-requests/${encodeURIComponent(p)}/resolve`,{method:"POST",headers:Z,body:JSON.stringify({})})).ok&&await E()}catch{}}async function Mt(){a&&(await fetch("/api/admins/grant",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("authToken")}`},body:JSON.stringify({email:a})}),o(""))}async function Et(){if(A.trim())try{const p={Authorization:`Bearer ${localStorage.getItem("authToken")}`},Z=await fetch(`/api/admin/users/search?q=${encodeURIComponent(A)}`,{headers:p});if(Z.ok){const ye=await Z.json();x(Array.isArray(ye.users)?ye.users:[])}}catch(p){console.error("Search failed:",p)}}async function fe(p){try{await fetch("/api/admin/users/ban",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("authToken")}`},body:JSON.stringify({email:p})}),await Et()}catch(Z){console.error("Ban failed:",Z)}}async function Qt(p){try{await fetch("/api/admin/users/unban",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("authToken")}`},body:JSON.stringify({email:p})}),await Et()}catch(Z){console.error("Unban failed:",Z)}}async function Be(){f(!0);try{const p=new Date(w.startAt).getTime(),Z=await fetch("/api/tournaments/create",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:w.title,game:w.game,mode:w.mode,value:Number(w.value),description:w.description,startAt:p,checkinMinutes:Number(w.checkinMinutes),capacity:Number(w.capacity),requireCalibration:!!w.requireCalibration,creatorEmail:t?.email,creatorName:t?.username,requesterEmail:t?.email,official:!0,prizeType:"premium",prizeAmount:Number(w.prizeAmount||0),prizeNotes:w.prizeNotes})});await E();try{const ye=await Z.json();ye&&ye.tournament&&ye.tournament.id&&window.dispatchEvent(new CustomEvent("ndn:change-tab",{detail:{tab:"tournaments"}}))}catch{}}finally{f(!1)}}async function vn(p,Z){f(!0);try{await fetch("/api/admin/tournaments/winner",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("authToken")}`},body:JSON.stringify({tournamentId:p,winnerEmail:Z})}),await E()}finally{f(!1)}}async function Gt(p){f(!0);try{await fetch("/api/admin/tournaments/delete",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("authToken")}`},body:JSON.stringify({tournamentId:p})}),await E()}finally{f(!1)}}async function ht(){f(!0);try{await fetch("/api/admin/tournaments/reseed-weekly",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("authToken")}`},body:JSON.stringify({})}),await E()}finally{f(!1)}}async function _e(p){f(!0);try{await fetch("/api/admin/matches/delete",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("authToken")}`},body:JSON.stringify({matchId:p})}),await E()}finally{f(!1)}}async function Te(){try{const p={Authorization:`Bearer ${localStorage.getItem("authToken")}`},Z=await fetch("/api/admin/logs",{headers:p});if(Z.ok){const ye=await Z.json();ye?.ok&&Pe(ye.logs||[])}}catch(p){console.error("Failed to fetch logs:",p)}}async function Ge(){try{const p={Authorization:`Bearer ${localStorage.getItem("authToken")}`},Z=await fetch("/api/admin/system-health",{headers:p});if(Z.ok){const ye=await Z.json();ye?.ok&&ye?.health&&(Ae({database:ye.health.database||!1,websocket:ye.health.websocket||!1,https:ye.health.https||!1,maintenance:ye.health.maintenance||!1,clustering:ye.health.clustering||!1,uptime:ye.health.uptime||0,memory:ye.health.memory||{heapUsed:0},version:ye.health.version||"unknown"}),H(ye.health?.clustering||!1))}}catch(p){console.error("Failed to fetch system health:",p)}}async function it(p){f(!0);try{const ye=await(await fetch("/api/admin/clustering",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("authToken")}`},body:JSON.stringify({enabled:p,maxWorkers:4,capacity:I})})).json();console.log("Clustering response:",ye),ye?.ok?(alert(`Clustering ${p?"enabled":"disabled"} successfully. Max capacity: ${I.toLocaleString()} concurrent users. NODE_WORKERS environment variable is set to max capacity.`),await Ge()):alert(`Failed: ${ye?.error||ye?.message||"Unknown error"}`)}catch(Z){console.error("Clustering toggle failed:",Z),alert("Clustering toggle failed: "+(Z instanceof Error?Z.message:String(Z)))}finally{f(!1)}}async function Ft(p){B(p)}async function ct(){try{const p={Authorization:`Bearer ${localStorage.getItem("authToken")}`},Z=await fetch("/api/admin/email-copy",{headers:p});if(Z.ok){const ye=await Z.json();ye?.ok&&j(ye.copy||$)}}catch{}}i.useEffect(()=>{L&&ct()},[L]),i.useEffect(()=>{L&&(N==="general"||N==="maintenance")&&(Te(),Ge())},[L,N]);async function $n(p,Z){await fetch("/api/admin/email-copy",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("authToken")}`},body:JSON.stringify({kind:p,...Z})}),await ct()}async function Ut(p,Z){try{const ye={Authorization:`Bearer ${localStorage.getItem("authToken")}`},Fe=await(await fetch(`/api/email/preview?kind=${encodeURIComponent(p)}`,{headers:ye})).text();if(Z){const Yt=window.open();if(Yt){Yt.document.open(),Yt.document.write(Fe),Yt.document.close();return}}M({open:!0,kind:p,html:Fe})}catch{M({open:!0,kind:p,html:'<!doctype html><html><body style="font-family:sans-serif;padding:16px">Failed to load preview.</body></html>'})}}i.useEffect(()=>{if(!T.open)return;function p(Z){Z.key==="Escape"&&M({open:!1})}return document.addEventListener("keydown",p),()=>document.removeEventListener("keydown",p)},[T.open]);function at({kind:p,label:Z}){const Ze=$?.[p==="confirm-email"?"confirmEmail":p==="changed"?"changed":p]||{title:"",intro:"",buttonLabel:""},[Fe,Yt]=i.useState(Ze.title||""),[Dn,Bn]=i.useState(Ze.intro||""),[et,In]=i.useState(Ze.buttonLabel||"");return i.useEffect(()=>{Yt(Ze.title||""),Bn(Ze.intro||""),In(Ze.buttonLabel||"")},[Ze.title,Ze.intro,Ze.buttonLabel]),e.jsxs("div",{className:"p-2 rounded bg-black/20 space-y-2",children:[e.jsx("div",{className:"font-semibold",children:Z}),e.jsx("input",{className:"input w-full",placeholder:"Title (optional)",value:Fe,onChange:Wt=>Yt(Wt.target.value)}),e.jsx("textarea",{className:"input w-full",rows:2,placeholder:"Intro line (optional)",value:Dn,onChange:Wt=>Bn(Wt.target.value)}),e.jsx("input",{className:"input w-full",placeholder:"Button label (optional)",value:et,onChange:Wt=>In(Wt.target.value)}),e.jsxs("div",{className:"flex gap-2 justify-end",children:[e.jsx("button",{className:"btn",type:"button",onClick:()=>Ut(p,!0),children:"Preview"}),e.jsx("button",{className:"btn",type:"button",onClick:()=>Ut(p),children:"Popup"}),e.jsx("button",{className:"btn",onClick:()=>$n(p,{title:Fe,intro:Dn,buttonLabel:et}),children:"Save"})]})]})}return L?e.jsxs("div",{className:"p-4 md:p-8 max-w-7xl mx-auto ndn-page",children:[e.jsxs("div",{className:"flex flex-col md:flex-row items-center justify-between gap-4 mb-8",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-3xl font-black text-white tracking-tight ndn-section-title",children:"Admin ðŸ›¡ï¸"}),e.jsx("p",{className:"text-white/40 font-medium",children:"System management and oversight"})]}),e.jsxs("div",{className:"shrink-0 flex items-center gap-2",children:[e.jsx(qu,{}),n&&n.reconnect&&e.jsx("button",{onClick:()=>n.reconnect(),className:"ml-1 rounded-md bg-neutral-700/60 hover:bg-neutral-600/70 px-2.5 py-1 text-xs border border-white/10",title:"Force close and recreate the WebSocket connection",children:"Recreate WS"})]})]}),te.length>0&&e.jsxs("div",{className:"p-2 rounded-xl bg-amber-900/10 border border-amber-500/20 mb-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"font-semibold",children:"Open Help Requests ðŸ†˜"}),e.jsxs("span",{className:"text-sm opacity-80",children:[te.length," open"]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{className:"btn",onClick:()=>ge(te[0]),children:"Open Latest"}),e.jsx("button",{className:"btn btn-ghost",onClick:()=>E(),children:"Refresh"})]})]}),e.jsx("div",{className:"mt-2 flex gap-2 overflow-x-auto",children:te.slice(0,6).map(p=>e.jsxs("div",{className:"p-2 rounded bg-black/10 border border-white/10 min-w-[220px]",children:[e.jsx("div",{className:"font-medium",children:p.username||"Anonymous"}),e.jsx("div",{className:"text-xs opacity-70",children:new Date(p.ts||0).toLocaleTimeString()}),e.jsx("div",{className:"text-sm truncate mt-1",children:p.message}),e.jsxs("div",{className:"mt-2 flex gap-2",children:[p.status==="open"?e.jsx("button",{className:"btn",onClick:()=>$e(p.id),children:"Claim"}):e.jsxs("span",{className:"text-xs opacity-70",children:[p.status," by ",p.claimedBy||"â€”"]}),e.jsx("button",{className:"btn",onClick:()=>ge(p),children:"Chat"})]})]},p.id))})]}),L&&e.jsx(Tu,{tabs:[{key:"general",label:"General"},{key:"maintenance",label:"Maintenance"},{key:"premium",label:"Premium"},{key:"tourneys",label:"Tourneys"},{key:"helpdesk",label:"Help Desk"}],active:N,onChange:p=>P(p),className:"mb-4"})," ",N==="general"&&e.jsxs(e.Fragment,{children:[L&&e.jsxs("div",{className:"card",children:[e.jsx("h3",{className:"text-xl font-semibold mb-2",children:"Game Usage"}),e.jsxs("div",{className:"rounded-xl border border-indigo-500/40 bg-indigo-500/10 p-3",children:[e.jsx(Eu,{data:st.map(p=>({label:"",value:p.value}))}),e.jsx("div",{className:"mt-2 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-2 text-[11px] opacity-80",children:st.map((p,Z)=>e.jsxs("div",{className:"flex items-center justify-between px-2 py-1 rounded-md bg-white/5 border border-white/10",children:[e.jsx("span",{className:"truncate mr-2",children:p.label}),e.jsxs("span",{className:"whitespace-nowrap",children:["Played ",p.value," Â· Won ",p.won]})]},Z))})]})]}),L&&e.jsxs("div",{className:"card",children:[e.jsx("h3",{className:"text-xl font-semibold mb-2",children:"Calibration Quality Status"}),e.jsx("div",{className:"text-sm opacity-80 mb-3",children:"Camera calibration confidence by game mode. Shows current system calibration readiness for each game."}),e.jsx("div",{className:"rounded-xl border border-amber-500/40 bg-amber-500/5 p-3",children:e.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-2 text-[11px]",children:pt.map(p=>{const Z=p.confidence>=85?"bg-emerald-500/20 border-emerald-500/40 text-emerald-200":p.confidence>=70?"bg-amber-500/20 border-amber-500/40 text-amber-200":"bg-rose-500/20 border-rose-500/40 text-rose-200";return e.jsxs("div",{className:`px-2 py-2 rounded-md border ${Z}`,children:[e.jsx("div",{className:"font-semibold text-xs truncate",children:p.game}),e.jsx("div",{className:"text-[10px] opacity-80 truncate",children:p.qualityInfo.quality}),e.jsxs("div",{className:"text-[10px] font-mono mt-0.5",children:[Math.round(p.confidence),"%"]})]},p.game)})})})]}),e.jsxs("div",{className:"card",children:[e.jsx("h2",{className:"text-2xl font-bold mb-2",children:"Admin Control âš™ï¸"}),e.jsx("div",{className:"text-sm opacity-80 mb-3",children:"Grant or revoke Admin to trusted users. Only the owner can perform these actions."}),e.jsxs("div",{className:"flex gap-2 mb-3",children:[e.jsx("input",{className:"input flex-1",placeholder:"user@example.com",value:a,onChange:p=>o(p.target.value)}),e.jsx("button",{className:"btn",disabled:u,onClick:Mt,children:"Grant"}),e.jsx("button",{className:"btn bg-rose-600 hover:bg-rose-700",disabled:u,onClick:()=>J(a),children:"Revoke"})]}),e.jsx("div",{className:"text-sm opacity-80 mb-2",children:"Current Admins:"}),e.jsx("div",{className:"flex flex-wrap gap-2 mb-4",children:r.map(p=>e.jsx("div",{className:"px-2 py-1 rounded bg-indigo-600/20 border border-indigo-500/40 text-sm",children:p},p))}),e.jsx("hr",{className:"border-indigo-500/20 my-4"}),e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"Premium Access Control"}),e.jsx("div",{className:"text-sm opacity-80 mb-3",children:"Grant or revoke Premium subscription access to users (grants 30 days)."}),e.jsxs("div",{className:"flex gap-2 mb-3",children:[e.jsx("input",{className:"input flex-1",placeholder:"user@example.com",value:a,onChange:p=>o(p.target.value)}),e.jsx("button",{className:"btn bg-emerald-600 hover:bg-emerald-700",disabled:u||!a.trim(),onClick:()=>z(a,30),children:"Grant Premium"}),e.jsx("button",{className:"btn bg-rose-600 hover:bg-rose-700",disabled:u,onClick:()=>oe(a),children:"Revoke Premium"})]}),e.jsx("div",{className:"text-sm opacity-80",children:"Premium grants provide 30 days of unlimited access to all features."})]}),e.jsxs("div",{className:"card",children:[e.jsx("h3",{className:"text-xl font-bold mb-4 text-white/90",children:"Announcements ðŸ“¢"}),e.jsx("div",{className:"text-sm opacity-80 mb-2",children:"Send a message to all users. This will appear as a toast notification."}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{className:"input flex-1",placeholder:"Announcement message...",value:l,onChange:p=>b(p.target.value)}),e.jsx("button",{className:"btn",disabled:u||!l.trim(),onClick:je,children:"Send"})]})]}),e.jsxs("div",{className:"card",children:[e.jsx("h3",{className:"text-xl font-semibold mb-2",children:"User Search"}),e.jsx("div",{className:"text-sm opacity-80 mb-2",children:"Search for users by email or name."}),e.jsxs("div",{className:"flex gap-2 mb-3",children:[e.jsx("input",{className:"input flex-1",placeholder:"Search users...",value:A,onChange:p=>k(p.target.value)}),e.jsx("button",{className:"btn",disabled:u,onClick:Et,children:"Search"})]}),S.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-sm opacity-80 mb-2",children:"Results:"}),S.map(p=>e.jsx("div",{className:"p-2 rounded bg-black/20 text-sm flex items-center justify-between",children:e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold",children:p.name||"No name"}),e.jsx("div",{className:"opacity-70",children:p.email}),e.jsxs("div",{className:"opacity-60 text-xs",children:["Joined ",new Date(p.createdAt).toLocaleDateString()]})]})},p.email))]})]}),L&&e.jsxs("div",{className:"card",children:[e.jsx("h3",{className:"text-xl font-semibold mb-3",children:"Email Templates"}),e.jsx("div",{className:"text-sm opacity-80 mb-2",children:"Customize titles, intro lines, and button text. Previews open in a new tab or as a popup."}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[e.jsx(at,{kind:"reset",label:"Password reset"}),e.jsx(at,{kind:"reminder",label:"Password reset reminder"}),e.jsx(at,{kind:"confirm-email",label:"Confirm new email"}),e.jsx(at,{kind:"changed",label:"Password changed notice"})]})]})]}),N==="maintenance"&&L&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"card",children:[e.jsx("h3",{className:"text-xl font-semibold mb-2",children:"User Management"}),e.jsx("div",{className:"text-sm opacity-80 mb-2",children:"Ban or unban users. Use with caution."}),e.jsxs("div",{className:"flex gap-2 mb-3",children:[e.jsx("input",{className:"input flex-1",placeholder:"user@example.com",value:A,onChange:p=>k(p.target.value)}),e.jsx("button",{className:"btn",disabled:u,onClick:Et,children:"Search"})]}),S.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-sm opacity-80 mb-2",children:"Results:"}),S.map(p=>e.jsxs("div",{className:"p-2 rounded bg-black/20 text-sm flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold",children:p.name||"No name"}),e.jsx("div",{className:"opacity-70",children:p.email}),e.jsxs("div",{className:"opacity-60 text-xs",children:["Joined ",new Date(p.createdAt).toLocaleDateString()]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{className:"btn bg-red-600 hover:bg-red-700 text-xs",onClick:()=>fe(p.email),children:"Ban"}),e.jsx("button",{className:"btn bg-green-600 hover:bg-green-700 text-xs",onClick:()=>Qt(p.email),children:"Unban"})]})]},p.email))]})]}),e.jsxs("div",{className:"card",children:[e.jsx("h3",{className:"text-xl font-semibold mb-3",children:"System Health"}),e.jsx("div",{className:"text-sm opacity-80 mb-3",children:"Current status of system components and services."}),ne?e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{children:"Database"}),e.jsx("span",{className:`px-2 py-1 rounded text-xs ${ne.database?"bg-emerald-600":"bg-red-600"}`,children:ne.database?"Ready":"Down"})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{children:"WebSocket"}),e.jsx("span",{className:`px-2 py-1 rounded text-xs ${ne.websocket?"bg-emerald-600":"bg-red-600"}`,children:ne.websocket?"Ready":"Down"})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{children:"HTTPS"}),e.jsx("span",{className:`px-2 py-1 rounded text-xs ${ne.https?"bg-emerald-600":"bg-amber-600"}`,children:ne.https?"Enabled":"HTTP Only"})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{children:"Maintenance Mode"}),e.jsx("span",{className:`px-2 py-1 rounded text-xs ${ne.maintenance?"bg-red-600":"bg-emerald-600"}`,children:ne.maintenance?"Active":"Normal"})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{children:"Clustering (Auto-Scaling)"}),e.jsx("span",{className:`px-2 py-1 rounded text-xs ${ce?"bg-emerald-600":"bg-amber-600"}`,children:ce?"Enabled":"Disabled"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"text-sm",children:[e.jsx("span",{className:"font-semibold",children:"Uptime:"})," ",Math.floor(ne.uptime/3600),"h"," ",Math.floor(ne.uptime%3600/60),"m"]}),e.jsxs("div",{className:"text-sm",children:[e.jsx("span",{className:"font-semibold",children:"Memory:"})," ",ne.memory?Math.round(ne.memory.heapUsed/1024/1024):"?","MB used"]}),e.jsxs("div",{className:"text-sm",children:[e.jsx("span",{className:"font-semibold",children:"Version:"})," ",ne.version]}),e.jsxs("div",{className:"flex gap-2 flex-wrap",children:[e.jsx("button",{className:"btn",onClick:Ge,children:"Refresh"}),e.jsxs("button",{className:`btn ${ce?"bg-amber-600 hover:bg-amber-700":"bg-emerald-600 hover:bg-emerald-700"}`,disabled:u,onClick:()=>it(!ce),children:[ce?"Disable":"Enable"," Clustering"]})]})]})]}):e.jsxs("div",{className:"text-center py-4",children:[e.jsx("div",{className:"text-sm opacity-60 mb-2",children:"Loading system health..."}),e.jsx("button",{className:"btn",onClick:Ge,children:"Load Health Status"})]}),e.jsxs("div",{className:"mt-4 pt-4 border-t border-white/10",children:[e.jsx("h4",{className:"font-semibold mb-3",children:"Clustering Capacity"}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("label",{className:"font-semibold",children:"Max Concurrent Users"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{className:"btn",onClick:()=>de(!1),children:"Close"}),e.jsx("button",{className:"btn",onClick:K,disabled:!L||u,children:"Force broadcast"})]})]}),e.jsx("input",{type:"range",min:"1500",max:"50000",step:"500",value:I,onChange:p=>Ft(Number(p.target.value)),disabled:u,className:"w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed",style:{background:ce?`linear-gradient(to right, #3b82f6 0%, #3b82f6 ${(I-1500)/48500*100}%, #374151 ${(I-1500)/48500*100}%, #374151 100%)`:"#374151"}}),e.jsxs("div",{className:"flex justify-between text-xs opacity-60 mt-1",children:[e.jsx("span",{children:"1.5k"}),e.jsx("span",{children:"50k"})]})]}),e.jsx("div",{className:"flex gap-2 flex-wrap",children:e.jsxs("button",{className:`btn ${ce?"bg-amber-600 hover:bg-amber-700":"bg-emerald-600 hover:bg-emerald-700"}`,disabled:u,onClick:()=>it(!ce),children:[ce?"Disable":"Enable"," Clustering"]})})]}),e.jsxs("div",{className:"text-xs opacity-70 mt-2 p-2 bg-white/5 rounded",children:["ðŸ’¡ Clustering enables auto-scaling with capacity up to"," ",I.toLocaleString()," concurrent users. Adjust the slider to set maximum capacity. NODE_WORKERS environment variable is set to handle the configured load behind a reverse proxy."]})]})]}),e.jsxs("div",{className:"card",children:[e.jsx("h3",{className:"text-xl font-semibold mb-3",children:"User Reports"}),e.jsxs("ul",{className:"space-y-2",children:[U.map(p=>e.jsx("li",{className:"p-2 rounded bg-black/20 text-sm",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-mono text-xs",children:p.id}),e.jsxs("div",{children:[e.jsx("span",{className:"font-semibold",children:p.reporter})," â†’"," ",e.jsx("span",{className:"font-semibold",children:p.offender})," Â·"," ",new Date(p.ts).toLocaleString()]}),e.jsxs("div",{className:"opacity-80",children:["Reason: ",p.reason]}),p.messageId&&e.jsxs("div",{className:"opacity-60 text-xs",children:["Message ID: ",p.messageId]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("span",{className:`px-2 py-0.5 rounded text-xs ${p.status==="open"?"bg-amber-600":"bg-emerald-600"}`,children:p.status}),p.status==="open"&&e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"btn bg-emerald-600 hover:bg-emerald-700",disabled:u,onClick:async()=>{await fetch("/api/admin/reports/resolve",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("authToken")}`},body:JSON.stringify({id:p.id,action:"resolved"})}),await E()},children:"Resolve"}),e.jsx("button",{className:"btn bg-rose-600 hover:bg-rose-700",disabled:u,onClick:async()=>{const Z=prompt("Enter notes for action taken (e.g., warning, block):")||"";await fetch("/api/admin/reports/resolve",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("authToken")}`},body:JSON.stringify({id:p.id,action:"actioned",notes:Z})}),await E()},children:"Action"})]})]})]})},p.id)),U.length===0&&e.jsx("li",{className:"opacity-60",children:"No reports."})]})]}),e.jsxs("div",{className:"card",children:[e.jsx("h3",{className:"text-xl font-semibold mb-3",children:"Open Matches"}),e.jsxs("ul",{className:"space-y-1",children:[(c?.matches||[]).map(p=>e.jsxs("li",{className:"flex items-center justify-between p-2 rounded bg-black/20 text-sm",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"font-mono text-xs",children:p.id}),e.jsx("span",{className:"opacity-80",children:p.creatorName}),e.jsxs("span",{className:"opacity-60",children:[p.game," Â· ",As(p.mode)," ",p.value," ",p.game==="X01"?`/${p.startingScore}`:""]})]}),e.jsx("button",{className:"btn bg-rose-600 hover:bg-rose-700",disabled:u,onClick:()=>_e(p.id),children:"Remove"})]},p.id)),(!c?.matches||c.matches.length===0)&&e.jsx("li",{className:"text-sm opacity-60",children:"No open matches."})]})]}),e.jsxs("div",{className:"card",children:[e.jsx("h3",{className:"text-xl font-semibold mb-3",children:"Dangerous Operations"}),e.jsx("div",{className:"text-sm opacity-80 mb-3 text-red-400",children:"âš ï¸ These operations can cause data loss or service disruption. Use with extreme caution."}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold mb-2 text-red-400",children:"Tournament Deletion"}),e.jsxs("ul",{className:"space-y-2",children:[g.map(p=>e.jsxs("li",{className:"p-2 rounded bg-red-900/20 border border-red-500/40 text-sm",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"font-semibold",children:p.title}),e.jsx("div",{className:"opacity-70",children:p.status})]}),e.jsxs("div",{className:"opacity-80",children:[p.game," Â· ",As(p.mode)," ",p.value]}),e.jsx("div",{className:"mt-2",children:e.jsx("button",{className:"btn bg-red-600 hover:bg-red-700 text-xs",disabled:u,onClick:()=>Gt(p.id),children:"Delete Tournament"})})]},p.id)),g.length===0&&e.jsx("li",{className:"opacity-60",children:"No tournaments."})]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold mb-2 text-red-400",children:"System Maintenance"}),e.jsx("div",{className:"space-y-2",children:e.jsxs("div",{className:"p-3 rounded bg-red-900/20 border border-red-500/40",children:[e.jsx("div",{className:"font-semibold text-red-400 mb-2",children:"Maintenance Mode"}),e.jsx("div",{className:"text-sm opacity-80 mb-3",children:"Put the entire site into maintenance mode. Users won't be able to access games or create matches."}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:`px-2 py-1 rounded text-xs ${c?.maintenance?"bg-red-600":"bg-green-600"}`,children:c?.maintenance?"MAINTENANCE ACTIVE":"NORMAL OPERATION"}),e.jsx("button",{className:`btn ${c?.maintenance?"bg-green-600 hover:bg-green-700":"bg-red-600 hover:bg-red-700"}`,disabled:u,onClick:()=>se(!c?.maintenance),children:c?.maintenance?"Disable":"Enable"})]})]})})]})]})]}),G&&e.jsx(lc,{request:G,user:{email:t?.email,username:t?.username,isAdmin:!0},onClose:()=>ge(null)})]}),N==="premium"&&L&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"card",children:[e.jsx("h3",{className:"text-xl font-semibold mb-2",children:"Premium Subscription Grants"}),e.jsx("div",{className:"text-sm opacity-80 mb-3",children:"Grant or revoke premium subscriptions for users (grants 30 days)."}),e.jsxs("div",{className:"flex gap-2 mb-3",children:[e.jsx("input",{className:"input flex-1",placeholder:"user@example.com",value:a,onChange:p=>o(p.target.value)}),e.jsx("button",{className:"btn",disabled:u||!a.trim(),onClick:()=>z(a,30),children:"Grant"}),e.jsx("button",{className:"btn bg-rose-600 hover:bg-rose-700",disabled:u,onClick:()=>oe(a),children:"Revoke"})]}),e.jsx("div",{className:"text-sm opacity-80 mb-2",children:"Premium users get 30 days of access to all features."})]}),e.jsxs("div",{className:"card",children:[e.jsx("h3",{className:"text-xl font-semibold mb-2",children:"Premium Winners"}),e.jsx("div",{className:"text-sm opacity-80 mb-2",children:"Users who have won premium through tournaments."}),e.jsxs("div",{className:"space-y-2",children:[V.map(p=>e.jsxs("div",{className:"p-2 rounded bg-black/20 text-sm flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold",children:p.name||"No name"}),e.jsx("div",{className:"opacity-70",children:p.email}),e.jsxs("div",{className:"opacity-60 text-xs",children:["Expires ",new Date(p.expiresAt).toLocaleDateString()]})]}),e.jsx("div",{className:"flex gap-2",children:p.expired?e.jsx("span",{className:"px-2 py-1 rounded bg-amber-600 text-xs",children:"Premium Expired"}):e.jsx("span",{className:"px-2 py-1 rounded bg-emerald-600 text-xs",children:"Premium Active"})})]},p.email)),V.length===0&&e.jsx("div",{className:"opacity-60",children:"No premium winners."})]})]})]}),N==="tourneys"&&L&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"card",children:[e.jsx("h3",{className:"text-xl font-semibold mb-3",children:"Create Official Tournament"}),e.jsx("div",{className:"text-sm opacity-80 mb-3",children:"Set up a new official tournament with custom rules, timing, and prizes."}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("input",{className:"input w-full",placeholder:"Tournament Title",value:w.title,onChange:p=>C(Z=>({...Z,title:p.target.value}))}),e.jsxs("div",{className:"grid grid-cols-3 gap-2",children:[e.jsx("select",{className:"input",value:w.game,onChange:p=>C(Z=>({...Z,game:p.target.value})),children:["X01","Around the Clock","Cricket","Halve It","Shanghai","High-Low"].map(p=>e.jsx("option",{value:p,children:p},p))}),e.jsx("select",{className:"input",value:w.mode,onChange:p=>C(Z=>({...Z,mode:p.target.value})),children:Vu(w.game).map(p=>e.jsx("option",{value:String(p),children:As(String(p))},String(p)))}),(()=>{const p=Wu(w.game,w.mode);return p&&p.length>0?e.jsx("select",{className:"input",value:String(w.value),onChange:Z=>C(ye=>({...ye,value:Number(Z.target.value)})),children:p.map(Z=>e.jsx("option",{value:String(Z),children:Z},Z))}):e.jsx("input",{className:"input",type:"number",min:1,value:w.value,onChange:Z=>C(ye=>({...ye,value:Number(Z.target.value)}))})})()]}),e.jsx("textarea",{className:"input w-full",rows:2,placeholder:"Description",value:w.description,onChange:p=>C(Z=>({...Z,description:p.target.value}))}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx("input",{className:"input",type:"datetime-local",value:w.startAt,onChange:p=>C(Z=>({...Z,startAt:p.target.value}))}),e.jsx("input",{className:"input",type:"number",min:0,placeholder:"Checkin minutes",value:w.checkinMinutes,onChange:p=>C(Z=>({...Z,checkinMinutes:Number(p.target.value)}))})]}),e.jsx("input",{className:"input w-full",type:"number",min:6,max:64,placeholder:"Capacity",value:w.capacity,onChange:p=>C(Z=>({...Z,capacity:Number(p.target.value)}))}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 items-center",children:[e.jsx("select",{className:"input",value:"premium",disabled:!0,children:e.jsx("option",{value:"premium",children:"PREMIUM"})}),e.jsxs("select",{className:"input",value:w.prizeAmount,onChange:p=>C(Z=>({...Z,prizeType:"premium",prizeAmount:Number(p.target.value)})),children:[e.jsx("option",{value:1,children:"1 month"}),e.jsx("option",{value:3,children:"3 months"})]})]}),e.jsx("input",{className:"input w-full",placeholder:"Prize notes (optional)",value:w.prizeNotes,onChange:p=>C(Z=>({...Z,prizeNotes:p.target.value}))}),e.jsx("div",{className:"flex justify-end",children:e.jsx("button",{className:"btn bg-emerald-600 hover:bg-emerald-700",disabled:u,onClick:Be,children:"Create Tournament"})})]})]}),e.jsxs("div",{className:"card",children:[e.jsx("h3",{className:"text-xl font-semibold mb-3",children:"Tournament Premium Winners"}),e.jsx("div",{className:"text-sm opacity-80 mb-3",children:"Users who have won premium prizes in tournaments. Grant them access here."}),e.jsxs("div",{className:"space-y-2",children:[g.filter(p=>p.status==="completed"&&p.winnerEmail&&p.prizeType==="premium").map(p=>{const Z=V.find(Ze=>Ze.email===p.winnerEmail),ye=Z&&!Z.expired;return e.jsxs("div",{className:"p-3 rounded bg-black/20 text-sm",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("div",{className:"font-semibold",children:p.title}),e.jsx("div",{className:"text-xs opacity-70",children:new Date(p.startAt).toLocaleDateString()})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:p.winnerEmail}),e.jsxs("div",{className:"text-xs opacity-70",children:["Prize: ",p.prizeAmount," month",p.prizeAmount>1?"s":""," PREMIUM"]})]}),e.jsx("div",{className:"flex items-center gap-2",children:ye?e.jsx("span",{className:"px-2 py-1 rounded bg-emerald-600 text-xs",children:"âœ“ Access Granted"}):e.jsx("button",{className:"btn bg-emerald-600 hover:bg-emerald-700 text-xs",disabled:u,onClick:()=>z(p.winnerEmail,p.prizeAmount*30),children:"Grant Access"})})]})]},p.id)}),g.filter(p=>p.status==="completed"&&p.winnerEmail&&p.prizeType==="premium").length===0&&e.jsx("div",{className:"text-center py-4 text-sm opacity-60",children:"No completed premium tournaments."})]})]}),e.jsxs("div",{className:"card",children:[e.jsx("h3",{className:"text-xl font-semibold mb-3",children:"Manage Tournaments"}),e.jsx("div",{className:"text-sm opacity-80 mb-3",children:"View and manage all tournaments. Set winners and manage brackets."}),e.jsxs("ul",{className:"space-y-2",children:[g.map(p=>e.jsxs("li",{className:"p-3 rounded bg-black/20 text-sm",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold",children:p.title}),e.jsxs("div",{className:"opacity-80",children:[p.game," Â· ",As(p.mode)," ",p.value]})]}),e.jsx("div",{className:`px-2 py-1 rounded text-xs font-semibold ${p.status==="scheduled"?"bg-blue-600":p.status==="running"?"bg-green-600":p.status==="completed"?"bg-purple-600":"bg-gray-600"}`,children:p.status})]}),e.jsxs("div",{className:"text-xs opacity-70 mb-2",children:["Start: ",new Date(p.startAt).toLocaleString()," Â· Capacity:"," ",p.capacity]}),p.prize&&e.jsxs("div",{className:"text-xs mb-2",children:["Prize: ",p.prizeAmount||3," month",(p.prizeAmount||3)>1?"s":""," PREMIUM"]}),e.jsxs("div",{className:"mt-2 flex flex-wrap gap-2",children:[e.jsx("button",{className:"btn text-xs",disabled:u||p.status!=="scheduled",onClick:()=>vn(p.id,prompt("Winner email?")||""),children:"Set Winner"}),e.jsx("button",{className:"btn text-xs",disabled:u,onClick:()=>ht(),children:"Reseed"})]})]},p.id)),g.length===0&&e.jsx("li",{className:"opacity-60",children:"No tournaments."})]})]})]}),N==="helpdesk"&&L&&e.jsx(e.Fragment,{children:e.jsxs("div",{className:"card",children:[e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"Helpdesk Requests"}),e.jsx("div",{className:"text-sm opacity-80 mb-3",children:"All help requests from users who asked to speak with an admin. Status is shown for each request."}),te.length===0?e.jsx("div",{className:"text-sm opacity-70",children:"No help requests."}):e.jsx("div",{className:"space-y-2",children:te.map(p=>e.jsxs("div",{className:"p-2 rounded bg-black/10 border border-white/10 flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:p.username||"Anonymous"}),e.jsx("div",{className:"text-xs opacity-70",children:new Date(p.ts||0).toLocaleString()}),e.jsx("div",{className:"text-sm mt-1",children:p.message}),e.jsxs("div",{className:"mt-1",children:[e.jsx("span",{className:`text-xs px-2 py-1 rounded-full mr-2 ${p.status==="open"?"bg-emerald-700/30 text-emerald-200":p.status==="claimed"?"bg-amber-700/30 text-amber-200":"bg-slate-700/30 text-slate-200"}`,children:p.status||"unknown"}),p.claimedBy&&e.jsxs("span",{className:"text-xs opacity-70",children:["by ",p.claimedBy]})]}),ae[p.id]&&e.jsxs("div",{className:"text-xs text-amber-300 mt-1",children:[ae[p.id].who," typing..."]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[p.status==="open"&&e.jsx("button",{className:"btn",onClick:()=>$e(p.id),children:"Claim"}),p.status!=="resolved"&&e.jsx("button",{className:"btn btn-ghost",onClick:()=>jt(p.id),children:"Resolve"}),e.jsx("button",{className:"btn",onClick:()=>ge(p),children:"Chat"})]})]},p.id))})]})}),T.open&&e.jsxs("div",{className:"fixed inset-0 z-[1000]",onClick:()=>M({open:!1}),children:[e.jsx("div",{className:"absolute inset-0 bg-black/70 backdrop-blur-sm"}),e.jsx("div",{className:"absolute inset-0 p-4 md:p-8 overflow-auto flex items-start md:items-center justify-center",children:e.jsxs("div",{className:"w-full max-w-3xl bg-[#0b1020] rounded-2xl border border-indigo-500/40 shadow-2xl",onClick:p=>p.stopPropagation(),children:[e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b border-indigo-500/20",children:[e.jsxs("div",{className:"font-semibold",children:["Preview: ",T.kind]}),e.jsx("button",{className:"btn",onClick:()=>M({open:!1}),children:"Close"})]}),e.jsx("div",{className:"p-0 bg-black/30",children:e.jsx("iframe",{title:"Email Preview",style:{width:"100%",height:"70vh",border:"0",background:"transparent"},srcDoc:T.html||""})}),e.jsx("div",{className:"px-4 py-3 border-t border-indigo-500/20 text-xs opacity-70",children:"Click outside this panel or press Esc to close."})]})})]})]}):e.jsxs("div",{className:"card ndn-page",children:[e.jsx("h2",{className:"text-2xl font-bold mb-2 ndn-section-title",children:"Admin ðŸ›¡ï¸"}),e.jsx("div",{className:"text-sm opacity-80",children:"You don't have permission to manage admins."})]})}const dc=i.createContext(null),Ms="ndn:theme";function Vo(t=new Date){const n=t.getMonth(),r=t.getDate();return n===9||n===10&&r<=5?"halloween":n===11||n===0||n===1&&r<=14?"christmas":n===2||n===3?"easter":n>=5&&n<=7?"summer":"default"}function Xu({children:t}){const[n,r]=i.useState(()=>{try{const l=localStorage.getItem(`${Ms}:auto`);return l?JSON.parse(l):!0}catch{return!0}}),[s,a]=i.useState(()=>{try{const l=localStorage.getItem(Ms);if(l)return l}catch{}return Vo()});i.useEffect(()=>{try{localStorage.setItem(`${Ms}:auto`,JSON.stringify(n))}catch{}},[n]),i.useEffect(()=>{const l=n?Vo():s;try{l==="default"?document.documentElement.removeAttribute("data-theme"):document.documentElement.setAttribute("data-theme",l)}catch{}},[s,n]);const o=l=>{try{localStorage.setItem(Ms,l)}catch{}a(l)},c=i.useMemo(()=>({theme:s,setTheme:o,auto:n,setAuto:r}),[s,n]);return e.jsx(dc.Provider,{value:c,children:t})}function Qu(){const t=i.useContext(dc);if(!t)throw new Error("useTheme must be used inside ThemeProvider");return t}const Zu=["default","halloween","easter","summer","christmas"],em={default:{icon:"ðŸŽ¯",label:"Default",gradient:"from-slate-600 to-slate-800",ring:"ring-slate-400"},christmas:{icon:"ðŸŽ„",label:"Christmas",gradient:"from-red-600 to-green-700",ring:"ring-red-400"},easter:{icon:"ðŸ£",label:"Easter",gradient:"from-pink-400 to-purple-400",ring:"ring-pink-300"},halloween:{icon:"ðŸŽƒ",label:"Halloween",gradient:"from-orange-500 to-purple-800",ring:"ring-orange-400"},summer:{icon:"â˜€ï¸",label:"Summer",gradient:"from-yellow-400 to-sky-400",ring:"ring-yellow-300"}};function Wo(){const{theme:t,setTheme:n,auto:r,setAuto:s}=Qu();return e.jsxs("div",{className:"theme-toggle space-y-4",role:"group","aria-label":"Theme selector",children:[e.jsxs("label",{className:"flex items-center gap-3 cursor-pointer select-none",children:[e.jsx("div",{onClick:()=>s(!r),className:`relative w-11 h-6 rounded-full transition-colors ${r?"bg-gradient-to-r from-cyan-500 to-blue-500":"bg-white/20"}`,children:e.jsx("span",{className:`absolute top-0.5 left-0.5 w-5 h-5 bg-white rounded-full shadow transition-transform ${r?"translate-x-5":""}`})}),e.jsx("span",{className:"text-sm font-medium",children:"Auto seasonal theme ðŸŽ¯"})]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:Zu.map(a=>{const o=em[a],c=t===a;return e.jsxs("button",{onClick:()=>n(a),disabled:r,"aria-pressed":c,title:`Set ${o.label} theme`,className:`
                relative flex items-center gap-2 px-4 py-2 rounded-full text-sm font-semibold
                transition-all duration-200 shadow-md
                ${r?"opacity-50 cursor-not-allowed":"hover:scale-105 active:scale-95"}
                ${c?`bg-gradient-to-r ${o.gradient} text-white ring-2 ${o.ring} ring-offset-2 ring-offset-black/50`:"bg-white/10 text-white/80 hover:bg-white/20"}
              `,children:[e.jsx("span",{className:"text-lg",children:o.icon}),e.jsxs("span",{children:[o.label," ðŸŽ¯"]}),c&&e.jsx("span",{className:"ml-1 w-2 h-2 rounded-full bg-white animate-pulse"})]},a)})})]})}function tm({user:t}){const{favoriteDouble:n,callerEnabled:r,callerVoice:s,callerVolume:a,speakCheckoutOnly:o,avgMode:c,autoStartOffline:l,rememberLastOffline:b,reducedMotion:u,compactHeader:f,allowSpectate:g,cameraScale:m,cameraAspect:A,cameraFitMode:k,autoscoreProvider:S,autoscoreWsUrl:x,autoCommitMode:w,confirmUncertainDarts:C,autoScoreConfidenceThreshold:$,autoscoreDetectorMinArea:j,autoscoreDetectorThresh:T,autoscoreDetectorRequireStableN:M,harshLightingMode:N,enhanceBigTrebles:P,cameraRecordDarts:L,cameraShowLabels:V,calibrationGuide:U,preferredCameraId:te,preferredCameraLabel:ie,cameraEnabled:ae,offlineLayout:q,textSize:G,boxSize:ge,setFavoriteDouble:Pe,setCallerEnabled:ne,setCallerVoice:Ae,setCallerVolume:ce,setSpeakCheckoutOnly:H,setAvgMode:I,setAutoStartOffline:B,setRememberLastOffline:de,setReducedMotion:K,setCompactHeader:le,setAllowSpectate:we,setCameraScale:He,setCameraAspect:Qe,setCameraFitMode:tt,setAutoscoreProvider:pt,setAutoscoreWsUrl:st,setAutoCommitMode:E,setConfirmUncertainDarts:J,setAutoScoreConfidenceThreshold:z,setAutoscoreDetectorMinArea:oe,setAutoscoreDetectorThresh:je,setAutoscoreDetectorRequireStableN:se,setHarshLightingMode:$e,setEnhanceBigTrebles:jt,setCameraRecordDarts:Mt,setCameraShowLabels:Et,cameraLowLatency:fe,setCameraLowLatency:Qt,cameraProcessingFps:Be,setCameraProcessingFps:vn,setCalibrationGuide:Gt,preserveCalibrationOverlay:ht,setPreserveCalibrationOverlay:_e,preserveCalibrationOnCameraChange:Te,setPreserveCalibrationOnCameraChange:Ge,setPreferredCamera:it,setCameraEnabled:Ft,setOfflineLayout:ct,setTextSize:$n,setBoxSize:Ut,dartTimerEnabled:at,dartTimerSeconds:p,setDartTimerEnabled:Z,setDartTimerSeconds:ye,x01DoubleIn:Ze,setX01DoubleIn:Fe}=ve(),[Yt,Dn]=i.useState([{key:"first180",label:"First 180",unlocked:!1,icon:"ðŸ”¥",desc:"Score 180 in a match."},{key:"hundredGames",label:"100 Games Played",unlocked:!1,icon:"ðŸ†",desc:"Play 100 games."},{key:"tournamentWin",label:"Tournament Winner",unlocked:!1,icon:"ðŸ¥‡",desc:"Win a tournament."},{key:"bestLeg",label:"Best Leg",unlocked:!1,icon:"âš¡",desc:"Finish a leg in 12 darts or less."},{key:"comeback",label:"Comeback",unlocked:!1,icon:"ðŸ”¥",desc:"Win after trailing by 3 legs."}]);i.useEffect(()=>{const O=t?.username||"";O&&Dn(De=>De.map(dt=>({...dt,unlocked:!!localStorage.getItem(`ndn:achieve:${dt.key}:${O}`)})))},[t?.username]),i.useEffect(()=>{function O(){try{St("user")}catch{}}return window.addEventListener("ndn:open-settings-profile",O),()=>window.removeEventListener("ndn:open-settings-profile",O)},[]);const[Bn,et]=i.useState(!1),[In,Wt]=i.useState(""),[yn,wn]=i.useState(""),[mn,rn]=i.useState(""),[zt,tr]=i.useState(""),[nr,xt]=i.useState(""),[sn,Zt]=i.useState(!0),[$t,an]=i.useState(null),[lt,Lt]=i.useState([{text:"Hi! I'm your Nine Dart Nation assistant. How can I help you today?",isUser:!1}]),[vt,en]=i.useState("");i.useEffect(()=>{const O=t?.username||"";if(O)try{Wt(localStorage.getItem(`ndn:bio:favPlayer:${O}`)||""),wn(localStorage.getItem(`ndn:bio:favTeam:${O}`)||""),rn(localStorage.getItem(`ndn:bio:favDarts:${O}`)||""),tr(localStorage.getItem(`ndn:bio:bio:${O}`)||""),xt(localStorage.getItem(`ndn:bio:profilePhoto:${O}`)||""),Zt(localStorage.getItem(`ndn:settings:allowAnalytics:${O}`)!=="false")}catch{}},[t?.username]),i.useEffect(()=>{t?.email&&xn(`/api/subscription?email=${encodeURIComponent(t.email)}`).then(O=>O.json()).then(an).catch(()=>{})},[t?.email]);const It=()=>{const O=t?.username||"";if(O)try{localStorage.setItem(`ndn:bio:favPlayer:${O}`,In),localStorage.setItem(`ndn:bio:favTeam:${O}`,yn),localStorage.setItem(`ndn:bio:favDarts:${O}`,mn),localStorage.setItem(`ndn:bio:bio:${O}`,zt),localStorage.setItem(`ndn:bio:profilePhoto:${O}`,nr);try{window.dispatchEvent(new CustomEvent("ndn:avatar-updated",{detail:{username:O,avatar:nr}}))}catch{}localStorage.setItem(`ndn:settings:allowAnalytics:${O}`,sn.toString()),et(!1)}catch{}},Je={"how to play":"To play darts, select a game mode from the menu. For online play, join a match. For offline, start a local game.",camera:"Go to Settings > Camera & Vision > Camera Guide to set up your camera properly.",calibration:"Go to Settings > Camera & Vision > Camera Guide to set up your camera properly.",premium:'Premium unlocks all game modes. Click the "Upgrade to PREMIUM" button in online play.',username:"Change your username once for free in Settings > Account.",voice:"Enable voice caller in Settings > Audio & Voice. Test the voice with the Test Voice button.",friends:"Add friends in the Friends tab to play together.",stats:"View your statistics in the Stats tab.",settings:"Customize your experience in the Settings panel.",support:"Contact support via email or check the FAQ in Settings > Support."},Ot=O=>{try{window.dispatchEvent(new CustomEvent("ndn:change-tab",{detail:{tab:O}}))}catch(De){console.error("Navigation failed:",De)}},hr=O=>{const De=O.toLowerCase();if(De.includes("username")||De.includes("change name"))return{text:"You can change your username once for free.",links:[{text:"Go to Settings > Account",tab:"settings"}]};if(De.includes("premium")||De.includes("upgrade")||De.includes("subscription"))return{text:"Premium unlocks all game modes and features.",links:[{text:"Go to Online Play",tab:"online"}]};if(De.includes("calibrat")||De.includes("camera")||De.includes("vision"))return{text:"Set up your camera properly in Settings.",links:[{text:"Go to Settings > Camera & Vision",tab:"settings"}]};if(De.includes("voice")||De.includes("caller")||De.includes("audio"))return{text:"Enable voice calling in Settings.",links:[{text:"Go to Settings > Audio & Voice",tab:"settings"}]};if(De.includes("friend")||De.includes("play together"))return{text:"Add friends to play together.",links:[{text:"Go to Friends",tab:"friends"}]};if(De.includes("stat")||De.includes("score")||De.includes("performance"))return{text:"View your statistics and performance.",links:[{text:"Go to Stats",tab:"stats"}]};if(De.includes("setting")||De.includes("customiz")||De.includes("configur"))return{text:"Customize your experience.",links:[{text:"Go to Settings",tab:"settings"}]};if(De.includes("tournament")||De.includes("competition"))return{text:"Check out tournaments and competitions.",links:[{text:"Go to Tournaments",tab:"tournaments"}]};if(De.includes("help")||De.includes("support")||De.includes("faq"))return{text:"You're already in the help section! Check the Support section above for more resources.",links:[{text:"Scroll to Support",tab:"settings"}]};if(De.includes("how to play")||De.includes("game")||De.includes("start"))return{text:"To play darts, select a game mode from the menu. For online play, join a match. For offline, start a local game.",links:[{text:"Play Online",tab:"online"},{text:"Play Offline",tab:"offline"}]};const dt=Object.entries(Je).find(([ln])=>De.includes(ln.toLowerCase()));return dt?{text:dt[1],links:[{text:"Open FAQ",tab:"settings"}]}:{text:"I'm not sure about that. Try asking about playing, camera setup, premium, username changes, voice settings, friends, stats, or settings."}},An=()=>{if(!vt.trim())return;const O=vt.toLowerCase();Lt(dt=>[...dt,{text:vt,isUser:!0}]),en("");const De=hr(O);setTimeout(()=>{Lt(dt=>[...dt,{text:De,isUser:!1}])},500)},[tn,kr]=i.useState(""),[Kn,fr]=i.useState(!1),[Ht,Vn]=i.useState(""),[hn,Pt]=i.useState([]);i.useEffect(()=>{const O=()=>{const De=speechSynthesis.getVoices();Pt(De.filter(dt=>dt.lang.startsWith("en")))};O(),speechSynthesis.onvoiceschanged=O},[]);const[Wr,cn]=i.useState(!1),[fn,St]=i.useState(null),Nn=({label:O,icon:De,pill:dt,color:ln})=>e.jsxs("button",{onPointerDown:nn=>{nn.stopPropagation()},onMouseDown:nn=>{nn.stopPropagation()},onTouchStart:nn=>{nn.stopPropagation?.()},onClick:()=>St(nn=>nn===dt?null:dt),type:"button","data-testid":`pill-button-${dt}`,className:`select-none whitespace-nowrap rounded-full px-4 py-2 text-sm font-semibold shadow-sm focus:outline-none focus-visible:ring-2 focus-visible:ring-white/60 active:scale-[0.98] bg-gradient-to-r ${ln} text-white flex items-center gap-2`,children:[e.jsx(De,{className:"w-4 h-4"})," ",O,e.jsx(Cc,{className:`w-4 h-4 transition-transform ${fn===dt?"rotate-180":""}`})]});return e.jsxs("div",{className:"space-y-6 ndn-page",children:[e.jsx("div",{className:"rounded-[28px] border border-white/10 bg-gradient-to-br from-slate-950/70 via-indigo-950/30 to-slate-950/60 p-5 shadow-2xl",children:e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("div",{className:"text-xs uppercase tracking-[0.35em] text-slate-400",children:"Preferences"}),e.jsx("h2",{className:"mt-1 text-2xl font-extrabold text-white",children:"Settings"}),e.jsx("div",{className:"mt-1 text-sm text-slate-300/80",children:"Tune your camera, scoring, and app experience."})]}),e.jsx("div",{className:"shrink-0 rounded-2xl border border-white/10 bg-white/5 px-3 py-2",children:e.jsx(Wo,{})})]})}),e.jsx("div",{className:"relative rounded-[22px] bg-gradient-to-br from-white/[0.08] to-white/[0.03] backdrop-blur-md border border-white/10 p-2 shadow-xl",children:e.jsxs("div",{className:"flex items-center gap-2 overflow-x-auto no-scrollbar py-1 px-1",children:[e.jsx(Nn,{label:"User Info ðŸ‘¤",icon:Ls,pill:"user",color:"from-indigo-600 to-indigo-500"}),e.jsx(Nn,{label:"Camera Setup ðŸ“",icon:as,pill:"calibration",color:"from-emerald-600 to-emerald-500"}),e.jsx(Nn,{label:"App Settings âš™ï¸",icon:ss,pill:"settings",color:"from-purple-600 to-purple-500"})]})}),null,fn==="user"&&e.jsx("div",{"data-testid":"pill-user-content",className:"p-5 sm:p-6 rounded-[28px] border border-white/10 bg-slate-950/50 shadow-2xl space-y-4",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx("div",{className:"card",children:e.jsxs("div",{className:"p-3 rounded-xl border border-red-500/40 bg-red-500/10",children:[e.jsxs("div",{className:"font-semibold mb-4 flex items-center gap-2 text-red-100",children:[e.jsx(Ls,{className:"w-5 h-5"})," Account ðŸ‘¤"]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex justify-center gap-2",children:[e.jsx("button",{onClick:()=>window.dispatchEvent(new CustomEvent("ndn:logout")),className:"px-6 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium transition-colors",children:"Logout ðŸšª"}),e.jsx("button",{onClick:()=>cn(!0),className:"px-4 py-2 bg-slate-700 hover:bg-slate-800 text-white rounded-lg font-medium transition-colors",children:"Highlights âœ¨"})]}),e.jsxs("div",{className:"border-t border-red-500/20 pt-3",children:[e.jsxs("div",{className:"font-medium mb-2 text-red-100",children:["Change Username âœï¸ (",(()=>{const O=t?.usernameChangeCount||0;return O<2?`${2-O} free changes remaining`:"Â£2 per change"})(),")"]}),e.jsx("div",{className:"text-sm text-red-100 mb-2",children:"You can change your username up to 2 times for free. Additional changes cost Â£2 each."}),t?.usernameChangeCount>=2&&!tn.trim()?e.jsx("div",{className:"text-amber-400 text-sm mb-2",children:"âš ï¸ Additional username changes cost Â£2"}):null,e.jsx("input",{className:"input w-full mb-2",type:"text",placeholder:"New username",value:tn,onChange:O=>kr(O.target.value),disabled:Kn}),Ht&&e.jsx("div",{className:"text-red-400 text-sm mb-2",children:Ht}),e.jsx("button",{onClick:async()=>{if(Vn(""),!tn.trim()){Vn("Username required");return}if(tn.length<3||tn.length>20){Vn("Username must be 3-20 characters");return}(t?.usernameChangeCount||0)<2?(localStorage.setItem("pendingUsernameChange",tn.trim()),window.location.href="/?username-change=free"):window.location.href="https://buy.stripe.com/eVq4gB3XqeNS0iw6vAfnO02"},disabled:Kn||!tn.trim(),className:"w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-600 text-white rounded-lg font-medium transition-colors",children:Kn?"Processing...":(t?.usernameChangeCount||0)<2?"Change Username (FREE) âœï¸":"Change Username (Â£2) âœï¸"})]})]})]})}),$t&&e.jsx("div",{className:"card",children:e.jsxs("div",{className:"p-3 rounded-xl border border-green-500/40 bg-green-500/10",children:[e.jsxs("div",{className:"font-semibold mb-4 flex items-center gap-2 text-green-100",children:[e.jsx(Kr,{className:"w-5 h-5"})," Premium âœ¨"]}),e.jsxs("div",{className:"space-y-3 text-sm text-green-100",children:[e.jsxs("div",{children:["Status:"," ",e.jsx("span",{className:$t?.status==="active"?"text-green-400":"text-yellow-400",children:$t?.status==="active"?"âœ“ Active âœ…":"Not Active"})]}),$t?.status==="active"&&$t?.nextBillingDate&&e.jsxs("div",{children:["Next Billing:"," ",new Date($t.nextBillingDate).toLocaleDateString()]}),$t?.source==="tournament"&&$t?.status==="active"&&e.jsx("button",{onClick:()=>window.location.href="https://buy.stripe.com/eVq4gB3XqeNS0iw6vAfnO02",className:"w-full px-3 py-2 bg-red-600 hover:bg-red-700 text-white rounded font-medium transition-colors text-xs",children:"Cancel Subscription âŒ"})]})]})}),e.jsx("div",{className:"card",children:e.jsxs("div",{className:"p-3 rounded-xl border border-cyan-500/40 bg-cyan-500/10",children:[e.jsxs("div",{className:"font-semibold mb-4 flex items-center gap-2 text-cyan-100",children:[e.jsx(xa,{className:"w-5 h-5"})," Profile Photo ðŸ–¼ï¸"]}),e.jsx("input",{type:"file",accept:"image/*",onChange:O=>{const De=O.target.files?.[0];if(De){const dt=new FileReader;dt.onload=()=>xt(dt.result),dt.readAsDataURL(De)}},className:"w-full text-xs text-slate-100"})]})}),e.jsx("div",{className:"card",children:e.jsxs("div",{className:"p-3 rounded-xl border border-purple-500/40 bg-purple-500/10",children:[e.jsxs("div",{className:"font-semibold mb-4 flex items-center gap-2 text-purple-100",children:[e.jsx(Tn,{className:"w-5 h-5"})," Online & Socials ï¿½"]}),e.jsx("div",{className:"space-y-3",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{type:"checkbox",id:"allowSpectate",checked:g,onChange:O=>we(O.target.checked),className:"w-4 h-4"}),e.jsx("label",{htmlFor:"allowSpectate",className:"text-sm text-purple-100",children:"Allow spectators ðŸ‘ï¸"})]})})]})}),e.jsx("div",{className:"card",children:e.jsxs("div",{className:"p-3 rounded-xl border border-orange-500/40 bg-orange-500/10",children:[e.jsxs("div",{className:"font-semibold mb-4 flex items-center gap-2 text-orange-100",children:[e.jsx(Kr,{className:"w-5 h-5"})," Data & Privacy ðŸ›¡ï¸"]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{type:"checkbox",id:"allowAnalytics",checked:sn,onChange:O=>Zt(O.target.checked),className:"w-4 h-4"}),e.jsx("label",{htmlFor:"allowAnalytics",className:"text-sm text-orange-100",children:"Allow analytics ðŸ“Š"})]}),e.jsx("button",{onClick:()=>{const O={achievements:Yt,bio:{favPlayer:In,favTeam:yn,favDarts:mn,bio:zt}},De=new Blob([JSON.stringify(O,null,2)],{type:"application/json"}),dt=URL.createObjectURL(De),ln=document.createElement("a");ln.href=dt,ln.download=`my-data-${new Date().toISOString().split("T")[0]}.json`,ln.click(),URL.revokeObjectURL(dt)},className:"btn bg-orange-600 hover:bg-orange-700 w-full",children:"Export My Data ðŸ“¥"})]})]})}),e.jsx("div",{className:"card",children:e.jsxs("div",{className:"p-3 rounded-xl border border-red-500/40 bg-red-500/10",children:[e.jsxs("div",{className:"font-semibold mb-4 flex items-center gap-2",children:[e.jsx(Kr,{className:"w-5 h-5 text-red-400"})," Privacy & Copyright ðŸ›¡ï¸"]}),e.jsx("div",{className:"space-y-3 text-sm text-slate-300",children:e.jsxs("div",{className:"bg-red-500/20 border border-red-500/30 rounded-lg p-3",children:[e.jsx("p",{className:"font-semibold text-red-300 mb-2",children:"âš ï¸ Legal Notice âš–ï¸"}),e.jsxs("p",{className:"mb-2 text-xs",children:[e.jsx("strong",{children:"Copyright:"})," All content is protected by copyright law. ðŸ“œ"]}),e.jsxs("p",{className:"text-xs",children:[e.jsx("strong",{children:"Privacy:"})," Your data is protected and unauthorized access is prohibited. ðŸ”’"]})]})})]})}),e.jsx("div",{className:"card",children:e.jsxs("div",{className:"p-3 rounded-xl border border-yellow-500/40 bg-yellow-500/10",children:[e.jsxs("div",{className:"font-semibold mb-4 flex items-center gap-2 text-yellow-100",children:[e.jsx(Kr,{className:"w-5 h-5"})," Blocked Users"]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("p",{className:"text-sm text-yellow-100",children:"Manage players you've blocked from contacting you."}),e.jsx("button",{onClick:()=>window.dispatchEvent(new CustomEvent("ndn:open-blocklist")),className:"btn bg-yellow-600 hover:bg-yellow-700 w-full text-sm",children:"View Blocked Users ðŸš«"})]})]})}),e.jsx("div",{className:"card",children:e.jsxs("div",{className:"p-3 rounded-xl border border-blue-500/40 bg-blue-500/10",children:[e.jsxs("div",{className:"font-semibold mb-4 flex items-center gap-2 text-blue-100",children:[e.jsx(Tn,{className:"w-5 h-5"})," Contact & Support"]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("a",{href:"mailto:support@ninedartnation.com",className:"flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors text-sm",children:"ðŸ“§ Email Support"}),e.jsx("a",{href:"https://ninedartnation.com/help",target:"_blank",rel:"noopener noreferrer",className:"flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors text-sm",children:"â“ Help Center"}),e.jsx("a",{href:"https://ninedartnation.com/faq",target:"_blank",rel:"noopener noreferrer",className:"flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors text-sm",children:"ðŸ“‹ FAQ"})]})]})}),e.jsx("div",{className:"card",children:e.jsxs("div",{className:"p-3 rounded-xl border border-red-500/40 bg-red-500/10",children:[e.jsxs("div",{className:"font-semibold mb-4 flex items-center gap-2 text-red-100",children:[e.jsx(Kr,{className:"w-5 h-5"})," Delete Account"]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"bg-red-500/20 border border-red-500/30 rounded-lg p-3 text-xs text-red-200",children:[e.jsx("p",{className:"font-semibold mb-1",children:"âš ï¸ Warning"}),e.jsx("p",{children:"Deleting your account is permanent and cannot be undone. All your stats, achievements, and data will be erased."})]}),e.jsx("button",{onClick:()=>{window.confirm(`Are you absolutely sure you want to delete your account? This action cannot be undone.

All your stats, achievements, and data will be permanently erased.`)&&window.confirm("This is your final warning. Click OK to permanently delete your account.")&&window.dispatchEvent(new CustomEvent("ndn:delete-account"))},className:"w-full px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium transition-colors",children:"Permanently Delete Account ðŸ—‘ï¸"})]})]})})]})}),e.jsx("div",{className:"relative rounded-xl bg-white/5 backdrop-blur-md border border-white/10 p-1",children:e.jsx("div",{className:"flex items-center gap-2 overflow-x-auto no-scrollbar py-1 px-1",children:e.jsx(Nn,{label:"Camera Setup",icon:as,pill:"calibration",color:"from-purple-500 to-pink-500 shadow-purple-500/30"})})}),fn==="calibration"&&e.jsx("div",{"data-testid":"pill-calibration-content",className:"p-6 rounded-2xl border border-white/10 bg-white/[0.02] space-y-4",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx("div",{className:"card",children:e.jsxs("div",{className:"p-3 rounded-xl border border-blue-500/40 bg-blue-500/10",children:[e.jsxs("div",{className:"font-semibold mb-4 flex items-center gap-2",children:[e.jsx(as,{className:"w-5 h-5 text-blue-400"})," Camera & Vision"]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{type:"checkbox",id:"cameraEnabled",checked:ae,onChange:O=>Ft(O.target.checked),className:"w-4 h-4"}),e.jsx("label",{htmlFor:"cameraEnabled",className:"text-sm",children:"Enable camera"})]}),ae&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"pt-2 border-t border-white/10",children:[e.jsx("div",{className:"font-semibold mb-2 text-sm",children:"Lighting"}),e.jsxs("div",{className:"mt-3 flex flex-col gap-2",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{type:"checkbox",id:"cameraRecordDarts",checked:!!L,onChange:O=>Mt(O.target.checked),className:"w-4 h-4"}),e.jsx("label",{htmlFor:"cameraRecordDarts",className:"text-sm",children:"Save detection thumbnails (no continuous video)"})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{type:"checkbox",id:"cameraShowLabels",checked:!!V,onChange:O=>Et(O.target.checked),className:"w-4 h-4"}),e.jsx("label",{htmlFor:"cameraShowLabels",className:"text-sm",children:"Show segment labels (e.g., T20)"})]})]}),e.jsx("p",{className:"text-xs opacity-70 mt-1",children:"When enabled, small thumbnails of detections and commits are saved for review. This does not record continuous video or audio."}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{type:"checkbox",id:"harshLightingMode",checked:!!N,onChange:O=>$e(O.target.checked),className:"w-4 h-4"}),e.jsx("label",{htmlFor:"harshLightingMode",className:"text-sm",children:"Reduce glare (ring lights / harsh lighting)"})]}),e.jsx("p",{className:"text-xs opacity-70 mt-1",children:"Applies highlight compression for better dart detection and slightly dims the preview."}),e.jsxs("div",{className:"mt-3 flex items-center gap-3",children:[e.jsx("input",{type:"checkbox",id:"enhanceBigTrebles",checked:!!P,onChange:O=>jt(O.target.checked),className:"w-4 h-4"}),e.jsx("label",{htmlFor:"enhanceBigTrebles",className:"text-sm",children:"Enhance big trebles (T20/T19/T18)"})]}),e.jsx("p",{className:"text-xs opacity-70 mt-1",children:"Visual aid only. Briefly enlarges/highlights the treble segment when detected."})]}),e.jsxs("div",{children:[e.jsxs("label",{htmlFor:"cameraScale",className:"block text-sm mb-2",children:["Scale: ",m?.toFixed(2)]}),e.jsx("input",{type:"range",id:"cameraScale",min:"0.5",max:"3",step:"0.1",value:m||1,onChange:O=>He(parseFloat(O.target.value)),className:"w-full"})]}),e.jsxs("div",{className:"mt-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{type:"checkbox",id:"cameraLowLatency",checked:!!fe,onChange:O=>Qt(O.target.checked),className:"w-4 h-4"}),e.jsx("label",{htmlFor:"cameraLowLatency",className:"text-sm",children:"Low-latency camera (prefer 720p & lower CPU)"})]}),e.jsx("p",{className:"text-xs opacity-70 mt-1",children:"Reduces preview resolution and throttles detection to improve responsiveness on slower devices."}),e.jsxs("div",{className:"mt-2",children:[e.jsx("label",{className:"text-sm block mb-1",children:"Detection FPS"}),e.jsxs("select",{value:Be,onChange:O=>vn(Number(O.target.value)),className:"input w-full",children:[e.jsx("option",{value:10,children:"10 fps (very low)"}),e.jsx("option",{value:15,children:"15 fps (balanced)"}),e.jsx("option",{value:20,children:"20 fps (smooth)"}),e.jsx("option",{value:30,children:"30 fps (high)"})]}),e.jsx("p",{className:"text-xs opacity-70 mt-1",children:"Lower FPS reduces CPU usage and improves stability on laggy feeds."})]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"cameraAspect",className:"block text-sm mb-2",children:"Aspect Ratio"}),e.jsxs("select",{onPointerDown:O=>{O.stopPropagation()},onMouseDown:O=>{O.stopPropagation()},onTouchStart:O=>{O.stopPropagation?.()},id:"cameraAspect",value:A||"wide",onChange:O=>Qe(O.target.value),className:"input w-full",children:[e.jsx("option",{value:"wide",children:"Wide (16:9)"}),e.jsx("option",{value:"square",children:"Square (1:1)"})]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"cameraFitMode",className:"block text-sm mb-2",children:"Fit Mode"}),e.jsxs("select",{onPointerDown:O=>{O.stopPropagation()},onMouseDown:O=>{O.stopPropagation()},onTouchStart:O=>{O.stopPropagation?.()},id:"cameraFitMode",value:k||"fit",onChange:O=>tt(O.target.value),className:"input w-full",children:[e.jsx("option",{value:"fill",children:"Fill (crop)"}),e.jsx("option",{value:"fit",children:"Fit (letterbox)"})]})]}),e.jsx("button",{onClick:()=>{},className:"btn bg-indigo-600 hover:bg-indigo-700 w-full",children:"Calibration Guide ðŸ“–"}),e.jsxs("div",{className:"flex items-center gap-3 mt-3",children:[e.jsx("input",{type:"checkbox",id:"preserveOverlaySize",checked:ht,onChange:O=>_e(O.target.checked),className:"w-4 h-4"}),e.jsx("label",{htmlFor:"preserveOverlaySize",className:"text-sm",children:"Preserve overlay display size when locking calibration"})]}),e.jsxs("div",{className:"flex items-center gap-3 mt-3",children:[e.jsx("input",{type:"checkbox",id:"preserveCalOnCamChange",checked:!!Te,onChange:O=>Ge(O.target.checked),className:"w-4 h-4"}),e.jsx("label",{htmlFor:"preserveCalOnCamChange",className:"text-sm",children:"Preserve calibration when switching camera devices"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"autoscoreProvider",className:"block text-sm mb-2",children:"Auto-score Provider"}),e.jsxs("select",{onPointerDown:O=>{O.stopPropagation()},onMouseDown:O=>{O.stopPropagation()},onTouchStart:O=>{O.stopPropagation?.()},id:"autoscoreProvider",value:S||"manual",onChange:O=>pt(O.target.value),className:"input w-full",children:[e.jsx("option",{value:"manual",children:"Manual Scoring"}),e.jsx("option",{value:"built-in",children:"Built-in Vision"}),e.jsx("option",{value:"built-in-v2",children:"Built-in Vision (v2)"}),e.jsx("option",{value:"external-ws",children:"External (WebSocket)"})]})]}),S==="external-ws"&&e.jsx("input",{type:"text",placeholder:"WebSocket URL",value:x||"",onChange:O=>st(O.target.value),className:"input w-full text-xs"}),S!=="manual"&&e.jsxs("div",{children:[e.jsx("label",{htmlFor:"autoCommitMode",className:"block text-sm mb-2",children:"Turn Advance"}),e.jsxs("select",{onPointerDown:O=>{O.stopPropagation()},onMouseDown:O=>{O.stopPropagation()},onTouchStart:O=>{O.stopPropagation?.()},id:"autoCommitMode",value:w||"wait-for-clear",onChange:O=>E(O.target.value),className:"input w-full",children:[e.jsx("option",{value:"wait-for-clear",children:"Wait for darts to be removed"}),e.jsx("option",{value:"immediate",children:"Advance immediately after 3 darts/bust"})]}),e.jsx("p",{className:"text-xs opacity-70 mt-1",children:"Waiting prevents the turn from rotating until you clear the board (or 6.5s pass)."})]}),S!=="manual"&&e.jsxs("div",{className:"pt-2 border-t border-white/10",children:[e.jsx("div",{className:"font-semibold mb-2 text-sm",children:"Auto-score quality"}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{type:"checkbox",id:"confirmUncertainDarts",checked:C??!0,onChange:O=>J(O.target.checked),className:"w-4 h-4"}),e.jsx("label",{htmlFor:"confirmUncertainDarts",className:"text-sm",children:"Confirm uncertain darts"})]}),e.jsx("p",{className:"text-xs opacity-70 mt-1",children:"If the system isnâ€™t confident enough, itâ€™ll pause and ask you to accept/reject (Omni/Scolia-style)."}),e.jsxs("div",{className:"mt-3",children:[e.jsxs("label",{htmlFor:"autoScoreConfidenceThreshold",className:"block text-sm mb-2",children:["Confidence threshold:"," ",($??.85).toFixed(2)]}),e.jsx("input",{type:"range",id:"autoScoreConfidenceThreshold",min:"0.5",max:"0.99",step:"0.01",value:$??.85,onChange:O=>z(parseFloat(O.target.value)),className:"w-full"}),e.jsx("p",{className:"text-xs opacity-70 mt-1",children:"Higher = fewer confirmations, but higher risk of accepting a wrong hit."})]}),e.jsxs("details",{className:"mt-4",children:[e.jsx("summary",{className:"text-sm cursor-pointer select-none opacity-90",children:"Advanced detector tuning"}),e.jsxs("div",{className:"mt-3 space-y-3",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm mb-2",children:["Min blob area:"," ",j??30]}),e.jsx("input",{type:"range",min:"5",max:"200",step:"1",value:j??30,onChange:O=>oe(parseInt(O.target.value,10)),className:"w-full"}),e.jsx("p",{className:"text-xs opacity-70 mt-1",children:"Lower = more sensitive (can increase false positives)."})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm mb-2",children:["Foreground threshold:"," ",T??15]}),e.jsx("input",{type:"range",min:"5",max:"40",step:"1",value:T??15,onChange:O=>je(parseInt(O.target.value,10)),className:"w-full"}),e.jsx("p",{className:"text-xs opacity-70 mt-1",children:"Lower = more motion counts as a dart."})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm mb-2",children:["Stable frames required:"," ",M??2]}),e.jsx("input",{type:"range",min:"1",max:"6",step:"1",value:M??2,onChange:O=>se(parseInt(O.target.value,10)),className:"w-full"}),e.jsx("p",{className:"text-xs opacity-70 mt-1",children:"Higher = fewer false triggers, but slower."})]})]})]})]})]})]})]})}),e.jsx("div",{className:"card",children:e.jsxs("div",{className:"p-3 rounded-xl border border-purple-500/40 bg-purple-500/10",children:[e.jsxs("div",{className:"font-semibold mb-4 flex items-center gap-2",children:[e.jsx(Nc,{className:"w-5 h-5 text-purple-400"})," Audio & Voice"]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{type:"checkbox",id:"callerEnabled",checked:r,onChange:O=>ne(O.target.checked),className:"w-4 h-4"}),e.jsx("label",{htmlFor:"callerEnabled",className:"text-sm",children:"Enable voice caller"})]}),r&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"callerVoice",className:"block text-sm mb-2",children:"Voice"}),e.jsxs("select",{onPointerDown:O=>{O.stopPropagation()},onMouseDown:O=>{O.stopPropagation()},onTouchStart:O=>{O.stopPropagation?.()},id:"callerVoice",value:s||"",onChange:O=>Ae(O.target.value),className:"input w-full text-xs",children:[e.jsx("option",{value:"",children:"Default"}),hn.map((O,De)=>e.jsx("option",{value:O.voiceURI,children:O.name},De))]})]}),e.jsxs("div",{children:[e.jsxs("label",{htmlFor:"callerVolume",className:"block text-sm mb-2",children:["Volume: ",Math.round((a||1)*100),"%"]}),e.jsx("input",{type:"range",id:"callerVolume",min:"0",max:"1",step:"0.1",value:a||1,onChange:O=>ce(parseFloat(O.target.value)),className:"w-full"})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{type:"checkbox",id:"speakCheckoutOnly",checked:o,onChange:O=>H(O.target.checked),className:"w-4 h-4"}),e.jsx("label",{htmlFor:"speakCheckoutOnly",className:"text-sm",children:"Only speak checkout scores"})]}),e.jsx("button",{onClick:()=>{const O=new SpeechSynthesisUtterance("One hundred and eighty!");if(s){const De=window.speechSynthesis.getVoices().find(dt=>dt.voiceURI===s);De&&(O.voice=De)}O.volume=a||1,window.speechSynthesis.speak(O)},className:"btn bg-purple-600 hover:bg-purple-700 w-full text-sm",children:"Test Voice ðŸ”Š"})]})]})]})})]})}),e.jsx("div",{className:"relative rounded-xl bg-white/5 backdrop-blur-md border border-white/10 p-1",children:e.jsx("div",{className:"flex items-center gap-2 overflow-x-auto no-scrollbar py-1 px-1",children:e.jsx(Nn,{label:"Settings",icon:ss,pill:"settings",color:"from-cyan-500 to-blue-500 shadow-cyan-500/30"})})}),fn==="settings"&&e.jsxs("div",{"data-testid":"pill-settings-content",className:"space-y-4",children:[e.jsx("div",{className:"card",children:e.jsxs("div",{className:"p-3 rounded-xl border border-indigo-500/40 bg-indigo-500/10",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{className:"font-semibold flex items-center gap-2",children:[e.jsx(Ls,{className:"w-5 h-5 text-brand-400"})," Profile Bio ðŸ‘¤"]}),Bn?e.jsxs("button",{onClick:It,className:"flex items-center gap-2 px-3 py-1 bg-green-500/20 hover:bg-green-500/30 rounded-lg text-green-400 text-sm transition-colors",children:[e.jsx(Sc,{className:"w-4 h-4"})," Save ðŸ’¾"]}):e.jsxs("button",{onClick:()=>et(!0),className:"flex items-center gap-2 px-3 py-1 bg-blue-500/20 hover:bg-blue-500/30 rounded-lg text-blue-400 text-sm transition-colors",children:[e.jsx(jc,{className:"w-4 h-4"})," Edit âœï¸"]})]}),e.jsx("div",{className:"space-y-3",children:Bn?e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm mb-1",children:"Favorite Player ðŸ‘¤"}),e.jsx("input",{type:"text",value:In,onChange:O=>Wt(O.target.value),className:"input w-full"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm mb-1",children:"Favorite Team ðŸ›¡ï¸"}),e.jsx("input",{type:"text",value:yn,onChange:O=>wn(O.target.value),className:"input w-full"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm mb-1",children:"Favorite Darts ðŸŽ¯"}),e.jsx("input",{type:"text",value:mn,onChange:O=>rn(O.target.value),className:"input w-full"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm mb-1",children:"Bio / Quote ðŸ’¬"}),e.jsx("textarea",{value:zt,onChange:O=>tr(O.target.value),rows:3,className:"input w-full"})]})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:["Favorite Player:"," ",e.jsxs("span",{className:"text-brand-300",children:[In||"Not set"," ðŸ‘¤"]})]}),e.jsxs("div",{children:["Favorite Team:"," ",e.jsxs("span",{className:"text-brand-300",children:[yn||"Not set"," ðŸ›¡ï¸"]})]}),e.jsxs("div",{children:["Favorite Darts:"," ",e.jsxs("span",{className:"text-brand-300",children:[mn||"Not set"," ðŸŽ¯"]})]}),e.jsxs("div",{children:["Bio:"," ",e.jsxs("span",{className:"text-brand-300",children:[zt||"No bio set"," ðŸ’¬"]})]})]})})]})}),e.jsx("div",{className:"card",children:e.jsxs("div",{className:"p-3 rounded-xl border border-green-500/40 bg-green-500/10",children:[e.jsxs("div",{className:"font-semibold mb-4 flex items-center gap-2",children:[e.jsx(ei,{className:"w-5 h-5 text-green-400"})," Game Preferences ï¿½"]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{type:"checkbox",id:"dartTimerEnabled",checked:!!at,onChange:O=>Z(O.target.checked),className:"w-4 h-4"}),e.jsx("label",{htmlFor:"dartTimerEnabled",className:"text-sm",children:"Enable per-dart throw timer â±ï¸"})]}),at&&e.jsxs("div",{children:[e.jsxs("label",{className:"block mb-2 text-sm font-medium",children:["Time per throw:"," ",p?Math.round(p):0,"s"]}),e.jsx("input",{type:"range",min:"3",max:"30",value:p||10,onChange:O=>ye(parseInt(O.target.value)),className:"w-full"}),e.jsx("div",{className:"text-xs opacity-70 mt-1",children:"When the timer reaches zero, the dart is recorded as a miss and advances to the next throw."})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"favoriteDouble",className:"block text-sm mb-2",children:"Favorite Finish Double"}),e.jsxs("select",{onPointerDown:O=>{O.stopPropagation()},onMouseDown:O=>{O.stopPropagation()},id:"favoriteDouble",value:n,onChange:O=>Pe(O.target.value),className:"input w-full",children:[e.jsx("option",{value:"any",children:"Any Double"}),e.jsx("option",{value:"D20",children:"Double 20"}),e.jsx("option",{value:"D10",children:"Double 10"}),e.jsx("option",{value:"D5",children:"Double 5"}),e.jsx("option",{value:"D1",children:"Double 1"})]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"avgMode",className:"block text-sm mb-2",children:"Average Display Mode"}),e.jsxs("select",{id:"avgMode",value:c,onChange:O=>I(O.target.value),className:"input w-full",children:[e.jsx("option",{value:"all-time",children:"All Time Average"}),e.jsx("option",{value:"24h",children:"30 Day Average"})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{type:"checkbox",id:"x01DoubleIn",checked:!!Ze,onChange:O=>Fe(O.target.checked),className:"w-4 h-4"}),e.jsx("label",{htmlFor:"x01DoubleIn",className:"text-sm",children:"Require Double-In for X01"})]})]})]})}),e.jsx("div",{className:"card",children:e.jsxs("div",{className:"p-3 rounded-xl border border-pink-500/40 bg-pink-500/10",children:[e.jsxs("div",{className:"font-semibold mb-4 flex items-center gap-2",children:[e.jsx(xa,{className:"w-5 h-5 text-pink-400"})," UI & Accessibility ðŸ‘ï¸"]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{type:"checkbox",id:"autoStartOffline",checked:l,onChange:O=>B(O.target.checked),className:"w-4 h-4"}),e.jsx("label",{htmlFor:"autoStartOffline",className:"text-sm",children:"Auto-start offline games ðŸš€"})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{type:"checkbox",id:"rememberLastOffline",checked:b,onChange:O=>de(O.target.checked),className:"w-4 h-4"}),e.jsx("label",{htmlFor:"rememberLastOffline",className:"text-sm",children:"Remember last offline game settings ðŸ’¾"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"offlineLayout",className:"block text-sm mb-2",children:"Offline Layout"}),e.jsxs("select",{id:"offlineLayout",value:q||"classic",onChange:O=>ct(O.target.value),className:"input w-full",children:[e.jsx("option",{value:"classic",children:"Classic Layout"}),e.jsx("option",{value:"modern",children:"Modern Layout"})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{type:"checkbox",id:"reducedMotion",checked:u,onChange:O=>K(O.target.checked),className:"w-4 h-4"}),e.jsx("label",{htmlFor:"reducedMotion",className:"text-sm",children:"Reduce motion/animations"})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{type:"checkbox",id:"compactHeader",checked:f,onChange:O=>le(O.target.checked),className:"w-4 h-4"}),e.jsx("label",{htmlFor:"compactHeader",className:"text-sm",children:"Compact header"})]})]})]})}),e.jsx("div",{className:"card",children:e.jsxs("div",{className:"p-3 rounded-xl border border-yellow-500/30 bg-yellow-500/6",children:[e.jsxs("div",{className:"font-semibold mb-4 flex items-center gap-2",children:[e.jsx(ss,{className:"w-5 h-5 text-yellow-400"})," Theme ï¿½"]}),e.jsx("div",{children:e.jsx(Wo,{})})]})}),e.jsx("div",{className:"card",children:e.jsxs("div",{className:"p-3 rounded-xl border border-blue-500/40 bg-blue-500/10",children:[e.jsxs("div",{className:"font-semibold mb-4 flex items-center gap-2",children:[e.jsx(va,{className:"w-5 h-5 text-blue-400"})," Support & Help ï¿½"]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-sm opacity-80",children:"Need help? Contact us via email:"}),e.jsx("a",{href:"mailto:support@ninedartnation.com",className:"btn bg-blue-600 hover:bg-blue-700 w-full text-xs",children:"Email Support ðŸ“§"})]})]})}),e.jsx("div",{className:"card",children:e.jsxs("div",{className:"p-3 rounded-xl border border-cyan-500/40 bg-cyan-500/10",children:[e.jsxs("div",{className:"font-semibold mb-4 flex items-center gap-2",children:[e.jsx(Tn,{className:"w-5 h-5 text-cyan-400"})," Help Assistant ðŸ¤–"]}),e.jsx("div",{className:"space-y-3 max-h-96 overflow-y-auto",children:lt.map((O,De)=>e.jsx("div",{className:`${O.isUser?"text-right":""}`,children:e.jsx("div",{className:`inline-block max-w-xs px-3 py-2 rounded-lg text-sm ${O.isUser?"bg-indigo-600 text-white":"bg-white/10 text-slate-100"}`,children:typeof O.text=="string"?O.text:e.jsxs(e.Fragment,{children:[e.jsx("div",{children:O.text.text}),O.text.links&&e.jsx("div",{className:"mt-2 space-y-1",children:O.text.links.map((dt,ln)=>e.jsx("button",{onClick:()=>Ot(dt.tab),className:"block w-full text-left text-xs px-2 py-1 bg-white/20 hover:bg-white/30 rounded transition",children:dt.text},ln))})]})})},De))}),e.jsxs("div",{className:"flex gap-2 mt-3",children:[e.jsx("input",{type:"text",value:vt,onChange:O=>en(O.target.value),onKeyPress:O=>O.key==="Enter"&&An(),placeholder:"Ask me anything...",className:"flex-1 input"}),e.jsx("button",{onClick:An,className:"btn bg-blue-600 hover:bg-blue-700",children:e.jsx(Ra,{className:"w-4 h-4"})})]})]})})]}),e.jsx("div",{className:"card",children:e.jsxs("div",{className:"p-3 rounded-xl border border-yellow-500/40 bg-yellow-500/10",children:[e.jsxs("div",{className:"font-semibold mb-4 flex items-center gap-2",children:[e.jsx(va,{className:"w-5 h-5 text-yellow-400"})," Achievements & Badges ï¿½"]}),e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-2",children:Yt.map(O=>e.jsxs("div",{className:`p-3 rounded-lg border ${O.unlocked?"border-yellow-500/40 bg-yellow-500/10":"border-white/10 bg-white/5"}`,title:O.desc,children:[e.jsx("div",{className:"text-lg",children:O.icon}),e.jsx("div",{className:"text-xs font-semibold mt-1",children:O.label}),e.jsx("div",{className:"text-[10px] opacity-70",children:O.unlocked?"âœ“ Unlocked":"Locked"})]},O.key))})]})})]})}function nm({onAuth:t}){const[n,r]=i.useState("signin"),[s,a]=i.useState(""),[o,c]=i.useState(""),[l,b]=i.useState(""),[u,f]=i.useState(""),[g,m]=i.useState(""),[A,k]=i.useState(!1),[S,x]=i.useState(!1),w=Ri(),C=async(N,P={},L=6e4)=>{const V=new AbortController,U=window.setTimeout(()=>V.abort(),L);try{return await fetch(N,{...P,signal:V.signal})}finally{window.clearTimeout(U)}};async function $(N){N.preventDefault(),m(""),x(!0);try{un(()=>import("./Home-CDvKPAND.js"),__vite__mapDeps([0,1,2,3])),un(()=>import("./OnlinePlay.clean-BQQoK3el.js"),__vite__mapDeps([4,1,2,5])),un(()=>import("./OfflinePlay-BeFzG4SF.js"),__vite__mapDeps([6,1,2,7,3])),un(()=>import("./Scoreboard-Dtydx77g.js"),__vite__mapDeps([8,3,7,1,2])),un(()=>import("./StatsPanel-CTb8ZBr4.js"),__vite__mapDeps([9,3,1,2]))}catch{}if(!o||!l){m("Username and password required."),x(!1);return}try{console.time("Auth:signIn roundtrip");const P=await C(`${w}/api/auth/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o.includes("@")?{email:o,password:l}:{username:o,password:l})}),L=await P.json().catch(()=>({}));console.timeEnd("Auth:signIn roundtrip"),P.status===429?m("Too many login attempts. Please wait 60 seconds and try again."):P.ok&&L?.user&&L?.token?(localStorage.setItem("authToken",L.token),t(L.user)):m(L?.error||"Invalid username or password.")}catch(P){console.error("Login error:",P),console.log("Attempting to connect to:",`${w}/api/auth/login`),P?.name==="AbortError"?m(`Login timed out after 60 seconds. Server: ${w}. Please check if your server is running and accessible.`):m(`Network error: ${P?.message||"Unknown error"}. Server: ${w}. Please check your connection and try again.`)}finally{x(!1)}}async function j(N){if(N.preventDefault(),m(""),x(!0),!s||!o||!l){m("Email, username, and password required."),x(!1);return}try{const P=await C(`${w}/api/auth/signup`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:s,username:o,password:l})}),L=await P.json().catch(()=>({}));P.ok&&L?.user&&L?.token?(localStorage.setItem("authToken",L.token),t(L.user)):m(L?.error||"Signup failed.")}catch(P){P?.name==="AbortError"?m("Signup timed out. Please try again."):m("Network error.")}finally{x(!1)}}async function T(N){if(N.preventDefault(),m(""),x(!0),!s||!s.includes("@")){m("Enter your email address."),x(!1);return}try{const L=await(await C(`${w}/api/auth/send-reset`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:s})})).json().catch(()=>({}));if(!L?.ok)throw new Error(L?.error||"Failed to send reset email");m("Password reset link sent to your email.")}catch(P){m(P?.message||"Failed to send reset email")}finally{x(!1)}}async function M(N){if(N.preventDefault(),m(""),x(!0),!s||!s.includes("@")){m("Enter your email address."),x(!1);return}try{const L=await(await C(`${w}/api/auth/send-username`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:s})})).json().catch(()=>({}));if(!L?.ok)throw new Error(L?.error||"Failed to send username email");m("Your username has been emailed to you.")}catch(P){m(P?.message||"Failed to send username email")}finally{x(!1)}}return e.jsxs("div",{className:"min-h-screen flex items-center justify-center bg-[#0F0C1D] p-4 relative overflow-hidden",children:[e.jsxs("div",{className:"absolute top-0 left-0 w-full h-full overflow-hidden pointer-events-none",children:[e.jsx("div",{className:"absolute -top-[10%] -left-[10%] w-[40%] h-[40%] bg-indigo-500/10 blur-[120px] rounded-full"}),e.jsx("div",{className:"absolute -bottom-[10%] -right-[10%] w-[40%] h-[40%] bg-purple-500/10 blur-[120px] rounded-full"})]}),e.jsxs("div",{className:"w-full max-w-md relative z-10",children:[e.jsxs("div",{className:"text-center mb-8",children:[e.jsx("h1",{className:"text-4xl font-black text-transparent bg-clip-text bg-gradient-to-r from-white via-white to-white/40 tracking-tighter mb-2",children:"NINE-DART-NATION ðŸŽ¯"}),e.jsx("p",{className:"text-white/40 font-medium uppercase tracking-[0.3em] text-xs",children:n==="signin"?"Sign In ðŸ”‘":n==="signup"?"Create Account âœ¨":"Reset Password ðŸ”„"})]}),e.jsx("div",{className:"flex items-center justify-center gap-3 mb-6",children:[{key:"signin",label:"Sign In"},{key:"signup",label:"Sign Up"},{key:"reset",label:"Reset"}].map(N=>e.jsx("button",{type:"button",onClick:()=>r(N.key),className:`px-4 py-1.5 rounded-full text-xs font-bold tracking-wide transition-all ${n===N.key?"bg-white text-indigo-600":"bg-white/5 text-white/70 hover:bg-white/10"}`,children:N.label},N.key))}),e.jsx("div",{className:"bg-white/[0.03] border border-white/10 backdrop-blur-xl rounded-[2.5rem] p-8 shadow-2xl",children:e.jsxs("form",{className:"space-y-4",onSubmit:n==="signin"?$:n==="signup"?j:T,children:[(n==="signup"||n==="reset")&&e.jsx("input",{className:"input w-full",type:"email",placeholder:"Email",value:s,onChange:N=>a(N.target.value),autoComplete:"email",required:!0}),n!=="reset"&&e.jsx("input",{className:"input w-full",type:"text",placeholder:"Username or Email",value:o,onChange:N=>c(N.target.value),autoComplete:"username",required:!0}),n!=="reset"&&e.jsxs("div",{className:"relative",children:[e.jsx("input",{className:"input w-full pr-10",type:A?"text":"password",placeholder:"Password",value:l,onChange:N=>b(N.target.value),autoComplete:"current-password",required:!0,onFocus:()=>k(!1),onBlur:()=>k(!1)}),e.jsx("button",{type:"button",className:"absolute right-2 top-1/2 -translate-y-1/2 text-slate-300 hover:text-white",tabIndex:-1,onMouseDown:N=>{N.preventDefault(),k(!0)},onMouseUp:N=>{N.preventDefault(),k(!1)},onMouseLeave:()=>k(!1),onTouchStart:N=>{N.preventDefault(),k(!0)},onTouchEnd:N=>{N.preventDefault(),k(!1)},"aria-label":"Toggle password visibility",children:A?e.jsx(kc,{className:"w-5 h-5"}):e.jsx(xa,{className:"w-5 h-5"})})]}),n==="signup"&&e.jsx("input",{className:"input w-full",type:"text",placeholder:"Password Reminder (optional)",value:u,onChange:N=>f(N.target.value),autoComplete:"off"}),g&&e.jsx("div",{className:"text-red-400 font-semibold text-sm",children:g}),e.jsx("button",{type:"submit",disabled:S,className:"w-full py-4 rounded-2xl bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-bold shadow-lg shadow-indigo-500/20 hover:scale-[1.02] active:scale-[0.98] transition-all disabled:opacity-50 disabled:hover:scale-100",children:S?e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("div",{className:"w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"}),"Processing..."]}):n==="signin"?"Sign In ðŸ”‘":n==="signup"?"Sign Up âœ¨":"Send Reset Link ðŸ“§"}),n==="signin"&&e.jsxs(e.Fragment,{children:[e.jsx("button",{type:"button",onClick:M,className:"w-full py-2 text-xs font-bold text-white/30 hover:text-white/60 transition-colors",children:"Email me my username ðŸ“§"}),e.jsx("button",{type:"button",onClick:()=>{localStorage.clear(),m("Cache cleared. Please try logging in again.")},className:"w-full py-2 text-xs font-bold text-white/20 hover:text-white/40 transition-colors",children:"Clear cache & retry ðŸ”„"}),e.jsx("button",{type:"button",onClick:async()=>{m(""),x(!0);try{console.log("Testing connection to:",`${w}/api/health`);const N=await C(`${w}/api/health`,{method:"GET"},1e4);N.ok?m(`âœ… Server is reachable at ${w}`):m(`âš ï¸ Server responded with status ${N.status} at ${w}`)}catch(N){m(`âŒ Cannot reach server at ${w}. Error: ${N?.message||"Unknown"}. Please check if your server is running.`)}finally{x(!1)}},className:"w-full py-2 text-xs font-bold text-white/20 hover:text-white/40 transition-colors",children:"Test server connection ðŸ”Œ"})]})]})}),e.jsx("div",{className:"mt-12 grid grid-cols-1 gap-4",children:e.jsxs("div",{className:"p-6 rounded-3xl bg-white/[0.02] border border-white/5",children:[e.jsx("h3",{className:"text-xl font-bold mb-3 text-white/90",children:"What's inside ðŸ“¦"}),e.jsxs("ul",{className:"space-y-3",children:[e.jsxs("li",{className:"flex items-start gap-3",children:[e.jsx($s,{className:"w-5 h-5 text-indigo-300 mt-1"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold",children:"Online & Friends"}),e.jsx("div",{className:"text-sm text-slate-200/90",children:"Challenge friends, chat, and join leagues."})]})]}),e.jsxs("li",{className:"flex items-start gap-3",children:[e.jsx(Ec,{className:"w-5 h-5 text-indigo-300 mt-1"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold",children:"Deep Stats"}),e.jsx("div",{className:"text-sm text-slate-200/90",children:"Track 3-dart averages, best legs, and more."})]})]}),e.jsxs("li",{className:"flex items-start gap-3",children:[e.jsx(dr,{className:"w-5 h-5 text-indigo-300 mt-1"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold",children:"Game Modes"}),e.jsx("div",{className:"text-sm text-slate-200/90",children:"Start with 3 free online games upon signup. After that, PREMIUM is required to play all games."})]})]}),e.jsxs("li",{className:"flex items-start gap-3",children:[e.jsx(Tc,{className:"w-5 h-5 text-indigo-300 mt-1"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold",children:"Premium Perks"}),e.jsx("div",{className:"text-sm text-slate-200/90",children:"Polished UI, upcoming features, and early access."})]})]}),e.jsxs("li",{className:"flex items-start gap-3",children:[e.jsx(Tn,{className:"w-5 h-5 text-indigo-300 mt-1"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold",children:"Live Support"}),e.jsx("div",{className:"text-sm text-slate-200/90",children:"Chat with moderators whenever you need a hand."})]})]})]})]})})]})]})}const zo=Xu;function rm(){const[t,n]=i.useState(!1),[r,s]=i.useState([{text:"Hi! I'm your Nine Dart Nation assistant. How can I help you today?",isUser:!1}]),[a,o]=i.useState(""),[c,l]=i.useState(!1),[b,u]=i.useState(""),[f,g]=i.useState(null),m=(()=>{try{return Cr()}catch{return null}})();i.useEffect(()=>{if(!m)return;const x=m.addListener(w=>{try{w?.type==="help-message"&&f&&(String(w.requestId),String(f.id)),w?.type==="help-request-updated"&&f&&w.request?.id===f.id&&g(w.request)}catch{}});return()=>x()},[m,f]);const A=x=>{try{window.dispatchEvent(new CustomEvent("ndn:change-tab",{detail:{tab:x}})),n(!1)}catch(w){console.error("Navigation failed:",w)}},k=x=>{const w=x.toLowerCase();return w.includes("username")||w.includes("change name")?{text:"You can change your username once for free.",links:[{text:"Go to Settings > Account",tab:"settings"}]}:w.includes("premium")||w.includes("upgrade")||w.includes("subscription")?{text:"Premium unlocks all game modes and features.",links:[{text:"Go to Online Play",tab:"online"}]}:w.includes("calibrat")||w.includes("camera")||w.includes("vision")?{text:"Set up your camera properly in Settings.",links:[{text:"Go to Settings > Camera & Vision",tab:"settings"}]}:w.includes("voice")||w.includes("caller")||w.includes("audio")?{text:"Enable voice calling in Settings.",links:[{text:"Go to Settings > Audio & Voice",tab:"settings"}]}:w.includes("friend")||w.includes("play together")?{text:"Add friends to play together.",links:[{text:"Go to Friends",tab:"friends"}]}:w.includes("stat")||w.includes("score")||w.includes("performance")?{text:"View your statistics and performance.",links:[{text:"Go to Stats",tab:"stats"}]}:w.includes("setting")||w.includes("customiz")||w.includes("configur")?{text:"Customize your experience.",links:[{text:"Go to Settings",tab:"settings"}]}:w.includes("tournament")||w.includes("competition")?{text:"Check out tournaments and competitions.",links:[{text:"Go to Tournaments",tab:"tournaments"}]}:w.includes("score")||w.includes("scoring")||w.includes("autoscore")?{text:"Auto-scoring assigns darts to board segments automatically. You can review and adjust placements in the Match Summary screen.",links:[{text:"Go to Match Summary",tab:"matchsummary"}]}:w.includes("pair")||w.includes("pairing")||w.includes("phone")||w.includes("camera pairing")?{text:"Use the Pairing flow to connect phones and cameras. Make sure devices are on the same Wi-Fi and scan the QR code shown.",links:[{text:"Open Pairing",tab:"pairing"}]}:w.includes("highlight")||w.includes("download")||w.includes("save")?{text:"Highlights can be downloaded or saved to your account from the Highlights section. We keep a record when you hit milestone checkouts or visits.",links:[{text:"Open Highlights",tab:"highlights"}]}:w.includes("privacy")||w.includes("copyright")||w.includes("legal")?{text:"Our Legal Notice and Privacy information are available in the footer. You can view privacy, copyright, and contact details there.",links:[{text:"View Legal Notice",tab:"footer"}]}:w.includes("help")||w.includes("support")||w.includes("faq")?{text:"You're already in the help section! Check Settings for more resources.",links:[{text:"Go to Settings > Support",tab:"settings"}]}:w.includes("how to play")||w.includes("game")||w.includes("start")?{text:"To play darts, select a game mode from the menu. For online play, join a match. For offline, start a local game.",links:[{text:"Play Online",tab:"online"},{text:"Play Offline",tab:"offline"}]}:{text:"I'm not sure about that. Try asking about playing, calibration, premium, username changes, voice settings, friends, stats, or settings."}},S=()=>{if(!a.trim())return;const x=a.trim(),w=x.toLowerCase();if(s($=>[...$,{text:x,isUser:!0}]),o(""),c)if(w.startsWith("y")){s($=>[...$,{text:"Okay â€” I will notify an admin. Please wait for them to join the chat.",isUser:!1}]),l(!1),(async()=>{try{const T=await(await xn("/api/help/requests",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:b||x})})).json().catch(()=>null);T&&T.request?(g(T.request),s(M=>[...M,{text:"Okay â€” I will notify an admin. Please wait for them to join the chat.",isUser:!1}])):s(M=>[...M,{text:"Okay â€” I will notify an admin. Please wait for them to join the chat.",isUser:!1}])}catch{s(j=>[...j,{text:"Failed to contact admins. Please try again later.",isUser:!1}])}})();return}else{s($=>[...$,{text:"Okay â€” I won't notify an admin. If you change your mind, just ask.",isUser:!1}]),l(!1);return}const C=k(w);if(typeof C.text=="string"&&C.text.includes("I'm not sure about that")){u(x),l(!0),setTimeout(()=>{s($=>[...$,{text:{text:"I can connect you to a member of our admin team â€” would you like that? Type YES or NO.",links:[]},isUser:!1}])},350);return}setTimeout(()=>{s($=>[...$,{text:C,isUser:!1}])},500)};return e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>n(!0),className:"fixed bottom-4 right-4 z-50 bg-blue-600 hover:bg-blue-700 text-white p-4 rounded-full shadow-lg transition-colors",title:"Help Assistant",children:e.jsx(va,{className:"w-6 h-6"})}),t&&e.jsxs("div",{className:"fixed inset-0 z-50 flex items-end justify-end p-4",children:[e.jsx("div",{className:"absolute inset-0 bg-black/50",onClick:()=>n(!1)}),e.jsxs("div",{className:"relative bg-slate-800 rounded-lg shadow-xl w-full max-w-md h-96 flex flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 border-b border-slate-700",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Tn,{className:"w-5 h-5 text-blue-400"}),e.jsx("span",{className:"font-semibold",children:"Help Assistant"})]}),e.jsx("button",{onClick:()=>n(!1),className:"text-slate-400 hover:text-white",children:e.jsx(Pa,{className:"w-5 h-5"})})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-4 space-y-3",children:r.map((x,w)=>e.jsx("div",{className:`flex ${x.isUser?"justify-end":"justify-start"}`,children:e.jsx("div",{className:`max-w-xs px-3 py-2 rounded-lg ${x.isUser?"bg-blue-600 text-white":"bg-slate-700 text-slate-200"}`,children:typeof x.text=="string"?x.text:e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{children:x.text.text}),x.text.links&&e.jsx("div",{className:"space-y-1",children:x.text.links.map((C,$)=>e.jsx("button",{onClick:()=>A(C.tab),className:"block w-full text-left text-blue-300 hover:text-blue-200 underline text-sm",children:C.text},$))})]})})},w))}),e.jsx("div",{className:"p-4 border-t border-slate-700",children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{type:"text",value:a,onChange:x=>o(x.target.value),onKeyPress:x=>x.key==="Enter"&&S(),placeholder:"Ask me anything...",className:"flex-1 input"}),e.jsx("button",{onClick:S,className:"btn bg-blue-600 hover:bg-blue-700",children:e.jsx(Ra,{className:"w-4 h-4"})})]})})]})]}),f&&e.jsx(lc,{request:f,user:{email:null,username:null,isAdmin:!1},onClose:()=>g(null)})]})}function sm(){const t=er(),n=i.useRef({}),r=i.useRef({});return i.useEffect(()=>{function s(u="[GlobalCamera]"){try{const f=t.getVideoElementRef(),g=t.getMediaStream(),m=t.getPcRef&&t.getPcRef(),A=t.getWsRef&&t.getWsRef();nt(u,{isStreaming:t.isStreaming,mode:t.mode,showOverlay:t.showOverlay,hasVideoElement:!!f,video:f?{videoWidth:f.videoWidth,videoHeight:f.videoHeight,srcObject:!!f.srcObject}:null,mediaTracks:g?g.getTracks().map(k=>({kind:k.kind,enabled:k.enabled,id:k.id})):null,pcState:m?m.connectionState||m.iceConnectionState:null,wsState:A?A.readyState||"unknown":null})}catch(f){console.warn("[GlobalCamera] dumpState failed",f)}}s("[GlobalCamera] INIT");let a=!0;const o=setInterval(()=>{if(a)try{const u=t.getVideoElementRef(),f=t.getMediaStream(),g=t.getPcRef&&t.getPcRef(),m={isStreaming:t.isStreaming,mode:t.mode,hasVideo:!!u,videoW:u?u.videoWidth:0,videoH:u?u.videoHeight:0,tracks:f?f.getTracks().length:0,pcState:g?g.connectionState||g.iceConnectionState:null},A=n.current;(m.isStreaming!==A.isStreaming||m.hasVideo!==A.hasVideo||m.videoW!==A.videoW||m.videoH!==A.videoH||m.tracks!==A.tracks||m.pcState!==A.pcState||t.showOverlay!==A.showOverlay)&&(n.current=m,s("[GlobalCamera] CHANGE"))}catch(u){console.warn("[GlobalCamera] poll failed",u)}},750);function c(u){try{const f=r.current.video;if(f&&f.el===u)return;if(f&&f.el){try{f.el.removeEventListener("loadedmetadata",f.loadedmetadata)}catch{}try{f.el.removeEventListener("playing",f.playing)}catch{}try{f.el.removeEventListener("pause",f.pause)}catch{}try{f.el.removeEventListener("ended",f.ended)}catch{}}if(r.current.video=null,u){const g=()=>nt("[GlobalCamera] video loadedmetadata",{videoWidth:u.videoWidth,videoHeight:u.videoHeight}),m=()=>{nt("[GlobalCamera] video playing",{paused:u.paused})},A=()=>{nt("[GlobalCamera] video pause")},k=()=>{nt("[GlobalCamera] video ended")};u.addEventListener("loadedmetadata",g),u.addEventListener("playing",m),u.addEventListener("pause",A),u.addEventListener("ended",k),r.current.video={el:u,loadedmetadata:g,playing:m,pause:A,ended:k}}}catch(f){console.warn("[GlobalCamera] attachVideoListeners failed",f)}}function l(u){try{const f=r.current.pc;if(f&&f.pc===u)return;if(f&&f.pc)try{f.pc.removeEventListener("connectionstatechange",f.connChange)}catch{}if(r.current.pc=null,u){const g=()=>nt("[GlobalCamera] pc state change",{connectionState:u.connectionState,iceState:u.iceConnectionState});u.addEventListener("connectionstatechange",g),r.current.pc={pc:u,connChange:g}}}catch(f){console.warn("[GlobalCamera] attachPc failed",f)}}const b=setInterval(()=>{try{c(t.getVideoElementRef()),l(t.getPcRef&&t.getPcRef())}catch{}},1e3);return()=>{a=!1,clearInterval(o),clearInterval(b);try{const u=r.current.video;u&&u.el&&(u.el.removeEventListener("loadedmetadata",u.loadedmetadata),u.el.removeEventListener("playing",u.playing))}catch{}try{const u=r.current.pc;u&&u.pc&&u.pc.removeEventListener("connectionstatechange",u.connChange)}catch{}}},[t]),null}function am(){const t=er(),n=i.useRef(null),r=i.useRef(null),s=i.useRef(0),a=i.useRef(0),o=i.useRef(0),c=i.useRef(0);return i.useEffect(()=>{n.current&&t.setVideoElementRef(n.current)},[t]),i.useEffect(()=>{let l=!0;const b=async()=>{if(l)try{const f=t.getMediaStream(),g=n.current;if(!g||!f)return;(r.current!==f||g.srcObject!==f)&&(g.srcObject=f,r.current=f),g.muted=!0,g.playsInline=!0;try{await g.play()}catch{}}catch{}};b();const u=setInterval(b,750);return()=>{l=!1,clearInterval(u)}},[t]),i.useEffect(()=>{const b=setInterval(()=>{const u=n.current,f=Date.now();if(!u||!t.isStreaming||t.mode!=="phone"){a.current=0;return}if(!u.srcObject){const m=[3e3,6e3,1e4][Math.min(c.current,2)];if(f-o.current>=m){o.current=f,c.current=Math.min(c.current+1,3);try{window.dispatchEvent(new CustomEvent("ndn:phone-camera-reconnect",{detail:{reason:"missing-stream",ts:f}})),u.play().catch(()=>{})}catch{}}return}const g=u.currentTime||0;if(Number.isFinite(g))if(g===s.current?a.current+=1:a.current=0,s.current=g,a.current>=3){const m=[3e3,6e3,1e4][Math.min(c.current,2)];if(f-o.current>=m){o.current=f,c.current=Math.min(c.current+1,3);try{window.dispatchEvent(new CustomEvent("ndn:phone-camera-reconnect",{detail:{reason:"stall",ts:f}})),u.play().catch(()=>{})}catch{}}}else a.current===0&&(c.current=0)},1e3);return()=>clearInterval(b)},[t]),e.jsx("video",{ref:n,style:{position:"fixed",width:1,height:1,left:-9999,top:-9999,opacity:0},muted:!0,playsInline:!0,"aria-hidden":!0})}function uc(t){const n=er.getState(),r=ve.getState(),s=Date.now();r.preferredCameraLabel==="Phone Camera"||n.mode==="phone"?window.dispatchEvent(new CustomEvent("ndn:phone-camera-reconnect",{detail:{reason:t,ts:s}})):window.dispatchEvent(new Event("ndn:camera-reset"))}const Aa="ndn:camera-recovery";function om(t){window.dispatchEvent(new CustomEvent(Aa,{detail:t}))}function im(){const t=ve(f=>!!f.cameraEnabled),n=ve(f=>f.preferredCameraLabel),r=t,s=er(),a=i.useRef(-1),o=i.useRef(0),c=i.useRef(0),l=i.useRef(0),b=i.useRef(!1),u=i.useRef(null);return i.useEffect(()=>{if(!r)return;const f=S=>{const x=S*.15,w=(Math.random()*2-1)*x;return Math.max(500,Math.round(S+w))},g=S=>{const x=Date.now(),w=[2500,5e3,1e4,18e3,3e4][Math.min(l.current,4)],C=f(w);if(!(x-c.current<C)&&!b.current){b.current=!0,c.current=x,u.current=S,l.current=Math.min(l.current+1,5);try{uc(S),om({reason:S,ts:x})}catch{}window.setTimeout(()=>{b.current=!1},1500)}},m=()=>{try{const S=s.getMediaStream?.()||null;if(!(!!s.isStreaming||!!S)){o.current=0,a.current=-1,l.current=0,b.current=!1,u.current=null;return}const w=s.getVideoElementRef?.()||null;if(!w){o.current=0,a.current=-1,S&&g("watchdog-detached");return}if(S&&!w.srcObject)try{w.srcObject=S}catch{}try{const $=S?.getVideoTracks?.()||[];if(S&&$.length>0&&$.every(j=>j.readyState==="ended"||j.muted)){g("watchdog-ended-track");return}}catch{}try{if(w.paused&&(w.play?.().catch?.(()=>{}),o.current+=1,o.current>=6)){g("watchdog-paused");return}}catch{}const C=Number(w.currentTime||0);if(!Number.isFinite(C)||(a.current===C?o.current+=1:o.current=0,a.current=C,o.current<4))return;g("watchdog-stall")}catch{}},A=()=>{try{if(document.visibilityState==="visible"){const S=s.getVideoElementRef?.()||null;try{S?.play?.().catch?.(()=>{})}catch{}(s.isStreaming||s.getMediaStream?.())&&g("watchdog-visibility-resume")}}catch{}},k=window.setInterval(m,1e3);return document.addEventListener("visibilitychange",A),()=>{window.clearInterval(k),document.removeEventListener("visibilitychange",A)}},[r,n,s]),null}function cm(t){return t.includes("ended-track")?"Camera stream ended. Recoveringâ€¦":t.includes("paused")?"Camera paused. Recoveringâ€¦":t.includes("detached")?"Camera preview detached. Reconnectingâ€¦":t.includes("visibility")?"Welcome back. Refreshing cameraâ€¦":"Camera froze. Recoveringâ€¦"}function lm(){const t=Xa(),n=i.useRef(0);return i.useEffect(()=>{const r=s=>{const o=s.detail;if(!o?.ts)return;const c=Date.now();c-n.current<8e3||(n.current=c,t(cm(o.reason),{type:"info",actionLabel:"Retry now",onAction:()=>{try{uc("user-click")}catch{}}}))};return window.addEventListener(Aa,r),()=>{window.removeEventListener(Aa,r)}},[t]),null}const Ho={};function dm(){const[t,n]=i.useState(!1),r=Ho?.VITE_PLAY_STORE_URL||"",s=Ho?.VITE_APP_STORE_URL||"",a=i.useRef(null);i.useEffect(()=>{if(!t)return;const c=b=>{b.key==="Escape"&&n(!1)},l=b=>{const u=b.target;u&&(a.current&&a.current.contains(u)||n(!1))};return document.addEventListener("mousedown",l),document.addEventListener("touchstart",l),window.addEventListener("keydown",c),()=>{document.removeEventListener("mousedown",l),document.removeEventListener("touchstart",l),window.removeEventListener("keydown",c)}},[t]);async function o(){try{if(window.promptInstallApp){const c=await window.promptInstallApp()}else navigator?.standalone||"onappinstalled"in window?alert("App is already installed or your browser does not support programmatic install."):alert("Install is not available for your browser. Try using the share menu (iOS) or the install prompt (Chrome/Edge on Android).")}catch{}}return e.jsxs("div",{className:"relative inline-block",ref:a,children:[e.jsx("button",{className:"px-2 py-1 rounded-full border border-white/10 bg-white/5 hover:bg-white/10 text-sm text-white flex items-center gap-2",onClick:()=>n(c=>!c),title:"Install or download app",children:"Install"}),t&&e.jsxs("div",{role:"dialog","aria-modal":"true",className:"absolute right-0 mt-2 z-40 w-80 max-w-[calc(100vw-2rem)] rounded-3xl border border-white/15 bg-slate-900/95 p-5 text-white shadow-2xl",children:[e.jsx("button",{className:"absolute right-3 top-3 flex h-7 w-7 items-center justify-center rounded-full bg-rose-500 text-sm font-bold text-white shadow hover:bg-rose-400",onClick:()=>n(!1),"aria-label":"Close install picker",children:"Ã—"}),e.jsxs("div",{className:"pr-6",children:[e.jsx("div",{className:"text-lg font-semibold",children:"Install or Download"}),e.jsx("p",{className:"text-sm text-white/70",children:"Install the Progressive Web App or jump to the native stores when available."})]}),e.jsxs("div",{className:"mt-4 flex flex-col space-y-2",children:[e.jsx("button",{className:"btn",onClick:()=>o(),children:"Install (PWA)"}),r?e.jsx("a",{className:"btn",target:"_blank",rel:"noreferrer",href:r,children:"Android (Google Play)"}):e.jsx("div",{className:"text-xs opacity-80",children:"Android native build not provided"}),s?e.jsx("a",{className:"btn",target:"_blank",rel:"noreferrer",href:s,children:"iOS (App Store)"}):e.jsx("div",{className:"text-xs opacity-80",children:"iOS native build not provided"}),e.jsx("div",{className:"text-xs opacity-70",children:'iOS: Open Safari â†’ Share â†’ "Add to Home Screen" to pin this dashboard like a native app.'})]})]})]})}function um(){const[t,n]=i.useState(!1),[r,s]=i.useState(!1),a=i.useRef(null);i.useEffect(()=>{try{window.__NDN_DEFER_INSTALL_PROMPT__=!0;const c=l=>{l.preventDefault(),window.deferredInstallPrompt=l,n(!0)};return window.addEventListener("beforeinstallprompt",c),window.deferredInstallPrompt&&n(!0),()=>{window.removeEventListener("beforeinstallprompt",c);try{window.__NDN_DEFER_INSTALL_PROMPT__=!1}catch{}}}catch{}},[]);async function o(){try{if(window.promptInstallApp)await window.promptInstallApp()||s(!0);else if(window.deferredInstallPrompt){const c=window.deferredInstallPrompt;c.prompt();const l=await c.userChoice;l&&l.outcome==="accepted"?n(!1):s(!0)}else s(!0)}catch{s(!0)}}return i.useEffect(()=>{if(!r)return;const c=b=>{b.key==="Escape"&&s(!1)},l=b=>{const u=b.target;u&&(a.current&&a.current.contains(u)||s(!1))};return document.addEventListener("mousedown",l),document.addEventListener("touchstart",l),window.addEventListener("keydown",c),()=>{document.removeEventListener("mousedown",l),document.removeEventListener("touchstart",l),window.removeEventListener("keydown",c)}},[r]),e.jsxs("div",{className:"relative inline-block",ref:a,children:[e.jsx("button",{onClick:o,className:"px-2 py-1 rounded-full border border-white/10 bg-white/5 hover:bg-white/10 text-sm",title:"Add to Home Screen","data-available":t?"true":"false",children:"Add to Home Screen"}),r&&e.jsxs("div",{className:"absolute right-0 mt-2 z-40 w-80 max-w-[calc(100vw-2rem)] rounded-3xl border border-white/15 bg-slate-900/95 p-5 text-white shadow-2xl",children:[e.jsx("button",{className:"absolute right-3 top-3 flex h-7 w-7 items-center justify-center rounded-full bg-rose-500 text-sm font-bold text-white shadow hover:bg-rose-400",onClick:()=>s(!1),"aria-label":"Close add-to-home instructions",children:"Ã—"}),e.jsx("h3",{className:"text-lg font-semibold pr-6",children:"Add Nine Dart Nation to Home"}),e.jsx("p",{className:"mt-3 text-sm text-white/80 pr-4",children:mm()?'Open Safari, tap the share icon, then choose "Add to Home Screen".':'Open your browser menu (â‹® or â‹¯) and choose "Install app" or "Add to Home Screen".'}),e.jsx("p",{className:"mt-2 text-xs text-white/60 pr-4",children:"Installing the PWA keeps alerts, matches, and calibration controls a tap away."}),e.jsxs("div",{className:"mt-4 flex flex-wrap justify-end gap-2",children:[e.jsx("button",{className:"btn btn--ghost px-3 py-1 text-sm",onClick:()=>s(!1),children:"Close"}),e.jsx("button",{className:"btn px-3 py-1 text-sm",onClick:()=>s(!1),children:"Got it"})]})]})]})}function mm(){try{return/iphone|ipad|ipod/i.test(navigator.userAgent)}catch{return!1}}function hm({storageKey:t,children:n,className:r,defaultWidth:s=520,defaultHeight:a,minWidth:o=360,minHeight:c=200,maxWidth:l=1100,maxHeight:b=900,fullScreen:u=!1,initialFitHeight:f=!1,onClose:g}){const[m,A]=i.useState(()=>{if(!u){try{const N=localStorage.getItem(t);if(N)return JSON.parse(N)}catch{}return{width:s,height:a}}return{}}),k=i.useRef(null);i.useEffect(()=>{if(u)return;function N(){try{localStorage.removeItem(t)}catch{}if(f&&j.current?.parentElement){const P=j.current.parentElement,L=window.getComputedStyle(P),V=parseFloat(L.paddingTop||"0")||0,U=parseFloat(L.paddingBottom||"0")||0,te=Math.max(0,P.clientHeight-V-U),ie=Math.max(c,Math.min(b,Math.round(te)));A({width:s,height:ie});return}A({width:s,height:a})}return window.addEventListener("ndn:layout-reset",N),()=>window.removeEventListener("ndn:layout-reset",N)},[t,s,a,u]),i.useEffect(()=>{if(!u)try{localStorage.setItem(t,JSON.stringify(m))}catch{}},[m,t,u]),i.useEffect(()=>{if(u||!f)return;const N=j.current?.parentElement;if(!N)return;const P=window.getComputedStyle(N),L=parseFloat(P.paddingTop||"0")||0,V=parseFloat(P.paddingBottom||"0")||0,U=Math.max(0,N.clientHeight-L-V),te=Math.max(c,Math.min(b,Math.round(U)));try{const ie=localStorage.getItem(t);if(ie){const q=JSON.parse(ie)?.height||0;(!q||q<te)&&A(G=>({...G,height:te}));return}}catch{}A(ie=>({...ie,height:te}))},[f,u,t,c,b]);function S(N,P,L){return Math.max(P,Math.min(L,N))}function x(N,P){N.preventDefault();const L=j.current;if(!L)return;const V=L.getBoundingClientRect();k.current={x:N.clientX,y:N.clientY,w:V.width,h:V.height,dir:P},window.addEventListener("mousemove",C),window.addEventListener("mouseup",$)}function w(N,P){const V=N.key;if(!["ArrowLeft","ArrowRight","ArrowUp","ArrowDown","Enter"," "].includes(V))return;N.preventDefault();const U=V==="ArrowLeft"||V==="ArrowUp"?-20:20;A(te=>{const ie=te.width||s,ae=te.height||a||c;let q=ie,G=ae;return P.includes("e")&&(q=S(ie+U,o,l)),P.includes("w")&&(q=S(ie-U,o,l)),P.includes("s")&&(G=S(ae+U,c,b)),P.includes("n")&&(G=S(ae-U,c,b)),{width:Math.round(q),height:Math.round(G)}})}function C(N){const P=k.current;if(!P)return;const L=N.clientX-P.x,V=N.clientY-P.y,U=P.dir;let te=P.w,ie=P.h,ae=1/0;const q=j.current?.parentElement;if(q){const ge=window.getComputedStyle(q),Pe=parseFloat(ge.paddingTop||"0")||0,ne=parseFloat(ge.paddingBottom||"0")||0;ae=Math.max(0,q.clientHeight-Pe-ne)}const G=Math.min(b,isFinite(ae)?ae:b);U.includes("e")&&(te=S(P.w+L,o,l)),U.includes("s")&&(ie=S(P.h+V,c,G)),U.includes("w")&&(te=S(P.w-L,o,l)),U.includes("n")&&(ie=S(P.h-V,c,G)),A({width:Math.round(te),height:Math.round(ie)})}function $(){window.removeEventListener("mousemove",C),window.removeEventListener("mouseup",$),k.current=null}const j=i.useRef(null);i.useEffect(()=>{if(!g)return;function N(P){P.key==="Escape"&&(P.stopPropagation(),g?.())}return window.addEventListener("keydown",N,!0),()=>window.removeEventListener("keydown",N,!0)},[g]);const T=u?{width:"100%",height:"100%",maxWidth:"100%",maxHeight:"100%"}:{width:m.width?`${m.width}px`:void 0,height:m.height?`${m.height}px`:void 0,maxWidth:`${l}px`,maxHeight:"100%"},M=u?"card relative ndn-modal-full":"card relative";return e.jsxs("div",{ref:j,className:`${M} ${r||""}`,style:T,children:[e.jsx(ur,{returnFocus:!0,className:"flex-1 flex flex-col min-h-0 w-full",children:n}),!u&&e.jsx("div",{className:"resizer resizer-nw",onMouseDown:N=>x(N,"nw"),role:"button",tabIndex:0,"aria-label":"Resize north-west",onKeyDown:N=>w(N,"nw")}),!u&&e.jsx("div",{className:"resizer resizer-ne",onMouseDown:N=>x(N,"ne"),role:"button",tabIndex:0,"aria-label":"Resize north-east",onKeyDown:N=>w(N,"ne")}),!u&&e.jsx("div",{className:"resizer resizer-sw",onMouseDown:N=>x(N,"sw"),role:"button",tabIndex:0,"aria-label":"Resize south-west",onKeyDown:N=>w(N,"sw")}),!u&&e.jsx("div",{className:"resizer resizer-se",onMouseDown:N=>x(N,"se"),role:"button",tabIndex:0,"aria-label":"Resize south-east",onKeyDown:N=>w(N,"se")}),!u&&e.jsx("div",{className:"resizer-edge resizer-s",onMouseDown:N=>x(N,"s"),role:"button",tabIndex:0,"aria-label":"Resize south",onKeyDown:N=>w(N,"s")})]})}function fm(){const[t,n]=i.useState(null);i.useEffect(()=>{try{const s=a=>{a.preventDefault(),n(a)};return window.addEventListener("beforeinstallprompt",s),()=>window.removeEventListener("beforeinstallprompt",s)}catch{}},[]);async function r(){if(!t){alert('Open this site in your browser and use "Add to Home Screen" from the share menu (iOS) or use the browser install prompt (Android/Chrome).');return}try{t.prompt();const s=await t.userChoice;s&&s.outcome==="accepted"&&n(null)}catch(s){console.warn("install failed",s)}}return t?e.jsx("button",{className:"rounded bg-violet-600 text-white px-2 py-1",onClick:()=>r(),children:"Install App"}):null}function pm(){const[t,n]=i.useState(!1),r=new Date().getFullYear();return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"w-full text-center text-xs text-gray-500 py-2 select-none",children:["Â© ",r," Nine Dart Nation â€”"," ",e.jsx("button",{className:"underline",onClick:()=>n(!0),children:"Legal Notice"}),e.jsx("span",{className:"ml-3 inline-block align-middle",children:e.jsx(fm,{})})]}),t?e.jsx(hm,{storageKey:"ndn:modal:legal",className:"w-[640px]",defaultWidth:640,defaultHeight:420,minWidth:420,minHeight:220,initialFitHeight:!0,children:e.jsxs("div",{className:"p-4 space-y-3",children:[e.jsx("div",{className:"text-lg font-semibold",children:"Privacy & Copyright Notice"}),e.jsx("div",{className:"text-sm",children:"âš ï¸ IMPORTANT LEGAL NOTICE"}),e.jsx("div",{className:"text-sm",children:"Copyright Protection: All code, assets, and intellectual property in Nine Dart Nation are protected by copyright law. Unauthorized copying, modification, or distribution of this software is strictly prohibited."}),e.jsx("div",{className:"text-sm",children:"Legal Consequences: Any attempt to edit, reverse-engineer, or redistribute this code will result in immediate legal action, including but not limited to copyright infringement lawsuits and potential criminal charges."}),e.jsx("div",{className:"text-sm",children:"Privacy: Your personal data and gameplay information are protected. Any unauthorized access or data collection violates privacy laws and will be prosecuted to the full extent of the law."}),e.jsx("div",{className:"flex items-center gap-2 mt-3",children:e.jsx("button",{className:"btn",onClick:()=>n(!1),children:"Close"})})]})}):null]})}const on=mr(t=>({paused:!1,pauseEndsAt:null,pauseStartedAt:null,setPaused:(n,r=null)=>t({paused:n,pauseEndsAt:r??null,pauseStartedAt:n?Date.now():null})}));function gm(){const t=on(s=>s.paused),n=on(s=>s.pauseEndsAt),r=on(s=>s.setPaused);return i.useEffect(()=>{if(!t||!n)return;const s=Date.now();if(n<=s){r(!1,null);return}const a=n-s,o=setTimeout(()=>r(!1,null),a);return()=>clearTimeout(o)},[t,n,r]),null}function qo(t){return new Promise(n=>setTimeout(n,t))}async function bm(t,n){const r=Date.now();t.readyState>=1||(t.videoWidth??0)>0||await new Promise(s=>{let a=!1;const o=()=>{a||(a=!0,u(),s())},c=()=>o(),l=()=>o(),b=window.setInterval(()=>{Date.now()-r>n&&o(),t.readyState>=1&&o(),(t.videoWidth??0)>0&&o()},50),u=()=>{try{t.removeEventListener("loadedmetadata",c),t.removeEventListener("canplay",l),window.clearInterval(b)}catch{}};try{t.addEventListener("loadedmetadata",c),t.addEventListener("canplay",l)}catch{}})}async function ms(t){const{video:n,stream:r,attach:s=!0,muted:a=!0,playsInline:o=!0,maxAttempts:c=4,metadataTimeoutMs:l=1200,onPlayError:b}=t;if(!n)return{attached:!1,played:!1,reason:"no video"};const u=(r?.getVideoTracks?.()||[]).filter(k=>k.readyState==="live");if(!r||u.length===0)return{attached:!1,played:!1,reason:"no live stream"};try{a&&(n.muted=!0),o&&(n.playsInline=!0)}catch{}let f=!1;if(s)try{n.srcObject!==r&&(n.srcObject=r),f=!0}catch{return{attached:!1,played:!1,reason:"attach failed"}}const g=ms._playAttemptMap||new WeakMap;ms._playAttemptMap=g;const m=g.get(n);if(m)try{return await m}catch{}const A=(async()=>{for(let k=0;k<c;k++){try{await bm(n,l)}catch{}try{const S=n.play();if(S&&typeof S.then=="function"&&await S,(n.videoWidth??0)>0&&(n.videoHeight??0)>0)return{attached:f,played:!0};if(n.paused===!1)return{attached:f,played:!0}}catch(S){try{b?.(S)}catch{}if(S&&S.name==="AbortError"){await qo(120+k*150);continue}}await qo(120+k*150)}return{attached:f,played:!1,reason:"play retries exhausted"}})();g.set(n,A);try{return await A}finally{try{g.delete(n)}catch{}}}function xm(t,n,r,s,a){const o=Zn(t,n);return o?typeof r=="number"?wr(o,r,s??0,a??0):Jd(o):{base:0,ring:"MISS",sector:null,mult:0}}function vm(t){try{if(!t||typeof t!="object")return null;const n=t.confidence,r=typeof n=="number"&&Number.isFinite(n)?n>1?Math.max(0,Math.min(1,n/100)):Math.max(0,Math.min(1,n)):void 0;if((t.type==="dart"||t.kind==="dart"||t.event==="dart")&&typeof t.value=="number"){const s=Go(t.ring),a=Jo(t.value,s);return a?{...a,confidence:r}:null}if(typeof t.value=="number"&&t.ring){const s=Go(t.ring),a=Jo(t.value,s);return a?{...a,confidence:r}:null}if(typeof t.score=="string"){const s=t.score.trim().toUpperCase();if(s==="50"||s==="DBULL"||s==="INNER_BULL")return{value:50,ring:"INNER_BULL",sector:null,mult:0,confidence:r};if(s==="25"||s==="BULL"||s==="OBULL")return{value:25,ring:"BULL",sector:null,mult:0,confidence:r};const a=s.match(/^(S|D|T)(\d{1,2})$/);if(a){const o=a[1]==="S"?1:a[1]==="D"?2:3,c=parseInt(a[2],10);if(c>=1&&c<=20)return{value:c*o,ring:o===1?"SINGLE":o===2?"DOUBLE":"TRIPLE",sector:c,mult:o,confidence:r}}}if(typeof t.sector=="number"&&typeof t.mult=="number"){const s=Math.max(1,Math.min(20,Math.floor(t.sector))),a=t.mult===1?1:t.mult===2?2:3;return{value:s*a,ring:a===1?"SINGLE":a===2?"DOUBLE":"TRIPLE",sector:s,mult:a,confidence:r}}if(t.bull){const s=String(t.bull).toLowerCase()==="inner"||t.bull===!0;return{value:s?50:25,ring:s?"INNER_BULL":"BULL",sector:null,mult:0,confidence:r}}}catch{}return null}function Go(t){const n=String(t||"").toUpperCase();return n.startsWith("TR")?"TRIPLE":n.startsWith("DO")?"DOUBLE":n.startsWith("SI")?"SINGLE":n==="INNER_BULL"||n==="DBULL"||n==="50"||n==="IBULL"?"INNER_BULL":n==="BULL"||n==="25"||n==="OBULL"||n==="OUTER_BULL"?"BULL":n==="MISS"||n==="0"?"MISS":"SINGLE"}function Jo(t,n){const r=Math.max(0,Math.min(60,Math.round(Number(t)||0)));return n==="INNER_BULL"?{value:50,ring:n}:n==="BULL"?{value:25,ring:n}:{value:r,ring:n}}function ym(t,n){let r=null,s=!0,a=null,o=0;const c=400,l=[],b=new Set;function u(g,m){const A=typeof g?.id=="string"||typeof g?.id=="number"?String(g.id):null;if(A){if(b.has(A))return;if(b.add(A),l.push(A),l.length>200){const x=l.shift();x&&b.delete(x)}}const k=`${m.value}|${m.ring}|${m.sector??""}|${m.mult??""}`,S=Date.now();k===a&&S-o<c||(a=k,o=S,n(m))}function f(){if(s)try{r=new WebSocket(t),r.onmessage=g=>{try{const m=JSON.parse(g.data),A=vm(m);A&&u(m,A)}catch{}},r.onclose=()=>{r=null,setTimeout(f,1500)},r.onerror=()=>{}}catch{setTimeout(f,2e3)}}return f(),{close:()=>{s=!1;try{r?.close()}catch{}}}}function Yo({storageKey:t,children:n,className:r,defaultWidth:s=640,defaultHeight:a=360,minWidth:o=320,minHeight:c=200,maxWidth:l=1600,maxHeight:b=1200,autoFill:u=!1}){const[f,g]=i.useState(()=>{try{const j=localStorage.getItem(t);if(j)return JSON.parse(j)}catch{}return u?{width:s}:{width:s,height:a}}),m=i.useRef(null),A=i.useRef(null);i.useEffect(()=>{function j(){try{localStorage.removeItem(t)}catch{}g({width:s,height:a})}return window.addEventListener("ndn:layout-reset",j),window.addEventListener("ndn:camera-reset",j),()=>{window.removeEventListener("ndn:layout-reset",j),window.removeEventListener("ndn:camera-reset",j)}},[t,s,a]),i.useEffect(()=>{try{localStorage.setItem(t,JSON.stringify(f))}catch{}},[f,t]);function k(j,T,M){return Math.max(T,Math.min(M,j))}function S(j,T){j.preventDefault();const M=A.current;if(!M)return;const N=M.getBoundingClientRect();m.current={x:j.clientX,y:j.clientY,w:N.width,h:N.height,dir:T},window.addEventListener("mousemove",x),window.addEventListener("mouseup",w)}function x(j){const T=m.current;if(!T)return;const M=j.clientX-T.x,N=j.clientY-T.y;let P=T.w,L=T.h;T.dir.includes("e")&&(P=k(T.w+M,o,l)),!u&&T.dir.includes("s")&&(L=k(T.h+N,c,b)),T.dir.includes("w")&&(P=k(T.w-M,o,l)),!u&&T.dir.includes("n")&&(L=k(T.h-N,c,b)),g({width:Math.round(P),height:Math.round(L)})}function w(){window.removeEventListener("mousemove",x),window.removeEventListener("mouseup",w),m.current=null}function C(j,T){const N=j.key;if(!["ArrowLeft","ArrowRight","ArrowUp","ArrowDown","Enter"," "].includes(N))return;j.preventDefault();const P=N==="ArrowLeft"||N==="ArrowUp"?-20:20;g(L=>{const V=L.width||s,U=L.height||a;let te=V,ie=U;return T.includes("e")&&(te=k(V+P,o,l)),T.includes("w")&&(te=k(V-P,o,l)),!u&&T.includes("s")&&(ie=k(U+P,c,b)),!u&&T.includes("n")&&(ie=k(U-P,c,b)),{width:Math.round(te),height:Math.round(ie)}})}const $={width:u?"100%":f.width?`${f.width}px`:void 0,height:u?"100%":f.height?`${f.height}px`:void 0,maxWidth:"100%",maxHeight:u?"100%":"80vh",position:"relative",...u?{display:"flex",flexDirection:"column",flex:"1 1 auto"}:{}};return e.jsxs("div",{ref:A,className:`${r||""}`,style:$,children:[n,e.jsx("div",{className:"resizer resizer-nw",onMouseDown:j=>S(j,"nw"),role:"button",tabIndex:0,"aria-label":"Resize north-west",onKeyDown:j=>C(j,"nw")}),e.jsx("div",{className:"resizer resizer-ne",onMouseDown:j=>S(j,"ne"),role:"button",tabIndex:0,"aria-label":"Resize north-east",onKeyDown:j=>C(j,"ne")}),e.jsx("div",{className:"resizer resizer-sw",onMouseDown:j=>S(j,"sw"),role:"button",tabIndex:0,"aria-label":"Resize south-west",onKeyDown:j=>C(j,"sw")}),e.jsx("div",{className:"resizer resizer-se",onMouseDown:j=>S(j,"se"),role:"button",tabIndex:0,"aria-label":"Resize south-east",onKeyDown:j=>C(j,"se")})]})}const Fn=mr(t=>({darts:0,total:0,entries:[],setVisit:(n,r,s)=>t({entries:n,darts:r,total:s}),reset:()=>t({darts:0,total:0,entries:[]})}));function wm({onClose:t,onQuit:n,onPause:r}){return Nt.useEffect(()=>{const s=a=>{a.key==="Escape"&&t()};return window.addEventListener("keydown",s),()=>window.removeEventListener("keydown",s)},[t]),e.jsxs("div",{className:"fixed inset-0 z-[1200]",role:"presentation",children:[e.jsx("button",{className:"absolute inset-0 bg-black/50",onClick:t,"aria-label":"Close overlay"}),e.jsx("div",{className:"absolute inset-0 flex items-center justify-center p-4",children:e.jsx(ur,{returnFocus:!0,children:e.jsxs("div",{className:"card max-w-md w-full p-4 rounded-xl text-left",role:"dialog","aria-modal":"true","aria-labelledby":"pause-quit-heading",children:[e.jsxs("div",{className:"flex justify-between items-center mb-3",children:[e.jsx("h3",{id:"pause-quit-heading",className:"text-lg font-bold",children:"Quit or Pause ðŸŽ¯"}),e.jsx("button",{className:"btn px-3 py-1",onClick:t,"aria-label":"Close dialog",children:"âœ•"})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("p",{className:"mb-2",children:"You can either quit the match, or pause it for up to 5 minutes ðŸŽ¯."}),e.jsx("p",{className:"text-sm text-slate-400",children:"If paused, the match will automatically resume when the timer expires or when a player resumes early ðŸŽ¯."})]}),e.jsxs("div",{className:"flex gap-2 flex-wrap mb-3",children:[e.jsx("button",{className:"btn bg-rose-600 hover:bg-rose-700 px-3 py-1",onClick:()=>n(),children:"Quit match ðŸŽ¯"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"opacity-80",children:"Pause:"}),[1,2,3,4,5].map(s=>e.jsxs("button",{className:"btn btn--ghost px-3 py-1 text-sm",onClick:()=>r(s),children:[s,"m ðŸŽ¯"]},s))]})]}),e.jsx("div",{className:"text-right",children:e.jsx("button",{className:"btn btn--ghost px-3 py-1",onClick:t,children:"Cancel ðŸŽ¯"})})]})})})]})}function Nm(t){const n=Math.max(0,Math.floor(t/1e3)),r=Math.floor(n/60).toString().padStart(2,"0"),s=(n%60).toString().padStart(2,"0");return`${r}:${s}`}function mc({compact:t=!1}){const n=on(f=>f.pauseEndsAt),r=on(f=>f.pauseStartedAt),s=on(f=>f.paused),[a,o]=i.useState(Date.now());if(i.useEffect(()=>{if(!s||!n)return;const f=setInterval(()=>o(Date.now()),500);return()=>clearInterval(f)},[s,n]),!s||!n)return null;const c=Math.max(0,n-a),b=Math.max(1,n-(r??a)),u=Math.max(0,Math.min(1,1-c/b));return e.jsxs("div",{className:"mr-2",role:"status","aria-live":"polite","aria-atomic":"true","aria-label":`Match paused, ${Math.ceil(c/1e3)} seconds remaining`,children:[e.jsxs("div",{className:`px-2 py-1 rounded-full bg-amber-600 text-black text-xs font-semibold ${t?"":"mr-2"}`,children:["Paused ",Nm(c)," ðŸŽ¯"]}),!t&&e.jsx("div",{className:"w-40 h-2 bg-white/10 rounded overflow-hidden mt-1","aria-hidden":!0,children:e.jsx("div",{className:"h-2 bg-amber-400",style:{width:`${Math.round(u*100)}%`}})})]})}const hc="ndn:match-sync";function jm(){try{const t=mt.getState(),n=on.getState(),r={roomId:t.roomId,players:t.players,currentPlayerIdx:t.currentPlayerIdx,startingScore:t.startingScore,inProgress:t.inProgress,bestLegThisMatch:t.bestLegThisMatch,game:t.game??null,mode:t.mode??null,value:t.value??null};let s={};try{if(typeof localStorage<"u"){const o=localStorage.getItem("ndn:selectedMode");s.selectedMode=o||null}}catch{s={selectedMode:null}}const a={paused:n.paused,pauseEndsAt:n.pauseEndsAt??null,pauseStartedAt:n.pauseStartedAt??null};return{match:r,control:a,ui:s,ts:Date.now()}}catch{return null}}function ga(){try{const t=jm();if(!t)return;localStorage.setItem(hc,JSON.stringify(t));try{Un({type:"snapshot",state:t})}catch{}}catch{}}function Ko(){try{const t=localStorage.getItem(hc);if(!t)return null;const n=JSON.parse(t);return{match:n.match,control:n.control}}catch{return null}}const Sm=["D1","D2","D3","D4","D5","D6","D7","D8","D9","D10","D11","D12","D13","D14","D15","D16","D17","D18","D19","D20","DB"];function Cm(t){return t==="DB"?50:Number(t.slice(1))*2}function km(t){return Sm.includes(t)?Cm(t):32}function fh(t,n="D16"){if(t>170||t<=1)return[];const r={170:["T20 T20 DB"],167:["T20 T19 DB"],164:["T20 T18 DB"],161:["T20 T17 DB"],160:["T20 T20 D20"],158:["T20 T20 D19"],157:["T20 T19 D20"],156:["T20 T20 D18"],155:["T20 T19 D19"],154:["T20 T18 D20"],153:["T20 T19 D18"],152:["T20 T20 D16"],151:["T20 T17 D20"],150:["T20 T18 D18"],149:["T20 T19 D16"],148:["T20 T16 D20"],147:["T20 T17 D18"],146:["T20 T18 D16"],145:["T20 T15 D20"],144:["T20 T20 D12"],141:["T20 T19 D12"],140:["T20 T20 D10"],137:["T20 T19 D10"],136:["T20 T20 D8"],132:["BULL T14 D20","T20 T12 D8"],130:["T20 T20 D5","T20 T18 D8"],129:["T19 T16 D12"],128:["T18 T14 D16"],127:["T20 T17 D8"],126:["T19 T19 D6"],121:["T20 11 D20","T20 T15 D8"],120:["T20 20 D20","T20 S20 D20"],110:["T20 10 D20"],100:["T20 D20"],99:["T19 10 D16","T19 S10 D16"],97:["T19 D20"],96:["T20 D18"],95:["T19 D19"],94:["T18 D20"],92:["T20 D16"],90:["T18 D18","T20 D15"],86:["T18 D16"],84:["T20 D12","T16 D18"],82:["BULL D16","T14 D20"],81:["T19 D12"],80:["T20 D10","D20 D20"],78:["T18 D12"],76:["T20 D8","T16 D14"],74:["T14 D16","T18 D10"],72:["T16 D12","T20 D6"],70:["T18 D8","S20 BULL"],68:["T20 D4","T16 D10"],66:["T10 D18","T14 D12"],64:["T16 D8","D16 D16"],62:["T10 D16","T12 D13"],60:["20 D20","S20 D20"],58:["18 D20","S18 D20"],56:["16 D20","S16 D20"],54:["14 D20","S14 D20"],52:["20 D16","S20 D16"],50:["BULL","10 D20"],48:["16 D16","S16 D16"],46:["14 D16"],44:["12 D16"],42:["10 D16"],40:["D20"],38:["D19"],36:["D18"],34:["D17"],32:["D16"],30:["D15"],28:["D14"],26:["D13"],24:["D12"],22:["D11"],20:["D10"],18:["D9"],16:["D8"],14:["D7"],12:["D6"],10:["D5"],8:["D4"],6:["D3"],4:["D2"],2:["D1"]};if(r[t])return r[t];const s=km(n),a=[];for(const o of[60,57,54,51,48])if(t-o===s){a.push(`T${o/3} ${n}`);break}if(!a.length){for(const o of[20,19,18,17,16,15])if(t-o===s){a.push(`${o} ${n}`);break}}return a}function fc(t,n,r,s,a){try{const o=window.speechSynthesis;if(!o)return;const c=new SpeechSynthesisUtterance,l=t?.toString().replace(/[_-]+/g," ").replace(/\s+/g," ").trim()||t||"Player",b=r<=170&&r>0,u=n===180;if(!(!a?.checkoutOnly||b||u))return;if(u){const g=[`${l}... One hundred and eighty!`,`One hundred and EIGHTY! ${l}!`,`${l} with a maximum! One eighty!`];c.text=g[Math.floor(Math.random()*g.length)],c.rate=.95,c.pitch=1.1}else if(r===0){const g=[`Game shot! And the match, ${l}!`,`${l} takes it! Game shot!`,`And that's the checkout! ${l} wins!`];c.text=g[Math.floor(Math.random()*g.length)],c.rate=.9,c.pitch=1.05}else if(b)r<=40?c.text=`${l}... requires ${r}.`:r<=100?c.text=`${l}, you require ${r}.`:c.text=`${l} leaves ${r}.`,c.rate=.92,c.pitch=1;else if(n===0){const g=[`${l}... no score.`,`No score there for ${l}.`,`${l}, unfortunately, no score.`];c.text=g[Math.floor(Math.random()*g.length)],c.rate=.95,c.pitch=.95}else if(n>=140){const g=[`${l}! ${n}!`,`Lovely darts! ${l} with ${n}!`,`${n}! Great scoring from ${l}!`];c.text=g[Math.floor(Math.random()*g.length)],c.rate=.95,c.pitch=1.05}else n>=100?(c.text=`${t}, ${n}.`,c.rate=.95,c.pitch=1):(c.text=`${t}... ${n}.`,c.rate=.95,c.pitch=.98);if(s){const g=o.getVoices().find(m=>m.name===s);g&&(c.voice=g)}typeof a?.volume=="number"?c.volume=Math.max(0,Math.min(1,a.volume)):c.volume=1;try{o.cancel()}catch{}o.speak(c)}catch{}}const Em={},ba=.8,Tm=6500,Dm=!1,Im=String(Em?.VITE_CAMERA_VERBOSE_LOGS??"").trim().toLowerCase()==="1",Xo=(...t)=>{Im&&console.log(...t)},rs=i.forwardRef(function({onVisitCommitted:n,showToolbar:r=!0,onAutoDart:s,immediateAutoCommit:a=!1,hideInlinePanels:o=!1,scoringMode:c="x01",onGenericDart:l,onGenericReplace:b,x01DoubleInOverride:u,onAddVisit:f,onEndLeg:g,cameraAutoCommit:m="camera",forceAutoStart:A=!1,disableDetection:k=!1},S){const x=i.useRef(null),w=ve(d=>d.preferredCameraId),C=ve(d=>d.preferredCameraLabel),$=ve(d=>d.autoscoreProvider),j=ve(d=>d.autoscoreWsUrl),T=ve(d=>d.cameraAspect),M=ve(d=>d.cameraFitMode),N=ve(d=>d.cameraScale),P=ve(d=>d.cameraLowLatency)??!1,L=ve(d=>d.cameraProcessingFps)??15,V=ve(d=>d.autoCommitMode)??"wait-for-clear",U=ve(d=>d.confirmUncertainDarts)??!0,te=ve(d=>d.autoScoreConfidenceThreshold)??ba;ve(d=>d.autoscoreDetectorMinArea),ve(d=>d.autoscoreDetectorThresh),ve(d=>d.autoscoreDetectorRequireStableN);const ie=ve(d=>d.harshLightingMode)??!1;ve(d=>d.enhanceBigTrebles);const ae=ve(d=>d.cameraEnabled),q=ve(d=>d.preferredCameraLocked),G=ve(d=>d.hideCameraOverlay);ve(d=>typeof d.cameraRecordDarts=="boolean"?d.cameraRecordDarts:!0),ve(d=>typeof d.cameraShowLabels=="boolean"?d.cameraShowLabels:!1);const ge=ve(d=>d.callerEnabled),Pe=ve(d=>d.speakCheckoutOnly),ne=ve(d=>d.callerVoice),Ae=ve(d=>d.callerVolume),ce=ve.getState().setPreferredCamera,H=ve.getState().setCameraEnabled,I=ve.getState().setHideCameraOverlay,B=ve.getState().setCameraScale,de=ve.getState().setCameraAspect,K=ve.getState().setCameraFitMode;ve(d=>d.preserveCalibrationOverlay);const le=!1,we=$==="manual"||k||!le,[He,Qe]=i.useState([]),tt=i.useRef(null),pt=i.useRef(null),st=i.useRef(null),[E,J]=i.useState(!1),[z,oe]=i.useState(!1),[je,se]=i.useState(!1),[$e,jt]=i.useState(null),[Mt,Et]=i.useState(null),fe=er(),Qt=i.useCallback(d=>{x.current=d},[fe]),Be=C==="Phone Camera",vn=fe.getMediaStream?.()||null,Gt=fe.isStreaming,ht=Be&&fe.mode==="phone"&&Gt&&!!vn,_e=E||Gt||!1,[Te,Ge]=i.useState(!1),it=i.useRef(0),Ft=i.useRef(!0);i.useEffect(()=>()=>{Ft.current=!1},[]);const[ct,$n]=i.useState(()=>typeof document>"u"?!0:!document.hidden);i.useEffect(()=>{if(typeof document>"u")return;const d=()=>$n(!document.hidden);return document.addEventListener("visibilitychange",d),()=>document.removeEventListener("visibilitychange",d)},[]),i.useEffect(()=>{const d=x.current,y=fe.getMediaStream?.()||null;if(!(!d||!y))try{d.srcObject||(d.srcObject=y),typeof d.play=="function"&&Promise.resolve(d.play()).catch(()=>{})}catch{}},[fe.isStreaming,fe.mode,w]),i.useEffect(()=>{if(!ae||Be&&ht)return;const d=!!fe.getMediaStream?.();if(!d&&!E&&!Te)try{qt()}catch{}if(fe.isStreaming&&!d&&!Te){try{fe.setStreaming(!1)}catch{}try{qt()}catch{}}},[ae,Be,ht,E,Te,w]),i.useEffect(()=>{const d=x.current;if(!d)return;const y=()=>{try{const Q=d.play();Q&&typeof Q.catch=="function"&&Q.catch(()=>{})}catch{}},F=()=>{try{d.videoWidth&&d.videoHeight&&oe(!0)}catch{}},W=()=>{try{d.videoWidth&&d.videoHeight&&oe(!0)}catch{}};return d.addEventListener("loadedmetadata",y),d.addEventListener("playing",F),d.addEventListener("resize",W),()=>{d.removeEventListener("loadedmetadata",y),d.removeEventListener("playing",F),d.removeEventListener("resize",W)}},[]);const Ut=i.useCallback(d=>{const y=x.current,F=fe.getMediaStream?.()||null,W=F?F.getVideoTracks():[],Q=F?F.getAudioTracks():[];return{ts:Date.now(),hasVideoEl:!!y,video:{hasSrcObject:!!y?.srcObject,readyState:typeof y?.readyState=="number"?y.readyState:null,paused:typeof y?.paused=="boolean"?y.paused:null,ended:typeof y?.ended=="boolean"?y.ended:null,videoWidth:y?.videoWidth||0,videoHeight:y?.videoHeight||0},stream:{exists:!!F,videoTracks:W.length,audioTracks:Q.length,videoTrackStates:W.map(ue=>({enabled:ue.enabled,muted:ue.muted,readyState:ue.readyState}))},session:{mode:fe.mode,isStreaming:fe.isStreaming},preferredCamera:{id:w,label:C,locked:q},error:d?.error??null}},[fe,w,C,q]);i.useEffect(()=>{if(!je)return;let d=!0;const y=()=>{if(d)try{jt(Ut())}catch{}};y();const F=window.setInterval(y,500);return()=>{d=!1,window.clearInterval(F)}},[je,Ut]),i.useEffect(()=>{try{window.__ndn_camera_debug=window.__ndn_camera_debug||{},window.__ndn_camera_debug.collect=()=>{try{return Ut({error:Mt})}catch(d){return{error:String(d)}}},window.__ndn_camera_debug.videoEl=()=>x.current||null,window.__ndn_camera_debug.stream=()=>fe.getMediaStream?.()||null}catch{}return()=>{try{window.__ndn_camera_debug&&delete window.__ndn_camera_debug.collect}catch{}}},[Ut,Mt,fe]),i.useLayoutEffect(()=>{if(!A)return;try{ve.getState().setCameraEnabled(!0)}catch{}!!!fe.getMediaStream?.()&&!E&&!Te&&qt()},[A]),i.useEffect(()=>{if(!ae||A||Be&&ht)return;const d=!!fe.getMediaStream?.();if(!d&&!E&&!Te)try{qt()}catch{}if(fe.isStreaming&&!d&&!Te){try{fe.setStreaming(!1)}catch{}try{qt()}catch{}}},[ae,Be,ht,E,Te,w,A]),i.useEffect(()=>{const d=y=>{nt("[CAMERA] Received ndn:start-camera event",y.detail);try{H(!0)}catch{}!E&&!Te&&qt()};return window.addEventListener("ndn:start-camera",d),()=>window.removeEventListener("ndn:start-camera",d)},[E,Te,H]);const{H:at,imageSize:p,overlaySize:Z,theta:ye,rotationOffsetRad:Ze,sectorOffset:Fe,_hydrated:Yt,locked:Dn,errorPx:Bn}=En();i.useRef("none");const et=mt(d=>d),In=!!(et&&et.roomId),Wt=12,yn=90,wn=typeof Bn=="number"?Bn:null,mn=Ya(wn),rn=!!at&&!!p&&(Dn||wn!=null&&wn<=Wt&&mn!=null&&mn>=yn);i.useEffect(()=>{q&&!G&&I(!0)},[q,G,I]);const[zt,tr]=i.useState(""),[nr,xt]=i.useState(""),[sn,Zt]=i.useState(0),[$t,an]=i.useState("MISS");i.useRef(null),i.useRef({pending:!1,lastSeenTs:0,lastBullDistanceMm:null,lastTipVideoPx:null}),i.useRef({sig:null,firstTs:0,lastTs:0,frames:0,lastTip:null});const[lt,Lt]=i.useState(0),vt=i.useRef(0),[en,It]=i.useState(0),[Je,Ot]=i.useState([]),[hr,An]=i.useState(!1),[tn,kr]=i.useState(!1),Kn=In&&Je.some(d=>d.meta&&d.meta.source==="camera"&&!d.meta.calibrationValid),[fr,Ht]=i.useState(0),[Vn,hn]=i.useState(0),[Pt,Wr]=i.useState(!1),cn=i.useRef(null),fn=i.useRef(null),St=!a&&V!=="immediate",[Nn,O]=i.useState(0),[De,dt]=i.useState([]),ln=i.useRef(null),nn=i.useRef([]);i.useRef(0);const zr=i.useRef(0),ps=i.useRef(!1),Wn=i.useRef(null);i.useRef(0),i.useRef(Number.NEGATIVE_INFINITY),i.useRef({lastTip:null,stableFrames:0}),i.useRef(0),i.useRef(0);const Er=i.useRef(null),[ao,gs]=i.useState([]),[zs,Tr]=i.useState(null),[oo,bs]=i.useState(null),[xs,Xn]=i.useState("idle"),[Dr,Mn]=i.useState(null),[vs,pr]=i.useState(!1),Ir=i.useRef({lastTs:0}),[,ys]=i.useState(0),Ar=i.useCallback(d=>{try{Ir.current={...Ir.current,...d,lastTs:Date.now()},vs&&ys(y=>(y+1)%1e5);try{window.ndnAutoscoreDiagnostics={...Ir.current,__build:{clientVersion:"autoscore-debug/v1",builtAt:new Date().toISOString()}}}catch{}}catch{}},[vs]);i.useEffect(()=>{try{const d=!!at,y=!!(p&&typeof p.w=="number"&&typeof p.h=="number"&&p.w>0&&p.h>0),F=y?`${Math.round(p.w)}x${Math.round(p.h)}`:"(none)";Ar({hasHomography:d,hasImageSize:y,imageSizeStr:F})}catch{}},[at,p,Ar]),i.useEffect(()=>{const d=y=>{try{if(String(y.key||"").toLowerCase()!=="d"||!(y.shiftKey&&(y.ctrlKey||y.metaKey)))return;y.preventDefault(),pr(W=>!W)}catch{}};return window.addEventListener("keydown",d),()=>window.removeEventListener("keydown",d)},[]);const[On,Pn]=i.useState(null),[gr,Hs]=i.useState(null),[io,_t]=i.useState([]),[qs,ws]=i.useState(null),Ns=i.useCallback(d=>{try{if(!U)return!1;if(On)return!0;const y=Number(d.confidence);if(!isFinite(y))return!1;const F=Math.max(.5,Math.min(.99,Number(te)||ba));return y>=F?!1:(Pn({label:d.label,value:d.value,ring:d.ring,confidence:y,meta:d.meta}),!0)}catch{return!1}},[U,On,te,Pn]),Hr=i.useRef(!1);i.useEffect(()=>{Hr.current=!1},[c]);const br=i.useCallback(()=>{fn.current&&(clearTimeout(fn.current),fn.current=null)},[]),pn=i.useCallback(d=>typeof d!="number"||Number.isNaN(d)?1:Math.min(1.25,Math.max(.5,Math.round(d*100)/100)),[]),qr=i.useCallback(d=>{if(!B)return;const y=pn((N??1)+d);B(y)},[N,pn,B]),Gs=i.useCallback(()=>{K&&K("fill"),de&&de("wide")},[K,de]),Mr=i.useCallback(()=>{K&&K("fit"),de&&de("wide")},[K,de]);i.useImperativeHandle(S,()=>({runDetectionTick:()=>{try{Er.current&&Er.current()}catch{}},__test_addDart:void 0,__test_commitVisit:void 0,runSelfTest:async()=>{try{return await Js()}catch{return!1}},__test_forceSetPendingVisit:void 0}));const js=i.useCallback(d=>{try{const F=Gr();F&&(d.frame=F)}catch{}const y=[...nn.current.slice(-8),d];nn.current=y,gs(y);try{Tr(d)}catch{}try{window.ndnCameraDiagnostics=y}catch{}},[]),xr=i.useCallback(()=>{try{const d=window.AudioContext||window.webkitAudioContext;if(!d)return;const y=new d,F=y.createOscillator(),W=y.createGain();F.type="sine",F.frequency.value=1e3,W.gain.value=.0015,F.connect(W),W.connect(y.destination),F.start(),setTimeout(()=>{try{F.stop(),y.close?.()}catch{}},120)}catch{}},[]),Js=i.useCallback(async()=>{try{Xn("running"),Mn(null),nn.current=[],gs([]);const d=6;for(let W=0;W<d;W++){try{Er.current&&Er.current()}catch{}await new Promise(Q=>setTimeout(Q,180))}const y=nn.current.slice();y.some(W=>W.accepted||W.ready&&W.confidence>=(te??ba))?(Xn("pass"),Mn("Detection OK")):(Xn("fail"),Mn(y.length?`No accepted detections (best confidence ${(y[y.length-1].confidence||0).toFixed(2)})`:"No detections"))}catch{Xn("fail"),Mn("Self-test error")}finally{setTimeout(()=>Xn("idle"),3e3)}},[te]),Gr=i.useCallback(()=>{try{const d=x.current;if(!d||!d.videoWidth||!d.videoHeight)return null;const y=640,F=Math.round(d.videoHeight/d.videoWidth*y)||360,W=document.createElement("canvas");W.width=y,W.height=F;const Q=W.getContext("2d");return Q?(Q.drawImage(d,0,0,y,F),W.toDataURL("image/jpeg",.5)):null}catch{return null}},[]),Rn=i.useCallback(d=>{const y=cn.current;if(y){cn.current=null,br(),Wr(!1),_t([]);try{const F=y.meta?.entries,W=F?.[F.length-1]?.meta?.bullDistanceMm;Xs(W)}catch{}if(n)try{n(y.score,y.darts,y.finished,y.meta);try{Un({type:"visit",score:y.score,darts:y.darts,finished:y.finished,meta:y.meta,playerIdx:et.currentPlayerIdx,ts:Date.now()});try{ga()}catch{}try{const F=Gr();bs({ts:Date.now(),score:y.score,darts:y.darts,frame:F})}catch{}}catch{}}catch{}}},[n,br]),zn=i.useCallback(d=>{if(n){if(!St){try{const y=d.meta?.entries,F=y?.[y.length-1]?.meta?.bullDistanceMm;Xs(F)}catch{}try{Pr(d.score)}catch{}try{n(d.score,d.darts,d.finished,d.meta)}catch{}return}cn.current=d,Wr(!0),br(),fn.current=window.setTimeout(()=>Rn("timeout"),Tm)}},[n,St,br,Rn,Xs,Pr]),rr=i.useCallback(d=>{Lt(0),vt.current=0,It(0),Ot([]),_t([]),Ht(0),hn(0),Xe(!1);try{window.dispatchEvent(new CustomEvent("ndn:clear-visit-request",{detail:{source:"camera-view",reason:d,ts:Date.now()}}))}catch{}},[]);i.useEffect(()=>{if(!St)return;const d=()=>Rn("event");return window.addEventListener("ndn:darts-cleared",d),()=>window.removeEventListener("ndn:darts-cleared",d)},[St,Rn]),i.useEffect(()=>{St||Rn("timeout")},[St,Rn]),i.useEffect(()=>()=>Rn("teardown"),[Rn]);const Or=i.useCallback(()=>{rr("indicator"),O(d=>d+1)},[rr]),Ss=i.useCallback(()=>{lt===0&&en===0||(rr("toolbar"),O(d=>d+1))},[rr,lt,en]);i.useCallback(()=>{},[we]);const vr=ve(d=>d.x01DoubleIn),sr=typeof u=="boolean"?!!u:!!vr,[co,h]=i.useState({}),D=et.players[et.currentPlayerIdx]?.id,R=!!(D&&co[D]),_=d=>{D&&h(y=>({...y,[D]:d}))},v=et?.inProgress,re=Fn(d=>d.setVisit),ee=Fn(d=>d.reset);i.useEffect(()=>{try{re(Je,lt,en);try{const d={type:"pendingVisit",entries:Je,darts:lt,total:en,playerIdx:et.currentPlayerIdx,ts:Date.now()};try{const y=x.current;if(y&&y.videoWidth&&y.videoHeight){const W=Math.round(y.videoHeight/y.videoWidth*320)||180,Q=document.createElement("canvas");Q.width=320,Q.height=W;const ue=Q.getContext("2d");if(ue){ue.drawImage(y,0,0,320,W);try{d.frame=Q.toDataURL("image/jpeg",.45)}catch{}}}}catch{}Un(d)}catch{}}catch{}},[Je,lt,en,re]),i.useEffect(()=>()=>{try{ee()}catch{}},[ee]);const X=mt(d=>d.addVisit),be=mt(d=>d.endLeg),me=i.useCallback(d=>{try{return Array.isArray(d)?d.slice(0,3).map(y=>({label:String(y?.label??""),value:Number(y?.value??0),ring:String(y?.ring??"")})):void 0}catch{return}},[]),Y=(d,y,F)=>{try{nt("CameraView: callAddVisit",d,y,F);try{ws({score:d,darts:y,expires:Date.now()+2e3})}catch{}f?f(d,y,F):X(d,y,F);try{Un({type:"visit",score:d,darts:y,playerIdx:et.currentPlayerIdx,ts:Date.now()});try{ga()}catch{}}catch{}}catch{}},he=d=>{try{g?g(d):be(typeof d=="number"?d:0)}catch{}},[Ve,qe]=i.useState(""),[xe,ke]=i.useState(0),[,Ee]=i.useState(!1),[Re,Xe]=i.useState(!1),[gn,Me]=i.useState(!1),[We,Tt]=i.useState("manual"),[bt,Ye]=i.useState(!1),[,Ct]=i.useState(!1),[Bt,ft]=i.useState(!1),Le=i.useRef(null),ot=ve(d=>d.dartTimerEnabled),Rt=ve(d=>d.dartTimerSeconds)||10,[kt,yt]=i.useState(null),Dt=i.useRef(null),Kt=on(d=>d.paused);i.useRef(null),i.useRef(null),i.useRef(0),i.useRef(null),i.useRef(0),i.useRef(null),i.useRef(0),i.useRef(!1);const kn=i.useRef(null),[dn]=i.useState(0),Xt=i.useCallback(()=>{try{window.dispatchEvent(new CustomEvent("ndn:phone-camera-reconnect",{detail:{source:"camera-view",ts:Date.now()}}))}catch(d){console.warn("[CameraView] Phone camera reconnect dispatch failed:",d)}},[]);i.useEffect(()=>{},[le,we]),i.useEffect(()=>()=>{try{kn.current&&clearTimeout(kn.current)}catch{}},[]),i.useEffect(()=>{const d=()=>ft(!0);return window.addEventListener("ndn:open-scoring",d),()=>window.removeEventListener("ndn:open-scoring",d)},[]),i.useEffect(()=>{const d=()=>{O(y=>y+1),Lt(0),vt.current=0,It(0),Ot([]),_t([]),Ht(0),hn(0),Xe(!1)};return window.addEventListener("ndn:darts-cleared",d),()=>window.removeEventListener("ndn:darts-cleared",d)},[]),i.useEffect(()=>{dt(d=>{if(Je.length>d.length){const y=Je.length-d.length;return[...d,...Array(y).fill(Nn)]}return Je.length<d.length?d.slice(0,Je.length):d})},[Je,Nn]),i.useEffect(()=>{Wn.current&&(clearTimeout(Wn.current),Wn.current=null);{ps.current=!1,zr.current=0,ln.current=null;return}},[_e,we]),i.useEffect(()=>{let d=!0;async function y(){try{if(!navigator?.mediaDevices?.enumerateDevices)return;const F=await navigator.mediaDevices.enumerateDevices();if(!d)return;Qe(F.filter(W=>W.kind==="videoinput"))}catch(F){console.warn("[CAMERA] enumerateDevices failed:",F)}}y();try{navigator.mediaDevices.addEventListener("devicechange",y)}catch{try{navigator.mediaDevices.ondevicechange=y}catch{}}return()=>{d=!1;try{navigator.mediaDevices.removeEventListener("devicechange",y)}catch{}}},[]),i.useEffect(()=>{const d=()=>{Tt("manual"),Ye(!0)},y=()=>{Tt("manual"),Ye(!1)};return window.addEventListener("ndn:open-manual",d),window.addEventListener("ndn:close-manual",y),()=>{window.removeEventListener("ndn:open-manual",d),window.removeEventListener("ndn:close-manual",y)}},[]),i.useEffect(()=>{Tt("manual"),Ct(!1)},[we]),i.useEffect(()=>{try{const d=et.players[et.currentPlayerIdx],y=d?.legs?.[d.legs.length-1];if(!d)return;(!y||y.dartsThrown===0)&&h(F=>({...F,[d.id]:!1}))}catch{}},[et.currentPlayerIdx,et.players?.[et.currentPlayerIdx]?.legs?.length]),i.useEffect(()=>{const d=!!ot&&v&&!Kt&&lt<3;if(Dt.current&&(clearInterval(Dt.current),Dt.current=null),!d){yt(null);return}return yt(Rt),Dt.current=window.setInterval(()=>{yt(y=>{const F=(y??Rt)-1;if(F<=0){try{const W=vt.current||0,Q=Math.max(0,3-W);for(let ue=0;ue<Q;ue++)ar(0,"MISS 0","MISS")}catch{}return Dt.current&&(clearInterval(Dt.current),Dt.current=null),0}return F})},1e3),()=>{Dt.current&&(clearInterval(Dt.current),Dt.current=null)}},[ot,Rt,lt,et.currentPlayerIdx,et?.inProgress,Kt]),i.useEffect(()=>{if(!bt)return;const d=setInterval(()=>{try{const y=x.current,F=Le.current;if(!y||!F)return;const W=y.videoWidth||0,Q=y.videoHeight||0;if(!W||!Q)return;const ue=F.clientWidth||640,Ce=F.clientHeight||360,Ie=Math.max(1,Math.round((window.devicePixelRatio||1)*100)/100),Ue=Math.floor(ue*Ie),gt=Math.floor(Ce*Ie);F.width!==Ue&&(F.width=Ue),F.height!==gt&&(F.height=gt);const Se=F.getContext("2d");if(!Se)return;Se.imageSmoothingEnabled=!0;try{Se.setTransform(Ie,0,0,Ie,0,0)}catch{}const Ke=Math.min(ue/W,Ce/Q),ut=Math.round(W*Ke),pe=Math.round(Q*Ke),Oe=Math.floor((ue-ut)/2),wt=Math.floor((Ce-pe)/2);Se.fillStyle="#000",Se.fillRect(0,0,ue,Ce),Se.drawImage(y,Oe,wt,ut,pe)}catch(y){console.warn("Manual preview update error:",y)}},120);return()=>clearInterval(d)},[bt]),i.useEffect(()=>()=>{},[]);const Jt=Be&&!ht;async function qt(){const d=fe.getMediaStream?.()||(x.current?.srcObject??null),y=(()=>{try{const W=d;if(!W)return!1;const Q=W.getVideoTracks;return typeof Q!="function"?!1:!!Q.call(W)?.length}catch{return!1}})();if(Te||E&&y)return;if(Be&&ht&&(d?.getVideoTracks?.()||[]).some(ue=>ue.readyState==="live")){Ge(!1);try{fe.setStarting?.(!1)}catch{}return}Ge(!0);try{fe.setStarting?.(!0)}catch{}try{Et(null)}catch{}const F=async W=>{if(!W||W.kind!=="video"||!(ie||typeof window<"u"&&window.localStorage?.getItem("ndn.glareClamp")==="1"))return;const ue=W.getCapabilities?.()||{},Ce=Ue=>Ue in ue,Ie={...Ce("exposureMode")?{exposureMode:"continuous"}:{},...Ce("whiteBalanceMode")?{whiteBalanceMode:"continuous"}:{},...Ce("focusMode")?{focusMode:"continuous"}:{},...Ce("sharpness")?{sharpness:ue.sharpness?.max}:{},...Ce("contrast")?{contrast:ue.contrast?.max}:{},...Ce("backlightCompensation")?{backlightCompensation:!1}:{}};if(Object.keys(Ie).length)try{await W.applyConstraints(Ie),nt("[CAMERA] Applied anti-glare track constraints:",Ie)}catch(Ue){console.warn("[CAMERA] Anti-glare track constraints not supported:",Ue)}};try{const W={width:{ideal:3840},height:{ideal:2160},frameRate:{ideal:30}},Q={width:{ideal:2560},height:{ideal:1440},frameRate:{ideal:30}},ue={width:{ideal:1920},height:{ideal:1080},frameRate:{ideal:30}},Ce={width:{ideal:1280},height:{ideal:720},frameRate:{ideal:30}},Ie=w?{deviceId:{exact:w}}:{facingMode:"environment"},Ue=async(Se,Ke)=>{const ut={video:{...Ie,...Se},audio:!1};return nt(`[CAMERA] Using constraints (${Ke}):`,ut),navigator.mediaDevices.getUserMedia(ut)};let gt;try{const Se=P?{width:{ideal:1280},height:{ideal:720},frameRate:{ideal:60}}:{width:{ideal:3840},height:{ideal:2160},frameRate:{ideal:30}};try{gt=await Ue(Se,"dynamic-best-effort")}catch(Ke){nt("[CAMERA] Dynamic hints failed, trying basic 1080p fallback:",Ke),gt=await Ue(ue,"1080p-fallback")}nt("[CAMERA] Got stream:",!!gt)}catch(Se){console.warn("[CAMERA] First attempt failed:",Se);const Ke=Se&&(Se.name||Se.code)||"";if(w&&(Ke==="OverconstrainedError"||Ke==="NotFoundError"))nt("[CAMERA] Trying fallback without deviceId"),gt=await navigator.mediaDevices.getUserMedia({video:{...Q},audio:!1});else if(!w&&(Ke==="OverconstrainedError"||Ke==="NotFoundError"||Ke==="NotSupportedError"))nt("[CAMERA] Trying fallback for facingMode not supported"),gt=await navigator.mediaDevices.getUserMedia({video:{...Q},audio:!1});else throw Se}if(x.current){nt("[CAMERA] Setting stream to video element"),x.current.srcObject=gt;try{const Ke=gt?.getVideoTracks?.()?.[0];F(Ke)}catch{}try{fe.setMediaStream?.(gt),fe.setMode?.("local"),fe.setStreaming?.(!0),fe.setStarting?.(!1)}catch(Ke){console.warn("[CAMERA] Failed to sync camera session with local stream:",Ke)}try{x.current.addEventListener("loadeddata",()=>nt("[CAMERA] Video loadeddata")),x.current.addEventListener("loadedmetadata",()=>{nt("[CAMERA] Video loadedmetadata - dimensions available"),x.current?.videoWidth&&x.current?.videoHeight&&oe(!0)}),x.current.addEventListener("canplay",()=>{nt("[CAMERA] Video canplay"),x.current?.videoWidth&&x.current?.videoHeight&&oe(!0)}),x.current.addEventListener("play",()=>nt("[CAMERA] Video started playing")),x.current.addEventListener("error",Ke=>console.error("[CAMERA] Video error:",Ke))}catch{}let Se=null;try{if(Se=await ms({video:x.current,stream:gt,onPlayError:Ke=>console.error("[CAMERA] Video play failed:",Ke)}),Se.played){nt("[CAMERA] Video play ensured");try{it.current=0}catch{}try{const Ke=fe.getVideoElementRef?.();(!Ke||Ke===x.current)&&fe.setVideoElementRef?.(x.current)}catch{}try{(async()=>{for(let pe=0;pe<3;pe++)try{if(x.current?.videoWidth&&x.current?.videoHeight)return oe(!0),!0;nt(`[CAMERA] play succeeded but no dimensions yet, reattach attempt ${pe+1}`);try{x.current&&(x.current.srcObject=null)}catch{}await new Promise(Oe=>setTimeout(Oe,120+pe*80));try{x.current&&(x.current.srcObject=gt)}catch{}try{(await ms({video:x.current,stream:gt,onPlayError:wt=>console.error("[CAMERA] reattach play failed:",wt)})).played&&nt("[CAMERA] reattach play confirmed")}catch(Oe){nt("[CAMERA] reattach ensureVideoPlays threw:",Oe)}await new Promise(Oe=>setTimeout(Oe,220+pe*60))}catch(Oe){nt("[CAMERA] attach retry error:",Oe)}return!1})().then(ut=>{ut||nt("[CAMERA] attach/replay retries exhausted")})}catch{}}else console.warn("[CAMERA] ensureVideoPlays did not confirm playback:",Se?.reason)}catch(Ke){console.error("[CAMERA] ensureVideoPlays failed:",Ke)}try{if(!!!(Se&&Se.played)){const pe=it.current??0;if(pe<3&&Ft.current){it.current=pe+1;const Oe=700*Math.pow(2,pe);nt("[CAMERA] Scheduling camera restart retry",it.current,"in",Oe,"ms"),setTimeout(async()=>{try{if(!Ft.current)return;Qn(),await new Promise(wt=>setTimeout(wt,120)),await qt()}catch(wt){nt("[CAMERA] Retry attempt failed:",wt)}},Oe)}else nt("[CAMERA] Max camera retries reached or unmounted; not retrying")}}catch{}if(nt("[CAMERA] Stream tracks:",gt.getTracks().length,"video tracks:",gt.getVideoTracks().length),Be)try{fe.setMediaStream?.(gt),Se?.played&&fe.setVideoElementRef?.(x.current)}catch{}}else console.error("[CAMERA] Video element not found");J(!0);try{Et(null)}catch{}try{const Se=await navigator.mediaDevices.enumerateDevices();Qe(Se.filter(Ke=>Ke.kind==="videoinput")),nt("[CAMERA] Found cameras:",Se.filter(Ke=>Ke.kind==="videoinput").length)}catch(Se){console.warn("[CAMERA] Failed to enumerate devices:",Se)}}catch(W){console.error("[CAMERA] Camera start failed:",W);const Q=W?.name||W?.code||"";Et(Q==="NotAllowedError"||Q==="SecurityError"?"permission-denied":Q==="NotFoundError"||Q==="OverconstrainedError"?"not-found":Q==="NotSupportedError"?"not-supported":"unknown"),Ge(!1);try{fe.setStarting?.(!1)}catch{}}finally{Ge(!1);try{fe.setStarting?.(!1)}catch{}}}function Qn(){try{const d=fe.getMediaStream?.()||null;d&&d.getTracks().forEach(y=>y.stop())}catch{}if(x.current)try{x.current.srcObject=null}catch{}try{fe.setMediaStream?.(null),fe.setStreaming?.(!1),fe.setVideoElementRef?.(null)}catch{}J(!1),Ge(!1)}i.useEffect(()=>{const d=x.current;if(!d)return;const y=fe.getMediaStream?.()||null,W=(fe.getVideoElementRef?.()||null)?.srcObject||null,Q=y||W;if(Q){d.srcObject!==Q&&(d.srcObject=Q),d.muted=!0,d.playsInline=!0;try{Promise.resolve(d.play()).catch(()=>{})}catch{}E||J(!0)}},[fe.mode,fe.isStreaming,E,fe]),i.useEffect(()=>{if(je)try{jt(Ut({error:Mt}))}catch{}},[je,Mt,Ut]),i.useEffect(()=>{let d=null,y=!0,F=!1,W=0,Q=null,ue=0;const Ce=18;pt.current,x.current;function Ie(){d!=null&&(cancelAnimationFrame(d),d=null)}function Ue(){try{const ut=performance&&performance.now&&performance.now()||Date.now(),pe=1e3/Ce;if(ut-ue<pe){d=requestAnimationFrame(Ue);return}ue=ut}catch{}try{const ut=x.current,pe=pt.current;if(!y||!ut||!pe)return Ie();const Oe=ut.videoWidth||0,wt=ut.videoHeight||0;if(Oe<=0||wt<=0){d=requestAnimationFrame(Ue);return}try{if(!F){try{Vs("CameraView: preview-canvas fallback activated")}catch{}F=!0}pe.style.visibility!=="visible"&&(pe.style.visibility="visible")}catch{}const At=pe.getBoundingClientRect(),Vt=Math.max(1,Math.round(At.width)),jn=Math.max(1,Math.round(At.height));(pe.width!==Vt||pe.height!==jn)&&(pe.width=Vt,pe.height=jn);const Rr=pe.getContext("2d");if(!Rr)return Ie();try{Rr.clearRect(0,0,pe.width,pe.height),Rr.drawImage(ut,0,0,pe.width,pe.height)}catch{}d=requestAnimationFrame(Ue)}catch{Ie()}}const gt=()=>{const ut=x.current,pe=pt.current;if(!ut||!pe)return;const Oe=!!(ut.videoWidth&&ut.videoHeight),wt=ut.readyState===0||ut.readyState<2;try{if(typeof window<"u"){const At=window.localStorage.getItem("ndn:forceCanvasFallback");if(At==="1"||At==="true"){try{console.info("CameraView: forced canvas fallback via localStorage")}catch{}Ie(),d=requestAnimationFrame(Ue);return}}}catch{}if(Oe&&wt)Ie(),d=requestAnimationFrame(Ue);else try{pt.current&&(pt.current.style.visibility="hidden")}catch{}};(()=>{try{if(typeof document>"u")return;const ut=document.createElement("canvas"),pe=32,Oe=32;ut.width=pe,ut.height=Oe;const wt=ut.getContext("2d",{willReadFrequently:!0});if(!wt)return;Q=window.setInterval(()=>{try{const At=x.current;if(!At||At.videoWidth===0||At.videoHeight===0){W=0;return}wt.clearRect(0,0,pe,Oe),wt.drawImage(At,0,0,pe,Oe);const Vt=wt.getImageData(0,0,pe,Oe).data;let jn=0;for(let yr=0;yr<Vt.length;yr+=4)jn+=.299*Vt[yr]+.587*Vt[yr+1]+.114*Vt[yr+2];if(jn/(pe*Oe*255)<.02?W+=1:W=0,W>=3){try{Vs("CameraView: video surface appears blank; enabling canvas fallback")}catch{}W=0,Ie(),d=requestAnimationFrame(Ue)}}catch{}},300)}catch{}})(),gt();const Ke=setInterval(()=>gt(),400);return()=>{y=!1,Ie(),clearInterval(Ke);try{Q&&clearInterval(Q)}catch{}}},[x,pt]);async function Jr(){try{if(!navigator?.mediaDevices?.enumerateDevices){Et("not-supported");return}const d=await navigator.mediaDevices.enumerateDevices();Qe(d.filter(y=>y.kind==="videoinput"))}catch(d){console.warn("[CAMERA] enumerateDevices failed:",d)}}function lo(){const[d,y]=i.useState(""),F=async W=>{if(Te)return;const Q=He.find(ue=>ue.deviceId===W)?.label;ce(W||void 0,Q||"",!0),Qn(),await new Promise(ue=>setTimeout(ue,150));try{await qt()}catch{}};return e.jsxs("div",{className:"camera-selector absolute bottom-2 right-2 z-20 flex items-center gap-2 bg-black/40 rounded px-2 py-1 text-xs",children:[e.jsx("span",{children:"Cam:"}),e.jsxs("select",{onPointerDown:W=>{W.stopPropagation()},onMouseDown:W=>{W.stopPropagation()},onTouchStart:W=>{W.stopPropagation?.()},className:"bg-black/20 rounded px-1 py-0.5",value:w||"",onChange:async W=>{if(Te)return;const Q=W.target.value||void 0,ue=He.find(Ce=>Ce.deviceId===Q)?.label;ce(Q,ue||"",!0),Qn(),await new Promise(Ce=>setTimeout(Ce,150));try{await qt()}catch(Ce){console.warn("Failed to start camera after device switch:",Ce),setTimeout(async()=>{try{await qt()}catch(Ie){console.error("Camera switch failed after retry:",Ie),alert("Failed to switch camera. Please try again or refresh the page.")}},500)}},children:[e.jsx("option",{value:"",children:"Auto"}),e.jsx("option",{value:"manual",children:"~ Enter device ID ..."}),He.map(W=>e.jsx("option",{value:W.deviceId,children:W.label||(W.deviceId?`Camera (${W.deviceId.slice(0,6)})`:"Camera")},W.deviceId))]}),w==="manual"&&e.jsxs("div",{className:"flex items-center gap-2 ml-2",children:[e.jsx("input",{className:"input input--small",placeholder:"Device ID",value:d,onChange:W=>y(W.target.value)}),e.jsx("button",{className:"btn btn--ghost btn-sm",onClick:()=>F(d||void 0),children:"Apply"})]}),He.length===0&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-xs text-yellow-300",children:"No cameras found"}),e.jsx("button",{className:"btn btn--ghost btn-sm ml-2",onClick:Jr,title:"Refresh camera list",children:"Refresh"})]}),Mt==="permission-denied"&&e.jsx("div",{className:"ml-2 text-xs text-rose-300",children:"Camera permission denied. Allow camera access in your browser site settings, then click Rescan."}),e.jsx("button",{className:"btn btn--ghost btn-sm ml-2",onClick:async()=>{try{await Jr()}catch(W){console.warn("Rescan failed:",W)}},title:"Rescan connected cameras",children:"Rescan"}),je&&e.jsxs("div",{className:"mt-2 ml-1 text-xs rounded-lg border border-white/10 bg-black/30 p-2",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("div",{className:"font-semibold",children:"Video diagnostics"}),e.jsx("div",{className:"opacity-60 text-xxs",children:$e?.ts?new Date($e.ts).toLocaleTimeString():""})]}),e.jsxs("div",{className:"mt-1 grid grid-cols-2 gap-x-3 gap-y-1",children:[e.jsx("div",{className:"opacity-70",children:"preferred"}),e.jsxs("div",{className:"break-all",children:[C||"(none)"," ",w?`(${w})`:""]}),e.jsx("div",{className:"opacity-70",children:"session"}),e.jsxs("div",{children:["mode=",String($e?.session?.mode??"?")," stream=",String($e?.session?.isStreaming??"?")]}),e.jsx("div",{className:"opacity-70",children:"video el"}),e.jsxs("div",{children:["srcObject=",String($e?.video?.hasSrcObject??!1)," rs=",String($e?.video?.readyState??"?")," paused=",String($e?.video?.paused??"?")]}),e.jsx("div",{className:"opacity-70",children:"dimensions"}),e.jsxs("div",{children:[$e?.video?.videoWidth??0,"ï¿½",$e?.video?.videoHeight??0]}),e.jsx("div",{className:"opacity-70",children:"tracks"}),e.jsxs("div",{children:["v=",$e?.stream?.videoTracks??0," a=",$e?.stream?.audioTracks??0]})]}),$e?.stream?.videoTrackStates?.length?e.jsxs("div",{className:"mt-2",children:[e.jsx("div",{className:"opacity-70",children:"video track state"}),e.jsx("div",{className:"mt-1 space-y-1",children:$e.stream.videoTrackStates.map((W,Q)=>e.jsxs("div",{className:"text-xxs opacity-90",children:["#",Q," ready=",W.readyState," enabled=",String(W.enabled),typeof W.muted=="boolean"?` muted=${String(W.muted)}`:""]},Q))})]}):null,$e?.error?e.jsxs("div",{className:"mt-2 text-xxs text-rose-200",children:["cameraAccessError=",String($e.error)]}):null,e.jsx("div",{className:"mt-2 text-xxs opacity-60",children:"If dims stay 0ï¿½0 but tracks>0, the video element isn't receiving frames (often a virtual cam / autoplay / stream ownership issue). If tracks=0, getUserMedia succeeded but no video track is being delivered."})]})]})}i.useEffect(()=>{},[at,p,_e,we,Be,q,G,ct,gr,qs]),i.useEffect(()=>{if(Xo("[DETECTION] Effect running",{manualOnly:we,autoscoreProvider:$,videoReady:z,hasH:!!at,hasImageSize:!!p,hasVideoRef:!!x.current,videoWidth:x.current?.videoWidth,videoHeight:x.current?.videoHeight}),!!ct){Xo("[DETECTION] Exiting: TEST_MODE or manualOnly");return}},[we,$,_e,at,p,Kt,lt,dn,js,z,ct,L]);const Yr=i.useCallback(async()=>{try{if(Be){const d=He.find(y=>y.kind==="videoinput");d?ce(d.deviceId,d.label||"",!0):ce(void 0,"",!0)}await qt()}catch(d){console.warn("[CameraView] Local camera fallback failed:",d)}},[He,Be,ce]),pc=()=>{if(!o)return null;const d=T||ve.getState().cameraAspect||"wide",y=(M||ve.getState().cameraFitMode||"fit")==="fit",F=d==="square"?"absolute left-0 top-1/2 -translate-y-1/2 min-w-full min-h-full object-cover object-left bg-black":y?"absolute inset-0 w-full h-full object-contain object-center bg-black ndn-video-smooth":"absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 min-w-full min-h-full w-auto h-auto object-cover object-center bg-black ndn-video-smooth",W=N??1,Q=ie||typeof window<"u"&&(window.localStorage?.getItem("ndn.glareDimming")==="1"||window.localStorage?.getItem("ndn.glareClamp")==="1"),ue={transform:`scale(${W})`,transformOrigin:"center center",filter:Q?"saturate(1.05) contrast(1.25) brightness(0.86)":"saturate(1.25) contrast(1.12) brightness(1.04)",imageRendering:"crisp-edges"},Ie=!!(fe.getMediaStream?.()||(x.current?.srcObject??null))?.getVideoTracks()?.length,Ue=Be&&!ht;return e.jsxs("div",{className:"relative h-full rounded-xl overflow-hidden bg-black",children:[e.jsxs("div",{className:"relative w-full h-full bg-black",children:[e.jsx("video",{ref:Qt,className:F,style:ue,playsInline:!0,muted:!0,autoPlay:!0}),e.jsx("canvas",{ref:pt,className:"absolute inset-0 w-full h-full",style:{pointerEvents:"none"}}),e.jsx("canvas",{ref:st,className:"absolute inset-0 w-full h-full",onClick:Ys}),!Ie&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-black/70 text-center px-4",children:e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"text-sm font-semibold text-white",children:Ue?"Phone camera not streaming":"Camera not running"}),e.jsxs("div",{className:"flex flex-wrap items-center justify-center gap-2 text-xs",children:[e.jsx("button",{className:"btn px-3 py-1 text-sm",onClick:()=>{try{H(!0)}catch{}qt()},children:"Start camera"}),e.jsx("button",{className:"btn btn--ghost px-3 py-1 text-sm",onClick:Yr,children:"Use local device"}),e.jsx("button",{className:"btn btn--ghost px-3 py-1 text-sm",onClick:Xt,children:"Reconnect phone"})]})]})})]}),e.jsx("canvas",{ref:tt,className:"hidden"})]})},uo=i.useCallback(()=>{try{if(typeof document>"u")return;const d=x.current||fe.getVideoElementRef?.()||null;if(!d){console.warn("[CameraView] capture requested without video element");return}const y=d.videoWidth||d.clientWidth||0,F=d.videoHeight||d.clientHeight||0;if(!y||!F){console.warn("[CameraView] capture aborted: video has no dimensions");return}const W=document.createElement("canvas");W.width=y,W.height=F;const Q=W.getContext("2d");if(!Q){console.warn("[CameraView] capture aborted: no 2d context");return}Q.drawImage(d,0,0,y,F),W.toBlob(ue=>{if(!ue)return;const Ce=URL.createObjectURL(ue),Ie=new Date().toISOString().replace(/[:.]/g,"-"),Ue=document.createElement("a");Ue.href=Ce,Ue.download=`ndn-capture-${Ie}.png`,document.body.appendChild(Ue),Ue.click(),document.body.removeChild(Ue),window.setTimeout(()=>URL.revokeObjectURL(Ce),4e3)},"image/png")}catch(d){console.warn("[CameraView] capture failed",d)}},[fe]);i.useEffect(()=>{try{if(q||w)return;const d=He.find(y=>/obs|virtual/i.test(String(y.label||"")));d&&ce(d.deviceId,d.label||"",!0)}catch{}},[He,w,q,ce]),i.useEffect(()=>{try{$r.getState().setCalibrationStatus({hasHomography:!!at,imageSize:p})}catch{}},[at,p]),i.useEffect(()=>{try{if(!st.current||!p)return;const d=st.current;typeof p.w=="number"&&typeof p.h=="number"&&(d.width!==p.w||d.height!==p.h)&&(d.width=p.w,d.height=p.h)}catch{}},[st,p]),i.useEffect(()=>{if($!=="external-ws"||!j)return;const d=ym(j,y=>{if(!ps.current||performance.now()-zr.current<5e3)return;const F=y.ring,W=Number(y.value)||0,Q=y.sector??null,ue=Math.max(0,Number(y.mult)||0);let Ce="";if(F==="MISS"?Ce="MISS":F==="BULL"?Ce="25":F==="INNER_BULL"?Ce="BULL 50":Q!=null?Ce=`${ue===3?"T":ue===2?"D":""}${Q}`:Ce=`${F} ${W>0?W:""}`.trim(),!Ns({value:W,label:Ce,ring:F,confidence:y?.confidence,meta:{calibrationValid:!1,pBoard:null,source:"camera"}}))if(s)try{s(y.value,y.ring,{sector:y.sector??null,mult:y.mult??0})}catch{}else ar(y.value,Ce,y.ring,{calibrationValid:!1,pBoard:null,source:"camera"})});return()=>d.close()},[$,j,Ns]);function Ys(d){if(!st.current||!at||!p)return;const y=st.current.getBoundingClientRect(),F=d.clientX-y.left,W=d.clientY-y.top,Q=st.current.width&&p.w?st.current.width/p.w:1,ue=st.current.height&&p.h?st.current.height/p.h:1,Ce={x:F/Q,y:W/ue},Ie=xm(at,Ce,ye??0,Fe??0,Ze??0),Ue=`${Ie.ring} ${Ie.base>0?Ie.base:""}`.trim();tr(Ue),Zt(Ie.base),an(Ie.ring),Xe(!0);try{a&&s&&(s(Ie.base,Ie.ring,{sector:Ie.sector,mult:Ie.mult}),Xe(!1))}catch{}}function mo(d){const y=d.trim().toUpperCase();if(!y)return null;const F=y==="BULL"||y==="50"||y==="DBULL"||y==="IBULL",W=y==="25"||y==="OBULL";if(F)return{label:"INNER_BULL 50",value:50,ring:"INNER_BULL"};if(W)return{label:"BULL 25",value:25,ring:"BULL"};const Q=y.match(/^(S|D|T)?\s*(\d{1,2})$/);if(!Q)return null;const ue=Q[1]||"S",Ce=parseInt(Q[2],10);if(Ce<1||Ce>20)return null;const Ie=ue==="S"?1:ue==="D"?2:3,Ue=ue==="S"?"SINGLE":ue==="D"?"DOUBLE":"TRIPLE";return{label:`${ue}${Ce} ${Ce*Ie}`,value:Ce*Ie,ring:Ue}}function Ks(){const d=et;if(!d.players.length)return d.startingScore;const y=d.players[d.currentPlayerIdx],F=y.legs[y.legs.length-1];return F?F.totalScoreRemaining:d.startingScore}function Xs(d){if(ge&&!(typeof d!="number"||!Number.isFinite(d)))try{const y=window.speechSynthesis;if(!y)return;const F=new SpeechSynthesisUtterance,W=Math.round(d);if(F.text=`${W} millimetres`,F.rate=.95,F.pitch=1,ne){const Q=y.getVoices().find(ue=>ue.name===ne);Q&&(F.voice=Q)}F.volume=typeof Ae=="number"?Math.max(0,Math.min(1,Ae)):1;try{y.cancel()}catch{}y.speak(F)}catch{}}function Pr(d){if(ge)try{const y=et.players[et.currentPlayerIdx]?.name,F=Ks();fc(y||"Player",d,Math.max(0,F),ne,{volume:Ae,checkoutOnly:Pe})}catch{}}function ar(d,y,F,W){if(St&&Pt)try{Rn("event")}catch{}const Q=W??{calibrationValid:!1,pBoard:null,source:"manual"};if(c==="custom"){if(!Q.__allowMultipleBullUp){if(Hr.current)return;Hr.current=!0}if(l)try{l(d,F,{label:y})}catch{}if((vt.current||0)>=3){Lt(1),It(d),Ot([{label:y,value:d,ring:F,meta:Q}]);try{Fn.getState().setVisit([{label:y,value:d,ring:F,meta:Q}],1,d)}catch{}try{Q.source==="camera"&&xr()}catch{}return}const pe=lt+1;Lt(pe),vt.current=pe,It(Oe=>Oe+d),Ot(Oe=>[...Oe,{label:y,value:d,ring:F,meta:Q}]);try{const Oe=[...Je,{label:y,value:d,ring:F,meta:Q}],wt=Oe.reduce((At,Vt)=>At+(Number(Vt?.value)||0),0);Fn.getState().setVisit(Oe,pe,wt)}catch{}return}if((vt.current||0)>=3){const pe=en,Oe=lt,wt=me(Je);Y(pe,Oe,{preOpenDarts:fr||0,doubleWindowDarts:Vn||0,finishedByDouble:!1,visitTotal:pe,entries:wt});try{const jn=et.players[et.currentPlayerIdx]?.name;jn&&Nr(jn,Oe,pe)}catch{}const At=!sr||R||F==="DOUBLE"||F==="INNER_BULL",Vt=At?d:0;Lt(1),vt.current=1,It(Vt),Ot([{label:y,value:Vt,ring:F,meta:Q}]);try{Fn.getState().setVisit([{label:y,value:Vt,ring:F,meta:Q}],1,Vt)}catch{}try{Q.source==="camera"&&xr()}catch{}Ht(At?0:1),hn(0),sr&&!R&&(F==="DOUBLE"||F==="INNER_BULL")&&_(!0),zn({score:pe,darts:Oe,finished:!1});return}const ue=(vt.current||0)+1,Ie=!sr||R||F==="DOUBLE"||F==="INNER_BULL"?d:0;sr&&!R&&(F==="DOUBLE"||F==="INNER_BULL")&&_(!0);const Ue=en+Ie,Se=Ks()-Ue,Ke=Se===0&&(F==="DOUBLE"||F==="INNER_BULL");if(Se<0||Se===1||Se===0&&!Ke){const pe=me([...Je,{label:y,value:Ie,ring:F}]),wt=(fr||0)+(sr&&!R&&!(F==="DOUBLE"||F==="INNER_BULL")?1:0),At=Se,Vt=Se+Ie,jn=Vt>50&&At<=50||Vt<=50?1:0,Rr=(Vn||0)+jn;Y(0,ue,{preOpenDarts:wt,doubleWindowDarts:Rr,finishedByDouble:!1,visitTotal:0,entries:pe}),St&&Pr(0),Lt(0),vt.current=0,It(0),Ot([]),_t([]),Ht(0),hn(0),zn({score:0,darts:ue,finished:!1});try{Fn.getState().reset()}catch{}return}Lt(ue),vt.current=ue,It(Ue),Ot(pe=>{const Oe=[...pe,{label:y,value:Ie,ring:F,meta:Q}];try{const wt=Oe.reduce((At,Vt)=>At+(Number(Vt?.value)||0),0);Fn.getState().setVisit(Oe,ue,wt)}catch{}return Oe});try{let pe=W?.__tipVideoPx??null;pe||(pe=Ir.current.lastTip??null),pe&&typeof pe.x=="number"&&typeof pe.y=="number"&&(_t(Oe=>[...Oe,{x:pe.x,y:pe.y,label:y}]),Hs({x:pe.x,y:pe.y,expires:Date.now()+2e3}))}catch{}try{Q.source==="camera"&&xr()}catch{}St&&(Ke||ue===3)&&Pr(Ue),sr&&!R&&!(F==="DOUBLE"||F==="INNER_BULL")&&Ht(pe=>(pe||0)+1);{const pe=Se,Oe=Se+Ie;(Oe>50&&pe<=50||Oe<=50)&&hn(At=>(At||0)+1)}if(Ke){const pe=me([...Je,{label:y,value:Ie,ring:F}]),Oe=Gr();Y(Ue,ue,{preOpenDarts:fr||0,doubleWindowDarts:Vn||0,finishedByDouble:!0,visitTotal:Ue,entries:pe}),he(Ue),Lt(0),vt.current=0,It(0),Ot([]),_t([]),Ht(0),hn(0),zn({score:Ue,darts:ue,finished:!0,meta:{label:y,ring:F,entries:pe,frame:Oe}});try{Fn.getState().reset()}catch{}return}if(ue>=3){const pe=me([...Je,{label:y,value:Ie,ring:F}]);Y(Ue,ue,{preOpenDarts:fr||0,doubleWindowDarts:Vn||0,finishedByDouble:!1,visitTotal:Ue,entries:pe});try{Q.source==="camera"&&xr()}catch{}Lt(0),vt.current=0,It(0),Ot([]),_t([]),Ht(0),hn(0),zn({score:Ue,darts:ue,finished:!1});try{Fn.getState().reset()}catch{}}}function gc(){if(!(St&&Pt)&&zt){if(s)try{s(sn,$t,void 0)}catch{}else ar(sn,zt,$t);ke(0),Xe(!1)}}function Cs(){if(St&&Pt)return;const d=mo(nr);if(!d){alert("Enter like T20, D16, 5, 25, 50");return}if(!Re||!zt||$t==="MISS"||sn===0){const y=xe+1;ke(y),y>=5&&Ee(!0)}else ke(0);ar(d.value,d.label,d.ring),xt(""),Xe(!1)}function ho(){if(St&&Pt)return;const d=mo(nr);if(!d){alert("Enter like T20, D16, 5, 25, 50");return}if(lt===0||Je.length===0){Cs();return}if(c==="custom"){if(!Re||!zt||$t==="MISS"||sn===0){const Se=xe+1;ke(Se),Se>=5&&Ee(!0)}else ke(0);if(Ot(Se=>[...Se.slice(0,-1),{label:d.label,value:d.value,ring:d.ring}]),b)try{b(d.value,d.ring,{label:d.label})}catch{}xt(""),Xe(!1);return}if(!Re||!zt||$t==="MISS"||sn===0){const Se=xe+1;ke(Se),Se>=5&&Ee(!0)}else ke(0);const y=Je[Je.length-1],F=lt-1,W=en-(y?.value||0),Q=Ks(),ue=W+d.value,Ce=F+1,Ie=Q-ue,Ue=Ie===0&&(d.ring==="DOUBLE"||d.ring==="INNER_BULL");if(Ie<0||Ie===1||Ie===0&&!Ue){Y(0,Ce);try{const Se=et.players[et.currentPlayerIdx]?.name;Se&&Nr(Se,Ce,0)}catch{}St&&Pr(0),Lt(0),vt.current=0,It(0),Ot([]),_t([]),zn({score:0,darts:Ce,finished:!1}),xt(""),Xe(!1);return}if(Lt(Ce),vt.current=Ce,It(ue),Ot(Se=>[...Se.slice(0,-1),{label:d.label,value:d.value,ring:d.ring}]),St&&(Ue||Ce===3)&&Pr(ue),Ue){Y(ue,Ce),he(ue);try{const Se=et.players[et.currentPlayerIdx]?.name;Se&&Nr(Se,Ce,ue)}catch{}Lt(0),vt.current=0,It(0),Ot([]),_t([]),zn({score:ue,darts:Ce,finished:!0}),xt(""),Xe(!1);return}if(Ce>=3){Y(ue,Ce);try{const Se=et.players[et.currentPlayerIdx]?.name;Se&&Nr(Se,Ce,ue)}catch{}Lt(0),vt.current=0,It(0),Ot([]),_t([]),zn({score:ue,darts:Ce,finished:!1})}xt(""),Xe(!1)}i.useEffect(()=>{function d(y){try{const W=document.activeElement?.tagName?.toLowerCase();y.key==="m"&&W!=="input"&&W!=="textarea"&&(Tt("manual"),Ye(!0))}catch{}}return window.addEventListener("keydown",d),()=>window.removeEventListener("keydown",d)},[]);function fo(d,y){if(lt>=3||St&&Pt)return;const F=d*(y==="S"?1:y==="D"?2:3),W=y==="S"?"SINGLE":y==="D"?"DOUBLE":"TRIPLE";if(!Re||!zt||$t==="MISS"||sn===0){const Q=xe+1;ke(Q),Q>=5&&Ee(!0)}else ke(0);ar(F,`${y}${d} ${F}`,W),Xe(!1)}function bc(){if(lt===0)return;const d=Je[Je.length-1];Lt(y=>y-1),vt.current=Math.max(0,(vt.current||0)-1),It(y=>y-(d?.value||0)),Ot(y=>y.slice(0,-1))}function po(){if(lt===0||St&&Pt)return;if(Kn){try{window.alert("Cannot commit: pending camera detections require camera connection validation for online matches")}catch{}return}if(c==="custom"){Lt(0),vt.current=0,vt.current=0,It(0),Ot([]),_t([]);return}const d=en,y=lt,F=me(Je);Y(d,y,{entries:F,visitTotal:d});try{const W=et.players[et.currentPlayerIdx]?.name;W&&Nr(W,y,d)}catch{}Lt(0),vt.current=0,It(0),Ot([]),_t([]),zn({score:d,darts:y,finished:!1})}const xc=e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-4 w-full min-w-0",children:[r&&e.jsx("div",{className:"lg:col-span-2",children:e.jsx("div",{className:"flex items-center gap-2 mb-2",children:e.jsx("button",{className:`btn px-3 py-1 text-sm ${We==="manual"?"tab--active":""}`,onClick:()=>{Tt("manual"),Ye(!0)},title:"Open Manual Correction",children:"Manual Correction"})})}),o?null:e.jsx("div",{className:"card relative camera-fullwidth-card lg:col-span-2 w-full min-w-0",children:e.jsxs("div",{className:"camera-fullwidth-body flex flex-col gap-4 w-full min-w-0",children:[e.jsx("h2",{className:"text-xl font-semibold mb-3",children:"Camera"}),e.jsxs(Yo,{storageKey:"ndn:camera:size",className:"relative rounded-2xl overflow-hidden bg-black w-full",defaultWidth:480,defaultHeight:360,minWidth:360,minHeight:270,maxWidth:800,maxHeight:600,autoFill:!0,children:[e.jsx(lo,{}),(()=>{const d=T||ve.getState().cameraAspect||"wide",y=(M||ve.getState().cameraFitMode||"fit")==="fit",F=d==="square"?"absolute left-0 top-1/2 -translate-y-1/2 min-w-full min-h-full object-cover object-left bg-black":y?"absolute inset-0 w-full h-full object-contain object-center bg-black":"absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 min-w-full min-h-full w-auto h-auto object-cover object-center bg-black ndn-video-smooth",W=N??1,Q=typeof window<"u"&&(window.localStorage?.getItem("ndn.glareDimming")==="1"||window.localStorage?.getItem("ndn.glareClamp")==="1"),ue={transform:`scale(${W})`,transformOrigin:"center center",filter:Q?"saturate(1.05) contrast(1.25) brightness(0.86)":"saturate(1.25) contrast(1.12) brightness(1.04)",imageRendering:"crisp-edges"},Ce=d==="square"?"relative w-full mx-auto aspect-square bg-black":"relative w-full aspect-[4/3] bg-black",Ie=()=>e.jsxs("div",{className:`camera-viewport ${Ce}`,children:[e.jsx("video",{ref:Qt,className:F,style:ue,playsInline:!0,muted:!0,autoPlay:!0}),e.jsx("canvas",{ref:st,className:"absolute inset-0 w-full h-full",onClick:Ys}),e.jsxs("div",{className:"absolute top-2 left-1/2 -translate-x-1/2 z-20 flex items-center gap-3 cursor-pointer select-none",onDoubleClick:Or,"aria-label":`Visit status: ${Je[0]?Je[0].value>0?"hit":"miss":"pending"}, ${Je[1]?Je[1].value>0?"hit":"miss":"pending"}, ${Je[2]?Je[2].value>0?"hit":"miss":"pending"}`,children:[[0,1,2].map(Ue=>{const gt=Je[Ue],Se=De[Ue],Ke=!gt,ut=!!gt&&Se===Nn,pe=typeof gt?.value=="number"?gt.value>0:!1,Oe=(gt?.ring&&gt.ring!=="MISS")??!1,At=ut?ut&&(pe||Oe)?"bg-emerald-400":"bg-rose-500":"bg-gray-500/70",Vt=ut&&!Ke;return e.jsx("span",{className:`visit-dot ${Vt?"active":"inactive"} ${At}`},Ue)}),ot&&kt!==null&&e.jsxs("span",{className:"px-2 py-0.5 rounded bg-black/60 text-white text-xs font-semibold",children:[Math.max(0,kt),"s"]})]}),St&&Pt?e.jsx("div",{className:"absolute bottom-3 left-1/2 -translate-x-1/2 z-20 bg-black/70 text-amber-200 text-xs font-semibold px-3 py-1 rounded-full shadow",children:"Remove darts to continue"}):null]});return Be?ht?Ie():e.jsx("div",{className:"w-full h-full flex flex-col items-center justify-center bg-gradient-to-br from-blue-900/50 to-purple-900/50",children:e.jsxs("div",{className:"text-center space-y-3 max-w-xs mx-auto",children:[e.jsx("div",{className:"text-2xl font-semibold",children:"CAM"}),e.jsx("div",{className:"text-lg font-semibold text-blue-100",children:"Phone camera selected"}),e.jsx("p",{className:"text-sm text-slate-300",children:"Start streaming from the Calibrator tab or reconnect below."}),e.jsxs("div",{className:"flex items-center justify-center gap-2 flex-wrap",children:[e.jsx("button",{className:"btn bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 text-sm",onClick:Xt,children:"Reconnect Phone"}),e.jsx("button",{className:"btn bg-slate-700 hover:bg-slate-800 text-white px-3 py-1 text-sm",onClick:()=>{try{fe.setShowOverlay?.(!0)}catch{}},children:"Show Overlay"}),e.jsx("button",{className:"btn bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-1 text-sm",onClick:Yr,disabled:!He.length,children:"Use Local Camera"})]})]})}):Ie()})()]}),e.jsxs("div",{className:"mt-3 flex flex-wrap items-center gap-2 text-xs",children:[e.jsx("span",{className:"uppercase tracking-wide text-slate-400",children:"Cam"}),e.jsx("button",{className:"btn btn--ghost px-2 py-1",onClick:()=>qr(-.05),title:"Decrease camera zoom",children:"-"}),e.jsxs("span",{className:"w-10 text-center font-semibold text-white",children:[Math.round((N??1)*100),"%"]}),e.jsx("button",{className:"btn btn--ghost px-2 py-1",onClick:()=>qr(.05),title:"Increase camera zoom",children:"+"}),e.jsx("button",{className:`btn btn--ghost px-3 py-1 text-[11px] ${M==="fill"?"bg-emerald-500 text-white":""}`,onClick:Gs,title:"Show dartboard only",children:"Full"}),e.jsx("button",{className:`btn btn--ghost px-3 py-1 text-[11px] ${M!=="fill"?"bg-slate-200 text-slate-900":""}`,onClick:Mr,title:"Letterbox to wide view",children:"Wide"})]}),e.jsx("div",{className:"mt-3 text-xs text-slate-400",children:"Manual scoring active Â· camera preview only."}),v?e.jsx("div",{className:"sr-only","aria-hidden":"true",children:e.jsx("button",{"data-testid":"commit-visit-btn",onClick:po,disabled:lt===0||Kn,children:"Commit"})}):null,e.jsxs("div",{className:"mt-3 rounded-2xl border border-white/10 bg-slate-900/60 p-3",children:[e.jsx("div",{className:"mb-2 text-[11px] uppercase tracking-wide text-slate-400",children:"Camera controls"}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[Be?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:`text-sm px-3 py-2 rounded border flex-1 min-w-[200px] ${ht?"bg-emerald-500/10 border-emerald-400/40 text-emerald-100":"bg-amber-500/10 border-amber-400/40 text-amber-100"}`,children:ht?"CAM Phone camera stream active":"CAM Waiting for phone camera stream"}),e.jsx("button",{className:"btn bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 text-sm",onClick:Xt,children:"Reconnect Phone"}),e.jsx("button",{className:"btn bg-slate-700 hover:bg-slate-800 text-white px-3 py-1 text-sm",onClick:()=>{try{fe.setShowOverlay?.(!fe.showOverlay)}catch{}},children:fe.showOverlay?"Hide Overlay":"Show Overlay"}),e.jsx("button",{className:"btn bg-rose-600 hover:bg-rose-700 text-white px-3 py-1 text-sm",disabled:!ht,onClick:()=>{try{fe.clearSession?.()}catch{}},children:"Stop Phone Feed"}),Jt&&e.jsx("button",{className:"btn bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-1 text-sm",onClick:Yr,disabled:!He.length,children:"Use Local Camera"})]}):e.jsx(e.Fragment,{children:E?e.jsx("button",{className:"btn bg-rose-600 hover:bg-rose-700",onClick:Qn,children:"Stop Camera"}):e.jsx("button",{className:"btn",onClick:qt,disabled:Te,children:Te?"Connecting Camera...":"Connect Camera"})}),!we,e.jsx("button",{className:"btn btn--ghost px-3 py-1 text-sm",onClick:()=>I(!G),title:"Toggle the board guide overlay",children:G?"Show board guides":"Hide board guides"}),e.jsx("button",{className:"btn",onClick:uo,disabled:!_e,children:"Capture Still"}),et?.inProgress&&e.jsxs(e.Fragment,{children:[e.jsx(mc,{compact:!0}),e.jsx("button",{className:"btn bg-rose-600 hover:bg-rose-700 text-white px-3 py-1 text-sm",onClick:()=>An(!0),children:"Quit / Pause"}),hr&&e.jsx(wm,{onClose:()=>An(!1),onQuit:()=>{try{window.dispatchEvent(new CustomEvent("ndn:match-quit"));try{Un({type:"quit"})}catch{}}catch{}An(!1)},onPause:d=>{const y=Date.now()+d*60*1e3;try{on.getState().setPaused(!0,y);try{Un({type:"pause",pauseEndsAt:y,pauseStartedAt:Date.now()})}catch{}}catch{}An(!1)}}),e.jsx("button",{className:"btn btn--ghost px-3 py-1 text-sm",onClick:()=>{try{ga(),window.open(`${window.location.origin}${window.location.pathname}?match=1`,"_blank")}catch{}},children:"Open match in new window"}),e.jsx("button",{className:"btn btn--ghost px-3 py-1 text-sm",onClick:async()=>{try{document.documentElement.requestFullscreen?await document.documentElement.requestFullscreen():document.body.requestFullscreen&&await document.body.requestFullscreen()}catch{}},children:"Open full screen"})]}),e.jsx("button",{className:"btn bg-slate-700 hover:bg-slate-800",onClick:()=>{try{window.dispatchEvent(new Event("ndn:camera-reset"))}catch{}},children:"Reset Camera Size"})]})]})]})}),v?e.jsx("div",{className:"fixed bottom-6 right-6 z-50",children:e.jsx("button",{className:"btn btn--primary rounded-full w-12 h-12 flex items-center justify-center shadow-lg",title:"Open Manual Correction (M)",onClick:()=>{Tt("manual"),Ye(!0)},children:"??"})}):null,e.jsx("canvas",{ref:tt,className:"hidden"}),On&&e.jsx("div",{className:"fixed inset-0 bg-black/70 z-[99999]",role:"dialog","aria-modal":"true",children:e.jsx("div",{className:"absolute inset-0 flex items-start justify-center p-6 pt-16",children:e.jsxs("div",{className:"card w-full max-w-lg mx-auto",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Confirm detected dart"}),e.jsx("button",{className:"btn btn--ghost",onClick:()=>Pn(null),children:"Close"})]}),e.jsx("div",{className:"text-sm opacity-80 mb-3",children:"This hit was detected with lower confidence."}),e.jsxs("div",{className:"flex flex-col gap-2 mb-3",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-semibold",children:"Detected:"})," ",On.label]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-semibold",children:"Confidence:"})," ",On.confidence.toFixed(2)]})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx("button",{className:"btn",onClick:()=>{try{ar(On.value,On.label,On.ring,On.meta)}catch{}Pn(null)},children:"Accept"}),e.jsx("button",{className:"btn btn--ghost",onClick:()=>Pn(null),children:"Reject"}),e.jsx("button",{className:"btn bg-slate-700 hover:bg-slate-800",onClick:()=>{Pn(null),Ye(!0),Tt("manual")},children:"Open Manual Correction"})]})]})})}),bt&&e.jsx("div",{className:"fixed inset-0 bg-black/60 z-[100]",role:"dialog","aria-modal":"true",children:e.jsx("div",{className:"absolute inset-0 flex flex-col",children:e.jsxs(ur,{returnFocus:!0,children:[e.jsxs("div",{className:"p-3 md:p-4 flex items-center justify-between",children:[e.jsx("h3",{className:"text-xl md:text-2xl font-semibold",children:"Manual Correction"}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("button",{className:"btn bg-slate-700 hover:bg-slate-800",onClick:()=>{Ye(!1)},children:"Close"})})]}),e.jsx("div",{className:"flex-1 p-3 md:p-4",children:e.jsxs("div",{className:"h-full grid grid-cols-1 lg:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"card relative flex flex-col",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"Live Preview"}),e.jsx("div",{className:"relative flex-1 rounded-2xl overflow-hidden bg-black",children:e.jsx("canvas",{ref:Le,className:"absolute inset-0 w-full h-full"})})]}),e.jsxs("div",{className:"card flex flex-col",children:[e.jsx("div",{className:"text-sm opacity-80 mb-2",children:"Type a correction or replace the last dart. The preview updates live."}),e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("span",{className:"font-semibold",children:"Last auto:"}),e.jsx("span",{children:zt||"ï¿½"}),e.jsx("button",{className:"btn",onClick:gc,disabled:lt>=3,children:"Add Auto Dart"})]}),e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("input",{className:"input flex-[1.2]",placeholder:"Manual (T20, D16, 5, 25, 50)",value:nr,onChange:d=>xt(d.target.value),onKeyDown:d=>{d.key==="Enter"&&!d.shiftKey&&(d.preventDefault(),Cs()),d.key==="Enter"&&d.shiftKey&&(d.preventDefault(),ho())}}),e.jsx("button",{className:"btn btn--ghost",onClick:ho,disabled:lt===0,children:"Replace Last"}),e.jsx("button",{className:"btn",onClick:Cs,disabled:lt>=3,children:"Add"})]}),e.jsx("div",{className:"text-xs opacity-70 mb-4",children:"Press Enter to Add ï¿½ Shift+Enter to Replace Last"}),e.jsxs("div",{className:"mb-4",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"Number pad"}),e.jsxs("div",{className:"grid grid-cols-3 gap-2 max-w-sm",children:[["7","8","9","4","5","6","1","2","3","0"].map(d=>e.jsx("button",{className:"btn text-lg",onClick:()=>{xt(y=>/^[SDT]/i.test(y)?y+d:(y||"")+d)},children:d},d)),e.jsx("button",{className:"btn bg-rose-600 hover:bg-rose-700 text-white",onClick:()=>xt(""),children:"Clear"}),e.jsx("button",{className:"btn bg-slate-600 hover:bg-slate-700 text-white",onClick:()=>xt(d=>(d||"").slice(0,-1)),children:"?"}),e.jsx("button",{className:"btn bg-emerald-600 hover:bg-emerald-700 text-white",onClick:()=>Cs(),disabled:lt>=3,children:"Enter"})]}),e.jsx("div",{className:"text-xs opacity-70 mt-2",children:"Tap numbers then press Enter to submit. Use D/T prefixes for doubles/trebles (e.g., D16)."})]}),e.jsxs("div",{className:"mt-auto",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"Quick entry"}),e.jsxs("div",{className:"flex flex-wrap gap-2 mb-3",children:[e.jsx("button",{className:"btn",disabled:lt>=3,onClick:()=>{if(!Re||!zt||$t==="MISS"||sn===0){const d=xe+1;ke(d),d>=5&&Ee(!0)}else ke(0);ar(25,"BULL 25","BULL"),Xe(!1)},children:"25"}),e.jsx("button",{className:"btn",disabled:lt>=3,onClick:()=>{if(!Re||!zt||$t==="MISS"||sn===0){const d=xe+1;ke(d),d>=5&&Ee(!0)}else ke(0);ar(50,"INNER_BULL 50","INNER_BULL"),Xe(!1)},children:"50"})]}),e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx("input",{className:"input w-full max-w-sm",list:"manual-quick-list",placeholder:"Type or select (e.g., D16, T20, S5)",value:Ve,onChange:d=>qe(d.target.value.toUpperCase()),onKeyDown:d=>{if(d.key==="Enter"){const y=Ve.match(/^(S|D|T)(\d{1,2})$/);y&&fo(parseInt(y[2],10),y[1])}}}),e.jsx("datalist",{id:"manual-quick-list",children:["D","S","T"].map(d=>Array.from({length:20},(y,F)=>F+1).map(y=>e.jsx("option",{value:`${d}${y}`},`${d}${y}`)))}),e.jsx("button",{className:"btn",disabled:!Ve||lt>=3,onClick:()=>{const d=Ve.match(/^(S|D|T)(\d{1,2})$/);if(!d)return;const y=d[1],F=parseInt(d[2],10);fo(F,y)},children:"Add"})]})]})]})]})})]})})}),Bt&&e.jsx("div",{className:"fixed inset-0 bg-black/60 z-[100] flex items-center justify-center",children:e.jsx(ur,{returnFocus:!0,children:e.jsxs("div",{className:"card w-full max-w-4xl relative text-left bg-[#2d2250] text-white p-6 rounded-xl shadow-xl",role:"dialog","aria-modal":"true",children:[e.jsx("button",{className:"absolute top-2 right-2 btn px-2 py-1 bg-purple-500 text-white font-bold",onClick:()=>ft(!1),"aria-label":"Close scoring dialog",children:"Close"}),e.jsx("h2",{className:"text-xl font-bold mb-4 flex items-center gap-2 text-white",children:"Scoring"}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"bg-black/30 rounded-2xl p-4",children:[e.jsx("h2",{className:"text-lg font-semibold mb-3",children:"Camera"}),e.jsxs(Yo,{storageKey:"ndn:camera:size:modal",className:"relative rounded-2xl overflow-hidden bg-black",defaultWidth:480,defaultHeight:360,minWidth:360,minHeight:270,maxWidth:800,maxHeight:600,children:[e.jsx(lo,{}),(()=>{const y=(ve.getState().cameraFitMode||"fit")==="fit"?"absolute inset-0 w-full h-full object-contain object-center bg-black ndn-video-smooth":"absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 min-w-full min-h-full w-auto h-auto object-cover object-center bg-black ndn-video-smooth",F=()=>e.jsxs("div",{className:"relative w-full aspect-[4/3] bg-black",children:[e.jsx("video",{ref:Qt,className:y,style:videoStyle,playsInline:!0,muted:!0,autoPlay:!0}),e.jsx("canvas",{ref:st,className:"absolute inset-0 w-full h-full",onClick:Ys}),e.jsxs("div",{className:"absolute top-2 left-1/2 -translate-x-1/2 z-20 flex items-center gap-3","aria-label":`Visit status: ${Je[0]?Je[0].value>0?"hit":"miss":"pending"}, ${Je[1]?Je[1].value>0?"hit":"miss":"pending"}, ${Je[2]?Je[2].value>0?"hit":"miss":"pending"}`,children:[[0,1,2].map(W=>{const Q=Je[W],ue=!Q,Ce=!!Q&&(typeof Q.value=="number"?Q.value>0:!0),Ie=ue?"bg-gray-500/70":Ce?"bg-emerald-400":"bg-rose-500";return e.jsx("span",{className:`w-3 h-3 rounded-full shadow ${Ie}`},W)}),ot&&kt!==null&&e.jsxs("span",{className:"px-2 py-0.5 rounded bg-black/60 text-white text-xs font-semibold",children:[Math.max(0,kt),"s"]})]}),St&&Pt?e.jsx("div",{className:"absolute bottom-3 left-1/2 -translate-x-1/2 z-20 bg-black/70 text-amber-200 text-xs font-semibold px-3 py-1 rounded-full shadow",children:"Remove darts to continue"}):null]});return Be?ht?F():e.jsx("div",{className:"w-full h-full flex flex-col items-center justify-center bg-gradient-to-br from-blue-900/50 to-purple-900/50",children:e.jsxs("div",{className:"text-center space-y-3 max-w-xs mx-auto",children:[e.jsx("div",{className:"text-2xl font-semibold",children:"CAM"}),e.jsx("div",{className:"text-lg font-semibold text-blue-100",children:"Phone camera selected"}),e.jsx("p",{className:"text-sm text-slate-300",children:"Start streaming from the Calibrator tab or reconnect below."}),e.jsxs("div",{className:"flex items-center justify-center gap-2 flex-wrap",children:[e.jsx("button",{className:"btn bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 text-sm",onClick:Xt,children:"Reconnect Phone"}),e.jsx("button",{className:"btn bg-slate-700 hover:bg-slate-800 text-white px-3 py-1 text-sm",onClick:()=>{try{fe.setShowOverlay?.(!0)}catch{}},children:"Show Overlay"}),e.jsx("button",{className:"btn bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-1 text-sm",onClick:Yr,disabled:!He.length,children:"Use Local Camera"})]})]})}):F()})()]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2 mt-3",children:[Be?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:`text-sm px-3 py-2 rounded border flex-1 min-w-[200px] ${ht?"bg-emerald-500/10 border-emerald-400/40 text-emerald-100":"bg-amber-500/10 border-amber-400/40 text-amber-100"}`,children:ht?"?? Phone camera stream active":"?? Waiting for phone camera stream"}),e.jsx("button",{className:"btn bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 text-sm",onClick:Xt,children:"Reconnect Phone"}),e.jsx("button",{className:"btn bg-slate-700 hover:bg-slate-800 text-white px-3 py-1 text-sm",onClick:()=>{try{fe.setShowOverlay?.(!fe.showOverlay)}catch{}},children:fe.showOverlay?"Hide Overlay":"Show Overlay"}),e.jsx("button",{className:"btn bg-rose-600 hover:bg-rose-700 text-white px-3 py-1 text-sm",disabled:!ht,onClick:()=>{try{fe.clearSession?.()}catch{}},children:"Stop Phone Feed"}),Jt&&e.jsx("button",{className:"btn bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-1 text-sm",onClick:Yr,disabled:!He.length,children:"Use Local Camera"})]}):e.jsx(e.Fragment,{children:E?e.jsx("button",{className:"btn bg-gradient-to-r from-rose-600 to-rose-700 text-white font-bold",onClick:Qn,children:"Stop Camera"}):e.jsx("button",{className:"btn bg-gradient-to-r from-purple-500 to-purple-700 text-white font-bold",onClick:qt,children:"Connect Camera"})}),e.jsx("button",{className:"btn bg-gradient-to-r from-indigo-500 to-indigo-700 text-white font-bold",onClick:uo,disabled:!_e,children:"Capture Still"}),e.jsx("button",{className:"btn bg-gradient-to-r from-slate-500 to-slate-700 text-white font-bold",onClick:()=>{try{window.dispatchEvent(new Event("ndn:camera-reset"))}catch{}},children:"Reset Camera Size"})]})]}),e.jsxs("div",{className:"bg-black/30 rounded-2xl p-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx("h2",{className:"text-lg font-semibold",children:"Pending Visit"}),e.jsxs("div",{className:"flex items-center gap-2 text-xs opacity-80 ml-auto",children:[e.jsx("span",{className:`inline-block w-2.5 h-2.5 rounded-full ${rn?"bg-emerald-400":"bg-rose-500"}`}),e.jsx("span",{children:rn?"Cal OK":"Cal invalid"})]})]}),e.jsx("div",{className:"text-sm opacity-80 mb-2",children:"Up to 3 darts per visit."}),e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[[0,1,2].map(d=>{const y=Je[d],F=!y,W=!!y&&(typeof y.value=="number"?y.value>0:!0),Q=F?"bg-gray-500/70":W?"bg-emerald-400":"bg-rose-500";return e.jsx("span",{className:`w-2.5 h-2.5 rounded-full shadow ${Q}`},d)}),ot&&kt!==null&&e.jsxs("span",{className:"ml-2 px-2 py-0.5 rounded bg-black/40 text-white text-xs font-semibold",children:[Math.max(0,kt),"s"]})]}),e.jsx("ul",{className:"text-sm mb-2 list-disc pl-5",children:Je.length===0?e.jsx("li",{className:"opacity-60",children:"No darts yet"}):Je.map((d,y)=>e.jsx("li",{children:d.label},y))}),e.jsxs("div",{className:"flex items-center gap-4 mb-2",children:[e.jsxs("div",{className:"font-semibold",children:["Darts: ",lt,"/3"]}),e.jsxs("div",{className:"font-semibold",children:["Total: ",en]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{className:"btn bg-gradient-to-r from-purple-500 to-purple-700 text-white font-bold",onClick:bc,disabled:lt===0,children:"Undo Dart"}),e.jsx("button",{className:"btn bg-gradient-to-r from-emerald-500 to-emerald-700 text-white font-bold",onClick:po,disabled:lt===0||Kn,"data-testid":"commit-visit-btn",children:"Commit Visit"}),e.jsx("button",{className:"btn bg-gradient-to-r from-slate-500 to-slate-700 text-white font-bold",onClick:Ss,disabled:lt===0,children:"Clear"})]})]})]})]})})})]}),go=pc();return o&&go?go:xc}),Am=Object.freeze(Object.defineProperty({__proto__:null,default:rs},Symbol.toStringTag,{value:"Module"}));function Mm({left:t,right:n,className:r="",sticky:s=!0}){return e.jsxs("div",{className:`${s?"sticky top-0":""} card relative overflow-hidden flex items-center justify-between gap-2 mb-2 px-2 sm:px-3 py-2 rounded-xl bg-white/10 border border-white/10 z-10 backdrop-blur-sm ${r}`,children:[e.jsx("div",{className:"pointer-events-none absolute inset-0 bg-gradient-to-b from-slate-900/30 via-slate-900/10 to-transparent"}),e.jsxs("div",{className:"flex items-center gap-2 text-xs sm:text-sm leading-none flex-wrap",children:[t," ðŸŽ¯"]}),e.jsx("div",{className:"flex items-center gap-1 flex-wrap justify-end",children:n})]})}function Os({gameMode:t,players:n,matchScore:r,gameRules:s}){return!n||n.length===0?null:e.jsx("div",{className:"grid w-full grid-cols-1 sm:grid-cols-2 gap-2 mb-3",children:n.map((a,o)=>e.jsxs("div",{className:`w-full rounded-lg border p-3 ${a.isCurrentTurn?"border-emerald-500/40 bg-emerald-500/10":"border-slate-500/40 bg-slate-500/10"}`,children:[e.jsx("div",{className:`text-sm font-semibold mb-2 uppercase tracking-wide ${a.isCurrentTurn?"text-emerald-300":"text-slate-300"}`,children:a.name}),e.jsxs("div",{className:"space-y-1 text-sm",children:[t==="X01"&&e.jsxs(e.Fragment,{children:[e.jsx(rt,{label:"Legs Won",value:`â— ${a.legsWon||0}`,highlight:!0}),e.jsx(rt,{label:"Score",value:a.score||0,mono:!0,bold:!0}),e.jsx(rt,{label:"Last Score",value:a.lastScore||"0",mono:!0}),e.jsx(rt,{label:"C/Out Rate",value:`${a.checkoutRate||0}%`,mono:!0}),e.jsx(rt,{label:"Best Leg",value:a.bestLeg||"â€”",mono:!0}),a.matchAvg!==void 0&&a.allTimeAvg!==void 0&&e.jsx(e.Fragment,{children:e.jsxs("div",{className:"border-t border-white/20 pt-1 mt-1",children:[e.jsx(rt,{label:"Match Avg",value:a.matchAvg.toFixed(2),mono:!0,bold:!0,highlight:a.matchAvg>0}),e.jsx(Om,{matchAvg:a.matchAvg,allTimeAvg:a.allTimeAvg})]})})]}),(t==="Cricket"||t==="American Cricket")&&e.jsxs(e.Fragment,{children:[e.jsx(rt,{label:"Closed",value:Pm(a.closed),mono:!0}),e.jsx(rt,{label:"Points",value:a.points||0,mono:!0,bold:!0}),e.jsx(rt,{label:"Status",value:Rm(a),highlight:a.isCurrentTurn})]}),(t==="Shanghai"||t==="Halve It")&&e.jsxs(e.Fragment,{children:[e.jsx(rt,{label:t==="Shanghai"?"Round":"Stage",value:a.round||1,mono:!0}),e.jsx(rt,{label:"Target",value:a.target||"â€”",mono:!0}),e.jsx(rt,{label:"Score",value:a.score||0,mono:!0,bold:!0})]}),t==="Killer"&&e.jsxs(e.Fragment,{children:[e.jsx(rt,{label:"Target #",value:a.number||"â€”",mono:!0,bold:!0}),e.jsx(rt,{label:"Lives",value:a.lives||0,mono:!0,bold:!0}),a.eliminated&&e.jsx(rt,{label:"Status",value:"ELIMINATED",highlight:!1})]}),t==="High-Low"&&e.jsxs(e.Fragment,{children:[e.jsx(rt,{label:"Round",value:a.round||1,mono:!0}),e.jsx(rt,{label:"Target",value:a.target||"High",mono:!0}),e.jsx(rt,{label:"Score",value:a.score||0,mono:!0,bold:!0})]}),(t==="Double Practice"||t==="Treble Practice"||t==="Around the Clock")&&e.jsxs(e.Fragment,{children:[e.jsx(rt,{label:"Target",value:a.target||"â€”",mono:!0,bold:!0}),e.jsx(rt,{label:"Hits",value:a.hits||0,mono:!0,bold:!0}),a.totalNeeded&&e.jsx(rt,{label:"Progress",value:`${a.hits||0} / ${a.totalNeeded}`,mono:!0})]}),(t==="Count-Up"||t==="High Score"||t==="Low Score")&&e.jsxs(e.Fragment,{children:[e.jsx(rt,{label:"Round",value:a.round||1,mono:!0}),e.jsx(rt,{label:"Score",value:a.score||0,mono:!0,bold:!0}),t==="High Score"&&e.jsx(rt,{label:"Best",value:a.bestScore||0,mono:!0})]}),(t==="Checkout 170"||t==="Checkout 121")&&e.jsxs(e.Fragment,{children:[e.jsx(rt,{label:"Remaining",value:a.remaining||0,mono:!0,bold:!0}),e.jsx(rt,{label:"Attempts",value:a.attempts||0,mono:!0}),e.jsx(rt,{label:"Successes",value:a.successes||0,mono:!0})]}),t==="Bob's 27"&&e.jsxs(e.Fragment,{children:[e.jsx(rt,{label:"Target",value:`D${a.target||1}`,mono:!0,bold:!0}),e.jsx(rt,{label:"Score",value:a.score||0,mono:!0,bold:!0})]}),t==="Baseball"&&e.jsxs(e.Fragment,{children:[e.jsx(rt,{label:"Inning",value:a.inning||1,mono:!0}),e.jsx(rt,{label:"Score",value:a.score||0,mono:!0,bold:!0})]}),t==="Golf"&&e.jsxs(e.Fragment,{children:[e.jsx(rt,{label:"Hole",value:a.hole||1,mono:!0}),e.jsx(rt,{label:"Strokes",value:a.strokes||0,mono:!0,bold:!0})]}),t==="Tic Tac Toe"&&e.jsxs(e.Fragment,{children:[e.jsx(rt,{label:"Turn",value:a.turn||1,mono:!0}),a.winner&&e.jsx(rt,{label:"Result",value:"WINNER!",highlight:!0})]}),r&&(t==="X01"||t==="Cricket"||t==="American Cricket")&&o===1&&e.jsx("div",{className:"border-t border-white/10 pt-1 mt-1",children:e.jsx(rt,{label:"Match",value:r,mono:!0,bold:!0,highlight:!0})})]})]},o))})}function rt({label:t,value:n,mono:r=!1,bold:s=!1,highlight:a=!1}){return e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("span",{className:"opacity-70",children:[t," ðŸŽ¯:"]}),e.jsx("span",{className:`${r?"font-mono":""} ${s?"font-semibold":""} ${a?"text-emerald-300":""}`,children:n})]})}function Om({matchAvg:t,allTimeAvg:n}){const r=t-n,s=r>0,a=Math.abs(r)<.01;let o="",c="text-slate-300";return a?(o="= All-time ðŸŽ¯",c="text-slate-300"):s?(o=`+${r.toFixed(2)} vs avg ðŸŽ¯`,c="text-emerald-400"):(o=`${r.toFixed(2)} vs avg ðŸŽ¯`,c="text-orange-400"),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"opacity-70",children:"AVG vs Avg ðŸŽ¯:"}),e.jsx("span",{className:`font-mono font-semibold ${c}`,children:o})]})}function Pm(t){return!t||Object.keys(t).length===0?"â€”":Object.entries(t).filter(([r,s])=>s===3).map(([r])=>r==="25"?"B":r).join(",")||"â€”"}function Rm(t){if(!t.closed)return"Starting ðŸŽ¯";const n=Object.values(t.closed).filter(r=>r===3).length;return n===0?"No marks ðŸŽ¯":n<7?`${n}/7 ðŸŽ¯`:"Closing in ðŸŽ¯"}function Ps(...t){return t.filter(Boolean).join(" ")}function Lm(t){const{label:n,autoStart:r,forceAutoStart:s=!1,scale:a,className:o,aspect:c="inherit",style:l,fill:b=!1,tileFitModeOverride:u}=t,f=i.useRef(null),g=er(),[m,A]=i.useState(!1),[k,S]=i.useState(null),[x,w]=i.useState(null),C=i.useRef(null),[$,j]=i.useState(null),T=i.useRef(null);i.useEffect(()=>{C.current=x},[x]);const M=i.useCallback((H,I="local")=>{try{H?(g.setMediaStream(H),g.setMode(I),g.setStreaming(!0),T.current=I):T.current&&T.current!=="phone"&&(g.setStreaming(!1),g.setMediaStream(null),T.current=null)}catch{}},[g]),N=i.useCallback(async()=>{try{const H=f.current;if(!H)return!1;const I=g.getMediaStream?.()||null,B=(I?.getVideoTracks?.()||[]).filter(K=>K.readyState==="live");if(!I||B.length===0)return!1;const de=await ms({video:H,stream:I,onPlayError:K=>console.warn("[CameraTile] Play failed:",K)});if(A(!!de.played),de.played)try{const K=g.getVideoElementRef?.();(!K||K===H)&&g.setVideoElementRef?.(H)}catch{}return!!de.played}catch{return!1}},[g]),P=ve(H=>H.preferredCameraLabel),[L,V]=i.useState(()=>P==="Phone Camera"?"phone":localStorage.getItem("ndn:camera:mode")||"local"),[U,te]=i.useState(null),[ie,ae]=i.useState(null);i.useEffect(()=>{localStorage.setItem("ndn:camera:mode",L)},[L]),i.useEffect(()=>{const H=window.location.hostname;(H==="localhost"||H==="127.0.0.1")&&xn("/api/hosts").then(I=>I.json()).then(I=>{const B=Array.isArray(I?.hosts)&&I.hosts.find(de=>de);B&&te(B)}).catch(()=>{}),xn("/api/https-info").then(I=>I.json()).then(I=>{I&&typeof I.https=="boolean"&&ae({https:!!I.https,port:Number(I.port)||8788})}).catch(()=>{})},[]);const q=i.useMemo(()=>{const H=x||"____",I=U||window.location.hostname,B=ie?.https?"https":"http",de=ie?.https?ie.port:8787;return`${B}://${I}:${de}/mobile-cam.html?code=${H}`},[x,U,ie]);function G(){if(k&&k.readyState===WebSocket.OPEN)return k;const H=Da(),I=new WebSocket(H);return S(I),I}const ge=i.useCallback(()=>{V("phone");const H=G();H.readyState===WebSocket.OPEN?H.send(JSON.stringify({type:"cam-create"})):H.onopen=()=>H.send(JSON.stringify({type:"cam-create"})),H.onmessage=async I=>{const B=JSON.parse(I.data);if(B.type==="cam-code")w(B.code),C.current=B.code;else if(B.type==="cam-peer-joined"){const de=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}]});j(de),de.onicecandidate=le=>{le.candidate&&C.current&&H.send(JSON.stringify({type:"cam-ice",code:C.current,payload:le.candidate}))},de.ontrack=le=>{f.current&&le.streams?.[0]&&(f.current.srcObject=le.streams[0],f.current.play().catch(()=>{}),M(le.streams[0],"phone"),A(!0))};const K=await de.createOffer({offerToReceiveVideo:!0});await de.setLocalDescription(K),C.current&&H.send(JSON.stringify({type:"cam-offer",code:C.current,payload:K}))}else if(B.type==="cam-answer"&&$)await $.setRemoteDescription(new RTCSessionDescription(B.payload));else if(B.type==="cam-ice"&&$)try{await $.addIceCandidate(B.payload)}catch{}}},[M,$,k]),Pe=i.useCallback(async()=>{await N()||window.dispatchEvent(new CustomEvent("ndn:start-camera",{detail:{mode:"local"}}))},[N]),ne=i.useCallback(H=>{V(H),H==="local"?Pe():H==="phone"&&ge()},[Pe,ge]);i.useEffect(()=>{(r||s)&&(L==="local"?Pe():L==="phone"&&ge())},[r,s,L,Pe,ge]);const Ae=g.isStreaming,ce=g.getMediaStream?.();return i.useEffect(()=>{if(Ae&&ce){try{const H=f.current;H&&H.srcObject!==ce&&(H.srcObject=ce,H.play().catch(()=>{}),A(!0))}catch{}N()}},[Ae,ce,N]),e.jsx(_m,{...t,videoRef:f,streaming:m,mode:L,pairCode:x,mobileUrl:q,startPhonePairing:ge,onModeSelect:ne})}function _m(t){const{videoRef:n,streaming:r,mode:s,pairCode:a,mobileUrl:o,startPhonePairing:c,label:l,fill:b,className:u,style:f,scale:g,aspect:m="inherit",tileFitModeOverride:A}=t,{cameraScale:k,cameraAspect:S,cameraFitMode:x}=ve(),w=i.useRef(null),C=i.useRef(null),[$,j]=i.useState(!1),T=i.useCallback(()=>{if(!w.current)return!0;const V=w.current.getBoundingClientRect();return V.width>0&&V.height>0&&V.top<(window.innerHeight||2e3)&&V.bottom>0},[]),M=A||(b?"fill":x||"fill"),N=Number(g??k??1),P=b&&M==="fill"?"free":m&&m!=="inherit"?m:S||"wide",L=P==="square"?"aspect-square":P==="portrait"?"aspect-[3/4]":P==="classic"?"aspect-[4/3]":P==="free"?"h-full":"aspect-video";return i.useEffect(()=>{let V=0,U=!0,te=0;const ie=()=>{if(!U)return;const ae=n.current,q=C.current,G=ae&&($||ae.videoWidth>0&&ae.readyState<2);if(ae&&q&&G){const ge=q.getContext("2d",{alpha:!1});ge&&ae.videoWidth>0&&(q.width!==ae.videoWidth&&(q.width=ae.videoWidth,q.height=ae.videoHeight),ge.drawImage(ae,0,0),q.style.visibility="visible")}else q&&(q.style.visibility="hidden");V=requestAnimationFrame(ie)};return V=requestAnimationFrame(ie),te=window.setInterval(()=>{const ae=n.current;if(ae&&ae.videoWidth>0&&T()){const q=document.createElement("canvas");q.width=16,q.height=16;const G=q.getContext("2d",{alpha:!1,willReadFrequently:!0});if(G)try{G.drawImage(ae,0,0,16,16);const ge=G.getImageData(0,0,16,16).data;let Pe=0;for(let Ae=0;Ae<ge.length;Ae+=4)Pe+=.299*ge[Ae]+.587*ge[Ae+1]+.114*ge[Ae+2];Pe/(256*255)<.02?j(!0):j(!1)}catch{}}},2e3),()=>{U=!1,cancelAnimationFrame(V),window.clearInterval(te)}},[n,T,$]),e.jsxs("div",{ref:w,className:Ps("relative bg-black rounded-3xl overflow-hidden shadow-2xl border border-white/5",u,b&&"w-full h-full"),style:f,children:[e.jsxs("div",{className:Ps("relative w-full",L),children:[e.jsx("video",{ref:n,autoPlay:!0,playsInline:!0,muted:!0,className:Ps("w-full h-full",M==="fill"?"object-cover":"object-contain",$?"opacity-0 absolute":"block"),style:{transform:`scale(${N})`}}),e.jsx("canvas",{ref:C,className:Ps("absolute inset-0 w-full h-full bg-black",M==="fill"?"object-cover":"object-contain"),style:{visibility:"hidden",transform:`scale(${N})`}})]}),e.jsxs("div",{className:"absolute top-3 left-3 flex items-center gap-2",children:[e.jsx("div",{className:"w-8 h-8 rounded-full bg-indigo-500/20 backdrop-blur-md flex items-center justify-center text-white",children:e.jsx(as,{size:14})}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-[10px] text-white/40 uppercase tracking-widest font-bold",children:"Live Feed"}),e.jsx("span",{className:"text-white font-bold leading-none",children:l||s})]})]}),r&&e.jsxs("div",{className:"absolute top-3 right-3 flex items-center gap-1.5 px-2 py-1 rounded-full bg-emerald-500/20 border border-emerald-500/30",children:[e.jsx("div",{className:"w-2 h-2 rounded-full bg-emerald-400 animate-pulse"}),e.jsx("span",{className:"text-xs text-emerald-400 font-bold uppercase tracking-widest",children:"Live"})]})]})}const Rs=({label:t,value:n})=>e.jsxs("div",{className:"flex flex-col items-center gap-0",children:[e.jsx("div",{className:"text-[8px] opacity-70 uppercase font-bold tracking-tighter leading-none",children:t}),e.jsx("div",{className:"text-sm sm:text-base font-black leading-none",children:n})]});function Fm({open:t=!0,players:n,user:r,initialSeconds:s=10,disableEscClose:a=!1,onDone:o,onRequestClose:c}){const[l,b]=i.useState(s),[u,f]=i.useState(!1),g=i.useRef(typeof document<"u"?document.createElement("div"):null),m=i.useRef(null),A=ve(C=>C.cameraEnabled),k=ve(C=>C.setCameraEnabled),S=er();i.useEffect(()=>{const C=g.current;if(!(!C||typeof document>"u"))return C.className="ndn-match-start-portal",document.body.appendChild(C),()=>{try{C.parentNode?.removeChild(C)}catch{}}},[]),i.useEffect(()=>{t&&(b(s),f(!1),m.current&&(window.clearTimeout(m.current),m.current=null))},[t,s]),i.useEffect(()=>{if(!t)return;A||k?.(!0);const C=window.setInterval(()=>{b($=>$<=1?(window.clearInterval(C),f(!0),m.current&&window.clearTimeout(m.current),m.current=window.setTimeout(()=>{try{o?.(),c?.()}catch{}},1e3),0):$-1)},1e3);return()=>{window.clearInterval(C)}},[t,o,c,k,A]),i.useEffect(()=>()=>{m.current&&window.clearTimeout(m.current)},[]),i.useEffect(()=>{if(!t||a)return;const C=$=>{if($.key==="Escape")try{c?.()}catch{}};return window.addEventListener("keydown",C),()=>window.removeEventListener("keydown",C)},[t,a,c]),i.useEffect(()=>{if(!t||typeof document>"u")return;const C=document.getElementById("root");if(!C)return;const $=C.getAttribute("aria-hidden");return C.setAttribute("aria-hidden","true"),()=>{$==null?C.removeAttribute("aria-hidden"):C.setAttribute("aria-hidden",$)}},[t]),i.useEffect(()=>{if(t){try{S?.acquireKeepAlive?.("match-start-showcase")}catch{}return()=>{try{S?.releaseKeepAlive?.("match-start-showcase")}catch{}}}},[t,S]);const x=i.useMemo(()=>n.map(C=>{try{const $=no(C.name).toFixed(1),j=Xi(C.name).toFixed(1),T=Zi(C.name),M=Qi(C.name),N=Yn(C.name),P=N.scored||0,L=N.darts||0,V=ec(C.name),U=(C.legs||[]).reduce((te,ie)=>{const ae=(ie.visits||[]).filter(q=>Number(q.visitTotal??q.score)===180).length;return te+ae},0);return{id:C.id,name:C.name,avg3:$,best9:j,bestCheckout:T,bestLeg:M,lifetimeScored:P,lifetimeDarts:L,career180s:V,match180s:U}}catch{return{id:C.id,name:C.name,avg3:"",best9:"",bestCheckout:"",bestLeg:"",lifetimeScored:0,lifetimeDarts:0,career180s:0,match180s:0}}}),[n]);if(!t||!g.current)return null;const w=e.jsx("div",{className:"fixed inset-0 z-50 overflow-y-auto bg-black/85 backdrop-blur-md",role:"dialog","aria-modal":"true","aria-label":"Match start showcase",children:e.jsx("div",{className:"min-h-full flex items-center justify-center p-4 sm:p-6 lg:p-8",children:e.jsx("div",{className:"w-full max-w-4xl",children:e.jsx(ur,{returnFocus:!0,children:e.jsxs("div",{className:"bg-[#0f111a] border border-white/10 rounded-3xl p-5 shadow-2xl ring-1 ring-white/5 relative overflow-hidden",children:[e.jsxs("div",{className:"flex items-start justify-between gap-3 mb-4 border-b border-white/5 pb-3",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-[10px] font-bold text-emerald-300 uppercase tracking-widest mb-1",children:"Manual scoring only"}),e.jsx("div",{className:"text-2xl md:text-3xl font-black text-white tracking-tighter",children:u||l<=0?"GO":`Match starting in ${l}s`}),e.jsx("p",{className:"text-xs text-white/70 mt-1 max-w-xl",children:"Camera is shown to both players before and during the match. No auto-calibration or auto-scoring is used â€” enter scores manually."})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{className:"px-3 py-2 rounded-lg bg-white/10 hover:bg-white/15 text-white text-xs font-semibold","aria-label":"Close match start showcase",onClick:()=>{try{c?.()}catch{}},children:"Close"}),e.jsx("button",{className:"px-4 py-2 rounded-lg bg-emerald-500 hover:bg-emerald-400 text-black text-xs font-bold","aria-label":"Start match now",onClick:()=>{try{o?.(),c?.()}catch{}},children:"Start now"})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx("div",{className:"space-y-3",children:x.map(C=>e.jsxs("div",{className:"p-3 rounded-2xl border border-white/10 bg-white/5 shadow-lg",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"text-lg font-black text-white tracking-tight",children:[C.name,r?.username===C.name?"  You":""]}),e.jsxs("div",{className:"text-[10px] text-emerald-300 font-bold",children:["Manual scoring enabled Â· ",C.match180s,"/",C.career180s]})]}),e.jsxs("div",{className:"text-sm text-white/70 font-semibold",children:["180s: ",C.match180s,"/",C.career180s]})]}),e.jsxs("div",{className:"grid grid-cols-4 gap-2",children:[e.jsx(Rs,{label:"Avg",value:String(C.avg3)}),e.jsx(Rs,{label:"F9",value:String(C.best9)}),e.jsx(Rs,{label:"CO",value:String(C.bestCheckout)}),e.jsx(Rs,{label:"Leg",value:String(C.bestLeg)})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 mt-2 text-[10px] text-white/70",children:[e.jsxs("div",{className:"flex items-center justify-between px-2 py-1 rounded-lg bg-white/5 border border-white/5",children:[e.jsx("span",{children:"Lifetime pts"}),e.jsx("span",{className:"font-semibold",children:C.lifetimeScored.toLocaleString()})]}),e.jsxs("div",{className:"flex items-center justify-between px-2 py-1 rounded-lg bg-white/5 border border-white/5",children:[e.jsx("span",{children:"Lifetime darts"}),e.jsx("span",{className:"font-semibold",children:C.lifetimeDarts.toLocaleString()})]})]})]},C.id))}),e.jsxs("div",{className:"rounded-2xl border border-white/10 bg-black/40 overflow-hidden shadow-xl",children:[e.jsxs("div",{className:"px-4 py-3 flex items-center justify-between text-sm text-white/80 border-b border-white/5",children:[e.jsx("div",{className:"font-semibold",children:"Camera preview"}),e.jsx("div",{className:"text-xs text-emerald-300 font-bold",children:"Live Manual scoring"})]}),e.jsx("div",{className:"aspect-video relative bg-black",children:e.jsx(Lm,{autoStart:!0,forceAutoStart:!0,fill:!0,aspect:"free",tileFitModeOverride:"fit",scale:1})}),e.jsx("div",{className:"px-4 py-3 text-xs text-white/70 border-t border-white/5",children:"Confirm your board is visible and stable. Scores will be entered manually during the match."})]})]})]})})})})});return ka.createPortal(w,g.current)}function Um(t,n="Player"){try{const r=[t?.username,t?.profile?.username,t?.profile?.fullName,t?.fullName,t?.profile?.displayName,t?.displayName,t?.name];for(const s of r){if(typeof s!="string")continue;const a=s.trim();if(a)return a}}catch{}return n}function $m(){const t=mt();ve(I=>I.hideInGameSidebar??!0),mt().importState,on(I=>I.setPaused),on();const[n,r]=i.useState(!1),[s,a]=i.useState(null),[o,c]=i.useState(null),l=ve(I=>I.lastOffline?.x01Start||501),b=ve(I=>I.user),u=b?.username||b?.name||b?.displayName||b?.email?.split("@")[0],f=(t.players||[]).findIndex(I=>I?.name&&I.name===u),g=f>=0?f:0,m=(t.currentPlayerIdx??0)===g,A=(t.players||[]).filter((I,B)=>B!==g),k=ve(I=>I.callerEnabled),S=ve(I=>I.callerVoice),x=ve(I=>I.callerVolume),w=ve(I=>I.speakCheckoutOnly),[C,$]=i.useState(0),[j,T]=i.useState(0),[M,N]=i.useState(""),[P,L]=i.useState(""),[V,U]=i.useState(""),[te,ie]=i.useState([]),[ae,q]=i.useState(!0),G=Nt.useRef(!0),[ge,Pe]=i.useState(!1),[ne,Ae]=i.useState("controls");i.useEffect(()=>{G.current&&q(!0)},[]),i.useEffect(()=>{try{ve.getState().setCameraEnabled(!0)}catch{}try{const B=Ko();if(B?.match)try{mt.getState().importState(B.match)}catch{}else try{mt.getState().importState({...mt.getState(),startingScore:l})}catch{}if(B?.control)try{on.getState().setPaused(B.control.paused,B.control.pauseEndsAt)}catch{}}catch{}r(!0);const I=du(B=>{try{if(!B)return;B.type==="snapshot"&&B.state&&(B.state.match&&mt.getState().importState(B.state.match),B.state.control&&on.getState().setPaused(B.state.control.paused,B.state.control.pauseEndsAt));const de=()=>{try{const K=Ko();if(K&&K.match)return mt.getState().importState(K.match),K.control&&on.getState().setPaused(K.control.paused,K.control.pauseEndsAt),!0}catch{}return!1};if(B.type==="pause")try{on.getState().setPaused(!0,B.pauseEndsAt??null)}catch{}if(B.type==="unpause")try{on.getState().setPaused(!1,null)}catch{}if(B.type==="quit")try{window.close()}catch{}if(B.type==="pendingVisit")try{const K=B.playerIdx??t.currentPlayerIdx;try{Fn.getState().setVisit(B.entries||[],B.darts||0,B.total||0)}catch{}B.frame&&c(B.frame)}catch{}if(B.type==="visit")try{const K=de();try{B.meta?.frame&&c(B.meta.frame),B.finished&&B.meta&&(a({label:B.meta.label||H()||void 0,ring:B.meta.ring,frame:B.meta.frame??B.frame??null,ts:Date.now()}),t.endGame())}catch{}try{Fn.getState().reset()}catch{}}catch{}if(B.type==="nextPlayer")try{if(!de())try{const le=mt.getState(),we={roomId:le.roomId,players:le.players,currentPlayerIdx:typeof B.currentPlayerIdx=="number"?B.currentPlayerIdx:(le.currentPlayerIdx+1)%(le.players?.length||1),startingScore:le.startingScore,inProgress:le.inProgress,bestLegThisMatch:le.bestLegThisMatch};mt.getState().importState(we)}catch{}}catch{}if(B.type==="endLeg")try{const K=de()}catch{}if(B.type==="endGame")try{if(!de())try{const le=mt.getState(),we={roomId:le.roomId,players:le.players,currentPlayerIdx:le.currentPlayerIdx,startingScore:le.startingScore,inProgress:!1,bestLegThisMatch:le.bestLegThisMatch};mt.getState().importState(we)}catch{}}catch{}}catch{}});return()=>{try{typeof I=="function"&&I()}catch{}}},[]);const ce=(I,B,de)=>{const K=t.players?.[t.currentPlayerIdx],le=K?.legs?.[K.legs.length-1],we=le?le.totalScoreRemaining:t.startingScore,He=typeof I=="number"?I:0;let Qe=we-He;if((!Number.isFinite(Qe)||Qe<0)&&(Qe=0),k){const tt=K?.name||Um(b,"Player");try{fc(tt,He,Qe,S,{volume:x,checkoutOnly:w})}catch{}}t.addVisit(He,B,de??{visitTotal:He}),Qe===0?t.endLeg(He):t.nextPlayer()},H=i.useCallback(()=>{try{const I=[];if((t.players||[]).forEach(K=>{(K.legs||[]).forEach(le=>{if(le?.finished){const we=(le.visits||[]).slice(-1)[0];I.push({ts:le.endTime||Date.now(),visit:we,player:K})}})}),!I.length)return null;const B=I.sort((K,le)=>le.ts-K.ts)[0],de=(B.visit?.entries||[]).slice(-1)[0];if(de?.label)return de.label;if(de?.ring==="DOUBLE"&&typeof de?.value=="number")return`Double ${de.value/2}`;if(typeof B.visit?.visitTotal=="number")return`Checkout ${B.visit.visitTotal}`}catch{}return null},[t.players]);return i.useEffect(()=>{if(t.inProgress){a(null);return}if(!s?.label){const I=H();I&&a(B=>({...B,label:I}))}},[t.inProgress,H,s?.label]),e.jsxs("div",{className:"card ndn-game-shell ndn-page relative overflow-hidden md:overflow-hidden overflow-y-auto",children:[ae&&e.jsx(Fm,{open:ae,players:t.players||[],onDone:()=>{G.current=!1,q(!1)},onRequestClose:()=>{G.current=!1,q(!1)},showCalibrationDefault:!0}),e.jsxs("div",{className:"flex items-center gap-3 mb-4 ndn-section-title",children:[e.jsx("button",{className:"btn btn--ghost px-3 py-1",onClick:()=>{try{if(window.opener&&!window.opener.closed)try{window.opener.focus()}catch{}window.close()}catch{}},"aria-label":"Return to app and close match window",children:"Return"}),e.jsx("h2",{className:"text-3xl font-bold text-brand-700",children:"Match ðŸŽ¯"}),s?.label&&e.jsxs("span",{className:"text-xs px-2 py-1 rounded-full bg-emerald-500/20 border border-emerald-400/30 text-emerald-200 align-middle",children:["Winning double: ",s.label]})]}),e.jsxs("div",{className:"ndn-shell-body",style:{paddingBottom:"calc(var(--ndn-bottomnav-h, 0px) + env(safe-area-inset-bottom, 0px) + 16px)"},children:[e.jsx(Mm,{left:e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("span",{className:"font-medium",children:"Camera view"})}),right:e.jsx(mc,{})}),e.jsx("div",{className:"rounded-3xl border border-slate-800/60 bg-gradient-to-br from-slate-900/80 via-slate-900/60 to-slate-950/90 p-4 sm:p-6 shadow-2xl",children:e.jsxs("div",{className:"grid grid-cols-1 gap-5 items-start",children:[e.jsx("div",{className:"lg:hidden min-w-0 space-y-4",children:m?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"card p-3 rounded-2xl border border-slate-800/60 bg-slate-950/60 shadow-xl ring-1 ring-white/5",children:[e.jsxs("div",{className:"text-sm font-semibold mb-3 flex items-center justify-between",children:[e.jsx("span",{children:"Your Camera"}),e.jsx("span",{className:"text-xs text-emerald-300",children:"Your turn"})]}),e.jsxs("div",{className:"relative h-56 rounded-2xl overflow-hidden bg-black shadow-inner",children:[e.jsx(rs,{hideInlinePanels:!0,forceAutoStart:!0,onAddVisit:ce,onEndLeg:I=>{try{t.endLeg(I??0)}catch{}},onVisitCommitted:(I,B,de,K)=>{if(!de)return;const le=K?.frame??o??null;a({label:K?.label||H()||void 0,ring:K?.ring,frame:le,ts:Date.now()});try{t.endGame()}catch{}}}),s?.frame&&!t.inProgress&&e.jsxs("div",{className:"absolute inset-2 rounded-lg overflow-hidden border border-emerald-400/40 shadow-lg bg-black/70",children:[e.jsx("img",{src:s.frame,alt:"Winning double zoom",className:"w-full h-full object-cover scale-125"}),e.jsxs("div",{className:"absolute bottom-2 left-2 right-2 text-xs text-white bg-black/60 rounded-md px-2 py-1 flex items-center justify-between gap-2",children:[e.jsx("span",{className:"font-semibold",children:"Winning dart zoom"}),s.label&&e.jsx("span",{className:"text-emerald-200",children:s.label})]})]})]})]}),e.jsxs("div",{className:"card p-4 rounded-2xl border border-slate-800/60 bg-slate-950/60 shadow-xl ring-1 ring-white/5",children:[e.jsx("div",{className:"flex items-center justify-between mb-3",children:e.jsx("h3",{className:"text-base font-semibold",children:"Your Scoreboard"})}),e.jsx(Os,{gameMode:t?.game||"X01",players:(t.players||[]).map((I,B)=>({name:I.name||`Player ${B+1}`,isCurrentTurn:B===(t.currentPlayerIdx||0),legsWon:I.legsWon||0,score:I.legs?.[I.legs.length-1]?.totalScoreRemaining??t.startingScore??l,lastScore:I.legs&&I.legs.length&&I.legs[I.legs.length-1].visits.slice(-1)[0]?.score||0}))}),e.jsx("div",{className:"mt-4 rounded-2xl border border-indigo-500/30 bg-gradient-to-r from-indigo-950/40 via-purple-950/40 to-indigo-950/40 p-3 shadow-[0_0_24px_rgba(99,102,241,0.25)]",children:e.jsxs("div",{className:"flex flex-col sm:flex-row gap-3",children:[e.jsx("input",{type:"number",inputMode:"numeric",className:"input text-center text-lg font-semibold rounded-xl border border-indigo-500/40 bg-transparent focus:border-indigo-400 focus:ring-2 focus:ring-indigo-500/30 transition-all flex-1",style:{width:"400mm",height:"30mm",maxWidth:"100%"},value:M,onChange:I=>N(I.target.value),onKeyDown:I=>{if(I.key==="Enter"){I.preventDefault();const B=parseInt(M)||0;ce(B,3,{visitTotal:B}),N("")}},placeholder:"Tap to enter score",disabled:!t.inProgress}),e.jsx("button",{type:"button",className:"btn btn--primary px-5 py-3 rounded-xl text-sm font-semibold",onClick:()=>{const I=parseInt(M)||0;ce(I,3,{visitTotal:I}),N("")},disabled:!t.inProgress||!M,children:"Submit score"})]})})]})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"card p-4 rounded-2xl border border-slate-800/60 bg-slate-950/60 shadow-xl ring-1 ring-white/5",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h3",{className:"text-base font-semibold",children:"Opponent"}),e.jsx("span",{className:"text-xs text-amber-300 font-semibold px-2 py-1 rounded-full bg-amber-500/10 border border-amber-400/30",children:"Waiting"})]}),e.jsx(Os,{gameMode:t?.game||"X01",players:(A.length?A:t.players||[]).map((I,B)=>({name:I.name||`Player ${B+1}`,isCurrentTurn:I===(t.players||[])[t.currentPlayerIdx],legsWon:I.legsWon||0,score:I.legs?.[I.legs.length-1]?.totalScoreRemaining??t.startingScore??l,lastScore:I.legs&&I.legs.length&&I.legs[I.legs.length-1].visits.slice(-1)[0]?.score||0}))})]}),e.jsxs("div",{className:"card p-3 rounded-2xl border border-slate-800/60 bg-slate-950/60 shadow-xl ring-1 ring-white/5",children:[e.jsxs("div",{className:"text-sm font-semibold mb-3 flex items-center justify-between",children:[e.jsx("span",{children:"Opponent Camera"}),e.jsx("span",{className:"text-xs text-slate-300",children:"Live feed"})]}),e.jsxs("div",{className:"relative h-56 rounded-2xl overflow-hidden bg-black shadow-inner",children:[e.jsx(rs,{hideInlinePanels:!0,forceAutoStart:!0,onAddVisit:ce,onEndLeg:I=>{try{t.endLeg(I??0)}catch{}},onVisitCommitted:(I,B,de,K)=>{if(!de)return;const le=K?.frame??o??null;a({label:K?.label||H()||void 0,ring:K?.ring,frame:le,ts:Date.now()});try{t.endGame()}catch{}}}),s?.frame&&!t.inProgress&&e.jsxs("div",{className:"absolute inset-2 rounded-lg overflow-hidden border border-emerald-400/40 shadow-lg bg-black/70",children:[e.jsx("img",{src:s.frame,alt:"Winning double zoom",className:"w-full h-full object-cover scale-125"}),e.jsxs("div",{className:"absolute bottom-2 left-2 right-2 text-xs text-white bg-black/60 rounded-md px-2 py-1 flex items-center justify-between gap-2",children:[e.jsx("span",{className:"font-semibold",children:"Winning dart zoom"}),s.label&&e.jsx("span",{className:"text-emerald-200",children:s.label})]})]})]})]})]})}),e.jsx("div",{className:"hidden lg:block min-w-0 space-y-5",children:m?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"card p-4 rounded-3xl border border-slate-800/60 bg-slate-950/60 shadow-xl ring-1 ring-white/5",children:[e.jsxs("div",{className:"text-sm font-semibold mb-3 flex items-center justify-between",children:[e.jsx("span",{children:"Your Camera"}),e.jsx("span",{className:"text-xs text-emerald-300",children:"Your turn"})]}),e.jsxs("div",{className:"relative h-[360px] rounded-2xl overflow-hidden bg-black shadow-inner",children:[e.jsx(rs,{hideInlinePanels:!0,forceAutoStart:!0,onAddVisit:ce,onEndLeg:I=>{try{t.endLeg(I??0)}catch{}},onVisitCommitted:(I,B,de,K)=>{if(!de)return;const le=K?.frame??o??null;a({label:K?.label||H()||void 0,ring:K?.ring,frame:le,ts:Date.now()});try{t.endGame()}catch{}}}),s?.frame&&!t.inProgress&&e.jsx("div",{className:"absolute inset-2 rounded-lg overflow-hidden border border-emerald-400/40 shadow-lg bg-black/70",children:e.jsx("img",{src:s.frame,alt:"Winning double zoom",className:"w-full h-full object-cover scale-125"})})]})]}),e.jsxs("div",{className:"card p-5 rounded-3xl border border-slate-800/60 bg-slate-950/60 shadow-xl ring-1 ring-white/5",children:[e.jsx("div",{className:"flex items-center justify-between mb-3",children:e.jsx("h3",{className:"text-base font-semibold",children:"Your Scoreboard"})}),e.jsx(Os,{gameMode:t?.game||"X01",players:(t.players||[]).map((I,B)=>({name:I.name||`Player ${B+1}`,isCurrentTurn:B===(t.currentPlayerIdx||0),legsWon:I.legsWon||0,score:I.legs?.[I.legs.length-1]?.totalScoreRemaining??t.startingScore??l,lastScore:I.legs&&I.legs.length&&I.legs[I.legs.length-1].visits.slice(-1)[0]?.score||0}))}),e.jsx("div",{className:"mt-5 rounded-2xl border border-indigo-500/30 bg-gradient-to-r from-indigo-950/40 via-purple-950/40 to-indigo-950/40 p-4 shadow-[0_0_24px_rgba(99,102,241,0.25)]",children:e.jsxs("div",{className:"flex flex-col sm:flex-row gap-3",children:[e.jsx("input",{type:"number",className:"input text-center text-lg font-semibold rounded-xl border border-indigo-500/40 bg-transparent focus:border-indigo-400 focus:ring-2 focus:ring-indigo-500/30 transition-all flex-1",style:{width:"400mm",height:"30mm",maxWidth:"100%"},value:M,onChange:I=>N(I.target.value),onKeyDown:I=>{if(I.key==="Enter"){I.preventDefault();const B=parseInt(M)||0;ce(B,3,{visitTotal:B}),N("")}},placeholder:"Enter score",disabled:!t.inProgress}),e.jsx("button",{type:"button",className:"btn btn--primary px-5 py-3 rounded-xl text-sm font-semibold",onClick:()=>{const I=parseInt(M)||0;ce(I,3,{visitTotal:I}),N("")},disabled:!t.inProgress||!M,children:"Submit score"})]})})]})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"card p-5 rounded-3xl border border-slate-800/60 bg-slate-950/60 shadow-xl ring-1 ring-white/5",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h3",{className:"text-base font-semibold",children:"Opponent"}),e.jsx("span",{className:"text-xs text-amber-300 font-semibold px-2 py-1 rounded-full bg-amber-500/10 border border-amber-400/30",children:"Opponent turn"})]}),e.jsx(Os,{gameMode:t?.game||"X01",players:(A.length?A:t.players||[]).map((I,B)=>({name:I.name||`Player ${B+1}`,isCurrentTurn:I===(t.players||[])[t.currentPlayerIdx],legsWon:I.legsWon||0,score:I.legs?.[I.legs.length-1]?.totalScoreRemaining??t.startingScore??l,lastScore:I.legs&&I.legs.length&&I.legs[I.legs.length-1].visits.slice(-1)[0]?.score||0}))})]}),e.jsxs("div",{className:"card p-4 rounded-3xl border border-slate-800/60 bg-slate-950/60 shadow-xl ring-1 ring-white/5",children:[e.jsxs("div",{className:"text-sm font-semibold mb-3 flex items-center justify-between",children:[e.jsx("span",{children:"Opponent Camera"}),e.jsx("span",{className:"text-xs text-slate-300",children:"Live feed"})]}),e.jsxs("div",{className:"relative h-[360px] rounded-2xl overflow-hidden bg-black shadow-inner",children:[e.jsx(rs,{hideInlinePanels:!0,forceAutoStart:!0,onAddVisit:ce,onEndLeg:I=>{try{t.endLeg(I??0)}catch{}},onVisitCommitted:(I,B,de,K)=>{if(!de)return;const le=K?.frame??o??null;a({label:K?.label||H()||void 0,ring:K?.ring,frame:le,ts:Date.now()});try{t.endGame()}catch{}}}),s?.frame&&!t.inProgress&&e.jsx("div",{className:"absolute inset-2 rounded-lg overflow-hidden border border-emerald-400/40 shadow-lg bg-black/70",children:e.jsx("img",{src:s.frame,alt:"Winning double zoom",className:"w-full h-full object-cover scale-125"})})]})]})]})})]})})]})]})}const Ma="ndn:open-notifications";function ph(){try{window.dispatchEvent(new CustomEvent(Ma))}catch{}}function Bm({className:t,title:n}){let r=!1;try{r=Cr().connected}catch{r=!1}const s=r?"Connected":"Disconnected";return e.jsx("span",{"aria-label":`Server connection: ${s}`,title:n||s,className:["inline-flex items-center justify-center","w-3 h-3 rounded-full",r?"bg-emerald-400":"bg-red-500","ring-2 ring-black/20",t||""].join(" ")})}const Vm={},Wm=Nt.lazy(()=>un(()=>import("./Home-CDvKPAND.js"),__vite__mapDeps([0,1,2,3]))),zm=Nt.lazy(()=>un(()=>Promise.resolve().then(()=>Am),void 0)),Hm=Nt.lazy(()=>un(()=>import("./OfflinePlay-BeFzG4SF.js"),__vite__mapDeps([6,1,2,7,3]))),qm=Nt.lazy(()=>un(()=>import("./Friends-YIPYeovv.js"),__vite__mapDeps([10,1,2]))),Gm=Nt.lazy(()=>un(()=>import("./OnlinePlay.clean-BQQoK3el.js"),__vite__mapDeps([4,1,2,5]))),Jm=Nt.lazy(()=>un(()=>import("./StatsPanel-CTb8ZBr4.js"),__vite__mapDeps([9,3,1,2]))),Ym=Nt.lazy(()=>un(()=>import("./Tournaments-CZavMlRR.js"),__vite__mapDeps([11,1,2,5]))),Km=Nt.lazy(()=>un(()=>import("./AdminAccess-D2TY36xp.js"),__vite__mapDeps([12,1,2]))),Xm=Nt.lazy(()=>un(()=>import("./OpsDashboard-zvS7Ohm7.js"),__vite__mapDeps([13,1,2])));function Qm(){const t=i.useRef(null),[n,r]=i.useState(""),[s,a]=i.useState(!1),o=(()=>{try{return Cr()}catch{return null}})(),[c,l]=i.useState("score"),[b,u]=i.useState(!1),[f,g]=i.useState(!1),[m,A]=i.useState(null);function k(E){if(!E){A(E);return}A(J=>{const z={...J,...E};return J?.subscription&&!E?.subscription&&(z.subscription=J.subscription),E?.subscription&&(z.subscription=E.subscription),z.fullAccess=!!(z.subscription?.fullAccess||E?.fullAccess||z.fullAccess),z})}const S=(Vm?.VITE_MINIMAL_AFTER_LOGIN||"").toString()==="1",[x,w]=i.useState(!1),[C,$]=i.useState(0),[j,T]=i.useState(0),{avgMode:M}=ve();ve(E=>E.cameraEnabled);const P=mt(E=>E.inProgress)&&c!=="score";Xa();const L=Math.abs(j)>=.05?j:0,V=Ri(),U=En(),te=ve();i.useEffect(()=>{try{const E=te.preferredCameraLocked;E&&U.locked!==E&&(U.setCalibration({locked:E}),console.info("[APP] Synced camera locked state from userSettings:",E))}catch(E){console.warn("Failed to sync locked state from userSettings",E)}},[]),i.useEffect(()=>{const E=J=>{try{console.warn("Unhandled promise rejection (suppressed):",J.reason),J.preventDefault?.()}catch(z){return console.error("Failed to refresh friend notifications:",z),!1}};return window.addEventListener("unhandledrejection",E),()=>window.removeEventListener("unhandledrejection",E)},[]),i.useEffect(()=>{const E=localStorage.getItem("authToken");E&&fetch(`${V}/api/auth/me`,{headers:{Authorization:`Bearer ${E}`}}).then(J=>J.json()).then(J=>{if(J?.user){k(J.user);try{const z=localStorage.getItem(`ndn:subscription:${J.user.email}`);z&&k({...J.user,subscription:JSON.parse(z)})}catch{}ie(J.user)}else localStorage.removeItem("authToken")}).catch(()=>{})},[]),i.useEffect(()=>{if(m&&S){w(!0);const E=setTimeout(()=>w(!1),1500);return()=>clearTimeout(E)}},[S,m]);try{if(new URLSearchParams(window.location.search).get("match")==="1")return e.jsxs(zo,{children:[e.jsx(gm,{}),e.jsx($m,{})]})}catch{}i.useEffect(()=>{const E=()=>{try{localStorage.removeItem("mockUser"),localStorage.removeItem("authToken"),m?.email&&localStorage.removeItem(`ndn:subscription:${m.email}`)}catch{}A(null),l("score")};return window.addEventListener("ndn:logout",E),()=>window.removeEventListener("ndn:logout",E)},[]),i.useEffect(()=>{if(!m?.username){T(0);return}try{localStorage.setItem("ndn:currentUser",m.username),window.ndnCurrentUser=m.username}catch{}try{Ki(m.username)}catch{}const E=()=>{const oe=M==="24h"?cc(m.username):no(m.username);$(oe);const je=`ndn:allTimeAvgSnapshot:${m.username}`,se=Date.now(),$e=new Date().getMonth(),jt=new Date().getFullYear();try{const Mt=localStorage.getItem(je);if(!Mt){localStorage.setItem(je,JSON.stringify({value:oe,ts:se,month:$e,year:jt})),T(0);return}const Et=JSON.parse(Mt),fe=Number(Et?.value)||0,Qt=Number(Et?.month);if(Number(Et?.year)!==jt||Qt!==$e)localStorage.setItem(je,JSON.stringify({value:oe,ts:se,month:$e,year:jt})),T(0);else{const vn=oe-fe;T(Number.isFinite(vn)?vn:0)}}catch{T(0)}};E();const J=()=>E(),z=oe=>{const je=oe.key||"";if(!je)return;[`ndn_stats_${m.username}`,`ndn_stats_ts_${m.username}`,`ndn_stats_daily_${m.username}`,`ndn:allTimeAvgSnapshot:${m.username}`].some($e=>je.startsWith($e))&&E()};return window.addEventListener("ndn:stats-updated",J),window.addEventListener("storage",z),()=>{window.removeEventListener("ndn:stats-updated",J),window.removeEventListener("storage",z)}},[m?.username,M]),i.useEffect(()=>{if(!m?.username){r("");return}const E=localStorage.getItem(`ndn:bio:profilePhoto:${m.username}`);r(E||"")},[m?.username]),i.useEffect(()=>{const E=je=>{je.key?.startsWith("ndn:bio:profilePhoto:")&&m?.username&&je.key.endsWith(m.username)&&r(je.newValue||"")},J=je=>{if(je.detail?.username===m?.username&&r(je.detail?.avatar||""),m?.username){const se=localStorage.getItem(`ndn:bio:profilePhoto:${m.username}`);r(se||"")}},z=()=>{if(!document.hidden&&m?.username){const je=localStorage.getItem(`ndn:bio:profilePhoto:${m.username}`);r(je||"")}},oe=setInterval(()=>{if(m?.username){const je=localStorage.getItem(`ndn:bio:profilePhoto:${m.username}`);je&&je!==n&&r(je)}},1e4);return window.addEventListener("storage",E),window.addEventListener("ndn:avatar-updated",J),document.addEventListener("visibilitychange",z),()=>{window.removeEventListener("storage",E),window.removeEventListener("ndn:avatar-updated",J),document.removeEventListener("visibilitychange",z),clearInterval(oe)}},[m?.username,n]),i.useEffect(()=>{const E=new URLSearchParams(window.location.search),J=E.get("paid"),z=E.get("username-change");if(J==="1"||J==="username-change"||z==="free"){const oe=localStorage.getItem("pendingUsernameChange");oe&&m?.email&&fetch(`${V}/api/change-username`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:m.email,newUsername:oe})}).then(je=>je.json()).then(je=>{je.ok?(alert("Username changed successfully!"),localStorage.removeItem("pendingUsernameChange"),je.token&&localStorage.setItem("authToken",je.token),je.user&&k(je.user),window.history.replaceState({},document.title,window.location.pathname)):alert("Failed to change username: "+(je.error||"Unknown error"))}).catch(()=>{alert("Network error while changing username")})}},[m?.email]),i.useEffect(()=>{const E=()=>a(!!document.fullscreenElement);return document.addEventListener("fullscreenchange",E),a(!!document.fullscreenElement),()=>document.removeEventListener("fullscreenchange",E)},[]),i.useEffect(()=>{new URLSearchParams(window.location.search).get("subscription")==="success"&&m?.email&&fetch(`${V}/api/auth/me`,{headers:{Authorization:`Bearer ${localStorage.getItem("authToken")}`}}).then(z=>z.json()).then(z=>{z?.user&&(k(z.user),alert("Premium subscription activated successfully!"),window.history.replaceState({},document.title,window.location.pathname))}).catch(()=>{alert("Subscription activated, but failed to refresh user data. Please refresh the page.")})},[m?.email]),i.useEffect(()=>{const E=window.matchMedia("(max-width: 768px)"),J=()=>u(E.matches);J();try{E.addEventListener("change",J)}catch{E.addListener(J)}return window.addEventListener("resize",J),window.addEventListener("orientationchange",J),()=>{window.removeEventListener("resize",J),window.removeEventListener("orientationchange",J);try{E.removeEventListener("change",J)}catch{E.removeListener(J)}}},[]),i.useEffect(()=>{function E(){const J=document.getElementById("ndn-header");if(!J)return;const z=Math.ceil(J.getBoundingClientRect().height);document.documentElement.style.setProperty("--ndn-header-h",`${z}px`)}return E(),window.addEventListener("resize",E),window.addEventListener("orientationchange",E),()=>{window.removeEventListener("resize",E),window.removeEventListener("orientationchange",E)}},[P]),i.useEffect(()=>{if(!b)return;const E=document.getElementById("ndn-main-scroll");if(!E)return;let J=E.scrollTop;const z=()=>{const oe=E.scrollTop;oe<J?document.documentElement.classList.add("ndn-menu-scrolled"):oe>J&&document.documentElement.classList.remove("ndn-menu-scrolled"),J=oe};return E.addEventListener("scroll",z,{passive:!0}),()=>{E.removeEventListener("scroll",z),document.documentElement.classList.remove("ndn-menu-scrolled")}},[b]),i.useEffect(()=>{if(b)return f?document.documentElement.classList.add("ndn-menu-open"):document.documentElement.classList.remove("ndn-menu-open"),()=>{document.documentElement.classList.remove("ndn-menu-open")}},[b,f]),i.useEffect(()=>{const E=()=>{try{localStorage.removeItem("ndn:avatar"),m?.email&&localStorage.removeItem(`ndn:subscription:${m.email}`)}catch{}A(null),l("score")};return window.addEventListener("ndn:logout",E),()=>window.removeEventListener("ndn:logout",E)},[]),i.useEffect(()=>{const E=J=>{try{const z=String(J?.detail?.username||"").trim();if(!z)return;A(oe=>oe&&{...oe,username:z});try{const oe=(m?.email||"").toLowerCase();o&&z&&oe&&o.send({type:"presence",username:z,email:oe})}catch{}}catch{}};return window.addEventListener("ndn:username-changed",E),()=>window.removeEventListener("ndn:username-changed",E)},[o,m?.email]),i.useEffect(()=>{const E=J=>{try{const z=String(J?.detail?.tab||"").trim();if(z&&["score","offline","online","stats","settings","admin","tournaments","friends"].includes(z)){l(z);try{const oe=document.querySelector(".ndn-mobile-brand");if(oe&&typeof window<"u"&&typeof window.getComputedStyle=="function"){const $e=oe.getBoundingClientRect(),jt=Math.max(8,Math.round($e.right+8));document.documentElement.style.setProperty("--ndn-mobile-menu-left",`${jt}px`)}const se={online:"8mm",tournaments:"10mm",calibrate:"12mm"}[z]||"0px";document.documentElement.style.setProperty("--ndn-section-gap",se)}catch{}}}catch{}};return window.addEventListener("ndn:change-tab",E),()=>window.removeEventListener("ndn:change-tab",E)},[]);async function ie(E){try{const J=E?.email?`?email=${encodeURIComponent(E.email)}`:"",z=await fetch("/api/subscription"+J);if(!z.ok)return;const oe=await z.json();k({...E,fullAccess:!!oe?.fullAccess,subscription:oe});try{E?.email&&localStorage.setItem(`ndn:subscription:${E.email}`,JSON.stringify(oe))}catch{}}catch{}}const[ae,q]=i.useState(!1),[G,ge]=i.useState(!1),[Pe,ne]=i.useState([]),[Ae,ce]=i.useState(0),[H,I]=i.useState(0),B=i.useCallback(async()=>{if(!m?.email)return[];try{const E=localStorage.getItem("authToken"),J={};E&&(J.Authorization=`Bearer ${E}`);const z=await fetch(`/api/notifications?email=${encodeURIComponent(m.email)}`,{headers:J});return z.ok?await z.json()||[]:[]}catch{return[]}},[m?.email]),de=i.useCallback(async()=>{if(!m?.email){ce(0),I(0);return}try{const[E,J]=await Promise.all([xn(`/api/friends/requests?email=${encodeURIComponent(m.email)}`),xn(`/api/friends/messages?email=${encodeURIComponent(m.email)}`)]),z=E.ok?await E.json():{requests:[]},oe=J.ok?await J.json():{messages:[]};ce(z.requests?.length||0),I((oe.messages||[]).filter(je=>!je.read).length)}catch(E){return console.error("Failed to refresh friend notifications:",E),!1}return!0},[m?.email]),K=i.useRef(0),le=i.useRef(null);if(i.useEffect(()=>{if(!m?.subscription){q(!1);return}const E=m.subscription,J=Date.now();let z=null;E?.expiresAt&&(z=typeof E.expiresAt=="string"?Date.parse(E.expiresAt):Number(E.expiresAt));const oe=4320*60*1e3;if(z&&z>J&&z-J<=oe){q(!0);return}if(z&&z<=J&&!m?.fullAccess){q(!0);return}if(E?.source==="stripe"&&E?.status&&E.status!=="active"){q(!0);return}q(!1)},[m?.subscription,m?.fullAccess]),i.useEffect(()=>{let E=!0;if(!m?.email)return ne([]),()=>{E=!1};const J=async()=>{const oe=await B();E&&ne(oe||[])};J();const z=setInterval(J,3e4);return()=>{E=!1,clearInterval(z)}},[B,m?.email]),i.useEffect(()=>{if(!m?.email)return;let E=!0;const J=async()=>{try{if(!E||typeof document<"u"&&!document.hasFocus())return;const je=le.current;if(je&&Date.now()<je)return;await de()?(K.current=0,le.current=null):(K.current=(K.current||0)+1,K.current>=3&&(le.current=Date.now()+300*1e3,console.warn("Friend/message polling disabled for 5 minutes due to repeated failures")))}catch{}};J();const z=()=>{try{J()}catch{}};window.addEventListener("focus",z);const oe=setInterval(()=>{try{J()}catch{}},3e4);return()=>{E=!1,window.removeEventListener("focus",z),clearInterval(oe)}},[de,m?.email]),i.useEffect(()=>{m?.email||(ce(0),I(0))},[m?.email]),i.useEffect(()=>{if(!m?.subscription||!m?.email)return;const E=m.subscription,J=Date.now();let z=null;E?.expiresAt&&(z=typeof E.expiresAt=="string"?Date.parse(E.expiresAt):Number(E.expiresAt));const oe=4320*60*1e3;async function je(se,$e){try{const jt=localStorage.getItem("authToken"),Mt={"Content-Type":"application/json"};jt&&(Mt.Authorization=`Bearer ${jt}`),await fetch("/api/notifications",{method:"POST",headers:Mt,body:JSON.stringify({email:m.email,message:$e,type:se})})}catch{}}if(z&&z>J&&z-J<=oe){je("sub_expiring",`Your premium subscription expires in ${Math.ceil((z-J)/(1440*60*1e3))} day(s)`);return}if(z&&z<=J&&!m?.fullAccess){je("sub_expired","Your premium subscription has ended");return}},[m?.email,m?.subscription,m?.fullAccess]),i.useEffect(()=>{if(!G)return;const E=J=>{J.key==="Escape"&&ge(!1)};return document.addEventListener("keydown",E),()=>{document.removeEventListener("keydown",E)}},[G]),i.useEffect(()=>{const E=()=>ge(!0);return window.addEventListener(Ma,E),()=>window.removeEventListener(Ma,E)},[]),!m)return e.jsx(nm,{onAuth:E=>{try{const J=localStorage.getItem(`ndn:subscription:${E.email}`);k(J?{...E,subscription:JSON.parse(J)}:E)}catch{k(E)}ie(E)}});const we=`https://ui-avatars.com/api/?name=${encodeURIComponent(m.username||"NDN")}&background=8F43EE&color=fff&bold=true&rounded=true&size=64`,He=E=>`${E.type||""} ${E.message||""}`.trim(),Qe=Pe.filter(E=>/(tournament|bracket)/i.test(He(E))).length,tt=Pe.filter(E=>/(check[-_\s]?in)/i.test(He(E))).length,pt=Pe.filter(E=>/(match|invite)/i.test(He(E))).length,st=[{key:"tournaments",label:"Tournament Closures",description:"Bracket updates and notices.",count:Qe,icon:dr},{key:"checkins",label:"Check-ins",description:"Venue reminders and start-of-round checks.",count:tt,icon:Ac},{key:"match-invites",label:"Match Invites",description:"Pending matches ready to accept.",count:pt,icon:Mc},{key:"friend-requests",label:"Friend Requests",description:"Accept or decline new connections.",count:Ae,icon:$s},{key:"messages",label:"Messages",description:"Unread chats and replies.",count:H,icon:Tn}];return e.jsxs(zo,{children:[e.jsxs("div",{ref:t,className:`${m?.fullAccess?"premium-body":""} h-screen overflow-hidden pt-1 pb-0 px-1 xs:pt-2 xs:pb-0 xs:px-2 sm:pt-3 sm:pb-0 sm:px-3 md:pt-4 md:pb-0 md:px-4`,children:[e.jsx(ku,{}),e.jsxs("div",{className:"max-w-[1600px] mx-auto grid grid-cols-1 lg:grid-cols-[auto,1fr] gap-4 sm:gap-6 h-full overflow-hidden",children:[!b&&e.jsx("div",{className:"relative hidden lg:block w-72",children:e.jsx(yd,{className:"w-full h-full",active:c,onChange:E=>{l(E)},user:m})}),e.jsxs("div",{className:"flex flex-col h-full overflow-hidden",children:[e.jsxs("div",{className:"pt-1 xs:pt-2 relative z-50",children:[e.jsxs("header",{id:"ndn-header","data-testid":"ndn-header",className:`header glass flex items-center justify-between gap-2 sm:gap-4 transition-all duration-200 ${P?"py-1 px-2":"py-2 px-4"}`,style:{willChange:"transform"},children:[b&&e.jsx("button",{className:"ndn-mobile-brand shrink-0 text-sm font-black px-3 py-2 rounded-xl bg-gradient-to-r from-indigo-600 to-violet-600 text-white shadow-lg shadow-indigo-500/20 hover:shadow-indigo-500/40 transition-all border border-white/10",onClick:()=>{l("score"),g(!1)},"aria-label":"Go Home",title:"Go Home",children:"NDN ðŸŽ¯"}),e.jsxs("div",{className:"flex items-center gap-3 min-w-0 shrink ndn-greeting",children:[!b&&e.jsxs("div",{className:"relative shrink-0",children:[e.jsx("img",{src:n||we,alt:"avatar",className:"w-7 h-7 sm:w-8 sm:h-8 rounded-full ring-1 ring-indigo-400/50 object-cover shadow-sm"}),e.jsx("div",{className:"absolute -bottom-0.5 -right-0.5 w-2 h-2 bg-emerald-500 border border-[#13111C] rounded-full"})]}),e.jsx("div",{className:"min-w-0",children:e.jsxs("div",{className:"flex flex-col gap-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[b&&e.jsxs("div",{className:"relative mr-0",children:[e.jsx("img",{src:n||we,alt:"avatar",className:"w-8 h-8 rounded-full ring-1 ring-indigo-400/50 object-cover shadow-sm"}),e.jsx("div",{className:"absolute -bottom-0.5 -right-0.5 w-2 h-2 bg-emerald-500 border border-[#13111C] rounded-full"})]}),e.jsxs("span",{className:"truncate text-xs text-white/70 ndn-greeting-welcome",children:["Welcome,"," ",e.jsx("span",{className:"font-bold text-white",children:m.username})]})]}),e.jsxs("div",{className:"flex items-center gap-2 shrink-0 text-[11px] sm:text-xs text-white/60 ndn-greeting-avg",children:[e.jsx("span",{className:"uppercase tracking-[0.3em] text-white/35 text-[9px]",children:M==="24h"?"30-Day 3-Dart Avg":"All-Time 3-Dart Avg"}),e.jsx("span",{className:"text-sm sm:text-base font-black text-white tracking-tight",children:C.toFixed(1)}),L!==0&&e.jsxs("span",{className:`flex items-center gap-1 text-[11px] sm:text-xs font-semibold ${L>0?"text-emerald-300":"text-rose-300"}`,children:[L>0?e.jsx(Dc,{className:"w-3 h-3"}):e.jsx(Ic,{className:"w-3 h-3"}),L>0?"+":"",L.toFixed(1)]})]})]})})]}),!b&&e.jsx("div",{className:"flex-1 flex justify-center px-2",children:e.jsx("h1",{className:"w-full sm:w-auto",children:e.jsxs("button",{type:"button",className:"w-full sm:w-auto flex items-center justify-center rounded-2xl border border-white/10 bg-black/40 px-4 py-2 text-base xs:text-xl sm:text-2xl font-black text-white tracking-tighter drop-shadow-lg whitespace-nowrap cursor-pointer select-none hover:bg-black/50 transition-colors",onClick:()=>{l("score")},title:"Go Home",children:[e.jsx("span",{className:"xs:hidden",children:"NDN ðŸŽ¯"}),e.jsx("span",{className:"hidden xs:inline",children:"NINE-DART-NATION ðŸŽ¯"})]})})}),e.jsxs("div",{className:"flex items-center gap-1.5 sm:gap-3 shrink-0",children:[e.jsx(Bm,{className:"mr-1"}),e.jsx("div",{className:"flex items-center gap-1 sm:gap-2 bg-black/20 p-1 rounded-full border border-white/5",children:e.jsx("button",{className:"px-2 sm:px-3 py-1 text-[10px] font-bold uppercase tracking-wider rounded-full bg-white/5 hover:bg-white/10 text-white transition-all",onClick:()=>{const E=t.current;E&&(document.fullscreenElement?document.exitFullscreen().catch(()=>{}):E.requestFullscreen().catch(()=>{}))},children:s?"Exit":"Full"})}),!P&&e.jsxs("div",{className:"hidden sm:flex items-center ml-2 space-x-2",children:[e.jsx(um,{}),e.jsx(dm,{})]})]})]}),b&&e.jsx("div",{"aria-hidden":!0,className:"ndn-mobile-menu-slot"})]}),b&&e.jsx(eh,{open:f,onClose:()=>g(!1),active:c,onChange:E=>{l(E),g(!1)},user:m,avatar:n||we}),e.jsxs("main",{id:"ndn-main-scroll",className:"space-y-4 flex-1 overflow-y-auto pr-1 flex flex-col",style:{willChange:"scroll-position",transform:"translateZ(0)",WebkitOverflowScrolling:"touch"},children:[c==="settings"&&e.jsx(i.Suspense,{fallback:e.jsx("div",{className:"p-4",children:"Loading settings..."}),children:e.jsx(Hn,{className:"flex-1 min-h-0",children:e.jsx(tm,{user:m})})}),c==="score"&&e.jsx(i.Suspense,{fallback:e.jsx("div",{className:"p-4",children:"Loading home..."}),children:e.jsx(Hn,{className:"flex-1 min-h-0",children:e.jsx(Wm,{user:m})})}),c==="online"&&e.jsx(i.Suspense,{fallback:e.jsx("div",{className:"p-4",children:"Loading online..."}),children:e.jsx(Hn,{className:"flex-1 min-h-0",children:e.jsx(Gm,{user:m})})}),c==="offline"&&e.jsx(i.Suspense,{fallback:e.jsx("div",{className:"p-4",children:"Loading offline..."}),children:e.jsx(Hn,{className:"flex-1 min-h-0",children:e.jsx(Hm,{user:m})})}),e.jsx("div",{className:c==="calibrate"?"":"hidden",children:e.jsx(Hn,{children:e.jsx(Su,{})})}),c==="friends"&&e.jsx(i.Suspense,{fallback:e.jsx("div",{className:"p-4",children:"Loading friends..."}),children:e.jsx(Hn,{className:"flex-1 min-h-0",children:e.jsx(qm,{user:m})})}),c==="stats"&&e.jsx(i.Suspense,{fallback:e.jsx("div",{className:"p-4",children:"Loading stats..."}),children:e.jsx(Hn,{className:"flex-1 min-h-0",children:e.jsx(Jm,{user:m})})}),c==="tournaments"&&e.jsx(i.Suspense,{fallback:e.jsx("div",{className:"p-4",children:"Loading tournaments..."}),children:e.jsx(Hn,{className:"flex-1 min-h-0",children:e.jsx(Ym,{user:m})})}),c==="admin"&&e.jsx(i.Suspense,{fallback:e.jsx("div",{className:"p-4",children:"Loading admin..."}),children:e.jsx(Hn,{className:"flex-1 min-h-0",children:e.jsxs("div",{className:"flex-1 min-h-0 space-y-6",children:[e.jsx(Ku,{user:m}),e.jsx(Xm,{user:m})]})})}),c==="fullaccess"&&e.jsx(i.Suspense,{fallback:e.jsx("div",{className:"p-4",children:"Loading admin access..."}),children:e.jsx(Hn,{className:"flex-1 min-h-0",children:e.jsx(Km,{user:m})})})]}),b&&e.jsx(Zm,{active:c,onChange:l,onMore:()=>g(!0)})]})]})]}),e.jsx(rm,{}),e.jsx(pm,{}),!x&&e.jsx(sm,{}),!x&&e.jsx(im,{}),!x&&e.jsx(lm,{}),G&&e.jsx("div",{className:"fixed inset-0 z-[9999] flex items-center justify-center bg-black/90 backdrop-blur-sm p-4",onClick:()=>ge(!1),children:e.jsxs("div",{role:"dialog","aria-modal":"true",className:"relative w-full max-w-4xl max-h-[85vh] overflow-y-auto rounded-3xl border border-white/10 bg-[#13111C] p-6 md:p-8 shadow-2xl animate-in fade-in zoom-in-95 duration-200 overflow-hidden",onClick:E=>E.stopPropagation(),children:[e.jsx("div",{className:"absolute inset-0 bg-[url('https://grainy-gradients.vercel.app/noise.svg')] opacity-20 pointer-events-none mix-blend-overlay"}),e.jsx("div",{className:"absolute -top-24 -right-24 w-64 h-64 bg-indigo-500/20 rounded-full blur-3xl pointer-events-none"}),e.jsx("div",{className:"absolute -bottom-24 -left-24 w-64 h-64 bg-emerald-500/20 rounded-full blur-3xl pointer-events-none"}),e.jsx("button",{className:"absolute right-4 top-4 flex h-8 w-8 items-center justify-center rounded-full bg-white/5 hover:bg-white/10 text-white transition z-10",onClick:()=>ge(!1),"aria-label":"Close notifications",children:"Ã—"}),e.jsxs("div",{className:"relative z-10 flex items-center gap-4 mb-8 border-b border-white/5 pb-6",children:[e.jsx("div",{className:"p-4 rounded-2xl bg-gradient-to-br from-amber-500/20 to-orange-500/20 text-amber-400 shadow-lg shadow-amber-500/10 ring-1 ring-white/10",children:e.jsx(xo,{className:"h-8 w-8"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r from-white via-white to-white/50 tracking-tight",children:"Notifications"}),e.jsx("p",{className:"text-sm text-white/50 font-medium",children:"Stay updated with your latest activity"})]})]}),e.jsxs("div",{className:"relative z-10",children:[ae&&e.jsxs("div",{className:"mb-8 rounded-2xl bg-gradient-to-r from-amber-500/10 to-orange-500/10 border border-amber-500/20 p-6 flex flex-col sm:flex-row items-start gap-5 shadow-lg shadow-amber-500/5",children:[e.jsx("div",{className:"p-3 rounded-xl bg-amber-500/20 text-amber-400 shrink-0 ring-1 ring-amber-500/30",children:e.jsx(dr,{className:"h-6 w-6"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"font-bold text-lg text-amber-200",children:"Premium Subscription Alert"}),e.jsx("p",{className:"text-sm text-amber-100/70 mt-1 leading-relaxed",children:"Your premium subscription is expiring soon or has expired. Renew now to keep full access to all features!"}),e.jsx("button",{onClick:()=>{ge(!1),l("settings")},className:"mt-4 px-6 py-2.5 rounded-xl bg-gradient-to-r from-amber-500 to-orange-600 text-white font-bold text-sm hover:shadow-lg hover:shadow-amber-500/25 hover:scale-105 transition-all duration-200",children:"Manage Subscription"})]})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 mb-10",children:st.map(E=>{const J=E.icon;return e.jsxs("div",{className:"group flex items-center gap-4 p-4 rounded-2xl bg-white/5 border border-white/5 hover:bg-white/10 hover:border-white/10 transition-all duration-200 cursor-pointer hover:shadow-xl hover:shadow-black/20 hover:-translate-y-0.5",onClick:()=>{ge(!1),(E.key==="friend-requests"||E.key==="messages")&&l("friends"),E.key==="tournaments"&&l("tournaments")},children:[e.jsx("div",{className:"p-3 rounded-xl bg-indigo-500/10 text-indigo-400 group-hover:bg-indigo-500/20 group-hover:text-indigo-300 group-hover:scale-110 transition-all duration-300 ring-1 ring-white/5",children:e.jsx(J,{className:"h-6 w-6"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"font-bold text-white group-hover:text-indigo-200 transition-colors",children:E.label}),e.jsx("p",{className:"text-xs text-white/50 group-hover:text-white/70 transition-colors",children:E.description})]}),E.count>0&&e.jsx("span",{className:"px-3 py-1 rounded-full bg-rose-500 text-white font-bold text-xs shadow-lg shadow-rose-500/30 animate-pulse",children:E.count})]},E.key)})}),e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsx("h3",{className:"text-xs font-bold text-white/40 uppercase tracking-[0.2em]",children:"Recent Activity"}),Pe.length>0&&e.jsxs("span",{className:"text-xs font-medium text-white/30 bg-white/5 px-2 py-1 rounded-md",children:[Pe.length," total"]})]}),e.jsx("div",{className:"space-y-3",children:Pe.length===0?e.jsxs("div",{className:"text-center py-16 rounded-3xl border border-dashed border-white/10 bg-white/[0.02]",children:[e.jsx("div",{className:"w-16 h-16 mx-auto mb-4 rounded-full bg-white/5 flex items-center justify-center text-white/20",children:e.jsx(xo,{className:"h-8 w-8"})}),e.jsx("p",{className:"text-white/40 font-medium",children:"No recent notifications"}),e.jsx("p",{className:"text-xs text-white/20 mt-1",children:"You're all caught up!"})]}):Pe.map(E=>e.jsxs("div",{className:`relative overflow-hidden rounded-2xl border p-5 transition-all duration-200 group ${E.read?"bg-white/[0.02] border-white/5 hover:bg-white/5":"bg-white/10 border-white/10 hover:bg-white/15 shadow-lg shadow-black/20"}`,children:[!E.read&&e.jsx("div",{className:"absolute left-0 top-0 bottom-0 w-1 bg-gradient-to-b from-rose-500 to-orange-500"}),e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center justify-between gap-2 mb-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:`text-[0.65rem] font-bold uppercase tracking-wider px-2 py-1 rounded-md ring-1 ring-inset ${E.read?"bg-white/5 text-white/40 ring-white/5":"bg-rose-500/10 text-rose-300 ring-rose-500/20"}`,children:E.type||"General"}),e.jsx("span",{className:"text-xs text-white/30 font-medium",children:new Date(E.createdAt).toLocaleDateString(void 0,{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})})]}),!E.read&&e.jsx("span",{className:"self-start sm:self-auto rounded-full bg-rose-500 px-2 py-0.5 text-[0.6rem] font-bold uppercase tracking-widest text-white shadow-sm shadow-rose-500/20",children:"New"})]}),e.jsx("p",{className:"text-sm font-medium text-white/90 leading-relaxed pl-1",children:E.message}),E.link&&e.jsx("a",{href:E.link,target:"_blank",rel:"noreferrer",className:"mt-4 inline-flex items-center gap-1.5 text-xs font-bold text-emerald-400 hover:text-emerald-300 transition-colors bg-emerald-500/10 px-3 py-1.5 rounded-lg hover:bg-emerald-500/20",children:"Open Link â†—"}),e.jsxs("div",{className:"mt-4 flex items-center gap-3 border-t border-white/5 pt-3 opacity-0 group-hover:opacity-100 transition-opacity duration-200",children:[!E.read&&e.jsx("button",{onClick:async J=>{J.stopPropagation();try{const z=localStorage.getItem("authToken");await fetch(`/api/notifications/${encodeURIComponent(E.id)}?email=${encodeURIComponent(m.email)}`,{method:"PATCH",headers:{"Content-Type":"application/json",Authorization:`Bearer ${z}`},body:JSON.stringify({read:!0})});const oe=await B();oe&&ne(oe)}catch{}},className:"text-xs font-bold text-white/50 hover:text-white transition-colors uppercase tracking-wider",children:"Mark as read"}),e.jsx("button",{onClick:async J=>{if(J.stopPropagation(),!!confirm("Delete this notification?"))try{const z=localStorage.getItem("authToken");await fetch(`/api/notifications/${encodeURIComponent(E.id)}?email=${encodeURIComponent(m.email)}`,{method:"DELETE",headers:{Authorization:`Bearer ${z}`}});const oe=await B();oe&&ne(oe)}catch{}},className:"text-xs font-bold text-rose-400/50 hover:text-rose-400 transition-colors ml-auto uppercase tracking-wider",children:"Delete"})]})]},E.id))})]})]})}),!x&&e.jsx(am,{}),m&&e.jsx("div",{"aria-hidden":!0,style:{position:"fixed",right:0,bottom:0,width:"4px",height:"4px",overflow:"hidden",pointerEvents:"none",opacity:.001,zIndex:-100,transform:"translateZ(0)"},children:e.jsx(i.Suspense,{fallback:null,children:e.jsx(zm,{showToolbar:!1,hideInlinePanels:!0,scoringMode:"custom",immediateAutoCommit:!1,disableDetection:!0})})})]})}function Zm({active:t,onChange:n,onMore:r}){const s=[{key:"score",label:"Play",icon:ei},{key:"online",label:"Online",icon:Oc},{key:"tournaments",label:"Compete",icon:dr},{key:"stats",label:"Stats",icon:Pc}];return e.jsx("div",{className:"fixed bottom-6 left-1/2 -translate-x-1/2 z-[100] w-full max-w-[360px] px-4 pointer-events-none",children:e.jsxs("div",{className:"flex items-center justify-between bg-zinc-900/90 backdrop-blur-xl border border-white/10 rounded-2xl p-2 shadow-2xl shadow-black/50 ring-1 ring-white/5 pointer-events-auto",children:[s.map(a=>{const o=t===a.key,c=a.icon;return e.jsxs("button",{onClick:()=>n(a.key),className:`relative flex flex-col items-center justify-center gap-1 w-16 h-14 rounded-xl transition-all duration-300 active:scale-90 ${o?"text-white bg-indigo-600 shadow-lg shadow-indigo-500/30":"text-zinc-500 hover:text-zinc-300 hover:bg-white/5"}`,children:[e.jsx(c,{className:`w-5 h-5 transition-transform duration-300 ${o?"-translate-y-0.5 scale-110":""}`,strokeWidth:o?2.5:2}),e.jsx("span",{className:`text-[9px] font-bold tracking-wide transition-opacity duration-300 ${o?"opacity-100":"opacity-70"}`,children:a.label}),o&&e.jsx("span",{className:"absolute -bottom-1 w-1 h-1 bg-indigo-300 rounded-full opacity-50 blur-[1px]"})]},a.key)}),e.jsx("div",{className:"w-px h-8 bg-white/10 mx-1"}),e.jsxs("button",{onClick:r,className:"flex flex-col items-center justify-center gap-1 w-16 h-14 rounded-xl text-zinc-500 hover:text-white hover:bg-white/5 transition-all duration-200 active:scale-95",children:[e.jsx(Rc,{className:"w-6 h-6"}),e.jsx("span",{className:"text-[9px] font-bold tracking-wide opacity-70",children:"More"})]})]})})}function eh({open:t,onClose:n,active:r,onChange:s,user:a,avatar:o}){const c=Mi(a?.email),l=Li(a,c),[b,u]=Nt.useState(!1),[f,g]=Nt.useState(!1),m=`https://ui-avatars.com/api/?name=${encodeURIComponent(a?.username||"NDN")}&background=8F43EE&color=fff&bold=true&rounded=true&size=64`,A=o||m,k=!!a?.fullAccess;return t?e.jsxs("div",{className:"fixed inset-0 z-[150] bg-[#0f0e13]/95 backdrop-blur-xl animate-in fade-in zoom-in-95 duration-200 flex flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b border-white/5 bg-white/[0.02]",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"relative",children:[e.jsx("img",{src:A,className:`w-12 h-12 rounded-full object-cover ring-2 ${k?"ring-indigo-500 shadow-lg shadow-indigo-500/30":"ring-white/10"}`,alt:a.username}),k&&e.jsx("div",{className:"absolute -bottom-1 -right-1 bg-indigo-500 text-white rounded-full p-1 border border-[#0f0e13]",children:e.jsx(dr,{className:"w-3 h-3"})})]}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"font-bold text-white text-xl tracking-tight",children:a.username}),e.jsx("span",{className:`text-xs font-medium uppercase tracking-wider ${k?"text-indigo-400":"text-white/40"}`,children:k?"Premium Member":"Free Account"})]})]}),e.jsx("button",{onClick:n,className:"p-3 rounded-full bg-white/5 text-white/70 hover:bg-white/10 hover:text-white transition-all active:scale-95 border border-white/5 shadow-lg",children:e.jsx(Pa,{className:"w-6 h-6"})})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-6",style:{WebkitOverflowScrolling:"touch"},children:[e.jsx("h3",{className:"text-[10px] font-black text-white/30 uppercase tracking-[0.2em] mb-4",children:"Menu"}),e.jsx("div",{className:"grid grid-cols-2 gap-3 mb-8",children:l.map(S=>{const x=S.icon,w=r===S.key;return e.jsxs("button",{onClick:()=>{s(S.key),n()},className:`group flex flex-col items-start gap-3 p-4 rounded-2xl border transition-all duration-200 active:scale-95 ${w?"bg-indigo-600 border-indigo-500 text-white shadow-xl shadow-indigo-900/30":"bg-white/5 border-white/5 text-slate-400 hover:bg-white/10 hover:text-white hover:border-white/10"}`,children:[e.jsx("div",{className:`p-2 rounded-xl ${w?"bg-white/20":"bg-black/20 group-hover:bg-white/10"}`,children:e.jsx(x,{className:"w-6 h-6"})}),e.jsx("span",{className:"font-bold text-sm",children:S.label})]},S.key)})}),e.jsx("h3",{className:"text-[10px] font-black text-white/30 uppercase tracking-[0.2em] mb-4",children:"Community"}),e.jsxs("div",{className:"space-y-3 pb-24",children:[e.jsxs("button",{onClick:()=>u(!0),className:"w-full flex items-center gap-4 p-4 rounded-2xl bg-[#5865F2]/10 border border-[#5865F2]/20 text-[#5865F2] hover:bg-[#5865F2]/20 transition-all active:scale-98",children:[e.jsx(Tn,{className:"w-6 h-6"}),e.jsxs("div",{className:"flex flex-col items-start",children:[e.jsx("span",{className:"font-bold",children:"Bullseye League"}),e.jsx("span",{className:"text-xs opacity-70",children:"Join the competition"})]})]}),e.jsxs("button",{onClick:()=>g(!0),className:"w-full flex items-center gap-4 p-4 rounded-2xl bg-[#5865F2]/10 border border-[#5865F2]/20 text-[#5865F2] hover:bg-[#5865F2]/20 transition-all active:scale-98",children:[e.jsx(Tn,{className:"w-6 h-6"}),e.jsxs("div",{className:"flex flex-col items-start",children:[e.jsx("span",{className:"font-bold",children:"NDN Community"}),e.jsx("span",{className:"text-xs opacity-70",children:"Get help & support"})]})]})]})]}),b&&e.jsx("div",{className:"fixed inset-0 z-[2000] flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm animate-in fade-in duration-200",children:e.jsxs("div",{className:"bg-[#1a1825] border border-white/10 rounded-3xl p-6 max-w-sm w-full shadow-2xl",children:[e.jsx("h2",{className:"text-xl font-bold text-white mb-2",children:"Join Bullseye League"}),e.jsx("p",{className:"text-slate-400 text-sm mb-6",children:"Connect with enthusiasts and compete in tourneys!"}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsx("button",{onClick:()=>u(!1),className:"px-4 py-3 rounded-xl bg-white/5 hover:bg-white/10 text-white text-sm font-bold",children:"Cancel"}),e.jsx("a",{href:Oi,target:"_blank",rel:"noopener noreferrer",className:"px-4 py-3 rounded-xl bg-[#5865F2] hover:bg-[#4752C4] text-white text-sm font-bold text-center",children:"Join"})]})]})}),f&&e.jsx("div",{className:"fixed inset-0 z-[2000] flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm animate-in fade-in duration-200",children:e.jsxs("div",{className:"bg-[#1a1825] border border-white/10 rounded-3xl p-6 max-w-sm w-full shadow-2xl",children:[e.jsx("h2",{className:"text-xl font-bold text-white mb-2",children:"NDN Community"}),e.jsx("p",{className:"text-slate-400 text-sm mb-6",children:"Official Nine Dart Nation community."}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsx("button",{onClick:()=>g(!1),className:"px-4 py-3 rounded-xl bg-white/5 hover:bg-white/10 text-white text-sm font-bold",children:"Cancel"}),e.jsx("a",{href:"https://discord.gg/ninedartnation",target:"_blank",rel:"noopener noreferrer",className:"px-4 py-3 rounded-xl bg-[#5865F2] hover:bg-[#4752C4] text-white text-sm font-bold text-center",children:"Join"})]})]})})]}):null}function th(t){return t.length>=10&&/\d/.test(t)&&/[^A-Za-z0-9]/.test(t)}function nh(){const[t,n]=i.useState(""),[r,s]=i.useState(""),[a,o]=i.useState(""),[c,l]=i.useState(""),[b,u]=i.useState("");i.useEffect(()=>{try{const m=new URLSearchParams(window.location.search).get("token")||"";n(m)}catch{}},[]);async function f(g){if(g.preventDefault(),l(""),u(""),!t){l("Missing or invalid reset token.");return}if(!r||r!==a){l("Passwords do not match.");return}if(!th(r)){l("Password must be at least 10 chars and include a number and symbol.");return}try{const A=await(await fetch("/api/auth/confirm-reset",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({token:t,newPassword:r})})).json();if(!A?.ok)throw new Error(A?.error||"Reset failed");u("Password changed. You can now sign in.")}catch(m){l(m?.message||"Reset failed")}}return e.jsxs("div",{className:"min-h-screen flex items-center justify-center relative overflow-hidden",children:[e.jsx("div",{className:"background-animated"}),e.jsx("div",{className:"relative z-10 w-full max-w-lg mx-auto p-4",children:e.jsxs("form",{className:"card w-full space-y-4",onSubmit:f,children:[e.jsx("div",{className:"flex flex-col items-center justify-center gap-2 mb-2 text-center",children:e.jsx("h1",{className:"logo text-center",children:"Reset your password"})}),!t&&e.jsx("div",{className:"text-red-400",children:"This reset link is missing a token. Please use the link from your email."}),e.jsx("input",{className:"input w-full",type:"password",placeholder:"New password",value:r,onChange:g=>s(g.target.value),required:!0}),e.jsx("input",{className:"input w-full",type:"password",placeholder:"Confirm password",value:a,onChange:g=>o(g.target.value),required:!0}),c&&e.jsx("div",{className:"text-red-400 font-semibold text-sm",children:c}),b&&e.jsx("div",{className:"text-emerald-400 font-semibold text-sm",children:b}),e.jsx("button",{className:"btn w-full",type:"submit",disabled:!t,children:"Change Password"}),e.jsx("a",{className:"underline text-sm text-center",href:"/",children:"Back to sign in"})]})})]})}class rh extends i.Component{constructor(n){super(n),this.state={hasError:!1}}static getDerivedStateFromError(n){return{hasError:!0,message:String(n?.message||n)}}componentDidCatch(n,r){console.error("[ErrorBoundary]",n,r)}render(){return this.state.hasError?e.jsx("div",{className:"min-h-screen flex items-center justify-center p-6",children:e.jsxs("div",{className:"card max-w-lg w-full text-center",children:[e.jsx("h2",{className:"text-2xl font-bold mb-2",children:"Something went wrong"}),e.jsx("p",{className:"opacity-80 mb-4",children:"Please refresh the page. If this persists, let us know."}),this.state.message&&e.jsx("pre",{className:"text-xs bg-black/40 rounded p-2 overflow-auto text-left",children:this.state.message}),e.jsx("button",{className:"btn mt-4",onClick:()=>window.location.reload(),children:"Reload"})]})}):this.props.children}}function sh(){if(!(typeof window>"u"))try{window.deferredInstallPrompt=null,window.addEventListener("beforeinstallprompt",t=>{(window.__NDN_DEFER_INSTALL_PROMPT__||localStorage.getItem("NDN_DEFER_INSTALL_PROMPT")==="1")&&(t.preventDefault(),window.deferredInstallPrompt=t)}),window.promptInstallApp=async()=>{try{const t=window.deferredInstallPrompt;if(!t)return!1;t.prompt();const n=await t.userChoice;return!!n&&n.outcome==="accepted"}catch{return!1}}}catch{}}const ah={};function oh(){if(!(String(ah?.VITE_QUIET_CONSOLE||"").trim()==="1"))return;const n=window;if(n.__ndnQuietConsoleInstalled)return;n.__ndnQuietConsoleInstalled=!0;const r={error:console.error.bind(console),warn:console.warn.bind(console),log:console.log.bind(console)},s=l=>{const b=l.map(u=>typeof u=="string"?u:u?.message||"").join(" ");return!!(/Not implemented: HTMLMediaElement's play\(\) method/i.test(b)||/WebSocket connection to .* failed/i.test(b)||/ERR_NETWORK_IO_SUSPENDED|ERR_NETWORK_CHANGED/i.test(b))},a=new Map,o=2e3,c=l=>(...b)=>{if(s(b))return;const u=String(b[0]??""),f=Date.now(),g=a.get(u)||0;f-g<o||(a.set(u,f),l(...b))};console.error=c(r.error),console.warn=c(r.warn),window.addEventListener("unhandledrejection",l=>{const b=l.reason&&(l.reason.message||String(l.reason))||"unhandledrejection",u=Date.now(),f=a.get(b)||0;u-f<o||(a.set(b,u),r.warn("[ndn] Unhandled promise rejection:",l.reason))})}try{window.React=window.React||{}}catch{}bd();sh();oh();try{let t=null;const n=r=>{try{if(t=r,console.error("[NDN ErrorCollector] Captured error:",r),typeof navigator<"u"&&navigator.clipboard?.writeText)try{const s=typeof r=="string"?r:JSON.stringify(r,null,2);navigator.clipboard.writeText(s).then(()=>console.info("[NDN ErrorCollector] Error copied to clipboard"),()=>console.info("[NDN ErrorCollector] Could not copy to clipboard"))}catch{}}catch(s){try{console.error("[NDN ErrorCollector] capture failed",s)}catch{}}};window.addEventListener("error",r=>{try{const s={message:r?.message||r?.error&&r.error.message||String(r),filename:r?.filename||null,lineno:r?.lineno||null,colno:r?.colno||null,stack:r?.error?.stack||r?.error&&String(r.error)||null,type:"error"};n(s)}catch(s){try{console.error("[NDN ErrorCollector] error handler failed",s)}catch{}}},!0),window.addEventListener("unhandledrejection",r=>{try{const s=r?.reason,a={message:s?.message||String(s)||"UnhandledRejection",stack:s?.stack||null,type:"unhandledrejection"};n(a)}catch(s){try{console.error("[NDN ErrorCollector] unhandledrejection handler failed",s)}catch{}}}),window.__ndn_error_collector={collect:async()=>{try{if(!t)return null;if(typeof navigator<"u"&&navigator.clipboard?.writeText)try{await navigator.clipboard.writeText(JSON.stringify(t,null,2)),console.info("[NDN ErrorCollector] Last error copied to clipboard")}catch{console.info("[NDN ErrorCollector] Could not copy last error to clipboard")}return t}catch(r){try{console.error("[NDN ErrorCollector] collect failed",r)}catch{}return null}},last:()=>t}}catch(t){try{console.warn("[NDN ErrorCollector] install failed",t)}catch{}}$c.createRoot(document.getElementById("root")).render(e.jsx(i.StrictMode,{children:e.jsx(rh,{children:e.jsx(wu,{children:e.jsx(ih,{})})})}));function ih(){return window.location.pathname==="/reset"?e.jsx(nh,{}):e.jsx(Qm,{})}const ch=new URLSearchParams(window.location.search).get("pwa")==="1"||typeof localStorage<"u"&&localStorage.getItem("NDN_ENABLE_PWA")==="1";if(ch&&typeof navigator<"u"&&"serviceWorker"in navigator)try{navigator.serviceWorker.register("/sw.js").then(t=>{console.debug("[ServiceWorker] Registered",t)}).catch(t=>{console.warn("[ServiceWorker] Registration failed",t)})}catch{}else if(typeof navigator<"u"&&"serviceWorker"in navigator)try{navigator.serviceWorker.getRegistrations().then(t=>{if(!t||t.length===0)return;try{console.info("[ServiceWorker] Found",t.length,"registrations â€” unregistering to avoid stale caches")}catch{}let n=!1;t.forEach(r=>{try{r.active&&(n=!0)}catch{}try{r.unregister()}catch(s){try{console.warn("[ServiceWorker] unregister failed:",s)}catch{}}});try{const r=typeof localStorage<"u"&&localStorage.getItem("NDN_FORCE_SW_RELOAD")==="1";if(n&&r)try{console.info("[ServiceWorker] Active worker removed; forcing page reload to fetch latest assets"),localStorage.removeItem("NDN_FORCE_SW_RELOAD"),window.location.reload()}catch{}}catch{}})}catch{}export{mr as A,hh as B,rs as C,$o as D,Cr as E,rc as F,Mm as G,cc as H,Ru as I,Xi as J,Lu as K,Eu as L,Fm as M,As as N,Vu as O,wm as P,ga as Q,hm as R,Mi as S,Tu as T,Fn as U,xn as a,no as b,sc as c,Ws as d,Xa as e,ph as f,Yn as g,Ri as h,mt as i,e as j,on as k,fh as l,Un as m,Um as n,fc as o,$r as p,$u as q,ka as r,Hu as s,Bu as t,ve as u,Os as v,uh as w,mh as x,Lm as y,Ou as z};
//# sourceMappingURL=index-DSVlaVGc.js.map
