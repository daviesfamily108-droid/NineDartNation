const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/Home-CWDFpsAt.js","assets/ui-gqBJRRJB.js","assets/vendor-D3F3s8fL.js","assets/stats-X3jz_E9o.js","assets/OnlinePlay.clean-BAzALA79.js","assets/GameCalibrationStatus-D9s5-k_7.js","assets/MatchStartShowcase-D5aABmM1.js","assets/OfflinePlay-DvEQLJLW.js","assets/MatchControls-BfVc-yS2.js","assets/Scoreboard-2xapDfxT.js","assets/StatsPanel-hbFwEa4y.js","assets/Friends-Dc-niZ5t.js","assets/Tournaments-CbESpCC_.js","assets/AdminAccess-Be8M_8R4.js","assets/OpsDashboard-DCeWlDIr.js"])))=>i.map(i=>d[i]);
import{r as ia,a as po,g as xo}from"./vendor-D3F3s8fL.js";import{r as f,R as jt,S as ls,L as Ni,M as Tn,a as Si,U as Gs,T as ss,C as Js,P as Ci,Z as Ma,X as bo,b as as,c as ca,d as Mr,E as Ys,V as ki,e as Ei,f as Ii,G as Mi,g as Xs,h as Pi,i as Ti,j as Oi,k as Ai,B as Ri}from"./ui-gqBJRRJB.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))a(s);new MutationObserver(s=>{for(const o of s)if(o.type==="childList")for(const c of o.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&a(c)}).observe(document,{childList:!0,subtree:!0});function n(s){const o={};return s.integrity&&(o.integrity=s.integrity),s.referrerPolicy&&(o.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?o.credentials="include":s.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function a(s){if(s.ep)return;s.ep=!0;const o=n(s);fetch(s.href,o)}})();var Cs={exports:{}},Pr={};/**
 * @license React
 * react-jsx-runtime.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var Pa;function Di(){if(Pa)return Pr;Pa=1;var r=ia(),t=Symbol.for("react.element"),n=Symbol.for("react.fragment"),a=Object.prototype.hasOwnProperty,s=r.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,o={key:!0,ref:!0,__self:!0,__source:!0};function c(i,h,l){var u,m={},d=null,v=null;l!==void 0&&(d=""+l),h.key!==void 0&&(d=""+h.key),h.ref!==void 0&&(v=h.ref);for(u in h)a.call(h,u)&&!o.hasOwnProperty(u)&&(m[u]=h[u]);if(i&&i.defaultProps)for(u in h=i.defaultProps,h)m[u]===void 0&&(m[u]=h[u]);return{$$typeof:t,type:i,key:d,ref:v,props:m,_owner:s.current}}return Pr.Fragment=n,Pr.jsx=c,Pr.jsxs=c,Pr}var Ta;function Li(){return Ta||(Ta=1,Cs.exports=Di()),Cs.exports}var e=Li(),Qr={},Oa;function _i(){if(Oa)return Qr;Oa=1;var r=po();return Qr.createRoot=r.createRoot,Qr.hydrateRoot=r.hydrateRoot,Qr}var Fi=_i();const Ui=xo(Fi),Bi="modulepreload",$i=function(r){return"/"+r},Aa={},cn=function(t,n,a){let s=Promise.resolve();if(n&&n.length>0){let h=function(l){return Promise.all(l.map(u=>Promise.resolve(u).then(m=>({status:"fulfilled",value:m}),m=>({status:"rejected",reason:m}))))};document.getElementsByTagName("link");const c=document.querySelector("meta[property=csp-nonce]"),i=c?.nonce||c?.getAttribute("nonce");s=h(n.map(l=>{if(l=$i(l),l in Aa)return;Aa[l]=!0;const u=l.endsWith(".css"),m=u?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${l}"]${m}`))return;const d=document.createElement("link");if(d.rel=u?"stylesheet":Bi,u||(d.as="script"),d.crossOrigin="",d.href=l,i&&d.setAttribute("nonce",i),document.head.appendChild(d),u)return new Promise((v,x)=>{d.addEventListener("load",v),d.addEventListener("error",()=>x(new Error(`Unable to preload CSS for ${l}`)))})}))}function o(c){const i=new Event("vite:preloadError",{cancelable:!0});if(i.payload=c,window.dispatchEvent(i),!i.defaultPrevented)throw c}return s.then(c=>{for(const i of c||[])i.status==="rejected"&&o(i.reason);return t().catch(o)})};function Vi(r,t){if(r==null)return{};var n={};for(var a in r)if({}.hasOwnProperty.call(r,a)){if(t.indexOf(a)!==-1)continue;n[a]=r[a]}return n}function Dr(){return Dr=Object.assign?Object.assign.bind():function(r){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var a in n)({}).hasOwnProperty.call(n,a)&&(r[a]=n[a])}return r},Dr.apply(null,arguments)}var Ks="data-focus-lock",go="data-focus-lock-disabled",zi="data-no-focus-lock",Wi="data-autofocus-inside",qi="data-no-autofocus";function ks(r,t){return typeof r=="function"?r(t):r&&(r.current=t),r}function Hi(r,t){var n=f.useState(function(){return{value:r,callback:t,facade:{get current(){return n.value},set current(a){var s=n.value;s!==a&&(n.value=a,n.callback(a,s))}}}})[0];return n.callback=t,n.facade}var Gi=typeof window<"u"?f.useLayoutEffect:f.useEffect,Ra=new WeakMap;function Ji(r,t){var n=Hi(null,function(a){return r.forEach(function(s){return ks(s,a)})});return Gi(function(){var a=Ra.get(n);if(a){var s=new Set(a),o=new Set(r),c=n.current;s.forEach(function(i){o.has(i)||ks(i,null)}),o.forEach(function(i){s.has(i)||ks(i,c)})}Ra.set(n,r)},[r]),n}var Es={width:"1px",height:"0px",padding:0,overflow:"hidden",position:"fixed",top:"1px",left:"1px"},Zs=function(){return Zs=Object.assign||function(t){for(var n,a=1,s=arguments.length;a<s;a++){n=arguments[a];for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(t[o]=n[o])}return t},Zs.apply(this,arguments)};function vo(r){return r}function yo(r,t){t===void 0&&(t=vo);var n=[],a=!1,s={read:function(){if(a)throw new Error("Sidecar: could not `read` from an `assigned` medium. `read` could be used only with `useMedium`.");return n.length?n[n.length-1]:r},useMedium:function(o){var c=t(o,a);return n.push(c),function(){n=n.filter(function(i){return i!==c})}},assignSyncMedium:function(o){for(a=!0;n.length;){var c=n;n=[],c.forEach(o)}n={push:function(i){return o(i)},filter:function(){return n}}},assignMedium:function(o){a=!0;var c=[];if(n.length){var i=n;n=[],i.forEach(o),c=n}var h=function(){var u=c;c=[],u.forEach(o)},l=function(){return Promise.resolve().then(h)};l(),n={push:function(u){c.push(u),l()},filter:function(u){return c=c.filter(u),n}}}};return s}function la(r,t){return t===void 0&&(t=vo),yo(r,t)}function Yi(r){r===void 0&&(r={});var t=yo(null);return t.options=Zs({async:!0,ssr:!1},r),t}var wo=la({},function(r){var t=r.target,n=r.currentTarget;return{target:t,currentTarget:n}}),jo=la(),Xi=la(),Ki=Yi({async:!0,ssr:typeof document<"u"}),Zi=f.createContext(void 0),Qi=[],da=f.forwardRef(function(t,n){var a,s=f.useState(),o=s[0],c=s[1],i=f.useRef(),h=f.useRef(!1),l=f.useRef(null),u=f.useState({}),m=u[1],d=t.children,v=t.disabled,x=v===void 0?!1:v,y=t.noFocusGuards,w=y===void 0?!1:y,C=t.persistentFocus,N=C===void 0?!1:C,P=t.crossFrame,S=P===void 0?!0:P,M=t.autoFocus,T=M===void 0?!0:M;t.allowTextSelection;var p=t.group,k=t.className,z=t.whiteList,W=t.hasPositiveIndices,ee=t.shards,Q=ee===void 0?Qi:ee,K=t.as,le=K===void 0?"div":K,ie=t.lockProps,L=ie===void 0?{}:ie,Y=t.sideCar,$=t.returnFocus,B=$===void 0?!1:$,H=t.focusOptions,fe=t.onActivation,Ye=t.onDeactivation,Ce=f.useState({}),Ve=Ce[0],Le=f.useCallback(function(st){var at=st.captureFocusRestore;if(!l.current){var ze,ut=(ze=document)==null?void 0:ze.activeElement;l.current=ut,ut!==document.body&&(l.current=at(ut))}i.current&&fe&&fe(i.current),h.current=!0,m()},[fe]),Nt=f.useCallback(function(){h.current=!1,Ye&&Ye(i.current),m()},[Ye]),St=f.useCallback(function(st){var at=l.current;if(at){var ze=(typeof at=="function"?at():at)||document.body,ut=typeof B=="function"?B(ze):B;if(ut){var Pe=typeof ut=="object"?ut:void 0;l.current=null,st?Promise.resolve().then(function(){return ze.focus(Pe)}):ze.focus(Pe)}}},[B]),zt=f.useCallback(function(st){h.current&&wo.useMedium(st)},[]),He=jo.useMedium,Ie=f.useCallback(function(st){i.current!==st&&(i.current=st,c(st))},[]),Mt=Dr((a={},a[go]=x&&"disabled",a[Ks]=p,a),L),Pt=w!==!0,Qt=Pt&&w!=="tail",Wt=Ji([n,Ie]),Ue=f.useMemo(function(){return{observed:i,shards:Q,enabled:!x,active:h.current}},[x,h.current,Q,o]);return jt.createElement(f.Fragment,null,Pt&&[jt.createElement("div",{key:"guard-first","data-focus-guard":!0,tabIndex:x?-1:0,style:Es}),W?jt.createElement("div",{key:"guard-nearest","data-focus-guard":!0,tabIndex:x?-1:1,style:Es}):null],!x&&jt.createElement(Y,{id:Ve,sideCar:Ki,observed:o,disabled:x,persistentFocus:N,crossFrame:S,autoFocus:T,whiteList:z,shards:Q,onActivation:Le,onDeactivation:Nt,returnFocus:St,focusOptions:H,noFocusGuards:w}),jt.createElement(le,Dr({ref:Wt},Mt,{className:k,onBlur:He,onFocus:zt}),jt.createElement(Zi.Provider,{value:Ue},d)),Qt&&jt.createElement("div",{"data-focus-guard":!0,tabIndex:x?-1:0,style:Es}))});da.propTypes={};function Qs(r,t){return Qs=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(n,a){return n.__proto__=a,n},Qs(r,t)}function ec(r,t){r.prototype=Object.create(t.prototype),r.prototype.constructor=r,Qs(r,t)}function Lr(r){"@babel/helpers - typeof";return Lr=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(t){return typeof t}:function(t){return t&&typeof Symbol=="function"&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},Lr(r)}function tc(r,t){if(Lr(r)!="object"||!r)return r;var n=r[Symbol.toPrimitive];if(n!==void 0){var a=n.call(r,t);if(Lr(a)!="object")return a;throw new TypeError("@@toPrimitive must return a primitive value.")}return(t==="string"?String:Number)(r)}function nc(r){var t=tc(r,"string");return Lr(t)=="symbol"?t:t+""}function rc(r,t,n){return(t=nc(t))in r?Object.defineProperty(r,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):r[t]=n,r}function sc(r,t){function n(a){return a.displayName||a.name||"Component"}return function(s){var o=[],c;function i(){c=r(o.map(function(l){return l.props})),t(c)}var h=(function(l){ec(u,l);function u(){return l.apply(this,arguments)||this}u.peek=function(){return c};var m=u.prototype;return m.componentDidMount=function(){o.push(this),i()},m.componentDidUpdate=function(){i()},m.componentWillUnmount=function(){var v=o.indexOf(this);o.splice(v,1),i()},m.render=function(){return jt.createElement(s,this.props)},u})(f.PureComponent);return rc(h,"displayName","SideEffect("+n(s)+")"),h}}var On=function(r){for(var t=Array(r.length),n=0;n<r.length;++n)t[n]=r[n];return t},or=function(r){return Array.isArray(r)?r:[r]},No=function(r){return Array.isArray(r)?r[0]:r},ac=function(r){if(r.nodeType!==Node.ELEMENT_NODE)return!1;var t=window.getComputedStyle(r,null);return!t||!t.getPropertyValue?!1:t.getPropertyValue("display")==="none"||t.getPropertyValue("visibility")==="hidden"},So=function(r){return r.parentNode&&r.parentNode.nodeType===Node.DOCUMENT_FRAGMENT_NODE?r.parentNode.host:r.parentNode},Co=function(r){return r===document||r&&r.nodeType===Node.DOCUMENT_NODE},oc=function(r){return r.hasAttribute("inert")},ic=function(r,t){return!r||Co(r)||!ac(r)&&!oc(r)&&t(So(r))},ko=function(r,t){var n=r.get(t);if(n!==void 0)return n;var a=ic(t,ko.bind(void 0,r));return r.set(t,a),a},cc=function(r,t){return r&&!Co(r)?uc(r)?t(So(r)):!1:!0},Eo=function(r,t){var n=r.get(t);if(n!==void 0)return n;var a=cc(t,Eo.bind(void 0,r));return r.set(t,a),a},Io=function(r){return r.dataset},lc=function(r){return r.tagName==="BUTTON"},Mo=function(r){return r.tagName==="INPUT"},Po=function(r){return Mo(r)&&r.type==="radio"},dc=function(r){return!((Mo(r)||lc(r))&&(r.type==="hidden"||r.disabled))},uc=function(r){var t=r.getAttribute(qi);return![!0,"true",""].includes(t)},ua=function(r){var t;return!!(r&&(!((t=Io(r))===null||t===void 0)&&t.focusGuard))},ea=function(r){return!ua(r)},mc=function(r){return!!r},hc=function(r,t){var n=Math.max(0,r.tabIndex),a=Math.max(0,t.tabIndex),s=n-a,o=r.index-t.index;if(s){if(!n)return 1;if(!a)return-1}return s||o},fc=function(r){return r.tabIndex<0&&!r.hasAttribute("tabindex")?0:r.tabIndex},ma=function(r,t,n){return On(r).map(function(a,s){var o=fc(a);return{node:a,index:s,tabIndex:n&&o===-1?(a.dataset||{}).focusGuard?0:-1:o}}).filter(function(a){return!t||a.tabIndex>=0}).sort(hc)},pc=["button:enabled","select:enabled","textarea:enabled","input:enabled","a[href]","area[href]","summary","iframe","object","embed","audio[controls]","video[controls]","[tabindex]","[contenteditable]","[autofocus]"],ha=pc.join(","),xc="".concat(ha,", [data-focus-guard]"),To=function(r,t){return On((r.shadowRoot||r).children).reduce(function(n,a){return n.concat(a.matches(t?xc:ha)?[a]:[],To(a))},[])},bc=function(r,t){var n;return r instanceof HTMLIFrameElement&&(!((n=r.contentDocument)===null||n===void 0)&&n.body)?br([r.contentDocument.body],t):[r]},br=function(r,t){return r.reduce(function(n,a){var s,o=To(a,t),c=(s=[]).concat.apply(s,o.map(function(i){return bc(i,t)}));return n.concat(c,a.parentNode?On(a.parentNode.querySelectorAll(ha)).filter(function(i){return i===a}):[])},[])},gc=function(r){var t=r.querySelectorAll("[".concat(Wi,"]"));return On(t).map(function(n){return br([n])}).reduce(function(n,a){return n.concat(a)},[])},fa=function(r,t){return On(r).filter(function(n){return ko(t,n)}).filter(function(n){return dc(n)})},Da=function(r,t){return t===void 0&&(t=new Map),On(r).filter(function(n){return Eo(t,n)})},pa=function(r,t,n){return ma(fa(br(r,n),t),!0,n)},_r=function(r,t){return ma(fa(br(r),t),!1)},vc=function(r,t){return fa(gc(r),t)},ar=function(r,t){return r.shadowRoot?ar(r.shadowRoot,t):Object.getPrototypeOf(r).contains!==void 0&&Object.getPrototypeOf(r).contains.call(r,t)?!0:On(r.children).some(function(n){var a;if(n instanceof HTMLIFrameElement){var s=(a=n.contentDocument)===null||a===void 0?void 0:a.body;return s?ar(s,t):!1}return ar(n,t)})},yc=function(r){for(var t=new Set,n=r.length,a=0;a<n;a+=1)for(var s=a+1;s<n;s+=1){var o=r[a].compareDocumentPosition(r[s]);(o&Node.DOCUMENT_POSITION_CONTAINED_BY)>0&&t.add(s),(o&Node.DOCUMENT_POSITION_CONTAINS)>0&&t.add(a)}return r.filter(function(c,i){return!t.has(i)})},Oo=function(r){return r.parentNode?Oo(r.parentNode):r},xa=function(r){var t=or(r);return t.filter(Boolean).reduce(function(n,a){var s=a.getAttribute(Ks);return n.push.apply(n,s?yc(On(Oo(a).querySelectorAll("[".concat(Ks,'="').concat(s,'"]:not([').concat(go,'="disabled"])')))):[a]),n},[])},wc=function(r){try{return r()}catch{return}},Fr=function(r){if(r===void 0&&(r=document),!(!r||!r.activeElement)){var t=r.activeElement;return t.shadowRoot?Fr(t.shadowRoot):t instanceof HTMLIFrameElement&&wc(function(){return t.contentWindow.document})?Fr(t.contentWindow.document):t}},jc=function(r,t){return r===t},Nc=function(r,t){return!!On(r.querySelectorAll("iframe")).some(function(n){return jc(n,t)})},Ao=function(r,t){return t===void 0&&(t=Fr(No(r).ownerDocument)),!t||t.dataset&&t.dataset.focusGuard?!1:xa(r).some(function(n){return ar(n,t)||Nc(n,t)})},Sc=function(r){r===void 0&&(r=document);var t=Fr(r);return t?On(r.querySelectorAll("[".concat(zi,"]"))).some(function(n){return ar(n,t)}):!1},Cc=function(r,t){return t.filter(Po).filter(function(n){return n.name===r.name}).filter(function(n){return n.checked})[0]||r},ba=function(r,t){return Po(r)&&r.name?Cc(r,t):r},kc=function(r){var t=new Set;return r.forEach(function(n){return t.add(ba(n,r))}),r.filter(function(n){return t.has(n)})},La=function(r){return r[0]&&r.length>1?ba(r[0],r):r[0]},_a=function(r,t){return r.indexOf(ba(t,r))},ta="NEW_FOCUS",Ec=function(r,t,n,a,s){var o=r.length,c=r[0],i=r[o-1],h=ua(a);if(!(a&&r.indexOf(a)>=0)){var l=a!==void 0?n.indexOf(a):-1,u=s?n.indexOf(s):l,m=s?r.indexOf(s):-1;if(l===-1)return m!==-1?m:ta;if(m===-1)return ta;var d=l-u,v=n.indexOf(c),x=n.indexOf(i),y=kc(n),w=a!==void 0?y.indexOf(a):-1,C=s?y.indexOf(s):w,N=y.filter(function(k){return k.tabIndex>=0}),P=a!==void 0?N.indexOf(a):-1,S=s?N.indexOf(s):P,M=P>=0&&S>=0?S-P:C-w;if(!d&&m>=0||t.length===0)return m;var T=_a(r,t[0]),p=_a(r,t[t.length-1]);if(l<=v&&h&&Math.abs(d)>1)return p;if(l>=x&&h&&Math.abs(d)>1)return T;if(d&&Math.abs(M)>1)return m;if(l<=v)return p;if(l>x)return T;if(d)return Math.abs(d)>1?m:(o+m+d)%o}},Ic=function(r){return function(t){var n,a=(n=Io(t))===null||n===void 0?void 0:n.autofocus;return t.autofocus||a!==void 0&&a!=="false"||r.indexOf(t)>=0}},Fa=function(r,t,n){var a=r.map(function(o){var c=o.node;return c}),s=Da(a.filter(Ic(n)));return s&&s.length?La(s):La(Da(t))},na=function(r,t){return t===void 0&&(t=[]),t.push(r),r.parentNode&&na(r.parentNode.host||r.parentNode,t),t},Is=function(r,t){for(var n=na(r),a=na(t),s=0;s<n.length;s+=1){var o=n[s];if(a.indexOf(o)>=0)return o}return!1},Ro=function(r,t,n){var a=or(r),s=or(t),o=a[0],c=!1;return s.filter(Boolean).forEach(function(i){c=Is(c||i,i)||c,n.filter(Boolean).forEach(function(h){var l=Is(o,h);l&&(!c||ar(l,c)?c=l:c=Is(l,c))})}),c},Ua=function(r,t){return r.reduce(function(n,a){return n.concat(vc(a,t))},[])},Mc=function(r,t){var n=new Map;return t.forEach(function(a){return n.set(a.node,a)}),r.map(function(a){return n.get(a)}).filter(mc)},Pc=function(r,t){var n=Fr(or(r).length>0?document:No(r).ownerDocument),a=xa(r).filter(ea),s=Ro(n||r,r,a),o=new Map,c=_r(a,o),i=c.filter(function(x){var y=x.node;return ea(y)});if(i[0]){var h=_r([s],o).map(function(x){var y=x.node;return y}),l=Mc(h,i),u=l.map(function(x){var y=x.node;return y}),m=l.filter(function(x){var y=x.tabIndex;return y>=0}).map(function(x){var y=x.node;return y}),d=Ec(u,m,h,n,t);if(d===ta){var v=Fa(c,m,Ua(a,o))||Fa(c,u,Ua(a,o));if(v)return{node:v};console.warn("focus-lock: cannot find any node to move focus into");return}return d===void 0?d:l[d]}},Tc=function(r){var t=xa(r).filter(ea),n=Ro(r,r,t),a=ma(br([n],!0),!0,!0),s=br(t,!1);return a.map(function(o){var c=o.node,i=o.index;return{node:c,index:i,lockItem:s.indexOf(c)>=0,guard:ua(c)}})},ga=function(r,t){r&&("focus"in r&&r.focus(t),"contentWindow"in r&&r.contentWindow&&r.contentWindow.focus())},Ms=0,Ps=!1,Do=function(r,t,n){n===void 0&&(n={});var a=Pc(r,t);if(!Ps&&a){if(Ms>2){console.error("FocusLock: focus-fighting detected. Only one focus management system could be active. See https://github.com/theKashey/focus-lock/#focus-fighting"),Ps=!0,setTimeout(function(){Ps=!1},1);return}Ms++,ga(a.node,n.focusOptions),Ms--}};function Tr(r){if(!r)return null;if(typeof WeakRef>"u")return function(){return r||null};var t=r?new WeakRef(r):null;return function(){return t?.deref()||null}}var Oc=function(r){if(!r)return null;for(var t=[],n=r;n&&n!==document.body;)t.push({current:Tr(n),parent:Tr(n.parentElement),left:Tr(n.previousElementSibling),right:Tr(n.nextElementSibling)}),n=n.parentElement;return{element:Tr(r),stack:t,ownerDocument:r.ownerDocument}},Ac=function(r){var t,n,a,s,o;if(r)for(var c=r.stack,i=r.ownerDocument,h=new Map,l=0,u=c;l<u.length;l++){var m=u[l],d=(t=m.parent)===null||t===void 0?void 0:t.call(m);if(d&&i.contains(d)){for(var v=(n=m.left)===null||n===void 0?void 0:n.call(m),x=m.current(),y=d.contains(x)?x:void 0,w=(a=m.right)===null||a===void 0?void 0:a.call(m),C=pa([d],h),N=(o=(s=y??v?.nextElementSibling)!==null&&s!==void 0?s:w)!==null&&o!==void 0?o:v;N;){for(var P=0,S=C;P<S.length;P++){var M=S[P];if(N?.contains(M.node))return M.node}N=N.nextElementSibling}if(C.length)return C[0].node}}},Lo=function(r){var t=Oc(r);return function(){return Ac(t)}},Rc=function(r,t,n){if(!r||!t)return console.error("no element or scope given"),{};var a=or(t);if(a.every(function(c){return!ar(c,r)}))return console.error("Active element is not contained in the scope"),{};var s=n?pa(a,new Map):_r(a,new Map),o=s.findIndex(function(c){var i=c.node;return i===r});if(o!==-1)return{prev:s[o-1],next:s[o+1],first:s[0],last:s[s.length-1]}},Dc=function(r,t){var n=t?pa(or(r),new Map):_r(or(r),new Map);return{first:n[0],last:n[n.length-1]}},Lc=function(r){return Object.assign({scope:document.body,cycle:!0,onlyTabbable:!0},r)},_o=function(r,t,n){t===void 0&&(t={});var a=Lc(t),s=Rc(r,a.scope,a.onlyTabbable);if(s){var o=n(s,a.cycle);o&&ga(o.node,a.focusOptions)}},_c=function(r,t){t===void 0&&(t={}),_o(r,t,function(n,a){var s=n.next,o=n.first;return s||a&&o})},Fc=function(r,t){t===void 0&&(t={}),_o(r,t,function(n,a){var s=n.prev,o=n.last;return s||a&&o})},Fo=function(r,t,n){var a,s=Dc(r,(a=t.onlyTabbable)!==null&&a!==void 0?a:!0),o=s[n];o&&ga(o.node,t.focusOptions)},Uc=function(r,t){t===void 0&&(t={}),Fo(r,t,"first")},Bc=function(r,t){t===void 0&&(t={}),Fo(r,t,"last")};function va(r){setTimeout(r,1)}var $c=function(t){return t&&"current"in t?t.current:t},Uo=function(){return document&&document.activeElement===document.body},Vc=function(){return Uo()||Sc()},fr=null,Zt=null,Ba=function(){return null},pr=null,Ur=!1,ya=!1,zc=function(){return!0},Wc=function(t){return(fr.whiteList||zc)(t)},qc=function(t,n){pr={observerNode:t,portaledElement:n}},Hc=function(t){return pr&&pr.portaledElement===t};function $a(r,t,n,a){var s=null,o=r;do{var c=a[o];if(c.guard)c.node.dataset.focusAutoGuard&&(s=c);else if(c.lockItem){if(o!==r)return;s=null}else break}while((o+=n)!==t);s&&(s.node.tabIndex=0)}var Gc=function(t){return t?!!Ur:Ur==="meanwhile"},Jc=function r(t,n,a){return n&&(n.host===t&&(!n.activeElement||a.contains(n.activeElement))||n.parentNode&&r(t,n.parentNode,a))},Yc=function(t,n){return n.some(function(a){return Jc(t,a,a)})},Bo=function(t){return _r(t,new Map)},Xc=function(t){return!Bo([t.parentNode]).some(function(n){return n.node===t})},ds=function(){var t=!1;if(fr){var n=fr,a=n.observed,s=n.persistentFocus,o=n.autoFocus,c=n.shards,i=n.crossFrame,h=n.focusOptions,l=n.noFocusGuards,u=a||pr&&pr.portaledElement;if(Uo()&&Zt&&Zt!==document.body&&(!document.body.contains(Zt)||Xc(Zt))){var m=Ba();m&&m.focus()}var d=document&&document.activeElement;if(u){var v=[u].concat(c.map($c).filter(Boolean)),x=function(){if(!Gc(i)||!l||!Zt||ya)return!1;var P=Bo(v),S=P.findIndex(function(M){var T=M.node;return T===Zt});return S===0||S===P.length-1};if((!d||Wc(d))&&(s||x()||!Vc()||!Zt&&o)&&(u&&!(Ao(v)||d&&Yc(d,v)||Hc(d))&&(document&&!Zt&&d&&!o?(d.blur&&d.blur(),document.body.focus()):(t=Do(v,Zt,{focusOptions:h}),pr={})),Zt=document&&document.activeElement,Zt!==document.body&&(Ba=Lo(Zt)),Ur=!1),document&&d!==document.activeElement&&document.querySelector("[data-focus-auto-guard]")){var y=document&&document.activeElement,w=Tc(v),C=w.map(function(N){var P=N.node;return P}).indexOf(y);C>-1&&(w.filter(function(N){var P=N.guard,S=N.node;return P&&S.dataset.focusAutoGuard}).forEach(function(N){var P=N.node;return P.removeAttribute("tabIndex")}),$a(C,w.length,1,w),$a(C,-1,-1,w))}}}return t},$o=function(t){ds()&&t&&(t.stopPropagation(),t.preventDefault())},wa=function(){return va(ds)},Kc=function(t){var n=t.target,a=t.currentTarget;a.contains(n)||qc(a,n)},Zc=function(){return null},Vo=function(){ya=!0},zo=function(){ya=!1,Ur="just",va(function(){Ur="meanwhile"})},Qc=function(){document.addEventListener("focusin",$o),document.addEventListener("focusout",wa),window.addEventListener("focus",Vo),window.addEventListener("blur",zo)},el=function(){document.removeEventListener("focusin",$o),document.removeEventListener("focusout",wa),window.removeEventListener("focus",Vo),window.removeEventListener("blur",zo)};function tl(r){return r.filter(function(t){var n=t.disabled;return!n})}var Wo={moveFocusInside:Do,focusInside:Ao,focusNextElement:_c,focusPrevElement:Fc,focusFirstElement:Uc,focusLastElement:Bc,captureFocusRestore:Lo};function nl(r){var t=r.slice(-1)[0];t&&!fr&&Qc();var n=fr,a=n&&t&&t.id===n.id;fr=t,n&&!a&&(n.onDeactivation(),r.filter(function(s){var o=s.id;return o===n.id}).length||n.returnFocus(!t)),t?(Zt=null,(!a||n.observed!==t.observed)&&t.onActivation(Wo),ds(),va(ds)):(el(),Zt=null)}wo.assignSyncMedium(Kc);jo.assignMedium(wa);Xi.assignMedium(function(r){return r(Wo)});const rl=sc(tl,nl)(Zc);var Jn=f.forwardRef(function(t,n){return jt.createElement(da,Dr({sideCar:rl,ref:n},t))}),qo=da.propTypes||{};qo.sideCar;Vi(qo,["sideCar"]);Jn.propTypes={};var Va=po();const sl=r=>`ndn_online_quota_${r}`;function Ts(r=new Date){const t=new Date(Date.UTC(r.getFullYear(),r.getMonth(),r.getDate())),n=t.getUTCDay()||7;t.setUTCDate(t.getUTCDate()+4-n);const a=new Date(Date.UTC(t.getUTCFullYear(),0,1)),s=Math.ceil(((t.getTime()-a.getTime())/864e5+1)/7),o=String(s).padStart(2,"0");return`${t.getUTCFullYear()}-${o}`}function al(r){try{const t=localStorage.getItem(sl(r));if(!t)return{week:Ts(),used:0};const n=JSON.parse(t),a=Ts();return!n.week||n.week!==a?{week:a,used:0}:{week:String(n.week),used:Number(n.used)||0}}catch{return{week:Ts(),used:0}}}function ol(r,t=3){const n=al(r);return Math.max(0,t-(n.used||0))}const Ho={BASE_URL:"/",DEV:!1,MODE:"production",PROD:!0,SSR:!1,VITE_API_URL:"http://localhost:8787",VITE_WS_URL:"ws://localhost:8787"},Go="ndn:isAdmin:v1";function Jo(){try{const r=localStorage.getItem(Go);return r?JSON.parse(r):{}}catch{return{}}}function il(r,t){try{const n=Jo();n[(r||"").toLowerCase()]={v:t,ts:Date.now()},localStorage.setItem(Go,JSON.stringify(n))}catch{}}async function cl(r){const t=String(r||"").toLowerCase();if(!t)return!1;try{const s=String(Ho?.VITE_OWNER_EMAIL||"").toLowerCase();if(s&&t===s)return!0}catch{}if(t==="daviesfamily108@gmail.com")return!0;try{const s=localStorage.getItem("ndn:forceAdmin");if(s==="1"||s==="true")return!0}catch{}const a=Jo()[t];if(a&&Date.now()-a.ts<300*1e3)return!!a.v;try{const c=!!(await(await fetch(`/api/admins/check?email=${encodeURIComponent(t)}`)).json().catch(()=>({})))?.isAdmin;return il(t,c),c}catch{return!!a?.v}}function ll(r){const t=String(r||"").toLowerCase(),[n,a]=f.useState(!1);return f.useEffect(()=>{let s=!0;if(!t){a(!1);return}try{const o=String(Ho?.VITE_OWNER_EMAIL||"").toLowerCase(),c=(()=>{try{const i=localStorage.getItem("ndn:forceAdmin");return i==="1"||i==="true"}catch{return!1}})();if(o&&t===o){a(!0);return}if(c){a(!0);return}}catch{}if(t==="daviesfamily108@gmail.com"){a(!0);return}return cl(t).then(o=>{s&&a(!!o)}),()=>{s=!1}},[t]),n}const dl={},ul=5,ml={GBP:1,EUR:1.16,USD:1.26,AUD:1.92,NZD:2.08,CAD:1.73};function Ru(r,t=ul){const n=(r||"GBP").toUpperCase(),a=ml[n]??1,s=t*a;try{return new Intl.NumberFormat(void 0,{style:"currency",currency:n}).format(s)}catch{return`${n} ${s.toFixed(2)}`}}function Du(){try{const r=new Intl.NumberFormat().resolvedOptions(),t=String(r.locale).toLowerCase();return t.includes("-gb")?"GBP":t.includes("-ie")||t.includes("-de")||t.includes("-fr")||t.includes("-es")||t.includes("-it")||t.includes("-nl")?"EUR":t.includes("-us")?"USD":t.includes("-au")?"AUD":t.includes("-nz")?"NZD":t.includes("-ca")?"CAD":"GBP"}catch{return"GBP"}}const hl=dl?.VITE_DISCORD_INVITE_URL||"https://discord.gg/nCfT4hJz";let Un=null;function fl(){if(Un)return Un;const r="http://localhost:8787".trim();if(r)return Un=r.replace(/\/$/,""),Un;if(typeof window<"u"){const{protocol:t,host:n,hostname:a}=window.location,s=`${t}//${n}`;return a.endsWith("onrender.com")||a==="localhost"||a==="127.0.0.1"?Un=s.replace(/\/$/,""):Un="https://ninedartnation.onrender.com",Un}return Un="https://ninedartnation.onrender.com",Un}function pl(r){if(/^https?:\/\//i.test(r))return r;const t=fl(),n=r.startsWith("/")?r:`/${r}`;return`${t}${n}`}function os(r){return pl(r)}function Gn(r,t){const n=os(r);return fetch(n,t)}function xl(){if(typeof window>"u"||typeof window.fetch!="function")return;const r=window;if(r.__ndnApiPatched)return;const t=window.fetch.bind(window);window.fetch=(n,a)=>{try{if(typeof n=="string")return n.startsWith("/")?t(os(n),a):t(n,a);if(n instanceof Request){const s=n.url.startsWith("/")?os(n.url):n.url;if(s===n.url)return t(n,a);const o=new Request(s,n);return t(o,a)}if(n instanceof URL){const s=n.href.startsWith("/")?os(n.href):n.href;return t(s,a)}}catch(s){console.warn("[API] Interceptor failed, falling back to original fetch",s)}return t(n,a)},r.__ndnApiPatched=!0}function bl(r){const t=[{key:"score",label:"Home",icon:Si},{key:"online",label:"Online Play",icon:Gs},{key:"offline",label:"Offline",icon:ss},{key:"tournaments",label:"Tournaments",icon:ss},{key:"friends",label:"Friends",icon:Gs},{key:"stats",label:"Stats",icon:ss},{key:"calibrate",label:"Calibrate",icon:Js},{key:"settings",label:"Settings",icon:ls}];function n(a){if(!a)return!1;const s=a.subscription;if(!s)return!!a.fullAccess;if(s.fullAccess){if(s.expiresAt){const o=typeof s.expiresAt=="string"?Date.parse(s.expiresAt):Number(s.expiresAt);if(!isNaN(o))return o>Date.now()}return s.status?s.status==="active":!0}return!1}return n(r)||t.push({key:"fullaccess",label:"PREMIUM £€$",icon:Ci}),t}function Yo({active:r,onChange:t,user:n,className:a}){let s=n;if(!n?.subscription&&n?.email)try{const x=localStorage?.getItem,y=typeof x=="function"?x.call(localStorage,`ndn:subscription:${n.email}`):null;if(y){const w=JSON.parse(y);s={...n,subscription:w,fullAccess:w.fullAccess||n.fullAccess}}}catch{}const o=bl(s),c=ll(n?.email);if(c&&!o.some(x=>x.key==="admin")){const x=o.findIndex(w=>w.key==="settings"),y={key:"admin",label:"Admin",icon:ls};x>=0?o.splice(x,0,y):o.push(y)}const[i,h]=f.useState(!1),[l,u]=f.useState(!1),m=n?.username&&!n?.fullAccess?ol(n.username):1/0,[d,v]=f.useState({friendRequests:0,messages:0,tournaments:0});return f.useEffect(()=>{if(!n?.email)return;const x=async()=>{try{const[w,C]=await Promise.all([Gn(`/api/friends/requests?email=${encodeURIComponent(n.email)}`),Gn(`/api/friends/messages?email=${encodeURIComponent(n.email)}`)]),N=w.ok?await w.json():{requests:[]},S=(C.ok?await C.json():{messages:[]}).messages?.filter(M=>!M.read).length||0;v({friendRequests:N.requests?.length||0,messages:S,tournaments:0})}catch(w){console.error("Failed to fetch notifications:",w)}};x();const y=setInterval(x,3e4);return()=>clearInterval(y)},[n?.email]),f.useEffect(()=>{if(!i)return;const x=y=>{(y.key==="Escape"||y.key==="Enter")&&h(!1)};return document.addEventListener("keydown",x),()=>document.removeEventListener("keydown",x)},[i]),e.jsxs("aside",{className:`${n?.fullAccess?"premium-sidebar":""} sidebar glass ${a?"":"w-60"} p-2 sm:p-4 rounded-2xl ${a??"hidden sm:flex"} flex-col gap-2 overflow-y-auto overflow-x-hidden ${a?"":"fixed top-2 bottom-2 sm:top-4 sm:bottom-4"}`,children:[o.map(({key:x,label:y,icon:w})=>x==="admin"&&!c?null:e.jsxs("button",{className:`tab whitespace-nowrap flex items-center justify-start gap-3 ${r===x?"tab--active":"tab--inactive"} `,onClick:()=>t(x),title:y,style:{fontWeight:700,fontSize:"1.1rem",color:r===x?"#fff":"#E5E7EB",letterSpacing:"0.02em"},children:[e.jsx(w,{className:"w-6 h-6"}),e.jsxs("span",{className:"flex items-center gap-2",children:[y,x==="online"&&!n?.fullAccess&&m<=0&&e.jsxs("span",{title:"Weekly free games used",className:"inline-flex items-center gap-1 text-[0.65rem] px-2 py-0.5 rounded-full bg-rose-600 text-white",children:[e.jsx(Ni,{className:"w-3 h-3"}),"Locked"]}),x==="friends"&&d.friendRequests>0&&e.jsx("span",{className:"inline-flex items-center justify-center w-5 h-5 text-xs font-bold text-white bg-orange-500 rounded-full",children:d.friendRequests>9?"9+":d.friendRequests}),x==="score"&&(d.messages>0||d.tournaments>0)&&e.jsx("span",{className:"inline-flex items-center justify-center w-5 h-5 text-xs font-bold text-white bg-orange-500 rounded-full",children:d.messages+d.tournaments>9?"9+":d.messages+d.tournaments})]})]},x)),e.jsxs("button",{className:"tab tab--compact whitespace-nowrap flex items-center justify-start gap-3 bg-[#5865F2] text-white mt-2",onClick:()=>h(!0),title:"BullseyeDartsLeague",style:{fontWeight:700,fontSize:"1.1rem",letterSpacing:"0.02em"},children:[e.jsx(Tn,{className:"w-6 h-6"}),e.jsx("span",{className:"truncate",children:"BullseyeDartsLeague"})]}),e.jsxs("button",{className:"tab tab--compact whitespace-nowrap flex items-center justify-start gap-3 bg-[#5865F2] text-white mt-1",onClick:()=>u(!0),title:"NineDartNation",style:{fontWeight:700,fontSize:"1.1rem",letterSpacing:"0.02em"},children:[e.jsx(Tn,{className:"w-6 h-6"}),e.jsx("span",{className:"truncate",children:"NineDartNation"})]}),i&&Va.createPortal(e.jsxs("div",{className:"fixed inset-0 z-[1000]",children:[e.jsx("button",{className:"absolute inset-0 bg-black/50",onClick:()=>h(!1),onTouchStart:()=>h(!1),"aria-label":"Close Discord dialog"}),e.jsx("div",{className:"absolute inset-0 flex items-center justify-center p-4",children:e.jsx(Jn,{returnFocus:!0,children:e.jsxs("div",{role:"dialog","aria-modal":"true",className:"card max-w-md w-full relative text-left p-6 rounded-xl",children:[e.jsx("button",{className:"absolute -top-3 -right-3 btn px-3 py-1","aria-label":"Close",onClick:()=>h(!1),children:"✕"}),e.jsxs("h3",{className:"text-xl font-bold mb-2 flex items-center gap-2 text-[#8ea1e1]",children:[e.jsx(Tn,{className:"w-6 h-6"})," BullseyeDartsLeague"]}),e.jsx("div",{className:"mb-4 text-lg font-semibold",children:"Join this fantastic Online Darts League with divisions and other cool stuff included"}),e.jsx("a",{href:hl,target:"_blank",rel:"noopener noreferrer nofollow",className:"btn bg-[#5865F2] text-white w-full font-bold text-lg",children:"Join Discord"})]})})})]}),document.body),l&&Va.createPortal(e.jsxs("div",{className:"fixed inset-0 z-[1000]",children:[e.jsx("button",{className:"absolute inset-0 bg-black/50",onClick:()=>u(!1),onTouchStart:()=>u(!1),"aria-label":"Close NineDartNation dialog"}),e.jsx("div",{className:"absolute inset-0 flex items-center justify-center p-4",children:e.jsx(Jn,{returnFocus:!0,children:e.jsxs("div",{role:"dialog","aria-modal":"true",className:"card max-w-md w-full relative text-left p-6 rounded-xl",children:[e.jsx("button",{className:"absolute -top-3 -right-3 btn px-3 py-1","aria-label":"Close",onClick:()=>u(!1),children:"✕"}),e.jsxs("h3",{className:"text-xl font-bold mb-2 flex items-center gap-2 text-[#8ea1e1]",children:[e.jsx(Tn,{className:"w-6 h-6"})," NineDartNation"]}),e.jsx("div",{className:"mb-4 text-lg font-semibold",children:"Join the NineDartNation Discord community"}),e.jsx("a",{href:"https://discord.gg/Q33J5FTVve",target:"_blank",rel:"noopener noreferrer nofollow",className:"btn bg-[#5865F2] text-white w-full font-bold text-lg",children:"Join Discord"})]})})})]}),document.body)]})}function Mn({children:r,className:t,style:n}){const a=f.useRef(null);return f.useEffect(()=>{let s=0;const o=()=>{const h=a.current;if(!h)return;const l=document.getElementById("ndn-header");if(!l){h.style.clipPath="";return}const u=document.getElementById("ndn-main-scroll"),m=u?u.scrollTop:window.scrollY||0,d=l.getBoundingClientRect().height,v=m>0?d:0;try{let x=h.querySelector("[data-ndn-top-mask]");x||(x=document.createElement("div"),x.setAttribute("data-ndn-top-mask","1"),Object.assign(x.style,{position:"absolute",left:"0px",right:"0px",top:"0px",height:"0px",pointerEvents:"none",zIndex:"20",background:"linear-gradient(to bottom, rgba(17,24,39,1), rgba(17,24,39,0))"}),h.style.position=h.style.position||"relative",h.insertBefore(x,h.firstChild)),v>0?(x.style.height=`${v}px`,x.style.display=""):(x.style.height="0px",x.style.display="none"),h.style.marginTop="0px"}catch{h.style.marginTop="0px"}};o();const c=()=>{s&&cancelAnimationFrame(s),s=requestAnimationFrame(o)},i=document.getElementById("ndn-main-scroll");return i?.addEventListener("scroll",c,{passive:!0}),window.addEventListener("scroll",c,{passive:!0}),window.addEventListener("resize",c),()=>{i?.removeEventListener("scroll",c),window.removeEventListener("scroll",c),window.removeEventListener("resize",c),s&&cancelAnimationFrame(s)}},[]),e.jsx("div",{ref:a,className:t,style:n,children:r})}const gl=({calibrationComplete:r})=>{const[t,n]=f.useState(!1),[a,s]=f.useState(!1);return f.useEffect(()=>{r?(n(!0),setTimeout(()=>s(!0),1200)):(n(!1),s(!1))},[r]),e.jsxs("div",{className:`flex flex-col items-center justify-center w-full h-full transition-opacity duration-700 ${a?"opacity-0":"opacity-100"}`,style:{pointerEvents:"none",position:"absolute",inset:0,zIndex:10},children:[e.jsxs("div",{className:"flex items-center justify-center",children:[e.jsx("svg",{width:"80",height:"80",viewBox:"0 0 80 80",className:`animate-spin-slow ${t?"opacity-0":"opacity-100"} transition-opacity duration-500`,style:{transition:"opacity 0.5s"},children:e.jsxs("g",{children:[e.jsx("rect",{x:"36",y:"10",width:"8",height:"40",rx:"3",fill:"#a78bfa"}),e.jsx("polygon",{points:"40,10 44,22 36,22",fill:"#f472b6"}),e.jsx("rect",{x:"36",y:"50",width:"8",height:"18",rx:"2",fill:"#22d3ee"}),e.jsx("polygon",{points:"36,68 44,68 40,78",fill:"#10b981"})]})}),t&&e.jsxs("svg",{width:"80",height:"80",viewBox:"0 0 80 80",className:"absolute",style:{left:0,top:0},children:[e.jsx("circle",{cx:"40",cy:"40",r:"32",fill:"none",stroke:"#10b981",strokeWidth:"6"}),e.jsx("polyline",{points:"28,44 38,54 54,30",fill:"none",stroke:"#10b981",strokeWidth:"6",strokeLinecap:"round",strokeLinejoin:"round"})]})]}),e.jsx("div",{className:"mt-4 text-lg font-semibold text-indigo-200",children:t?"Calibration Complete!":"Initializing Camera..."})]})};class Xo{width=0;height=0;bg=null;lastAcceptTs=0;cooldownMs=600;roiRadius=0;roiCx=0;roiCy=0;initialized=!1;thresh=18;minArea=60;maxArea=6e3;angMaxDeg=70;prevTip=null;prevArea=0;stableCount=0;requireStableN=3;constructor(t){t?.thresh!==void 0&&(this.thresh=t.thresh),t?.minArea!==void 0&&(this.minArea=t.minArea),t?.maxArea!==void 0&&(this.maxArea=t.maxArea),t?.requireStableN!==void 0&&(this.requireStableN=t.requireStableN),t?.angMaxDeg!==void 0&&(this.angMaxDeg=t.angMaxDeg)}setROI(t,n,a){this.roiCx=t,this.roiCy=n,this.roiRadius=Math.max(0,a|0)}reset(t,n){this.width=t,this.height=n,this.bg=new Float32Array(t*n),this.initialized=!1}updateBackground(t,n=.05){const{width:a,height:s,data:o}=t;(!this.bg||a!==this.width||s!==this.height)&&this.reset(a,s);const c=this.bg,i=a*s;for(let h=0,l=0;h<i;h++,l+=4){const u=o[l],m=o[l+1],d=o[l+2],v=.299*u+.587*m+.114*d;this.initialized?c[h]=(1-n)*c[h]+n*v:c[h]=v}this.initialized=!0}inRoi(t,n){if(this.roiRadius<=0)return!0;const a=t-this.roiCx,s=n-this.roiCy;return a*a+s*s<=this.roiRadius*this.roiRadius}detect(t){const a=Date.now()-this.lastAcceptTs<this.cooldownMs,{width:s,height:o,data:c}=t;(!this.bg||s!==this.width||o!==this.height)&&this.reset(s,o);const i=this.bg;if(!this.initialized)return this.updateBackground(t,1),null;const h=s*o,l=new Uint8Array(h),u=new Float32Array(h);let m=0,d=0,v=0;const x=new Uint8Array(h);for(let xe=0,ne=0;xe<h;xe++,ne+=4){const ke=c[ne],je=c[ne+1],_e=c[ne+2],Ee=Math.max(ke,je,_e),be=Math.min(ke,je,_e),Xe=.299*ke+.587*je+.114*_e,de=Math.abs(Xe-i[xe]);u[xe]=de;const xn=Math.floor(xe/s),qt=xe-xn*s,_t=Ee===0?0:(Ee-be)/Ee,Ft=Ee>=250&&_t<=.12;Ft&&(x[xe]=1),this.inRoi(qt,xn)&&!Ft&&(m+=de,d+=de*de,v++)}const y=v?m/v:0,w=v?Math.max(0,d/v-y*y):0,C=Math.sqrt(w),N=Math.max(this.thresh,y+1.2*C);for(let xe=0;xe<h;xe++){if(x[xe]){l[xe]=0;continue}if(u[xe]>N){const ne=Math.floor(xe/s),ke=xe-ne*s;l[xe]=this.inRoi(ke,ne)?1:0}}this._dilate(l,s,o),this._erode(l,s,o);const P=new Uint8Array(h);let S=0,M=null;for(let xe=0;xe<h;xe++){if(l[xe]===0||P[xe])continue;const ne=[];let ke=0,je=0;const _e=[xe];for(P[xe]=1;je<_e.length;){const Ee=_e[je++];ne.push(Ee),ke++;const be=Ee/s|0,Xe=[Ee-1,Ee+1,Ee-s,Ee+s];for(const de of Xe)de<0||de>=h||P[de]||(de===Ee-1||de===Ee+1)&&(de/s|0)!==be||l[de]&&(P[de]=1,_e.push(de))}ke>S&&(S=ke,M=ne)}if(!M||S<this.minArea||S>this.maxArea)return a||this.updateBackground(t,.02),null;let T=s,p=o,k=0,z=0,W=0,ee=0;for(const xe of M){const ne=xe/s|0,ke=xe-ne*s;W+=ke,ee+=ne,ke<T&&(T=ke),ke>k&&(k=ke),ne<p&&(p=ne),ne>z&&(z=ne)}W/=S,ee/=S;let Q=0,K=0,le=0;for(const xe of M){const ne=xe/s|0,je=xe-ne*s-W,_e=ne-ee;Q+=je*je,K+=_e*_e,le+=je*_e}Q/=S,K/=S,le/=S;const ie=Q+K,L=Q*K-le*le,Y=Math.sqrt(Math.max(0,ie*ie/4-L)),$=ie/2+Y;let B=le,H=$-Q;Math.hypot(B,H)<1e-6&&(B=$-K,H=le);const fe=Math.hypot(B,H)||1;B/=fe,H/=fe;const Ye=W-this.roiCx,Ce=ee-this.roiCy,Ve=Ye*B+Ce*H>0?1:-1;B*=Ve,H*=Ve;const Le=Math.hypot(Ye,Ce)||1,Nt=Ye/Le,St=Ce/Le,zt=Math.max(-1,Math.min(1,B*Nt+H*St));if(Math.acos(zt)*180/Math.PI>this.angMaxDeg)return a||this.updateBackground(t,.02),null;let Ie=-1/0,Mt=W,Pt=ee;for(const xe of M){const ne=xe/s|0,ke=xe-ne*s,je=(ke-W)*B+(ne-ee)*H;je>Ie&&(Ie=je,Mt=ke,Pt=ne)}const Qt=Mt-this.roiCx,Wt=Pt-this.roiCy,Ue=Qt*Qt+Wt*Wt,st=Math.max(1,k-T+1),at=Math.max(1,z-p+1),ze=st*at,ut=S/ze,Pe=Math.sqrt(Ue)/Math.max(1,this.roiRadius);let Ge=.5;ut<.45&&(Ge+=.2),ut<.25&&(Ge+=.15),Pe<1.1&&(Ge+=.1);const Me=ie-$;return($>0?1-Me/$:0)>.3&&(Ge+=.1),Ge=Math.max(0,Math.min(1,Ge)),!this._isStable({x:Mt+.5,y:Pt+.5},S)||a?null:{tip:{x:Mt+.5,y:Pt+.5},axis:{x1:W-B*20,y1:ee-H*20,x2:W+B*20,y2:ee+H*20},area:S,bbox:{x:T,y:p,w:st,h:at},confidence:Ge}}accept(t,n){if(this.lastAcceptTs=Date.now(),this.prevTip=null,this.prevArea=0,this.stableCount=0,!this.bg)return;const{width:a}=t,s=this.bg,{x:o,y:c,w:i,h}=n.bbox,l=.5;for(let u=c;u<c+h;u++)for(let m=o;m<o+i;m++){const d=u*a+m,v=d*4,x=t.data[v],y=t.data[v+1],w=t.data[v+2],C=.299*x+.587*y+.114*w;s[d]=(1-l)*s[d]+l*C}}_isStable(t,n){const a=(s,o)=>Math.hypot(s.x-o.x,s.y-o.y)<=6;if(!this.prevTip)return this.prevTip={...t},this.prevArea=n,this.stableCount=1,!1;if(a(this.prevTip,t)&&Math.abs(n-this.prevArea)/Math.max(1,n)<.3)this.prevTip={...t},this.prevArea=n,this.stableCount++;else return this.prevTip={...t},this.prevArea=n,this.stableCount=1,!1;return this.stableCount>=this.requireStableN}_dilate(t,n,a){const s=new Uint8Array(t.length);for(let o=0;o<a;o++)for(let c=0;c<n;c++){let i=0;for(let h=-1;h<=1;h++){for(let l=-1;l<=1;l++){const u=o+h,m=c+l;if(!(u<0||u>=a||m<0||m>=n)&&t[u*n+m]){i=1;break}}if(i)break}s[o*n+c]=i}t.set(s)}_erode(t,n,a){const s=new Uint8Array(t.length);for(let o=0;o<a;o++)for(let c=0;c<n;c++){let i=1;for(let h=-1;h<=1;h++){for(let l=-1;l<=1;l++){const u=o+h,m=c+l;if(!(u<0||u>=a||m<0||m>=n)&&!t[u*n+m]){i=0;break}}if(!i)break}s[o*n+c]=i}t.set(s)}}const vl={},za=r=>{let t;const n=new Set,a=(u,m)=>{const d=typeof u=="function"?u(t):u;if(!Object.is(d,t)){const v=t;t=m??(typeof d!="object"||d===null)?d:Object.assign({},t,d),n.forEach(x=>x(t,v))}},s=()=>t,h={setState:a,getState:s,getInitialState:()=>l,subscribe:u=>(n.add(u),()=>n.delete(u)),destroy:()=>{(vl?"production":void 0)!=="production"&&console.warn("[DEPRECATED] The `destroy` method will be unsupported in a future version. Instead use unsubscribe function returned by subscribe. Everything will be garbage-collected if store is garbage-collected."),n.clear()}},l=t=r(a,s,h);return h},yl=r=>r?za(r):za;var Os={exports:{}},As={},Rs={exports:{}},Ds={};/**
 * @license React
 * use-sync-external-store-shim.production.js
 *
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var Wa;function wl(){if(Wa)return Ds;Wa=1;var r=ia();function t(m,d){return m===d&&(m!==0||1/m===1/d)||m!==m&&d!==d}var n=typeof Object.is=="function"?Object.is:t,a=r.useState,s=r.useEffect,o=r.useLayoutEffect,c=r.useDebugValue;function i(m,d){var v=d(),x=a({inst:{value:v,getSnapshot:d}}),y=x[0].inst,w=x[1];return o(function(){y.value=v,y.getSnapshot=d,h(y)&&w({inst:y})},[m,v,d]),s(function(){return h(y)&&w({inst:y}),m(function(){h(y)&&w({inst:y})})},[m]),c(v),v}function h(m){var d=m.getSnapshot;m=m.value;try{var v=d();return!n(m,v)}catch{return!0}}function l(m,d){return d()}var u=typeof window>"u"||typeof window.document>"u"||typeof window.document.createElement>"u"?l:i;return Ds.useSyncExternalStore=r.useSyncExternalStore!==void 0?r.useSyncExternalStore:u,Ds}var qa;function jl(){return qa||(qa=1,Rs.exports=wl()),Rs.exports}/**
 * @license React
 * use-sync-external-store-shim/with-selector.production.js
 *
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var Ha;function Nl(){if(Ha)return As;Ha=1;var r=ia(),t=jl();function n(l,u){return l===u&&(l!==0||1/l===1/u)||l!==l&&u!==u}var a=typeof Object.is=="function"?Object.is:n,s=t.useSyncExternalStore,o=r.useRef,c=r.useEffect,i=r.useMemo,h=r.useDebugValue;return As.useSyncExternalStoreWithSelector=function(l,u,m,d,v){var x=o(null);if(x.current===null){var y={hasValue:!1,value:null};x.current=y}else y=x.current;x=i(function(){function C(T){if(!N){if(N=!0,P=T,T=d(T),v!==void 0&&y.hasValue){var p=y.value;if(v(p,T))return S=p}return S=T}if(p=S,a(P,T))return p;var k=d(T);return v!==void 0&&v(p,k)?(P=T,p):(P=T,S=k)}var N=!1,P,S,M=m===void 0?null:m;return[function(){return C(u())},M===null?void 0:function(){return C(M())}]},[u,m,d,v]);var w=s(l,x[0],x[1]);return c(function(){y.hasValue=!0,y.value=w},[w]),h(w),w},As}var Ga;function Sl(){return Ga||(Ga=1,Os.exports=Nl()),Os.exports}var Cl=Sl();const kl=xo(Cl),Ko={},{useDebugValue:El}=jt,{useSyncExternalStoreWithSelector:Il}=kl;let Ja=!1;const Ml=r=>r;function Pl(r,t=Ml,n){(Ko?"production":void 0)!=="production"&&n&&!Ja&&(console.warn("[DEPRECATED] Use `createWithEqualityFn` instead of `create` or use `useStoreWithEqualityFn` instead of `useStore`. They can be imported from 'zustand/traditional'. https://github.com/pmndrs/zustand/discussions/1937"),Ja=!0);const a=Il(r.subscribe,r.getState,r.getServerState||r.getInitialState,t,n);return El(a),a}const Ya=r=>{(Ko?"production":void 0)!=="production"&&typeof r!="function"&&console.warn("[DEPRECATED] Passing a vanilla store will be unsupported in a future version. Instead use `import { useStore } from 'zustand'`.");const t=typeof r=="function"?yl(r):r,n=(a,s)=>Pl(t,a,s);return Object.assign(n,t),n},Vn=r=>r?Ya(r):Ya,Tl={};function ja(r,t){let n;try{n=r()}catch{return}return{getItem:s=>{var o;const c=h=>h===null?null:JSON.parse(h,void 0),i=(o=n.getItem(s))!=null?o:null;return i instanceof Promise?i.then(c):c(i)},setItem:(s,o)=>n.setItem(s,JSON.stringify(o,void 0)),removeItem:s=>n.removeItem(s)}}const Br=r=>t=>{try{const n=r(t);return n instanceof Promise?n:{then(a){return Br(a)(n)},catch(a){return this}}}catch(n){return{then(a){return this},catch(a){return Br(a)(n)}}}},Ol=(r,t)=>(n,a,s)=>{let o={getStorage:()=>localStorage,serialize:JSON.stringify,deserialize:JSON.parse,partialize:w=>w,version:0,merge:(w,C)=>({...C,...w}),...t},c=!1;const i=new Set,h=new Set;let l;try{l=o.getStorage()}catch{}if(!l)return r((...w)=>{console.warn(`[zustand persist middleware] Unable to update item '${o.name}', the given storage is currently unavailable.`),n(...w)},a,s);const u=Br(o.serialize),m=()=>{const w=o.partialize({...a()});let C;const N=u({state:w,version:o.version}).then(P=>l.setItem(o.name,P)).catch(P=>{C=P});if(C)throw C;return N},d=s.setState;s.setState=(w,C)=>{d(w,C),m()};const v=r((...w)=>{n(...w),m()},a,s);let x;const y=()=>{var w;if(!l)return;c=!1,i.forEach(N=>N(a()));const C=((w=o.onRehydrateStorage)==null?void 0:w.call(o,a()))||void 0;return Br(l.getItem.bind(l))(o.name).then(N=>{if(N)return o.deserialize(N)}).then(N=>{if(N)if(typeof N.version=="number"&&N.version!==o.version){if(o.migrate)return o.migrate(N.state,N.version);console.error("State loaded from storage couldn't be migrated since no migrate function was provided")}else return N.state}).then(N=>{var P;return x=o.merge(N,(P=a())!=null?P:v),n(x,!0),m()}).then(()=>{C?.(x,void 0),c=!0,h.forEach(N=>N(x))}).catch(N=>{C?.(void 0,N)})};return s.persist={setOptions:w=>{o={...o,...w},w.getStorage&&(l=w.getStorage())},clearStorage:()=>{l?.removeItem(o.name)},getOptions:()=>o,rehydrate:()=>y(),hasHydrated:()=>c,onHydrate:w=>(i.add(w),()=>{i.delete(w)}),onFinishHydration:w=>(h.add(w),()=>{h.delete(w)})},y(),x||v},Al=(r,t)=>(n,a,s)=>{let o={storage:ja(()=>localStorage),partialize:y=>y,version:0,merge:(y,w)=>({...w,...y}),...t},c=!1;const i=new Set,h=new Set;let l=o.storage;if(!l)return r((...y)=>{console.warn(`[zustand persist middleware] Unable to update item '${o.name}', the given storage is currently unavailable.`),n(...y)},a,s);const u=()=>{const y=o.partialize({...a()});return l.setItem(o.name,{state:y,version:o.version})},m=s.setState;s.setState=(y,w)=>{m(y,w),u()};const d=r((...y)=>{n(...y),u()},a,s);s.getInitialState=()=>d;let v;const x=()=>{var y,w;if(!l)return;c=!1,i.forEach(N=>{var P;return N((P=a())!=null?P:d)});const C=((w=o.onRehydrateStorage)==null?void 0:w.call(o,(y=a())!=null?y:d))||void 0;return Br(l.getItem.bind(l))(o.name).then(N=>{if(N)if(typeof N.version=="number"&&N.version!==o.version){if(o.migrate)return[!0,o.migrate(N.state,N.version)];console.error("State loaded from storage couldn't be migrated since no migrate function was provided")}else return[!1,N.state];return[!1,void 0]}).then(N=>{var P;const[S,M]=N;if(v=o.merge(M,(P=a())!=null?P:d),n(v,!0),S)return u()}).then(()=>{C?.(v,void 0),v=a(),c=!0,h.forEach(N=>N(v))}).catch(N=>{C?.(void 0,N)})};return s.persist={setOptions:y=>{o={...o,...y},y.storage&&(l=y.storage)},clearStorage:()=>{l?.removeItem(o.name)},getOptions:()=>o,rehydrate:()=>x(),hasHydrated:()=>c,onHydrate:y=>(i.add(y),()=>{i.delete(y)}),onFinishHydration:y=>(h.add(y),()=>{h.delete(y)})},o.skipHydration||x(),v||d},Rl=(r,t)=>"getStorage"in t||"serialize"in t||"deserialize"in t?((Tl?"production":void 0)!=="production"&&console.warn("[DEPRECATED] `getStorage`, `serialize` and `deserialize` options are deprecated. Use `storage` option instead."),Ol(r,t)):Al(r,t),Zo=Rl,pn=Vn()(Zo((r,t)=>({H:null,createdAt:null,errorPx:null,imageSize:null,overlaySize:null,anchors:null,locked:!1,_hydrated:!1,setCalibration:n=>r(a=>({...a,...n})),reset:()=>r({H:null,createdAt:null,errorPx:null,imageSize:null,overlaySize:null,anchors:null,locked:!1})}),{name:"ndn-calibration-v1",storage:ja(()=>localStorage),onRehydrateStorage:()=>(r,t)=>{if(!(t||!r))try{if(r&&!r.H){const n=localStorage.getItem("ndn:calibration:v1");if(n){const a=JSON.parse(n);a&&(a.H||a.imageSize)&&r.setCalibration({H:a.H??null,createdAt:a.createdAt??null,errorPx:a.errorPx??null,imageSize:a.imageSize??null,overlaySize:a.overlaySize??null,anchors:a.anchors??null,locked:!!a.locked})}}r._hydrated=!0}catch{}}}));function Be(...r){}let Ls=null,_s=null,Fs=null,Us=null;const gr=Vn()(Zo((r,t)=>({isStreaming:!1,mode:"local",pairingCode:null,expiresAt:null,isPaired:!1,mobileUrl:null,showOverlay:!0,setStreaming:n=>{r({isStreaming:n})},setMode:n=>{r({mode:n})},setPairingCode:n=>r({pairingCode:n}),setExpiresAt:n=>r({expiresAt:n}),setPaired:n=>r({isPaired:n}),setMobileUrl:n=>r({mobileUrl:n}),setShowOverlay:n=>r({showOverlay:!!n}),setMediaStream:n=>{_s=n},getMediaStream:()=>_s,setPcRef:n=>{Fs=n},getPcRef:()=>Fs,setWsRef:n=>{Us=n},getWsRef:()=>Us,getVideoElementRef:()=>Ls,setVideoElementRef:n=>{n&&Be("[cameraSession] ✅ setVideoElementRef called - storing HTMLVideoElement",{tagName:n.tagName,hasStream:!!n.srcObject}),Ls=n},clearSession:()=>{Ls=null,_s=null,Fs=null,Us=null,r({isStreaming:!1,pairingCode:null,expiresAt:null,isPaired:!1,mobileUrl:null})}}),{name:"ndn-camera-session",storage:ja(()=>localStorage),partialize:r=>({isStreaming:r.isStreaming,mode:r.mode,pairingCode:r.pairingCode,expiresAt:r.expiresAt,isPaired:r.isPaired,mobileUrl:r.mobileUrl,showOverlay:r.showOverlay})})),Z={bullInner:6.35,bullOuter:15.9,trebleInner:99,trebleOuter:107,doubleInner:162,doubleOuter:170},ra=[20,1,18,4,13,6,10,15,2,17,3,19,7,16,8,11,14,9,12,5];function ir(r,t){const n=t.x,a=t.y,s=r[6]*n+r[7]*a+r[8],o=(r[0]*n+r[1]*a+r[2])/s,c=(r[3]*n+r[4]*a+r[5])/s;return{x:o,y:c}}function Dl(r){const t=r,n=t[0],a=t[1],s=t[2],o=t[3],c=t[4],i=t[5],h=t[6],l=t[7],u=t[8],m=c*u-i*l,d=s*l-a*u,v=a*i-s*c,x=i*h-o*u,y=n*u-s*h,w=s*o-n*i,C=o*l-c*h,N=a*h-n*l,P=n*c-a*o,S=n*m+a*x+s*C;if(Math.abs(S)<1e-12)throw new Error("Singular homography");return[m/S,d/S,v/S,x/S,y/S,w/S,C/S,N/S,P/S]}function mr(r,t){if(r.length<4||t.length<4)throw new Error("Need at least 4 correspondences");if(r.length!==t.length)throw new Error("Correspondences must have equal length");const n=[],a=[];for(let c=0;c<r.length;c++){const{x:i,y:h}=r[c],{x:l,y:u}=t[c];n.push([i,h,1,0,0,0,-l*i,-l*h]),a.push(l),n.push([0,0,0,i,h,1,-u*i,-u*h]),a.push(u)}const s=Ll(n,a);return[s[0],s[1],s[2],s[3],s[4],s[5],s[6],s[7],1]}function Ll(r,t){const n=r.length,a=r[0].length,s=Array.from({length:a},()=>new Array(a).fill(0)),o=new Array(a).fill(0);for(let c=0;c<n;c++)for(let i=0;i<a;i++){o[i]+=r[c][i]*t[c];for(let h=0;h<a;h++)s[i][h]+=r[c][i]*r[c][h]}return _l(s,o)}function _l(r,t){const n=t.length,a=r.map((o,c)=>o.concat([t[c]]));for(let o=0;o<n;o++){let c=o;for(let i=o+1;i<n;i++)Math.abs(a[i][o])>Math.abs(a[c][o])&&(c=i);if(Math.abs(a[c][o])<1e-12)throw new Error("Singular matrix");if(c!==o){const i=a[o];a[o]=a[c],a[c]=i}for(let i=o+1;i<n;i++){const h=a[i][o]/a[o][o];for(let l=o;l<=n;l++)a[i][l]-=h*a[o][l]}}const s=new Array(n).fill(0);for(let o=n-1;o>=0;o--){let c=a[o][n];for(let i=o+1;i<n;i++)c-=a[o][i]*s[i];s[o]=c/a[o][o]}return s}function Or(){const r=Z.doubleOuter;return[20,6,3,11].map(n=>{const s=ra.indexOf(n)/ra.length*Math.PI*2-Math.PI/2,o=r*Math.cos(s),c=r*Math.sin(s);return{x:Math.abs(o)<1e-9?0:o,y:Math.abs(c)<1e-9?0:c}})}function Fl(r,t,n=256){const a=[];for(let s=0;s<n;s++){const o=s/n*Math.PI*2,c=ir(r,{x:t*Math.cos(o),y:t*Math.sin(o)});a.push(c)}return a}function Ar(r,t,n){let a=0;for(let s=0;s<t.length;s++){const o=ir(r,t[s]),c=o.x-n[s].x,i=o.y-n[s].y;a+=c*c+i*i}return Math.sqrt(a/t.length)}function $n(r,t){const n=Dl(r);return ir(n,t)}function Rr(r){const t=Math.hypot(r.x,r.y);let a=Math.atan2(r.y,r.x)*180/Math.PI;a=(a+360+90)%360;const s=ra[Math.floor(a/18)];return t<=Z.bullInner?{base:50,ring:"INNER_BULL",sector:25,mult:2}:t<=Z.bullOuter?{base:25,ring:"BULL",sector:25,mult:1}:t>=Z.doubleOuter?{base:0,ring:"MISS",sector:null,mult:0}:t>=Z.doubleInner?{base:s*2,ring:"DOUBLE",sector:s,mult:2}:t>=Z.trebleOuter?{base:s,ring:"SINGLE",sector:s,mult:1}:t>=Z.trebleInner?{base:s*3,ring:"TRIPLE",sector:s,mult:3}:{base:s,ring:"SINGLE",sector:s,mult:1}}function Ul(r,t,n="#10b981",a=2){if(t.length){r.save(),r.strokeStyle=n,r.lineWidth=a,r.beginPath(),r.moveTo(t[0].x,t[0].y);for(let s=1;s<t.length;s++)r.lineTo(t[s].x,t[s].y);r.closePath(),r.stroke(),r.restore()}}function Xa(r,t,n="#f59e0b"){r.save(),r.strokeStyle=n,r.lineWidth=2,r.beginPath(),r.moveTo(t.x-8,t.y),r.lineTo(t.x+8,t.y),r.moveTo(t.x,t.y-8),r.lineTo(t.x,t.y+8),r.stroke(),r.restore()}function us(r,t,n){return Math.max(t,Math.min(n,r))}function Bl(r,t,n){const{width:a,data:s}=r,o=[[-1,0,1],[-2,0,2],[-1,0,1]],c=[[-1,-2,-1],[0,0,0],[1,2,1]];let i=0,h=0;for(let l=-1;l<=1;l++)for(let u=-1;u<=1;u++){const m=us(t+u,0,a-1),v=(us(n+l,0,r.height-1)*a+m)*4,x=s[v],y=s[v+1],w=s[v+2],C=.299*x+.587*y+.114*w;i+=C*o[l+1][u+1],h+=C*c[l+1][u+1]}return Math.hypot(i,h)}function $l(r,t,n=6){const s=r.getContext("2d").getImageData(0,0,r.width,r.height),o=us(Math.round(t.x),1,r.width-2),c=us(Math.round(t.y),1,r.height-2);let i={x:o,y:c,mag:-1};for(let h=c-n;h<=c+n;h++)for(let l=o-n;l<=o+n;l++){if(l<=0||h<=0||l>=r.width-1||h>=r.height-1)continue;const u=Bl(s,l,h);u>i.mag&&(i={x:l,y:h,mag:u})}return{x:i.x,y:i.y}}var Bs,Ka;function Qo(){if(Ka)return Bs;Ka=1;var r=r||{};return r.Image=function(t,n,a){this.width=t||0,this.height=n||0,this.data=a||[]},r.grayscale=function(t,n){for(var a=t.data,s=n.data,o=a.length,c=0,i=0;c<o;c+=4)s[i++]=a[c]*.299+a[c+1]*.587+a[c+2]*.114+.5&255;return n.width=t.width,n.height=t.height,n},r.threshold=function(t,n,a){var s=t.data,o=n.data,c=s.length,i=[],h;for(h=0;h<256;++h)i[h]=h<=a?0:255;for(h=0;h<c;++h)o[h]=i[s[h]];return n.width=t.width,n.height=t.height,n},r.adaptiveThreshold=function(t,n,a,s){var o=t.data,c=n.data,i=o.length,h=[],l;for(r.stackBoxBlur(t,n,a),l=0;l<768;++l)h[l]=l-255<=-s?255:0;for(l=0;l<i;++l)c[l]=h[o[l]-c[l]+255];return n.width=t.width,n.height=t.height,n},r.otsu=function(t){var n=t.data,a=n.length,s=[],o=0,c=0,i=0,h=0,l=0,u=0,m,d,v;for(v=0;v<256;++v)s[v]=0;for(v=0;v<a;++v)s[n[v]]++;for(v=0;v<256;++v)c+=s[v]*v;for(v=0;v<256;++v)if(h+=s[v],h!==0){if(l=a-h,l===0)break;i+=s[v]*v,m=i/h-(c-i)/l,d=h*l*m*m,d>u&&(u=d,o=v)}return o},r.stackBoxBlurMult=[1,171,205,293,57,373,79,137,241,27,391,357,41,19,283,265],r.stackBoxBlurShift=[0,9,10,11,9,12,10,11,12,9,13,13,10,9,13,13],r.BlurStack=function(){this.color=0,this.next=null},r.stackBoxBlur=function(t,n,a){var s=t.data,o=n.data,c=t.height,i=t.width,h=c-1,l=i-1,u=a+a+1,m=a+1,d=r.stackBoxBlurMult[a],v=r.stackBoxBlurShift[a],x,y,w,C,N,P,S,M,T,p;for(x=y=new r.BlurStack,p=1;p<u;++p)x=x.next=new r.BlurStack;for(x.next=y,N=0,T=0;T<c;++T){for(P=N,w=s[N],C=m*w,x=y,p=0;p<m;++p)x.color=w,x=x.next;for(p=1;p<m;++p)x.color=s[N+p],C+=x.color,x=x.next;for(x=y,M=0;M<i;++M)o[N++]=C*d>>>v,S=M+m,S=P+(S<l?S:l),C-=x.color-s[S],x.color=s[S],x=x.next}for(M=0;M<i;++M){for(N=M,P=N+i,w=o[N],C=m*w,x=y,p=0;p<m;++p)x.color=w,x=x.next;for(p=1;p<m;++p)x.color=o[P],C+=x.color,x=x.next,P+=i;for(x=y,T=0;T<c;++T)o[N]=C*d>>>v,S=T+m,S=M+(S<h?S:h)*i,C-=x.color-o[S],x.color=o[S],x=x.next,N+=i}return n},r.gaussianBlur=function(t,n,a,s){var o=r.gaussianKernel(s);return n.width=t.width,n.height=t.height,a.width=t.width,a.height=t.height,r.gaussianBlurFilter(t,a,o,!0),r.gaussianBlurFilter(a,n,o,!1),n},r.gaussianBlurFilter=function(t,n,a,s){var o=t.data,c=n.data,i=t.height,h=t.width,l=0,u=a.length>>1,m,d,v,x,y;for(v=0;v<i;++v)for(x=0;x<h;++x){for(d=0,y=-u;y<=u;++y)s?(m=l+y,(x+y<0||x+y>=h)&&(m=l)):(m=l+y*h,(v+y<0||v+y>=i)&&(m=l)),d+=a[u+y]*o[m];c[l++]=s?d:d+.5&255}return n},r.gaussianKernel=function(t){var n=[[1],[.25,.5,.25],[.0625,.25,.375,.25,.0625],[.03125,.109375,.21875,.28125,.21875,.109375,.03125]],a=[],s,o,c,i,h,l;if(t<=7&&t%2===1)a=n[t>>1];else{for(s=(t-1)*.5,o=.8+.3*(s-1),c=-.5/(o*o),i=0,l=0;l<t;++l)h=l-s,i+=a[l]=Math.exp(c*h*h);for(i=1/i,l=0;l<t;++l)a[l]*=i}return a},r.findContours=function(t,n){var a=t.width,s=t.height,o=[],c,i,h,l,u,m,d,v,x;for(c=r.binaryBorder(t,n),i=r.neighborhoodDeltas(a+2),h=a+3,u=1,v=0;v<s;++v,h+=2)for(x=0;x<a;++x,++h)l=c[h],l!==0&&(m=d=!1,l===1&&c[h-1]===0?m=!0:l>=1&&c[h+1]===0&&(d=!0),(m||d)&&(++u,o.push(r.borderFollowing(c,h,u,{x,y:v},d,i))));return o},r.borderFollowing=function(t,n,a,s,o,c){var i=[],h,l,u,m,d;i.hole=o,m=d=o?0:4;do if(m=m-1&7,h=n+c[m],t[h]!==0)break;while(m!==d);if(m===d)t[n]=-a,i.push({x:s.x,y:s.y});else for(l=n;;){d=m;do u=l+c[++m];while(t[u]===0);if(m&=7,m-1>>>0<d>>>0?t[l]=-a:t[l]===1&&(t[l]=a),i.push({x:s.x,y:s.y}),s.x+=r.neighborhood[m][0],s.y+=r.neighborhood[m][1],u===n&&l===h)break;l=u,m=m+4&7}return i},r.neighborhood=[[1,0],[1,-1],[0,-1],[-1,-1],[-1,0],[-1,1],[0,1],[1,1]],r.neighborhoodDeltas=function(t){for(var n=[],a=r.neighborhood.length,s=0;s<a;++s)n[s]=r.neighborhood[s][0]+r.neighborhood[s][1]*t;return n.concat(n)},r.approxPolyDP=function(t,n){var a={start_index:0,end_index:0},s={start_index:0,end_index:0},o=[],c=[],i=t.length,h,l,u,m,d,v,x,y,w,C,N;for(n*=n,N=0,w=0;w<3;++w)for(d=0,N=(N+s.start_index)%i,l=t[N],++N===i&&(N=0),C=1;C<i;++C)h=t[N],++N===i&&(N=0),x=h.x-l.x,y=h.y-l.y,m=x*x+y*y,m>d&&(d=m,s.start_index=C);for(d<=n?o.push({x:l.x,y:l.y}):(a.start_index=N,a.end_index=s.start_index+=a.start_index,s.start_index-=s.start_index>=i?i:0,s.end_index=a.start_index,s.end_index<s.start_index&&(s.end_index+=i),c.push({start_index:s.start_index,end_index:s.end_index}),c.push({start_index:a.start_index,end_index:a.end_index}));c.length!==0;){if(a=c.pop(),u=t[a.end_index%i],l=t[N=a.start_index%i],++N===i&&(N=0),a.end_index<=a.start_index+1)v=!0;else{for(d=0,x=u.x-l.x,y=u.y-l.y,w=a.start_index+1;w<a.end_index;++w)h=t[N],++N===i&&(N=0),m=Math.abs((h.y-l.y)*x-(h.x-l.x)*y),m>d&&(d=m,s.start_index=w);v=d*d<=n*(x*x+y*y)}v?o.push({x:l.x,y:l.y}):(s.end_index=a.end_index,a.end_index=s.start_index,c.push({start_index:s.start_index,end_index:s.end_index}),c.push({start_index:a.start_index,end_index:a.end_index}))}return o},r.warp=function(t,n,a,s){var o=t.data,c=n.data,i=t.width,h=t.height,l=0,u,m,d,v,x,y,w,C,N,P,S,M,T,p,k,z,W,ee,Q,K,le,ie,L;for(T=r.getPerspectiveTransform(a,s-1),p=T[8],k=T[2],z=T[5],ie=0;ie<s;++ie)for(p+=T[7],k+=T[1],z+=T[4],W=p,ee=k,Q=z,L=0;L<s;++L)W+=T[6],ee+=T[0],Q+=T[3],K=ee/W,le=Q/W,u=K>>>0,m=u===i-1?u:u+1,d=K-u,v=1-d,x=le>>>0,y=x===h-1?x:x+1,w=le-x,C=1-w,N=P=x*i,S=M=y*i,c[l++]=C*(v*o[N+u]+d*o[P+m])+w*(v*o[S+u]+d*o[M+m])&255;return n.width=s,n.height=s,n},r.getPerspectiveTransform=function(t,n){var a=r.square2quad(t);return a[0]/=n,a[1]/=n,a[3]/=n,a[4]/=n,a[6]/=n,a[7]/=n,a},r.square2quad=function(t){var n=[],a,s,o,c,i,h,l;return a=t[0].x-t[1].x+t[2].x-t[3].x,s=t[0].y-t[1].y+t[2].y-t[3].y,a===0&&s===0?(n[0]=t[1].x-t[0].x,n[1]=t[2].x-t[1].x,n[2]=t[0].x,n[3]=t[1].y-t[0].y,n[4]=t[2].y-t[1].y,n[5]=t[0].y,n[6]=0,n[7]=0,n[8]=1):(o=t[1].x-t[2].x,c=t[3].x-t[2].x,i=t[1].y-t[2].y,h=t[3].y-t[2].y,l=o*h-c*i,n[6]=(a*h-c*s)/l,n[7]=(o*s-a*i)/l,n[8]=1,n[0]=t[1].x-t[0].x+n[6]*t[1].x,n[1]=t[3].x-t[0].x+n[7]*t[3].x,n[2]=t[0].x,n[3]=t[1].y-t[0].y+n[6]*t[1].y,n[4]=t[3].y-t[0].y+n[7]*t[3].y,n[5]=t[0].y),n},r.isContourConvex=function(t){var n=0,a=!0,s=t.length,o=0,c=0,i,h,l,u,m,d,v,x;for(h=t[s-1],i=t[0],m=i.x-h.x,d=i.y-h.y;o<s;++o){if(++c===s&&(c=0),h=i,i=t[c],v=i.x-h.x,x=i.y-h.y,l=v*d,u=x*m,n|=u>l?1:u<l?2:3,n===3){a=!1;break}m=v,d=x}return a},r.perimeter=function(t){for(var n=t.length,a=0,s=n-1,o=0,c,i;a<n;s=a++)c=t[a].x-t[s].x,i=t[a].y-t[s].y,o+=Math.sqrt(c*c+i*i);return o},r.minEdgeLength=function(t){for(var n=t.length,a=0,s=n-1,o=1/0,c,i,h;a<n;s=a++)i=t[a].x-t[s].x,h=t[a].y-t[s].y,c=i*i+h*h,c<o&&(o=c);return Math.sqrt(o)},r.countNonZero=function(t,n){var a=t.data,s=n.height,o=n.width,c=n.x+n.y*t.width,i=t.width-o,h=0,l,u;for(l=0;l<s;++l){for(u=0;u<o;++u)a[c++]!==0&&++h;c+=i}return h},r.binaryBorder=function(t,n){var a=t.data,s=t.height,o=t.width,c=0,i=0,h,l;for(l=-2;l<o;++l)n[i++]=0;for(h=0;h<s;++h){for(n[i++]=0,l=0;l<o;++l)n[i++]=a[c++]===0?0:1;n[i++]=0}for(l=-2;l<o;++l)n[i++]=0;return n},Bs=r,Bs}var $s,Za;function Vl(){if(Za)return $s;Za=1;var r=Qo(),t=t||{};return t.Marker=function(n,a){this.id=n,this.corners=a},t.Detector=function(){this.grey=new r.Image,this.thres=new r.Image,this.homography=new r.Image,this.binary=[],this.contours=[],this.polys=[],this.candidates=[]},t.Detector.prototype.detect=function(n){return r.grayscale(n,this.grey),r.adaptiveThreshold(this.grey,this.thres,2,7),this.contours=r.findContours(this.thres,this.binary),this.candidates=this.findCandidates(this.contours,n.width*.2,.05,10),this.candidates=this.clockwiseCorners(this.candidates),this.candidates=this.notTooNear(this.candidates,10),this.findMarkers(this.grey,this.candidates,49)},t.Detector.prototype.findCandidates=function(n,a,s,o){var c=[],i=n.length,h,l,u;for(this.polys=[],u=0;u<i;++u)h=n[u],h.length>=a&&(l=r.approxPolyDP(h,h.length*s),this.polys.push(l),l.length===4&&r.isContourConvex(l)&&r.minEdgeLength(l)>=o&&c.push(l));return c},t.Detector.prototype.clockwiseCorners=function(n){var a=n.length,s,o,c,i,h,l;for(l=0;l<a;++l)s=n[l][1].x-n[l][0].x,c=n[l][1].y-n[l][0].y,o=n[l][2].x-n[l][0].x,i=n[l][2].y-n[l][0].y,s*i-c*o<0&&(h=n[l][1],n[l][1]=n[l][3],n[l][3]=h);return n},t.Detector.prototype.notTooNear=function(n,a){var s=[],o=n.length,c,i,h,l,u,m;for(l=0;l<o;++l)for(u=l+1;u<o;++u){for(c=0,m=0;m<4;++m)i=n[l][m].x-n[u][m].x,h=n[l][m].y-n[u][m].y,c+=i*i+h*h;c/4<a*a&&(r.perimeter(n[l])<r.perimeter(n[u])?n[l].tooNear=!0:n[u].tooNear=!0)}for(l=0;l<o;++l)n[l].tooNear||s.push(n[l]);return s},t.Detector.prototype.findMarkers=function(n,a,s){var o=[],c=a.length,i,h,l;for(l=0;l<c;++l)i=a[l],r.warp(n,this.homography,i,s),r.threshold(this.homography,this.homography,r.otsu(this.homography)),h=this.getMarker(this.homography,i),h&&o.push(h);return o},t.Detector.prototype.getMarker=function(n,a){var s=n.width/7>>>0,o=s*s>>1,c=[],i=[],h=[],l,u,m,d,v;for(d=0;d<7;++d)for(m=d===0||d===6?1:6,v=0;v<7;v+=m)if(l={x:v*s,y:d*s,width:s,height:s},r.countNonZero(n,l)>o)return null;for(d=0;d<5;++d)for(c[d]=[],v=0;v<5;++v)l={x:(v+1)*s,y:(d+1)*s,width:s,height:s},c[d][v]=r.countNonZero(n,l)>o?1:0;for(i[0]=c,h[0]=this.hammingDistance(i[0]),u={first:h[0],second:0},d=1;d<4;++d)i[d]=this.rotate(i[d-1]),h[d]=this.hammingDistance(i[d]),h[d]<u.first&&(u.first=h[d],u.second=d);return u.first!==0?null:new t.Marker(this.mat2id(i[u.second]),this.rotate2(a,4-u.second))},t.Detector.prototype.hammingDistance=function(n){var a=[[1,0,0,0,0],[1,0,1,1,1],[0,1,0,0,1],[0,1,1,1,0]],s=0,o,c,i,h,l;for(i=0;i<5;++i){for(c=1/0,h=0;h<4;++h){for(o=0,l=0;l<5;++l)o+=n[i][l]===a[h][l]?0:1;o<c&&(c=o)}s+=c}return s},t.Detector.prototype.mat2id=function(n){var a=0,s;for(s=0;s<5;++s)a<<=1,a|=n[s][1],a<<=1,a|=n[s][3];return a},t.Detector.prototype.rotate=function(n){var a=[],s=n.length,o,c;for(o=0;o<s;++o)for(a[o]=[],c=0;c<n[o].length;++c)a[o][c]=n[n[o].length-c-1][o];return a},t.Detector.prototype.rotate2=function(n,a){var s=[],o=n.length,c;for(c=0;c<o;++c)s[c]=n[(a+c)%o];return s},$s=t,$s}var Vs,Qa;function Na(){if(Qa)return Vs;Qa=1;var r=r||{};return r.svdcmp=function(t,n,a,s,o){var c,i,h,l,u,m,d,v,x=0,y,w,C=0,N,P,S=0,M,T,p,k=[];for(i=0;i<a;++i){if(d=i+1,k[i]=S*C,C=P=S=0,i<n){for(m=i;m<n;++m)S+=Math.abs(t[m][i]);if(S!==0){for(m=i;m<n;++m)t[m][i]/=S,P+=t[m][i]*t[m][i];for(w=t[i][i],C=-r.sign(Math.sqrt(P),w),N=w*C-P,t[i][i]=w-C,l=d;l<a;++l){for(P=0,m=i;m<n;++m)P+=t[m][i]*t[m][l];for(w=P/N,m=i;m<n;++m)t[m][l]+=w*t[m][i]}for(m=i;m<n;++m)t[m][i]*=S}}if(s[i]=S*C,C=P=S=0,i<n&&i!==a-1){for(m=d;m<a;++m)S+=Math.abs(t[i][m]);if(S!==0){for(m=d;m<a;++m)t[i][m]/=S,P+=t[i][m]*t[i][m];for(w=t[i][d],C=-r.sign(Math.sqrt(P),w),N=w*C-P,t[i][d]=w-C,m=d;m<a;++m)k[m]=t[i][m]/N;for(l=d;l<n;++l){for(P=0,m=d;m<a;++m)P+=t[l][m]*t[i][m];for(m=d;m<a;++m)t[l][m]+=P*k[m]}for(m=d;m<a;++m)t[i][m]*=S}}x=Math.max(x,Math.abs(s[i])+Math.abs(k[i]))}for(i=a-1;i>=0;--i){if(i<a-1){if(C!==0){for(l=d;l<a;++l)o[l][i]=t[i][l]/t[i][d]/C;for(l=d;l<a;++l){for(P=0,m=d;m<a;++m)P+=t[i][m]*o[m][l];for(m=d;m<a;++m)o[m][l]+=P*o[m][i]}}for(l=d;l<a;++l)o[i][l]=o[l][i]=0}o[i][i]=1,C=k[i],d=i}for(i=Math.min(a,n)-1;i>=0;--i){for(d=i+1,C=s[i],l=d;l<a;++l)t[i][l]=0;if(C!==0){for(C=1/C,l=d;l<a;++l){for(P=0,m=d;m<n;++m)P+=t[m][i]*t[m][l];for(w=P/t[i][i]*C,m=i;m<n;++m)t[m][l]+=w*t[m][i]}for(l=i;l<n;++l)t[l][i]*=C}else for(l=i;l<n;++l)t[l][i]=0;++t[i][i]}for(m=a-1;m>=0;--m)for(h=1;h<=30;++h){for(c=!0,d=m;d>=0;--d){if(v=d-1,Math.abs(k[d])+x===x){c=!1;break}if(Math.abs(s[v])+x===x)break}if(c)for(y=0,P=1,i=d;i<=m&&(w=P*k[i],Math.abs(w)+x!==x);++i)for(C=s[i],N=r.pythag(w,C),s[i]=N,N=1/N,y=C*N,P=-w*N,l=1;l<=n;++l)T=t[l][v],p=t[l][i],t[l][v]=T*y+p*P,t[l][i]=p*y-T*P;if(p=s[m],d===m){if(p<0)for(s[m]=-p,l=0;l<a;++l)o[l][m]=-o[l][m];break}if(h===30)return!1;for(M=s[d],v=m-1,T=s[v],C=k[v],N=k[m],w=((T-p)*(T+p)+(C-N)*(C+N))/(2*N*T),C=r.pythag(w,1),w=((M-p)*(M+p)+N*(T/(w+r.sign(C,w))-N))/M,y=P=1,l=d;l<=v;++l){for(i=l+1,C=k[i],T=s[i],N=P*C,C=y*C,p=r.pythag(w,N),k[l]=p,y=w/p,P=N/p,w=M*y+C*P,C=C*y-M*P,N=T*P,T*=y,u=0;u<a;++u)M=o[u][l],p=o[u][i],o[u][l]=M*y+p*P,o[u][i]=p*y-M*P;for(p=r.pythag(w,N),s[l]=p,p!==0&&(p=1/p,y=w*p,P=N*p),w=y*C+P*T,M=y*T-P*C,u=0;u<n;++u)T=t[u][l],p=t[u][i],t[u][l]=T*y+p*P,t[u][i]=p*y-T*P}k[d]=0,k[m]=w,s[m]=M}return!0},r.pythag=function(t,n){var a=Math.abs(t),s=Math.abs(n),o;return a>s?(o=s/a,a*Math.sqrt(1+o*o)):s===0?0:(o=a/s,s*Math.sqrt(1+o*o))},r.sign=function(t,n){return n>=0?Math.abs(t):-Math.abs(t)},Vs=r,Vs}var zs,eo;function zl(){if(eo)return zs;eo=1;var r=Na(),t=t||{};return t.Posit=function(n,a){this.objectPoints=this.buildModel(n),this.focalLength=a,this.objectVectors=[],this.objectNormal=[],this.objectMatrix=[[],[],[]],this.init()},t.Posit.prototype.buildModel=function(n){var a=n/2;return[[-a,a,0],[a,a,0],[a,-a,0],[-a,-a,0]]},t.Posit.prototype.init=function(){var n=this.objectPoints.length,a=[],s=[],o=0,c=2,i;for(i=0;i<n;++i)this.objectVectors[i]=[this.objectPoints[i][0]-this.objectPoints[0][0],this.objectPoints[i][1]-this.objectPoints[0][1],this.objectPoints[i][2]-this.objectPoints[0][2]],a[i]=[this.objectVectors[i][0],this.objectVectors[i][1],this.objectVectors[i][2]];for(;o===0;)s[0]=this.objectVectors[1][1]*this.objectVectors[c][2]-this.objectVectors[1][2]*this.objectVectors[c][1],s[1]=this.objectVectors[1][2]*this.objectVectors[c][0]-this.objectVectors[1][0]*this.objectVectors[c][2],s[2]=this.objectVectors[1][0]*this.objectVectors[c][1]-this.objectVectors[1][1]*this.objectVectors[c][0],o=Math.sqrt(s[0]*s[0]+s[1]*s[1]+s[2]*s[2]),++c;for(i=0;i<3;++i)this.objectNormal[i]=s[i]/o;t.pseudoInverse(a,n,this.objectMatrix)},t.Posit.prototype.pose=function(n){var a=[[],[],[]],s=[[],[],[]],o=[],c=[[],[],[]],i=[[],[],[]],h=[],l=[],u,m,d,v,x,y;for(this.pos(n,a,s,o),d=this.isValid(a,o),d?u=this.iterate(n,a,o,c,h):u={euclidean:-1,pixels:-1,maximum:-1},v=this.isValid(s,o),v?m=this.iterate(n,s,o,i,l):m={euclidean:-1,pixels:-1,maximum:-1},x=0;x<3;++x)for(y=0;y<3;++y)d&&(h[x]-=c[x][y]*this.objectPoints[0][y]),v&&(l[x]-=i[x][y]*this.objectPoints[0][y]);return u.euclidean<m.euclidean?new t.Pose(u.pixels,c,h,m.pixels,i,l):new t.Pose(m.pixels,i,l,u.pixels,c,h)},t.Posit.prototype.pos=function(n,a,s,o){var c=this.objectPoints.length,i=[],h=[],l=[],u=[],m=[],d=[],v=[],x=[],y,w,C,N,P,S,M,T,p,k;for(p=0;p<c;++p)i[p]=[n[p].x-n[0].x,n[p].y-n[0].y];for(p=0;p<3;++p)for(h[p]=0,l[p]=0,k=0;k<c;++k)h[p]+=this.objectMatrix[p][k]*i[k][0],l[p]+=this.objectMatrix[p][k]*i[k][1];for(y=h[0]*h[0]+h[1]*h[1]+h[2]*h[2],w=l[0]*l[0]+l[1]*l[1]+l[2]*l[2],C=h[0]*l[0]+h[1]*l[1]+h[2]*l[2],N=(w-y)*(w-y)+4*(C*C),w-y>=0?P=(w-y+Math.sqrt(N))/2:P=(w-y-Math.sqrt(N))/2,P>=0?(S=Math.sqrt(P),S===0?M=0:M=-C/S):(S=Math.sqrt(-(C*C)/P),S===0?M=Math.sqrt(y-w):M=-C/S),p=0;p<3;++p)u[p]=h[p]+S*this.objectNormal[p],m[p]=l[p]+M*this.objectNormal[p];for(T=Math.sqrt(u[0]*u[0]+u[1]*u[1]+u[2]*u[2]),p=0;p<3;++p)d[p]=u[p]/T,v[p]=m[p]/T;for(x[0]=d[1]*v[2]-d[2]*v[1],x[1]=d[2]*v[0]-d[0]*v[2],x[2]=d[0]*v[1]-d[1]*v[0],p=0;p<3;++p)a[0][p]=d[p],a[1][p]=v[p],a[2][p]=x[p];for(p=0;p<3;++p)u[p]=h[p]-S*this.objectNormal[p],m[p]=l[p]-M*this.objectNormal[p];for(p=0;p<3;++p)d[p]=u[p]/T,v[p]=m[p]/T;for(x[0]=d[1]*v[2]-d[2]*v[1],x[1]=d[2]*v[0]-d[0]*v[2],x[2]=d[0]*v[1]-d[1]*v[0],p=0;p<3;++p)s[0][p]=d[p],s[1][p]=v[p],s[2][p]=x[p];o[0]=n[0].x/T,o[1]=n[0].y/T,o[2]=this.focalLength/T},t.Posit.prototype.isValid=function(n,a){for(var s=this.objectPoints.length,o=1/0,c=0,i;c<s;++c)i=a[2]+(n[2][0]*this.objectVectors[c][0]+n[2][1]*this.objectVectors[c][1]+n[2][2]*this.objectVectors[c][2]),i<o&&(o=i);return o>=0},t.Posit.prototype.iterate=function(n,a,s,o,c){var i=this.objectPoints.length,h=[],l=[],u=[[],[],[]],m=[[],[],[]],d=[],v=[],x=!1,y=0,w,C,N,P,S,M,T,p,k;for(p=0;p<i;++p)h[p]={x:n[p].x,y:n[p].y};for(p=0;p<3;++p){for(k=0;k<3;++k)o[p][k]=a[p][k];c[p]=s[p]}for(p=0;p<i;++p){for(N=0,k=0;k<3;++k)N+=this.objectVectors[p][k]*o[2][k]/c[2];l[p]={x:(1+N)*n[p].x,y:(1+N)*n[p].y}}for(C=0,p=0;p<i;++p)C+=Math.abs(l[p].x-h[p].x),C+=Math.abs(l[p].y-h[p].y);for(p=0;p<3;++p)d[p]=c[p]-(o[p][0]*this.objectPoints[0][0]+o[p][1]*this.objectPoints[0][1]+o[p][2]*this.objectPoints[0][2]);for(P=S=this.error(n,o,d),x=S.pixels===0||C<.01;y++<100&&!x;){for(p=0;p<i;++p)h[p].x=l[p].x,h[p].y=l[p].y;for(this.pos(l,u,m,c),p=0;p<3;++p)d[p]=c[p]-(u[p][0]*this.objectPoints[0][0]+u[p][1]*this.objectPoints[0][1]+u[p][2]*this.objectPoints[0][2]),v[p]=c[p]-(m[p][0]*this.objectPoints[0][0]+m[p][1]*this.objectPoints[0][1]+m[p][2]*this.objectPoints[0][2]);if(S=this.error(n,u,d),M=this.error(n,m,v),S.euclidean>=0&&M.euclidean>=0)if(M.euclidean<S.euclidean)for(P=M,p=0;p<3;++p)for(k=0;k<3;++k)o[p][k]=m[p][k];else for(P=S,p=0;p<3;++p)for(k=0;k<3;++k)o[p][k]=u[p][k];if(S.euclidean<0&&M.euclidean>=0)for(P=M,p=0;p<3;++p)for(k=0;k<3;++k)o[p][k]=m[p][k];if(M.euclidean<0&&S.euclidean>=0)for(P=S,p=0;p<3;++p)for(k=0;k<3;++k)o[p][k]=u[p][k];for(p=0;p<i;++p){for(N=0,k=0;k<3;++k)N+=this.objectVectors[p][k]*o[2][k]/c[2];l[p].x=(1+N)*n[p].x,l[p].y=(1+N)*n[p].y}for(w=C,C=0,p=0;p<i;++p)C+=Math.abs(l[p].x-h[p].x),C+=Math.abs(l[p].y-h[p].y);T=Math.abs(C-w),x=P.pixels===0||T<.01}return P},t.Posit.prototype.error=function(n,a,s){var o=this.objectPoints.length,c=[],i=[],h=[],l=0,u=0,m=0,d,v,x;if(!this.isValid(a,s))return{euclidean:-1,pixels:-1,maximum:-1};for(d=0;d<o;++d)for(c[d]=[],v=0;v<3;++v)c[d][v]=s[v];for(d=0;d<o;++d)for(v=0;v<3;++v)for(x=0;x<3;++x)c[d][v]+=a[v][x]*this.objectPoints[d][x];for(d=0;d<o;++d)for(i[d]=[],v=0;v<2;++v)i[d][v]=this.focalLength*c[d][v]/c[d][2];for(d=0;d<o;++d)h[d]=[i[d][0]-n[d].x,i[d][1]-n[d].y];for(d=0;d<o;++d)l+=Math.sqrt(h[d][0]*h[d][0]+h[d][1]*h[d][1]),u+=Math.abs(Math.round(i[d][0])-Math.round(n[d].x))+Math.abs(Math.round(i[d][1])-Math.round(n[d].y)),Math.abs(h[d][0])>m&&(m=Math.abs(h[d][0])),Math.abs(h[d][1])>m&&(m=Math.abs(h[d][1]));return{euclidean:l/o,pixels:u,maximum:m}},t.pseudoInverse=function(n,a,s){var o=[],c=[[],[],[]],i=[[],[],[]],h=0,l=0,u,m,d;for(r.svdcmp(n,a,3,o,c),u=0;u<3;++u)o[u]>h&&(h=o[u]);for(h*=.01,u=0;u<3;++u)o[u]<h&&(o[u]=0);for(m=0;m<3;++m)if(o[m]===0)for(++l,d=m;d<2;++d){for(u=0;u<a;++u)n[u][d]=n[u][d+1];for(u=0;u<3;++u)c[u][d]=c[u][d+1]}for(m=0;m<2;++m)o[m]===0&&(o[m]=o[m+1]);for(u=0;u<3;++u)for(m=0;m<3-l;++m)i[u][m]=c[u][m]/o[m];for(u=0;u<3;++u)for(m=0;m<a;++m)for(s[u][m]=0,d=0;d<3-l;++d)s[u][m]+=i[u][d]*n[m][d]},t.Pose=function(n,a,s,o,c,i){this.bestError=n,this.bestRotation=a,this.bestTranslation=s,this.alternativeError=o,this.alternativeRotation=c,this.alternativeTranslation=i},zs=t,zs}var Ws,to;function Wl(){if(to)return Ws;to=1;var r=Na(),t=t||{};t.Posit=function(s,o){this.model=this.buildModel(s),this.focalLength=o,this.init()},t.Posit.prototype.buildModel=function(s){var o=s/2;return[new n(-o,o,0),new n(o,o,0),new n(o,-o,0),new n(-o,-o,0)]},t.Posit.prototype.init=function(){var s=new n,o=new a,c;this.modelVectors=a.fromRows(n.sub(this.model[1],this.model[0]),n.sub(this.model[2],this.model[0]),n.sub(this.model[3],this.model[0])),c=a.clone(this.modelVectors),r.svdcmp(c.m,3,3,s.v,o.m),this.modelPseudoInverse=a.mult(a.mult(o,a.fromDiagonal(n.inverse(s))),a.transpose(c)),this.modelNormal=o.column(s.minIndex())},t.Posit.prototype.pose=function(s){var o=new n(1,1,1),c=new a,i=new a,h=new n,l=new n,u,m;return this.pos(s,o,c,i,h,l),u=this.iterate(s,c,h),m=this.iterate(s,i,l),u<m?new t.Pose(u,c.m,h.v,m,i.m,l.v):new t.Pose(m,i.m,l.v,u,c.m,h.v)},t.Posit.prototype.pos=function(s,o,c,i,h,l){var u=new n(s[1].x,s[2].x,s[3].x),m=new n(s[1].y,s[2].y,s[3].y),d=n.addScalar(n.mult(u,o),-s[0].x),v=n.addScalar(n.mult(m,o),-s[0].y),x=a.multVector(this.modelPseudoInverse,d),y=a.multVector(this.modelPseudoInverse,v),w=y.square()-x.square(),C=n.dot(x,y),N=0,P=0,S,M,T,p,k,z,W,ee,Q;w===0?(N=Math.sqrt(Math.abs(2*C)),P=-Math.PI/2*(C<0?-1:C>0?1:0)):(N=Math.sqrt(Math.sqrt(w*w+4*C*C)),P=Math.atan(-2*C/w),w<0&&(P+=Math.PI),P/=2),ee=N*Math.cos(P),Q=N*Math.sin(P),S=n.add(x,n.multScalar(this.modelNormal,ee)),M=n.add(y,n.multScalar(this.modelNormal,Q)),p=S.normalize(),k=M.normalize(),T=n.cross(S,M),c.copy(a.fromRows(S,M,T)),z=(p+k)/2,W=a.multVector(c,this.model[0]),h.v=[s[0].x/z-W.v[0],s[0].y/z-W.v[1],this.focalLength/z],S=n.sub(x,n.multScalar(this.modelNormal,ee)),M=n.sub(y,n.multScalar(this.modelNormal,Q)),p=S.normalize(),k=M.normalize(),T=n.cross(S,M),i.copy(a.fromRows(S,M,T)),z=(p+k)/2,W=a.multVector(i,this.model[0]),l.v=[s[0].x/z-W.v[0],s[0].y/z-W.v[1],this.focalLength/z]},t.Posit.prototype.iterate=function(s,o,c){for(var i=1/0,h=new a,l=new a,u=new n,m=new n,d=0,v,x,y,w;d<100&&(v=n.addScalar(n.multScalar(a.multVector(this.modelVectors,o.row(2)),1/c.v[2]),1),this.pos(s,v,h,l,u,m),y=this.getError(s,h,u),w=this.getError(s,l,m),y<w?(o.copy(h),c.copy(u),x=y):(o.copy(l),c.copy(m),x=w),!(x<=2||x>i));++d)i=x;return x},t.Posit.prototype.getError=function(s,o,c){var i=n.add(a.multVector(o,this.model[0]),c),h=n.add(a.multVector(o,this.model[1]),c),l=n.add(a.multVector(o,this.model[2]),c),u=n.add(a.multVector(o,this.model[3]),c),m,d,v,x,y,w,C,N,P;return i=i.v,h=h.v,l=l.v,u=u.v,i[0]*=this.focalLength/i[2],i[1]*=this.focalLength/i[2],h[0]*=this.focalLength/h[2],h[1]*=this.focalLength/h[2],l[0]*=this.focalLength/l[2],l[1]*=this.focalLength/l[2],u[0]*=this.focalLength/u[2],u[1]*=this.focalLength/u[2],m=[{x:i[0],y:i[1]},{x:h[0],y:h[1]},{x:l[0],y:l[1]},{x:u[0],y:u[1]}],d=this.angle(s[0],s[1],s[3]),v=this.angle(s[1],s[2],s[0]),x=this.angle(s[2],s[3],s[1]),y=this.angle(s[3],s[0],s[2]),w=this.angle(m[0],m[1],m[3]),C=this.angle(m[1],m[2],m[0]),N=this.angle(m[2],m[3],m[1]),P=this.angle(m[3],m[0],m[2]),(Math.abs(d-w)+Math.abs(v-C)+Math.abs(x-N)+Math.abs(y-P))/4},t.Posit.prototype.angle=function(s,o,c){var i=o.x-s.x,h=o.y-s.y,l=c.x-s.x,u=c.y-s.y;return Math.acos((i*l+h*u)/(Math.sqrt(i*i+h*h)*Math.sqrt(l*l+u*u)))*180/Math.PI},t.Pose=function(s,o,c,i,h,l){this.bestError=s,this.bestRotation=o,this.bestTranslation=c,this.alternativeError=i,this.alternativeRotation=h,this.alternativeTranslation=l};var n=function(s,o,c){this.v=[s||0,o||0,c||0]};n.prototype.copy=function(s){var o=this.v;return s=s.v,o[0]=s[0],o[1]=s[1],o[2]=s[2],this},n.add=function(s,o){var c=new n,i=c.v;return s=s.v,o=o.v,i[0]=s[0]+o[0],i[1]=s[1]+o[1],i[2]=s[2]+o[2],c},n.sub=function(s,o){var c=new n,i=c.v;return s=s.v,o=o.v,i[0]=s[0]-o[0],i[1]=s[1]-o[1],i[2]=s[2]-o[2],c},n.mult=function(s,o){var c=new n,i=c.v;return s=s.v,o=o.v,i[0]=s[0]*o[0],i[1]=s[1]*o[1],i[2]=s[2]*o[2],c},n.addScalar=function(s,o){var c=new n,i=c.v;return s=s.v,i[0]=s[0]+o,i[1]=s[1]+o,i[2]=s[2]+o,c},n.multScalar=function(s,o){var c=new n,i=c.v;return s=s.v,i[0]=s[0]*o,i[1]=s[1]*o,i[2]=s[2]*o,c},n.dot=function(s,o){return s=s.v,o=o.v,s[0]*o[0]+s[1]*o[1]+s[2]*o[2]},n.cross=function(s,o){return s=s.v,o=o.v,new n(s[1]*o[2]-s[2]*o[1],s[2]*o[0]-s[0]*o[2],s[0]*o[1]-s[1]*o[0])},n.prototype.normalize=function(){var s=this.v,o=Math.sqrt(s[0]*s[0]+s[1]*s[1]+s[2]*s[2]);return o>0&&(s[0]/=o,s[1]/=o,s[2]/=o),o},n.inverse=function(s){var o=new n,c=o.v;return s=s.v,s[0]!==0&&(c[0]=1/s[0]),s[1]!==0&&(c[1]=1/s[1]),s[2]!==0&&(c[2]=1/s[2]),o},n.prototype.square=function(){var s=this.v;return s[0]*s[0]+s[1]*s[1]+s[2]*s[2]},n.prototype.minIndex=function(){var s=this.v;return s[0]<s[1]?s[0]<s[2]?0:2:s[1]<s[2]?1:2};var a=function(){this.m=[[0,0,0],[0,0,0],[0,0,0]]};return a.clone=function(s){var o=new a,c=o.m;return s=s.m,c[0][0]=s[0][0],c[0][1]=s[0][1],c[0][2]=s[0][2],c[1][0]=s[1][0],c[1][1]=s[1][1],c[1][2]=s[1][2],c[2][0]=s[2][0],c[2][1]=s[2][1],c[2][2]=s[2][2],o},a.prototype.copy=function(s){var o=this.m;return s=s.m,o[0][0]=s[0][0],o[0][1]=s[0][1],o[0][2]=s[0][2],o[1][0]=s[1][0],o[1][1]=s[1][1],o[1][2]=s[1][2],o[2][0]=s[2][0],o[2][1]=s[2][1],o[2][2]=s[2][2],this},a.fromRows=function(s,o,c){var i=new a,h=i.m;return s=s.v,o=o.v,c=c.v,h[0][0]=s[0],h[0][1]=s[1],h[0][2]=s[2],h[1][0]=o[0],h[1][1]=o[1],h[1][2]=o[2],h[2][0]=c[0],h[2][1]=c[1],h[2][2]=c[2],i},a.fromDiagonal=function(s){var o=new a,c=o.m;return s=s.v,c[0][0]=s[0],c[1][1]=s[1],c[2][2]=s[2],o},a.transpose=function(s){var o=new a,c=o.m;return s=s.m,c[0][0]=s[0][0],c[0][1]=s[1][0],c[0][2]=s[2][0],c[1][0]=s[0][1],c[1][1]=s[1][1],c[1][2]=s[2][1],c[2][0]=s[0][2],c[2][1]=s[1][2],c[2][2]=s[2][2],o},a.mult=function(s,o){var c=new a,i=c.m;return s=s.m,o=o.m,i[0][0]=s[0][0]*o[0][0]+s[0][1]*o[1][0]+s[0][2]*o[2][0],i[0][1]=s[0][0]*o[0][1]+s[0][1]*o[1][1]+s[0][2]*o[2][1],i[0][2]=s[0][0]*o[0][2]+s[0][1]*o[1][2]+s[0][2]*o[2][2],i[1][0]=s[1][0]*o[0][0]+s[1][1]*o[1][0]+s[1][2]*o[2][0],i[1][1]=s[1][0]*o[0][1]+s[1][1]*o[1][1]+s[1][2]*o[2][1],i[1][2]=s[1][0]*o[0][2]+s[1][1]*o[1][2]+s[1][2]*o[2][2],i[2][0]=s[2][0]*o[0][0]+s[2][1]*o[1][0]+s[2][2]*o[2][0],i[2][1]=s[2][0]*o[0][1]+s[2][1]*o[1][1]+s[2][2]*o[2][1],i[2][2]=s[2][0]*o[0][2]+s[2][1]*o[1][2]+s[2][2]*o[2][2],c},a.multVector=function(s,o){return s=s.m,o=o.v,new n(s[0][0]*o[0]+s[0][1]*o[1]+s[0][2]*o[2],s[1][0]*o[0]+s[1][1]*o[1]+s[1][2]*o[2],s[2][0]*o[0]+s[2][1]*o[1]+s[2][2]*o[2])},a.prototype.column=function(s){var o=this.m;return new n(o[0][s],o[1][s],o[2][s])},a.prototype.row=function(s){var o=this.m;return new n(o[s][0],o[s][1],o[s][2])},Ws=t,Ws}var qs,no;function ql(){return no||(no=1,qs={CV:Qo(),AR:Vl(),SVD:Na(),POS1:zl(),POS2:Wl()}),qs}ql();const Hl={"0,0":[1,0,0,0,0],"0,1":[1,0,1,1,1],"1,0":[0,1,0,0,1],"1,1":[0,1,1,1,0]};function Gl(r){const t=new Array(5);let n=r>>>0;for(let s=4;s>=0;s--){const o=n&1;n>>=1;const c=n&1;n>>=1;const i=Hl[`${c},${o}`];if(!i)throw new Error(`Unsupported marker id pattern for row ${s}`);t[s]=i.slice()}const a=Array.from({length:7},()=>new Array(7).fill(0));for(let s=0;s<5;s++)for(let o=0;o<5;o++)a[s+1][o+1]=t[s][o];return a}const Jl=r=>!!r&&Number.isFinite(r.x)&&Number.isFinite(r.y),Yl=r=>Array.isArray(r)&&r.length===9&&r.every(Number.isFinite);function Xl(r){const t=r.getContext("2d");if(!t)return null;const n=r.width,a=r.height,o=t.getImageData(0,0,n,a).data,c=[],i=Math.round(Math.max(8,Math.min(32,(n+a)/120))),h=new Float32Array(n*a);for(let k=0;k<a;k++)for(let z=0;z<n;z++){const W=(k*n+z)*4;h[k*n+z]=o[W]*.299+o[W+1]*.587+o[W+2]*.114}const l=new Float32Array(n*a);for(let k=1;k<a-1;k++)for(let z=1;z<n-1;z++){let W=0;for(let ee=-1;ee<=1;ee++)for(let Q=-1;Q<=1;Q++)W+=h[(k+ee)*n+(z+Q)];l[k*n+z]=W/9}for(let k=2;k<a-2;k++)for(let z=2;z<n-2;z++){let W=0,ee=0;for(let K=-1;K<=1;K++)for(let le=-1;le<=1;le++){const ie=l[(k+K)*n+(z+le)];le!==0&&(W+=(le>0?1:-1)*ie),K!==0&&(ee+=(K>0?1:-1)*ie)}const Q=Math.hypot(W,ee);Q>i&&c.push({x:z,y:k,mag:Q})}if(c.length===0)return null;const u=Math.max(3,Math.round(n*a/(640*480)*10));let m=null,d=0,v=0;const x=Math.max(6,Math.round(Math.min(n,a)/40));for(let k=Math.round(a*.3);k<Math.round(a*.7);k+=x)for(let z=Math.round(n*.3);z<Math.round(n*.7);z+=x){let W=0,ee=0;const K=Math.min(n,a)*.45/Z.doubleOuter,le=[Z.bullInner*K,Z.bullOuter*K,Z.trebleInner*K,Z.trebleOuter*K,Z.doubleInner*K,Z.doubleOuter*K],ie=Math.round(Math.min(Math.min(z,n-z),Math.min(k,a-k))),L=new Float32Array(ie+1);let Y=0;for(const H of c){const fe=Math.round(Math.hypot(H.x-z,H.y-k));fe<=0||fe>ie||(L[fe]+=H.mag,L[fe]>Y&&(Y=L[fe]))}const $=[],B=Math.max(12,Y*.08);for(let H=2;H<ie-2;H++){const fe=L[H];fe<=B||fe>L[H-1]&&fe>=L[H+1]&&$.push(H)}for(const H of le){const fe=Math.max(3,Math.round(H*.02));let Ye=-1,Ce=1/0;for(const Ve of $){const Le=Math.abs(Ve-H);Le<Ce&&(Ce=Le,Ye=Ve)}Ye>=0&&Ce<=fe&&(W++,ee+=L[Ye]||0)}W>=3&&ee>d&&(d=ee,m={cx:z,cy:k},v=W)}if(!m)return null;const y=m.cx,w=m.cy,C=Math.min(n,a)*.45,N=Math.max(6,Math.round(C*.5)),P=Math.min(Math.round(Math.max(n,a)-4),Math.round(C*1.5));let S=Math.round(C),M=0;for(let k=N;k<=P;k+=Math.max(2,Math.round((P-N)/60))){let z=0,W=0;for(const ee of c){const Q=Math.hypot(ee.x-y,ee.y-w),K=Math.max(2,Math.round(k*.01));Math.abs(Q-k)<K&&(z+=ee.mag,W++)}W>Math.max(6,Math.round(u*.6))&&z>M&&(M=z,S=k)}let T=0;const p=S/Z.doubleOuter;for(const k of[Z.bullInner,Z.bullOuter,Z.trebleInner,Z.trebleOuter,Z.doubleInner,Z.doubleOuter]){const z=k*p;for(const W of c){const ee=Math.hypot(W.x-y,W.y-w),Q=Math.max(3,Math.round(z*.02));if(Math.abs(ee-z)<Q){T+=15;break}}}return T=Math.min(100,T),{cx:y,cy:w,r:S,confidence:T,ringCount:v,ringStrength:Math.round(d)}}function ur(r){try{const t=r.width,n=r.height,a=t/2,s=n/2,o=Xl(r);if(!o)return{success:!1,cx:a,cy:s,bullInner:0,bullOuter:0,trebleInner:0,trebleOuter:0,doubleInner:0,doubleOuter:0,confidence:0,homography:null,errorPx:null,calibrationPoints:[],message:"No dartboard detected. Ensure board is clearly visible with good contrast between rings and background."};const c=o.r/Z.doubleOuter,i={cx:o.cx,cy:o.cy,bullInner:Z.bullInner*c,bullOuter:Z.bullOuter*c,trebleInner:Z.trebleInner*c,trebleOuter:Z.trebleOuter*c,doubleInner:Z.doubleInner*c,doubleOuter:o.r},h=[{x:i.cx,y:i.cy-i.doubleOuter},{x:i.cx+i.doubleOuter,y:i.cy},{x:i.cx,y:i.cy+i.doubleOuter},{x:i.cx-i.doubleOuter,y:i.cy}],l=[{x:0,y:-Z.doubleOuter},{x:Z.doubleOuter,y:0},{x:0,y:Z.doubleOuter},{x:-Z.doubleOuter,y:0}];let u=null,m=null,d=o.confidence;try{u=mr(l,h),m=Ar(u,l,h);const N=Math.max(10,Math.min(95,100-Math.max(0,m-1)*10));d=(d+N)/2}catch{d=Math.max(40,d)}const v=h.every(Jl),x=Yl(u),y=!!x&&v&&d>50,w=o.ringCount??0,C=o.ringStrength??0;return{success:y,cx:i.cx,cy:i.cy,bullInner:i.bullInner,bullOuter:i.bullOuter,trebleInner:i.trebleInner,trebleOuter:i.trebleOuter,doubleInner:i.doubleInner,doubleOuter:i.doubleOuter,confidence:d,homography:x?u:null,errorPx:x?m:null,calibrationPoints:v?h:[],message:!v||!x?`❌ Detection produced unstable calibration data. Adjust camera framing or calibrate manually. (rings: ${w}, r:${Math.round(o.r)})`:d>80?`✅ High confidence detection (rings: ${w}, r:${Math.round(o.r)})`:d>50?`⚠️ Detection found but could be better (rings: ${w}, r:${Math.round(o.r)})`:`❌ Low confidence - try better lighting (rings: ${w}, r:${Math.round(o.r)})`}}catch(t){return{success:!1,cx:r.width/2,cy:r.height/2,bullInner:0,bullOuter:0,trebleInner:0,trebleOuter:0,doubleInner:0,doubleOuter:0,confidence:0,homography:null,errorPx:null,calibrationPoints:[],message:t instanceof Error?t.message:"Board detection failed"}}}function ro(r){if(r.confidence>70)return r;const t={bullInner_to_bullOuter:Z.bullInner/Z.bullOuter,bullOuter_to_trebleInner:Z.bullOuter/Z.trebleInner,trebleOuter_to_doubleInner:Z.trebleOuter/Z.doubleInner,doubleInner_to_doubleOuter:Z.doubleInner/Z.doubleOuter},n={bullInner_to_bullOuter:r.bullInner/r.bullOuter,bullOuter_to_trebleInner:r.bullOuter/r.trebleInner,trebleOuter_to_doubleInner:r.trebleOuter/r.doubleInner,doubleInner_to_doubleOuter:r.doubleInner/r.doubleOuter};let a=0,s=0;for(const[i,h]of Object.entries(t)){const l=n[i],u=Math.abs(l-h)/h;a+=u,s++}const o=a/s,c=Math.max(10,r.confidence-o*100);return{...r,confidence:c,message:c>70?"✅ High confidence detection":c>50?"⚠️ Rings detected but ratios off - may need refinement":"❌ Low confidence - try repositioning camera"}}const ei="ndn_user_settings";function sa(){try{const r=localStorage.getItem(ei);if(!r)return{favoriteDouble:"D16",callerEnabled:!0,callerVoice:"",callerVolume:1,speakCheckoutOnly:!1,avgMode:"all-time",autoStartOffline:!1,rememberLastOffline:!0,lastOffline:{mode:"X01",x01Start:501,firstTo:1,aiLevel:"None"},reducedMotion:!1,compactHeader:!1,allowSpectate:!0,cameraScale:1,cameraAspect:"wide",cameraFitMode:"fit",calibrationGuide:!0,preferredCameraId:void 0,preferredCameraLabel:void 0,preserveCalibrationOverlay:!0,cameraEnabled:!0,hideCameraOverlay:!1,offlineLayout:"modern",autoscoreProvider:"built-in",autoscoreWsUrl:"",autoCommitMode:"wait-for-clear",allowAutocommitInOnline:!1,textSize:"medium",boxSize:"medium",matchType:"singles",teamAName:"Team A",teamBName:"Team B",dartTimerEnabled:!1,dartTimerSeconds:10,x01DoubleIn:!1};const t=JSON.parse(r);return{favoriteDouble:t.favoriteDouble||"D16",callerEnabled:typeof t.callerEnabled=="boolean"?t.callerEnabled:!0,callerVoice:t.callerVoice||"",callerVolume:typeof t.callerVolume=="number"?Math.max(0,Math.min(1,t.callerVolume)):1,speakCheckoutOnly:!!t.speakCheckoutOnly,avgMode:t.avgMode==="24h"?"24h":"all-time",autoStartOffline:!!t.autoStartOffline,rememberLastOffline:typeof t.rememberLastOffline=="boolean"?t.rememberLastOffline:!0,lastOffline:t.lastOffline&&typeof t.lastOffline=="object"?{mode:t.lastOffline.mode||"X01",x01Start:Number(t.lastOffline.x01Start)||501,firstTo:Number(t.lastOffline.firstTo)||1,aiLevel:t.lastOffline.aiLevel||"None"}:{mode:"X01",x01Start:501,firstTo:1,aiLevel:"None"},reducedMotion:!!t.reducedMotion,compactHeader:!!t.compactHeader,allowSpectate:typeof t.allowSpectate=="boolean"?t.allowSpectate:!0,cameraScale:typeof t.cameraScale=="number"&&isFinite(t.cameraScale)?Math.max(.5,Math.min(1.25,t.cameraScale)):1,cameraAspect:t.cameraAspect==="square"?"square":"wide",cameraFitMode:t.cameraFitMode==="fit"||t.cameraFitMode==="fill"?t.cameraFitMode:"fit",autoscoreProvider:t.autoscoreProvider==="external-ws"?"external-ws":t.autoscoreProvider==="manual"?"manual":"built-in",autoscoreWsUrl:typeof t.autoscoreWsUrl=="string"?t.autoscoreWsUrl:"",autoCommitMode:t.autoCommitMode==="immediate"?"immediate":"wait-for-clear",allowAutocommitInOnline:!!t.allowAutocommitInOnline,calibrationGuide:typeof t.calibrationGuide=="boolean"?t.calibrationGuide:!0,preferredCameraId:typeof t.preferredCameraId=="string"?t.preferredCameraId:void 0,preserveCalibrationOverlay:typeof t.preserveCalibrationOverlay=="boolean"?t.preserveCalibrationOverlay:!0,preferredCameraLabel:typeof t.preferredCameraLabel=="string"?t.preferredCameraLabel:void 0,preferredCameraLocked:typeof t.preferredCameraLocked=="boolean"?t.preferredCameraLocked:!1,cameraEnabled:typeof t.cameraEnabled=="boolean"?t.cameraEnabled:!0,hideCameraOverlay:typeof t.hideCameraOverlay=="boolean"?t.hideCameraOverlay:!1,offlineLayout:t.offlineLayout==="classic"?"classic":"modern",textSize:t.textSize==="small"||t.textSize==="large"?t.textSize:"medium",boxSize:t.boxSize==="small"||t.boxSize==="large"?t.boxSize:"medium",matchType:t.matchType==="doubles"?"doubles":"singles",teamAName:typeof t.teamAName=="string"?t.teamAName:"Team A",teamBName:typeof t.teamBName=="string"?t.teamBName:"Team B",dartTimerEnabled:typeof t.dartTimerEnabled=="boolean"?t.dartTimerEnabled:!1,dartTimerSeconds:typeof t.dartTimerSeconds=="number"&&isFinite(t.dartTimerSeconds)?Math.max(3,Math.min(60,t.dartTimerSeconds)):10,x01DoubleIn:typeof t.x01DoubleIn=="boolean"?t.x01DoubleIn:!1}}catch{return{favoriteDouble:"D16",callerEnabled:!0,callerVoice:"",callerVolume:1,speakCheckoutOnly:!1,avgMode:"all-time",autoStartOffline:!1,rememberLastOffline:!0,lastOffline:{mode:"X01",x01Start:501,firstTo:1,aiLevel:"None"},reducedMotion:!1,compactHeader:!1,allowSpectate:!0,cameraScale:1,cameraAspect:"wide",cameraFitMode:"fit",calibrationGuide:!0,preferredCameraId:void 0,preferredCameraLabel:void 0,preferredCameraLocked:!1,preserveCalibrationOverlay:!0,cameraEnabled:!0,hideCameraOverlay:!1,offlineLayout:"modern",autoscoreProvider:"built-in",autoscoreWsUrl:"",autoCommitMode:"wait-for-clear",textSize:"medium",boxSize:"medium",matchType:"singles",teamAName:"Team A",teamBName:"Team B",dartTimerEnabled:!1,dartTimerSeconds:10,x01DoubleIn:!1}}}function De(r){try{const t=sa();localStorage.setItem(ei,JSON.stringify({...t,...r}))}catch{}}const on=Vn((r,t)=>({...sa(),setFavoriteDouble:n=>{De({favoriteDouble:n}),r({favoriteDouble:n})},setCallerEnabled:n=>{De({callerEnabled:n}),r({callerEnabled:n})},setCallerVoice:n=>{De({callerVoice:n}),r({callerVoice:n})},setAvgMode:n=>{De({avgMode:n}),r({avgMode:n})},setCallerVolume:n=>{const a=Math.max(0,Math.min(1,n));De({callerVolume:a}),r({callerVolume:a})},setSpeakCheckoutOnly:n=>{De({speakCheckoutOnly:n}),r({speakCheckoutOnly:n})},setAutoStartOffline:n=>{De({autoStartOffline:n}),r({autoStartOffline:n})},setRememberLastOffline:n=>{De({rememberLastOffline:n}),r({rememberLastOffline:n})},setLastOffline:n=>{const s={...sa().lastOffline,...n};De({lastOffline:s}),r({lastOffline:s})},setReducedMotion:n=>{De({reducedMotion:n}),r({reducedMotion:n})},setCompactHeader:n=>{De({compactHeader:n}),r({compactHeader:n})},setAllowSpectate:n=>{De({allowSpectate:n}),r({allowSpectate:n})},ignorePreferredCameraSync:!1,setIgnorePreferredCameraSync:n=>{De({}),r({ignorePreferredCameraSync:n})},setCameraScale:n=>{const a=Math.max(.5,Math.min(1.25,n));De({cameraScale:a}),r({cameraScale:a})},setCameraAspect:n=>{const a=n==="square"?"square":"wide";De({cameraAspect:a}),r({cameraAspect:a})},setCameraFitMode:n=>{const a=n==="fit"?"fit":"fill";De({cameraFitMode:a}),r({cameraFitMode:a})},setAutoscoreProvider:n=>{De({autoscoreProvider:n}),r({autoscoreProvider:n})},setAutoscoreWsUrl:n=>{De({autoscoreWsUrl:n}),r({autoscoreWsUrl:n})},setAutoCommitMode:n=>{const a=n==="immediate"?"immediate":"wait-for-clear";De({autoCommitMode:a}),r({autoCommitMode:a})},setAllowAutocommitInOnline:n=>{De({allowAutocommitInOnline:n}),r({allowAutocommitInOnline:n})},setCalibrationGuide:n=>{De({calibrationGuide:n}),r({calibrationGuide:n})},setPreserveCalibrationOverlay:n=>{De({preserveCalibrationOverlay:n}),r({preserveCalibrationOverlay:n})},setPreferredCamera:(n,a,s=!1)=>{try{if(t().preferredCameraLocked&&!s){console.log("[USERSETTINGS] Camera selection locked and force=false, ignoring update");return}}catch{}try{const o=t();if(o.preferredCameraId===n&&o.preferredCameraLabel===a)return}catch{}De({preferredCameraId:n,preferredCameraLabel:a}),r({preferredCameraId:n,preferredCameraLabel:a})},setPreferredCameraLocked:n=>{try{if(t().ignorePreferredCameraSync&&n===!0){console.debug("[USERSETTINGS] Ignoring auto-lock due to ignorePreferredCameraSync");return}}catch{}De({preferredCameraLocked:n}),r({preferredCameraLocked:n})},setCameraEnabled:n=>{De({cameraEnabled:n}),r({cameraEnabled:n})},setHideCameraOverlay:n=>{De({hideCameraOverlay:n}),r({hideCameraOverlay:n})},setOfflineLayout:n=>{De({offlineLayout:n}),r({offlineLayout:n})},setTextSize:n=>{De({textSize:n}),r({textSize:n})},setBoxSize:n=>{De({boxSize:n}),r({boxSize:n})},setMatchType:n=>{const a=n==="doubles"?"doubles":"singles";De({matchType:a}),r({matchType:a})},setTeamAName:n=>{const a=n?.trim()||"Team A";De({teamAName:a}),r({teamAName:a})},setTeamBName:n=>{const a=n?.trim()||"Team B";De({teamBName:a}),r({teamBName:a})},setDartTimerEnabled:n=>{De({dartTimerEnabled:n}),r({dartTimerEnabled:n})},setDartTimerSeconds:n=>{const a=Math.max(3,Math.min(60,Math.round(n)));De({dartTimerSeconds:a}),r({dartTimerSeconds:a})},setX01DoubleIn:n=>{De({x01DoubleIn:n}),r({x01DoubleIn:n})}}));async function Kl(){const r=[];try{const t=await Zl();for(const n of t){const a=await ed(n,[80,8080,8787,8788,3e3,5e3]);for(const s of a){const o=await nd(s.ip,s.port);o&&r.push(o)}}}catch(t){console.error("Network discovery failed:",t)}return r}async function Zl(){const r=[];try{const t=new RTCPeerConnection({iceServers:[]});t.createDataChannel("");const n=await t.createOffer();return await t.setLocalDescription(n),new Promise(a=>{const s=setTimeout(()=>{t.close(),a(r)},5e3);t.onicecandidate=o=>{if(o.candidate){const i=o.candidate.candidate.match(/(\d+\.\d+\.\d+\.\d+)/);if(i&&i[1]&&!r.includes(i[1])){const h=i[1];Ql(h)&&r.push(h)}}else clearTimeout(s),t.close(),a(r)}})}catch(t){return console.error("Failed to get local IPs:",t),["192.168.1.0"]}}function Ql(r){const t=r.split(".").map(Number);return t[0]===10||t[0]===172&&t[1]>=16&&t[1]<=31||t[0]===192&&t[1]===168}async function ed(r,t){const n=[],a=r.split(".").slice(0,3).join("."),s=[];for(let c=1;c<=254;c++){const i=`${a}.${c}`;for(const h of t)s.push(td(i,h))}return(await Promise.allSettled(s)).forEach((c,i)=>{if(c.status==="fulfilled"&&c.value){const h=i%t.length,l=Math.floor(i/t.length),u=`${a}.${l+1}`;n.push({ip:u,port:t[h]})}}),n}async function td(r,t){try{const n=await fetch(`http://${r}:${t}/`,{method:"HEAD",mode:"no-cors",signal:AbortSignal.timeout(2e3)});return!0}catch{return!1}}async function nd(r,t){try{const n=["/","/api/info","/api/status","/camera","/stream"];for(const a of n)try{const s=await fetch(`http://${r}:${t}${a}`,{method:"GET",signal:AbortSignal.timeout(3e3)});if(s.ok){const o=s.headers.get("content-type")||"",c=await s.text();if(c.includes("OMNI")||c.includes("omni")||a.includes("omni"))return{id:`omni-${r}-${t}`,name:`OMNI Camera (${r})`,ip:r,port:t,type:"omni",capabilities:["video","calibration"],status:"online",connectionType:"wifi"};if(c.includes("VERT")||c.includes("vert")||a.includes("vert"))return{id:`vert-${r}-${t}`,name:`VERT Camera (${r})`,ip:r,port:t,type:"vert",capabilities:["video","calibration"],status:"online",connectionType:"wifi"};if(o.includes("video")||c.includes("stream")||a==="/stream")return{id:`generic-${r}-${t}`,name:`Network Camera (${r})`,ip:r,port:t,type:"generic",capabilities:["video"],status:"online",connectionType:"wifi"}}}catch{}}catch(n){console.error(`Failed to probe device ${r}:${t}:`,n)}return null}async function Lu(){const r=[];try{if(!("serial"in navigator))return console.warn("Web Serial API not supported in this browser"),r;const t=await navigator.serial.getPorts();for(const n of t){const a=await ti(n);a&&r.push(a)}}catch(t){console.error("USB device discovery failed:",t)}return r}async function _u(){try{if(!("serial"in navigator))return alert("Web Serial API not supported in this browser. Please use a compatible browser like Chrome or Edge."),null;const r=await navigator.serial.requestPort();return await ti(r)}catch(r){return r.name!=="NotFoundError"&&console.error("USB device request failed:",r),null}}async function ti(r){try{await r.open({baudRate:9600,dataBits:8,stopBits:1,parity:"none"});const t=r.readable?.getReader();if(t)try{const n=setTimeout(()=>t.cancel(),2e3),{value:a,done:s}=await t.read();if(clearTimeout(n),!s&&a){const o=new TextDecoder().decode(a);if(o.includes("OMNI")||o.includes("omni"))return t.releaseLock(),{id:`usb-omni-${Date.now()}`,name:"OMNI Camera (USB)",type:"omni",capabilities:["video","calibration"],status:"online",port:r};if(o.includes("VERT")||o.includes("vert"))return t.releaseLock(),{id:`usb-vert-${Date.now()}`,name:"VERT Camera (USB)",type:"vert",capabilities:["video","calibration"],status:"online",port:r}}}catch{}finally{try{t.releaseLock()}catch{}}return{id:`usb-generic-${Date.now()}`,name:"USB Scoring Device",type:"generic",capabilities:["video"],status:"online",port:r}}catch(t){return console.error("Failed to probe USB device:",t),null}}async function rd(r){try{const t=`http://${r.ip}:${r.port}/stream`,n=document.createElement("video");return n.src=t,n.crossOrigin="anonymous",new Promise((a,s)=>{n.onloadeddata=()=>{const o=document.createElement("canvas"),c=o.getContext("2d");o.width=n.videoWidth,o.height=n.videoHeight;const i=o.captureStream(30),h=()=>{n.readyState>=2&&c.drawImage(n,0,0),requestAnimationFrame(h)};h(),a(i)},n.onerror=()=>s(new Error("Failed to load video stream")),n.load()})}catch(t){return console.error("Failed to connect to network device:",t),null}}async function Fu(r){try{if(!r.port)throw new Error("No serial port available");return console.log("USB device connection not fully implemented yet"),null}catch(t){return console.error("Failed to connect to USB device:",t),null}}const xr=Vn((r,t)=>({recent:[],totals:{visits:0,darts:0,points:0,finishes:0,busts:0,byMode:{}},calibration:{hasHomography:!1,imageSize:null,lastUpdated:void 0},recordVisit:(n,a,s,o)=>r(c=>{const h={ts:Date.now(),mode:n,darts:a,visitTotal:s,preOpenDarts:o?.preOpenDarts,preRemaining:o?.preRemaining,postRemaining:o?.postRemaining,bust:o?.bust,finish:o?.finish,threeDartAvg:o?.threeDartAvg},l=[...c.recent,h].slice(-50),u={...c.totals};u.visits+=1,u.darts+=a,u.points+=s,h.finish&&(u.finishes+=1),h.bust&&(u.busts+=1);const m=u.byMode[n]||{visits:0,darts:0,points:0};m.visits+=1,m.darts+=a,m.points+=s,u.byMode[n]=m;try{const d=h.finish?"FINISH":h.bust?"BUST":"VISIT",v={mode:n,darts:a,visitTotal:s,preOpenDarts:h.preOpenDarts??0,preRemaining:h.preRemaining,postRemaining:h.postRemaining,threeDartAvg:h.threeDartAvg};console.info(`[Audit:${d}]`,v)}catch{}try{localStorage.setItem("ndn_audit_recent",JSON.stringify(l))}catch{}return{...c,recent:l,totals:u}}),setCalibrationStatus:n=>r(a=>{const s={hasHomography:n.hasHomography??a.calibration.hasHomography,imageSize:n.imageSize===void 0?a.calibration.imageSize:n.imageSize,lastUpdated:Date.now()};try{console.info("[Audit:Calibration]",s)}catch{}return{...a,calibration:s}}),reset:()=>r({recent:[],totals:{visits:0,darts:0,points:0,finishes:0,busts:0,byMode:{}},calibration:{hasHomography:!1,imageSize:null,lastUpdated:void 0}})}));try{typeof window<"u"&&(window.__NDN_AUDIT__={get:()=>xr.getState(),subscribe:xr.subscribe,reset:()=>xr.getState().reset()})}catch{}try{if(typeof window<"u"){const r=localStorage.getItem("ndn_audit_recent");if(r){const t=JSON.parse(r);Array.isArray(t)&&t.length&&xr.setState(n=>({...n,recent:t.slice(-50)}))}}}catch{}const is="ndn:match-sync",ni="ndn-match-sync";function Pn(r){try{const t=new BroadcastChannel(ni);t.postMessage(r),t.close()}catch{try{localStorage.setItem(`${is}:lastmsg`,JSON.stringify({msg:r,ts:Date.now()}));try{const t=new StorageEvent("storage",{key:`${is}:lastmsg`,newValue:localStorage.getItem(`${is}:lastmsg`)});window.dispatchEvent(t)}catch{try{window.dispatchEvent(new Event("storage"))}catch{}}try{window.dispatchEvent(new CustomEvent("ndn:match-sync",{detail:{msg:r}}))}catch{}}catch{}}}function sd(r){let t=null;try{t=new BroadcastChannel(ni),t.onmessage=n=>{try{r(n.data)}catch{}}}catch{const n=()=>{try{const s=localStorage.getItem(`${is}:lastmsg`);if(!s)return;const o=JSON.parse(s);r(o.msg)}catch{}},a=s=>{try{if(!s?.detail)return;r(s.detail.msg)}catch{}};return window.addEventListener("storage",n),window.addEventListener("ndn:match-sync",a),()=>{window.removeEventListener("storage",n),window.removeEventListener("ndn:match-sync",a)}}return()=>{try{t&&t.close()}catch{}}}function ri(r){return r.dartsThrown===0?0:(r.totalScoreStart-r.totalScoreRemaining)/r.dartsThrown*3}function ad(r){const t=ri(r),n=r.finished;return{avg:t,isCompleted:n,darts:r.dartsThrown,checkout:r.checkoutScore??0}}function od(r){if(r.legs.length===0)return;const t=[];let n,a=r.bestCheckout??0;for(const s of r.legs){if(!s.finished)continue;const o=ad(s);t.push(o.avg),(!n||o.darts<n.darts||o.darts===n.darts&&(s.endTime??0)<n.timestamp)&&(n={darts:o.darts,timestamp:s.endTime??Date.now()}),o.checkout>a&&(a=o.checkout)}t.length&&(r.bestThreeDartAvg=Math.max(...t),r.worstThreeDartAvg=Math.min(...t)),n&&(r.bestNineDart=n),r.bestCheckout=a}const qe=Vn((r,t)=>({roomId:"",players:[],currentPlayerIdx:0,startingScore:501,inProgress:!1,newMatch:(n,a,s="")=>r(()=>{const o=n.map((c,i)=>({id:`${i}`,name:c,legsWon:0,legs:[]}));return console.debug("[useMatch] newMatch",n,a,s),{players:o,currentPlayerIdx:0,startingScore:a,inProgress:!0,roomId:s,bestLegThisMatch:void 0}}),addVisit:(n,a,s)=>r(o=>{if(console.debug("[useMatch] addVisit",{score:n,darts:a,inProgress:o.inProgress,currentPlayerIdx:o.currentPlayerIdx,players:o.players.length}),!o.inProgress)return o;const c=o.players[o.currentPlayerIdx];let i=c.legs[c.legs.length-1];(!i||i.finished)&&(i={visits:[],totalScoreStart:o.startingScore,totalScoreRemaining:o.startingScore,dartsThrown:0,finished:!1,checkoutScore:null,startTime:Date.now()},c.legs.push(i));const h=i.totalScoreRemaining,l=Math.max(0,h-n);i.visits.push({darts:a,score:n,preOpenDarts:s?.preOpenDarts,doubleWindowDarts:s?.doubleWindowDarts,finishedByDouble:s?.finishedByDouble,visitTotal:s?.visitTotal??n}),i.dartsThrown+=a,i.totalScoreRemaining=l;try{const u=n===0&&a>0&&l===h,m=l===0,d={};if(i.dartsThrown%3===0){const v=ri(i);Math.abs((c.currentThreeDartAvg??0)-v)>1e-4&&(c.currentThreeDartAvg=v),d.threeDartAvg=v}xr.getState().recordVisit("x01-match",a,n,{preOpenDarts:s?.preOpenDarts??0,preRemaining:h,postRemaining:l,...d,bust:u,finish:m})}catch{}try{Pn({type:"visit",score:n,darts:a,playerIdx:o.currentPlayerIdx,ts:Date.now()})}catch{}return{...o}}),undoVisit:()=>r(n=>{const a=n.players[n.currentPlayerIdx],s=a.legs[a.legs.length-1];if(!s||s.finished||s.visits.length===0)return n;const o=s.visits.pop();return s.dartsThrown-=o.darts,s.totalScoreRemaining+=o.score,{...n}}),endLeg:n=>r(a=>{const s=a.players[a.currentPlayerIdx],o=s.legs[s.legs.length-1];if(!o||o.finished)return a;if(o.finished=!0,o.checkoutScore=n,o.endTime=Date.now(),o.totalScoreRemaining===0){s.legsWon+=1;const c=a.bestLegThisMatch;(!c||o.dartsThrown<c.darts)&&(a.bestLegThisMatch={playerId:s.id,darts:o.dartsThrown,timestamp:o.endTime})}try{Pn({type:"endLeg",checkoutScore:n,playerIdx:a.currentPlayerIdx,ts:Date.now()})}catch{}return{...a}}),nextPlayer:()=>r(n=>{const a=(n.currentPlayerIdx+1)%n.players.length;try{Pn({type:"nextPlayer",currentPlayerIdx:a,ts:Date.now()})}catch{}return{...n,currentPlayerIdx:a}}),endGame:()=>r(n=>{for(const a of n.players)od(a);try{Pn({type:"endGame",ts:Date.now()})}catch{}return{...n,inProgress:!1}}),importState:n=>r(()=>({...n})),setPlayerCurrentAverage:(n,a)=>r(s=>{const o=s.players[n];return o&&Math.abs((o.currentThreeDartAvg??0)-a)>1e-4?(o.currentThreeDartAvg=a,{...s}):s})})),si=f.createContext(null);function id({children:r}){const[t,n]=f.useState(!1),[a,s]=f.useState("connecting"),o=f.useRef(null),c=f.useRef(new Set),i=f.useRef(!0),h=f.useRef(0),l=f.useRef(null),u=f.useRef(null),m=f.useRef(null),d=f.useRef(0),v=()=>{if(m.current)return m.current;const M="ws://localhost:8787";if(M.length>0){const W=M.endsWith("/ws")?M:M.replace(/\/$/,"")+"/ws";return m.current=[W],m.current}const T=window.location.protocol==="https:"?"wss":"ws",p=window.location.hostname,z=[`${T}://${window.location.host}`+"/ws",`${T}://${p}/ws`,`${T}://${p}:8787/ws`,`${T}://${p}:3000/ws`];return m.current=Array.from(new Set(z)),m.current},x=()=>{const M=v();return d.current=(d.current+1)%M.length,M[d.current]},y=()=>{const M=v();return M[d.current]||M[0]},w=f.useCallback(()=>{if(o.current&&(o.current.readyState===WebSocket.OPEN||o.current.readyState===WebSocket.CONNECTING))return;s("connecting");const T=`${y()}`,p=new WebSocket(T);o.current=p,p.onopen=()=>{n(!0),s("connected"),h.current=0,u.current&&clearInterval(u.current),u.current=setInterval(()=>{try{o.current?.readyState===WebSocket.OPEN&&o.current?.send(JSON.stringify({type:"ping",t:Date.now()}))}catch{}},2e4)},p.onmessage=k=>{try{const z=JSON.parse(k.data);c.current.forEach(W=>{try{W(z)}catch{}})}catch{}},p.onerror=()=>{},p.onclose=()=>{if(n(!1),s("disconnected"),u.current&&(clearInterval(u.current),u.current=null),!i.current)return;const k=(h.current||0)+1;h.current=k,k%2===0&&x();const z=1e3*Math.pow(2,k-1),W=Math.floor(Math.random()*1e3);let ee=Math.min(3e4,z+W);k===1&&(ee=0),l.current&&clearTimeout(l.current),ee===0?w():l.current=setTimeout(w,ee)}},[]),C=f.useCallback(()=>{try{i.current=!1,l.current&&(clearTimeout(l.current),l.current=null),u.current&&(clearInterval(u.current),u.current=null);try{o.current?.close()}catch{}o.current=null}catch{}h.current=0,i.current=!0,s("connecting"),n(!1),w()},[w]);f.useEffect(()=>{i.current=!0,w();const M=()=>{i.current=!1;try{o.current?.close()}catch{}};window.addEventListener("beforeunload",M);const T=()=>{document.visibilityState==="visible"&&(t||w())};return document.addEventListener("visibilitychange",T),window.addEventListener("online",w),()=>{i.current=!1,l.current&&clearTimeout(l.current),u.current&&clearInterval(u.current);try{o.current?.close()}catch{}document.removeEventListener("visibilitychange",T),window.removeEventListener("online",w),window.removeEventListener("beforeunload",M)}},[w]);const N=f.useCallback(M=>{try{o.current&&o.current.readyState===WebSocket.OPEN&&o.current.send(typeof M=="string"?M:JSON.stringify(M))}catch{}},[]),P=f.useCallback(M=>(c.current.add(M),()=>{c.current.delete(M)}),[]),S=f.useMemo(()=>({connected:t,status:a,send:N,addListener:P,reconnect:C}),[t,a,N,P,C]);return e.jsx(si.Provider,{value:S,children:r})}function vr(){const r=f.useContext(si);if(!r)throw new Error("useWS must be used within WSProvider");return r}const aa=["D20","D6","D3","D11"],es=aa.length;function cd(){const r=f.useRef(null),t=f.useRef(null),n=f.useRef(null),a=f.useRef(null),[s,o]=f.useState("unknown"),[c,i]=f.useState([]),[h,l]=f.useState(null),[u,m]=f.useState(!1),[d,v]=f.useState(!1),[x,y]=f.useState("camera"),[w,C]=f.useState(()=>localStorage.getItem("ndn:cal:mode")||"local"),[N,P]=f.useState([]),[S,M]=f.useState(!1),[T,p]=f.useState(null),[k,z]=f.useState(1),[W,ee]=f.useState(()=>{if(typeof window>"u")return!1;try{return window.localStorage.getItem("ndn:cal:forceDesktop")==="1"}catch{return!1}}),[Q,K]=f.useState(()=>typeof navigator>"u"?!1:/Android|iPhone|iPad|iPod|Mobi/i.test(navigator.userAgent)),{H:le,setCalibration:ie,reset:L,errorPx:Y,locked:$,overlaySize:B,imageSize:H}=pn(),fe=6,Ye=!!le&&!!H&&($||typeof Y=="number"&&Y<=fe),Ce=gr(),{calibrationGuide:Ve,setCalibrationGuide:Le,preferredCameraId:Nt,cameraEnabled:St,setCameraEnabled:zt,preferredCameraLocked:He,setPreferredCameraLocked:Ie,setPreferredCamera:Mt,preserveCalibrationOverlay:Pt,allowAutocommitInOnline:Qt,setAllowAutocommitInOnline:Wt}=on(),[Ue,st]=f.useState(null),[at,ze]=f.useState(!1),[ut,Pe]=f.useState(0),[Ge,Me]=f.useState(!1),[ln,Ze]=f.useState(null),[xe,ne]=f.useState(!0),[ke,je]=f.useState(null),[_e,Ee]=f.useState(!1),[be,Xe]=f.useState(!1),[de,xn]=f.useState(!1),[qt,_t]=f.useState(null),[Ft,Ht]=f.useState(null),[Nn,en]=f.useState(!1),Tt=f.useRef(null),ot=f.useRef(!1),mt=f.useRef(null),vt=f.useRef(0),Gt=300,[bn,b]=f.useState([]);f.useCallback((j,R=480)=>{if(typeof document>"u")throw new Error("Marker rendering only available in browser context");const _=Gl(j),O=document.createElement("canvas");O.width=R,O.height=R;const D=O.getContext("2d");if(!D)return"";D.fillStyle="#ffffff",D.fillRect(0,0,R,R);const oe=_.length,G=_[0]?.length||oe,X=R/G,J=R/oe;for(let ve=0;ve<oe;ve++)for(let me=0;me<G;me++)_[ve][me]&&(D.fillStyle="#000000",D.fillRect(Math.round(me*X),Math.round(ve*J),Math.ceil(X),Math.ceil(J)));return O.toDataURL("image/png")},[]);const[F,re]=f.useState(null),Se=f.useRef(null),[Ne,yt]=f.useState(null),Te=f.useRef(null),tn=f.useRef([]),[nn,Jt]=f.useState(null),[ht,Ut]=f.useState(Date.now()),[Bt,dn]=f.useState(!1);function I(j){try{re(j),Se.current=j}catch{}}const[ce,Re]=f.useState(null),[wt,$t]=f.useState(null),[wr,Sn]=f.useState(!0),[gn,An]=f.useState([]),[hs,$r]=f.useState(!1),[jr,Nr]=f.useState(null),un=f.useRef(null);f.useEffect(()=>{let j=null;if(_e&&u&&r.current&&n.current)try{const R=r.current,_=new Xo({requireStableN:2,thresh:18,minArea:40}),O=R.videoWidth||r.current.clientWidth||640,D=R.videoHeight||r.current.clientHeight||480;if(_.reset(O,D),Ue){const oe=Math.max(Ue.doubleOuter*1.1,Ue.trebleOuter*1.1);_.setROI(Ue.cx,Ue.cy,Math.round(oe))}Tt.current=_,j=window.setInterval(()=>{try{const oe=document.createElement("canvas");oe.width=O,oe.height=D;const G=oe.getContext("2d");if(!G)return;G.drawImage(R,0,0,O,D);const X=G.getImageData(0,0,O,D);_.updateBackground(X);const J=_.detect(X),ve=n.current,me=ve.getContext("2d");if(!me)return;if(me.clearRect(0,0,ve.width,ve.height),J){try{if(le&&H){const ye={x:J.tip.x,y:J.tip.y},pe=n.current&&n.current.width||H.w||1,we=n.current&&n.current.height||H.h||1,Fe={x:ye.x/(pe/H.w),y:ye.y/(we/H.h)},At=$n(le,Fe),Ct=Rr(At),Oe=Ct.base,it=`${Ct.ring} ${Oe}`.trim(),yn=6,Rt=3,ge=3,rt=!!le&&!!H&&($||typeof Y=="number"&&Y<=yn),ft=J.tip.x>=-Rt&&J.tip.x<=pe+Rt&&J.tip.y>=-Rt&&J.tip.y<=we+Rt,kt=Fe.x>=-ge&&Fe.x<=H.w+ge&&Fe.y>=-ge&&Fe.y<=H.h+ge;let pt=!1;try{const We=$n(le,Fe);pt=Math.hypot(We.x,We.y)<=Z.doubleOuter+3}catch{}if(!rt||!ft||!kt||!pt)console.debug("Calibrator: ignoring ghost preview detection",rt,ft,kt);else{_t(Oe),Ht(it);try{if(be&&de&&qe.getState().inProgress&&qe.getState().roomId===""){const We=`${Oe}|3`,ct=performance.now();if(!ot.current&&!(We===mt.current&&ct-vt.current<Gt)){mt.current=We,vt.current=ct,ot.current=!0;try{qe.getState().addVisit(Oe,3,{visitTotal:Oe})}catch{}try{window.setTimeout(()=>{ot.current=!1},Math.max(120,Gt))}catch{}}}}catch{}try{const We=qe.getState().roomId!=="";if(be&&de&&qe.getState().inProgress&&We&&Qt){const ct=$n(le,Fe);vr().send({type:"auto-visit",roomId:qe.getState().roomId,value:Oe,darts:3,ring:Ct.ring,sector:Ct.sector,pBoard:ct,calibrationValid:!0})}}catch{}}}}catch{}me.fillStyle="rgba(0,255,0,0.9)",me.beginPath(),me.arc(J.tip.x,J.tip.y,6,0,Math.PI*2),me.fill(),me.strokeStyle="rgba(0,255,0,0.8)",me.lineWidth=2,J.axis&&(me.beginPath(),me.moveTo(J.axis.x1,J.axis.y1),me.lineTo(J.axis.x2,J.axis.y2),me.stroke())}}catch{}},300)}catch(R){console.warn("[Calibrator] failed to start dart preview",R)}return()=>{j&&clearInterval(j),Tt.current=null}},[_e,u,Ue]),f.useEffect(()=>{const j=window.location.hostname;(j==="localhost"||j==="127.0.0.1")&&Gn("/api/hosts").then(R=>R.json()).then(R=>{const _=Array.isArray(R?.hosts)&&R.hosts.find(O=>O);_&&Re(_)}).catch(()=>{}),Gn("/api/https-info").then(R=>R.json()).then(R=>{R&&typeof R.https=="boolean"&&$t({https:!!R.https,port:Number(R.port)||8788})}).catch(()=>{})},[]);const zn=f.useMemo(()=>{const j=F||"____",R="ws://localhost:8787";if(R.length>0)try{const G=new URL(R);return`${`${G.protocol==="wss:"?"https":"http"}://${G.host}${G.pathname.endsWith("/ws")?"":G.pathname}`.replace(/\/?ws$/i,"")}/mobile-cam.html?code=${j}`}catch{}const _=ce||window.location.hostname,O=!!wt?.https,D=O?wt?.port||8788:8787;return`${O?"https":"http"}://${_}:${D}/mobile-cam.html?code=${j}`},[F,ce,wt]),Vr=f.useMemo(()=>{if(!zn)return null;try{const j=new URL(zn);return j.searchParams.delete("code"),j.toString().replace(/\?$/,"")}catch{return typeof window<"u"?`${window.location.origin.replace(/\/$/,"")}/mobile-cam.html`:"/mobile-cam.html"}},[zn]);f.useEffect(()=>{localStorage.setItem("ndn:cal:mode",w)},[w]),f.useEffect(()=>{if(!(typeof window>"u"))try{W?window.localStorage.setItem("ndn:cal:forceDesktop","1"):window.localStorage.removeItem("ndn:cal:forceDesktop")}catch{}},[W]),f.useEffect(()=>{if(typeof window>"u")return;const j=window.matchMedia("(pointer: coarse)"),R=()=>{const _=typeof navigator<"u"&&/Android|iPhone|iPad|iPod|Mobi/i.test(navigator.userAgent),O=typeof j.matches=="boolean"?j.matches:!1,D=window.innerWidth<=820;K(_||O||D)};R();try{typeof j.addEventListener=="function"?j.addEventListener("change",R):typeof j.addListener=="function"&&j.addListener(R)}catch{}return window.addEventListener("resize",R),()=>{try{typeof j.removeEventListener=="function"?j.removeEventListener("change",R):typeof j.removeListener=="function"&&j.removeListener(R)}catch{}window.removeEventListener("resize",R)}},[]),f.useEffect(()=>{if(typeof navigator>"u"||!navigator.permissions){o("unsupported");return}let j=!0;return(async()=>{try{const R=await navigator.permissions.query({name:"camera"});if(!j)return;o(R.state||"unknown"),R.onchange=()=>{j&&o(R.state)}}catch{j&&o("unknown")}})(),()=>{j=!1}},[]);async function mn(){if(!(typeof navigator>"u"||!navigator.mediaDevices||!navigator.mediaDevices.enumerateDevices))try{const R=(await navigator.mediaDevices.enumerateDevices()).filter(_=>_.kind==="videoinput").map(_=>({deviceId:_.deviceId,label:_.label||"Camera"}));i(R),R.length&&!h&&l(R[0].deviceId)}catch{}}f.useEffect(()=>((async()=>{try{await mn()}catch{}try{navigator?.mediaDevices?.addEventListener?navigator.mediaDevices.addEventListener("devicechange",mn):navigator.mediaDevices.ondevicechange=mn}catch{}})(),()=>{try{navigator?.mediaDevices?.removeEventListener&&navigator.mediaDevices.removeEventListener("devicechange",mn)}catch{}}),[]);async function Rn(j){if(typeof navigator>"u"||!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia){alert("getUserMedia is not available in this browser");return}const R={video:j?{deviceId:{exact:j}}:{facingMode:"environment"}};let _=null;try{_=await navigator.mediaDevices.getUserMedia(R),_.getTracks().forEach(O=>O.stop()),o("granted");try{j&&typeof Mt=="function"&&Mt(j)}catch{}alert("Camera access granted — your webcam is available and set as preferred.")}catch(O){console.error("[Calibrator] testCamera failed",O),O&&(O.name==="NotAllowedError"||O.name==="PermissionDeniedError")?(o("denied"),alert("Camera permission denied. Please allow camera access in your browser settings and try again.")):O&&(O.name==="NotFoundError"||O.name==="DevicesNotFoundError")?alert("No camera devices found. Ensure your USB webcam is connected and not in use by another app."):alert("Unable to access the camera: "+(O?.message||O))}finally{_&&_.getTracks().forEach(O=>O.stop())}}f.useEffect(()=>{if(!nn)return;const j=setInterval(()=>Ut(Date.now()),1e3);return()=>clearInterval(j)},[nn]);const Sr=f.useMemo(()=>nn?Math.max(0,Math.ceil((nn-ht)/1e3)):null,[nn,ht]);f.useEffect(()=>()=>{un.current&&window.clearTimeout(un.current)},[]);const Yn=f.useCallback(async(j,R)=>{if(j)try{if(navigator.clipboard&&navigator.clipboard.writeText)await navigator.clipboard.writeText(j);else{const _=document.createElement("textarea");_.value=j,_.style.position="fixed",_.style.opacity="0",document.body.appendChild(_),_.focus(),_.select(),document.execCommand("copy"),document.body.removeChild(_)}Nr(R),un.current&&window.clearTimeout(un.current),un.current=window.setTimeout(()=>Nr(null),1500)}catch(_){console.warn("[Calibrator] Copy failed:",_),Nr(null)}},[]);f.useEffect(()=>()=>{},[]),f.useEffect(()=>{const j=R=>{console.log("[Calibrator] Received reconnect request from PhoneCameraOverlay"),w==="phone"&&Bt&&(hn(!1),setTimeout(()=>{Xn()},500))};return window.addEventListener("ndn:phone-camera-reconnect",j),()=>{window.removeEventListener("ndn:phone-camera-reconnect",j)}},[w,Bt]),f.useEffect(()=>{console.log("[Calibrator] 🔄 STREAMING CHANGED:",{streaming:u,videoRefAvailable:!!r.current}),r.current?(console.log("[Calibrator] ✅ Syncing videoElementRef on streaming change"),Ce.setVideoElementRef(r.current),r.current.srcObject instanceof MediaStream&&(console.log("[Calibrator] ✅ Setting mediaStream from video element"),Ce.setMediaStream(r.current.srcObject))):console.warn("[Calibrator] ⚠️ videoRef.current is null on streaming change!")},[u]),f.useEffect(()=>(console.log("[Calibrator] 🚀 MOUNT: Initial mount - syncing videoRef"),console.log("[Calibrator] videoRef.current available:",!!r.current),console.log("[Calibrator] videoRef.current type:",r.current?.constructor?.name),r.current?(console.log("[Calibrator] ✅ Setting videoElementRef on mount"),console.log("[Calibrator] Video element:",{tagName:r.current.tagName,srcObject:!!r.current.srcObject,videoWidth:r.current.videoWidth,videoHeight:r.current.videoHeight}),Ce.setVideoElementRef(r.current),console.log("[Calibrator] ✅ videoElementRef set successfully")):console.error("[Calibrator] ❌ CRITICAL: videoRef.current is NULL at mount!"),()=>{}),[]);function zr(){if(Ne&&(Ne.readyState===WebSocket.OPEN||Ne.readyState===WebSocket.CONNECTING))return console.log("[Calibrator] ensureWS: Reusing existing WebSocket (state:",Ne.readyState,")"),Ne;const j="ws://localhost:8787",R=j.length>0?j.endsWith("/ws")?j:j.replace(/\/$/,"")+"/ws":void 0,O=`${window.location.protocol==="https:"?"wss":"ws"}://${window.location.host}/ws`,D=window.location.hostname,G=R||(D.endsWith("onrender.com")?O:"wss://ninedartnation.onrender.com/ws");console.log("[Calibrator] ensureWS: Creating new WebSocket to:",G);const X=new WebSocket(G);return X.onerror=J=>{console.error("[Calibrator] WebSocket connection error:",J),alert("Failed to connect to camera pairing service. Please check your internet connection and try again.")},X.onclose=J=>{if(console.log("[Calibrator] WebSocket closed:",J.code,J.reason),Te.current){try{Te.current.close()}catch{}Te.current=null}I(null),Jt(null),dn(!1),J.code!==1e3&&(alert("Camera pairing connection lost. Please try pairing again."),w==="phone"&&C("local"))},yt(X),X}async function Xn(){C("phone"),hn(!1),Zn();try{zt(!0)}catch{}const j=zr();j.readyState===WebSocket.OPEN?(console.log("[Calibrator] WebSocket open, sending cam-create"),j.send(JSON.stringify({type:"cam-create"}))):(console.log("[Calibrator] WebSocket connecting, will send cam-create on open"),j.onopen=()=>{console.log("[Calibrator] WebSocket now open, sending cam-create"),j.send(JSON.stringify({type:"cam-create"}))}),j.onmessage=async R=>{const _=JSON.parse(R.data);if(_.type==="cam-code")I(_.code),_.expiresAt&&Jt(_.expiresAt);else if(_.type==="cam-peer-joined"){!Se.current&&_.code&&I(_.code),dn(!0);const O=Se.current||_.code||null;O&&(Se.current=O);try{if($&&O){const oe=t.current?{w:t.current.width,h:t.current.height}:null,G={H:le,imageSize:oe,errorPx:Y??null,createdAt:Date.now()};j.send(JSON.stringify({type:"cam-calibration",code:O,payload:G})),console.log("[Calibrator] Sent calibration to joined phone for code",O)}}catch(oe){console.warn("[Calibrator] Failed to send calibration on peer join",oe)}const D=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}],iceCandidatePoolSize:10});Te.current=D,D.onconnectionstatechange=()=>{console.log("WebRTC connection state:",D.connectionState),D.connectionState==="failed"||D.connectionState==="disconnected"?(console.error("WebRTC connection failed"),alert("Camera connection lost. Please try pairing again."),hn(!1)):D.connectionState==="connected"&&console.log("WebRTC connection established")},D.onicecandidate=oe=>{oe.candidate&&O&&j.send(JSON.stringify({type:"cam-ice",code:O,payload:oe.candidate}))},D.ontrack=oe=>{if(console.log("[Calibrator] WebRTC ontrack received:",oe.streams?.length,"streams, track kind:",oe.track?.kind),r.current){const G=oe.streams?.[0];G?(console.log("[Calibrator] Assigning video stream (tracks:",G.getTracks().length,") to video element"),M(!1),setTimeout(()=>{r.current&&(console.log("[Calibrator] Setting srcObject and attempting play"),r.current.srcObject&&r.current.srcObject.getTracks().forEach(J=>J.stop()),r.current.srcObject=G,r.current.muted=!0,r.current.playsInline=!0,r.current.play().then(()=>{console.log("[Calibrator] Video playback started successfully"),m(!0),y("capture"),Ce.setStreaming(!0),Ce.setMode("phone"),Ce.setMediaStream(G);try{Mt(void 0,"Phone Camera",!0)}catch{}if(!He)try{Ie(!0)}catch{}try{zt(!0)}catch{}v(!1)}).catch(X=>{console.error("[Calibrator] Video play failed:",X),v(!0),console.warn("[Calibrator] video play blocked — prompting user interaction")}))},100)):console.error("[Calibrator] No inbound stream received in ontrack")}else console.error("[Calibrator] Video element not available")};try{const oe=await D.createOffer({offerToReceiveAudio:!1,offerToReceiveVideo:!0});await D.setLocalDescription(oe),console.log("[Calibrator] Sending cam-offer for code:",O),O?j.send(JSON.stringify({type:"cam-offer",code:O,payload:oe})):console.warn("[Calibrator] Missing pairing code when sending offer")}catch(oe){console.error("Failed to create WebRTC offer:",oe),alert("Failed to establish camera connection. Please try again."),hn(!1)}}else if(_.type==="cam-answer"){console.log("[Calibrator] Received cam-answer");const O=Te.current;if(O)try{await O.setRemoteDescription(new RTCSessionDescription(_.payload)),console.log("[Calibrator] Remote description set (answer)");const D=tn.current;console.log(`[Calibrator] Processing ${D.length} pending ICE candidates`);for(const oe of D)try{await O.addIceCandidate(oe),console.log("[Calibrator] Queued ICE candidate added")}catch(G){console.error("Failed to add queued ICE candidate:",G)}tn.current=[]}catch(D){console.error("Failed to set remote description:",D),alert("Camera pairing failed. Please try again."),hn(!1)}else console.warn("[Calibrator] Received cam-answer but no peer connection exists")}else if(_.type==="cam-ice"){console.log("[Calibrator] Received cam-ice");const O=Te.current;if(O)if(O.remoteDescription)try{await O.addIceCandidate(_.payload),console.log("[Calibrator] ICE candidate added")}catch(D){console.error("Failed to add ICE candidate:",D)}else console.log("[Calibrator] Remote description not set yet, queuing ICE candidate"),tn.current.push(_.payload);else console.warn("[Calibrator] Received ICE candidate but no peer connection exists")}else if(_.type==="cam-error")console.error("Camera pairing error:",_.code),alert(_.code==="EXPIRED"?"Code expired. Generate a new code.":`Camera error: ${_.code||"Unknown error"}`),hn(!1);else if(_.type==="cam-calibration"){console.log("[Calibrator] Received calibration from peer:",_.payload);try{if(_.payload){let O=Array.isArray(_.payload.H)?_.payload.H:null;if(!O&&Array.isArray(_.payload.calibrationPoints)&&_.payload.calibrationPoints.length>=4)try{const D=[{x:0,y:-Z.doubleOuter},{x:Z.doubleOuter,y:0},{x:0,y:Z.doubleOuter},{x:-Z.doubleOuter,y:0}];O=mr(D,_.payload.calibrationPoints.slice(0,4))}catch(D){console.warn("[Calibrator] Failed to compute homography from received calibration points",D)}if(O){const D=n?.current?{w:n.current.width,h:n.current.height}:r?.current?{w:r.current.clientWidth,h:r.current.clientHeight}:_.payload.imageSize??null;ie({H:O,createdAt:_.payload.createdAt||Date.now(),errorPx:_.payload.errorPx,imageSize:_.payload.imageSize,overlaySize:D,locked:!0}),console.log("[Calibrator] Applied received calibration")}}}catch(O){console.error("[Calibrator] Failed to apply received calibration",O)}}}}async function Kn(){$r(!0);try{const j=await Kl();An(j),j.length===0&&alert("No wifi scoring devices found on your network. Make sure devices are powered on and connected to the same network.")}catch(j){console.error("Wifi device discovery failed:",j),alert("Failed to discover wifi devices. Please check your network connection.")}finally{$r(!1)}y("camera")}async function fs(j){try{An(_=>_.map(O=>O.id===j.id?{...O,status:"connecting"}:O));const R=await rd(j);if(R&&r.current)r.current.srcObject&&r.current.srcObject.getTracks().forEach(O=>O.stop()),r.current.srcObject=R,await r.current.play(),m(!0),y("capture"),An(_=>_.map(O=>O.id===j.id?{...O,status:"online"}:O));else throw new Error("Failed to get video stream")}catch(R){console.error("Failed to connect to wifi device:",R),alert(`Failed to connect to ${j.name}. Please check the device and try again.`),An(_=>_.map(O=>O.id===j.id?{...O,status:"offline"}:O))}}async function vn(){if(w==="phone")return Xn();if(w==="wifi")return Kn();console.log("[Calibrator] 🎬 START_CAMERA: mode=",w,"preferredCameraId=",Nt);try{let j=null;if(Nt)try{console.log("[Calibrator] 📹 Attempt 1: Using preferred camera ID:",Nt),j=await navigator.mediaDevices.getUserMedia({video:{deviceId:{exact:Nt}},audio:!1}),console.log("[Calibrator] ✅ SUCCESS with preferred camera:",j.getTracks().length,"tracks")}catch(R){console.warn("[Calibrator] ⚠️ Preferred camera failed:",R?.name,R?.message)}if(!j)try{console.log("[Calibrator] 📹 Attempt 2: Using ANY available camera"),j=await navigator.mediaDevices.getUserMedia({video:!0,audio:!1}),console.log("[Calibrator] ✅ SUCCESS with fallback camera:",j.getTracks().length,"tracks")}catch(R){throw console.error("[Calibrator] ❌ BOTH attempts failed:",R?.name,R?.message),R}if(!j)throw new Error("No stream obtained");if(!r.current)throw new Error("Video element ref is null");console.log("[Calibrator] 📺 Assigning stream to video element"),r.current.srcObject=j,console.log("[Calibrator] ▶️ Calling play()");try{await r.current.play(),console.log("[Calibrator] ✅ Play succeeded")}catch(R){console.warn("[Calibrator] ⚠️ Play failed, retrying in 100ms:",R?.message),await new Promise(_=>setTimeout(_,100)),await r.current.play(),console.log("[Calibrator] ✅ Play succeeded on retry")}console.log("[Calibrator] 🟢 Setting streaming = true"),m(!0),y("capture"),console.log("[Calibrator] 🟢 State updated")}catch(j){console.error("[Calibrator] 🔴 FATAL:",j?.message||j),alert(`Camera failed: ${j?.message||"Unknown error"}`),r.current?.srcObject&&(r.current.srcObject.getTracks().forEach(R=>R.stop()),r.current.srcObject=null)}}function hn(j=!1){if(r.current&&r.current.srcObject&&(r.current.srcObject.getTracks().forEach(_=>_.stop()),r.current.srcObject=null,m(!1)),Te.current){try{Te.current.close()}catch{}Te.current=null}tn.current=[],I(null),Jt(null),dn(!1),je(null),Ce.setStreaming(!1),Ce.setMediaStream(null),j&&(w==="phone"||w==="wifi")&&C("local")}function Cr(){Ne&&Ne.readyState===WebSocket.OPEN?Ne.send(JSON.stringify({type:"cam-create"})):Xn(),Zn()}function Zn(){try{He||Ie(!0)}catch{}}function ps(){try{a.current?.click()}catch{}}function Qn(){if(!r.current||!t.current)return;const j=r.current,R=t.current;R.width=j.videoWidth,R.height=j.videoHeight,R.getContext("2d").drawImage(j,0,0,R.width,R.height),M(!0),p({w:R.width,h:R.height}),y("select"),P([]),je(null),at&&setTimeout(()=>{Kt()},0)}function Cn(j=N,R=null){if(!t.current||!n.current)return;const _=t.current,O=n.current;O.width=_.width,O.height=_.height;const D=O.getContext("2d");D.clearRect(0,0,O.width,O.height);const oe=R||le;if(oe){const X=[Z.bullInner,Z.bullOuter,Z.trebleInner,Z.trebleOuter,Z.doubleInner,Z.doubleOuter];for(const J of X){if(!Number.isFinite(J))continue;const ve=$?"#10b981":J===Z.doubleOuter?"#22d3ee":"#a78bfa",me=$||J===Z.doubleOuter?3:2;try{const ye=Fl(oe,J,360);if(!ye.length||ye.some(pe=>!Number.isFinite(pe.x)||!Number.isFinite(pe.y)))continue;Ul(D,ye,ve,me)}catch(ye){console.warn("[Calibrator] Skipped invalid ring overlay",{radius:J,err:ye})}}}if(!oe&&Ue){const X=(J,ve,me=2)=>{!Number.isFinite(J)||J<=0||(D.save(),D.strokeStyle=ve,D.lineWidth=me,D.beginPath(),D.arc(Ue.cx,Ue.cy,J,0,Math.PI*2),D.stroke(),D.restore())};X(Ue.doubleOuter,"#22d3ee",3),X(Ue.doubleInner,"#22d3ee",2),X(Ue.trebleOuter,"#fde047",2),X(Ue.trebleInner,"#fde047",2),X(Ue.bullOuter,"#34d399",2),X(Ue.bullInner,"#10b981",3)}const G=Or();if(j.length<G.length&&oe){D.save(),D.strokeStyle="rgba(255,193,7,0.4)",D.lineWidth=2,D.setLineDash([4,4]);for(let X=j.length;X<G.length;X++)try{const J=ir(oe,G[X]);D.beginPath(),D.arc(J.x,J.y,12,0,Math.PI*2),D.stroke(),D.save(),D.fillStyle="rgba(255,255,255,0.65)",D.font="12px sans-serif",D.fillText(aa[X]??String(X+1),J.x+10,J.y-10),D.restore()}catch{}D.restore()}if(j.forEach((X,J)=>{Xa(D,X,"#f472b6"),D.save(),D.fillStyle="#f472b6",D.font="14px sans-serif",D.fillText(aa[J]??String(J+1),X.x+6,X.y-6),D.restore()}),Ve&&!$){D.save(),D.fillStyle="rgba(59,130,246,0.10)";const X=Math.round(Math.min(O.width,O.height)*.08),J=O.width-X*2,ve=O.height-X*2;D.fillRect(X,X,J,ve),D.strokeStyle="rgba(34,197,94,0.9)",D.lineWidth=2,D.beginPath(),D.moveTo(X,O.height/2),D.lineTo(O.width-X,O.height/2),D.stroke(),D.beginPath(),D.moveTo(O.width/2,X),D.lineTo(O.width/2,O.height-X),D.stroke(),D.strokeStyle="rgba(234,179,8,0.9)",D.setLineDash([6,4]);const me=X+30,ye=X+30;D.beginPath(),D.moveTo(me,ye+30),D.lineTo(me+60,ye),D.stroke(),D.beginPath(),D.moveTo(O.width-me,ye+30),D.lineTo(O.width-me-60,ye),D.stroke(),D.restore(),D.save(),D.scale(1/k,1/k),D.fillStyle="rgba(255,255,255,0.85)",D.font="12px sans-serif",D.fillText("Tip: Frame board centered, edges parallel; slight top-down is okay. Keep bull near center.",X*k,(X+18)*k),D.restore()}}function Yt(j){if(console.debug("[Calibrator] onClickOverlay entry",x,j.type),x!=="select"&&x!=="computed"&&!((x==="camera"||x==="capture")&&be))return;const _=j.target,O=_.getBoundingClientRect(),D=j.clientX-O.left,oe=j.clientY-O.top,G=_.width>0?_.width/(O.width||t.current?.clientWidth||O.width):1,X=_.height>0?_.height/(O.height||t.current?.clientHeight||O.height):1,J=D*G,ve=oe*X;if(console.debug("[Calibrator] onClickOverlay css/x/y",{cssX:D,cssY:oe,scaleX:G,scaleY:X,x:J,y:ve}),x==="select"){const me=[...N,{x:J,y:ve}];me.length<=es&&(P(me),Cn(me));return}try{const me=pn.getState?pn.getState():void 0,ye=me?.H??le,pe=me?.imageSize??H;if(console.debug("[Calibrator] onClickOverlay state",{Hcur:ye,imgSize:pe}),!ye||!n.current||!pe)return;const we=n.current,Fe=we.getBoundingClientRect(),At=t.current&&t.current.width?t.current.width:Fe.width,Ct=t.current&&t.current.height?t.current.height:Fe.height,Oe=we.width&&pe.w?we.width/pe.w:At/pe.w,it=we.height&&pe.h?we.height/pe.h:Ct/pe.h;console.debug("[Calibrator] onClickOverlay dims",{oWidth:we.width,oHeight:we.height,rectWidth:Fe.width,rectHeight:Fe.height,fallbackWidth:At,fallbackHeight:Ct,sx:Oe,sy:it});const yn=Fe.width||At,Rt=Fe.height||Ct,ge=yn?D/yn:0,rt=Rt?oe/Rt:0,ft={x:ge*pe.w,y:rt*pe.h},kt=$n(ye,ft);console.debug("[Calibrator] onClickOverlay pCal/pBoard",ft,kt);const pt=Rr(kt);let We=pt.base;console.debug("[Calibrator] autoCommitTestMode",be),be&&We===0&&(We=25);const ct=`${pt.ring} ${We}`.trim();_t(We),console.debug("[Calibrator] onClickOverlay detected",We,ct),Ht(ct);try{const lt=pn.getState?pn.getState():void 0,rn=!!lt?.H&&!!lt?.imageSize&&(lt.locked||typeof lt.errorPx=="number"&&lt.errorPx<=fe);be&&!de&&rn&&qe.getState().inProgress&&Qe(We)}catch{}if(be&&de&&qe.getState().inProgress){const lt=pn.getState?pn.getState():void 0,rn=!!lt?.H&&!!lt?.imageSize&&(lt.locked||typeof lt.errorPx=="number"&&lt.errorPx<=fe);if(!rn)console.debug("[Calibrator] immediate autocommit skipped due to invalid calibration",{calibrationValidSt2:rn});else{const Dn=qe.getState().roomId!=="";if(console.debug("[Calibrator] immediate-branch conditions",{autoCommitTestMode:be,autoCommitImmediate:de,inProgress:qe.getState().inProgress,isOnline:Dn}),Dn){if(Qt)try{const fn=$n(le,ft);console.debug("[Calibrator] sending auto-visit",{roomId:qe.getState().roomId,allowAutocommitInOnline:Qt}),vr().send({type:"auto-visit",roomId:qe.getState().roomId,value:We,darts:3,ring:pt.ring,sector:pt.sector,pBoard:fn,calibrationValid:!0})}catch{}}else{const fn=`${We}|3`,Ln=performance.now();if(!ot.current&&!(fn===mt.current&&Ln-vt.current<Gt)){mt.current=fn,vt.current=Ln,ot.current=!0,qe.getState().addVisit(We,3,{visitTotal:We});try{window.setTimeout(()=>{ot.current=!1},Math.max(120,Gt))}catch{}}}}}}catch{}}function Qe(j){try{const R=typeof j=="number"?j:qt;console.debug("[Calibrator] doCommit invoked",{v:R,inProgress:qe.getState().inProgress});const _=pn.getState?pn.getState():void 0,O=!!_?.H&&!!_?.imageSize&&(_.locked||typeof _.errorPx=="number"&&_.errorPx<=fe);if(R!=null&&qe.getState().inProgress&&O){const D=`${R}|3`,oe=performance.now();if(!ot.current&&!(D===mt.current&&oe-vt.current<Gt)){mt.current=D,vt.current=oe,ot.current=!0,console.debug("[Calibrator] doCommit: committing visit",R,{calState:_,curCalValid:O});try{qe.getState().addVisit(R,3,{visitTotal:R})}catch{}try{window.setTimeout(()=>{ot.current=!1},Math.max(120,Gt))}catch{}}else console.debug("[Calibrator] doCommit: deduped commit skipped",{v:R,curCalValid:O,sig:D})}else console.debug("[Calibrator] doCommit: NOT committing (invalid cal or no match)",{v:R,inProgress:qe.getState().inProgress,curCalValid:O,calState:_})}catch{}}function xs(){if(!t.current)return;if(N.length<es)return alert("Please click all 4 calibration points on the double ring: D20, D6, D3, and D11.");const j=Or(),R=mr(j,N);Cn(N,R);const _=Ar(R,j,N),O=n?.current?{w:n.current.width,h:n.current.height}:r?.current?{w:r.current.clientWidth,h:r.current.clientHeight}:{w:t.current.width,h:t.current.height};ie({H:R,createdAt:Date.now(),errorPx:_,imageSize:{w:t.current.width,h:t.current.height},overlaySize:O,anchors:{src:j,dst:N}}),Pe(100),y("computed")}function Xt(){if(!le||!n.current)return alert("Please compute calibration first (lock) before running verification.");try{const j=[{label:"Bull (50)",p:{x:0,y:0}},{label:"Outer Bull (25)",p:{x:0,y:-Z.bullOuter}},{label:"Triple 20",p:{x:0,y:-((Z.trebleInner+Z.trebleOuter)/2)}},{label:"Single 5 (near 5 sector)",p:{x:(Z.trebleInner+Z.trebleOuter)/2*Math.cos(Math.PI*.1),y:(Z.trebleInner+Z.trebleOuter)/2*Math.sin(Math.PI*.1)}}],R=n.current.getContext("2d");Cn(N,le);const _=[];for(const O of j){const D=ir(le,{x:O.p.x,y:O.p.y}),oe=$n(le,D),G=Rr(oe),X=Rr(O.p),J=X.base===G.base&&X.mult===G.mult||X.base===G.base;_.push({label:O.label,expected:X,detected:G,match:J}),Xa(R,D,J?"#10b981":"#ef4444"),R.fillStyle=J?"#10b981":"#ef4444",R.font="12px sans-serif",R.fillText(O.label,D.x+6,D.y-6)}b(_)}catch(j){console.error("Verification failed",j),alert("Verification failed: "+j?.message)}}async function Kt(){if(!t.current)return alert("Load a photo or capture a frame first.");Me(!0),Ze(null),je(null);const j=t.current,R=800,_=Math.min(1,R/j.width),O=Math.max(1,Math.round(j.width*_)),D=Math.max(1,Math.round(j.height*_)),oe=document.createElement("canvas");oe.width=O,oe.height=D;const G=oe.getContext("2d");G.drawImage(j,0,0,O,D);const X=G.getImageData(0,0,O,D),J=new Float32Array(O*D);for(let A=0,V=0;A<X.data.length;A+=4,V++){const q=X.data[A],U=X.data[A+1],te=X.data[A+2];J[V]=.299*q+.587*U+.114*te}const ve=new Float32Array(O*D),me=new Float32Array(O*D);for(let A=1;A<D-1;A++)for(let V=1;V<O-1;V++){const q=A*O+V,U=J[q-O-1],te=J[q-O],ae=J[q-O+1],he=J[q-1],$e=J[q+1],ue=J[q+O-1],tt=J[q+O],En=J[q+O+1];ve[q]=-U-2*he-ue+(ae+2*$e+En),me[q]=-U-2*te-ae+(ue+2*tt+En)}const ye=new Float32Array(O*D);let pe=1;for(let A=0;A<ye.length;A++){const V=Math.hypot(ve[A],me[A]);ye[A]=V,V>pe&&(pe=V)}const we=Math.floor(O/2),Fe=Math.floor(D/2),At=Math.floor(Math.min(O,D)*.35),Ct=Math.floor(Math.min(O,D)*.52);let Oe={score:-1,cx:we,cy:Fe,r:Math.floor((At+Ct)/2)};const it=Math.max(2,Math.floor(Math.min(O,D)*.01)),yn=Math.max(2,Math.floor(Math.min(O,D)*.01));for(let A=Fe-Math.floor(D*.08);A<=Fe+Math.floor(D*.08);A+=it)for(let V=we-Math.floor(O*.08);V<=we+Math.floor(O*.08);V+=it)for(let q=At;q<=Ct;q+=yn){let U=0;const te=360;for(let ae=0;ae<te;ae++){const he=ae*Math.PI/180,$e=Math.round(V+q*Math.cos(he)),ue=Math.round(A+q*Math.sin(he));$e<=0||$e>=O-1||ue<=0||ue>=D-1||(U+=ye[ue*O+$e])}U>Oe.score&&(Oe={score:U,cx:V,cy:A,r:q})}const Rt=1/_,ge=Oe.cx*Rt,rt=Oe.cy*Rt,ft=Oe.r*Rt;function kt(A){let V=0;const q=A*_,U=360;for(let te=0;te<U;te++){const ae=te*Math.PI/180,he=Math.round(Oe.cx+q*Math.cos(ae)),$e=Math.round(Oe.cy+q*Math.sin(ae));he<=0||he>=O-1||$e<=0||$e>=D-1||(V+=ye[$e*O+he])}return V}const pt={bullInner:Z.bullInner/Z.doubleOuter,bullOuter:Z.bullOuter/Z.doubleOuter,trebleInner:Z.trebleInner/Z.doubleOuter,trebleOuter:Z.trebleOuter/Z.doubleOuter,doubleInner:Z.doubleInner/Z.doubleOuter};function We(A,V=.08){const q=Math.max(1,Math.floor(A*(1-V))),U=Math.max(q+1,Math.floor(A*(1+V)));let te=q,ae=-1;for(let he=q;he<=U;he++){const $e=kt(he);$e>ae&&(ae=$e,te=he)}return te}const ct=ft,lt=We(ct*pt.doubleInner),rn=We(ct*pt.trebleOuter),Dn=We(ct*pt.trebleInner),fn=We(ct*pt.bullOuter),Ln=We(ct*pt.bullInner);st({cx:ge,cy:rt,bullInner:Ln,bullOuter:fn,trebleInner:Dn,trebleOuter:rn,doubleInner:lt,doubleOuter:ct});const et=A=>{let q=0;for(let U=0;U<180;U++){const te=U*Math.PI/90,ae=Math.round(Oe.cx+A*_*Math.cos(te)),he=Math.round(Oe.cy+A*_*Math.sin(te));ae<=0||ae>=O-1||he<=0||he>=D-1||(q+=ye[he*O+ae])}return q/180},cr=(et(Oe.r)+et(rn)+et(Dn)+et(lt)+et(fn)+et(Ln))/(pe*6),qr=Math.max(0,Math.min(1,cr)),kr=Math.min(qr,Math.min(et(Oe.r)/pe,et(rn)/pe,et(Dn)/pe,et(lt)/pe,et(fn)/pe,et(Ln)/pe));Pe(xe?100:Math.round(kr*100));const Wn=[{x:ge,y:rt-ct},{x:ge+ct,y:rt},{x:ge,y:rt+ct},{x:ge-ct,y:rt}];P(Wn),Cn(Wn);try{const A=Or(),V=mr(A,Wn);Cn(Wn,V);const q=Ar(V,A,Wn),U=n?.current?{w:n.current.width,h:n.current.height}:r?.current?{w:r.current.clientWidth,h:r.current.clientHeight}:{w:t.current.width,h:t.current.height};ie({H:V,createdAt:Date.now(),errorPx:q,imageSize:{w:t.current.width,h:t.current.height},overlaySize:U,anchors:{src:A,dst:Wn}}),y("computed"),Me(!1)}catch(A){console.error("[Calibrator] Auto-detect compute failed:",A),Me(!1)}try{let V=1;for(let U=1;U<3;U++){const te=document.createElement("canvas");te.width=Math.max(1,Math.round(j.width*Math.min(1,R/j.width))),te.height=Math.max(1,Math.round(j.height*Math.min(1,R/j.width))),te.getContext("2d").drawImage(j,0,0,te.width,te.height);const he=ur(te);he&&he.success&&nt({cx:ge,cy:rt,doubleOuter:ft},{cx:he.cx,cy:he.cy,doubleOuter:he.doubleOuter})&&V++}const q=V>=Math.ceil(3*.66);q||console.warn("Auto-detect inconsistent across quick samples, skipping auto-lock"),q||Pe(0)}catch{}const nr=3;let Hr=1;for(let A=1;A<nr;A++)try{const V=document.createElement("canvas");V.width=Math.max(1,Math.round(j.width*Math.min(1,R/j.width))),V.height=Math.max(1,Math.round(j.height*Math.min(1,R/j.width))),V.getContext("2d").drawImage(j,0,0,V.width,V.height);const U=ur(V);nt({cx:ge,cy:rt,doubleOuter:ft},{cx:U.cx,cy:U.cy,doubleOuter:U.doubleOuter})&&Hr++}catch{}const Gr=Hr>=Math.ceil(nr*.66),g=(xe?!0:kr>=.95)&&Gr,E=n?.current?{w:n.current.width,h:n.current.height}:r?.current?{w:r.current.clientWidth,h:r.current.clientHeight}:t?.current?{w:t.current.width,h:t.current.height}:null;ie(g?{locked:!0,overlaySize:E}:{locked:!1}),Ze(`Auto-detect completed — confidence: ${Math.round(kr*100)}%`),Me(!1)}function nt(j,R,_=.03){if(!j||!R)return!1;const O=Math.abs((j.cx-R.cx)/(j.cx||1)),D=Math.abs((j.cy-R.cy)/(j.cy||1)),oe=Math.abs((j.doubleOuter-R.doubleOuter)/(j.doubleOuter||1));return O<=_&&D<=_&&oe<=_}const er=f.useRef(null);f.useEffect(()=>{let j=null;try{j=new Worker(new URL("/assets/boardDetection.worker-BU4xdRPi.js",import.meta.url),{type:"module"}),er.current=j,console.log("[Calibrator] Board detection worker created")}catch(R){console.warn("[Calibrator] Failed to create board detection worker, will fallback to main thread: ",R),er.current=null}return()=>{try{j?.terminate()}catch{}}},[]);async function tr(){if(!t.current)return alert("Capture a frame or upload a photo first.");if(er.current){Me(!0);let j=null;try{j=await createImageBitmap(t.current)}catch(R){console.warn("[Calibrator] createImageBitmap failed; falling back to main thread detection",R),j=null}if(!j)return Me(!1),Ot();try{const R=er.current;return R?new Promise(_=>{let O;const D=oe=>{try{if(oe.data&&oe.data.error){const G=oe.data.error||"Auto-calibration failed";alert(`Auto-calibration failed: ${G}`),Ze(G),Me(!1),O&&clearTimeout(O),R.removeEventListener("message",D),_();return}if(oe.data&&oe.data.type==="result"){const G=oe.data.detection;if(xe&&(G.confidence=100),!G.homography||!Array.isArray(G.calibrationPoints)||G.calibrationPoints.length<4){const ve=G.calibrationPoints||[];if(ve.length>=4){const me=[{x:0,y:-Z.doubleOuter},{x:Z.doubleOuter,y:0},{x:0,y:Z.doubleOuter},{x:-Z.doubleOuter,y:0}];try{const ye=mr(me,ve.slice(0,4));G.homography=ye,G.errorPx=Ar(ye,me,ve.slice(0,4))}catch(ye){console.warn("[Calibrator] Worker homography compute failed",ye)}}}if(!G.success||!G.homography||!xe&&G.confidence<50){alert(`❌ Board Detection Failed

Confidence: ${Math.round(G.confidence)}%

${G.message}

Try:
• Better lighting
• Closer camera angle
• Make sure entire board is visible
• Use manual calibration instead (click the 4 double-ring points: D20, D6, D3, D11)`),Me(!1),O&&clearTimeout(O),R.removeEventListener("message",D),_();return}st({cx:G.cx,cy:G.cy,bullInner:G.bullInner,bullOuter:G.bullOuter,trebleInner:G.trebleInner,trebleOuter:G.trebleOuter,doubleInner:G.doubleInner,doubleOuter:G.doubleOuter}),P(G.calibrationPoints),Cn(G.calibrationPoints,G.homography);let X=(G.errorPx??Number.POSITIVE_INFINITY)<=2;try{let ve=1;const me=3;for(let pe=1;pe<me;pe++){const we=document.createElement("canvas");we.width=Math.max(1,Math.round(t.current.width*.8)),we.height=Math.max(1,Math.round(t.current.height*.8)),we.getContext("2d").drawImage(t.current,0,0,we.width,we.height);const At=ur(we);nt(G,At)&&ve++}const ye=ve>=Math.ceil(me*.66);X=X&&ye}catch{}const J=n?.current?{w:n.current.width,h:n.current.height}:r?.current?{w:r.current.clientWidth,h:r.current.clientHeight}:{w:t.current?.width??0,h:t.current?.height??0};ie({H:G.homography,createdAt:Date.now(),errorPx:G.errorPx??null,imageSize:{w:t.current?.width??0,h:t.current?.height??0},overlaySize:J,anchors:{src:Or().slice(0,4),dst:G.calibrationPoints},locked:X?!0:$}),Ze(G.message??`Auto-calibration success (confidence ${Math.round(G.confidence)}%)`),y("computed"),Pe(xe?100:Math.round(G.confidence)),ie({errorPx:G.errorPx??null}),Me(!1),R.removeEventListener("message",D),_();return}}catch(G){console.warn("[Calibrator] Worker message processing failed",G),Me(!1),R.removeEventListener("message",D),_();return}};R.addEventListener("message",D),R.postMessage({type:"detect",bitmap:j},[j]),O=setTimeout(()=>{Ge&&(console.warn("[Calibrator] Worker timed out, attempting sync fallback"),Me(!1),O&&clearTimeout(O),R.removeEventListener("message",D),Ot())},8e3)}):Ot()}catch(R){return console.warn("[Calibrator] AutoCalibrate worker payload failed",R),Me(!1),Ot()}}else return Ot()}async function Ot(){Me(!0);let j=ur(t.current);if(j=ro(j),xe&&(j.confidence=100),!j.homography||!Array.isArray(j.calibrationPoints)||j.calibrationPoints.length<4)try{const X=j.calibrationPoints||[];if(X.length>=4){const J=[{x:0,y:-Z.doubleOuter},{x:Z.doubleOuter,y:0},{x:0,y:Z.doubleOuter},{x:-Z.doubleOuter,y:0}],ve=mr(J,X.slice(0,4));j.homography=ve,j.errorPx=Ar(ve,J,X.slice(0,4))}}catch(X){console.warn("[Calibrator] sync forced homography compute failed",X)}if(!j.success||!j.homography||!xe&&j.confidence<50){const X=[.9,.8,1.1,1.2];for(const J of X)try{const ve=t.current,me=document.createElement("canvas");me.width=Math.max(1,Math.round(ve.width*J)),me.height=Math.max(1,Math.round(ve.height*J));const ye=me.getContext("2d");if(!ye)continue;ye.drawImage(ve,0,0,me.width,me.height);let pe=ur(me);if(pe=ro(pe),pe.success&&pe.homography){const we=1/J;pe.cx*=we,pe.cy*=we,pe.bullInner*=we,pe.bullOuter*=we,pe.trebleInner*=we,pe.trebleOuter*=we,pe.doubleInner*=we,pe.doubleOuter*=we,pe.calibrationPoints=pe.calibrationPoints.map(Fe=>({x:Fe.x*we,y:Fe.y*we})),j=pe;break}}catch{}}if(!j.success||!j.homography||!xe&&j.confidence<50){alert(`❌ Board Detection Failed

Confidence: ${Math.round(j.confidence)}%

${j.message}

Try:
• Better lighting
• Closer camera angle
• Make sure entire board is visible
• Use manual calibration instead (click the 4 double-ring points: D20, D6, D3, D11)`),Ze(j.message??null),Me(!1);return}st({cx:j.cx,cy:j.cy,bullInner:j.bullInner,bullOuter:j.bullOuter,trebleInner:j.trebleInner,trebleOuter:j.trebleOuter,doubleInner:j.doubleInner,doubleOuter:j.doubleOuter}),P(j.calibrationPoints),Cn(j.calibrationPoints,j.homography);const R=(j.errorPx??Number.POSITIVE_INFINITY)<=2;let _=1;const O=3;for(let X=1;X<O;X++)try{const J=document.createElement("canvas");J.width=Math.max(1,Math.round(t.current.width*.9)),J.height=Math.max(1,Math.round(t.current.height*.9)),J.getContext("2d").drawImage(t.current,0,0,J.width,J.height);const me=ur(J);nt(j,me)&&_++}catch{}const D=_>=Math.ceil(O*.66),oe=R&&D,G=n?.current?{w:n.current.width,h:n.current.height}:r?.current?{w:r.current.clientWidth,h:r.current.clientHeight}:{w:t.current.width,h:t.current.height};ie({H:j.homography,createdAt:Date.now(),errorPx:j.errorPx??null,imageSize:{w:t.current.width,h:t.current.height},overlaySize:G,anchors:{src:Or().slice(0,4),dst:j.calibrationPoints},locked:oe?!0:$}),y("computed"),Pe(xe?100:Math.round(j.confidence)),ie({errorPx:j.errorPx??null}),Ze(j.message??null),Me(!1)}f.useEffect(()=>{Cn()},[S,le]),f.useEffect(()=>{if(!at||!u)return;let j=0;const R=()=>{try{Qn()}catch{}j=requestAnimationFrame(R)};return j=requestAnimationFrame(R),()=>cancelAnimationFrame(j)},[at,u]),f.useEffect(()=>{(async()=>{try{if(!$||!F)return;const j=t.current?{w:t.current.width,h:t.current.height}:null,R=JSON.stringify({H:le,anchors:null,imageSize:j,errorPx:Y??null});try{await Gn(`/cam/calibration/${F}`,{method:"POST",headers:{"Content-Type":"application/json"},body:R}),console.log("[Calibrator] Posted calibration for code",F)}catch(_){console.warn("[Calibrator] Upload calibration failed",_)}try{const _=localStorage.getItem("authToken");_&&(await Gn("/api/user/calibration",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${_}`},body:R}),console.log("[Calibrator] Synced calibration to user account"))}catch(_){console.warn("[Calibrator] User calibration sync failed",_)}}catch{}})()},[$,F]);function Wr(){const{preferredCameraId:j,preferredCameraLabel:R,setPreferredCamera:_,cameraEnabled:O,setCameraEnabled:D,preferredCameraLocked:oe,setPreferredCameraLocked:G}=on(),[X,J]=f.useState(null),[ve,me]=f.useState(""),[ye,pe]=f.useState(!1),we=f.useRef(null),Fe=document.getElementById("dropdown-portal-root")||(()=>{const ge=document.createElement("div");return ge.id="dropdown-portal-root",document.body.appendChild(ge),ge})();async function At(){me("");try{await mn();const ge=c;we.current&&we.current.dataset?.open==="true"&&J(ge)}catch{me("Unable to list cameras. Grant camera permission in your browser.")}}f.useEffect(()=>{At()},[c.length]),f.useEffect(()=>{function ge(rt){try{const ft=rt.target,kt=we.current&&we.current.contains(ft),pt=Fe&&Fe.contains&&Fe.contains(ft);!kt&&!pt&&(pe(!1),we.current&&(we.current.dataset.open="false"))}catch{}}return document.addEventListener("mousedown",ge),document.addEventListener("pointerdown",ge),document.addEventListener("touchstart",ge),()=>{document.removeEventListener("mousedown",ge),document.removeEventListener("pointerdown",ge),document.removeEventListener("touchstart",ge)}},[]),f.useEffect(()=>{try{we.current&&(we.current.dataset.open=ye?"true":"false")}catch{}},[ye]);const Ct=(X||c).find(ge=>ge.deviceId===j),Oe=Ct?`${Ct.label||"Camera"}`:j?"Camera (unavailable)":"Auto (browser default)",[it,yn]=f.useState(Oe),Rt=j&&!Ct;return e.jsxs("div",{ref:we,className:"mt-3 p-3 rounded-lg border border-indigo-500/30 bg-indigo-500/5",children:[e.jsx("div",{className:"font-semibold mb-2",children:"Select camera device"}),ve&&e.jsx("div",{className:"text-rose-400 text-sm mb-2",children:ve}),c.length===0&&!ve&&e.jsx("div",{className:"text-xs text-slate-400 mb-2",children:'Detecting devices... (click "Rescan" if this hangs)'}),Rt&&e.jsxs("div",{className:"text-amber-400 text-sm mb-2",children:["Selected camera is no longer available.",e.jsx("button",{className:"underline ml-1",onClick:()=>_(void 0,"",!0),disabled:u,children:"Use auto-selection"})]}),e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[oe?e.jsx("div",{className:"text-xs text-emerald-400",children:"🔒 Camera selection locked"}):e.jsx("div",{className:"text-xs text-slate-400",children:"Camera selection unlocked"}),e.jsx("button",{"data-testid":"cam-lock-toggle",className:"btn btn--ghost px-2 py-0.5 text-xs ml-2",onClick:()=>{G(!oe)},children:oe?"Unlock":"Lock"})]}),e.jsxs("div",{className:"flex items-center gap-3 mb-3",children:[e.jsx("input",{type:"checkbox",id:"cameraEnabled-calibrator",checked:O,onChange:ge=>D(ge.target.checked),className:"w-4 h-4",disabled:u}),e.jsx("label",{htmlFor:"cameraEnabled-calibrator",className:"text-sm",children:"Enable camera for scoring"})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-2 items-center text-sm",children:[e.jsxs("select",{"data-testid":"cam-select",onFocus:()=>{try{At()}catch{}},onPointerDown:ge=>{ge.stopPropagation()},onMouseDown:ge=>{ge.stopPropagation()},onTouchStart:ge=>{ge.stopPropagation()},className:"input col-span-2 dropdown-themed",value:j||"auto",onChange:ge=>{const rt=ge.target.value;if(rt==="auto")try{_(void 0,"",!0)}catch{}else if(rt==="phone"){try{_(void 0,"Phone Camera",!0)}catch{}try{C("phone"),y("camera"),m(!1),M(!1)}catch{}}else{const ft=(X||c).find(kt=>kt.deviceId===rt);if(ft)try{_(ft.deviceId,ft.label||"",!0)}catch{}}},children:[e.jsx("option",{value:"auto",children:"Auto (browser default)"}),(X||c).map(ge=>e.jsx("option",{value:ge.deviceId,children:ge.label||"Camera"},ge.deviceId)),e.jsx("option",{value:"phone",children:"📱 Phone Camera"})]}),c.length===0&&e.jsxs("div",{className:"col-span-1 flex gap-2 items-center justify-end",children:[e.jsx("button",{className:"btn btn--ghost btn-sm",onClick:async()=>{try{await Rn(),await mn()}catch(ge){console.warn("[Calibrator] request camera permission failed",ge)}},children:"Enable local camera"}),e.jsx("button",{className:"btn btn--ghost btn-sm",onClick:async()=>await mn(),children:"Rescan"})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("button",{className:"btn px-2 py-1",onClick:()=>{Rn(j||void 0)},disabled:u,children:"Test"}),e.jsx("div",{className:"text-xs mt-2 flex items-center justify-end gap-2",children:e.jsxs("div",{className:"text-xs opacity-70 flex items-center gap-2",children:[e.jsx("span",{children:Ft?`Detected: ${Ft}`:"No recent detection"}),(Ft!=null||be)&&e.jsx("button",{className:"btn btn--ghost btn-sm",onClick:()=>{console.debug("[Calibrator] top Commit detected click (onClick)"),Qe()},onPointerDown:()=>{console.debug("[Calibrator] top Commit detected click (onPointerDown)"),Qe()},disabled:qt==null,children:"Commit detected"}),e.jsx("span",{className:`inline-block w-2.5 h-2.5 rounded-full ${Ye?"bg-emerald-400":"bg-rose-500"}`}),e.jsx("span",{className:"text-xs opacity-70",children:Ye?"Cal OK":"Cal invalid"})]})})]})]}),R&&e.jsxs("div",{className:"text-xs opacity-70 mt-1",children:["Selected: ",R]}),e.jsx("div",{className:"text-xs opacity-70 mt-1",children:"Tip: All camera technology is supported for autoscoring needs—select your camera here and then open Calibrator to align."})]})}if(Q&&!W){const j=Vr??(typeof window<"u"?`${window.location.origin.replace(/\/$/,"")}/mobile-cam.html`:"/mobile-cam.html");return e.jsxs("div",{className:"mx-auto flex min-h-[calc(100vh-140px)] w-full max-w-xl flex-col justify-center gap-6 p-6",children:[e.jsxs("div",{className:"space-y-5 rounded-3xl border border-indigo-400/30 bg-slate-900/70 p-6 text-slate-100 shadow-xl",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-xs font-semibold uppercase tracking-wide text-indigo-300",children:"Mobile camera"}),e.jsx("h2",{className:"text-2xl font-semibold leading-tight text-white",children:"This device is ready to stream as your dartboard camera"}),e.jsx("p",{className:"text-sm text-slate-200/80",children:"Open the lightweight mobile camera page to stream video to your desktop calibrator. You can still come back here if you need the full desktop tools."})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("a",{href:j,className:"btn w-full justify-center px-4 py-2 text-base",children:"Open mobile camera"}),e.jsx("button",{type:"button",className:"btn btn--ghost w-full justify-center px-4 py-2 text-sm",onClick:()=>Yn(j,"link"),children:jr==="link"?"Link copied!":"Copy link"})]}),e.jsxs("p",{className:"text-xs text-slate-300/70",children:["On a desktop, open Calibrator and generate a pairing code. Then tap"," ",e.jsx("span",{className:"font-semibold",children:"Pair with Desktop"})," from the mobile camera page to connect this device."]})]}),e.jsx("button",{type:"button",className:"self-center text-xs font-medium text-indigo-200 underline decoration-dotted decoration-indigo-300/70 transition hover:text-indigo-100",onClick:()=>ee(!0),children:"Continue to desktop calibrator"})]})}return e.jsxs("div",{className:"space-y-6",children:[Q&&W&&e.jsx("div",{className:"rounded-2xl border border-indigo-400/30 bg-indigo-500/10 p-4 text-sm text-indigo-100",children:e.jsxs("div",{className:"flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between",children:[e.jsx("p",{className:"leading-relaxed",children:"Using a phone? Switch back to the streamlined mobile camera interface for an easier pairing flow."}),e.jsx("button",{type:"button",className:"btn btn--ghost px-3 py-1 text-xs",onClick:()=>ee(!1),children:"Open mobile camera mode"})]})}),e.jsxs("div",{className:"card space-y-6 p-6",children:[e.jsxs("header",{className:"flex flex-wrap items-start justify-between gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-xs font-semibold uppercase tracking-wide text-indigo-300",children:"Marker calibration"}),e.jsx("h2",{className:"text-2xl font-semibold leading-tight text-white",children:"Align your board with the autoscoring overlay"}),e.jsx("p",{className:"max-w-2xl text-sm opacity-80",children:"Place the printable fiducial markers around the double ring, capture a clear frame, and let the calibrator compute a precise homography."})]}),e.jsxs("div",{className:"flex flex-col items-end gap-2 text-xs font-medium",children:[e.jsxs("span",{className:"inline-flex items-center gap-2 rounded-full border border-indigo-400/50 bg-indigo-500/10 px-3 py-1",children:[e.jsx("span",{className:"opacity-60",children:"Mode"}),e.jsx("span",{children:w==="local"?"Desktop camera":w==="phone"?"Phone camera":"Wifi device"})]}),e.jsxs("span",{className:`inline-flex items-center gap-2 rounded-full border px-3 py-1 ${u?"border-emerald-400/60 bg-emerald-500/10 text-emerald-100":"border-white/20 bg-white/5 text-slate-200"}`,children:[e.jsx("span",{className:`h-2 w-2 rounded-full ${u?"bg-emerald-400":"bg-slate-400"}`}),u?"Live stream active":"Stream idle"]}),$?e.jsxs("div",{className:"space-y-3 rounded-2xl border border-emerald-400/40 bg-emerald-500/10 p-4 text-sm",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"flex h-10 w-10 items-center justify-center rounded-full bg-emerald-500/20",children:e.jsx("span",{className:"text-lg",children:"✓"})}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold text-emerald-100",children:"Calibration active"}),e.jsx("p",{className:"text-xs opacity-80",children:"Your calibration is saved and active across all game modes. It will be used in Online, Offline, and Tournaments."})]})]}),e.jsx("button",{className:"btn btn--ghost px-2 py-1 text-xs whitespace-nowrap",onClick:()=>ie({locked:!1}),title:"Unlock to recalibrate",children:"Unlock"})]}),Y!=null&&e.jsxs("div",{className:"text-xs opacity-75",children:["Precision: ",Y.toFixed(2)," px RMS error"]})]}):null]})]}),e.jsxs("div",{className:"grid gap-6 xl:grid-cols-[minmax(0,2fr)_minmax(320px,1fr)]",children:[e.jsxs("section",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-4 rounded-2xl border border-white/10 bg-black/40 p-4",children:[e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-4 text-xs",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[e.jsx("span",{className:"uppercase tracking-wide opacity-60",children:"Video source"}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{className:`btn px-3 py-1 ${w==="local"?"bg-emerald-600 hover:bg-emerald-700":"bg-slate-700 hover:bg-slate-600"}`,"data-testid":"mode-local",onClick:()=>{C("local"),typeof DROPDOWN_DEBUG<"u"&&DROPDOWN_DEBUG&&console.debug("[Calibrator] setMode(local)",Date.now()),hn(!1)},title:"Use local camera",children:"Local"}),e.jsx("button",{className:`btn px-3 py-1 ${w==="phone"?"bg-emerald-600 hover:bg-emerald-700":"bg-slate-700 hover:bg-slate-600"}`,"data-testid":"mode-phone",onClick:()=>{C("phone"),typeof DROPDOWN_DEBUG<"u"&&DROPDOWN_DEBUG&&console.debug("[Calibrator] setMode(phone)",Date.now()),hn(!1)},title:"Enable camera on this device",children:"Phone"}),e.jsx("button",{className:`btn px-3 py-1 ${w==="wifi"?"bg-emerald-600 hover:bg-emerald-700":"bg-slate-700 hover:bg-slate-600"}`,"data-testid":"mode-wifi",onClick:()=>{C("wifi"),typeof DROPDOWN_DEBUG<"u"&&DROPDOWN_DEBUG&&console.debug("[Calibrator] setMode(wifi)",Date.now()),hn(!1);try{Kn()}catch(j){console.debug("[Calibrator] startWifiConnection failed",j)}},title:"Discover wifi/USB autoscoring devices",children:"Wifi"})]})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"opacity-70",children:"Zoom"}),e.jsx("input",{type:"range",min:50,max:200,step:5,value:Math.round((k||1)*100),onChange:j=>z(Math.max(.5,Math.min(2,Number(j.target.value)/100)))}),e.jsxs("span",{className:"w-12 text-right",children:[Math.round((k||1)*100),"%"]})]}),e.jsx("button",{className:"btn px-3 py-1",onClick:()=>z(1),children:"Actual"})]})]}),e.jsxs("div",{className:"ml-3 relative",children:[e.jsxs("button",{className:"inline-flex items-center gap-2 rounded-full border border-indigo-400/30 bg-indigo-400/10 px-3 py-1 text-sm",onClick:()=>en(!Nn),"data-testid":"cal-tools-popper-button",children:[e.jsx("span",{className:"font-semibold",children:"Cal. Tools"}),Pt&&e.jsx("span",{className:"ml-2 text-xs opacity-70",children:"(overlay preserved)"})]}),Nn&&e.jsxs("div",{className:"absolute right-0 mt-2 w-64 rounded-lg border bg-gray-900/80 p-3 shadow-lg z-50","data-testid":"cal-tools-popover",role:"dialog",children:[e.jsx("div",{className:"text-xs mb-2",children:"Calibrator quick tools"}),e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("input",{id:"hdr-show-darts",type:"checkbox",checked:_e,onChange:j=>Ee(j.target.checked)}),e.jsx("label",{htmlFor:"hdr-show-darts",className:"text-sm",children:"Show darts overlay"})]}),e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("input",{id:"hdr-autocommit",type:"checkbox",checked:be,onChange:j=>Xe(j.target.checked)}),e.jsx("label",{htmlFor:"hdr-autocommit",className:"text-sm",children:"Enable autocommit test"})]}),e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("input",{id:"hdr-autocommit-online",type:"checkbox",checked:Qt,onChange:j=>Wt(j.target.checked),disabled:!be}),e.jsx("label",{htmlFor:"hdr-autocommit-online",className:"text-sm",children:"Allow autocommit in Online/Tournament matches (dangerous)"})]}),e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("input",{id:"hdr-autocommit-immediate",type:"checkbox",checked:de,onChange:j=>xn(j.target.checked)}),e.jsx("label",{htmlFor:"hdr-autocommit-immediate",className:"text-sm",children:"Autocommit immediate when detected"})]}),e.jsxs("div",{className:"flex items-center justify-between mt-2",children:[e.jsx("div",{className:"text-xs opacity-70",children:Ft||"No recent detection"}),e.jsx("div",{children:e.jsx("button",{className:"btn btn--small",onClick:()=>{console.debug("[Calibrator] popover Commit click (onClick)"),Qe()},onPointerDown:()=>{console.debug("[Calibrator] popover Commit click (onPointerDown)"),Qe()},children:"Commit"})})]})]})]}),e.jsxs("div",{className:"relative w-full overflow-hidden rounded-2xl border border-indigo-400/30 bg-black",style:{aspectRatio:T?`${T.w} / ${T.h}`:"16 / 9"},children:[(w==="phone"?!u||!Bt:!u)&&e.jsx("div",{className:"absolute inset-0 z-20 flex items-center justify-center bg-gradient-to-br from-black/40 to-black/10",children:e.jsx(gl,{calibrationComplete:x==="computed"})}),e.jsxs("div",{className:"absolute inset-0",style:{transform:`scale(${k||1})`,transformOrigin:"center center"},children:[e.jsx("video",{ref:r,onLoadedMetadata:j=>{try{const R=j.currentTarget;R.videoWidth&&R.videoHeight&&p({w:R.videoWidth,h:R.videoHeight})}catch{}},className:`absolute inset-0 h-full w-full object-cover transition-opacity duration-300 ${S?"opacity-0 -z-10":"opacity-100 z-10"}`,autoPlay:!0,playsInline:!0,muted:!0,controls:!1}),d&&e.jsx("div",{className:"absolute inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur",children:e.jsx("button",{className:"rounded-lg bg-white px-4 py-2 font-semibold text-slate-900 shadow-lg",onClick:async()=>{try{await r.current?.play(),v(!1),m(!0),y("capture")}catch(j){console.warn("Tap-to-play retry failed",j),alert("Tap to enable video failed. Please check browser settings or reload the page.")}},children:"Tap to allow video"})}),e.jsx("canvas",{ref:t,onPointerDown:Yt,className:`absolute inset-0 h-full w-full transition-opacity duration-300 ${S?"opacity-100 z-10":"opacity-0 -z-10"}`}),e.jsx("canvas",{ref:n,onClick:Yt,onPointerDown:Yt,className:"absolute inset-0 z-30 h-full w-full cursor-crosshair"})]})]}),e.jsxs("label",{className:"flex items-center gap-2 text-xs",children:[e.jsx("input",{type:"checkbox",className:"accent-indigo-600",checked:Ve,onChange:j=>Le(j.target.checked)}),"Show preferred-view guide overlay"]}),e.jsxs("div",{className:"mt-4 grid grid-cols-1 gap-3 sm:grid-cols-3 overflow-visible",children:[e.jsxs("div",{className:"rounded-2xl border border-white/10 bg-white/5 p-4 overflow-visible",children:[e.jsx("h3",{className:"text-sm font-semibold",children:"Stage 1 · Capture"}),e.jsx("p",{className:"text-xs opacity-70",children:"Start your camera or upload a photo to capture the board."}),e.jsxs("div",{className:"mt-3 flex flex-col gap-2",children:[w==="local"&&e.jsx("button",{className:"btn",onClick:vn,children:"Enable camera"}),w==="phone"&&e.jsx("button",{className:"btn",title:"Enable camera on this device",onClick:()=>{try{window.dispatchEvent(new CustomEvent("ndn:start-camera",{detail:{mode:"phone"}}))}catch{Xn()}},children:"Enable camera"}),w==="wifi"&&e.jsx("button",{className:"btn",onClick:Kn,children:"Connect wifi camera"}),e.jsx("button",{className:"btn",onClick:Qn,disabled:!u,children:"Capture frame"}),e.jsx("button",{className:"btn",onClick:ps,children:"Upload photo"})]})]}),e.jsxs("div",{className:"rounded-2xl border border-white/10 bg-white/5 p-4",children:[e.jsx("h3",{className:"text-sm font-semibold",children:"Stage 2 · Auto-Calibrate"}),e.jsx("p",{className:"text-xs opacity-70",children:"Automatically detect dartboard rings and compute calibration without any markers or clicking."}),e.jsxs("div",{className:"mt-3 flex flex-col gap-2",children:[e.jsx("button",{className:"btn bg-emerald-600 hover:bg-emerald-700 font-semibold",disabled:!S||Ge,onClick:tr,"data-testid":"autocalibrate-advanced",children:Ge?"Auto-calibrating…":"🎯 Auto-Calibrate (Advanced)"}),e.jsx("button",{className:"btn",disabled:!S||Ge,onClick:Kt,"data-testid":"autodetect-legacy",children:Ge?"Auto-calibrating…":"Legacy: Auto detect rings"})]}),e.jsxs("div",{className:"mt-2 text-xs opacity-70",children:["Confidence: ",xe?100:ut,"%"]}),e.jsxs("div",{className:"mt-2 text-xs opacity-70",children:["Scoring image size: ",H?`${H.w} x ${H.h}`:"—"]}),e.jsxs("div",{className:"mt-2 text-xs opacity-70",children:["Overlay display size: ",B?`${B.w} x ${B.h}`:"—"]}),e.jsx("div",{className:"mt-2",children:e.jsx("button",{className:"btn btn-secondary text-xs",onClick:()=>{Ge||tr()},disabled:!S||Ge,children:"Re-run Auto-Calibrate"})}),ln&&e.jsx("div",{className:"mt-2 text-xs text-yellow-300",children:ln}),e.jsxs("div",{className:"mt-2 text-xs opacity-70 flex items-center gap-2",children:[e.jsxs("label",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",className:"accent-indigo-600",checked:xe,onChange:j=>ne(j.target.checked)}),e.jsx("span",{className:"text-xs",children:"Force 100% Confidence"})]}),xe&&e.jsx("span",{className:"text-xs text-yellow-300",children:"⚠️ For testing only — may produce mis-registrations"})]})]}),e.jsxs("div",{className:"rounded-2xl border border-white/10 bg-white/5 p-4",children:[e.jsx("h3",{className:"text-sm font-semibold",children:"Stage 3 · Align & lock"}),e.jsx("p",{className:"text-xs opacity-70",children:"Click the board points, refine edges and lock calibration when satisfied."}),e.jsxs("div",{className:"mt-3 flex flex-col gap-2",children:[e.jsx("button",{className:"btn",disabled:N.length<es,onClick:xs,children:"Compute"}),e.jsx("button",{className:`btn ${$?"bg-emerald-600 hover:bg-emerald-700":""}`,onClick:()=>{if(!!$)ie({locked:!1});else{const R=n?.current?{w:n.current.width,h:n.current.height}:r?.current?{w:r.current.clientWidth,h:r.current.clientHeight}:t?.current?{w:t.current.width,h:t.current.height}:null;ie({locked:!0,overlaySize:R})}},children:$?"Unlock":"Lock in"}),Pt?e.jsxs("div",{className:"text-xs opacity-70 mt-1",children:["Overlay preservation ",e.jsx("span",{className:"font-semibold",children:"enabled"})," — locked calibration will preserve display size"]}):e.jsxs("div",{className:"text-xs opacity-70 mt-1",children:["Overlay preservation ",e.jsx("span",{className:"font-semibold",children:"disabled"})," — locked calibration uses current canvas size"]}),$&&Pt&&B&&e.jsxs("div",{className:"text-xs opacity-60 mt-1",children:["Overlay display size preserved: ",B.w," x ",B.h]}),e.jsx("button",{className:"btn",onClick:()=>Xt(),children:"Verify"})]})]})]})]}),e.jsxs("div",{className:"mt-4 rounded-lg border border-blue-500/30 bg-blue-500/10 p-3",children:[e.jsx("div",{className:"text-xs font-semibold text-blue-300 mb-1",children:"💡 Pro Tip for Perfect Calibration"}),e.jsxs("div",{className:"text-xs opacity-80",children:["Click the 4 corners of the double ring at"," ",e.jsx("span",{className:"font-semibold",children:"D20, D6, D3, and D11"}),". These evenly-spaced doubles lock the board orientation and yield a perfect (100%) confidence score."]})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-3 text-xs sm:grid-cols-3",children:[e.jsxs("div",{className:"rounded-xl border border-white/10 bg-white/5 px-3 py-2",children:[e.jsx("div",{className:"uppercase tracking-wide opacity-60",children:"Phase"}),e.jsx("div",{className:"text-sm font-semibold capitalize",children:x})]}),e.jsxs("div",{className:"rounded-xl border border-white/10 bg-white/5 px-3 py-2",children:[e.jsx("div",{className:"uppercase tracking-wide opacity-60",children:"Points selected"}),e.jsxs("div",{className:"text-sm font-semibold",children:[N.length," / ",es]})]}),e.jsxs("div",{className:"rounded-xl border border-white/10 bg-white/5 px-3 py-2",children:[e.jsx("div",{className:"uppercase tracking-wide opacity-60",children:"Fit error"}),e.jsx("div",{className:"text-sm font-semibold",children:Y!=null?`${Y.toFixed(2)} px`:"—"})]})]})]}),e.jsxs("aside",{className:"space-y-4",children:[e.jsx(Wr,{}),w==="phone"&&e.jsxs("section",{className:"space-y-3 rounded-2xl border border-indigo-400/30 bg-black/40 p-4 text-xs text-white",children:[e.jsx("div",{className:"font-semibold",children:"Phone pairing"}),e.jsxs("button",{type:"button",className:"w-full text-left px-3 py-2 rounded-lg border border-white/10 bg-white/5 hover:bg-white/10 transition flex items-center gap-2",onClick:()=>Yn(zn,"link"),title:"Copy mobile camera link",children:[e.jsx("span",{className:"flex-1 min-w-0 font-mono break-all text-[11px]",children:zn}),e.jsx("span",{className:"text-[10px] uppercase tracking-wide whitespace-nowrap text-emerald-200",children:jr==="link"?"Copied!":"Copy link"})]}),e.jsx("div",{className:"flex items-center gap-2 text-[11px]",children:e.jsx("a",{href:zn,target:"_blank",rel:"noreferrer",className:"underline decoration-dotted text-indigo-200 hover:text-indigo-100 transition",children:"Open link in new tab"})}),e.jsxs("div",{className:"opacity-80",children:["WS:"," ",Ne?Ne.readyState===1?"open":Ne.readyState===0?"connecting":Ne.readyState===2?"closing":"closed":"not started"," ","· ",wt?.https?"HTTPS on":"HTTP only"]}),F&&e.jsxs("button",{type:"button",className:"w-full text-left px-3 py-2 rounded-lg border border-white/10 bg-white/5 hover:bg-white/10 transition flex items-center justify-between gap-2",onClick:()=>Yn(F,"code"),title:"Copy pairing code",children:[e.jsx("span",{className:"font-mono tracking-[0.3em] text-sm",children:F}),e.jsx("span",{className:"text-[10px] uppercase tracking-wide whitespace-nowrap text-emerald-200",children:jr==="code"?"Copied!":"Copy code"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[Sr!==null&&e.jsxs("span",{children:["Expires in ",Sr,"s"]}),e.jsx("button",{className:"btn px-2 py-1 text-xs",onClick:Cr,children:"Regenerate"})]}),wr&&e.jsxs("div",{className:"space-y-2 rounded-lg border border-slate-700/50 bg-slate-900/60 p-3 text-slate-200",children:[e.jsx("div",{className:"font-semibold",children:"Troubleshooting"}),e.jsxs("ul",{className:"list-disc space-y-1 pl-4",children:[e.jsx("li",{children:"Phone and desktop must be on the same Wi‑Fi network."}),e.jsxs("li",{children:["Allow the server through your firewall (ports 8787 and"," ",wt?.https?wt.port:8788,")."]}),e.jsx("li",{children:"On iPhone, use HTTPS links (QR will prefer HTTPS when enabled)."})]}),e.jsx("div",{className:"text-right",children:e.jsx("button",{className:"btn btn--ghost px-2 py-1 text-xs",onClick:()=>Sn(!1),children:"Hide tips"})})]})]})]})]}),w==="wifi"&&!u&&e.jsxs("div",{className:"space-y-3 rounded-2xl border border-indigo-400/30 bg-black/40 p-4 text-xs text-white",children:[e.jsx("div",{className:"font-semibold",children:"Wifi scoring devices"}),hs?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"h-4 w-4 animate-spin rounded-full border-b-2 border-white"}),e.jsx("span",{children:"Scanning network for devices…"})]}):gn.length>0?e.jsxs("div",{className:"space-y-2",children:[gn.map(j=>e.jsxs("div",{className:"flex items-center justify-between rounded border border-slate-700/50 bg-slate-900/60 p-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:j.name}),e.jsxs("div",{className:"opacity-70",children:[j.ip,":",j.port," · ",j.type.toUpperCase()]}),e.jsxs("div",{className:"opacity-70 text-xs",children:["Capabilities: ",j.capabilities.join(", ")]})]}),e.jsx("button",{className:`btn px-2 py-1 text-xs ${j.status==="connecting"?"bg-yellow-600":j.status==="online"?"bg-green-600":"bg-blue-600"}`,onClick:()=>fs(j),disabled:j.status==="connecting",children:j.status==="connecting"?"Connecting…":"Connect"})]},j.id)),e.jsx("div",{className:"text-center",children:e.jsx("button",{className:"btn px-2 py-1 text-xs",onClick:Kn,children:"Rescan network"})})]}):e.jsxs("div",{className:"space-y-2 text-center",children:[e.jsx("div",{children:"No wifi scoring devices found."}),e.jsx("div",{className:"opacity-70",children:"Ensure your wifi cameras are powered on and on the same network."}),e.jsx("button",{className:"btn px-2 py-1 text-xs",onClick:Kn,children:"Scan again"})]})]})]})]})}let ld=1;const oa=Vn(r=>({toasts:[],push:(t,n)=>r(a=>{const s=ld++,o={id:s,message:t,type:n?.type||"info",timeout:n?.timeout??3e3};return o.timeout&&o.timeout>0&&setTimeout(()=>{r(c=>({toasts:c.toasts.filter(i=>i.id!==s)}))},o.timeout),{toasts:[...a.toasts,o]}}),remove:t=>r(n=>({toasts:n.toasts.filter(a=>a.id!==t)})),clear:()=>r({toasts:[]})}));function dd(){return oa(t=>t.push)}function ud(){const r=oa(n=>n.toasts),t=oa(n=>n.remove);return r.length?e.jsxs(e.Fragment,{children:[r.filter(n=>n.type==="success").map(n=>e.jsx("div",{className:"fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-50",children:e.jsx("div",{className:"p-4 rounded-lg shadow-lg border text-sm bg-emerald-700/90 border-emerald-500/60 text-white max-w-sm text-center",children:e.jsx("div",{className:"flex items-center justify-center gap-2",children:e.jsx("span",{className:"flex-1 font-semibold",children:n.message})})})},n.id)),r.filter(n=>n.type!=="success").length>0&&e.jsx("div",{className:"fixed bottom-4 right-4 z-50 space-y-2 sm:right-4 sm:left-auto left-1/2 -translate-x-1/2 sm:translate-x-0 w-[calc(100%-1.5rem)] sm:w-auto max-w-sm",children:r.filter(n=>n.type!=="success").map(n=>e.jsx("div",{className:`p-3 rounded-lg shadow-lg border text-sm ${n.type==="error"?"bg-rose-700/80 border-rose-500/60 text-white":"bg-black/70 border-slate-700 text-slate-100"}`,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"flex-1",children:n.message}),e.jsx("button",{className:"btn btn--ghost px-2 py-1 text-xs",onClick:()=>t(n.id),children:"Dismiss"})]})},n.id))})]}):null}function md({data:r,height:t=220,barWidth:n=28,gap:a=6,showValues:s=!1}){const o=Math.max(1,...r.map(i=>i.value)),c=r.length*(n+a);return e.jsx("div",{className:"w-full overflow-x-auto",children:e.jsx("div",{className:"relative",style:{height:t,width:Math.max(600,c)},children:e.jsx("div",{className:"absolute inset-0 flex items-end",children:r.map((i,h)=>{const l=Math.round(i.value/o*(t-40));return e.jsxs("div",{className:"flex flex-col items-center justify-end",style:{width:n,marginRight:a},children:[e.jsx("div",{className:"w-full rounded-t-md bg-gradient-to-b from-indigo-400 to-fuchsia-500 shadow-sm",style:{height:l},title:`${i.label}: ${i.value}`}),s&&e.jsx("div",{className:"text-sm mt-1 text-indigo-200 font-semibold",children:i.value}),e.jsx("div",{className:"text-sm mt-1 text-slate-200 font-medium select-none",children:i.label})]},h)})})})})}function hd({tabs:r,active:t,onChange:n,className:a}){return e.jsxs("div",{className:`relative ${a||""}`,children:[e.jsx("div",{className:"absolute inset-0 rounded-xl bg-white/5 backdrop-blur-md border border-white/10 pointer-events-none"}),e.jsx("div",{className:"relative overflow-x-auto no-scrollbar py-1 px-1",children:e.jsx("div",{className:"flex items-center gap-2 min-w-max",children:r.map(s=>{const o=s.key===t;return e.jsx("button",{type:"button",onPointerDown:c=>{c.stopPropagation()},onMouseDown:c=>{c.stopPropagation()},onTouchStart:c=>{c.stopPropagation?.()},onClick:()=>n(s.key),className:`transition-all select-none whitespace-nowrap rounded-full px-4 py-2 text-sm font-semibold shadow-sm focus:outline-none focus-visible:ring-2 focus-visible:ring-white/60 active:scale-[0.98]
                  ${o?"bg-gradient-to-r from-indigo-500 to-fuchsia-500 text-white shadow-indigo-500/30":"bg-white/10 text-slate-100 hover:bg-white/15"}
                `,"aria-pressed":o,children:s.label},s.key)})})}),e.jsx("style",{children:`
        /* Hide scrollbars on WebKit/Firefox for a cleaner pill row */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
      `})]})}const ai=r=>`ndn_stats_${r}`,oi=r=>`ndn_stats_ts_${r}`;function yr(r){try{const t=localStorage.getItem(ai(r));if(!t)return{darts:0,scored:0};const n=JSON.parse(t);return{darts:Number(n.darts)||0,scored:Number(n.scored)||0,fnDarts:Number(n.fnDarts)||0,fnScored:Number(n.fnScored)||0,best3:typeof n.best3=="number"?n.best3:0,worst3:typeof n.worst3=="number"?n.worst3:0,bestLegDarts:typeof n.bestLegDarts=="number"?n.bestLegDarts:0,bestCheckout:typeof n.bestCheckout=="number"?n.bestCheckout:0,worstLegDarts:typeof n.worstLegDarts=="number"?n.worstLegDarts:0,bestFNAvg:typeof n.bestFNAvg=="number"?n.bestFNAvg:0,worstFNAvg:typeof n.worstFNAvg=="number"?n.worstFNAvg:0,num180s:typeof n.num180s=="number"?n.num180s:0}}catch{return{darts:0,scored:0}}}function fd(r,t){try{localStorage.setItem(ai(r),JSON.stringify(t)),window.dispatchEvent(new CustomEvent("ndn:stats-updated",{detail:{name:r,totals:t}}))}catch{}}function pd(r){const{darts:t,scored:n}=yr(r);return t?n/t*3:0}function Uu(r){const{fnDarts:t=0,fnScored:n=0}=yr(r);return t?n/t*3:0}function Bu(r){const{bestLegDarts:t=0}=yr(r);return t||0}function $u(r){const{bestCheckout:t=0}=yr(r);return t||0}function Vu(r){const{num180s:t=0}=yr(r);return Number(t||0)}const ii="ndn_game_mode_stats";function ci(r){let t={};try{const n=localStorage.getItem(ii);n&&(t=JSON.parse(n))}catch{}if(Array.isArray(r))for(const n of r)t[n]||(t[n]={played:0,won:0});return t}function xd(r){try{localStorage.setItem(ii,JSON.stringify(r)),window.dispatchEvent(new CustomEvent("ndn:stats-updated",{detail:{gameModes:!0}}))}catch{}}function zu(r,t){const n=ci(),a=n[r]||{played:0,won:0};a.played+=1,t&&(a.won+=1),n[r]=a,xd(n)}function ms(r){try{const t=localStorage.getItem(oi(r));if(!t)return[];const n=JSON.parse(t);return Array.isArray(n)?n.map(a=>({t:Number(a.t)||0,darts:Number(a.darts)||0,scored:Number(a.scored)||0,fnDarts:Number(a.fnDarts)||0,fnScored:Number(a.fnScored)||0})).filter(a=>a.t>0):[]}catch{return[]}}function bd(r,t){try{localStorage.setItem(oi(r),JSON.stringify(t)),window.dispatchEvent(new CustomEvent("ndn:stats-updated",{detail:{name:r}}))}catch{}}function gd(r,t){const n=Date.now();return r.filter(a=>n-a.t<=t)}function hr(r,t,n,a=Date.now(),s,o){if(t<=0)return;const c=ms(r),i=gd([...c,{t:a,darts:t,scored:n,fnDarts:s,fnScored:o}],1e3*60*60*24*30);bd(r,i)}function vd(r,t=1e3*60*60*24){const n=ms(r);if(!n.length)return 0;const a=Date.now();let s=0,o=0;for(const c of n)a-c.t<=t&&(s+=c.darts,o+=c.scored);return s<=0?0:o/s*3}function yd(r,t=1e3*60*60*24*30){const n=ms(r);if(!n.length)return 0;const a=Date.now();let s=0,o=0;for(const c of n)a-c.t<=t&&(s+=c.fnDarts||0,o+=c.fnScored||0);return s<=0?0:o/s*3}function Wu(r){const n=ms(r);if(!n.length)return 0;const a=Date.now(),s=n.filter(l=>a-l.t<=2592e6),o=s.filter(l=>typeof l.fnDarts=="number"),c=o.length?o:s;let i=0,h=0;for(const l of c)i+=l.darts,h+=l.scored;return i<=0?0:h/i*3}function qu(r){return yd(r,2592e6)}function Hu(r){for(const t of r){let n=0,a=0,s=0,o=0,c=0,i=0,h=0,l=0,u=0,m=0,d=0,v=0;for(const x of t.legs){if(!x.finished)continue;n+=x.dartsThrown,a+=Math.max(0,x.totalScoreStart-x.totalScoreRemaining);const{d:y,s:w}=wd(x);s+=y,o+=w;const C=Math.max(0,x.dartsThrown),N=Math.max(0,x.totalScoreStart-x.totalScoreRemaining),P=C>0?N/C*3:0,S=y>0?w/y*3:0;if(P>0&&(c=Math.max(c,P),i=i===0?P:Math.min(i,P)),S>0&&(m=Math.max(m,S),d=d===0?S:Math.min(d,S)),x.totalScoreRemaining===0){(h===0||C<h)&&(h=C),(u===0||C>u)&&(u=C);const T=typeof x.checkoutScore=="number"?x.checkoutScore:0;T>l&&(l=T)}try{for(const T of x.visits||[])Number(T.score||0)===180&&(v+=1)}catch{}}if(n>0){const x=yr(t.name),y={darts:x.darts+n,scored:x.scored+a,fnDarts:(x.fnDarts||0)+s,fnScored:(x.fnScored||0)+o,best3:Math.max(x.best3||0,c||0),worst3:(()=>{const w=x.worst3||0;return w===0?i||0:i===0?w:Math.min(w,i)})(),bestLegDarts:(()=>{const w=x.bestLegDarts||0;return w===0?h||0:h===0?w:Math.min(w,h)})(),bestCheckout:Math.max(x.bestCheckout||0,l||0),worstLegDarts:(()=>{const w=x.worstLegDarts||0;return w===0?u||0:u===0?w:Math.max(w,u)})(),bestFNAvg:Math.max(x.bestFNAvg||0,m||0),worstFNAvg:(()=>{const w=x.worstFNAvg||0;return w===0?d||0:d===0?w:Math.min(w,d)})(),num180s:(x.num180s||0)+(v||0)};fd(t.name,y),hr(t.name,n,a,Date.now(),s,o)}}}function wd(r){let t=Math.min(9,r.dartsThrown);if(t<=0)return{d:0,s:0};let n=0;for(const s of r.visits){if(t<=0)break;const o=Math.min(t,s.darts);o===s.darts?n+=s.score:n+=Math.round(s.score/s.darts*o),t-=o}return{d:Math.min(9,r.dartsThrown),s:n}}const jd=["X01","Double Practice"],Nd=["Around the Clock","Cricket","Halve It","Shanghai","High-Low","Killer","Bob's 27","Count-Up","High Score","Low Score","Checkout 170","Checkout 121","Treble Practice","Baseball","Golf","Tic Tac Toe","American Cricket","Scam","Fives","Sevens"],so=[...jd,...Nd],Sa={X01:{startOptions:[301,501,701],modeOptions:["bestof","firstto"],modeValueOptions:{bestof:[1,3,5,7],firstto:[1,2,3,4,5,6]}},"Double Practice":{startOptions:[],modeOptions:["practice"],modeValueOptions:{practice:[30,60,120]}},"Around the Clock":{startOptions:[],modeOptions:["bestof","firstto"],modeValueOptions:{bestof:[1,3,5],firstto:[1,2,3,4]}},Cricket:{startOptions:[],modeOptions:["bestof","firstto","rounds"],modeValueOptions:{bestof:[1,3,5],firstto:[1,2,3,4],rounds:[1,3,5]}},"Halve It":{startOptions:[],modeOptions:["bestof","firstto"],modeValueOptions:{bestof:[1,3,5],firstto:[1,2,3,4]}},Shanghai:{startOptions:[],modeOptions:["bestof","firstto"],modeValueOptions:{bestof:[1,3,5],firstto:[1,2,3,4]}},"High-Low":{startOptions:[],modeOptions:["bestof","firstto"],modeValueOptions:{bestof:[1,3,5],firstto:[1,2,3,4]}},Killer:{startOptions:[],modeOptions:["bestof","firstto"],modeValueOptions:{bestof:[1,3,5],firstto:[1,2,3,4]}},"Bob's 27":{startOptions:[],modeOptions:["bestof","firstto"],modeValueOptions:{bestof:[1,3,5],firstto:[1,2,3,4]}},"Count-Up":{startOptions:[],modeOptions:["bestof","firstto"],modeValueOptions:{bestof:[1,3,5],firstto:[1,2,3,4]}},"High Score":{startOptions:[],modeOptions:["bestof","firstto"],modeValueOptions:{bestof:[1,3,5],firstto:[1,2,3,4]}},"Low Score":{startOptions:[],modeOptions:["bestof","firstto"],modeValueOptions:{bestof:[1,3,5],firstto:[1,2,3,4]}},"Checkout 170":{startOptions:[],modeOptions:["bestof","firstto"],modeValueOptions:{bestof:[1,3,5],firstto:[1,2,3,4]}},"Checkout 121":{startOptions:[],modeOptions:["bestof","firstto"],modeValueOptions:{bestof:[1,3,5],firstto:[1,2,3,4]}},"Treble Practice":{startOptions:[],modeOptions:["practice"],modeValueOptions:{practice:[30,60,120]}},Baseball:{startOptions:[],modeOptions:["bestof","innings"],modeValueOptions:{bestof:[1,3,5],innings:[1,3,5,9]}},Golf:{startOptions:[],modeOptions:["holes","bestof"],modeValueOptions:{holes:[9,18],bestof:[1,3,5]}},"Tic Tac Toe":{startOptions:[],modeOptions:["bestof","firstto"],modeValueOptions:{bestof:[1,3,5],firstto:[1,2,3,4]}},"American Cricket":{startOptions:[],modeOptions:["bestof","firstto"],modeValueOptions:{bestof:[1,3,5],firstto:[1,2,3,4]}},Scam:{startOptions:[],modeOptions:["bestof","firstto"],modeValueOptions:{bestof:[1,3,5],firstto:[1,2,3,4]}},Fives:{startOptions:[],modeOptions:["bestof","firstto"],modeValueOptions:{bestof:[1,3,5],firstto:[1,2,3,4]}},Sevens:{startOptions:[],modeOptions:["bestof","firstto"],modeValueOptions:{bestof:[1,3,5],firstto:[1,2,3,4]}}};function Gu(r){return r==="all"?[301,501,701]:Sa[r]?.startOptions??[]}function Sd(r){if(r==="all")return["all","bestof","firstto"];const t=Sa[r];return t?["all",...t.modeOptions]:["all","bestof","firstto"]}function Cd(r,t){return r==="all"||t==="all"?[]:Sa[r]?.modeValueOptions?.[t]??[]}function ts(r){if(!r)return"";switch(r){case"all":return"All Modes";case"bestof":return"Best of";case"firstto":return"First to";case"innings":return"Innings";case"holes":return"Holes";case"rounds":return"Rounds";case"practice":return"Practice";case"none":return"Mode";default:return String(r).replace(/[-_]/g," ").replace(/\b\w/g,t=>t.toUpperCase())}}function li({status:r,title:t,size:n=12}){const a=n;return r==="connecting"?e.jsx("span",{role:"img","aria-label":"Connecting",title:t||"Connecting…",className:"inline-flex items-center justify-center",style:{width:a,height:a},children:e.jsxs("svg",{width:a,height:a,viewBox:"0 0 24 24",className:"animate-spin","aria-hidden":"true",children:[e.jsx("circle",{cx:"12",cy:"12",r:"10",stroke:"#A7F3D0",strokeWidth:"3",fill:"none",opacity:"0.35"}),e.jsx("path",{d:"M22 12a10 10 0 0 0-10-10",stroke:"#34D399",strokeWidth:"3",strokeLinecap:"round",fill:"none"})]})}):r==="connected"?e.jsx("span",{role:"img","aria-label":"Connected",title:t||"Connected",className:"inline-flex items-center justify-center",style:{width:a,height:a},children:e.jsx("svg",{width:a,height:a,viewBox:"0 0 24 24","aria-hidden":"true",children:e.jsx("circle",{cx:"12",cy:"12",r:"10",fill:"#34D399"})})}):e.jsx("span",{role:"img","aria-label":"Disconnected",title:t||"Not connected",className:"inline-flex items-center justify-center",style:{width:a,height:a},children:e.jsxs("svg",{width:a,height:a,viewBox:"0 0 24 24","aria-hidden":"true",children:[e.jsx("circle",{cx:"12",cy:"12",r:"10",fill:"#F87171",opacity:"0.15"}),e.jsx("circle",{cx:"12",cy:"12",r:"9",stroke:"#F87171",strokeWidth:"2",fill:"none"}),e.jsx("rect",{x:"6",y:"11",width:"12",height:"2",rx:"1",fill:"#F87171"})]})})}function di(){const r=gr(),t=f.useRef(null),n=f.useRef(null),a=r.getVideoElementRef(),o=!!(r.getMediaStream?.()||a?.srcObject),c=r.isStreaming&&r.mode==="phone"&&o;f.useEffect(()=>{const h=t.current;if(!h)return;let l=!0;const u=h.getContext("2d");if(!u)return;const m=()=>{if(l){try{if(u.clearRect(0,0,h.width,h.height),c&&a&&a.readyState>=2){const d=a.videoWidth||640,v=a.videoHeight||360,x=h.width,y=h.height,w=d/v,C=x/y;let N=0,P=0,S=d,M=v;if(w>C){const T=v*C;N=(d-T)/2,S=T}else if(w<C){const T=d/C;P=(v-T)/2,M=T}u.drawImage(a,N,P,S,M,0,0,x,y)}else u.fillStyle="rgba(148, 163, 184, 0.25)",u.fillRect(0,0,h.width,h.height),u.fillStyle="rgba(226,232,240,0.8)",u.font="10px system-ui, sans-serif",u.textAlign="center",u.textBaseline="middle",u.fillText("Camera",h.width/2,h.height/2)}catch{}n.current=requestAnimationFrame(m)}};return n.current=requestAnimationFrame(m),()=>{l=!1,n.current&&cancelAnimationFrame(n.current)}},[c,a]);const i=()=>{try{window.dispatchEvent(new CustomEvent("ndn:toggle-phone-overlay"))}catch{}};return e.jsxs("button",{type:"button",onClick:i,className:"relative inline-flex items-center gap-1 rounded-lg border border-white/15 bg-white/5 hover:bg-white/10 transition-colors shadow-sm overflow-hidden",style:{height:36},title:c?"Camera connected – click to toggle overlay":"Camera not connected",children:[e.jsx("canvas",{ref:t,width:64,height:36,className:"block"}),e.jsx("span",{className:"pr-2 text-xs text-slate-100 select-none hidden xs:inline",children:c?"Phone Cam":"No Camera"}),e.jsx("span",{className:"absolute -top-1 -right-1 text-lg pointer-events-none drop-shadow","aria-hidden":"true",children:c?"✅":"⚪"})]})}const ao={calibration:{keywords:["calibration","calibrate","camera","score","accuracy","aim","setup"],title:"How Calibration Works",explanation:`Calibration helps our AI precisely detect where your darts land on the board. Here's how it works:

1. **D20**: Click on the 20 segment to calibrate that area
2. **D6**: Click on the 6 segment to calibrate that area
3. **D3**: Click on the 3 segment to calibrate that area
4. **D11**: Click on the 11 segment to calibrate that area
5. **Bullseye**: Click on the bullseye to calibrate the center

Each click teaches the system about your board's position and angle. After calibrating all areas, your scoring will be much more accurate!`,actions:[{id:"D20",label:"📍 Click D20",color:"bg-blue-600"},{id:"D6",label:"📍 Click D6",color:"bg-purple-600"},{id:"D3",label:"📍 Click D3",color:"bg-pink-600"},{id:"D11",label:"📍 Click D11",color:"bg-cyan-600"},{id:"Bullseye",label:"🎯 Click Bullseye",color:"bg-yellow-600"}]},scoring:{keywords:["score","points","counting","how do i score","scoring system"],title:"Dart Scoring",explanation:`In darts, each segment on the board has a value:
- Single areas: Face value (1-20)
- Double ring (outer): 2× the segment number
- Triple ring (inner): 3× the segment number
- Bullseye: 50 points
- Bull (outer bull): 25 points

For example: hitting Triple 20 = 60 points, Double 10 = 20 points`},gameplay:{keywords:["game","how to play","rules","x01","cricket","match","round"],title:"How to Play",explanation:`Nine Dart Nation supports multiple game modes:

**X01** (501, 301, 701): Start from the set score and count down to exactly 0. Final dart must be on a double.

**Cricket**: Players try to "close" numbers 15-20 and bullseye by hitting them. First to close all and have the highest score wins.

**Killer**: Players mark their "number" and try to knock out other players' lives.

Select your game mode when creating a match, and follow the on-screen instructions!`},premium:{keywords:["premium","subscription","features","upgrade","cost","paid"],title:"Premium Features",explanation:`Our Premium subscription gives you:
- Tournament creation and entry
- Advanced statistics and replays
- Priority matchmaking
- Custom profiles and themes
- Ad-free experience

Premium grants are often awarded as tournament prizes!`},connection:{keywords:["connection","disconnect","lag","latency","websocket","error","offline"],title:"Connection Issues",explanation:`If you're experiencing connection issues:
1. Check your internet connection
2. Refresh the page (Ctrl+R or Cmd+R)
3. Clear browser cache
4. Try a different browser
5. Check if the site status page shows any issues

Most connection issues resolve in seconds. Contact admin if problems persist.`},camera:{keywords:["camera","phone camera","mobile","video","pairing","connect"],title:"Camera Setup",explanation:`To use our phone camera feature:
1. Open Nine Dart Nation on your phone
2. Go to Settings > Camera Pairing
3. Scan the QR code or enter the pairing code
4. Position your phone to capture the dartboard
5. Run calibration (see calibration help for details)

Your phone will now act as a live dartboard camera!`},tournament:{keywords:["tournament","compete","bracket","prize","winner","playoffs"],title:"Tournaments",explanation:`Tournaments are competitive events where you can:
- Play against other skilled players
- Win prizes (Premium subscriptions or cash)
- Climb leaderboards
- Compete in structured brackets

Check the Tournaments tab to see upcoming events. Registration typically opens 30 minutes before start time.`}};function kd(r){const t=r.toLowerCase();for(const[n,a]of Object.entries(ao))for(const s of a.keywords)if(t.includes(s))return{type:"explanation",title:a.title,message:a.explanation,actions:a.actions,followUp:"Do you need further assistance? I can connect you with an admin if needed."};return{type:"suggestion",title:"Need More Help?",message:`I couldn't find a specific answer to your question. Common topics I can help with:

${Object.values(ao).map(n=>`• ${n.title}`).join(`
`)}

Or I can connect you with an admin who can help further.`,followUp:"Would you like to speak with an admin?"}}function Ed(){const r=new Date().getHours();return r>=20||r<7?"20-30 minutes (off-peak hours)":r>=12&&r<14?"10-15 minutes (moderate traffic)":r>=18&&r<20?"15-20 minutes (peak hours)":"5-10 minutes"}function ui({request:r,user:t,onClose:n}){const a=(()=>{try{return vr()}catch{return null}})(),[s,o]=f.useState(r?.messages||[]),[c,i]=f.useState(""),[h,l]=f.useState({}),[u,m]=f.useState(!1),[d,v]=f.useState(""),x=f.useRef(null),y=f.useRef(null),w=f.useRef([]);f.useEffect(()=>{if(!a)return;const S=a.addListener(M=>{try{if(M?.type==="help-message"&&String(M.requestId)===String(r.id)&&o(T=>[...T,M.message]),M?.type==="help-request-updated"&&M.request?.id===r.id&&(o(M.request.messages||[]),m(!!M.request.claimedBy)),M?.type==="help-typing"&&String(M.requestId)===String(r.id)){const T=M.fromName||M.fromEmail||(M.admin?"admin":"user");l(p=>({...p,[T]:Date.now()}))}}catch{}});return()=>{S()}},[a,r?.id]);const C=()=>{if(!c.trim())return;const S=c,M={type:"help-message",requestId:r.id,message:S};try{a?.send(M)}catch{}const T={fromEmail:t?.email||null,fromName:t?.username||null,message:S,ts:Date.now(),admin:!1};if(o(p=>[...p,T]),i(""),!u){const p=window.setTimeout(()=>{const k=kd(S);if(k){const z={fromName:"AI Assistant",message:`${k.title}

${k.message}`,ts:Date.now(),admin:!0,actions:k.actions,followUp:k.followUp};o(W=>[...W,z])}},500);w.current.push(p)}},N=S=>{if(!S){const p={fromName:"You",message:"No, I think I have it now. Thanks!",ts:Date.now(),admin:!1};o(z=>[...z,p]);const k=window.setTimeout(()=>{const z={fromName:"AI Assistant",message:"✅ Great! Glad I could help. Feel free to reach out anytime you need assistance.",ts:Date.now(),admin:!0};o(W=>[...W,z])},300);w.current.push(k);return}const M={fromName:"You",message:"Yes, I need to speak with an admin",ts:Date.now(),admin:!1};o(p=>[...p,M]);try{a?.send({type:"help-escalate",requestId:r.id})}catch{}v(Ed());const T=window.setTimeout(()=>{const p={fromName:"System",message:`⏳ Connecting you with an admin...

📊 Estimated wait time: ${d}

An admin will be with you shortly. Please stay on this chat.`,ts:Date.now(),admin:!0};o(k=>[...k,p])},500);w.current.push(T)};f.useEffect(()=>{if(x.current)try{x.current.scrollTop=x.current.scrollHeight}catch{}},[s]);const P=f.useCallback(()=>{try{a?.send({type:"help-typing",requestId:r.id,fromName:t?.username,fromEmail:t?.email,admin:!!t?.isAdmin})}catch{}y.current&&clearTimeout(y.current),y.current=window.setTimeout(()=>{l(S=>{const M={...S};return delete M[t?.username||t?.email||"me"],M})},3e3)},[a,r.id,t]);return f.useEffect(()=>()=>{y.current&&clearTimeout(y.current);for(const S of w.current)clearTimeout(S);w.current=[]},[]),e.jsxs("div",{className:"fixed inset-0 z-50 flex items-end justify-center p-4",children:[e.jsx("div",{className:"absolute inset-0 bg-black/40",onClick:n}),e.jsxs("div",{className:"relative w-full max-w-2xl bg-slate-900 rounded-lg shadow-xl overflow-hidden flex flex-col max-h-[80vh]",children:[e.jsxs("div",{className:"flex items-center justify-between p-3 border-b border-slate-700 bg-slate-800",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"font-semibold flex items-center gap-2",children:[e.jsx(Ma,{className:"w-4 h-4 text-yellow-400"}),"Help Desk — ",r.username||"Anonymous"]}),u&&e.jsx("span",{className:"text-xs px-2 py-1 rounded bg-emerald-600",children:"Admin Connected"})]}),e.jsx("button",{"aria-label":"Close",className:"px-2 py-1 rounded bg-neutral-700 hover:bg-neutral-600 text-sm",onClick:n,children:e.jsx(bo,{className:"w-4 h-4"})})]}),e.jsxs("div",{ref:x,className:"flex-1 overflow-y-auto p-3 space-y-3 bg-black/20",children:[s.map((S,M)=>e.jsx("div",{children:e.jsxs("div",{className:`max-w-[85%] px-3 py-2 rounded ${S.admin?"bg-emerald-600/20 border border-emerald-500/40 text-emerald-100 ml-auto":"bg-slate-700 text-slate-100"}`,children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsxs("div",{className:"text-xs opacity-70 font-semibold flex items-center gap-1",children:[S.admin?e.jsx(Ma,{className:"w-3 h-3"}):e.jsx(as,{className:"w-3 h-3"}),S.fromName||S.fromEmail||(S.admin?"AI Assistant":"You")]}),e.jsx("div",{className:"text-xs opacity-50 ml-2",children:S.ts?new Date(S.ts).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):""})]}),e.jsx("div",{className:"whitespace-pre-wrap break-words text-sm",children:S.message}),S.actions&&S.actions.length>0&&e.jsxs("div",{className:"mt-3 space-y-2",children:[e.jsx("div",{className:"text-xs font-semibold opacity-80",children:"🎯 Try these calibration points:"}),e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-5 gap-2",children:S.actions.map(T=>e.jsx("button",{className:`${T.color} text-white text-xs py-2 px-2 rounded font-medium hover:opacity-90 transition-opacity`,onClick:()=>{const p={fromName:"You",message:`Clicked: ${T.label}`,ts:Date.now(),admin:!1};o(k=>[...k,p]);try{a?.send({type:"help-message",requestId:r.id,message:`User clicked: ${T.id}`})}catch{}},children:T.label},T.id))})]}),S.followUp&&!u&&e.jsxs("div",{className:"mt-3 space-y-2",children:[e.jsx("div",{className:"text-xs opacity-80",children:S.followUp}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{className:"flex-1 bg-emerald-600 hover:bg-emerald-700 text-white text-xs py-2 px-3 rounded font-medium transition-colors",onClick:()=>N(!0),children:"✅ Yes, connect me"}),e.jsx("button",{className:"flex-1 bg-slate-600 hover:bg-slate-700 text-white text-xs py-2 px-3 rounded font-medium transition-colors",onClick:()=>N(!1),children:"❌ No thanks"})]})]})]})},M)),Object.keys(h).length>0&&e.jsxs("div",{className:"text-xs text-slate-300 opacity-80 flex items-center gap-2",children:[e.jsxs("span",{children:[Object.keys(h).join(", ")," typing"]}),e.jsxs("span",{className:"flex gap-1",children:[e.jsx("span",{className:"w-1 h-1 bg-slate-300 rounded-full animate-bounce"}),e.jsx("span",{className:"w-1 h-1 bg-slate-300 rounded-full animate-bounce delay-100"}),e.jsx("span",{className:"w-1 h-1 bg-slate-300 rounded-full animate-bounce delay-200"})]})]})]}),e.jsxs("div",{className:"p-3 border-t border-slate-700 bg-slate-800 flex gap-2",children:[e.jsx("input",{className:"input flex-1 text-sm",value:c,onChange:S=>{i(S.target.value),P()},onKeyDown:S=>{S.key==="Enter"&&!S.shiftKey&&(S.preventDefault(),C())},placeholder:"Ask a question (e.g., 'How does calibration work?')..."}),e.jsx("button",{"aria-label":"Send message",className:"btn bg-blue-600 hover:bg-blue-700 text-white",onClick:C,children:e.jsx(ca,{className:"w-4 h-4"})})]})]})]})}const Ca={X01:{tolerancePx:10,requiredTargets:["SINGLE","DOUBLE","TREBLE","BULL","OUTER_BULL"],criticalZones:["D20","D1","BULLSEYE","T20","SINGLE_20"],minConfidence:80},"Double Practice":{tolerancePx:12,requiredTargets:["DOUBLE","BULL"],criticalZones:["D20","D1","D6","D17"],minConfidence:75},"Treble Practice":{tolerancePx:8,requiredTargets:["TREBLE"],criticalZones:["T20","T1","T5"],minConfidence:85},"Checkout 170":{tolerancePx:9,requiredTargets:["DOUBLE"],criticalZones:["D25","D20","D8"],minConfidence:82},"Checkout 121":{tolerancePx:9,requiredTargets:["DOUBLE"],criticalZones:["D20","D5","D1"],minConfidence:82},Cricket:{tolerancePx:15,requiredTargets:["20","19","18","17","16","15","BULL"],criticalZones:["20","15","BULL"],minConfidence:70},"American Cricket":{tolerancePx:15,requiredTargets:["20","19","18","17","16","15","BULL"],criticalZones:["20","15","BULL"],minConfidence:70},"Around the Clock":{tolerancePx:12,requiredTargets:["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20"],criticalZones:["1","20","6","15"],minConfidence:78},Shanghai:{tolerancePx:13,requiredTargets:["1","2","3","4","5","6","7","SINGLE","DOUBLE","TREBLE"],criticalZones:["1","7","S1","D1","T1"],minConfidence:75},"High Score":{tolerancePx:14,requiredTargets:["TREBLE","DOUBLE","BULL"],criticalZones:["T20","BULL","D20"],minConfidence:72},"Low Score":{tolerancePx:11,requiredTargets:["SINGLE"],criticalZones:["1","2","3"],minConfidence:76},"Count-Up":{tolerancePx:13,requiredTargets:["SINGLE","DOUBLE","TREBLE"],criticalZones:["20","DOUBLE","TREBLE"],minConfidence:74},"Halve It":{tolerancePx:12,requiredTargets:["TREBLE","SINGLE"],criticalZones:["T20","T5","SINGLE"],minConfidence:73},"High-Low":{tolerancePx:13,requiredTargets:["SINGLE","DOUBLE","BULL"],criticalZones:["HIGH (>10)","LOW (<5)","BULL"],minConfidence:72},Killer:{tolerancePx:12,requiredTargets:["ALL_NUMBERS"],criticalZones:["RANDOM_TARGETS"],minConfidence:74},Baseball:{tolerancePx:14,requiredTargets:["1-9","SINGLE","DOUBLE","TREBLE"],criticalZones:["1","9","TRIPLE"],minConfidence:71},Golf:{tolerancePx:14,requiredTargets:["1-18","TREBLE"],criticalZones:["T1","T18"],minConfidence:71},"Tic Tac Toe":{tolerancePx:16,requiredTargets:["1-9","SINGLE"],criticalZones:["CENTER","CORNERS"],minConfidence:68},"Bob's 27":{tolerancePx:13,requiredTargets:["SINGLE","DOUBLE"],criticalZones:["1-20","BULL"],minConfidence:73},Scam:{tolerancePx:14,requiredTargets:["ALL_NUMBERS","OUTER_BULL"],criticalZones:["TARGET_NUMBER","OUTER_BULL"],minConfidence:70},Fives:{tolerancePx:14,requiredTargets:["ALL_NUMBERS","OUTER_BULL"],criticalZones:["5","10","15","20"],minConfidence:70},Sevens:{tolerancePx:14,requiredTargets:["ALL_NUMBERS","OUTER_BULL"],criticalZones:["7","14"],minConfidence:70}};function ka(r,t){if(!t||t<0)return 0;const n=Ca[r];if(!n)return 50;if(t<=n.tolerancePx)return Math.min(100,100-t/n.tolerancePx*20);{const a=t-n.tolerancePx;return Math.max(0,50-a*2)}}function Ju(r,t){if(!t)return!1;const n=Ca[r];return n?ka(r,t)>=n.minConfidence:!0}function Id(r,t){if(!t)return{quality:"none",text:"Not calibrated"};const n=ka(r,t);return n>=90?{quality:"excellent",text:`Excellent (${Math.round(n)}%)`}:n>=75?{quality:"good",text:`Good (${Math.round(n)}%)`}:n>=50?{quality:"fair",text:`Fair (${Math.round(n)}%)`}:{quality:"poor",text:`Poor (${Math.round(n)}%)`}}function Yu(r){const t=Ca[r];return!t||t.criticalZones.length===0?null:`Recalibrate focusing on: ${t.criticalZones.join(", ")}`}const Md="daviesfamily108@gmail.com";function Pd({user:r}){const t=(()=>{try{return vr()}catch{return null}})(),[n,a]=f.useState([]),[s,o]=f.useState(""),[c,i]=f.useState(""),[h,l]=f.useState("USD"),[u,m]=f.useState(""),[d,v]=f.useState(""),[x,y]=f.useState(!1),[w,C]=f.useState([]),[N]=f.useState([]),[P,S]=f.useState(""),[M,T]=f.useState([]),[p,k]=f.useState({title:"Official Tournament",game:"X01",mode:"bestof",value:3,description:"",startAt:new Date(Date.now()+7200*1e3).toISOString().slice(0,16),checkinMinutes:30,capacity:16,prizeType:"premium",prizeAmount:3,currency:"GBP",prizeNotes:""}),[z,W]=f.useState({reset:{},reminder:{},confirmEmail:{},changed:{}}),[ee,Q]=f.useState({open:!1}),[K,le]=f.useState("general"),ie=r?.email?.toLowerCase()===Md,[L]=f.useState([]),[Y]=f.useState([]),[$,B]=f.useState([]),[H,fe]=f.useState({}),[Ye,Ce]=f.useState(null),[,Ve]=f.useState([]),[Le,Nt]=f.useState(null),[St,zt]=f.useState(!1),[He,Ie]=f.useState(1500),[,Mt]=f.useState(!1),Pt=async()=>{y(!0);try{const b={"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("authToken")}`};(await fetch("/api/admin/tournaments/broadcast",{method:"POST",headers:b})).ok?at("Tournaments broadcast triggered",{type:"success"}):at("Broadcast failed",{type:"error"})}catch{at("Broadcast request failed",{type:"error"})}finally{y(!1)}},[Qt,Wt]=f.useState(0);f.useEffect(()=>{const b=()=>Wt(F=>F+1);return window.addEventListener("ndn:stats-updated",b),()=>window.removeEventListener("ndn:stats-updated",b)},[]);const Ue=f.useMemo(()=>ci(so),[Qt]),st=pn(),at=dd();f.useEffect(()=>{if(!ee.open)return;function b(F){F.key==="Escape"&&Q({open:!1})}return document.addEventListener("keydown",b),()=>document.removeEventListener("keydown",b)},[ee.open]);const ze=f.useMemo(()=>{const b=st.errorPx??null,F=[];for(const re of so){const Se=ka(re,b),Ne=Id(re,b);F.push({game:re,confidence:Se,qualityInfo:Ne})}return F},[st.errorPx]),ut=f.useMemo(()=>{const b=[];if(Ue&&typeof Ue=="object")for(const[F,re]of Object.entries(Ue)){const Se=re;b.push({label:F,value:Se?.played||0,won:Se?.won||0})}return b},[Ue]);async function Pe(){try{const b={Authorization:`Bearer ${localStorage.getItem("authToken")}`},[F,re,Se]=await Promise.all([fetch("/api/admin/help-requests",{headers:b}),fetch("/api/admins",{headers:b}),fetch("/api/tournaments",{headers:b})]);if(F.ok){const Ne=await F.json();B(Array.isArray(Ne)?Ne:Ne.requests||[])}if(re.ok){const Ne=await re.json();a(Array.isArray(Ne)?Ne:Ne.admins||[])}if(Se.ok){const Ne=await Se.json();C(Array.isArray(Ne)?Ne:Ne.tournaments||Ne)}}catch(b){console.error("refresh failed",b)}}async function Ge(b){try{await fetch("/api/admins/revoke",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("authToken")}`},body:JSON.stringify({email:b})}),await Pe()}catch{}}async function Me(b,F){if(b)try{await fetch("/api/admin/premium/grant",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("authToken")}`},body:JSON.stringify({email:b,days:F})}),await Pe()}catch{}}async function ln(b){try{await fetch("/api/admin/premium/revoke",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("authToken")}`},body:JSON.stringify({email:b})}),await Pe()}catch{}}async function Ze(){if(d.trim())try{await fetch("/api/admin/announce",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("authToken")}`},body:JSON.stringify({message:d})}),v(""),await Pe()}catch{}}async function xe(b){try{await fetch("/api/admin/maintenance",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("authToken")}`},body:JSON.stringify({maintenance:b})}),await Pe()}catch{}}f.useEffect(()=>{if(!t)return;const b=t.addListener(re=>{try{if(re?.type==="help-typing"){const Se=String(re.requestId||"");if(!Se)return;fe(Ne=>({...Ne,[Se]:{who:re.fromName||"someone",ts:Date.now()}}));return}if(re?.type==="help-request"){const Se=re.request;if(!Se||!Se.id)return;B(Ne=>{const yt=(Ne||[]).filter(Te=>String(Te.id)!==String(Se.id));return[Se,...yt]});return}re?.type==="help-request-updated"&&Pe()}catch{}}),F=setInterval(()=>{const re=Date.now();let Se=!1;const Ne={...H};for(const yt of Object.keys(Ne))re-Ne[yt].ts>3500&&(delete Ne[yt],Se=!0);Se&&fe(Ne)},1500);return()=>{try{b()}catch{}clearInterval(F)}},[t]);async function ne(b){try{const F={"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("authToken")}`};(await fetch(`/api/admin/help-requests/${encodeURIComponent(b)}/claim`,{method:"POST",headers:F,body:JSON.stringify({})})).ok&&await Pe()}catch{}}async function ke(b){try{const F={"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("authToken")}`};(await fetch(`/api/admin/help-requests/${encodeURIComponent(b)}/resolve`,{method:"POST",headers:F,body:JSON.stringify({})})).ok&&await Pe()}catch{}}async function je(){u&&(await fetch("/api/admins/grant",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("authToken")}`},body:JSON.stringify({email:u})}),m(""))}async function _e(){if(P.trim())try{const b={Authorization:`Bearer ${localStorage.getItem("authToken")}`},F=await fetch(`/api/admin/users/search?q=${encodeURIComponent(P)}`,{headers:b});if(F.ok){const re=await F.json();T(Array.isArray(re.users)?re.users:[])}}catch(b){console.error("Search failed:",b)}}async function Ee(b){try{await fetch("/api/admin/users/ban",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("authToken")}`},body:JSON.stringify({email:b})}),await _e()}catch(F){console.error("Ban failed:",F)}}async function be(b){try{await fetch("/api/admin/users/unban",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("authToken")}`},body:JSON.stringify({email:b})}),await _e()}catch(F){console.error("Unban failed:",F)}}async function Xe(){y(!0);try{const b=new Date(p.startAt).getTime(),F=await fetch("/api/tournaments/create",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:p.title,game:p.game,mode:p.mode,value:Number(p.value),description:p.description,startAt:b,checkinMinutes:Number(p.checkinMinutes),capacity:Number(p.capacity),requireCalibration:!!p.requireCalibration,creatorEmail:r?.email,creatorName:r?.username,requesterEmail:r?.email,official:!0,prizeType:p.prizeType,prizeAmount:Number(p.prizeAmount||0),currency:p.currency,prizeNotes:p.prizeNotes})});await Pe();try{const re=await F.json();re&&re.tournament&&re.tournament.id&&window.dispatchEvent(new CustomEvent("ndn:change-tab",{detail:{tab:"tournaments"}}))}catch{}}finally{y(!1)}}async function de(b,F){y(!0);try{await fetch("/api/admin/tournaments/winner",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("authToken")}`},body:JSON.stringify({tournamentId:b,winnerEmail:F})}),await Pe()}finally{y(!1)}}async function xn(b){y(!0);try{await fetch("/api/admin/tournaments/mark-paid",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("authToken")}`},body:JSON.stringify({tournamentId:b})}),await Pe()}finally{y(!1)}}async function qt(b){y(!0);try{await fetch("/api/admin/tournaments/delete",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("authToken")}`},body:JSON.stringify({tournamentId:b})}),await Pe()}finally{y(!1)}}async function _t(){y(!0);try{await fetch("/api/admin/tournaments/reseed-weekly",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("authToken")}`},body:JSON.stringify({})}),await Pe()}finally{y(!1)}}async function Ft(b,F){y(!0);try{await fetch("/api/admin/wallet/withdrawals/decide",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("authToken")}`},body:JSON.stringify({id:b,approve:F})}),await Pe()}finally{y(!1)}}async function Ht(b){y(!0);try{await fetch("/api/admin/matches/delete",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("authToken")}`},body:JSON.stringify({matchId:b})}),await Pe()}finally{y(!1)}}async function Nn(){try{const b={Authorization:`Bearer ${localStorage.getItem("authToken")}`},F=await fetch("/api/admin/logs",{headers:b});if(F.ok){const re=await F.json();re?.ok&&Ve(re.logs||[])}}catch(b){console.error("Failed to fetch logs:",b)}}async function en(){try{const b={Authorization:`Bearer ${localStorage.getItem("authToken")}`},F=await fetch("/api/admin/system-health",{headers:b});if(F.ok){const re=await F.json();re?.ok&&re?.health&&(Nt({database:re.health.database||!1,websocket:re.health.websocket||!1,https:re.health.https||!1,maintenance:re.health.maintenance||!1,clustering:re.health.clustering||!1,uptime:re.health.uptime||0,memory:re.health.memory||{heapUsed:0},version:re.health.version||"unknown"}),zt(re.health?.clustering||!1))}}catch(b){console.error("Failed to fetch system health:",b)}}async function Tt(b){y(!0);try{const re=await(await fetch("/api/admin/clustering",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("authToken")}`},body:JSON.stringify({enabled:b,maxWorkers:4,capacity:He})})).json();console.log("Clustering response:",re),re?.ok?(alert(`Clustering ${b?"enabled":"disabled"} successfully. Max capacity: ${He.toLocaleString()} concurrent users. NODE_WORKERS environment variable is set to max capacity.`),await en()):alert(`Failed: ${re?.error||re?.message||"Unknown error"}`)}catch(F){console.error("Clustering toggle failed:",F),alert("Clustering toggle failed: "+(F instanceof Error?F.message:String(F)))}finally{y(!1)}}async function ot(b){Ie(b)}async function mt(){try{const b={Authorization:`Bearer ${localStorage.getItem("authToken")}`},F=await fetch("/api/admin/email-copy",{headers:b});if(F.ok){const re=await F.json();re?.ok&&W(re.copy||z)}}catch{}}f.useEffect(()=>{ie&&mt()},[ie]),f.useEffect(()=>{ie&&(K==="general"||K==="maintenance")&&(Nn(),en())},[ie,K]);async function vt(b,F){await fetch("/api/admin/email-copy",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("authToken")}`},body:JSON.stringify({kind:b,...F})}),await mt()}async function Gt(b,F){try{const re={Authorization:`Bearer ${localStorage.getItem("authToken")}`},Ne=await(await fetch(`/api/email/preview?kind=${encodeURIComponent(b)}`,{headers:re})).text();if(F){const yt=window.open();if(yt){yt.document.open(),yt.document.write(Ne),yt.document.close();return}}Q({open:!0,kind:b,html:Ne})}catch{Q({open:!0,kind:b,html:'<!doctype html><html><body style="font-family:sans-serif;padding:16px">Failed to load preview.</body></html>'})}}f.useEffect(()=>{if(!ee.open)return;function b(F){F.key==="Escape"&&Q({open:!1})}return document.addEventListener("keydown",b),()=>document.removeEventListener("keydown",b)},[ee.open]);function bn({kind:b,label:F}){const Se=z?.[b==="confirm-email"?"confirmEmail":b==="changed"?"changed":b]||{title:"",intro:"",buttonLabel:""},[Ne,yt]=f.useState(Se.title||""),[Te,tn]=f.useState(Se.intro||""),[nn,Jt]=f.useState(Se.buttonLabel||"");return f.useEffect(()=>{yt(Se.title||""),tn(Se.intro||""),Jt(Se.buttonLabel||"")},[Se.title,Se.intro,Se.buttonLabel]),e.jsxs("div",{className:"p-2 rounded bg-black/20 space-y-2",children:[e.jsx("div",{className:"font-semibold",children:F}),e.jsx("input",{className:"input w-full",placeholder:"Title (optional)",value:Ne,onChange:ht=>yt(ht.target.value)}),e.jsx("textarea",{className:"input w-full",rows:2,placeholder:"Intro line (optional)",value:Te,onChange:ht=>tn(ht.target.value)}),e.jsx("input",{className:"input w-full",placeholder:"Button label (optional)",value:nn,onChange:ht=>Jt(ht.target.value)}),e.jsxs("div",{className:"flex gap-2 justify-end",children:[e.jsx("button",{className:"btn",type:"button",onClick:()=>Gt(b,!0),children:"Preview"}),e.jsx("button",{className:"btn",type:"button",onClick:()=>Gt(b),children:"Popup"}),e.jsx("button",{className:"btn",onClick:()=>vt(b,{title:Ne,intro:Te,buttonLabel:nn}),children:"Save"})]})]})}return ie?($.length>0&&($.length,$.slice(0,6).map(b=>e.jsxs("div",{className:"p-2 rounded bg-black/10 border border-white/10 min-w-[220px]",children:[e.jsx("div",{className:"font-medium",children:b.username||"Anonymous"}),e.jsx("div",{className:"text-xs opacity-70",children:new Date(b.ts||0).toLocaleTimeString()}),e.jsx("div",{className:"text-sm truncate mt-1",children:b.message}),e.jsxs("div",{className:"mt-2 flex gap-2",children:[b.status==="open"?e.jsx("button",{className:"btn",onClick:()=>ne(b.id),children:"Claim"}):e.jsxs("span",{className:"text-xs opacity-70",children:[b.status," by ",b.claimedBy||"—"]}),e.jsx("button",{className:"btn",onClick:()=>Ce(b),children:"Chat"})]})]},b.id))),e.jsxs("div",{className:"space-y-4 ndn-game-shell",children:[e.jsxs("div",{className:"card p-2 rounded-xl bg-white/10 border border-white/10 flex items-center justify-between gap-2 flex-wrap",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx("span",{className:"font-semibold",children:"Connection Status"}),t?e.jsxs("span",{className:"inline-flex items-center gap-2",children:[e.jsx(li,{status:t.status,title:`WebSocket: ${t.status}`}),e.jsxs("span",{className:"text-xs opacity-80",children:["WS: ",t.status]})]}):e.jsx("span",{className:"text-xs opacity-70",children:"WS: unavailable"})]}),e.jsxs("div",{className:"shrink-0 flex items-center gap-2",children:[e.jsx(di,{}),t&&t.reconnect&&e.jsx("button",{onClick:()=>t.reconnect(),className:"ml-1 rounded-md bg-neutral-700/60 hover:bg-neutral-600/70 px-2.5 py-1 text-xs border border-white/10",title:"Force close and recreate the WebSocket connection",children:"Recreate WS"})]})]}),ie&&e.jsx(hd,{tabs:[{key:"general",label:"General"},{key:"maintenance",label:"Maintenance"},{key:"premium",label:"Premium"},{key:"tourneys",label:"Tourneys"},{key:"helpdesk",label:"Help Desk"}],active:K,onChange:b=>le(b),className:"mb-4"})," ",K==="general"&&e.jsxs(e.Fragment,{children:[ie&&e.jsxs("div",{className:"card",children:[e.jsx("h3",{className:"text-xl font-semibold mb-2",children:"Game Usage"}),e.jsxs("div",{className:"rounded-xl border border-indigo-500/40 bg-indigo-500/10 p-3",children:[e.jsx(md,{data:ut.map(b=>({label:"",value:b.value}))}),e.jsx("div",{className:"mt-2 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-2 text-[11px] opacity-80",children:ut.map((b,F)=>e.jsxs("div",{className:"flex items-center justify-between px-2 py-1 rounded-md bg-white/5 border border-white/10",children:[e.jsx("span",{className:"truncate mr-2",children:b.label}),e.jsxs("span",{className:"whitespace-nowrap",children:["Played ",b.value," · Won ",b.won]})]},F))})]})]}),ie&&e.jsxs("div",{className:"card",children:[e.jsx("h3",{className:"text-xl font-semibold mb-2",children:"Calibration Quality Status"}),e.jsx("div",{className:"text-sm opacity-80 mb-3",children:"Camera calibration confidence by game mode. Shows current system calibration readiness for each game."}),e.jsx("div",{className:"rounded-xl border border-amber-500/40 bg-amber-500/5 p-3",children:e.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-2 text-[11px]",children:ze.map(b=>{const F=b.confidence>=85?"bg-emerald-500/20 border-emerald-500/40 text-emerald-200":b.confidence>=70?"bg-amber-500/20 border-amber-500/40 text-amber-200":"bg-rose-500/20 border-rose-500/40 text-rose-200";return e.jsxs("div",{className:`px-2 py-2 rounded-md border ${F}`,children:[e.jsx("div",{className:"font-semibold text-xs truncate",children:b.game}),e.jsx("div",{className:"text-[10px] opacity-80 truncate",children:b.qualityInfo.quality}),e.jsxs("div",{className:"text-[10px] font-mono mt-0.5",children:[Math.round(b.confidence),"%"]})]},b.game)})})})]}),e.jsxs("div",{className:"card",children:[e.jsx("h2",{className:"text-2xl font-bold mb-2",children:"Admin Control"}),e.jsx("div",{className:"text-sm opacity-80 mb-3",children:"Grant or revoke Admin to trusted users. Only the owner can perform these actions."}),e.jsxs("div",{className:"flex gap-2 mb-3",children:[e.jsx("input",{className:"input flex-1",placeholder:"user@example.com",value:u,onChange:b=>m(b.target.value)}),e.jsx("button",{className:"btn",disabled:x,onClick:je,children:"Grant"}),e.jsx("button",{className:"btn bg-rose-600 hover:bg-rose-700",disabled:x,onClick:()=>Ge(u),children:"Revoke"})]}),e.jsx("div",{className:"text-sm opacity-80 mb-2",children:"Current Admins:"}),e.jsx("div",{className:"flex flex-wrap gap-2 mb-4",children:n.map(b=>e.jsx("div",{className:"px-2 py-1 rounded bg-indigo-600/20 border border-indigo-500/40 text-sm",children:b},b))}),e.jsx("hr",{className:"border-indigo-500/20 my-4"}),e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"Premium Access Control"}),e.jsx("div",{className:"text-sm opacity-80 mb-3",children:"Grant or revoke Premium subscription access to users (grants 30 days)."}),e.jsxs("div",{className:"flex gap-2 mb-3",children:[e.jsx("input",{className:"input flex-1",placeholder:"user@example.com",value:u,onChange:b=>m(b.target.value)}),e.jsx("button",{className:"btn bg-emerald-600 hover:bg-emerald-700",disabled:x||!u.trim(),onClick:()=>Me(u,30),children:"Grant Premium"}),e.jsx("button",{className:"btn bg-rose-600 hover:bg-rose-700",disabled:x,onClick:()=>ln(u),children:"Revoke Premium"})]}),e.jsx("div",{className:"text-sm opacity-80",children:"Premium grants provide 30 days of unlimited access to all features."})]}),e.jsxs("div",{className:"card",children:[e.jsx("h3",{className:"text-xl font-semibold mb-2",children:"Announcements"}),e.jsx("div",{className:"text-sm opacity-80 mb-2",children:"Send a message to all users. This will appear as a toast notification."}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{className:"input flex-1",placeholder:"Announcement message...",value:d,onChange:b=>v(b.target.value)}),e.jsx("button",{className:"btn",disabled:x||!d.trim(),onClick:Ze,children:"Send"})]})]}),e.jsxs("div",{className:"card",children:[e.jsx("h3",{className:"text-xl font-semibold mb-2",children:"User Search"}),e.jsx("div",{className:"text-sm opacity-80 mb-2",children:"Search for users by email or name."}),e.jsxs("div",{className:"flex gap-2 mb-3",children:[e.jsx("input",{className:"input flex-1",placeholder:"Search users...",value:P,onChange:b=>S(b.target.value)}),e.jsx("button",{className:"btn",disabled:x,onClick:_e,children:"Search"})]}),M.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-sm opacity-80 mb-2",children:"Results:"}),M.map(b=>e.jsx("div",{className:"p-2 rounded bg-black/20 text-sm flex items-center justify-between",children:e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold",children:b.name||"No name"}),e.jsx("div",{className:"opacity-70",children:b.email}),e.jsxs("div",{className:"opacity-60 text-xs",children:["Joined ",new Date(b.createdAt).toLocaleDateString()]})]})},b.email))]})]}),ie&&e.jsxs("div",{className:"card",children:[e.jsx("h3",{className:"text-xl font-semibold mb-3",children:"Email Templates"}),e.jsx("div",{className:"text-sm opacity-80 mb-2",children:"Customize titles, intro lines, and button text. Previews open in a new tab or as a popup."}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[e.jsx(bn,{kind:"reset",label:"Password reset"}),e.jsx(bn,{kind:"reminder",label:"Password reset reminder"}),e.jsx(bn,{kind:"confirm-email",label:"Confirm new email"}),e.jsx(bn,{kind:"changed",label:"Password changed notice"})]})]})]}),K==="maintenance"&&ie&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"card",children:[e.jsx("h3",{className:"text-xl font-semibold mb-2",children:"User Management"}),e.jsx("div",{className:"text-sm opacity-80 mb-2",children:"Ban or unban users. Use with caution."}),e.jsxs("div",{className:"flex gap-2 mb-3",children:[e.jsx("input",{className:"input flex-1",placeholder:"user@example.com",value:P,onChange:b=>S(b.target.value)}),e.jsx("button",{className:"btn",disabled:x,onClick:_e,children:"Search"})]}),M.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-sm opacity-80 mb-2",children:"Results:"}),M.map(b=>e.jsxs("div",{className:"p-2 rounded bg-black/20 text-sm flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold",children:b.name||"No name"}),e.jsx("div",{className:"opacity-70",children:b.email}),e.jsxs("div",{className:"opacity-60 text-xs",children:["Joined ",new Date(b.createdAt).toLocaleDateString()]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{className:"btn bg-red-600 hover:bg-red-700 text-xs",onClick:()=>Ee(b.email),children:"Ban"}),e.jsx("button",{className:"btn bg-green-600 hover:bg-green-700 text-xs",onClick:()=>be(b.email),children:"Unban"})]})]},b.email))]})]}),e.jsxs("div",{className:"card",children:[e.jsx("h3",{className:"text-xl font-semibold mb-3",children:"Withdrawals"}),e.jsxs("ul",{className:"space-y-2",children:[N.map(b=>e.jsxs("li",{className:"p-2 rounded bg-black/20 text-sm flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-mono text-xs",children:b.id}),e.jsxs("div",{children:[b.email," · ",b.currency," ",(b.amountCents/100).toFixed(2)]}),e.jsxs("div",{className:"opacity-70",children:[b.status," · ",new Date(b.requestedAt).toLocaleString()]})]}),e.jsx("div",{className:"flex gap-2",children:b.status==="pending"&&e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"btn bg-emerald-600 hover:bg-emerald-700",disabled:x,onClick:()=>Ft(b.id,!0),children:"Approve"}),e.jsx("button",{className:"btn bg-rose-600 hover:bg-rose-700",disabled:x,onClick:()=>Ft(b.id,!1),children:"Reject"})]})})]},b.id)),N.length===0&&e.jsx("li",{className:"opacity-60",children:"No withdrawal requests."})]})]}),e.jsxs("div",{className:"card",children:[e.jsx("h3",{className:"text-xl font-semibold mb-3",children:"System Health"}),e.jsx("div",{className:"text-sm opacity-80 mb-3",children:"Current status of system components and services."}),Le?e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{children:"Database"}),e.jsx("span",{className:`px-2 py-1 rounded text-xs ${Le.database?"bg-emerald-600":"bg-red-600"}`,children:Le.database?"Ready":"Down"})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{children:"WebSocket"}),e.jsx("span",{className:`px-2 py-1 rounded text-xs ${Le.websocket?"bg-emerald-600":"bg-red-600"}`,children:Le.websocket?"Ready":"Down"})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{children:"HTTPS"}),e.jsx("span",{className:`px-2 py-1 rounded text-xs ${Le.https?"bg-emerald-600":"bg-amber-600"}`,children:Le.https?"Enabled":"HTTP Only"})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{children:"Maintenance Mode"}),e.jsx("span",{className:`px-2 py-1 rounded text-xs ${Le.maintenance?"bg-red-600":"bg-emerald-600"}`,children:Le.maintenance?"Active":"Normal"})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{children:"Clustering (Auto-Scaling)"}),e.jsx("span",{className:`px-2 py-1 rounded text-xs ${St?"bg-emerald-600":"bg-amber-600"}`,children:St?"Enabled":"Disabled"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"text-sm",children:[e.jsx("span",{className:"font-semibold",children:"Uptime:"})," ",Math.floor(Le.uptime/3600),"h"," ",Math.floor(Le.uptime%3600/60),"m"]}),e.jsxs("div",{className:"text-sm",children:[e.jsx("span",{className:"font-semibold",children:"Memory:"})," ",Le.memory?Math.round(Le.memory.heapUsed/1024/1024):"?","MB used"]}),e.jsxs("div",{className:"text-sm",children:[e.jsx("span",{className:"font-semibold",children:"Version:"})," ",Le.version]}),e.jsxs("div",{className:"flex gap-2 flex-wrap",children:[e.jsx("button",{className:"btn",onClick:en,children:"Refresh"}),e.jsxs("button",{className:`btn ${St?"bg-amber-600 hover:bg-amber-700":"bg-emerald-600 hover:bg-emerald-700"}`,disabled:x,onClick:()=>Tt(!St),children:[St?"Disable":"Enable"," Clustering"]})]})]})]}):e.jsxs("div",{className:"text-center py-4",children:[e.jsx("div",{className:"text-sm opacity-60 mb-2",children:"Loading system health..."}),e.jsx("button",{className:"btn",onClick:en,children:"Load Health Status"})]}),e.jsxs("div",{className:"mt-4 pt-4 border-t border-white/10",children:[e.jsx("h4",{className:"font-semibold mb-3",children:"Clustering Capacity"}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("label",{className:"font-semibold",children:"Max Concurrent Users"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{className:"btn",onClick:()=>Mt(!1),children:"Close"}),e.jsx("button",{className:"btn",onClick:Pt,disabled:!ie||x,children:"Force broadcast"})]})]}),e.jsx("input",{type:"range",min:"1500",max:"50000",step:"500",value:He,onChange:b=>ot(Number(b.target.value)),disabled:x,className:"w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed",style:{background:St?`linear-gradient(to right, #3b82f6 0%, #3b82f6 ${(He-1500)/48500*100}%, #374151 ${(He-1500)/48500*100}%, #374151 100%)`:"#374151"}}),e.jsxs("div",{className:"flex justify-between text-xs opacity-60 mt-1",children:[e.jsx("span",{children:"1.5k"}),e.jsx("span",{children:"50k"})]})]}),e.jsx("div",{className:"flex gap-2 flex-wrap",children:e.jsxs("button",{className:`btn ${St?"bg-amber-600 hover:bg-amber-700":"bg-emerald-600 hover:bg-emerald-700"}`,disabled:x,onClick:()=>Tt(!St),children:[St?"Disable":"Enable"," Clustering"]})})]}),e.jsxs("div",{className:"text-xs opacity-70 mt-2 p-2 bg-white/5 rounded",children:["💡 Clustering enables auto-scaling with capacity up to"," ",He.toLocaleString()," concurrent users. Adjust the slider to set maximum capacity. NODE_WORKERS environment variable is set to handle the configured load behind a reverse proxy."]})]})]}),e.jsxs("div",{className:"card",children:[e.jsx("h3",{className:"text-xl font-semibold mb-3",children:"User Reports"}),e.jsxs("ul",{className:"space-y-2",children:[Y.map(b=>e.jsx("li",{className:"p-2 rounded bg-black/20 text-sm",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-mono text-xs",children:b.id}),e.jsxs("div",{children:[e.jsx("span",{className:"font-semibold",children:b.reporter})," →"," ",e.jsx("span",{className:"font-semibold",children:b.offender})," ·"," ",new Date(b.ts).toLocaleString()]}),e.jsxs("div",{className:"opacity-80",children:["Reason: ",b.reason]}),b.messageId&&e.jsxs("div",{className:"opacity-60 text-xs",children:["Message ID: ",b.messageId]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("span",{className:`px-2 py-0.5 rounded text-xs ${b.status==="open"?"bg-amber-600":"bg-emerald-600"}`,children:b.status}),b.status==="open"&&e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"btn bg-emerald-600 hover:bg-emerald-700",disabled:x,onClick:async()=>{await fetch("/api/admin/reports/resolve",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("authToken")}`},body:JSON.stringify({id:b.id,action:"resolved"})}),await Pe()},children:"Resolve"}),e.jsx("button",{className:"btn bg-rose-600 hover:bg-rose-700",disabled:x,onClick:async()=>{const F=prompt("Enter notes for action taken (e.g., warning, block):")||"";await fetch("/api/admin/reports/resolve",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("authToken")}`},body:JSON.stringify({id:b.id,action:"actioned",notes:F})}),await Pe()},children:"Action"})]})]})]})},b.id)),Y.length===0&&e.jsx("li",{className:"opacity-60",children:"No reports."})]})]}),e.jsxs("div",{className:"card",children:[e.jsx("h3",{className:"text-xl font-semibold mb-3",children:"Open Matches"}),e.jsxs("ul",{className:"space-y-1",children:[(status?.matches||[]).map(b=>e.jsxs("li",{className:"flex items-center justify-between p-2 rounded bg-black/20 text-sm",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"font-mono text-xs",children:b.id}),e.jsx("span",{className:"opacity-80",children:b.creatorName}),e.jsxs("span",{className:"opacity-60",children:[b.game," ",ts(b.mode)," ",b.value," ",b.game==="X01"?`/${b.startingScore}`:""]})]}),e.jsx("button",{className:"btn bg-rose-600 hover:bg-rose-700",disabled:x,onClick:()=>Ht(b.id),children:"Remove"})]},b.id)),(!status?.matches||status.matches.length===0)&&e.jsx("li",{className:"text-sm opacity-60",children:"No open matches."})]})]}),e.jsxs("div",{className:"card",children:[e.jsx("h3",{className:"text-xl font-semibold mb-3",children:"Dangerous Operations"}),e.jsx("div",{className:"text-sm opacity-80 mb-3 text-red-400",children:"⚠️ These operations can cause data loss or service disruption. Use with extreme caution."}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold mb-2 text-red-400",children:"Tournament Deletion"}),e.jsxs("ul",{className:"space-y-2",children:[w.map(b=>e.jsxs("li",{className:"p-2 rounded bg-red-900/20 border border-red-500/40 text-sm",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"font-semibold",children:b.title}),e.jsx("div",{className:"opacity-70",children:b.status})]}),e.jsxs("div",{className:"opacity-80",children:[b.game," · ",ts(b.mode)," ",b.value]}),e.jsx("div",{className:"mt-2",children:e.jsx("button",{className:"btn bg-red-600 hover:bg-red-700 text-xs",disabled:x,onClick:()=>qt(b.id),children:"Delete Tournament"})})]},b.id)),w.length===0&&e.jsx("li",{className:"opacity-60",children:"No tournaments."})]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold mb-2 text-red-400",children:"System Maintenance"}),e.jsx("div",{className:"space-y-2",children:e.jsxs("div",{className:"p-3 rounded bg-red-900/20 border border-red-500/40",children:[e.jsx("div",{className:"font-semibold text-red-400 mb-2",children:"Maintenance Mode"}),e.jsx("div",{className:"text-sm opacity-80 mb-3",children:"Put the entire site into maintenance mode. Users won't be able to access games or create matches."}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:`px-2 py-1 rounded text-xs ${status?.maintenance?"bg-red-600":"bg-green-600"}`,children:status?.maintenance?"MAINTENANCE ACTIVE":"NORMAL OPERATION"}),e.jsx("button",{className:`btn ${status?.maintenance?"bg-green-600 hover:bg-green-700":"bg-red-600 hover:bg-red-700"}`,disabled:x,onClick:()=>xe(!status?.maintenance),children:status?.maintenance?"Disable":"Enable"})]})]})})]})]})]}),Ye&&e.jsx(ui,{request:Ye,user:{email:r?.email,username:r?.username,isAdmin:!0},onClose:()=>Ce(null)})]}),K==="premium"&&ie&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"card",children:[e.jsx("h3",{className:"text-xl font-semibold mb-2",children:"Premium Subscription Grants"}),e.jsx("div",{className:"text-sm opacity-80 mb-3",children:"Grant or revoke premium subscriptions for users (grants 30 days)."}),e.jsxs("div",{className:"flex gap-2 mb-3",children:[e.jsx("input",{className:"input flex-1",placeholder:"user@example.com",value:u,onChange:b=>m(b.target.value)}),e.jsx("button",{className:"btn",disabled:x||!u.trim(),onClick:()=>Me(u,30),children:"Grant"}),e.jsx("button",{className:"btn bg-rose-600 hover:bg-rose-700",disabled:x,onClick:()=>ln(u),children:"Revoke"})]}),e.jsx("div",{className:"text-sm opacity-80 mb-2",children:"Premium users get 30 days of access to all features."})]}),e.jsxs("div",{className:"card",children:[e.jsx("h3",{className:"text-xl font-semibold mb-2",children:"Premium Winners"}),e.jsx("div",{className:"text-sm opacity-80 mb-2",children:"Users who have won premium through tournaments."}),e.jsxs("div",{className:"space-y-2",children:[L.map(b=>e.jsxs("div",{className:"p-2 rounded bg-black/20 text-sm flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold",children:b.name||"No name"}),e.jsx("div",{className:"opacity-70",children:b.email}),e.jsxs("div",{className:"opacity-60 text-xs",children:["Expires ",new Date(b.expiresAt).toLocaleDateString()]})]}),e.jsx("div",{className:"flex gap-2",children:b.expired?e.jsx("span",{className:"px-2 py-1 rounded bg-amber-600 text-xs",children:"Premium Expired"}):e.jsx("span",{className:"px-2 py-1 rounded bg-emerald-600 text-xs",children:"Premium Active"})})]},b.email)),L.length===0&&e.jsx("div",{className:"opacity-60",children:"No premium winners."})]})]})]}),K==="tourneys"&&ie&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"card",children:[e.jsx("h3",{className:"text-xl font-semibold mb-3",children:"Create Official Tournament"}),e.jsx("div",{className:"text-sm opacity-80 mb-3",children:"Set up a new official tournament with custom rules, timing, and prizes."}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("input",{className:"input w-full",placeholder:"Tournament Title",value:p.title,onChange:b=>k(F=>({...F,title:b.target.value}))}),e.jsxs("div",{className:"grid grid-cols-3 gap-2",children:[e.jsx("select",{className:"input",value:p.game,onChange:b=>k(F=>({...F,game:b.target.value})),children:["X01","Around the Clock","Cricket","Halve It","Shanghai","High-Low"].map(b=>e.jsx("option",{value:b,children:b},b))}),e.jsx("select",{className:"input",value:p.mode,onChange:b=>k(F=>({...F,mode:b.target.value})),children:Sd(p.game).map(b=>e.jsx("option",{value:String(b),children:ts(String(b))},String(b)))}),(()=>{const b=Cd(p.game,p.mode);return b&&b.length>0?e.jsx("select",{className:"input",value:String(p.value),onChange:F=>k(re=>({...re,value:Number(F.target.value)})),children:b.map(F=>e.jsx("option",{value:String(F),children:F},F))}):e.jsx("input",{className:"input",type:"number",min:1,value:p.value,onChange:F=>k(re=>({...re,value:Number(F.target.value)}))})})()]}),e.jsx("textarea",{className:"input w-full",rows:2,placeholder:"Description",value:p.description,onChange:b=>k(F=>({...F,description:b.target.value}))}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx("input",{className:"input",type:"datetime-local",value:p.startAt,onChange:b=>k(F=>({...F,startAt:b.target.value}))}),e.jsx("input",{className:"input",type:"number",min:0,placeholder:"Checkin minutes",value:p.checkinMinutes,onChange:b=>k(F=>({...F,checkinMinutes:Number(b.target.value)}))})]}),e.jsx("input",{className:"input w-full",type:"number",min:6,max:64,placeholder:"Capacity",value:p.capacity,onChange:b=>k(F=>({...F,capacity:Number(b.target.value)}))}),e.jsxs("div",{className:"grid grid-cols-3 gap-2 items-center",children:[e.jsxs("select",{className:"input",value:p.prizeType,onChange:b=>{const F=b.target.value;k(re=>({...re,prizeType:F,prizeAmount:F==="premium"?3:0}))},children:[e.jsx("option",{value:"premium",children:"PREMIUM"}),e.jsx("option",{value:"cash",children:"Cash"})]}),p.prizeType==="premium"?e.jsxs("select",{className:"input",value:p.prizeAmount,onChange:b=>k(F=>({...F,prizeAmount:Number(b.target.value)})),children:[e.jsx("option",{value:1,children:"1 month"}),e.jsx("option",{value:3,children:"3 months"})]}):e.jsx("input",{className:"input",type:"number",min:0,value:p.prizeAmount,onChange:b=>k(F=>({...F,prizeAmount:Number(b.target.value)}))}),e.jsxs("select",{className:"input",disabled:p.prizeType!=="cash",value:p.currency,onChange:b=>k(F=>({...F,currency:b.target.value})),children:[e.jsx("option",{value:"GBP",children:"GBP"}),e.jsx("option",{value:"USD",children:"USD"}),e.jsx("option",{value:"EUR",children:"EUR"}),e.jsx("option",{value:"CAD",children:"CAD"}),e.jsx("option",{value:"AUD",children:"AUD"})]})]}),e.jsx("input",{className:"input w-full",placeholder:"Prize notes (optional)",value:p.prizeNotes,onChange:b=>k(F=>({...F,prizeNotes:b.target.value}))}),e.jsx("div",{className:"flex justify-end",children:e.jsx("button",{className:"btn bg-emerald-600 hover:bg-emerald-700",disabled:x,onClick:Xe,children:"Create Tournament"})})]})]}),e.jsxs("div",{className:"card",children:[e.jsx("h3",{className:"text-xl font-semibold mb-3",children:"Tournament Premium Winners"}),e.jsx("div",{className:"text-sm opacity-80 mb-3",children:"Users who have won premium prizes in tournaments. Grant them access here."}),e.jsxs("div",{className:"space-y-2",children:[w.filter(b=>b.status==="completed"&&b.winnerEmail&&b.prizeType==="premium").map(b=>{const F=L.find(Se=>Se.email===b.winnerEmail),re=F&&!F.expired;return e.jsxs("div",{className:"p-3 rounded bg-black/20 text-sm",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("div",{className:"font-semibold",children:b.title}),e.jsx("div",{className:"text-xs opacity-70",children:new Date(b.startAt).toLocaleDateString()})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:b.winnerEmail}),e.jsxs("div",{className:"text-xs opacity-70",children:["Prize: ",b.prizeAmount," month",b.prizeAmount>1?"s":""," PREMIUM"]})]}),e.jsx("div",{className:"flex items-center gap-2",children:re?e.jsx("span",{className:"px-2 py-1 rounded bg-emerald-600 text-xs",children:"✓ Access Granted"}):e.jsx("button",{className:"btn bg-emerald-600 hover:bg-emerald-700 text-xs",disabled:x,onClick:()=>Me(b.winnerEmail,b.prizeAmount*30),children:"Grant Access"})})]})]},b.id)}),w.filter(b=>b.status==="completed"&&b.winnerEmail&&b.prizeType==="premium").length===0&&e.jsx("div",{className:"text-center py-4 text-sm opacity-60",children:"No completed premium tournaments."})]})]}),e.jsxs("div",{className:"card",children:[e.jsx("h3",{className:"text-xl font-semibold mb-3",children:"Manage Tournaments"}),e.jsx("div",{className:"text-sm opacity-80 mb-3",children:"View and manage all tournaments. Set winners or mark payouts."}),e.jsxs("ul",{className:"space-y-2",children:[w.map(b=>e.jsxs("li",{className:"p-3 rounded bg-black/20 text-sm",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold",children:b.title}),e.jsxs("div",{className:"opacity-80",children:[b.game," · ",ts(b.mode)," ",b.value]})]}),e.jsx("div",{className:`px-2 py-1 rounded text-xs font-semibold ${b.status==="scheduled"?"bg-blue-600":b.status==="running"?"bg-green-600":b.status==="completed"?"bg-purple-600":"bg-gray-600"}`,children:b.status})]}),e.jsxs("div",{className:"text-xs opacity-70 mb-2",children:["Start: ",new Date(b.startAt).toLocaleString()," · Capacity:"," ",b.capacity]}),b.prize&&e.jsxs("div",{className:"text-xs mb-2",children:["Prize:"," ",b.prizeType==="cash"&&b.prizeAmount?`${b.currency||"USD"} ${b.prizeAmount}`:`${b.prizeAmount||3} month${(b.prizeAmount||3)>1?"s":""} PREMIUM`,b.prizeType==="cash"&&b.status==="completed"&&b.payoutStatus&&e.jsx("span",{className:`ml-2 px-1.5 py-0.5 rounded ${b.payoutStatus==="paid"?"bg-emerald-600":"bg-amber-600"}`,children:b.payoutStatus})]}),e.jsxs("div",{className:"mt-2 flex flex-wrap gap-2",children:[e.jsx("button",{className:"btn text-xs",disabled:x||b.status!=="scheduled",onClick:()=>de(b.id,prompt("Winner email?")||""),children:"Set Winner"}),b.prizeType==="cash"&&b.status==="completed"&&b.payoutStatus!=="paid"&&e.jsx("button",{className:"btn text-xs",disabled:x,onClick:()=>xn(b.id),children:"Mark Paid"}),e.jsx("button",{className:"btn text-xs",disabled:x,onClick:()=>_t(),children:"Reseed"})]})]},b.id)),w.length===0&&e.jsx("li",{className:"opacity-60",children:"No tournaments."})]})]})]}),K==="helpdesk"&&ie&&e.jsx(e.Fragment,{children:e.jsxs("div",{className:"card",children:[e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"Helpdesk Requests"}),e.jsx("div",{className:"text-sm opacity-80 mb-3",children:"All help requests from users who asked to speak with an admin. Status is shown for each request."}),$.length===0?e.jsx("div",{className:"text-sm opacity-70",children:"No help requests."}):e.jsx("div",{className:"space-y-2",children:$.map(b=>e.jsxs("div",{className:"p-2 rounded bg-black/10 border border-white/10 flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:b.username||"Anonymous"}),e.jsx("div",{className:"text-xs opacity-70",children:new Date(b.ts||0).toLocaleString()}),e.jsx("div",{className:"text-sm mt-1",children:b.message}),e.jsxs("div",{className:"mt-1",children:[e.jsx("span",{className:`text-xs px-2 py-1 rounded-full mr-2 ${b.status==="open"?"bg-emerald-700/30 text-emerald-200":b.status==="claimed"?"bg-amber-700/30 text-amber-200":"bg-slate-700/30 text-slate-200"}`,children:b.status||"unknown"}),b.claimedBy&&e.jsxs("span",{className:"text-xs opacity-70",children:["by ",b.claimedBy]})]}),H[b.id]&&e.jsxs("div",{className:"text-xs text-amber-300 mt-1",children:[H[b.id].who," typing..."]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[b.status==="open"&&e.jsx("button",{className:"btn",onClick:()=>ne(b.id),children:"Claim"}),b.status!=="resolved"&&e.jsx("button",{className:"btn btn-ghost",onClick:()=>ke(b.id),children:"Resolve"}),e.jsx("button",{className:"btn",onClick:()=>Ce(b),children:"Chat"})]})]},b.id))})]})}),ee.open&&e.jsxs("div",{className:"fixed inset-0 z-[1000]",onClick:()=>Q({open:!1}),children:[e.jsx("div",{className:"absolute inset-0 bg-black/70 backdrop-blur-sm"}),e.jsx("div",{className:"absolute inset-0 p-4 md:p-8 overflow-auto flex items-start md:items-center justify-center",children:e.jsxs("div",{className:"w-full max-w-3xl bg-[#0b1020] rounded-2xl border border-indigo-500/40 shadow-2xl",onClick:b=>b.stopPropagation(),children:[e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b border-indigo-500/20",children:[e.jsxs("div",{className:"font-semibold",children:["Preview: ",ee.kind]}),e.jsx("button",{className:"btn",onClick:()=>Q({open:!1}),children:"Close"})]}),e.jsx("div",{className:"p-0 bg-black/30",children:e.jsx("iframe",{title:"Email Preview",style:{width:"100%",height:"70vh",border:"0",background:"transparent"},srcDoc:ee.html||""})}),e.jsx("div",{className:"px-4 py-3 border-t border-indigo-500/20 text-xs opacity-70",children:"Click outside this panel or press Esc to close."})]})})]})]})):e.jsxs("div",{className:"card",children:[e.jsx("h2",{className:"text-2xl font-bold mb-2",children:"Admin"}),e.jsx("div",{className:"text-sm opacity-80",children:"You don’t have permission to manage admins."})]})}const mi=f.createContext(null),ns="ndn:theme";function oo(r=new Date){const t=r.getMonth(),n=r.getDate();return t===9||t===10&&n<=5?"halloween":t===11||t===0||t===1&&n<=14?"christmas":t===2||t===3?"easter":t>=5&&t<=7?"summer":"default"}function Td({children:r}){const[t,n]=f.useState(()=>{try{const i=localStorage.getItem(`${ns}:auto`);return i?JSON.parse(i):!0}catch{return!0}}),[a,s]=f.useState(()=>{try{const i=localStorage.getItem(ns);if(i)return i}catch{}return oo()});f.useEffect(()=>{try{localStorage.setItem(`${ns}:auto`,JSON.stringify(t))}catch{}},[t]),f.useEffect(()=>{const i=t?oo():a;try{i==="default"?document.documentElement.removeAttribute("data-theme"):document.documentElement.setAttribute("data-theme",i)}catch{}},[a,t]);const o=i=>{try{localStorage.setItem(ns,i)}catch{}s(i)},c=f.useMemo(()=>({theme:a,setTheme:o,auto:t,setAuto:n}),[a,t]);return e.jsx(mi.Provider,{value:c,children:r})}function Od(){const r=f.useContext(mi);if(!r)throw new Error("useTheme must be used inside ThemeProvider");return r}const Ad=["default","halloween","easter","summer","christmas"];function Rd(){const{theme:r,setTheme:t,auto:n,setAuto:a}=Od();return e.jsxs("div",{className:"theme-toggle",role:"group","aria-label":"Theme selector",children:[e.jsxs("label",{style:{display:"flex",alignItems:"center",gap:8},children:[e.jsx("input",{type:"checkbox",checked:n,onChange:s=>a(!!s.target.checked),"aria-checked":n}),e.jsx("span",{children:"Auto seasonal theme"})]}),e.jsx("div",{style:{marginTop:8,display:"flex",gap:8,flexWrap:"wrap"},children:Ad.map(s=>e.jsx("button",{onClick:()=>t(s),disabled:n,"aria-pressed":r===s,className:`btn btn-ghost theme-btn theme-${s}`,title:`Set ${s} theme`,children:s==="default"?"Default":s[0].toUpperCase()+s.slice(1)},s))})]})}function Dd({user:r}){const{favoriteDouble:t,callerEnabled:n,callerVoice:a,callerVolume:s,speakCheckoutOnly:o,avgMode:c,autoStartOffline:i,rememberLastOffline:h,reducedMotion:l,compactHeader:u,allowSpectate:m,cameraScale:d,cameraAspect:v,cameraFitMode:x,autoscoreProvider:y,autoscoreWsUrl:w,autoCommitMode:C,calibrationGuide:N,preferredCameraId:P,preferredCameraLabel:S,cameraEnabled:M,offlineLayout:T,textSize:p,boxSize:k,setFavoriteDouble:z,setCallerEnabled:W,setCallerVoice:ee,setCallerVolume:Q,setSpeakCheckoutOnly:K,setAvgMode:le,setAutoStartOffline:ie,setRememberLastOffline:L,setReducedMotion:Y,setCompactHeader:$,setAllowSpectate:B,setCameraScale:H,setCameraAspect:fe,setCameraFitMode:Ye,setAutoscoreProvider:Ce,setAutoscoreWsUrl:Ve,setAutoCommitMode:Le,setCalibrationGuide:Nt,preserveCalibrationOverlay:St,setPreserveCalibrationOverlay:zt,setPreferredCamera:He,setCameraEnabled:Ie,setOfflineLayout:Mt,setTextSize:Pt,setBoxSize:Qt,dartTimerEnabled:Wt,dartTimerSeconds:Ue,setDartTimerEnabled:st,setDartTimerSeconds:at,x01DoubleIn:ze,setX01DoubleIn:ut}=on(),[Pe,Ge]=f.useState([{key:"first180",label:"First 180",unlocked:!1,icon:"🎯",desc:"Score 180 in a match."},{key:"hundredGames",label:"100 Games Played",unlocked:!1,icon:"🏅",desc:"Play 100 games."},{key:"tournamentWin",label:"Tournament Winner",unlocked:!1,icon:"🥇",desc:"Win a tournament."},{key:"bestLeg",label:"Best Leg",unlocked:!1,icon:"⚡",desc:"Finish a leg in 12 darts or less."},{key:"comeback",label:"Comeback",unlocked:!1,icon:"🔥",desc:"Win after trailing by 3 legs."}]);f.useEffect(()=>{const I=r?.username||"";I&&Ge(ce=>ce.map(Re=>({...Re,unlocked:!!localStorage.getItem(`ndn:achieve:${Re.key}:${I}`)})))},[r?.username]),f.useEffect(()=>{function I(ce){try{Bt("user")}catch{}}return window.addEventListener("ndn:open-settings-profile",I),()=>window.removeEventListener("ndn:open-settings-profile",I)},[]);const[Me,ln]=f.useState(!1),[Ze,xe]=f.useState(""),[ne,ke]=f.useState(""),[je,_e]=f.useState(""),[Ee,be]=f.useState(""),[Xe,de]=f.useState(""),[xn,qt]=f.useState(!0),[_t,Ft]=f.useState(null),[Ht,Nn]=f.useState(null),[en,Tt]=f.useState([{text:"Hi! I'm your Nine Dart Nation assistant. How can I help you today?",isUser:!1}]),[ot,mt]=f.useState("");f.useEffect(()=>{const I=r?.username||"";if(I)try{xe(localStorage.getItem(`ndn:bio:favPlayer:${I}`)||""),ke(localStorage.getItem(`ndn:bio:favTeam:${I}`)||""),_e(localStorage.getItem(`ndn:bio:favDarts:${I}`)||""),be(localStorage.getItem(`ndn:bio:bio:${I}`)||""),de(localStorage.getItem(`ndn:bio:profilePhoto:${I}`)||""),qt(localStorage.getItem(`ndn:settings:allowAnalytics:${I}`)!=="false")}catch{}},[r?.username]),f.useEffect(()=>{r?.email&&(Gn(`/api/subscription?email=${encodeURIComponent(r.email)}`).then(I=>I.json()).then(Nn).catch(()=>{}),(async()=>{try{const I=localStorage.getItem("authToken"),ce={};I&&(ce.Authorization=`Bearer ${I}`);const Re=await fetch(`/api/wallet/balance?email=${encodeURIComponent(r.email)}`,{headers:ce});Re.ok&&Ft(await Re.json())}catch{}})())},[r?.email]);const vt=()=>{const I=r?.username||"";if(I)try{localStorage.setItem(`ndn:bio:favPlayer:${I}`,Ze),localStorage.setItem(`ndn:bio:favTeam:${I}`,ne),localStorage.setItem(`ndn:bio:favDarts:${I}`,je),localStorage.setItem(`ndn:bio:bio:${I}`,Ee),localStorage.setItem(`ndn:bio:profilePhoto:${I}`,Xe);try{window.dispatchEvent(new CustomEvent("ndn:avatar-updated",{detail:{username:I,avatar:Xe}}))}catch{}localStorage.setItem(`ndn:settings:allowAnalytics:${I}`,xn.toString()),ln(!1)}catch{}},Gt=I=>{try{window.dispatchEvent(new CustomEvent("ndn:change-tab",{detail:{tab:I}}))}catch(ce){console.error("Navigation failed:",ce)}},bn=I=>{const ce=I.toLowerCase();return ce.includes("username")||ce.includes("change name")?{text:"You can change your username once for free.",links:[{text:"Go to Settings > Account",tab:"settings"}]}:ce.includes("premium")||ce.includes("upgrade")||ce.includes("subscription")?{text:"Premium unlocks all game modes and features.",links:[{text:"Go to Online Play",tab:"online"}]}:ce.includes("calibrat")||ce.includes("camera")||ce.includes("vision")?{text:"Set up your camera properly in Settings.",links:[{text:"Go to Settings > Camera & Vision",tab:"settings"}]}:ce.includes("voice")||ce.includes("caller")||ce.includes("audio")?{text:"Enable voice calling in Settings.",links:[{text:"Go to Settings > Audio & Voice",tab:"settings"}]}:ce.includes("friend")||ce.includes("play together")?{text:"Add friends to play together.",links:[{text:"Go to Friends",tab:"friends"}]}:ce.includes("stat")||ce.includes("score")||ce.includes("performance")?{text:"View your statistics and performance.",links:[{text:"Go to Stats",tab:"stats"}]}:ce.includes("setting")||ce.includes("customiz")||ce.includes("configur")?{text:"Customize your experience.",links:[{text:"Go to Settings",tab:"settings"}]}:ce.includes("tournament")||ce.includes("competition")?{text:"Check out tournaments and competitions.",links:[{text:"Go to Tournaments",tab:"tournaments"}]}:ce.includes("help")||ce.includes("support")||ce.includes("faq")?{text:"You're already in the help section! Check the Support section above for more resources.",links:[{text:"Scroll to Support",tab:"settings"}]}:ce.includes("how to play")||ce.includes("game")||ce.includes("start")?{text:"To play darts, select a game mode from the menu. For online play, join a match. For offline, start a local game.",links:[{text:"Play Online",tab:"online"},{text:"Play Offline",tab:"offline"}]}:{text:"I'm not sure about that. Try asking about playing, calibration, premium, username changes, voice settings, friends, stats, or settings."}},b=()=>{if(!ot.trim())return;const I=ot.toLowerCase();Tt(Re=>[...Re,{text:ot,isUser:!0}]),mt("");const ce=bn(I);setTimeout(()=>{Tt(Re=>[...Re,{text:ce,isUser:!1}])},500)},[F,re]=f.useState(""),[Se,Ne]=f.useState(!1),[yt,Te]=f.useState(""),[tn,nn]=f.useState([]);f.useEffect(()=>{const I=()=>{const ce=speechSynthesis.getVoices();nn(ce.filter(Re=>Re.lang.startsWith("en")))};I(),speechSynthesis.onvoiceschanged=I},[]);const[Jt,ht]=f.useState(!1),[Ut,Bt]=f.useState(null),dn=({label:I,icon:ce,pill:Re,color:wt})=>e.jsxs("button",{onPointerDown:$t=>{$t.stopPropagation()},onMouseDown:$t=>{$t.stopPropagation()},onTouchStart:$t=>{$t.stopPropagation?.()},onClick:()=>Bt($t=>$t===Re?null:Re),type:"button","data-testid":`pill-button-${Re}`,className:`select-none whitespace-nowrap rounded-full px-4 py-2 text-sm font-semibold shadow-sm focus:outline-none focus-visible:ring-2 focus-visible:ring-white/60 active:scale-[0.98] bg-gradient-to-r ${wt} text-white flex items-center gap-2`,children:[e.jsx(ce,{className:"w-4 h-4"})," ",I,e.jsx(Pi,{className:`w-4 h-4 transition-transform ${Ut===Re?"rotate-180":""}`})]});return e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"relative rounded-xl bg-white/5 backdrop-blur-md border border-white/10 p-1",children:e.jsx("div",{className:"flex items-center gap-2 overflow-x-auto no-scrollbar py-1 px-1",children:e.jsx(dn,{label:"User Info",icon:as,pill:"user",color:"from-indigo-500 to-fuchsia-500 shadow-indigo-500/30"})})}),Ut==="user"&&e.jsx("div",{"data-testid":"pill-user-content",className:"p-6 rounded-2xl border border-white/10 bg-white/[0.02] space-y-4",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx("div",{className:"card",children:e.jsxs("div",{className:"p-3 rounded-xl border border-red-500/40 bg-red-500/10",children:[e.jsxs("div",{className:"font-semibold mb-4 flex items-center gap-2 text-red-100",children:[e.jsx(as,{className:"w-5 h-5"})," Account"]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex justify-center gap-2",children:[e.jsx("button",{onClick:()=>window.dispatchEvent(new CustomEvent("ndn:logout")),className:"px-6 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium transition-colors",children:"Logout"}),e.jsx("button",{onClick:()=>ht(!0),className:"px-4 py-2 bg-slate-700 hover:bg-slate-800 text-white rounded-lg font-medium transition-colors",children:"Highlights"})]}),e.jsxs("div",{className:"mt-4 border-t pt-3",children:[e.jsx("div",{className:"font-medium mb-2",children:"Wallet"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"text-sm opacity-80 mr-4",children:["Balance:"," ",e.jsx("strong",{children:_t&&_t.wallet&&Object.keys(_t.wallet.balances||{}).length>0?Object.entries(_t.wallet.balances).map(([I,ce])=>`${I} ${(ce/100).toFixed(2)}`).join(" • "):"0.00"})]}),e.jsx("input",{className:"input w-40",placeholder:"Withdraw amount",value:"",onChange:()=>{}}),e.jsxs("select",{className:"input",children:[e.jsx("option",{children:"USD"}),e.jsx("option",{children:"GBP"}),e.jsx("option",{children:"EUR"})]}),e.jsx("button",{className:"btn",onClick:async()=>{const I=r?.email||"";if(!I)return alert("Not signed in");const ce=prompt("Enter withdraw amount (e.g., 10.00)");if(ce)try{const Re=localStorage.getItem("authToken"),wt={"Content-Type":"application/json"};if(Re&&(wt.Authorization=`Bearer ${Re}`),!(await fetch("/api/wallet/withdraw",{method:"POST",headers:wt,body:JSON.stringify({email:I,amount:ce,currency:"USD"})})).ok)throw new Error("Failed");alert("Withdrawal requested")}catch{alert("Failed to request withdrawal")}},children:"Withdraw"})]})]}),e.jsxs("div",{className:"border-t border-red-500/20 pt-3",children:[e.jsxs("div",{className:"font-medium mb-2 text-red-100",children:["Change Username (",(()=>{const I=r?.usernameChangeCount||0;return I<2?`${2-I} free changes remaining`:"£2 per change"})(),")"]}),e.jsx("div",{className:"text-sm text-red-100 mb-2",children:"You can change your username up to 2 times for free. Additional changes cost £2 each."}),r?.usernameChangeCount>=2&&!F.trim()?e.jsx("div",{className:"text-amber-400 text-sm mb-2",children:"⚠️ Additional username changes cost £2"}):null,e.jsx("input",{className:"input w-full mb-2",type:"text",placeholder:"New username",value:F,onChange:I=>re(I.target.value),disabled:Se}),yt&&e.jsx("div",{className:"text-red-400 text-sm mb-2",children:yt}),e.jsx("button",{onClick:async()=>{if(Te(""),!F.trim()){Te("Username required");return}if(F.length<3||F.length>20){Te("Username must be 3-20 characters");return}(r?.usernameChangeCount||0)<2?(localStorage.setItem("pendingUsernameChange",F.trim()),window.location.href="/?username-change=free"):window.location.href="https://buy.stripe.com/eVq4gB3XqeNS0iw6vAfnO02"},disabled:Se||!F.trim(),className:"w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-600 text-white rounded-lg font-medium transition-colors",children:Se?"Processing...":(r?.usernameChangeCount||0)<2?"Change Username (FREE)":"Change Username (£2)"})]})]})]})}),Ht&&e.jsx("div",{className:"card",children:e.jsxs("div",{className:"p-3 rounded-xl border border-green-500/40 bg-green-500/10",children:[e.jsxs("div",{className:"font-semibold mb-4 flex items-center gap-2 text-green-100",children:[e.jsx(Mr,{className:"w-5 h-5"})," Premium"]}),e.jsxs("div",{className:"space-y-3 text-sm text-green-100",children:[e.jsxs("div",{children:["Status:"," ",e.jsx("span",{className:Ht?.status==="active"?"text-green-400":"text-yellow-400",children:Ht?.status==="active"?"✓ Active":"Not Active"})]}),Ht?.status==="active"&&Ht?.nextBillingDate&&e.jsxs("div",{children:["Next Billing:"," ",new Date(Ht.nextBillingDate).toLocaleDateString()]}),Ht?.source==="tournament"&&Ht?.status==="active"&&e.jsx("button",{onClick:()=>window.location.href="https://buy.stripe.com/eVq4gB3XqeNS0iw6vAfnO02",className:"w-full px-3 py-2 bg-red-600 hover:bg-red-700 text-white rounded font-medium transition-colors text-xs",children:"Cancel Subscription"})]})]})}),e.jsx("div",{className:"card",children:e.jsxs("div",{className:"p-3 rounded-xl border border-cyan-500/40 bg-cyan-500/10",children:[e.jsxs("div",{className:"font-semibold mb-4 flex items-center gap-2 text-cyan-100",children:[e.jsx(Ys,{className:"w-5 h-5"})," Profile Photo"]}),e.jsx("input",{type:"file",accept:"image/*",onChange:I=>{const ce=I.target.files?.[0];if(ce){const Re=new FileReader;Re.onload=()=>de(Re.result),Re.readAsDataURL(ce)}},className:"w-full text-xs text-slate-100"})]})}),e.jsx("div",{className:"card",children:e.jsxs("div",{className:"p-3 rounded-xl border border-purple-500/40 bg-purple-500/10",children:[e.jsxs("div",{className:"font-semibold mb-4 flex items-center gap-2 text-purple-100",children:[e.jsx(Tn,{className:"w-5 h-5"})," Online & Socials"]}),e.jsx("div",{className:"space-y-3",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{type:"checkbox",id:"allowSpectate",checked:m,onChange:I=>B(I.target.checked),className:"w-4 h-4"}),e.jsx("label",{htmlFor:"allowSpectate",className:"text-sm text-purple-100",children:"Allow spectators"})]})})]})}),e.jsx("div",{className:"card",children:e.jsxs("div",{className:"p-3 rounded-xl border border-orange-500/40 bg-orange-500/10",children:[e.jsxs("div",{className:"font-semibold mb-4 flex items-center gap-2 text-orange-100",children:[e.jsx(Mr,{className:"w-5 h-5"})," Data & Privacy"]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{type:"checkbox",id:"allowAnalytics",checked:xn,onChange:I=>qt(I.target.checked),className:"w-4 h-4"}),e.jsx("label",{htmlFor:"allowAnalytics",className:"text-sm text-orange-100",children:"Allow analytics"})]}),e.jsx("button",{onClick:()=>{const I={achievements:Pe,bio:{favPlayer:Ze,favTeam:ne,favDarts:je,bio:Ee}},ce=new Blob([JSON.stringify(I,null,2)],{type:"application/json"}),Re=URL.createObjectURL(ce),wt=document.createElement("a");wt.href=Re,wt.download=`my-data-${new Date().toISOString().split("T")[0]}.json`,wt.click(),URL.revokeObjectURL(Re)},className:"btn bg-orange-600 hover:bg-orange-700 w-full",children:"Export My Data"})]})]})}),e.jsx("div",{className:"card",children:e.jsxs("div",{className:"p-3 rounded-xl border border-red-500/40 bg-red-500/10",children:[e.jsxs("div",{className:"font-semibold mb-4 flex items-center gap-2",children:[e.jsx(Mr,{className:"w-5 h-5 text-red-400"})," Privacy & Copyright"]}),e.jsx("div",{className:"space-y-3 text-sm text-slate-300",children:e.jsxs("div",{className:"bg-red-500/20 border border-red-500/30 rounded-lg p-3",children:[e.jsx("p",{className:"font-semibold text-red-300 mb-2",children:"⚠️ Legal Notice"}),e.jsxs("p",{className:"mb-2 text-xs",children:[e.jsx("strong",{children:"Copyright:"})," All content is protected by copyright law."]}),e.jsxs("p",{className:"text-xs",children:[e.jsx("strong",{children:"Privacy:"})," Your data is protected and unauthorized access is prohibited."]})]})})]})}),e.jsx("div",{className:"card",children:e.jsxs("div",{className:"p-3 rounded-xl border border-yellow-500/40 bg-yellow-500/10",children:[e.jsxs("div",{className:"font-semibold mb-4 flex items-center gap-2 text-yellow-100",children:[e.jsx(Mr,{className:"w-5 h-5"})," Blocked Users"]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("p",{className:"text-sm text-yellow-100",children:"Manage players you've blocked from contacting you."}),e.jsx("button",{onClick:()=>window.dispatchEvent(new CustomEvent("ndn:open-blocklist")),className:"btn bg-yellow-600 hover:bg-yellow-700 w-full text-sm",children:"View Blocked Users"})]})]})}),e.jsx("div",{className:"card",children:e.jsxs("div",{className:"p-3 rounded-xl border border-blue-500/40 bg-blue-500/10",children:[e.jsxs("div",{className:"font-semibold mb-4 flex items-center gap-2 text-blue-100",children:[e.jsx(Tn,{className:"w-5 h-5"})," Contact & Support"]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("a",{href:"mailto:support@ninedartnation.com",className:"flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors text-sm",children:"📧 Email Support"}),e.jsx("a",{href:"https://ninedartnation.com/help",target:"_blank",rel:"noopener noreferrer",className:"flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors text-sm",children:"❓ Help Center"}),e.jsx("a",{href:"https://ninedartnation.com/faq",target:"_blank",rel:"noopener noreferrer",className:"flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors text-sm",children:"📋 FAQ"})]})]})}),e.jsx("div",{className:"card",children:e.jsxs("div",{className:"p-3 rounded-xl border border-red-500/40 bg-red-500/10",children:[e.jsxs("div",{className:"font-semibold mb-4 flex items-center gap-2 text-red-100",children:[e.jsx(Mr,{className:"w-5 h-5"})," Delete Account"]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"bg-red-500/20 border border-red-500/30 rounded-lg p-3 text-xs text-red-200",children:[e.jsx("p",{className:"font-semibold mb-1",children:"⚠️ Warning"}),e.jsx("p",{children:"Deleting your account is permanent and cannot be undone. All your stats, achievements, and data will be erased."})]}),e.jsx("button",{onClick:()=>{window.confirm(`Are you absolutely sure you want to delete your account? This action cannot be undone.

All your stats, achievements, and data will be permanently erased.`)&&window.confirm("This is your final warning. Click OK to permanently delete your account.")&&window.dispatchEvent(new CustomEvent("ndn:delete-account"))},className:"w-full px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium transition-colors",children:"Permanently Delete Account"})]})]})})]})}),e.jsx("div",{className:"relative rounded-xl bg-white/5 backdrop-blur-md border border-white/10 p-1",children:e.jsx("div",{className:"flex items-center gap-2 overflow-x-auto no-scrollbar py-1 px-1",children:e.jsx(dn,{label:"Calibration",icon:Js,pill:"calibration",color:"from-purple-500 to-pink-500 shadow-purple-500/30"})})}),Ut==="calibration"&&e.jsx("div",{"data-testid":"pill-calibration-content",className:"p-6 rounded-2xl border border-white/10 bg-white/[0.02] space-y-4",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx("div",{className:"card",children:e.jsxs("div",{className:"p-3 rounded-xl border border-blue-500/40 bg-blue-500/10",children:[e.jsxs("div",{className:"font-semibold mb-4 flex items-center gap-2",children:[e.jsx(Js,{className:"w-5 h-5 text-blue-400"})," Camera & Vision"]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{type:"checkbox",id:"cameraEnabled",checked:M,onChange:I=>Ie(I.target.checked),className:"w-4 h-4"}),e.jsx("label",{htmlFor:"cameraEnabled",className:"text-sm",children:"Enable camera"})]}),M&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsxs("label",{htmlFor:"cameraScale",className:"block text-sm mb-2",children:["Scale: ",d?.toFixed(2)]}),e.jsx("input",{type:"range",id:"cameraScale",min:"0.5",max:"3",step:"0.1",value:d||1,onChange:I=>H(parseFloat(I.target.value)),className:"w-full"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"cameraAspect",className:"block text-sm mb-2",children:"Aspect Ratio"}),e.jsxs("select",{onPointerDown:I=>{I.stopPropagation()},onMouseDown:I=>{I.stopPropagation()},onTouchStart:I=>{I.stopPropagation?.()},id:"cameraAspect",value:v||"wide",onChange:I=>fe(I.target.value),className:"input w-full",children:[e.jsx("option",{value:"wide",children:"Wide (16:9)"}),e.jsx("option",{value:"square",children:"Square (1:1)"})]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"cameraFitMode",className:"block text-sm mb-2",children:"Fit Mode"}),e.jsxs("select",{onPointerDown:I=>{I.stopPropagation()},onMouseDown:I=>{I.stopPropagation()},onTouchStart:I=>{I.stopPropagation?.()},id:"cameraFitMode",value:x||"fit",onChange:I=>Ye(I.target.value),className:"input w-full",children:[e.jsx("option",{value:"fill",children:"Fill (crop)"}),e.jsx("option",{value:"fit",children:"Fit (letterbox)"})]})]}),e.jsx("button",{onClick:()=>{},className:"btn bg-indigo-600 hover:bg-indigo-700 w-full",children:"Calibration Guide"}),e.jsxs("div",{className:"flex items-center gap-3 mt-3",children:[e.jsx("input",{type:"checkbox",id:"preserveOverlaySize",checked:St,onChange:I=>zt(I.target.checked),className:"w-4 h-4"}),e.jsx("label",{htmlFor:"preserveOverlaySize",className:"text-sm",children:"Preserve overlay display size when locking calibration"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"autoscoreProvider",className:"block text-sm mb-2",children:"Auto-score Provider"}),e.jsxs("select",{onPointerDown:I=>{I.stopPropagation()},onMouseDown:I=>{I.stopPropagation()},onTouchStart:I=>{I.stopPropagation?.()},id:"autoscoreProvider",value:y||"manual",onChange:I=>Ce(I.target.value),className:"input w-full",children:[e.jsx("option",{value:"manual",children:"Manual Scoring"}),e.jsx("option",{value:"built-in",children:"Built-in Vision"}),e.jsx("option",{value:"external-ws",children:"External (WebSocket)"})]})]}),y==="external-ws"&&e.jsx("input",{type:"text",placeholder:"WebSocket URL",value:w||"",onChange:I=>Ve(I.target.value),className:"input w-full text-xs"}),y!=="manual"&&e.jsxs("div",{children:[e.jsx("label",{htmlFor:"autoCommitMode",className:"block text-sm mb-2",children:"Turn Advance"}),e.jsxs("select",{onPointerDown:I=>{I.stopPropagation()},onMouseDown:I=>{I.stopPropagation()},onTouchStart:I=>{I.stopPropagation?.()},id:"autoCommitMode",value:C||"wait-for-clear",onChange:I=>Le(I.target.value),className:"input w-full",children:[e.jsx("option",{value:"wait-for-clear",children:"Wait for darts to be removed"}),e.jsx("option",{value:"immediate",children:"Advance immediately after 3 darts/bust"})]}),e.jsx("p",{className:"text-xs opacity-70 mt-1",children:"Waiting prevents the turn from rotating until you clear the board (or 6.5s pass)."})]})]})]})]})}),e.jsx("div",{className:"card",children:e.jsxs("div",{className:"p-3 rounded-xl border border-purple-500/40 bg-purple-500/10",children:[e.jsxs("div",{className:"font-semibold mb-4 flex items-center gap-2",children:[e.jsx(ki,{className:"w-5 h-5 text-purple-400"})," Audio & Voice"]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{type:"checkbox",id:"callerEnabled",checked:n,onChange:I=>W(I.target.checked),className:"w-4 h-4"}),e.jsx("label",{htmlFor:"callerEnabled",className:"text-sm",children:"Enable voice caller"})]}),n&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"callerVoice",className:"block text-sm mb-2",children:"Voice"}),e.jsxs("select",{onPointerDown:I=>{I.stopPropagation()},onMouseDown:I=>{I.stopPropagation()},onTouchStart:I=>{I.stopPropagation?.()},id:"callerVoice",value:a||"",onChange:I=>ee(I.target.value),className:"input w-full text-xs",children:[e.jsx("option",{value:"",children:"Default"}),tn.map((I,ce)=>e.jsx("option",{value:I.voiceURI,children:I.name},ce))]})]}),e.jsxs("div",{children:[e.jsxs("label",{htmlFor:"callerVolume",className:"block text-sm mb-2",children:["Volume: ",Math.round((s||1)*100),"%"]}),e.jsx("input",{type:"range",id:"callerVolume",min:"0",max:"1",step:"0.1",value:s||1,onChange:I=>Q(parseFloat(I.target.value)),className:"w-full"})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{type:"checkbox",id:"speakCheckoutOnly",checked:o,onChange:I=>K(I.target.checked),className:"w-4 h-4"}),e.jsx("label",{htmlFor:"speakCheckoutOnly",className:"text-sm",children:"Only speak checkout scores"})]}),e.jsx("button",{onClick:()=>{const I=new SpeechSynthesisUtterance("Test voice. 180!");I.voice=tn.find(ce=>ce.voiceURI===a)||null,I.volume=s||1,speechSynthesis.cancel(),speechSynthesis.speak(I)},className:"btn bg-purple-600 hover:bg-purple-700 w-full",children:"Test Voice"})]})]})]})})]})}),e.jsx("div",{className:"relative rounded-xl bg-white/5 backdrop-blur-md border border-white/10 p-1",children:e.jsx("div",{className:"flex items-center gap-2 overflow-x-auto no-scrollbar py-1 px-1",children:e.jsx(dn,{label:"Settings",icon:ls,pill:"settings",color:"from-cyan-500 to-blue-500 shadow-cyan-500/30"})})}),Ut==="settings"&&e.jsxs("div",{"data-testid":"pill-settings-content",className:"space-y-4",children:[e.jsx("div",{className:"card",children:e.jsxs("div",{className:"p-3 rounded-xl border border-indigo-500/40 bg-indigo-500/10",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{className:"font-semibold flex items-center gap-2",children:[e.jsx(as,{className:"w-5 h-5 text-brand-400"})," Profile Bio"]}),Me?e.jsxs("button",{onClick:vt,className:"flex items-center gap-2 px-3 py-1 bg-green-500/20 hover:bg-green-500/30 rounded-lg text-green-400 text-sm transition-colors",children:[e.jsx(Ii,{className:"w-4 h-4"})," Save"]}):e.jsxs("button",{onClick:()=>ln(!0),className:"flex items-center gap-2 px-3 py-1 bg-blue-500/20 hover:bg-blue-500/30 rounded-lg text-blue-400 text-sm transition-colors",children:[e.jsx(Ei,{className:"w-4 h-4"})," Edit"]})]}),e.jsx("div",{className:"space-y-3",children:Me?e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm mb-1",children:"Favorite Player"}),e.jsx("input",{type:"text",value:Ze,onChange:I=>xe(I.target.value),className:"input w-full"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm mb-1",children:"Favorite Team"}),e.jsx("input",{type:"text",value:ne,onChange:I=>ke(I.target.value),className:"input w-full"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm mb-1",children:"Favorite Darts"}),e.jsx("input",{type:"text",value:je,onChange:I=>_e(I.target.value),className:"input w-full"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm mb-1",children:"Bio / Quote"}),e.jsx("textarea",{value:Ee,onChange:I=>be(I.target.value),rows:3,className:"input w-full"})]})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:["Favorite Player:"," ",e.jsx("span",{className:"text-brand-300",children:Ze||"Not set"})]}),e.jsxs("div",{children:["Favorite Team:"," ",e.jsx("span",{className:"text-brand-300",children:ne||"Not set"})]}),e.jsxs("div",{children:["Favorite Darts:"," ",e.jsx("span",{className:"text-brand-300",children:je||"Not set"})]}),e.jsxs("div",{children:["Bio:"," ",e.jsx("span",{className:"text-brand-300",children:Ee||"No bio set"})]})]})})]})}),e.jsx("div",{className:"card",children:e.jsxs("div",{className:"p-3 rounded-xl border border-green-500/40 bg-green-500/10",children:[e.jsxs("div",{className:"font-semibold mb-4 flex items-center gap-2",children:[e.jsx(Mi,{className:"w-5 h-5 text-green-400"})," Game Preferences"]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{type:"checkbox",id:"dartTimerEnabled",checked:!!Wt,onChange:I=>st(I.target.checked),className:"w-4 h-4"}),e.jsx("label",{htmlFor:"dartTimerEnabled",className:"text-sm",children:"Enable per-dart throw timer"})]}),Wt&&e.jsxs("div",{children:[e.jsxs("label",{className:"block mb-2 text-sm font-medium",children:["Time per throw:"," ",Ue?Math.round(Ue):0,"s"]}),e.jsx("input",{type:"range",min:"3",max:"30",value:Ue||10,onChange:I=>at(parseInt(I.target.value)),className:"w-full"}),e.jsx("div",{className:"text-xs opacity-70 mt-1",children:"When the timer reaches zero, the dart is recorded as a miss and advances to the next throw."})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"favoriteDouble",className:"block text-sm mb-2",children:"Favorite Finish Double"}),e.jsxs("select",{onPointerDown:I=>{I.stopPropagation()},onMouseDown:I=>{I.stopPropagation()},id:"favoriteDouble",value:t,onChange:I=>z(I.target.value),className:"input w-full",children:[e.jsx("option",{value:"any",children:"Any Double"}),e.jsx("option",{value:"D20",children:"Double 20"}),e.jsx("option",{value:"D10",children:"Double 10"}),e.jsx("option",{value:"D5",children:"Double 5"}),e.jsx("option",{value:"D1",children:"Double 1"})]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"avgMode",className:"block text-sm mb-2",children:"Average Display Mode"}),e.jsxs("select",{id:"avgMode",value:c,onChange:I=>le(I.target.value),className:"input w-full",children:[e.jsx("option",{value:"all-time",children:"All Time Average"}),e.jsx("option",{value:"24h",children:"24 Hour Average"})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{type:"checkbox",id:"x01DoubleIn",checked:!!ze,onChange:I=>ut(I.target.checked),className:"w-4 h-4"}),e.jsx("label",{htmlFor:"x01DoubleIn",className:"text-sm",children:"Require Double-In for X01"})]})]})]})}),e.jsx("div",{className:"card",children:e.jsxs("div",{className:"p-3 rounded-xl border border-pink-500/40 bg-pink-500/10",children:[e.jsxs("div",{className:"font-semibold mb-4 flex items-center gap-2",children:[e.jsx(Ys,{className:"w-5 h-5 text-pink-400"})," UI & Accessibility"]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{type:"checkbox",id:"autoStartOffline",checked:i,onChange:I=>ie(I.target.checked),className:"w-4 h-4"}),e.jsx("label",{htmlFor:"autoStartOffline",className:"text-sm",children:"Auto-start offline games"})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{type:"checkbox",id:"rememberLastOffline",checked:h,onChange:I=>L(I.target.checked),className:"w-4 h-4"}),e.jsx("label",{htmlFor:"rememberLastOffline",className:"text-sm",children:"Remember last offline game settings"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"offlineLayout",className:"block text-sm mb-2",children:"Offline Layout"}),e.jsxs("select",{id:"offlineLayout",value:T||"classic",onChange:I=>Mt(I.target.value),className:"input w-full",children:[e.jsx("option",{value:"classic",children:"Classic Layout"}),e.jsx("option",{value:"modern",children:"Modern Layout"})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{type:"checkbox",id:"reducedMotion",checked:l,onChange:I=>Y(I.target.checked),className:"w-4 h-4"}),e.jsx("label",{htmlFor:"reducedMotion",className:"text-sm",children:"Reduce motion/animations"})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{type:"checkbox",id:"compactHeader",checked:u,onChange:I=>$(I.target.checked),className:"w-4 h-4"}),e.jsx("label",{htmlFor:"compactHeader",className:"text-sm",children:"Compact header"})]})]})]})}),e.jsx("div",{className:"card",children:e.jsxs("div",{className:"p-3 rounded-xl border border-yellow-500/30 bg-yellow-500/6",children:[e.jsxs("div",{className:"font-semibold mb-4 flex items-center gap-2",children:[e.jsx(ls,{className:"w-5 h-5 text-yellow-400"})," Theme"]}),e.jsx("div",{children:e.jsx(Rd,{})})]})}),e.jsx("div",{className:"card",children:e.jsxs("div",{className:"p-3 rounded-xl border border-blue-500/40 bg-blue-500/10",children:[e.jsxs("div",{className:"font-semibold mb-4 flex items-center gap-2",children:[e.jsx(Xs,{className:"w-5 h-5 text-blue-400"})," Support & Help"]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-sm opacity-80",children:"Need help? Contact us via email:"}),e.jsx("a",{href:"mailto:support@ninedartnation.com",className:"btn bg-blue-600 hover:bg-blue-700 w-full text-xs",children:"Email Support"})]})]})}),e.jsx("div",{className:"card",children:e.jsxs("div",{className:"p-3 rounded-xl border border-cyan-500/40 bg-cyan-500/10",children:[e.jsxs("div",{className:"font-semibold mb-4 flex items-center gap-2",children:[e.jsx(Tn,{className:"w-5 h-5 text-cyan-400"})," Help Assistant"]}),e.jsx("div",{className:"space-y-3 max-h-96 overflow-y-auto",children:en.map((I,ce)=>e.jsx("div",{className:`${I.isUser?"text-right":""}`,children:e.jsx("div",{className:`inline-block max-w-xs px-3 py-2 rounded-lg text-sm ${I.isUser?"bg-indigo-600 text-white":"bg-white/10 text-slate-100"}`,children:typeof I.text=="string"?I.text:e.jsxs(e.Fragment,{children:[e.jsx("div",{children:I.text.text}),I.text.links&&e.jsx("div",{className:"mt-2 space-y-1",children:I.text.links.map((Re,wt)=>e.jsx("button",{onClick:()=>Gt(Re.tab),className:"block w-full text-left text-xs px-2 py-1 bg-white/20 hover:bg-white/30 rounded transition",children:Re.text},wt))})]})})},ce))}),e.jsxs("div",{className:"flex gap-2 mt-3",children:[e.jsx("input",{type:"text",value:ot,onChange:I=>mt(I.target.value),onKeyPress:I=>I.key==="Enter"&&b(),placeholder:"Ask me anything...",className:"flex-1 input"}),e.jsx("button",{onClick:b,className:"btn bg-blue-600 hover:bg-blue-700",children:e.jsx(ca,{className:"w-4 h-4"})})]})]})})]}),e.jsx("div",{className:"card",children:e.jsxs("div",{className:"p-3 rounded-xl border border-yellow-500/40 bg-yellow-500/10",children:[e.jsxs("div",{className:"font-semibold mb-4 flex items-center gap-2",children:[e.jsx(Xs,{className:"w-5 h-5 text-yellow-400"})," Achievements & Badges"]}),e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-2",children:Pe.map(I=>e.jsxs("div",{className:`p-3 rounded-lg border ${I.unlocked?"border-yellow-500/40 bg-yellow-500/10":"border-white/10 bg-white/5"}`,title:I.desc,children:[e.jsx("div",{className:"text-lg",children:I.icon}),e.jsx("div",{className:"text-xs font-semibold mt-1",children:I.label}),e.jsx("div",{className:"text-[10px] opacity-70",children:I.unlocked?"✓ Unlocked":"Locked"})]},I.key))})]})})]})}const Ld={};function _d({onAuth:r}){const[t,n]=f.useState("signin"),[a,s]=f.useState(""),[o,c]=f.useState(""),[i,h]=f.useState(""),[l,u]=f.useState(""),[m,d]=f.useState(""),[v,x]=f.useState(!1),[y,w]=f.useState(!1),C="http://localhost:8787";async function N(T){T.preventDefault(),d(""),w(!0);try{cn(()=>import("./Home-CWDFpsAt.js"),__vite__mapDeps([0,1,2,3])),cn(()=>import("./OnlinePlay.clean-BAzALA79.js"),__vite__mapDeps([4,1,2,5,6])),cn(()=>import("./OfflinePlay-DvEQLJLW.js"),__vite__mapDeps([7,1,2,5,6,8])),cn(()=>import("./Scoreboard-2xapDfxT.js"),__vite__mapDeps([9,3,8,1,2])),cn(()=>import("./StatsPanel-hbFwEa4y.js"),__vite__mapDeps([10,3,1,2]))}catch{}if(!o||!i){d("Username and password required."),w(!1);return}try{console.time("Auth:signIn roundtrip");const p=await fetch(`${C}/api/auth/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o.includes("@")?{email:o,password:i}:{username:o,password:i})}),k=await p.json();console.timeEnd("Auth:signIn roundtrip"),p.ok&&k?.user&&k?.token?(localStorage.setItem("authToken",k.token),r(k.user)):d(k?.error||"Invalid username or password.")}catch{d("Network error.")}finally{w(!1)}}async function P(T){if(T.preventDefault(),d(""),w(!0),!a||!o||!i){d("Email, username, and password required."),w(!1);return}try{const p=await fetch(`${C}/api/auth/signup`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:a,username:o,password:i})}),k=await p.json();p.ok&&k?.user&&k?.token?(localStorage.setItem("authToken",k.token),r(k.user)):d(k?.error||"Signup failed.")}catch{d("Network error.")}finally{w(!1)}}async function S(T){if(T.preventDefault(),d(""),w(!0),!a||!a.includes("@")){d("Enter your email address."),w(!1);return}try{const k=await(await fetch(`${C}/api/auth/send-reset`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:a})})).json();if(!k?.ok)throw new Error(k?.error||"Failed to send reset email");d("Password reset link sent to your email.")}catch(p){d(p?.message||"Failed to send reset email")}finally{w(!1)}}async function M(T){if(T.preventDefault(),d(""),w(!0),!a||!a.includes("@")){d("Enter your email address."),w(!1);return}try{const k=await(await fetch(`${C}/api/auth/send-username`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:a})})).json();if(!k?.ok)throw new Error(k?.error||"Failed to send username email");d("Your username has been emailed to you.")}catch(p){d(p?.message||"Failed to send username email")}finally{w(!1)}}return e.jsxs("div",{className:"min-h-screen flex items-center justify-center relative overflow-hidden",children:[e.jsx("div",{className:"background-animated"}),e.jsxs("div",{className:"relative z-10 w-full max-w-5xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-6 p-4",children:[e.jsxs("form",{className:"card w-full space-y-4",onSubmit:t==="signin"?N:t==="signup"?P:S,children:[e.jsxs("div",{className:"flex flex-col items-center justify-center gap-2 mb-2 text-center",children:[e.jsx("h1",{className:"logo text-center",children:"NINE-DART-NATION 🎯"}),e.jsx("span",{className:"badge",children:"Welcome"})]}),e.jsx("h2",{className:"text-2xl font-bold",children:t==="signin"?"Sign In":t==="signup"?"Create Account":"Reset Password"}),(t==="signup"||t==="reset")&&e.jsx("input",{className:"input w-full",type:"email",placeholder:"Email",value:a,onChange:T=>s(T.target.value),required:!0}),t!=="reset"&&e.jsx("input",{className:"input w-full",type:"text",placeholder:"Username or Email",value:o,onChange:T=>c(T.target.value),required:!0}),t!=="reset"&&e.jsxs("div",{className:"relative",children:[e.jsx("input",{className:"input w-full pr-10",type:v?"text":"password",placeholder:"Password",value:i,onChange:T=>h(T.target.value),autoComplete:"current-password",required:!0,onFocus:()=>x(!1),onBlur:()=>x(!1)}),e.jsx("button",{type:"button",className:"absolute right-2 top-1/2 -translate-y-1/2 text-slate-300 hover:text-white",tabIndex:-1,onMouseDown:T=>{T.preventDefault(),x(!0)},onMouseUp:T=>{T.preventDefault(),x(!1)},onMouseLeave:()=>x(!1),onTouchStart:T=>{T.preventDefault(),x(!0)},onTouchEnd:T=>{T.preventDefault(),x(!1)},"aria-label":"Toggle password visibility",children:v?e.jsx(Ti,{className:"w-5 h-5"}):e.jsx(Ys,{className:"w-5 h-5"})})]}),t==="signup"&&e.jsx("input",{className:"input w-full",type:"text",placeholder:"Password Reminder (optional)",value:l,onChange:T=>u(T.target.value)}),m&&e.jsx("div",{className:"text-red-400 font-semibold text-sm",children:m}),e.jsx("button",{className:"btn w-full",type:"submit",disabled:y,children:y?"Signing In...":t==="signin"?"Sign In":t==="signup"?"Sign Up":"Send Reset Link"}),t==="reset"&&e.jsx("button",{className:"btn w-full mt-2 bg-white/10 hover:bg-white/20",type:"button",onClick:M,disabled:y,children:"Email me my username"}),e.jsxs("div",{className:"flex justify-between text-sm mt-2",children:[e.jsx("button",{type:"button",className:"underline",onClick:()=>n(t==="signin"?"signup":"signin"),disabled:y,children:t==="signin"?"Need an account? Sign Up":"Already have an account? Sign In"}),e.jsx("button",{type:"button",className:"underline",onClick:()=>n("reset"),disabled:y,children:"Forgot password?"})]})]}),e.jsxs("aside",{className:"card w-full",children:[e.jsx("h3",{className:"text-xl font-bold mb-3",children:"What’s inside"}),e.jsxs("ul",{className:"space-y-3",children:[e.jsxs("li",{className:"flex items-start gap-3",children:[e.jsx(Gs,{className:"w-5 h-5 text-indigo-300 mt-1"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold",children:"Online & Friends"}),e.jsx("div",{className:"text-sm text-slate-200/90",children:"Challenge friends, chat, and join leagues."})]})]}),e.jsxs("li",{className:"flex items-start gap-3",children:[e.jsx(Oi,{className:"w-5 h-5 text-indigo-300 mt-1"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold",children:"Deep Stats"}),e.jsx("div",{className:"text-sm text-slate-200/90",children:"Track 3-dart averages, best legs, and more."})]})]}),e.jsxs("li",{className:"flex items-start gap-3",children:[e.jsx(ss,{className:"w-5 h-5 text-indigo-300 mt-1"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold",children:"Game Modes"}),e.jsx("div",{className:"text-sm text-slate-200/90",children:"Start with 3 free online games upon signup. After that, PREMIUM is required to play all games."})]})]}),e.jsxs("li",{className:"flex items-start gap-3",children:[e.jsx(Ai,{className:"w-5 h-5 text-indigo-300 mt-1"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold",children:"Premium Perks"}),e.jsx("div",{className:"text-sm text-slate-200/90",children:"Polished UI, upcoming features, and early access."})]})]})]}),e.jsxs("a",{href:Ld?.VITE_DISCORD_INVITE_URL||"https://discord.gg/8GtbZ6RU",target:"_blank",rel:"noopener noreferrer",className:"btn mt-4 flex items-center justify-center gap-2",children:[e.jsx(Tn,{className:"w-5 h-5"})," Join BullseyeDartsLeague"]}),e.jsxs("a",{href:"https://discord.gg/NineDartNation",target:"_blank",rel:"noopener noreferrer",className:"btn mt-2 flex items-center justify-center gap-2 bg-white/10 hover:bg-white/20",children:[e.jsx(Tn,{className:"w-5 h-5"})," Join NineDartNation"]})]})]})]})}const io=Td;function Fd({open:r,onClose:t,width:n=700,title:a,footer:s,children:o,side:c="right"}){return f.useEffect(()=>{function i(h){h.key==="Escape"&&t()}return r&&document.addEventListener("keydown",i),()=>document.removeEventListener("keydown",i)},[r,t]),e.jsxs("div",{className:`fixed inset-0 z-50 ${r?"":"pointer-events-none"}`,"aria-hidden":!r,children:[e.jsx("div",{className:`absolute inset-0 bg-black/60 transition-opacity ${r?"opacity-100":"opacity-0"}`,onClick:t,role:"button","aria-label":"Close drawer",tabIndex:0,onKeyDown:i=>{(i.key==="Enter"||i.key===" "||i.key==="Escape")&&t()}}),e.jsx("div",{className:`absolute top-0 ${c==="right"?"right-0 border-l":"left-0 border-r"} h-full bg-slate-900 border-slate-700 shadow-2xl w-full sm:w-auto flex flex-col transition-transform duration-200 ${r?"translate-x-0":c==="right"?"translate-x-full":"-translate-x-full"}`,style:{width:typeof n=="number"?`${n}px`:n},role:"dialog","aria-modal":"true",children:e.jsxs(Jn,{returnFocus:!0,children:[e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b border-slate-700 sticky top-0 bg-slate-900 z-10",children:[e.jsx("div",{className:"text-lg font-semibold",children:a}),e.jsx("button",{className:"btn px-3 py-1 text-sm",onClick:t,children:"Close"})]}),e.jsx("div",{className:"flex-1 overflow-auto p-4",children:o}),s&&e.jsx("div",{className:"px-4 py-3 border-t border-slate-700 sticky bottom-0 bg-slate-900 z-10",children:s})]})})]})}function Ud(r){const[t,n]=f.useState(!1),[a,s]=f.useState([{text:"Hi! I'm your Nine Dart Nation assistant. How can I help you today?",isUser:!1}]),[o,c]=f.useState(""),[i,h]=f.useState(!1),[l,u]=f.useState(""),[m,d]=f.useState(null),v=(()=>{try{return vr()}catch{return null}})();f.useEffect(()=>{if(!v)return;const C=v.addListener(N=>{try{N?.type==="help-message"&&m&&(String(N.requestId),String(m.id)),N?.type==="help-request-updated"&&m&&N.request?.id===m.id&&d(N.request)}catch{}});return()=>C()},[v,m]);const x=C=>{try{window.dispatchEvent(new CustomEvent("ndn:change-tab",{detail:{tab:C}})),n(!1)}catch(N){console.error("Navigation failed:",N)}},y=C=>{const N=C.toLowerCase();return N.includes("username")||N.includes("change name")?{text:"You can change your username once for free.",links:[{text:"Go to Settings > Account",tab:"settings"}]}:N.includes("premium")||N.includes("upgrade")||N.includes("subscription")?{text:"Premium unlocks all game modes and features.",links:[{text:"Go to Online Play",tab:"online"}]}:N.includes("calibrat")||N.includes("camera")||N.includes("vision")?{text:"Set up your camera properly in Settings.",links:[{text:"Go to Settings > Camera & Vision",tab:"settings"}]}:N.includes("voice")||N.includes("caller")||N.includes("audio")?{text:"Enable voice calling in Settings.",links:[{text:"Go to Settings > Audio & Voice",tab:"settings"}]}:N.includes("friend")||N.includes("play together")?{text:"Add friends to play together.",links:[{text:"Go to Friends",tab:"friends"}]}:N.includes("stat")||N.includes("score")||N.includes("performance")?{text:"View your statistics and performance.",links:[{text:"Go to Stats",tab:"stats"}]}:N.includes("setting")||N.includes("customiz")||N.includes("configur")?{text:"Customize your experience.",links:[{text:"Go to Settings",tab:"settings"}]}:N.includes("tournament")||N.includes("competition")?{text:"Check out tournaments and competitions.",links:[{text:"Go to Tournaments",tab:"tournaments"}]}:N.includes("score")||N.includes("scoring")||N.includes("autoscore")?{text:"Auto-scoring assigns darts to board segments automatically. You can review and adjust placements in the Match Summary screen.",links:[{text:"Go to Match Summary",tab:"matchsummary"}]}:N.includes("pair")||N.includes("pairing")||N.includes("phone")||N.includes("camera pairing")?{text:"Use the Pairing flow to connect phones and cameras. Make sure devices are on the same Wi‑Fi and scan the QR code shown.",links:[{text:"Open Pairing",tab:"pairing"}]}:N.includes("highlight")||N.includes("download")||N.includes("save")?{text:"Highlights can be downloaded or saved to your account from the Highlights section. We keep a record when you hit milestone checkouts or visits.",links:[{text:"Open Highlights",tab:"highlights"}]}:N.includes("privacy")||N.includes("copyright")||N.includes("legal")?{text:"Our Legal Notice and Privacy information are available in the footer. You can view privacy, copyright, and contact details there.",links:[{text:"View Legal Notice",tab:"footer"}]}:N.includes("help")||N.includes("support")||N.includes("faq")?{text:"You're already in the help section! Check Settings for more resources.",links:[{text:"Go to Settings > Support",tab:"settings"}]}:N.includes("how to play")||N.includes("game")||N.includes("start")?{text:"To play darts, select a game mode from the menu. For online play, join a match. For offline, start a local game.",links:[{text:"Play Online",tab:"online"},{text:"Play Offline",tab:"offline"}]}:{text:"I'm not sure about that. Try asking about playing, calibration, premium, username changes, voice settings, friends, stats, or settings."}},w=()=>{if(!o.trim())return;const C=o.trim(),N=C.toLowerCase();if(s(S=>[...S,{text:C,isUser:!0}]),c(""),i)if(N.startsWith("y")){s(S=>[...S,{text:"Okay — I will notify an admin. Please wait for them to join the chat.",isUser:!1}]),h(!1),(async()=>{try{const T=await(await Gn("/api/help/requests",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:l||C})})).json().catch(()=>null);T&&T.request?(d(T.request),s(p=>[...p,{text:"Okay — I will notify an admin. Please wait for them to join the chat.",isUser:!1}])):s(p=>[...p,{text:"Okay — I will notify an admin. Please wait for them to join the chat.",isUser:!1}])}catch{s(M=>[...M,{text:"Failed to contact admins. Please try again later.",isUser:!1}])}})();return}else{s(S=>[...S,{text:"Okay — I won't notify an admin. If you change your mind, just ask.",isUser:!1}]),h(!1);return}const P=y(N);if(typeof P.text=="string"&&P.text.includes("I'm not sure about that")){u(C),h(!0),setTimeout(()=>{s(S=>[...S,{text:{text:"I can connect you to a member of our admin team — would you like that? Type YES or NO.",links:[]},isUser:!1}])},350);return}setTimeout(()=>{s(S=>[...S,{text:P,isUser:!1}])},500)};return e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>n(!0),className:"fixed bottom-4 right-4 z-50 bg-blue-600 hover:bg-blue-700 text-white p-4 rounded-full shadow-lg transition-colors",title:"Help Assistant",children:e.jsx(Xs,{className:"w-6 h-6"})}),t&&e.jsxs("div",{className:"fixed inset-0 z-50 flex items-end justify-end p-4",children:[e.jsx("div",{className:"absolute inset-0 bg-black/50",onClick:()=>n(!1)}),e.jsxs("div",{className:"relative bg-slate-800 rounded-lg shadow-xl w-full max-w-md h-96 flex flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 border-b border-slate-700",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Tn,{className:"w-5 h-5 text-blue-400"}),e.jsx("span",{className:"font-semibold",children:"Help Assistant"})]}),e.jsx("button",{onClick:()=>n(!1),className:"text-slate-400 hover:text-white",children:e.jsx(bo,{className:"w-5 h-5"})})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-4 space-y-3",children:a.map((C,N)=>e.jsx("div",{className:`flex ${C.isUser?"justify-end":"justify-start"}`,children:e.jsx("div",{className:`max-w-xs px-3 py-2 rounded-lg ${C.isUser?"bg-blue-600 text-white":"bg-slate-700 text-slate-200"}`,children:typeof C.text=="string"?C.text:e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{children:C.text.text}),C.text.links&&e.jsx("div",{className:"space-y-1",children:C.text.links.map((P,S)=>e.jsx("button",{onClick:()=>x(P.tab),className:"block w-full text-left text-blue-300 hover:text-blue-200 underline text-sm",children:P.text},S))})]})})},N))}),e.jsx("div",{className:"p-4 border-t border-slate-700",children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{type:"text",value:o,onChange:C=>c(C.target.value),onKeyPress:C=>C.key==="Enter"&&w(),placeholder:"Ask me anything...",className:"flex-1 input"}),e.jsx("button",{onClick:w,className:"btn bg-blue-600 hover:bg-blue-700",children:e.jsx(ca,{className:"w-4 h-4"})})]})})]})]}),m&&e.jsx(ui,{request:m,user:{email:null,username:null,isAdmin:!1},onClose:()=>d(null)})]})}function Bd(){const r=gr(),t=f.useRef({}),n=f.useRef({});return f.useEffect(()=>{function a(l="[GlobalCamera]"){try{const u=r.getVideoElementRef(),m=r.getMediaStream(),d=r.getPcRef&&r.getPcRef(),v=r.getWsRef&&r.getWsRef();Be(l,{isStreaming:r.isStreaming,mode:r.mode,showOverlay:r.showOverlay,hasVideoElement:!!u,video:u?{videoWidth:u.videoWidth,videoHeight:u.videoHeight,srcObject:!!u.srcObject}:null,mediaTracks:m?m.getTracks().map(x=>({kind:x.kind,enabled:x.enabled,id:x.id})):null,pcState:d?d.connectionState||d.iceConnectionState:null,wsState:v?v.readyState||"unknown":null})}catch(u){console.warn("[GlobalCamera] dumpState failed",u)}}a("[GlobalCamera] INIT");let s=!0;const o=setInterval(()=>{if(s)try{const l=r.getVideoElementRef(),u=r.getMediaStream(),m=r.getPcRef&&r.getPcRef(),d={isStreaming:r.isStreaming,mode:r.mode,hasVideo:!!l,videoW:l?l.videoWidth:0,videoH:l?l.videoHeight:0,tracks:u?u.getTracks().length:0,pcState:m?m.connectionState||m.iceConnectionState:null},v=t.current;(d.isStreaming!==v.isStreaming||d.hasVideo!==v.hasVideo||d.videoW!==v.videoW||d.videoH!==v.videoH||d.tracks!==v.tracks||d.pcState!==v.pcState||r.showOverlay!==v.showOverlay)&&(t.current=d,a("[GlobalCamera] CHANGE"))}catch(l){console.warn("[GlobalCamera] poll failed",l)}},750);function c(l){try{const u=n.current.video;if(u&&u.el===l)return;if(u&&u.el){try{u.el.removeEventListener("loadedmetadata",u.loadedmetadata)}catch{}try{u.el.removeEventListener("playing",u.playing)}catch{}try{u.el.removeEventListener("pause",u.pause)}catch{}try{u.el.removeEventListener("ended",u.ended)}catch{}}if(n.current.video=null,l){const m=()=>Be("[GlobalCamera] video loadedmetadata",{videoWidth:l.videoWidth,videoHeight:l.videoHeight}),d=()=>{Be("[GlobalCamera] video playing",{paused:l.paused});try{r.setStreaming(!0)}catch{}},v=()=>{Be("[GlobalCamera] video pause");try{r.setStreaming(!1)}catch{}},x=()=>{Be("[GlobalCamera] video ended");try{r.setStreaming(!1)}catch{}};l.addEventListener("loadedmetadata",m),l.addEventListener("playing",d),l.addEventListener("pause",v),l.addEventListener("ended",x),n.current.video={el:l,loadedmetadata:m,playing:d,pause:v,ended:x}}}catch(u){console.warn("[GlobalCamera] attachVideoListeners failed",u)}}function i(l){try{const u=n.current.pc;if(u&&u.pc===l)return;if(u&&u.pc)try{u.pc.removeEventListener("connectionstatechange",u.connChange)}catch{}if(n.current.pc=null,l){const m=()=>Be("[GlobalCamera] pc state change",{connectionState:l.connectionState,iceState:l.iceConnectionState});l.addEventListener("connectionstatechange",m),n.current.pc={pc:l,connChange:m}}}catch(u){console.warn("[GlobalCamera] attachPc failed",u)}}const h=setInterval(()=>{try{c(r.getVideoElementRef()),i(r.getPcRef&&r.getPcRef())}catch{}},1e3);return()=>{s=!1,clearInterval(o),clearInterval(h);try{const l=n.current.video;l&&l.el&&(l.el.removeEventListener("loadedmetadata",l.loadedmetadata),l.el.removeEventListener("playing",l.playing))}catch{}try{const l=n.current.pc;l&&l.pc&&l.pc.removeEventListener("connectionstatechange",l.connChange)}catch{}}},[r]),null}function $d(){const r=gr(),t=f.useRef(null),n=f.useRef(null),a=f.useRef(0),s=f.useRef(0),o=f.useRef(0),c=f.useRef(0);return f.useEffect(()=>{t.current&&r.setVideoElementRef(t.current)},[r]),f.useEffect(()=>{let i=!0;const h=async()=>{if(i)try{const u=r.getMediaStream(),m=t.current;if(!m||!u)return;(n.current!==u||m.srcObject!==u)&&(m.srcObject=u,n.current=u),m.muted=!0,m.playsInline=!0;try{await m.play()}catch{}}catch{}};h();const l=setInterval(h,750);return()=>{i=!1,clearInterval(l)}},[r]),f.useEffect(()=>{const h=setInterval(()=>{const l=t.current,u=Date.now();if(!l||!r.isStreaming||r.mode!=="phone"){s.current=0;return}if(!l.srcObject){const d=[3e3,6e3,1e4][Math.min(c.current,2)];if(u-o.current>=d){o.current=u,c.current=Math.min(c.current+1,3);try{window.dispatchEvent(new CustomEvent("ndn:phone-camera-reconnect",{detail:{reason:"missing-stream",ts:u}})),l.play().catch(()=>{})}catch{}}return}const m=l.currentTime||0;if(Number.isFinite(m))if(m===a.current?s.current+=1:s.current=0,a.current=m,s.current>=3){const d=[3e3,6e3,1e4][Math.min(c.current,2)];if(u-o.current>=d){o.current=u,c.current=Math.min(c.current+1,3);try{window.dispatchEvent(new CustomEvent("ndn:phone-camera-reconnect",{detail:{reason:"stall",ts:u}})),l.play().catch(()=>{})}catch{}}}else s.current===0&&(c.current=0)},1e3);return()=>clearInterval(h)},[r]),e.jsx("video",{ref:t,style:{position:"fixed",width:1,height:1,left:-9999,top:-9999,opacity:0},muted:!0,playsInline:!0,"aria-hidden":!0})}const co={};function Vd(){const[r,t]=f.useState(!1),n=co?.VITE_PLAY_STORE_URL||"",a=co?.VITE_APP_STORE_URL||"";async function s(){try{if(window.promptInstallApp){const o=await window.promptInstallApp()}else navigator?.standalone||"onappinstalled"in window?alert("App is already installed or your browser does not support programmatic install."):alert("Install is not available for your browser. Try using the share menu (iOS) or the install prompt (Chrome/Edge on Android).")}catch{}}return e.jsxs("div",{className:"relative inline-block",children:[e.jsx("button",{className:"px-2 py-1 rounded-full border border-white/10 bg-white/5 hover:bg-white/10 text-sm text-white flex items-center gap-2",onClick:()=>t(o=>!o),title:"Install or download app",children:"Install"}),r&&e.jsxs("div",{className:"absolute right-0 mt-2 w-64 bg-white/5 text-black card p-3 z-50",children:[e.jsx("div",{className:"font-semibold mb-2",children:"Install or Download"}),e.jsx("div",{className:"text-sm mb-2",children:"Install the app as a Progressive Web App or install a native version if available"}),e.jsxs("div",{className:"flex flex-col space-y-2",children:[e.jsx("button",{className:"btn",onClick:s,children:"Install (PWA)"}),n?e.jsx("a",{className:"btn",target:"_blank",rel:"noreferrer",href:n,children:"Android (Google Play)"}):e.jsx("div",{className:"text-xs opacity-80",children:"Android native build not provided"}),a?e.jsx("a",{className:"btn",target:"_blank",rel:"noreferrer",href:a,children:"iOS (App Store)"}):e.jsx("div",{className:"text-xs opacity-80",children:"iOS native build not provided"}),e.jsx("div",{className:"text-xs opacity-70",children:'iOS: Use Safari → Share → "Add to Home Screen" to add this site to your home screen.'})]})]})]})}function zd(){const[r,t]=f.useState(!1),[n,a]=f.useState(!1);f.useEffect(()=>{try{const c=i=>{i.preventDefault(),window.deferredInstallPrompt=i,t(!0)};return window.addEventListener("beforeinstallprompt",c),window.deferredInstallPrompt&&t(!0),()=>window.removeEventListener("beforeinstallprompt",c)}catch{}},[]);async function s(){try{if(window.promptInstallApp)await window.promptInstallApp()||a(!0);else if(window.deferredInstallPrompt){const c=window.deferredInstallPrompt;c.prompt();const i=await c.userChoice;i&&i.outcome==="accepted"?t(!1):a(!0)}else a(!0)}catch{a(!0)}}function o(){return'Open Safari &rarr; Tap the share button &rarr; "Add to Home Screen".'}return n?e.jsxs("div",{className:"relative inline-block",children:[e.jsx("button",{onClick:()=>a(!1),className:"px-2 py-1 rounded-full border border-white/10 bg-white/5 text-sm",children:"Close"}),e.jsx("div",{className:"text-sm p-2 mt-1 text-black card",children:Wd()?o():'Use your browser "Install" menu or the share button (iOS) to add to home screen.'})]}):e.jsx("button",{onClick:s,className:"px-2 py-1 rounded-full border border-white/10 bg-white/5 hover:bg-white/10 text-sm",title:"Add to Home Screen",children:"Add to Home Screen"})}function Wd(){try{return/iphone|ipad|ipod/i.test(navigator.userAgent)}catch{return!1}}function hi({storageKey:r,children:t,className:n,defaultWidth:a=520,defaultHeight:s,minWidth:o=360,minHeight:c=200,maxWidth:i=1100,maxHeight:h=900,fullScreen:l=!1,initialFitHeight:u=!1,onClose:m}){const[d,v]=f.useState(()=>{if(!l){try{const p=localStorage.getItem(r);if(p)return JSON.parse(p)}catch{}return{width:a,height:s}}return{}}),x=f.useRef(null);f.useEffect(()=>{if(l)return;function p(){try{localStorage.removeItem(r)}catch{}if(u&&S.current?.parentElement){const k=S.current.parentElement,z=window.getComputedStyle(k),W=parseFloat(z.paddingTop||"0")||0,ee=parseFloat(z.paddingBottom||"0")||0,Q=Math.max(0,k.clientHeight-W-ee),K=Math.max(c,Math.min(h,Math.round(Q)));v({width:a,height:K});return}v({width:a,height:s})}return window.addEventListener("ndn:layout-reset",p),()=>window.removeEventListener("ndn:layout-reset",p)},[r,a,s,l]),f.useEffect(()=>{if(!l)try{localStorage.setItem(r,JSON.stringify(d))}catch{}},[d,r,l]),f.useEffect(()=>{if(l||!u)return;const p=S.current?.parentElement;if(!p)return;const k=window.getComputedStyle(p),z=parseFloat(k.paddingTop||"0")||0,W=parseFloat(k.paddingBottom||"0")||0,ee=Math.max(0,p.clientHeight-z-W),Q=Math.max(c,Math.min(h,Math.round(ee)));try{const K=localStorage.getItem(r);if(K){const ie=JSON.parse(K)?.height||0;(!ie||ie<Q)&&v(L=>({...L,height:Q}));return}}catch{}v(K=>({...K,height:Q}))},[u,l,r,c,h]);function y(p,k,z){return Math.max(k,Math.min(z,p))}function w(p,k){p.preventDefault();const z=S.current;if(!z)return;const W=z.getBoundingClientRect();x.current={x:p.clientX,y:p.clientY,w:W.width,h:W.height,dir:k},window.addEventListener("mousemove",N),window.addEventListener("mouseup",P)}function C(p,k){const W=p.key;if(!["ArrowLeft","ArrowRight","ArrowUp","ArrowDown","Enter"," "].includes(W))return;p.preventDefault();const ee=W==="ArrowLeft"||W==="ArrowUp"?-20:20;v(Q=>{const K=Q.width||a,le=Q.height||s||c;let ie=K,L=le;return k.includes("e")&&(ie=y(K+ee,o,i)),k.includes("w")&&(ie=y(K-ee,o,i)),k.includes("s")&&(L=y(le+ee,c,h)),k.includes("n")&&(L=y(le-ee,c,h)),{width:Math.round(ie),height:Math.round(L)}})}function N(p){const k=x.current;if(!k)return;const z=p.clientX-k.x,W=p.clientY-k.y,ee=k.dir;let Q=k.w,K=k.h,le=1/0;const ie=S.current?.parentElement;if(ie){const Y=window.getComputedStyle(ie),$=parseFloat(Y.paddingTop||"0")||0,B=parseFloat(Y.paddingBottom||"0")||0;le=Math.max(0,ie.clientHeight-$-B)}const L=Math.min(h,isFinite(le)?le:h);ee.includes("e")&&(Q=y(k.w+z,o,i)),ee.includes("s")&&(K=y(k.h+W,c,L)),ee.includes("w")&&(Q=y(k.w-z,o,i)),ee.includes("n")&&(K=y(k.h-W,c,L)),v({width:Math.round(Q),height:Math.round(K)})}function P(){window.removeEventListener("mousemove",N),window.removeEventListener("mouseup",P),x.current=null}const S=f.useRef(null),M=l?{width:"100%",height:"100%",maxWidth:"100%",maxHeight:"100%"}:{width:d.width?`${d.width}px`:void 0,height:d.height?`${d.height}px`:void 0,maxWidth:`${i}px`,maxHeight:"100%"},T=l?"card relative ndn-modal-full":"card relative";return e.jsxs("div",{ref:S,className:`${T} ${n||""}`,style:M,children:[e.jsx(Jn,{returnFocus:!0,className:"flex-1 flex flex-col min-h-0 w-full",children:t}),!l&&e.jsx("div",{className:"resizer resizer-nw",onMouseDown:p=>w(p,"nw"),role:"button",tabIndex:0,"aria-label":"Resize north-west",onKeyDown:p=>C(p,"nw")}),!l&&e.jsx("div",{className:"resizer resizer-ne",onMouseDown:p=>w(p,"ne"),role:"button",tabIndex:0,"aria-label":"Resize north-east",onKeyDown:p=>C(p,"ne")}),!l&&e.jsx("div",{className:"resizer resizer-sw",onMouseDown:p=>w(p,"sw"),role:"button",tabIndex:0,"aria-label":"Resize south-west",onKeyDown:p=>C(p,"sw")}),!l&&e.jsx("div",{className:"resizer resizer-se",onMouseDown:p=>w(p,"se"),role:"button",tabIndex:0,"aria-label":"Resize south-east",onKeyDown:p=>C(p,"se")}),!l&&e.jsx("div",{className:"resizer-edge resizer-s",onMouseDown:p=>w(p,"s"),role:"button",tabIndex:0,"aria-label":"Resize south",onKeyDown:p=>C(p,"s")})]})}function qd(){const[r,t]=f.useState(null);f.useEffect(()=>{try{const a=s=>{s.preventDefault(),t(s)};return window.addEventListener("beforeinstallprompt",a),()=>window.removeEventListener("beforeinstallprompt",a)}catch{}},[]);async function n(){if(!r){alert('Open this site in your browser and use "Add to Home Screen" from the share menu (iOS) or use the browser install prompt (Android/Chrome).');return}try{r.prompt();const a=await r.userChoice;a&&a.outcome==="accepted"&&t(null)}catch(a){console.warn("install failed",a)}}return r?e.jsx("button",{className:"rounded bg-violet-600 text-white px-2 py-1",onClick:()=>n(),children:"Install App"}):null}function Hd(){const[r,t]=f.useState(!1),n=new Date().getFullYear();return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"w-full text-center text-xs text-gray-500 py-2 select-none",children:["© ",n," Nine Dart Nation —"," ",e.jsx("button",{className:"underline",onClick:()=>t(!0),children:"Legal Notice"}),e.jsx("span",{className:"ml-3 inline-block align-middle",children:e.jsx(qd,{})})]}),r?e.jsx(hi,{storageKey:"ndn:modal:legal",className:"w-[640px]",defaultWidth:640,defaultHeight:420,minWidth:420,minHeight:220,initialFitHeight:!0,children:e.jsxs("div",{className:"p-4 space-y-3",children:[e.jsx("div",{className:"text-lg font-semibold",children:"Privacy & Copyright Notice"}),e.jsx("div",{className:"text-sm",children:"⚠️ IMPORTANT LEGAL NOTICE"}),e.jsx("div",{className:"text-sm",children:"Copyright Protection: All code, assets, and intellectual property in Nine Dart Nation are protected by copyright law. Unauthorized copying, modification, or distribution of this software is strictly prohibited."}),e.jsx("div",{className:"text-sm",children:"Legal Consequences: Any attempt to edit, reverse-engineer, or redistribute this code will result in immediate legal action, including but not limited to copyright infringement lawsuits and potential criminal charges."}),e.jsx("div",{className:"text-sm",children:"Privacy: Your personal data and gameplay information are protected. Any unauthorized access or data collection violates privacy laws and will be prosecuted to the full extent of the law."}),e.jsx("div",{className:"flex items-center gap-2 mt-3",children:e.jsx("button",{className:"btn",onClick:()=>t(!1),children:"Close"})})]})}):null]})}const Lt=Vn(r=>({paused:!1,pauseEndsAt:null,pauseStartedAt:null,setPaused:(t,n=null)=>r({paused:t,pauseEndsAt:n??null,pauseStartedAt:t?Date.now():null})}));function Gd(){const r=Lt(a=>a.paused),t=Lt(a=>a.pauseEndsAt),n=Lt(a=>a.setPaused);return f.useEffect(()=>{if(!r||!t)return;const a=Date.now();if(t<=a){n(!1,null);return}const s=t-a,o=setTimeout(()=>n(!1,null),s);return()=>clearTimeout(o)},[r,t,n]),null}function lo(r,t){const n=$n(r,t);return Rr(n)}function Jd(r){try{if(!r||typeof r!="object")return null;if((r.type==="dart"||r.kind==="dart"||r.event==="dart")&&typeof r.value=="number"){const t=uo(r.ring);return mo(r.value,t)}if(typeof r.value=="number"&&r.ring){const t=uo(r.ring);return mo(r.value,t)}if(typeof r.score=="string"){const t=r.score.trim().toUpperCase();if(t==="50"||t==="DBULL"||t==="INNER_BULL")return{value:50,ring:"INNER_BULL",sector:null,mult:0};if(t==="25"||t==="BULL"||t==="OBULL")return{value:25,ring:"BULL",sector:null,mult:0};const n=t.match(/^(S|D|T)(\d{1,2})$/);if(n){const a=n[1]==="S"?1:n[1]==="D"?2:3,s=parseInt(n[2],10);if(s>=1&&s<=20)return{value:s*a,ring:a===1?"SINGLE":a===2?"DOUBLE":"TRIPLE",sector:s,mult:a}}}if(typeof r.sector=="number"&&typeof r.mult=="number"){const t=Math.max(1,Math.min(20,Math.floor(r.sector))),n=r.mult===1?1:r.mult===2?2:3;return{value:t*n,ring:n===1?"SINGLE":n===2?"DOUBLE":"TRIPLE",sector:t,mult:n}}if(r.bull){const t=String(r.bull).toLowerCase()==="inner"||r.bull===!0;return{value:t?50:25,ring:t?"INNER_BULL":"BULL",sector:null,mult:0}}}catch{}return null}function uo(r){const t=String(r||"").toUpperCase();return t.startsWith("TR")?"TRIPLE":t.startsWith("DO")?"DOUBLE":t.startsWith("SI")?"SINGLE":t==="INNER_BULL"||t==="DBULL"||t==="50"||t==="IBULL"?"INNER_BULL":t==="BULL"||t==="25"||t==="OBULL"||t==="OUTER_BULL"?"BULL":t==="MISS"||t==="0"?"MISS":"SINGLE"}function mo(r,t){const n=Math.max(0,Math.min(60,Math.round(Number(r)||0)));return t==="INNER_BULL"?{value:50,ring:t}:t==="BULL"?{value:25,ring:t}:{value:n,ring:t}}function Yd(r,t){let n=null,a=!0,s=null,o=0;const c=400,i=[],h=new Set;function l(m,d){const v=typeof m?.id=="string"||typeof m?.id=="number"?String(m.id):null;if(v){if(h.has(v))return;if(h.add(v),i.push(v),i.length>200){const w=i.shift();w&&h.delete(w)}}const x=`${d.value}|${d.ring}|${d.sector??""}|${d.mult??""}`,y=Date.now();x===s&&y-o<c||(s=x,o=y,t(d))}function u(){if(a)try{n=new WebSocket(r),n.onmessage=m=>{try{const d=JSON.parse(m.data),v=Jd(d);v&&l(d,v)}catch{}},n.onclose=()=>{n=null,setTimeout(u,1500)},n.onerror=()=>{}}catch{setTimeout(u,2e3)}}return u(),{close:()=>{a=!1;try{n?.close()}catch{}}}}function ho({storageKey:r,children:t,className:n,defaultWidth:a=640,defaultHeight:s=360,minWidth:o=320,minHeight:c=200,maxWidth:i=1600,maxHeight:h=1200,autoFill:l=!1}){const[u,m]=f.useState(()=>{try{const S=localStorage.getItem(r);if(S)return JSON.parse(S)}catch{}return l?{width:a}:{width:a,height:s}}),d=f.useRef(null),v=f.useRef(null);f.useEffect(()=>{function S(){try{localStorage.removeItem(r)}catch{}m({width:a,height:s})}return window.addEventListener("ndn:layout-reset",S),window.addEventListener("ndn:camera-reset",S),()=>{window.removeEventListener("ndn:layout-reset",S),window.removeEventListener("ndn:camera-reset",S)}},[r,a,s]),f.useEffect(()=>{try{localStorage.setItem(r,JSON.stringify(u))}catch{}},[u,r]);function x(S,M,T){return Math.max(M,Math.min(T,S))}function y(S,M){S.preventDefault();const T=v.current;if(!T)return;const p=T.getBoundingClientRect();d.current={x:S.clientX,y:S.clientY,w:p.width,h:p.height,dir:M},window.addEventListener("mousemove",w),window.addEventListener("mouseup",C)}function w(S){const M=d.current;if(!M)return;const T=S.clientX-M.x,p=S.clientY-M.y;let k=M.w,z=M.h;M.dir.includes("e")&&(k=x(M.w+T,o,i)),!l&&M.dir.includes("s")&&(z=x(M.h+p,c,h)),M.dir.includes("w")&&(k=x(M.w-T,o,i)),!l&&M.dir.includes("n")&&(z=x(M.h-p,c,h)),m({width:Math.round(k),height:Math.round(z)})}function C(){window.removeEventListener("mousemove",w),window.removeEventListener("mouseup",C),d.current=null}function N(S,M){const p=S.key;if(!["ArrowLeft","ArrowRight","ArrowUp","ArrowDown","Enter"," "].includes(p))return;S.preventDefault();const k=p==="ArrowLeft"||p==="ArrowUp"?-20:20;m(z=>{const W=z.width||a,ee=z.height||s;let Q=W,K=ee;return M.includes("e")&&(Q=x(W+k,o,i)),M.includes("w")&&(Q=x(W-k,o,i)),!l&&M.includes("s")&&(K=x(ee+k,c,h)),!l&&M.includes("n")&&(K=x(ee-k,c,h)),{width:Math.round(Q),height:Math.round(K)}})}const P={width:l?"100%":u.width?`${u.width}px`:void 0,height:l?"100%":u.height?`${u.height}px`:void 0,maxWidth:"100%",maxHeight:l?"100%":"80vh",position:"relative",...l?{display:"flex",flexDirection:"column",flex:"1 1 auto"}:{}};return e.jsxs("div",{ref:v,className:`${n||""}`,style:P,children:[t,e.jsx("div",{className:"resizer resizer-nw",onMouseDown:S=>y(S,"nw"),role:"button",tabIndex:0,"aria-label":"Resize north-west",onKeyDown:S=>N(S,"nw")}),e.jsx("div",{className:"resizer resizer-ne",onMouseDown:S=>y(S,"ne"),role:"button",tabIndex:0,"aria-label":"Resize north-east",onKeyDown:S=>N(S,"ne")}),e.jsx("div",{className:"resizer resizer-sw",onMouseDown:S=>y(S,"sw"),role:"button",tabIndex:0,"aria-label":"Resize south-west",onKeyDown:S=>N(S,"sw")}),e.jsx("div",{className:"resizer resizer-se",onMouseDown:S=>y(S,"se"),role:"button",tabIndex:0,"aria-label":"Resize south-east",onKeyDown:S=>N(S,"se")})]})}const Xd=Vn((r,t)=>({samples:[],addSample:n=>r(a=>({samples:[...a.samples,n]})),clear:()=>r({samples:[]}),export:()=>t().samples.slice()})),sr=Vn(r=>({darts:0,total:0,entries:[],setVisit:(t,n,a)=>r({entries:t,darts:n,total:a}),reset:()=>r({darts:0,total:0,entries:[]})}));function Kd({onClose:r,onQuit:t,onPause:n}){return jt.useEffect(()=>{const a=s=>{s.key==="Escape"&&r()};return window.addEventListener("keydown",a),()=>window.removeEventListener("keydown",a)},[r]),e.jsxs("div",{className:"fixed inset-0 z-[1200]",role:"presentation",children:[e.jsx("button",{className:"absolute inset-0 bg-black/50",onClick:r,"aria-label":"Close overlay"}),e.jsx("div",{className:"absolute inset-0 flex items-center justify-center p-4",children:e.jsx(Jn,{returnFocus:!0,children:e.jsxs("div",{className:"card max-w-md w-full p-4 rounded-xl text-left",role:"dialog","aria-modal":"true","aria-labelledby":"pause-quit-heading",children:[e.jsxs("div",{className:"flex justify-between items-center mb-3",children:[e.jsx("h3",{id:"pause-quit-heading",className:"text-lg font-bold",children:"Quit or Pause"}),e.jsx("button",{className:"btn px-3 py-1",onClick:r,"aria-label":"Close dialog",children:"✕"})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("p",{className:"mb-2",children:"You can either quit the match, or pause it for up to 5 minutes."}),e.jsx("p",{className:"text-sm text-slate-400",children:"If paused, the match will automatically resume when the timer expires or when a player resumes early."})]}),e.jsxs("div",{className:"flex gap-2 flex-wrap mb-3",children:[e.jsx("button",{className:"btn bg-rose-600 hover:bg-rose-700 px-3 py-1",onClick:()=>t(),children:"Quit match"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"opacity-80",children:"Pause:"}),[1,2,3,4,5].map(a=>e.jsxs("button",{className:"btn btn--ghost px-3 py-1 text-sm",onClick:()=>n(a),children:[a,"m"]},a))]})]}),e.jsx("div",{className:"text-right",children:e.jsx("button",{className:"btn btn--ghost px-3 py-1",onClick:r,children:"Cancel"})})]})})})]})}function Zd(r){const t=Math.max(0,Math.floor(r/1e3)),n=Math.floor(t/60).toString().padStart(2,"0"),a=(t%60).toString().padStart(2,"0");return`${n}:${a}`}function fi({compact:r=!1}){const t=Lt(u=>u.pauseEndsAt),n=Lt(u=>u.pauseStartedAt),a=Lt(u=>u.paused),[s,o]=f.useState(Date.now());if(f.useEffect(()=>{if(!a||!t)return;const u=setInterval(()=>o(Date.now()),500);return()=>clearInterval(u)},[a,t]),!a||!t)return null;const c=Math.max(0,t-s),h=Math.max(1,t-(n??s)),l=Math.max(0,Math.min(1,1-c/h));return e.jsxs("div",{className:"mr-2",role:"status","aria-live":"polite","aria-atomic":"true","aria-label":`Match paused, ${Math.ceil(c/1e3)} seconds remaining`,children:[e.jsxs("div",{className:`px-2 py-1 rounded-full bg-amber-600 text-black text-xs font-semibold ${r?"":"mr-2"}`,children:["Paused ",Zd(c)]}),!r&&e.jsx("div",{className:"w-40 h-2 bg-white/10 rounded overflow-hidden mt-1","aria-hidden":!0,children:e.jsx("div",{className:"h-2 bg-amber-400",style:{width:`${Math.round(l*100)}%`}})})]})}const pi="ndn:match-sync",Qd="ndn-match-sync";function eu(){try{const r=qe.getState(),t=Lt.getState(),n={roomId:r.roomId,players:r.players,currentPlayerIdx:r.currentPlayerIdx,startingScore:r.startingScore,inProgress:r.inProgress,bestLegThisMatch:r.bestLegThisMatch,game:r.game??null,mode:r.mode??null,value:r.value??null};let a={};try{if(typeof localStorage<"u"){const o=localStorage.getItem("ndn:selectedMode");a.selectedMode=o||null}}catch{a={selectedMode:null}}const s={paused:t.paused,pauseEndsAt:t.pauseEndsAt??null,pauseStartedAt:t.pauseStartedAt??null};return{match:n,control:s,ui:a,ts:Date.now()}}catch{return null}}function Hs(){try{const r=eu();if(!r)return;localStorage.setItem(pi,JSON.stringify(r));try{const t=new BroadcastChannel(Qd);t.postMessage({type:"snapshot",state:r}),t.close()}catch{}}catch{}}function fo(){try{const r=localStorage.getItem(pi);if(!r)return null;const t=JSON.parse(r);return{match:t.match,control:t.control}}catch{return null}}let cs=null,Hn=null;function tu(r,t=500){try{xi(),Hn=r,cs=window.setInterval(()=>{try{if(!Hn||!Hn.videoWidth||!Hn.videoHeight)return;const n=320,a=Math.round(Hn.videoHeight/Hn.videoWidth*n)||180,s=document.createElement("canvas");s.width=n,s.height=a;const o=s.getContext("2d");if(!o)return;o.drawImage(Hn,0,0,n,a);try{const c=s.toDataURL("image/jpeg",.45);Pn({type:"cameraFrame",frame:c,ts:Date.now()})}catch{}}catch{}},t)}catch{}}function xi(){try{cs&&(clearInterval(cs),cs=null),Hn=null}catch{}}const nu=2,ru=200,Bn=400,su=450,au=5e3,rs=150,ou=.9,iu=6500,cu=f.forwardRef(function({onVisitCommitted:t,showToolbar:n=!0,onAutoDart:a,immediateAutoCommit:s=!1,hideInlinePanels:o=!1,scoringMode:c="x01",onGenericDart:i,onGenericReplace:h,x01DoubleInOverride:l,onAddVisit:u,onEndLeg:m,cameraAutoCommit:d="camera"},v){const x=f.useRef(null),{preferredCameraId:y,preferredCameraLabel:w,setPreferredCamera:C,autoscoreProvider:N,autoscoreWsUrl:P,cameraAspect:S,cameraFitMode:M,autoCommitMode:T="wait-for-clear",cameraEnabled:p,setCameraEnabled:k,preferredCameraLocked:z,hideCameraOverlay:W,setHideCameraOverlay:ee}=on();on(g=>g.preserveCalibrationOverlay);const Q=N==="manual",[K,le]=f.useState([]),ie=f.useRef(null),L=f.useRef(null),[Y,$]=f.useState(!1),B=gr(),H=w==="Phone Camera",fe=B.getMediaStream?.()||null,Ye=B.isStreaming,Ce=H&&B.mode==="phone"&&Ye&&!!fe,Ve=Y||Ye||!1,[Le,Nt]=f.useState(!1),[St,zt]=f.useState(null),{H:He,imageSize:Ie,overlaySize:Mt,reset:Pt,_hydrated:Qt,locked:Wt,errorPx:Ue}=pn(),at=!!He&&!!Ie&&(Wt||typeof Ue=="number"&&Ue<=6);f.useEffect(()=>{z&&!W&&ee(!0)},[z,W,ee]);const[ze,ut]=f.useState(""),[Pe,Ge]=f.useState(""),[Me,ln]=f.useState(0),[Ze,xe]=f.useState("MISS"),[ne,ke]=f.useState(0),je=f.useRef(0),[_e,Ee]=f.useState(0),[be,Xe]=f.useState([]),de=qe(g=>g),[xn,qt]=f.useState(!1),[_t,Ft]=f.useState(!1),Nn=!!(de&&de.roomId)&&be.some(g=>g.meta&&g.meta.source==="camera"&&!g.meta.calibrationValid),[en,Tt]=f.useState(0),[ot,mt]=f.useState(0),[vt,Gt]=f.useState(!1),bn=f.useRef(null),b=f.useRef(null),F=d!=="camera"&&!s&&T!=="immediate",[re,Se]=f.useState(0),[Ne,yt]=f.useState([]),Te=f.useRef(null),tn=f.useRef([]),nn=f.useRef(0),Jt=f.useRef(0),ht=f.useRef(!1),Ut=f.useRef(null),Bt=f.useRef(0),dn=f.useRef(null),[I,ce]=f.useState([]),[Re,wt]=f.useState(!1),$t=f.useCallback(()=>{b.current&&(clearTimeout(b.current),b.current=null)},[]);f.useImperativeHandle(v,()=>({runDetectionTick:()=>{try{dn.current&&dn.current()}catch{}},__test_addDart:void 0}));const wr=f.useCallback(g=>{const E=[...tn.current.slice(-8),g];tn.current=E,ce(E);try{window.ndnCameraDiagnostics=E}catch{}},[]),Sn=f.useCallback(g=>{const E=bn.current;if(E&&(bn.current=null,$t(),Gt(!1),t))try{t(E.score,E.darts,E.finished);try{Pn({type:"visit",score:E.score,darts:E.darts,finished:E.finished,playerIdx:de.currentPlayerIdx,ts:Date.now()});try{Hs()}catch{}}catch{}}catch{}},[t,$t]),gn=f.useCallback(g=>{if(t){if(!F){try{t(g.score,g.darts,g.finished)}catch{}return}bn.current=g,Gt(!0),$t(),b.current=window.setTimeout(()=>Sn("timeout"),iu)}},[t,F,$t,Sn]),An=f.useCallback(g=>{ke(0),je.current=0,Ee(0),Xe([]),Tt(0),mt(0),nt(!1);try{window.dispatchEvent(new CustomEvent("ndn:clear-visit-request",{detail:{source:"camera-view",reason:g,ts:Date.now()}}))}catch{}},[]);f.useEffect(()=>{if(!F)return;const g=()=>Sn("event");return window.addEventListener("ndn:darts-cleared",g),()=>window.removeEventListener("ndn:darts-cleared",g)},[F,Sn]),f.useEffect(()=>{F||Sn("timeout")},[F,Sn]),f.useEffect(()=>()=>Sn("teardown"),[Sn]);const hs=f.useCallback(()=>{An("indicator"),Se(g=>g+1)},[An]),$r=f.useCallback(()=>{ne===0&&_e===0||(An("toolbar"),Se(g=>g+1))},[An,ne,_e]),jr=f.useCallback(()=>{if(!Q)try{window.dispatchEvent(new CustomEvent("ndn:open-camera-manager",{detail:{source:"camera-view",ts:Date.now()}}))}catch(g){console.warn("[CameraView] Failed to request camera manager:",g)}},[Q]),Nr=on(g=>g.x01DoubleIn),un=typeof l=="boolean"?!!l:!!Nr,[zn,Vr]=f.useState({}),mn=de.players[de.currentPlayerIdx]?.id,Rn=!!(mn&&zn[mn]),Sr=g=>{mn&&Vr(E=>({...E,[mn]:g}))},Yn=de?.inProgress,zr=sr(g=>g.setVisit),Xn=sr(g=>g.reset);f.useEffect(()=>{try{zr(be,ne,_e);try{const g={type:"pendingVisit",entries:be,darts:ne,total:_e,playerIdx:de.currentPlayerIdx,ts:Date.now()};try{const E=x.current;if(E&&E.videoWidth&&E.videoHeight){const V=Math.round(E.videoHeight/E.videoWidth*320)||180,q=document.createElement("canvas");q.width=320,q.height=V;const U=q.getContext("2d");if(U){U.drawImage(E,0,0,320,V);try{g.frame=q.toDataURL("image/jpeg",.45)}catch{}}}}catch{}Pn(g)}catch{}}catch{}},[be,ne,_e,zr]),f.useEffect(()=>()=>{try{Xn()}catch{}},[Xn]);const Kn=qe(g=>g.addVisit),fs=qe(g=>g.endLeg),vn=(g,E,A)=>{try{Be("CameraView: callAddVisit",g,E,A),u?u(g,E,A):Kn(g,E,A);try{Pn({type:"visit",score:g,darts:E,playerIdx:de.currentPlayerIdx,ts:Date.now()});try{Hs()}catch{}}catch{}}catch{}},hn=g=>{try{m?m(g):fs(typeof g=="number"?g:0)}catch{}},Cr=Xd(g=>g.addSample),[Zn,ps]=f.useState(""),[Qn,Cn]=f.useState(""),[Yt,Qe]=f.useState(0),[xs,Xt]=f.useState(!1),[Kt,nt]=f.useState(!1),[er,tr]=f.useState(!1),Ot=f.useRef(null),[Wr,kn]=f.useState("auto"),[j,R]=f.useState(!1),[_,O]=f.useState(!1),[D,oe]=f.useState(!1),G=f.useRef(null),X=on(g=>g.dartTimerEnabled),J=on(g=>g.dartTimerSeconds)||10,[ve,me]=f.useState(null),ye=f.useRef(null),pe=Lt(g=>g.paused),we=f.useRef(null),Fe=f.useRef(null),At=f.useRef(null),Ct=f.useRef(0),Oe=f.useRef(null),it=f.useRef(0),yn=f.useRef(!1),[Rt,ge]=f.useState(0),rt=f.useCallback(()=>{try{window.dispatchEvent(new CustomEvent("ndn:phone-camera-reconnect",{detail:{source:"camera-view",ts:Date.now()}}))}catch(g){console.warn("[CameraView] Phone camera reconnect dispatch failed:",g)}},[]);f.useEffect(()=>{const g=()=>{Q||O(!0)};return window.addEventListener("ndn:open-autoscore",g),()=>window.removeEventListener("ndn:open-autoscore",g)},[Q]),f.useEffect(()=>()=>{try{Ot.current&&clearTimeout(Ot.current)}catch{}},[]),f.useEffect(()=>{const g=()=>oe(!0);return window.addEventListener("ndn:open-scoring",g),()=>window.removeEventListener("ndn:open-scoring",g)},[]),f.useEffect(()=>{const g=()=>{Se(E=>E+1),ke(0),je.current=0,Ee(0),Xe([]),Tt(0),mt(0),nt(!1)};return window.addEventListener("ndn:darts-cleared",g),()=>window.removeEventListener("ndn:darts-cleared",g)},[]),f.useEffect(()=>{yt(g=>{if(be.length>g.length){const E=be.length-g.length;return[...g,...Array(E).fill(re)]}return be.length<g.length?g.slice(0,be.length):g})},[be,re]),f.useEffect(()=>{if(Ut.current&&(clearTimeout(Ut.current),Ut.current=null),Q){ht.current=!1,Jt.current=0,Te.current=null;return}return Ve?(Jt.current=performance.now(),Te.current=null,ht.current=!1,Bt.current=0,Ut.current=window.setTimeout(()=>{ht.current=!0,Ut.current=null},au)):(Jt.current=0,Te.current=null,ht.current=!1,Bt.current=0),()=>{Ut.current&&(clearTimeout(Ut.current),Ut.current=null),ht.current=!1,Bt.current=0,dn.current=null}},[Ve,Q]),f.useEffect(()=>{let g=!0;async function E(){try{if(!navigator?.mediaDevices?.enumerateDevices)return;const A=await navigator.mediaDevices.enumerateDevices();if(!g)return;le(A.filter(V=>V.kind==="videoinput"))}catch(A){console.warn("[CAMERA] enumerateDevices failed:",A)}}E();try{navigator.mediaDevices.addEventListener("devicechange",E)}catch{try{navigator.mediaDevices.ondevicechange=E}catch{}}return()=>{g=!1;try{navigator.mediaDevices.removeEventListener("devicechange",E)}catch{}}},[]),f.useEffect(()=>{const g=()=>{kn("manual"),R(!0)},E=()=>{kn("auto"),R(!1)};return window.addEventListener("ndn:open-manual",g),window.addEventListener("ndn:close-manual",E),()=>{window.removeEventListener("ndn:open-manual",g),window.removeEventListener("ndn:close-manual",E)}},[]),f.useEffect(()=>{Q&&(kn("manual"),O(!1))},[Q]),f.useEffect(()=>{try{const g=de.players[de.currentPlayerIdx],E=g?.legs?.[g.legs.length-1];if(!g)return;(!E||E.dartsThrown===0)&&Vr(A=>({...A,[g.id]:!1}))}catch{}},[de.currentPlayerIdx,de.players?.[de.currentPlayerIdx]?.legs?.length]),f.useEffect(()=>{const g=!!X&&Yn&&!pe&&ne<3;if(ye.current&&(clearInterval(ye.current),ye.current=null),!g){me(null);return}return me(J),ye.current=window.setInterval(()=>{me(E=>{const A=(E??J)-1;if(A<=0){try{et(0,"MISS 0","MISS")}catch{}return ye.current&&(clearInterval(ye.current),ye.current=null),0}return A})},1e3),()=>{ye.current&&(clearInterval(ye.current),ye.current=null)}},[X,J,ne,de.currentPlayerIdx,de?.inProgress,pe]),f.useEffect(()=>{if(!j)return;const g=setInterval(()=>{try{const E=x.current,A=G.current;if(!E||!A)return;const V=E.videoWidth||0,q=E.videoHeight||0;if(!V||!q)return;const U=A.clientWidth||640,te=A.clientHeight||360;A.width!==U&&(A.width=U),A.height!==te&&(A.height=te);const ae=A.getContext("2d");if(!ae)return;ae.imageSmoothingEnabled=!0;const he=Math.min(U/V,te/q),$e=Math.round(V*he),ue=Math.round(q*he),tt=Math.floor((U-$e)/2),En=Math.floor((te-ue)/2);ae.fillStyle="#000",ae.fillRect(0,0,U,te),ae.drawImage(E,tt,En,$e,ue)}catch(E){console.warn("Manual preview update error:",E)}},120);return()=>clearInterval(g)},[j]),f.useEffect(()=>()=>{},[]);const ft=H&&!Ce;async function kt(){if(!(Le||Y)){if(H&&Ce){Nt(!1);return}Nt(!0);try{const g=y?{video:{deviceId:{exact:y}},audio:!1}:{video:{facingMode:"environment"},audio:!1};Be("[CAMERA] Using constraints:",g);let E;try{E=await navigator.mediaDevices.getUserMedia(g),Be("[CAMERA] Got stream:",!!E)}catch(A){console.warn("[CAMERA] First attempt failed:",A);const V=A&&(A.name||A.code)||"";if(y&&(V==="OverconstrainedError"||V==="NotFoundError"))Be("[CAMERA] Trying fallback without deviceId"),E=await navigator.mediaDevices.getUserMedia({video:!0,audio:!1});else if(!y&&(V==="OverconstrainedError"||V==="NotFoundError"||V==="NotSupportedError"))Be("[CAMERA] Trying fallback for facingMode not supported"),E=await navigator.mediaDevices.getUserMedia({video:!0,audio:!1});else throw A}if(x.current){Be("[CAMERA] Setting stream to video element"),x.current.srcObject=E,Be("[CAMERA] Stream tracks:",E.getTracks().length,"video tracks:",E.getVideoTracks().length),x.current.addEventListener("loadeddata",()=>Be("[CAMERA] Video loadeddata")),x.current.addEventListener("canplay",()=>Be("[CAMERA] Video canplay")),x.current.addEventListener("play",()=>Be("[CAMERA] Video started playing")),x.current.addEventListener("error",A=>console.error("[CAMERA] Video error:",A));try{x.current.play(),Be("[CAMERA] Play called successfully")}catch(A){console.error("[CAMERA] Video play failed:",A),setTimeout(()=>{try{x.current?.play(),Be("[CAMERA] Retry play called")}catch(V){console.error("[CAMERA] Retry play failed:",V)}},100)}try{B.setVideoElementRef?.(x.current),B.setMediaStream?.(E),B.setMode?.("local"),B.setStreaming?.(!0)}catch(A){console.warn("[CAMERA] Failed to sync camera session with local stream:",A)}}else console.error("[CAMERA] Video element not found");$(!0);try{const A=await navigator.mediaDevices.enumerateDevices();le(A.filter(V=>V.kind==="videoinput")),Be("[CAMERA] Found cameras:",A.filter(V=>V.kind==="videoinput").length)}catch(A){console.warn("[CAMERA] Failed to enumerate devices:",A)}}catch(g){console.error("[CAMERA] Camera start failed:",g),alert("Camera permission denied or not available.")}finally{Nt(!1)}}}function pt(){try{const g=B.getMediaStream?.()||null;g&&g.getTracks().forEach(E=>E.stop())}catch{}if(x.current)try{x.current.srcObject=null}catch{}try{B.setMediaStream?.(null),B.setStreaming?.(!1),B.setVideoElementRef?.(null)}catch{}$(!1),Nt(!1)}f.useEffect(()=>{const g=x.current;if(!g)return;const E=B.getMediaStream?.()||null,V=(B.getVideoElementRef?.()||null)?.srcObject||null,q=E||V;if(q){g.srcObject!==q&&(g.srcObject=q),g.muted=!0,g.playsInline=!0;try{g.play?.()}catch{}Y||$(!0)}},[B.mode,B.isStreaming,Y,B]);function We(){try{if(!ie.current)return;const g=x.current,E=B.getVideoElementRef?.()||null,A=g&&g.videoWidth>0&&g.videoHeight>0?g:E||g;if(!A)return;const V=A,q=ie.current;q.width=V.videoWidth,q.height=V.videoHeight;const U=q.getContext("2d");if(!U)return;U.drawImage(V,0,0,q.width,q.height);const te=q.toDataURL("image/png");zt(te)}catch(g){console.warn("Capture error:",g)}}async function ct(){try{if(!navigator?.mediaDevices?.getUserMedia)throw new Error("getUserMedia not supported");const g=await navigator.mediaDevices.getUserMedia({video:!0,audio:!1});try{g.getTracks().forEach(E=>E.stop())}catch{}try{const E=await navigator.mediaDevices.enumerateDevices();le(E.filter(A=>A.kind==="videoinput"))}catch(E){console.warn("[CAMERA] enumerateDevices failed after permission:",E)}}catch(g){console.warn("[CAMERA] request permission failed:",g),alert("Failed to request camera permission. Please enable camera access in your browser.")}}function lt(){const[g,E]=f.useState(!1),[A,V]=f.useState(""),q=async U=>{if(Le)return;const te=K.find(ae=>ae.deviceId===U)?.label;C(U||void 0,te||"",!0),pt(),await new Promise(ae=>setTimeout(ae,150));try{await kt()}catch{}};return e.jsxs("div",{className:"absolute top-2 right-2 z-20 flex items-center gap-2 bg-black/40 rounded px-2 py-1 text-xs",children:[e.jsx("span",{children:"Cam:"}),e.jsxs("select",{onPointerDown:U=>{U.stopPropagation()},onMouseDown:U=>{U.stopPropagation()},onTouchStart:U=>{U.stopPropagation?.()},className:"bg-black/20 rounded px-1 py-0.5",value:y||"",onChange:async U=>{if(Le)return;const te=U.target.value||void 0,ae=K.find(he=>he.deviceId===te)?.label;C(te,ae||"",!0),pt(),await new Promise(he=>setTimeout(he,150));try{await kt()}catch(he){console.warn("Failed to start camera after device switch:",he),setTimeout(async()=>{try{await kt()}catch($e){console.error("Camera switch failed after retry:",$e),alert("Failed to switch camera. Please try again or refresh the page.")}},500)}},children:[e.jsx("option",{value:"",children:"Auto"}),e.jsx("option",{value:"manual",children:"~ Enter device ID ..."}),K.map(U=>e.jsx("option",{value:U.deviceId,children:U.label||(U.deviceId?`Camera (${U.deviceId.slice(0,6)})`:"Camera")},U.deviceId))]}),y==="manual"&&e.jsxs("div",{className:"flex items-center gap-2 ml-2",children:[e.jsx("input",{className:"input input--small",placeholder:"Device ID",value:A,onChange:U=>V(U.target.value)}),e.jsx("button",{className:"btn btn--ghost btn-sm",onClick:()=>q(A||void 0),children:"Apply"})]}),K.length===0&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-xs text-yellow-300",children:"No cameras found"}),e.jsx("button",{className:"btn btn--ghost btn-sm ml-2",onClick:ct,title:"Request camera permission",children:"Enable local camera"})]}),e.jsx("button",{className:"btn btn--ghost btn-sm ml-2",onClick:async()=>{try{const U=await navigator.mediaDevices.enumerateDevices();le(U.filter(te=>te.kind==="videoinput"))}catch(U){console.warn("Rescan failed:",U),alert("Failed to rescan devices. Ensure camera permissions are granted.")}},title:"Rescan connected cameras",children:"Rescan"}),e.jsx("div",{className:"flex items-center gap-2 ml-2",children:e.jsx("button",{className:"btn btn--ghost btn-sm",onClick:()=>{E(U=>!U),g||(async()=>{try{const U=await navigator.mediaDevices.enumerateDevices();le(U.filter(te=>te.kind==="videoinput"))}catch{}})()},children:g?"Hide devices":"Show devices"})}),g&&e.jsxs("div",{className:"mt-2 space-y-1 ml-1 text-xs",children:[e.jsx("div",{className:"opacity-60 text-xxs mb-1",children:"If you don't see your virtual camera (e.g., OBS), ensure the virtual camera is enabled and your browser has camera permission. Click Rescan after enabling."}),K.map(U=>{const te=String(U.label||"").toLowerCase().includes("obs")||String(U.label||"").toLowerCase().includes("virtual");return e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"truncate",children:[U.label||"Unnamed device"," ",te&&e.jsx("span",{className:"text-xs opacity-60 ml-1",children:"(OBS)"})]}),e.jsx("div",{className:"opacity-60 ml-1",children:U.deviceId}),e.jsx("button",{className:"btn btn--ghost btn-xs ml-2",onClick:()=>q(U.deviceId),children:"Select"})]},U.deviceId)})]})]})}f.useEffect(()=>{},[He,Ie,Ve,Q,H,z,W]),f.useEffect(()=>{if(Q||N!=="built-in")return;const g=gr.getState();let A=on.getState().preferredCameraLabel==="Phone Camera"?g.getVideoElementRef?.()||null:x.current;if(!A||!He||!Ie)return;let V=!1;const q=A,U=q.videoWidth||0,te=q.videoHeight||0,ae=ie.current;if(!ae)return;if(!we.current){let $e=60,ue=18,tt=3;U>0&&te>0&&U*te<1280*720&&($e=40,ue=16,tt=2),we.current=new Xo({minArea:$e,thresh:ue,requireStableN:tt,angMaxDeg:70})}const he=()=>{let $e=!1;if(!V){try{const ue=q.videoWidth||0,tt=q.videoHeight||0;if(!ue||!tt){Fe.current=requestAnimationFrame(he);return}ae.width!==ue&&(ae.width=ue),ae.height!==tt&&(ae.height=tt);const En=ae.getContext("2d",{willReadFrequently:!0});if(!En){Fe.current=requestAnimationFrame(he);return}En.drawImage(q,0,0,ue,tt);const xt=En.getImageData(0,0,ue,tt);Bt.current++;const Et=ir(He,{x:0,y:0}),qn=ir(He,{x:Z.doubleOuter,y:0}),wn=ue/Ie.w,_n=tt/Ie.h,Jr=Et.x*wn,Ea=Et.y*_n,bi=qn.x*wn,gi=qn.y*_n,vi=Math.hypot(bi-Jr,gi-Ea)*1.08,gs=we.current;Rt>=0&&gs.setROI(Jr,Ea,Math.max(24,Math.min(Math.max(ue,tt),vi)));{const bt=!pe,sn=ne<3,Er=ht.current,vs=Bt.current>rs;Be("CameraView: detection conditions",{condPaused:bt,condPending:sn,condArmed:Er,condFrame:vs,frameCount:Bt.current,minFrames:rs})}if(!pe&&ne<3&&ht.current&&Bt.current>rs){Be("CameraView: entering detection branch",{paused:pe,pendingDarts:ne,detectionArmed:ht.current,frameCount:Bt.current,DETECTION_MIN_FRAMES:rs});const bt=gs.detect(xt);Be("CameraView: raw detection",bt);const sn=performance.now();if(Te.current&&sn-Te.current.firstTs>900&&(Te.current=null),bt&&bt.confidence>=ou){Be("CameraView: detected raw",bt.confidence,bt.tip),Be("CameraView: detected raw",bt.confidence,bt.tip);const Er=Jt.current>0&&sn-Jt.current<su;let vs=!1;const In=$l(ae,bt.tip,6),Fn={x:In.x/wn,y:In.y/_n},jn=lo(He,Fn);let an=null;try{an=$n(He,Fn)}catch{an=null}if(a)try{const se=`${jn.base}|${jn.ring}|${jn.mult}`,Ke=performance.now();se===Oe.current&&Ke-it.current<Bn||a(jn.base,jn.ring,{sector:jn.sector??null,mult:Math.max(0,Number(jn.mult)||0),calibrationValid:!!Kr,pBoard:an})===!0&&(Oe.current=se,it.current=Ke,vs=!0)}catch{}const Dt=jn.ring,It=jn.base,lr=`${Dt} ${It>0?It:""}`.trim(),Ir=jn.sector??null,dr=Math.max(0,Number(jn.mult)||0);let rr=!1;Be("CameraView: detection details",{value:It,ring:Dt,calibrationGood:Kr,tipInVideo:ys,pCalInImage:ws,isGhost:js});const yi=6,Yr=3,Xr=3,Kr=!!He&&!!Ie&&(Wt||(typeof Ue=="number"?Ue:0)<=yi),ys=In.x>=-Yr&&In.x<=ue+Yr&&In.y>=-Yr&&In.y<=tt+Yr,ws=Ie?Fn.x>=-Xr&&Fn.x<=Ie.w+Xr&&Fn.y>=-Xr&&Fn.y<=Ie.h+Xr:!1;let wi=!1;try{if(He){const se=$n(He,Fn);wi=Math.hypot(se.x,se.y)<=Z.doubleOuter+3}}catch{}const js=!Kr||!ys||!ws;ut(lr),ln(It),xe(Dt);const Ia=async se=>{Be("CameraView: applyAutoHit",se.value,se.ring,se.sector),Be("CameraView: applyAutoHit",se.value,se.ring,se.sector);const Ke=performance.now();if(yn.current)return;yn.current=!0;try{window.setTimeout(()=>{yn.current=!1},Math.max(120,Bn))}catch{}const Je=`${se.value}|${se.ring}|${se.mult}`;if(!(Ke-Ct.current<Bn&&Je===At.current)){if(At.current=Je,Ct.current=Ke,se.value>0){nt(!0),tr(!0);try{Ot.current&&clearTimeout(Ot.current)}catch{}Ot.current=window.setTimeout(()=>{tr(!1),Ot.current=null},1500);try{if(d==="camera"){let dt=!1;if(a)try{const gt=Je,Vt=performance.now();gt===Oe.current&&Vt-it.current<Bn||await Promise.resolve(a(se.value,se.ring,{sector:se.sector,mult:se.mult,calibrationValid:!0,pBoard:an}))&&(dt=!0,Oe.current=gt,it.current=Vt)}catch{}if(!dt){try{Be("CameraView: cameraAutoCommit committing locally",se.value,se.label,se.ring),et(se.value,se.label,se.ring,{calibrationValid:!0,pBoard:an,source:"camera"})}catch{}try{Be("CameraView: calling callAddVisit from cameraAutoCommit",se.value),vn(se.value,1,{visitTotal:se.value,calibrationValid:!0,pBoard:an,source:"camera"})}catch{}}try{const gt=Je,Vt=performance.now();!a||gt===Oe.current&&Vt-it.current<Bn||(a&&a(se.value,se.ring,{sector:se.sector,mult:se.mult,calibrationValid:!0,pBoard:an}),Oe.current=gt,it.current=Vt)}catch{}}else if(d==="parent"){let dt=!1;if(a)try{const gt=Je,Vt=performance.now();gt===Oe.current&&Vt-it.current<Bn||(dt=!!await Promise.resolve(a(se.value,se.ring,{sector:se.sector,mult:se.mult,calibrationValid:!0,pBoard:an})),dt&&(Oe.current=gt,it.current=Vt))}catch{}dt||et(se.value,se.label,se.ring,{calibrationValid:!0,pBoard:an,source:"camera"}),dt&&(Oe.current=Je,it.current=performance.now())}else{try{et(se.value,se.label,se.ring,{calibrationValid:!0,pBoard:an,source:"camera"})}catch{}try{const dt=Je,gt=performance.now();!a||dt===Oe.current&&gt-it.current<Bn||(a&&a(se.value,se.ring,{sector:se.sector,mult:se.mult,calibrationValid:!0,pBoard:an}),Oe.current=dt,it.current=gt)}catch{}}}catch{}}else nt(!1);if(se.value<=0)try{a&&a(se.value,se.ring,{sector:se.sector,mult:se.mult})}catch{}}};if(Er)Te.current=null,rr=!0;else if(js){Be("CameraView: ignoring ghost detection (calibrationGood:",Kr,"tipInVideo:",ys,"pCalInImage:",ws,")"),Te.current=null,nt(!1),rr=!1;try{a&&a(It,Dt,{sector:Ir,mult:dr,calibrationValid:!1,pBoard:null})}catch{}wr({ts:sn,label:lr,value:It,ring:Dt,pCal:Fn,tip:In,confidence:bt.confidence,ready:!1,accepted:!1,warmup:Er})}else if(Dt==="MISS"||It<=0){Te.current=null,nt(!1);try{a&&a(It,Dt,{sector:Ir,mult:dr,calibrationValid:!0,pBoard:an})}catch{}rr=!0}else{const se=Te.current;!se||se.value!==It||se.ring!==Dt?Te.current={value:It,ring:Dt,label:lr,sector:Ir,mult:dr,firstTs:sn,frames:1}:Te.current={...se,label:lr,frames:se.frames+1};const Ke=Te.current,Je=sn-Ke.firstTs,dt=Ke.frames>=nu||Je>=ru,gt=sn-nn.current>=Bn;dt&&gt&&(Be("CameraView: candidate ready and cooled",{value:It,ring:Dt,frames:Ke.frames,nowPerf:sn}),Ia(Ke),$e=!0,Te.current=null,nn.current=sn,rr=!0)}wr({ts:sn,label:lr,value:It,ring:Dt,pCal:Fn,tip:In,confidence:bt.confidence,ready:rr,accepted:rr&&It>0&&Dt!=="MISS",warmup:Er});try{if(It>0&&Dt!=="MISS"&&!js){const Ke=L.current;if(Ke){const Je=Ke.getContext("2d");if(Je){const dt=In.x/ue*Ke.width,gt=In.y/tt*Ke.height;if(Je.save(),Je.beginPath(),Je.strokeStyle="#f59e0b",Je.lineWidth=2,Je.arc(dt,gt,6,0,Math.PI*2),Je.stroke(),bt.axis){const Vt=bt.axis,Zr=Vt.x1/ue*Ke.width,Ns=Vt.y1/tt*Ke.height,Ss=Vt.x2/ue*Ke.width,ji=Vt.y2/tt*Ke.height;Je.beginPath(),Je.moveTo(Zr,Ns),Je.lineTo(Ss,ji),Je.stroke()}if(bt.bbox){const Vt=bt.bbox.x/ue*Ke.width,Zr=bt.bbox.y/tt*Ke.height,Ns=bt.bbox.w/ue*Ke.width,Ss=bt.bbox.h/tt*Ke.height;Je.strokeStyle="#22d3ee",Je.strokeRect(Vt,Zr,Ns,Ss)}Je.restore()}}}}catch{}if(rr&&!$e){gs.accept(xt,bt);try{let se=!1;if(a)try{const Ke=`${It}|${Dt}|${dr}`,Je=performance.now();Ke===Oe.current&&Je-it.current<Bn||a(It,Dt,{sector:Ir,mult:dr,calibrationValid:!0,pBoard:an})===!0&&(Oe.current=Ke,it.current=Je,se=!0)}catch{}se||Ia({value:It,ring:Dt,label:lr,sector:Ir,mult:dr,firstTs:sn,frames:1})}catch{}}}else Te.current&&sn-Te.current.firstTs>800&&(Te.current=null)}}catch{}Fe.current=requestAnimationFrame(he),dn.current=he}};return Fe.current=requestAnimationFrame(he),()=>{V=!0,Fe.current&&cancelAnimationFrame(Fe.current),Fe.current=null}},[Q,N,Ve,He,Ie,pe,ne,Rt,wr]);const rn=f.useCallback(async()=>{try{if(H){const g=K.find(E=>E.kind==="videoinput");g?C(g.deviceId,g.label||"",!0):C(void 0,"",!0)}await kt()}catch(g){console.warn("[CameraView] Local camera fallback failed:",g)}},[K,H,C]);f.useEffect(()=>{try{if(z||y)return;const g=K.find(E=>/obs|virtual/i.test(String(E.label||"")));g&&C(g.deviceId,g.label||"",!0)}catch{}},[K,y,z,C]),f.useEffect(()=>{try{xr.getState().setCalibrationStatus({hasHomography:!!He,imageSize:Ie,overlaySize:Mt})}catch{}},[He,Ie]),f.useEffect(()=>{try{if(!L.current||!Ie)return;const g=L.current;typeof Ie.w=="number"&&typeof Ie.h=="number"&&(g.width!==Ie.w||g.height!==Ie.h)&&(g.width=Ie.w,g.height=Ie.h)}catch{}},[L,Ie]),f.useEffect(()=>{if(N!=="external-ws"||!P)return;const g=Yd(P,E=>{if(!(!ht.current||performance.now()-Jt.current<5e3))if(a){try{a(E.value,E.ring,{sector:E.sector??null,mult:E.mult??0})}catch{}try{Cr({playerId:de.players[de.currentPlayerIdx]?.id??null,sector:E.sector??null,mult:E.mult??0,ring:E.ring,ts:Date.now()})}catch{}}else{const A=E.ring==="INNER_BULL"?"INNER_BULL 50":E.ring==="BULL"?"BULL 25":`${E.ring[0]}${E.value/(E.mult||1)||E.value} ${E.value}`;et(E.value,A,E.ring,{calibrationValid:!1,pBoard:null,source:"camera"});try{Cr({playerId:de.players[de.currentPlayerIdx]?.id??null,sector:E.sector??null,mult:E.mult??0,ring:E.ring,ts:Date.now()})}catch{}}});return()=>g.close()},[N,P]);function Dn(g){if(!L.current||!He||!Ie)return;const E=L.current.getBoundingClientRect(),A=g.clientX-E.left,V=g.clientY-E.top,q=L.current.width&&Ie.w?L.current.width/Ie.w:1,U=L.current.height&&Ie.h?L.current.height/Ie.h:1,te={x:A/q,y:V/U},ae=lo(He,te),he=`${ae.ring} ${ae.base>0?ae.base:""}`.trim();ut(he),ln(ae.base),xe(ae.ring),nt(!0);try{if(s&&a){a(ae.base,ae.ring,{sector:ae.sector,mult:ae.mult});try{Cr({playerId:de.players[de.currentPlayerIdx]?.id??null,sector:ae.sector??null,mult:ae.mult??0,ring:ae.ring,ts:Date.now()})}catch{}nt(!1)}}catch{}}function fn(g){const E=g.trim().toUpperCase();if(!E)return null;const A=E==="BULL"||E==="50"||E==="DBULL"||E==="IBULL",V=E==="25"||E==="OBULL";if(A)return{label:"INNER_BULL 50",value:50,ring:"INNER_BULL"};if(V)return{label:"BULL 25",value:25,ring:"BULL"};const q=E.match(/^(S|D|T)?\s*(\d{1,2})$/);if(!q)return null;const U=q[1]||"S",te=parseInt(q[2],10);if(te<1||te>20)return null;const ae=U==="S"?1:U==="D"?2:3,he=U==="S"?"SINGLE":U==="D"?"DOUBLE":"TRIPLE";return{label:`${U}${te} ${te*ae}`,value:te*ae,ring:he}}function Ln(){const g=de;if(!g.players.length)return g.startingScore;const E=g.players[g.currentPlayerIdx],A=E.legs[E.legs.length-1];return A?A.totalScoreRemaining:g.startingScore}function et(g,E,A,V){if(F&&vt){if(!er){tr(!0);try{Ot.current&&clearTimeout(Ot.current)}catch{}Ot.current=window.setTimeout(()=>{tr(!1),Ot.current=null},1200)}return}const q=V??{calibrationValid:!1,pBoard:null,source:"manual"};if(c==="custom"){if(i)try{i(g,A,{label:E})}catch{}if((je.current||0)>=3){ke(1),Ee(g),Xe([{label:E,value:g,ring:A,meta:q}]);return}const xt=ne+1;ke(xt),je.current=xt,Ee(Et=>Et+g),Xe(Et=>[...Et,{label:E,value:g,ring:A,meta:q}]);return}if((je.current||0)>=3){const xt=_e,Et=ne;vn(xt,Et,{preOpenDarts:en||0,doubleWindowDarts:ot||0,finishedByDouble:!1,visitTotal:xt});try{const _n=de.players[de.currentPlayerIdx]?.name;_n&&hr(_n,Et,xt)}catch{}const qn=!un||Rn||A==="DOUBLE"||A==="INNER_BULL",wn=qn?g:0;ke(1),je.current=1,Ee(wn),Xe([{label:E,value:wn,ring:A,meta:q}]),Tt(qn?0:1),mt(0),un&&!Rn&&(A==="DOUBLE"||A==="INNER_BULL")&&Sr(!0),gn({score:xt,darts:Et,finished:!1});return}const U=(je.current||0)+1,ae=!un||Rn||A==="DOUBLE"||A==="INNER_BULL"?g:0;un&&!Rn&&(A==="DOUBLE"||A==="INNER_BULL")&&Sr(!0);const he=_e+ae,ue=Ln()-he,tt=ue===0&&(A==="DOUBLE"||A==="INNER_BULL");if(ue<0||ue===1||ue===0&&!tt){const Et=(en||0)+(un&&!Rn&&!(A==="DOUBLE"||A==="INNER_BULL")?1:0),qn=ue,wn=ue+ae,_n=wn>50&&qn<=50||wn<=50?1:0,Jr=(ot||0)+_n;vn(0,U,{preOpenDarts:Et,doubleWindowDarts:Jr,finishedByDouble:!1,visitTotal:0}),ke(0),je.current=0,Ee(0),Xe([]),Tt(0),mt(0),gn({score:0,darts:U,finished:!1});return}ke(U),je.current=U,Ee(he),Xe(xt=>[...xt,{label:E,value:ae,ring:A,meta:q}]),un&&!Rn&&!(A==="DOUBLE"||A==="INNER_BULL")&&Tt(xt=>(xt||0)+1);{const xt=ue,Et=ue+ae;(Et>50&&xt<=50||Et<=50)&&mt(wn=>(wn||0)+1)}if(tt){vn(he,U,{preOpenDarts:en||0,doubleWindowDarts:ot||0,finishedByDouble:!0,visitTotal:he}),hn(he),ke(0),je.current=0,Ee(0),Xe([]),Tt(0),mt(0),gn({score:he,darts:U,finished:!0});return}U>=3&&(vn(he,U,{preOpenDarts:en||0,doubleWindowDarts:ot||0,finishedByDouble:!1,visitTotal:he}),ke(0),je.current=0,Ee(0),Xe([]),Tt(0),mt(0),gn({score:he,darts:U,finished:!1}))}function bs(){if(!(F&&vt)&&ze){if(a)try{a(Me,Ze,void 0)}catch{}else et(Me,ze,Ze);Qe(0),nt(!1)}}function cr(){if(F&&vt)return;const g=fn(Pe);if(!g){alert("Enter like T20, D16, 5, 25, 50");return}if(!Kt||!ze||Ze==="MISS"||Me===0){const E=Yt+1;Qe(E),E>=5&&Xt(!0)}else Qe(0);et(g.value,g.label,g.ring),Ge(""),nt(!1)}function qr(){if(F&&vt)return;const g=fn(Pe);if(!g){alert("Enter like T20, D16, 5, 25, 50");return}if(ne===0||be.length===0){cr();return}if(c==="custom"){if(!Kt||!ze||Ze==="MISS"||Me===0){const ue=Yt+1;Qe(ue),ue>=5&&Xt(!0)}else Qe(0);if(Xe(ue=>[...ue.slice(0,-1),{label:g.label,value:g.value,ring:g.ring}]),h)try{h(g.value,g.ring,{label:g.label})}catch{}Ge(""),nt(!1);return}if(!Kt||!ze||Ze==="MISS"||Me===0){const ue=Yt+1;Qe(ue),ue>=5&&Xt(!0)}else Qe(0);const E=be[be.length-1],A=ne-1,V=_e-(E?.value||0),q=Ln(),U=V+g.value,te=A+1,ae=q-U,he=ae===0&&(g.ring==="DOUBLE"||g.ring==="INNER_BULL");if(ae<0||ae===1||ae===0&&!he){vn(0,te);try{const ue=de.players[de.currentPlayerIdx]?.name;ue&&hr(ue,te,0)}catch{}ke(0),je.current=0,Ee(0),Xe([]),gn({score:0,darts:te,finished:!1}),Ge(""),nt(!1);return}if(ke(te),je.current=te,Ee(U),Xe(ue=>[...ue.slice(0,-1),{label:g.label,value:g.value,ring:g.ring}]),he){vn(U,te),hn(U);try{const ue=de.players[de.currentPlayerIdx]?.name;ue&&hr(ue,te,U)}catch{}ke(0),je.current=0,Ee(0),Xe([]),gn({score:U,darts:te,finished:!0}),Ge(""),nt(!1);return}if(te>=3){vn(U,te);try{const ue=de.players[de.currentPlayerIdx]?.name;ue&&hr(ue,te,U)}catch{}ke(0),je.current=0,Ee(0),Xe([]),gn({score:U,darts:te,finished:!1})}Ge(""),nt(!1)}function kr(){Xt(!1),Qe(0);try{window.dispatchEvent(new CustomEvent("ndn:request-calibrate"))}catch{}}function Wn(){Pt(),Xt(!1),Qe(0)}f.useEffect(()=>{function g(E){try{const V=document.activeElement?.tagName?.toLowerCase();E.key==="m"&&V!=="input"&&V!=="textarea"&&(kn("manual"),R(!0))}catch{}}return window.addEventListener("keydown",g),()=>window.removeEventListener("keydown",g)},[]);function nr(g,E){if(ne>=3||F&&vt)return;const A=g*(E==="S"?1:E==="D"?2:3),V=E==="S"?"SINGLE":E==="D"?"DOUBLE":"TRIPLE";if(!Kt||!ze||Ze==="MISS"||Me===0){const q=Yt+1;Qe(q),q>=5&&Xt(!0)}else Qe(0);et(A,`${E}${g} ${A}`,V),nt(!1)}function Hr(){if(ne===0)return;const g=be[be.length-1];ke(E=>E-1),je.current=Math.max(0,(je.current||0)-1),Ee(E=>E-(g?.value||0)),Xe(E=>E.slice(0,-1))}function Gr(){if(ne===0||F&&vt)return;if(Nn){try{window.alert("Cannot commit: pending camera detections are not calibration validated for online matches")}catch{}return}if(c==="custom"){ke(0),je.current=0,je.current=0,Ee(0),Xe([]);return}const g=_e,E=ne;vn(g,E);try{const A=de.players[de.currentPlayerIdx]?.name;A&&hr(A,E,g)}catch{}ke(0),je.current=0,Ee(0),Xe([]),gn({score:g,darts:E,finished:!1})}return e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-4",children:[n&&e.jsx("div",{className:"lg:col-span-2",children:e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[!Q&&e.jsx("button",{className:`btn px-3 py-1 text-sm ${Wr==="auto"?"tab--active":""}`,onClick:()=>{kn("auto"),R(!1),O(!0)},children:"Autoscore"}),e.jsx("button",{className:`btn px-3 py-1 text-sm ${Wr==="manual"?"tab--active":""}`,onClick:()=>{kn("manual"),R(!0)},title:"Open Manual Correction",children:"Manual Correction"}),Q&&e.jsx("span",{className:"text-xs opacity-70",children:"Manual scoring mode active"})]})}),!o&&!Q?e.jsxs("div",{className:"card relative camera-fullwidth-card lg:col-span-2",children:[e.jsx("h2",{className:"text-xl font-semibold mb-3",children:"Camera"}),e.jsxs(ho,{storageKey:"ndn:camera:size",className:"relative rounded-2xl overflow-hidden bg-black",defaultWidth:480,defaultHeight:360,minWidth:360,minHeight:270,maxWidth:800,maxHeight:600,autoFill:!0,children:[e.jsx(lt,{}),(()=>{const g=S||on.getState().cameraAspect||"wide",E=(M||on.getState().cameraFitMode||"fit")==="fit",A=g==="square"?"absolute left-0 top-1/2 -translate-y-1/2 min-w-full min-h-full object-cover object-left bg-black":E?"absolute inset-0 w-full h-full object-contain object-center bg-black":"absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 min-w-full min-h-full w-auto h-auto object-cover object-center bg-black",V=g==="square"?"relative w-full mx-auto aspect-square bg-black":"relative w-full aspect-[4/3] bg-black",q=()=>e.jsxs("div",{className:V,children:[e.jsx("video",{ref:x,className:A,playsInline:!0,muted:!0,autoPlay:!0}),e.jsx("canvas",{ref:L,className:"absolute inset-0 w-full h-full",onClick:Dn}),e.jsxs("div",{className:"absolute top-2 left-1/2 -translate-x-1/2 z-20 flex items-center gap-3 cursor-pointer select-none",onDoubleClick:hs,"aria-label":`Visit status: ${be[0]?be[0].value>0?"hit":"miss":"pending"}, ${be[1]?be[1].value>0?"hit":"miss":"pending"}, ${be[2]?be[2].value>0?"hit":"miss":"pending"}`,children:[[0,1,2].map(U=>{const te=be[U],ae=Ne[U],he=!te,$e=!!te&&ae===re,ue=typeof te?.value=="number"?te.value>0:!1,tt=(te?.ring&&te.ring!=="MISS")??!1,xt=$e?$e&&(ue||tt)?"bg-emerald-400":"bg-rose-500":"bg-gray-500/70",Et=$e&&!he;return e.jsx("span",{className:`visit-dot ${Et?"active":"inactive"} ${xt}`},U)}),X&&ve!==null&&e.jsxs("span",{className:"px-2 py-0.5 rounded bg-black/60 text-white text-xs font-semibold",children:[Math.max(0,ve),"s"]})]}),F&&vt?e.jsx("div",{className:"absolute bottom-3 left-1/2 -translate-x-1/2 z-20 bg-black/70 text-amber-200 text-xs font-semibold px-3 py-1 rounded-full shadow",children:"Remove darts to continue"}):null]});return H?Ce?q():e.jsx("div",{className:"w-full h-full flex flex-col items-center justify-center bg-gradient-to-br from-blue-900/50 to-purple-900/50",children:e.jsxs("div",{className:"text-center space-y-3 max-w-xs mx-auto",children:[e.jsx("div",{className:"text-4xl",children:"📱"}),e.jsx("div",{className:"text-lg font-semibold text-blue-100",children:"Phone camera selected"}),e.jsx("p",{className:"text-sm text-slate-300",children:"Start streaming from the Calibrator tab or reconnect below."}),e.jsxs("div",{className:"flex items-center justify-center gap-2 flex-wrap",children:[e.jsx("button",{className:"btn bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 text-sm",onClick:rt,children:"Reconnect Phone"}),e.jsx("button",{className:"btn bg-slate-700 hover:bg-slate-800 text-white px-3 py-1 text-sm",onClick:()=>{try{B.setShowOverlay?.(!0)}catch{}},children:"Show Overlay"}),e.jsx("button",{className:"btn bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-1 text-sm",onClick:rn,disabled:!K.length,children:"Use Local Camera"})]})]})}):q()})()]}),e.jsxs("div",{className:"mt-3 flex items-center justify-between gap-2",children:[e.jsxs("button",{className:"btn btn--ghost px-3 py-1 text-xs font-semibold",onClick:()=>wt(g=>!g),children:[Re?"Hide":"Show"," detection log"]}),e.jsxs("span",{className:"text-xs text-slate-400",children:["Recent detections: ",I.length]})]}),Re&&e.jsx("div",{className:"mt-2 rounded-2xl border border-white/15 bg-slate-900/80 p-3 text-xs text-white font-mono max-h-36 overflow-y-auto space-y-1",children:I.length===0?e.jsx("div",{className:"text-center text-slate-400",children:"No autoscore detections yet."}):I.slice().reverse().map(g=>e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsx("span",{className:"truncate flex-1",title:`Value ${g.value} ${g.ring}`,children:g.label.padEnd(6," ")}),e.jsx("span",{className:"text-slate-400",children:g.confidence.toFixed(2)}),e.jsx("span",{className:`px-2 rounded-full text-[10px] font-semibold ${g.accepted?"bg-emerald-500/80":g.ready?"bg-amber-500/80":"bg-rose-500/80"}`,children:g.accepted?"accepted":g.ready?"queued":"ignored"})]},g.ts))}),Yn?e.jsx("div",{className:"absolute top-3 right-3 z-30",children:(()=>{let g="bg-white/90 text-slate-800",E="Manual Correction (M)";Kt&&(!!ze&&Ze!=="MISS"&&Me>0?(g="bg-emerald-600 text-white",E=`Manual Correction (M) — Autoscore: ${ze} (confirmed)`):(g="bg-amber-400 text-black",E=`Manual Correction (M) — Autoscore ambiguous: ${ze||"—"}`));const A="px-4 py-2 rounded-full text-base font-semibold shadow-sm hover:opacity-90",V=Kt&&!!ze&&Ze!=="MISS"&&Me>0,q=er&&V?"ring-4 ring-emerald-400/60 animate-ping":Kt&&!V?"animate-pulse":"";return e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{className:`${A} ${g} ${q}`,onClick:()=>{kn("manual"),R(!0)},title:E,children:"Manual"}),e.jsx("button",{"data-testid":"commit-visit-btn",className:"px-3 py-1 rounded bg-emerald-500 text-white text-sm",onClick:Gr,disabled:ne===0||Nn,title:"Commit visit",children:"Commit"})]})})()}):null,e.jsxs("div",{className:"flex flex-wrap items-center gap-2 mt-3",children:[H?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:`text-sm px-3 py-2 rounded border flex-1 min-w-[200px] ${Ce?"bg-emerald-500/10 border-emerald-400/40 text-emerald-100":"bg-amber-500/10 border-amber-400/40 text-amber-100"}`,children:Ce?"📱 Phone camera stream active":"📱 Waiting for phone camera stream"}),e.jsx("button",{className:"btn bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 text-sm",onClick:rt,children:"Reconnect Phone"}),e.jsx("button",{className:"btn bg-slate-700 hover:bg-slate-800 text-white px-3 py-1 text-sm",onClick:()=>{try{B.setShowOverlay?.(!B.showOverlay)}catch{}},children:B.showOverlay?"Hide Overlay":"Show Overlay"}),e.jsx("button",{className:"btn bg-rose-600 hover:bg-rose-700 text-white px-3 py-1 text-sm",disabled:!Ce,onClick:()=>{try{B.clearSession?.()}catch{}},children:"Stop Phone Feed"}),ft&&e.jsx("button",{className:"btn bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-1 text-sm",onClick:rn,disabled:!K.length,children:"Use Local Camera"})]}):e.jsx(e.Fragment,{children:Y?e.jsx("button",{className:"btn bg-rose-600 hover:bg-rose-700",onClick:pt,children:"Stop Camera"}):e.jsx("button",{className:"btn",onClick:kt,disabled:Le,children:Le?"Connecting Camera...":"Connect Camera"})}),!Q&&e.jsx("button",{className:"btn bg-slate-700 hover:bg-slate-800",onClick:jr,title:"Open phone, WiFi, and USB camera options",children:"Camera Devices"}),e.jsx("button",{className:"btn btn--ghost px-3 py-1 text-sm",onClick:()=>ee(!W),title:"Toggle the board guide overlay",children:W?"Show board guides":"Hide board guides"}),e.jsx("button",{className:`btn ${p?"bg-rose-600 hover:bg-rose-700 text-white":"bg-emerald-600 hover:bg-emerald-700 text-white"}`,onClick:()=>k(!p),title:"Toggle whether the camera is used for scoring",children:p?"Disable camera mode":"Enable camera mode"}),e.jsx("button",{className:"btn",onClick:We,disabled:!Ve,children:"Capture Still"}),de?.inProgress&&e.jsxs(e.Fragment,{children:[e.jsx(fi,{compact:!0}),e.jsx("button",{className:"btn bg-rose-600 hover:bg-rose-700 text-white px-3 py-1 text-sm",onClick:()=>qt(!0),children:"Quit / Pause"}),xn&&e.jsx(Kd,{onClose:()=>qt(!1),onQuit:()=>{try{window.dispatchEvent(new CustomEvent("ndn:match-quit"));try{Pn({type:"quit"})}catch{}}catch{}qt(!1)},onPause:g=>{const E=Date.now()+g*60*1e3;try{Lt.getState().setPaused(!0,E);try{Pn({type:"pause",pauseEndsAt:E,pauseStartedAt:Date.now()})}catch{}}catch{}qt(!1)}}),e.jsx("button",{className:"btn btn--ghost px-3 py-1 text-sm",onClick:()=>{try{Hs(),window.open(`${window.location.origin}${window.location.pathname}?match=1`,"_blank")}catch{}},children:"Open match in new window"}),e.jsx("button",{className:`btn btn--ghost px-3 py-1 text-sm ${_t?"bg-emerald-600 text-black":""}`,onClick:()=>{try{const g=x.current;if(!g)return;_t?(xi(),Ft(!1)):(tu(g,600),Ft(!0))}catch{}},children:_t?"Stop preview forward":"Forward preview (PoC)"}),e.jsx("button",{className:"btn btn--ghost px-3 py-1 text-sm",onClick:async()=>{try{document.documentElement.requestFullscreen?await document.documentElement.requestFullscreen():document.body.requestFullscreen&&await document.body.requestFullscreen()}catch{}},children:"Open full screen"})]}),e.jsx("button",{className:"btn bg-slate-700 hover:bg-slate-800",disabled:!Ve,onClick:()=>{we.current=null,ge(g=>g+1)},children:"Reset Autoscore Background"}),e.jsx("button",{className:"btn bg-slate-700 hover:bg-slate-800",onClick:()=>{try{window.dispatchEvent(new Event("ndn:camera-reset"))}catch{}},children:"Reset Camera Size"})]})]}):null,Yn?e.jsx("div",{className:"fixed bottom-6 right-6 z-50",children:e.jsx("button",{className:"btn btn--primary rounded-full w-12 h-12 flex items-center justify-center shadow-lg",title:"Open Manual Correction (M)",onClick:()=>{kn("manual"),R(!0)},children:"✏️"})}):null,!o&&Q&&e.jsxs("div",{className:"card",children:[e.jsx("h2",{className:"text-xl font-semibold mb-3",children:"Manual Scoring"}),e.jsx("p",{className:"text-sm opacity-80 mb-3",children:"Camera-based autoscore is disabled. Use the manual visit input or open the Manual Correction panel to record darts."}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsx("button",{className:"btn",onClick:()=>{R(!0),kn("manual")},children:"Open Manual Correction"}),e.jsx("button",{className:"btn btn--ghost",onClick:()=>{try{window.dispatchEvent(new Event("ndn:open-scoring"))}catch{}},children:"Manage Pending Visit"})]})]}),e.jsx("canvas",{ref:ie,className:"hidden"}),_&&!Q&&e.jsx("div",{className:"fixed inset-0 bg-black/60 z-[100]",role:"dialog","aria-modal":"true",children:e.jsx("div",{className:"absolute inset-0 flex items-center justify-center p-4",children:e.jsxs(hi,{storageKey:"ndn:autoscore:size",className:"w-full max-w-3xl",defaultWidth:720,defaultHeight:520,minWidth:420,minHeight:320,maxWidth:1400,maxHeight:900,initialFitHeight:!0,children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h2",{className:"text-xl font-semibold",children:"Autoscore"}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("button",{className:"btn btn--ghost",onClick:()=>O(!1),children:"Close"})})]}),e.jsx("div",{className:"text-sm opacity-80 mb-3",children:"Click the camera overlay to autoscore. Use Manual Correction if the last auto is off."}),e.jsxs("div",{className:"flex items-center gap-2 mb-3 flex-wrap",children:[e.jsx("span",{className:"font-semibold",children:"Last auto:"}),e.jsx("span",{children:ze||"—"}),e.jsx("button",{className:"btn",onClick:bs,disabled:ne>=3,children:"Add Auto Dart"}),Yt>0&&e.jsxs("span",{className:"text-sm opacity-80",children:["No-registers: ",Yt,"/3"]})]}),e.jsxs("div",{className:"mt-2",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"Quick entry"}),e.jsxs("div",{className:"flex flex-wrap gap-2 mb-3",children:[e.jsx("button",{className:"btn",disabled:ne>=3,onClick:()=>{if(!Kt||!ze||Ze==="MISS"||Me===0){const g=Yt+1;Qe(g),g>=5&&Xt(!0)}else Qe(0);et(25,"BULL 25","BULL"),nt(!1)},children:"25"}),e.jsx("button",{className:"btn",disabled:ne>=3,onClick:()=>{if(!Kt||!ze||Ze==="MISS"||Me===0){const g=Yt+1;Qe(g),g>=5&&Xt(!0)}else Qe(0);et(50,"INNER_BULL 50","INNER_BULL"),nt(!1)},children:"50"})]}),e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx("input",{className:"input w-full max-w-sm",list:"autoscore-quick-list",placeholder:"Type or select (e.g., D16, T20, S5)",value:Zn,onChange:g=>ps(g.target.value.toUpperCase()),onKeyDown:g=>{if(g.key==="Enter"){const E=Zn.match(/^(S|D|T)(\d{1,2})$/);E&&nr(parseInt(E[2],10),E[1])}}}),e.jsx("datalist",{id:"autoscore-quick-list",children:["D","S","T"].map(g=>Array.from({length:20},(E,A)=>A+1).map(E=>e.jsx("option",{value:`${g}${E}`},`${g}${E}`)))}),e.jsx("button",{className:"btn",disabled:!Zn||ne>=3,onClick:()=>{const g=Zn.match(/^(S|D|T)(\d{1,2})$/);if(!g)return;const E=g[1],A=parseInt(g[2],10);nr(A,E)},children:"Add"})]})]})]})})}),j&&e.jsx("div",{className:"fixed inset-0 bg-black/60 z-[100]",role:"dialog","aria-modal":"true",children:e.jsx("div",{className:"absolute inset-0 flex flex-col",children:e.jsxs(Jn,{returnFocus:!0,children:[e.jsxs("div",{className:"p-3 md:p-4 flex items-center justify-between",children:[e.jsx("h3",{className:"text-xl md:text-2xl font-semibold",children:"Manual Correction"}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("button",{className:"btn bg-slate-700 hover:bg-slate-800",onClick:()=>{R(!1)},children:"Close"})})]}),e.jsx("div",{className:"flex-1 p-3 md:p-4",children:e.jsxs("div",{className:"h-full grid grid-cols-1 lg:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"card relative flex flex-col",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"Live Preview"}),e.jsx("div",{className:"relative flex-1 rounded-2xl overflow-hidden bg-black",children:e.jsx("canvas",{ref:G,className:"absolute inset-0 w-full h-full"})})]}),e.jsxs("div",{className:"card flex flex-col",children:[e.jsx("div",{className:"text-sm opacity-80 mb-2",children:"Type a correction or replace the last dart. The preview updates live."}),e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("span",{className:"font-semibold",children:"Last auto:"}),e.jsx("span",{children:ze||"—"}),e.jsx("button",{className:"btn",onClick:bs,disabled:ne>=3,children:"Add Auto Dart"})]}),e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("input",{className:"input flex-[1.2]",placeholder:"Manual (T20, D16, 5, 25, 50)",value:Pe,onChange:g=>Ge(g.target.value),onKeyDown:g=>{g.key==="Enter"&&!g.shiftKey&&(g.preventDefault(),cr()),g.key==="Enter"&&g.shiftKey&&(g.preventDefault(),qr())}}),e.jsx("button",{className:"btn btn--ghost",onClick:qr,disabled:ne===0,children:"Replace Last"}),e.jsx("button",{className:"btn",onClick:cr,disabled:ne>=3,children:"Add"})]}),e.jsx("div",{className:"text-xs opacity-70 mb-4",children:"Press Enter to Add · Shift+Enter to Replace Last"}),e.jsxs("div",{className:"mb-4",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"Number pad"}),e.jsxs("div",{className:"grid grid-cols-3 gap-2 max-w-sm",children:[["7","8","9","4","5","6","1","2","3","0"].map(g=>e.jsx("button",{className:"btn text-lg",onClick:()=>{Ge(E=>/^[SDT]/i.test(E)?E+g:(E||"")+g)},children:g},g)),e.jsx("button",{className:"btn bg-rose-600 hover:bg-rose-700 text-white",onClick:()=>Ge(""),children:"Clear"}),e.jsx("button",{className:"btn bg-slate-600 hover:bg-slate-700 text-white",onClick:()=>Ge(g=>(g||"").slice(0,-1)),children:"⌫"}),e.jsx("button",{className:"btn bg-emerald-600 hover:bg-emerald-700 text-white",onClick:()=>cr(),disabled:ne>=3,children:"Enter"})]}),e.jsx("div",{className:"text-xs opacity-70 mt-2",children:"Tap numbers then press Enter to submit. Use D/T prefixes for doubles/trebles (e.g., D16)."})]}),e.jsxs("div",{className:"mt-auto",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"Quick entry"}),e.jsxs("div",{className:"flex flex-wrap gap-2 mb-3",children:[e.jsx("button",{className:"btn",disabled:ne>=3,onClick:()=>{if(!Kt||!ze||Ze==="MISS"||Me===0){const g=Yt+1;Qe(g),g>=5&&Xt(!0)}else Qe(0);et(25,"BULL 25","BULL"),nt(!1)},children:"25"}),e.jsx("button",{className:"btn",disabled:ne>=3,onClick:()=>{if(!Kt||!ze||Ze==="MISS"||Me===0){const g=Yt+1;Qe(g),g>=5&&Xt(!0)}else Qe(0);et(50,"INNER_BULL 50","INNER_BULL"),nt(!1)},children:"50"})]}),e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx("input",{className:"input w-full max-w-sm",list:"manual-quick-list",placeholder:"Type or select (e.g., D16, T20, S5)",value:Qn,onChange:g=>Cn(g.target.value.toUpperCase()),onKeyDown:g=>{if(g.key==="Enter"){const E=Qn.match(/^(S|D|T)(\d{1,2})$/);E&&nr(parseInt(E[2],10),E[1])}}}),e.jsx("datalist",{id:"manual-quick-list",children:["D","S","T"].map(g=>Array.from({length:20},(E,A)=>A+1).map(E=>e.jsx("option",{value:`${g}${E}`},`${g}${E}`)))}),e.jsx("button",{className:"btn",disabled:!Qn||ne>=3,onClick:()=>{const g=Qn.match(/^(S|D|T)(\d{1,2})$/);if(!g)return;const E=g[1],A=parseInt(g[2],10);nr(A,E)},children:"Add"})]})]})]})]})})]})})}),D&&e.jsx("div",{className:"fixed inset-0 bg-black/60 z-[100] flex items-center justify-center",children:e.jsx(Jn,{returnFocus:!0,children:e.jsxs("div",{className:"card w-full max-w-4xl relative text-left bg-[#2d2250] text-white p-6 rounded-xl shadow-xl",role:"dialog","aria-modal":"true",children:[e.jsx("button",{className:"absolute top-2 right-2 btn px-2 py-1 bg-purple-500 text-white font-bold",onClick:()=>oe(!1),"aria-label":"Close scoring dialog",children:"Close"}),e.jsx("h2",{className:"text-xl font-bold mb-4 flex items-center gap-2 text-white",children:"Scoring"}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"bg-black/30 rounded-2xl p-4",children:[e.jsx("h2",{className:"text-lg font-semibold mb-3",children:"Camera"}),e.jsxs(ho,{storageKey:"ndn:camera:size:modal",className:"relative rounded-2xl overflow-hidden bg-black",defaultWidth:480,defaultHeight:360,minWidth:360,minHeight:270,maxWidth:800,maxHeight:600,children:[e.jsx(lt,{}),(()=>{const E=(on.getState().cameraFitMode||"fit")==="fit"?"absolute inset-0 w-full h-full object-contain object-center bg-black":"absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 min-w-full min-h-full w-auto h-auto object-cover object-center bg-black",A=()=>e.jsxs("div",{className:"relative w-full aspect-[4/3] bg-black",children:[e.jsx("video",{ref:x,className:E,playsInline:!0,muted:!0,autoPlay:!0}),e.jsx("canvas",{ref:L,className:"absolute inset-0 w-full h-full",onClick:Dn}),e.jsxs("div",{className:"absolute top-2 left-1/2 -translate-x-1/2 z-20 flex items-center gap-3","aria-label":`Visit status: ${be[0]?be[0].value>0?"hit":"miss":"pending"}, ${be[1]?be[1].value>0?"hit":"miss":"pending"}, ${be[2]?be[2].value>0?"hit":"miss":"pending"}`,children:[[0,1,2].map(V=>{const q=be[V],U=!q,te=!!q&&(typeof q.value=="number"?q.value>0:!0),ae=U?"bg-gray-500/70":te?"bg-emerald-400":"bg-rose-500";return e.jsx("span",{className:`w-3 h-3 rounded-full shadow ${ae}`},V)}),X&&ve!==null&&e.jsxs("span",{className:"px-2 py-0.5 rounded bg-black/60 text-white text-xs font-semibold",children:[Math.max(0,ve),"s"]})]}),F&&vt?e.jsx("div",{className:"absolute bottom-3 left-1/2 -translate-x-1/2 z-20 bg-black/70 text-amber-200 text-xs font-semibold px-3 py-1 rounded-full shadow",children:"Remove darts to continue"}):null]});return H?Ce?A():e.jsx("div",{className:"w-full h-full flex flex-col items-center justify-center bg-gradient-to-br from-blue-900/50 to-purple-900/50",children:e.jsxs("div",{className:"text-center space-y-3 max-w-xs mx-auto",children:[e.jsx("div",{className:"text-4xl",children:"📱"}),e.jsx("div",{className:"text-lg font-semibold text-blue-100",children:"Phone camera selected"}),e.jsx("p",{className:"text-sm text-slate-300",children:"Start streaming from the Calibrator tab or reconnect below."}),e.jsxs("div",{className:"flex items-center justify-center gap-2 flex-wrap",children:[e.jsx("button",{className:"btn bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 text-sm",onClick:rt,children:"Reconnect Phone"}),e.jsx("button",{className:"btn bg-slate-700 hover:bg-slate-800 text-white px-3 py-1 text-sm",onClick:()=>{try{B.setShowOverlay?.(!0)}catch{}},children:"Show Overlay"}),e.jsx("button",{className:"btn bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-1 text-sm",onClick:rn,disabled:!K.length,children:"Use Local Camera"})]})]})}):A()})()]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2 mt-3",children:[H?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:`text-sm px-3 py-2 rounded border flex-1 min-w-[200px] ${Ce?"bg-emerald-500/10 border-emerald-400/40 text-emerald-100":"bg-amber-500/10 border-amber-400/40 text-amber-100"}`,children:Ce?"📱 Phone camera stream active":"📱 Waiting for phone camera stream"}),e.jsx("button",{className:"btn bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 text-sm",onClick:rt,children:"Reconnect Phone"}),e.jsx("button",{className:"btn bg-slate-700 hover:bg-slate-800 text-white px-3 py-1 text-sm",onClick:()=>{try{B.setShowOverlay?.(!B.showOverlay)}catch{}},children:B.showOverlay?"Hide Overlay":"Show Overlay"}),e.jsx("button",{className:"btn bg-rose-600 hover:bg-rose-700 text-white px-3 py-1 text-sm",disabled:!Ce,onClick:()=>{try{B.clearSession?.()}catch{}},children:"Stop Phone Feed"}),ft&&e.jsx("button",{className:"btn bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-1 text-sm",onClick:rn,disabled:!K.length,children:"Use Local Camera"})]}):e.jsx(e.Fragment,{children:Y?e.jsx("button",{className:"btn bg-gradient-to-r from-rose-600 to-rose-700 text-white font-bold",onClick:pt,children:"Stop Camera"}):e.jsx("button",{className:"btn bg-gradient-to-r from-purple-500 to-purple-700 text-white font-bold",onClick:kt,children:"Connect Camera"})}),e.jsx("button",{className:"btn bg-gradient-to-r from-indigo-500 to-indigo-700 text-white font-bold",onClick:We,disabled:!Ve,children:"Capture Still"}),e.jsx("button",{className:"btn bg-gradient-to-r from-slate-600 to-slate-800 text-white font-bold",disabled:!Ve,onClick:()=>{we.current=null,ge(g=>g+1)},children:"Reset Autoscore Background"}),e.jsx("button",{className:"btn bg-gradient-to-r from-slate-500 to-slate-700 text-white font-bold",onClick:()=>{try{window.dispatchEvent(new Event("ndn:camera-reset"))}catch{}},children:"Reset Camera Size"})]})]}),e.jsxs("div",{className:"bg-black/30 rounded-2xl p-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx("h2",{className:"text-lg font-semibold",children:"Pending Visit"}),e.jsxs("div",{className:"flex items-center gap-2 text-xs opacity-80 ml-auto",children:[e.jsx("span",{className:`inline-block w-2.5 h-2.5 rounded-full ${at?"bg-emerald-400":"bg-rose-500"}`}),e.jsx("span",{children:at?"Cal OK":"Cal invalid"})]})]}),e.jsx("div",{className:"text-sm opacity-80 mb-2",children:"Up to 3 darts per visit."}),e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[[0,1,2].map(g=>{const E=be[g],A=!E,V=!!E&&(typeof E.value=="number"?E.value>0:!0),q=A?"bg-gray-500/70":V?"bg-emerald-400":"bg-rose-500";return e.jsx("span",{className:`w-2.5 h-2.5 rounded-full shadow ${q}`},g)}),X&&ve!==null&&e.jsxs("span",{className:"ml-2 px-2 py-0.5 rounded bg-black/40 text-white text-xs font-semibold",children:[Math.max(0,ve),"s"]})]}),e.jsx("ul",{className:"text-sm mb-2 list-disc pl-5",children:be.length===0?e.jsx("li",{className:"opacity-60",children:"No darts yet"}):be.map((g,E)=>e.jsx("li",{children:g.label},E))}),e.jsxs("div",{className:"flex items-center gap-4 mb-2",children:[e.jsxs("div",{className:"font-semibold",children:["Darts: ",ne,"/3"]}),e.jsxs("div",{className:"font-semibold",children:["Total: ",_e]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{className:"btn bg-gradient-to-r from-purple-500 to-purple-700 text-white font-bold",onClick:Hr,disabled:ne===0,children:"Undo Dart"}),e.jsx("button",{className:"btn bg-gradient-to-r from-emerald-500 to-emerald-700 text-white font-bold",onClick:Gr,disabled:ne===0||Nn,"data-testid":"commit-visit-btn",children:"Commit Visit"}),e.jsx("button",{className:"btn bg-gradient-to-r from-slate-500 to-slate-700 text-white font-bold",onClick:$r,disabled:ne===0,children:"Clear"})]})]})]})]})})}),xs&&e.jsx("div",{className:"fixed inset-0 bg-black/60 z-50 flex items-center justify-center",children:e.jsxs("div",{className:"card max-w-md w-full relative text-left bg-[#2d2250] text-white p-6 rounded-xl shadow-xl",children:[e.jsx("button",{className:"absolute top-2 right-2 btn px-2 py-1 bg-purple-500 text-white font-bold",onClick:()=>{Xt(!1),Qe(0)},children:"Close"}),e.jsx("h3",{className:"text-xl font-bold mb-2 flex items-center gap-2 text-white",children:"Recalibration Recommended"}),e.jsx("div",{className:"mb-4 text-lg font-semibold text-indigo-200",children:"We detected 3 incorrect autoscores in a row. You can recalibrate now or reset calibration and try again."}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{className:"btn bg-gradient-to-r from-purple-500 to-purple-700 text-white font-bold",onClick:kr,children:"Go to Calibrate"}),e.jsx("button",{className:"btn bg-gradient-to-r from-slate-500 to-slate-700 text-white font-bold",onClick:Wn,children:"Reset Calibration"}),e.jsx("button",{className:"btn bg-gradient-to-r from-slate-500 to-slate-700 text-white font-bold",onClick:()=>{Xt(!1),Qe(0)},children:"Dismiss"})]})]})})]})});function lu({left:r,right:t,className:n="",sticky:a=!0}){return e.jsxs("div",{className:`${a?"sticky top-0":""} card relative overflow-hidden flex items-center justify-between gap-2 mb-2 px-2 sm:px-3 py-2 rounded-xl bg-white/10 border border-white/10 z-10 backdrop-blur-sm ${n}`,children:[e.jsx("div",{className:"pointer-events-none absolute inset-0 bg-gradient-to-b from-slate-900/30 via-slate-900/10 to-transparent"}),e.jsx("div",{className:"flex items-center gap-2 text-xs sm:text-sm leading-none flex-wrap",children:r}),e.jsx("div",{className:"flex items-center gap-1 flex-wrap justify-end",children:t})]})}function du({gameMode:r,players:t,matchScore:n,gameRules:a}){return!t||t.length===0?null:e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-2 mb-3",children:t.map((s,o)=>e.jsxs("div",{className:`rounded-lg border p-3 ${s.isCurrentTurn?"border-emerald-500/40 bg-emerald-500/10":"border-slate-500/40 bg-slate-500/10"}`,children:[e.jsx("div",{className:`text-sm font-semibold mb-2 uppercase tracking-wide ${s.isCurrentTurn?"text-emerald-300":"text-slate-300"}`,children:s.name}),e.jsxs("div",{className:"space-y-1 text-sm",children:[r==="X01"&&e.jsxs(e.Fragment,{children:[e.jsx(Ae,{label:"Legs Won",value:`● ${s.legsWon||0}`,highlight:!0}),e.jsx(Ae,{label:"Score",value:s.score||0,mono:!0,bold:!0}),e.jsx(Ae,{label:"Last Score",value:s.lastScore||"0",mono:!0}),e.jsx(Ae,{label:"C/Out Rate",value:`${s.checkoutRate||0}%`,mono:!0}),e.jsx(Ae,{label:"Best Leg",value:s.bestLeg||"—",mono:!0}),s.matchAvg!==void 0&&s.allTimeAvg!==void 0&&e.jsx(e.Fragment,{children:e.jsxs("div",{className:"border-t border-white/20 pt-1 mt-1",children:[e.jsx(Ae,{label:"Match Avg",value:s.matchAvg.toFixed(2),mono:!0,bold:!0,highlight:s.matchAvg>0}),e.jsx(uu,{matchAvg:s.matchAvg,allTimeAvg:s.allTimeAvg})]})})]}),(r==="Cricket"||r==="American Cricket")&&e.jsxs(e.Fragment,{children:[e.jsx(Ae,{label:"Closed",value:mu(s.closed),mono:!0}),e.jsx(Ae,{label:"Points",value:s.points||0,mono:!0,bold:!0}),e.jsx(Ae,{label:"Status",value:hu(s),highlight:s.isCurrentTurn})]}),(r==="Shanghai"||r==="Halve It")&&e.jsxs(e.Fragment,{children:[e.jsx(Ae,{label:r==="Shanghai"?"Round":"Stage",value:s.round||1,mono:!0}),e.jsx(Ae,{label:"Target",value:s.target||"—",mono:!0}),e.jsx(Ae,{label:"Score",value:s.score||0,mono:!0,bold:!0})]}),r==="Killer"&&e.jsxs(e.Fragment,{children:[e.jsx(Ae,{label:"Target #",value:s.number||"—",mono:!0,bold:!0}),e.jsx(Ae,{label:"Lives",value:s.lives||0,mono:!0,bold:!0}),s.eliminated&&e.jsx(Ae,{label:"Status",value:"ELIMINATED",highlight:!1})]}),r==="High-Low"&&e.jsxs(e.Fragment,{children:[e.jsx(Ae,{label:"Round",value:s.round||1,mono:!0}),e.jsx(Ae,{label:"Target",value:s.target||"High",mono:!0}),e.jsx(Ae,{label:"Score",value:s.score||0,mono:!0,bold:!0})]}),(r==="Double Practice"||r==="Treble Practice"||r==="Around the Clock")&&e.jsxs(e.Fragment,{children:[e.jsx(Ae,{label:"Target",value:s.target||"—",mono:!0,bold:!0}),e.jsx(Ae,{label:"Hits",value:s.hits||0,mono:!0,bold:!0}),s.totalNeeded&&e.jsx(Ae,{label:"Progress",value:`${s.hits||0} / ${s.totalNeeded}`,mono:!0})]}),(r==="Count-Up"||r==="High Score"||r==="Low Score")&&e.jsxs(e.Fragment,{children:[e.jsx(Ae,{label:"Round",value:s.round||1,mono:!0}),e.jsx(Ae,{label:"Score",value:s.score||0,mono:!0,bold:!0}),r==="High Score"&&e.jsx(Ae,{label:"Best",value:s.bestScore||0,mono:!0})]}),(r==="Checkout 170"||r==="Checkout 121")&&e.jsxs(e.Fragment,{children:[e.jsx(Ae,{label:"Remaining",value:s.remaining||0,mono:!0,bold:!0}),e.jsx(Ae,{label:"Attempts",value:s.attempts||0,mono:!0}),e.jsx(Ae,{label:"Successes",value:s.successes||0,mono:!0})]}),r==="Bob's 27"&&e.jsxs(e.Fragment,{children:[e.jsx(Ae,{label:"Target",value:`D${s.target||1}`,mono:!0,bold:!0}),e.jsx(Ae,{label:"Score",value:s.score||0,mono:!0,bold:!0})]}),r==="Baseball"&&e.jsxs(e.Fragment,{children:[e.jsx(Ae,{label:"Inning",value:s.inning||1,mono:!0}),e.jsx(Ae,{label:"Score",value:s.score||0,mono:!0,bold:!0})]}),r==="Golf"&&e.jsxs(e.Fragment,{children:[e.jsx(Ae,{label:"Hole",value:s.hole||1,mono:!0}),e.jsx(Ae,{label:"Strokes",value:s.strokes||0,mono:!0,bold:!0})]}),r==="Tic Tac Toe"&&e.jsxs(e.Fragment,{children:[e.jsx(Ae,{label:"Turn",value:s.turn||1,mono:!0}),s.winner&&e.jsx(Ae,{label:"Result",value:"WINNER!",highlight:!0})]}),n&&(r==="X01"||r==="Cricket"||r==="American Cricket")&&o===1&&e.jsx("div",{className:"border-t border-white/10 pt-1 mt-1",children:e.jsx(Ae,{label:"Match",value:n,mono:!0,bold:!0,highlight:!0})})]})]},o))})}function Ae({label:r,value:t,mono:n=!1,bold:a=!1,highlight:s=!1}){return e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("span",{className:"opacity-70",children:[r,":"]}),e.jsx("span",{className:`${n?"font-mono":""} ${a?"font-semibold":""} ${s?"text-emerald-300":""}`,children:t})]})}function uu({matchAvg:r,allTimeAvg:t}){const n=r-t,a=n>0,s=Math.abs(n)<.01;let o="",c="text-slate-300";return s?(o="= All-time",c="text-slate-300"):a?(o=`+${n.toFixed(2)} vs avg`,c="text-emerald-400"):(o=`${n.toFixed(2)} vs avg`,c="text-orange-400"),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"opacity-70",children:"AVG vs Avg:"}),e.jsx("span",{className:`font-mono font-semibold ${c}`,children:o})]})}function mu(r){return!r||Object.keys(r).length===0?"—":Object.entries(r).filter(([n,a])=>a===3).map(([n])=>n==="25"?"B":n).join(",")||"—"}function hu(r){if(!r.closed)return"Starting";const t=Object.values(r.closed).filter(n=>n===3).length;return t===0?"No marks":t<7?`${t}/7`:"Closing in"}function fu(){const r=qe();qe().importState,Lt(c=>c.setPaused),Lt();const[t,n]=f.useState(!1);sr(c=>c.setVisit),sr(c=>c.reset);const a=sr(c=>({entries:c.entries,darts:c.darts,total:c.total})),[s,o]=f.useState(null);return f.useEffect(()=>{try{const i=fo();if(i?.match)try{qe.getState().importState(i.match)}catch{}if(i?.control)try{Lt.getState().setPaused(i.control.paused,i.control.pauseEndsAt)}catch{}}catch{}n(!0);const c=sd(i=>{try{if(!i)return;i.type==="snapshot"&&i.state&&(i.state.match&&qe.getState().importState(i.state.match),i.state.control&&Lt.getState().setPaused(i.state.control.paused,i.state.control.pauseEndsAt));const h=()=>{try{const l=fo();if(l&&l.match)return qe.getState().importState(l.match),l.control&&Lt.getState().setPaused(l.control.paused,l.control.pauseEndsAt),!0}catch{}return!1};if(i.type==="pause")try{Lt.getState().setPaused(!0,i.pauseEndsAt??null)}catch{}if(i.type==="unpause")try{Lt.getState().setPaused(!1,null)}catch{}if(i.type==="quit")try{window.close()}catch{}if(i.type==="pendingVisit")try{const l=i.playerIdx??r.currentPlayerIdx;try{sr.getState().setVisit(i.entries||[],i.darts||0,i.total||0)}catch{}i.frame&&o(i.frame)}catch{}if(i.type==="visit")try{const l=h();try{sr.getState().reset()}catch{}}catch{}if(i.type==="nextPlayer")try{if(!h())try{const u=qe.getState(),m={roomId:u.roomId,players:u.players,currentPlayerIdx:typeof i.currentPlayerIdx=="number"?i.currentPlayerIdx:(u.currentPlayerIdx+1)%(u.players?.length||1),startingScore:u.startingScore,inProgress:u.inProgress,bestLegThisMatch:u.bestLegThisMatch};qe.getState().importState(m)}catch{}}catch{}if(i.type==="endLeg")try{const l=h()}catch{}if(i.type==="endGame")try{if(!h())try{const u=qe.getState(),m={roomId:u.roomId,players:u.players,currentPlayerIdx:u.currentPlayerIdx,startingScore:u.startingScore,inProgress:!1,bestLegThisMatch:u.bestLegThisMatch};qe.getState().importState(m)}catch{}}catch{}}catch{}});return()=>{try{typeof c=="function"&&c()}catch{}}},[]),e.jsxs("div",{className:"min-h-screen bg-slate-900 text-white",children:[e.jsxs("div",{className:"p-3 max-w-6xl mx-auto",children:[e.jsx(lu,{left:e.jsx("span",{className:"font-medium",children:"Match"}),right:e.jsxs(e.Fragment,{children:[e.jsx(fi,{}),e.jsx("button",{className:"btn btn--ghost px-3 py-1",onClick:()=>{try{if(window.opener&&!window.opener.closed)try{window.opener.focus()}catch{}window.close()}catch{}},"aria-label":"Return to app and close match window",children:"Return to app"}),e.jsx("button",{className:"btn btn--ghost px-3 py-1",onClick:()=>{try{window.close()}catch{}},"aria-label":"Close match window",children:"Close"})]})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-3 mt-3",children:[e.jsx("div",{className:"md:col-span-2",children:e.jsx("div",{className:"card p-2",children:e.jsx(cu,{})})}),e.jsx("div",{children:e.jsx("div",{className:"card p-2",children:e.jsx(du,{gameMode:r?.game||"X01",players:(r.players||[]).map((c,i)=>({name:c.name||`Player ${i+1}`,isCurrentTurn:i===(r.currentPlayerIdx||0),legsWon:c.legsWon||0,score:c.legs?.[c.legs.length-1]?.totalScoreRemaining||void 0,lastScore:c.legs&&c.legs.length&&c.legs[c.legs.length-1].visits.slice(-1)[0]?.score||0}))})})})]})]}),e.jsx("div",{className:"fixed right-4 bottom-4 z-50",children:e.jsxs("div",{className:"w-48 bg-black/70 text-white rounded-xl overflow-hidden shadow-lg border border-white/10",children:[e.jsxs("div",{className:"p-2 flex items-center gap-2",children:[e.jsx("div",{className:"w-16 h-10 bg-black rounded overflow-hidden flex-shrink-0",children:s?e.jsx("img",{src:s,alt:"opponent camera",className:"w-full h-full object-cover"}):e.jsx("div",{className:"w-full h-full bg-gray-800 flex items-center justify-center text-xs",children:"No preview"})}),e.jsxs("div",{className:"flex-1 text-sm",children:[e.jsx("div",{className:"font-medium",children:(r.players||[])[r.currentPlayerIdx]?.name||"Player"}),e.jsxs("div",{className:"text-xs text-slate-300",children:["Remaining:",e.jsx("span",{className:"ml-1 font-semibold",children:(()=>{const c=(r.players||[])[r.currentPlayerIdx],i=c?.legs?.[c.legs?.length-1],h=i?i.totalScoreRemaining:r.startingScore,l=a&&a.total||0;return typeof h=="number"?Math.max(0,h-l):h})()})]})]})]}),e.jsxs("div",{className:"px-2 pb-2",children:[e.jsx("div",{className:"text-xs text-slate-300",children:"Pending"}),e.jsx("div",{className:"flex gap-1 mt-1",children:a.entries?.length?a.entries.map((c,i)=>e.jsx("div",{className:"px-2 py-1 bg-white/5 rounded text-sm",children:c.value},i)):e.jsx("div",{className:"px-2 py-1 text-xs text-slate-400",children:"—"})})]})]})})]})}const pu={},xu=jt.lazy(()=>cn(()=>import("./Home-CWDFpsAt.js"),__vite__mapDeps([0,1,2,3]))),bu=jt.lazy(()=>cn(()=>import("./OfflinePlay-DvEQLJLW.js"),__vite__mapDeps([7,1,2,5,6,8]))),gu=jt.lazy(()=>cn(()=>import("./Friends-Dc-niZ5t.js"),__vite__mapDeps([11,1,2]))),vu=jt.lazy(()=>cn(()=>import("./OnlinePlay.clean-BAzALA79.js"),__vite__mapDeps([4,1,2,5,6]))),yu=jt.lazy(()=>cn(()=>import("./StatsPanel-hbFwEa4y.js"),__vite__mapDeps([10,3,1,2]))),wu=jt.lazy(()=>cn(()=>import("./Tournaments-CbESpCC_.js"),__vite__mapDeps([12,1,2,6]))),ju=jt.lazy(()=>cn(()=>import("./AdminAccess-Be8M_8R4.js"),__vite__mapDeps([13,1,2]))),Nu=jt.lazy(()=>cn(()=>import("./OpsDashboard-DCeWlDIr.js"),__vite__mapDeps([14,1,2])));function Su(){const r=f.useRef(null),[t,n]=f.useState(""),[a,s]=f.useState(!1),o=(()=>{try{return vr()}catch{return null}})(),[c,i]=f.useState("score"),[h,l]=f.useState(!1),[u,m]=f.useState(!1),[d,v]=f.useState(null);function x(L){if(!L){v(L);return}v(Y=>{const $={...Y,...L};return Y?.subscription&&!L?.subscription&&($.subscription=Y.subscription),L?.subscription&&($.subscription=L.subscription),$.fullAccess=!!($.subscription?.fullAccess||L?.fullAccess||$.fullAccess),$})}const y=(pu?.VITE_MINIMAL_AFTER_LOGIN||"").toString()==="1",[w,C]=f.useState(!1),[N,P]=f.useState(0),{avgMode:S}=on(),{H:M,locked:T,errorPx:p}=pn();f.useEffect(()=>{if(d&&y){C(!0);const Y=setTimeout(()=>C(!1),1500);return()=>clearTimeout(Y)}const L=localStorage.getItem("authToken");L&&fetch("http://localhost:8787/api/auth/me",{headers:{Authorization:`Bearer ${L}`}}).then($=>$.json()).then($=>{if($?.user){x($.user);try{const B=localStorage.getItem(`ndn:subscription:${$.user.email}`);B&&x({...$.user,subscription:JSON.parse(B)})}catch{}k($.user)}else localStorage.removeItem("authToken")}).catch(()=>{})},[y,d]);try{if(new URLSearchParams(window.location.search).get("match")==="1")return e.jsxs(io,{children:[e.jsx(Gd,{}),e.jsx(fu,{})]})}catch{}f.useEffect(()=>{const L=()=>{try{localStorage.removeItem("mockUser"),localStorage.removeItem("authToken"),d?.email&&localStorage.removeItem(`ndn:subscription:${d.email}`)}catch{}v(null),i("score")};return window.addEventListener("ndn:logout",L),()=>window.removeEventListener("ndn:logout",L)},[]),f.useEffect(()=>{if(!d?.username)return;const L=()=>P(S==="24h"?vd(d.username):pd(d.username));L();const Y=()=>L();return window.addEventListener("ndn:stats-updated",Y),()=>window.removeEventListener("ndn:stats-updated",Y)},[d?.username,S]),f.useEffect(()=>{if(!d?.username){n("");return}const L=localStorage.getItem(`ndn:bio:profilePhoto:${d.username}`);n(L||"")},[d?.username]),f.useEffect(()=>{const L=H=>{H.key?.startsWith("ndn:bio:profilePhoto:")&&d?.username&&H.key.endsWith(d.username)&&n(H.newValue||"")},Y=H=>{if(H.detail?.username===d?.username&&n(H.detail?.avatar||""),d?.username){const fe=localStorage.getItem(`ndn:bio:profilePhoto:${d.username}`);n(fe||"")}},$=()=>{if(!document.hidden&&d?.username){const H=localStorage.getItem(`ndn:bio:profilePhoto:${d.username}`);n(H||"")}},B=setInterval(()=>{if(d?.username){const H=localStorage.getItem(`ndn:bio:profilePhoto:${d.username}`);H&&H!==t&&n(H)}},2e3);return window.addEventListener("storage",L),window.addEventListener("ndn:avatar-updated",Y),document.addEventListener("visibilitychange",$),()=>{window.removeEventListener("storage",L),window.removeEventListener("ndn:avatar-updated",Y),document.removeEventListener("visibilitychange",$),clearInterval(B)}},[d?.username,t]),f.useEffect(()=>{const L=new URLSearchParams(window.location.search),Y=L.get("paid"),$=L.get("username-change");if(Y==="1"||Y==="username-change"||$==="free"){const B=localStorage.getItem("pendingUsernameChange");B&&d?.email&&fetch("http://localhost:8787/api/change-username",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:d.email,newUsername:B})}).then(fe=>fe.json()).then(fe=>{fe.ok?(alert("Username changed successfully!"),localStorage.removeItem("pendingUsernameChange"),fe.token&&localStorage.setItem("authToken",fe.token),fe.user&&x(fe.user),window.history.replaceState({},document.title,window.location.pathname)):alert("Failed to change username: "+(fe.error||"Unknown error"))}).catch(()=>{alert("Network error while changing username")})}},[d?.email]),f.useEffect(()=>{const L=()=>s(!!document.fullscreenElement);return document.addEventListener("fullscreenchange",L),s(!!document.fullscreenElement),()=>document.removeEventListener("fullscreenchange",L)},[]),f.useEffect(()=>{new URLSearchParams(window.location.search).get("subscription")==="success"&&d?.email&&fetch("http://localhost:8787/api/auth/me",{headers:{Authorization:`Bearer ${localStorage.getItem("authToken")}`}}).then(B=>B.json()).then(B=>{B?.user&&(x(B.user),alert("Premium subscription activated successfully!"),window.history.replaceState({},document.title,window.location.pathname))}).catch(()=>{alert("Subscription activated, but failed to refresh user data. Please refresh the page.")})},[d?.email]),f.useEffect(()=>{const L=()=>{const B=window.innerWidth,H=window.matchMedia("(max-width: 768px)").matches,fe=window.matchMedia("(max-width: 1024px) and (min-width: 769px)").matches,Ye=/Mobi|Android|iPhone|iPad|iPod|Mobile|BlackBerry|IEMobile|Opera Mini|Windows Phone/i.test(navigator.userAgent||""),Ce=/iPad|Android(?=.*\bMobile\b)|Tablet|PlayBook|Silk/i.test(navigator.userAgent||""),Ve="ontouchstart"in window||navigator.maxTouchPoints>0,Le=B<769,Nt=fe&&Ve||Ce||B>=769&&B<=1024&&Ve,zt=H||Ye||Le||B<769&&Ve||Nt;l(zt)};L(),window.addEventListener("resize",L),window.addEventListener("orientationchange",L);const Y=window.matchMedia("(max-width: 768px)"),$=window.matchMedia("(max-width: 1024px) and (min-width: 769px)");try{Y.addEventListener("change",L),$.addEventListener("change",L)}catch{}return()=>{window.removeEventListener("resize",L),window.removeEventListener("orientationchange",L);try{Y.removeEventListener("change",L),$.removeEventListener("change",L)}catch{}}},[]),f.useEffect(()=>{const L=()=>{try{localStorage.removeItem("ndn:avatar"),d?.email&&localStorage.removeItem(`ndn:subscription:${d.email}`)}catch{}v(null),i("score")};return window.addEventListener("ndn:logout",L),()=>window.removeEventListener("ndn:logout",L)},[]),f.useEffect(()=>{const L=Y=>{try{const $=String(Y?.detail?.username||"").trim();if(!$)return;v(B=>B&&{...B,username:$});try{const B=(d?.email||"").toLowerCase();o&&$&&B&&o.send({type:"presence",username:$,email:B})}catch{}}catch{}};return window.addEventListener("ndn:username-changed",L),()=>window.removeEventListener("ndn:username-changed",L)},[o,d?.email]),f.useEffect(()=>{const L=Y=>{try{const $=String(Y?.detail?.tab||"").trim();$&&["score","offline","online","stats","settings","admin","tournaments","friends"].includes($)&&i($)}catch{}};return window.addEventListener("ndn:change-tab",L),()=>window.removeEventListener("ndn:change-tab",L)},[]);async function k(L){try{const Y=L?.email?`?email=${encodeURIComponent(L.email)}`:"",$=await fetch("/api/subscription"+Y);if(!$.ok)return;const B=await $.json();x({...L,fullAccess:!!B?.fullAccess,subscription:B});try{L?.email&&localStorage.setItem(`ndn:subscription:${L.email}`,JSON.stringify(B))}catch{}}catch{}}const[z,W]=f.useState(!1),[ee,Q]=f.useState(!1),[K,le]=f.useState([]);if(f.useEffect(()=>{if(!d?.subscription){W(!1);return}const L=d.subscription,Y=Date.now();let $=null;L?.expiresAt&&($=typeof L.expiresAt=="string"?Date.parse(L.expiresAt):Number(L.expiresAt));const B=4320*60*1e3;if($&&$>Y&&$-Y<=B){W(!0);return}if($&&$<=Y&&!d?.fullAccess){W(!0);return}if(L?.source==="stripe"&&L?.status&&L.status!=="active"){W(!0);return}W(!1)},[d?.subscription,d?.fullAccess]),f.useEffect(()=>{if(!d?.email)return;let L=!0;async function Y(){try{const B=localStorage.getItem("authToken"),H={};B&&(H.Authorization=`Bearer ${B}`);const fe=await fetch(`/api/notifications?email=${encodeURIComponent(d.email)}`,{headers:H});if(!fe.ok)return;const Ye=await fe.json();L&&le(Ye||[])}catch{}}Y();const $=setInterval(Y,3e4);return()=>{L=!1,clearInterval($)}},[d?.email]),f.useEffect(()=>{if(!d?.subscription||!d?.email)return;const L=d.subscription,Y=Date.now();let $=null;L?.expiresAt&&($=typeof L.expiresAt=="string"?Date.parse(L.expiresAt):Number(L.expiresAt));const B=4320*60*1e3;async function H(fe,Ye){try{const Ce=localStorage.getItem("authToken"),Ve={"Content-Type":"application/json"};Ce&&(Ve.Authorization=`Bearer ${Ce}`),await fetch("/api/notifications",{method:"POST",headers:Ve,body:JSON.stringify({email:d.email,message:Ye,type:fe})})}catch{}}if($&&$>Y&&$-Y<=B){H("sub_expiring",`Your premium subscription expires in ${Math.ceil(($-Y)/(1440*60*1e3))} day(s)`);return}if($&&$<=Y&&!d?.fullAccess){H("sub_expired","Your premium subscription has ended");return}},[d?.email,d?.subscription,d?.fullAccess]),!d)return e.jsx(_d,{onAuth:L=>{try{const Y=localStorage.getItem(`ndn:subscription:${L.email}`);x(Y?{...L,subscription:JSON.parse(Y)}:L)}catch{x(L)}k(L)}});const ie=`https://ui-avatars.com/api/?name=${encodeURIComponent(d.username||"NDN")}&background=8F43EE&color=fff&bold=true&rounded=true&size=64`;return e.jsxs(io,{children:[e.jsxs("div",{ref:r,className:`${d?.fullAccess?"premium-body":""} h-screen overflow-hidden pt-1 pb-0 px-1 xs:pt-2 xs:pb-0 xs:px-2 sm:pt-3 sm:pb-0 sm:px-3 md:pt-4 md:pb-0 md:px-4`,children:[e.jsx(ud,{}),e.jsxs("div",{className:"max-w-[1400px] mx-auto grid grid-cols-1 lg:grid-cols-[auto,1fr] gap-2 xs:gap-3 sm:gap-4 h-full overflow-hidden",children:[!h&&e.jsx("div",{className:"relative hidden lg:block",style:{width:240},children:e.jsx(Yo,{active:c,onChange:L=>{i(L)},user:d})}),e.jsxs("div",{className:"flex flex-col h-full overflow-hidden",children:[e.jsx("div",{className:"pt-1 xs:pt-2",children:e.jsxs("header",{id:"ndn-header",className:"header glass flex-col xs:flex-col sm:flex-row gap-2 xs:gap-2 sm:gap-3",children:[e.jsx("div",{className:"flex items-center gap-2 order-1",children:e.jsx("h1",{children:e.jsx("button",{type:"button",className:"text-lg xs:text-xl sm:text-xl md:text-2xl font-bold text-brand-700 whitespace-nowrap cursor-pointer select-none",onClick:()=>{i("score")},title:"Go Home",children:"NINE-DART-NATION 🎯"})})}),e.jsxs("div",{className:"order-3 xs:order-3 sm:order-2 w-full sm:w-auto flex-1 flex flex-col items-center justify-center text-center sm:text-left !text-black",children:[e.jsxs("span",{className:"text-sm xs:text-base sm:text-base md:text-lg font-semibold flex items-center gap-2 max-w-full truncate !text-black",style:{color:"#000000",WebkitTextFillColor:"#000000"},children:[e.jsx("span",{className:"hidden xs:inline !text-black",children:"Welcome"}),e.jsx("img",{src:t||ie,alt:"avatar",className:"w-5 h-5 xs:w-6 xs:h-6 sm:w-6 sm:h-6 md:w-7 md:h-7 rounded-full ring-2 ring-white/20"}),e.jsxs("span",{className:"truncate !text-black",style:{color:"#000000",WebkitTextFillColor:"#000000"},children:[d.username,"🎯"]})]}),e.jsxs("span",{className:"hidden xs:inline text-xs xs:text-xs sm:text-xs md:text-sm !text-black",style:{color:"#000000",WebkitTextFillColor:"#000000"},children:["All-time 3-dart avg:"," ",e.jsx("span",{className:"font-semibold !text-black",style:{color:"#000000",WebkitTextFillColor:"#000000"},children:N.toFixed(2)})]}),h&&e.jsx("button",{className:"btn px-3 py-1 xs:px-3 xs:py-1 sm:px-3 sm:py-1 mt-1 text-sm xs:text-sm","aria-label":"Open navigation",onClick:()=>m(!0),children:"☰ Menu"})]}),T&&M&&e.jsxs("button",{onClick:()=>i("calibrate"),className:"order-4 sm:order-4 md:order-3 px-3 py-1 text-xs sm:text-sm rounded-full bg-emerald-500/20 hover:bg-emerald-500/30 text-emerald-100 border border-emerald-400/50 transition-colors",title:"Click to adjust calibration",children:["✓ Calibration Active"," ",p!=null&&`• ${p.toFixed(1)}px`]}),e.jsxs("div",{className:"order-2 md:order-3 ml-0 md:ml-auto flex items-center gap-2 flex-wrap",children:[e.jsx("button",{className:"px-3 py-1 text-sm rounded-full bg-white/5 hover:bg-white/10 border border-white/10",onClick:()=>{const L=r.current;L&&(document.fullscreenElement?document.exitFullscreen().catch(()=>{}):L.requestFullscreen().catch(()=>{}))},title:a?"Exit Full Screen":"Enter Full Screen",children:a?"Exit Full Screen":"Full Screen"}),c==="online"&&e.jsx("button",{className:"text-[10px] md:text-xs px-3 py-1 rounded-full bg-indigo-500/25 text-indigo-100 border border-indigo-400/40 hover:bg-indigo-500/40",title:"Open a simulated online match",onClick:()=>{setTimeout(()=>{try{window.dispatchEvent(new CustomEvent("ndn:online-match-demo",{detail:{game:"X01",start:501}}))}catch{}},40)},children:"ONLINE DEMO"}),e.jsx(di,{}),o?e.jsx("span",{className:"ml-0 md:ml-2",children:e.jsx(li,{status:o.status})}):null,(K.length>0||z)&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"relative ml-2 flex items-center space-x-2",children:[e.jsxs("button",{className:"px-2 py-1 text-sm rounded-full bg-white/5 hover:bg-white/10 border border-white/10 flex items-center gap-2",onClick:()=>Q(L=>!L),"aria-label":"View notifications",title:"Notifications",children:[e.jsx(Ri,{className:"w-5 h-5 text-amber-400"}),K.filter(L=>!L.read).length>0&&e.jsx("span",{className:"inline-flex items-center justify-center w-5 h-5 text-xs font-bold text-white bg-rose-500 rounded-full",children:K.filter(L=>!L.read).length>9?"9+":K.filter(L=>!L.read).length})]}),ee&&e.jsxs("div",{className:"absolute right-0 mt-2 w-80 card p-3 z-50",children:[e.jsx("div",{className:"font-semibold mb-2",children:"Notifications"}),e.jsxs("div",{className:"space-y-2",children:[K.length===0&&e.jsx("div",{className:"text-sm opacity-70",children:"No notifications"}),K.map(L=>e.jsxs("div",{className:`p-2 rounded ${L.type?.startsWith("sub")?"bg-amber-900/10":"bg-black/10"}`,children:[e.jsx("div",{className:"text-sm mb-1",children:L.message}),e.jsxs("div",{className:"text-xs opacity-60 flex items-center justify-between",children:[e.jsx("span",{children:new Date(L.createdAt).toLocaleString()}),e.jsxs("div",{className:"flex gap-2 items-center",children:[!L.read&&e.jsx("button",{className:"text-xs px-2 py-0.5 rounded bg-emerald-600 text-black",onClick:async()=>{try{const Y=localStorage.getItem("authToken"),$={"Content-Type":"application/json"};Y&&($.Authorization=`Bearer ${Y}`),await fetch(`/api/notifications/${encodeURIComponent(L.id)}?email=${encodeURIComponent(d.email)}`,{method:"PATCH",headers:$,body:JSON.stringify({read:!0})});const B=localStorage.getItem("authToken"),H={};B&&(H.Authorization=`Bearer ${B}`);const fe=await fetch(`/api/notifications?email=${encodeURIComponent(d.email)}`,{headers:H});fe.ok&&le(await fe.json())}catch{}},children:"Mark read"}),e.jsx("button",{className:"text-xs px-2 py-0.5 rounded bg-rose-600 text-white",onClick:async()=>{try{const Y=localStorage.getItem("authToken"),$={};Y&&($.Authorization=`Bearer ${Y}`),await fetch(`/api/notifications/${encodeURIComponent(L.id)}?email=${encodeURIComponent(d.email)}`,{method:"DELETE",headers:$});const B=localStorage.getItem("authToken"),H={};B&&(H.Authorization=`Bearer ${B}`);const fe=await fetch(`/api/notifications?email=${encodeURIComponent(d.email)}`,{headers:H});fe.ok&&le(await fe.json())}catch{}},children:"Clear"})]})]})]},L.id))]})]})]}),e.jsxs("div",{className:"hidden sm:flex items-center ml-2 space-x-2",children:[e.jsx(zd,{}),e.jsx(Vd,{})]})]})]})]})}),h&&e.jsx(Cu,{open:u,onClose:()=>m(!1),active:c,onChange:L=>{i(L),m(!1)},user:d}),e.jsxs("main",{id:"ndn-main-scroll",className:"space-y-4 flex-1 overflow-y-auto pr-1 flex flex-col",children:[c==="settings"&&e.jsx(f.Suspense,{fallback:e.jsx("div",{className:"p-4",children:"Loading settings…"}),children:e.jsx(Mn,{className:"flex-1 min-h-0",children:e.jsx(Dd,{user:d})})}),c==="score"&&e.jsx(f.Suspense,{fallback:e.jsx("div",{className:"p-4",children:"Loading home…"}),children:e.jsx(Mn,{className:"flex-1 min-h-0",children:e.jsx(xu,{user:d})})}),c==="online"&&e.jsx(f.Suspense,{fallback:e.jsx("div",{className:"p-4",children:"Loading online…"}),children:e.jsx(Mn,{className:"flex-1 min-h-0",children:e.jsx(vu,{user:d})})}),c==="offline"&&e.jsx(f.Suspense,{fallback:e.jsx("div",{className:"p-4",children:"Loading offline…"}),children:e.jsx(Mn,{className:"flex-1 min-h-0",children:e.jsx(bu,{user:d})})}),e.jsx("div",{className:c==="calibrate"?"":"hidden",children:e.jsx(Mn,{children:e.jsx(cd,{})})}),c==="friends"&&e.jsx(f.Suspense,{fallback:e.jsx("div",{className:"p-4",children:"Loading friends…"}),children:e.jsx(Mn,{className:"flex-1 min-h-0",children:e.jsx(gu,{user:d})})}),c==="stats"&&e.jsx(f.Suspense,{fallback:e.jsx("div",{className:"p-4",children:"Loading stats…"}),children:e.jsx(Mn,{className:"flex-1 min-h-0",children:e.jsx(yu,{user:d})})}),c==="tournaments"&&e.jsx(f.Suspense,{fallback:e.jsx("div",{className:"p-4",children:"Loading tournaments…"}),children:e.jsx(Mn,{className:"flex-1 min-h-0",children:e.jsx(wu,{user:d})})}),c==="admin"&&e.jsx(f.Suspense,{fallback:e.jsx("div",{className:"p-4",children:"Loading admin…"}),children:e.jsx(Mn,{className:"flex-1 min-h-0",children:e.jsxs("div",{className:"flex-1 min-h-0 space-y-6",children:[e.jsx(Pd,{user:d}),e.jsx(Nu,{user:d})]})})}),c==="fullaccess"&&e.jsx(f.Suspense,{fallback:e.jsx("div",{className:"p-4",children:"Loading admin access…"}),children:e.jsx(Mn,{className:"flex-1 min-h-0",children:e.jsx(ju,{user:d})})})]})]})]})]}),e.jsx(Ud,{}),e.jsx(Hd,{}),!w&&e.jsx(Bd,{}),!w&&e.jsx($d,{})]})}function Cu({open:r,onClose:t,active:n,onChange:a,user:s}){return e.jsx(Fd,{open:r,onClose:t,width:320,side:"left",title:"Navigate",children:e.jsx("div",{className:"mt-2",children:e.jsx(Yo,{active:n,onChange:a,user:s,className:"flex relative static max-h-[80vh] w-full"})})})}function ku(r){return r.length>=10&&/\d/.test(r)&&/[^A-Za-z0-9]/.test(r)}function Eu(){const[r,t]=f.useState(""),[n,a]=f.useState(""),[s,o]=f.useState(""),[c,i]=f.useState(""),[h,l]=f.useState("");f.useEffect(()=>{try{const d=new URLSearchParams(window.location.search).get("token")||"";t(d)}catch{}},[]);async function u(m){if(m.preventDefault(),i(""),l(""),!r){i("Missing or invalid reset token.");return}if(!n||n!==s){i("Passwords do not match.");return}if(!ku(n)){i("Password must be at least 10 chars and include a number and symbol.");return}try{const v=await(await fetch("/api/auth/confirm-reset",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({token:r,newPassword:n})})).json();if(!v?.ok)throw new Error(v?.error||"Reset failed");l("Password changed. You can now sign in.")}catch(d){i(d?.message||"Reset failed")}}return e.jsxs("div",{className:"min-h-screen flex items-center justify-center relative overflow-hidden",children:[e.jsx("div",{className:"background-animated"}),e.jsx("div",{className:"relative z-10 w-full max-w-lg mx-auto p-4",children:e.jsxs("form",{className:"card w-full space-y-4",onSubmit:u,children:[e.jsx("div",{className:"flex flex-col items-center justify-center gap-2 mb-2 text-center",children:e.jsx("h1",{className:"logo text-center",children:"Reset your password"})}),!r&&e.jsx("div",{className:"text-red-400",children:"This reset link is missing a token. Please use the link from your email."}),e.jsx("input",{className:"input w-full",type:"password",placeholder:"New password",value:n,onChange:m=>a(m.target.value),required:!0}),e.jsx("input",{className:"input w-full",type:"password",placeholder:"Confirm password",value:s,onChange:m=>o(m.target.value),required:!0}),c&&e.jsx("div",{className:"text-red-400 font-semibold text-sm",children:c}),h&&e.jsx("div",{className:"text-emerald-400 font-semibold text-sm",children:h}),e.jsx("button",{className:"btn w-full",type:"submit",disabled:!r,children:"Change Password"}),e.jsx("a",{className:"underline text-sm text-center",href:"/",children:"Back to sign in"})]})})]})}class Iu extends f.Component{constructor(t){super(t),this.state={hasError:!1}}static getDerivedStateFromError(t){return{hasError:!0,message:String(t?.message||t)}}componentDidCatch(t,n){console.error("[ErrorBoundary]",t,n)}render(){return this.state.hasError?e.jsx("div",{className:"min-h-screen flex items-center justify-center p-6",children:e.jsxs("div",{className:"card max-w-lg w-full text-center",children:[e.jsx("h2",{className:"text-2xl font-bold mb-2",children:"Something went wrong"}),e.jsx("p",{className:"opacity-80 mb-4",children:"Please refresh the page. If this persists, let us know."}),this.state.message&&e.jsx("pre",{className:"text-xs bg-black/40 rounded p-2 overflow-auto text-left",children:this.state.message}),e.jsx("button",{className:"btn mt-4",onClick:()=>window.location.reload(),children:"Reload"})]})}):this.props.children}}try{window.React=window.React||{}}catch{}xl();Ui.createRoot(document.getElementById("root")).render(e.jsx(f.StrictMode,{children:e.jsx(Iu,{children:e.jsx(id,{children:e.jsx(Mu,{})})})}));function Mu(){return window.location.pathname==="/reset"?e.jsx(Eu,{}):e.jsx(Su,{})}if(typeof navigator<"u"&&"serviceWorker"in navigator)try{navigator.serviceWorker.register("/sw.js").then(r=>{console.debug("[ServiceWorker] Registered",r)}).catch(r=>{console.warn("[ServiceWorker] Registration failed",r)})}catch{}export{sr as $,ts as A,Z as B,cu as C,Gu as D,so as E,vr as F,lu as G,pn as H,ka as I,Ju as J,Id as K,Yu as L,Ca as M,ci as N,Wu as O,Kd as P,Uu as Q,hi as R,qu as S,hd as T,md as U,Sd as V,$u as W,Bu as X,Vu as Y,Jn as Z,ll as _,dd as a,Hu as a0,gr as b,Gn as c,Kl as d,rd as e,Lu as f,yr as g,Fu as h,Xd as i,e as j,pd as k,qe as l,Lt as m,xr as n,Va as o,jd as p,Nd as q,_u as r,Pn as s,du as t,on as u,ho as v,Ru as w,Du as x,zu as y,Vn as z};
//# sourceMappingURL=index-DbLtaxCq.js.map
