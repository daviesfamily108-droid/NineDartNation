{"version":3,"file":"boardDetection.worker-ByHWv7sG.js","sources":["../src/utils/vision.ts","../src/utils/gameCalibrationRequirements.ts","../node_modules/zustand/esm/vanilla.mjs","../node_modules/react/cjs/react.production.min.js","../node_modules/react/index.js","../node_modules/use-sync-external-store/cjs/use-sync-external-store-shim.production.js","../node_modules/use-sync-external-store/shim/index.js","../node_modules/use-sync-external-store/cjs/use-sync-external-store-shim/with-selector.production.js","../node_modules/use-sync-external-store/shim/with-selector.js","../node_modules/zustand/esm/index.mjs","../src/store/userSettings.ts","../src/utils/boardDetection.ts","../src/workers/boardDetection.worker.ts"],"sourcesContent":["// Vision and calibration utilities for dartboard mapping\n// Standard dartboard: 18 inches (457.2 mm) outer diameter\n// Board dimensions follow standard measurements (millimeters)\n// - Inner bull radius: 6.35 mm (12.7 mm diameter)\n// - Outer bull radius: 15.9 mm (31.8 mm diameter)\n// - Treble inner radius: 99 mm\n// - Treble outer radius: 107 mm\n// - Double inner radius: 162 mm\n// - Double outer radius: 170 mm (playing field outer edge = 340 mm diameter)\n\nexport type Point = { x: number; y: number };\nexport type Homography = [\n  number,\n  number,\n  number,\n  number,\n  number,\n  number,\n  number,\n  number,\n  number,\n]; // row-major 3x3\n\nexport const BoardRadii = {\n  bullInner: 6.35,\n  bullOuter: 15.9,\n  trebleInner: 99,\n  trebleOuter: 107,\n  doubleInner: 162,\n  doubleOuter: 170,\n};\n\nexport const CalibrationGuideRadii = BoardRadii;\n\nexport const SectorOrder = [\n  20, 1, 18, 4, 13, 6, 10, 15, 2, 17, 3, 19, 7, 16, 8, 11, 14, 9, 12, 5,\n];\n\n// Basic 3x3 matrix operations\nexport function matMul3(a: Homography, b: Homography): Homography {\n  const r = new Array(9).fill(0);\n  for (let i = 0; i < 3; i++) {\n    for (let j = 0; j < 3; j++) {\n      for (let k = 0; k < 3; k++) {\n        r[i * 3 + j] += a[i * 3 + k] * b[k * 3 + j];\n      }\n    }\n  }\n  return r as Homography;\n}\n\nexport function applyHomography(H: Homography, p: Point): Point {\n  const x = p.x,\n    y = p.y;\n  const w = H[6] * x + H[7] * y + H[8];\n  const nx = (H[0] * x + H[1] * y + H[2]) / w;\n  const ny = (H[3] * x + H[4] * y + H[5]) / w;\n  return { x: nx, y: ny };\n}\n\n// Scale a homography by sx, sy on the destination/image side: H' = S * H\n// Where S = diag([sx, sy, 1])\nexport function scaleHomography(\n  H: Homography,\n  sx: number,\n  sy: number,\n): Homography {\n  return [\n    sx * H[0],\n    sx * H[1],\n    sx * H[2],\n    sy * H[3],\n    sy * H[4],\n    sy * H[5],\n    H[6],\n    H[7],\n    H[8],\n  ] as Homography;\n}\n\n// Rotate a homography around the board center by angle (in radians, counter-clockwise)\n// Creates a rotation matrix R and applies it: H' = R * H\nexport function rotateHomography(\n  H: Homography,\n  angleRadians: number,\n): Homography {\n  const cos = Math.cos(angleRadians);\n  const sin = Math.sin(angleRadians);\n  // Rotation matrix R = [cos -sin 0; sin cos 0; 0 0 1]\n  const R: Homography = [cos, -sin, 0, sin, cos, 0, 0, 0, 1];\n  // We want to rotate the board coordinates before applying the homography\n  // so the correct composition is H' = H * R (rotate board, then map to image).\n  // Applying R on the left (R * H) would instead rotate the image space.\n  return matMul3(H, R);\n}\n\n// Translate a homography on the destination/image side by (tx, ty): H' = T * H\n// Where T = [1 0 tx; 0 1 ty; 0 0 1]\nexport function translateHomography(\n  H: Homography,\n  tx: number,\n  ty: number,\n): Homography {\n  const T: Homography = [1, 0, tx, 0, 1, ty, 0, 0, 1];\n  return matMul3(T, H);\n}\n\nexport function invertHomography(H: Homography): Homography {\n  // Inverse of 3x3 matrix\n  const m = H;\n  const a = m[0],\n    b = m[1],\n    c = m[2],\n    d = m[3],\n    e = m[4],\n    f = m[5],\n    g = m[6],\n    h = m[7],\n    i = m[8];\n  const A = e * i - f * h;\n  const B = c * h - b * i;\n  const C = b * f - c * e;\n  const D = f * g - d * i;\n  const E = a * i - c * g;\n  const F = c * d - a * f;\n  const G = d * h - e * g;\n  const Hh = b * g - a * h;\n  const I = a * e - b * d;\n  const det = a * A + b * D + c * G;\n  if (Math.abs(det) < 1e-12) throw new Error(\"Singular homography\");\n  const inv = [\n    A / det,\n    B / det,\n    C / det,\n    D / det,\n    E / det,\n    F / det,\n    G / det,\n    Hh / det,\n    I / det,\n  ] as Homography;\n  return inv;\n}\n\n// Compute homography H that maps src (board space) -> dst (image space)\n// Using N correspondences via DLT (solved by Gaussian elimination) with least-squares fit\n// Supports overdetermined systems (N > 4) for improved accuracy\nexport function computeHomographyDLT(src: Point[], dst: Point[]): Homography {\n  if (src.length < 4 || dst.length < 4)\n    throw new Error(\"Need at least 4 correspondences\");\n  if (src.length !== dst.length)\n    throw new Error(\"Correspondences must have equal length\");\n  // Build A * h = b where h = [h11 h12 h13 h21 h22 h23 h31 h32]^T and h33 = 1\n  const A: number[][] = [];\n  const B: number[] = [];\n  for (let k = 0; k < src.length; k++) {\n    const { x: X, y: Y } = src[k];\n    const { x: x, y: y } = dst[k];\n    // x = (h11 X + h12 Y + h13) / (h31 X + h32 Y + 1)\n    // y = (h21 X + h22 Y + h23) / (h31 X + h32 Y + 1)\n    // => x*(h31 X + h32 Y + 1) = h11 X + h12 Y + h13\n    // => y*(h31 X + h32 Y + 1) = h21 X + h22 Y + h23\n    A.push([X, Y, 1, 0, 0, 0, -x * X, -x * Y]);\n    B.push(x);\n    A.push([0, 0, 0, X, Y, 1, -y * X, -y * Y]);\n    B.push(y);\n  }\n  const h = solveLeastSquares(A, B); // length 8\n  const H: Homography = [h[0], h[1], h[2], h[3], h[4], h[5], h[6], h[7], 1];\n  return H;\n}\n\n// Solve A x = b in least squares sense using Gaussian elimination with partial pivoting\nfunction solveLeastSquares(A: number[][], b: number[]): number[] {\n  // Normal equations: (A^T A) x = A^T b\n  const m = A.length,\n    n = A[0].length;\n  const AtA: number[][] = Array.from({ length: n }, () => new Array(n).fill(0));\n  const Atb: number[] = new Array(n).fill(0);\n  for (let r = 0; r < m; r++) {\n    for (let i = 0; i < n; i++) {\n      Atb[i] += A[r][i] * b[r];\n      for (let j = 0; j < n; j++) {\n        AtA[i][j] += A[r][i] * A[r][j];\n      }\n    }\n  }\n  return gaussianSolve(AtA, Atb);\n}\n\nfunction gaussianSolve(M: number[][], v: number[]): number[] {\n  const n = v.length;\n  // Augment matrix\n  const A = M.map((row, i) => row.concat([v[i]]));\n  for (let i = 0; i < n; i++) {\n    // Pivot\n    let maxRow = i;\n    for (let r = i + 1; r < n; r++) {\n      if (Math.abs(A[r][i]) > Math.abs(A[maxRow][i])) maxRow = r;\n    }\n    if (Math.abs(A[maxRow][i]) < 1e-12) throw new Error(\"Singular matrix\");\n    if (maxRow !== i) {\n      const tmp = A[i];\n      A[i] = A[maxRow];\n      A[maxRow] = tmp;\n    }\n    // Eliminate\n    for (let r = i + 1; r < n; r++) {\n      const f = A[r][i] / A[i][i];\n      for (let c = i; c <= n; c++) A[r][c] -= f * A[i][c];\n    }\n  }\n  // Back substitution\n  const x = new Array(n).fill(0);\n  for (let i = n - 1; i >= 0; i--) {\n    let s = A[i][n];\n    for (let c = i + 1; c < n; c++) s -= A[i][c] * x[c];\n    x[i] = s / A[i][i];\n  }\n  return x;\n}\n\n// Canonical calibration targets in board space (mm)\n// We now anchor the homography with four evenly spaced double-ring sectors:\n// D20 (top), D6 (right), D3 (bottom), D11 (left), plus bullseye (center).\nexport function canonicalRimTargets(\n  mode: \"center\" | \"outer\" = \"center\",\n): Point[] {\n  // Target the CENTER of the double ring (166mm radius)\n  // This is more stable than the outer edge and ensures the point is\n  // clearly within the double segment, avoiding the outer light ring.\n  const radius =\n    mode === \"outer\"\n      ? (BoardRadii.doubleInner + BoardRadii.doubleOuter) / 2 // 166mm - center of double ring\n      : (BoardRadii.doubleInner + BoardRadii.doubleOuter) / 2;\n  const targetSectors = [20, 6, 3, 11] as const;\n  const rimPoints = targetSectors.map((sector) => {\n    const idx = SectorOrder.indexOf(sector);\n    const angle = (idx / SectorOrder.length) * Math.PI * 2 - Math.PI / 2;\n    const x = radius * Math.cos(angle);\n    const y = radius * Math.sin(angle);\n    return {\n      x: Math.abs(x) < 1e-9 ? 0 : x,\n      y: Math.abs(y) < 1e-9 ? 0 : y,\n    };\n  });\n  // Add bullseye (center) as 5th calibration point\n  rimPoints.push({ x: 0, y: 0 });\n  return rimPoints;\n}\n\n// Given a homography mapping board->image, produce polylines for overlay rings (in image px)\nexport function sampleRing(\n  H: Homography,\n  radius: number,\n  steps = 256,\n): Point[] {\n  const pts: Point[] = [];\n  for (let k = 0; k < steps; k++) {\n    const theta = (k / steps) * Math.PI * 2;\n    const p = applyHomography(H, {\n      x: radius * Math.cos(theta),\n      y: radius * Math.sin(theta),\n    });\n    pts.push(p);\n  }\n  return pts;\n}\n\n// Estimate sectorOffset from a calibrated homography so that sector 20 aligns to the image \"top\".\n// We measure the image-space angle from the mapped board center to the mapped D20 mid-point\n// and convert that angular discrepancy into an integer sector offset in steps of 18 degrees.\nexport function estimateSectorOffsetFromHomography(\n  H: Homography,\n  mode: \"center\" | \"outer\" = \"outer\",\n): number {\n  // Board-space center and D20 mid-point\n  const centerImg = applyHomography(H, { x: 0, y: 0 });\n  const radius =\n    mode === \"outer\"\n      ? BoardRadii.doubleOuter\n      : (BoardRadii.doubleInner + BoardRadii.doubleOuter) / 2;\n  const d20Board = { x: 0, y: -radius }; // -Y points to top (sector 20 center)\n  const d20Img = applyHomography(H, d20Board);\n  const vx = d20Img.x - centerImg.x;\n  const vy = d20Img.y - centerImg.y;\n  // Image-space angle: atan2(y, x) in degrees, normalized to [0, 360)\n  let degImg = (Math.atan2(vy, vx) * 180) / Math.PI;\n  degImg = (degImg + 360) % 360;\n  // Desired top direction is -Y, which is 270 degrees in image atan2 convention\n  const desiredTop = 270; // degrees\n  let delta = degImg - desiredTop; // positive if rotated clockwise relative to desired top\n  // Normalize delta to [-180, 180)\n  delta = ((delta + 180) % 360) - 180;\n  // Convert angular delta to nearest sector steps (18 degrees per sector)\n  const offset = Math.round(delta / 18);\n  // Ensure offset in [0, 19] for consistency\n  return ((offset % 20) + 20) % 20;\n}\n\nexport function rmsError(H: Homography, src: Point[], dst: Point[]): number {\n  let e2 = 0;\n  for (let i = 0; i < src.length; i++) {\n    const p = applyHomography(H, src[i]);\n    const dx = p.x - dst[i].x;\n    const dy = p.y - dst[i].y;\n    e2 += dx * dx + dy * dy;\n  }\n  return Math.sqrt(e2 / src.length);\n}\n\nexport interface RansacOptions {\n  thresholdPx?: number; // reprojection error threshold\n  maxIter?: number;\n  minInliers?: number;\n  rng?: () => number; // optional RNG for deterministic tests\n}\n\n// Robust homography estimation using RANSAC. Returns best H, inlier mask and inlier RMS error.\nexport function ransacHomography(\n  src: Point[],\n  dst: Point[],\n  opts: RansacOptions = {},\n): { H: Homography | null; inliers: boolean[]; errorPx: number | null } {\n  const n = src.length;\n  if (n < 4 || dst.length < 4)\n    throw new Error(\"Need at least 4 correspondences\");\n  const threshold = opts.thresholdPx ?? 8;\n  const maxIter = opts.maxIter ?? 500;\n  const minInliers = opts.minInliers ?? 4;\n  const rng = opts.rng ?? Math.random;\n\n  let bestH: Homography | null = null;\n  let bestInliers: boolean[] = new Array(n).fill(false);\n  let bestCount = 0;\n  let bestError = Infinity;\n\n  for (let iter = 0; iter < maxIter; iter++) {\n    // pick 4 unique indices\n    const idxs = new Set<number>();\n    while (idxs.size < 4) {\n      idxs.add(Math.floor(rng() * n));\n    }\n    const chosen = Array.from(idxs);\n    const ssub: Point[] = [];\n    const dsub: Point[] = [];\n    for (const i of chosen) {\n      ssub.push(src[i]);\n      dsub.push(dst[i]);\n    }\n    let Htry: Homography;\n    try {\n      Htry = computeHomographyDLT(ssub, dsub);\n    } catch (e) {\n      continue; // singular or invalid, skip\n    }\n\n    // Count inliers\n    const inliers = new Array(n).fill(false);\n    let count = 0;\n    for (let i = 0; i < n; i++) {\n      const p = applyHomography(Htry, src[i]);\n      const dx = p.x - dst[i].x;\n      const dy = p.y - dst[i].y;\n      const dist = Math.hypot(dx, dy);\n      if (dist <= threshold) {\n        inliers[i] = true;\n        count++;\n      }\n    }\n\n    if (count < minInliers) continue;\n\n    // Recompute H using all inliers for better fit\n    const sIn: Point[] = [];\n    const dIn: Point[] = [];\n    for (let i = 0; i < n; i++) {\n      if (inliers[i]) {\n        sIn.push(src[i]);\n        dIn.push(dst[i]);\n      }\n    }\n    let Hrefined: Homography;\n    try {\n      Hrefined = computeHomographyDLT(sIn, dIn);\n    } catch (e) {\n      continue;\n    }\n    const err = rmsError(Hrefined, sIn, dIn);\n\n    // Choose better by inlier count first, then lower error\n    if (count > bestCount || (count === bestCount && err < bestError)) {\n      bestCount = count;\n      bestError = err;\n      bestH = Hrefined;\n      bestInliers = inliers.slice();\n    }\n  }\n\n  if (!bestH || bestCount < minInliers)\n    return { H: null, inliers: new Array(n).fill(false), errorPx: null };\n\n  // Compute final error over inliers\n  const sFin: Point[] = [];\n  const dFin: Point[] = [];\n  for (let i = 0; i < n; i++) {\n    if (bestInliers[i]) {\n      sFin.push(src[i]);\n      dFin.push(dst[i]);\n    }\n  }\n  const finalError = sFin.length > 0 ? rmsError(bestH, sFin, dFin) : null;\n  return { H: bestH, inliers: bestInliers, errorPx: finalError };\n}\n\n// Map an image point to board coordinates using inverse homography (image->board)\n// Returns null if the homography cannot be inverted (singular matrix)\nexport function imageToBoard(\n  H_boardToImage: Homography,\n  pImg: Point,\n): Point | null {\n  try {\n    const inv = invertHomography(H_boardToImage);\n    const result = applyHomography(inv as Homography, pImg);\n    // Validate that the result is finite (not NaN or Infinity)\n    if (!isFinite(result.x) || !isFinite(result.y)) {\n      return null;\n    }\n    return result;\n  } catch (e) {\n    return null;\n  }\n}\n\n// Compute score for a board coordinate (mm)\nexport function scoreAtBoardPoint(p: Point): {\n  base: number;\n  ring: \"MISS\" | \"SINGLE\" | \"DOUBLE\" | \"TRIPLE\" | \"BULL\" | \"INNER_BULL\";\n  sector: number | null;\n  mult: 0 | 1 | 2 | 3;\n} {\n  const r = Math.hypot(p.x, p.y);\n  const ang = Math.atan2(p.y, p.x); // 0 rad at +X, increasing CCW\n  // Rotate so that sector 20 is at the top (negative Y). Top corresponds to -90 degrees (or 270)\n  let deg = (ang * 180) / Math.PI;\n  deg = (deg + 360 + 90) % 360; // shift so 0 deg is at top\n\n  // Shift by half a sector (9 degrees) to align boundaries.\n  // Sector 20 is centered at 0 deg, spanning -9 to +9.\n  // Adding 9 maps [-9, 9] to [0, 18], which floor divides to index 0.\n  const index = Math.floor(((deg + 9) % 360) / 18);\n  const sector = SectorOrder[index];\n\n  // Standard dartboard dimensions (mm)\n  const {\n    bullInner,\n    bullOuter,\n    trebleInner,\n    trebleOuter,\n    doubleInner,\n    doubleOuter,\n  } = BoardRadii;\n\n  // Apply minimal tolerance for wire-shots (0.75mm is approx half a wire width)\n  const tol = 0.75;\n  // Minimal outer tolerance: allow a tiny buffer for detection noise but treat\n  // anything beyond the double ring as a miss.\n  const outerTol = 0.5;\n\n  // Outside board edge\n  if (r > doubleOuter + outerTol)\n    return { base: 0, ring: \"MISS\", sector: null, mult: 0 };\n\n  // Double band (clamp to outer edge tolerance)\n  if (r >= doubleInner - tol && r <= doubleOuter + outerTol)\n    return { base: sector * 2, ring: \"DOUBLE\", sector, mult: 2 };\n\n  // Single outer band\n  if (r > trebleOuter + tol)\n    return { base: sector, ring: \"SINGLE\", sector, mult: 1 };\n\n  // Treble band\n  if (r >= trebleInner - tol)\n    return { base: sector * 3, ring: \"TRIPLE\", sector, mult: 3 };\n\n  // Single inner band\n  if (r > bullOuter + tol)\n    return { base: sector, ring: \"SINGLE\", sector, mult: 1 };\n\n  // Bulls\n  if (r > bullInner + 0.5)\n    return { base: 25, ring: \"BULL\", sector: 25, mult: 1 };\n\n  return { base: 50, ring: \"INNER_BULL\", sector: 25, mult: 2 };\n}\n\n// Orientation-aware scoring: add theta (radians) to angle before sector mapping\nexport function scoreAtBoardPointTheta(\n  p: Point,\n  theta: number,\n  sectorOffset: number = 0,\n  rotationOffsetRad: number = 0,\n): {\n  base: number;\n  ring: \"MISS\" | \"SINGLE\" | \"DOUBLE\" | \"TRIPLE\" | \"BULL\" | \"INNER_BULL\";\n  sector: number | null;\n  mult: 0 | 1 | 2 | 3;\n} {\n  const r = Math.hypot(p.x, p.y);\n  const ang =\n    Math.atan2(p.y, p.x) +\n    (Number.isFinite(theta) ? theta : 0) +\n    (Number.isFinite(rotationOffsetRad) ? rotationOffsetRad : 0);\n  let deg = (ang * 180) / Math.PI;\n  deg = (deg + 360 + 90) % 360;\n  const index = Math.floor(((deg + 9) % 360) / 18);\n  const correctedIndex =\n    (((index + (Number.isFinite(sectorOffset) ? sectorOffset : 0)) % 20) + 20) %\n    20;\n  const sector = SectorOrder[correctedIndex];\n\n  // Standard dartboard dimensions (mm)\n  const {\n    bullInner,\n    bullOuter,\n    trebleInner,\n    trebleOuter,\n    doubleInner,\n    doubleOuter,\n  } = BoardRadii;\n\n  // Apply minimal tolerance for wire-shots\n  const tol = 0.75;\n\n  if (r > doubleOuter + tol)\n    return { base: 0, ring: \"MISS\", sector: null, mult: 0 };\n\n  if (r >= doubleInner - tol)\n    return { base: sector * 2, ring: \"DOUBLE\", sector, mult: 2 };\n\n  if (r > trebleOuter + tol)\n    return { base: sector, ring: \"SINGLE\", sector, mult: 1 };\n\n  if (r >= trebleInner - tol)\n    return { base: sector * 3, ring: \"TRIPLE\", sector, mult: 3 };\n\n  if (r > bullOuter + tol)\n    return { base: sector, ring: \"SINGLE\", sector, mult: 1 };\n\n  if (r > bullInner + 0.5)\n    return { base: 25, ring: \"BULL\", sector: 25, mult: 1 };\n\n  return { base: 50, ring: \"INNER_BULL\", sector: 25, mult: 2 };\n}\n\n// Check if a point is actually on the dartboard (within valid playing area)\nexport function isPointOnBoard(p: Point): boolean {\n  const r = Math.hypot(p.x, p.y);\n  // A point is on the board if it's within the double outer radius (the edge of the board)\n  // No margin - we want strict checking to ensure darts are actually on the board\n  return r <= BoardRadii.doubleOuter;\n}\n\nexport function drawPolyline(\n  ctx: CanvasRenderingContext2D,\n  pts: Point[],\n  color = \"#10b981\",\n  width = 2,\n) {\n  if (!pts.length) return;\n  ctx.save();\n  ctx.strokeStyle = color;\n  ctx.lineWidth = width;\n  ctx.beginPath();\n  ctx.moveTo(pts[0].x, pts[0].y);\n  for (let i = 1; i < pts.length; i++) ctx.lineTo(pts[i].x, pts[i].y);\n  ctx.closePath();\n  ctx.stroke();\n  ctx.restore();\n}\n\nexport function drawCross(\n  ctx: CanvasRenderingContext2D,\n  p: Point,\n  color = \"#f59e0b\",\n) {\n  ctx.save();\n  ctx.strokeStyle = color;\n  ctx.lineWidth = 2;\n  ctx.beginPath();\n  ctx.moveTo(p.x - 8, p.y);\n  ctx.lineTo(p.x + 8, p.y);\n  ctx.moveTo(p.x, p.y - 8);\n  ctx.lineTo(p.x, p.y + 8);\n  ctx.stroke();\n  ctx.restore();\n}\n\n// --- Point refinement using Sobel gradient ---\nfunction clamp(v: number, lo: number, hi: number) {\n  return Math.max(lo, Math.min(hi, v));\n}\n\nfunction sobelAtGray(img: ImageData, x: number, y: number): number {\n  const { width, data } = img;\n  // Sobel kernels\n  const gx = [\n    [-1, 0, 1],\n    [-2, 0, 2],\n    [-1, 0, 1],\n  ];\n  const gy = [\n    [-1, -2, -1],\n    [0, 0, 0],\n    [1, 2, 1],\n  ];\n  let sx = 0,\n    sy = 0;\n  for (let j = -1; j <= 1; j++) {\n    for (let i = -1; i <= 1; i++) {\n      const xi = clamp(x + i, 0, width - 1);\n      const yi = clamp(y + j, 0, img.height - 1);\n      const idx = (yi * width + xi) * 4;\n      const r = data[idx],\n        g = data[idx + 1],\n        b = data[idx + 2];\n      const gray = 0.299 * r + 0.587 * g + 0.114 * b;\n      sx += gray * gx[j + 1][i + 1];\n      sy += gray * gy[j + 1][i + 1];\n    }\n  }\n  return Math.hypot(sx, sy);\n}\n\nexport function refinePointSobel(\n  canvas: HTMLCanvasElement,\n  p: Point,\n  radius = 6,\n): Point {\n  const ctx = canvas.getContext(\"2d\")!;\n  const img = ctx.getImageData(0, 0, canvas.width, canvas.height);\n  const cx = clamp(Math.round(p.x), 1, canvas.width - 2);\n  const cy = clamp(Math.round(p.y), 1, canvas.height - 2);\n  let best = { x: cx, y: cy, mag: -1 };\n  for (let y = cy - radius; y <= cy + radius; y++) {\n    for (let x = cx - radius; x <= cx + radius; x++) {\n      if (x <= 0 || y <= 0 || x >= canvas.width - 1 || y >= canvas.height - 1)\n        continue;\n      const mag = sobelAtGray(img, x, y);\n      if (mag > best.mag) best = { x, y, mag };\n    }\n  }\n  return { x: best.x, y: best.y };\n}\n\nexport function refinePointsSobel(\n  canvas: HTMLCanvasElement,\n  pts: Point[],\n  radius = 6,\n): Point[] {\n  return pts.map((p) => refinePointSobel(canvas, p, radius));\n}\n\n// Detect board orientation (theta) from calibration homography\n// The board has 4 calibration points on the double ring at sectors 20, 6, 3, 11 (top, right, bottom, left)\n// If the camera is rotated, these sectors will appear at different angles than expected\n// Returns theta in radians that can be used to correct sector calculations\nexport function detectBoardOrientation(\n  H: Homography,\n  canonicalTargets: Point[],\n): number {\n  // Get the 4 double ring points (indices 0-3)\n  // In canonical orientation: index 0 = 20 (top), 1 = 6 (right), 2 = 3 (bottom), 3 = 11 (left)\n  const rimPoints = canonicalTargets.slice(0, 4);\n\n  // Map each board-space rim point to image space via homography\n  const imagePoints = rimPoints.map((p) => applyHomography(H, p));\n\n  // Compute the center of the points in image space\n  const centerX =\n    imagePoints.reduce((sum, p) => sum + p.x, 0) / imagePoints.length;\n  const centerY =\n    imagePoints.reduce((sum, p) => sum + p.y, 0) / imagePoints.length;\n\n  // Compute angles of each point relative to center in image space\n  // The first point (canonical 20, top) should be at angle -Ï€/2 (negative Y)\n  const expectedAngles = [-Math.PI / 2, 0, Math.PI / 2, Math.PI];\n  const actualAngles = imagePoints.map((p) =>\n    Math.atan2(p.y - centerY, p.x - centerX),\n  );\n\n  // Compute the rotation needed to align actual with expected\n  // Use the first point as reference (it's the most consistent)\n  let theta = expectedAngles[0] - actualAngles[0];\n\n  // Normalize theta to [-Ï€, Ï€]\n  while (theta > Math.PI) theta -= 2 * Math.PI;\n  while (theta < -Math.PI) theta += 2 * Math.PI;\n\n  return theta;\n}\n\n// Convert theta (radians) to human-readable degrees for UI display\nexport function thetaToDegrees(theta: number | null): number {\n  if (theta === null) return 0;\n  return -(theta * 180) / Math.PI; // Negate because positive theta is CCW in math, but users think CW\n}\n","/**\n * Game-Mode-Specific Calibration Requirements\n *\n * Each game mode has different accuracy requirements:\n * - X01: Needs all zones (singles, doubles, trebles, bulls)\n * - Cricket: Only needs 6 numbers + bullseye\n * - Treble Practice: Only needs treble ring (strictest)\n * - Checkout modes: Need double precision\n */\n\nexport type CalibrationRequirement = {\n  tolerancePx: number; // Maximum acceptable error in pixels\n  requiredTargets: string[]; // Key areas needed for this game\n  criticalZones: string[]; // Most important areas to focus on during calibration\n  minConfidence: number; // Minimum acceptable calibration confidence (0-100)\n};\n\nexport function getGlobalCalibrationConfidence(\n  errorPx: number | null,\n): number | null {\n  if (errorPx == null || Number.isNaN(errorPx as any) || errorPx < 0) {\n    return null;\n  }\n\n  let percentage: number;\n  if (errorPx <= 0.25) percentage = 99.5 + (0.25 - errorPx) * 2;\n  else if (errorPx <= 1.0) percentage = 98 + (1.0 - errorPx) * 2;\n  else if (errorPx <= 2.0) percentage = 95 + (2.0 - errorPx) * 3;\n  else if (errorPx <= 5.0) percentage = 90 + (5.0 - errorPx) * 1.66;\n  else percentage = Math.max(0, 90 - (errorPx - 5) * 5);\n\n  const clamped = Math.max(0, Math.min(100, percentage));\n  return Number(clamped.toFixed(1));\n}\n\nexport const GAME_CALIBRATION_REQUIREMENTS: Record<\n  string,\n  CalibrationRequirement\n> = {\n  // Free Games\n  X01: {\n    tolerancePx: 10,\n    requiredTargets: [\"SINGLE\", \"DOUBLE\", \"TREBLE\", \"BULL\", \"OUTER_BULL\"],\n    criticalZones: [\"D20\", \"D1\", \"BULLSEYE\", \"T20\", \"SINGLE_20\"],\n    minConfidence: 80,\n  },\n  \"Double Practice\": {\n    tolerancePx: 12,\n    requiredTargets: [\"DOUBLE\", \"BULL\"],\n    criticalZones: [\"D20\", \"D1\", \"D6\", \"D17\"],\n    minConfidence: 75,\n  },\n\n  // Premium - Accuracy Critical\n  \"Treble Practice\": {\n    tolerancePx: 8, // Strictest requirement\n    requiredTargets: [\"TREBLE\"],\n    criticalZones: [\"T20\", \"T1\", \"T5\"],\n    minConfidence: 85,\n  },\n  \"Checkout 170\": {\n    tolerancePx: 9,\n    requiredTargets: [\"DOUBLE\"],\n    criticalZones: [\"D25\", \"D20\", \"D8\"],\n    minConfidence: 82,\n  },\n  \"Checkout 121\": {\n    tolerancePx: 9,\n    requiredTargets: [\"DOUBLE\"],\n    criticalZones: [\"D20\", \"D5\", \"D1\"],\n    minConfidence: 82,\n  },\n\n  // Premium - Target Subset\n  Cricket: {\n    tolerancePx: 15,\n    requiredTargets: [\"20\", \"19\", \"18\", \"17\", \"16\", \"15\", \"BULL\"],\n    criticalZones: [\"20\", \"15\", \"BULL\"],\n    minConfidence: 70,\n  },\n  \"American Cricket\": {\n    tolerancePx: 15,\n    requiredTargets: [\"20\", \"19\", \"18\", \"17\", \"16\", \"15\", \"BULL\"],\n    criticalZones: [\"20\", \"15\", \"BULL\"],\n    minConfidence: 70,\n  },\n\n  // Premium - All Numbers\n  \"Around the Clock\": {\n    tolerancePx: 12,\n    requiredTargets: [\n      \"1\",\n      \"2\",\n      \"3\",\n      \"4\",\n      \"5\",\n      \"6\",\n      \"7\",\n      \"8\",\n      \"9\",\n      \"10\",\n      \"11\",\n      \"12\",\n      \"13\",\n      \"14\",\n      \"15\",\n      \"16\",\n      \"17\",\n      \"18\",\n      \"19\",\n      \"20\",\n    ],\n    criticalZones: [\"1\", \"20\", \"6\", \"15\"],\n    minConfidence: 78,\n  },\n  Shanghai: {\n    tolerancePx: 13,\n    requiredTargets: [\n      \"1\",\n      \"2\",\n      \"3\",\n      \"4\",\n      \"5\",\n      \"6\",\n      \"7\",\n      \"SINGLE\",\n      \"DOUBLE\",\n      \"TREBLE\",\n    ],\n    criticalZones: [\"1\", \"7\", \"S1\", \"D1\", \"T1\"],\n    minConfidence: 75,\n  },\n\n  // Premium - Practice/Training\n  \"High Score\": {\n    tolerancePx: 14,\n    requiredTargets: [\"TREBLE\", \"DOUBLE\", \"BULL\"],\n    criticalZones: [\"T20\", \"BULL\", \"D20\"],\n    minConfidence: 72,\n  },\n  \"Low Score\": {\n    tolerancePx: 11,\n    requiredTargets: [\"SINGLE\"],\n    criticalZones: [\"1\", \"2\", \"3\"],\n    minConfidence: 76,\n  },\n  \"Count-Up\": {\n    tolerancePx: 13,\n    requiredTargets: [\"SINGLE\", \"DOUBLE\", \"TREBLE\"],\n    criticalZones: [\"20\", \"DOUBLE\", \"TREBLE\"],\n    minConfidence: 74,\n  },\n\n  // Premium - Head-to-Head\n  \"Halve It\": {\n    tolerancePx: 12,\n    requiredTargets: [\"TREBLE\", \"SINGLE\"],\n    criticalZones: [\"T20\", \"T5\", \"SINGLE\"],\n    minConfidence: 73,\n  },\n  \"High-Low\": {\n    tolerancePx: 13,\n    requiredTargets: [\"SINGLE\", \"DOUBLE\", \"BULL\"],\n    criticalZones: [\"HIGH (>10)\", \"LOW (<5)\", \"BULL\"],\n    minConfidence: 72,\n  },\n  Killer: {\n    tolerancePx: 12,\n    requiredTargets: [\"ALL_NUMBERS\"],\n    criticalZones: [\"RANDOM_TARGETS\"],\n    minConfidence: 74,\n  },\n\n  // Premium - Skill Games\n  Baseball: {\n    tolerancePx: 14,\n    requiredTargets: [\"1-9\", \"SINGLE\", \"DOUBLE\", \"TREBLE\"],\n    criticalZones: [\"1\", \"9\", \"TRIPLE\"],\n    minConfidence: 71,\n  },\n  Golf: {\n    tolerancePx: 14,\n    requiredTargets: [\"1-18\", \"TREBLE\"],\n    criticalZones: [\"T1\", \"T18\"],\n    minConfidence: 71,\n  },\n  \"Tic Tac Toe\": {\n    tolerancePx: 16,\n    requiredTargets: [\"1-9\", \"SINGLE\"],\n    criticalZones: [\"CENTER\", \"CORNERS\"],\n    minConfidence: 68,\n  },\n\n  // Premium - Variation Games\n  \"Bob's 27\": {\n    tolerancePx: 13,\n    requiredTargets: [\"SINGLE\", \"DOUBLE\"],\n    criticalZones: [\"1-20\", \"BULL\"],\n    minConfidence: 73,\n  },\n  Scam: {\n    tolerancePx: 14,\n    requiredTargets: [\"ALL_NUMBERS\", \"OUTER_BULL\"],\n    criticalZones: [\"TARGET_NUMBER\", \"OUTER_BULL\"],\n    minConfidence: 70,\n  },\n  Fives: {\n    tolerancePx: 14,\n    requiredTargets: [\"ALL_NUMBERS\", \"OUTER_BULL\"],\n    criticalZones: [\"5\", \"10\", \"15\", \"20\"],\n    minConfidence: 70,\n  },\n  Sevens: {\n    tolerancePx: 14,\n    requiredTargets: [\"ALL_NUMBERS\", \"OUTER_BULL\"],\n    criticalZones: [\"7\", \"14\"],\n    minConfidence: 70,\n  },\n};\n\n/**\n * Evaluate calibration quality for a specific game mode\n * Returns confidence level 0-100\n */\nexport function getCalibrationConfidenceForGame(\n  gameMode: string,\n  errorPx: number | null,\n): number {\n  // Treat missing/unknown error as unknown confidence. IMPORTANT: don't treat 0 as falsy.\n  if (errorPx == null || Number.isNaN(errorPx as any) || errorPx < 0) return 0;\n\n  const req = GAME_CALIBRATION_REQUIREMENTS[gameMode];\n  const tolerance = req?.tolerancePx ?? 12; // Default tolerance if game unknown\n\n  // v2.6: High-precision confidence calculation\n  // 0.25px error = 99.5% (User's target)\n  // 1.0px error = 98%\n  // 2.0px error = 95%\n  // 5.0px error = 90%\n  // At tolerance = 85%\n  // Beyond tolerance = drops linearly to 0% at 3x tolerance\n\n  if (errorPx <= 0.25) return 99.5 + (0.25 - errorPx) * 2; // 99.5% to 100%\n  if (errorPx <= 1.0) return 98 + (1.0 - errorPx) * 2; // 98% to 99.5%\n  if (errorPx <= 2.0) return 95 + (2.0 - errorPx) * 3; // 95% to 98%\n  if (errorPx <= 5.0) return 90 + (5.0 - errorPx) * 1.66; // 90% to 95%\n\n  if (errorPx <= tolerance) {\n    // Linear from 90% down to 85% at tolerance\n    const range = tolerance - 5;\n    if (range <= 0) return 85;\n    return 85 + ((tolerance - errorPx) / range) * 5;\n  } else {\n    // Beyond tolerance: drop linearly to 0 at 3x tolerance\n    // This is much less punishing than the previous version\n    const maxError = tolerance * 3;\n    if (errorPx >= maxError) return 0;\n    return 85 * (1 - (errorPx - tolerance) / (maxError - tolerance));\n  }\n}\n\n/**\n * Check if calibration is suitable for a game\n */\nexport function isCalibrationSuitableForGame(\n  gameMode: string,\n  errorPx: number | null,\n): boolean {\n  // Treat missing/unknown error as not suitable. IMPORTANT: don't treat 0 as missing.\n  if (errorPx == null || Number.isNaN(errorPx as any) || errorPx < 0)\n    return false;\n\n  const req = GAME_CALIBRATION_REQUIREMENTS[gameMode];\n  if (!req) return true; // Unknown game, assume suitable\n\n  const confidence = getCalibrationConfidenceForGame(gameMode, errorPx);\n  return confidence >= req.minConfidence;\n}\n\n/**\n * Get a human-readable assessment of calibration quality\n */\nexport function getCalibrationQualityText(\n  gameMode: string,\n  errorPx: number | null,\n): {\n  quality: \"perfect\" | \"excellent\" | \"good\" | \"fair\" | \"poor\" | \"none\";\n  text: string;\n} {\n  // IMPORTANT: don't treat 0 as missing.\n  if (errorPx == null || Number.isNaN(errorPx as any) || errorPx < 0) {\n    return { quality: \"none\", text: \"Camera not connected\" };\n  }\n\n  const confidence = getCalibrationConfidenceForGame(gameMode, errorPx);\n\n  if (confidence >= 99.5) {\n    return {\n      quality: \"perfect\",\n      text: `Perfect (${confidence.toFixed(1)}%)`,\n    };\n  } else if (confidence >= 90) {\n    return {\n      quality: \"excellent\",\n      text: `Excellent (${Math.round(confidence)}%)`,\n    };\n  } else if (confidence >= 75) {\n    return { quality: \"good\", text: `Good (${Math.round(confidence)}%)` };\n  } else if (confidence >= 50) {\n    return { quality: \"fair\", text: `Fair (${Math.round(confidence)}%)` };\n  } else {\n    return { quality: \"poor\", text: `Poor (${Math.round(confidence)}%)` };\n  }\n}\n\nexport type CalibrationStatus = \"verified\" | \"unknown\" | \"none\";\n\n/**\n * Shared, UI-friendly calibration gate.\n *\n * Contract:\n * - verified: has a homography AND an imageSize AND (locked OR errorPx <= maxErrorPx)\n * - unknown: has a homography but is missing quality metrics (imageSize/errorPx)\n * - none: no homography\n */\nexport function getCalibrationStatus(params: {\n  H: any | null | undefined;\n  imageSize?: { w: number; h: number } | null;\n  locked?: boolean | null;\n  errorPx?: number | null;\n  maxErrorPx?: number;\n}): CalibrationStatus {\n  const { H, imageSize, locked, errorPx, maxErrorPx = 12 } = params;\n  if (!H) return \"none\";\n\n  const hasImageSize = !!(\n    imageSize &&\n    typeof imageSize.w === \"number\" &&\n    typeof imageSize.h === \"number\" &&\n    imageSize.w > 0 &&\n    imageSize.h > 0\n  );\n  const errorVal =\n    typeof errorPx === \"number\" && !Number.isNaN(errorPx) ? errorPx : null;\n\n  if (\n    hasImageSize &&\n    (locked || (errorVal != null && errorVal <= maxErrorPx))\n  ) {\n    return \"verified\";\n  }\n  return \"unknown\";\n}\n\n/**\n * Get personalized recalibration recommendation for a game\n */\nexport function getRecalibrationRecommendation(\n  gameMode: string,\n): string | null {\n  const req = GAME_CALIBRATION_REQUIREMENTS[gameMode];\n  if (!req || req.criticalZones.length === 0) return null;\n\n  const zones = req.criticalZones.join(\", \");\n  return `Recalibrate focusing on: ${zones}`;\n}\n\n/**\n * Get all games sorted by calibration difficulty (strictest first)\n */\nexport function getGamesByCalibrationDifficulty(): string[] {\n  return Object.entries(GAME_CALIBRATION_REQUIREMENTS)\n    .sort((a, b) => a[1].tolerancePx - b[1].tolerancePx)\n    .map(([name]) => name);\n}\n","const createStoreImpl = (createState) => {\n  let state;\n  const listeners = /* @__PURE__ */ new Set();\n  const setState = (partial, replace) => {\n    const nextState = typeof partial === \"function\" ? partial(state) : partial;\n    if (!Object.is(nextState, state)) {\n      const previousState = state;\n      state = (replace != null ? replace : typeof nextState !== \"object\" || nextState === null) ? nextState : Object.assign({}, state, nextState);\n      listeners.forEach((listener) => listener(state, previousState));\n    }\n  };\n  const getState = () => state;\n  const getInitialState = () => initialState;\n  const subscribe = (listener) => {\n    listeners.add(listener);\n    return () => listeners.delete(listener);\n  };\n  const destroy = () => {\n    if ((import.meta.env ? import.meta.env.MODE : void 0) !== \"production\") {\n      console.warn(\n        \"[DEPRECATED] The `destroy` method will be unsupported in a future version. Instead use unsubscribe function returned by subscribe. Everything will be garbage-collected if store is garbage-collected.\"\n      );\n    }\n    listeners.clear();\n  };\n  const api = { setState, getState, getInitialState, subscribe, destroy };\n  const initialState = state = createState(setState, getState, api);\n  return api;\n};\nconst createStore = (createState) => createState ? createStoreImpl(createState) : createStoreImpl;\nvar vanilla = (createState) => {\n  if ((import.meta.env ? import.meta.env.MODE : void 0) !== \"production\") {\n    console.warn(\n      \"[DEPRECATED] Default export is deprecated. Instead use import { createStore } from 'zustand/vanilla'.\"\n    );\n  }\n  return createStore(createState);\n};\n\nexport { createStore, vanilla as default };\n","/**\n * @license React\n * react.production.min.js\n *\n * Copyright (c) Facebook, Inc. and its affiliates.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n */\n'use strict';var l=Symbol.for(\"react.element\"),n=Symbol.for(\"react.portal\"),p=Symbol.for(\"react.fragment\"),q=Symbol.for(\"react.strict_mode\"),r=Symbol.for(\"react.profiler\"),t=Symbol.for(\"react.provider\"),u=Symbol.for(\"react.context\"),v=Symbol.for(\"react.forward_ref\"),w=Symbol.for(\"react.suspense\"),x=Symbol.for(\"react.memo\"),y=Symbol.for(\"react.lazy\"),z=Symbol.iterator;function A(a){if(null===a||\"object\"!==typeof a)return null;a=z&&a[z]||a[\"@@iterator\"];return\"function\"===typeof a?a:null}\nvar B={isMounted:function(){return!1},enqueueForceUpdate:function(){},enqueueReplaceState:function(){},enqueueSetState:function(){}},C=Object.assign,D={};function E(a,b,e){this.props=a;this.context=b;this.refs=D;this.updater=e||B}E.prototype.isReactComponent={};\nE.prototype.setState=function(a,b){if(\"object\"!==typeof a&&\"function\"!==typeof a&&null!=a)throw Error(\"setState(...): takes an object of state variables to update or a function which returns an object of state variables.\");this.updater.enqueueSetState(this,a,b,\"setState\")};E.prototype.forceUpdate=function(a){this.updater.enqueueForceUpdate(this,a,\"forceUpdate\")};function F(){}F.prototype=E.prototype;function G(a,b,e){this.props=a;this.context=b;this.refs=D;this.updater=e||B}var H=G.prototype=new F;\nH.constructor=G;C(H,E.prototype);H.isPureReactComponent=!0;var I=Array.isArray,J=Object.prototype.hasOwnProperty,K={current:null},L={key:!0,ref:!0,__self:!0,__source:!0};\nfunction M(a,b,e){var d,c={},k=null,h=null;if(null!=b)for(d in void 0!==b.ref&&(h=b.ref),void 0!==b.key&&(k=\"\"+b.key),b)J.call(b,d)&&!L.hasOwnProperty(d)&&(c[d]=b[d]);var g=arguments.length-2;if(1===g)c.children=e;else if(1<g){for(var f=Array(g),m=0;m<g;m++)f[m]=arguments[m+2];c.children=f}if(a&&a.defaultProps)for(d in g=a.defaultProps,g)void 0===c[d]&&(c[d]=g[d]);return{$$typeof:l,type:a,key:k,ref:h,props:c,_owner:K.current}}\nfunction N(a,b){return{$$typeof:l,type:a.type,key:b,ref:a.ref,props:a.props,_owner:a._owner}}function O(a){return\"object\"===typeof a&&null!==a&&a.$$typeof===l}function escape(a){var b={\"=\":\"=0\",\":\":\"=2\"};return\"$\"+a.replace(/[=:]/g,function(a){return b[a]})}var P=/\\/+/g;function Q(a,b){return\"object\"===typeof a&&null!==a&&null!=a.key?escape(\"\"+a.key):b.toString(36)}\nfunction R(a,b,e,d,c){var k=typeof a;if(\"undefined\"===k||\"boolean\"===k)a=null;var h=!1;if(null===a)h=!0;else switch(k){case \"string\":case \"number\":h=!0;break;case \"object\":switch(a.$$typeof){case l:case n:h=!0}}if(h)return h=a,c=c(h),a=\"\"===d?\".\"+Q(h,0):d,I(c)?(e=\"\",null!=a&&(e=a.replace(P,\"$&/\")+\"/\"),R(c,b,e,\"\",function(a){return a})):null!=c&&(O(c)&&(c=N(c,e+(!c.key||h&&h.key===c.key?\"\":(\"\"+c.key).replace(P,\"$&/\")+\"/\")+a)),b.push(c)),1;h=0;d=\"\"===d?\".\":d+\":\";if(I(a))for(var g=0;g<a.length;g++){k=\na[g];var f=d+Q(k,g);h+=R(k,b,e,f,c)}else if(f=A(a),\"function\"===typeof f)for(a=f.call(a),g=0;!(k=a.next()).done;)k=k.value,f=d+Q(k,g++),h+=R(k,b,e,f,c);else if(\"object\"===k)throw b=String(a),Error(\"Objects are not valid as a React child (found: \"+(\"[object Object]\"===b?\"object with keys {\"+Object.keys(a).join(\", \")+\"}\":b)+\"). If you meant to render a collection of children, use an array instead.\");return h}\nfunction S(a,b,e){if(null==a)return a;var d=[],c=0;R(a,d,\"\",\"\",function(a){return b.call(e,a,c++)});return d}function T(a){if(-1===a._status){var b=a._result;b=b();b.then(function(b){if(0===a._status||-1===a._status)a._status=1,a._result=b},function(b){if(0===a._status||-1===a._status)a._status=2,a._result=b});-1===a._status&&(a._status=0,a._result=b)}if(1===a._status)return a._result.default;throw a._result;}\nvar U={current:null},V={transition:null},W={ReactCurrentDispatcher:U,ReactCurrentBatchConfig:V,ReactCurrentOwner:K};function X(){throw Error(\"act(...) is not supported in production builds of React.\");}\nexports.Children={map:S,forEach:function(a,b,e){S(a,function(){b.apply(this,arguments)},e)},count:function(a){var b=0;S(a,function(){b++});return b},toArray:function(a){return S(a,function(a){return a})||[]},only:function(a){if(!O(a))throw Error(\"React.Children.only expected to receive a single React element child.\");return a}};exports.Component=E;exports.Fragment=p;exports.Profiler=r;exports.PureComponent=G;exports.StrictMode=q;exports.Suspense=w;\nexports.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=W;exports.act=X;\nexports.cloneElement=function(a,b,e){if(null===a||void 0===a)throw Error(\"React.cloneElement(...): The argument must be a React element, but you passed \"+a+\".\");var d=C({},a.props),c=a.key,k=a.ref,h=a._owner;if(null!=b){void 0!==b.ref&&(k=b.ref,h=K.current);void 0!==b.key&&(c=\"\"+b.key);if(a.type&&a.type.defaultProps)var g=a.type.defaultProps;for(f in b)J.call(b,f)&&!L.hasOwnProperty(f)&&(d[f]=void 0===b[f]&&void 0!==g?g[f]:b[f])}var f=arguments.length-2;if(1===f)d.children=e;else if(1<f){g=Array(f);\nfor(var m=0;m<f;m++)g[m]=arguments[m+2];d.children=g}return{$$typeof:l,type:a.type,key:c,ref:k,props:d,_owner:h}};exports.createContext=function(a){a={$$typeof:u,_currentValue:a,_currentValue2:a,_threadCount:0,Provider:null,Consumer:null,_defaultValue:null,_globalName:null};a.Provider={$$typeof:t,_context:a};return a.Consumer=a};exports.createElement=M;exports.createFactory=function(a){var b=M.bind(null,a);b.type=a;return b};exports.createRef=function(){return{current:null}};\nexports.forwardRef=function(a){return{$$typeof:v,render:a}};exports.isValidElement=O;exports.lazy=function(a){return{$$typeof:y,_payload:{_status:-1,_result:a},_init:T}};exports.memo=function(a,b){return{$$typeof:x,type:a,compare:void 0===b?null:b}};exports.startTransition=function(a){var b=V.transition;V.transition={};try{a()}finally{V.transition=b}};exports.unstable_act=X;exports.useCallback=function(a,b){return U.current.useCallback(a,b)};exports.useContext=function(a){return U.current.useContext(a)};\nexports.useDebugValue=function(){};exports.useDeferredValue=function(a){return U.current.useDeferredValue(a)};exports.useEffect=function(a,b){return U.current.useEffect(a,b)};exports.useId=function(){return U.current.useId()};exports.useImperativeHandle=function(a,b,e){return U.current.useImperativeHandle(a,b,e)};exports.useInsertionEffect=function(a,b){return U.current.useInsertionEffect(a,b)};exports.useLayoutEffect=function(a,b){return U.current.useLayoutEffect(a,b)};\nexports.useMemo=function(a,b){return U.current.useMemo(a,b)};exports.useReducer=function(a,b,e){return U.current.useReducer(a,b,e)};exports.useRef=function(a){return U.current.useRef(a)};exports.useState=function(a){return U.current.useState(a)};exports.useSyncExternalStore=function(a,b,e){return U.current.useSyncExternalStore(a,b,e)};exports.useTransition=function(){return U.current.useTransition()};exports.version=\"18.3.1\";\n","'use strict';\n\nif (process.env.NODE_ENV === 'production') {\n  module.exports = require('./cjs/react.production.min.js');\n} else {\n  module.exports = require('./cjs/react.development.js');\n}\n","/**\n * @license React\n * use-sync-external-store-shim.production.js\n *\n * Copyright (c) Meta Platforms, Inc. and affiliates.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n */\n\n\"use strict\";\nvar React = require(\"react\");\nfunction is(x, y) {\n  return (x === y && (0 !== x || 1 / x === 1 / y)) || (x !== x && y !== y);\n}\nvar objectIs = \"function\" === typeof Object.is ? Object.is : is,\n  useState = React.useState,\n  useEffect = React.useEffect,\n  useLayoutEffect = React.useLayoutEffect,\n  useDebugValue = React.useDebugValue;\nfunction useSyncExternalStore$2(subscribe, getSnapshot) {\n  var value = getSnapshot(),\n    _useState = useState({ inst: { value: value, getSnapshot: getSnapshot } }),\n    inst = _useState[0].inst,\n    forceUpdate = _useState[1];\n  useLayoutEffect(\n    function () {\n      inst.value = value;\n      inst.getSnapshot = getSnapshot;\n      checkIfSnapshotChanged(inst) && forceUpdate({ inst: inst });\n    },\n    [subscribe, value, getSnapshot]\n  );\n  useEffect(\n    function () {\n      checkIfSnapshotChanged(inst) && forceUpdate({ inst: inst });\n      return subscribe(function () {\n        checkIfSnapshotChanged(inst) && forceUpdate({ inst: inst });\n      });\n    },\n    [subscribe]\n  );\n  useDebugValue(value);\n  return value;\n}\nfunction checkIfSnapshotChanged(inst) {\n  var latestGetSnapshot = inst.getSnapshot;\n  inst = inst.value;\n  try {\n    var nextValue = latestGetSnapshot();\n    return !objectIs(inst, nextValue);\n  } catch (error) {\n    return !0;\n  }\n}\nfunction useSyncExternalStore$1(subscribe, getSnapshot) {\n  return getSnapshot();\n}\nvar shim =\n  \"undefined\" === typeof window ||\n  \"undefined\" === typeof window.document ||\n  \"undefined\" === typeof window.document.createElement\n    ? useSyncExternalStore$1\n    : useSyncExternalStore$2;\nexports.useSyncExternalStore =\n  void 0 !== React.useSyncExternalStore ? React.useSyncExternalStore : shim;\n","'use strict';\n\nif (process.env.NODE_ENV === 'production') {\n  module.exports = require('../cjs/use-sync-external-store-shim.production.js');\n} else {\n  module.exports = require('../cjs/use-sync-external-store-shim.development.js');\n}\n","/**\n * @license React\n * use-sync-external-store-shim/with-selector.production.js\n *\n * Copyright (c) Meta Platforms, Inc. and affiliates.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n */\n\n\"use strict\";\nvar React = require(\"react\"),\n  shim = require(\"use-sync-external-store/shim\");\nfunction is(x, y) {\n  return (x === y && (0 !== x || 1 / x === 1 / y)) || (x !== x && y !== y);\n}\nvar objectIs = \"function\" === typeof Object.is ? Object.is : is,\n  useSyncExternalStore = shim.useSyncExternalStore,\n  useRef = React.useRef,\n  useEffect = React.useEffect,\n  useMemo = React.useMemo,\n  useDebugValue = React.useDebugValue;\nexports.useSyncExternalStoreWithSelector = function (\n  subscribe,\n  getSnapshot,\n  getServerSnapshot,\n  selector,\n  isEqual\n) {\n  var instRef = useRef(null);\n  if (null === instRef.current) {\n    var inst = { hasValue: !1, value: null };\n    instRef.current = inst;\n  } else inst = instRef.current;\n  instRef = useMemo(\n    function () {\n      function memoizedSelector(nextSnapshot) {\n        if (!hasMemo) {\n          hasMemo = !0;\n          memoizedSnapshot = nextSnapshot;\n          nextSnapshot = selector(nextSnapshot);\n          if (void 0 !== isEqual && inst.hasValue) {\n            var currentSelection = inst.value;\n            if (isEqual(currentSelection, nextSnapshot))\n              return (memoizedSelection = currentSelection);\n          }\n          return (memoizedSelection = nextSnapshot);\n        }\n        currentSelection = memoizedSelection;\n        if (objectIs(memoizedSnapshot, nextSnapshot)) return currentSelection;\n        var nextSelection = selector(nextSnapshot);\n        if (void 0 !== isEqual && isEqual(currentSelection, nextSelection))\n          return (memoizedSnapshot = nextSnapshot), currentSelection;\n        memoizedSnapshot = nextSnapshot;\n        return (memoizedSelection = nextSelection);\n      }\n      var hasMemo = !1,\n        memoizedSnapshot,\n        memoizedSelection,\n        maybeGetServerSnapshot =\n          void 0 === getServerSnapshot ? null : getServerSnapshot;\n      return [\n        function () {\n          return memoizedSelector(getSnapshot());\n        },\n        null === maybeGetServerSnapshot\n          ? void 0\n          : function () {\n              return memoizedSelector(maybeGetServerSnapshot());\n            }\n      ];\n    },\n    [getSnapshot, getServerSnapshot, selector, isEqual]\n  );\n  var value = useSyncExternalStore(subscribe, instRef[0], instRef[1]);\n  useEffect(\n    function () {\n      inst.hasValue = !0;\n      inst.value = value;\n    },\n    [value]\n  );\n  useDebugValue(value);\n  return value;\n};\n","'use strict';\n\nif (process.env.NODE_ENV === 'production') {\n  module.exports = require('../cjs/use-sync-external-store-shim/with-selector.production.js');\n} else {\n  module.exports = require('../cjs/use-sync-external-store-shim/with-selector.development.js');\n}\n","import { createStore } from 'zustand/vanilla';\nexport * from 'zustand/vanilla';\nimport ReactExports from 'react';\nimport useSyncExternalStoreExports from 'use-sync-external-store/shim/with-selector.js';\n\nconst { useDebugValue } = ReactExports;\nconst { useSyncExternalStoreWithSelector } = useSyncExternalStoreExports;\nlet didWarnAboutEqualityFn = false;\nconst identity = (arg) => arg;\nfunction useStore(api, selector = identity, equalityFn) {\n  if ((import.meta.env ? import.meta.env.MODE : void 0) !== \"production\" && equalityFn && !didWarnAboutEqualityFn) {\n    console.warn(\n      \"[DEPRECATED] Use `createWithEqualityFn` instead of `create` or use `useStoreWithEqualityFn` instead of `useStore`. They can be imported from 'zustand/traditional'. https://github.com/pmndrs/zustand/discussions/1937\"\n    );\n    didWarnAboutEqualityFn = true;\n  }\n  const slice = useSyncExternalStoreWithSelector(\n    api.subscribe,\n    api.getState,\n    api.getServerState || api.getInitialState,\n    selector,\n    equalityFn\n  );\n  useDebugValue(slice);\n  return slice;\n}\nconst createImpl = (createState) => {\n  if ((import.meta.env ? import.meta.env.MODE : void 0) !== \"production\" && typeof createState !== \"function\") {\n    console.warn(\n      \"[DEPRECATED] Passing a vanilla store will be unsupported in a future version. Instead use `import { useStore } from 'zustand'`.\"\n    );\n  }\n  const api = typeof createState === \"function\" ? createStore(createState) : createState;\n  const useBoundStore = (selector, equalityFn) => useStore(api, selector, equalityFn);\n  Object.assign(useBoundStore, api);\n  return useBoundStore;\n};\nconst create = (createState) => createState ? createImpl(createState) : createImpl;\nvar react = (createState) => {\n  if ((import.meta.env ? import.meta.env.MODE : void 0) !== \"production\") {\n    console.warn(\n      \"[DEPRECATED] Default export is deprecated. Instead use `import { create } from 'zustand'`.\"\n    );\n  }\n  return create(createState);\n};\n\nexport { create, react as default, useStore };\n","import { create } from \"zustand\";\n// Import logger for side-effects (initialization/patching in some builds)\nimport \"../utils/logger\";\n\ntype LastOffline = {\n  mode: string;\n  x01Start: number;\n  firstTo: number;\n  aiLevel: string;\n};\n\ntype SettingsState = {\n  user?: {\n    username?: string;\n    name?: string;\n    displayName?: string;\n    email?: string;\n  } | null;\n  favoriteDouble: string;\n  callerEnabled: boolean;\n  callerVoice: string; // voice name\n  callerVolume: number; // 0..1\n  speakCheckoutOnly: boolean;\n  avgMode: \"all-time\" | \"24h\";\n  autoStartOffline: boolean;\n  rememberLastOffline: boolean;\n  lastOffline: LastOffline;\n  reducedMotion: boolean;\n  compactHeader: boolean;\n  allowSpectate: boolean;\n  // UI tuning\n  cameraScale: number; // 0.5 .. 2.0\n  cameraAspect?: \"wide\" | \"square\";\n  cameraFitMode?: \"fit\" | \"fill\";\n  // External autoscore provider\n  autoscoreProvider?: \"built-in\" | \"built-in-v2\" | \"external-ws\" | \"manual\";\n  autoscoreWsUrl?: string;\n  autoCommitMode?: \"wait-for-clear\" | \"immediate\";\n  // Autoscore quality gating\n  // If enabled, detections below the threshold must be confirmed by the user.\n  confirmUncertainDarts?: boolean;\n  // 0..1 confidence threshold used by built-in autoscore.\n  autoScoreConfidenceThreshold?: number;\n  // Built-in detector tuning (advanced)\n  // These primarily affect the DartDetector blob segmentation and stability gating.\n  autoscoreDetectorMinArea?: number;\n  autoscoreDetectorThresh?: number;\n  autoscoreDetectorRequireStableN?: number;\n  // Lighting / glare mitigation (optional)\n  harshLightingMode?: boolean;\n  // Visual aid: emphasize big trebles (T20/T19/T18)\n  enhanceBigTrebles?: boolean;\n  // Allow immediate autocommit when playing online/tournaments\n  allowAutocommitInOnline?: boolean;\n  calibrationGuide: boolean;\n  // Use RANSAC-based homography for auto-detection\n  calibrationUseRansac?: boolean;\n  // Preserve calibration overlay display size when calibration is locked\n  preserveCalibrationOverlay: boolean;\n  // When true, don't auto-override the calibration state when camera device changes or auto detection runs\n  preserveCalibrationOnCameraChange: boolean;\n  // Devices & preferences\n  preferredCameraId?: string;\n  preferredCameraLabel?: string;\n  preferredCameraLocked?: boolean;\n  // Camera control\n  cameraEnabled: boolean;\n  hideCameraOverlay: boolean;\n  // Show segment labels (e.g., 'T20') in UI/detection logs. Some users prefer numeric-only.\n  cameraShowLabels?: boolean;\n  // Reduce resolution + processing for lower-latency preview (good for slow devices)\n  cameraLowLatency?: boolean;\n  // Processing FPS used by the detection loop (frames/sec). Lower reduces CPU and latency.\n  cameraProcessingFps?: number;\n  // When true, allow the camera detector to add/record darts automatically.\n  // Some users prefer to use the camera for detection/counting only without\n  // committing darts to visits automatically.\n  cameraRecordDarts?: boolean;\n  ignorePreferredCameraSync: boolean;\n  // UI variants\n  offlineLayout?: \"classic\" | \"modern\";\n  // Match UI\n  hideInGameSidebar?: boolean;\n  // Admin-controlled section visibility\n  hiddenSections?: string[];\n  // Text size\n  textSize: \"small\" | \"medium\" | \"large\";\n  // Box size\n  boxSize: \"small\" | \"medium\" | \"large\";\n  // Stats UI tuning\n  statsCardMinHeight?: number;\n  // Card depth (padding-bottom) applied to page cards like the stats card\n  cardPaddingBottom?: number;\n  // Match configuration\n  matchType?: \"singles\" | \"doubles\";\n  teamAName?: string;\n  teamBName?: string;\n  setFavoriteDouble: (d: string) => void;\n  setCallerEnabled: (v: boolean) => void;\n  setCallerVoice: (name: string) => void;\n  setAvgMode: (mode: \"all-time\" | \"24h\") => void;\n  setCallerVolume: (v: number) => void;\n  setSpeakCheckoutOnly: (v: boolean) => void;\n  setAutoStartOffline: (v: boolean) => void;\n  setRememberLastOffline: (v: boolean) => void;\n  setLastOffline: (cfg: Partial<LastOffline>) => void;\n  setReducedMotion: (v: boolean) => void;\n  setCompactHeader: (v: boolean) => void;\n  setAllowSpectate: (v: boolean) => void;\n  setCameraScale: (n: number) => void;\n  setCameraAspect: (a: \"wide\" | \"square\") => void;\n  setCameraFitMode: (m: \"fit\" | \"fill\") => void;\n  setCalibrationGuide: (v: boolean) => void;\n  setCalibrationUseRansac: (v: boolean) => void;\n  setPreserveCalibrationOverlay: (v: boolean) => void;\n  setPreserveCalibrationOnCameraChange: (v: boolean) => void;\n  setPreferredCamera: (\n    id: string | undefined,\n    label?: string,\n    force?: boolean,\n  ) => void;\n  setPreferredCameraLocked: (v: boolean) => void;\n  setCameraEnabled: (v: boolean) => void;\n  setHideCameraOverlay: (v: boolean) => void;\n  setCameraShowLabels: (v: boolean) => void;\n  setCameraLowLatency: (v: boolean) => void;\n  setCameraProcessingFps: (n: number) => void;\n  setCameraRecordDarts: (v: boolean) => void;\n  setIgnorePreferredCameraSync: (v: boolean) => void;\n  setOfflineLayout: (mode: \"classic\" | \"modern\") => void;\n  setHideInGameSidebar: (v: boolean) => void;\n  setHiddenSections: (sections: string[]) => void;\n  setAutoscoreProvider: (\n    p: \"built-in\" | \"built-in-v2\" | \"external-ws\" | \"manual\",\n  ) => void;\n  setAutoscoreWsUrl: (u: string) => void;\n  setAutoCommitMode: (mode: \"wait-for-clear\" | \"immediate\") => void;\n  setConfirmUncertainDarts: (v: boolean) => void;\n  setAutoScoreConfidenceThreshold: (n: number) => void;\n  setAutoscoreDetectorMinArea: (n: number) => void;\n  setAutoscoreDetectorThresh: (n: number) => void;\n  setAutoscoreDetectorRequireStableN: (n: number) => void;\n  setHarshLightingMode: (v: boolean) => void;\n  setEnhanceBigTrebles: (v: boolean) => void;\n  setAllowAutocommitInOnline: (v: boolean) => void;\n  setTextSize: (size: \"small\" | \"medium\" | \"large\") => void;\n  setBoxSize: (size: \"small\" | \"medium\" | \"large\") => void;\n  setStatsCardMinHeight: (n: number) => void;\n  setCardPaddingBottom: (n: number) => void;\n  setMatchType: (t: \"singles\" | \"doubles\") => void;\n  setTeamAName: (name: string) => void;\n  setTeamBName: (name: string) => void;\n  // Throw timer per dart\n  dartTimerEnabled?: boolean;\n  dartTimerSeconds?: number;\n  setDartTimerEnabled: (v: boolean) => void;\n  setDartTimerSeconds: (n: number) => void;\n  // X01 rules\n  x01DoubleIn?: boolean;\n  setX01DoubleIn: (v: boolean) => void;\n};\nconst KEY = \"ndn_user_settings\";\n\nfunction load(): Pick<\n  SettingsState,\n  | \"favoriteDouble\"\n  | \"callerEnabled\"\n  | \"callerVoice\"\n  | \"avgMode\"\n  | \"callerVolume\"\n  | \"speakCheckoutOnly\"\n  | \"autoStartOffline\"\n  | \"rememberLastOffline\"\n  | \"lastOffline\"\n  | \"reducedMotion\"\n  | \"compactHeader\"\n  | \"allowSpectate\"\n  | \"cameraScale\"\n  | \"cameraAspect\"\n  | \"cameraFitMode\"\n  | \"cameraRecordDarts\"\n  | \"cameraShowLabels\"\n  | \"cameraLowLatency\"\n  | \"cameraProcessingFps\"\n  | \"calibrationGuide\"\n  | \"calibrationUseRansac\"\n  | \"preserveCalibrationOverlay\"\n  | \"preserveCalibrationOnCameraChange\"\n  | \"preferredCameraId\"\n  | \"preferredCameraLabel\"\n  | \"preferredCameraLocked\"\n  | \"cameraEnabled\"\n  | \"hideCameraOverlay\"\n  | \"offlineLayout\"\n  | \"hideInGameSidebar\"\n  | \"hiddenSections\"\n  | \"autoscoreProvider\"\n  | \"autoscoreWsUrl\"\n  | \"autoCommitMode\"\n  | \"confirmUncertainDarts\"\n  | \"autoScoreConfidenceThreshold\"\n  | \"autoscoreDetectorMinArea\"\n  | \"autoscoreDetectorThresh\"\n  | \"autoscoreDetectorRequireStableN\"\n  | \"harshLightingMode\"\n  | \"enhanceBigTrebles\"\n  | \"allowAutocommitInOnline\"\n  | \"textSize\"\n  | \"boxSize\"\n  | \"statsCardMinHeight\"\n  | \"cardPaddingBottom\"\n  | \"matchType\"\n  | \"teamAName\"\n  | \"teamBName\"\n  | \"dartTimerEnabled\"\n  | \"dartTimerSeconds\"\n  | \"x01DoubleIn\"\n> {\n  try {\n    const raw = localStorage.getItem(KEY);\n    if (!raw)\n      return {\n        favoriteDouble: \"D16\",\n        callerEnabled: true,\n        callerVoice: \"\",\n        callerVolume: 1,\n        speakCheckoutOnly: false,\n        avgMode: \"all-time\",\n        autoStartOffline: false,\n        rememberLastOffline: true,\n        lastOffline: {\n          mode: \"X01\",\n          x01Start: 501,\n          firstTo: 1,\n          aiLevel: \"None\",\n        },\n        reducedMotion: false,\n        compactHeader: false,\n        allowSpectate: true,\n        cameraScale: 1.0,\n        cameraAspect: \"wide\",\n        cameraFitMode: \"fit\",\n        cameraRecordDarts: true,\n        cameraShowLabels: false,\n        cameraLowLatency: false,\n        cameraProcessingFps: 15,\n        calibrationGuide: true,\n        preferredCameraId: undefined,\n        preferredCameraLabel: undefined,\n        preserveCalibrationOverlay: true,\n        preserveCalibrationOnCameraChange: true,\n        cameraEnabled: true,\n        hideCameraOverlay: false,\n        offlineLayout: \"modern\",\n        hideInGameSidebar: true,\n        hiddenSections: [],\n        autoscoreProvider: \"built-in\",\n        autoscoreWsUrl: \"\",\n        autoCommitMode: \"immediate\",\n        confirmUncertainDarts: false,\n        autoScoreConfidenceThreshold: 0.82,\n        autoscoreDetectorMinArea: 30,\n        autoscoreDetectorThresh: 15,\n        autoscoreDetectorRequireStableN: 2,\n        harshLightingMode: false,\n        enhanceBigTrebles: false,\n        allowAutocommitInOnline: false,\n        textSize: \"medium\",\n        boxSize: \"medium\",\n        statsCardMinHeight: 220,\n        cardPaddingBottom: 200,\n        matchType: \"singles\",\n        teamAName: \"Team A\",\n        teamBName: \"Team B\",\n        dartTimerEnabled: false,\n        dartTimerSeconds: 10,\n        x01DoubleIn: false,\n      };\n    const j = JSON.parse(raw);\n    const version = Number((j as any)?.__version || 0);\n    if (version < 2) {\n      // Smooth autoscore migration: reduce manual steps for existing users.\n      const migrated = {\n        ...j,\n        autoCommitMode: \"immediate\",\n        confirmUncertainDarts: false,\n        cameraRecordDarts: true,\n        autoScoreConfidenceThreshold: 0.82,\n        __version: 2,\n      };\n      try {\n        localStorage.setItem(KEY, JSON.stringify(migrated));\n      } catch {}\n    }\n    return {\n      favoriteDouble: j.favoriteDouble || \"D16\",\n      callerEnabled:\n        typeof j.callerEnabled === \"boolean\" ? j.callerEnabled : true,\n      callerVoice: j.callerVoice || \"\",\n      callerVolume:\n        typeof j.callerVolume === \"number\"\n          ? Math.max(0, Math.min(1, j.callerVolume))\n          : 1,\n      speakCheckoutOnly: !!j.speakCheckoutOnly,\n      avgMode: j.avgMode === \"24h\" ? \"24h\" : \"all-time\",\n      autoStartOffline: !!j.autoStartOffline,\n      rememberLastOffline:\n        typeof j.rememberLastOffline === \"boolean\"\n          ? j.rememberLastOffline\n          : true,\n      lastOffline:\n        j.lastOffline && typeof j.lastOffline === \"object\"\n          ? {\n              mode: j.lastOffline.mode || \"X01\",\n              x01Start: Number(j.lastOffline.x01Start) || 501,\n              firstTo: Number(j.lastOffline.firstTo) || 1,\n              aiLevel: j.lastOffline.aiLevel || \"None\",\n            }\n          : { mode: \"X01\", x01Start: 501, firstTo: 1, aiLevel: \"None\" },\n      reducedMotion: !!j.reducedMotion,\n      compactHeader: !!j.compactHeader,\n      allowSpectate:\n        typeof j.allowSpectate === \"boolean\" ? j.allowSpectate : true,\n      cameraScale:\n        typeof j.cameraScale === \"number\" && isFinite(j.cameraScale)\n          ? Math.max(0.5, Math.min(1.25, j.cameraScale))\n          : 1.0,\n      cameraAspect: j.cameraAspect === \"square\" ? \"square\" : \"wide\",\n      cameraFitMode:\n        j.cameraFitMode === \"fit\" || j.cameraFitMode === \"fill\"\n          ? j.cameraFitMode\n          : \"fit\",\n      calibrationUseRansac:\n        typeof j.calibrationUseRansac === \"boolean\"\n          ? j.calibrationUseRansac\n          : true,\n      autoscoreProvider: (() => {\n        let val = j.autoscoreProvider;\n        if (\n          val !== \"external-ws\" &&\n          val !== \"manual\" &&\n          val !== \"built-in\" &&\n          val !== \"built-in-v2\"\n        ) {\n          val = \"built-in\";\n        }\n        return val;\n      })(),\n      autoscoreWsUrl:\n        typeof j.autoscoreWsUrl === \"string\" ? j.autoscoreWsUrl : \"\",\n      autoCommitMode:\n        j.autoCommitMode === \"immediate\" ? \"immediate\" : \"wait-for-clear\",\n      confirmUncertainDarts:\n        typeof j.confirmUncertainDarts === \"boolean\"\n          ? j.confirmUncertainDarts\n          : false,\n      autoScoreConfidenceThreshold:\n        typeof j.autoScoreConfidenceThreshold === \"number\" &&\n        isFinite(j.autoScoreConfidenceThreshold)\n          ? Math.max(0.5, Math.min(0.99, j.autoScoreConfidenceThreshold))\n          : 0.82,\n      autoscoreDetectorMinArea:\n        typeof j.autoscoreDetectorMinArea === \"number\" &&\n        isFinite(j.autoscoreDetectorMinArea)\n          ? Math.max(5, Math.min(500, Math.round(j.autoscoreDetectorMinArea)))\n          : 30,\n      autoscoreDetectorThresh:\n        typeof j.autoscoreDetectorThresh === \"number\" &&\n        isFinite(j.autoscoreDetectorThresh)\n          ? Math.max(5, Math.min(60, Math.round(j.autoscoreDetectorThresh)))\n          : 15,\n      autoscoreDetectorRequireStableN:\n        typeof j.autoscoreDetectorRequireStableN === \"number\" &&\n        isFinite(j.autoscoreDetectorRequireStableN)\n          ? Math.max(\n              1,\n              Math.min(10, Math.round(j.autoscoreDetectorRequireStableN)),\n            )\n          : 2,\n      harshLightingMode:\n        typeof j.harshLightingMode === \"boolean\" ? j.harshLightingMode : false,\n      enhanceBigTrebles:\n        typeof j.enhanceBigTrebles === \"boolean\" ? j.enhanceBigTrebles : false,\n      allowAutocommitInOnline: !!j.allowAutocommitInOnline,\n      calibrationGuide:\n        typeof j.calibrationGuide === \"boolean\" ? j.calibrationGuide : true,\n      preferredCameraId:\n        typeof j.preferredCameraId === \"string\"\n          ? j.preferredCameraId\n          : undefined,\n      preserveCalibrationOverlay:\n        typeof j.preserveCalibrationOverlay === \"boolean\"\n          ? j.preserveCalibrationOverlay\n          : true,\n      preserveCalibrationOnCameraChange:\n        typeof j.preserveCalibrationOnCameraChange === \"boolean\"\n          ? j.preserveCalibrationOnCameraChange\n          : true,\n      preferredCameraLabel:\n        typeof j.preferredCameraLabel === \"string\"\n          ? j.preferredCameraLabel\n          : undefined,\n      preferredCameraLocked:\n        typeof j.preferredCameraLocked === \"boolean\"\n          ? j.preferredCameraLocked\n          : false,\n      cameraEnabled:\n        typeof j.cameraEnabled === \"boolean\" ? j.cameraEnabled : true,\n      hideCameraOverlay:\n        typeof j.hideCameraOverlay === \"boolean\" ? j.hideCameraOverlay : false,\n      offlineLayout: j.offlineLayout === \"classic\" ? \"classic\" : \"modern\",\n      hideInGameSidebar:\n        typeof j.hideInGameSidebar === \"boolean\" ? j.hideInGameSidebar : true,\n      hiddenSections: Array.isArray(j.hiddenSections)\n        ? j.hiddenSections.filter((v: any) => typeof v === \"string\")\n        : [],\n      textSize:\n        j.textSize === \"small\" || j.textSize === \"large\"\n          ? j.textSize\n          : \"medium\",\n      boxSize:\n        j.boxSize === \"small\" || j.boxSize === \"large\" ? j.boxSize : \"medium\",\n      statsCardMinHeight:\n        typeof j.statsCardMinHeight === \"number\" &&\n        isFinite(j.statsCardMinHeight)\n          ? Math.max(160, Math.min(520, Math.round(j.statsCardMinHeight)))\n          : 220,\n      cardPaddingBottom:\n        typeof j.cardPaddingBottom === \"number\" && isFinite(j.cardPaddingBottom)\n          ? Math.max(0, Math.min(600, Math.round(j.cardPaddingBottom)))\n          : 200,\n      matchType: j.matchType === \"doubles\" ? \"doubles\" : \"singles\",\n      teamAName: typeof j.teamAName === \"string\" ? j.teamAName : \"Team A\",\n      teamBName: typeof j.teamBName === \"string\" ? j.teamBName : \"Team B\",\n      dartTimerEnabled:\n        typeof j.dartTimerEnabled === \"boolean\" ? j.dartTimerEnabled : false,\n      dartTimerSeconds:\n        typeof j.dartTimerSeconds === \"number\" && isFinite(j.dartTimerSeconds)\n          ? Math.max(3, Math.min(60, j.dartTimerSeconds))\n          : 10,\n      x01DoubleIn: typeof j.x01DoubleIn === \"boolean\" ? j.x01DoubleIn : false,\n      cameraRecordDarts:\n        typeof j.cameraRecordDarts === \"boolean\" ? j.cameraRecordDarts : true,\n      cameraShowLabels:\n        typeof j.cameraShowLabels === \"boolean\" ? j.cameraShowLabels : false,\n    };\n  } catch {\n    return {\n      favoriteDouble: \"D16\",\n      callerEnabled: true,\n      callerVoice: \"\",\n      callerVolume: 1,\n      speakCheckoutOnly: false,\n      avgMode: \"all-time\",\n      autoStartOffline: false,\n      rememberLastOffline: true,\n      lastOffline: { mode: \"X01\", x01Start: 501, firstTo: 1, aiLevel: \"None\" },\n      reducedMotion: false,\n      compactHeader: false,\n      allowSpectate: true,\n      cameraScale: 1.0,\n      cameraAspect: \"wide\",\n      cameraFitMode: \"fit\",\n      calibrationGuide: true,\n      calibrationUseRansac: true,\n      preferredCameraId: undefined,\n      preferredCameraLabel: undefined,\n      preferredCameraLocked: false,\n      preserveCalibrationOverlay: true,\n      preserveCalibrationOnCameraChange: true,\n      cameraEnabled: true,\n      hideCameraOverlay: false,\n      offlineLayout: \"modern\",\n      hideInGameSidebar: true,\n      hiddenSections: [],\n      autoscoreProvider: \"built-in\",\n      autoscoreWsUrl: \"\",\n      autoCommitMode: \"immediate\",\n      confirmUncertainDarts: false,\n      autoScoreConfidenceThreshold: 0.82,\n      harshLightingMode: false,\n      enhanceBigTrebles: false,\n      textSize: \"medium\",\n      boxSize: \"medium\",\n      statsCardMinHeight: 220,\n      cardPaddingBottom: 200,\n      matchType: \"singles\",\n      teamAName: \"Team A\",\n      teamBName: \"Team B\",\n      dartTimerEnabled: false,\n      dartTimerSeconds: 10,\n      x01DoubleIn: false,\n    };\n  }\n}\n\nfunction save(partial: Partial<SettingsState>) {\n  try {\n    const prev = load();\n    localStorage.setItem(KEY, JSON.stringify({ ...prev, ...partial }));\n  } catch {}\n}\n\nexport const useUserSettings = create<SettingsState>((set, get) => ({\n  ...load(),\n  setFavoriteDouble: (d) => {\n    save({ favoriteDouble: d });\n    set({ favoriteDouble: d });\n  },\n  setCallerEnabled: (v) => {\n    save({ callerEnabled: v });\n    set({ callerEnabled: v });\n  },\n  setCallerVoice: (name) => {\n    save({ callerVoice: name });\n    set({ callerVoice: name });\n  },\n  setAvgMode: (mode) => {\n    save({ avgMode: mode });\n    set({ avgMode: mode });\n  },\n  setCallerVolume: (v) => {\n    const vol = Math.max(0, Math.min(1, v));\n    save({ callerVolume: vol });\n    set({ callerVolume: vol });\n  },\n  setSpeakCheckoutOnly: (v) => {\n    save({ speakCheckoutOnly: v });\n    set({ speakCheckoutOnly: v });\n  },\n  setAutoStartOffline: (v) => {\n    save({ autoStartOffline: v });\n    set({ autoStartOffline: v });\n  },\n  setRememberLastOffline: (v) => {\n    save({ rememberLastOffline: v });\n    set({ rememberLastOffline: v });\n  },\n  setLastOffline: (cfg) => {\n    const prev = load().lastOffline;\n    const next = { ...prev, ...cfg };\n    save({ lastOffline: next });\n    set({ lastOffline: next });\n  },\n  setReducedMotion: (v) => {\n    save({ reducedMotion: v });\n    set({ reducedMotion: v });\n  },\n  setCompactHeader: (v) => {\n    save({ compactHeader: v });\n    set({ compactHeader: v });\n  },\n  setAllowSpectate: (v) => {\n    save({ allowSpectate: v });\n    set({ allowSpectate: v });\n  },\n  // Temporarily suppress external camera-mode syncing (used while user is interacting with device picker)\n  ignorePreferredCameraSync: false,\n  setIgnorePreferredCameraSync: (v: boolean) => {\n    save({} as any);\n    set({ ignorePreferredCameraSync: v });\n  },\n  setCameraScale: (n) => {\n    const s = Math.max(0.5, Math.min(2.0, n));\n    save({ cameraScale: s });\n    set({ cameraScale: s });\n  },\n  setCameraAspect: (a) => {\n    const v = a === \"square\" ? \"square\" : \"wide\";\n    save({ cameraAspect: v });\n    set({ cameraAspect: v });\n  },\n  setCameraFitMode: (m) => {\n    const v = m === \"fit\" ? \"fit\" : \"fill\";\n    save({ cameraFitMode: v });\n    set({ cameraFitMode: v });\n  },\n  setAutoscoreProvider: (p) => {\n    // Force set next to p\n    const next = p;\n    // Persist\n    save({ autoscoreProvider: next });\n    set({ autoscoreProvider: next });\n  },\n  setAutoscoreWsUrl: (u) => {\n    save({ autoscoreWsUrl: u });\n    set({ autoscoreWsUrl: u });\n  },\n  setAutoCommitMode: (mode) => {\n    const v = mode === \"immediate\" ? \"immediate\" : \"wait-for-clear\";\n    save({ autoCommitMode: v });\n    set({ autoCommitMode: v });\n  },\n  setConfirmUncertainDarts: (v) => {\n    const next = !!v;\n    save({ confirmUncertainDarts: next });\n    set({ confirmUncertainDarts: next });\n  },\n  setAutoScoreConfidenceThreshold: (n) => {\n    const next =\n      typeof n === \"number\" && isFinite(n)\n        ? Math.max(0.5, Math.min(0.99, n))\n        : 0.85;\n    save({ autoScoreConfidenceThreshold: next });\n    set({ autoScoreConfidenceThreshold: next });\n  },\n  setAutoscoreDetectorMinArea: (n) => {\n    const next =\n      typeof n === \"number\" && isFinite(n)\n        ? Math.max(5, Math.min(500, Math.round(n)))\n        : 30;\n    save({ autoscoreDetectorMinArea: next } as any);\n    set({ autoscoreDetectorMinArea: next });\n  },\n  setAutoscoreDetectorThresh: (n) => {\n    const next =\n      typeof n === \"number\" && isFinite(n)\n        ? Math.max(5, Math.min(60, Math.round(n)))\n        : 15;\n    save({ autoscoreDetectorThresh: next } as any);\n    set({ autoscoreDetectorThresh: next });\n  },\n  setAutoscoreDetectorRequireStableN: (n) => {\n    const next =\n      typeof n === \"number\" && isFinite(n)\n        ? Math.max(1, Math.min(10, Math.round(n)))\n        : 2;\n    save({ autoscoreDetectorRequireStableN: next } as any);\n    set({ autoscoreDetectorRequireStableN: next });\n  },\n  setHarshLightingMode: (v) => {\n    const next = !!v;\n    save({ harshLightingMode: next } as any);\n    set({ harshLightingMode: next });\n  },\n  setEnhanceBigTrebles: (v) => {\n    const next = !!v;\n    save({ enhanceBigTrebles: next } as any);\n    set({ enhanceBigTrebles: next });\n  },\n  setAllowAutocommitInOnline: (v) => {\n    save({ allowAutocommitInOnline: v } as any);\n    set({ allowAutocommitInOnline: v });\n  },\n  setCalibrationGuide: (v) => {\n    save({ calibrationGuide: v });\n    set({ calibrationGuide: v });\n  },\n  setCalibrationUseRansac: (v) => {\n    save({ calibrationUseRansac: v } as any);\n    set({ calibrationUseRansac: v } as any);\n  },\n  setPreserveCalibrationOverlay: (v) => {\n    save({ preserveCalibrationOverlay: v } as any);\n    set({ preserveCalibrationOverlay: v });\n  },\n  setPreserveCalibrationOnCameraChange: (v) => {\n    save({ preserveCalibrationOnCameraChange: v } as any);\n    set({ preserveCalibrationOnCameraChange: !!v });\n  },\n  setPreferredCamera: (id, label, force = false) => {\n    try {\n      const state = get();\n      // Intentionally no logs here to avoid noisy console output in user flows\n      if (state.preferredCameraLocked && !force) {\n        // Locked: ignore programmatic updates unless explicitly forced by user action\n        console.log(\n          \"[USERSETTINGS] Camera selection locked and force=false, ignoring update\",\n        );\n        return;\n      }\n    } catch {}\n    // Avoid redundant writes and accidental clears when values are unchanged.\n    try {\n      const prev = get();\n      if (\n        prev.preferredCameraId === id &&\n        prev.preferredCameraLabel === label\n      ) {\n        // Nothing changed; avoid writing to storage to reduce unexpected updates\n        return;\n      }\n    } catch {}\n    // No logging on successful save to keep runtime output quiet\n    save({ preferredCameraId: id, preferredCameraLabel: label });\n    set({ preferredCameraId: id, preferredCameraLabel: label });\n  },\n  setPreferredCameraLocked: (v) => {\n    // Respect a temporary user-interaction guard which prevents automatic\n    // re-locking while the user is actively interacting with the picker.\n    try {\n      const state = get();\n      if (state.ignorePreferredCameraSync && v === true) {\n        // Ignore attempts to auto-lock while the user has signalled they're\n        // interacting with the picker. This prevents the lock \"bouncing\"\n        // back on immediately after a user unlocks and selects a new camera.\n        console.debug(\n          \"[USERSETTINGS] Ignoring auto-lock due to ignorePreferredCameraSync\",\n        );\n        return;\n      }\n    } catch {}\n    save({ preferredCameraLocked: v });\n    set({ preferredCameraLocked: v });\n  },\n  setCameraEnabled: (v) => {\n    save({ cameraEnabled: v });\n    set({ cameraEnabled: v });\n  },\n  setHideCameraOverlay: (v) => {\n    save({ hideCameraOverlay: v });\n    set({ hideCameraOverlay: v });\n  },\n  setCameraShowLabels: (v) => {\n    save({ cameraShowLabels: v } as any);\n    set({ cameraShowLabels: !!v } as any);\n  },\n  setCameraRecordDarts: (v: boolean) => {\n    const next = !!v;\n    save({ cameraRecordDarts: next } as any);\n    set({ cameraRecordDarts: next } as any);\n  },\n  setCameraLowLatency: (v: boolean) => {\n    const next = !!v;\n    save({ cameraLowLatency: next } as any);\n    set({ cameraLowLatency: next } as any);\n  },\n  setCameraProcessingFps: (n: number) => {\n    const s = Math.max(5, Math.min(30, Math.round(n)));\n    save({ cameraProcessingFps: s } as any);\n    set({ cameraProcessingFps: s } as any);\n  },\n  setOfflineLayout: (mode) => {\n    save({ offlineLayout: mode });\n    set({ offlineLayout: mode });\n  },\n  setHideInGameSidebar: (v) => {\n    save({ hideInGameSidebar: v });\n    set({ hideInGameSidebar: v });\n  },\n  setHiddenSections: (sections) => {\n    const next = Array.isArray(sections)\n      ? sections.filter((v) => typeof v === \"string\")\n      : [];\n    save({ hiddenSections: next });\n    set({ hiddenSections: next });\n  },\n  setTextSize: (size) => {\n    save({ textSize: size });\n    set({ textSize: size });\n  },\n  setBoxSize: (size) => {\n    save({ boxSize: size });\n    set({ boxSize: size });\n  },\n  setStatsCardMinHeight: (n) => {\n    const next = Math.max(160, Math.min(520, Math.round(n)));\n    save({ statsCardMinHeight: next });\n    set({ statsCardMinHeight: next });\n  },\n  setCardPaddingBottom: (n) => {\n    const next = Math.max(0, Math.min(600, Math.round(n)));\n    save({ cardPaddingBottom: next });\n    set({ cardPaddingBottom: next });\n  },\n  setMatchType: (t) => {\n    const v = t === \"doubles\" ? \"doubles\" : \"singles\";\n    save({ matchType: v });\n    set({ matchType: v });\n  },\n  setTeamAName: (name) => {\n    const v = name?.trim() || \"Team A\";\n    save({ teamAName: v });\n    set({ teamAName: v });\n  },\n  setTeamBName: (name) => {\n    const v = name?.trim() || \"Team B\";\n    save({ teamBName: v });\n    set({ teamBName: v });\n  },\n  setDartTimerEnabled: (v) => {\n    save({ dartTimerEnabled: v });\n    set({ dartTimerEnabled: v });\n  },\n  setDartTimerSeconds: (n) => {\n    const s = Math.max(3, Math.min(60, Math.round(n)));\n    save({ dartTimerSeconds: s });\n    set({ dartTimerSeconds: s });\n  },\n  setX01DoubleIn: (v) => {\n    save({ x01DoubleIn: v });\n    set({ x01DoubleIn: v });\n  },\n}));\n","/**\n * Advanced Dartboard Auto-Calibration\n *\n * Detects dartboard features automatically without markers or manual clicking:\n * 1. Detects bull (inner & outer rings) using circle detection\n * 2. Detects treble and double rings using edge/circle detection\n * 3. Computes board center and orientation\n * 4. Generates calibration points from detected rings\n * 5. Computes homography without user interaction\n */\n\nimport {\n  BoardRadii,\n  canonicalRimTargets,\n  computeHomographyDLT,\n  applyHomography,\n  sampleRing,\n  translateHomography,\n  rotateHomography,\n  scaleHomography,\n  rmsError,\n  ransacHomography,\n  type Homography,\n  type Point,\n} from \"./vision.js\";\nimport { getGlobalCalibrationConfidence } from \"./gameCalibrationRequirements.js\";\nimport { useUserSettings } from \"../store/userSettings.js\";\n\nconst isFinitePoint = (p: Point | undefined): p is Point =>\n  !!p && Number.isFinite(p.x) && Number.isFinite(p.y);\nconst isFiniteHomography = (\n  H: Homography | null | undefined,\n): H is Homography =>\n  Array.isArray(H) && H.length === 9 && H.every(Number.isFinite);\n\nexport interface BoardDetectionResult {\n  success: boolean;\n  cx: number; // Board center X in image\n  cy: number; // Board center Y in image\n  bullInner: number; // Detected inner bull radius (pixels)\n  bullOuter: number; // Detected outer bull radius (pixels)\n  trebleInner: number; // Detected treble inner radius (pixels)\n  trebleOuter: number; // Detected treble outer radius (pixels)\n  doubleInner: number; // Detected double inner radius (pixels)\n  doubleOuter: number; // Detected double outer radius (pixels)\n  confidence: number; // 0-100, quality of detection\n  homography: Homography | null;\n  errorPx: number | null;\n  calibrationPoints: Point[];\n  theta?: number; // detected orientation in radians (0 = canonical top)\n  message?: string;\n}\n\n/**\n * Detect dartboard using radial edge detection\n * Simpler, more robust approach:\n * 1. Find the center using Hough voting\n * 2. Scan radially from center to find ring boundaries (black/white transitions)\n * 3. Identify double ring (outermost playable ring) by looking for the characteristic radius\n */\nfunction findDartboardRings(\n  canvas: HTMLCanvasElement,\n  centerHint?: { x: number; y: number },\n): {\n  cx: number;\n  cy: number;\n  r: number;\n  confidence: number;\n  ringCount?: number;\n  ringStrength?: number;\n  detectedRings?: number[];\n} | null {\n  const ctx = canvas.getContext(\"2d\", { willReadFrequently: true });\n  if (!ctx) return null;\n\n  const w = canvas.width;\n  const h = canvas.height;\n\n  // 1. Downsample for Center Detection (Gradient Voting)\n  // Use a slightly higher resolution than before for better accuracy\n  const mapW = 160;\n  const scale = mapW / w;\n  const mapH = Math.floor(h * scale);\n\n  const workCanvas = new OffscreenCanvas(mapW, mapH);\n  const workCtx = workCanvas.getContext(\"2d\", { willReadFrequently: true });\n  if (!workCtx) return null;\n\n  workCtx.drawImage(canvas, 0, 0, mapW, mapH);\n  const imageData = workCtx.getImageData(0, 0, mapW, mapH);\n  const data = imageData.data;\n\n  // 2. Compute Gradients & Accumulator\n  const accumulator = new Float32Array(mapW * mapH);\n  const magThreshold = 8; // Sweet spot sensitivity (v2.1 level - was working)\n\n  // Simple Central Difference Gradients\n  for (let y = 1; y < mapH - 1; y++) {\n    for (let x = 1; x < mapW - 1; x++) {\n      const i = (y * mapW + x) * 4;\n\n      // Neighbors\n      const iL = i - 4;\n      const iR = i + 4;\n      const iU = i - mapW * 4;\n      const iD = i + mapW * 4;\n\n      // Luminance\n      const lumL =\n        data[iL] * 0.299 + data[iL + 1] * 0.587 + data[iL + 2] * 0.114;\n      const lumR =\n        data[iR] * 0.299 + data[iR + 1] * 0.587 + data[iR + 2] * 0.114;\n      const lumU =\n        data[iU] * 0.299 + data[iU + 1] * 0.587 + data[iU + 2] * 0.114;\n      const lumD =\n        data[iD] * 0.299 + data[iD + 1] * 0.587 + data[iD + 2] * 0.114;\n\n      const dx = lumR - lumL;\n      const dy = lumD - lumU;\n      const mag = Math.sqrt(dx * dx + dy * dy);\n\n      if (mag > magThreshold) {\n        // Normalize direction\n        const ux = dx / mag;\n        const uy = dy / mag;\n\n        // Vote along the gradient line (perpendicular to edge)\n        // We vote in both directions because we don't know if it's inner or outer edge of a ring\n        // Expanded range: 3% to 60% of width to handle boards at different distances\n        const minR = mapW * 0.03;\n        const maxR = mapW * 0.6;\n\n        // Optimization: Step by 1 pixel\n        for (let r = minR; r < maxR; r += 1) {\n          // Direction 1 (+ gradient)\n          const v1x = Math.round(x + ux * r);\n          const v1y = Math.round(y + uy * r);\n          if (v1x >= 0 && v1x < mapW && v1y >= 0 && v1y < mapH) {\n            accumulator[v1y * mapW + v1x]++;\n          }\n\n          // Direction 2 (- gradient)\n          const v2x = Math.round(x - ux * r);\n          const v2y = Math.round(y - uy * r);\n          if (v2x >= 0 && v2x < mapW && v2y >= 0 && v2y < mapH) {\n            accumulator[v2y * mapW + v2x]++;\n          }\n        }\n      }\n    }\n  }\n\n  // 3. Find Peak in Accumulator\n  // Apply a small blur to the accumulator to smooth noise and aggregate votes\n  const smoothedAcc = new Float32Array(mapW * mapH);\n  const blurR = 2;\n  for (let y = blurR; y < mapH - blurR; y++) {\n    for (let x = blurR; x < mapW - blurR; x++) {\n      let sum = 0;\n      for (let dy = -blurR; dy <= blurR; dy++) {\n        for (let dx = -blurR; dx <= blurR; dx++) {\n          sum += accumulator[(y + dy) * mapW + (x + dx)];\n        }\n      }\n      smoothedAcc[y * mapW + x] = sum;\n    }\n  }\n\n  let maxVotes = 0;\n  let peakX = mapW / 2;\n  let peakY = mapH / 2;\n\n  // Ignore borders - but smaller border to detect boards at edges\n  const border = 5;\n  for (let y = border; y < mapH - border; y++) {\n    for (let x = border; x < mapW - border; x++) {\n      const votes = smoothedAcc[y * mapW + x];\n      if (votes > maxVotes) {\n        maxVotes = votes;\n        peakX = x;\n        peakY = y;\n      }\n    }\n  }\n\n  // Scale peak back to full size\n  let roughCx = peakX / scale;\n  let roughCy = peakY / scale;\n  // If a center hint is provided (e.g., a one-click bull), bias the rough center toward it\n  if (\n    centerHint &&\n    Number.isFinite(centerHint.x) &&\n    Number.isFinite(centerHint.y)\n  ) {\n    // Blend 70% hint, 30% voted peak to keep robustness while honoring user hint\n    roughCx = 0.7 * centerHint.x + 0.3 * roughCx;\n    roughCy = 0.7 * centerHint.y + 0.3 * roughCy;\n  }\n\n  console.log(\n    `[findDartboardRings] Voting Peak: (${Math.round(roughCx)}, ${Math.round(roughCy)}) Votes=${maxVotes}`,\n  );\n\n  // 5. Structural Lock (Double + Treble)\n  // We use a \"Radial Gradient\" search to ignore the spider/segment wires.\n  // Segment wires have gradients perpendicular to the radius (tangential).\n  // Rings have gradients parallel to the radius (radial).\n  const scanW = 400; // Increased resolution for better wire separation\n  const scanScale = scanW / w;\n  const scanH = Math.floor(h * scanScale);\n\n  const scanCanvas = new OffscreenCanvas(scanW, scanH);\n  const scanCtx = scanCanvas.getContext(\"2d\");\n  if (!scanCtx) return null;\n\n  scanCtx.drawImage(canvas, 0, 0, scanW, scanH);\n  const scanData = scanCtx.getImageData(0, 0, scanW, scanH).data;\n\n  // NOTE: roughCxScaled/roughCyScaled were used in an earlier debug path; keep\n  // them removed to avoid unused-vars warnings.\n\n  // Pre-compute gradients for scan image\n  const scanDx = new Float32Array(scanW * scanH);\n  const scanDy = new Float32Array(scanW * scanH);\n\n  for (let y = 1; y < scanH - 1; y++) {\n    for (let x = 1; x < scanW - 1; x++) {\n      const i = (y * scanW + x) * 4;\n\n      // Luminance\n      const _lum =\n        scanData[i] * 0.299 + scanData[i + 1] * 0.587 + scanData[i + 2] * 0.114;\n\n      // Neighbors\n      const iL = i - 4;\n      const iR = i + 4;\n      const iU = i - scanW * 4;\n      const iD = i + scanW * 4;\n\n      const lumL =\n        scanData[iL] * 0.299 +\n        scanData[iL + 1] * 0.587 +\n        scanData[iL + 2] * 0.114;\n      const lumR =\n        scanData[iR] * 0.299 +\n        scanData[iR + 1] * 0.587 +\n        scanData[iR + 2] * 0.114;\n      const lumU =\n        scanData[iU] * 0.299 +\n        scanData[iU + 1] * 0.587 +\n        scanData[iU + 2] * 0.114;\n      const lumD =\n        scanData[iD] * 0.299 +\n        scanData[iD + 1] * 0.587 +\n        scanData[iD + 2] * 0.114;\n\n      // Central Difference\n      const dx = lumR - lumL;\n      const dy = lumD - lumU;\n\n      scanDx[y * scanW + x] = dx;\n      scanDy[y * scanW + x] = dy;\n    }\n  }\n\n  // 4. Radial scan from center to find rings\n  // The double ring has a characteristic width (~8mm = ~8-12 pixels in typical images)\n  // and should be the outermost ring with strong radial gradients\n  const fullData = ctx.getImageData(0, 0, w, h).data;\n\n  const lum = (x: number, y: number) => {\n    const ix = Math.max(0, Math.min(w - 1, Math.round(x)));\n    const iy = Math.max(0, Math.min(h - 1, Math.round(y)));\n    const idx = (iy * w + ix) * 4;\n    return (\n      0.299 * fullData[idx] +\n      0.587 * fullData[idx + 1] +\n      0.114 * fullData[idx + 2]\n    );\n  };\n\n  // Scan radially at many angles to find ALL ring boundaries\n  // We need to detect: bullInner, bullOuter, trebleInner, trebleOuter, doubleInner, doubleOuter\n  const angleCount = 60;\n  const radiiByRing: { [key: number]: number[] } = {}; // Store radii at each angle\n\n  for (let a = 0; a < angleCount; a++) {\n    const angle = (a / angleCount) * Math.PI * 2;\n    const cos = Math.cos(angle);\n    const sin = Math.sin(angle);\n\n    // Scan from center outward and find ALL local maxima (all ring boundaries)\n    const gradients: { r: number; grad: number }[] = [];\n\n    for (let r = 30; r < Math.min(w, h) / 2; r += 1) {\n      // Probe point (kept implicit via inner/outer sampling below)\n      const xInner = roughCx + (r - 2) * cos;\n      const yInner = roughCy + (r - 2) * sin;\n      const xOuter = roughCx + (r + 2) * cos;\n      const yOuter = roughCy + (r + 2) * sin;\n\n      const lumInner = lum(xInner, yInner);\n      const lumOuter = lum(xOuter, yOuter);\n\n      // Radial gradient: larger = stronger boundary\n      const grad = Math.abs(lumOuter - lumInner);\n\n      // SWEET SPOT: balanced threshold (v2.1 level)\n      if (grad > 2 && r > 20) {\n        // Good balance - not too strict, not too lenient\n        gradients.push({ r, grad });\n      }\n    }\n\n    // Find local maxima in gradients (these are ring boundaries)\n    const peaks: number[] = [];\n    for (let i = 0; i < gradients.length; i++) {\n      const prev = i > 0 ? gradients[i - 1].grad : 0;\n      const curr = gradients[i].grad;\n      const next = i < gradients.length - 1 ? gradients[i + 1].grad : 0;\n\n      // SWEET SPOT: balanced peak detection\n      if (curr > prev && curr > next && curr > 2) {\n        // Good balance point\n        peaks.push(gradients[i].r);\n      }\n    }\n\n    // Store all peaks for this angle\n    // Instead of using index, group peaks that are close together\n    // (close peaks = same ring, different angles)\n    if (peaks.length > 0) {\n      peaks.forEach((r) => {\n        // Find the closest existing ring tier\n        const ringKey = Object.keys(radiiByRing)\n          .map((k) => ({\n            key: parseInt(k),\n            median:\n              radiiByRing[parseInt(k)][\n                Math.floor(radiiByRing[parseInt(k)].length / 2)\n              ],\n          }))\n          .filter((entry) => Math.abs(entry.median - r) < 15) // Within 15 pixels = same ring\n          .sort((a, b) => Math.abs(a.median - r) - Math.abs(b.median - r))[0];\n\n        const tierIndex = ringKey\n          ? ringKey.key\n          : Math.max(-1, ...Object.keys(radiiByRing).map((k) => parseInt(k))) +\n            1;\n        if (!radiiByRing[tierIndex]) radiiByRing[tierIndex] = [];\n        radiiByRing[tierIndex].push(r);\n      });\n    }\n  }\n\n  // Extract the median radius for each ring tier\n  const ringRadii = Object.keys(radiiByRing)\n    .map((key) => {\n      const radii = radiiByRing[parseInt(key)].sort((a, b) => a - b);\n      const median = radii[Math.floor(radii.length / 2)];\n      return { tier: parseInt(key), radius: median, samples: radii.length };\n    })\n    .sort((a, b) => a.radius - b.radius);\n\n  console.log(`[findDartboardRings] Detected ring tiers:`, ringRadii);\n\n  // v2.6: Robust ring selection to ignore light rings/surrounds\n  // The double ring (inner/outer) are very close together (162 vs 170, ratio 1.05)\n  // If the outermost ring is much further out than the one before it, it's likely a light ring.\n  const filteredRings = [...ringRadii];\n  if (filteredRings.length >= 2) {\n    const last = filteredRings[filteredRings.length - 1].radius;\n    const secondLast = filteredRings[filteredRings.length - 2].radius;\n    const ratio = last / secondLast;\n\n    // If ratio > 1.15 and we have enough rings to suggest the second-last is the double,\n    // or if the ratio is extremely large (> 1.3), ignore the outermost ring.\n    if ((ratio > 1.15 && filteredRings.length >= 5) || ratio > 1.3) {\n      console.log(\n        `[findDartboardRings] Ignoring outermost ring (likely light ring/surround): ${last.toFixed(\n          1,\n        )}px (ratio ${ratio.toFixed(2)} to ${secondLast.toFixed(1)}px)`,\n      );\n      filteredRings.pop();\n    }\n  }\n\n  // The outermost ring of the FILTERED set should be the double outer\n  const doubleOuterRadius =\n    filteredRings.length > 0\n      ? filteredRings[filteredRings.length - 1].radius\n      : Math.min(w, h) * 0.3;\n\n  // v2.4: Boost detection confidence based on ring completeness\n  // All 7 rings detected = near-perfect setup (98%)\n  // 6+ rings = excellent (96%)\n  // 5 rings = good (94%)\n  // fewer = lower confidence\n  let detectionConfidence = 50 + filteredRings.length * 6; // Base: 50-92% for 0-7 rings\n  if (filteredRings.length >= 7) {\n    detectionConfidence = 98; // All rings perfect\n  } else if (filteredRings.length === 6) {\n    detectionConfidence = 96;\n  } else if (filteredRings.length === 5) {\n    detectionConfidence = 94;\n  }\n\n  return {\n    cx: roughCx,\n    cy: roughCy,\n    r: doubleOuterRadius,\n    confidence: detectionConfidence,\n    ringCount: filteredRings.length,\n    ringStrength:\n      filteredRings.length > 0\n        ? filteredRings[filteredRings.length - 1].radius\n        : 0,\n    detectedRings: filteredRings.map((r) => r.radius),\n  };\n}\n\n/**\n * Compute board orientation by analyzing radial gradients at the treble ring.\n * Returns the rotation angle (radians) that maps canonical sector centers to image angles.\n */\nfunction computeBoardOrientation(\n  canvas: HTMLCanvasElement,\n  cx: number,\n  cy: number,\n  radius: number,\n): number | null {\n  const ctx = canvas.getContext(\"2d\");\n  if (!ctx) return null;\n  const w = canvas.width;\n  const h = canvas.height;\n  const sampleCount = 720; // high angular resolution\n  const sampleRadius = radius; // use the outer radius (double outer) or treble\n  const gradSamples: number[] = new Array(sampleCount).fill(0);\n  // compute luminance radial derivative across a small radial band\n  const rInner = Math.max(2, Math.round(sampleRadius - 8));\n  const rOuter = Math.round(sampleRadius + 8);\n  const imageData = ctx.getImageData(0, 0, w, h).data;\n  const lum = (x: number, y: number) => {\n    const ix = Math.round(x);\n    const iy = Math.round(y);\n    if (ix < 0 || ix >= w || iy < 0 || iy >= h) return 127;\n    const idx = (iy * w + ix) * 4;\n    return (\n      imageData[idx] * 0.299 +\n      imageData[idx + 1] * 0.587 +\n      imageData[idx + 2] * 0.114\n    );\n  };\n  for (let i = 0; i < sampleCount; i++) {\n    const a = (i / sampleCount) * Math.PI * 2;\n    // sample radial line and compute max gradient magnitude along it\n    let maxGrad = 0;\n    let prev = lum(cx + rInner * Math.cos(a), cy + rInner * Math.sin(a));\n    for (let r = rInner + 1; r <= rOuter; r++) {\n      const cur = lum(cx + r * Math.cos(a), cy + r * Math.sin(a));\n      const g = Math.abs(cur - prev);\n      if (g > maxGrad) maxGrad = g;\n      prev = cur;\n    }\n    gradSamples[i] = maxGrad;\n  }\n  // Find local maxima which correspond to boundaries; threshold somewhat high\n  const peaks: number[] = [];\n  for (let i = 0; i < sampleCount; i++) {\n    const prev = gradSamples[(i - 1 + sampleCount) % sampleCount];\n    const cur = gradSamples[i];\n    const next = gradSamples[(i + 1) % sampleCount];\n    if (cur > prev && cur > next && cur > 10) peaks.push(i);\n  }\n  if (peaks.length < 16) {\n    // fallback: smooth and find broad maxima\n    const smoothed = gradSamples.map((v, idx) => {\n      let s = 0;\n      let k = 0;\n      for (let d = -2; d <= 2; d++) {\n        s += gradSamples[(idx + d + sampleCount) % sampleCount];\n        k++;\n      }\n      return s / k;\n    });\n    for (let i = 0; i < sampleCount; i++) {\n      const prev = smoothed[(i - 1 + sampleCount) % sampleCount];\n      const cur = smoothed[i];\n      const next = smoothed[(i + 1) % sampleCount];\n      if (cur > prev && cur > next && cur > 8) peaks.push(i);\n    }\n  }\n  if (peaks.length === 0) return 0;\n  // Convert peak indices to angles\n  const peakAngles = peaks.map((p) => (p / sampleCount) * Math.PI * 2);\n  // We expect wires at roughly 20 positions; convert to sector centers (midpoint between successive peaks)\n  peakAngles.sort((a, b) => a - b);\n  const sectorCenters: number[] = [];\n  for (let i = 0; i < peakAngles.length; i++) {\n    const a1 = peakAngles[i];\n    const a2 = peakAngles[(i + 1) % peakAngles.length];\n    // handle wrap\n    const diff = (a2 - a1 + Math.PI * 2) % (Math.PI * 2);\n    sectorCenters.push((a1 + diff / 2) % (Math.PI * 2));\n  }\n  // Now we need to map these detected sector centers to canonical sector angles\n  const sectorCount = 20;\n  const canonicalAngles = new Array(sectorCount)\n    .fill(0)\n    .map((_, i) => -Math.PI / 2 + i * ((Math.PI * 2) / sectorCount));\n  // Find rotation offset that best aligns detected centers to canonical centers using circular shifting\n  // We'll attempt shifts so that sectorCenters[0] maps to canonicalAngles[s] and choose best fit\n  let bestRot = 0;\n  let bestErr = Infinity;\n  for (let shift = 0; shift < sectorCenters.length; shift++) {\n    // Build map for first N up to 20 sectors\n    let err = 0;\n    for (let k = 0; k < Math.min(sectorCount, sectorCenters.length); k++) {\n      const detectedAngle = sectorCenters[(k + shift) % sectorCenters.length];\n      const canonicalAngle = canonicalAngles[k];\n      const d = Math.abs(\n        ((detectedAngle - canonicalAngle + Math.PI) % (Math.PI * 2)) - Math.PI,\n      );\n      err += d * d;\n    }\n    if (err < bestErr) {\n      bestErr = err;\n      bestRot =\n        (sectorCenters[shift] - canonicalAngles[0] + Math.PI * 2) %\n        (Math.PI * 2);\n    }\n  }\n  // Convert bestRot to [-pi,pi]\n  const theta = ((bestRot + Math.PI) % (Math.PI * 2)) - Math.PI;\n  return theta;\n}\n\n// Refine an existing homography by making tiny adjustments (rotation, scale, translation)\n// to maximize radial gradient energy along the treble and double outer rings.\nfunction refineHomographyByRings(\n  canvas: HTMLCanvasElement,\n  H: Homography,\n): Homography {\n  const ctx = canvas.getContext(\"2d\");\n  if (!ctx) return H;\n  const w = canvas.width,\n    h = canvas.height;\n  const id = ctx.getImageData(0, 0, w, h);\n  const data = id.data;\n\n  // Helper: luminance and gradient at (x,y)\n  const lum = (x: number, y: number) => {\n    const ix = Math.max(0, Math.min(w - 1, Math.round(x)));\n    const iy = Math.max(0, Math.min(h - 1, Math.round(y)));\n    const idx = (iy * w + ix) * 4;\n    return 0.299 * data[idx] + 0.587 * data[idx + 1] + 0.114 * data[idx + 2];\n  };\n  const grad = (x: number, y: number) => {\n    const gx = lum(x + 1, y) - lum(x - 1, y);\n    const gy = lum(x, y + 1) - lum(x, y - 1);\n    return { gx, gy };\n  };\n\n  // Board center in image for computing radial normals\n  const cImg = applyHomography(H, { x: 0, y: 0 });\n\n  // Scoring function: sum of radial gradient magnitude along rings\n  const ringScore = (Htest: Homography) => {\n    const rings = [BoardRadii.trebleOuter, BoardRadii.doubleOuter];\n    let score = 0;\n    for (const r of rings) {\n      const pts = sampleRing(Htest, r, 180);\n      for (let i = 0; i < pts.length; i++) {\n        const p = pts[i];\n        const g = grad(p.x, p.y);\n        // radial direction from image center point (mapped board origin)\n        const nx = p.x - cImg.x;\n        const ny = p.y - cImg.y;\n        const nlen = Math.hypot(nx, ny) || 1;\n        const ux = nx / nlen,\n          uy = ny / nlen;\n        score += Math.abs(g.gx * ux + g.gy * uy);\n      }\n    }\n    return score / 180 / 2; // normalized average per ring\n  };\n\n  let bestH = H;\n  let bestScore = ringScore(H);\n\n  // Small local search: rotation (±4°), image translation (±3px), isotropic image scale (±2%)\n  const toRad = (deg: number) => (deg * Math.PI) / 180;\n  const rotSteps = [-4, -2, -1, -0.5, 0, 0.5, 1, 2, 4];\n  const txSteps = [-3, -2, -1, 0, 1, 2, 3];\n  const scaleSteps = [0.98, 0.99, 1.0, 1.01, 1.02];\n\n  for (const rot of rotSteps) {\n    const Hr = rotateHomography(H, toRad(rot));\n    for (const tx of txSteps) {\n      for (const ty of txSteps) {\n        const Ht = translateHomography(Hr, tx, ty);\n        for (const s of scaleSteps) {\n          const Hs = scaleHomography(Ht, s, s);\n          const sc = ringScore(Hs);\n          if (sc > bestScore) {\n            bestScore = sc;\n            bestH = Hs;\n          }\n        }\n      }\n    }\n  }\n  return bestH;\n}\n\n/**\n * Main board detection function\n * Uses direct ring detection approach\n */\nexport function detectBoard(\n  canvas: HTMLCanvasElement,\n  opts?: { centerHint?: Point; colorAssist?: boolean },\n): BoardDetectionResult {\n  try {\n    const w = canvas.width;\n    const h = canvas.height;\n    const centerX = w / 2;\n    const centerY = h / 2;\n\n    // Optional: pre-filter image to only keep red and green hues (helps isolate double/treble bands)\n    let srcCanvas: HTMLCanvasElement | OffscreenCanvas = canvas as any;\n    // Optional color assist pre-filter (helps isolate double/treble bands)\n    if (opts?.colorAssist) {\n      try {\n        const makeCanvas = (w: number, h: number) => {\n          try {\n            return new OffscreenCanvas(w, h);\n          } catch {\n            const c = document.createElement(\"canvas\");\n            c.width = w;\n            c.height = h;\n            return c;\n          }\n        };\n        const oc = makeCanvas(w, h);\n        const octx = oc.getContext(\"2d\") as CanvasRenderingContext2D | null;\n        if (!octx) throw new Error(\"Could not get 2D context\");\n        (octx as CanvasRenderingContext2D).drawImage(canvas, 0, 0, w, h);\n        const id = (octx as CanvasRenderingContext2D).getImageData(0, 0, w, h);\n        const data = id.data;\n        // RGB -> HSV helper (fast approximation)\n        const rgb2hsv = (r: number, g: number, b: number) => {\n          const rn = r / 255,\n            gn = g / 255,\n            bn = b / 255;\n          const max = Math.max(rn, gn, bn),\n            min = Math.min(rn, gn, bn);\n          const d = max - min;\n          let h = 0;\n          if (d !== 0) {\n            if (max === rn) h = ((gn - bn) / d) % 6;\n            else if (max === gn) h = (bn - rn) / d + 2;\n            else h = (rn - gn) / d + 4;\n            h *= 60;\n            if (h < 0) h += 360;\n          }\n          const s = max === 0 ? 0 : d / max;\n          const v = max;\n          return { h, s, v };\n        };\n        for (let i = 0; i < data.length; i += 4) {\n          const r = data[i],\n            g = data[i + 1],\n            b = data[i + 2];\n          const { h: hh, s, v } = rgb2hsv(r, g, b);\n          // Keep saturated reds and greens; zero out everything else\n          const isRed =\n            s > 0.25 &&\n            v > 0.2 &&\n            (hh < 20 || hh > 340 || (hh > 340 && hh <= 360));\n          const isGreen = s > 0.25 && v > 0.2 && hh >= 80 && hh <= 160;\n          if (!(isRed || isGreen)) {\n            data[i] = data[i + 1] = data[i + 2] = 0; // black\n          } else {\n            // boost\n            data[i] = Math.min(255, r * 1.2);\n            data[i + 1] = Math.min(255, g * 1.2);\n            data[i + 2] = Math.min(255, b * 1.2);\n          }\n        }\n        (octx as CanvasRenderingContext2D).putImageData(id, 0, 0);\n        srcCanvas = oc;\n      } catch (e) {\n        // fall back silently\n        srcCanvas = canvas as any;\n      }\n    }\n\n    // Find dartboard rings\n    const detection = findDartboardRings(srcCanvas as any, opts?.centerHint);\n\n    if (!detection) {\n      return {\n        success: false,\n        cx: centerX,\n        cy: centerY,\n        bullInner: 0,\n        bullOuter: 0,\n        trebleInner: 0,\n        trebleOuter: 0,\n        doubleInner: 0,\n        doubleOuter: 0,\n        confidence: 0,\n        homography: null,\n        errorPx: null,\n        calibrationPoints: [],\n        message:\n          \"No dartboard detected. Ensure board is clearly visible with good contrast between rings and background.\",\n      };\n    }\n\n    // Use DETECTED ring positions directly - these are the actual black rings on YOUR dartboard!\n    // If we detected all 6 rings, use them. Otherwise fall back to scaling.\n    const detected = (() => {\n      const rings = detection.detectedRings || [];\n      if (rings.length >= 6) {\n        // We detected all rings: use them directly\n        return {\n          cx: detection.cx,\n          cy: detection.cy,\n          bullInner: rings[0],\n          bullOuter: rings[1],\n          trebleInner: rings[2],\n          trebleOuter: rings[3],\n          doubleInner: rings[4],\n          doubleOuter: rings[5],\n        };\n      } else {\n        // Fallback: scale based on detected double outer\n        const scale = detection.r / BoardRadii.doubleOuter;\n        return {\n          cx: detection.cx,\n          cy: detection.cy,\n          bullInner: BoardRadii.bullInner * scale,\n          bullOuter: BoardRadii.bullOuter * scale,\n          trebleInner: BoardRadii.trebleInner * scale,\n          trebleOuter: BoardRadii.trebleOuter * scale,\n          doubleInner: BoardRadii.doubleInner * scale,\n          doubleOuter: detection.r,\n        };\n      }\n    })();\n\n    // NEW: Detect board orientation (theta) using the treble ring\n    // This is much more robust than looking for peaks in the double ring\n    const theta =\n      computeBoardOrientation(\n        canvas,\n        detected.cx,\n        detected.cy,\n        detected.doubleOuter,\n      ) || 0;\n\n    // Generate 5 calibration points from detected rings (TOP, RIGHT, BOTTOM, LEFT, BULL)\n    // We use the detected theta to rotate the canonical targets\n    const canonicalSrc = canonicalRimTargets(\"outer\");\n    const calibrationPoints: Point[] = canonicalSrc.map((p) => {\n      if (p.x === 0 && p.y === 0) return { x: detected.cx, y: detected.cy };\n\n      // Rotate canonical point by theta\n      const cos = Math.cos(theta);\n      const sin = Math.sin(theta);\n\n      // Canonical points are in mm, we need to scale them to pixels\n      const scale = detected.doubleOuter / BoardRadii.doubleOuter;\n      const px = p.x * scale;\n      const py = p.y * scale;\n\n      // Rotate and translate to detected center\n      return {\n        x: detected.cx + (px * cos - py * sin),\n        y: detected.cy + (px * sin + py * cos),\n      };\n    });\n\n    let homography: Homography | null = null;\n    let errorPx: number | null = null;\n    let confidence = detection.confidence;\n    let inlierRatio = 1.0;\n\n    try {\n      // Respect user setting for RANSAC usage (when available)\n      let useRansac = true;\n      try {\n        const s = useUserSettings.getState?.();\n        useRansac = !!s?.calibrationUseRansac;\n      } catch (e) {}\n\n      if (useRansac) {\n        const ransac = ransacHomography(canonicalSrc, calibrationPoints, {\n          thresholdPx: 8,\n          maxIter: 300,\n        });\n        if (ransac.H) {\n          homography = ransac.H;\n          errorPx = ransac.errorPx;\n          const inlierCount = ransac.inliers.filter(Boolean).length;\n          inlierRatio = inlierCount / calibrationPoints.length;\n          confidence = Math.max(\n            confidence,\n            Math.round(confidence * 0.6 + inlierRatio * 40),\n          );\n        } else {\n          homography = computeHomographyDLT(canonicalSrc, calibrationPoints);\n          errorPx = rmsError(homography, canonicalSrc, calibrationPoints);\n        }\n      } else {\n        homography = computeHomographyDLT(canonicalSrc, calibrationPoints);\n        errorPx = rmsError(homography, canonicalSrc, calibrationPoints);\n      }\n\n      // NEW: Refine homography by maximizing radial gradient energy along rings\n      if (homography) {\n        homography = refineHomographyByRings(canvas, homography);\n        errorPx = rmsError(homography, canonicalSrc, calibrationPoints);\n      }\n\n      // Re-center the homography so board center maps exactly to detected bull.\n      // This keeps bull scoring tight even when ring refinement introduces a\n      // tiny translation drift.\n      if (homography) {\n        const centerImg = applyHomography(homography, { x: 0, y: 0 });\n        const dx = detected.cx - centerImg.x;\n        const dy = detected.cy - centerImg.y;\n        if (Math.hypot(dx, dy) > 0.25) {\n          homography = translateHomography(homography, dx, dy);\n          errorPx = rmsError(homography, canonicalSrc, calibrationPoints);\n        }\n      }\n\n      // Truth-based confidence: keep all calibration confidence values on the same\n      // scale used throughout the app (errorPx -> 0-100 mapping).\n      // This avoids having multiple competing confidence formulas.\n      const errPx = typeof errorPx === \"number\" ? errorPx : null;\n      const global = getGlobalCalibrationConfidence(errPx);\n      if (typeof global === \"number\") {\n        confidence = global;\n      } else {\n        // If error is unavailable, fall back to detection quality and inlier ratio.\n        confidence = Math.max(inlierRatio * 100, detection.confidence);\n      }\n    } catch (err) {\n      // Even if error in computation, if we have points, still fairly confident\n      confidence = Math.max(65, detection.confidence);\n    }\n\n    const pointsValid = calibrationPoints.every(isFinitePoint);\n    const homographyValid = isFiniteHomography(homography);\n    // More lenient success criteria: if homography computed, consider it success\n    const success = !!homographyValid && pointsValid && confidence > 50;\n    const detRingCount = detection.ringCount ?? 0;\n\n    const result = {\n      success,\n      cx: detected.cx,\n      cy: detected.cy,\n      bullInner: detected.bullInner,\n      bullOuter: detected.bullOuter,\n      trebleInner: detected.trebleInner,\n      trebleOuter: detected.trebleOuter,\n      doubleInner: detected.doubleInner,\n      doubleOuter: detected.doubleOuter,\n      confidence: Math.round(confidence), // Use calculated confidence directly (already has 85% floor)\n      homography: homographyValid ? homography : null,\n      errorPx: homographyValid ? errorPx : null,\n      calibrationPoints: pointsValid ? calibrationPoints : [],\n      theta: typeof theta === \"number\" ? theta : undefined,\n      message:\n        !pointsValid || !homographyValid\n          ? `❌ Detection produced unstable calibration data. Adjust camera framing or calibrate manually. (rings: ${detRingCount}, r:${Math.round(detection.r)})`\n          : confidence > 85\n            ? `✅ Excellent detection (rings: ${detRingCount}, r:${Math.round(detection.r)})`\n            : `✅ Board detected - may need angle adjustment (rings: ${detRingCount}, r:${Math.round(detection.r)})`,\n    };\n\n    console.log(\n      \"[detectBoard] Final result:\",\n      {\n        success: result.success,\n        confidence: result.confidence,\n        homographyValid,\n        pointsValid,\n        cx: Math.round(result.cx),\n        cy: Math.round(result.cy),\n        doubleOuter: Math.round(result.doubleOuter),\n        rings: detRingCount,\n        errorPx: result.errorPx ? result.errorPx.toFixed(2) : null,\n        calibrationPoints: calibrationPoints.map((p) => ({\n          x: Math.round(p.x),\n          y: Math.round(p.y),\n        })),\n      },\n      result.message,\n    );\n\n    return result;\n  } catch (err) {\n    return {\n      success: false,\n      cx: canvas.width / 2,\n      cy: canvas.height / 2,\n      bullInner: 0,\n      bullOuter: 0,\n      trebleInner: 0,\n      trebleOuter: 0,\n      doubleInner: 0,\n      doubleOuter: 0,\n      confidence: 0,\n      homography: null,\n      errorPx: null,\n      calibrationPoints: [],\n      message: err instanceof Error ? err.message : \"Board detection failed\",\n    };\n  }\n}\n\n/**\n * Refine detection by looking for concentric rings\n * This helps match detected circles to specific board rings\n */\nexport function refineRingDetection(\n  detected: BoardDetectionResult,\n): BoardDetectionResult {\n  // v2.4: Don't reduce confidence based on ring ratios\n  // The v2.4 confidence calculation already accounts for detection quality\n  // Ratios being off just means different dartboard size/setup - not a quality issue\n  // The homography calculation handles the actual ring positions\n  return detected;\n}\n","import { detectBoard, refineRingDetection } from \"../utils/boardDetection.js\";\n\ntype DetectMessage = {\n  type: \"detect\";\n  bitmap: ImageBitmap;\n};\n\ntype WorkerMessage = DetectMessage;\n\nconst ctx2d = (canvas: OffscreenCanvas) => {\n  const ctx = canvas.getContext(\"2d\", { willReadFrequently: true });\n  if (!ctx) throw new Error(\"Unable to get 2D context for detection\");\n  return ctx;\n};\n\nself.addEventListener(\"message\", (event: MessageEvent<WorkerMessage>) => {\n  const data = event.data;\n  if (!data || data.type !== \"detect\") return;\n  const { bitmap } = data;\n  try {\n    const canvas = new OffscreenCanvas(bitmap.width, bitmap.height);\n    const ctx = ctx2d(canvas);\n    ctx.drawImage(bitmap, 0, 0, bitmap.width, bitmap.height);\n    const detection = detectBoard(canvas as unknown as HTMLCanvasElement);\n    const refined = detection ? refineRingDetection(detection) : detection;\n    (self as DedicatedWorkerGlobalScope).postMessage({\n      type: \"result\",\n      detection: refined ?? detection,\n    });\n  } catch (err) {\n    const message = err instanceof Error ? err.message : String(err);\n    (self as DedicatedWorkerGlobalScope).postMessage({ error: message });\n  } finally {\n    try {\n      bitmap.close?.();\n    } catch {}\n  }\n});\n"],"names":["BoardRadii","SectorOrder","matMul3","a","b","r","i","j","k","applyHomography","H","p","x","y","w","nx","ny","scaleHomography","sx","sy","rotateHomography","angleRadians","cos","sin","R","translateHomography","tx","ty","computeHomographyDLT","src","dst","A","B","X","Y","h","solveLeastSquares","m","AtA","Atb","gaussianSolve","M","v","n","row","maxRow","tmp","f","c","s","canonicalRimTargets","mode","radius","rimPoints","sector","angle","sampleRing","steps","pts","theta","rmsError","e2","dx","dy","ransacHomography","opts","threshold","maxIter","minInliers","rng","bestH","bestInliers","bestCount","bestError","iter","idxs","chosen","ssub","dsub","Htry","inliers","count","sIn","dIn","Hrefined","err","sFin","dFin","finalError","getGlobalCalibrationConfidence","errorPx","percentage","clamped","createStoreImpl","createState","state","listeners","setState","partial","replace","nextState","previousState","listener","getState","api","initialState","__vite_import_meta_env__","createStore","l","q","t","u","z","C","D","E","e","F","G","I","J","K","L","d","g","N","O","escape","P","Q","S","T","V","W","react_production_min","reactModule","require$$0","React","is","objectIs","useState","useEffect","useLayoutEffect","useDebugValue","useSyncExternalStore$2","subscribe","getSnapshot","value","_useState","inst","forceUpdate","checkIfSnapshotChanged","latestGetSnapshot","nextValue","useSyncExternalStore$1","shim","useSyncExternalStoreShim_production","shimModule","require$$1","useSyncExternalStore","useRef","useMemo","withSelector_production","getServerSnapshot","selector","isEqual","instRef","memoizedSelector","nextSnapshot","hasMemo","memoizedSnapshot","currentSelection","memoizedSelection","nextSelection","maybeGetServerSnapshot","withSelectorModule","ReactExports","useSyncExternalStoreWithSelector","useSyncExternalStoreExports","didWarnAboutEqualityFn","identity","arg","useStore","equalityFn","slice","createImpl","useBoundStore","create","KEY","load","raw","migrated","val","save","prev","useUserSettings","set","get","name","vol","cfg","next","id","label","force","sections","size","isFinitePoint","isFiniteHomography","findDartboardRings","canvas","centerHint","ctx","mapW","scale","mapH","workCtx","data","accumulator","magThreshold","iL","iR","iU","iD","lumL","lumR","lumU","lumD","mag","ux","uy","minR","maxR","v1x","v1y","v2x","v2y","smoothedAcc","blurR","sum","maxVotes","peakX","peakY","border","votes","roughCx","roughCy","scanW","scanScale","scanH","scanCtx","scanData","scanDx","scanDy","fullData","lum","ix","idx","angleCount","radiiByRing","gradients","xInner","yInner","xOuter","yOuter","lumInner","lumOuter","grad","peaks","curr","ringKey","entry","tierIndex","ringRadii","key","radii","median","filteredRings","last","secondLast","ratio","doubleOuterRadius","detectionConfidence","computeBoardOrientation","cx","cy","sampleCount","sampleRadius","gradSamples","rInner","rOuter","imageData","iy","maxGrad","cur","smoothed","peakAngles","sectorCenters","a1","diff","sectorCount","canonicalAngles","_","bestRot","bestErr","shift","detectedAngle","canonicalAngle","refineHomographyByRings","gx","gy","cImg","ringScore","Htest","rings","score","nlen","bestScore","toRad","deg","rotSteps","txSteps","scaleSteps","rot","Hr","Ht","Hs","sc","detectBoard","centerX","centerY","srcCanvas","detection","detected","canonicalSrc","calibrationPoints","px","py","homography","confidence","inlierRatio","useRansac","ransac","centerImg","global","pointsValid","homographyValid","success","detRingCount","result","refineRingDetection","ctx2d","event","bitmap","refined","message"],"mappings":"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","x_google_ignoreList":[2,3,4,5,6,7,8,9]}