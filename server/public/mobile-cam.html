<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NDN Mobile Camera</title>
  <style>
    html, body { margin: 0; padding: 0; background: #0b1020; color: white; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    .container { max-width: 720px; margin: 0 auto; padding: 16px; }
    .card { background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.12); border-radius: 16px; padding: 16px; }
    .row { display: flex; gap: 8px; align-items: center; }
    .muted { color: #cbd5e1; opacity: 0.8; font-size: 12px; }
    video { width: 100%; height: auto; background: black; border-radius: 12px; }
    input, button { font-size: 16px; padding: 10px 12px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.06); color: white; }
    button { background: #4f46e5; border-color: #4f46e5; cursor: pointer; }
    button.secondary { background: rgba(255,255,255,0.08); border-color: rgba(255,255,255,0.24); }
    .error { color: #fecaca; font-weight: 600; }
  </style>
</head>
<body>
  <div class="container">
    <h2>ðŸ“· NDN Mobile Camera</h2>
    <div class="card">
      <div class="row" style="margin-bottom:8px;">
        <label>Pair code</label>
        <input id="code" placeholder="ABCD" maxlength="8" />
        <button id="join">Join</button>
      </div>
      <div class="muted" style="margin-bottom:12px;">Tip: If camera doesnâ€™t start, allow camera permission and retry the Join button.</div>
      <video id="v" playsinline autoplay muted></video>
      <div class="row" style="margin-top:8px;">
        <button id="swap" class="secondary">Switch camera</button>
        <button id="stop" class="secondary">Stop</button>
      </div>
      <div id="msg" class="muted" style="margin-top:8px;"></div>
    </div>
  </div>
  <script>
    const params = new URLSearchParams(location.search)
    const input = document.getElementById('code')
    const joinBtn = document.getElementById('join')
    const swapBtn = document.getElementById('swap')
    const stopBtn = document.getElementById('stop')
    const v = document.getElementById('v')
    const msg = document.getElementById('msg')

    input.value = (params.get('code') || '').toUpperCase().slice(0, 8)

    let stream = null
    let pc = null
    let ws = null
    let lastFacing = 'environment'

    function wsUrl() {
      // Prefer same-origin ws path
      const proto = location.protocol === 'https:' ? 'wss' : 'ws'
      let base = `${proto}://${location.host}/ws`
      return base
    }

    function log(t) { msg.textContent = t }

    async function startCam(facing) {
      if (stream) { try { stream.getTracks().forEach(t => t.stop()) } catch {} }
      try {
        console.log('Requesting camera with facing:', facing)
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: facing || 'environment' }, audio: false })
        console.log('Camera stream obtained:', stream)
        v.srcObject = stream
        await v.play().catch((e) => console.error('Video play failed:', e))
        log('Camera started')
      } catch (err) {
        log('Camera error: ' + err.message)
        console.error('Camera error:', err)
        // Try fallback to user facing if environment failed
        if (facing === 'environment' && err.name === 'NotFoundError') {
          console.log('Trying user facing camera as fallback')
          await startCam('user')
        }
      }
    }

    function ensureWS() {
      const u = wsUrl()
      ws = new WebSocket(u)
      return new Promise((resolve) => {
        ws.onopen = () => resolve(ws)
        ws.onclose = () => log('Connection closed')
        ws.onerror = () => log('WebSocket error')
      })
    }

    async function join() {
      const code = (input.value || '').trim().toUpperCase()
      if (!code) { log('Enter a code'); return }
      log('Connecting...')
      await startCam(lastFacing)
      await ensureWS()
      log('Joining session...')
      ws.send(JSON.stringify({ type: 'cam-join', code }))
      ws.onmessage = async (ev) => {
        const data = JSON.parse(ev.data)
        if (data.type === 'cam-joined') {
          log('Paired. Negotiating...')
        } else if (data.type === 'cam-offer') {
          pc = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] })
          stream.getTracks().forEach(t => pc.addTrack(t, stream))
          pc.onicecandidate = (e) => { if (e.candidate) ws.send(JSON.stringify({ type: 'cam-ice', code, payload: e.candidate })) }
          await pc.setRemoteDescription(new RTCSessionDescription(data.payload))
          const answer = await pc.createAnswer()
          await pc.setLocalDescription(answer)
          ws.send(JSON.stringify({ type: 'cam-answer', code, payload: answer }))
          log('Streaming to desktop...')
        } else if (data.type === 'cam-ice') {
          try { await pc.addIceCandidate(data.payload) } catch {}
        } else if (data.type === 'cam-error') {
          log('Error: ' + (data.code || 'UNKNOWN'))
        }
      }
    }

    joinBtn.addEventListener('click', (e) => { e.preventDefault(); join() })
    stopBtn.addEventListener('click', (e) => { e.preventDefault(); try { if (pc) pc.close(); if (ws) ws.close(); if (stream) stream.getTracks().forEach(t=>t.stop()) } catch {}; log('Stopped.') })
    swapBtn.addEventListener('click', async (e) => { e.preventDefault(); lastFacing = (lastFacing === 'environment' ? 'user' : 'environment'); await startCam(lastFacing) })
  </script>
</body>
</html>
